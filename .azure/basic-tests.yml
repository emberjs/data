parameters:
  nodeVersion: '10.x'
  useLockfile: true

steps:
  - template: 'setup-environment.yml'

  - ${{ if not(eq(parameters.useLockfile, 'false')) }}:
    - script: yarn install --non-interactive
      displayName: 'Yarn install'

  - ${{ if eq(parameters.useLockfile, 'false') }}:
    - script: yarn install --no-lockfile --non-interactive
      displayName: 'Yarn install --no-lockfile'

  - script: yarn test
    displayName: 'Basic tests'

  - script: yarn test:production
    displayName: 'Production'

  - script: yarn test:node
    displayName: 'Node tests'

  - script: yarn test:docs
    displayName: 'Node tests'

  - script: yarn test:enabled-in-progress-features
    displayName: 'In progress features'
    env:
      EMBER_DATA_FEATURE_OVERRIDE: ENABLE_ALL_OPTIONAL
    condition: |
      or(
        in(variables['Build.SourceBranchName'], 'master', 'beta'),
        in(variables['System.PullRequest.TargetBranch'], 'master', 'beta')
      )
