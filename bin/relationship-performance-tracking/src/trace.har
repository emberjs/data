{
  "log": {
    "version": "1.2",
    "creator": {
      "name": "WebInspector",
      "version": "537.36"
    },
    "pages": [
      {
        "startedDateTime": "2019-11-08T20:37:42.897Z",
        "id": "page_1",
        "title": "http://localhost:5000/",
        "pageTimings": {
          "onContentLoad": null,
          "onLoad": null
        }
      }
    ],
    "entries": [
      {
        "startedDateTime": "2019-11-08T20:37:42.896Z",
        "time": 2.6479999996809056,
        "request": {
          "method": "GET",
          "url": "http://localhost:5000/",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Host",
              "value": "localhost:5000"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Cache-Control",
              "value": "max-age=0"
            },
            {
              "name": "Upgrade-Insecure-Requests",
              "value": "1"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.97 Safari/537.36"
            },
            {
              "name": "Sec-Fetch-User",
              "value": "?1"
            },
            {
              "name": "Accept",
              "value": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3"
            },
            {
              "name": "Sec-Fetch-Site",
              "value": "same-origin"
            },
            {
              "name": "Sec-Fetch-Mode",
              "value": "navigate"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.9"
            },
            {
              "name": "Cookie",
              "value": "io=wIu7CXtmPvSmDD1VAAAM; amplitude_id_5e201f0eac128f83637a72cc714578f0=eyJkZXZpY2VJZCI6IjFjNDI0NTRkLTg5MjgtNDc2OC05MzE3LTJlZjFhZWIyOGEyY1IiLCJ1c2VySWQiOm51bGwsIm9wdE91dCI6ZmFsc2UsInNlc3Npb25JZCI6MTU3MjM4NjI4OTk2MiwibGFzdEV2ZW50VGltZSI6MTU3MjM4ODkwNjkxNiwiZXZlbnRJZCI6MTgyLCJpZGVudGlmeUlkIjo5NCwic2VxdWVuY2VOdW1iZXIiOjI3Nn0="
            }
          ],
          "queryString": [],
          "cookies": [
            {
              "name": "io",
              "value": "wIu7CXtmPvSmDD1VAAAM",
              "expires": null,
              "httpOnly": false,
              "secure": false
            },
            {
              "name": "amplitude_id_5e201f0eac128f83637a72cc714578f0",
              "value": "eyJkZXZpY2VJZCI6IjFjNDI0NTRkLTg5MjgtNDc2OC05MzE3LTJlZjFhZWIyOGEyY1IiLCJ1c2VySWQiOm51bGwsIm9wdE91dCI6ZmFsc2UsInNlc3Npb25JZCI6MTU3MjM4NjI4OTk2MiwibGFzdEV2ZW50VGltZSI6MTU3MjM4ODkwNjkxNiwiZXZlbnRJZCI6MTgyLCJpZGVudGlmeUlkIjo5NCwic2VxdWVuY2VOdW1iZXIiOjI3Nn0=",
              "expires": null,
              "httpOnly": false,
              "secure": false
            }
          ],
          "headersSize": 857,
          "bodySize": 0
        },
        "response": {
          "status": 200,
          "statusText": "OK",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Host",
              "value": "localhost:5000"
            },
            {
              "name": "Date",
              "value": "Fri, 08 Nov 2019 20:37:42 +0000"
            },
            {
              "name": "Connection",
              "value": "close"
            },
            {
              "name": "Content-Type",
              "value": "text/html; charset=UTF-8"
            },
            {
              "name": "Content-Length",
              "value": "1176"
            }
          ],
          "cookies": [],
          "content": {
            "size": 1176,
            "mimeType": "text/html",
            "compression": 0,
            "text": "<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"utf-8\" />\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />\n    <title>RelationshipPerformance</title>\n    <meta name=\"description\" content=\"\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n\n    \n<meta name=\"relationship-performance-test-app/config/environment\" content=\"%7B%22modulePrefix%22%3A%22relationship-performance-test-app%22%2C%22environment%22%3A%22production%22%2C%22rootURL%22%3A%22%2F%22%2C%22locationType%22%3A%22auto%22%2C%22EmberENV%22%3A%7B%22FEATURES%22%3A%7B%7D%2C%22EXTEND_PROTOTYPES%22%3A%7B%22Date%22%3Afalse%7D%2C%22_JQUERY_INTEGRATION%22%3Afalse%7D%2C%22APP%22%3A%7B%22name%22%3A%22relationship-performance-test-app%22%2C%22version%22%3A%223.16.0-alpha.0%2Bec454410%22%7D%2C%22exportApplicationGlobal%22%3Afalse%7D\" />\n\n    <link integrity=\"\" rel=\"stylesheet\" href=\"/assets/vendor.css\" />\n    <link integrity=\"\" rel=\"stylesheet\" href=\"/assets/relationship-performance-test-app.css\" />\n\n    \n  </head>\n  <body>\n    \n\n    <script src=\"/assets/vendor.js\"></script>\n    <script src=\"/assets/relationship-performance-test-app.js\"></script>\n\n    \n  </body>\n</html>\n"
          },
          "redirectURL": "",
          "headersSize": 161,
          "bodySize": 1176,
          "_transferSize": 1337
        },
        "cache": {},
        "timings": {
          "blocked": 1.5590000005672917,
          "dns": -1,
          "ssl": -1,
          "connect": -1,
          "send": 0.05900000000000005,
          "wait": 0.7399999991636723,
          "receive": 0.2899999999499414,
          "_blocked_queueing": 0.8560000005672919
        },
        "serverIPAddress": "[::1]",
        "_initiator": {
          "type": "other"
        },
        "_priority": "VeryHigh",
        "_resourceType": "document",
        "connection": "50967",
        "pageref": "page_1"
      },
      {
        "startedDateTime": "2019-11-08T20:37:42.914Z",
        "time": 3.937999999834574,
        "request": {
          "method": "GET",
          "url": "http://localhost:5000/assets/vendor.css",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Host",
              "value": "localhost:5000"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.97 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "text/css,*/*;q=0.1"
            },
            {
              "name": "Sec-Fetch-Site",
              "value": "same-origin"
            },
            {
              "name": "Sec-Fetch-Mode",
              "value": "no-cors"
            },
            {
              "name": "Referer",
              "value": "http://localhost:5000/"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.9"
            },
            {
              "name": "Cookie",
              "value": "io=wIu7CXtmPvSmDD1VAAAM; amplitude_id_5e201f0eac128f83637a72cc714578f0=eyJkZXZpY2VJZCI6IjFjNDI0NTRkLTg5MjgtNDc2OC05MzE3LTJlZjFhZWIyOGEyY1IiLCJ1c2VySWQiOm51bGwsIm9wdE91dCI6ZmFsc2UsInNlc3Npb25JZCI6MTU3MjM4NjI4OTk2MiwibGFzdEV2ZW50VGltZSI6MTU3MjM4ODkwNjkxNiwiZXZlbnRJZCI6MTgyLCJpZGVudGlmeUlkIjo5NCwic2VxdWVuY2VOdW1iZXIiOjI3Nn0="
            }
          ],
          "queryString": [],
          "cookies": [
            {
              "name": "io",
              "value": "wIu7CXtmPvSmDD1VAAAM",
              "expires": null,
              "httpOnly": false,
              "secure": false
            },
            {
              "name": "amplitude_id_5e201f0eac128f83637a72cc714578f0",
              "value": "eyJkZXZpY2VJZCI6IjFjNDI0NTRkLTg5MjgtNDc2OC05MzE3LTJlZjFhZWIyOGEyY1IiLCJ1c2VySWQiOm51bGwsIm9wdE91dCI6ZmFsc2UsInNlc3Npb25JZCI6MTU3MjM4NjI4OTk2MiwibGFzdEV2ZW50VGltZSI6MTU3MjM4ODkwNjkxNiwiZXZlbnRJZCI6MTgyLCJpZGVudGlmeUlkIjo5NCwic2VxdWVuY2VOdW1iZXIiOjI3Nn0=",
              "expires": null,
              "httpOnly": false,
              "secure": false
            }
          ],
          "headersSize": 730,
          "bodySize": 0
        },
        "response": {
          "status": 200,
          "statusText": "OK",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Host",
              "value": "localhost:5000"
            },
            {
              "name": "Date",
              "value": "Fri, 08 Nov 2019 20:37:42 +0000"
            },
            {
              "name": "Connection",
              "value": "close"
            },
            {
              "name": "Content-Type",
              "value": "text/css; charset=UTF-8"
            },
            {
              "name": "Content-Length",
              "value": "0"
            }
          ],
          "cookies": [],
          "content": {
            "size": 0,
            "mimeType": "text/css",
            "compression": 0,
            "text": ""
          },
          "redirectURL": "",
          "headersSize": 157,
          "bodySize": 0,
          "_transferSize": 157
        },
        "cache": {},
        "timings": {
          "blocked": 1.8299999988757771,
          "dns": -1,
          "ssl": -1,
          "connect": -1,
          "send": 0.07900000000000001,
          "wait": 1.7669999995739198,
          "receive": 0.26200000138487667,
          "_blocked_queueing": 1.5709999988757772
        },
        "serverIPAddress": "[::1]",
        "_initiator": {
          "type": "parser",
          "url": "http://localhost:5000/",
          "lineNumber": 12
        },
        "_priority": "VeryHigh",
        "_resourceType": "stylesheet",
        "connection": "50969",
        "pageref": "page_1"
      },
      {
        "startedDateTime": "2019-11-08T20:37:42.914Z",
        "time": 4.8840000008769575,
        "request": {
          "method": "GET",
          "url": "http://localhost:5000/assets/relationship-performance-test-app.css",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Host",
              "value": "localhost:5000"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.97 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "text/css,*/*;q=0.1"
            },
            {
              "name": "Sec-Fetch-Site",
              "value": "same-origin"
            },
            {
              "name": "Sec-Fetch-Mode",
              "value": "no-cors"
            },
            {
              "name": "Referer",
              "value": "http://localhost:5000/"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.9"
            },
            {
              "name": "Cookie",
              "value": "io=wIu7CXtmPvSmDD1VAAAM; amplitude_id_5e201f0eac128f83637a72cc714578f0=eyJkZXZpY2VJZCI6IjFjNDI0NTRkLTg5MjgtNDc2OC05MzE3LTJlZjFhZWIyOGEyY1IiLCJ1c2VySWQiOm51bGwsIm9wdE91dCI6ZmFsc2UsInNlc3Npb25JZCI6MTU3MjM4NjI4OTk2MiwibGFzdEV2ZW50VGltZSI6MTU3MjM4ODkwNjkxNiwiZXZlbnRJZCI6MTgyLCJpZGVudGlmeUlkIjo5NCwic2VxdWVuY2VOdW1iZXIiOjI3Nn0="
            }
          ],
          "queryString": [],
          "cookies": [
            {
              "name": "io",
              "value": "wIu7CXtmPvSmDD1VAAAM",
              "expires": null,
              "httpOnly": false,
              "secure": false
            },
            {
              "name": "amplitude_id_5e201f0eac128f83637a72cc714578f0",
              "value": "eyJkZXZpY2VJZCI6IjFjNDI0NTRkLTg5MjgtNDc2OC05MzE3LTJlZjFhZWIyOGEyY1IiLCJ1c2VySWQiOm51bGwsIm9wdE91dCI6ZmFsc2UsInNlc3Npb25JZCI6MTU3MjM4NjI4OTk2MiwibGFzdEV2ZW50VGltZSI6MTU3MjM4ODkwNjkxNiwiZXZlbnRJZCI6MTgyLCJpZGVudGlmeUlkIjo5NCwic2VxdWVuY2VOdW1iZXIiOjI3Nn0=",
              "expires": null,
              "httpOnly": false,
              "secure": false
            }
          ],
          "headersSize": 757,
          "bodySize": 0
        },
        "response": {
          "status": 200,
          "statusText": "OK",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Host",
              "value": "localhost:5000"
            },
            {
              "name": "Date",
              "value": "Fri, 08 Nov 2019 20:37:42 +0000"
            },
            {
              "name": "Connection",
              "value": "close"
            },
            {
              "name": "Content-Type",
              "value": "text/css; charset=UTF-8"
            },
            {
              "name": "Content-Length",
              "value": "0"
            }
          ],
          "cookies": [],
          "content": {
            "size": 0,
            "mimeType": "text/css",
            "compression": 0,
            "text": ""
          },
          "redirectURL": "",
          "headersSize": 157,
          "bodySize": 0,
          "_transferSize": 157
        },
        "cache": {},
        "timings": {
          "blocked": 3.0459999993679814,
          "dns": 0.008000000000000007,
          "ssl": -1,
          "connect": 0.942,
          "send": 0.2220000000000002,
          "wait": 0.4360000000433064,
          "receive": 0.2300000014656689,
          "_blocked_queueing": 2.861999999367981
        },
        "serverIPAddress": "[::1]",
        "_initiator": {
          "type": "parser",
          "url": "http://localhost:5000/",
          "lineNumber": 13
        },
        "_priority": "VeryHigh",
        "_resourceType": "stylesheet",
        "connection": "50983",
        "pageref": "page_1"
      },
      {
        "startedDateTime": "2019-11-08T20:37:42.915Z",
        "time": 99.79100000126788,
        "request": {
          "method": "GET",
          "url": "http://localhost:5000/assets/vendor.js",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Host",
              "value": "localhost:5000"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.97 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "*/*"
            },
            {
              "name": "Sec-Fetch-Site",
              "value": "same-origin"
            },
            {
              "name": "Sec-Fetch-Mode",
              "value": "no-cors"
            },
            {
              "name": "Referer",
              "value": "http://localhost:5000/"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.9"
            },
            {
              "name": "Cookie",
              "value": "io=wIu7CXtmPvSmDD1VAAAM; amplitude_id_5e201f0eac128f83637a72cc714578f0=eyJkZXZpY2VJZCI6IjFjNDI0NTRkLTg5MjgtNDc2OC05MzE3LTJlZjFhZWIyOGEyY1IiLCJ1c2VySWQiOm51bGwsIm9wdE91dCI6ZmFsc2UsInNlc3Npb25JZCI6MTU3MjM4NjI4OTk2MiwibGFzdEV2ZW50VGltZSI6MTU3MjM4ODkwNjkxNiwiZXZlbnRJZCI6MTgyLCJpZGVudGlmeUlkIjo5NCwic2VxdWVuY2VOdW1iZXIiOjI3Nn0="
            }
          ],
          "queryString": [],
          "cookies": [
            {
              "name": "io",
              "value": "wIu7CXtmPvSmDD1VAAAM",
              "expires": null,
              "httpOnly": false,
              "secure": false
            },
            {
              "name": "amplitude_id_5e201f0eac128f83637a72cc714578f0",
              "value": "eyJkZXZpY2VJZCI6IjFjNDI0NTRkLTg5MjgtNDc2OC05MzE3LTJlZjFhZWIyOGEyY1IiLCJ1c2VySWQiOm51bGwsIm9wdE91dCI6ZmFsc2UsInNlc3Npb25JZCI6MTU3MjM4NjI4OTk2MiwibGFzdEV2ZW50VGltZSI6MTU3MjM4ODkwNjkxNiwiZXZlbnRJZCI6MTgyLCJpZGVudGlmeUlkIjo5NCwic2VxdWVuY2VOdW1iZXIiOjI3Nn0=",
              "expires": null,
              "httpOnly": false,
              "secure": false
            }
          ],
          "headersSize": 714,
          "bodySize": 0
        },
        "response": {
          "status": 200,
          "statusText": "OK",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Host",
              "value": "localhost:5000"
            },
            {
              "name": "Date",
              "value": "Fri, 08 Nov 2019 20:37:42 +0000"
            },
            {
              "name": "Connection",
              "value": "close"
            },
            {
              "name": "Content-Type",
              "value": "application/javascript"
            },
            {
              "name": "Content-Length",
              "value": "2818657"
            }
          ],
          "cookies": [],
          "content": {
            "size": 2818657,
            "mimeType": "application/javascript",
            "compression": 0,
            "text": "d2luZG93LkVtYmVyRU5WID0geyJGRUFUVVJFUyI6e30sIkVYVEVORF9QUk9UT1RZUEVTIjp7IkRhdGUiOmZhbHNlfSwiX0pRVUVSWV9JTlRFR1JBVElPTiI6ZmFsc2V9Owp2YXIgcnVubmluZ1Rlc3RzID0gZmFsc2U7CgoKCjt2YXIgbG9hZGVyLCBkZWZpbmUsIHJlcXVpcmVNb2R1bGUsIHJlcXVpcmUsIHJlcXVpcmVqczsKCihmdW5jdGlvbiAoZ2xvYmFsKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBmdW5jdGlvbiBkaWN0KCkgewogICAgdmFyIG9iaiA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICBvYmpbJ19fJ10gPSB1bmRlZmluZWQ7CiAgICBkZWxldGUgb2JqWydfXyddOwogICAgcmV0dXJuIG9iajsKICB9CgogIC8vIFNhdmUgb2ZmIHRoZSBvcmlnaW5hbCB2YWx1ZXMgb2YgdGhlc2UgZ2xvYmFscywgc28gd2UgY2FuIHJlc3RvcmUgdGhlbSBpZiBzb21lb25lIGFza3MgdXMgdG8KICB2YXIgb2xkR2xvYmFscyA9IHsKICAgIGxvYWRlcjogbG9hZGVyLAogICAgZGVmaW5lOiBkZWZpbmUsCiAgICByZXF1aXJlTW9kdWxlOiByZXF1aXJlTW9kdWxlLAogICAgcmVxdWlyZTogcmVxdWlyZSwKICAgIHJlcXVpcmVqczogcmVxdWlyZWpzCiAgfTsKCiAgcmVxdWlyZWpzID0gcmVxdWlyZSA9IHJlcXVpcmVNb2R1bGUgPSBmdW5jdGlvbiAoaWQpIHsKICAgIHZhciBwZW5kaW5nID0gW107CiAgICB2YXIgbW9kID0gZmluZE1vZHVsZShpZCwgJyhyZXF1aXJlKScsIHBlbmRpbmcpOwoKICAgIGZvciAodmFyIGkgPSBwZW5kaW5nLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIHBlbmRpbmdbaV0uZXhwb3J0cygpOwogICAgfQoKICAgIHJldHVybiBtb2QubW9kdWxlLmV4cG9ydHM7CiAgfTsKCiAgbG9hZGVyID0gewogICAgbm9Db25mbGljdDogZnVuY3Rpb24gKGFsaWFzZXMpIHsKICAgICAgdmFyIG9sZE5hbWUsIG5ld05hbWU7CgogICAgICBmb3IgKG9sZE5hbWUgaW4gYWxpYXNlcykgewogICAgICAgIGlmIChhbGlhc2VzLmhhc093blByb3BlcnR5KG9sZE5hbWUpKSB7CiAgICAgICAgICBpZiAob2xkR2xvYmFscy5oYXNPd25Qcm9wZXJ0eShvbGROYW1lKSkgewogICAgICAgICAgICBuZXdOYW1lID0gYWxpYXNlc1tvbGROYW1lXTsKCiAgICAgICAgICAgIGdsb2JhbFtuZXdOYW1lXSA9IGdsb2JhbFtvbGROYW1lXTsKICAgICAgICAgICAgZ2xvYmFsW29sZE5hbWVdID0gb2xkR2xvYmFsc1tvbGROYW1lXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAvLyBPcHRpb24gdG8gZW5hYmxlIG9yIGRpc2FibGUgdGhlIGdlbmVyYXRpb24gb2YgZGVmYXVsdCBleHBvcnRzCiAgICBtYWtlRGVmYXVsdEV4cG9ydDogdHJ1ZQogIH07CgogIHZhciByZWdpc3RyeSA9IGRpY3QoKTsKICB2YXIgc2VlbiA9IGRpY3QoKTsKCiAgdmFyIHV1aWQgPSAwOwoKICBmdW5jdGlvbiB1bnN1cHBvcnRlZE1vZHVsZShsZW5ndGgpIHsKICAgIHRocm93IG5ldyBFcnJvcignYW4gdW5zdXBwb3J0ZWQgbW9kdWxlIHdhcyBkZWZpbmVkLCBleHBlY3RlZCBgZGVmaW5lKGlkLCBkZXBzLCBtb2R1bGUpYCBpbnN0ZWFkIGdvdDogYCcgKyBsZW5ndGggKyAnYCBhcmd1bWVudHMgdG8gZGVmaW5lYCcpOwogIH0KCiAgdmFyIGRlZmF1bHREZXBzID0gWydyZXF1aXJlJywgJ2V4cG9ydHMnLCAnbW9kdWxlJ107CgogIGZ1bmN0aW9uIE1vZHVsZShpZCwgZGVwcywgY2FsbGJhY2ssIGFsaWFzKSB7CiAgICB0aGlzLnV1aWQgPSB1dWlkKys7CiAgICB0aGlzLmlkID0gaWQ7CiAgICB0aGlzLmRlcHMgPSAhZGVwcy5sZW5ndGggJiYgY2FsbGJhY2subGVuZ3RoID8gZGVmYXVsdERlcHMgOiBkZXBzOwogICAgdGhpcy5tb2R1bGUgPSB7IGV4cG9ydHM6IHt9IH07CiAgICB0aGlzLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB0aGlzLmhhc0V4cG9ydHNBc0RlcCA9IGZhbHNlOwogICAgdGhpcy5pc0FsaWFzID0gYWxpYXM7CiAgICB0aGlzLnJlaWZpZWQgPSBuZXcgQXJyYXkoZGVwcy5sZW5ndGgpOwoKICAgIC8qCiAgICAgICBFYWNoIG1vZHVsZSBub3JtYWxseSBwYXNzZXMgdGhyb3VnaCB0aGVzZSBzdGF0ZXMsIGluIG9yZGVyOgogICAgICAgICBuZXcgICAgICAgOiBpbml0aWFsIHN0YXRlCiAgICAgICAgIHBlbmRpbmcgICA6IHRoaXMgbW9kdWxlIGlzIHNjaGVkdWxlZCB0byBiZSBleGVjdXRlZAogICAgICAgICByZWlmeWluZyAgOiB0aGlzIG1vZHVsZSdzIGRlcGVuZGVuY2llcyBhcmUgYmVpbmcgZXhlY3V0ZWQKICAgICAgICAgcmVpZmllZCAgIDogdGhpcyBtb2R1bGUncyBkZXBlbmRlbmNpZXMgZmluaXNoZWQgZXhlY3V0aW5nIHN1Y2Nlc3NmdWxseQogICAgICAgICBlcnJvcmVkICAgOiB0aGlzIG1vZHVsZSdzIGRlcGVuZGVuY2llcyBmYWlsZWQgdG8gZXhlY3V0ZQogICAgICAgICBmaW5hbGl6ZWQgOiB0aGlzIG1vZHVsZSBleGVjdXRlZCBzdWNjZXNzZnVsbHkKICAgICAqLwogICAgdGhpcy5zdGF0ZSA9ICduZXcnOwogIH0KCiAgTW9kdWxlLnByb3RvdHlwZS5tYWtlRGVmYXVsdEV4cG9ydCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBleHBvcnRzID0gdGhpcy5tb2R1bGUuZXhwb3J0czsKICAgIGlmIChleHBvcnRzICE9PSBudWxsICYmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIGV4cG9ydHMgPT09ICdmdW5jdGlvbicpICYmIGV4cG9ydHNbJ2RlZmF1bHQnXSA9PT0gdW5kZWZpbmVkICYmIE9iamVjdC5pc0V4dGVuc2libGUoZXhwb3J0cykpIHsKICAgICAgZXhwb3J0c1snZGVmYXVsdCddID0gZXhwb3J0czsKICAgIH0KICB9OwoKICBNb2R1bGUucHJvdG90eXBlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7CiAgICAvLyBpZiBmaW5hbGl6ZWQsIHRoZXJlIGlzIG5vIHdvcmsgdG8gZG8uIElmIHJlaWZ5aW5nLCB0aGVyZSBpcyBhCiAgICAvLyBjaXJjdWxhciBkZXBlbmRlbmN5IHNvIHdlIG11c3QgcmV0dXJuIG91ciAocGFydGlhbCkgZXhwb3J0cy4KICAgIGlmICh0aGlzLnN0YXRlID09PSAnZmluYWxpemVkJyB8fCB0aGlzLnN0YXRlID09PSAncmVpZnlpbmcnKSB7CiAgICAgIHJldHVybiB0aGlzLm1vZHVsZS5leHBvcnRzOwogICAgfQoKCiAgICBpZiAobG9hZGVyLndyYXBNb2R1bGVzKSB7CiAgICAgIHRoaXMuY2FsbGJhY2sgPSBsb2FkZXIud3JhcE1vZHVsZXModGhpcy5pZCwgdGhpcy5jYWxsYmFjayk7CiAgICB9CgogICAgdGhpcy5yZWlmeSgpOwoKICAgIHZhciByZXN1bHQgPSB0aGlzLmNhbGxiYWNrLmFwcGx5KHRoaXMsIHRoaXMucmVpZmllZCk7CiAgICB0aGlzLnJlaWZpZWQubGVuZ3RoID0gMDsKICAgIHRoaXMuc3RhdGUgPSAnZmluYWxpemVkJzsKCiAgICBpZiAoISh0aGlzLmhhc0V4cG9ydHNBc0RlcCAmJiByZXN1bHQgPT09IHVuZGVmaW5lZCkpIHsKICAgICAgdGhpcy5tb2R1bGUuZXhwb3J0cyA9IHJlc3VsdDsKICAgIH0KICAgIGlmIChsb2FkZXIubWFrZURlZmF1bHRFeHBvcnQpIHsKICAgICAgdGhpcy5tYWtlRGVmYXVsdEV4cG9ydCgpOwogICAgfQogICAgcmV0dXJuIHRoaXMubW9kdWxlLmV4cG9ydHM7CiAgfTsKCiAgTW9kdWxlLnByb3RvdHlwZS51bnNlZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuc3RhdGUgPSAnbmV3JzsKICAgIHRoaXMubW9kdWxlID0geyBleHBvcnRzOiB7fSB9OwogIH07CgogIE1vZHVsZS5wcm90b3R5cGUucmVpZnkgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ3JlaWZpZWQnKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuc3RhdGUgPSAncmVpZnlpbmcnOwogICAgdHJ5IHsKICAgICAgdGhpcy5yZWlmaWVkID0gdGhpcy5fcmVpZnkoKTsKICAgICAgdGhpcy5zdGF0ZSA9ICdyZWlmaWVkJzsKICAgIH0gZmluYWxseSB7CiAgICAgIGlmICh0aGlzLnN0YXRlID09PSAncmVpZnlpbmcnKSB7CiAgICAgICAgdGhpcy5zdGF0ZSA9ICdlcnJvcmVkJzsKICAgICAgfQogICAgfQogIH07CgogIE1vZHVsZS5wcm90b3R5cGUuX3JlaWZ5ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHJlaWZpZWQgPSB0aGlzLnJlaWZpZWQuc2xpY2UoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVpZmllZC5sZW5ndGg7IGkrKykgewogICAgICB2YXIgbW9kID0gcmVpZmllZFtpXTsKICAgICAgcmVpZmllZFtpXSA9IG1vZC5leHBvcnRzID8gbW9kLmV4cG9ydHMgOiBtb2QubW9kdWxlLmV4cG9ydHMoKTsKICAgIH0KICAgIHJldHVybiByZWlmaWVkOwogIH07CgogIE1vZHVsZS5wcm90b3R5cGUuZmluZERlcHMgPSBmdW5jdGlvbiAocGVuZGluZykgewogICAgaWYgKHRoaXMuc3RhdGUgIT09ICduZXcnKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLnN0YXRlID0gJ3BlbmRpbmcnOwoKICAgIHZhciBkZXBzID0gdGhpcy5kZXBzOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVwcy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgZGVwID0gZGVwc1tpXTsKICAgICAgdmFyIGVudHJ5ID0gdGhpcy5yZWlmaWVkW2ldID0geyBleHBvcnRzOiB1bmRlZmluZWQsIG1vZHVsZTogdW5kZWZpbmVkIH07CiAgICAgIGlmIChkZXAgPT09ICdleHBvcnRzJykgewogICAgICAgIHRoaXMuaGFzRXhwb3J0c0FzRGVwID0gdHJ1ZTsKICAgICAgICBlbnRyeS5leHBvcnRzID0gdGhpcy5tb2R1bGUuZXhwb3J0czsKICAgICAgfSBlbHNlIGlmIChkZXAgPT09ICdyZXF1aXJlJykgewogICAgICAgIGVudHJ5LmV4cG9ydHMgPSB0aGlzLm1ha2VSZXF1aXJlKCk7CiAgICAgIH0gZWxzZSBpZiAoZGVwID09PSAnbW9kdWxlJykgewogICAgICAgIGVudHJ5LmV4cG9ydHMgPSB0aGlzLm1vZHVsZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbnRyeS5tb2R1bGUgPSBmaW5kTW9kdWxlKHJlc29sdmUoZGVwLCB0aGlzLmlkKSwgdGhpcy5pZCwgcGVuZGluZyk7CiAgICAgIH0KICAgIH0KICB9OwoKICBNb2R1bGUucHJvdG90eXBlLm1ha2VSZXF1aXJlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGlkID0gdGhpcy5pZDsKICAgIHZhciByID0gZnVuY3Rpb24gKGRlcCkgewogICAgICByZXR1cm4gcmVxdWlyZShyZXNvbHZlKGRlcCwgaWQpKTsKICAgIH07CiAgICByWydkZWZhdWx0J10gPSByOwogICAgci5tb2R1bGVJZCA9IGlkOwogICAgci5oYXMgPSBmdW5jdGlvbiAoZGVwKSB7CiAgICAgIHJldHVybiBoYXMocmVzb2x2ZShkZXAsIGlkKSk7CiAgICB9OwogICAgcmV0dXJuIHI7CiAgfTsKCiAgZGVmaW5lID0gZnVuY3Rpb24gKGlkLCBkZXBzLCBjYWxsYmFjaykgewogICAgdmFyIG1vZHVsZSA9IHJlZ2lzdHJ5W2lkXTsKCiAgICAvLyBJZiBhIG1vZHVsZSBmb3IgdGhpcyBpZCBoYXMgYWxyZWFkeSBiZWVuIGRlZmluZWQgYW5kIGlzIGluIGFueSBzdGF0ZQogICAgLy8gb3RoZXIgdGhhbiBgbmV3YCAobWVhbmluZyBpdCBoYXMgYmVlbiBvciBpcyBjdXJyZW50bHkgYmVpbmcgcmVxdWlyZWQpLAogICAgLy8gdGhlbiB3ZSByZXR1cm4gZWFybHkgdG8gYXZvaWQgcmVkZWZpbml0aW9uLgogICAgaWYgKG1vZHVsZSAmJiBtb2R1bGUuc3RhdGUgIT09ICduZXcnKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDIpIHsKICAgICAgdW5zdXBwb3J0ZWRNb2R1bGUoYXJndW1lbnRzLmxlbmd0aCk7CiAgICB9CgogICAgaWYgKCFBcnJheS5pc0FycmF5KGRlcHMpKSB7CiAgICAgIGNhbGxiYWNrID0gZGVwczsKICAgICAgZGVwcyA9IFtdOwogICAgfQoKICAgIGlmIChjYWxsYmFjayBpbnN0YW5jZW9mIEFsaWFzKSB7CiAgICAgIHJlZ2lzdHJ5W2lkXSA9IG5ldyBNb2R1bGUoY2FsbGJhY2suaWQsIGRlcHMsIGNhbGxiYWNrLCB0cnVlKTsKICAgIH0gZWxzZSB7CiAgICAgIHJlZ2lzdHJ5W2lkXSA9IG5ldyBNb2R1bGUoaWQsIGRlcHMsIGNhbGxiYWNrLCBmYWxzZSk7CiAgICB9CiAgfTsKCiAgZGVmaW5lLmV4cG9ydHMgPSBmdW5jdGlvbiAobmFtZSwgZGVmYXVsdEV4cG9ydCkgewogICAgdmFyIG1vZHVsZSA9IHJlZ2lzdHJ5W25hbWVdOwoKICAgIC8vIElmIGEgbW9kdWxlIGZvciB0aGlzIG5hbWUgaGFzIGFscmVhZHkgYmVlbiBkZWZpbmVkIGFuZCBpcyBpbiBhbnkgc3RhdGUKICAgIC8vIG90aGVyIHRoYW4gYG5ld2AgKG1lYW5pbmcgaXQgaGFzIGJlZW4gb3IgaXMgY3VycmVudGx5IGJlaW5nIHJlcXVpcmVkKSwKICAgIC8vIHRoZW4gd2UgcmV0dXJuIGVhcmx5IHRvIGF2b2lkIHJlZGVmaW5pdGlvbi4KICAgIGlmIChtb2R1bGUgJiYgbW9kdWxlLnN0YXRlICE9PSAnbmV3JykgewogICAgICByZXR1cm47CiAgICB9CgogICAgbW9kdWxlID0gbmV3IE1vZHVsZShuYW1lLCBbXSwgbm9vcCwgbnVsbCk7CiAgICBtb2R1bGUubW9kdWxlLmV4cG9ydHMgPSBkZWZhdWx0RXhwb3J0OwogICAgbW9kdWxlLnN0YXRlID0gJ2ZpbmFsaXplZCc7CiAgICByZWdpc3RyeVtuYW1lXSA9IG1vZHVsZTsKCiAgICByZXR1cm4gbW9kdWxlOwogIH07CgogIGZ1bmN0aW9uIG5vb3AoKSB7fQogIC8vIHdlIGRvbid0IHN1cHBvcnQgYWxsIG9mIEFNRAogIC8vIGRlZmluZS5hbWQgPSB7fTsKCiAgZnVuY3Rpb24gQWxpYXMoaWQpIHsKICAgIHRoaXMuaWQgPSBpZDsKICB9CgogIGRlZmluZS5hbGlhcyA9IGZ1bmN0aW9uIChpZCwgdGFyZ2V0KSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgICByZXR1cm4gZGVmaW5lKHRhcmdldCwgbmV3IEFsaWFzKGlkKSk7CiAgICB9CgogICAgcmV0dXJuIG5ldyBBbGlhcyhpZCk7CiAgfTsKCiAgZnVuY3Rpb24gbWlzc2luZ01vZHVsZShpZCwgcmVmZXJyZXIpIHsKICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGZpbmQgbW9kdWxlIGAnICsgaWQgKyAnYCBpbXBvcnRlZCBmcm9tIGAnICsgcmVmZXJyZXIgKyAnYCcpOwogIH0KCiAgZnVuY3Rpb24gZmluZE1vZHVsZShpZCwgcmVmZXJyZXIsIHBlbmRpbmcpIHsKICAgIHZhciBtb2QgPSByZWdpc3RyeVtpZF0gfHwgcmVnaXN0cnlbaWQgKyAnL2luZGV4J107CgogICAgd2hpbGUgKG1vZCAmJiBtb2QuaXNBbGlhcykgewogICAgICBtb2QgPSByZWdpc3RyeVttb2QuaWRdIHx8IHJlZ2lzdHJ5W21vZC5pZCArICcvaW5kZXgnXTsKICAgIH0KCiAgICBpZiAoIW1vZCkgewogICAgICBtaXNzaW5nTW9kdWxlKGlkLCByZWZlcnJlcik7CiAgICB9CgogICAgaWYgKHBlbmRpbmcgJiYgbW9kLnN0YXRlICE9PSAncGVuZGluZycgJiYgbW9kLnN0YXRlICE9PSAnZmluYWxpemVkJykgewogICAgICBtb2QuZmluZERlcHMocGVuZGluZyk7CiAgICAgIHBlbmRpbmcucHVzaChtb2QpOwogICAgfQogICAgcmV0dXJuIG1vZDsKICB9CgogIGZ1bmN0aW9uIHJlc29sdmUoY2hpbGQsIGlkKSB7CiAgICBpZiAoY2hpbGQuY2hhckF0KDApICE9PSAnLicpIHsKICAgICAgcmV0dXJuIGNoaWxkOwogICAgfQoKCiAgICB2YXIgcGFydHMgPSBjaGlsZC5zcGxpdCgnLycpOwogICAgdmFyIG5hbWVQYXJ0cyA9IGlkLnNwbGl0KCcvJyk7CiAgICB2YXIgcGFyZW50QmFzZSA9IG5hbWVQYXJ0cy5zbGljZSgwLCAtMSk7CgogICAgZm9yICh2YXIgaSA9IDAsIGwgPSBwYXJ0cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgdmFyIHBhcnQgPSBwYXJ0c1tpXTsKCiAgICAgIGlmIChwYXJ0ID09PSAnLi4nKSB7CiAgICAgICAgaWYgKHBhcmVudEJhc2UubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBhY2Nlc3MgcGFyZW50IG1vZHVsZSBvZiByb290Jyk7CiAgICAgICAgfQogICAgICAgIHBhcmVudEJhc2UucG9wKCk7CiAgICAgIH0gZWxzZSBpZiAocGFydCA9PT0gJy4nKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFyZW50QmFzZS5wdXNoKHBhcnQpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHBhcmVudEJhc2Uuam9pbignLycpOwogIH0KCiAgZnVuY3Rpb24gaGFzKGlkKSB7CiAgICByZXR1cm4gISEocmVnaXN0cnlbaWRdIHx8IHJlZ2lzdHJ5W2lkICsgJy9pbmRleCddKTsKICB9CgogIHJlcXVpcmVqcy5lbnRyaWVzID0gcmVxdWlyZWpzLl9lYWtfc2VlbiA9IHJlZ2lzdHJ5OwogIHJlcXVpcmVqcy5oYXMgPSBoYXM7CiAgcmVxdWlyZWpzLnVuc2VlID0gZnVuY3Rpb24gKGlkKSB7CiAgICBmaW5kTW9kdWxlKGlkLCAnKHVuc2VlKScsIGZhbHNlKS51bnNlZSgpOwogIH07CgogIHJlcXVpcmVqcy5jbGVhciA9IGZ1bmN0aW9uICgpIHsKICAgIHJlcXVpcmVqcy5lbnRyaWVzID0gcmVxdWlyZWpzLl9lYWtfc2VlbiA9IHJlZ2lzdHJ5ID0gZGljdCgpOwogICAgc2VlbiA9IGRpY3QoKTsKICB9OwoKICAvLyBUaGlzIGNvZGUgcHJpbWVzIHRoZSBKUyBlbmdpbmUgZm9yIGdvb2QgcGVyZm9ybWFuY2UgYnkgd2FybWluZyB0aGUKICAvLyBKSVQgY29tcGlsZXIgZm9yIHRoZXNlIGZ1bmN0aW9ucy4KICBkZWZpbmUoJ2ZvbycsIGZ1bmN0aW9uICgpIHt9KTsKICBkZWZpbmUoJ2Zvby9iYXInLCBbXSwgZnVuY3Rpb24gKCkge30pOwogIGRlZmluZSgnZm9vL2FzZGYnLCBbJ21vZHVsZScsICdleHBvcnRzJywgJ3JlcXVpcmUnXSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgcmVxdWlyZSkgewogICAgaWYgKHJlcXVpcmUuaGFzKCdmb28vYmFyJykpIHsKICAgICAgcmVxdWlyZSgnZm9vL2JhcicpOwogICAgfQogIH0pOwogIGRlZmluZSgnZm9vL2JheicsIFtdLCBkZWZpbmUuYWxpYXMoJ2ZvbycpKTsKICBkZWZpbmUoJ2Zvby9xdXonLCBkZWZpbmUuYWxpYXMoJ2ZvbycpKTsKICBkZWZpbmUuYWxpYXMoJ2ZvbycsICdmb28vcXV4Jyk7CiAgZGVmaW5lKCdmb28vYmFyJywgWydmb28nLCAnLi9xdXonLCAnLi9iYXonLCAnLi9hc2RmJywgJy4vYmFyJywgJy4uL2ZvbyddLCBmdW5jdGlvbiAoKSB7fSk7CiAgZGVmaW5lKCdmb28vbWFpbicsIFsnZm9vL2JhciddLCBmdW5jdGlvbiAoKSB7fSk7CiAgZGVmaW5lLmV4cG9ydHMoJ2Zvby9leHBvcnRzJywge30pOwoKICByZXF1aXJlKCdmb28vZXhwb3J0cycpOwogIHJlcXVpcmUoJ2Zvby9tYWluJyk7CiAgcmVxdWlyZS51bnNlZSgnZm9vL2JhcicpOwoKICByZXF1aXJlanMuY2xlYXIoKTsKCiAgaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0JyAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgbW9kdWxlLmV4cG9ydHMgPSB7IHJlcXVpcmU6IHJlcXVpcmUsIGRlZmluZTogZGVmaW5lIH07CiAgfQp9KSh0aGlzKTsKOy8qKgogKiBDb3B5cmlnaHQgKGMpIDIwMTQsIEZhY2Vib29rLCBJbmMuCiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqCiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIEJTRC1zdHlsZSBsaWNlbnNlIGZvdW5kIGluIHRoZQogKiBodHRwczovL3Jhdy5naXRodWIuY29tL2ZhY2Vib29rL3JlZ2VuZXJhdG9yL21hc3Rlci9MSUNFTlNFIGZpbGUuIEFuCiAqIGFkZGl0aW9uYWwgZ3JhbnQgb2YgcGF0ZW50IHJpZ2h0cyBjYW4gYmUgZm91bmQgaW4gdGhlIFBBVEVOVFMgZmlsZSBpbgogKiB0aGUgc2FtZSBkaXJlY3RvcnkuCiAqLwoKIShmdW5jdGlvbihnbG9iYWwpIHsKICAidXNlIHN0cmljdCI7CgogIHZhciBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogIHZhciB1bmRlZmluZWQ7IC8vIE1vcmUgY29tcHJlc3NpYmxlIHRoYW4gdm9pZCAwLgogIHZhciAkU3ltYm9sID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiA/IFN5bWJvbCA6IHt9OwogIHZhciBpdGVyYXRvclN5bWJvbCA9ICRTeW1ib2wuaXRlcmF0b3IgfHwgIkBAaXRlcmF0b3IiOwogIHZhciB0b1N0cmluZ1RhZ1N5bWJvbCA9ICRTeW1ib2wudG9TdHJpbmdUYWcgfHwgIkBAdG9TdHJpbmdUYWciOwoKICB2YXIgaW5Nb2R1bGUgPSB0eXBlb2YgbW9kdWxlID09PSAib2JqZWN0IjsKICB2YXIgcnVudGltZSA9IGdsb2JhbC5yZWdlbmVyYXRvclJ1bnRpbWU7CiAgaWYgKHJ1bnRpbWUpIHsKICAgIGlmIChpbk1vZHVsZSkgewogICAgICAvLyBJZiByZWdlbmVyYXRvclJ1bnRpbWUgaXMgZGVmaW5lZCBnbG9iYWxseSBhbmQgd2UncmUgaW4gYSBtb2R1bGUsCiAgICAgIC8vIG1ha2UgdGhlIGV4cG9ydHMgb2JqZWN0IGlkZW50aWNhbCB0byByZWdlbmVyYXRvclJ1bnRpbWUuCiAgICAgIG1vZHVsZS5leHBvcnRzID0gcnVudGltZTsKICAgIH0KICAgIC8vIERvbid0IGJvdGhlciBldmFsdWF0aW5nIHRoZSByZXN0IG9mIHRoaXMgZmlsZSBpZiB0aGUgcnVudGltZSB3YXMKICAgIC8vIGFscmVhZHkgZGVmaW5lZCBnbG9iYWxseS4KICAgIHJldHVybjsKICB9CgogIC8vIERlZmluZSB0aGUgcnVudGltZSBnbG9iYWxseSAoYXMgZXhwZWN0ZWQgYnkgZ2VuZXJhdGVkIGNvZGUpIGFzIGVpdGhlcgogIC8vIG1vZHVsZS5leHBvcnRzIChpZiB3ZSdyZSBpbiBhIG1vZHVsZSkgb3IgYSBuZXcsIGVtcHR5IG9iamVjdC4KICBydW50aW1lID0gZ2xvYmFsLnJlZ2VuZXJhdG9yUnVudGltZSA9IGluTW9kdWxlID8gbW9kdWxlLmV4cG9ydHMgOiB7fTsKCiAgZnVuY3Rpb24gd3JhcChpbm5lckZuLCBvdXRlckZuLCBzZWxmLCB0cnlMb2NzTGlzdCkgewogICAgLy8gSWYgb3V0ZXJGbiBwcm92aWRlZCBhbmQgb3V0ZXJGbi5wcm90b3R5cGUgaXMgYSBHZW5lcmF0b3IsIHRoZW4gb3V0ZXJGbi5wcm90b3R5cGUgaW5zdGFuY2VvZiBHZW5lcmF0b3IuCiAgICB2YXIgcHJvdG9HZW5lcmF0b3IgPSBvdXRlckZuICYmIG91dGVyRm4ucHJvdG90eXBlIGluc3RhbmNlb2YgR2VuZXJhdG9yID8gb3V0ZXJGbiA6IEdlbmVyYXRvcjsKICAgIHZhciBnZW5lcmF0b3IgPSBPYmplY3QuY3JlYXRlKHByb3RvR2VuZXJhdG9yLnByb3RvdHlwZSk7CiAgICB2YXIgY29udGV4dCA9IG5ldyBDb250ZXh0KHRyeUxvY3NMaXN0IHx8IFtdKTsKCiAgICAvLyBUaGUgLl9pbnZva2UgbWV0aG9kIHVuaWZpZXMgdGhlIGltcGxlbWVudGF0aW9ucyBvZiB0aGUgLm5leHQsCiAgICAvLyAudGhyb3csIGFuZCAucmV0dXJuIG1ldGhvZHMuCiAgICBnZW5lcmF0b3IuX2ludm9rZSA9IG1ha2VJbnZva2VNZXRob2QoaW5uZXJGbiwgc2VsZiwgY29udGV4dCk7CgogICAgcmV0dXJuIGdlbmVyYXRvcjsKICB9CiAgcnVudGltZS53cmFwID0gd3JhcDsKCiAgLy8gVHJ5L2NhdGNoIGhlbHBlciB0byBtaW5pbWl6ZSBkZW9wdGltaXphdGlvbnMuIFJldHVybnMgYSBjb21wbGV0aW9uCiAgLy8gcmVjb3JkIGxpa2UgY29udGV4dC50cnlFbnRyaWVzW2ldLmNvbXBsZXRpb24uIFRoaXMgaW50ZXJmYWNlIGNvdWxkCiAgLy8gaGF2ZSBiZWVuIChhbmQgd2FzIHByZXZpb3VzbHkpIGRlc2lnbmVkIHRvIHRha2UgYSBjbG9zdXJlIHRvIGJlCiAgLy8gaW52b2tlZCB3aXRob3V0IGFyZ3VtZW50cywgYnV0IGluIGFsbCB0aGUgY2FzZXMgd2UgY2FyZSBhYm91dCB3ZQogIC8vIGFscmVhZHkgaGF2ZSBhbiBleGlzdGluZyBtZXRob2Qgd2Ugd2FudCB0byBjYWxsLCBzbyB0aGVyZSdzIG5vIG5lZWQKICAvLyB0byBjcmVhdGUgYSBuZXcgZnVuY3Rpb24gb2JqZWN0LiBXZSBjYW4gZXZlbiBnZXQgYXdheSB3aXRoIGFzc3VtaW5nCiAgLy8gdGhlIG1ldGhvZCB0YWtlcyBleGFjdGx5IG9uZSBhcmd1bWVudCwgc2luY2UgdGhhdCBoYXBwZW5zIHRvIGJlIHRydWUKICAvLyBpbiBldmVyeSBjYXNlLCBzbyB3ZSBkb24ndCBoYXZlIHRvIHRvdWNoIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBUaGUKICAvLyBvbmx5IGFkZGl0aW9uYWwgYWxsb2NhdGlvbiByZXF1aXJlZCBpcyB0aGUgY29tcGxldGlvbiByZWNvcmQsIHdoaWNoCiAgLy8gaGFzIGEgc3RhYmxlIHNoYXBlIGFuZCBzbyBob3BlZnVsbHkgc2hvdWxkIGJlIGNoZWFwIHRvIGFsbG9jYXRlLgogIGZ1bmN0aW9uIHRyeUNhdGNoKGZuLCBvYmosIGFyZykgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIHsgdHlwZTogIm5vcm1hbCIsIGFyZzogZm4uY2FsbChvYmosIGFyZykgfTsKICAgIH0gY2F0Y2ggKGVycikgewogICAgICByZXR1cm4geyB0eXBlOiAidGhyb3ciLCBhcmc6IGVyciB9OwogICAgfQogIH0KCiAgdmFyIEdlblN0YXRlU3VzcGVuZGVkU3RhcnQgPSAic3VzcGVuZGVkU3RhcnQiOwogIHZhciBHZW5TdGF0ZVN1c3BlbmRlZFlpZWxkID0gInN1c3BlbmRlZFlpZWxkIjsKICB2YXIgR2VuU3RhdGVFeGVjdXRpbmcgPSAiZXhlY3V0aW5nIjsKICB2YXIgR2VuU3RhdGVDb21wbGV0ZWQgPSAiY29tcGxldGVkIjsKCiAgLy8gUmV0dXJuaW5nIHRoaXMgb2JqZWN0IGZyb20gdGhlIGlubmVyRm4gaGFzIHRoZSBzYW1lIGVmZmVjdCBhcwogIC8vIGJyZWFraW5nIG91dCBvZiB0aGUgZGlzcGF0Y2ggc3dpdGNoIHN0YXRlbWVudC4KICB2YXIgQ29udGludWVTZW50aW5lbCA9IHt9OwoKICAvLyBEdW1teSBjb25zdHJ1Y3RvciBmdW5jdGlvbnMgdGhhdCB3ZSB1c2UgYXMgdGhlIC5jb25zdHJ1Y3RvciBhbmQKICAvLyAuY29uc3RydWN0b3IucHJvdG90eXBlIHByb3BlcnRpZXMgZm9yIGZ1bmN0aW9ucyB0aGF0IHJldHVybiBHZW5lcmF0b3IKICAvLyBvYmplY3RzLiBGb3IgZnVsbCBzcGVjIGNvbXBsaWFuY2UsIHlvdSBtYXkgd2lzaCB0byBjb25maWd1cmUgeW91cgogIC8vIG1pbmlmaWVyIG5vdCB0byBtYW5nbGUgdGhlIG5hbWVzIG9mIHRoZXNlIHR3byBmdW5jdGlvbnMuCiAgZnVuY3Rpb24gR2VuZXJhdG9yKCkge30KICBmdW5jdGlvbiBHZW5lcmF0b3JGdW5jdGlvbigpIHt9CiAgZnVuY3Rpb24gR2VuZXJhdG9yRnVuY3Rpb25Qcm90b3R5cGUoKSB7fQoKICB2YXIgR3AgPSBHZW5lcmF0b3JGdW5jdGlvblByb3RvdHlwZS5wcm90b3R5cGUgPSBHZW5lcmF0b3IucHJvdG90eXBlOwogIEdlbmVyYXRvckZ1bmN0aW9uLnByb3RvdHlwZSA9IEdwLmNvbnN0cnVjdG9yID0gR2VuZXJhdG9yRnVuY3Rpb25Qcm90b3R5cGU7CiAgR2VuZXJhdG9yRnVuY3Rpb25Qcm90b3R5cGUuY29uc3RydWN0b3IgPSBHZW5lcmF0b3JGdW5jdGlvbjsKICBHZW5lcmF0b3JGdW5jdGlvblByb3RvdHlwZVt0b1N0cmluZ1RhZ1N5bWJvbF0gPSBHZW5lcmF0b3JGdW5jdGlvbi5kaXNwbGF5TmFtZSA9ICJHZW5lcmF0b3JGdW5jdGlvbiI7CgogIC8vIEhlbHBlciBmb3IgZGVmaW5pbmcgdGhlIC5uZXh0LCAudGhyb3csIGFuZCAucmV0dXJuIG1ldGhvZHMgb2YgdGhlCiAgLy8gSXRlcmF0b3IgaW50ZXJmYWNlIGluIHRlcm1zIG9mIGEgc2luZ2xlIC5faW52b2tlIG1ldGhvZC4KICBmdW5jdGlvbiBkZWZpbmVJdGVyYXRvck1ldGhvZHMocHJvdG90eXBlKSB7CiAgICBbIm5leHQiLCAidGhyb3ciLCAicmV0dXJuIl0uZm9yRWFjaChmdW5jdGlvbihtZXRob2QpIHsKICAgICAgcHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbihhcmcpIHsKICAgICAgICByZXR1cm4gdGhpcy5faW52b2tlKG1ldGhvZCwgYXJnKTsKICAgICAgfTsKICAgIH0pOwogIH0KCiAgcnVudGltZS5pc0dlbmVyYXRvckZ1bmN0aW9uID0gZnVuY3Rpb24oZ2VuRnVuKSB7CiAgICB2YXIgY3RvciA9IHR5cGVvZiBnZW5GdW4gPT09ICJmdW5jdGlvbiIgJiYgZ2VuRnVuLmNvbnN0cnVjdG9yOwogICAgcmV0dXJuIGN0b3IKICAgICAgPyBjdG9yID09PSBHZW5lcmF0b3JGdW5jdGlvbiB8fAogICAgICAgIC8vIEZvciB0aGUgbmF0aXZlIEdlbmVyYXRvckZ1bmN0aW9uIGNvbnN0cnVjdG9yLCB0aGUgYmVzdCB3ZSBjYW4KICAgICAgICAvLyBkbyBpcyB0byBjaGVjayBpdHMgLm5hbWUgcHJvcGVydHkuCiAgICAgICAgKGN0b3IuZGlzcGxheU5hbWUgfHwgY3Rvci5uYW1lKSA9PT0gIkdlbmVyYXRvckZ1bmN0aW9uIgogICAgICA6IGZhbHNlOwogIH07CgogIHJ1bnRpbWUubWFyayA9IGZ1bmN0aW9uKGdlbkZ1bikgewogICAgaWYgKE9iamVjdC5zZXRQcm90b3R5cGVPZikgewogICAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YoZ2VuRnVuLCBHZW5lcmF0b3JGdW5jdGlvblByb3RvdHlwZSk7CiAgICB9IGVsc2UgewogICAgICBnZW5GdW4uX19wcm90b19fID0gR2VuZXJhdG9yRnVuY3Rpb25Qcm90b3R5cGU7CiAgICAgIGlmICghKHRvU3RyaW5nVGFnU3ltYm9sIGluIGdlbkZ1bikpIHsKICAgICAgICBnZW5GdW5bdG9TdHJpbmdUYWdTeW1ib2xdID0gIkdlbmVyYXRvckZ1bmN0aW9uIjsKICAgICAgfQogICAgfQogICAgZ2VuRnVuLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoR3ApOwogICAgcmV0dXJuIGdlbkZ1bjsKICB9OwoKICAvLyBXaXRoaW4gdGhlIGJvZHkgb2YgYW55IGFzeW5jIGZ1bmN0aW9uLCBgYXdhaXQgeGAgaXMgdHJhbnNmb3JtZWQgdG8KICAvLyBgeWllbGQgcmVnZW5lcmF0b3JSdW50aW1lLmF3cmFwKHgpYCwgc28gdGhhdCB0aGUgcnVudGltZSBjYW4gdGVzdAogIC8vIGB2YWx1ZSBpbnN0YW5jZW9mIEF3YWl0QXJndW1lbnRgIHRvIGRldGVybWluZSBpZiB0aGUgeWllbGRlZCB2YWx1ZSBpcwogIC8vIG1lYW50IHRvIGJlIGF3YWl0ZWQuIFNvbWUgbWF5IGNvbnNpZGVyIHRoZSBuYW1lIG9mIHRoaXMgbWV0aG9kIHRvbwogIC8vIGN1dGVzeSwgYnV0IHRoZXkgYXJlIGN1cm11ZGdlb25zLgogIHJ1bnRpbWUuYXdyYXAgPSBmdW5jdGlvbihhcmcpIHsKICAgIHJldHVybiBuZXcgQXdhaXRBcmd1bWVudChhcmcpOwogIH07CgogIGZ1bmN0aW9uIEF3YWl0QXJndW1lbnQoYXJnKSB7CiAgICB0aGlzLmFyZyA9IGFyZzsKICB9CgogIGZ1bmN0aW9uIEFzeW5jSXRlcmF0b3IoZ2VuZXJhdG9yKSB7CiAgICBmdW5jdGlvbiBpbnZva2UobWV0aG9kLCBhcmcsIHJlc29sdmUsIHJlamVjdCkgewogICAgICB2YXIgcmVjb3JkID0gdHJ5Q2F0Y2goZ2VuZXJhdG9yW21ldGhvZF0sIGdlbmVyYXRvciwgYXJnKTsKICAgICAgaWYgKHJlY29yZC50eXBlID09PSAidGhyb3ciKSB7CiAgICAgICAgcmVqZWN0KHJlY29yZC5hcmcpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciByZXN1bHQgPSByZWNvcmQuYXJnOwogICAgICAgIHZhciB2YWx1ZSA9IHJlc3VsdC52YWx1ZTsKICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBd2FpdEFyZ3VtZW50KSB7CiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHZhbHVlLmFyZykudGhlbihmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBpbnZva2UoIm5leHQiLCB2YWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgIH0sIGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICBpbnZva2UoInRocm93IiwgZXJyLCByZXNvbHZlLCByZWplY3QpOwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHZhbHVlKS50aGVuKGZ1bmN0aW9uKHVud3JhcHBlZCkgewogICAgICAgICAgLy8gV2hlbiBhIHlpZWxkZWQgUHJvbWlzZSBpcyByZXNvbHZlZCwgaXRzIGZpbmFsIHZhbHVlIGJlY29tZXMKICAgICAgICAgIC8vIHRoZSAudmFsdWUgb2YgdGhlIFByb21pc2U8e3ZhbHVlLGRvbmV9PiByZXN1bHQgZm9yIHRoZQogICAgICAgICAgLy8gY3VycmVudCBpdGVyYXRpb24uIElmIHRoZSBQcm9taXNlIGlzIHJlamVjdGVkLCBob3dldmVyLCB0aGUKICAgICAgICAgIC8vIHJlc3VsdCBmb3IgdGhpcyBpdGVyYXRpb24gd2lsbCBiZSByZWplY3RlZCB3aXRoIHRoZSBzYW1lCiAgICAgICAgICAvLyByZWFzb24uIE5vdGUgdGhhdCByZWplY3Rpb25zIG9mIHlpZWxkZWQgUHJvbWlzZXMgYXJlIG5vdAogICAgICAgICAgLy8gdGhyb3duIGJhY2sgaW50byB0aGUgZ2VuZXJhdG9yIGZ1bmN0aW9uLCBhcyBpcyB0aGUgY2FzZQogICAgICAgICAgLy8gd2hlbiBhbiBhd2FpdGVkIFByb21pc2UgaXMgcmVqZWN0ZWQuIFRoaXMgZGlmZmVyZW5jZSBpbgogICAgICAgICAgLy8gYmVoYXZpb3IgYmV0d2VlbiB5aWVsZCBhbmQgYXdhaXQgaXMgaW1wb3J0YW50LCBiZWNhdXNlIGl0CiAgICAgICAgICAvLyBhbGxvd3MgdGhlIGNvbnN1bWVyIHRvIGRlY2lkZSB3aGF0IHRvIGRvIHdpdGggdGhlIHlpZWxkZWQKICAgICAgICAgIC8vIHJlamVjdGlvbiAoc3dhbGxvdyBpdCBhbmQgY29udGludWUsIG1hbnVhbGx5IC50aHJvdyBpdCBiYWNrCiAgICAgICAgICAvLyBpbnRvIHRoZSBnZW5lcmF0b3IsIGFiYW5kb24gaXRlcmF0aW9uLCB3aGF0ZXZlcikuIFdpdGgKICAgICAgICAgIC8vIGF3YWl0LCBieSBjb250cmFzdCwgdGhlcmUgaXMgbm8gb3Bwb3J0dW5pdHkgdG8gZXhhbWluZSB0aGUKICAgICAgICAgIC8vIHJlamVjdGlvbiByZWFzb24gb3V0c2lkZSB0aGUgZ2VuZXJhdG9yIGZ1bmN0aW9uLCBzbyB0aGUKICAgICAgICAgIC8vIG9ubHkgb3B0aW9uIGlzIHRvIHRocm93IGl0IGZyb20gdGhlIGF3YWl0IGV4cHJlc3Npb24sIGFuZAogICAgICAgICAgLy8gbGV0IHRoZSBnZW5lcmF0b3IgZnVuY3Rpb24gaGFuZGxlIHRoZSBleGNlcHRpb24uCiAgICAgICAgICByZXN1bHQudmFsdWUgPSB1bndyYXBwZWQ7CiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7CiAgICAgICAgfSwgcmVqZWN0KTsKICAgICAgfQogICAgfQoKICAgIGlmICh0eXBlb2YgcHJvY2VzcyA9PT0gIm9iamVjdCIgJiYgcHJvY2Vzcy5kb21haW4pIHsKICAgICAgaW52b2tlID0gcHJvY2Vzcy5kb21haW4uYmluZChpbnZva2UpOwogICAgfQoKICAgIHZhciBwcmV2aW91c1Byb21pc2U7CgogICAgZnVuY3Rpb24gZW5xdWV1ZShtZXRob2QsIGFyZykgewogICAgICBmdW5jdGlvbiBjYWxsSW52b2tlV2l0aE1ldGhvZEFuZEFyZygpIHsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBpbnZva2UobWV0aG9kLCBhcmcsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwcmV2aW91c1Byb21pc2UgPQogICAgICAgIC8vIElmIGVucXVldWUgaGFzIGJlZW4gY2FsbGVkIGJlZm9yZSwgdGhlbiB3ZSB3YW50IHRvIHdhaXQgdW50aWwKICAgICAgICAvLyBhbGwgcHJldmlvdXMgUHJvbWlzZXMgaGF2ZSBiZWVuIHJlc29sdmVkIGJlZm9yZSBjYWxsaW5nIGludm9rZSwKICAgICAgICAvLyBzbyB0aGF0IHJlc3VsdHMgYXJlIGFsd2F5cyBkZWxpdmVyZWQgaW4gdGhlIGNvcnJlY3Qgb3JkZXIuIElmCiAgICAgICAgLy8gZW5xdWV1ZSBoYXMgbm90IGJlZW4gY2FsbGVkIGJlZm9yZSwgdGhlbiBpdCBpcyBpbXBvcnRhbnQgdG8KICAgICAgICAvLyBjYWxsIGludm9rZSBpbW1lZGlhdGVseSwgd2l0aG91dCB3YWl0aW5nIG9uIGEgY2FsbGJhY2sgdG8gZmlyZSwKICAgICAgICAvLyBzbyB0aGF0IHRoZSBhc3luYyBnZW5lcmF0b3IgZnVuY3Rpb24gaGFzIHRoZSBvcHBvcnR1bml0eSB0byBkbwogICAgICAgIC8vIGFueSBuZWNlc3Nhcnkgc2V0dXAgaW4gYSBwcmVkaWN0YWJsZSB3YXkuIFRoaXMgcHJlZGljdGFiaWxpdHkKICAgICAgICAvLyBpcyB3aHkgdGhlIFByb21pc2UgY29uc3RydWN0b3Igc3luY2hyb25vdXNseSBpbnZva2VzIGl0cwogICAgICAgIC8vIGV4ZWN1dG9yIGNhbGxiYWNrLCBhbmQgd2h5IGFzeW5jIGZ1bmN0aW9ucyBzeW5jaHJvbm91c2x5CiAgICAgICAgLy8gZXhlY3V0ZSBjb2RlIGJlZm9yZSB0aGUgZmlyc3QgYXdhaXQuIFNpbmNlIHdlIGltcGxlbWVudCBzaW1wbGUKICAgICAgICAvLyBhc3luYyBmdW5jdGlvbnMgaW4gdGVybXMgb2YgYXN5bmMgZ2VuZXJhdG9ycywgaXQgaXMgZXNwZWNpYWxseQogICAgICAgIC8vIGltcG9ydGFudCB0byBnZXQgdGhpcyByaWdodCwgZXZlbiB0aG91Z2ggaXQgcmVxdWlyZXMgY2FyZS4KICAgICAgICBwcmV2aW91c1Byb21pc2UgPyBwcmV2aW91c1Byb21pc2UudGhlbigKICAgICAgICAgIGNhbGxJbnZva2VXaXRoTWV0aG9kQW5kQXJnLAogICAgICAgICAgLy8gQXZvaWQgcHJvcGFnYXRpbmcgZmFpbHVyZXMgdG8gUHJvbWlzZXMgcmV0dXJuZWQgYnkgbGF0ZXIKICAgICAgICAgIC8vIGludm9jYXRpb25zIG9mIHRoZSBpdGVyYXRvci4KICAgICAgICAgIGNhbGxJbnZva2VXaXRoTWV0aG9kQW5kQXJnCiAgICAgICAgKSA6IGNhbGxJbnZva2VXaXRoTWV0aG9kQW5kQXJnKCk7CiAgICB9CgogICAgLy8gRGVmaW5lIHRoZSB1bmlmaWVkIGhlbHBlciBtZXRob2QgdGhhdCBpcyB1c2VkIHRvIGltcGxlbWVudCAubmV4dCwKICAgIC8vIC50aHJvdywgYW5kIC5yZXR1cm4gKHNlZSBkZWZpbmVJdGVyYXRvck1ldGhvZHMpLgogICAgdGhpcy5faW52b2tlID0gZW5xdWV1ZTsKICB9CgogIGRlZmluZUl0ZXJhdG9yTWV0aG9kcyhBc3luY0l0ZXJhdG9yLnByb3RvdHlwZSk7CgogIC8vIE5vdGUgdGhhdCBzaW1wbGUgYXN5bmMgZnVuY3Rpb25zIGFyZSBpbXBsZW1lbnRlZCBvbiB0b3Agb2YKICAvLyBBc3luY0l0ZXJhdG9yIG9iamVjdHM7IHRoZXkganVzdCByZXR1cm4gYSBQcm9taXNlIGZvciB0aGUgdmFsdWUgb2YKICAvLyB0aGUgZmluYWwgcmVzdWx0IHByb2R1Y2VkIGJ5IHRoZSBpdGVyYXRvci4KICBydW50aW1lLmFzeW5jID0gZnVuY3Rpb24oaW5uZXJGbiwgb3V0ZXJGbiwgc2VsZiwgdHJ5TG9jc0xpc3QpIHsKICAgIHZhciBpdGVyID0gbmV3IEFzeW5jSXRlcmF0b3IoCiAgICAgIHdyYXAoaW5uZXJGbiwgb3V0ZXJGbiwgc2VsZiwgdHJ5TG9jc0xpc3QpCiAgICApOwoKICAgIHJldHVybiBydW50aW1lLmlzR2VuZXJhdG9yRnVuY3Rpb24ob3V0ZXJGbikKICAgICAgPyBpdGVyIC8vIElmIG91dGVyRm4gaXMgYSBnZW5lcmF0b3IsIHJldHVybiB0aGUgZnVsbCBpdGVyYXRvci4KICAgICAgOiBpdGVyLm5leHQoKS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAgcmV0dXJuIHJlc3VsdC5kb25lID8gcmVzdWx0LnZhbHVlIDogaXRlci5uZXh0KCk7CiAgICAgICAgfSk7CiAgfTsKCiAgZnVuY3Rpb24gbWFrZUludm9rZU1ldGhvZChpbm5lckZuLCBzZWxmLCBjb250ZXh0KSB7CiAgICB2YXIgc3RhdGUgPSBHZW5TdGF0ZVN1c3BlbmRlZFN0YXJ0OwoKICAgIHJldHVybiBmdW5jdGlvbiBpbnZva2UobWV0aG9kLCBhcmcpIHsKICAgICAgaWYgKHN0YXRlID09PSBHZW5TdGF0ZUV4ZWN1dGluZykgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiR2VuZXJhdG9yIGlzIGFscmVhZHkgcnVubmluZyIpOwogICAgICB9CgogICAgICBpZiAoc3RhdGUgPT09IEdlblN0YXRlQ29tcGxldGVkKSB7CiAgICAgICAgaWYgKG1ldGhvZCA9PT0gInRocm93IikgewogICAgICAgICAgdGhyb3cgYXJnOwogICAgICAgIH0KCiAgICAgICAgLy8gQmUgZm9yZ2l2aW5nLCBwZXIgMjUuMy4zLjMuMyBvZiB0aGUgc3BlYzoKICAgICAgICAvLyBodHRwczovL3Blb3BsZS5tb3ppbGxhLm9yZy9+am9yZW5kb3JmZi9lczYtZHJhZnQuaHRtbCNzZWMtZ2VuZXJhdG9ycmVzdW1lCiAgICAgICAgcmV0dXJuIGRvbmVSZXN1bHQoKTsKICAgICAgfQoKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICB2YXIgZGVsZWdhdGUgPSBjb250ZXh0LmRlbGVnYXRlOwogICAgICAgIGlmIChkZWxlZ2F0ZSkgewogICAgICAgICAgaWYgKG1ldGhvZCA9PT0gInJldHVybiIgfHwKICAgICAgICAgICAgICAobWV0aG9kID09PSAidGhyb3ciICYmIGRlbGVnYXRlLml0ZXJhdG9yW21ldGhvZF0gPT09IHVuZGVmaW5lZCkpIHsKICAgICAgICAgICAgLy8gQSByZXR1cm4gb3IgdGhyb3cgKHdoZW4gdGhlIGRlbGVnYXRlIGl0ZXJhdG9yIGhhcyBubyB0aHJvdwogICAgICAgICAgICAvLyBtZXRob2QpIGFsd2F5cyB0ZXJtaW5hdGVzIHRoZSB5aWVsZCogbG9vcC4KICAgICAgICAgICAgY29udGV4dC5kZWxlZ2F0ZSA9IG51bGw7CgogICAgICAgICAgICAvLyBJZiB0aGUgZGVsZWdhdGUgaXRlcmF0b3IgaGFzIGEgcmV0dXJuIG1ldGhvZCwgZ2l2ZSBpdCBhCiAgICAgICAgICAgIC8vIGNoYW5jZSB0byBjbGVhbiB1cC4KICAgICAgICAgICAgdmFyIHJldHVybk1ldGhvZCA9IGRlbGVnYXRlLml0ZXJhdG9yWyJyZXR1cm4iXTsKICAgICAgICAgICAgaWYgKHJldHVybk1ldGhvZCkgewogICAgICAgICAgICAgIHZhciByZWNvcmQgPSB0cnlDYXRjaChyZXR1cm5NZXRob2QsIGRlbGVnYXRlLml0ZXJhdG9yLCBhcmcpOwogICAgICAgICAgICAgIGlmIChyZWNvcmQudHlwZSA9PT0gInRocm93IikgewogICAgICAgICAgICAgICAgLy8gSWYgdGhlIHJldHVybiBtZXRob2QgdGhyZXcgYW4gZXhjZXB0aW9uLCBsZXQgdGhhdAogICAgICAgICAgICAgICAgLy8gZXhjZXB0aW9uIHByZXZhaWwgb3ZlciB0aGUgb3JpZ2luYWwgcmV0dXJuIG9yIHRocm93LgogICAgICAgICAgICAgICAgbWV0aG9kID0gInRocm93IjsKICAgICAgICAgICAgICAgIGFyZyA9IHJlY29yZC5hcmc7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChtZXRob2QgPT09ICJyZXR1cm4iKSB7CiAgICAgICAgICAgICAgLy8gQ29udGludWUgd2l0aCB0aGUgb3V0ZXIgcmV0dXJuLCBub3cgdGhhdCB0aGUgZGVsZWdhdGUKICAgICAgICAgICAgICAvLyBpdGVyYXRvciBoYXMgYmVlbiB0ZXJtaW5hdGVkLgogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHJlY29yZCA9IHRyeUNhdGNoKAogICAgICAgICAgICBkZWxlZ2F0ZS5pdGVyYXRvclttZXRob2RdLAogICAgICAgICAgICBkZWxlZ2F0ZS5pdGVyYXRvciwKICAgICAgICAgICAgYXJnCiAgICAgICAgICApOwoKICAgICAgICAgIGlmIChyZWNvcmQudHlwZSA9PT0gInRocm93IikgewogICAgICAgICAgICBjb250ZXh0LmRlbGVnYXRlID0gbnVsbDsKCiAgICAgICAgICAgIC8vIExpa2UgcmV0dXJuaW5nIGdlbmVyYXRvci50aHJvdyh1bmNhdWdodCksIGJ1dCB3aXRob3V0IHRoZQogICAgICAgICAgICAvLyBvdmVyaGVhZCBvZiBhbiBleHRyYSBmdW5jdGlvbiBjYWxsLgogICAgICAgICAgICBtZXRob2QgPSAidGhyb3ciOwogICAgICAgICAgICBhcmcgPSByZWNvcmQuYXJnOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBEZWxlZ2F0ZSBnZW5lcmF0b3IgcmFuIGFuZCBoYW5kbGVkIGl0cyBvd24gZXhjZXB0aW9ucyBzbwogICAgICAgICAgLy8gcmVnYXJkbGVzcyBvZiB3aGF0IHRoZSBtZXRob2Qgd2FzLCB3ZSBjb250aW51ZSBhcyBpZiBpdCBpcwogICAgICAgICAgLy8gIm5leHQiIHdpdGggYW4gdW5kZWZpbmVkIGFyZy4KICAgICAgICAgIG1ldGhvZCA9ICJuZXh0IjsKICAgICAgICAgIGFyZyA9IHVuZGVmaW5lZDsKCiAgICAgICAgICB2YXIgaW5mbyA9IHJlY29yZC5hcmc7CiAgICAgICAgICBpZiAoaW5mby5kb25lKSB7CiAgICAgICAgICAgIGNvbnRleHRbZGVsZWdhdGUucmVzdWx0TmFtZV0gPSBpbmZvLnZhbHVlOwogICAgICAgICAgICBjb250ZXh0Lm5leHQgPSBkZWxlZ2F0ZS5uZXh0TG9jOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdGUgPSBHZW5TdGF0ZVN1c3BlbmRlZFlpZWxkOwogICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgIH0KCiAgICAgICAgICBjb250ZXh0LmRlbGVnYXRlID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChtZXRob2QgPT09ICJuZXh0IikgewogICAgICAgICAgLy8gU2V0dGluZyBjb250ZXh0Ll9zZW50IGZvciBsZWdhY3kgc3VwcG9ydCBvZiBCYWJlbCdzCiAgICAgICAgICAvLyBmdW5jdGlvbi5zZW50IGltcGxlbWVudGF0aW9uLgogICAgICAgICAgY29udGV4dC5zZW50ID0gY29udGV4dC5fc2VudCA9IGFyZzsKCiAgICAgICAgfSBlbHNlIGlmIChtZXRob2QgPT09ICJ0aHJvdyIpIHsKICAgICAgICAgIGlmIChzdGF0ZSA9PT0gR2VuU3RhdGVTdXNwZW5kZWRTdGFydCkgewogICAgICAgICAgICBzdGF0ZSA9IEdlblN0YXRlQ29tcGxldGVkOwogICAgICAgICAgICB0aHJvdyBhcmc7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGNvbnRleHQuZGlzcGF0Y2hFeGNlcHRpb24oYXJnKSkgewogICAgICAgICAgICAvLyBJZiB0aGUgZGlzcGF0Y2hlZCBleGNlcHRpb24gd2FzIGNhdWdodCBieSBhIGNhdGNoIGJsb2NrLAogICAgICAgICAgICAvLyB0aGVuIGxldCB0aGF0IGNhdGNoIGJsb2NrIGhhbmRsZSB0aGUgZXhjZXB0aW9uIG5vcm1hbGx5LgogICAgICAgICAgICBtZXRob2QgPSAibmV4dCI7CiAgICAgICAgICAgIGFyZyA9IHVuZGVmaW5lZDsKICAgICAgICAgIH0KCiAgICAgICAgfSBlbHNlIGlmIChtZXRob2QgPT09ICJyZXR1cm4iKSB7CiAgICAgICAgICBjb250ZXh0LmFicnVwdCgicmV0dXJuIiwgYXJnKTsKICAgICAgICB9CgogICAgICAgIHN0YXRlID0gR2VuU3RhdGVFeGVjdXRpbmc7CgogICAgICAgIHZhciByZWNvcmQgPSB0cnlDYXRjaChpbm5lckZuLCBzZWxmLCBjb250ZXh0KTsKICAgICAgICBpZiAocmVjb3JkLnR5cGUgPT09ICJub3JtYWwiKSB7CiAgICAgICAgICAvLyBJZiBhbiBleGNlcHRpb24gaXMgdGhyb3duIGZyb20gaW5uZXJGbiwgd2UgbGVhdmUgc3RhdGUgPT09CiAgICAgICAgICAvLyBHZW5TdGF0ZUV4ZWN1dGluZyBhbmQgbG9vcCBiYWNrIGZvciBhbm90aGVyIGludm9jYXRpb24uCiAgICAgICAgICBzdGF0ZSA9IGNvbnRleHQuZG9uZQogICAgICAgICAgICA/IEdlblN0YXRlQ29tcGxldGVkCiAgICAgICAgICAgIDogR2VuU3RhdGVTdXNwZW5kZWRZaWVsZDsKCiAgICAgICAgICB2YXIgaW5mbyA9IHsKICAgICAgICAgICAgdmFsdWU6IHJlY29yZC5hcmcsCiAgICAgICAgICAgIGRvbmU6IGNvbnRleHQuZG9uZQogICAgICAgICAgfTsKCiAgICAgICAgICBpZiAocmVjb3JkLmFyZyA9PT0gQ29udGludWVTZW50aW5lbCkgewogICAgICAgICAgICBpZiAoY29udGV4dC5kZWxlZ2F0ZSAmJiBtZXRob2QgPT09ICJuZXh0IikgewogICAgICAgICAgICAgIC8vIERlbGliZXJhdGVseSBmb3JnZXQgdGhlIGxhc3Qgc2VudCB2YWx1ZSBzbyB0aGF0IHdlIGRvbid0CiAgICAgICAgICAgICAgLy8gYWNjaWRlbnRhbGx5IHBhc3MgaXQgb24gdG8gdGhlIGRlbGVnYXRlLgogICAgICAgICAgICAgIGFyZyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGluZm87CiAgICAgICAgICB9CgogICAgICAgIH0gZWxzZSBpZiAocmVjb3JkLnR5cGUgPT09ICJ0aHJvdyIpIHsKICAgICAgICAgIHN0YXRlID0gR2VuU3RhdGVDb21wbGV0ZWQ7CiAgICAgICAgICAvLyBEaXNwYXRjaCB0aGUgZXhjZXB0aW9uIGJ5IGxvb3BpbmcgYmFjayBhcm91bmQgdG8gdGhlCiAgICAgICAgICAvLyBjb250ZXh0LmRpc3BhdGNoRXhjZXB0aW9uKGFyZykgY2FsbCBhYm92ZS4KICAgICAgICAgIG1ldGhvZCA9ICJ0aHJvdyI7CiAgICAgICAgICBhcmcgPSByZWNvcmQuYXJnOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9CgogIC8vIERlZmluZSBHZW5lcmF0b3IucHJvdG90eXBlLntuZXh0LHRocm93LHJldHVybn0gaW4gdGVybXMgb2YgdGhlCiAgLy8gdW5pZmllZCAuX2ludm9rZSBoZWxwZXIgbWV0aG9kLgogIGRlZmluZUl0ZXJhdG9yTWV0aG9kcyhHcCk7CgogIEdwW2l0ZXJhdG9yU3ltYm9sXSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgR3BbdG9TdHJpbmdUYWdTeW1ib2xdID0gIkdlbmVyYXRvciI7CgogIEdwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gIltvYmplY3QgR2VuZXJhdG9yXSI7CiAgfTsKCiAgZnVuY3Rpb24gcHVzaFRyeUVudHJ5KGxvY3MpIHsKICAgIHZhciBlbnRyeSA9IHsgdHJ5TG9jOiBsb2NzWzBdIH07CgogICAgaWYgKDEgaW4gbG9jcykgewogICAgICBlbnRyeS5jYXRjaExvYyA9IGxvY3NbMV07CiAgICB9CgogICAgaWYgKDIgaW4gbG9jcykgewogICAgICBlbnRyeS5maW5hbGx5TG9jID0gbG9jc1syXTsKICAgICAgZW50cnkuYWZ0ZXJMb2MgPSBsb2NzWzNdOwogICAgfQoKICAgIHRoaXMudHJ5RW50cmllcy5wdXNoKGVudHJ5KTsKICB9CgogIGZ1bmN0aW9uIHJlc2V0VHJ5RW50cnkoZW50cnkpIHsKICAgIHZhciByZWNvcmQgPSBlbnRyeS5jb21wbGV0aW9uIHx8IHt9OwogICAgcmVjb3JkLnR5cGUgPSAibm9ybWFsIjsKICAgIGRlbGV0ZSByZWNvcmQuYXJnOwogICAgZW50cnkuY29tcGxldGlvbiA9IHJlY29yZDsKICB9CgogIGZ1bmN0aW9uIENvbnRleHQodHJ5TG9jc0xpc3QpIHsKICAgIC8vIFRoZSByb290IGVudHJ5IG9iamVjdCAoZWZmZWN0aXZlbHkgYSB0cnkgc3RhdGVtZW50IHdpdGhvdXQgYSBjYXRjaAogICAgLy8gb3IgYSBmaW5hbGx5IGJsb2NrKSBnaXZlcyB1cyBhIHBsYWNlIHRvIHN0b3JlIHZhbHVlcyB0aHJvd24gZnJvbQogICAgLy8gbG9jYXRpb25zIHdoZXJlIHRoZXJlIGlzIG5vIGVuY2xvc2luZyB0cnkgc3RhdGVtZW50LgogICAgdGhpcy50cnlFbnRyaWVzID0gW3sgdHJ5TG9jOiAicm9vdCIgfV07CiAgICB0cnlMb2NzTGlzdC5mb3JFYWNoKHB1c2hUcnlFbnRyeSwgdGhpcyk7CiAgICB0aGlzLnJlc2V0KHRydWUpOwogIH0KCiAgcnVudGltZS5rZXlzID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICB2YXIga2V5cyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgewogICAgICBrZXlzLnB1c2goa2V5KTsKICAgIH0KICAgIGtleXMucmV2ZXJzZSgpOwoKICAgIC8vIFJhdGhlciB0aGFuIHJldHVybmluZyBhbiBvYmplY3Qgd2l0aCBhIG5leHQgbWV0aG9kLCB3ZSBrZWVwCiAgICAvLyB0aGluZ3Mgc2ltcGxlIGFuZCByZXR1cm4gdGhlIG5leHQgZnVuY3Rpb24gaXRzZWxmLgogICAgcmV0dXJuIGZ1bmN0aW9uIG5leHQoKSB7CiAgICAgIHdoaWxlIChrZXlzLmxlbmd0aCkgewogICAgICAgIHZhciBrZXkgPSBrZXlzLnBvcCgpOwogICAgICAgIGlmIChrZXkgaW4gb2JqZWN0KSB7CiAgICAgICAgICBuZXh0LnZhbHVlID0ga2V5OwogICAgICAgICAgbmV4dC5kb25lID0gZmFsc2U7CiAgICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFRvIGF2b2lkIGNyZWF0aW5nIGFuIGFkZGl0aW9uYWwgb2JqZWN0LCB3ZSBqdXN0IGhhbmcgdGhlIC52YWx1ZQogICAgICAvLyBhbmQgLmRvbmUgcHJvcGVydGllcyBvZmYgdGhlIG5leHQgZnVuY3Rpb24gb2JqZWN0IGl0c2VsZi4gVGhpcwogICAgICAvLyBhbHNvIGVuc3VyZXMgdGhhdCB0aGUgbWluaWZpZXIgd2lsbCBub3QgYW5vbnltaXplIHRoZSBmdW5jdGlvbi4KICAgICAgbmV4dC5kb25lID0gdHJ1ZTsKICAgICAgcmV0dXJuIG5leHQ7CiAgICB9OwogIH07CgogIGZ1bmN0aW9uIHZhbHVlcyhpdGVyYWJsZSkgewogICAgaWYgKGl0ZXJhYmxlKSB7CiAgICAgIHZhciBpdGVyYXRvck1ldGhvZCA9IGl0ZXJhYmxlW2l0ZXJhdG9yU3ltYm9sXTsKICAgICAgaWYgKGl0ZXJhdG9yTWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGl0ZXJhdG9yTWV0aG9kLmNhbGwoaXRlcmFibGUpOwogICAgICB9CgogICAgICBpZiAodHlwZW9mIGl0ZXJhYmxlLm5leHQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICByZXR1cm4gaXRlcmFibGU7CiAgICAgIH0KCiAgICAgIGlmICghaXNOYU4oaXRlcmFibGUubGVuZ3RoKSkgewogICAgICAgIHZhciBpID0gLTEsIG5leHQgPSBmdW5jdGlvbiBuZXh0KCkgewogICAgICAgICAgd2hpbGUgKCsraSA8IGl0ZXJhYmxlLmxlbmd0aCkgewogICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwoaXRlcmFibGUsIGkpKSB7CiAgICAgICAgICAgICAgbmV4dC52YWx1ZSA9IGl0ZXJhYmxlW2ldOwogICAgICAgICAgICAgIG5leHQuZG9uZSA9IGZhbHNlOwogICAgICAgICAgICAgIHJldHVybiBuZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgbmV4dC52YWx1ZSA9IHVuZGVmaW5lZDsKICAgICAgICAgIG5leHQuZG9uZSA9IHRydWU7CgogICAgICAgICAgcmV0dXJuIG5leHQ7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIG5leHQubmV4dCA9IG5leHQ7CiAgICAgIH0KICAgIH0KCiAgICAvLyBSZXR1cm4gYW4gaXRlcmF0b3Igd2l0aCBubyB2YWx1ZXMuCiAgICByZXR1cm4geyBuZXh0OiBkb25lUmVzdWx0IH07CiAgfQogIHJ1bnRpbWUudmFsdWVzID0gdmFsdWVzOwoKICBmdW5jdGlvbiBkb25lUmVzdWx0KCkgewogICAgcmV0dXJuIHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9OwogIH0KCiAgQ29udGV4dC5wcm90b3R5cGUgPSB7CiAgICBjb25zdHJ1Y3RvcjogQ29udGV4dCwKCiAgICByZXNldDogZnVuY3Rpb24oc2tpcFRlbXBSZXNldCkgewogICAgICB0aGlzLnByZXYgPSAwOwogICAgICB0aGlzLm5leHQgPSAwOwogICAgICAvLyBSZXNldHRpbmcgY29udGV4dC5fc2VudCBmb3IgbGVnYWN5IHN1cHBvcnQgb2YgQmFiZWwncwogICAgICAvLyBmdW5jdGlvbi5zZW50IGltcGxlbWVudGF0aW9uLgogICAgICB0aGlzLnNlbnQgPSB0aGlzLl9zZW50ID0gdW5kZWZpbmVkOwogICAgICB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgdGhpcy5kZWxlZ2F0ZSA9IG51bGw7CgogICAgICB0aGlzLnRyeUVudHJpZXMuZm9yRWFjaChyZXNldFRyeUVudHJ5KTsKCiAgICAgIGlmICghc2tpcFRlbXBSZXNldCkgewogICAgICAgIGZvciAodmFyIG5hbWUgaW4gdGhpcykgewogICAgICAgICAgLy8gTm90IHN1cmUgYWJvdXQgdGhlIG9wdGltYWwgb3JkZXIgb2YgdGhlc2UgY29uZGl0aW9uczoKICAgICAgICAgIGlmIChuYW1lLmNoYXJBdCgwKSA9PT0gInQiICYmCiAgICAgICAgICAgICAgaGFzT3duLmNhbGwodGhpcywgbmFtZSkgJiYKICAgICAgICAgICAgICAhaXNOYU4oK25hbWUuc2xpY2UoMSkpKSB7CiAgICAgICAgICAgIHRoaXNbbmFtZV0gPSB1bmRlZmluZWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmRvbmUgPSB0cnVlOwoKICAgICAgdmFyIHJvb3RFbnRyeSA9IHRoaXMudHJ5RW50cmllc1swXTsKICAgICAgdmFyIHJvb3RSZWNvcmQgPSByb290RW50cnkuY29tcGxldGlvbjsKICAgICAgaWYgKHJvb3RSZWNvcmQudHlwZSA9PT0gInRocm93IikgewogICAgICAgIHRocm93IHJvb3RSZWNvcmQuYXJnOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5ydmFsOwogICAgfSwKCiAgICBkaXNwYXRjaEV4Y2VwdGlvbjogZnVuY3Rpb24oZXhjZXB0aW9uKSB7CiAgICAgIGlmICh0aGlzLmRvbmUpIHsKICAgICAgICB0aHJvdyBleGNlcHRpb247CiAgICAgIH0KCiAgICAgIHZhciBjb250ZXh0ID0gdGhpczsKICAgICAgZnVuY3Rpb24gaGFuZGxlKGxvYywgY2F1Z2h0KSB7CiAgICAgICAgcmVjb3JkLnR5cGUgPSAidGhyb3ciOwogICAgICAgIHJlY29yZC5hcmcgPSBleGNlcHRpb247CiAgICAgICAgY29udGV4dC5uZXh0ID0gbG9jOwogICAgICAgIHJldHVybiAhIWNhdWdodDsKICAgICAgfQoKICAgICAgZm9yICh2YXIgaSA9IHRoaXMudHJ5RW50cmllcy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgIHZhciBlbnRyeSA9IHRoaXMudHJ5RW50cmllc1tpXTsKICAgICAgICB2YXIgcmVjb3JkID0gZW50cnkuY29tcGxldGlvbjsKCiAgICAgICAgaWYgKGVudHJ5LnRyeUxvYyA9PT0gInJvb3QiKSB7CiAgICAgICAgICAvLyBFeGNlcHRpb24gdGhyb3duIG91dHNpZGUgb2YgYW55IHRyeSBibG9jayB0aGF0IGNvdWxkIGhhbmRsZQogICAgICAgICAgLy8gaXQsIHNvIHNldCB0aGUgY29tcGxldGlvbiB2YWx1ZSBvZiB0aGUgZW50aXJlIGZ1bmN0aW9uIHRvCiAgICAgICAgICAvLyB0aHJvdyB0aGUgZXhjZXB0aW9uLgogICAgICAgICAgcmV0dXJuIGhhbmRsZSgiZW5kIik7CiAgICAgICAgfQoKICAgICAgICBpZiAoZW50cnkudHJ5TG9jIDw9IHRoaXMucHJldikgewogICAgICAgICAgdmFyIGhhc0NhdGNoID0gaGFzT3duLmNhbGwoZW50cnksICJjYXRjaExvYyIpOwogICAgICAgICAgdmFyIGhhc0ZpbmFsbHkgPSBoYXNPd24uY2FsbChlbnRyeSwgImZpbmFsbHlMb2MiKTsKCiAgICAgICAgICBpZiAoaGFzQ2F0Y2ggJiYgaGFzRmluYWxseSkgewogICAgICAgICAgICBpZiAodGhpcy5wcmV2IDwgZW50cnkuY2F0Y2hMb2MpIHsKICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlKGVudHJ5LmNhdGNoTG9jLCB0cnVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnByZXYgPCBlbnRyeS5maW5hbGx5TG9jKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZShlbnRyeS5maW5hbGx5TG9jKTsKICAgICAgICAgICAgfQoKICAgICAgICAgIH0gZWxzZSBpZiAoaGFzQ2F0Y2gpIHsKICAgICAgICAgICAgaWYgKHRoaXMucHJldiA8IGVudHJ5LmNhdGNoTG9jKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZShlbnRyeS5jYXRjaExvYywgdHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9IGVsc2UgaWYgKGhhc0ZpbmFsbHkpIHsKICAgICAgICAgICAgaWYgKHRoaXMucHJldiA8IGVudHJ5LmZpbmFsbHlMb2MpIHsKICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlKGVudHJ5LmZpbmFsbHlMb2MpOwogICAgICAgICAgICB9CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ0cnkgc3RhdGVtZW50IHdpdGhvdXQgY2F0Y2ggb3IgZmluYWxseSIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBhYnJ1cHQ6IGZ1bmN0aW9uKHR5cGUsIGFyZykgewogICAgICBmb3IgKHZhciBpID0gdGhpcy50cnlFbnRyaWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgdmFyIGVudHJ5ID0gdGhpcy50cnlFbnRyaWVzW2ldOwogICAgICAgIGlmIChlbnRyeS50cnlMb2MgPD0gdGhpcy5wcmV2ICYmCiAgICAgICAgICAgIGhhc093bi5jYWxsKGVudHJ5LCAiZmluYWxseUxvYyIpICYmCiAgICAgICAgICAgIHRoaXMucHJldiA8IGVudHJ5LmZpbmFsbHlMb2MpIHsKICAgICAgICAgIHZhciBmaW5hbGx5RW50cnkgPSBlbnRyeTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGZpbmFsbHlFbnRyeSAmJgogICAgICAgICAgKHR5cGUgPT09ICJicmVhayIgfHwKICAgICAgICAgICB0eXBlID09PSAiY29udGludWUiKSAmJgogICAgICAgICAgZmluYWxseUVudHJ5LnRyeUxvYyA8PSBhcmcgJiYKICAgICAgICAgIGFyZyA8PSBmaW5hbGx5RW50cnkuZmluYWxseUxvYykgewogICAgICAgIC8vIElnbm9yZSB0aGUgZmluYWxseSBlbnRyeSBpZiBjb250cm9sIGlzIG5vdCBqdW1waW5nIHRvIGEKICAgICAgICAvLyBsb2NhdGlvbiBvdXRzaWRlIHRoZSB0cnkvY2F0Y2ggYmxvY2suCiAgICAgICAgZmluYWxseUVudHJ5ID0gbnVsbDsKICAgICAgfQoKICAgICAgdmFyIHJlY29yZCA9IGZpbmFsbHlFbnRyeSA/IGZpbmFsbHlFbnRyeS5jb21wbGV0aW9uIDoge307CiAgICAgIHJlY29yZC50eXBlID0gdHlwZTsKICAgICAgcmVjb3JkLmFyZyA9IGFyZzsKCiAgICAgIGlmIChmaW5hbGx5RW50cnkpIHsKICAgICAgICB0aGlzLm5leHQgPSBmaW5hbGx5RW50cnkuZmluYWxseUxvYzsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmNvbXBsZXRlKHJlY29yZCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBDb250aW51ZVNlbnRpbmVsOwogICAgfSwKCiAgICBjb21wbGV0ZTogZnVuY3Rpb24ocmVjb3JkLCBhZnRlckxvYykgewogICAgICBpZiAocmVjb3JkLnR5cGUgPT09ICJ0aHJvdyIpIHsKICAgICAgICB0aHJvdyByZWNvcmQuYXJnOwogICAgICB9CgogICAgICBpZiAocmVjb3JkLnR5cGUgPT09ICJicmVhayIgfHwKICAgICAgICAgIHJlY29yZC50eXBlID09PSAiY29udGludWUiKSB7CiAgICAgICAgdGhpcy5uZXh0ID0gcmVjb3JkLmFyZzsKICAgICAgfSBlbHNlIGlmIChyZWNvcmQudHlwZSA9PT0gInJldHVybiIpIHsKICAgICAgICB0aGlzLnJ2YWwgPSByZWNvcmQuYXJnOwogICAgICAgIHRoaXMubmV4dCA9ICJlbmQiOwogICAgICB9IGVsc2UgaWYgKHJlY29yZC50eXBlID09PSAibm9ybWFsIiAmJiBhZnRlckxvYykgewogICAgICAgIHRoaXMubmV4dCA9IGFmdGVyTG9jOwogICAgICB9CiAgICB9LAoKICAgIGZpbmlzaDogZnVuY3Rpb24oZmluYWxseUxvYykgewogICAgICBmb3IgKHZhciBpID0gdGhpcy50cnlFbnRyaWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgdmFyIGVudHJ5ID0gdGhpcy50cnlFbnRyaWVzW2ldOwogICAgICAgIGlmIChlbnRyeS5maW5hbGx5TG9jID09PSBmaW5hbGx5TG9jKSB7CiAgICAgICAgICB0aGlzLmNvbXBsZXRlKGVudHJ5LmNvbXBsZXRpb24sIGVudHJ5LmFmdGVyTG9jKTsKICAgICAgICAgIHJlc2V0VHJ5RW50cnkoZW50cnkpOwogICAgICAgICAgcmV0dXJuIENvbnRpbnVlU2VudGluZWw7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgICJjYXRjaCI6IGZ1bmN0aW9uKHRyeUxvYykgewogICAgICBmb3IgKHZhciBpID0gdGhpcy50cnlFbnRyaWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgdmFyIGVudHJ5ID0gdGhpcy50cnlFbnRyaWVzW2ldOwogICAgICAgIGlmIChlbnRyeS50cnlMb2MgPT09IHRyeUxvYykgewogICAgICAgICAgdmFyIHJlY29yZCA9IGVudHJ5LmNvbXBsZXRpb247CiAgICAgICAgICBpZiAocmVjb3JkLnR5cGUgPT09ICJ0aHJvdyIpIHsKICAgICAgICAgICAgdmFyIHRocm93biA9IHJlY29yZC5hcmc7CiAgICAgICAgICAgIHJlc2V0VHJ5RW50cnkoZW50cnkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRocm93bjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFRoZSBjb250ZXh0LmNhdGNoIG1ldGhvZCBtdXN0IG9ubHkgYmUgY2FsbGVkIHdpdGggYSBsb2NhdGlvbgogICAgICAvLyBhcmd1bWVudCB0aGF0IGNvcnJlc3BvbmRzIHRvIGEga25vd24gY2F0Y2ggYmxvY2suCiAgICAgIHRocm93IG5ldyBFcnJvcigiaWxsZWdhbCBjYXRjaCBhdHRlbXB0Iik7CiAgICB9LAoKICAgIGRlbGVnYXRlWWllbGQ6IGZ1bmN0aW9uKGl0ZXJhYmxlLCByZXN1bHROYW1lLCBuZXh0TG9jKSB7CiAgICAgIHRoaXMuZGVsZWdhdGUgPSB7CiAgICAgICAgaXRlcmF0b3I6IHZhbHVlcyhpdGVyYWJsZSksCiAgICAgICAgcmVzdWx0TmFtZTogcmVzdWx0TmFtZSwKICAgICAgICBuZXh0TG9jOiBuZXh0TG9jCiAgICAgIH07CgogICAgICByZXR1cm4gQ29udGludWVTZW50aW5lbDsKICAgIH0KICB9Owp9KSgKICAvLyBBbW9uZyB0aGUgdmFyaW91cyB0cmlja3MgZm9yIG9idGFpbmluZyBhIHJlZmVyZW5jZSB0byB0aGUgZ2xvYmFsCiAgLy8gb2JqZWN0LCB0aGlzIHNlZW1zIHRvIGJlIHRoZSBtb3N0IHJlbGlhYmxlIHRlY2huaXF1ZSB0aGF0IGRvZXMgbm90CiAgLy8gdXNlIGluZGlyZWN0IGV2YWwgKHdoaWNoIHZpb2xhdGVzIENvbnRlbnQgU2VjdXJpdHkgUG9saWN5KS4KICB0eXBlb2YgZ2xvYmFsID09PSAib2JqZWN0IiA/IGdsb2JhbCA6CiAgdHlwZW9mIHdpbmRvdyA9PT0gIm9iamVjdCIgPyB3aW5kb3cgOgogIHR5cGVvZiBzZWxmID09PSAib2JqZWN0IiA/IHNlbGYgOiB0aGlzCik7Cgo7KGZ1bmN0aW9uKCkgewovKiEKICogQG92ZXJ2aWV3ICBFbWJlciAtIEphdmFTY3JpcHQgQXBwbGljYXRpb24gRnJhbWV3b3JrCiAqIEBjb3B5cmlnaHQgQ29weXJpZ2h0IDIwMTEtMjAxOSBUaWxkZSBJbmMuIGFuZCBjb250cmlidXRvcnMKICogICAgICAgICAgICBQb3J0aW9ucyBDb3B5cmlnaHQgMjAwNi0yMDExIFN0cm9iZSBJbmMuCiAqICAgICAgICAgICAgUG9ydGlvbnMgQ29weXJpZ2h0IDIwMDgtMjAxMSBBcHBsZSBJbmMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIEBsaWNlbnNlICAgTGljZW5zZWQgdW5kZXIgTUlUIGxpY2Vuc2UKICogICAgICAgICAgICBTZWUgaHR0cHM6Ly9yYXcuZ2l0aHViLmNvbS9lbWJlcmpzL2VtYmVyLmpzL21hc3Rlci9MSUNFTlNFCiAqIEB2ZXJzaW9uICAgMy4xNC4xCiAqLwoKLypnbG9iYWxzIHByb2Nlc3MgKi8KbGV0IGRlZmluZSwgcmVxdWlyZSwgRW1iZXI7CgovLyBVc2VkIGluIEBlbWJlci8taW50ZXJuYWxzL2Vudmlyb25tZW50L2xpYi9nbG9iYWwuanMKbWFpbkNvbnRleHQgPSB0aGlzOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVuZGVmCgooZnVuY3Rpb24oKSB7CiAgbGV0IHJlZ2lzdHJ5OwogIGxldCBzZWVuOwoKICBmdW5jdGlvbiBtaXNzaW5nTW9kdWxlKG5hbWUsIHJlZmVycmVyTmFtZSkgewogICAgaWYgKHJlZmVycmVyTmFtZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kIG1vZHVsZSAnICsgbmFtZSArICcgcmVxdWlyZWQgYnk6ICcgKyByZWZlcnJlck5hbWUpOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZmluZCBtb2R1bGUgJyArIG5hbWUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW50ZXJuYWxSZXF1aXJlKF9uYW1lLCByZWZlcnJlck5hbWUpIHsKICAgIGxldCBuYW1lID0gX25hbWU7CiAgICBsZXQgbW9kID0gcmVnaXN0cnlbbmFtZV07CgogICAgaWYgKCFtb2QpIHsKICAgICAgbmFtZSA9IG5hbWUgKyAnL2luZGV4JzsKICAgICAgbW9kID0gcmVnaXN0cnlbbmFtZV07CiAgICB9CgogICAgbGV0IGV4cG9ydHMgPSBzZWVuW25hbWVdOwoKICAgIGlmIChleHBvcnRzICE9PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIGV4cG9ydHM7CiAgICB9CgogICAgZXhwb3J0cyA9IHNlZW5bbmFtZV0gPSB7fTsKCiAgICBpZiAoIW1vZCkgewogICAgICBtaXNzaW5nTW9kdWxlKF9uYW1lLCByZWZlcnJlck5hbWUpOwogICAgfQoKICAgIGxldCBkZXBzID0gbW9kLmRlcHM7CiAgICBsZXQgY2FsbGJhY2sgPSBtb2QuY2FsbGJhY2s7CiAgICBsZXQgcmVpZmllZCA9IG5ldyBBcnJheShkZXBzLmxlbmd0aCk7CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkZXBzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChkZXBzW2ldID09PSAnZXhwb3J0cycpIHsKICAgICAgICByZWlmaWVkW2ldID0gZXhwb3J0czsKICAgICAgfSBlbHNlIGlmIChkZXBzW2ldID09PSAncmVxdWlyZScpIHsKICAgICAgICByZWlmaWVkW2ldID0gcmVxdWlyZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZWlmaWVkW2ldID0gaW50ZXJuYWxSZXF1aXJlKGRlcHNbaV0sIG5hbWUpOwogICAgICB9CiAgICB9CgogICAgY2FsbGJhY2suYXBwbHkodGhpcywgcmVpZmllZCk7CgogICAgcmV0dXJuIGV4cG9ydHM7CiAgfQoKICBsZXQgaXNOb2RlID0KICAgIHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnICYmCiAgICB0eXBlb2YgcHJvY2VzcyAhPT0gJ3VuZGVmaW5lZCcgJiYKICAgIHt9LnRvU3RyaW5nLmNhbGwocHJvY2VzcykgPT09ICdbb2JqZWN0IHByb2Nlc3NdJzsKCiAgaWYgKCFpc05vZGUpIHsKICAgIEVtYmVyID0gdGhpcy5FbWJlciA9IHRoaXMuRW1iZXIgfHwge307CiAgfQoKICBpZiAodHlwZW9mIEVtYmVyID09PSAndW5kZWZpbmVkJykgewogICAgRW1iZXIgPSB7fTsKICB9CgogIGlmICh0eXBlb2YgRW1iZXIuX19sb2FkZXIgPT09ICd1bmRlZmluZWQnKSB7CiAgICByZWdpc3RyeSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICBzZWVuID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCiAgICBkZWZpbmUgPSBmdW5jdGlvbihuYW1lLCBkZXBzLCBjYWxsYmFjaykgewogICAgICBsZXQgdmFsdWUgPSB7fTsKCiAgICAgIGlmICghY2FsbGJhY2spIHsKICAgICAgICB2YWx1ZS5kZXBzID0gW107CiAgICAgICAgdmFsdWUuY2FsbGJhY2sgPSBkZXBzOwogICAgICB9IGVsc2UgewogICAgICAgIHZhbHVlLmRlcHMgPSBkZXBzOwogICAgICAgIHZhbHVlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgIH0KCiAgICAgIHJlZ2lzdHJ5W25hbWVdID0gdmFsdWU7CiAgICB9OwoKICAgIHJlcXVpcmUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHJldHVybiBpbnRlcm5hbFJlcXVpcmUobmFtZSwgbnVsbCk7CiAgICB9OwoKICAgIC8vIHNldHVwIGByZXF1aXJlYCBtb2R1bGUKICAgIHJlcXVpcmVbJ2RlZmF1bHQnXSA9IHJlcXVpcmU7CgogICAgcmVxdWlyZS5oYXMgPSBmdW5jdGlvbiByZWdpc3RyeUhhcyhtb2R1bGVOYW1lKSB7CiAgICAgIHJldHVybiBCb29sZWFuKHJlZ2lzdHJ5W21vZHVsZU5hbWVdKSB8fCBCb29sZWFuKHJlZ2lzdHJ5W21vZHVsZU5hbWUgKyAnL2luZGV4J10pOwogICAgfTsKCiAgICByZXF1aXJlLl9lYWtfc2VlbiA9IHJlZ2lzdHJ5OwoKICAgIEVtYmVyLl9fbG9hZGVyID0gewogICAgICBkZWZpbmU6IGRlZmluZSwKICAgICAgcmVxdWlyZTogcmVxdWlyZSwKICAgICAgcmVnaXN0cnk6IHJlZ2lzdHJ5LAogICAgfTsKICB9IGVsc2UgewogICAgZGVmaW5lID0gRW1iZXIuX19sb2FkZXIuZGVmaW5lOwogICAgcmVxdWlyZSA9IEVtYmVyLl9fbG9hZGVyLnJlcXVpcmU7CiAgfQp9KSgpOwoKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9icm93c2VyLWVudmlyb25tZW50L2luZGV4IiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuaGFzRE9NID0gX2V4cG9ydHMuaXNGaXJlZm94ID0gX2V4cG9ydHMuaXNDaHJvbWUgPSBfZXhwb3J0cy51c2VyQWdlbnQgPSBfZXhwb3J0cy5oaXN0b3J5ID0gX2V4cG9ydHMubG9jYXRpb24gPSBfZXhwb3J0cy53aW5kb3cgPSB2b2lkIDA7CiAgLy8gY2hlY2sgaWYgd2luZG93IGV4aXN0cyBhbmQgYWN0dWFsbHkgaXMgdGhlIGdsb2JhbAogIHZhciBoYXNEb20gPSB0eXBlb2Ygc2VsZiA9PT0gJ29iamVjdCcgJiYgc2VsZiAhPT0gbnVsbCAmJiBzZWxmLk9iamVjdCA9PT0gT2JqZWN0ICYmIHR5cGVvZiBXaW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHNlbGYuY29uc3RydWN0b3IgPT09IFdpbmRvdyAmJiB0eXBlb2YgZG9jdW1lbnQgPT09ICdvYmplY3QnICYmIGRvY3VtZW50ICE9PSBudWxsICYmIHNlbGYuZG9jdW1lbnQgPT09IGRvY3VtZW50ICYmIHR5cGVvZiBsb2NhdGlvbiA9PT0gJ29iamVjdCcgJiYgbG9jYXRpb24gIT09IG51bGwgJiYgc2VsZi5sb2NhdGlvbiA9PT0gbG9jYXRpb24gJiYgdHlwZW9mIGhpc3RvcnkgPT09ICdvYmplY3QnICYmIGhpc3RvcnkgIT09IG51bGwgJiYgc2VsZi5oaXN0b3J5ID09PSBoaXN0b3J5ICYmIHR5cGVvZiBuYXZpZ2F0b3IgPT09ICdvYmplY3QnICYmIG5hdmlnYXRvciAhPT0gbnVsbCAmJiBzZWxmLm5hdmlnYXRvciA9PT0gbmF2aWdhdG9yICYmIHR5cGVvZiBuYXZpZ2F0b3IudXNlckFnZW50ID09PSAnc3RyaW5nJzsKICBfZXhwb3J0cy5oYXNET00gPSBoYXNEb207CiAgdmFyIHdpbmRvdyA9IGhhc0RvbSA/IHNlbGYgOiBudWxsOwogIF9leHBvcnRzLndpbmRvdyA9IHdpbmRvdzsKICB2YXIgbG9jYXRpb24kMSA9IGhhc0RvbSA/IHNlbGYubG9jYXRpb24gOiBudWxsOwogIF9leHBvcnRzLmxvY2F0aW9uID0gbG9jYXRpb24kMTsKICB2YXIgaGlzdG9yeSQxID0gaGFzRG9tID8gc2VsZi5oaXN0b3J5IDogbnVsbDsKICBfZXhwb3J0cy5oaXN0b3J5ID0gaGlzdG9yeSQxOwogIHZhciB1c2VyQWdlbnQgPSBoYXNEb20gPyBzZWxmLm5hdmlnYXRvci51c2VyQWdlbnQgOiAnTHlueCAodGV4dG1vZGUpJzsKICBfZXhwb3J0cy51c2VyQWdlbnQgPSB1c2VyQWdlbnQ7CiAgdmFyIGlzQ2hyb21lID0gaGFzRG9tID8gQm9vbGVhbih3aW5kb3cuY2hyb21lKSAmJiAhd2luZG93Lm9wZXJhIDogZmFsc2U7CiAgX2V4cG9ydHMuaXNDaHJvbWUgPSBpc0Nocm9tZTsKICB2YXIgaXNGaXJlZm94ID0gaGFzRG9tID8gdHlwZW9mIEluc3RhbGxUcmlnZ2VyICE9PSAndW5kZWZpbmVkJyA6IGZhbHNlOwogIF9leHBvcnRzLmlzRmlyZWZveCA9IGlzRmlyZWZveDsKfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvY29uc29sZS9pbmRleCIsIFsiZXhwb3J0cyIsICJAZW1iZXIvZGVidWciLCAiQGVtYmVyL2RlcHJlY2F0ZWQtZmVhdHVyZXMiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZGVidWcsIF9kZXByZWNhdGVkRmVhdHVyZXMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CiAgLy8gRGVsaXZlciBtZXNzYWdlIHRoYXQgdGhlIGZ1bmN0aW9uIGlzIGRlcHJlY2F0ZWQKICB2YXIgREVQUkVDQVRJT05fTUVTU0FHRSA9ICdVc2Ugb2YgRW1iZXIuTG9nZ2VyIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSB1c2UgYGNvbnNvbGVgIGZvciBsb2dnaW5nLic7CiAgdmFyIERFUFJFQ0FUSU9OX0lEID0gJ2VtYmVyLWNvbnNvbGUuZGVwcmVjYXRlLWxvZ2dlcic7CiAgdmFyIERFUFJFQ0FUSU9OX1VSTCA9ICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92My54I3RvY191c2UtY29uc29sZS1yYXRoZXItdGhhbi1lbWJlci1sb2dnZXInOwogIC8qKgogICAgIEBtb2R1bGUgZW1iZXIKICAqLwoKICAvKioKICAgIEluc2lkZSBFbWJlci1NZXRhbCwgc2ltcGx5IHVzZXMgdGhlIG1ldGhvZHMgZnJvbSBgaW1wb3J0cy5jb25zb2xlYC4KICAgIE92ZXJyaWRlIHRoaXMgdG8gcHJvdmlkZSBtb3JlIHJvYnVzdCBsb2dnaW5nIGZ1bmN0aW9uYWxpdHkuCiAgCiAgICBAY2xhc3MgTG9nZ2VyCiAgICBAZGVwcmVjYXRlZCBVc2UgJ2NvbnNvbGUnIGluc3RlYWQKICAKICAgIEBuYW1lc3BhY2UgRW1iZXIKICAgIEBwdWJsaWMKICAqLwoKICB2YXIgREVQUkVDQVRFRF9MT0dHRVI7CgogIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLkxPR0dFUikgewogICAgREVQUkVDQVRFRF9MT0dHRVIgPSB7CiAgICAgIC8qKgogICAgICBMb2dzIHRoZSBhcmd1bWVudHMgdG8gdGhlIGNvbnNvbGUuCiAgICAgIFlvdSBjYW4gcGFzcyBhcyBtYW55IGFyZ3VtZW50cyBhcyB5b3Ugd2FudCBhbmQgdGhleSB3aWxsIGJlIGpvaW5lZCB0b2dldGhlciB3aXRoIGEgc3BhY2UuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHZhciBmb28gPSAxOwogICAgICBFbWJlci5Mb2dnZXIubG9nKCdsb2cgdmFsdWUgb2YgZm9vOicsIGZvbyk7CiAgICAgIC8vICJsb2cgdmFsdWUgb2YgZm9vOiAxIiB3aWxsIGJlIHByaW50ZWQgdG8gdGhlIGNvbnNvbGUKICAgICAgYGBgCiAgICAgIEBtZXRob2QgbG9nCiAgICAgIEBmb3IgRW1iZXIuTG9nZ2VyCiAgICAgIEBwYXJhbSB7Kn0gYXJndW1lbnRzCiAgICAgIEBwdWJsaWMKICAgICAgKi8KICAgICAgbG9nOiBmdW5jdGlvbiBsb2coKSB7CiAgICAgICAgdmFyIF9jb25zb2xlOwoKICAgICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKERFUFJFQ0FUSU9OX01FU1NBR0UsIGZhbHNlLCB7CiAgICAgICAgICBpZDogREVQUkVDQVRJT05fSUQsCiAgICAgICAgICB1bnRpbDogJzQuMC4wJywKICAgICAgICAgIHVybDogREVQUkVDQVRJT05fVVJMCiAgICAgICAgfSkpOwogICAgICAgIHJldHVybiAoX2NvbnNvbGUgPSBjb25zb2xlKS5sb2cuYXBwbHkoX2NvbnNvbGUsIGFyZ3VtZW50cyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZQogICAgICB9LAoKICAgICAgLyoqCiAgICAgIFByaW50cyB0aGUgYXJndW1lbnRzIHRvIHRoZSBjb25zb2xlIHdpdGggYSB3YXJuaW5nIGljb24uCiAgICAgIFlvdSBjYW4gcGFzcyBhcyBtYW55IGFyZ3VtZW50cyBhcyB5b3Ugd2FudCBhbmQgdGhleSB3aWxsIGJlIGpvaW5lZCB0b2dldGhlciB3aXRoIGEgc3BhY2UuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIEVtYmVyLkxvZ2dlci53YXJuKCdTb21ldGhpbmcgaGFwcGVuZWQhJyk7CiAgICAgIC8vICJTb21ldGhpbmcgaGFwcGVuZWQhIiB3aWxsIGJlIHByaW50ZWQgdG8gdGhlIGNvbnNvbGUgd2l0aCBhIHdhcm5pbmcgaWNvbi4KICAgICAgYGBgCiAgICAgIEBtZXRob2Qgd2FybgogICAgICBAZm9yIEVtYmVyLkxvZ2dlcgogICAgICBAcGFyYW0geyp9IGFyZ3VtZW50cwogICAgICBAcHVibGljCiAgICAgICovCiAgICAgIHdhcm46IGZ1bmN0aW9uIHdhcm4oKSB7CiAgICAgICAgdmFyIF9jb25zb2xlMjsKCiAgICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKShERVBSRUNBVElPTl9NRVNTQUdFLCBmYWxzZSwgewogICAgICAgICAgaWQ6IERFUFJFQ0FUSU9OX0lELAogICAgICAgICAgdW50aWw6ICc0LjAuMCcsCiAgICAgICAgICB1cmw6IERFUFJFQ0FUSU9OX1VSTAogICAgICAgIH0pKTsKICAgICAgICByZXR1cm4gKF9jb25zb2xlMiA9IGNvbnNvbGUpLndhcm4uYXBwbHkoX2NvbnNvbGUyLCBhcmd1bWVudHMpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGUKICAgICAgfSwKCiAgICAgIC8qKgogICAgICBQcmludHMgdGhlIGFyZ3VtZW50cyB0byB0aGUgY29uc29sZSB3aXRoIGFuIGVycm9yIGljb24sIHJlZCB0ZXh0IGFuZCBhIHN0YWNrIHRyYWNlLgogICAgICBZb3UgY2FuIHBhc3MgYXMgbWFueSBhcmd1bWVudHMgYXMgeW91IHdhbnQgYW5kIHRoZXkgd2lsbCBiZSBqb2luZWQgdG9nZXRoZXIgd2l0aCBhIHNwYWNlLgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBFbWJlci5Mb2dnZXIuZXJyb3IoJ0RhbmdlciEgRGFuZ2VyIScpOwogICAgICAvLyAiRGFuZ2VyISBEYW5nZXIhIiB3aWxsIGJlIHByaW50ZWQgdG8gdGhlIGNvbnNvbGUgaW4gcmVkIHRleHQuCiAgICAgIGBgYAogICAgICBAbWV0aG9kIGVycm9yCiAgICAgIEBmb3IgRW1iZXIuTG9nZ2VyCiAgICAgIEBwYXJhbSB7Kn0gYXJndW1lbnRzCiAgICAgIEBwdWJsaWMKICAgICAgKi8KICAgICAgZXJyb3I6IGZ1bmN0aW9uIGVycm9yKCkgewogICAgICAgIHZhciBfY29uc29sZTM7CgogICAgICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoREVQUkVDQVRJT05fTUVTU0FHRSwgZmFsc2UsIHsKICAgICAgICAgIGlkOiBERVBSRUNBVElPTl9JRCwKICAgICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgICAgdXJsOiBERVBSRUNBVElPTl9VUkwKICAgICAgICB9KSk7CiAgICAgICAgcmV0dXJuIChfY29uc29sZTMgPSBjb25zb2xlKS5lcnJvci5hcHBseShfY29uc29sZTMsIGFyZ3VtZW50cyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZQogICAgICB9LAoKICAgICAgLyoqCiAgICAgIExvZ3MgdGhlIGFyZ3VtZW50cyB0byB0aGUgY29uc29sZS4KICAgICAgWW91IGNhbiBwYXNzIGFzIG1hbnkgYXJndW1lbnRzIGFzIHlvdSB3YW50IGFuZCB0aGV5IHdpbGwgYmUgam9pbmVkIHRvZ2V0aGVyIHdpdGggYSBzcGFjZS4KICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgdmFyIGZvbyA9IDE7CiAgICAgIEVtYmVyLkxvZ2dlci5pbmZvKCdsb2cgdmFsdWUgb2YgZm9vOicsIGZvbyk7CiAgICAgIC8vICJsb2cgdmFsdWUgb2YgZm9vOiAxIiB3aWxsIGJlIHByaW50ZWQgdG8gdGhlIGNvbnNvbGUKICAgICAgYGBgCiAgICAgIEBtZXRob2QgaW5mbwogICAgICBAZm9yIEVtYmVyLkxvZ2dlcgogICAgICBAcGFyYW0geyp9IGFyZ3VtZW50cwogICAgICBAcHVibGljCiAgICAgICovCiAgICAgIGluZm86IGZ1bmN0aW9uIGluZm8oKSB7CiAgICAgICAgdmFyIF9jb25zb2xlNDsKCiAgICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKShERVBSRUNBVElPTl9NRVNTQUdFLCBmYWxzZSwgewogICAgICAgICAgaWQ6IERFUFJFQ0FUSU9OX0lELAogICAgICAgICAgdW50aWw6ICc0LjAuMCcsCiAgICAgICAgICB1cmw6IERFUFJFQ0FUSU9OX1VSTAogICAgICAgIH0pKTsKICAgICAgICByZXR1cm4gKF9jb25zb2xlNCA9IGNvbnNvbGUpLmluZm8uYXBwbHkoX2NvbnNvbGU0LCBhcmd1bWVudHMpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGUKICAgICAgfSwKCiAgICAgIC8qKgogICAgICBMb2dzIHRoZSBhcmd1bWVudHMgdG8gdGhlIGNvbnNvbGUgaW4gYmx1ZSB0ZXh0LgogICAgICBZb3UgY2FuIHBhc3MgYXMgbWFueSBhcmd1bWVudHMgYXMgeW91IHdhbnQgYW5kIHRoZXkgd2lsbCBiZSBqb2luZWQgdG9nZXRoZXIgd2l0aCBhIHNwYWNlLgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICB2YXIgZm9vID0gMTsKICAgICAgRW1iZXIuTG9nZ2VyLmRlYnVnKCdsb2cgdmFsdWUgb2YgZm9vOicsIGZvbyk7CiAgICAgIC8vICJsb2cgdmFsdWUgb2YgZm9vOiAxIiB3aWxsIGJlIHByaW50ZWQgdG8gdGhlIGNvbnNvbGUKICAgICAgYGBgCiAgICAgIEBtZXRob2QgZGVidWcKICAgICAgQGZvciBFbWJlci5Mb2dnZXIKICAgICAgQHBhcmFtIHsqfSBhcmd1bWVudHMKICAgICAgQHB1YmxpYwogICAgICAqLwogICAgICBkZWJ1ZzogZnVuY3Rpb24gZGVidWcoKSB7CiAgICAgICAgdmFyIF9jb25zb2xlNjsKCiAgICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKShERVBSRUNBVElPTl9NRVNTQUdFLCBmYWxzZSwgewogICAgICAgICAgaWQ6IERFUFJFQ0FUSU9OX0lELAogICAgICAgICAgdW50aWw6ICc0LjAuMCcsCiAgICAgICAgICB1cmw6IERFUFJFQ0FUSU9OX1VSTAogICAgICAgIH0pKTsKICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1jb25zb2xlICovCgogICAgICAgIGlmIChjb25zb2xlLmRlYnVnKSB7CiAgICAgICAgICB2YXIgX2NvbnNvbGU1OwoKICAgICAgICAgIHJldHVybiAoX2NvbnNvbGU1ID0gY29uc29sZSkuZGVidWcuYXBwbHkoX2NvbnNvbGU1LCBhcmd1bWVudHMpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIChfY29uc29sZTYgPSBjb25zb2xlKS5pbmZvLmFwcGx5KF9jb25zb2xlNiwgYXJndW1lbnRzKTsKICAgICAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLWNvbnNvbGUgKi8KICAgICAgfSwKCiAgICAgIC8qKgogICAgICBJZiB0aGUgdmFsdWUgcGFzc2VkIGludG8gYEVtYmVyLkxvZ2dlci5hc3NlcnRgIGlzIG5vdCB0cnV0aHkgaXQgd2lsbCB0aHJvdyBhbiBlcnJvciB3aXRoIGEgc3RhY2sgdHJhY2UuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIEVtYmVyLkxvZ2dlci5hc3NlcnQodHJ1ZSk7IC8vIHVuZGVmaW5lZAogICAgICBFbWJlci5Mb2dnZXIuYXNzZXJ0KHRydWUgPT09IGZhbHNlKTsgLy8gVGhyb3dzIGFuIEFzc2VydGlvbiBmYWlsZWQgZXJyb3IuCiAgICAgIEVtYmVyLkxvZ2dlci5hc3NlcnQodHJ1ZSA9PT0gZmFsc2UsICdTb21ldGhpbmcgaW52YWxpZCcpOyAvLyBUaHJvd3MgYW4gQXNzZXJ0aW9uIGZhaWxlZCBlcnJvciB3aXRoIG1lc3NhZ2UuCiAgICAgIGBgYAogICAgICBAbWV0aG9kIGFzc2VydAogICAgICBAZm9yIEVtYmVyLkxvZ2dlcgogICAgICBAcGFyYW0ge0Jvb2xlYW59IGJvb2wgVmFsdWUgdG8gdGVzdAogICAgICBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBBc3NlcnRpb24gbWVzc2FnZSBvbiBmYWlsZWQKICAgICAgQHB1YmxpYwogICAgICAqLwogICAgICBhc3NlcnQ6IGZ1bmN0aW9uIGFzc2VydCgpIHsKICAgICAgICB2YXIgX2NvbnNvbGU3OwoKICAgICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKERFUFJFQ0FUSU9OX01FU1NBR0UsIGZhbHNlLCB7CiAgICAgICAgICBpZDogREVQUkVDQVRJT05fSUQsCiAgICAgICAgICB1bnRpbDogJzQuMC4wJywKICAgICAgICAgIHVybDogREVQUkVDQVRJT05fVVJMCiAgICAgICAgfSkpOwogICAgICAgIHJldHVybiAoX2NvbnNvbGU3ID0gY29uc29sZSkuYXNzZXJ0LmFwcGx5KF9jb25zb2xlNywgYXJndW1lbnRzKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlCiAgICAgIH0KICAgIH07CiAgfQoKICB2YXIgX2RlZmF1bHQgPSBERVBSRUNBVEVEX0xPR0dFUjsKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL2NvbnRhaW5lci9pbmRleCIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy9vd25lciIsICJAZW1iZXIvLWludGVybmFscy91dGlscyIsICJAZW1iZXIvZGVidWciLCAiQGVtYmVyL3BvbHlmaWxscyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9vd25lciwgX3V0aWxzLCBfZGVidWcsIF9wb2x5ZmlsbHMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLnByaXZhdGl6ZSA9IHByaXZhdGl6ZTsKICBfZXhwb3J0cy5GQUNUT1JZX0ZPUiA9IF9leHBvcnRzLkNvbnRhaW5lciA9IF9leHBvcnRzLlJlZ2lzdHJ5ID0gdm9pZCAwOwogIHZhciBsZWFrVHJhY2tpbmc7CiAgdmFyIGNvbnRhaW5lcnM7CgogIGlmIChmYWxzZQogIC8qIERFQlVHICovCiAgKSB7CiAgICAvLyByZXF1aXJlcyB2OAogICAgLy8gY2hyb21lIC0tanMtZmxhZ3M9Ii0tYWxsb3ctbmF0aXZlcy1zeW50YXggLS1leHBvc2UtZ2MiCiAgICAvLyBub2RlIC0tYWxsb3ctbmF0aXZlcy1zeW50YXggLS1leHBvc2UtZ2MKICAgIHRyeSB7CiAgICAgIGlmICh0eXBlb2YgZ2MgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBsZWFrVHJhY2tpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAvLyBhdm9pZCBzeW50YXggZXJyb3JzIHdoZW4gLS1hbGxvdy1uYXRpdmVzLXN5bnRheCBub3QgcHJlc2VudAogICAgICAgICAgdmFyIEdldFdlYWtTZXRWYWx1ZXMgPSBuZXcgRnVuY3Rpb24oJ3dlYWtTZXQnLCAncmV0dXJuICVHZXRXZWFrU2V0VmFsdWVzKHdlYWtTZXQsIDApJyk7CiAgICAgICAgICBjb250YWluZXJzID0gbmV3IFdlYWtTZXQoKTsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGhhc0NvbnRhaW5lcnM6IGZ1bmN0aW9uIGhhc0NvbnRhaW5lcnMoKSB7CiAgICAgICAgICAgICAgZ2MoKTsKICAgICAgICAgICAgICByZXR1cm4gR2V0V2Vha1NldFZhbHVlcyhjb250YWluZXJzKS5sZW5ndGggPiAwOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZXNldDogZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgICAgICAgICAgdmFyIHZhbHVlcyA9IEdldFdlYWtTZXRWYWx1ZXMoY29udGFpbmVycyk7CgogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb250YWluZXJzLmRlbGV0ZSh2YWx1ZXNbaV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9KCk7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsvLyBpZ25vcmUKICAgIH0KICB9CiAgLyoqCiAgIEEgY29udGFpbmVyIHVzZWQgdG8gaW5zdGFudGlhdGUgYW5kIGNhY2hlIG9iamVjdHMuCiAgCiAgIEV2ZXJ5IGBDb250YWluZXJgIG11c3QgYmUgYXNzb2NpYXRlZCB3aXRoIGEgYFJlZ2lzdHJ5YCwgd2hpY2ggaXMgcmVmZXJlbmNlZAogICB0byBkZXRlcm1pbmUgdGhlIGZhY3RvcnkgYW5kIG9wdGlvbnMgdGhhdCBzaG91bGQgYmUgdXNlZCB0byBpbnN0YW50aWF0ZQogICBvYmplY3RzLgogIAogICBUaGUgcHVibGljIEFQSSBmb3IgYENvbnRhaW5lcmAgaXMgc3RpbGwgaW4gZmx1eCBhbmQgc2hvdWxkIG5vdCBiZSBjb25zaWRlcmVkCiAgIHN0YWJsZS4KICAKICAgQHByaXZhdGUKICAgQGNsYXNzIENvbnRhaW5lcgogICAqLwoKCiAgdmFyIENvbnRhaW5lciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIENvbnRhaW5lcihyZWdpc3RyeSwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICB0aGlzLnJlZ2lzdHJ5ID0gcmVnaXN0cnk7CiAgICAgIHRoaXMub3duZXIgPSBvcHRpb25zLm93bmVyIHx8IG51bGw7CiAgICAgIHRoaXMuY2FjaGUgPSAoMCwgX3V0aWxzLmRpY3Rpb25hcnkpKG9wdGlvbnMuY2FjaGUgfHwgbnVsbCk7CiAgICAgIHRoaXMuZmFjdG9yeU1hbmFnZXJDYWNoZSA9ICgwLCBfdXRpbHMuZGljdGlvbmFyeSkob3B0aW9ucy5mYWN0b3J5TWFuYWdlckNhY2hlIHx8IG51bGwpOwogICAgICB0aGlzLmlzRGVzdHJveWVkID0gZmFsc2U7CiAgICAgIHRoaXMuaXNEZXN0cm95aW5nID0gZmFsc2U7CgogICAgICBpZiAoZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgKSB7CiAgICAgICAgdGhpcy52YWxpZGF0aW9uQ2FjaGUgPSAoMCwgX3V0aWxzLmRpY3Rpb25hcnkpKG9wdGlvbnMudmFsaWRhdGlvbkNhY2hlIHx8IG51bGwpOwoKICAgICAgICBpZiAoY29udGFpbmVycyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBjb250YWluZXJzLmFkZCh0aGlzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgIEBwcml2YXRlCiAgICAgQHByb3BlcnR5IHJlZ2lzdHJ5CiAgICAgQHR5cGUgUmVnaXN0cnkKICAgICBAc2luY2UgMS4xMS4wCiAgICAgKi8KCiAgICAvKioKICAgICBAcHJpdmF0ZQogICAgIEBwcm9wZXJ0eSBjYWNoZQogICAgIEB0eXBlIEluaGVyaXRpbmdEaWN0CiAgICAgKi8KCiAgICAvKioKICAgICBAcHJpdmF0ZQogICAgIEBwcm9wZXJ0eSB2YWxpZGF0aW9uQ2FjaGUKICAgICBAdHlwZSBJbmhlcml0aW5nRGljdAogICAgICovCgogICAgLyoqCiAgICAgR2l2ZW4gYSBmdWxsTmFtZSByZXR1cm4gYSBjb3JyZXNwb25kaW5nIGluc3RhbmNlLgogICAgICBUaGUgZGVmYXVsdCBiZWhhdmlvciBpcyBmb3IgbG9va3VwIHRvIHJldHVybiBhIHNpbmdsZXRvbiBpbnN0YW5jZS4KICAgICBUaGUgc2luZ2xldG9uIGlzIHNjb3BlZCB0byB0aGUgY29udGFpbmVyLCBhbGxvd2luZyBtdWx0aXBsZSBjb250YWluZXJzCiAgICAgdG8gYWxsIGhhdmUgdGhlaXIgb3duIGxvY2FsbHkgc2NvcGVkIHNpbmdsZXRvbnMuCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBsZXQgcmVnaXN0cnkgPSBuZXcgUmVnaXN0cnkoKTsKICAgICBsZXQgY29udGFpbmVyID0gcmVnaXN0cnkuY29udGFpbmVyKCk7CiAgICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdhcGk6dHdpdHRlcicsIFR3aXR0ZXIpOwogICAgICBsZXQgdHdpdHRlciA9IGNvbnRhaW5lci5sb29rdXAoJ2FwaTp0d2l0dGVyJyk7CiAgICAgIHR3aXR0ZXIgaW5zdGFuY2VvZiBUd2l0dGVyOyAvLyA9PiB0cnVlCiAgICAgIC8vIGJ5IGRlZmF1bHQgdGhlIGNvbnRhaW5lciB3aWxsIHJldHVybiBzaW5nbGV0b25zCiAgICAgbGV0IHR3aXR0ZXIyID0gY29udGFpbmVyLmxvb2t1cCgnYXBpOnR3aXR0ZXInKTsKICAgICB0d2l0dGVyMiBpbnN0YW5jZW9mIFR3aXR0ZXI7IC8vID0+IHRydWUKICAgICAgdHdpdHRlciA9PT0gdHdpdHRlcjI7IC8vPT4gdHJ1ZQogICAgIGBgYAogICAgICBJZiBzaW5nbGV0b25zIGFyZSBub3Qgd2FudGVkLCBhbiBvcHRpb25hbCBmbGFnIGNhbiBiZSBwcm92aWRlZCBhdCBsb29rdXAuCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBsZXQgcmVnaXN0cnkgPSBuZXcgUmVnaXN0cnkoKTsKICAgICBsZXQgY29udGFpbmVyID0gcmVnaXN0cnkuY29udGFpbmVyKCk7CiAgICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdhcGk6dHdpdHRlcicsIFR3aXR0ZXIpOwogICAgICBsZXQgdHdpdHRlciA9IGNvbnRhaW5lci5sb29rdXAoJ2FwaTp0d2l0dGVyJywgeyBzaW5nbGV0b246IGZhbHNlIH0pOwogICAgIGxldCB0d2l0dGVyMiA9IGNvbnRhaW5lci5sb29rdXAoJ2FwaTp0d2l0dGVyJywgeyBzaW5nbGV0b246IGZhbHNlIH0pOwogICAgICB0d2l0dGVyID09PSB0d2l0dGVyMjsgLy89PiBmYWxzZQogICAgIGBgYAogICAgICBAcHJpdmF0ZQogICAgIEBtZXRob2QgbG9va3VwCiAgICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lCiAgICAgQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXQogICAgIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy5zb3VyY2VdIFRoZSBmdWxsbmFtZSBvZiB0aGUgcmVxdWVzdCBzb3VyY2UgKHVzZWQgZm9yIGxvY2FsIGxvb2t1cCkKICAgICBAcmV0dXJuIHthbnl9CiAgICAgKi8KCgogICAgdmFyIF9wcm90byA9IENvbnRhaW5lci5wcm90b3R5cGU7CgogICAgX3Byb3RvLmxvb2t1cCA9IGZ1bmN0aW9uIGxvb2t1cChmdWxsTmFtZSwgb3B0aW9ucykgewogICAgICAoZmFsc2UgJiYgISghdGhpcy5pc0Rlc3Ryb3llZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdleHBlY3RlZCBjb250YWluZXIgbm90IHRvIGJlIGRlc3Ryb3llZCcsICF0aGlzLmlzRGVzdHJveWVkKSk7CiAgICAgIChmYWxzZSAmJiAhKHRoaXMucmVnaXN0cnkuaXNWYWxpZEZ1bGxOYW1lKGZ1bGxOYW1lKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdmdWxsTmFtZSBtdXN0IGJlIGEgcHJvcGVyIGZ1bGwgbmFtZScsIHRoaXMucmVnaXN0cnkuaXNWYWxpZEZ1bGxOYW1lKGZ1bGxOYW1lKSkpOwogICAgICByZXR1cm4gX2xvb2t1cCh0aGlzLCB0aGlzLnJlZ2lzdHJ5Lm5vcm1hbGl6ZShmdWxsTmFtZSksIG9wdGlvbnMpOwogICAgfQogICAgLyoqCiAgICAgQSBkZXB0aCBmaXJzdCB0cmF2ZXJzYWwsIGRlc3Ryb3lpbmcgdGhlIGNvbnRhaW5lciwgaXRzIGRlc2NlbmRhbnQgY29udGFpbmVycyBhbmQgYWxsCiAgICAgdGhlaXIgbWFuYWdlZCBvYmplY3RzLgogICAgICBAcHJpdmF0ZQogICAgIEBtZXRob2QgZGVzdHJveQogICAgICovCiAgICA7CgogICAgX3Byb3RvLmRlc3Ryb3kgPSBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICBkZXN0cm95RGVzdHJveWFibGVzKHRoaXMpOwogICAgICB0aGlzLmlzRGVzdHJveWluZyA9IHRydWU7CiAgICB9OwoKICAgIF9wcm90by5maW5hbGl6ZURlc3Ryb3kgPSBmdW5jdGlvbiBmaW5hbGl6ZURlc3Ryb3koKSB7CiAgICAgIHJlc2V0Q2FjaGUodGhpcyk7CiAgICAgIHRoaXMuaXNEZXN0cm95ZWQgPSB0cnVlOwogICAgfQogICAgLyoqCiAgICAgQ2xlYXIgZWl0aGVyIHRoZSBlbnRpcmUgY2FjaGUgb3IganVzdCB0aGUgY2FjaGUgZm9yIGEgcGFydGljdWxhciBrZXkuCiAgICAgICAgQHByaXZhdGUKICAgICBAbWV0aG9kIHJlc2V0CiAgICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lIG9wdGlvbmFsIGtleSB0byByZXNldDsgaWYgbWlzc2luZywgcmVzZXRzIGV2ZXJ5dGhpbmcKICAgICovCiAgICA7CgogICAgX3Byb3RvLnJlc2V0ID0gZnVuY3Rpb24gcmVzZXQoZnVsbE5hbWUpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHJldHVybjsKCiAgICAgIGlmIChmdWxsTmFtZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgZGVzdHJveURlc3Ryb3lhYmxlcyh0aGlzKTsKICAgICAgICByZXNldENhY2hlKHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc2V0TWVtYmVyKHRoaXMsIHRoaXMucmVnaXN0cnkubm9ybWFsaXplKGZ1bGxOYW1lKSk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgIFJldHVybnMgYW4gb2JqZWN0IHRoYXQgY2FuIGJlIHVzZWQgdG8gcHJvdmlkZSBhbiBvd25lciB0byBhCiAgICAgbWFudWFsbHkgY3JlYXRlZCBpbnN0YW5jZS4KICAgICAgQHByaXZhdGUKICAgICBAbWV0aG9kIG93bmVySW5qZWN0aW9uCiAgICAgQHJldHVybnMgeyBPYmplY3QgfQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ub3duZXJJbmplY3Rpb24gPSBmdW5jdGlvbiBvd25lckluamVjdGlvbigpIHsKICAgICAgdmFyIF9yZWY7CgogICAgICByZXR1cm4gX3JlZiA9IHt9LCBfcmVmW19vd25lci5PV05FUl0gPSB0aGlzLm93bmVyLCBfcmVmOwogICAgfQogICAgLyoqCiAgICAgR2l2ZW4gYSBmdWxsTmFtZSwgcmV0dXJuIHRoZSBjb3JyZXNwb25kaW5nIGZhY3RvcnkuIFRoZSBjb25zdW1lciBvZiB0aGUgZmFjdG9yeQogICAgIGlzIHJlc3BvbnNpYmxlIGZvciB0aGUgZGVzdHJ1Y3Rpb24gb2YgYW55IGZhY3RvcnkgaW5zdGFuY2VzLCBhcyB0aGVyZSBpcyBubwogICAgIHdheSBmb3IgdGhlIGNvbnRhaW5lciB0byBlbnN1cmUgaW5zdGFuY2VzIGFyZSBkZXN0cm95ZWQgd2hlbiBpdCBpdHNlbGYgaXMKICAgICBkZXN0cm95ZWQuCiAgICAgIEBwdWJsaWMKICAgICBAbWV0aG9kIGZhY3RvcnlGb3IKICAgICBAcGFyYW0ge1N0cmluZ30gZnVsbE5hbWUKICAgICBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdCiAgICAgQHBhcmFtIHtTdHJpbmd9IFtvcHRpb25zLnNvdXJjZV0gVGhlIGZ1bGxuYW1lIG9mIHRoZSByZXF1ZXN0IHNvdXJjZSAodXNlZCBmb3IgbG9jYWwgbG9va3VwKQogICAgIEByZXR1cm4ge2FueX0KICAgICAqLwogICAgOwoKICAgIF9wcm90by5mYWN0b3J5Rm9yID0gZnVuY3Rpb24gZmFjdG9yeUZvcihmdWxsTmFtZSwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICAoZmFsc2UgJiYgISghdGhpcy5pc0Rlc3Ryb3llZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdleHBlY3RlZCBjb250YWluZXIgbm90IHRvIGJlIGRlc3Ryb3llZCcsICF0aGlzLmlzRGVzdHJveWVkKSk7CiAgICAgIHZhciBub3JtYWxpemVkTmFtZSA9IHRoaXMucmVnaXN0cnkubm9ybWFsaXplKGZ1bGxOYW1lKTsKICAgICAgKGZhbHNlICYmICEodGhpcy5yZWdpc3RyeS5pc1ZhbGlkRnVsbE5hbWUobm9ybWFsaXplZE5hbWUpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2Z1bGxOYW1lIG11c3QgYmUgYSBwcm9wZXIgZnVsbCBuYW1lJywgdGhpcy5yZWdpc3RyeS5pc1ZhbGlkRnVsbE5hbWUobm9ybWFsaXplZE5hbWUpKSk7CiAgICAgIChmYWxzZSAmJiAhKGZhbHNlCiAgICAgIC8qIEVNQkVSX01PRFVMRV9VTklGSUNBVElPTiAqLwogICAgICB8fCAhb3B0aW9ucy5uYW1lc3BhY2UpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnRU1CRVJfTU9EVUxFX1VOSUZJQ0FUSU9OIG11c3QgYmUgZW5hYmxlZCB0byBwYXNzIGEgbmFtZXNwYWNlIG9wdGlvbiB0byBmYWN0b3J5Rm9yJywgZmFsc2UgfHwgIW9wdGlvbnMubmFtZXNwYWNlKSk7CgogICAgICBpZiAob3B0aW9ucy5zb3VyY2UgfHwgb3B0aW9ucy5uYW1lc3BhY2UpIHsKICAgICAgICBub3JtYWxpemVkTmFtZSA9IHRoaXMucmVnaXN0cnkuZXhwYW5kTG9jYWxMb29rdXAoZnVsbE5hbWUsIG9wdGlvbnMpOwoKICAgICAgICBpZiAoIW5vcm1hbGl6ZWROYW1lKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gX2ZhY3RvcnlGb3IodGhpcywgbm9ybWFsaXplZE5hbWUsIGZ1bGxOYW1lKTsKICAgIH07CgogICAgcmV0dXJuIENvbnRhaW5lcjsKICB9KCk7CgogIF9leHBvcnRzLkNvbnRhaW5lciA9IENvbnRhaW5lcjsKCiAgaWYgKGZhbHNlCiAgLyogREVCVUcgKi8KICApIHsKICAgIENvbnRhaW5lci5fbGVha1RyYWNraW5nID0gbGVha1RyYWNraW5nOwogIH0KICAvKgogICAqIFdyYXAgYSBmYWN0b3J5IG1hbmFnZXIgaW4gYSBwcm94eSB3aGljaCB3aWxsIG5vdCBwZXJtaXQgcHJvcGVydGllcyB0byBiZQogICAqIHNldCBvbiB0aGUgbWFuYWdlci4KICAgKi8KCgogIGZ1bmN0aW9uIHdyYXBNYW5hZ2VySW5EZXByZWNhdGlvblByb3h5KG1hbmFnZXIpIHsKICAgIGlmIChfdXRpbHMuSEFTX05BVElWRV9QUk9YWSkgewogICAgICB2YXIgdmFsaWRhdG9yID0gewogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KF9vYmosIHByb3ApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiWW91IGF0dGVtcHRlZCB0byBzZXQgXCIiICsgcHJvcCArICJcIiBvbiBhIGZhY3RvcnkgbWFuYWdlciBjcmVhdGVkIGJ5IGNvbnRhaW5lciNmYWN0b3J5Rm9yLiBBIGZhY3RvcnkgbWFuYWdlciBpcyBhIHJlYWQtb25seSBjb25zdHJ1Y3QuIik7CiAgICAgICAgfQogICAgICB9OyAvLyBOb3RlOgogICAgICAvLyBXZSBoYXZlIHRvIHByb3h5IGFjY2VzcyB0byB0aGUgbWFuYWdlciBoZXJlIHNvIHRoYXQgcHJpdmF0ZSBwcm9wZXJ0eQogICAgICAvLyBhY2Nlc3MgZG9lc24ndCBjYXVzZSB0aGUgYWJvdmUgZXJyb3JzIHRvIG9jY3VyLgoKICAgICAgdmFyIG0gPSBtYW5hZ2VyOwogICAgICB2YXIgcHJveGllZE1hbmFnZXIgPSB7CiAgICAgICAgY2xhc3M6IG0uY2xhc3MsCiAgICAgICAgY3JlYXRlOiBmdW5jdGlvbiBjcmVhdGUocHJvcHMpIHsKICAgICAgICAgIHJldHVybiBtLmNyZWF0ZShwcm9wcyk7CiAgICAgICAgfQogICAgICB9OwogICAgICB2YXIgcHJveHkgPSBuZXcgUHJveHkocHJveGllZE1hbmFnZXIsIHZhbGlkYXRvcik7CiAgICAgIEZBQ1RPUllfRk9SLnNldChwcm94eSwgbWFuYWdlcik7CiAgICB9CgogICAgcmV0dXJuIG1hbmFnZXI7CiAgfQoKICBmdW5jdGlvbiBpc1NpbmdsZXRvbihjb250YWluZXIsIGZ1bGxOYW1lKSB7CiAgICByZXR1cm4gY29udGFpbmVyLnJlZ2lzdHJ5LmdldE9wdGlvbihmdWxsTmFtZSwgJ3NpbmdsZXRvbicpICE9PSBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIGlzSW5zdGFudGlhdGFibGUoY29udGFpbmVyLCBmdWxsTmFtZSkgewogICAgcmV0dXJuIGNvbnRhaW5lci5yZWdpc3RyeS5nZXRPcHRpb24oZnVsbE5hbWUsICdpbnN0YW50aWF0ZScpICE9PSBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIF9sb29rdXAoY29udGFpbmVyLCBmdWxsTmFtZSwgb3B0aW9ucykgewogICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICBvcHRpb25zID0ge307CiAgICB9CgogICAgKGZhbHNlICYmICEoZmFsc2UKICAgIC8qIEVNQkVSX01PRFVMRV9VTklGSUNBVElPTiAqLwogICAgfHwgIW9wdGlvbnMubmFtZXNwYWNlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0VNQkVSX01PRFVMRV9VTklGSUNBVElPTiBtdXN0IGJlIGVuYWJsZWQgdG8gcGFzcyBhIG5hbWVzcGFjZSBvcHRpb24gdG8gbG9va3VwJywgZmFsc2UgfHwgIW9wdGlvbnMubmFtZXNwYWNlKSk7CiAgICB2YXIgbm9ybWFsaXplZE5hbWUgPSBmdWxsTmFtZTsKCiAgICBpZiAob3B0aW9ucy5zb3VyY2UgfHwgb3B0aW9ucy5uYW1lc3BhY2UpIHsKICAgICAgbm9ybWFsaXplZE5hbWUgPSBjb250YWluZXIucmVnaXN0cnkuZXhwYW5kTG9jYWxMb29rdXAoZnVsbE5hbWUsIG9wdGlvbnMpOwoKICAgICAgaWYgKCFub3JtYWxpemVkTmFtZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQoKICAgIGlmIChvcHRpb25zLnNpbmdsZXRvbiAhPT0gZmFsc2UpIHsKICAgICAgdmFyIGNhY2hlZCA9IGNvbnRhaW5lci5jYWNoZVtub3JtYWxpemVkTmFtZV07CgogICAgICBpZiAoY2FjaGVkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gY2FjaGVkOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGluc3RhbnRpYXRlRmFjdG9yeShjb250YWluZXIsIG5vcm1hbGl6ZWROYW1lLCBmdWxsTmFtZSwgb3B0aW9ucyk7CiAgfQoKICBmdW5jdGlvbiBfZmFjdG9yeUZvcihjb250YWluZXIsIG5vcm1hbGl6ZWROYW1lLCBmdWxsTmFtZSkgewogICAgdmFyIGNhY2hlZCA9IGNvbnRhaW5lci5mYWN0b3J5TWFuYWdlckNhY2hlW25vcm1hbGl6ZWROYW1lXTsKCiAgICBpZiAoY2FjaGVkICE9PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIGNhY2hlZDsKICAgIH0KCiAgICB2YXIgZmFjdG9yeSA9IGNvbnRhaW5lci5yZWdpc3RyeS5yZXNvbHZlKG5vcm1hbGl6ZWROYW1lKTsKCiAgICBpZiAoZmFjdG9yeSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoZmFsc2UKICAgIC8qIERFQlVHICovCiAgICAmJiBmYWN0b3J5ICYmIHR5cGVvZiBmYWN0b3J5Ll9vbkxvb2t1cCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBmYWN0b3J5Ll9vbkxvb2t1cChmdWxsTmFtZSk7CiAgICB9CgogICAgdmFyIG1hbmFnZXIgPSBuZXcgRmFjdG9yeU1hbmFnZXIoY29udGFpbmVyLCBmYWN0b3J5LCBmdWxsTmFtZSwgbm9ybWFsaXplZE5hbWUpOwoKICAgIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICkgewogICAgICBtYW5hZ2VyID0gd3JhcE1hbmFnZXJJbkRlcHJlY2F0aW9uUHJveHkobWFuYWdlcik7CiAgICB9CgogICAgY29udGFpbmVyLmZhY3RvcnlNYW5hZ2VyQ2FjaGVbbm9ybWFsaXplZE5hbWVdID0gbWFuYWdlcjsKICAgIHJldHVybiBtYW5hZ2VyOwogIH0KCiAgZnVuY3Rpb24gaXNTaW5nbGV0b25DbGFzcyhjb250YWluZXIsIGZ1bGxOYW1lLCBfcmVmMikgewogICAgdmFyIGluc3RhbnRpYXRlID0gX3JlZjIuaW5zdGFudGlhdGUsCiAgICAgICAgc2luZ2xldG9uID0gX3JlZjIuc2luZ2xldG9uOwogICAgcmV0dXJuIHNpbmdsZXRvbiAhPT0gZmFsc2UgJiYgIWluc3RhbnRpYXRlICYmIGlzU2luZ2xldG9uKGNvbnRhaW5lciwgZnVsbE5hbWUpICYmICFpc0luc3RhbnRpYXRhYmxlKGNvbnRhaW5lciwgZnVsbE5hbWUpOwogIH0KCiAgZnVuY3Rpb24gaXNTaW5nbGV0b25JbnN0YW5jZShjb250YWluZXIsIGZ1bGxOYW1lLCBfcmVmMykgewogICAgdmFyIGluc3RhbnRpYXRlID0gX3JlZjMuaW5zdGFudGlhdGUsCiAgICAgICAgc2luZ2xldG9uID0gX3JlZjMuc2luZ2xldG9uOwogICAgcmV0dXJuIHNpbmdsZXRvbiAhPT0gZmFsc2UgJiYgaW5zdGFudGlhdGUgIT09IGZhbHNlICYmIGlzU2luZ2xldG9uKGNvbnRhaW5lciwgZnVsbE5hbWUpICYmIGlzSW5zdGFudGlhdGFibGUoY29udGFpbmVyLCBmdWxsTmFtZSk7CiAgfQoKICBmdW5jdGlvbiBpc0ZhY3RvcnlDbGFzcyhjb250YWluZXIsIGZ1bGxuYW1lLCBfcmVmNCkgewogICAgdmFyIGluc3RhbnRpYXRlID0gX3JlZjQuaW5zdGFudGlhdGUsCiAgICAgICAgc2luZ2xldG9uID0gX3JlZjQuc2luZ2xldG9uOwogICAgcmV0dXJuIGluc3RhbnRpYXRlID09PSBmYWxzZSAmJiAoc2luZ2xldG9uID09PSBmYWxzZSB8fCAhaXNTaW5nbGV0b24oY29udGFpbmVyLCBmdWxsbmFtZSkpICYmICFpc0luc3RhbnRpYXRhYmxlKGNvbnRhaW5lciwgZnVsbG5hbWUpOwogIH0KCiAgZnVuY3Rpb24gaXNGYWN0b3J5SW5zdGFuY2UoY29udGFpbmVyLCBmdWxsTmFtZSwgX3JlZjUpIHsKICAgIHZhciBpbnN0YW50aWF0ZSA9IF9yZWY1Lmluc3RhbnRpYXRlLAogICAgICAgIHNpbmdsZXRvbiA9IF9yZWY1LnNpbmdsZXRvbjsKICAgIHJldHVybiBpbnN0YW50aWF0ZSAhPT0gZmFsc2UgJiYgKHNpbmdsZXRvbiAhPT0gZmFsc2UgfHwgaXNTaW5nbGV0b24oY29udGFpbmVyLCBmdWxsTmFtZSkpICYmIGlzSW5zdGFudGlhdGFibGUoY29udGFpbmVyLCBmdWxsTmFtZSk7CiAgfQoKICBmdW5jdGlvbiBpbnN0YW50aWF0ZUZhY3RvcnkoY29udGFpbmVyLCBub3JtYWxpemVkTmFtZSwgZnVsbE5hbWUsIG9wdGlvbnMpIHsKICAgIHZhciBmYWN0b3J5TWFuYWdlciA9IF9mYWN0b3J5Rm9yKGNvbnRhaW5lciwgbm9ybWFsaXplZE5hbWUsIGZ1bGxOYW1lKTsKCiAgICBpZiAoZmFjdG9yeU1hbmFnZXIgPT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm47CiAgICB9IC8vIFNvbWVDbGFzcyB7IHNpbmdsZXRvbjogdHJ1ZSwgaW5zdGFudGlhdGU6IHRydWUgfSB8IHsgc2luZ2xldG9uOiB0cnVlIH0gfCB7IGluc3RhbnRpYXRlOiB0cnVlIH0gfCB7fQogICAgLy8gQnkgZGVmYXVsdCBtYWpvcml0eSBvZiBvYmplY3RzIGZhbGwgaW50byB0aGlzIGNhc2UKCgogICAgaWYgKGlzU2luZ2xldG9uSW5zdGFuY2UoY29udGFpbmVyLCBmdWxsTmFtZSwgb3B0aW9ucykpIHsKICAgICAgcmV0dXJuIGNvbnRhaW5lci5jYWNoZVtub3JtYWxpemVkTmFtZV0gPSBmYWN0b3J5TWFuYWdlci5jcmVhdGUoKTsKICAgIH0gLy8gU29tZUNsYXNzIHsgc2luZ2xldG9uOiBmYWxzZSwgaW5zdGFudGlhdGU6IHRydWUgfQoKCiAgICBpZiAoaXNGYWN0b3J5SW5zdGFuY2UoY29udGFpbmVyLCBmdWxsTmFtZSwgb3B0aW9ucykpIHsKICAgICAgcmV0dXJuIGZhY3RvcnlNYW5hZ2VyLmNyZWF0ZSgpOwogICAgfSAvLyBTb21lQ2xhc3MgeyBzaW5nbGV0b246IHRydWUsIGluc3RhbnRpYXRlOiBmYWxzZSB9IHwgeyBpbnN0YW50aWF0ZTogZmFsc2UgfSB8IHsgc2luZ2xldG9uOiBmYWxzZSwgaW5zdGFudGlhdGlvbjogZmFsc2UgfQoKCiAgICBpZiAoaXNTaW5nbGV0b25DbGFzcyhjb250YWluZXIsIGZ1bGxOYW1lLCBvcHRpb25zKSB8fCBpc0ZhY3RvcnlDbGFzcyhjb250YWluZXIsIGZ1bGxOYW1lLCBvcHRpb25zKSkgewogICAgICByZXR1cm4gZmFjdG9yeU1hbmFnZXIuY2xhc3M7CiAgICB9CgogICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgY3JlYXRlIGZhY3RvcnknKTsKICB9CgogIGZ1bmN0aW9uIHByb2Nlc3NJbmplY3Rpb25zKGNvbnRhaW5lciwgaW5qZWN0aW9ucywgcmVzdWx0KSB7CiAgICBpZiAoZmFsc2UKICAgIC8qIERFQlVHICovCiAgICApIHsKICAgICAgY29udGFpbmVyLnJlZ2lzdHJ5LnZhbGlkYXRlSW5qZWN0aW9ucyhpbmplY3Rpb25zKTsKICAgIH0KCiAgICB2YXIgaGFzaCA9IHJlc3VsdC5pbmplY3Rpb25zOwoKICAgIGlmIChoYXNoID09PSB1bmRlZmluZWQpIHsKICAgICAgaGFzaCA9IHJlc3VsdC5pbmplY3Rpb25zID0ge307CiAgICB9CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbmplY3Rpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBfaW5qZWN0aW9ucyRpID0gaW5qZWN0aW9uc1tpXSwKICAgICAgICAgIHByb3BlcnR5ID0gX2luamVjdGlvbnMkaS5wcm9wZXJ0eSwKICAgICAgICAgIHNwZWNpZmllciA9IF9pbmplY3Rpb25zJGkuc3BlY2lmaWVyLAogICAgICAgICAgc291cmNlID0gX2luamVjdGlvbnMkaS5zb3VyY2U7CgogICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgaGFzaFtwcm9wZXJ0eV0gPSBfbG9va3VwKGNvbnRhaW5lciwgc3BlY2lmaWVyLCB7CiAgICAgICAgICBzb3VyY2U6IHNvdXJjZQogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGhhc2hbcHJvcGVydHldID0gX2xvb2t1cChjb250YWluZXIsIHNwZWNpZmllcik7CiAgICAgIH0KCiAgICAgIGlmICghcmVzdWx0LmlzRHluYW1pYykgewogICAgICAgIHJlc3VsdC5pc0R5bmFtaWMgPSAhaXNTaW5nbGV0b24oY29udGFpbmVyLCBzcGVjaWZpZXIpOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBidWlsZEluamVjdGlvbnMoY29udGFpbmVyLCB0eXBlSW5qZWN0aW9ucywgaW5qZWN0aW9ucykgewogICAgdmFyIHJlc3VsdCA9IHsKICAgICAgaW5qZWN0aW9uczogdW5kZWZpbmVkLAogICAgICBpc0R5bmFtaWM6IGZhbHNlCiAgICB9OwoKICAgIGlmICh0eXBlSW5qZWN0aW9ucyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHByb2Nlc3NJbmplY3Rpb25zKGNvbnRhaW5lciwgdHlwZUluamVjdGlvbnMsIHJlc3VsdCk7CiAgICB9CgogICAgaWYgKGluamVjdGlvbnMgIT09IHVuZGVmaW5lZCkgewogICAgICBwcm9jZXNzSW5qZWN0aW9ucyhjb250YWluZXIsIGluamVjdGlvbnMsIHJlc3VsdCk7CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIGZ1bmN0aW9uIGluamVjdGlvbnNGb3IoY29udGFpbmVyLCBmdWxsTmFtZSkgewogICAgdmFyIHJlZ2lzdHJ5ID0gY29udGFpbmVyLnJlZ2lzdHJ5OwoKICAgIHZhciBfZnVsbE5hbWUkc3BsaXQgPSBmdWxsTmFtZS5zcGxpdCgnOicpLAogICAgICAgIHR5cGUgPSBfZnVsbE5hbWUkc3BsaXRbMF07CgogICAgdmFyIHR5cGVJbmplY3Rpb25zID0gcmVnaXN0cnkuZ2V0VHlwZUluamVjdGlvbnModHlwZSk7CiAgICB2YXIgaW5qZWN0aW9ucyA9IHJlZ2lzdHJ5LmdldEluamVjdGlvbnMoZnVsbE5hbWUpOwogICAgcmV0dXJuIGJ1aWxkSW5qZWN0aW9ucyhjb250YWluZXIsIHR5cGVJbmplY3Rpb25zLCBpbmplY3Rpb25zKTsKICB9CgogIGZ1bmN0aW9uIGRlc3Ryb3lEZXN0cm95YWJsZXMoY29udGFpbmVyKSB7CiAgICB2YXIgY2FjaGUgPSBjb250YWluZXIuY2FjaGU7CiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGNhY2hlKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgIHZhciB2YWx1ZSA9IGNhY2hlW2tleV07CgogICAgICBpZiAodmFsdWUuZGVzdHJveSkgewogICAgICAgIHZhbHVlLmRlc3Ryb3koKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVzZXRDYWNoZShjb250YWluZXIpIHsKICAgIGNvbnRhaW5lci5jYWNoZSA9ICgwLCBfdXRpbHMuZGljdGlvbmFyeSkobnVsbCk7CiAgICBjb250YWluZXIuZmFjdG9yeU1hbmFnZXJDYWNoZSA9ICgwLCBfdXRpbHMuZGljdGlvbmFyeSkobnVsbCk7CiAgfQoKICBmdW5jdGlvbiByZXNldE1lbWJlcihjb250YWluZXIsIGZ1bGxOYW1lKSB7CiAgICB2YXIgbWVtYmVyID0gY29udGFpbmVyLmNhY2hlW2Z1bGxOYW1lXTsKICAgIGRlbGV0ZSBjb250YWluZXIuZmFjdG9yeU1hbmFnZXJDYWNoZVtmdWxsTmFtZV07CgogICAgaWYgKG1lbWJlcikgewogICAgICBkZWxldGUgY29udGFpbmVyLmNhY2hlW2Z1bGxOYW1lXTsKCiAgICAgIGlmIChtZW1iZXIuZGVzdHJveSkgewogICAgICAgIG1lbWJlci5kZXN0cm95KCk7CiAgICAgIH0KICAgIH0KICB9CgogIHZhciBGQUNUT1JZX0ZPUiA9IG5ldyBXZWFrTWFwKCk7CiAgX2V4cG9ydHMuRkFDVE9SWV9GT1IgPSBGQUNUT1JZX0ZPUjsKCiAgdmFyIEZhY3RvcnlNYW5hZ2VyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRmFjdG9yeU1hbmFnZXIoY29udGFpbmVyLCBmYWN0b3J5LCBmdWxsTmFtZSwgbm9ybWFsaXplZE5hbWUpIHsKICAgICAgdGhpcy5jb250YWluZXIgPSBjb250YWluZXI7CiAgICAgIHRoaXMub3duZXIgPSBjb250YWluZXIub3duZXI7CiAgICAgIHRoaXMuY2xhc3MgPSBmYWN0b3J5OwogICAgICB0aGlzLmZ1bGxOYW1lID0gZnVsbE5hbWU7CiAgICAgIHRoaXMubm9ybWFsaXplZE5hbWUgPSBub3JtYWxpemVkTmFtZTsKICAgICAgdGhpcy5tYWRlVG9TdHJpbmcgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuaW5qZWN0aW9ucyA9IHVuZGVmaW5lZDsKICAgICAgRkFDVE9SWV9GT1Iuc2V0KHRoaXMsIHRoaXMpOwogICAgfQoKICAgIHZhciBfcHJvdG8yID0gRmFjdG9yeU1hbmFnZXIucHJvdG90eXBlOwoKICAgIF9wcm90bzIudG9TdHJpbmcgPSBmdW5jdGlvbiB0b1N0cmluZygpIHsKICAgICAgaWYgKHRoaXMubWFkZVRvU3RyaW5nID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLm1hZGVUb1N0cmluZyA9IHRoaXMuY29udGFpbmVyLnJlZ2lzdHJ5Lm1ha2VUb1N0cmluZyh0aGlzLmNsYXNzLCB0aGlzLmZ1bGxOYW1lKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMubWFkZVRvU3RyaW5nOwogICAgfTsKCiAgICBfcHJvdG8yLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShvcHRpb25zKSB7CiAgICAgIHZhciBpbmplY3Rpb25zQ2FjaGUgPSB0aGlzLmluamVjdGlvbnM7CgogICAgICBpZiAoaW5qZWN0aW9uc0NhY2hlID09PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgX2luamVjdGlvbnNGb3IgPSBpbmplY3Rpb25zRm9yKHRoaXMuY29udGFpbmVyLCB0aGlzLm5vcm1hbGl6ZWROYW1lKSwKICAgICAgICAgICAgaW5qZWN0aW9ucyA9IF9pbmplY3Rpb25zRm9yLmluamVjdGlvbnMsCiAgICAgICAgICAgIGlzRHluYW1pYyA9IF9pbmplY3Rpb25zRm9yLmlzRHluYW1pYzsKCiAgICAgICAgaW5qZWN0aW9uc0NhY2hlID0gaW5qZWN0aW9uczsKCiAgICAgICAgaWYgKCFpc0R5bmFtaWMpIHsKICAgICAgICAgIHRoaXMuaW5qZWN0aW9ucyA9IGluamVjdGlvbnM7CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgcHJvcHMgPSBpbmplY3Rpb25zQ2FjaGU7CgogICAgICBpZiAob3B0aW9ucyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcHJvcHMgPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCBpbmplY3Rpb25zQ2FjaGUsIG9wdGlvbnMpOwogICAgICB9CgogICAgICBpZiAoZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgKSB7CiAgICAgICAgdmFyIGxhenlJbmplY3Rpb25zOwogICAgICAgIHZhciB2YWxpZGF0aW9uQ2FjaGUgPSB0aGlzLmNvbnRhaW5lci52YWxpZGF0aW9uQ2FjaGU7IC8vIEVuc3VyZSB0aGF0IGFsbCBsYXp5IGluamVjdGlvbnMgYXJlIHZhbGlkIGF0IGluc3RhbnRpYXRpb24gdGltZQoKICAgICAgICBpZiAoIXZhbGlkYXRpb25DYWNoZVt0aGlzLmZ1bGxOYW1lXSAmJiB0aGlzLmNsYXNzICYmIHR5cGVvZiB0aGlzLmNsYXNzLl9sYXp5SW5qZWN0aW9ucyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgbGF6eUluamVjdGlvbnMgPSB0aGlzLmNsYXNzLl9sYXp5SW5qZWN0aW9ucygpOwogICAgICAgICAgbGF6eUluamVjdGlvbnMgPSB0aGlzLmNvbnRhaW5lci5yZWdpc3RyeS5ub3JtYWxpemVJbmplY3Rpb25zSGFzaChsYXp5SW5qZWN0aW9ucyk7CiAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZWdpc3RyeS52YWxpZGF0ZUluamVjdGlvbnMobGF6eUluamVjdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgdmFsaWRhdGlvbkNhY2hlW3RoaXMuZnVsbE5hbWVdID0gdHJ1ZTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLmNsYXNzLmNyZWF0ZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiRmFpbGVkIHRvIGNyZWF0ZSBhbiBpbnN0YW5jZSBvZiAnIiArIHRoaXMubm9ybWFsaXplZE5hbWUgKyAiJy4gTW9zdCBsaWtlbHkgYW4gaW1wcm9wZXJseSBkZWZpbmVkIGNsYXNzIG9yIGFuIGludmFsaWQgbW9kdWxlIGV4cG9ydC4iKTsKICAgICAgfSAvLyByZXF1aXJlZCB0byBhbGxvdyBhY2Nlc3MgdG8gdGhpbmdzIGxpa2UKICAgICAgLy8gdGhlIGN1c3RvbWl6ZWQgdG9TdHJpbmcsIF9kZWJ1Z0NvbnRhaW5lcktleSwKICAgICAgLy8gb3duZXIsIGV0Yy4gd2l0aG91dCBhIGRvdWJsZSBleHRlbmQgYW5kIHdpdGhvdXQKICAgICAgLy8gbW9kaWZ5aW5nIHRoZSBvYmplY3RzIHByb3BlcnRpZXMKCgogICAgICBpZiAodHlwZW9mIHRoaXMuY2xhc3MuX2luaXRGYWN0b3J5ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhpcy5jbGFzcy5faW5pdEZhY3RvcnkodGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gaW4gdGhlIG5vbi1FbWJlck9iamVjdCBjYXNlIHdlIG5lZWQgdG8gc3RpbGwgc2V0T3duZXIKICAgICAgICAvLyB0aGlzIGlzIHJlcXVpcmVkIGZvciBzdXBwb3J0aW5nIGdsaW1tZXIgZW52aXJvbm1lbnQgYW5kCiAgICAgICAgLy8gdGVtcGxhdGUgaW5zdGFudGlhdGlvbiB3aGljaCByZWx5IGhlYXZpbHkgb24KICAgICAgICAvLyBgb3B0aW9uc1tPV05FUl1gIGJlaW5nIHBhc3NlZCBpbnRvIGBjcmVhdGVgCiAgICAgICAgLy8gVE9ETzogY2xlYW4gdGhpcyB1cCwgYW5kIHJlbW92ZSBpbiBmdXR1cmUgdmVyc2lvbnMKICAgICAgICBpZiAob3B0aW9ucyA9PT0gdW5kZWZpbmVkIHx8IHByb3BzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIC8vIGF2b2lkIG11dGF0aW5nIGBwcm9wc2AgaGVyZSBzaW5jZSB0aGV5IGFyZSB0aGUgY2FjaGVkIGluamVjdGlvbnMKICAgICAgICAgIHByb3BzID0gKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7fSwgcHJvcHMpOwogICAgICAgIH0KCiAgICAgICAgKDAsIF9vd25lci5zZXRPd25lcikocHJvcHMsIHRoaXMub3duZXIpOwogICAgICB9CgogICAgICB2YXIgaW5zdGFuY2UgPSB0aGlzLmNsYXNzLmNyZWF0ZShwcm9wcyk7CiAgICAgIEZBQ1RPUllfRk9SLnNldChpbnN0YW5jZSwgdGhpcyk7CiAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgIH07CgogICAgcmV0dXJuIEZhY3RvcnlNYW5hZ2VyOwogIH0oKTsKCiAgdmFyIFZBTElEX0ZVTExfTkFNRV9SRUdFWFAgPSAvXlteOl0rOlteOl0rJC87CiAgLyoqCiAgIEEgcmVnaXN0cnkgdXNlZCB0byBzdG9yZSBmYWN0b3J5IGFuZCBvcHRpb24gaW5mb3JtYXRpb24ga2V5ZWQKICAgYnkgdHlwZS4KICAKICAgQSBgUmVnaXN0cnlgIHN0b3JlcyB0aGUgZmFjdG9yeSBhbmQgb3B0aW9uIGluZm9ybWF0aW9uIG5lZWRlZCBieSBhCiAgIGBDb250YWluZXJgIHRvIGluc3RhbnRpYXRlIGFuZCBjYWNoZSBvYmplY3RzLgogIAogICBUaGUgQVBJIGZvciBgUmVnaXN0cnlgIGlzIHN0aWxsIGluIGZsdXggYW5kIHNob3VsZCBub3QgYmUgY29uc2lkZXJlZCBzdGFibGUuCiAgCiAgIEBwcml2YXRlCiAgIEBjbGFzcyBSZWdpc3RyeQogICBAc2luY2UgMS4xMS4wCiAgKi8KCiAgdmFyIFJlZ2lzdHJ5ID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gUmVnaXN0cnkob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICB0aGlzLmZhbGxiYWNrID0gb3B0aW9ucy5mYWxsYmFjayB8fCBudWxsOwogICAgICB0aGlzLnJlc29sdmVyID0gb3B0aW9ucy5yZXNvbHZlciB8fCBudWxsOwogICAgICB0aGlzLnJlZ2lzdHJhdGlvbnMgPSAoMCwgX3V0aWxzLmRpY3Rpb25hcnkpKG9wdGlvbnMucmVnaXN0cmF0aW9ucyB8fCBudWxsKTsKICAgICAgdGhpcy5fdHlwZUluamVjdGlvbnMgPSAoMCwgX3V0aWxzLmRpY3Rpb25hcnkpKG51bGwpOwogICAgICB0aGlzLl9pbmplY3Rpb25zID0gKDAsIF91dGlscy5kaWN0aW9uYXJ5KShudWxsKTsKICAgICAgdGhpcy5fbG9jYWxMb29rdXBDYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHRoaXMuX25vcm1hbGl6ZUNhY2hlID0gKDAsIF91dGlscy5kaWN0aW9uYXJ5KShudWxsKTsKICAgICAgdGhpcy5fcmVzb2x2ZUNhY2hlID0gKDAsIF91dGlscy5kaWN0aW9uYXJ5KShudWxsKTsKICAgICAgdGhpcy5fZmFpbFNldCA9IG5ldyBTZXQoKTsKICAgICAgdGhpcy5fb3B0aW9ucyA9ICgwLCBfdXRpbHMuZGljdGlvbmFyeSkobnVsbCk7CiAgICAgIHRoaXMuX3R5cGVPcHRpb25zID0gKDAsIF91dGlscy5kaWN0aW9uYXJ5KShudWxsKTsKICAgIH0KICAgIC8qKgogICAgIEEgYmFja3VwIHJlZ2lzdHJ5IGZvciByZXNvbHZpbmcgcmVnaXN0cmF0aW9ucyB3aGVuIG5vIG1hdGNoZXMgY2FuIGJlIGZvdW5kLgogICAgICAgIEBwcml2YXRlCiAgICAgQHByb3BlcnR5IGZhbGxiYWNrCiAgICAgQHR5cGUgUmVnaXN0cnkKICAgICAqLwoKICAgIC8qKgogICAgIEFuIG9iamVjdCB0aGF0IGhhcyBhIGByZXNvbHZlYCBtZXRob2QgdGhhdCByZXNvbHZlcyBhIG5hbWUuCiAgICAgICAgQHByaXZhdGUKICAgICBAcHJvcGVydHkgcmVzb2x2ZXIKICAgICBAdHlwZSBSZXNvbHZlcgogICAgICovCgogICAgLyoqCiAgICAgQHByaXZhdGUKICAgICBAcHJvcGVydHkgcmVnaXN0cmF0aW9ucwogICAgIEB0eXBlIEluaGVyaXRpbmdEaWN0CiAgICAgKi8KCiAgICAvKioKICAgICBAcHJpdmF0ZQogICAgICAgIEBwcm9wZXJ0eSBfdHlwZUluamVjdGlvbnMKICAgICBAdHlwZSBJbmhlcml0aW5nRGljdAogICAgICovCgogICAgLyoqCiAgICAgQHByaXZhdGUKICAgICAgICBAcHJvcGVydHkgX2luamVjdGlvbnMKICAgICBAdHlwZSBJbmhlcml0aW5nRGljdAogICAgICovCgogICAgLyoqCiAgICAgQHByaXZhdGUKICAgICAgICBAcHJvcGVydHkgX25vcm1hbGl6ZUNhY2hlCiAgICAgQHR5cGUgSW5oZXJpdGluZ0RpY3QKICAgICAqLwoKICAgIC8qKgogICAgIEBwcml2YXRlCiAgICAgICAgQHByb3BlcnR5IF9yZXNvbHZlQ2FjaGUKICAgICBAdHlwZSBJbmhlcml0aW5nRGljdAogICAgICovCgogICAgLyoqCiAgICAgQHByaXZhdGUKICAgICAgICBAcHJvcGVydHkgX29wdGlvbnMKICAgICBAdHlwZSBJbmhlcml0aW5nRGljdAogICAgICovCgogICAgLyoqCiAgICAgQHByaXZhdGUKICAgICAgICBAcHJvcGVydHkgX3R5cGVPcHRpb25zCiAgICAgQHR5cGUgSW5oZXJpdGluZ0RpY3QKICAgICAqLwoKICAgIC8qKgogICAgIENyZWF0ZXMgYSBjb250YWluZXIgYmFzZWQgb24gdGhpcyByZWdpc3RyeS4KICAgICAgICBAcHJpdmF0ZQogICAgIEBtZXRob2QgY29udGFpbmVyCiAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICBAcmV0dXJuIHtDb250YWluZXJ9IGNyZWF0ZWQgY29udGFpbmVyCiAgICAgKi8KCgogICAgdmFyIF9wcm90bzMgPSBSZWdpc3RyeS5wcm90b3R5cGU7CgogICAgX3Byb3RvMy5jb250YWluZXIgPSBmdW5jdGlvbiBjb250YWluZXIob3B0aW9ucykgewogICAgICByZXR1cm4gbmV3IENvbnRhaW5lcih0aGlzLCBvcHRpb25zKTsKICAgIH0KICAgIC8qKgogICAgIFJlZ2lzdGVycyBhIGZhY3RvcnkgZm9yIGxhdGVyIGluamVjdGlvbi4KICAgICAgICBFeGFtcGxlOgogICAgICAgIGBgYGphdmFzY3JpcHQKICAgICBsZXQgcmVnaXN0cnkgPSBuZXcgUmVnaXN0cnkoKTsKICAgICAgICByZWdpc3RyeS5yZWdpc3RlcignbW9kZWw6dXNlcicsIFBlcnNvbiwge3NpbmdsZXRvbjogZmFsc2UgfSk7CiAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2ZydWl0OmZhdm9yaXRlJywgT3JhbmdlKTsKICAgICByZWdpc3RyeS5yZWdpc3RlcignY29tbXVuaWNhdGlvbjptYWluJywgRW1haWwsIHtzaW5nbGV0b246IGZhbHNlfSk7CiAgICAgYGBgCiAgICAgICAgQHByaXZhdGUKICAgICBAbWV0aG9kIHJlZ2lzdGVyCiAgICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lCiAgICAgQHBhcmFtIHtGdW5jdGlvbn0gZmFjdG9yeQogICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8zLnJlZ2lzdGVyID0gZnVuY3Rpb24gcmVnaXN0ZXIoZnVsbE5hbWUsIGZhY3RvcnksIG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgKGZhbHNlICYmICEodGhpcy5pc1ZhbGlkRnVsbE5hbWUoZnVsbE5hbWUpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2Z1bGxOYW1lIG11c3QgYmUgYSBwcm9wZXIgZnVsbCBuYW1lJywgdGhpcy5pc1ZhbGlkRnVsbE5hbWUoZnVsbE5hbWUpKSk7CiAgICAgIChmYWxzZSAmJiAhKGZhY3RvcnkgIT09IHVuZGVmaW5lZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJBdHRlbXB0aW5nIHRvIHJlZ2lzdGVyIGFuIHVua25vd24gZmFjdG9yeTogJyIgKyBmdWxsTmFtZSArICInIiwgZmFjdG9yeSAhPT0gdW5kZWZpbmVkKSk7CiAgICAgIHZhciBub3JtYWxpemVkTmFtZSA9IHRoaXMubm9ybWFsaXplKGZ1bGxOYW1lKTsKICAgICAgKGZhbHNlICYmICEoIXRoaXMuX3Jlc29sdmVDYWNoZVtub3JtYWxpemVkTmFtZV0pICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQ2Fubm90IHJlLXJlZ2lzdGVyOiAnIiArIGZ1bGxOYW1lICsgIicsIGFzIGl0IGhhcyBhbHJlYWR5IGJlZW4gcmVzb2x2ZWQuIiwgIXRoaXMuX3Jlc29sdmVDYWNoZVtub3JtYWxpemVkTmFtZV0pKTsKCiAgICAgIHRoaXMuX2ZhaWxTZXQuZGVsZXRlKG5vcm1hbGl6ZWROYW1lKTsKCiAgICAgIHRoaXMucmVnaXN0cmF0aW9uc1tub3JtYWxpemVkTmFtZV0gPSBmYWN0b3J5OwogICAgICB0aGlzLl9vcHRpb25zW25vcm1hbGl6ZWROYW1lXSA9IG9wdGlvbnM7CiAgICB9CiAgICAvKioKICAgICBVbnJlZ2lzdGVyIGEgZnVsbE5hbWUKICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgbGV0IHJlZ2lzdHJ5ID0gbmV3IFJlZ2lzdHJ5KCk7CiAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ21vZGVsOnVzZXInLCBVc2VyKTsKICAgICAgICByZWdpc3RyeS5yZXNvbHZlKCdtb2RlbDp1c2VyJykuY3JlYXRlKCkgaW5zdGFuY2VvZiBVc2VyIC8vPT4gdHJ1ZQogICAgICAgIHJlZ2lzdHJ5LnVucmVnaXN0ZXIoJ21vZGVsOnVzZXInKQogICAgIHJlZ2lzdHJ5LnJlc29sdmUoJ21vZGVsOnVzZXInKSA9PT0gdW5kZWZpbmVkIC8vPT4gdHJ1ZQogICAgIGBgYAogICAgICAgIEBwcml2YXRlCiAgICAgQG1ldGhvZCB1bnJlZ2lzdGVyCiAgICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8zLnVucmVnaXN0ZXIgPSBmdW5jdGlvbiB1bnJlZ2lzdGVyKGZ1bGxOYW1lKSB7CiAgICAgIChmYWxzZSAmJiAhKHRoaXMuaXNWYWxpZEZ1bGxOYW1lKGZ1bGxOYW1lKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdmdWxsTmFtZSBtdXN0IGJlIGEgcHJvcGVyIGZ1bGwgbmFtZScsIHRoaXMuaXNWYWxpZEZ1bGxOYW1lKGZ1bGxOYW1lKSkpOwogICAgICB2YXIgbm9ybWFsaXplZE5hbWUgPSB0aGlzLm5vcm1hbGl6ZShmdWxsTmFtZSk7CiAgICAgIHRoaXMuX2xvY2FsTG9va3VwQ2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBkZWxldGUgdGhpcy5yZWdpc3RyYXRpb25zW25vcm1hbGl6ZWROYW1lXTsKICAgICAgZGVsZXRlIHRoaXMuX3Jlc29sdmVDYWNoZVtub3JtYWxpemVkTmFtZV07CiAgICAgIGRlbGV0ZSB0aGlzLl9vcHRpb25zW25vcm1hbGl6ZWROYW1lXTsKCiAgICAgIHRoaXMuX2ZhaWxTZXQuZGVsZXRlKG5vcm1hbGl6ZWROYW1lKTsKICAgIH0KICAgIC8qKgogICAgIEdpdmVuIGEgZnVsbE5hbWUgcmV0dXJuIHRoZSBjb3JyZXNwb25kaW5nIGZhY3RvcnkuCiAgICAgICAgQnkgZGVmYXVsdCBgcmVzb2x2ZWAgd2lsbCByZXRyaWV2ZSB0aGUgZmFjdG9yeSBmcm9tCiAgICAgdGhlIHJlZ2lzdHJ5LgogICAgICAgIGBgYGphdmFzY3JpcHQKICAgICBsZXQgcmVnaXN0cnkgPSBuZXcgUmVnaXN0cnkoKTsKICAgICByZWdpc3RyeS5yZWdpc3RlcignYXBpOnR3aXR0ZXInLCBUd2l0dGVyKTsKICAgICAgICByZWdpc3RyeS5yZXNvbHZlKCdhcGk6dHdpdHRlcicpIC8vID0+IFR3aXR0ZXIKICAgICBgYGAKICAgICAgICBPcHRpb25hbGx5IHRoZSByZWdpc3RyeSBjYW4gYmUgcHJvdmlkZWQgd2l0aCBhIGN1c3RvbSByZXNvbHZlci4KICAgICBJZiBwcm92aWRlZCwgYHJlc29sdmVgIHdpbGwgZmlyc3QgcHJvdmlkZSB0aGUgY3VzdG9tIHJlc29sdmVyCiAgICAgdGhlIG9wcG9ydHVuaXR5IHRvIHJlc29sdmUgdGhlIGZ1bGxOYW1lLCBvdGhlcndpc2UgaXQgd2lsbCBmYWxsYmFjawogICAgIHRvIHRoZSByZWdpc3RyeS4KICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgbGV0IHJlZ2lzdHJ5ID0gbmV3IFJlZ2lzdHJ5KCk7CiAgICAgcmVnaXN0cnkucmVzb2x2ZXIgPSBmdW5jdGlvbihmdWxsTmFtZSkgewogICAgICAgIC8vIGxvb2t1cCB2aWEgdGhlIG1vZHVsZSBzeXN0ZW0gb2YgY2hvaWNlCiAgICAgIH07CiAgICAgICAgLy8gdGhlIHR3aXR0ZXIgZmFjdG9yeSBpcyBhZGRlZCB0byB0aGUgbW9kdWxlIHN5c3RlbQogICAgIHJlZ2lzdHJ5LnJlc29sdmUoJ2FwaTp0d2l0dGVyJykgLy8gPT4gVHdpdHRlcgogICAgIGBgYAogICAgICAgIEBwcml2YXRlCiAgICAgQG1ldGhvZCByZXNvbHZlCiAgICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lCiAgICAgQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXQogICAgIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy5zb3VyY2VdIHRoZSBmdWxsbmFtZSBvZiB0aGUgcmVxdWVzdCBzb3VyY2UgKHVzZWQgZm9yIGxvY2FsIGxvb2t1cHMpCiAgICAgQHJldHVybiB7RnVuY3Rpb259IGZ1bGxOYW1lJ3MgZmFjdG9yeQogICAgICovCiAgICA7CgogICAgX3Byb3RvMy5yZXNvbHZlID0gZnVuY3Rpb24gcmVzb2x2ZShmdWxsTmFtZSwgb3B0aW9ucykgewogICAgICB2YXIgZmFjdG9yeSA9IF9yZXNvbHZlKHRoaXMsIHRoaXMubm9ybWFsaXplKGZ1bGxOYW1lKSwgb3B0aW9ucyk7CgogICAgICBpZiAoZmFjdG9yeSA9PT0gdW5kZWZpbmVkICYmIHRoaXMuZmFsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICB2YXIgX3RoaXMkZmFsbGJhY2s7CgogICAgICAgIGZhY3RvcnkgPSAoX3RoaXMkZmFsbGJhY2sgPSB0aGlzLmZhbGxiYWNrKS5yZXNvbHZlLmFwcGx5KF90aGlzJGZhbGxiYWNrLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gZmFjdG9yeTsKICAgIH0KICAgIC8qKgogICAgIEEgaG9vayB0aGF0IGNhbiBiZSB1c2VkIHRvIGRlc2NyaWJlIGhvdyB0aGUgcmVzb2x2ZXIgd2lsbAogICAgIGF0dGVtcHQgdG8gZmluZCB0aGUgZmFjdG9yeS4KICAgICAgICBGb3IgZXhhbXBsZSwgdGhlIGRlZmF1bHQgRW1iZXIgYC5kZXNjcmliZWAgcmV0dXJucyB0aGUgZnVsbAogICAgIGNsYXNzIG5hbWUgKGluY2x1ZGluZyBuYW1lc3BhY2UpIHdoZXJlIEVtYmVyJ3MgcmVzb2x2ZXIgZXhwZWN0cwogICAgIHRvIGZpbmQgdGhlIGBmdWxsTmFtZWAuCiAgICAgICAgQHByaXZhdGUKICAgICBAbWV0aG9kIGRlc2NyaWJlCiAgICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lCiAgICAgQHJldHVybiB7c3RyaW5nfSBkZXNjcmliZWQgZnVsbE5hbWUKICAgICAqLwogICAgOwoKICAgIF9wcm90bzMuZGVzY3JpYmUgPSBmdW5jdGlvbiBkZXNjcmliZShmdWxsTmFtZSkgewogICAgICBpZiAodGhpcy5yZXNvbHZlciAhPT0gbnVsbCAmJiB0aGlzLnJlc29sdmVyLmxvb2t1cERlc2NyaXB0aW9uKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucmVzb2x2ZXIubG9va3VwRGVzY3JpcHRpb24oZnVsbE5hbWUpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuZmFsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gdGhpcy5mYWxsYmFjay5kZXNjcmliZShmdWxsTmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZ1bGxOYW1lOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICBBIGhvb2sgdG8gZW5hYmxlIGN1c3RvbSBmdWxsTmFtZSBub3JtYWxpemF0aW9uIGJlaGF2aW9yCiAgICAgICAgQHByaXZhdGUKICAgICBAbWV0aG9kIG5vcm1hbGl6ZUZ1bGxOYW1lCiAgICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lCiAgICAgQHJldHVybiB7c3RyaW5nfSBub3JtYWxpemVkIGZ1bGxOYW1lCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8zLm5vcm1hbGl6ZUZ1bGxOYW1lID0gZnVuY3Rpb24gbm9ybWFsaXplRnVsbE5hbWUoZnVsbE5hbWUpIHsKICAgICAgaWYgKHRoaXMucmVzb2x2ZXIgIT09IG51bGwgJiYgdGhpcy5yZXNvbHZlci5ub3JtYWxpemUpIHsKICAgICAgICByZXR1cm4gdGhpcy5yZXNvbHZlci5ub3JtYWxpemUoZnVsbE5hbWUpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuZmFsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gdGhpcy5mYWxsYmFjay5ub3JtYWxpemVGdWxsTmFtZShmdWxsTmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZ1bGxOYW1lOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICBOb3JtYWxpemUgYSBmdWxsTmFtZSBiYXNlZCBvbiB0aGUgYXBwbGljYXRpb24ncyBjb252ZW50aW9ucwogICAgICAgIEBwcml2YXRlCiAgICAgQG1ldGhvZCBub3JtYWxpemUKICAgICBAcGFyYW0ge1N0cmluZ30gZnVsbE5hbWUKICAgICBAcmV0dXJuIHtzdHJpbmd9IG5vcm1hbGl6ZWQgZnVsbE5hbWUKICAgICAqLwogICAgOwoKICAgIF9wcm90bzMubm9ybWFsaXplID0gZnVuY3Rpb24gbm9ybWFsaXplKGZ1bGxOYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLl9ub3JtYWxpemVDYWNoZVtmdWxsTmFtZV0gfHwgKHRoaXMuX25vcm1hbGl6ZUNhY2hlW2Z1bGxOYW1lXSA9IHRoaXMubm9ybWFsaXplRnVsbE5hbWUoZnVsbE5hbWUpKTsKICAgIH0KICAgIC8qKgogICAgIEBtZXRob2QgbWFrZVRvU3RyaW5nCiAgICAgICAgQHByaXZhdGUKICAgICBAcGFyYW0ge2FueX0gZmFjdG9yeQogICAgIEBwYXJhbSB7c3RyaW5nfSBmdWxsTmFtZQogICAgIEByZXR1cm4ge2Z1bmN0aW9ufSB0b1N0cmluZyBmdW5jdGlvbgogICAgICovCiAgICA7CgogICAgX3Byb3RvMy5tYWtlVG9TdHJpbmcgPSBmdW5jdGlvbiBtYWtlVG9TdHJpbmcoZmFjdG9yeSwgZnVsbE5hbWUpIHsKICAgICAgaWYgKHRoaXMucmVzb2x2ZXIgIT09IG51bGwgJiYgdGhpcy5yZXNvbHZlci5tYWtlVG9TdHJpbmcpIHsKICAgICAgICByZXR1cm4gdGhpcy5yZXNvbHZlci5tYWtlVG9TdHJpbmcoZmFjdG9yeSwgZnVsbE5hbWUpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuZmFsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gdGhpcy5mYWxsYmFjay5tYWtlVG9TdHJpbmcoZmFjdG9yeSwgZnVsbE5hbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWN0b3J5LnRvU3RyaW5nKCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgIEdpdmVuIGEgZnVsbE5hbWUgY2hlY2sgaWYgdGhlIGNvbnRhaW5lciBpcyBhd2FyZSBvZiBpdHMgZmFjdG9yeQogICAgIG9yIHNpbmdsZXRvbiBpbnN0YW5jZS4KICAgICAgICBAcHJpdmF0ZQogICAgIEBtZXRob2QgaGFzCiAgICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lCiAgICAgQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXQogICAgIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy5zb3VyY2VdIHRoZSBmdWxsbmFtZSBvZiB0aGUgcmVxdWVzdCBzb3VyY2UgKHVzZWQgZm9yIGxvY2FsIGxvb2t1cHMpCiAgICAgQHJldHVybiB7Qm9vbGVhbn0KICAgICAqLwogICAgOwoKICAgIF9wcm90bzMuaGFzID0gZnVuY3Rpb24gaGFzKGZ1bGxOYW1lLCBvcHRpb25zKSB7CiAgICAgIGlmICghdGhpcy5pc1ZhbGlkRnVsbE5hbWUoZnVsbE5hbWUpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB2YXIgc291cmNlID0gb3B0aW9ucyAmJiBvcHRpb25zLnNvdXJjZSAmJiB0aGlzLm5vcm1hbGl6ZShvcHRpb25zLnNvdXJjZSk7CiAgICAgIHZhciBuYW1lc3BhY2UgPSBvcHRpb25zICYmIG9wdGlvbnMubmFtZXNwYWNlIHx8IHVuZGVmaW5lZDsKICAgICAgcmV0dXJuIF9oYXModGhpcywgdGhpcy5ub3JtYWxpemUoZnVsbE5hbWUpLCBzb3VyY2UsIG5hbWVzcGFjZSk7CiAgICB9CiAgICAvKioKICAgICBBbGxvdyByZWdpc3RlcmluZyBvcHRpb25zIGZvciBhbGwgZmFjdG9yaWVzIG9mIGEgdHlwZS4KICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgbGV0IHJlZ2lzdHJ5ID0gbmV3IFJlZ2lzdHJ5KCk7CiAgICAgbGV0IGNvbnRhaW5lciA9IHJlZ2lzdHJ5LmNvbnRhaW5lcigpOwogICAgICAgIC8vIGlmIGFsbCBvZiB0eXBlIGBjb25uZWN0aW9uYCBtdXN0IG5vdCBiZSBzaW5nbGV0b25zCiAgICAgcmVnaXN0cnkub3B0aW9uc0ZvclR5cGUoJ2Nvbm5lY3Rpb24nLCB7IHNpbmdsZXRvbjogZmFsc2UgfSk7CiAgICAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2Nvbm5lY3Rpb246dHdpdHRlcicsIFR3aXR0ZXJDb25uZWN0aW9uKTsKICAgICByZWdpc3RyeS5yZWdpc3RlcignY29ubmVjdGlvbjpmYWNlYm9vaycsIEZhY2Vib29rQ29ubmVjdGlvbik7CiAgICAgICAgbGV0IHR3aXR0ZXIgPSBjb250YWluZXIubG9va3VwKCdjb25uZWN0aW9uOnR3aXR0ZXInKTsKICAgICBsZXQgdHdpdHRlcjIgPSBjb250YWluZXIubG9va3VwKCdjb25uZWN0aW9uOnR3aXR0ZXInKTsKICAgICAgICB0d2l0dGVyID09PSB0d2l0dGVyMjsgLy8gPT4gZmFsc2UKICAgICAgICBsZXQgZmFjZWJvb2sgPSBjb250YWluZXIubG9va3VwKCdjb25uZWN0aW9uOmZhY2Vib29rJyk7CiAgICAgbGV0IGZhY2Vib29rMiA9IGNvbnRhaW5lci5sb29rdXAoJ2Nvbm5lY3Rpb246ZmFjZWJvb2snKTsKICAgICAgICBmYWNlYm9vayA9PT0gZmFjZWJvb2syOyAvLyA9PiBmYWxzZQogICAgIGBgYAogICAgICAgIEBwcml2YXRlCiAgICAgQG1ldGhvZCBvcHRpb25zRm9yVHlwZQogICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAqLwogICAgOwoKICAgIF9wcm90bzMub3B0aW9uc0ZvclR5cGUgPSBmdW5jdGlvbiBvcHRpb25zRm9yVHlwZSh0eXBlLCBvcHRpb25zKSB7CiAgICAgIHRoaXMuX3R5cGVPcHRpb25zW3R5cGVdID0gb3B0aW9uczsKICAgIH07CgogICAgX3Byb3RvMy5nZXRPcHRpb25zRm9yVHlwZSA9IGZ1bmN0aW9uIGdldE9wdGlvbnNGb3JUeXBlKHR5cGUpIHsKICAgICAgdmFyIG9wdGlvbnNGb3JUeXBlID0gdGhpcy5fdHlwZU9wdGlvbnNbdHlwZV07CgogICAgICBpZiAob3B0aW9uc0ZvclR5cGUgPT09IHVuZGVmaW5lZCAmJiB0aGlzLmZhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgb3B0aW9uc0ZvclR5cGUgPSB0aGlzLmZhbGxiYWNrLmdldE9wdGlvbnNGb3JUeXBlKHR5cGUpOwogICAgICB9CgogICAgICByZXR1cm4gb3B0aW9uc0ZvclR5cGU7CiAgICB9CiAgICAvKioKICAgICBAcHJpdmF0ZQogICAgIEBtZXRob2Qgb3B0aW9ucwogICAgIEBwYXJhbSB7U3RyaW5nfSBmdWxsTmFtZQogICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8zLm9wdGlvbnMgPSBmdW5jdGlvbiBvcHRpb25zKGZ1bGxOYW1lLCBfb3B0aW9ucykgewogICAgICB2YXIgbm9ybWFsaXplZE5hbWUgPSB0aGlzLm5vcm1hbGl6ZShmdWxsTmFtZSk7CiAgICAgIHRoaXMuX29wdGlvbnNbbm9ybWFsaXplZE5hbWVdID0gX29wdGlvbnM7CiAgICB9OwoKICAgIF9wcm90bzMuZ2V0T3B0aW9ucyA9IGZ1bmN0aW9uIGdldE9wdGlvbnMoZnVsbE5hbWUpIHsKICAgICAgdmFyIG5vcm1hbGl6ZWROYW1lID0gdGhpcy5ub3JtYWxpemUoZnVsbE5hbWUpOwogICAgICB2YXIgb3B0aW9ucyA9IHRoaXMuX29wdGlvbnNbbm9ybWFsaXplZE5hbWVdOwoKICAgICAgaWYgKG9wdGlvbnMgPT09IHVuZGVmaW5lZCAmJiB0aGlzLmZhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgb3B0aW9ucyA9IHRoaXMuZmFsbGJhY2suZ2V0T3B0aW9ucyhmdWxsTmFtZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBvcHRpb25zOwogICAgfTsKCiAgICBfcHJvdG8zLmdldE9wdGlvbiA9IGZ1bmN0aW9uIGdldE9wdGlvbihmdWxsTmFtZSwgb3B0aW9uTmFtZSkgewogICAgICB2YXIgb3B0aW9ucyA9IHRoaXMuX29wdGlvbnNbZnVsbE5hbWVdOwoKICAgICAgaWYgKG9wdGlvbnMgIT09IHVuZGVmaW5lZCAmJiBvcHRpb25zW29wdGlvbk5hbWVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gb3B0aW9uc1tvcHRpb25OYW1lXTsKICAgICAgfQoKICAgICAgdmFyIHR5cGUgPSBmdWxsTmFtZS5zcGxpdCgnOicpWzBdOwogICAgICBvcHRpb25zID0gdGhpcy5fdHlwZU9wdGlvbnNbdHlwZV07CgogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zW29wdGlvbk5hbWVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gb3B0aW9uc1tvcHRpb25OYW1lXTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmZhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZmFsbGJhY2suZ2V0T3B0aW9uKGZ1bGxOYW1lLCBvcHRpb25OYW1lKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KICAgIC8qKgogICAgIFVzZWQgb25seSB2aWEgYGluamVjdGlvbmAuCiAgICAgICAgUHJvdmlkZXMgYSBzcGVjaWFsaXplZCBmb3JtIG9mIGluamVjdGlvbiwgc3BlY2lmaWNhbGx5IGVuYWJsaW5nCiAgICAgYWxsIG9iamVjdHMgb2Ygb25lIHR5cGUgdG8gYmUgaW5qZWN0ZWQgd2l0aCBhIHJlZmVyZW5jZSB0byBhbm90aGVyCiAgICAgb2JqZWN0LgogICAgICAgIEZvciBleGFtcGxlLCBwcm92aWRlZCBlYWNoIG9iamVjdCBvZiB0eXBlIGBjb250cm9sbGVyYCBuZWVkZWQgYSBgcm91dGVyYC4KICAgICBvbmUgd291bGQgZG8gdGhlIGZvbGxvd2luZzoKICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgbGV0IHJlZ2lzdHJ5ID0gbmV3IFJlZ2lzdHJ5KCk7CiAgICAgbGV0IGNvbnRhaW5lciA9IHJlZ2lzdHJ5LmNvbnRhaW5lcigpOwogICAgICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdyb3V0ZXI6bWFpbicsIFJvdXRlcik7CiAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2NvbnRyb2xsZXI6dXNlcicsIFVzZXJDb250cm9sbGVyKTsKICAgICByZWdpc3RyeS5yZWdpc3RlcignY29udHJvbGxlcjpwb3N0JywgUG9zdENvbnRyb2xsZXIpOwogICAgICAgIHJlZ2lzdHJ5LnR5cGVJbmplY3Rpb24oJ2NvbnRyb2xsZXInLCAncm91dGVyJywgJ3JvdXRlcjptYWluJyk7CiAgICAgICAgbGV0IHVzZXIgPSBjb250YWluZXIubG9va3VwKCdjb250cm9sbGVyOnVzZXInKTsKICAgICBsZXQgcG9zdCA9IGNvbnRhaW5lci5sb29rdXAoJ2NvbnRyb2xsZXI6cG9zdCcpOwogICAgICAgIHVzZXIucm91dGVyIGluc3RhbmNlb2YgUm91dGVyOyAvLz0+IHRydWUKICAgICBwb3N0LnJvdXRlciBpbnN0YW5jZW9mIFJvdXRlcjsgLy89PiB0cnVlCiAgICAgICAgLy8gYm90aCBjb250cm9sbGVycyBzaGFyZSB0aGUgc2FtZSByb3V0ZXIKICAgICB1c2VyLnJvdXRlciA9PT0gcG9zdC5yb3V0ZXI7IC8vPT4gdHJ1ZQogICAgIGBgYAogICAgICAgIEBwcml2YXRlCiAgICAgQG1ldGhvZCB0eXBlSW5qZWN0aW9uCiAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkKICAgICBAcGFyYW0ge1N0cmluZ30gZnVsbE5hbWUKICAgICAqLwogICAgOwoKICAgIF9wcm90bzMudHlwZUluamVjdGlvbiA9IGZ1bmN0aW9uIHR5cGVJbmplY3Rpb24odHlwZSwgcHJvcGVydHksIGZ1bGxOYW1lKSB7CiAgICAgIChmYWxzZSAmJiAhKHRoaXMuaXNWYWxpZEZ1bGxOYW1lKGZ1bGxOYW1lKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdmdWxsTmFtZSBtdXN0IGJlIGEgcHJvcGVyIGZ1bGwgbmFtZScsIHRoaXMuaXNWYWxpZEZ1bGxOYW1lKGZ1bGxOYW1lKSkpOwogICAgICB2YXIgZnVsbE5hbWVUeXBlID0gZnVsbE5hbWUuc3BsaXQoJzonKVswXTsKICAgICAgKGZhbHNlICYmICEoZnVsbE5hbWVUeXBlICE9PSB0eXBlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkNhbm5vdCBpbmplY3QgYSAnIiArIGZ1bGxOYW1lICsgIicgb24gb3RoZXIgIiArIHR5cGUgKyAiKHMpLiIsIGZ1bGxOYW1lVHlwZSAhPT0gdHlwZSkpOwogICAgICB2YXIgaW5qZWN0aW9ucyA9IHRoaXMuX3R5cGVJbmplY3Rpb25zW3R5cGVdIHx8ICh0aGlzLl90eXBlSW5qZWN0aW9uc1t0eXBlXSA9IFtdKTsKICAgICAgaW5qZWN0aW9ucy5wdXNoKHsKICAgICAgICBwcm9wZXJ0eTogcHJvcGVydHksCiAgICAgICAgc3BlY2lmaWVyOiBmdWxsTmFtZQogICAgICB9KTsKICAgIH0KICAgIC8qKgogICAgIERlZmluZXMgaW5qZWN0aW9uIHJ1bGVzLgogICAgICAgIFRoZXNlIHJ1bGVzIGFyZSB1c2VkIHRvIGluamVjdCBkZXBlbmRlbmNpZXMgb250byBvYmplY3RzIHdoZW4gdGhleQogICAgIGFyZSBpbnN0YW50aWF0ZWQuCiAgICAgICAgVHdvIGZvcm1zIG9mIGluamVjdGlvbnMgYXJlIHBvc3NpYmxlOgogICAgICAgICogSW5qZWN0aW5nIG9uZSBmdWxsTmFtZSBvbiBhbm90aGVyIGZ1bGxOYW1lCiAgICAgKiBJbmplY3Rpbmcgb25lIGZ1bGxOYW1lIG9uIGEgdHlwZQogICAgICAgIEV4YW1wbGU6CiAgICAgICAgYGBgamF2YXNjcmlwdAogICAgIGxldCByZWdpc3RyeSA9IG5ldyBSZWdpc3RyeSgpOwogICAgIGxldCBjb250YWluZXIgPSByZWdpc3RyeS5jb250YWluZXIoKTsKICAgICAgICByZWdpc3RyeS5yZWdpc3Rlcignc291cmNlOm1haW4nLCBTb3VyY2UpOwogICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdtb2RlbDp1c2VyJywgVXNlcik7CiAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ21vZGVsOnBvc3QnLCBQb3N0KTsKICAgICAgICAvLyBpbmplY3Rpbmcgb25lIGZ1bGxOYW1lIG9uIGFub3RoZXIgZnVsbE5hbWUKICAgICAvLyBlZy4gZWFjaCB1c2VyIG1vZGVsIGdldHMgYSBwb3N0IG1vZGVsCiAgICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdtb2RlbDp1c2VyJywgJ3Bvc3QnLCAnbW9kZWw6cG9zdCcpOwogICAgICAgIC8vIGluamVjdGluZyBvbmUgZnVsbE5hbWUgb24gYW5vdGhlciB0eXBlCiAgICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdtb2RlbCcsICdzb3VyY2UnLCAnc291cmNlOm1haW4nKTsKICAgICAgICBsZXQgdXNlciA9IGNvbnRhaW5lci5sb29rdXAoJ21vZGVsOnVzZXInKTsKICAgICBsZXQgcG9zdCA9IGNvbnRhaW5lci5sb29rdXAoJ21vZGVsOnBvc3QnKTsKICAgICAgICB1c2VyLnNvdXJjZSBpbnN0YW5jZW9mIFNvdXJjZTsgLy89PiB0cnVlCiAgICAgcG9zdC5zb3VyY2UgaW5zdGFuY2VvZiBTb3VyY2U7IC8vPT4gdHJ1ZQogICAgICAgIHVzZXIucG9zdCBpbnN0YW5jZW9mIFBvc3Q7IC8vPT4gdHJ1ZQogICAgICAgIC8vIGFuZCBib3RoIG1vZGVscyBzaGFyZSB0aGUgc2FtZSBzb3VyY2UKICAgICB1c2VyLnNvdXJjZSA9PT0gcG9zdC5zb3VyY2U7IC8vPT4gdHJ1ZQogICAgIGBgYAogICAgICAgIEBwcml2YXRlCiAgICAgQG1ldGhvZCBpbmplY3Rpb24KICAgICBAcGFyYW0ge1N0cmluZ30gZmFjdG9yeU5hbWUKICAgICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkKICAgICBAcGFyYW0ge1N0cmluZ30gaW5qZWN0aW9uTmFtZQogICAgICovCiAgICA7CgogICAgX3Byb3RvMy5pbmplY3Rpb24gPSBmdW5jdGlvbiBpbmplY3Rpb24oZnVsbE5hbWUsIHByb3BlcnR5LCBpbmplY3Rpb25OYW1lKSB7CiAgICAgIChmYWxzZSAmJiAhKHRoaXMuaXNWYWxpZEZ1bGxOYW1lKGluamVjdGlvbk5hbWUpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkludmFsaWQgaW5qZWN0aW9uTmFtZSwgZXhwZWN0ZWQ6ICd0eXBlOm5hbWUnIGdvdDogIiArIGluamVjdGlvbk5hbWUsIHRoaXMuaXNWYWxpZEZ1bGxOYW1lKGluamVjdGlvbk5hbWUpKSk7CiAgICAgIHZhciBub3JtYWxpemVkSW5qZWN0aW9uTmFtZSA9IHRoaXMubm9ybWFsaXplKGluamVjdGlvbk5hbWUpOwoKICAgICAgaWYgKGZ1bGxOYW1lLmluZGV4T2YoJzonKSA9PT0gLTEpIHsKICAgICAgICByZXR1cm4gdGhpcy50eXBlSW5qZWN0aW9uKGZ1bGxOYW1lLCBwcm9wZXJ0eSwgbm9ybWFsaXplZEluamVjdGlvbk5hbWUpOwogICAgICB9CgogICAgICAoZmFsc2UgJiYgISh0aGlzLmlzVmFsaWRGdWxsTmFtZShmdWxsTmFtZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnZnVsbE5hbWUgbXVzdCBiZSBhIHByb3BlciBmdWxsIG5hbWUnLCB0aGlzLmlzVmFsaWRGdWxsTmFtZShmdWxsTmFtZSkpKTsKICAgICAgdmFyIG5vcm1hbGl6ZWROYW1lID0gdGhpcy5ub3JtYWxpemUoZnVsbE5hbWUpOwogICAgICB2YXIgaW5qZWN0aW9ucyA9IHRoaXMuX2luamVjdGlvbnNbbm9ybWFsaXplZE5hbWVdIHx8ICh0aGlzLl9pbmplY3Rpb25zW25vcm1hbGl6ZWROYW1lXSA9IFtdKTsKICAgICAgaW5qZWN0aW9ucy5wdXNoKHsKICAgICAgICBwcm9wZXJ0eTogcHJvcGVydHksCiAgICAgICAgc3BlY2lmaWVyOiBub3JtYWxpemVkSW5qZWN0aW9uTmFtZQogICAgICB9KTsKICAgIH0KICAgIC8qKgogICAgIEBwcml2YXRlCiAgICAgQG1ldGhvZCBrbm93bkZvclR5cGUKICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSB0aGUgdHlwZSB0byBpdGVyYXRlIG92ZXIKICAgICovCiAgICA7CgogICAgX3Byb3RvMy5rbm93bkZvclR5cGUgPSBmdW5jdGlvbiBrbm93bkZvclR5cGUodHlwZSkgewogICAgICB2YXIgbG9jYWxLbm93biA9ICgwLCBfdXRpbHMuZGljdGlvbmFyeSkobnVsbCk7CiAgICAgIHZhciByZWdpc3RlcmVkTmFtZXMgPSBPYmplY3Qua2V5cyh0aGlzLnJlZ2lzdHJhdGlvbnMpOwoKICAgICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IHJlZ2lzdGVyZWROYW1lcy5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICB2YXIgZnVsbE5hbWUgPSByZWdpc3RlcmVkTmFtZXNbaW5kZXhdOwogICAgICAgIHZhciBpdGVtVHlwZSA9IGZ1bGxOYW1lLnNwbGl0KCc6JylbMF07CgogICAgICAgIGlmIChpdGVtVHlwZSA9PT0gdHlwZSkgewogICAgICAgICAgbG9jYWxLbm93bltmdWxsTmFtZV0gPSB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIGZhbGxiYWNrS25vd24sIHJlc29sdmVyS25vd247CgogICAgICBpZiAodGhpcy5mYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgIGZhbGxiYWNrS25vd24gPSB0aGlzLmZhbGxiYWNrLmtub3duRm9yVHlwZSh0eXBlKTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMucmVzb2x2ZXIgIT09IG51bGwgJiYgdGhpcy5yZXNvbHZlci5rbm93bkZvclR5cGUpIHsKICAgICAgICByZXNvbHZlcktub3duID0gdGhpcy5yZXNvbHZlci5rbm93bkZvclR5cGUodHlwZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCBmYWxsYmFja0tub3duLCBsb2NhbEtub3duLCByZXNvbHZlcktub3duKTsKICAgIH07CgogICAgX3Byb3RvMy5pc1ZhbGlkRnVsbE5hbWUgPSBmdW5jdGlvbiBpc1ZhbGlkRnVsbE5hbWUoZnVsbE5hbWUpIHsKICAgICAgcmV0dXJuIFZBTElEX0ZVTExfTkFNRV9SRUdFWFAudGVzdChmdWxsTmFtZSk7CiAgICB9OwoKICAgIF9wcm90bzMuZ2V0SW5qZWN0aW9ucyA9IGZ1bmN0aW9uIGdldEluamVjdGlvbnMoZnVsbE5hbWUpIHsKICAgICAgdmFyIGluamVjdGlvbnMgPSB0aGlzLl9pbmplY3Rpb25zW2Z1bGxOYW1lXTsKCiAgICAgIGlmICh0aGlzLmZhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgdmFyIGZhbGxiYWNrSW5qZWN0aW9ucyA9IHRoaXMuZmFsbGJhY2suZ2V0SW5qZWN0aW9ucyhmdWxsTmFtZSk7CgogICAgICAgIGlmIChmYWxsYmFja0luamVjdGlvbnMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgaW5qZWN0aW9ucyA9IGluamVjdGlvbnMgPT09IHVuZGVmaW5lZCA/IGZhbGxiYWNrSW5qZWN0aW9ucyA6IGluamVjdGlvbnMuY29uY2F0KGZhbGxiYWNrSW5qZWN0aW9ucyk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gaW5qZWN0aW9uczsKICAgIH07CgogICAgX3Byb3RvMy5nZXRUeXBlSW5qZWN0aW9ucyA9IGZ1bmN0aW9uIGdldFR5cGVJbmplY3Rpb25zKHR5cGUpIHsKICAgICAgdmFyIGluamVjdGlvbnMgPSB0aGlzLl90eXBlSW5qZWN0aW9uc1t0eXBlXTsKCiAgICAgIGlmICh0aGlzLmZhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgdmFyIGZhbGxiYWNrSW5qZWN0aW9ucyA9IHRoaXMuZmFsbGJhY2suZ2V0VHlwZUluamVjdGlvbnModHlwZSk7CgogICAgICAgIGlmIChmYWxsYmFja0luamVjdGlvbnMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgaW5qZWN0aW9ucyA9IGluamVjdGlvbnMgPT09IHVuZGVmaW5lZCA/IGZhbGxiYWNrSW5qZWN0aW9ucyA6IGluamVjdGlvbnMuY29uY2F0KGZhbGxiYWNrSW5qZWN0aW9ucyk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gaW5qZWN0aW9uczsKICAgIH0KICAgIC8qKgogICAgIEdpdmVuIGEgZnVsbE5hbWUgYW5kIGEgc291cmNlIGZ1bGxOYW1lIHJldHVybnMgdGhlIGZ1bGx5IHJlc29sdmVkCiAgICAgZnVsbE5hbWUuIFVzZWQgdG8gYWxsb3cgZm9yIGxvY2FsIGxvb2t1cC4KICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgbGV0IHJlZ2lzdHJ5ID0gbmV3IFJlZ2lzdHJ5KCk7CiAgICAgICAgLy8gdGhlIHR3aXR0ZXIgZmFjdG9yeSBpcyBhZGRlZCB0byB0aGUgbW9kdWxlIHN5c3RlbQogICAgIHJlZ2lzdHJ5LmV4cGFuZExvY2FsTG9va3VwKCdjb21wb25lbnQ6cG9zdC10aXRsZScsIHsgc291cmNlOiAndGVtcGxhdGU6cG9zdCcgfSkgLy8gPT4gY29tcG9uZW50OnBvc3QvcG9zdC10aXRsZQogICAgIGBgYAogICAgICAgIEBwcml2YXRlCiAgICAgQG1ldGhvZCBleHBhbmRMb2NhbExvb2t1cAogICAgIEBwYXJhbSB7U3RyaW5nfSBmdWxsTmFtZQogICAgIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10KICAgICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMuc291cmNlXSB0aGUgZnVsbG5hbWUgb2YgdGhlIHJlcXVlc3Qgc291cmNlICh1c2VkIGZvciBsb2NhbCBsb29rdXBzKQogICAgIEByZXR1cm4ge1N0cmluZ30gZnVsbE5hbWUKICAgICAqLwogICAgOwoKICAgIF9wcm90bzMuZXhwYW5kTG9jYWxMb29rdXAgPSBmdW5jdGlvbiBleHBhbmRMb2NhbExvb2t1cChmdWxsTmFtZSwgb3B0aW9ucykgewogICAgICBpZiAodGhpcy5yZXNvbHZlciAhPT0gbnVsbCAmJiB0aGlzLnJlc29sdmVyLmV4cGFuZExvY2FsTG9va3VwKSB7CiAgICAgICAgKGZhbHNlICYmICEodGhpcy5pc1ZhbGlkRnVsbE5hbWUoZnVsbE5hbWUpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2Z1bGxOYW1lIG11c3QgYmUgYSBwcm9wZXIgZnVsbCBuYW1lJywgdGhpcy5pc1ZhbGlkRnVsbE5hbWUoZnVsbE5hbWUpKSk7CiAgICAgICAgKGZhbHNlICYmICEoIW9wdGlvbnMuc291cmNlIHx8IHRoaXMuaXNWYWxpZEZ1bGxOYW1lKG9wdGlvbnMuc291cmNlKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdvcHRpb25zLnNvdXJjZSBtdXN0IGJlIGEgcHJvcGVyIGZ1bGwgbmFtZScsICFvcHRpb25zLnNvdXJjZSB8fCB0aGlzLmlzVmFsaWRGdWxsTmFtZShvcHRpb25zLnNvdXJjZSkpKTsKICAgICAgICB2YXIgbm9ybWFsaXplZEZ1bGxOYW1lID0gdGhpcy5ub3JtYWxpemUoZnVsbE5hbWUpOwogICAgICAgIHZhciBub3JtYWxpemVkU291cmNlID0gdGhpcy5ub3JtYWxpemUob3B0aW9ucy5zb3VyY2UpOwogICAgICAgIHJldHVybiBfZXhwYW5kTG9jYWxMb29rdXAodGhpcywgbm9ybWFsaXplZEZ1bGxOYW1lLCBub3JtYWxpemVkU291cmNlLCBvcHRpb25zLm5hbWVzcGFjZSk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5mYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiB0aGlzLmZhbGxiYWNrLmV4cGFuZExvY2FsTG9va3VwKGZ1bGxOYW1lLCBvcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gUmVnaXN0cnk7CiAgfSgpOwoKICBfZXhwb3J0cy5SZWdpc3RyeSA9IFJlZ2lzdHJ5OwoKICBpZiAoZmFsc2UKICAvKiBERUJVRyAqLwogICkgewogICAgdmFyIHByb3RvID0gUmVnaXN0cnkucHJvdG90eXBlOwoKICAgIHByb3RvLm5vcm1hbGl6ZUluamVjdGlvbnNIYXNoID0gZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgdmFyIGluamVjdGlvbnMgPSBbXTsKCiAgICAgIGZvciAodmFyIGtleSBpbiBoYXNoKSB7CiAgICAgICAgaWYgKGhhc2guaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgdmFyIF9oYXNoJGtleSA9IGhhc2hba2V5XSwKICAgICAgICAgICAgICBzcGVjaWZpZXIgPSBfaGFzaCRrZXkuc3BlY2lmaWVyLAogICAgICAgICAgICAgIHNvdXJjZSA9IF9oYXNoJGtleS5zb3VyY2UsCiAgICAgICAgICAgICAgbmFtZXNwYWNlID0gX2hhc2gka2V5Lm5hbWVzcGFjZTsKICAgICAgICAgIChmYWxzZSAmJiAhKHRoaXMuaXNWYWxpZEZ1bGxOYW1lKHNwZWNpZmllcikpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiRXhwZWN0ZWQgYSBwcm9wZXIgZnVsbCBuYW1lLCBnaXZlbiAnIiArIHNwZWNpZmllciArICInIiwgdGhpcy5pc1ZhbGlkRnVsbE5hbWUoc3BlY2lmaWVyKSkpOwogICAgICAgICAgaW5qZWN0aW9ucy5wdXNoKHsKICAgICAgICAgICAgcHJvcGVydHk6IGtleSwKICAgICAgICAgICAgc3BlY2lmaWVyOiBzcGVjaWZpZXIsCiAgICAgICAgICAgIHNvdXJjZTogc291cmNlLAogICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gaW5qZWN0aW9uczsKICAgIH07CgogICAgcHJvdG8udmFsaWRhdGVJbmplY3Rpb25zID0gZnVuY3Rpb24gKGluamVjdGlvbnMpIHsKICAgICAgaWYgKCFpbmplY3Rpb25zKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluamVjdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgX2luamVjdGlvbnMkaTIgPSBpbmplY3Rpb25zW2ldLAogICAgICAgICAgICBzcGVjaWZpZXIgPSBfaW5qZWN0aW9ucyRpMi5zcGVjaWZpZXIsCiAgICAgICAgICAgIHNvdXJjZSA9IF9pbmplY3Rpb25zJGkyLnNvdXJjZSwKICAgICAgICAgICAgbmFtZXNwYWNlID0gX2luamVjdGlvbnMkaTIubmFtZXNwYWNlOwogICAgICAgIChmYWxzZSAmJiAhKHRoaXMuaGFzKHNwZWNpZmllciwgewogICAgICAgICAgc291cmNlOiBzb3VyY2UsCiAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZQogICAgICAgIH0pKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkF0dGVtcHRpbmcgdG8gaW5qZWN0IGFuIHVua25vd24gaW5qZWN0aW9uOiAnIiArIHNwZWNpZmllciArICInIiwgdGhpcy5oYXMoc3BlY2lmaWVyLCB7CiAgICAgICAgICBzb3VyY2U6IHNvdXJjZSwKICAgICAgICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlCiAgICAgICAgfSkpKTsKICAgICAgfQogICAgfTsKICB9CgogIGZ1bmN0aW9uIF9leHBhbmRMb2NhbExvb2t1cChyZWdpc3RyeSwgbm9ybWFsaXplZE5hbWUsIG5vcm1hbGl6ZWRTb3VyY2UsIG5hbWVzcGFjZSkgewogICAgdmFyIGNhY2hlID0gcmVnaXN0cnkuX2xvY2FsTG9va3VwQ2FjaGU7CiAgICB2YXIgbm9ybWFsaXplZE5hbWVDYWNoZSA9IGNhY2hlW25vcm1hbGl6ZWROYW1lXTsKCiAgICBpZiAoIW5vcm1hbGl6ZWROYW1lQ2FjaGUpIHsKICAgICAgbm9ybWFsaXplZE5hbWVDYWNoZSA9IGNhY2hlW25vcm1hbGl6ZWROYW1lXSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB9CgogICAgdmFyIGNhY2hlS2V5ID0gbmFtZXNwYWNlIHx8IG5vcm1hbGl6ZWRTb3VyY2U7CiAgICB2YXIgY2FjaGVkID0gbm9ybWFsaXplZE5hbWVDYWNoZVtjYWNoZUtleV07CgogICAgaWYgKGNhY2hlZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiBjYWNoZWQ7CiAgICB9CgogICAgdmFyIGV4cGFuZGVkID0gcmVnaXN0cnkucmVzb2x2ZXIuZXhwYW5kTG9jYWxMb29rdXAobm9ybWFsaXplZE5hbWUsIG5vcm1hbGl6ZWRTb3VyY2UsIG5hbWVzcGFjZSk7CiAgICByZXR1cm4gbm9ybWFsaXplZE5hbWVDYWNoZVtjYWNoZUtleV0gPSBleHBhbmRlZDsKICB9CgogIGZ1bmN0aW9uIF9yZXNvbHZlKHJlZ2lzdHJ5LCBfbm9ybWFsaXplZE5hbWUsIG9wdGlvbnMpIHsKICAgIHZhciBub3JtYWxpemVkTmFtZSA9IF9ub3JtYWxpemVkTmFtZTsgLy8gd2hlbiBgc291cmNlYCBpcyBwcm92aWRlZCBleHBhbmQgbm9ybWFsaXplZE5hbWUKICAgIC8vIGFuZCBzb3VyY2UgaW50byB0aGUgZnVsbCBub3JtYWxpemVkTmFtZQoKICAgIGlmIChvcHRpb25zICE9PSB1bmRlZmluZWQgJiYgKG9wdGlvbnMuc291cmNlIHx8IG9wdGlvbnMubmFtZXNwYWNlKSkgewogICAgICBub3JtYWxpemVkTmFtZSA9IHJlZ2lzdHJ5LmV4cGFuZExvY2FsTG9va3VwKF9ub3JtYWxpemVkTmFtZSwgb3B0aW9ucyk7CgogICAgICBpZiAoIW5vcm1hbGl6ZWROYW1lKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CgogICAgdmFyIGNhY2hlZCA9IHJlZ2lzdHJ5Ll9yZXNvbHZlQ2FjaGVbbm9ybWFsaXplZE5hbWVdOwoKICAgIGlmIChjYWNoZWQgIT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gY2FjaGVkOwogICAgfQoKICAgIGlmIChyZWdpc3RyeS5fZmFpbFNldC5oYXMobm9ybWFsaXplZE5hbWUpKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgcmVzb2x2ZWQ7CgogICAgaWYgKHJlZ2lzdHJ5LnJlc29sdmVyKSB7CiAgICAgIHJlc29sdmVkID0gcmVnaXN0cnkucmVzb2x2ZXIucmVzb2x2ZShub3JtYWxpemVkTmFtZSk7CiAgICB9CgogICAgaWYgKHJlc29sdmVkID09PSB1bmRlZmluZWQpIHsKICAgICAgcmVzb2x2ZWQgPSByZWdpc3RyeS5yZWdpc3RyYXRpb25zW25vcm1hbGl6ZWROYW1lXTsKICAgIH0KCiAgICBpZiAocmVzb2x2ZWQgPT09IHVuZGVmaW5lZCkgewogICAgICByZWdpc3RyeS5fZmFpbFNldC5hZGQobm9ybWFsaXplZE5hbWUpOwogICAgfSBlbHNlIHsKICAgICAgcmVnaXN0cnkuX3Jlc29sdmVDYWNoZVtub3JtYWxpemVkTmFtZV0gPSByZXNvbHZlZDsKICAgIH0KCiAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgfQoKICBmdW5jdGlvbiBfaGFzKHJlZ2lzdHJ5LCBmdWxsTmFtZSwgc291cmNlLCBuYW1lc3BhY2UpIHsKICAgIHJldHVybiByZWdpc3RyeS5yZXNvbHZlKGZ1bGxOYW1lLCB7CiAgICAgIHNvdXJjZTogc291cmNlLAogICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZQogICAgfSkgIT09IHVuZGVmaW5lZDsKICB9CgogIHZhciBwcml2YXRlTmFtZXMgPSAoMCwgX3V0aWxzLmRpY3Rpb25hcnkpKG51bGwpOwogIHZhciBwcml2YXRlU3VmZml4ID0gKCIiICsgTWF0aC5yYW5kb20oKSArIERhdGUubm93KCkpLnJlcGxhY2UoJy4nLCAnJyk7CgogIGZ1bmN0aW9uIHByaXZhdGl6ZShfcmVmNikgewogICAgdmFyIGZ1bGxOYW1lID0gX3JlZjZbMF07CiAgICB2YXIgbmFtZSA9IHByaXZhdGVOYW1lc1tmdWxsTmFtZV07CgogICAgaWYgKG5hbWUpIHsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CgogICAgdmFyIF9mdWxsTmFtZSRzcGxpdDIgPSBmdWxsTmFtZS5zcGxpdCgnOicpLAogICAgICAgIHR5cGUgPSBfZnVsbE5hbWUkc3BsaXQyWzBdLAogICAgICAgIHJhd05hbWUgPSBfZnVsbE5hbWUkc3BsaXQyWzFdOwoKICAgIHJldHVybiBwcml2YXRlTmFtZXNbZnVsbE5hbWVdID0gKDAsIF91dGlscy5pbnRlcm4pKHR5cGUgKyAiOiIgKyByYXdOYW1lICsgIi0iICsgcHJpdmF0ZVN1ZmZpeCk7CiAgfQogIC8qCiAgUHVibGljIEFQSSBmb3IgdGhlIGNvbnRhaW5lciBpcyBzdGlsbCBpbiBmbHV4LgogIFRoZSBwdWJsaWMgQVBJLCBzcGVjaWZpZWQgb24gdGhlIGFwcGxpY2F0aW9uIG5hbWVzcGFjZSBzaG91bGQgYmUgY29uc2lkZXJlZCB0aGUgc3RhYmxlIEFQSS4KICAvLyBAbW9kdWxlIGNvbnRhaW5lcgogICAgQHByaXZhdGUKICAqLwoKfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvZW52aXJvbm1lbnQvaW5kZXgiLCBbImV4cG9ydHMiLCAiQGVtYmVyL2RlcHJlY2F0ZWQtZmVhdHVyZXMiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZGVwcmVjYXRlZEZlYXR1cmVzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5nZXRMb29rdXAgPSBnZXRMb29rdXA7CiAgX2V4cG9ydHMuc2V0TG9va3VwID0gc2V0TG9va3VwOwogIF9leHBvcnRzLmdldEVOViA9IGdldEVOVjsKICBfZXhwb3J0cy5FTlYgPSBfZXhwb3J0cy5jb250ZXh0ID0gX2V4cG9ydHMuZ2xvYmFsID0gdm9pZCAwOwoKICAvLyBmcm9tIGxvZGFzaCB0byBjYXRjaCBmYWtlIGdsb2JhbHMKICBmdW5jdGlvbiBjaGVja0dsb2JhbCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlICYmIHZhbHVlLk9iamVjdCA9PT0gT2JqZWN0ID8gdmFsdWUgOiB1bmRlZmluZWQ7CiAgfSAvLyBlbGVtZW50IGlkcyBjYW4gcnVpbiBnbG9iYWwgbWlzcyBjaGVja3MKCgogIGZ1bmN0aW9uIGNoZWNrRWxlbWVudElkU2hhZG93aW5nKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgJiYgdmFsdWUubm9kZVR5cGUgPT09IHVuZGVmaW5lZCA/IHZhbHVlIDogdW5kZWZpbmVkOwogIH0gLy8gZXhwb3J0IHJlYWwgZ2xvYmFsCgoKICB2YXIgZ2xvYmFsJDEgPSBjaGVja0dsb2JhbChjaGVja0VsZW1lbnRJZFNoYWRvd2luZyh0eXBlb2YgZ2xvYmFsID09PSAnb2JqZWN0JyAmJiBnbG9iYWwpKSB8fCBjaGVja0dsb2JhbCh0eXBlb2Ygc2VsZiA9PT0gJ29iamVjdCcgJiYgc2VsZikgfHwgY2hlY2tHbG9iYWwodHlwZW9mIHdpbmRvdyA9PT0gJ29iamVjdCcgJiYgd2luZG93KSB8fCB0eXBlb2YgbWFpbkNvbnRleHQgIT09ICd1bmRlZmluZWQnICYmIG1haW5Db250ZXh0IHx8IC8vIHNldCBiZWZvcmUgc3RyaWN0IG1vZGUgaW4gRW1iZXIgbG9hZGVyL3dyYXBwZXIKICBuZXcgRnVuY3Rpb24oJ3JldHVybiB0aGlzJykoKTsgLy8gZXZhbCBvdXRzaWRlIG9mIHN0cmljdCBtb2RlCgogIF9leHBvcnRzLmdsb2JhbCA9IGdsb2JhbCQxOwoKICB2YXIgY29udGV4dCA9IGZ1bmN0aW9uIChnbG9iYWwsIEVtYmVyKSB7CiAgICByZXR1cm4gRW1iZXIgPT09IHVuZGVmaW5lZCA/IHsKICAgICAgaW1wb3J0czogZ2xvYmFsLAogICAgICBleHBvcnRzOiBnbG9iYWwsCiAgICAgIGxvb2t1cDogZ2xvYmFsCiAgICB9IDogewogICAgICAvLyBpbXBvcnQgalF1ZXJ5CiAgICAgIGltcG9ydHM6IEVtYmVyLmltcG9ydHMgfHwgZ2xvYmFsLAogICAgICAvLyBleHBvcnQgRW1iZXIKICAgICAgZXhwb3J0czogRW1iZXIuZXhwb3J0cyB8fCBnbG9iYWwsCiAgICAgIC8vIHNlYXJjaCBmb3IgTmFtZXNwYWNlcwogICAgICBsb29rdXA6IEVtYmVyLmxvb2t1cCB8fCBnbG9iYWwKICAgIH07CiAgfShnbG9iYWwkMSwgZ2xvYmFsJDEuRW1iZXIpOwoKICBfZXhwb3J0cy5jb250ZXh0ID0gY29udGV4dDsKCiAgZnVuY3Rpb24gZ2V0TG9va3VwKCkgewogICAgcmV0dXJuIGNvbnRleHQubG9va3VwOwogIH0KCiAgZnVuY3Rpb24gc2V0TG9va3VwKHZhbHVlKSB7CiAgICBjb250ZXh0Lmxvb2t1cCA9IHZhbHVlOwogIH0KICAvKioKICAgIFRoZSBoYXNoIG9mIGVudmlyb25tZW50IHZhcmlhYmxlcyB1c2VkIHRvIGNvbnRyb2wgdmFyaW91cyBjb25maWd1cmF0aW9uCiAgICBzZXR0aW5ncy4gVG8gc3BlY2lmeSB5b3VyIG93biBvciBvdmVycmlkZSBkZWZhdWx0IHNldHRpbmdzLCBhZGQgdGhlCiAgICBkZXNpcmVkIHByb3BlcnRpZXMgdG8gYSBnbG9iYWwgaGFzaCBuYW1lZCBgRW1iZXJFTlZgIChvciBgRU5WYCBmb3IKICAgIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IHdpdGggZWFybGllciB2ZXJzaW9ucyBvZiBFbWJlcikuIFRoZSBgRW1iZXJFTlZgCiAgICBoYXNoIG11c3QgYmUgY3JlYXRlZCBiZWZvcmUgbG9hZGluZyBFbWJlci4KICAKICAgIEBjbGFzcyBFbWJlckVOVgogICAgQHR5cGUgT2JqZWN0CiAgICBAcHVibGljCiAgKi8KCgogIHZhciBFTlYgPSB7CiAgICBFTkFCTEVfT1BUSU9OQUxfRkVBVFVSRVM6IGZhbHNlLAoKICAgIC8qKgogICAgICBEZXRlcm1pbmVzIHdoZXRoZXIgRW1iZXIgc2hvdWxkIGFkZCB0byBgQXJyYXlgLCBgRnVuY3Rpb25gLCBhbmQgYFN0cmluZ2AKICAgICAgbmF0aXZlIG9iamVjdCBwcm90b3R5cGVzLCBhIGZldyBleHRyYSBtZXRob2RzIGluIG9yZGVyIHRvIHByb3ZpZGUgYSBtb3JlCiAgICAgIGZyaWVuZGx5IEFQSS4KICAgICAgICAgV2UgZ2VuZXJhbGx5IHJlY29tbWVuZCBsZWF2aW5nIHRoaXMgb3B0aW9uIHNldCB0byB0cnVlIGhvd2V2ZXIsIGlmIHlvdSBuZWVkCiAgICAgIHRvIHR1cm4gaXQgb2ZmLCB5b3UgY2FuIGFkZCB0aGUgY29uZmlndXJhdGlvbiBwcm9wZXJ0eQogICAgICBgRVhURU5EX1BST1RPVFlQRVNgIHRvIGBFbWJlckVOVmAgYW5kIHNldCBpdCB0byBgZmFsc2VgLgogICAgICAgICBOb3RlLCB3aGVuIGRpc2FibGVkICh0aGUgZGVmYXVsdCBjb25maWd1cmF0aW9uIGZvciBFbWJlciBBZGRvbnMpLCB5b3Ugd2lsbAogICAgICBpbnN0ZWFkIGhhdmUgdG8gYWNjZXNzIGFsbCBtZXRob2RzIGFuZCBmdW5jdGlvbnMgZnJvbSB0aGUgRW1iZXIKICAgICAgbmFtZXNwYWNlLgogICAgICAgICBAcHJvcGVydHkgRVhURU5EX1BST1RPVFlQRVMKICAgICAgQHR5cGUgQm9vbGVhbgogICAgICBAZGVmYXVsdCB0cnVlCiAgICAgIEBmb3IgRW1iZXJFTlYKICAgICAgQHB1YmxpYwogICAgKi8KICAgIEVYVEVORF9QUk9UT1RZUEVTOiB7CiAgICAgIEFycmF5OiB0cnVlLAogICAgICBGdW5jdGlvbjogdHJ1ZSwKICAgICAgU3RyaW5nOiB0cnVlCiAgICB9LAoKICAgIC8qKgogICAgICBUaGUgYExPR19TVEFDS1RSQUNFX09OX0RFUFJFQ0FUSU9OYCBwcm9wZXJ0eSwgd2hlbiB0cnVlLCB0ZWxscyBFbWJlciB0byBsb2cKICAgICAgYSBmdWxsIHN0YWNrIHRyYWNlIGR1cmluZyBkZXByZWNhdGlvbiB3YXJuaW5ncy4KICAgICAgICAgQHByb3BlcnR5IExPR19TVEFDS1RSQUNFX09OX0RFUFJFQ0FUSU9OCiAgICAgIEB0eXBlIEJvb2xlYW4KICAgICAgQGRlZmF1bHQgdHJ1ZQogICAgICBAZm9yIEVtYmVyRU5WCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBMT0dfU1RBQ0tUUkFDRV9PTl9ERVBSRUNBVElPTjogdHJ1ZSwKCiAgICAvKioKICAgICAgVGhlIGBMT0dfVkVSU0lPTmAgcHJvcGVydHksIHdoZW4gdHJ1ZSwgdGVsbHMgRW1iZXIgdG8gbG9nIHZlcnNpb25zIG9mIGFsbAogICAgICBkZXBlbmRlbnQgbGlicmFyaWVzIGluIHVzZS4KICAgICAgICAgQHByb3BlcnR5IExPR19WRVJTSU9OCiAgICAgIEB0eXBlIEJvb2xlYW4KICAgICAgQGRlZmF1bHQgdHJ1ZQogICAgICBAZm9yIEVtYmVyRU5WCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBMT0dfVkVSU0lPTjogdHJ1ZSwKICAgIFJBSVNFX09OX0RFUFJFQ0FUSU9OOiBmYWxzZSwKICAgIFNUUlVDVFVSRURfUFJPRklMRTogZmFsc2UsCgogICAgLyoqCiAgICAgIFdoZXRoZXIgdG8gaW5zZXJ0IGEgYDxkaXYgY2xhc3M9ImVtYmVyLXZpZXciIC8+YCB3cmFwcGVyIGFyb3VuZCB0aGUKICAgICAgYXBwbGljYXRpb24gdGVtcGxhdGUuIFNlZSBSRkMgIzI4MC4KICAgICAgICAgVGhpcyBpcyBub3QgaW50ZW5kZWQgdG8gYmUgc2V0IGRpcmVjdGx5LCBhcyB0aGUgaW1wbGVtZW50YXRpb24gbWF5IGNoYW5nZSBpbgogICAgICB0aGUgZnV0dXJlLiBVc2UgYEBlbWJlci9vcHRpb25hbC1mZWF0dXJlc2AgaW5zdGVhZC4KICAgICAgICAgQHByb3BlcnR5IF9BUFBMSUNBVElPTl9URU1QTEFURV9XUkFQUEVSCiAgICAgIEBmb3IgRW1iZXJFTlYKICAgICAgQHR5cGUgQm9vbGVhbgogICAgICBAZGVmYXVsdCB0cnVlCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgX0FQUExJQ0FUSU9OX1RFTVBMQVRFX1dSQVBQRVI6IHRydWUsCgogICAgLyoqCiAgICAgIFdoZXRoZXIgdG8gdXNlIEdsaW1tZXIgQ29tcG9uZW50IHNlbWFudGljcyAoYXMgb3Bwb3NlZCB0byB0aGUgY2xhc3NpYyAiQ3VybHkiCiAgICAgIGNvbXBvbmVudHMgc2VtYW50aWNzKSBmb3IgdGVtcGxhdGUtb25seSBjb21wb25lbnRzLiBTZWUgUkZDICMyNzguCiAgICAgICAgIFRoaXMgaXMgbm90IGludGVuZGVkIHRvIGJlIHNldCBkaXJlY3RseSwgYXMgdGhlIGltcGxlbWVudGF0aW9uIG1heSBjaGFuZ2UgaW4KICAgICAgdGhlIGZ1dHVyZS4gVXNlIGBAZW1iZXIvb3B0aW9uYWwtZmVhdHVyZXNgIGluc3RlYWQuCiAgICAgICAgIEBwcm9wZXJ0eSBfVEVNUExBVEVfT05MWV9HTElNTUVSX0NPTVBPTkVOVFMKICAgICAgQGZvciBFbWJlckVOVgogICAgICBAdHlwZSBCb29sZWFuCiAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgX1RFTVBMQVRFX09OTFlfR0xJTU1FUl9DT01QT05FTlRTOiBmYWxzZSwKCiAgICAvKioKICAgICAgV2hldGhlciB0byBwZXJmb3JtIGV4dHJhIGJvb2trZWVwaW5nIG5lZWRlZCB0byBtYWtlIHRoZSBgY2FwdHVyZVJlbmRlclRyZWVgCiAgICAgIEFQSSB3b3JrLgogICAgICAgICBUaGlzIGhhcyB0byBiZSBzZXQgYmVmb3JlIHRoZSBlbWJlciBKYXZhU2NyaXB0IGNvZGUgaXMgZXZhbHVhdGVkLiBUaGlzIGlzCiAgICAgIHVzdWFsbHkgZG9uZSBieSBzZXR0aW5nIGB3aW5kb3cuRW1iZXJFTlYgPSB7IF9ERUJVR19SRU5ERVJfVFJFRTogdHJ1ZSB9O2AKICAgICAgb3IgYHdpbmRvdy5FTlYgPSB7IF9ERUJVR19SRU5ERVJfVFJFRTogdHJ1ZSB9O2AgYmVmb3JlIHRoZSAidmVuZG9yIgogICAgICBgPHNjcmlwdD5gIHRhZyBpbiBgaW5kZXguaHRtbGAuCiAgICAgICAgIFNldHRpbmcgdGhlIGZsYWcgYWZ0ZXIgRW1iZXIgaXMgYWxyZWFkeSBsb2FkZWQgd2lsbCBub3Qgd29yayBjb3JyZWN0bHkuIEl0CiAgICAgIG1heSBhcHBlYXIgdG8gd29yayBzb21ld2hhdCwgYnV0IGZ1bmRhbWVudGFsbHkgYnJva2VuLgogICAgICAgICBUaGlzIGlzIG5vdCBpbnRlbmRlZCB0byBiZSBzZXQgZGlyZWN0bHkuIEVtYmVyIEluc3BlY3RvciB3aWxsIGVuYWJsZSB0aGUKICAgICAgZmxhZyBvbiBiZWhhbGYgb2YgdGhlIHVzZXIgYXMgbmVlZGVkLgogICAgICAgICBUaGlzIGZsYWcgaXMgYWx3YXlzIG9uIGluIGRldmVsb3BtZW50IG1vZGUuCiAgICAgICAgIFRoZSBmbGFnIGlzIG9mZiBieSBkZWZhdWx0IGluIHByb2R1Y3Rpb24gbW9kZSwgZHVlIHRvIHRoZSBjb3N0IGFzc29jaWF0ZWQKICAgICAgd2l0aCB0aGUgdGhlIGJvb2trZWVwaW5nIHdvcmsuCiAgICAgICAgIFRoZSBleHBlY3RlZCBmbG93IGlzIHRoYXQgRW1iZXIgSW5zcGVjdG9yIHdpbGwgYXNrIHRoZSB1c2VyIHRvIHJlZnJlc2ggdGhlCiAgICAgIHBhZ2UgYWZ0ZXIgZW5hYmxpbmcgdGhlIGZlYXR1cmUuIEl0IGNvdWxkIGFsc28gb2ZmZXIgYSBmZWF0dXJlIHdoZXJlIHRoZQogICAgICB1c2VyIGFkZCBzb21lIGRvbWFpbnMgdG8gdGhlICJhbHdheXMgb24iIGxpc3QuIEluIGVpdGhlciBjYXNlLCBFbWJlcgogICAgICBJbnNwZWN0b3Igd2lsbCBpbmplY3QgdGhlIGNvZGUgb24gdGhlIHBhZ2UgdG8gc2V0IHRoZSBmbGFnIGlmIG5lZWRlZC4KICAgICAgICAgQHByb3BlcnR5IF9ERUJVR19SRU5ERVJfVFJFRQogICAgICBAZm9yIEVtYmVyRU5WCiAgICAgIEB0eXBlIEJvb2xlYW4KICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgQHByaXZhdGUKICAgICovCiAgICBfREVCVUdfUkVOREVSX1RSRUU6IGZhbHNlCiAgICAvKiBERUJVRyAqLwogICAgLAoKICAgIC8qKgogICAgICBXaGV0aGVyIHRoZSBhcHAgaXMgdXNpbmcgalF1ZXJ5LiBTZWUgUkZDICMyOTQuCiAgICAgICAgIFRoaXMgaXMgbm90IGludGVuZGVkIHRvIGJlIHNldCBkaXJlY3RseSwgYXMgdGhlIGltcGxlbWVudGF0aW9uIG1heSBjaGFuZ2UgaW4KICAgICAgdGhlIGZ1dHVyZS4gVXNlIGBAZW1iZXIvb3B0aW9uYWwtZmVhdHVyZXNgIGluc3RlYWQuCiAgICAgICAgIEBwcm9wZXJ0eSBfSlFVRVJZX0lOVEVHUkFUSU9OCiAgICAgIEBmb3IgRW1iZXJFTlYKICAgICAgQHR5cGUgQm9vbGVhbgogICAgICBAZGVmYXVsdCB0cnVlCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgX0pRVUVSWV9JTlRFR1JBVElPTjogdHJ1ZSwKCiAgICAvKioKICAgICAgV2hldGhlciB0aGUgYXBwIGRlZmF1bHRzIHRvIHVzaW5nIGFzeW5jIG9ic2VydmVycy4KICAgICAgICAgVGhpcyBpcyBub3QgaW50ZW5kZWQgdG8gYmUgc2V0IGRpcmVjdGx5LCBhcyB0aGUgaW1wbGVtZW50YXRpb24gbWF5IGNoYW5nZSBpbgogICAgICB0aGUgZnV0dXJlLiBVc2UgYEBlbWJlci9vcHRpb25hbC1mZWF0dXJlc2AgaW5zdGVhZC4KICAgICAgICAgQHByb3BlcnR5IF9ERUZBVUxUX0FTWU5DX09CU0VSVkVSUwogICAgICBAZm9yIEVtYmVyRU5WCiAgICAgIEB0eXBlIEJvb2xlYW4KICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgQHByaXZhdGUKICAgICovCiAgICBfREVGQVVMVF9BU1lOQ19PQlNFUlZFUlM6IGZhbHNlLAoKICAgIC8qKgogICAgICBDb250cm9scyB0aGUgbWF4aW11bSBudW1iZXIgb2Ygc2NoZWR1bGVkIHJlcmVuZGVycyB3aXRob3V0ICJzZXR0bGluZyIuIEluIGdlbmVyYWwsCiAgICAgIGFwcGxpY2F0aW9ucyBzaG91bGQgbm90IG5lZWQgdG8gbW9kaWZ5IHRoaXMgZW52aXJvbm1lbnQgdmFyaWFibGUsIGJ1dCBwbGVhc2UKICAgICAgb3BlbiBhbiBpc3N1ZSBzbyB0aGF0IHdlIGNhbiBkZXRlcm1pbmUgaWYgYSBiZXR0ZXIgZGVmYXVsdCB2YWx1ZSBpcyBuZWVkZWQuCiAgICAgICAgIEBwcm9wZXJ0eSBfUkVSRU5ERVJfTE9PUF9MSU1JVAogICAgICBAZm9yIEVtYmVyRU5WCiAgICAgIEB0eXBlIG51bWJlcgogICAgICBAZGVmYXVsdCAxMDAwCiAgICAgIEBwcml2YXRlCiAgICAgKi8KICAgIF9SRVJFTkRFUl9MT09QX0xJTUlUOiAxMDAwLAogICAgRU1CRVJfTE9BRF9IT09LUzoge30sCiAgICBGRUFUVVJFUzoge30KICB9OwogIF9leHBvcnRzLkVOViA9IEVOVjsKCiAgKGZ1bmN0aW9uIChFbWJlckVOVikgewogICAgaWYgKHR5cGVvZiBFbWJlckVOViAhPT0gJ29iamVjdCcgfHwgRW1iZXJFTlYgPT09IG51bGwpIHJldHVybjsKCiAgICBmb3IgKHZhciBmbGFnIGluIEVtYmVyRU5WKSB7CiAgICAgIGlmICghRW1iZXJFTlYuaGFzT3duUHJvcGVydHkoZmxhZykgfHwgZmxhZyA9PT0gJ0VYVEVORF9QUk9UT1RZUEVTJyB8fCBmbGFnID09PSAnRU1CRVJfTE9BRF9IT09LUycpIGNvbnRpbnVlOwogICAgICB2YXIgZGVmYXVsdFZhbHVlID0gRU5WW2ZsYWddOwoKICAgICAgaWYgKGRlZmF1bHRWYWx1ZSA9PT0gdHJ1ZSkgewogICAgICAgIEVOVltmbGFnXSA9IEVtYmVyRU5WW2ZsYWddICE9PSBmYWxzZTsKICAgICAgfSBlbHNlIGlmIChkZWZhdWx0VmFsdWUgPT09IGZhbHNlKSB7CiAgICAgICAgRU5WW2ZsYWddID0gRW1iZXJFTlZbZmxhZ10gPT09IHRydWU7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgRVhURU5EX1BST1RPVFlQRVMgPSBFbWJlckVOVi5FWFRFTkRfUFJPVE9UWVBFUzsKCiAgICBpZiAoRVhURU5EX1BST1RPVFlQRVMgIT09IHVuZGVmaW5lZCkgewogICAgICBpZiAodHlwZW9mIEVYVEVORF9QUk9UT1RZUEVTID09PSAnb2JqZWN0JyAmJiBFWFRFTkRfUFJPVE9UWVBFUyAhPT0gbnVsbCkgewogICAgICAgIEVOVi5FWFRFTkRfUFJPVE9UWVBFUy5TdHJpbmcgPSBFWFRFTkRfUFJPVE9UWVBFUy5TdHJpbmcgIT09IGZhbHNlOwoKICAgICAgICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5GVU5DVElPTl9QUk9UT1RZUEVfRVhURU5TSU9OUykgewogICAgICAgICAgRU5WLkVYVEVORF9QUk9UT1RZUEVTLkZ1bmN0aW9uID0gRVhURU5EX1BST1RPVFlQRVMuRnVuY3Rpb24gIT09IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgRU5WLkVYVEVORF9QUk9UT1RZUEVTLkFycmF5ID0gRVhURU5EX1BST1RPVFlQRVMuQXJyYXkgIT09IGZhbHNlOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBpc0VuYWJsZWQgPSBFWFRFTkRfUFJPVE9UWVBFUyAhPT0gZmFsc2U7CiAgICAgICAgRU5WLkVYVEVORF9QUk9UT1RZUEVTLlN0cmluZyA9IGlzRW5hYmxlZDsKCiAgICAgICAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuRlVOQ1RJT05fUFJPVE9UWVBFX0VYVEVOU0lPTlMpIHsKICAgICAgICAgIEVOVi5FWFRFTkRfUFJPVE9UWVBFUy5GdW5jdGlvbiA9IGlzRW5hYmxlZDsKICAgICAgICB9CgogICAgICAgIEVOVi5FWFRFTkRfUFJPVE9UWVBFUy5BcnJheSA9IGlzRW5hYmxlZDsKICAgICAgfQogICAgfSAvLyBUT0RPIHRoaXMgZG9lcyBub3Qgc2VlbSB0byBiZSB1c2VkIGJ5IGFueXRoaW5nLAogICAgLy8gICAgICBjYW4gd2UgcmVtb3ZlIGl0PyBkbyB3ZSBuZWVkIHRvIGRlcHJlY2F0ZSBpdD8KCgogICAgdmFyIEVNQkVSX0xPQURfSE9PS1MgPSBFbWJlckVOVi5FTUJFUl9MT0FEX0hPT0tTOwoKICAgIGlmICh0eXBlb2YgRU1CRVJfTE9BRF9IT09LUyA9PT0gJ29iamVjdCcgJiYgRU1CRVJfTE9BRF9IT09LUyAhPT0gbnVsbCkgewogICAgICBmb3IgKHZhciBob29rTmFtZSBpbiBFTUJFUl9MT0FEX0hPT0tTKSB7CiAgICAgICAgaWYgKCFFTUJFUl9MT0FEX0hPT0tTLmhhc093blByb3BlcnR5KGhvb2tOYW1lKSkgY29udGludWU7CiAgICAgICAgdmFyIGhvb2tzID0gRU1CRVJfTE9BRF9IT09LU1tob29rTmFtZV07CgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGhvb2tzKSkgewogICAgICAgICAgRU5WLkVNQkVSX0xPQURfSE9PS1NbaG9va05hbWVdID0gaG9va3MuZmlsdGVyKGZ1bmN0aW9uIChob29rKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgaG9vayA9PT0gJ2Z1bmN0aW9uJzsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHZhciBGRUFUVVJFUyA9IEVtYmVyRU5WLkZFQVRVUkVTOwoKICAgIGlmICh0eXBlb2YgRkVBVFVSRVMgPT09ICdvYmplY3QnICYmIEZFQVRVUkVTICE9PSBudWxsKSB7CiAgICAgIGZvciAodmFyIGZlYXR1cmUgaW4gRkVBVFVSRVMpIHsKICAgICAgICBpZiAoIUZFQVRVUkVTLmhhc093blByb3BlcnR5KGZlYXR1cmUpKSBjb250aW51ZTsKICAgICAgICBFTlYuRkVBVFVSRVNbZmVhdHVyZV0gPSBGRUFUVVJFU1tmZWF0dXJlXSA9PT0gdHJ1ZTsKICAgICAgfQogICAgfQoKICAgIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICkgewogICAgICBFTlYuX0RFQlVHX1JFTkRFUl9UUkVFID0gdHJ1ZTsKICAgIH0KICB9KShnbG9iYWwkMS5FbWJlckVOViB8fCBnbG9iYWwkMS5FTlYpOwoKICBmdW5jdGlvbiBnZXRFTlYoKSB7CiAgICByZXR1cm4gRU5WOwogIH0KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvZXJyb3ItaGFuZGxpbmcvaW5kZXgiLCBbImV4cG9ydHMiXSwgZnVuY3Rpb24gKF9leHBvcnRzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5nZXRPbmVycm9yID0gZ2V0T25lcnJvcjsKICBfZXhwb3J0cy5zZXRPbmVycm9yID0gc2V0T25lcnJvcjsKICBfZXhwb3J0cy5nZXREaXNwYXRjaE92ZXJyaWRlID0gZ2V0RGlzcGF0Y2hPdmVycmlkZTsKICBfZXhwb3J0cy5zZXREaXNwYXRjaE92ZXJyaWRlID0gc2V0RGlzcGF0Y2hPdmVycmlkZTsKICBfZXhwb3J0cy5vbkVycm9yVGFyZ2V0ID0gdm9pZCAwOwogIHZhciBvbmVycm9yOwogIHZhciBvbkVycm9yVGFyZ2V0ID0gewogICAgZ2V0IG9uZXJyb3IoKSB7CiAgICAgIHJldHVybiBvbmVycm9yOwogICAgfQoKICB9OyAvLyBFbWJlci5vbmVycm9yIGdldHRlcgoKICBfZXhwb3J0cy5vbkVycm9yVGFyZ2V0ID0gb25FcnJvclRhcmdldDsKCiAgZnVuY3Rpb24gZ2V0T25lcnJvcigpIHsKICAgIHJldHVybiBvbmVycm9yOwogIH0gLy8gRW1iZXIub25lcnJvciBzZXR0ZXIKCgogIGZ1bmN0aW9uIHNldE9uZXJyb3IoaGFuZGxlcikgewogICAgb25lcnJvciA9IGhhbmRsZXI7CiAgfQoKICB2YXIgZGlzcGF0Y2hPdmVycmlkZTsgLy8gYWxsb3dzIHRlc3RpbmcgYWRhcHRlciB0byBvdmVycmlkZSBkaXNwYXRjaAoKICBmdW5jdGlvbiBnZXREaXNwYXRjaE92ZXJyaWRlKCkgewogICAgcmV0dXJuIGRpc3BhdGNoT3ZlcnJpZGU7CiAgfQoKICBmdW5jdGlvbiBzZXREaXNwYXRjaE92ZXJyaWRlKGhhbmRsZXIpIHsKICAgIGRpc3BhdGNoT3ZlcnJpZGUgPSBoYW5kbGVyOwogIH0KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvZXh0ZW5zaW9uLXN1cHBvcnQvaW5kZXgiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvZXh0ZW5zaW9uLXN1cHBvcnQvbGliL2RhdGFfYWRhcHRlciIsICJAZW1iZXIvLWludGVybmFscy9leHRlbnNpb24tc3VwcG9ydC9saWIvY29udGFpbmVyX2RlYnVnX2FkYXB0ZXIiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZGF0YV9hZGFwdGVyLCBfY29udGFpbmVyX2RlYnVnX2FkYXB0ZXIpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIkRhdGFBZGFwdGVyIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2RhdGFfYWRhcHRlci5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIkNvbnRhaW5lckRlYnVnQWRhcHRlciIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9jb250YWluZXJfZGVidWdfYWRhcHRlci5kZWZhdWx0OwogICAgfQogIH0pOwp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9leHRlbnNpb24tc3VwcG9ydC9saWIvY29udGFpbmVyX2RlYnVnX2FkYXB0ZXIiLCBbImV4cG9ydHMiLCAiQGVtYmVyL3N0cmluZyIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX3N0cmluZywgX3J1bnRpbWUpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIC8qKgogIEBtb2R1bGUgQGVtYmVyL2RlYnVnCiAgKi8KCiAgLyoqCiAgICBUaGUgYENvbnRhaW5lckRlYnVnQWRhcHRlcmAgaGVscHMgdGhlIGNvbnRhaW5lciBhbmQgcmVzb2x2ZXIgaW50ZXJmYWNlCiAgICB3aXRoIHRvb2xzIHRoYXQgZGVidWcgRW1iZXIgc3VjaCBhcyB0aGUKICAgIFtFbWJlciBJbnNwZWN0b3JdKGh0dHBzOi8vZ2l0aHViLmNvbS9lbWJlcmpzL2VtYmVyLWluc3BlY3RvcikKICAgIGZvciBDaHJvbWUgYW5kIEZpcmVmb3guCiAgCiAgICBUaGlzIGNsYXNzIGNhbiBiZSBleHRlbmRlZCBieSBhIGN1c3RvbSByZXNvbHZlciBpbXBsZW1lbnRlcgogICAgdG8gb3ZlcnJpZGUgc29tZSBvZiB0aGUgbWV0aG9kcyB3aXRoIGxpYnJhcnktc3BlY2lmaWMgY29kZS4KICAKICAgIFRoZSBtZXRob2RzIGxpa2VseSB0byBiZSBvdmVycmlkZGVuIGFyZToKICAKICAgICogYGNhbkNhdGFsb2dFbnRyaWVzQnlUeXBlYAogICAgKiBgY2F0YWxvZ0VudHJpZXNCeVR5cGVgCiAgCiAgICBUaGUgYWRhcHRlciB3aWxsIG5lZWQgdG8gYmUgcmVnaXN0ZXJlZAogICAgaW4gdGhlIGFwcGxpY2F0aW9uJ3MgY29udGFpbmVyIGFzIGBjb250YWluZXItZGVidWctYWRhcHRlcjptYWluYC4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHBsaWNhdGlvbi5pbml0aWFsaXplcih7CiAgICAgIG5hbWU6ICJjb250YWluZXJEZWJ1Z0FkYXB0ZXIiLAogIAogICAgICBpbml0aWFsaXplKGFwcGxpY2F0aW9uKSB7CiAgICAgICAgYXBwbGljYXRpb24ucmVnaXN0ZXIoJ2NvbnRhaW5lci1kZWJ1Zy1hZGFwdGVyOm1haW4nLCByZXF1aXJlKCdhcHAvY29udGFpbmVyLWRlYnVnLWFkYXB0ZXInKSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBAY2xhc3MgQ29udGFpbmVyRGVidWdBZGFwdGVyCiAgICBAZXh0ZW5kcyBFbWJlck9iamVjdAogICAgQHNpbmNlIDEuNS4wCiAgICBAcHVibGljCiAgKi8KICB2YXIgX2RlZmF1bHQgPSBfcnVudGltZS5PYmplY3QuZXh0ZW5kKHsKICAgIC8qKgogICAgICBUaGUgcmVzb2x2ZXIgaW5zdGFuY2Ugb2YgdGhlIGFwcGxpY2F0aW9uCiAgICAgIGJlaW5nIGRlYnVnZ2VkLiBUaGlzIHByb3BlcnR5IHdpbGwgYmUgaW5qZWN0ZWQKICAgICAgb24gY3JlYXRpb24uCiAgICAgICBAcHJvcGVydHkgcmVzb2x2ZXIKICAgICAgQGRlZmF1bHQgbnVsbAogICAgICBAcHVibGljCiAgICAqLwogICAgcmVzb2x2ZXI6IG51bGwsCgogICAgLyoqCiAgICAgIFJldHVybnMgdHJ1ZSBpZiBpdCBpcyBwb3NzaWJsZSB0byBjYXRhbG9nIGEgbGlzdCBvZiBhdmFpbGFibGUKICAgICAgY2xhc3NlcyBpbiB0aGUgcmVzb2x2ZXIgZm9yIGEgZ2l2ZW4gdHlwZS4KICAgICAgIEBtZXRob2QgY2FuQ2F0YWxvZ0VudHJpZXNCeVR5cGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUuIGUuZy4gIm1vZGVsIiwgImNvbnRyb2xsZXIiLCAicm91dGUiLgogICAgICBAcmV0dXJuIHtib29sZWFufSB3aGV0aGVyIGEgbGlzdCBpcyBhdmFpbGFibGUgZm9yIHRoaXMgdHlwZS4KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGNhbkNhdGFsb2dFbnRyaWVzQnlUeXBlOiBmdW5jdGlvbiBjYW5DYXRhbG9nRW50cmllc0J5VHlwZSh0eXBlKSB7CiAgICAgIGlmICh0eXBlID09PSAnbW9kZWwnIHx8IHR5cGUgPT09ICd0ZW1wbGF0ZScpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKCiAgICAvKioKICAgICAgUmV0dXJucyB0aGUgYXZhaWxhYmxlIGNsYXNzZXMgYSBnaXZlbiB0eXBlLgogICAgICAgQG1ldGhvZCBjYXRhbG9nRW50cmllc0J5VHlwZQogICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZS4gZS5nLiAibW9kZWwiLCAiY29udHJvbGxlciIsICJyb3V0ZSIuCiAgICAgIEByZXR1cm4ge0FycmF5fSBBbiBhcnJheSBvZiBzdHJpbmdzLgogICAgICBAcHVibGljCiAgICAqLwogICAgY2F0YWxvZ0VudHJpZXNCeVR5cGU6IGZ1bmN0aW9uIGNhdGFsb2dFbnRyaWVzQnlUeXBlKHR5cGUpIHsKICAgICAgdmFyIG5hbWVzcGFjZXMgPSAoMCwgX3J1bnRpbWUuQSkoX3J1bnRpbWUuTmFtZXNwYWNlLk5BTUVTUEFDRVMpOwogICAgICB2YXIgdHlwZXMgPSAoMCwgX3J1bnRpbWUuQSkoKTsKICAgICAgdmFyIHR5cGVTdWZmaXhSZWdleCA9IG5ldyBSZWdFeHAoKDAsIF9zdHJpbmcuY2xhc3NpZnkpKHR5cGUpICsgIiQiKTsKICAgICAgbmFtZXNwYWNlcy5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lc3BhY2UpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZXNwYWNlKSB7CiAgICAgICAgICBpZiAoIW5hbWVzcGFjZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICh0eXBlU3VmZml4UmVnZXgudGVzdChrZXkpKSB7CiAgICAgICAgICAgIHZhciBrbGFzcyA9IG5hbWVzcGFjZVtrZXldOwoKICAgICAgICAgICAgaWYgKCgwLCBfcnVudGltZS50eXBlT2YpKGtsYXNzKSA9PT0gJ2NsYXNzJykgewogICAgICAgICAgICAgIHR5cGVzLnB1c2goKDAsIF9zdHJpbmcuZGFzaGVyaXplKShrZXkucmVwbGFjZSh0eXBlU3VmZml4UmVnZXgsICcnKSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHR5cGVzOwogICAgfQogIH0pOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL2V4dGVuc2lvbi1zdXBwb3J0L2xpYi9kYXRhX2FkYXB0ZXIiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvb3duZXIiLCAiQGVtYmVyL3J1bmxvb3AiLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiLCAiQGVtYmVyL3N0cmluZyIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX293bmVyLCBfcnVubG9vcCwgX21ldGFsLCBfc3RyaW5nLCBfcnVudGltZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvZGVidWcKICAqLwoKICAvKioKICAgIFRoZSBgRGF0YUFkYXB0ZXJgIGhlbHBzIGEgZGF0YSBwZXJzaXN0ZW5jZSBsaWJyYXJ5CiAgICBpbnRlcmZhY2Ugd2l0aCB0b29scyB0aGF0IGRlYnVnIEVtYmVyIHN1Y2gKICAgIGFzIHRoZSBbRW1iZXIgSW5zcGVjdG9yXShodHRwczovL2dpdGh1Yi5jb20vZW1iZXJqcy9lbWJlci1pbnNwZWN0b3IpCiAgICBmb3IgQ2hyb21lIGFuZCBGaXJlZm94LgogIAogICAgVGhpcyBjbGFzcyB3aWxsIGJlIGV4dGVuZGVkIGJ5IGEgcGVyc2lzdGVuY2UgbGlicmFyeQogICAgd2hpY2ggd2lsbCBvdmVycmlkZSBzb21lIG9mIHRoZSBtZXRob2RzIHdpdGgKICAgIGxpYnJhcnktc3BlY2lmaWMgY29kZS4KICAKICAgIFRoZSBtZXRob2RzIGxpa2VseSB0byBiZSBvdmVycmlkZGVuIGFyZToKICAKICAgICogYGdldEZpbHRlcnNgCiAgICAqIGBkZXRlY3RgCiAgICAqIGBjb2x1bW5zRm9yVHlwZWAKICAgICogYGdldFJlY29yZHNgCiAgICAqIGBnZXRSZWNvcmRDb2x1bW5WYWx1ZXNgCiAgICAqIGBnZXRSZWNvcmRLZXl3b3Jkc2AKICAgICogYGdldFJlY29yZEZpbHRlclZhbHVlc2AKICAgICogYGdldFJlY29yZENvbG9yYAogICAgKiBgb2JzZXJ2ZVJlY29yZGAKICAKICAgIFRoZSBhZGFwdGVyIHdpbGwgbmVlZCB0byBiZSByZWdpc3RlcmVkCiAgICBpbiB0aGUgYXBwbGljYXRpb24ncyBjb250YWluZXIgYXMgYGRhdGFBZGFwdGVyOm1haW5gLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcGxpY2F0aW9uLmluaXRpYWxpemVyKHsKICAgICAgbmFtZTogImRhdGEtYWRhcHRlciIsCiAgCiAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGFwcGxpY2F0aW9uKSB7CiAgICAgICAgYXBwbGljYXRpb24ucmVnaXN0ZXIoJ2RhdGEtYWRhcHRlcjptYWluJywgRFMuRGF0YUFkYXB0ZXIpOwogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgQGNsYXNzIERhdGFBZGFwdGVyCiAgICBAZXh0ZW5kcyBFbWJlck9iamVjdAogICAgQHB1YmxpYwogICovCiAgdmFyIF9kZWZhdWx0ID0gX3J1bnRpbWUuT2JqZWN0LmV4dGVuZCh7CiAgICBpbml0OiBmdW5jdGlvbiBpbml0KCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgdGhpcy5yZWxlYXNlTWV0aG9kcyA9ICgwLCBfcnVudGltZS5BKSgpOwogICAgfSwKCiAgICAvKioKICAgICAgVGhlIGNvbnRhaW5lci1kZWJ1Zy1hZGFwdGVyIHdoaWNoIGlzIHVzZWQKICAgICAgdG8gbGlzdCBhbGwgbW9kZWxzLgogICAgICAgQHByb3BlcnR5IGNvbnRhaW5lckRlYnVnQWRhcHRlcgogICAgICBAZGVmYXVsdCB1bmRlZmluZWQKICAgICAgQHNpbmNlIDEuNS4wCiAgICAgIEBwdWJsaWMKICAgICoqLwogICAgY29udGFpbmVyRGVidWdBZGFwdGVyOiB1bmRlZmluZWQsCgogICAgLyoqCiAgICAgIFRoZSBudW1iZXIgb2YgYXR0cmlidXRlcyB0byBzZW5kCiAgICAgIGFzIGNvbHVtbnMuIChFbm91Z2ggdG8gbWFrZSB0aGUgcmVjb3JkCiAgICAgIGlkZW50aWZpYWJsZSkuCiAgICAgICBAcHJpdmF0ZQogICAgICBAcHJvcGVydHkgYXR0cmlidXRlTGltaXQKICAgICAgQGRlZmF1bHQgMwogICAgICBAc2luY2UgMS4zLjAKICAgICovCiAgICBhdHRyaWJ1dGVMaW1pdDogMywKCiAgICAvKioKICAgICAgIEVtYmVyIERhdGEgPiB2MS4wLjAtYmV0YS4xOAogICAgICAgcmVxdWlyZXMgc3RyaW5nIG1vZGVsIG5hbWVzIHRvIGJlIHBhc3NlZAogICAgICAgYXJvdW5kIGluc3RlYWQgb2YgdGhlIGFjdHVhbCBmYWN0b3JpZXMuCiAgICAgICAgVGhpcyBpcyBhIHN0YW1wIGZvciB0aGUgRW1iZXIgSW5zcGVjdG9yCiAgICAgICB0byBkaWZmZXJlbnRpYXRlIGJldHdlZW4gdGhlIHZlcnNpb25zCiAgICAgICB0byBiZSBhYmxlIHRvIHN1cHBvcnQgb2xkZXIgdmVyc2lvbnMgdG9vLgogICAgICAgIEBwdWJsaWMKICAgICAgIEBwcm9wZXJ0eSBhY2NlcHRzTW9kZWxOYW1lCiAgICAgKi8KICAgIGFjY2VwdHNNb2RlbE5hbWU6IHRydWUsCgogICAgLyoqCiAgICAgIFN0b3JlcyBhbGwgbWV0aG9kcyB0aGF0IGNsZWFyIG9ic2VydmVycy4KICAgICAgVGhlc2UgbWV0aG9kcyB3aWxsIGJlIGNhbGxlZCBvbiBkZXN0cnVjdGlvbi4KICAgICAgIEBwcml2YXRlCiAgICAgIEBwcm9wZXJ0eSByZWxlYXNlTWV0aG9kcwogICAgICBAc2luY2UgMS4zLjAKICAgICovCiAgICByZWxlYXNlTWV0aG9kczogKDAsIF9ydW50aW1lLkEpKCksCgogICAgLyoqCiAgICAgIFNwZWNpZmllcyBob3cgcmVjb3JkcyBjYW4gYmUgZmlsdGVyZWQuCiAgICAgIFJlY29yZHMgcmV0dXJuZWQgd2lsbCBuZWVkIHRvIGhhdmUgYSBgZmlsdGVyVmFsdWVzYAogICAgICBwcm9wZXJ0eSB3aXRoIGEga2V5IGZvciBldmVyeSBuYW1lIGluIHRoZSByZXR1cm5lZCBhcnJheS4KICAgICAgIEBwdWJsaWMKICAgICAgQG1ldGhvZCBnZXRGaWx0ZXJzCiAgICAgIEByZXR1cm4ge0FycmF5fSBMaXN0IG9mIG9iamVjdHMgZGVmaW5pbmcgZmlsdGVycy4KICAgICAgIFRoZSBvYmplY3Qgc2hvdWxkIGhhdmUgYSBgbmFtZWAgYW5kIGBkZXNjYCBwcm9wZXJ0eS4KICAgICovCiAgICBnZXRGaWx0ZXJzOiBmdW5jdGlvbiBnZXRGaWx0ZXJzKCkgewogICAgICByZXR1cm4gKDAsIF9ydW50aW1lLkEpKCk7CiAgICB9LAoKICAgIC8qKgogICAgICBGZXRjaCB0aGUgbW9kZWwgdHlwZXMgYW5kIG9ic2VydmUgdGhlbSBmb3IgY2hhbmdlcy4KICAgICAgIEBwdWJsaWMKICAgICAgQG1ldGhvZCB3YXRjaE1vZGVsVHlwZXMKICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IHR5cGVzQWRkZWQgQ2FsbGJhY2sgdG8gY2FsbCB0byBhZGQgdHlwZXMuCiAgICAgIFRha2VzIGFuIGFycmF5IG9mIG9iamVjdHMgY29udGFpbmluZyB3cmFwcGVkIHR5cGVzIChyZXR1cm5lZCBmcm9tIGB3cmFwTW9kZWxUeXBlYCkuCiAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSB0eXBlc1VwZGF0ZWQgQ2FsbGJhY2sgdG8gY2FsbCB3aGVuIGEgdHlwZSBoYXMgY2hhbmdlZC4KICAgICAgVGFrZXMgYW4gYXJyYXkgb2Ygb2JqZWN0cyBjb250YWluaW5nIHdyYXBwZWQgdHlwZXMuCiAgICAgICBAcmV0dXJuIHtGdW5jdGlvbn0gTWV0aG9kIHRvIGNhbGwgdG8gcmVtb3ZlIGFsbCBvYnNlcnZlcnMKICAgICovCiAgICB3YXRjaE1vZGVsVHlwZXM6IGZ1bmN0aW9uIHdhdGNoTW9kZWxUeXBlcyh0eXBlc0FkZGVkLCB0eXBlc1VwZGF0ZWQpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBtb2RlbFR5cGVzID0gdGhpcy5nZXRNb2RlbFR5cGVzKCk7CiAgICAgIHZhciByZWxlYXNlTWV0aG9kcyA9ICgwLCBfcnVudGltZS5BKSgpOwogICAgICB2YXIgdHlwZXNUb1NlbmQ7CiAgICAgIHR5cGVzVG9TZW5kID0gbW9kZWxUeXBlcy5tYXAoZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICB2YXIga2xhc3MgPSB0eXBlLmtsYXNzOwoKICAgICAgICB2YXIgd3JhcHBlZCA9IF90aGlzLndyYXBNb2RlbFR5cGUoa2xhc3MsIHR5cGUubmFtZSk7CgogICAgICAgIHJlbGVhc2VNZXRob2RzLnB1c2goX3RoaXMub2JzZXJ2ZU1vZGVsVHlwZSh0eXBlLm5hbWUsIHR5cGVzVXBkYXRlZCkpOwogICAgICAgIHJldHVybiB3cmFwcGVkOwogICAgICB9KTsKICAgICAgdHlwZXNBZGRlZCh0eXBlc1RvU2VuZCk7CgogICAgICB2YXIgcmVsZWFzZSA9IGZ1bmN0aW9uIHJlbGVhc2UoKSB7CiAgICAgICAgcmVsZWFzZU1ldGhvZHMuZm9yRWFjaChmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgIHJldHVybiBmbigpOwogICAgICAgIH0pOwoKICAgICAgICBfdGhpcy5yZWxlYXNlTWV0aG9kcy5yZW1vdmVPYmplY3QocmVsZWFzZSk7CiAgICAgIH07CgogICAgICB0aGlzLnJlbGVhc2VNZXRob2RzLnB1c2hPYmplY3QocmVsZWFzZSk7CiAgICAgIHJldHVybiByZWxlYXNlOwogICAgfSwKICAgIF9uYW1lVG9DbGFzczogZnVuY3Rpb24gX25hbWVUb0NsYXNzKHR5cGUpIHsKICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAnc3RyaW5nJykgewogICAgICAgIHZhciBvd25lciA9ICgwLCBfb3duZXIuZ2V0T3duZXIpKHRoaXMpOwogICAgICAgIHZhciBGYWN0b3J5ID0gb3duZXIuZmFjdG9yeUZvcigibW9kZWw6IiArIHR5cGUpOwogICAgICAgIHR5cGUgPSBGYWN0b3J5ICYmIEZhY3RvcnkuY2xhc3M7CiAgICAgIH0KCiAgICAgIHJldHVybiB0eXBlOwogICAgfSwKCiAgICAvKioKICAgICAgRmV0Y2ggdGhlIHJlY29yZHMgb2YgYSBnaXZlbiB0eXBlIGFuZCBvYnNlcnZlIHRoZW0gZm9yIGNoYW5nZXMuCiAgICAgICBAcHVibGljCiAgICAgIEBtZXRob2Qgd2F0Y2hSZWNvcmRzCiAgICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lIFRoZSBtb2RlbCBuYW1lLgogICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gcmVjb3Jkc0FkZGVkIENhbGxiYWNrIHRvIGNhbGwgdG8gYWRkIHJlY29yZHMuCiAgICAgIFRha2VzIGFuIGFycmF5IG9mIG9iamVjdHMgY29udGFpbmluZyB3cmFwcGVkIHJlY29yZHMuCiAgICAgIFRoZSBvYmplY3Qgc2hvdWxkIGhhdmUgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICAgIGNvbHVtblZhbHVlczoge09iamVjdH0gVGhlIGtleSBhbmQgdmFsdWUgb2YgYSB0YWJsZSBjZWxsLgogICAgICAgIG9iamVjdDoge09iamVjdH0gVGhlIGFjdHVhbCByZWNvcmQgb2JqZWN0LgogICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gcmVjb3Jkc1VwZGF0ZWQgQ2FsbGJhY2sgdG8gY2FsbCB3aGVuIGEgcmVjb3JkIGhhcyBjaGFuZ2VkLgogICAgICBUYWtlcyBhbiBhcnJheSBvZiBvYmplY3RzIGNvbnRhaW5pbmcgd3JhcHBlZCByZWNvcmRzLgogICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gcmVjb3Jkc1JlbW92ZWQgQ2FsbGJhY2sgdG8gY2FsbCB3aGVuIGEgcmVjb3JkIGhhcyByZW1vdmVkLgogICAgICBUYWtlcyB0aGUgZm9sbG93aW5nIHBhcmFtZXRlcnM6CiAgICAgICAgaW5kZXg6IFRoZSBhcnJheSBpbmRleCB3aGVyZSB0aGUgcmVjb3JkcyB3ZXJlIHJlbW92ZWQuCiAgICAgICAgY291bnQ6IFRoZSBudW1iZXIgb2YgcmVjb3JkcyByZW1vdmVkLgogICAgICAgQHJldHVybiB7RnVuY3Rpb259IE1ldGhvZCB0byBjYWxsIHRvIHJlbW92ZSBhbGwgb2JzZXJ2ZXJzLgogICAgKi8KICAgIHdhdGNoUmVjb3JkczogZnVuY3Rpb24gd2F0Y2hSZWNvcmRzKG1vZGVsTmFtZSwgcmVjb3Jkc0FkZGVkLCByZWNvcmRzVXBkYXRlZCwgcmVjb3Jkc1JlbW92ZWQpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB2YXIgcmVsZWFzZU1ldGhvZHMgPSAoMCwgX3J1bnRpbWUuQSkoKTsKCiAgICAgIHZhciBrbGFzcyA9IHRoaXMuX25hbWVUb0NsYXNzKG1vZGVsTmFtZSk7CgogICAgICB2YXIgcmVjb3JkcyA9IHRoaXMuZ2V0UmVjb3JkcyhrbGFzcywgbW9kZWxOYW1lKTsKCiAgICAgIHZhciBfcmVsZWFzZTsKCiAgICAgIGZ1bmN0aW9uIHJlY29yZFVwZGF0ZWQodXBkYXRlZFJlY29yZCkgewogICAgICAgIHJlY29yZHNVcGRhdGVkKFt1cGRhdGVkUmVjb3JkXSk7CiAgICAgIH0KCiAgICAgIHZhciByZWNvcmRzVG9TZW5kID0gcmVjb3Jkcy5tYXAoZnVuY3Rpb24gKHJlY29yZCkgewogICAgICAgIHJlbGVhc2VNZXRob2RzLnB1c2goX3RoaXMyLm9ic2VydmVSZWNvcmQocmVjb3JkLCByZWNvcmRVcGRhdGVkKSk7CiAgICAgICAgcmV0dXJuIF90aGlzMi53cmFwUmVjb3JkKHJlY29yZCk7CiAgICAgIH0pOwoKICAgICAgdmFyIGNvbnRlbnREaWRDaGFuZ2UgPSBmdW5jdGlvbiBjb250ZW50RGlkQ2hhbmdlKGFycmF5LCBpZHgsIHJlbW92ZWRDb3VudCwgYWRkZWRDb3VudCkgewogICAgICAgIGZvciAodmFyIGkgPSBpZHg7IGkgPCBpZHggKyBhZGRlZENvdW50OyBpKyspIHsKICAgICAgICAgIHZhciByZWNvcmQgPSAoMCwgX21ldGFsLm9iamVjdEF0KShhcnJheSwgaSk7CgogICAgICAgICAgdmFyIHdyYXBwZWQgPSBfdGhpczIud3JhcFJlY29yZChyZWNvcmQpOwoKICAgICAgICAgIHJlbGVhc2VNZXRob2RzLnB1c2goX3RoaXMyLm9ic2VydmVSZWNvcmQocmVjb3JkLCByZWNvcmRVcGRhdGVkKSk7CiAgICAgICAgICByZWNvcmRzQWRkZWQoW3dyYXBwZWRdKTsKICAgICAgICB9CgogICAgICAgIGlmIChyZW1vdmVkQ291bnQpIHsKICAgICAgICAgIHJlY29yZHNSZW1vdmVkKGlkeCwgcmVtb3ZlZENvdW50KTsKICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgb2JzZXJ2ZXIgPSB7CiAgICAgICAgZGlkQ2hhbmdlOiBjb250ZW50RGlkQ2hhbmdlLAogICAgICAgIHdpbGxDaGFuZ2U6IGZ1bmN0aW9uIHdpbGxDaGFuZ2UoKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgIH07CiAgICAgICgwLCBfbWV0YWwuYWRkQXJyYXlPYnNlcnZlcikocmVjb3JkcywgdGhpcywgb2JzZXJ2ZXIpOwoKICAgICAgX3JlbGVhc2UgPSBmdW5jdGlvbiByZWxlYXNlKCkgewogICAgICAgIHJlbGVhc2VNZXRob2RzLmZvckVhY2goZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICB9KTsKICAgICAgICAoMCwgX21ldGFsLnJlbW92ZUFycmF5T2JzZXJ2ZXIpKHJlY29yZHMsIF90aGlzMiwgb2JzZXJ2ZXIpOwoKICAgICAgICBfdGhpczIucmVsZWFzZU1ldGhvZHMucmVtb3ZlT2JqZWN0KF9yZWxlYXNlKTsKICAgICAgfTsKCiAgICAgIHJlY29yZHNBZGRlZChyZWNvcmRzVG9TZW5kKTsKICAgICAgdGhpcy5yZWxlYXNlTWV0aG9kcy5wdXNoT2JqZWN0KF9yZWxlYXNlKTsKICAgICAgcmV0dXJuIF9yZWxlYXNlOwogICAgfSwKCiAgICAvKioKICAgICAgQ2xlYXIgYWxsIG9ic2VydmVycyBiZWZvcmUgZGVzdHJ1Y3Rpb24KICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCB3aWxsRGVzdHJveQogICAgKi8KICAgIHdpbGxEZXN0cm95OiBmdW5jdGlvbiB3aWxsRGVzdHJveSgpIHsKICAgICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgIHRoaXMucmVsZWFzZU1ldGhvZHMuZm9yRWFjaChmdW5jdGlvbiAoZm4pIHsKICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICBEZXRlY3Qgd2hldGhlciBhIGNsYXNzIGlzIGEgbW9kZWwuCiAgICAgICBUZXN0IHRoYXQgYWdhaW5zdCB0aGUgbW9kZWwgY2xhc3MKICAgICAgb2YgeW91ciBwZXJzaXN0ZW5jZSBsaWJyYXJ5LgogICAgICAgQHB1YmxpYwogICAgICBAbWV0aG9kIGRldGVjdAogICAgICBAcmV0dXJuIGJvb2xlYW4gV2hldGhlciB0aGUgY2xhc3MgaXMgYSBtb2RlbCBjbGFzcyBvciBub3QuCiAgICAqLwogICAgZGV0ZWN0OiBmdW5jdGlvbiBkZXRlY3QoKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgLyoqCiAgICAgIEdldCB0aGUgY29sdW1ucyBmb3IgYSBnaXZlbiBtb2RlbCB0eXBlLgogICAgICAgQHB1YmxpYwogICAgICBAbWV0aG9kIGNvbHVtbnNGb3JUeXBlCiAgICAgIEByZXR1cm4ge0FycmF5fSBBbiBhcnJheSBvZiBjb2x1bW5zIG9mIHRoZSBmb2xsb3dpbmcgZm9ybWF0OgogICAgICAgbmFtZToge1N0cmluZ30gVGhlIG5hbWUgb2YgdGhlIGNvbHVtbi4KICAgICAgIGRlc2M6IHtTdHJpbmd9IEh1bWFuaXplZCBkZXNjcmlwdGlvbiAod2hhdCB3b3VsZCBzaG93IGluIGEgdGFibGUgY29sdW1uIG5hbWUpLgogICAgKi8KICAgIGNvbHVtbnNGb3JUeXBlOiBmdW5jdGlvbiBjb2x1bW5zRm9yVHlwZSgpIHsKICAgICAgcmV0dXJuICgwLCBfcnVudGltZS5BKSgpOwogICAgfSwKCiAgICAvKioKICAgICAgQWRkcyBvYnNlcnZlcnMgdG8gYSBtb2RlbCB0eXBlIGNsYXNzLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBvYnNlcnZlTW9kZWxUeXBlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUgVGhlIG1vZGVsIHR5cGUgbmFtZS4KICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gdHlwZXNVcGRhdGVkIENhbGxlZCB3aGVuIGEgdHlwZSBpcyBtb2RpZmllZC4KICAgICAgQHJldHVybiB7RnVuY3Rpb259IFRoZSBmdW5jdGlvbiB0byBjYWxsIHRvIHJlbW92ZSBvYnNlcnZlcnMuCiAgICAqLwogICAgb2JzZXJ2ZU1vZGVsVHlwZTogZnVuY3Rpb24gb2JzZXJ2ZU1vZGVsVHlwZShtb2RlbE5hbWUsIHR5cGVzVXBkYXRlZCkgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIHZhciBrbGFzcyA9IHRoaXMuX25hbWVUb0NsYXNzKG1vZGVsTmFtZSk7CgogICAgICB2YXIgcmVjb3JkcyA9IHRoaXMuZ2V0UmVjb3JkcyhrbGFzcywgbW9kZWxOYW1lKTsKCiAgICAgIGZ1bmN0aW9uIG9uQ2hhbmdlKCkgewogICAgICAgIHR5cGVzVXBkYXRlZChbdGhpcy53cmFwTW9kZWxUeXBlKGtsYXNzLCBtb2RlbE5hbWUpXSk7CiAgICAgIH0KCiAgICAgIHZhciBvYnNlcnZlciA9IHsKICAgICAgICBkaWRDaGFuZ2U6IGZ1bmN0aW9uIGRpZENoYW5nZShhcnJheSwgaWR4LCByZW1vdmVkQ291bnQsIGFkZGVkQ291bnQpIHsKICAgICAgICAgIC8vIE9ubHkgcmUtZmV0Y2ggcmVjb3JkcyBpZiB0aGUgcmVjb3JkIGNvdW50IGNoYW5nZWQKICAgICAgICAgIC8vICh3aGljaCBpcyBhbGwgd2UgY2FyZSBhYm91dCBhcyBmYXIgYXMgbW9kZWwgdHlwZXMgYXJlIGNvbmNlcm5lZCkuCiAgICAgICAgICBpZiAocmVtb3ZlZENvdW50ID4gMCB8fCBhZGRlZENvdW50ID4gMCkgewogICAgICAgICAgICAoMCwgX3J1bmxvb3Auc2NoZWR1bGVPbmNlKSgnYWN0aW9ucycsIHRoaXMsIG9uQ2hhbmdlKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHdpbGxDaGFuZ2U6IGZ1bmN0aW9uIHdpbGxDaGFuZ2UoKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgIH07CiAgICAgICgwLCBfbWV0YWwuYWRkQXJyYXlPYnNlcnZlcikocmVjb3JkcywgdGhpcywgb2JzZXJ2ZXIpOwoKICAgICAgdmFyIHJlbGVhc2UgPSBmdW5jdGlvbiByZWxlYXNlKCkgewogICAgICAgIHJldHVybiAoMCwgX21ldGFsLnJlbW92ZUFycmF5T2JzZXJ2ZXIpKHJlY29yZHMsIF90aGlzMywgb2JzZXJ2ZXIpOwogICAgICB9OwoKICAgICAgcmV0dXJuIHJlbGVhc2U7CiAgICB9LAoKICAgIC8qKgogICAgICBXcmFwcyBhIGdpdmVuIG1vZGVsIHR5cGUgYW5kIG9ic2VydmVzIGNoYW5nZXMgdG8gaXQuCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIHdyYXBNb2RlbFR5cGUKICAgICAgQHBhcmFtIHtDbGFzc30ga2xhc3MgQSBtb2RlbCBjbGFzcy4KICAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZSBOYW1lIG9mIHRoZSBjbGFzcy4KICAgICAgQHJldHVybiB7T2JqZWN0fSBDb250YWlucyB0aGUgd3JhcHBlZCB0eXBlIGFuZCB0aGUgZnVuY3Rpb24gdG8gcmVtb3ZlIG9ic2VydmVycwogICAgICBGb3JtYXQ6CiAgICAgICAgdHlwZToge09iamVjdH0gVGhlIHdyYXBwZWQgdHlwZS4KICAgICAgICAgIFRoZSB3cmFwcGVkIHR5cGUgaGFzIHRoZSBmb2xsb3dpbmcgZm9ybWF0OgogICAgICAgICAgICBuYW1lOiB7U3RyaW5nfSBUaGUgbmFtZSBvZiB0aGUgdHlwZS4KICAgICAgICAgICAgY291bnQ6IHtJbnRlZ2VyfSBUaGUgbnVtYmVyIG9mIHJlY29yZHMgYXZhaWxhYmxlLgogICAgICAgICAgICBjb2x1bW5zOiB7Q29sdW1uc30gQW4gYXJyYXkgb2YgY29sdW1ucyB0byBkZXNjcmliZSB0aGUgcmVjb3JkLgogICAgICAgICAgICBvYmplY3Q6IHtDbGFzc30gVGhlIGFjdHVhbCBNb2RlbCB0eXBlIGNsYXNzLgogICAgICAgIHJlbGVhc2U6IHtGdW5jdGlvbn0gVGhlIGZ1bmN0aW9uIHRvIHJlbW92ZSBvYnNlcnZlcnMuCiAgICAqLwogICAgd3JhcE1vZGVsVHlwZTogZnVuY3Rpb24gd3JhcE1vZGVsVHlwZShrbGFzcywgbmFtZSkgewogICAgICB2YXIgcmVjb3JkcyA9IHRoaXMuZ2V0UmVjb3JkcyhrbGFzcywgbmFtZSk7CiAgICAgIHZhciB0eXBlVG9TZW5kOwogICAgICB0eXBlVG9TZW5kID0gewogICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgY291bnQ6ICgwLCBfbWV0YWwuZ2V0KShyZWNvcmRzLCAnbGVuZ3RoJyksCiAgICAgICAgY29sdW1uczogdGhpcy5jb2x1bW5zRm9yVHlwZShrbGFzcyksCiAgICAgICAgb2JqZWN0OiBrbGFzcwogICAgICB9OwogICAgICByZXR1cm4gdHlwZVRvU2VuZDsKICAgIH0sCgogICAgLyoqCiAgICAgIEZldGNoZXMgYWxsIG1vZGVscyBkZWZpbmVkIGluIHRoZSBhcHBsaWNhdGlvbi4KICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgZ2V0TW9kZWxUeXBlcwogICAgICBAcmV0dXJuIHtBcnJheX0gQXJyYXkgb2YgbW9kZWwgdHlwZXMuCiAgICAqLwogICAgZ2V0TW9kZWxUeXBlczogZnVuY3Rpb24gZ2V0TW9kZWxUeXBlcygpIHsKICAgICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgICB2YXIgY29udGFpbmVyRGVidWdBZGFwdGVyID0gdGhpcy5nZXQoJ2NvbnRhaW5lckRlYnVnQWRhcHRlcicpOwogICAgICB2YXIgdHlwZXM7CgogICAgICBpZiAoY29udGFpbmVyRGVidWdBZGFwdGVyLmNhbkNhdGFsb2dFbnRyaWVzQnlUeXBlKCdtb2RlbCcpKSB7CiAgICAgICAgdHlwZXMgPSBjb250YWluZXJEZWJ1Z0FkYXB0ZXIuY2F0YWxvZ0VudHJpZXNCeVR5cGUoJ21vZGVsJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHlwZXMgPSB0aGlzLl9nZXRPYmplY3RzT25OYW1lc3BhY2VzKCk7CiAgICAgIH0gLy8gTmV3IGFkYXB0ZXJzIHJldHVybiBzdHJpbmdzIGluc3RlYWQgb2YgY2xhc3Nlcy4KCgogICAgICB0eXBlcyA9ICgwLCBfcnVudGltZS5BKSh0eXBlcykubWFwKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGtsYXNzOiBfdGhpczQuX25hbWVUb0NsYXNzKG5hbWUpLAogICAgICAgICAgbmFtZTogbmFtZQogICAgICAgIH07CiAgICAgIH0pOwogICAgICB0eXBlcyA9ICgwLCBfcnVudGltZS5BKSh0eXBlcykuZmlsdGVyKGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgcmV0dXJuIF90aGlzNC5kZXRlY3QodHlwZS5rbGFzcyk7CiAgICAgIH0pOwogICAgICByZXR1cm4gKDAsIF9ydW50aW1lLkEpKHR5cGVzKTsKICAgIH0sCgogICAgLyoqCiAgICAgIExvb3BzIG92ZXIgYWxsIG5hbWVzcGFjZXMgYW5kIGFsbCBvYmplY3RzCiAgICAgIGF0dGFjaGVkIHRvIHRoZW0uCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIF9nZXRPYmplY3RzT25OYW1lc3BhY2VzCiAgICAgIEByZXR1cm4ge0FycmF5fSBBcnJheSBvZiBtb2RlbCB0eXBlIHN0cmluZ3MuCiAgICAqLwogICAgX2dldE9iamVjdHNPbk5hbWVzcGFjZXM6IGZ1bmN0aW9uIF9nZXRPYmplY3RzT25OYW1lc3BhY2VzKCkgewogICAgICB2YXIgX3RoaXM1ID0gdGhpczsKCiAgICAgIHZhciBuYW1lc3BhY2VzID0gKDAsIF9ydW50aW1lLkEpKF9ydW50aW1lLk5hbWVzcGFjZS5OQU1FU1BBQ0VTKTsKICAgICAgdmFyIHR5cGVzID0gKDAsIF9ydW50aW1lLkEpKCk7CiAgICAgIG5hbWVzcGFjZXMuZm9yRWFjaChmdW5jdGlvbiAobmFtZXNwYWNlKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIG5hbWVzcGFjZSkgewogICAgICAgICAgaWYgKCFuYW1lc3BhY2UuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0gLy8gRXZlbiB0aG91Z2ggd2Ugd2lsbCBmaWx0ZXIgYWdhaW4gaW4gYGdldE1vZGVsVHlwZXNgLAogICAgICAgICAgLy8gd2Ugc2hvdWxkIG5vdCBjYWxsIGBsb29rdXBGYWN0b3J5YCBvbiBub24tbW9kZWxzCgoKICAgICAgICAgIGlmICghX3RoaXM1LmRldGVjdChuYW1lc3BhY2Vba2V5XSkpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIG5hbWUgPSAoMCwgX3N0cmluZy5kYXNoZXJpemUpKGtleSk7CiAgICAgICAgICB0eXBlcy5wdXNoKG5hbWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiB0eXBlczsKICAgIH0sCgogICAgLyoqCiAgICAgIEZldGNoZXMgYWxsIGxvYWRlZCByZWNvcmRzIGZvciBhIGdpdmVuIHR5cGUuCiAgICAgICBAcHVibGljCiAgICAgIEBtZXRob2QgZ2V0UmVjb3JkcwogICAgICBAcmV0dXJuIHtBcnJheX0gQW4gYXJyYXkgb2YgcmVjb3Jkcy4KICAgICAgIFRoaXMgYXJyYXkgd2lsbCBiZSBvYnNlcnZlZCBmb3IgY2hhbmdlcywKICAgICAgIHNvIGl0IHNob3VsZCB1cGRhdGUgd2hlbiBuZXcgcmVjb3JkcyBhcmUgYWRkZWQvcmVtb3ZlZC4KICAgICovCiAgICBnZXRSZWNvcmRzOiBmdW5jdGlvbiBnZXRSZWNvcmRzKCkgewogICAgICByZXR1cm4gKDAsIF9ydW50aW1lLkEpKCk7CiAgICB9LAoKICAgIC8qKgogICAgICBXcmFwcyBhIHJlY29yZCBhbmQgb2JzZXJ2ZXJzIGNoYW5nZXMgdG8gaXQuCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIHdyYXBSZWNvcmQKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlY29yZCBUaGUgcmVjb3JkIGluc3RhbmNlLgogICAgICBAcmV0dXJuIHtPYmplY3R9IFRoZSB3cmFwcGVkIHJlY29yZC4gRm9ybWF0OgogICAgICBjb2x1bW5WYWx1ZXM6IHtBcnJheX0KICAgICAgc2VhcmNoS2V5d29yZHM6IHtBcnJheX0KICAgICovCiAgICB3cmFwUmVjb3JkOiBmdW5jdGlvbiB3cmFwUmVjb3JkKHJlY29yZCkgewogICAgICB2YXIgcmVjb3JkVG9TZW5kID0gewogICAgICAgIG9iamVjdDogcmVjb3JkCiAgICAgIH07CiAgICAgIHJlY29yZFRvU2VuZC5jb2x1bW5WYWx1ZXMgPSB0aGlzLmdldFJlY29yZENvbHVtblZhbHVlcyhyZWNvcmQpOwogICAgICByZWNvcmRUb1NlbmQuc2VhcmNoS2V5d29yZHMgPSB0aGlzLmdldFJlY29yZEtleXdvcmRzKHJlY29yZCk7CiAgICAgIHJlY29yZFRvU2VuZC5maWx0ZXJWYWx1ZXMgPSB0aGlzLmdldFJlY29yZEZpbHRlclZhbHVlcyhyZWNvcmQpOwogICAgICByZWNvcmRUb1NlbmQuY29sb3IgPSB0aGlzLmdldFJlY29yZENvbG9yKHJlY29yZCk7CiAgICAgIHJldHVybiByZWNvcmRUb1NlbmQ7CiAgICB9LAoKICAgIC8qKgogICAgICBHZXRzIHRoZSB2YWx1ZXMgZm9yIGVhY2ggY29sdW1uLgogICAgICAgQHB1YmxpYwogICAgICBAbWV0aG9kIGdldFJlY29yZENvbHVtblZhbHVlcwogICAgICBAcmV0dXJuIHtPYmplY3R9IEtleXMgc2hvdWxkIG1hdGNoIGNvbHVtbiBuYW1lcyBkZWZpbmVkCiAgICAgIGJ5IHRoZSBtb2RlbCB0eXBlLgogICAgKi8KICAgIGdldFJlY29yZENvbHVtblZhbHVlczogZnVuY3Rpb24gZ2V0UmVjb3JkQ29sdW1uVmFsdWVzKCkgewogICAgICByZXR1cm4ge307CiAgICB9LAoKICAgIC8qKgogICAgICBSZXR1cm5zIGtleXdvcmRzIHRvIG1hdGNoIHdoZW4gc2VhcmNoaW5nIHJlY29yZHMuCiAgICAgICBAcHVibGljCiAgICAgIEBtZXRob2QgZ2V0UmVjb3JkS2V5d29yZHMKICAgICAgQHJldHVybiB7QXJyYXl9IFJlbGV2YW50IGtleXdvcmRzIGZvciBzZWFyY2guCiAgICAqLwogICAgZ2V0UmVjb3JkS2V5d29yZHM6IGZ1bmN0aW9uIGdldFJlY29yZEtleXdvcmRzKCkgewogICAgICByZXR1cm4gKDAsIF9ydW50aW1lLkEpKCk7CiAgICB9LAoKICAgIC8qKgogICAgICBSZXR1cm5zIHRoZSB2YWx1ZXMgb2YgZmlsdGVycyBkZWZpbmVkIGJ5IGBnZXRGaWx0ZXJzYC4KICAgICAgIEBwdWJsaWMKICAgICAgQG1ldGhvZCBnZXRSZWNvcmRGaWx0ZXJWYWx1ZXMKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlY29yZCBUaGUgcmVjb3JkIGluc3RhbmNlLgogICAgICBAcmV0dXJuIHtPYmplY3R9IFRoZSBmaWx0ZXIgdmFsdWVzLgogICAgKi8KICAgIGdldFJlY29yZEZpbHRlclZhbHVlczogZnVuY3Rpb24gZ2V0UmVjb3JkRmlsdGVyVmFsdWVzKCkgewogICAgICByZXR1cm4ge307CiAgICB9LAoKICAgIC8qKgogICAgICBFYWNoIHJlY29yZCBjYW4gaGF2ZSBhIGNvbG9yIHRoYXQgcmVwcmVzZW50cyBpdHMgc3RhdGUuCiAgICAgICBAcHVibGljCiAgICAgIEBtZXRob2QgZ2V0UmVjb3JkQ29sb3IKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlY29yZCBUaGUgcmVjb3JkIGluc3RhbmNlCiAgICAgIEByZXR1cm4ge1N0cmluZ30gVGhlIHJlY29yZHMgY29sb3IuCiAgICAgICAgUG9zc2libGUgb3B0aW9uczogYmxhY2ssIHJlZCwgYmx1ZSwgZ3JlZW4uCiAgICAqLwogICAgZ2V0UmVjb3JkQ29sb3I6IGZ1bmN0aW9uIGdldFJlY29yZENvbG9yKCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgogICAgLyoqCiAgICAgIE9ic2VydmVzIGFsbCByZWxldmFudCBwcm9wZXJ0aWVzIGFuZCByZS1zZW5kcyB0aGUgd3JhcHBlZCByZWNvcmQKICAgICAgd2hlbiBhIGNoYW5nZSBvY2N1cnMuCiAgICAgICBAcHVibGljCiAgICAgIEBtZXRob2Qgb2JzZXJ2ZXJSZWNvcmQKICAgICAgQHJldHVybiB7RnVuY3Rpb259IFRoZSBmdW5jdGlvbiB0byBjYWxsIHRvIHJlbW92ZSBhbGwgb2JzZXJ2ZXJzLgogICAgKi8KICAgIG9ic2VydmVSZWNvcmQ6IGZ1bmN0aW9uIG9ic2VydmVSZWNvcmQoKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7fTsKICAgIH0KICB9KTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9nbGltbWVyL2luZGV4IiwgWyJleHBvcnRzIiwgImVtYmVyLWJhYmVsIiwgIkBlbWJlci9wb2x5ZmlsbHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvY29udGFpbmVyIiwgIkBnbGltbWVyL29wY29kZS1jb21waWxlciIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lIiwgIkBlbWJlci8taW50ZXJuYWxzL3V0aWxzIiwgIkBlbWJlci9ydW5sb29wIiwgIkBnbGltbWVyL3JlZmVyZW5jZSIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCIsICJAZW1iZXIvZGVidWciLCAiQGdsaW1tZXIvcnVudGltZSIsICJAZ2xpbW1lci91dGlsIiwgIkBlbWJlci8taW50ZXJuYWxzL293bmVyIiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzIiwgIkBlbWJlci8taW50ZXJuYWxzL2Jyb3dzZXItZW52aXJvbm1lbnQiLCAiQGVtYmVyL2luc3RydW1lbnRhdGlvbiIsICJAZW1iZXIvc2VydmljZSIsICJAZW1iZXIvLWludGVybmFscy9lbnZpcm9ubWVudCIsICJAZW1iZXIvc3RyaW5nIiwgIkBnbGltbWVyL3dpcmUtZm9ybWF0IiwgInJzdnAiLCAiQGdsaW1tZXIvbm9kZSIsICJAZW1iZXIvLWludGVybmFscy9yb3V0aW5nIiwgIkBlbWJlci9jb21wb25lbnQvdGVtcGxhdGUtb25seSIsICJAZW1iZXIvZGVwcmVjYXRlZC1mZWF0dXJlcyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9lbWJlckJhYmVsLCBfcG9seWZpbGxzLCBfY29udGFpbmVyLCBfb3Bjb2RlQ29tcGlsZXIsIF9ydW50aW1lLCBfdXRpbHMsIF9ydW5sb29wLCBfcmVmZXJlbmNlLCBfbWV0YWwsIF9kZWJ1ZywgX3J1bnRpbWUyLCBfdXRpbCwgX293bmVyLCBfdmlld3MsIF9icm93c2VyRW52aXJvbm1lbnQsIF9pbnN0cnVtZW50YXRpb24sIF9zZXJ2aWNlLCBfZW52aXJvbm1lbnQyLCBfc3RyaW5nLCBfd2lyZUZvcm1hdCwgX3JzdnAsIF9ub2RlLCBfcm91dGluZywgX3RlbXBsYXRlT25seSwgX2RlcHJlY2F0ZWRGZWF0dXJlcykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICBfZXhwb3J0cy5oZWxwZXIgPSBoZWxwZXI7CiAgX2V4cG9ydHMuZXNjYXBlRXhwcmVzc2lvbiA9IGVzY2FwZUV4cHJlc3Npb247CiAgX2V4cG9ydHMuaHRtbFNhZmUgPSBodG1sU2FmZTsKICBfZXhwb3J0cy5pc0hUTUxTYWZlID0gaXNIVE1MU2FmZTsKICBfZXhwb3J0cy5fcmVzZXRSZW5kZXJlcnMgPSBfcmVzZXRSZW5kZXJlcnM7CiAgX2V4cG9ydHMucmVuZGVyU2V0dGxlZCA9IHJlbmRlclNldHRsZWQ7CiAgX2V4cG9ydHMuZ2V0VGVtcGxhdGUgPSBnZXRUZW1wbGF0ZTsKICBfZXhwb3J0cy5zZXRUZW1wbGF0ZSA9IHNldFRlbXBsYXRlOwogIF9leHBvcnRzLmhhc1RlbXBsYXRlID0gaGFzVGVtcGxhdGU7CiAgX2V4cG9ydHMuZ2V0VGVtcGxhdGVzID0gZ2V0VGVtcGxhdGVzOwogIF9leHBvcnRzLnNldFRlbXBsYXRlcyA9IHNldFRlbXBsYXRlczsKICBfZXhwb3J0cy5zZXR1cEVuZ2luZVJlZ2lzdHJ5ID0gc2V0dXBFbmdpbmVSZWdpc3RyeTsKICBfZXhwb3J0cy5zZXR1cEFwcGxpY2F0aW9uUmVnaXN0cnkgPSBzZXR1cEFwcGxpY2F0aW9uUmVnaXN0cnk7CiAgX2V4cG9ydHMuX3JlZ2lzdGVyTWFjcm9zID0gcmVnaXN0ZXJNYWNyb3M7CiAgX2V4cG9ydHMuaXRlcmFibGVGb3IgPSBfaXRlcmFibGVGb3I7CiAgX2V4cG9ydHMuY2FwYWJpbGl0aWVzID0gY2FwYWJpbGl0aWVzOwogIF9leHBvcnRzLnNldENvbXBvbmVudE1hbmFnZXIgPSBzZXRDb21wb25lbnRNYW5hZ2VyOwogIF9leHBvcnRzLmdldENvbXBvbmVudE1hbmFnZXIgPSBnZXRDb21wb25lbnRNYW5hZ2VyOwogIF9leHBvcnRzLnNldE1vZGlmaWVyTWFuYWdlciA9IHNldE1vZGlmaWVyTWFuYWdlcjsKICBfZXhwb3J0cy5nZXRNb2RpZmllck1hbmFnZXIgPSBnZXRNb2RpZmllck1hbmFnZXI7CiAgX2V4cG9ydHMubW9kaWZpZXJDYXBhYmlsaXRpZXMgPSBjYXBhYmlsaXRpZXMkMTsKICBfZXhwb3J0cy5zZXRDb21wb25lbnRUZW1wbGF0ZSA9IHNldENvbXBvbmVudFRlbXBsYXRlOwogIF9leHBvcnRzLmdldENvbXBvbmVudFRlbXBsYXRlID0gZ2V0Q29tcG9uZW50VGVtcGxhdGU7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiRE9NQ2hhbmdlcyIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9ydW50aW1lMi5ET01DaGFuZ2VzOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIkRPTVRyZWVDb25zdHJ1Y3Rpb24iLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcnVudGltZTIuRE9NVHJlZUNvbnN0cnVjdGlvbjsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJpc1NlcmlhbGl6YXRpb25GaXJzdE5vZGUiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcnVudGltZTIuaXNTZXJpYWxpemF0aW9uRmlyc3ROb2RlOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIk5vZGVET01UcmVlQ29uc3RydWN0aW9uIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX25vZGUuTm9kZURPTVRyZWVDb25zdHJ1Y3Rpb247CiAgICB9CiAgfSk7CiAgX2V4cG9ydHMuT3V0bGV0VmlldyA9IF9leHBvcnRzLmdldERlYnVnU3RhY2sgPSBfZXhwb3J0cy5JTlZPS0UgPSBfZXhwb3J0cy5VcGRhdGFibGVSZWZlcmVuY2UgPSBfZXhwb3J0cy5BYnN0cmFjdENvbXBvbmVudE1hbmFnZXIgPSBfZXhwb3J0cy5fZXhwZXJpbWVudGFsTWFjcm9zID0gX2V4cG9ydHMuSW50ZXJhY3RpdmVSZW5kZXJlciA9IF9leHBvcnRzLkluZXJ0UmVuZGVyZXIgPSBfZXhwb3J0cy5SZW5kZXJlciA9IF9leHBvcnRzLlNhZmVTdHJpbmcgPSBfZXhwb3J0cy5FbnZpcm9ubWVudCA9IF9leHBvcnRzLkhlbHBlciA9IF9leHBvcnRzLlJPT1RfUkVGID0gX2V4cG9ydHMuQ29tcG9uZW50ID0gX2V4cG9ydHMuTGlua0NvbXBvbmVudCA9IF9leHBvcnRzLlRleHRBcmVhID0gX2V4cG9ydHMuVGV4dEZpZWxkID0gX2V4cG9ydHMuQ2hlY2tib3ggPSBfZXhwb3J0cy50ZW1wbGF0ZUNhY2hlQ291bnRlcnMgPSBfZXhwb3J0cy5Sb290VGVtcGxhdGUgPSB2b2lkIDA7CgogIHZhciBfQ29yZVZpZXckZXh0ZW5kOwoKICBmdW5jdGlvbiBfdGVtcGxhdGVPYmplY3QxMCgpIHsKICAgIHZhciBkYXRhID0gKDAsIF9lbWJlckJhYmVsLnRhZ2dlZFRlbXBsYXRlTGl0ZXJhbExvb3NlKShbImNvbXBvbmVudDotZGVmYXVsdCJdKTsKCiAgICBfdGVtcGxhdGVPYmplY3QxMCA9IGZ1bmN0aW9uIF90ZW1wbGF0ZU9iamVjdDEwKCkgewogICAgICByZXR1cm4gZGF0YTsKICAgIH07CgogICAgcmV0dXJuIGRhdGE7CiAgfQoKICBmdW5jdGlvbiBfdGVtcGxhdGVPYmplY3Q5KCkgewogICAgdmFyIGRhdGEgPSAoMCwgX2VtYmVyQmFiZWwudGFnZ2VkVGVtcGxhdGVMaXRlcmFsTG9vc2UpKFsidGVtcGxhdGUtY29tcGlsZXI6bWFpbiJdKTsKCiAgICBfdGVtcGxhdGVPYmplY3Q5ID0gZnVuY3Rpb24gX3RlbXBsYXRlT2JqZWN0OSgpIHsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwoKICAgIHJldHVybiBkYXRhOwogIH0KCiAgZnVuY3Rpb24gX3RlbXBsYXRlT2JqZWN0OCgpIHsKICAgIHZhciBkYXRhID0gKDAsIF9lbWJlckJhYmVsLnRhZ2dlZFRlbXBsYXRlTGl0ZXJhbExvb3NlKShbInRlbXBsYXRlLWNvbXBpbGVyOm1haW4iXSk7CgogICAgX3RlbXBsYXRlT2JqZWN0OCA9IGZ1bmN0aW9uIF90ZW1wbGF0ZU9iamVjdDgoKSB7CiAgICAgIHJldHVybiBkYXRhOwogICAgfTsKCiAgICByZXR1cm4gZGF0YTsKICB9CgogIGZ1bmN0aW9uIF90ZW1wbGF0ZU9iamVjdDcoKSB7CiAgICB2YXIgZGF0YSA9ICgwLCBfZW1iZXJCYWJlbC50YWdnZWRUZW1wbGF0ZUxpdGVyYWxMb29zZSkoWyJ0ZW1wbGF0ZTpjb21wb25lbnRzLy1kZWZhdWx0Il0pOwoKICAgIF90ZW1wbGF0ZU9iamVjdDcgPSBmdW5jdGlvbiBfdGVtcGxhdGVPYmplY3Q3KCkgewogICAgICByZXR1cm4gZGF0YTsKICAgIH07CgogICAgcmV0dXJuIGRhdGE7CiAgfQoKICBmdW5jdGlvbiBfdGVtcGxhdGVPYmplY3Q2KCkgewogICAgdmFyIGRhdGEgPSAoMCwgX2VtYmVyQmFiZWwudGFnZ2VkVGVtcGxhdGVMaXRlcmFsTG9vc2UpKFsidGVtcGxhdGU6LXJvb3QiXSk7CgogICAgX3RlbXBsYXRlT2JqZWN0NiA9IGZ1bmN0aW9uIF90ZW1wbGF0ZU9iamVjdDYoKSB7CiAgICAgIHJldHVybiBkYXRhOwogICAgfTsKCiAgICByZXR1cm4gZGF0YTsKICB9CgogIGZ1bmN0aW9uIF90ZW1wbGF0ZU9iamVjdDUoKSB7CiAgICB2YXIgZGF0YSA9ICgwLCBfZW1iZXJCYWJlbC50YWdnZWRUZW1wbGF0ZUxpdGVyYWxMb29zZSkoWyJ0ZW1wbGF0ZTotcm9vdCJdKTsKCiAgICBfdGVtcGxhdGVPYmplY3Q1ID0gZnVuY3Rpb24gX3RlbXBsYXRlT2JqZWN0NSgpIHsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwoKICAgIHJldHVybiBkYXRhOwogIH0KCiAgZnVuY3Rpb24gX3RlbXBsYXRlT2JqZWN0NCgpIHsKICAgIHZhciBkYXRhID0gKDAsIF9lbWJlckJhYmVsLnRhZ2dlZFRlbXBsYXRlTGl0ZXJhbExvb3NlKShbImNvbXBvbmVudDotZGVmYXVsdCJdKTsKCiAgICBfdGVtcGxhdGVPYmplY3Q0ID0gZnVuY3Rpb24gX3RlbXBsYXRlT2JqZWN0NCgpIHsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwoKICAgIHJldHVybiBkYXRhOwogIH0KCiAgZnVuY3Rpb24gX3RlbXBsYXRlT2JqZWN0MygpIHsKICAgIHZhciBkYXRhID0gKDAsIF9lbWJlckJhYmVsLnRhZ2dlZFRlbXBsYXRlTGl0ZXJhbExvb3NlKShbInRlbXBsYXRlOmNvbXBvbmVudHMvLWRlZmF1bHQiXSk7CgogICAgX3RlbXBsYXRlT2JqZWN0MyA9IGZ1bmN0aW9uIF90ZW1wbGF0ZU9iamVjdDMoKSB7CiAgICAgIHJldHVybiBkYXRhOwogICAgfTsKCiAgICByZXR1cm4gZGF0YTsKICB9CgogIGZ1bmN0aW9uIF90ZW1wbGF0ZU9iamVjdDIoKSB7CiAgICB2YXIgZGF0YSA9ICgwLCBfZW1iZXJCYWJlbC50YWdnZWRUZW1wbGF0ZUxpdGVyYWxMb29zZSkoWyJ0ZW1wbGF0ZTpjb21wb25lbnRzLy1kZWZhdWx0Il0pOwoKICAgIF90ZW1wbGF0ZU9iamVjdDIgPSBmdW5jdGlvbiBfdGVtcGxhdGVPYmplY3QyKCkgewogICAgICByZXR1cm4gZGF0YTsKICAgIH07CgogICAgcmV0dXJuIGRhdGE7CiAgfQoKICBmdW5jdGlvbiBfdGVtcGxhdGVPYmplY3QoKSB7CiAgICB2YXIgZGF0YSA9ICgwLCBfZW1iZXJCYWJlbC50YWdnZWRUZW1wbGF0ZUxpdGVyYWxMb29zZSkoWyJ0ZW1wbGF0ZS1jb21waWxlcjptYWluIl0pOwoKICAgIF90ZW1wbGF0ZU9iamVjdCA9IGZ1bmN0aW9uIF90ZW1wbGF0ZU9iamVjdCgpIHsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwoKICAgIHJldHVybiBkYXRhOwogIH0KCiAgZnVuY3Rpb24gaXNUZW1wbGF0ZUZhY3RvcnkodGVtcGxhdGUpIHsKICAgIHJldHVybiB0eXBlb2YgdGVtcGxhdGUgPT09ICdmdW5jdGlvbic7CiAgfQoKICB2YXIgY291bnRlcnMgPSB7CiAgICBjYWNoZUhpdDogMCwKICAgIGNhY2hlTWlzczogMAogIH07CiAgX2V4cG9ydHMudGVtcGxhdGVDYWNoZUNvdW50ZXJzID0gY291bnRlcnM7CiAgdmFyIFRFTVBMQVRFX0NPTVBJTEVSX01BSU4gPSAoMCwgX2NvbnRhaW5lci5wcml2YXRpemUpKF90ZW1wbGF0ZU9iamVjdCgpKTsKCiAgZnVuY3Rpb24gdGVtcGxhdGUoanNvbikgewogICAgdmFyIGdsaW1tZXJGYWN0b3J5ID0gKDAsIF9vcGNvZGVDb21waWxlci50ZW1wbGF0ZUZhY3RvcnkpKGpzb24pOwogICAgdmFyIGNhY2hlID0gbmV3IFdlYWtNYXAoKTsKCiAgICB2YXIgZmFjdG9yeSA9IGZ1bmN0aW9uIGZhY3Rvcnkob3duZXIpIHsKICAgICAgdmFyIHJlc3VsdCA9IGNhY2hlLmdldChvd25lcik7CgogICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBjb3VudGVycy5jYWNoZU1pc3MrKzsKICAgICAgICB2YXIgY29tcGlsZXIgPSBvd25lci5sb29rdXAoVEVNUExBVEVfQ09NUElMRVJfTUFJTik7CiAgICAgICAgcmVzdWx0ID0gZ2xpbW1lckZhY3RvcnkuY3JlYXRlKGNvbXBpbGVyLCB7CiAgICAgICAgICBvd25lcjogb3duZXIKICAgICAgICB9KTsKICAgICAgICBjYWNoZS5zZXQob3duZXIsIHJlc3VsdCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY291bnRlcnMuY2FjaGVIaXQrKzsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CgogICAgZmFjdG9yeS5fX2lkID0gZ2xpbW1lckZhY3RvcnkuaWQ7CiAgICBmYWN0b3J5Ll9fbWV0YSA9IGdsaW1tZXJGYWN0b3J5Lm1ldGE7CiAgICByZXR1cm4gZmFjdG9yeTsKICB9CgogIHZhciBSb290VGVtcGxhdGUgPSB0ZW1wbGF0ZSh7CiAgICAiaWQiOiAiaGpoeFVvcnUiLAogICAgImJsb2NrIjogIntcInN5bWJvbHNcIjpbXSxcInN0YXRlbWVudHNcIjpbWzEsWzI4LFwiY29tcG9uZW50XCIsW1syMywwLFtdXV0sbnVsbF0sZmFsc2VdXSxcImhhc0V2YWxcIjpmYWxzZX0iLAogICAgIm1ldGEiOiB7CiAgICAgICJtb2R1bGVOYW1lIjogInBhY2thZ2VzL0BlbWJlci8taW50ZXJuYWxzL2dsaW1tZXIvbGliL3RlbXBsYXRlcy9yb290LmhicyIKICAgIH0KICB9KTsKICAvKioKICBAbW9kdWxlIEBlbWJlci9jb21wb25lbnQKICAqLwoKICBfZXhwb3J0cy5Sb290VGVtcGxhdGUgPSBSb290VGVtcGxhdGU7CiAgdmFyIFJFQ09NUFVURV9UQUcgPSAoMCwgX3V0aWxzLnN5bWJvbCkoJ1JFQ09NUFVURV9UQUcnKTsKCiAgZnVuY3Rpb24gaXNIZWxwZXJGYWN0b3J5KGhlbHBlcikgewogICAgcmV0dXJuIHR5cGVvZiBoZWxwZXIgPT09ICdvYmplY3QnICYmIGhlbHBlciAhPT0gbnVsbCAmJiBoZWxwZXIuY2xhc3MgJiYgaGVscGVyLmNsYXNzLmlzSGVscGVyRmFjdG9yeTsKICB9CgogIGZ1bmN0aW9uIGlzU2ltcGxlSGVscGVyKGhlbHBlcikgewogICAgcmV0dXJuIGhlbHBlci5kZXN0cm95ID09PSB1bmRlZmluZWQ7CiAgfQogIC8qKgogICAgRW1iZXIgSGVscGVycyBhcmUgZnVuY3Rpb25zIHRoYXQgY2FuIGNvbXB1dGUgdmFsdWVzLCBhbmQgYXJlIHVzZWQgaW4gdGVtcGxhdGVzLgogICAgRm9yIGV4YW1wbGUsIHRoaXMgY29kZSBjYWxscyBhIGhlbHBlciBuYW1lZCBgZm9ybWF0LWN1cnJlbmN5YDoKICAKICAgIGBgYGFwcC90ZW1wbGF0ZXMvYXBwbGljYXRpb24uaGJzCiAgICA8Q29zdCBAY2VudHM9e3syMzB9fSAvPgogICAgYGBgCiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9jb3N0LmhicwogICAgPGRpdj57e2Zvcm1hdC1jdXJyZW5jeSBAY2VudHMgY3VycmVuY3k9IiQifX08L2Rpdj4KICAgIGBgYAogIAogICAgQWRkaXRpb25hbGx5IGEgaGVscGVyIGNhbiBiZSBjYWxsZWQgYXMgYSBuZXN0ZWQgaGVscGVyLgogICAgSW4gdGhpcyBleGFtcGxlLCB3ZSBzaG93IHRoZSBmb3JtYXR0ZWQgY3VycmVuY3kgdmFsdWUgaWYgdGhlIGBzaG93TW9uZXlgCiAgICBuYW1lZCBhcmd1bWVudCBpcyB0cnV0aHkuCiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7e2lmIEBzaG93TW9uZXkgKGZvcm1hdC1jdXJyZW5jeSBAY2VudHMgY3VycmVuY3k9IiQiKX19CiAgICBgYGAKICAKICAgIEhlbHBlcnMgZGVmaW5lZCB1c2luZyBhIGNsYXNzIG11c3QgcHJvdmlkZSBhIGBjb21wdXRlYCBmdW5jdGlvbi4gRm9yIGV4YW1wbGU6CiAgCiAgICBgYGBhcHAvaGVscGVycy9mb3JtYXQtY3VycmVuY3kuanMKICAgIGltcG9ydCBIZWxwZXIgZnJvbSAnQGVtYmVyL2NvbXBvbmVudC9oZWxwZXInOwogIAogICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgZXh0ZW5kcyBIZWxwZXIgewogICAgICBjb21wdXRlKFtjZW50c10sIHsgY3VycmVuY3kgfSkgewogICAgICAgIHJldHVybiBgJHtjdXJyZW5jeX0ke2NlbnRzICogMC4wMX1gOwogICAgICB9CiAgICB9CiAgICBgYGAKICAKICAgIEVhY2ggdGltZSB0aGUgaW5wdXQgdG8gYSBoZWxwZXIgY2hhbmdlcywgdGhlIGBjb21wdXRlYCBmdW5jdGlvbiB3aWxsIGJlCiAgICBjYWxsZWQgYWdhaW4uCiAgCiAgICBBcyBpbnN0YW5jZXMsIHRoZXNlIGhlbHBlcnMgYWxzbyBoYXZlIGFjY2VzcyB0byB0aGUgY29udGFpbmVyIGFuZCB3aWxsIGFjY2VwdAogICAgaW5qZWN0ZWQgZGVwZW5kZW5jaWVzLgogIAogICAgQWRkaXRpb25hbGx5LCBjbGFzcyBoZWxwZXJzIGNhbiBjYWxsIGByZWNvbXB1dGVgIHRvIGZvcmNlIGEgbmV3IGNvbXB1dGF0aW9uLgogIAogICAgQGNsYXNzIEhlbHBlcgogICAgQHB1YmxpYwogICAgQHNpbmNlIDEuMTMuMAogICovCgoKICB2YXIgSGVscGVyID0gX3J1bnRpbWUuRnJhbWV3b3JrT2JqZWN0LmV4dGVuZCh7CiAgICBpbml0OiBmdW5jdGlvbiBpbml0KCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgdGhpc1tSRUNPTVBVVEVfVEFHXSA9ICgwLCBfcmVmZXJlbmNlLmNyZWF0ZVRhZykoKTsKICAgIH0sCgogICAgLyoqCiAgICAgIE9uIGEgY2xhc3MtYmFzZWQgaGVscGVyLCBpdCBtYXkgYmUgdXNlZnVsIHRvIGZvcmNlIGEgcmVjb21wdXRhdGlvbiBvZiB0aGF0CiAgICAgIGhlbHBlcnMgdmFsdWUuIFRoaXMgaXMgYWtpbiB0byBgcmVyZW5kZXJgIG9uIGEgY29tcG9uZW50LgogICAgICAgICBGb3IgZXhhbXBsZSwgdGhpcyBjb21wb25lbnQgd2lsbCByZXJlbmRlciB3aGVuIHRoZSBgY3VycmVudFVzZXJgIG9uIGEKICAgICAgc2Vzc2lvbiBzZXJ2aWNlIGNoYW5nZXM6CiAgICAgICAgIGBgYGFwcC9oZWxwZXJzL2N1cnJlbnQtdXNlci1lbWFpbC5qcwogICAgICBpbXBvcnQgSGVscGVyIGZyb20gJ0BlbWJlci9jb21wb25lbnQvaGVscGVyJwogICAgICBpbXBvcnQgeyBpbmplY3QgYXMgc2VydmljZSB9IGZyb20gJ0BlbWJlci9zZXJ2aWNlJwogICAgICBpbXBvcnQgeyBvYnNlcnZlciB9IGZyb20gJ0BlbWJlci9vYmplY3QnCiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IEhlbHBlci5leHRlbmQoewogICAgICAgIHNlc3Npb246IHNlcnZpY2UoKSwKICAgICAgICAgICBvbk5ld1VzZXI6IG9ic2VydmVyKCdzZXNzaW9uLmN1cnJlbnRVc2VyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLnJlY29tcHV0ZSgpOwogICAgICAgIH0pLAogICAgICAgICAgIGNvbXB1dGUoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5nZXQoJ3Nlc3Npb24uY3VycmVudFVzZXIuZW1haWwnKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgICAgQG1ldGhvZCByZWNvbXB1dGUKICAgICAgQHB1YmxpYwogICAgICBAc2luY2UgMS4xMy4wCiAgICAqLwogICAgcmVjb21wdXRlOiBmdW5jdGlvbiByZWNvbXB1dGUoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAoMCwgX3J1bmxvb3Auam9pbikoZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAoMCwgX3JlZmVyZW5jZS5kaXJ0eSkoX3RoaXNbUkVDT01QVVRFX1RBR10pOwogICAgICB9KTsKICAgIH0KICB9KTsKCiAgX2V4cG9ydHMuSGVscGVyID0gSGVscGVyOwogIEhlbHBlci5pc0hlbHBlckZhY3RvcnkgPSB0cnVlOwogICgwLCBfcnVudGltZS5zZXRGcmFtZXdvcmtDbGFzcykoSGVscGVyKTsKCiAgdmFyIFdyYXBwZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBXcmFwcGVyKGNvbXB1dGUpIHsKICAgICAgdGhpcy5jb21wdXRlID0gY29tcHV0ZTsKICAgICAgdGhpcy5pc0hlbHBlckZhY3RvcnkgPSB0cnVlOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBXcmFwcGVyLnByb3RvdHlwZTsKCiAgICBfcHJvdG8uY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKCkgewogICAgICAvLyBuZWVkcyBuZXcgaW5zdGFuY2Ugb3Igd2lsbCBsZWFrIGNvbnRhaW5lcnMKICAgICAgcmV0dXJuIHsKICAgICAgICBjb21wdXRlOiB0aGlzLmNvbXB1dGUKICAgICAgfTsKICAgIH07CgogICAgcmV0dXJuIFdyYXBwZXI7CiAgfSgpOwogIC8qKgogICAgSW4gbWFueSBjYXNlcyBpdCBpcyBub3QgbmVjZXNzYXJ5IHRvIHVzZSB0aGUgZnVsbCBgSGVscGVyYCBjbGFzcy4KICAgIFRoZSBgaGVscGVyYCBtZXRob2QgY3JlYXRlIHB1cmUtZnVuY3Rpb24gaGVscGVycyB3aXRob3V0IGluc3RhbmNlcy4KICAgIEZvciBleGFtcGxlOgogIAogICAgYGBgYXBwL2hlbHBlcnMvZm9ybWF0LWN1cnJlbmN5LmpzCiAgICBpbXBvcnQgeyBoZWxwZXIgfSBmcm9tICdAZW1iZXIvY29tcG9uZW50L2hlbHBlcic7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBoZWxwZXIoZnVuY3Rpb24oW2NlbnRzXSwge2N1cnJlbmN5fSkgewogICAgICByZXR1cm4gYCR7Y3VycmVuY3l9JHtjZW50cyAqIDAuMDF9YDsKICAgIH0pOwogICAgYGBgCiAgCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBoZWxwZXIgVGhlIGhlbHBlciBmdW5jdGlvbgogICAgQG1ldGhvZCBoZWxwZXIKICAgIEBmb3IgQGVtYmVyL2NvbXBvbmVudC9oZWxwZXIKICAgIEBwdWJsaWMKICAgIEBzaW5jZSAxLjEzLjAKICAqLwoKCiAgZnVuY3Rpb24gaGVscGVyKGhlbHBlckZuKSB7CiAgICByZXR1cm4gbmV3IFdyYXBwZXIoaGVscGVyRm4pOwogIH0KCiAgZnVuY3Rpb24gX3RvQm9vbChwcmVkaWNhdGUpIHsKICAgIGlmICgoMCwgX3J1bnRpbWUuaXNBcnJheSkocHJlZGljYXRlKSkgewogICAgICByZXR1cm4gcHJlZGljYXRlLmxlbmd0aCAhPT0gMDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBCb29sZWFuKHByZWRpY2F0ZSk7CiAgICB9CiAgfQoKICB2YXIgVVBEQVRFID0gKDAsIF91dGlscy5zeW1ib2wpKCdVUERBVEUnKTsKICB2YXIgSU5WT0tFID0gKDAsIF91dGlscy5zeW1ib2wpKCdJTlZPS0UnKTsKICBfZXhwb3J0cy5JTlZPS0UgPSBJTlZPS0U7CiAgdmFyIEFDVElPTiA9ICgwLCBfdXRpbHMuc3ltYm9sKSgnQUNUSU9OJyk7CgogIHZhciBFbWJlclBhdGhSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBFbWJlclBhdGhSZWZlcmVuY2UoKSB7fQoKICAgIHZhciBfcHJvdG8yID0gRW1iZXJQYXRoUmVmZXJlbmNlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8yLmdldCA9IGZ1bmN0aW9uIGdldChrZXkpIHsKICAgICAgcmV0dXJuIFByb3BlcnR5UmVmZXJlbmNlLmNyZWF0ZSh0aGlzLCBrZXkpOwogICAgfTsKCiAgICByZXR1cm4gRW1iZXJQYXRoUmVmZXJlbmNlOwogIH0oKTsKCiAgdmFyIENhY2hlZFJlZmVyZW5jZSQxID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9FbWJlclBhdGhSZWZlcmVuY2UpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShDYWNoZWRSZWZlcmVuY2UkMSwgX0VtYmVyUGF0aFJlZmVyZW5jZSk7CgogICAgZnVuY3Rpb24gQ2FjaGVkUmVmZXJlbmNlJDEoKSB7CiAgICAgIHZhciBfdGhpczI7CgogICAgICBfdGhpczIgPSBfRW1iZXJQYXRoUmVmZXJlbmNlLmNhbGwodGhpcykgfHwgdGhpczsKICAgICAgX3RoaXMyLmxhc3RSZXZpc2lvbiA9IG51bGw7CiAgICAgIF90aGlzMi5sYXN0VmFsdWUgPSBudWxsOwogICAgICByZXR1cm4gX3RoaXMyOwogICAgfQoKICAgIHZhciBfcHJvdG8zID0gQ2FjaGVkUmVmZXJlbmNlJDEucHJvdG90eXBlOwoKICAgIF9wcm90bzMudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdmFyIHRhZyA9IHRoaXMudGFnLAogICAgICAgICAgbGFzdFJldmlzaW9uID0gdGhpcy5sYXN0UmV2aXNpb24sCiAgICAgICAgICBsYXN0VmFsdWUgPSB0aGlzLmxhc3RWYWx1ZTsKCiAgICAgIGlmIChsYXN0UmV2aXNpb24gPT09IG51bGwgfHwgISgwLCBfcmVmZXJlbmNlLnZhbGlkYXRlKSh0YWcsIGxhc3RSZXZpc2lvbikpIHsKICAgICAgICBsYXN0VmFsdWUgPSB0aGlzLmxhc3RWYWx1ZSA9IHRoaXMuY29tcHV0ZSgpOwogICAgICAgIHRoaXMubGFzdFJldmlzaW9uID0gKDAsIF9yZWZlcmVuY2UudmFsdWUpKHRhZyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBsYXN0VmFsdWU7CiAgICB9OwoKICAgIHJldHVybiBDYWNoZWRSZWZlcmVuY2UkMTsKICB9KEVtYmVyUGF0aFJlZmVyZW5jZSk7CgogIHZhciBSb290UmVmZXJlbmNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9Db25zdFJlZmVyZW5jZSkgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKFJvb3RSZWZlcmVuY2UsIF9Db25zdFJlZmVyZW5jZSk7CgogICAgZnVuY3Rpb24gUm9vdFJlZmVyZW5jZSh2YWx1ZSQkMSkgewogICAgICB2YXIgX3RoaXMzOwoKICAgICAgX3RoaXMzID0gX0NvbnN0UmVmZXJlbmNlLmNhbGwodGhpcywgdmFsdWUkJDEpIHx8IHRoaXM7CiAgICAgIF90aGlzMy5jaGlsZHJlbiA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHJldHVybiBfdGhpczM7CiAgICB9CgogICAgUm9vdFJlZmVyZW5jZS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUodmFsdWUkJDEpIHsKICAgICAgcmV0dXJuIHZhbHVlVG9SZWYodmFsdWUkJDEpOwogICAgfTsKCiAgICB2YXIgX3Byb3RvNCA9IFJvb3RSZWZlcmVuY2UucHJvdG90eXBlOwoKICAgIF9wcm90bzQuZ2V0ID0gZnVuY3Rpb24gZ2V0KHByb3BlcnR5S2V5KSB7CiAgICAgIHZhciByZWYgPSB0aGlzLmNoaWxkcmVuW3Byb3BlcnR5S2V5XTsKCiAgICAgIGlmIChyZWYgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJlZiA9IHRoaXMuY2hpbGRyZW5bcHJvcGVydHlLZXldID0gbmV3IFJvb3RQcm9wZXJ0eVJlZmVyZW5jZSh0aGlzLmlubmVyLCBwcm9wZXJ0eUtleSk7CiAgICAgIH0KCiAgICAgIHJldHVybiByZWY7CiAgICB9OwoKICAgIHJldHVybiBSb290UmVmZXJlbmNlOwogIH0oX3JlZmVyZW5jZS5Db25zdFJlZmVyZW5jZSk7CgogIHZhciBUd29XYXlGbHVzaERldGVjdGlvblRhZzsKCiAgaWYgKGZhbHNlCiAgLyogREVCVUcgKi8KICApIHsKICAgIFR3b1dheUZsdXNoRGV0ZWN0aW9uVGFnID0KICAgIC8qI19fUFVSRV9fKi8KICAgIGZ1bmN0aW9uICgpIHsKICAgICAgZnVuY3Rpb24gVHdvV2F5Rmx1c2hEZXRlY3Rpb25UYWcodGFnLCBrZXksIHJlZikgewogICAgICAgIHRoaXMudGFnID0gdGFnOwogICAgICAgIHRoaXMua2V5ID0ga2V5OwogICAgICAgIHRoaXMucmVmID0gcmVmOwogICAgICB9CgogICAgICBUd29XYXlGbHVzaERldGVjdGlvblRhZy5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUodGFnLCBrZXksIHJlZikgewogICAgICAgIHJldHVybiBuZXcgVHdvV2F5Rmx1c2hEZXRlY3Rpb25UYWcodGFnLCBrZXksIHJlZik7CiAgICAgIH07CgogICAgICB2YXIgX3Byb3RvNSA9IFR3b1dheUZsdXNoRGV0ZWN0aW9uVGFnLnByb3RvdHlwZTsKCiAgICAgIF9wcm90bzVbX3JlZmVyZW5jZS5DT01QVVRFXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy50YWdbX3JlZmVyZW5jZS5DT01QVVRFXSgpOwogICAgICB9OwoKICAgICAgX3Byb3RvNS5kaWRDb21wdXRlID0gZnVuY3Rpb24gZGlkQ29tcHV0ZShwYXJlbnQpIHsKICAgICAgICAoMCwgX21ldGFsLmRpZFJlbmRlcikocGFyZW50LCB0aGlzLmtleSwgdGhpcy5yZWYpOwogICAgICB9OwoKICAgICAgcmV0dXJuIFR3b1dheUZsdXNoRGV0ZWN0aW9uVGFnOwogICAgfSgpOwogIH0KCiAgdmFyIFByb3BlcnR5UmVmZXJlbmNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9DYWNoZWRSZWZlcmVuY2UkKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoUHJvcGVydHlSZWZlcmVuY2UsIF9DYWNoZWRSZWZlcmVuY2UkKTsKCiAgICBmdW5jdGlvbiBQcm9wZXJ0eVJlZmVyZW5jZSgpIHsKICAgICAgcmV0dXJuIF9DYWNoZWRSZWZlcmVuY2UkLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgIH0KCiAgICBQcm9wZXJ0eVJlZmVyZW5jZS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUocGFyZW50UmVmZXJlbmNlLCBwcm9wZXJ0eUtleSkgewogICAgICBpZiAoKDAsIF9yZWZlcmVuY2UuaXNDb25zdCkocGFyZW50UmVmZXJlbmNlKSkgewogICAgICAgIHJldHVybiB2YWx1ZUtleVRvUmVmKHBhcmVudFJlZmVyZW5jZS52YWx1ZSgpLCBwcm9wZXJ0eUtleSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG5ldyBOZXN0ZWRQcm9wZXJ0eVJlZmVyZW5jZShwYXJlbnRSZWZlcmVuY2UsIHByb3BlcnR5S2V5KTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgX3Byb3RvNiA9IFByb3BlcnR5UmVmZXJlbmNlLnByb3RvdHlwZTsKCiAgICBfcHJvdG82LmdldCA9IGZ1bmN0aW9uIGdldChrZXkpIHsKICAgICAgcmV0dXJuIG5ldyBOZXN0ZWRQcm9wZXJ0eVJlZmVyZW5jZSh0aGlzLCBrZXkpOwogICAgfTsKCiAgICByZXR1cm4gUHJvcGVydHlSZWZlcmVuY2U7CiAgfShDYWNoZWRSZWZlcmVuY2UkMSk7CgogIHZhciBSb290UHJvcGVydHlSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX1Byb3BlcnR5UmVmZXJlbmNlKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoUm9vdFByb3BlcnR5UmVmZXJlbmNlLCBfUHJvcGVydHlSZWZlcmVuY2UpOwoKICAgIGZ1bmN0aW9uIFJvb3RQcm9wZXJ0eVJlZmVyZW5jZShwYXJlbnRWYWx1ZSwgcHJvcGVydHlLZXkpIHsKICAgICAgdmFyIF90aGlzNDsKCiAgICAgIF90aGlzNCA9IF9Qcm9wZXJ0eVJlZmVyZW5jZS5jYWxsKHRoaXMpIHx8IHRoaXM7CiAgICAgIF90aGlzNC5wYXJlbnRWYWx1ZSA9IHBhcmVudFZhbHVlOwogICAgICBfdGhpczQucHJvcGVydHlLZXkgPSBwcm9wZXJ0eUtleTsKICAgICAgewogICAgICAgIF90aGlzNC5wcm9wZXJ0eVRhZyA9ICgwLCBfcmVmZXJlbmNlLmNyZWF0ZVVwZGF0YWJsZVRhZykoKTsKICAgICAgfQoKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICkgewogICAgICAgIF90aGlzNC50YWcgPSBUd29XYXlGbHVzaERldGVjdGlvblRhZy5jcmVhdGUoX3RoaXM0LnByb3BlcnR5VGFnLCBwcm9wZXJ0eUtleSwgKDAsIF9lbWJlckJhYmVsLmFzc2VydFRoaXNJbml0aWFsaXplZCkoX3RoaXM0KSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgX3RoaXM0LnRhZyA9IF90aGlzNC5wcm9wZXJ0eVRhZzsKICAgICAgfQoKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICYmICF0cnVlCiAgICAgIC8qIEVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyAqLwogICAgICApIHsKICAgICAgICAgICgwLCBfbWV0YWwud2F0Y2hLZXkpKHBhcmVudFZhbHVlLCBwcm9wZXJ0eUtleSk7CiAgICAgICAgfQoKICAgICAgcmV0dXJuIF90aGlzNDsKICAgIH0KCiAgICB2YXIgX3Byb3RvNyA9IFJvb3RQcm9wZXJ0eVJlZmVyZW5jZS5wcm90b3R5cGU7CgogICAgX3Byb3RvNy5jb21wdXRlID0gZnVuY3Rpb24gY29tcHV0ZSgpIHsKICAgICAgdmFyIHBhcmVudFZhbHVlID0gdGhpcy5wYXJlbnRWYWx1ZSwKICAgICAgICAgIHByb3BlcnR5S2V5ID0gdGhpcy5wcm9wZXJ0eUtleTsKCiAgICAgIGlmIChmYWxzZQogICAgICAvKiBERUJVRyAqLwogICAgICApIHsKICAgICAgICB0aGlzLnRhZy5kaWRDb21wdXRlKHBhcmVudFZhbHVlKTsKICAgICAgfQoKICAgICAgdmFyIHJldDsKICAgICAgewogICAgICAgIHZhciB0YWcgPSAoMCwgX21ldGFsLnRyYWNrKShmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXQgPSAoMCwgX21ldGFsLmdldCkocGFyZW50VmFsdWUsIHByb3BlcnR5S2V5KTsKICAgICAgICB9KTsKICAgICAgICAoMCwgX21ldGFsLmNvbnN1bWUpKHRhZyk7CiAgICAgICAgKDAsIF9yZWZlcmVuY2UudXBkYXRlKSh0aGlzLnByb3BlcnR5VGFnLCB0YWcpOwogICAgICB9CiAgICAgIHJldHVybiByZXQ7CiAgICB9OwoKICAgIF9wcm90bzdbVVBEQVRFXSA9IGZ1bmN0aW9uICh2YWx1ZSQkMSkgewogICAgICAoMCwgX21ldGFsLnNldCkodGhpcy5wYXJlbnRWYWx1ZSwgdGhpcy5wcm9wZXJ0eUtleSwgdmFsdWUkJDEpOwogICAgfTsKCiAgICByZXR1cm4gUm9vdFByb3BlcnR5UmVmZXJlbmNlOwogIH0oUHJvcGVydHlSZWZlcmVuY2UpOwoKICBpZiAoZmFsc2UKICAvKiBERUJVRyAqLwogICkgewogICAgUm9vdFByb3BlcnR5UmVmZXJlbmNlLnByb3RvdHlwZVsnZGVidWcnXSA9IGZ1bmN0aW9uIGRlYnVnKCkgewogICAgICByZXR1cm4gInRoaXMuIiArIHRoaXNbJ3Byb3BlcnR5S2V5J107CiAgICB9OwogIH0KCiAgdmFyIE5lc3RlZFByb3BlcnR5UmVmZXJlbmNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9Qcm9wZXJ0eVJlZmVyZW5jZTIpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShOZXN0ZWRQcm9wZXJ0eVJlZmVyZW5jZSwgX1Byb3BlcnR5UmVmZXJlbmNlMik7CgogICAgZnVuY3Rpb24gTmVzdGVkUHJvcGVydHlSZWZlcmVuY2UocGFyZW50UmVmZXJlbmNlLCBwcm9wZXJ0eUtleSkgewogICAgICB2YXIgX3RoaXM1OwoKICAgICAgX3RoaXM1ID0gX1Byb3BlcnR5UmVmZXJlbmNlMi5jYWxsKHRoaXMpIHx8IHRoaXM7CiAgICAgIF90aGlzNS5wYXJlbnRSZWZlcmVuY2UgPSBwYXJlbnRSZWZlcmVuY2U7CiAgICAgIF90aGlzNS5wcm9wZXJ0eUtleSA9IHByb3BlcnR5S2V5OwogICAgICB2YXIgcGFyZW50UmVmZXJlbmNlVGFnID0gcGFyZW50UmVmZXJlbmNlLnRhZzsKICAgICAgdmFyIHByb3BlcnR5VGFnID0gX3RoaXM1LnByb3BlcnR5VGFnID0gKDAsIF9yZWZlcmVuY2UuY3JlYXRlVXBkYXRhYmxlVGFnKSgpOwoKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICkgewogICAgICAgIHZhciB0YWcgPSAoMCwgX3JlZmVyZW5jZS5jb21iaW5lKShbcGFyZW50UmVmZXJlbmNlVGFnLCBwcm9wZXJ0eVRhZ10pOwogICAgICAgIF90aGlzNS50YWcgPSBUd29XYXlGbHVzaERldGVjdGlvblRhZy5jcmVhdGUodGFnLCBwcm9wZXJ0eUtleSwgKDAsIF9lbWJlckJhYmVsLmFzc2VydFRoaXNJbml0aWFsaXplZCkoX3RoaXM1KSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgX3RoaXM1LnRhZyA9ICgwLCBfcmVmZXJlbmNlLmNvbWJpbmUpKFtwYXJlbnRSZWZlcmVuY2VUYWcsIHByb3BlcnR5VGFnXSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBfdGhpczU7CiAgICB9CgogICAgdmFyIF9wcm90bzggPSBOZXN0ZWRQcm9wZXJ0eVJlZmVyZW5jZS5wcm90b3R5cGU7CgogICAgX3Byb3RvOC5jb21wdXRlID0gZnVuY3Rpb24gY29tcHV0ZSgpIHsKICAgICAgdmFyIHBhcmVudFJlZmVyZW5jZSA9IHRoaXMucGFyZW50UmVmZXJlbmNlLAogICAgICAgICAgcHJvcGVydHlUYWcgPSB0aGlzLnByb3BlcnR5VGFnLAogICAgICAgICAgcHJvcGVydHlLZXkgPSB0aGlzLnByb3BlcnR5S2V5OwoKICAgICAgdmFyIF9wYXJlbnRWYWx1ZSA9IHBhcmVudFJlZmVyZW5jZS52YWx1ZSgpOwoKICAgICAgdmFyIHBhcmVudFZhbHVlVHlwZSA9IHR5cGVvZiBfcGFyZW50VmFsdWU7CgogICAgICBpZiAocGFyZW50VmFsdWVUeXBlID09PSAnc3RyaW5nJyAmJiBwcm9wZXJ0eUtleSA9PT0gJ2xlbmd0aCcpIHsKICAgICAgICByZXR1cm4gX3BhcmVudFZhbHVlLmxlbmd0aDsKICAgICAgfQoKICAgICAgaWYgKHBhcmVudFZhbHVlVHlwZSA9PT0gJ29iamVjdCcgJiYgX3BhcmVudFZhbHVlICE9PSBudWxsIHx8IHBhcmVudFZhbHVlVHlwZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHZhciBwYXJlbnRWYWx1ZSA9IF9wYXJlbnRWYWx1ZTsKCiAgICAgICAgaWYgKGZhbHNlCiAgICAgICAgLyogREVCVUcgKi8KICAgICAgICAmJiAhdHJ1ZQogICAgICAgIC8qIEVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyAqLwogICAgICAgICkgewogICAgICAgICAgICAoMCwgX21ldGFsLndhdGNoS2V5KShwYXJlbnRWYWx1ZSwgcHJvcGVydHlLZXkpOwogICAgICAgICAgfQoKICAgICAgICBpZiAoZmFsc2UKICAgICAgICAvKiBERUJVRyAqLwogICAgICAgICkgewogICAgICAgICAgdGhpcy50YWcuZGlkQ29tcHV0ZShwYXJlbnRWYWx1ZSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgcmV0OwogICAgICAgIHsKICAgICAgICAgIHZhciB0YWcgPSAoMCwgX21ldGFsLnRyYWNrKShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldCA9ICgwLCBfbWV0YWwuZ2V0KShwYXJlbnRWYWx1ZSwgcHJvcGVydHlLZXkpOwogICAgICAgICAgfSk7CiAgICAgICAgICAoMCwgX21ldGFsLmNvbnN1bWUpKHRhZyk7CiAgICAgICAgICAoMCwgX3JlZmVyZW5jZS51cGRhdGUpKHByb3BlcnR5VGFnLCB0YWcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvOFtVUERBVEVdID0gZnVuY3Rpb24gKHZhbHVlJCQxKSB7CiAgICAgICgwLCBfbWV0YWwuc2V0KSh0aGlzLnBhcmVudFJlZmVyZW5jZS52YWx1ZSgpCiAgICAgIC8qIGxldCB0aGUgb3RoZXIgc2lkZSBoYW5kbGUgdGhlIGVycm9yICovCiAgICAgICwgdGhpcy5wcm9wZXJ0eUtleSwgdmFsdWUkJDEpOwogICAgfTsKCiAgICByZXR1cm4gTmVzdGVkUHJvcGVydHlSZWZlcmVuY2U7CiAgfShQcm9wZXJ0eVJlZmVyZW5jZSk7CgogIGlmIChmYWxzZQogIC8qIERFQlVHICovCiAgKSB7CiAgICBOZXN0ZWRQcm9wZXJ0eVJlZmVyZW5jZS5wcm90b3R5cGVbJ2RlYnVnJ10gPSBmdW5jdGlvbiBkZWJ1ZygpIHsKICAgICAgdmFyIHBhcmVudCA9IHRoaXNbJ3BhcmVudFJlZmVyZW5jZSddOwogICAgICB2YXIgcGFyZW50S2V5ID0gJ3Vua25vd25PYmplY3QnOwogICAgICB2YXIgc2VsZktleSA9IHRoaXNbJ3Byb3BlcnR5S2V5J107CgogICAgICBpZiAodHlwZW9mIHBhcmVudFsnZGVidWcnXSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHBhcmVudEtleSA9IHBhcmVudFsnZGVidWcnXSgpOwogICAgICB9CgogICAgICByZXR1cm4gcGFyZW50S2V5ICsgIi4iICsgc2VsZktleTsKICAgIH07CiAgfQoKICB2YXIgVXBkYXRhYmxlUmVmZXJlbmNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9FbWJlclBhdGhSZWZlcmVuY2UyKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoVXBkYXRhYmxlUmVmZXJlbmNlLCBfRW1iZXJQYXRoUmVmZXJlbmNlMik7CgogICAgZnVuY3Rpb24gVXBkYXRhYmxlUmVmZXJlbmNlKHZhbHVlJCQxKSB7CiAgICAgIHZhciBfdGhpczY7CgogICAgICBfdGhpczYgPSBfRW1iZXJQYXRoUmVmZXJlbmNlMi5jYWxsKHRoaXMpIHx8IHRoaXM7CiAgICAgIF90aGlzNi50YWcgPSAoMCwgX3JlZmVyZW5jZS5jcmVhdGVUYWcpKCk7CiAgICAgIF90aGlzNi5fdmFsdWUgPSB2YWx1ZSQkMTsKICAgICAgcmV0dXJuIF90aGlzNjsKICAgIH0KCiAgICB2YXIgX3Byb3RvOSA9IFVwZGF0YWJsZVJlZmVyZW5jZS5wcm90b3R5cGU7CgogICAgX3Byb3RvOS52YWx1ZSA9IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICByZXR1cm4gdGhpcy5fdmFsdWU7CiAgICB9OwoKICAgIF9wcm90bzkudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlKHZhbHVlJCQxKSB7CiAgICAgIHZhciBfdmFsdWUgPSB0aGlzLl92YWx1ZTsKCiAgICAgIGlmICh2YWx1ZSQkMSAhPT0gX3ZhbHVlKSB7CiAgICAgICAgKDAsIF9yZWZlcmVuY2UuZGlydHkpKHRoaXMudGFnKTsKICAgICAgICB0aGlzLl92YWx1ZSA9IHZhbHVlJCQxOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBVcGRhdGFibGVSZWZlcmVuY2U7CiAgfShFbWJlclBhdGhSZWZlcmVuY2UpOwoKICBfZXhwb3J0cy5VcGRhdGFibGVSZWZlcmVuY2UgPSBVcGRhdGFibGVSZWZlcmVuY2U7CgogIHZhciBDb25kaXRpb25hbFJlZmVyZW5jZSQxID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9Db25kaXRpb25hbFJlZmVyZW5jZSkgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKENvbmRpdGlvbmFsUmVmZXJlbmNlJDEsIF9Db25kaXRpb25hbFJlZmVyZW5jZSk7CgogICAgQ29uZGl0aW9uYWxSZWZlcmVuY2UkMS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUocmVmZXJlbmNlKSB7CiAgICAgIGlmICgoMCwgX3JlZmVyZW5jZS5pc0NvbnN0KShyZWZlcmVuY2UpKSB7CiAgICAgICAgdmFyIHZhbHVlJCQxID0gcmVmZXJlbmNlLnZhbHVlKCk7CgogICAgICAgIGlmICghKDAsIF91dGlscy5pc1Byb3h5KSh2YWx1ZSQkMSkpIHsKICAgICAgICAgIHJldHVybiBfcnVudGltZTIuUHJpbWl0aXZlUmVmZXJlbmNlLmNyZWF0ZShfdG9Cb29sKHZhbHVlJCQxKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gbmV3IENvbmRpdGlvbmFsUmVmZXJlbmNlJDEocmVmZXJlbmNlKTsKICAgIH07CgogICAgZnVuY3Rpb24gQ29uZGl0aW9uYWxSZWZlcmVuY2UkMShyZWZlcmVuY2UpIHsKICAgICAgdmFyIF90aGlzNzsKCiAgICAgIF90aGlzNyA9IF9Db25kaXRpb25hbFJlZmVyZW5jZS5jYWxsKHRoaXMsIHJlZmVyZW5jZSkgfHwgdGhpczsKICAgICAgX3RoaXM3Lm9iamVjdFRhZyA9ICgwLCBfcmVmZXJlbmNlLmNyZWF0ZVVwZGF0YWJsZVRhZykoKTsKICAgICAgX3RoaXM3LnRhZyA9ICgwLCBfcmVmZXJlbmNlLmNvbWJpbmUpKFtyZWZlcmVuY2UudGFnLCBfdGhpczcub2JqZWN0VGFnXSk7CiAgICAgIHJldHVybiBfdGhpczc7CiAgICB9CgogICAgdmFyIF9wcm90bzEwID0gQ29uZGl0aW9uYWxSZWZlcmVuY2UkMS5wcm90b3R5cGU7CgogICAgX3Byb3RvMTAudG9Cb29sID0gZnVuY3Rpb24gdG9Cb29sKHByZWRpY2F0ZSkgewogICAgICBpZiAoKDAsIF91dGlscy5pc1Byb3h5KShwcmVkaWNhdGUpKSB7CiAgICAgICAgKDAsIF9yZWZlcmVuY2UudXBkYXRlKSh0aGlzLm9iamVjdFRhZywgKDAsIF9tZXRhbC50YWdGb3JQcm9wZXJ0eSkocHJlZGljYXRlLCAnaXNUcnV0aHknKSk7CiAgICAgICAgcmV0dXJuIEJvb2xlYW4oKDAsIF9tZXRhbC5nZXQpKHByZWRpY2F0ZSwgJ2lzVHJ1dGh5JykpOwogICAgICB9IGVsc2UgewogICAgICAgICgwLCBfcmVmZXJlbmNlLnVwZGF0ZSkodGhpcy5vYmplY3RUYWcsICgwLCBfbWV0YWwudGFnRm9yKShwcmVkaWNhdGUpKTsKICAgICAgICByZXR1cm4gX3RvQm9vbChwcmVkaWNhdGUpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBDb25kaXRpb25hbFJlZmVyZW5jZSQxOwogIH0oX3J1bnRpbWUyLkNvbmRpdGlvbmFsUmVmZXJlbmNlKTsKCiAgdmFyIFNpbXBsZUhlbHBlclJlZmVyZW5jZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfQ2FjaGVkUmVmZXJlbmNlJDIpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShTaW1wbGVIZWxwZXJSZWZlcmVuY2UsIF9DYWNoZWRSZWZlcmVuY2UkMik7CgogICAgZnVuY3Rpb24gU2ltcGxlSGVscGVyUmVmZXJlbmNlKGhlbHBlciQkMSwgYXJncykgewogICAgICB2YXIgX3RoaXM4OwoKICAgICAgX3RoaXM4ID0gX0NhY2hlZFJlZmVyZW5jZSQyLmNhbGwodGhpcykgfHwgdGhpczsKICAgICAgX3RoaXM4LmhlbHBlciA9IGhlbHBlciQkMTsKICAgICAgX3RoaXM4LmFyZ3MgPSBhcmdzOwogICAgICB2YXIgY29tcHV0ZVRhZyA9IF90aGlzOC5jb21wdXRlVGFnID0gKDAsIF9yZWZlcmVuY2UuY3JlYXRlVXBkYXRhYmxlVGFnKSgpOwogICAgICBfdGhpczgudGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW2FyZ3MudGFnLCBjb21wdXRlVGFnXSk7CiAgICAgIHJldHVybiBfdGhpczg7CiAgICB9CgogICAgU2ltcGxlSGVscGVyUmVmZXJlbmNlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShoZWxwZXIkJDEsIGFyZ3MpIHsKICAgICAgaWYgKCgwLCBfcmVmZXJlbmNlLmlzQ29uc3QpKGFyZ3MpKSB7CiAgICAgICAgdmFyIHBvc2l0aW9uYWwgPSBhcmdzLnBvc2l0aW9uYWwsCiAgICAgICAgICAgIG5hbWVkID0gYXJncy5uYW1lZDsKICAgICAgICB2YXIgcG9zaXRpb25hbFZhbHVlID0gcG9zaXRpb25hbC52YWx1ZSgpOwogICAgICAgIHZhciBuYW1lZFZhbHVlID0gbmFtZWQudmFsdWUoKTsKCiAgICAgICAgaWYgKGZhbHNlCiAgICAgICAgLyogREVCVUcgKi8KICAgICAgICApIHsKICAgICAgICAgICgwLCBfZGVidWcuZGVidWdGcmVlemUpKHBvc2l0aW9uYWxWYWx1ZSk7CiAgICAgICAgICAoMCwgX2RlYnVnLmRlYnVnRnJlZXplKShuYW1lZFZhbHVlKTsKICAgICAgICB9CgogICAgICAgIHZhciByZXN1bHQgPSBoZWxwZXIkJDEocG9zaXRpb25hbFZhbHVlLCBuYW1lZFZhbHVlKTsKICAgICAgICByZXR1cm4gdmFsdWVUb1JlZihyZXN1bHQpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuZXcgU2ltcGxlSGVscGVyUmVmZXJlbmNlKGhlbHBlciQkMSwgYXJncyk7CiAgICAgIH0KICAgIH07CgogICAgdmFyIF9wcm90bzExID0gU2ltcGxlSGVscGVyUmVmZXJlbmNlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8xMS5jb21wdXRlID0gZnVuY3Rpb24gY29tcHV0ZSgpIHsKICAgICAgdmFyIGhlbHBlciQkMSA9IHRoaXMuaGVscGVyLAogICAgICAgICAgY29tcHV0ZVRhZyA9IHRoaXMuY29tcHV0ZVRhZywKICAgICAgICAgIF90aGlzJGFyZ3MgPSB0aGlzLmFyZ3MsCiAgICAgICAgICBwb3NpdGlvbmFsID0gX3RoaXMkYXJncy5wb3NpdGlvbmFsLAogICAgICAgICAgbmFtZWQgPSBfdGhpcyRhcmdzLm5hbWVkOwogICAgICB2YXIgcG9zaXRpb25hbFZhbHVlID0gcG9zaXRpb25hbC52YWx1ZSgpOwogICAgICB2YXIgbmFtZWRWYWx1ZSA9IG5hbWVkLnZhbHVlKCk7CgogICAgICBpZiAoZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgKSB7CiAgICAgICAgKDAsIF9kZWJ1Zy5kZWJ1Z0ZyZWV6ZSkocG9zaXRpb25hbFZhbHVlKTsKICAgICAgICAoMCwgX2RlYnVnLmRlYnVnRnJlZXplKShuYW1lZFZhbHVlKTsKICAgICAgfQoKICAgICAgdmFyIGNvbXB1dGVkVmFsdWU7CiAgICAgIHZhciBjb21iaW5lZFRyYWNraW5nVGFnID0gKDAsIF9tZXRhbC50cmFjaykoZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjb21wdXRlZFZhbHVlID0gaGVscGVyJCQxKHBvc2l0aW9uYWxWYWx1ZSwgbmFtZWRWYWx1ZSk7CiAgICAgIH0pOwogICAgICAoMCwgX3JlZmVyZW5jZS51cGRhdGUpKGNvbXB1dGVUYWcsIGNvbWJpbmVkVHJhY2tpbmdUYWcpOwogICAgICByZXR1cm4gY29tcHV0ZWRWYWx1ZTsKICAgIH07CgogICAgcmV0dXJuIFNpbXBsZUhlbHBlclJlZmVyZW5jZTsKICB9KENhY2hlZFJlZmVyZW5jZSQxKTsKCiAgdmFyIENsYXNzQmFzZWRIZWxwZXJSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0NhY2hlZFJlZmVyZW5jZSQzKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoQ2xhc3NCYXNlZEhlbHBlclJlZmVyZW5jZSwgX0NhY2hlZFJlZmVyZW5jZSQzKTsKCiAgICBmdW5jdGlvbiBDbGFzc0Jhc2VkSGVscGVyUmVmZXJlbmNlKGluc3RhbmNlLCBhcmdzKSB7CiAgICAgIHZhciBfdGhpczk7CgogICAgICBfdGhpczkgPSBfQ2FjaGVkUmVmZXJlbmNlJDMuY2FsbCh0aGlzKSB8fCB0aGlzOwogICAgICBfdGhpczkuaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgX3RoaXM5LmFyZ3MgPSBhcmdzOwogICAgICB2YXIgY29tcHV0ZVRhZyA9IF90aGlzOS5jb21wdXRlVGFnID0gKDAsIF9yZWZlcmVuY2UuY3JlYXRlVXBkYXRhYmxlVGFnKSgpOwogICAgICBfdGhpczkudGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW2luc3RhbmNlW1JFQ09NUFVURV9UQUddLCBhcmdzLnRhZywgY29tcHV0ZVRhZ10pOwogICAgICByZXR1cm4gX3RoaXM5OwogICAgfQoKICAgIENsYXNzQmFzZWRIZWxwZXJSZWZlcmVuY2UuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKGluc3RhbmNlLCBhcmdzKSB7CiAgICAgIHJldHVybiBuZXcgQ2xhc3NCYXNlZEhlbHBlclJlZmVyZW5jZShpbnN0YW5jZSwgYXJncyk7CiAgICB9OwoKICAgIHZhciBfcHJvdG8xMiA9IENsYXNzQmFzZWRIZWxwZXJSZWZlcmVuY2UucHJvdG90eXBlOwoKICAgIF9wcm90bzEyLmNvbXB1dGUgPSBmdW5jdGlvbiBjb21wdXRlKCkgewogICAgICB2YXIgaW5zdGFuY2UgPSB0aGlzLmluc3RhbmNlLAogICAgICAgICAgY29tcHV0ZVRhZyA9IHRoaXMuY29tcHV0ZVRhZywKICAgICAgICAgIF90aGlzJGFyZ3MyID0gdGhpcy5hcmdzLAogICAgICAgICAgcG9zaXRpb25hbCA9IF90aGlzJGFyZ3MyLnBvc2l0aW9uYWwsCiAgICAgICAgICBuYW1lZCA9IF90aGlzJGFyZ3MyLm5hbWVkOwogICAgICB2YXIgcG9zaXRpb25hbFZhbHVlID0gcG9zaXRpb25hbC52YWx1ZSgpOwogICAgICB2YXIgbmFtZWRWYWx1ZSA9IG5hbWVkLnZhbHVlKCk7CgogICAgICBpZiAoZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgKSB7CiAgICAgICAgKDAsIF9kZWJ1Zy5kZWJ1Z0ZyZWV6ZSkocG9zaXRpb25hbFZhbHVlKTsKICAgICAgICAoMCwgX2RlYnVnLmRlYnVnRnJlZXplKShuYW1lZFZhbHVlKTsKICAgICAgfQoKICAgICAgdmFyIGNvbXB1dGVkVmFsdWU7CiAgICAgIHZhciBjb21iaW5lZFRyYWNraW5nVGFnID0gKDAsIF9tZXRhbC50cmFjaykoZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjb21wdXRlZFZhbHVlID0gaW5zdGFuY2UuY29tcHV0ZShwb3NpdGlvbmFsVmFsdWUsIG5hbWVkVmFsdWUpOwogICAgICB9KTsKICAgICAgKDAsIF9yZWZlcmVuY2UudXBkYXRlKShjb21wdXRlVGFnLCBjb21iaW5lZFRyYWNraW5nVGFnKTsKICAgICAgcmV0dXJuIGNvbXB1dGVkVmFsdWU7CiAgICB9OwoKICAgIHJldHVybiBDbGFzc0Jhc2VkSGVscGVyUmVmZXJlbmNlOwogIH0oQ2FjaGVkUmVmZXJlbmNlJDEpOwoKICB2YXIgSW50ZXJuYWxIZWxwZXJSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0NhY2hlZFJlZmVyZW5jZSQ0KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoSW50ZXJuYWxIZWxwZXJSZWZlcmVuY2UsIF9DYWNoZWRSZWZlcmVuY2UkNCk7CgogICAgZnVuY3Rpb24gSW50ZXJuYWxIZWxwZXJSZWZlcmVuY2UoaGVscGVyJCQxLCBhcmdzKSB7CiAgICAgIHZhciBfdGhpczEwOwoKICAgICAgX3RoaXMxMCA9IF9DYWNoZWRSZWZlcmVuY2UkNC5jYWxsKHRoaXMpIHx8IHRoaXM7CiAgICAgIF90aGlzMTAuaGVscGVyID0gaGVscGVyJCQxOwogICAgICBfdGhpczEwLmFyZ3MgPSBhcmdzOwogICAgICBfdGhpczEwLnRhZyA9IGFyZ3MudGFnOwogICAgICByZXR1cm4gX3RoaXMxMDsKICAgIH0KCiAgICB2YXIgX3Byb3RvMTMgPSBJbnRlcm5hbEhlbHBlclJlZmVyZW5jZS5wcm90b3R5cGU7CgogICAgX3Byb3RvMTMuY29tcHV0ZSA9IGZ1bmN0aW9uIGNvbXB1dGUoKSB7CiAgICAgIHZhciBoZWxwZXIkJDEgPSB0aGlzLmhlbHBlciwKICAgICAgICAgIGFyZ3MgPSB0aGlzLmFyZ3M7CiAgICAgIHJldHVybiBoZWxwZXIkJDEoYXJncyk7CiAgICB9OwoKICAgIHJldHVybiBJbnRlcm5hbEhlbHBlclJlZmVyZW5jZTsKICB9KENhY2hlZFJlZmVyZW5jZSQxKTsKCiAgdmFyIFVuYm91bmRSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0NvbnN0UmVmZXJlbmNlMikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKFVuYm91bmRSZWZlcmVuY2UsIF9Db25zdFJlZmVyZW5jZTIpOwoKICAgIGZ1bmN0aW9uIFVuYm91bmRSZWZlcmVuY2UoKSB7CiAgICAgIHJldHVybiBfQ29uc3RSZWZlcmVuY2UyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgIH0KCiAgICBVbmJvdW5kUmVmZXJlbmNlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZSh2YWx1ZSQkMSkgewogICAgICByZXR1cm4gdmFsdWVUb1JlZih2YWx1ZSQkMSwgZmFsc2UpOwogICAgfTsKCiAgICB2YXIgX3Byb3RvMTQgPSBVbmJvdW5kUmVmZXJlbmNlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8xNC5nZXQgPSBmdW5jdGlvbiBnZXQoa2V5KSB7CiAgICAgIHJldHVybiB2YWx1ZVRvUmVmKHRoaXMuaW5uZXJba2V5XSwgZmFsc2UpOwogICAgfTsKCiAgICByZXR1cm4gVW5ib3VuZFJlZmVyZW5jZTsKICB9KF9yZWZlcmVuY2UuQ29uc3RSZWZlcmVuY2UpOwoKICB2YXIgUmVhZG9ubHlSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0NhY2hlZFJlZmVyZW5jZSQ1KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoUmVhZG9ubHlSZWZlcmVuY2UsIF9DYWNoZWRSZWZlcmVuY2UkNSk7CgogICAgZnVuY3Rpb24gUmVhZG9ubHlSZWZlcmVuY2UoaW5uZXIpIHsKICAgICAgdmFyIF90aGlzMTE7CgogICAgICBfdGhpczExID0gX0NhY2hlZFJlZmVyZW5jZSQ1LmNhbGwodGhpcykgfHwgdGhpczsKICAgICAgX3RoaXMxMS5pbm5lciA9IGlubmVyOwogICAgICBfdGhpczExLnRhZyA9IGlubmVyLnRhZzsKICAgICAgcmV0dXJuIF90aGlzMTE7CiAgICB9CgogICAgdmFyIF9wcm90bzE1ID0gUmVhZG9ubHlSZWZlcmVuY2UucHJvdG90eXBlOwoKICAgIF9wcm90bzE1LmNvbXB1dGUgPSBmdW5jdGlvbiBjb21wdXRlKCkgewogICAgICByZXR1cm4gdGhpcy5pbm5lci52YWx1ZSgpOwogICAgfTsKCiAgICBfcHJvdG8xNS5nZXQgPSBmdW5jdGlvbiBnZXQoa2V5KSB7CiAgICAgIHJldHVybiB0aGlzLmlubmVyLmdldChrZXkpOwogICAgfTsKCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKFJlYWRvbmx5UmVmZXJlbmNlLCBbewogICAgICBrZXk6IElOVk9LRSwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5uZXJbSU5WT0tFXTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFJlYWRvbmx5UmVmZXJlbmNlOwogIH0oQ2FjaGVkUmVmZXJlbmNlJDEpOwoKICBmdW5jdGlvbiByZWZlcmVuY2VGcm9tUGFydHMocm9vdCwgcGFydHMpIHsKICAgIHZhciByZWZlcmVuY2UgPSByb290OwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgcmVmZXJlbmNlID0gcmVmZXJlbmNlLmdldChwYXJ0c1tpXSk7CiAgICB9CgogICAgcmV0dXJuIHJlZmVyZW5jZTsKICB9CgogIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlJCQxKSB7CiAgICByZXR1cm4gdmFsdWUkJDEgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlJCQxID09PSAnb2JqZWN0JzsKICB9CgogIGZ1bmN0aW9uIGlzRnVuY3Rpb24odmFsdWUkJDEpIHsKICAgIHJldHVybiB0eXBlb2YgdmFsdWUkJDEgPT09ICdmdW5jdGlvbic7CiAgfQoKICBmdW5jdGlvbiBpc1ByaW1pdGl2ZSh2YWx1ZSQkMSkgewogICAgaWYgKGZhbHNlCiAgICAvKiBERUJVRyAqLwogICAgKSB7CiAgICAgIHZhciBsYWJlbDsKCiAgICAgIHRyeSB7CiAgICAgICAgbGFiZWwgPSAiICh3YXMgYCIgKyBTdHJpbmcodmFsdWUkJDEpICsgImApIjsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGxhYmVsID0gbnVsbDsKICAgICAgfQoKICAgICAgKGZhbHNlICYmICEodmFsdWUkJDEgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSQkMSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUkJDEgPT09ICdib29sZWFuJyB8fCB0eXBlb2YgdmFsdWUkJDEgPT09ICdudW1iZXInIHx8IHR5cGVvZiB2YWx1ZSQkMSA9PT0gJ3N0cmluZycpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiVGhpcyBpcyBhIGZhbGwtdGhyb3VnaCBjaGVjayBmb3IgdHlwaW5nIHB1cnBvc2VzIG9ubHkhIGB2YWx1ZWAgbXVzdCBhbHJlYWR5IGJlIGEgcHJpbWl0aXZlIGF0IHRoaXMgcG9pbnQuIiArIGxhYmVsICsgIikiLCB2YWx1ZSQkMSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlJCQxID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSQkMSA9PT0gJ2Jvb2xlYW4nIHx8IHR5cGVvZiB2YWx1ZSQkMSA9PT0gJ251bWJlcicgfHwgdHlwZW9mIHZhbHVlJCQxID09PSAnc3RyaW5nJykpOwogICAgfQoKICAgIHJldHVybiB0cnVlOwogIH0KCiAgZnVuY3Rpb24gdmFsdWVUb1JlZih2YWx1ZSQkMSwgYm91bmQpIHsKICAgIGlmIChib3VuZCA9PT0gdm9pZCAwKSB7CiAgICAgIGJvdW5kID0gdHJ1ZTsKICAgIH0KCiAgICBpZiAoaXNPYmplY3QodmFsdWUkJDEpKSB7CiAgICAgIC8vIHJvb3Qgb2YgaW50ZXJvcCB3aXRoIGVtYmVyIG9iamVjdHMKICAgICAgcmV0dXJuIGJvdW5kID8gbmV3IFJvb3RSZWZlcmVuY2UodmFsdWUkJDEpIDogbmV3IFVuYm91bmRSZWZlcmVuY2UodmFsdWUkJDEpOwogICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKHZhbHVlJCQxKSkgewogICAgICAvLyBlbWJlciBkb2Vzbid0IGRvIG9ic2VydmluZyB3aXRoIGZ1bmN0aW9ucwogICAgICByZXR1cm4gbmV3IFVuYm91bmRSZWZlcmVuY2UodmFsdWUkJDEpOwogICAgfSBlbHNlIGlmIChpc1ByaW1pdGl2ZSh2YWx1ZSQkMSkpIHsKICAgICAgcmV0dXJuIF9ydW50aW1lMi5QcmltaXRpdmVSZWZlcmVuY2UuY3JlYXRlKHZhbHVlJCQxKTsKICAgIH0gZWxzZSBpZiAoZmFsc2UKICAgIC8qIERFQlVHICovCiAgICApIHsKICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWUkJDE7CiAgICAgIHZhciBvdXRwdXQ7CgogICAgICB0cnkgewogICAgICAgIG91dHB1dCA9IFN0cmluZyh2YWx1ZSQkMSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBvdXRwdXQgPSBudWxsOwogICAgICB9CgogICAgICBpZiAob3V0cHV0KSB7CiAgICAgICAgdGhyb3cgKDAsIF91dGlsLnVucmVhY2hhYmxlKSgiW0JVR10gVW5leHBlY3RlZCAiICsgdHlwZSArICIgKCIgKyBvdXRwdXQgKyAiKSIpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93ICgwLCBfdXRpbC51bnJlYWNoYWJsZSkoIltCVUddIFVuZXhwZWN0ZWQgIiArIHR5cGUpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aHJvdyAoMCwgX3V0aWwudW5yZWFjaGFibGUpKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB2YWx1ZUtleVRvUmVmKHZhbHVlJCQxLCBrZXkpIHsKICAgIGlmIChpc09iamVjdCh2YWx1ZSQkMSkpIHsKICAgICAgLy8gcm9vdCBvZiBpbnRlcm9wIHdpdGggZW1iZXIgb2JqZWN0cwogICAgICByZXR1cm4gbmV3IFJvb3RQcm9wZXJ0eVJlZmVyZW5jZSh2YWx1ZSQkMSwga2V5KTsKICAgIH0gZWxzZSBpZiAoaXNGdW5jdGlvbih2YWx1ZSQkMSkpIHsKICAgICAgLy8gZW1iZXIgZG9lc24ndCBkbyBvYnNlcnZpbmcgd2l0aCBmdW5jdGlvbnMKICAgICAgcmV0dXJuIG5ldyBVbmJvdW5kUmVmZXJlbmNlKHZhbHVlJCQxW2tleV0pOwogICAgfSBlbHNlIGlmIChpc1ByaW1pdGl2ZSh2YWx1ZSQkMSkpIHsKICAgICAgcmV0dXJuIF9ydW50aW1lMi5VTkRFRklORURfUkVGRVJFTkNFOwogICAgfSBlbHNlIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICkgewogICAgICB2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZSQkMTsKICAgICAgdmFyIG91dHB1dDsKCiAgICAgIHRyeSB7CiAgICAgICAgb3V0cHV0ID0gU3RyaW5nKHZhbHVlJCQxKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIG91dHB1dCA9IG51bGw7CiAgICAgIH0KCiAgICAgIGlmIChvdXRwdXQpIHsKICAgICAgICB0aHJvdyAoMCwgX3V0aWwudW5yZWFjaGFibGUpKCJbQlVHXSBVbmV4cGVjdGVkICIgKyB0eXBlICsgIiAoIiArIG91dHB1dCArICIpIik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgKDAsIF91dGlsLnVucmVhY2hhYmxlKSgiW0JVR10gVW5leHBlY3RlZCAiICsgdHlwZSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRocm93ICgwLCBfdXRpbC51bnJlYWNoYWJsZSkoKTsKICAgIH0KICB9CgogIHZhciBESVJUWV9UQUcgPSAoMCwgX3V0aWxzLnN5bWJvbCkoJ0RJUlRZX1RBRycpOwogIHZhciBBUkdTID0gKDAsIF91dGlscy5zeW1ib2wpKCdBUkdTJyk7CiAgdmFyIFJPT1RfUkVGID0gKDAsIF91dGlscy5zeW1ib2wpKCdST09UX1JFRicpOwogIF9leHBvcnRzLlJPT1RfUkVGID0gUk9PVF9SRUY7CiAgdmFyIElTX0RJU1BBVENISU5HX0FUVFJTID0gKDAsIF91dGlscy5zeW1ib2wpKCdJU19ESVNQQVRDSElOR19BVFRSUycpOwogIHZhciBIQVNfQkxPQ0sgPSAoMCwgX3V0aWxzLnN5bWJvbCkoJ0hBU19CTE9DSycpOwogIHZhciBCT1VORFMgPSAoMCwgX3V0aWxzLnN5bWJvbCkoJ0JPVU5EUycpOwogIC8qKgogIEBtb2R1bGUgQGVtYmVyL2NvbXBvbmVudAogICovCgogIC8qKgogICAgQSBjb21wb25lbnQgaXMgYW4gaXNvbGF0ZWQgcGllY2Ugb2YgVUksIHJlcHJlc2VudGVkIGJ5IGEgdGVtcGxhdGUgYW5kIGFuCiAgICBvcHRpb25hbCBjbGFzcy4gV2hlbiBhIGNvbXBvbmVudCBoYXMgYSBjbGFzcywgaXRzIHRlbXBsYXRlJ3MgYHRoaXNgIHZhbHVlCiAgICBpcyBhbiBpbnN0YW5jZSBvZiB0aGUgY29tcG9uZW50IGNsYXNzLgogIAogICAgIyMgVGVtcGxhdGUtb25seSBDb21wb25lbnRzCiAgCiAgICBUaGUgc2ltcGxlc3Qgd2F5IHRvIGNyZWF0ZSBhIGNvbXBvbmVudCBpcyB0byBjcmVhdGUgYSB0ZW1wbGF0ZSBmaWxlIGluCiAgICBgYXBwL3RlbXBsYXRlcy9jb21wb25lbnRzYC4gRm9yIGV4YW1wbGUsIGlmIHlvdSBuYW1lIGEgdGVtcGxhdGUKICAgIGBhcHAvdGVtcGxhdGVzL2NvbXBvbmVudHMvcGVyc29uLXByb2ZpbGUuaGJzYDoKICAKICAgIGBgYGFwcC90ZW1wbGF0ZXMvY29tcG9uZW50cy9wZXJzb24tcHJvZmlsZS5oYnMKICAgIDxoMT57e0BwZXJzb24ubmFtZX19PC9oMT4KICAgIDxpbWcgc3JjPXt7QHBlcnNvbi5hdmF0YXJ9fT4KICAgIDxwIGNsYXNzPSdzaWduYXR1cmUnPnt7QHBlcnNvbi5zaWduYXR1cmV9fTwvcD4KICAgIGBgYAogIAogICAgWW91IHdpbGwgYmUgYWJsZSB0byB1c2UgYDxQZXJzb25Qcm9maWxlIC8+YCB0byBpbnZva2UgdGhpcyBjb21wb25lbnQgZWxzZXdoZXJlCiAgICBpbiB5b3VyIGFwcGxpY2F0aW9uOgogIAogICAgYGBgYXBwL3RlbXBsYXRlcy9hcHBsaWNhdGlvbi5oYnMKICAgIDxQZXJzb25Qcm9maWxlIEBwZXJzb249e3t0aGlzLmN1cnJlbnRVc2VyfX0gLz4KICAgIGBgYAogIAogICAgTm90ZSB0aGF0IGNvbXBvbmVudCBuYW1lcyBhcmUgY2FwaXRhbGl6ZWQgaGVyZSBpbiBvcmRlciB0byBkaXN0aW5ndWlzaCB0aGVtCiAgICBmcm9tIHJlZ3VsYXIgSFRNTCBlbGVtZW50cywgYnV0IHRoZXkgYXJlIGRhc2hlcml6ZWQgaW4gdGhlIGZpbGUgc3lzdGVtLgogIAogICAgV2hpbGUgdGhlIGFuZ2xlIGJyYWNrZXQgaW52b2NhdGlvbiBmb3JtIGlzIGdlbmVyYWxseSBwcmVmZXJyZWQsIGl0IGlzIGFsc28KICAgIHBvc3NpYmxlIHRvIGludm9rZSB0aGUgc2FtZSBjb21wb25lbnQgd2l0aCB0aGUgYHt7cGVyc29uLXByb2ZpbGV9fWAgc3ludGF4OgogIAogICAgYGBgYXBwL3RlbXBsYXRlcy9hcHBsaWNhdGlvbi5oYnMKICAgIHt7cGVyc29uLXByb2ZpbGUgcGVyc29uPXRoaXMuY3VycmVudFVzZXJ9fQogICAgYGBgCiAgCiAgICBOb3RlIHRoYXQgd2l0aCB0aGlzIHN5bnRheCwgeW91IHVzZSBkYXNoZXMgaW4gdGhlIGNvbXBvbmVudCBuYW1lIGFuZAogICAgYXJndW1lbnRzIGFyZSBwYXNzZWQgd2l0aG91dCB0aGUgYEBgIHNpZ24uCiAgCiAgICBJbiBib3RoIGNhc2VzLCBFbWJlciB3aWxsIHJlbmRlciB0aGUgY29udGVudCBvZiB0aGUgY29tcG9uZW50IHRlbXBsYXRlIHdlCiAgICBjcmVhdGVkIGFib3ZlLiBUaGUgZW5kIHJlc3VsdCB3aWxsIGJlIHNvbWV0aGluZyBsaWtlIHRoaXM6CiAgCiAgICBgYGBodG1sCiAgICA8aDE+VG9tc3RlcjwvaDE+CiAgICA8aW1nIHNyYz0iaHR0cHM6Ly9lbWJlcmpzLmNvbS90b21zdGVyLmpwZyI+CiAgICA8cCBjbGFzcz0nc2lnbmF0dXJlJz5PdXQgb2Ygb2ZmaWNlIHRoaXMgd2VlazwvcD4KICAgIGBgYAogIAogICAgIyMgRmlsZSBTeXN0ZW0gTmVzdGluZwogIAogICAgQ29tcG9uZW50cyBjYW4gYmUgbmVzdGVkIGluc2lkZSBzdWItZm9sZGVycyBmb3IgbG9naWNhbCBncm91cHBpbmcuIEZvcgogICAgZXhhbXBsZSwgaWYgd2UgcGxhY2VkIG91ciB0ZW1wbGF0ZSBpbgogICAgYGFwcC90ZW1wbGF0ZXMvY29tcG9uZW50cy9wZXJzb24vc2hvcnQtcHJvZmlsZS5oYnNgLCB3ZSBjYW4gaW52b2tlIGl0IGFzCiAgICBgPFBlcnNvbjo6U2hvcnRQcm9maWxlIC8+YDoKICAKICAgIGBgYGFwcC90ZW1wbGF0ZXMvYXBwbGljYXRpb24uaGJzCiAgICA8UGVyc29uOjpTaG9ydFByb2ZpbGUgQHBlcnNvbj17e3RoaXMuY3VycmVudFVzZXJ9fSAvPgogICAgYGBgCiAgCiAgICBPciBlcXVpdmFsZW50bHksIGB7e3BlcnNvbi9zaG9ydC1wcm9maWxlfX1gOgogIAogICAgYGBgYXBwL3RlbXBsYXRlcy9hcHBsaWNhdGlvbi5oYnMKICAgIHt7cGVyc29uL3Nob3J0LXByb2ZpbGUgcGVyc29uPXRoaXMuY3VycmVudFVzZXJ9fQogICAgYGBgCiAgCiAgICAjIyBZaWVsZGluZyBDb250ZW50cwogIAogICAgWW91IGNhbiB1c2UgYHlpZWxkYCBpbnNpZGUgYSB0ZW1wbGF0ZSB0byBpbmNsdWRlIHRoZSAqKmNvbnRlbnRzKiogb2YgYW55IGJsb2NrCiAgICBhdHRhY2hlZCB0byB0aGUgY29tcG9uZW50LiBUaGUgYmxvY2sgd2lsbCBiZSBleGVjdXRlZCBpbiBpdHMgb3JpZ2luYWwgY29udGV4dDoKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxQZXJzb25Qcm9maWxlIEBwZXJzb249e3t0aGlzLmN1cnJlbnRVc2VyfX0+CiAgICAgIDxwPkFkbWluIG1vZGU8L3A+CiAgICAgIHt7ISBFeGVjdXRlZCBpbiB0aGUgY3VycmVudCBjb250ZXh0LiB9fQogICAgPC9QZXJzb25Qcm9maWxlPgogICAgYGBgCiAgCiAgICBvcgogIAogICAgYGBgaGFuZGxlYmFycwogICAge3sjcGVyc29uLXByb2ZpbGUgcGVyc29uPXRoaXMuY3VycmVudFVzZXJ9fQogICAgICA8cD5BZG1pbiBtb2RlPC9wPgogICAgICB7eyEgRXhlY3V0ZWQgaW4gdGhlIGN1cnJlbnQgY29udGV4dC4gfX0KICAgIHt7L3BlcnNvbi1wcm9maWxlfX0KICAgIGBgYAogIAogICAgYGBgYXBwL3RlbXBsYXRlcy9jb21wb25lbnRzL3BlcnNvbi1wcm9maWxlLmhicwogICAgPGgxPnt7QHBlcnNvbi5uYW1lfX08L2gxPgogICAge3t5aWVsZH19CiAgICBgYGAKICAKICAgICMjIEN1c3RvbWl6aW5nIENvbXBvbmVudHMgV2l0aCBKYXZhU2NyaXB0CiAgCiAgICBJZiB5b3Ugd2FudCB0byBjdXN0b21pemUgdGhlIGNvbXBvbmVudCBpbiBvcmRlciB0byBoYW5kbGUgZXZlbnRzLCB0cmFuc2Zvcm0KICAgIGFyZ3VtZW50cyBvciBtYWludGFpbiBpbnRlcm5hbCBzdGF0ZSwgeW91IGltcGxlbWVudCBhIHN1YmNsYXNzIG9mIGBDb21wb25lbnRgLgogIAogICAgT25lIGV4YW1wbGUgaXMgdG8gYWRkIGNvbXB1dGVkIHByb3BlcnRpZXMgdG8geW91ciBjb21wb25lbnQ6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9wZXJzb24tcHJvZmlsZS5qcwogICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICBkaXNwbGF5TmFtZTogY29tcHV0ZWQoJ3BlcnNvbi50aXRsZScsICdwZXJzb24uZmlyc3ROYW1lJywgJ3BlcnNvbi5sYXN0TmFtZScsIGZ1bmN0aW9uKCkgewogICAgICAgIGxldCB7IHRpdGxlLCBmaXJzdE5hbWUsIGxhc3ROYW1lIH0gPSB0aGlzOwogIAogICAgICAgIGlmICh0aXRsZSkgewogICAgICAgICAgcmV0dXJuIGAke3RpdGxlfSAke2xhc3ROYW1lfWA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBgJHtmaXJzdE5hbWV9ICR7bGFzdE5hbWV9YDsKICAgICAgICB9CiAgICAgIH0pCiAgICB9KTsKICAgIGBgYAogIAogICAgQW5kIHRoZW4gdXNlIGl0IGluIHRoZSBjb21wb25lbnQncyB0ZW1wbGF0ZToKICAKICAgIGBgYGFwcC90ZW1wbGF0ZXMvY29tcG9uZW50cy9wZXJzb24tcHJvZmlsZS5oYnMKICAgIDxoMT57e3RoaXMuZGlzcGxheU5hbWV9fTwvaDE+CiAgICB7e3lpZWxkfX0KICAgIGBgYAogIAogICAgIyMgQ3VzdG9taXppbmcgYSBDb21wb25lbnQncyBIVE1MIEVsZW1lbnQgaW4gSmF2YVNjcmlwdAogIAogICAgIyMjIEhUTUwgVGFnCiAgCiAgICBUaGUgZGVmYXVsdCBIVE1MIHRhZyBuYW1lIHVzZWQgZm9yIGEgY29tcG9uZW50J3MgSFRNTCByZXByZXNlbnRhdGlvbiBpcyBgZGl2YC4KICAgIFRoaXMgY2FuIGJlIGN1c3RvbWl6ZWQgYnkgc2V0dGluZyB0aGUgYHRhZ05hbWVgIHByb3BlcnR5LgogIAogICAgQ29uc2lkZXIgdGhlIGZvbGxvd2luZyBjb21wb25lbnQgY2xhc3M6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9lbXBoYXNpemVkLXBhcmFncmFwaC5qcwogICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICB0YWdOYW1lOiAnZW0nCiAgICB9KTsKICAgIGBgYAogIAogICAgV2hlbiBpbnZva2VkLCB0aGlzIGNvbXBvbmVudCB3b3VsZCBwcm9kdWNlIG91dHB1dCB0aGF0IGxvb2tzIHNvbWV0aGluZyBsaWtlCiAgICB0aGlzOgogIAogICAgYGBgaHRtbAogICAgPGVtIGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3Ij48L2VtPgogICAgYGBgCiAgCiAgICAjIyMgSFRNTCBgY2xhc3NgIEF0dHJpYnV0ZQogIAogICAgVGhlIEhUTUwgYGNsYXNzYCBhdHRyaWJ1dGUgb2YgYSBjb21wb25lbnQncyB0YWcgY2FuIGJlIHNldCBieSBwcm92aWRpbmcgYQogICAgYGNsYXNzTmFtZXNgIHByb3BlcnR5IHRoYXQgaXMgc2V0IHRvIGFuIGFycmF5IG9mIHN0cmluZ3M6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9teS13aWRnZXQuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgY2xhc3NOYW1lczogWydteS1jbGFzcycsICdteS1vdGhlci1jbGFzcyddCiAgICB9KTsKICAgIGBgYAogIAogICAgSW52b2tpbmcgdGhpcyBjb21wb25lbnQgd2lsbCBwcm9kdWNlIG91dHB1dCB0aGF0IGxvb2tzIGxpa2UgdGhpczoKICAKICAgIGBgYGh0bWwKICAgIDxkaXYgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXcgbXktY2xhc3MgbXktb3RoZXItY2xhc3MiPjwvZGl2PgogICAgYGBgCiAgCiAgICBgY2xhc3NgIGF0dHJpYnV0ZSB2YWx1ZXMgY2FuIGFsc28gYmUgc2V0IGJ5IHByb3ZpZGluZyBhIGBjbGFzc05hbWVCaW5kaW5nc2AKICAgIHByb3BlcnR5IHNldCB0byBhbiBhcnJheSBvZiBwcm9wZXJ0aWVzIG5hbWVzIGZvciB0aGUgY29tcG9uZW50LiBUaGUgcmV0dXJuCiAgICB2YWx1ZSBvZiB0aGVzZSBwcm9wZXJ0aWVzIHdpbGwgYmUgYWRkZWQgYXMgcGFydCBvZiB0aGUgdmFsdWUgZm9yIHRoZQogICAgY29tcG9uZW50cydzIGBjbGFzc2AgYXR0cmlidXRlLiBUaGVzZSBwcm9wZXJ0aWVzIGNhbiBiZSBjb21wdXRlZCBwcm9wZXJ0aWVzOgogIAogICAgYGBgYXBwL2NvbXBvbmVudHMvbXktd2lkZ2V0LmpzCiAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgaW1wb3J0IHsgY29tcHV0ZWQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICBjbGFzc05hbWVzOiBbJ215LWNsYXNzJywgJ215LW90aGVyLWNsYXNzJ10sCiAgICAgIGNsYXNzTmFtZUJpbmRpbmdzOiBbJ3Byb3BlcnR5QScsICdwcm9wZXJ0eUInXSwKICAKICAgICAgcHJvcGVydHlBOiAnZnJvbS1hJywKICAgICAgcHJvcGVydHlCOiBjb21wdXRlZChmdW5jdGlvbigpIHsKICAgICAgICBpZiAoc29tZUxvZ2ljKSB7IHJldHVybiAnZnJvbS1iJzsgfQogICAgICB9KQogICAgfSk7CiAgICBgYGAKICAKICAgIEludm9raW5nIHRoaXMgY29tcG9uZW50IHdpbGwgcHJvZHVjZSBIVE1MIHRoYXQgbG9va3MgbGlrZToKICAKICAgIGBgYGh0bWwKICAgIDxkaXYgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXcgbXktY2xhc3MgbXktb3RoZXItY2xhc3MgZnJvbS1hIGZyb20tYiI+PC9kaXY+CiAgICBgYGAKICAKICAgIE5vdGUgdGhhdCBgY2xhc3NOYW1lc2AgYW5kIGBjbGFzc05hbWVCaW5kaW5nc2AgaXMgaW4gYWRkaXRpb24gdG8gdGhlIGBjbGFzc2AKICAgIGF0dHJpYnV0ZSBwYXNzZWQgd2l0aCB0aGUgYW5nbGUgYnJhY2tldCBpbnZvY2F0aW9uIHN5bnRheC4gVGhlcmVmb3JlLCBpZiB0aGlzCiAgICBjb21wb25lbnQgd2FzIGludm9rZWQgbGlrZSBzbzoKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxNeVdpZGdldCBjbGFzcz0iZnJvbS1pbnZvY2F0aW9uIiAvPgogICAgYGBgCiAgCiAgICBUaGUgcmVzdWx0aW5nIEhUTUwgd2lsbCBsb29rIHNpbWlsYXIgdG8gdGhpczoKICAKICAgIGBgYGh0bWwKICAgIDxkaXYgaWQ9ImVtYmVyMSIgY2xhc3M9ImZyb20taW52b2NhdGlvbiBlbWJlci12aWV3IG15LWNsYXNzIG15LW90aGVyLWNsYXNzIGZyb20tYSBmcm9tLWIiPjwvZGl2PgogICAgYGBgCiAgCiAgICBJZiB0aGUgdmFsdWUgb2YgYSBjbGFzcyBuYW1lIGJpbmRpbmcgcmV0dXJucyBhIGJvb2xlYW4gdGhlIHByb3BlcnR5IG5hbWUKICAgIGl0c2VsZiB3aWxsIGJlIHVzZWQgYXMgdGhlIGNsYXNzIG5hbWUgaWYgdGhlIHByb3BlcnR5IGlzIHRydWUuIFRoZSBjbGFzcyBuYW1lCiAgICB3aWxsIG5vdCBiZSBhZGRlZCBpZiB0aGUgdmFsdWUgaXMgYGZhbHNlYCBvciBgdW5kZWZpbmVkYC4KICAKICAgIGBgYGFwcC9jb21wb25lbnRzL215LXdpZGdldC5qcwogICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICBjbGFzc05hbWVCaW5kaW5nczogWydob3ZlcmVkJ10sCiAgCiAgICAgIGhvdmVyZWQ6IHRydWUKICAgIH0pOwogICAgYGBgCiAgCiAgICBJbnZva2luZyB0aGlzIGNvbXBvbmVudCB3aWxsIHByb2R1Y2UgSFRNTCB0aGF0IGxvb2tzIGxpa2U6CiAgCiAgICBgYGBodG1sCiAgICA8ZGl2IGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3IGhvdmVyZWQiPjwvZGl2PgogICAgYGBgCiAgCiAgICAjIyMgQ3VzdG9tIENsYXNzIE5hbWVzIGZvciBCb29sZWFuIFZhbHVlcwogIAogICAgV2hlbiB1c2luZyBib29sZWFuIGNsYXNzIG5hbWUgYmluZGluZ3MgeW91IGNhbiBzdXBwbHkgYSBzdHJpbmcgdmFsdWUgb3RoZXIKICAgIHRoYW4gdGhlIHByb3BlcnR5IG5hbWUgZm9yIHVzZSBhcyB0aGUgYGNsYXNzYCBIVE1MIGF0dHJpYnV0ZSBieSBhcHBlbmRpbmcgdGhlCiAgICBwcmVmZXJyZWQgdmFsdWUgYWZ0ZXIgYSAiOiIgY2hhcmFjdGVyIHdoZW4gZGVmaW5pbmcgdGhlIGJpbmRpbmc6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9teS13aWRnZXQuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgY2xhc3NOYW1lQmluZGluZ3M6IFsnYXdlc29tZTpzby12ZXJ5LWNvb2wnXSwKICAKICAgICAgYXdlc29tZTogdHJ1ZQogICAgfSk7CiAgICBgYGAKICAKICAgIEludm9raW5nIHRoaXMgY29tcG9uZW50IHdpbGwgcHJvZHVjZSBIVE1MIHRoYXQgbG9va3MgbGlrZToKICAKICAgIGBgYGh0bWwKICAgIDxkaXYgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXcgc28tdmVyeS1jb29sIj48L2Rpdj4KICAgIGBgYAogIAogICAgQm9vbGVhbiB2YWx1ZSBjbGFzcyBuYW1lIGJpbmRpbmdzIHdob3NlIHByb3BlcnR5IG5hbWVzIGFyZSBpbiBhCiAgICBjYW1lbENhc2Utc3R5bGUgZm9ybWF0IHdpbGwgYmUgY29udmVydGVkIHRvIGEgZGFzaGVyaXplZCBmb3JtYXQ6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9teS13aWRnZXQuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgY2xhc3NOYW1lQmluZGluZ3M6IFsnaXNVcmdlbnQnXSwKICAKICAgICAgaXNVcmdlbnQ6IHRydWUKICAgIH0pOwogICAgYGBgCiAgCiAgICBJbnZva2luZyB0aGlzIGNvbXBvbmVudCB3aWxsIHByb2R1Y2UgSFRNTCB0aGF0IGxvb2tzIGxpa2U6CiAgCiAgICBgYGBodG1sCiAgICA8ZGl2IGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3IGlzLXVyZ2VudCI+PC9kaXY+CiAgICBgYGAKICAKICAgIENsYXNzIG5hbWUgYmluZGluZ3MgY2FuIGFsc28gcmVmZXIgdG8gb2JqZWN0IHZhbHVlcyB0aGF0IGFyZSBmb3VuZCBieQogICAgdHJhdmVyc2luZyBhIHBhdGggcmVsYXRpdmUgdG8gdGhlIGNvbXBvbmVudCBpdHNlbGY6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9teS13aWRnZXQuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgY2xhc3NOYW1lQmluZGluZ3M6IFsnbWVzc2FnZXMuZW1wdHknXSwKICAKICAgICAgbWVzc2FnZXM6IEVtYmVyT2JqZWN0LmNyZWF0ZSh7CiAgICAgICAgZW1wdHk6IHRydWUKICAgICAgfSkKICAgIH0pOwogICAgYGBgCiAgCiAgICBJbnZva2luZyB0aGlzIGNvbXBvbmVudCB3aWxsIHByb2R1Y2UgSFRNTCB0aGF0IGxvb2tzIGxpa2U6CiAgCiAgICBgYGBodG1sCiAgICA8ZGl2IGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3IGVtcHR5Ij48L2Rpdj4KICAgIGBgYAogIAogICAgSWYgeW91IHdhbnQgdG8gYWRkIGEgY2xhc3MgbmFtZSBmb3IgYSBwcm9wZXJ0eSB3aGljaCBldmFsdWF0ZXMgdG8gdHJ1ZSBhbmQKICAgIGFuZCBhIGRpZmZlcmVudCBjbGFzcyBuYW1lIGlmIGl0IGV2YWx1YXRlcyB0byBmYWxzZSwgeW91IGNhbiBwYXNzIGEgYmluZGluZwogICAgbGlrZSB0aGlzOgogIAogICAgYGBgYXBwL2NvbXBvbmVudHMvbXktd2lkZ2V0LmpzCiAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogIAogICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgIGNsYXNzTmFtZUJpbmRpbmdzOiBbJ2lzRW5hYmxlZDplbmFibGVkOmRpc2FibGVkJ10sCiAgICAgIGlzRW5hYmxlZDogdHJ1ZQogICAgfSk7CiAgICBgYGAKICAKICAgIEludm9raW5nIHRoaXMgY29tcG9uZW50IHdpbGwgcHJvZHVjZSBIVE1MIHRoYXQgbG9va3MgbGlrZToKICAKICAgIGBgYGh0bWwKICAgIDxkaXYgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXcgZW5hYmxlZCI+PC9kaXY+CiAgICBgYGAKICAKICAgIFdoZW4gaXNFbmFibGVkIGlzIGBmYWxzZWAsIHRoZSByZXN1bHRpbmcgSFRNTCByZXByZXNlbnRhdGlvbiBsb29rcyBsaWtlIHRoaXM6CiAgCiAgICBgYGBodG1sCiAgICA8ZGl2IGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3IGRpc2FibGVkIj48L2Rpdj4KICAgIGBgYAogIAogICAgVGhpcyBzeW50YXggb2ZmZXJzIHRoZSBjb252ZW5pZW5jZSB0byBhZGQgYSBjbGFzcyBpZiBhIHByb3BlcnR5IGlzIGBmYWxzZWA6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9teS13aWRnZXQuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgCiAgICAvLyBBcHBsaWVzIG5vIGNsYXNzIHdoZW4gaXNFbmFibGVkIGlzIHRydWUgYW5kIGNsYXNzICdkaXNhYmxlZCcgd2hlbiBpc0VuYWJsZWQgaXMgZmFsc2UKICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICBjbGFzc05hbWVCaW5kaW5nczogWydpc0VuYWJsZWQ6OmRpc2FibGVkJ10sCiAgICAgIGlzRW5hYmxlZDogdHJ1ZQogICAgfSk7CiAgICBgYGAKICAKICAgIEludm9raW5nIHRoaXMgY29tcG9uZW50IHdoZW4gdGhlIGBpc0VuYWJsZWRgIHByb3BlcnR5IGlzIHRydWUgd2lsbCBwcm9kdWNlCiAgICBIVE1MIHRoYXQgbG9va3MgbGlrZToKICAKICAgIGBgYGh0bWwKICAgIDxkaXYgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXciPjwvZGl2PgogICAgYGBgCiAgCiAgICBJbnZva2luZyBpdCB3aGVuIHRoZSBgaXNFbmFibGVkYCBwcm9wZXJ0eSBvbiB0aGUgY29tcG9uZW50IGlzIGBmYWxzZWAgd2lsbAogICAgcHJvZHVjZSBIVE1MIHRoYXQgbG9va3MgbGlrZToKICAKICAgIGBgYGh0bWwKICAgIDxkaXYgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXcgZGlzYWJsZWQiPjwvZGl2PgogICAgYGBgCiAgCiAgICBVcGRhdGVzIHRvIHRoZSB2YWx1ZSBvZiBhIGNsYXNzIG5hbWUgYmluZGluZyB3aWxsIHJlc3VsdCBpbiBhdXRvbWF0aWMgdXBkYXRlCiAgICBvZiB0aGUgIEhUTUwgYGNsYXNzYCBhdHRyaWJ1dGUgaW4gdGhlIGNvbXBvbmVudCdzIHJlbmRlcmVkIEhUTUwKICAgIHJlcHJlc2VudGF0aW9uLiBJZiB0aGUgdmFsdWUgYmVjb21lcyBgZmFsc2VgIG9yIGB1bmRlZmluZWRgIHRoZSBjbGFzcyBuYW1lCiAgICB3aWxsIGJlIHJlbW92ZWQuCiAgCiAgICBCb3RoIGBjbGFzc05hbWVzYCBhbmQgYGNsYXNzTmFtZUJpbmRpbmdzYCBhcmUgY29uY2F0ZW5hdGVkIHByb3BlcnRpZXMuIFNlZQogICAgW0VtYmVyT2JqZWN0XSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0VtYmVyT2JqZWN0KSBkb2N1bWVudGF0aW9uIGZvciBtb3JlCiAgICBpbmZvcm1hdGlvbiBhYm91dCBjb25jYXRlbmF0ZWQgcHJvcGVydGllcy4KICAKICAgICMjIyBPdGhlciBIVE1MIEF0dHJpYnV0ZXMKICAKICAgIFRoZSBIVE1MIGF0dHJpYnV0ZSBzZWN0aW9uIG9mIGEgY29tcG9uZW50J3MgdGFnIGNhbiBiZSBzZXQgYnkgcHJvdmlkaW5nIGFuCiAgICBgYXR0cmlidXRlQmluZGluZ3NgIHByb3BlcnR5IHNldCB0byBhbiBhcnJheSBvZiBwcm9wZXJ0eSBuYW1lcyBvbiB0aGUgY29tcG9uZW50LgogICAgVGhlIHJldHVybiB2YWx1ZSBvZiB0aGVzZSBwcm9wZXJ0aWVzIHdpbGwgYmUgdXNlZCBhcyB0aGUgdmFsdWUgb2YgdGhlIGNvbXBvbmVudCdzCiAgICBIVE1MIGFzc29jaWF0ZWQgYXR0cmlidXRlOgogIAogICAgYGBgYXBwL2NvbXBvbmVudHMvbXktYW5jaG9yLmpzCiAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogIAogICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgIHRhZ05hbWU6ICdhJywKICAgICAgYXR0cmlidXRlQmluZGluZ3M6IFsnaHJlZiddLAogIAogICAgICBocmVmOiAnaHR0cDovL2dvb2dsZS5jb20nCiAgICB9KTsKICAgIGBgYAogIAogICAgSW52b2tpbmcgdGhpcyBjb21wb25lbnQgd2lsbCBwcm9kdWNlIEhUTUwgdGhhdCBsb29rcyBsaWtlOgogIAogICAgYGBgaHRtbAogICAgPGEgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXciIGhyZWY9Imh0dHA6Ly9nb29nbGUuY29tIj48L2E+CiAgICBgYGAKICAKICAgIE9uZSBwcm9wZXJ0eSBjYW4gYmUgbWFwcGVkIG9uIHRvIGFub3RoZXIgYnkgcGxhY2luZyBhICI6IiBiZXR3ZWVuCiAgICB0aGUgc291cmNlIHByb3BlcnR5IGFuZCB0aGUgZGVzdGluYXRpb24gcHJvcGVydHk6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9teS1hbmNob3IuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgdGFnTmFtZTogJ2EnLAogICAgICBhdHRyaWJ1dGVCaW5kaW5nczogWyd1cmw6aHJlZiddLAogIAogICAgICB1cmw6ICdodHRwOi8vZ29vZ2xlLmNvbScKICAgIH0pOwogICAgYGBgCiAgCiAgICBJbnZva2luZyB0aGlzIGNvbXBvbmVudCB3aWxsIHByb2R1Y2UgSFRNTCB0aGF0IGxvb2tzIGxpa2U6CiAgCiAgICBgYGBodG1sCiAgICA8YSBpZD0iZW1iZXIxIiBjbGFzcz0iZW1iZXItdmlldyIgaHJlZj0iaHR0cDovL2dvb2dsZS5jb20iPjwvYT4KICAgIGBgYAogIAogICAgSFRNTCBhdHRyaWJ1dGVzIHBhc3NlZCB3aXRoIGFuZ2xlIGJyYWNrZXQgaW52b2NhdGlvbnMgd2lsbCB0YWtlIHByZWNlZGVuY2UKICAgIG92ZXIgdGhvc2Ugc3BlY2lmaWVkIGluIGBhdHRyaWJ1dGVCaW5kaW5nc2AuIFRoZXJlZm9yZSwgaWYgdGhpcyBjb21wb25lbnQgd2FzCiAgICBpbnZva2VkIGxpa2Ugc286CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICA8TXlBbmNob3IgaHJlZj0iaHR0cDovL2JpbmcuY29tIiBAdXJsPSJodHRwOi8vZ29vZ2xlLmNvbSIgLz4KICAgIGBgYAogIAogICAgVGhlIHJlc3VsdGluZyBIVE1MIHdpbGwgbG9va3MgbGlrZSB0aGlzOgogIAogICAgYGBgaHRtbAogICAgPGEgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXciIGhyZWY9Imh0dHA6Ly9iaW5nLmNvbSI+PC9hPgogICAgYGBgCiAgCiAgICBOb3RlIHRoYXQgdGhlIGBocmVmYCBhdHRyaWJ1dGUgaXMgdWx0aW1hdGVseSBzZXQgdG8gYGh0dHA6Ly9iaW5nLmNvbWAsCiAgICBkZXNwaXRlIGl0IGhhdmluZyBhdHRyaWJ1dGUgYmluaWRuZyB0byB0aGUgYHVybGAgcHJvcGVydHksIHdoaWNoIHdhcwogICAgc2V0IHRvIGBodHRwOi8vZ29vZ2xlLmNvbWAuCiAgCiAgICBOYW1lc3BhY2VkIGF0dHJpYnV0ZXMgKGUuZy4gYHhsaW5rOmhyZWZgKSBhcmUgc3VwcG9ydGVkLCBidXQgaGF2ZSB0byBiZQogICAgbWFwcGVkLCBzaW5jZSBgOmAgaXMgbm90IGEgdmFsaWQgY2hhcmFjdGVyIGZvciBwcm9wZXJ0aWVzIGluIEphdmFzY3JpcHQ6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9teS11c2UuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgdGFnTmFtZTogJ3VzZScsCiAgICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ3hsaW5rSHJlZjp4bGluazpocmVmJ10sCiAgCiAgICAgIHhsaW5rSHJlZjogJyN0cmlhbmdsZScKICAgIH0pOwogICAgYGBgCiAgCiAgICBJbnZva2luZyB0aGlzIGNvbXBvbmVudCB3aWxsIHByb2R1Y2UgSFRNTCB0aGF0IGxvb2tzIGxpa2U6CiAgCiAgICBgYGBodG1sCiAgICA8dXNlIHhsaW5rOmhyZWY9IiN0cmlhbmdsZSI+PC91c2U+CiAgICBgYGAKICAKICAgIElmIHRoZSB2YWx1ZSBvZiBhIHByb3BlcnR5IG1vbml0b3JlZCBieSBgYXR0cmlidXRlQmluZGluZ3NgIGlzIGEgYm9vbGVhbiwgdGhlCiAgICBhdHRyaWJ1dGUgd2lsbCBiZSBwcmVzZW50IG9yIGFic2VudCBkZXBlbmRpbmcgb24gdGhlIHZhbHVlOgogIAogICAgYGBgYXBwL2NvbXBvbmVudHMvbXktdGV4dC1pbnB1dC5qcwogICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICB0YWdOYW1lOiAnaW5wdXQnLAogICAgICBhdHRyaWJ1dGVCaW5kaW5nczogWydkaXNhYmxlZCddLAogIAogICAgICBkaXNhYmxlZDogZmFsc2UKICAgIH0pOwogICAgYGBgCiAgCiAgICBJbnZva2luZyB0aGlzIGNvbXBvbmVudCB3aWxsIHByb2R1Y2UgSFRNTCB0aGF0IGxvb2tzIGxpa2U6CiAgCiAgICBgYGBodG1sCiAgICA8aW5wdXQgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXciIC8+CiAgICBgYGAKICAKICAgIGBhdHRyaWJ1dGVCaW5kaW5nc2AgY2FuIHJlZmVyIHRvIGNvbXB1dGVkIHByb3BlcnRpZXM6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9teS10ZXh0LWlucHV0LmpzCiAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgaW1wb3J0IHsgY29tcHV0ZWQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICB0YWdOYW1lOiAnaW5wdXQnLAogICAgICBhdHRyaWJ1dGVCaW5kaW5nczogWydkaXNhYmxlZCddLAogIAogICAgICBkaXNhYmxlZDogY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHNvbWVMb2dpYykgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9KTsKICAgIGBgYAogIAogICAgVG8gcHJldmVudCBzZXR0aW5nIGFuIGF0dHJpYnV0ZSBhbHRvZ2V0aGVyLCB1c2UgYG51bGxgIG9yIGB1bmRlZmluZWRgIGFzIHRoZQogICAgdmFsdWUgb2YgdGhlIHByb3BlcnR5IHVzZWQgaW4gYGF0dHJpYnV0ZUJpbmRpbmdzYDoKICAKICAgIGBgYGFwcC9jb21wb25lbnRzL215LXRleHQtaW5wdXQuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgdGFnTmFtZTogJ2Zvcm0nLAogICAgICBhdHRyaWJ1dGVCaW5kaW5nczogWydub3ZhbGlkYXRlJ10sCiAgICAgIG5vdmFsaWRhdGU6IG51bGwKICAgIH0pOwogICAgYGBgCiAgCiAgICBVcGRhdGVzIHRvIHRoZSBwcm9wZXJ0eSBvZiBhbiBhdHRyaWJ1dGUgYmluZGluZyB3aWxsIHJlc3VsdCBpbiBhdXRvbWF0aWMKICAgIHVwZGF0ZSBvZiB0aGUgIEhUTUwgYXR0cmlidXRlIGluIHRoZSBjb21wb25lbnQncyBIVE1MIG91dHB1dC4KICAKICAgIGBhdHRyaWJ1dGVCaW5kaW5nc2AgaXMgYSBjb25jYXRlbmF0ZWQgcHJvcGVydHkuIFNlZQogICAgW0VtYmVyT2JqZWN0XSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0VtYmVyT2JqZWN0KSBkb2N1bWVudGF0aW9uIGZvciBtb3JlCiAgICBpbmZvcm1hdGlvbiBhYm91dCBjb25jYXRlbmF0ZWQgcHJvcGVydGllcy4KICAKICAgICMjIExheW91dHMKICAKICAgIFRoZSBgbGF5b3V0YCBwcm9wZXJ0eSBjYW4gYmUgdXNlZCB0byBkeW5hbWljYWxseSBzcGVjaWZ5IGEgdGVtcGxhdGUgYXNzb2NpYXRlZAogICAgd2l0aCBhIGNvbXBvbmVudCBjbGFzcywgaW5zdGVhZCBvZiByZWx5aW5nIG9uIEVtYmVyIHRvIGxpbmsgdG9nZXRoZXIgYQogICAgY29tcG9uZW50IGNsYXNzIGFuZCBhIHRlbXBsYXRlIGJhc2VkIG9uIGZpbGUgbmFtZXMuCiAgCiAgICBJbiBnZW5lcmFsLCBhcHBsaWNhdGlvbnMgc2hvdWxkIG5vdCB1c2UgdGhpcyBmZWF0dXJlLCBidXQgaXQncyBjb21tb25seSB1c2VkCiAgICBpbiBhZGRvbnMgZm9yIGhpc3RvcmljYWwgcmVhc29ucy4KICAKICAgIFRoZSBgbGF5b3V0YCBwcm9wZXJ0eSBzaG91bGQgYmUgc2V0IHRvIHRoZSBkZWZhdWx0IGV4cG9ydCBvZiBhIHRlbXBsYXRlCiAgICBtb2R1bGUsIHdoaWNoIGlzIHRoZSBuYW1lIG9mIGEgdGVtcGxhdGUgZmlsZSB3aXRob3V0IHRoZSBgLmhic2AgZXh0ZW5zaW9uLgogIAogICAgYGBgYXBwL3RlbXBsYXRlcy9jb21wb25lbnRzL3BlcnNvbi1wcm9maWxlLmhicwogICAgPGgxPlBlcnNvbidzIFRpdGxlPC9oMT4KICAgIDxkaXYgY2xhc3M9J2RldGFpbHMnPnt7eWllbGR9fTwvZGl2PgogICAgYGBgCiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9wZXJzb24tcHJvZmlsZS5qcwogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgICBpbXBvcnQgbGF5b3V0IGZyb20gJy4uL3RlbXBsYXRlcy9jb21wb25lbnRzL3BlcnNvbi1wcm9maWxlJzsKICAKICAgICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgbGF5b3V0CiAgICAgIH0pOwogICAgYGBgCiAgCiAgICBJZiB5b3UgaW52b2tlIHRoZSBjb21wb25lbnQ6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICA8UGVyc29uUHJvZmlsZT4KICAgICAgPGgyPkNoaWVmIEJhc2tldCBXZWF2ZXI8L2gyPgogICAgICA8aDM+RmlzaGVybWFuIEluZHVzdHJpZXM8L2gzPgogICAgPC9QZXJzb25Qcm9maWxlPgogICAgYGBgCiAgCiAgICBvcgogIAogICAgYGBgaGFuZGxlYmFycwogICAge3sjcGVyc29uLXByb2ZpbGV9fQogICAgICA8aDI+Q2hpZWYgQmFza2V0IFdlYXZlcjwvaDI+CiAgICAgIDxoMz5GaXNoZXJtYW4gSW5kdXN0cmllczwvaDM+CiAgICB7ey9wZXJzb24tcHJvZmlsZX19CiAgICBgYGAKICAKICAgIEl0IHdpbGwgcmVzdWx0IGluIHRoZSBmb2xsb3dpbmcgSFRNTCBvdXRwdXQ6CiAgCiAgICBgYGBodG1sCiAgICA8aDE+UGVyc29uJ3MgVGl0bGU8L2gxPgogICAgICA8ZGl2IGNsYXNzPSJkZXRhaWxzIj4KICAgICAgPGgyPkNoaWVmIEJhc2tldCBXZWF2ZXI8L2gyPgogICAgICA8aDM+RmlzaGVybWFuIEluZHVzdHJpZXM8L2gzPgogICAgPC9kaXY+CiAgICBgYGAKICAKICAgICMjIEhhbmRsaW5nIEJyb3dzZXIgRXZlbnRzCiAgCiAgICBDb21wb25lbnRzIGNhbiByZXNwb25kIHRvIHVzZXItaW5pdGlhdGVkIGV2ZW50cyBpbiBvbmUgb2YgdGhyZWUgd2F5czogcGFzc2luZwogICAgYWN0aW9ucyB3aXRoIGFuZ2xlIGJyYWNrZXQgaW52b2NhdGlvbiwgYWRkaW5nIGV2ZW50IGhhbmRsZXIgbWV0aG9kcyB0byB0aGUKICAgIGNvbXBvbmVudCdzIGNsYXNzLCBvciBhZGRpbmcgYWN0aW9ucyB0byB0aGUgY29tcG9uZW50J3MgdGVtcGxhdGUuCiAgCiAgICAjIyMgUGFzc2luZyBBY3Rpb25zIFdpdGggQW5nbGUgQnJhY2tldCBJbnZvYXRpb24KICAKICAgIEZvciBvbmUtb2ZmIGV2ZW50cyBzcGVjaWZpYyB0byBwYXJ0aWN1bGFyIGluc3RhbmNlIG9mIGEgY29tcG9uZW50LCBpdCBpcyBwb3NzaWJsZQogICAgdG8gcGFzcyBhY3Rpb25zIHRvIHRoZSBjb21wb25lbnQncyBlbGVtZW50IHVzaW5nIGFuZ2xlIGJyYWNrZXQgaW52b2F0aW9uIHN5bnRheC4KICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxNeVdpZGdldCB7e2FjdGlvbiAnZmlyc3RXaWRnZXRDbGlja2VkJ319IC8+CiAgCiAgICA8TXlXaWRnZXQge3thY3Rpb24gJ3NlY29uZFdpZGdldENsaWNrZWQnfX0gLz4KICAgIGBgYAogIAogICAgSW4gdGhpcyBjYXNlLCB3aGVuIHRoZSBmaXJzdCBjb21wb25lbnQgaXMgY2xpY2tlZCBvbiwgRW1iZXIgd2lsbCBpbnZva2UgdGhlCiAgICBgZmlyc3RXaWRnZXRDbGlja2VkYCBhY3Rpb24uIFdoZW4gdGhlIHNlY29uZCBjb21wb25lbnQgaXMgY2xpY2tlZCBvbiwgRW1iZXIKICAgIHdpbGwgaW52b2tlIHRoZSBgc2Vjb25kV2lkZ2V0Q2xpY2tlZGAgYWN0aW9uIGluc3RlYWQuCiAgCiAgICBCZXNpZGVzIGB7e2FjdGlvbn19YCwgaXQgaXMgYWxzbyBwb3NzaWJsZSB0byBwYXNzIGFueSBhcmJpdHJhcnkgZWxlbWVudCBtb2RpZmllcnMKICAgIHVzaW5nIHRoZSBhbmdsZSBicmFja2V0IGludm9jYXRpb24gc3ludGF4LgogIAogICAgIyMjIEV2ZW50IEhhbmRsZXIgTWV0aG9kcwogIAogICAgQ29tcG9uZW50cyBjYW4gYWxzbyByZXNwb25kIHRvIHVzZXItaW5pdGlhdGVkIGV2ZW50cyBieSBpbXBsZW1lbnRpbmcgYSBtZXRob2QKICAgIHRoYXQgbWF0Y2hlcyB0aGUgZXZlbnQgbmFtZS4gVGhpcyBhcHByb2FjaCBpcyBhcHByb3BpYXRlIHdoZW4gdGhlIHNhbWUgZXZlbnQKICAgIHNob3VsZCBiZSBoYW5kbGVkIGJ5IGFsbCBpbnN0YW5jZXMgb2YgdGhlIHNhbWUgY29tcG9uZW50LgogIAogICAgQW4gZXZlbnQgb2JqZWN0IHdpbGwgYmUgcGFzc2VkIGFzIHRoZSBhcmd1bWVudCB0byB0aGUgZXZlbnQgaGFuZGxlciBtZXRob2QuCiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9teS13aWRnZXQuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgY2xpY2soZXZlbnQpIHsKICAgICAgICAvLyBgZXZlbnQudGFyZ2V0YCBpcyBlaXRoZXIgdGhlIGNvbXBvbmVudCdzIGVsZW1lbnQgb3Igb25lIG9mIGl0cyBjaGlsZHJlbgogICAgICAgIGxldCB0YWcgPSBldmVudC50YXJnZXQudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGNvbnNvbGUubG9nKCdjbGlja2VkIG9uIGEgYDwke3RhZ30+YCBIVE1MIGVsZW1lbnQhJyk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBJbiB0aGlzIGV4YW1wbGUsIHdoZW5ldmVyIHRoZSB1c2VyIGNsaWNrZWQgYW55d2hlcmUgaW5zaWRlIHRoZSBjb21wb25lbnQsIGl0CiAgICB3aWxsIGxvZyBhIG1lc3NhZ2UgdG8gdGhlIGNvbnNvbGUuCiAgCiAgICBJdCBpcyBwb3NzaWJsZSB0byBoYW5kbGUgZXZlbnQgdHlwZXMgb3RoZXIgdGhhbiBgY2xpY2tgIGJ5IGltcGxlbWVudGluZyB0aGUKICAgIGZvbGxvd2luZyBldmVudCBoYW5kbGVyIG1ldGhvZHMuIEluIGFkZGl0aW9uLCBjdXN0b20gZXZlbnRzIGNhbiBiZSByZWdpc3RlcmVkCiAgICBieSB1c2luZyBgQXBwbGljYXRpb24uY3VzdG9tRXZlbnRzYC4KICAKICAgIFRvdWNoIGV2ZW50czoKICAKICAgICogYHRvdWNoU3RhcnRgCiAgICAqIGB0b3VjaE1vdmVgCiAgICAqIGB0b3VjaEVuZGAKICAgICogYHRvdWNoQ2FuY2VsYAogIAogICAgS2V5Ym9hcmQgZXZlbnRzOgogIAogICAgKiBga2V5RG93bmAKICAgICogYGtleVVwYAogICAgKiBga2V5UHJlc3NgCiAgCiAgICBNb3VzZSBldmVudHM6CiAgCiAgICAqIGBtb3VzZURvd25gCiAgICAqIGBtb3VzZVVwYAogICAgKiBgY29udGV4dE1lbnVgCiAgICAqIGBjbGlja2AKICAgICogYGRvdWJsZUNsaWNrYAogICAgKiBgZm9jdXNJbmAKICAgICogYGZvY3VzT3V0YAogIAogICAgRm9ybSBldmVudHM6CiAgCiAgICAqIGBzdWJtaXRgCiAgICAqIGBjaGFuZ2VgCiAgICAqIGBmb2N1c0luYAogICAgKiBgZm9jdXNPdXRgCiAgICAqIGBpbnB1dGAKICAKICAgIERyYWcgYW5kIGRyb3AgZXZlbnRzOgogIAogICAgKiBgZHJhZ1N0YXJ0YAogICAgKiBgZHJhZ2AKICAgICogYGRyYWdFbnRlcmAKICAgICogYGRyYWdMZWF2ZWAKICAgICogYGRyYWdPdmVyYAogICAgKiBgZHJhZ0VuZGAKICAgICogYGRyb3BgCiAgCiAgICAjIyMgYHt7YWN0aW9ufX1gIEhlbHBlcgogIAogICAgSW5zdGVhZCBvZiBoYW5kbGluZyBhbGwgZXZlbnRzIG9mIGEgcGFydGljdWxhciB0eXBlIGFueXdoZXJlIGluc2lkZSB0aGUKICAgIGNvbXBvbmVudCdzIGVsZW1lbnQsIHlvdSBtYXkgaW5zdGVhZCB3YW50IHRvIGxpbWl0IGl0IHRvIGEgcGFydGljdWxhcgogICAgZWxlbWVudCBpbiB0aGUgY29tcG9uZW50J3MgdGVtcGxhdGUuIEluIHRoaXMgY2FzZSwgaXQgd291bGQgYmUgbW9yZQogICAgY29udmVuaWVudCB0byBpbXBsZW1lbnQgYW4gYWN0aW9uIGluc3RlYWQuCiAgCiAgICBGb3IgZXhhbXBsZSwgeW91IGNvdWxkIGltcGxlbWVudCB0aGUgYWN0aW9uIGBoZWxsb2AgZm9yIHRoZSBgcGVyc29uLXByb2ZpbGVgCiAgICBjb21wb25lbnQ6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9wZXJzb24tcHJvZmlsZS5qcwogICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgaGVsbG8obmFtZSkgewogICAgICAgICAgY29uc29sZS5sb2coIkhlbGxvIiwgbmFtZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgQW5kIHRoZW4gdXNlIGl0IGluIHRoZSBjb21wb25lbnQncyB0ZW1wbGF0ZToKICAKICAgIGBgYGFwcC90ZW1wbGF0ZXMvY29tcG9uZW50cy9wZXJzb24tcHJvZmlsZS5oYnMKICAgIDxoMT57e0BwZXJzb24ubmFtZX19PC9oMT4KICAKICAgIDxidXR0b24ge3thY3Rpb24gJ2hlbGxvJyBAcGVyc29uLm5hbWV9fT4KICAgICAgU2F5IEhlbGxvIHRvIHt7QHBlcnNvbi5uYW1lfX0KICAgIDwvYnV0dG9uPgogICAgYGBgCiAgCiAgICBXaGVuIHRoZSB1c2VyIGNsaWNrcyB0aGUgYnV0dG9uLCBFbWJlciB3aWxsIGludm9rZSB0aGUgYGhlbGxvYCBhY3Rpb24sCiAgICBwYXNzaW5nIGluIHRoZSBjdXJyZW50IHZhbHVlIG9mIGBAcGVyc29uLm5hbWVgIGFzIGFuIGFyZ3VtZW50LgogIAogICAgU2VlIFtFbWJlci5UZW1wbGF0ZXMuaGVscGVycy5hY3Rpb25dKC9lbWJlci9yZWxlYXNlL2NsYXNzZXMvRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMvbWV0aG9kcy9hY3Rpb24/YW5jaG9yPWFjdGlvbikuCiAgCiAgICBAY2xhc3MgQ29tcG9uZW50CiAgICBAZXh0ZW5kcyBFbWJlci5Db3JlVmlldwogICAgQHVzZXMgRW1iZXIuVGFyZ2V0QWN0aW9uU3VwcG9ydAogICAgQHVzZXMgRW1iZXIuQ2xhc3NOYW1lc1N1cHBvcnQKICAgIEB1c2VzIEVtYmVyLkFjdGlvblN1cHBvcnQKICAgIEB1c2VzIEVtYmVyLlZpZXdNaXhpbgogICAgQHVzZXMgRW1iZXIuVmlld1N0YXRlU3VwcG9ydAogICAgQHB1YmxpYwogICovCgogIHZhciBDb21wb25lbnQgPSBfdmlld3MuQ29yZVZpZXcuZXh0ZW5kKF92aWV3cy5DaGlsZFZpZXdzU3VwcG9ydCwgX3ZpZXdzLlZpZXdTdGF0ZVN1cHBvcnQsIF92aWV3cy5DbGFzc05hbWVzU3VwcG9ydCwgX3J1bnRpbWUuVGFyZ2V0QWN0aW9uU3VwcG9ydCwgX3ZpZXdzLkFjdGlvblN1cHBvcnQsIF92aWV3cy5WaWV3TWl4aW4sIChfQ29yZVZpZXckZXh0ZW5kID0gewogICAgaXNDb21wb25lbnQ6IHRydWUsCiAgICBpbml0OiBmdW5jdGlvbiBpbml0KCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgdGhpc1tJU19ESVNQQVRDSElOR19BVFRSU10gPSBmYWxzZTsKICAgICAgdGhpc1tESVJUWV9UQUddID0gKDAsIF9yZWZlcmVuY2UuY3JlYXRlVGFnKSgpOwogICAgICB0aGlzW1JPT1RfUkVGXSA9IG5ldyBSb290UmVmZXJlbmNlKHRoaXMpOwogICAgICB0aGlzW0JPVU5EU10gPSBudWxsOwoKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICYmIHRoaXMucmVuZGVyZXIuX2Rlc3RpbmVkRm9yRE9NICYmIHRoaXMudGFnTmFtZSA9PT0gJycpIHsKICAgICAgICB2YXIgZXZlbnROYW1lcyA9IFtdOwogICAgICAgIHZhciBldmVudERpc3BhdGNoZXIgPSAoMCwgX293bmVyLmdldE93bmVyKSh0aGlzKS5sb29rdXAoJ2V2ZW50X2Rpc3BhdGNoZXI6bWFpbicpOwogICAgICAgIHZhciBldmVudHMgPSBldmVudERpc3BhdGNoZXIgJiYgZXZlbnREaXNwYXRjaGVyLl9maW5hbEV2ZW50cyB8fCB7fTsgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmZvcmluCgogICAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsKICAgICAgICAgIHZhciBtZXRob2ROYW1lID0gZXZlbnRzW2tleV07CgogICAgICAgICAgaWYgKHR5cGVvZiB0aGlzW21ldGhvZE5hbWVdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGV2ZW50TmFtZXMucHVzaChtZXRob2ROYW1lKTsKICAgICAgICAgIH0KICAgICAgICB9IC8vIElmIGluIGEgdGFnbGVzcyBjb21wb25lbnQsIGFzc2VydCB0aGF0IG5vIGV2ZW50IGhhbmRsZXJzIGFyZSBkZWZpbmVkCgoKICAgICAgICAoZmFsc2UgJiYgISghZXZlbnROYW1lcy5sZW5ndGgpICYmICgwLCBfZGVidWcuYXNzZXJ0KSggLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aAogICAgICAgICJZb3UgY2FuIG5vdCBkZWZpbmUgYCIgKyBldmVudE5hbWVzICsgImAgZnVuY3Rpb24ocykgdG8gaGFuZGxlIERPTSBldmVudCBpbiB0aGUgYCIgKyB0aGlzICsgImAgdGFnbGVzcyBjb21wb25lbnQgc2luY2UgaXQgZG9lc24ndCBoYXZlIGFueSBET00gZWxlbWVudC4iLCAhZXZlbnROYW1lcy5sZW5ndGgpKTsKICAgICAgfQoKICAgICAgKGZhbHNlICYmICEodGhpcy5tb3VzZUVudGVyID09PSB1bmRlZmluZWQpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgiVXNpbmcgYG1vdXNlRW50ZXJgIGV2ZW50IGhhbmRsZXIgbWV0aG9kcyBpbiBjb21wb25lbnRzIGhhcyBiZWVuIGRlcHJlY2F0ZWQuIiwgdGhpcy5tb3VzZUVudGVyID09PSB1bmRlZmluZWQsIHsKICAgICAgICBpZDogJ2VtYmVyLXZpZXdzLmV2ZW50LWRpc3BhdGNoZXIubW91c2VlbnRlci1sZWF2ZS1tb3ZlJywKICAgICAgICB1bnRpbDogJzQuMC4wJywKICAgICAgICB1cmw6ICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92My54I3RvY19jb21wb25lbnQtbW91c2VlbnRlci1sZWF2ZS1tb3ZlJwogICAgICB9KSk7CiAgICAgIChmYWxzZSAmJiAhKHRoaXMubW91c2VMZWF2ZSA9PT0gdW5kZWZpbmVkKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoIlVzaW5nIGBtb3VzZUxlYXZlYCBldmVudCBoYW5kbGVyIG1ldGhvZHMgaW4gY29tcG9uZW50cyBoYXMgYmVlbiBkZXByZWNhdGVkLiIsIHRoaXMubW91c2VMZWF2ZSA9PT0gdW5kZWZpbmVkLCB7CiAgICAgICAgaWQ6ICdlbWJlci12aWV3cy5ldmVudC1kaXNwYXRjaGVyLm1vdXNlZW50ZXItbGVhdmUtbW92ZScsCiAgICAgICAgdW50aWw6ICc0LjAuMCcsCiAgICAgICAgdXJsOiAnaHR0cHM6Ly9lbWJlcmpzLmNvbS9kZXByZWNhdGlvbnMvdjMueCN0b2NfY29tcG9uZW50LW1vdXNlZW50ZXItbGVhdmUtbW92ZScKICAgICAgfSkpOwogICAgICAoZmFsc2UgJiYgISh0aGlzLm1vdXNlTW92ZSA9PT0gdW5kZWZpbmVkKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoIlVzaW5nIGBtb3VzZU1vdmVgIGV2ZW50IGhhbmRsZXIgbWV0aG9kcyBpbiBjb21wb25lbnRzIGhhcyBiZWVuIGRlcHJlY2F0ZWQuIiwgdGhpcy5tb3VzZU1vdmUgPT09IHVuZGVmaW5lZCwgewogICAgICAgIGlkOiAnZW1iZXItdmlld3MuZXZlbnQtZGlzcGF0Y2hlci5tb3VzZWVudGVyLWxlYXZlLW1vdmUnLAogICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgIHVybDogJ2h0dHBzOi8vZW1iZXJqcy5jb20vZGVwcmVjYXRpb25zL3YzLngjdG9jX2NvbXBvbmVudC1tb3VzZWVudGVyLWxlYXZlLW1vdmUnCiAgICAgIH0pKTsKICAgIH0sCiAgICByZXJlbmRlcjogZnVuY3Rpb24gcmVyZW5kZXIoKSB7CiAgICAgICgwLCBfcmVmZXJlbmNlLmRpcnR5KSh0aGlzW0RJUlRZX1RBR10pOwoKICAgICAgdGhpcy5fc3VwZXIoKTsKICAgIH0KICB9LCBfQ29yZVZpZXckZXh0ZW5kW19tZXRhbC5QUk9QRVJUWV9ESURfQ0hBTkdFXSA9IGZ1bmN0aW9uIChrZXkpIHsKICAgIGlmICh0aGlzW0lTX0RJU1BBVENISU5HX0FUVFJTXSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGFyZ3MgPSB0aGlzW0FSR1NdOwogICAgdmFyIHJlZmVyZW5jZSA9IGFyZ3MgIT09IHVuZGVmaW5lZCA/IGFyZ3Nba2V5XSA6IHVuZGVmaW5lZDsKCiAgICBpZiAocmVmZXJlbmNlICE9PSB1bmRlZmluZWQgJiYgcmVmZXJlbmNlW1VQREFURV0gIT09IHVuZGVmaW5lZCkgewogICAgICByZWZlcmVuY2VbVVBEQVRFXSgoMCwgX21ldGFsLmdldCkodGhpcywga2V5KSk7CiAgICB9CiAgfSwgX0NvcmVWaWV3JGV4dGVuZC5nZXRBdHRyID0gZnVuY3Rpb24gZ2V0QXR0cihrZXkpIHsKICAgIC8vIFRPRE8gSW50aW1hdGUgQVBJIHNob3VsZCBiZSBkZXByZWNhdGVkCiAgICByZXR1cm4gdGhpcy5nZXQoa2V5KTsKICB9LCBfQ29yZVZpZXckZXh0ZW5kLnJlYWRET01BdHRyID0gZnVuY3Rpb24gcmVhZERPTUF0dHIobmFtZSkgewogICAgLy8gVE9ETyByZXZpc2l0IHRoaXMKICAgIHZhciBfZWxlbWVudCA9ICgwLCBfdmlld3MuZ2V0Vmlld0VsZW1lbnQpKHRoaXMpOwoKICAgIChmYWxzZSAmJiAhKF9lbGVtZW50ICE9PSBudWxsKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkNhbm5vdCBjYWxsIGByZWFkRE9NQXR0cmAgb24gIiArIHRoaXMgKyAiIHdoaWNoIGRvZXMgbm90IGhhdmUgYW4gZWxlbWVudCIsIF9lbGVtZW50ICE9PSBudWxsKSk7CiAgICB2YXIgZWxlbWVudCA9IF9lbGVtZW50OwogICAgdmFyIGlzU1ZHID0gZWxlbWVudC5uYW1lc3BhY2VVUkkgPT09IF9ydW50aW1lMi5TVkdfTkFNRVNQQUNFOwoKICAgIHZhciBfbm9ybWFsaXplUHJvcGVydHkgPSAoMCwgX3J1bnRpbWUyLm5vcm1hbGl6ZVByb3BlcnR5KShlbGVtZW50LCBuYW1lKSwKICAgICAgICB0eXBlID0gX25vcm1hbGl6ZVByb3BlcnR5LnR5cGUsCiAgICAgICAgbm9ybWFsaXplZCA9IF9ub3JtYWxpemVQcm9wZXJ0eS5ub3JtYWxpemVkOwoKICAgIGlmIChpc1NWRyB8fCB0eXBlID09PSAnYXR0cicpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQuZ2V0QXR0cmlidXRlKG5vcm1hbGl6ZWQpOwogICAgfQoKICAgIHJldHVybiBlbGVtZW50W25vcm1hbGl6ZWRdOwogIH0sIF9Db3JlVmlldyRleHRlbmQuZGlkUmVjZWl2ZUF0dHJzID0gZnVuY3Rpb24gZGlkUmVjZWl2ZUF0dHJzKCkge30sIF9Db3JlVmlldyRleHRlbmQuZGlkUmVuZGVyID0gZnVuY3Rpb24gZGlkUmVuZGVyKCkge30sIF9Db3JlVmlldyRleHRlbmQud2lsbFJlbmRlciA9IGZ1bmN0aW9uIHdpbGxSZW5kZXIoKSB7fSwgX0NvcmVWaWV3JGV4dGVuZC5kaWRVcGRhdGVBdHRycyA9IGZ1bmN0aW9uIGRpZFVwZGF0ZUF0dHJzKCkge30sIF9Db3JlVmlldyRleHRlbmQud2lsbFVwZGF0ZSA9IGZ1bmN0aW9uIHdpbGxVcGRhdGUoKSB7fSwgX0NvcmVWaWV3JGV4dGVuZC5kaWRVcGRhdGUgPSBmdW5jdGlvbiBkaWRVcGRhdGUoKSB7fSwgX0NvcmVWaWV3JGV4dGVuZCkpOwoKICBfZXhwb3J0cy5Db21wb25lbnQgPSBDb21wb25lbnQ7CgogIENvbXBvbmVudC50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiAnQGVtYmVyL2NvbXBvbmVudCc7CiAgfTsKCiAgQ29tcG9uZW50LnJlb3BlbkNsYXNzKHsKICAgIGlzQ29tcG9uZW50RmFjdG9yeTogdHJ1ZSwKICAgIHBvc2l0aW9uYWxQYXJhbXM6IFtdCiAgfSk7CiAgKDAsIF9ydW50aW1lLnNldEZyYW1ld29ya0NsYXNzKShDb21wb25lbnQpOwogIHZhciBsYXlvdXQgPSB0ZW1wbGF0ZSh7CiAgICAiaWQiOiAiaHZ0c3o3UkYiLAogICAgImJsb2NrIjogIntcInN5bWJvbHNcIjpbXSxcInN0YXRlbWVudHNcIjpbXSxcImhhc0V2YWxcIjpmYWxzZX0iLAogICAgIm1ldGEiOiB7CiAgICAgICJtb2R1bGVOYW1lIjogInBhY2thZ2VzL0BlbWJlci8taW50ZXJuYWxzL2dsaW1tZXIvbGliL3RlbXBsYXRlcy9lbXB0eS5oYnMiCiAgICB9CiAgfSk7CiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvY29tcG9uZW50CiAgKi8KCiAgLyoqCiAgICBUaGUgaW50ZXJuYWwgY2xhc3MgdXNlZCB0byBjcmVhdGUgdGV4dCBpbnB1dHMgd2hlbiB0aGUgYHt7aW5wdXR9fWAKICAgIGhlbHBlciBpcyB1c2VkIHdpdGggYHR5cGVgIG9mIGBjaGVja2JveGAuCiAgCiAgICBTZWUgW0VtYmVyLlRlbXBsYXRlcy5oZWxwZXJzLmlucHV0XSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0VtYmVyLlRlbXBsYXRlcy5oZWxwZXJzL21ldGhvZHMvaW5wdXQ/YW5jaG9yPWlucHV0KSAgZm9yIHVzYWdlIGRldGFpbHMuCiAgCiAgICAjIyBEaXJlY3QgbWFuaXB1bGF0aW9uIG9mIGBjaGVja2VkYAogIAogICAgVGhlIGBjaGVja2VkYCBhdHRyaWJ1dGUgb2YgYW4gYENoZWNrYm94YCBvYmplY3Qgc2hvdWxkIGFsd2F5cyBiZSBzZXQKICAgIHRocm91Z2ggdGhlIEVtYmVyIG9iamVjdCBvciBieSBpbnRlcmFjdGluZyB3aXRoIGl0cyByZW5kZXJlZCBlbGVtZW50CiAgICByZXByZXNlbnRhdGlvbiB2aWEgdGhlIG1vdXNlLCBrZXlib2FyZCwgb3IgdG91Y2guIFVwZGF0aW5nIHRoZSB2YWx1ZSBvZiB0aGUKICAgIGNoZWNrYm94IHZpYSBqUXVlcnkgd2lsbCByZXN1bHQgaW4gdGhlIGNoZWNrZWQgdmFsdWUgb2YgdGhlIG9iamVjdCBhbmQgaXRzCiAgICBlbGVtZW50IGxvc2luZyBzeW5jaHJvbml6YXRpb24uCiAgCiAgICAjIyBMYXlvdXQgYW5kIExheW91dE5hbWUgcHJvcGVydGllcwogIAogICAgQmVjYXVzZSBIVE1MIGBpbnB1dGAgZWxlbWVudHMgYXJlIHNlbGYgY2xvc2luZyBgbGF5b3V0YCBhbmQgYGxheW91dE5hbWVgCiAgICBwcm9wZXJ0aWVzIHdpbGwgbm90IGJlIGFwcGxpZWQuCiAgCiAgICBAY2xhc3MgQ2hlY2tib3gKICAgIEBleHRlbmRzIENvbXBvbmVudAogICAgQHB1YmxpYwogICovCgogIHZhciBDaGVja2JveCA9IENvbXBvbmVudC5leHRlbmQoewogICAgbGF5b3V0OiBsYXlvdXQsCgogICAgLyoqCiAgICAgIEJ5IGRlZmF1bHQsIHRoaXMgY29tcG9uZW50IHdpbGwgYWRkIHRoZSBgZW1iZXItY2hlY2tib3hgIGNsYXNzIHRvIHRoZSBjb21wb25lbnQncyBlbGVtZW50LgogICAgICAgICBAcHJvcGVydHkgY2xhc3NOYW1lcwogICAgICBAdHlwZSBBcnJheSB8IFN0cmluZwogICAgICBAZGVmYXVsdCBbJ2VtYmVyLWNoZWNrYm94J10KICAgICAgQHB1YmxpYwogICAgICovCiAgICBjbGFzc05hbWVzOiBbJ2VtYmVyLWNoZWNrYm94J10sCiAgICB0YWdOYW1lOiAnaW5wdXQnLAoKICAgIC8qKgogICAgICBCeSBkZWZhdWx0IHRoaXMgY29tcG9uZW50IHdpbGwgZm9yd2FyZCBhIG51bWJlciBvZiBhcmd1bWVudHMgdG8gYXR0cmlidXRlcyBvbiB0aGUgdGhlCiAgICAgIGNvbXBvbmVudCdzIGVsZW1lbnQ6CiAgICAgICAgICogaW5kZXRlcm1pbmF0ZQogICAgICAqIGRpc2FibGVkCiAgICAgICogdGFiaW5kZXgKICAgICAgKiBuYW1lCiAgICAgICogYXV0b2ZvY3VzCiAgICAgICogcmVxdWlyZWQKICAgICAgKiBmb3JtCiAgICAgICAgIFdoZW4gaW52b2tlZCB3aXRoIGN1cmx5IGJyYWNlcywgdGhpcyBpcyB0aGUgZXhoYXVzdGl2ZSBsaXN0IG9mIEhUTUwgYXR0cmlidXRlcyB5b3UgY2FuCiAgICAgIGN1c3RvbWl6ZSAoaS5lLiBge3tpbnB1dCB0eXBlPSJjaGVja2JveCIgZGlzYWJsZWQ9dHJ1ZX19YCkuCiAgICAgICAgIFdoZW4gaW52b2tlZCB3aXRoIGFuZ2xlIGJyYWNrZXQgaW52b2NhdGlvbiwgdGhpcyBsaXN0IGlzIGlycmVsZXZhbnQsIGJlY2F1c2UgeW91IGNhbiB1c2UgSFRNTAogICAgICBhdHRyaWJ1dGUgc3ludGF4IHRvIGN1c3RvbWl6ZSB0aGUgZWxlbWVudCAoaS5lLgogICAgICBgPElucHV0IEB0eXBlPSJjaGVja2JveCIgZGlzYWJsZWQgZGF0YS1jdXN0b209ImN1c3RvbSB2YWx1ZSIgLz5gKS4gSG93ZXZlciwgYEB0eXBlYCBhbmQKICAgICAgYEBjaGVja2VkYCBtdXN0IGJlIHBhc3NlZCBhcyBuYW1lZCBhcmd1bWVudHMsIG5vdCBhdHRyaWJ1dGVzLgogICAgICAgICBAcHJvcGVydHkgYXR0cmlidXRlQmluZGluZ3MKICAgICAgQHR5cGUgQXJyYXkgfCBTdHJpbmcKICAgICAgQGRlZmF1bHQgWyd0eXBlJywgJ2NoZWNrZWQnLCAnaW5kZXRlcm1pbmF0ZScsICdkaXNhYmxlZCcsICd0YWJpbmRleCcsICduYW1lJywgJ2F1dG9mb2N1cycsICdyZXF1aXJlZCcsICdmb3JtJ10KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ3R5cGUnLCAnY2hlY2tlZCcsICdpbmRldGVybWluYXRlJywgJ2Rpc2FibGVkJywgJ3RhYmluZGV4JywgJ25hbWUnLCAnYXV0b2ZvY3VzJywgJ3JlcXVpcmVkJywgJ2Zvcm0nXSwKCiAgICAvKioKICAgICAgU2V0cyB0aGUgYHR5cGVgIGF0dHJpYnV0ZSBvZiB0aGUgYENoZWNrYm94YCdzIGVsZW1lbnQKICAgICAgICAgQHByb3BlcnR5IGRpc2FibGVkCiAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgIEBwcml2YXRlCiAgICAgKi8KICAgIHR5cGU6ICdjaGVja2JveCcsCgogICAgLyoqCiAgICAgIFNldHMgdGhlIGBkaXNhYmxlZGAgYXR0cmlidXRlIG9mIHRoZSBgQ2hlY2tib3hgJ3MgZWxlbWVudAogICAgICAgICBAcHJvcGVydHkgZGlzYWJsZWQKICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgQHB1YmxpYwogICAgICovCiAgICBkaXNhYmxlZDogZmFsc2UsCgogICAgLyoqCiAgICAgIENvcnJlc3BvbmRzIHRvIHRoZSBgaW5kZXRlcm1pbmF0ZWAgcHJvcGVydHkgb2YgdGhlIGBDaGVja2JveGAncyBlbGVtZW50CiAgICAgICAgIEBwcm9wZXJ0eSBkaXNhYmxlZAogICAgICBAZGVmYXVsdCBmYWxzZQogICAgICBAcHVibGljCiAgICAgKi8KICAgIGluZGV0ZXJtaW5hdGU6IGZhbHNlLAoKICAgIC8qKgogICAgICBXaGVuZXZlciB0aGUgY2hlY2tib3ggaXMgaW5zZXJ0ZWQgaW50byB0aGUgRE9NLCBwZXJmb3JtIGluaXRpYWxpemF0aW9uIHN0ZXBzLCB3aGljaCBpbmNsdWRlCiAgICAgIHNldHRpbmcgdGhlIGluZGV0ZXJtaW5hdGUgcHJvcGVydHkgaWYgbmVlZGVkLgogICAgICAgICBJZiB0aGlzIG1ldGhvZCBpcyBvdmVycmlkZGVuLCBgc3VwZXJgIG11c3QgYmUgY2FsbGVkLgogICAgICAgICBAbWV0aG9kCiAgICAgIEBwdWJsaWMKICAgICAqLwogICAgZGlkSW5zZXJ0RWxlbWVudDogZnVuY3Rpb24gZGlkSW5zZXJ0RWxlbWVudCgpIHsKICAgICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgIHRoaXMuZWxlbWVudC5pbmRldGVybWluYXRlID0gQm9vbGVhbih0aGlzLmluZGV0ZXJtaW5hdGUpOwogICAgfSwKCiAgICAvKioKICAgICAgV2hlbmV2ZXIgdGhlIGBjaGFuZ2VgIGV2ZW50IGlzIGZpcmVkIG9uIHRoZSBjaGVja2JveCwgdXBkYXRlIGl0cyBgY2hlY2tlZGAgcHJvcGVydHkgdG8gcmVmbGVjdAogICAgICB3aGV0aGVyIHRoZSBjaGVja2JveCBpcyBjaGVja2VkLgogICAgICAgICBJZiB0aGlzIG1ldGhvZCBpcyBvdmVycmlkZGVuLCBgc3VwZXJgIG11c3QgYmUgY2FsbGVkLgogICAgICAgICBAbWV0aG9kCiAgICAgIEBwdWJsaWMKICAgICAqLwogICAgY2hhbmdlOiBmdW5jdGlvbiBjaGFuZ2UoKSB7CiAgICAgICgwLCBfbWV0YWwuc2V0KSh0aGlzLCAnY2hlY2tlZCcsIHRoaXMuZWxlbWVudC5jaGVja2VkKTsKICAgIH0KICB9KTsKICBfZXhwb3J0cy5DaGVja2JveCA9IENoZWNrYm94OwoKICBpZiAoZmFsc2UKICAvKiBERUJVRyAqLwogICkgewogICAgdmFyIFVOU0VUID0ge307CiAgICBDaGVja2JveC5yZW9wZW4oewogICAgICB2YWx1ZTogVU5TRVQsCiAgICAgIGRpZFJlY2VpdmVBdHRyczogZnVuY3Rpb24gZGlkUmVjZWl2ZUF0dHJzKCkgewogICAgICAgIHRoaXMuX3N1cGVyKCk7CgogICAgICAgIChmYWxzZSAmJiAhKCEodGhpcy50eXBlID09PSAnY2hlY2tib3gnICYmIHRoaXMudmFsdWUgIT09IFVOU0VUKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJgPElucHV0IEB0eXBlPSdjaGVja2JveCcgQHZhbHVlPXt7Li4ufX0gLz5gIGlzIG5vdCBzdXBwb3J0ZWQ7ICIgKyAicGxlYXNlIHVzZSBgPElucHV0IEB0eXBlPSdjaGVja2JveCcgQGNoZWNrZWQ9e3suLi59fSAvPmAgaW5zdGVhZC4iLCAhKHRoaXMudHlwZSA9PT0gJ2NoZWNrYm94JyAmJiB0aGlzLnZhbHVlICE9PSBVTlNFVCkpKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBDaGVja2JveC50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiAnQGVtYmVyL2NvbXBvbmVudC9jaGVja2JveCc7CiAgfTsKICAvKioKICBAbW9kdWxlIEBlbWJlci9jb21wb25lbnQKICAqLwoKCiAgdmFyIGlucHV0VHlwZXMgPSBfYnJvd3NlckVudmlyb25tZW50Lmhhc0RPTSA/IE9iamVjdC5jcmVhdGUobnVsbCkgOiBudWxsOwoKICBmdW5jdGlvbiBjYW5TZXRUeXBlT2ZJbnB1dCh0eXBlKSB7CiAgICAvLyBpZiBydW5uaW5nIGluIG91dHNpZGUgb2YgYSBicm93c2VyIGFsd2F5cyByZXR1cm4KICAgIC8vIHRoZSBvcmlnaW5hbCB0eXBlCiAgICBpZiAoIV9icm93c2VyRW52aXJvbm1lbnQuaGFzRE9NKSB7CiAgICAgIHJldHVybiBCb29sZWFuKHR5cGUpOwogICAgfQoKICAgIGlmICh0eXBlIGluIGlucHV0VHlwZXMpIHsKICAgICAgcmV0dXJuIGlucHV0VHlwZXNbdHlwZV07CiAgICB9CgogICAgdmFyIGlucHV0VHlwZVRlc3RFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTsKCiAgICB0cnkgewogICAgICBpbnB1dFR5cGVUZXN0RWxlbWVudC50eXBlID0gdHlwZTsKICAgIH0gY2F0Y2ggKGUpIHsvLyBpZ25vcmVkCiAgICB9CgogICAgcmV0dXJuIGlucHV0VHlwZXNbdHlwZV0gPSBpbnB1dFR5cGVUZXN0RWxlbWVudC50eXBlID09PSB0eXBlOwogIH0KICAvKioKICAgIFRoZSBpbnRlcm5hbCBjbGFzcyB1c2VkIHRvIGNyZWF0ZSB0ZXh0IGlucHV0cyB3aGVuIHRoZSBgSW5wdXRgIGNvbXBvbmVudCBpcyB1c2VkIHdpdGggYHR5cGVgIG9mIGB0ZXh0YC4KICAKICAgIFNlZSBbRW1iZXIuVGVtcGxhdGVzLmNvbXBvbmVudHMuSW5wdXRdKC9lbWJlci9yZWxlYXNlL2NsYXNzZXMvRW1iZXIuVGVtcGxhdGVzLmNvbXBvbmVudHMvbWV0aG9kcy9JbnB1dD9hbmNob3I9SW5wdXQpIGZvciB1c2FnZSBkZXRhaWxzLgogIAogICAgIyMgTGF5b3V0IGFuZCBMYXlvdXROYW1lIHByb3BlcnRpZXMKICAKICAgIEJlY2F1c2UgSFRNTCBgaW5wdXRgIGVsZW1lbnRzIGFyZSBzZWxmIGNsb3NpbmcgYGxheW91dGAgYW5kIGBsYXlvdXROYW1lYAogICAgcHJvcGVydGllcyB3aWxsIG5vdCBiZSBhcHBsaWVkLgogIAogICAgQGNsYXNzIFRleHRGaWVsZAogICAgQGV4dGVuZHMgQ29tcG9uZW50CiAgICBAdXNlcyBFbWJlci5UZXh0U3VwcG9ydAogICAgQHB1YmxpYwogICovCgoKICB2YXIgVGV4dEZpZWxkID0gQ29tcG9uZW50LmV4dGVuZChfdmlld3MuVGV4dFN1cHBvcnQsIHsKICAgIGxheW91dDogbGF5b3V0LAoKICAgIC8qKgogICAgICBCeSBkZWZhdWx0LCB0aGlzIGNvbXBvbmVudCB3aWxsIGFkZCB0aGUgYGVtYmVyLXRleHQtZmllbGRgIGNsYXNzIHRvIHRoZSBjb21wb25lbnQncyBlbGVtZW50LgogICAgICAgICBAcHJvcGVydHkgY2xhc3NOYW1lcwogICAgICBAdHlwZSBBcnJheSB8IFN0cmluZwogICAgICBAZGVmYXVsdCBbJ2VtYmVyLXRleHQtZmllbGQnXQogICAgICBAcHVibGljCiAgICAgKi8KICAgIGNsYXNzTmFtZXM6IFsnZW1iZXItdGV4dC1maWVsZCddLAogICAgdGFnTmFtZTogJ2lucHV0JywKCiAgICAvKioKICAgICAgQnkgZGVmYXVsdCB0aGlzIGNvbXBvbmVudCB3aWxsIGZvcndhcmQgYSBudW1iZXIgb2YgYXJndW1lbnRzIHRvIGF0dHJpYnV0ZXMgb24gdGhlIHRoZQogICAgICBjb21wb25lbnQncyBlbGVtZW50OgogICAgICAgICAqIGFjY2VwdAogICAgICAqIGF1dG9jb21wbGV0ZQogICAgICAqIGF1dG9zYXZlCiAgICAgICogZGlyCiAgICAgICogZm9ybWFjdGlvbgogICAgICAqIGZvcm1lbmN0eXBlCiAgICAgICogZm9ybW1ldGhvZAogICAgICAqIGZvcm1ub3ZhbGlkYXRlCiAgICAgICogZm9ybXRhcmdldAogICAgICAqIGhlaWdodAogICAgICAqIGlucHV0bW9kZQogICAgICAqIGxhbmcKICAgICAgKiBsaXN0CiAgICAgICogdHlwZQogICAgICAqIG1heAogICAgICAqIG1pbgogICAgICAqIG11bHRpcGxlCiAgICAgICogbmFtZQogICAgICAqIHBhdHRlcm4KICAgICAgKiBzaXplCiAgICAgICogc3RlcAogICAgICAqIHZhbHVlCiAgICAgICogd2lkdGgKICAgICAgICAgV2hlbiBpbnZva2VkIHdpdGggYHt7aW5wdXQgdHlwZT0idGV4dCJ9fWAsIHlvdSBjYW4gb25seSBjdXN0b21pemUgdGhlc2UgYXR0cmlidXRlcy4gV2hlbiBpbnZva2VkCiAgICAgIHdpdGggYDxJbnB1dCBAdHlwZT0idGV4dCIgLz5gLCB5b3UgY2FuIGp1c3QgdXNlIEhUTUwgYXR0cmlidXRlcyBkaXJlY3RseS4KICAgICAgICAgQHByb3BlcnR5IGF0dHJpYnV0ZUJpbmRpbmdzCiAgICAgIEB0eXBlIEFycmF5IHwgU3RyaW5nCiAgICAgIEBkZWZhdWx0IFsnYWNjZXB0JywgJ2F1dG9jb21wbGV0ZScsICdhdXRvc2F2ZScsICdkaXInLCAnZm9ybWFjdGlvbicsICdmb3JtZW5jdHlwZScsICdmb3JtbWV0aG9kJywgJ2Zvcm1ub3ZhbGlkYXRlJywgJ2Zvcm10YXJnZXQnLCAnaGVpZ2h0JywgJ2lucHV0bW9kZScsICdsYW5nJywgJ2xpc3QnLCAndHlwZScsICdtYXgnLCAnbWluJywgJ211bHRpcGxlJywgJ25hbWUnLCAncGF0dGVybicsICdzaXplJywgJ3N0ZXAnLCAndmFsdWUnLCAnd2lkdGgnXQogICAgICBAcHVibGljCiAgICAqLwogICAgYXR0cmlidXRlQmluZGluZ3M6IFsnYWNjZXB0JywgJ2F1dG9jb21wbGV0ZScsICdhdXRvc2F2ZScsICdkaXInLCAnZm9ybWFjdGlvbicsICdmb3JtZW5jdHlwZScsICdmb3JtbWV0aG9kJywgJ2Zvcm1ub3ZhbGlkYXRlJywgJ2Zvcm10YXJnZXQnLCAnaGVpZ2h0JywgJ2lucHV0bW9kZScsICdsYW5nJywgJ2xpc3QnLCAndHlwZScsICdtYXgnLCAnbWluJywgJ211bHRpcGxlJywgJ25hbWUnLCAncGF0dGVybicsICdzaXplJywgJ3N0ZXAnLCAndmFsdWUnLCAnd2lkdGgnXSwKCiAgICAvKioKICAgICAgQXMgdGhlIHVzZXIgaW5wdXRzIHRleHQsIHRoaXMgcHJvcGVydHkgaXMgdXBkYXRlZCB0byByZWZsZWN0IHRoZSBgdmFsdWVgIHByb3BlcnR5IG9mIHRoZSBIVE1MCiAgICAgIGVsZW1lbnQuCiAgICAgICAgIEBwcm9wZXJ0eSB2YWx1ZQogICAgICBAdHlwZSBTdHJpbmcKICAgICAgQGRlZmF1bHQgIiIKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHZhbHVlOiAnJywKCiAgICAvKioKICAgICAgVGhlIGB0eXBlYCBhdHRyaWJ1dGUgb2YgdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgICAgIEBwcm9wZXJ0eSB0eXBlCiAgICAgIEB0eXBlIFN0cmluZwogICAgICBAZGVmYXVsdCAidGV4dCIKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHR5cGU6ICgwLCBfbWV0YWwuY29tcHV0ZWQpKHsKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuICd0ZXh0JzsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoX2tleSwgdmFsdWUkJDEpIHsKICAgICAgICB2YXIgdHlwZSA9ICd0ZXh0JzsKCiAgICAgICAgaWYgKGNhblNldFR5cGVPZklucHV0KHZhbHVlJCQxKSkgewogICAgICAgICAgdHlwZSA9IHZhbHVlJCQxOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgIH0KICAgIH0pLAoKICAgIC8qKgogICAgICBUaGUgYHNpemVgIG9mIHRoZSB0ZXh0IGZpZWxkIGluIGNoYXJhY3RlcnMuCiAgICAgICAgIEBwcm9wZXJ0eSBzaXplCiAgICAgIEB0eXBlIFN0cmluZwogICAgICBAZGVmYXVsdCBudWxsCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBzaXplOiBudWxsLAoKICAgIC8qKgogICAgICBUaGUgYHBhdHRlcm5gIGF0dHJpYnV0ZSBvZiBpbnB1dCBlbGVtZW50LgogICAgICAgICBAcHJvcGVydHkgcGF0dGVybgogICAgICBAdHlwZSBTdHJpbmcKICAgICAgQGRlZmF1bHQgbnVsbAogICAgICBAcHVibGljCiAgICAqLwogICAgcGF0dGVybjogbnVsbCwKCiAgICAvKioKICAgICAgVGhlIGBtaW5gIGF0dHJpYnV0ZSBvZiBpbnB1dCBlbGVtZW50IHVzZWQgd2l0aCBgdHlwZT0ibnVtYmVyImAgb3IgYHR5cGU9InJhbmdlImAuCiAgICAgICAgIEBwcm9wZXJ0eSBtaW4KICAgICAgQHR5cGUgU3RyaW5nCiAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgQHNpbmNlIDEuNC4wCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBtaW46IG51bGwsCgogICAgLyoqCiAgICAgIFRoZSBgbWF4YCBhdHRyaWJ1dGUgb2YgaW5wdXQgZWxlbWVudCB1c2VkIHdpdGggYHR5cGU9Im51bWJlciJgIG9yIGB0eXBlPSJyYW5nZSJgLgogICAgICAgICBAcHJvcGVydHkgbWF4CiAgICAgIEB0eXBlIFN0cmluZwogICAgICBAZGVmYXVsdCBudWxsCiAgICAgIEBzaW5jZSAxLjQuMAogICAgICBAcHVibGljCiAgICAqLwogICAgbWF4OiBudWxsCiAgfSk7CiAgX2V4cG9ydHMuVGV4dEZpZWxkID0gVGV4dEZpZWxkOwoKICBUZXh0RmllbGQudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gJ0BlbWJlci9jb21wb25lbnQvdGV4dC1maWVsZCc7CiAgfTsKICAvKioKICBAbW9kdWxlIEBlbWJlci9jb21wb25lbnQKICAqLwoKICAvKioKICAgIFRoZSBgVGV4dGFyZWFgIGNvbXBvbmVudCBpbnNlcnRzIGEgbmV3IGluc3RhbmNlIG9mIGA8dGV4dGFyZWE+YCB0YWcgaW50byB0aGUgdGVtcGxhdGUuCiAgCiAgICBUaGUgYEB2YWx1ZWAgYXJndW1lbnQgcHJvdmlkZXMgdGhlIGNvbnRlbnQgb2YgdGhlIGA8dGV4dGFyZWE+YC4KICAKICAgIFRoaXMgdGVtcGxhdGU6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICA8VGV4dGFyZWEgQHZhbHVlPSJBIGJ1bmNoIG9mIHRleHQiIC8+CiAgICBgYGAKICAKICAgIFdvdWxkIHJlc3VsdCBpbiB0aGUgZm9sbG93aW5nIEhUTUw6CiAgCiAgICBgYGBodG1sCiAgICA8dGV4dGFyZWEgY2xhc3M9ImVtYmVyLXRleHQtYXJlYSI+CiAgICAgIEEgYnVuY2ggb2YgdGV4dAogICAgPC90ZXh0YXJlYT4KICAgIGBgYAogIAogICAgVGhlIGBAdmFsdWVgIGFyZ3VtZW50IGlzIHR3by13YXkgYm91bmQuIElmIHRoZSB1c2VyIHR5cGVzIHRleHQgaW50byB0aGUgdGV4dGFyZWEsIHRoZSBgQHZhbHVlYAogICAgYXJndW1lbnQgaXMgdXBkYXRlZC4gSWYgdGhlIGBAdmFsdWVgIGFyZ3VtZW50IGlzIHVwZGF0ZWQsIHRoZSB0ZXh0IGluIHRoZSB0ZXh0YXJlYSBpcyB1cGRhdGVkLgogIAogICAgSW4gdGhlIGZvbGxvd2luZyBleGFtcGxlLCB0aGUgYHdyaXR0ZW5Xb3Jkc2AgcHJvcGVydHkgb24gdGhlIGNvbXBvbmVudCB3aWxsIGJlIHVwZGF0ZWQgYXMgdGhlIHVzZXIKICAgIHR5cGVzICdMb3RzIG9mIHRleHQnIGludG8gdGhlIHRleHQgYXJlYSBvZiB0aGVpciBicm93c2VyJ3Mgd2luZG93LgogIAogICAgYGBgYXBwL2NvbXBvbmVudHMvd29yZC1lZGl0b3IuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGdsaW1tZXIvY29tcG9uZW50JzsKICAgIGltcG9ydCB7IHRyYWNrZWQgfSBmcm9tICdAZ2xpbW1lci90cmFja2luZyc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBXb3JkRWRpdG9yQ29tcG9uZW50IGV4dGVuZHMgQ29tcG9uZW50IHsKICAgICAgQHRyYWNrZWQgd3JpdHRlbldvcmRzID0gIkxvdHMgb2YgdGV4dCB0aGF0IElTIGJvdW5kIjsKICAgIH0KICAgIGBgYAogIAogICAgYGBgaGFuZGxlYmFycwogICAgPFRleHRhcmVhIEB2YWx1ZT17e3dyaXR0ZW5Xb3Jkc319IC8+CiAgICBgYGAKICAKICAgIFdvdWxkIHJlc3VsdCBpbiB0aGUgZm9sbG93aW5nIEhUTUw6CiAgCiAgICBgYGBodG1sCiAgICA8dGV4dGFyZWEgY2xhc3M9ImVtYmVyLXRleHQtYXJlYSI+CiAgICAgIExvdHMgb2YgdGV4dCB0aGF0IElTIGJvdW5kCiAgICA8L3RleHRhcmVhPgogICAgYGBgCiAgCiAgICBJZiB5b3Ugd2FudGVkIGEgb25lIHdheSBiaW5kaW5nLCB5b3UgY291bGQgdXNlIHRoZSBgPHRleHRhcmVhPmAgZWxlbWVudCBkaXJlY3RseSwgYW5kIHVzZSB0aGUKICAgIGB2YWx1ZWAgRE9NIHByb3BlcnR5IGFuZCB0aGUgYGlucHV0YCBldmVudC4KICAKICAgICMjIyBBY3Rpb25zCiAgCiAgICBUaGUgYFRleHRhcmVhYCBjb21wb25lbnQgdGFrZXMgYSBudW1iZXIgb2YgYXJndW1lbnRzIHdpdGggY2FsbGJhY2tzIHRoYXQgYXJlIGludm9rZWQgaW4KICAgIHJlc3BvbnNlIHRvIHVzZXIgZXZlbnRzLgogIAogICAgKiBgZW50ZXJgCiAgICAqIGBpbnNlcnQtbmV3bGluZWAKICAgICogYGVzY2FwZS1wcmVzc2AKICAgICogYGZvY3VzLWluYAogICAgKiBgZm9jdXMtb3V0YAogICAgKiBga2V5LXByZXNzYAogIAogICAgVGhlc2UgY2FsbGJhY2tzIGFyZSBwYXNzZWQgdG8gYFRleHRhcmVhYCBsaWtlIHRoaXM6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICA8VGV4dGFyZWEgQHZhbHVlPXt7dGhpcy5zZWFyY2hXb3JkfX0gQGVudGVyPXt7dGhpcy5xdWVyeX19IC8+CiAgICBgYGAKICAKICAgICMjIENsYXNzaWMgSW52b2NhdGlvbiBTeW50YXgKICAKICAgIFRoZSBgVGV4dGFyZWFgIGNvbXBvbmVudCBjYW4gYWxzbyBiZSBpbnZva2VkIHVzaW5nIGN1cmx5IGJyYWNlcywganVzdCBsaWtlIGFueSBvdGhlciBFbWJlcgogICAgY29tcG9uZW50LgogIAogICAgRm9yIGV4YW1wbGUsIHRoaXMgaXMgYW4gaW52b2NhdGlvbiB1c2luZyBhbmdsZS1icmFja2V0IG5vdGF0aW9uOgogIAogICAgYGBgaGFuZGxlYmFycwogICAgPFRleHRhcmVhIEB2YWx1ZT17e3RoaXMuc2VhcmNoV29yZH19IEBlbnRlcj17e3RoaXMucXVlcnl9fSAvPgogICAgYGBgCiAgCiAgICBZb3UgY291bGQgYWNjb21wbGlzaCB0aGUgc2FtZSB0aGluZyB1c2luZyBjbGFzc2ljIGludm9jYXRpb246CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7e3RleHRhcmVhIHZhbHVlPXRoaXMuc2VhcmNoV29yZCBlbnRlcj10aGlzLnF1ZXJ5fX0KICAgIGBgYAogIAogICAgVGhlIG1haW4gZGlmZmVyZW5jZSBpcyB0aGF0IGFuZ2xlLWJyYWNrZXQgaW52b2NhdGlvbiBzdXBwb3J0cyBhbnkgSFRNTCBhdHRyaWJ1dGUgdXNpbmcgSFRNTAogICAgYXR0cmlidXRlIHN5bnRheCwgYmVjYXVzZSBhdHRyaWJ1dGVzIGFuZCBhcmd1bWVudHMgaGF2ZSBkaWZmZXJlbnQgc3ludGF4IHdoZW4gdXNpbmcgYW5nbGUtYnJhY2tldAogICAgaW52b2NhdGlvbi4gQ3VybHkgYnJhY2UgaW52b2NhdGlvbiwgb24gdGhlIG90aGVyIGhhbmQsIG9ubHkgaGFzIGEgc2luZ2xlIHN5bnRheCBmb3IgYXJndW1lbnRzLAogICAgYW5kIGNvbXBvbmVudHMgbXVzdCBtYW51YWxseSBtYXAgYXR0cmlidXRlcyBvbnRvIGNvbXBvbmVudCBhcmd1bWVudHMuCiAgCiAgICBXaGVuIHVzaW5nIGNsYXNzaWMgaW52b2NhdGlvbiB3aXRoIGB7e3RleHRhcmVhfX1gLCBvbmx5IHRoZSBmb2xsb3dpbmcgYXR0cmlidXRlcyBhcmUgbWFwcGVkIG9udG8KICAgIGFyZ3VtZW50czoKICAKICAgICogcm93cwogICAgKiBjb2xzCiAgICAqIG5hbWUKICAgICogc2VsZWN0aW9uRW5kCiAgICAqIHNlbGVjdGlvblN0YXJ0CiAgICAqIGF1dG9jb21wbGV0ZQogICAgKiB3cmFwCiAgICAqIGxhbmcKICAgICogZGlyCiAgICAqIHZhbHVlCiAgCiAgICAjIyBDbGFzc2ljIGBsYXlvdXRgIGFuZCBgbGF5b3V0TmFtZWAgcHJvcGVydGllcwogIAogICAgQmVjYXVzZSBIVE1MIGB0ZXh0YXJlYWAgZWxlbWVudHMgZG8gbm90IGNvbnRhaW4gaW5uZXIgSFRNTCB0aGUgYGxheW91dGAgYW5kCiAgICBgbGF5b3V0TmFtZWAgcHJvcGVydGllcyB3aWxsIG5vdCBiZSBhcHBsaWVkLgogIAogICAgQG1ldGhvZCBUZXh0YXJlYQogICAgQGZvciBFbWJlci5UZW1wbGF0ZXMuY29tcG9uZW50cwogICAgQHNlZSB7VGV4dEFyZWF9CiAgICBAcHVibGljCiAgKi8KCiAgLyoqCiAgICBTZWUgRW1iZXIuVGVtcGxhdGVzLmNvbXBvbmVudHMuVGV4dGFyZWEuCiAgCiAgICBAbWV0aG9kIHRleHRhcmVhCiAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICBAc2VlIHtFbWJlci5UZW1wbGF0ZXMuY29tcG9uZW50cy50ZXh0YXJlYX0KICAgIEBwdWJsaWMKICAqLwoKICAvKioKICAgIFRoZSBpbnRlcm5hbCByZXByZXNlbnRhdGlvbiB1c2VkIGZvciBgVGV4dGFyZWFgIGludm9jYXRpb25zLgogIAogICAgQGNsYXNzIFRleHRBcmVhCiAgICBAZXh0ZW5kcyBDb21wb25lbnQKICAgIEBzZWUge0VtYmVyLlRlbXBsYXRlcy5jb21wb25lbnRzLlRleHRhcmVhfQogICAgQHVzZXMgRW1iZXIuVGV4dFN1cHBvcnQKICAgIEBwdWJsaWMKICAqLwoKCiAgdmFyIFRleHRBcmVhID0gQ29tcG9uZW50LmV4dGVuZChfdmlld3MuVGV4dFN1cHBvcnQsIHsKICAgIGNsYXNzTmFtZXM6IFsnZW1iZXItdGV4dC1hcmVhJ10sCiAgICBsYXlvdXQ6IGxheW91dCwKICAgIHRhZ05hbWU6ICd0ZXh0YXJlYScsCiAgICBhdHRyaWJ1dGVCaW5kaW5nczogWydyb3dzJywgJ2NvbHMnLCAnbmFtZScsICdzZWxlY3Rpb25FbmQnLCAnc2VsZWN0aW9uU3RhcnQnLCAnYXV0b2NvbXBsZXRlJywgJ3dyYXAnLCAnbGFuZycsICdkaXInLCAndmFsdWUnXSwKICAgIHJvd3M6IG51bGwsCiAgICBjb2xzOiBudWxsCiAgfSk7CiAgX2V4cG9ydHMuVGV4dEFyZWEgPSBUZXh0QXJlYTsKCiAgVGV4dEFyZWEudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gJ0BlbWJlci9jb21wb25lbnQvdGV4dC1hcmVhJzsKICB9OwoKICB2YXIgbGF5b3V0JDEgPSB0ZW1wbGF0ZSh7CiAgICAiaWQiOiAiZ2lUTngrb3AiLAogICAgImJsb2NrIjogIntcInN5bWJvbHNcIjpbXCImZGVmYXVsdFwiXSxcInN0YXRlbWVudHNcIjpbWzQsXCJpZlwiLFtbMjUsMV1dLG51bGwse1wic3RhdGVtZW50c1wiOltbMTQsMV1dLFwicGFyYW1ldGVyc1wiOltdfSx7XCJzdGF0ZW1lbnRzXCI6W1sxLFsyMywwLFtcImxpbmtUaXRsZVwiXV0sZmFsc2VdXSxcInBhcmFtZXRlcnNcIjpbXX1dXSxcImhhc0V2YWxcIjpmYWxzZX0iLAogICAgIm1ldGEiOiB7CiAgICAgICJtb2R1bGVOYW1lIjogInBhY2thZ2VzL0BlbWJlci8taW50ZXJuYWxzL2dsaW1tZXIvbGliL3RlbXBsYXRlcy9saW5rLXRvLmhicyIKICAgIH0KICB9KTsKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICBUaGUgYExpbmtUb2AgY29tcG9uZW50IHJlbmRlcnMgYSBsaW5rIHRvIHRoZSBzdXBwbGllZCBgcm91dGVOYW1lYCBwYXNzaW5nIGFuIG9wdGlvbmFsbHkKICAgIHN1cHBsaWVkIG1vZGVsIHRvIHRoZSByb3V0ZSBhcyBpdHMgYG1vZGVsYCBjb250ZXh0IG9mIHRoZSByb3V0ZS4gVGhlIGJsb2NrIGZvciBgTGlua1RvYAogICAgYmVjb21lcyB0aGUgY29udGVudHMgb2YgdGhlIHJlbmRlcmVkIGVsZW1lbnQ6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICA8TGlua1RvIEByb3V0ZT0ncGhvdG9HYWxsZXJ5Jz4KICAgICAgR3JlYXQgSGFtc3RlciBQaG90b3MKICAgIDwvTGlua1RvPgogICAgYGBgCiAgCiAgICBUaGlzIHdpbGwgcmVzdWx0IGluOgogIAogICAgYGBgaHRtbAogICAgPGEgaHJlZj0iL2hhbXN0ZXItcGhvdG9zIj4KICAgICAgR3JlYXQgSGFtc3RlciBQaG90b3MKICAgIDwvYT4KICAgIGBgYAogIAogICAgIyMjIERpc2FibGluZyB0aGUgYExpbmtUb2AgY29tcG9uZW50CiAgCiAgICBUaGUgYExpbmtUb2AgY29tcG9uZW50IGNhbiBiZSBkaXNhYmxlZCBieSB1c2luZyB0aGUgYGRpc2FibGVkYCBhcmd1bWVudC4gQSBkaXNhYmxlZCBsaW5rCiAgICBkb2Vzbid0IHJlc3VsdCBpbiBhIHRyYW5zaXRpb24gd2hlbiBhY3RpdmF0ZWQsIGFuZCBhZGRzIHRoZSBgZGlzYWJsZWRgIGNsYXNzIHRvIHRoZSBgPGE+YAogICAgZWxlbWVudC4KICAKICAgIChUaGUgY2xhc3MgbmFtZSB0byBhcHBseSB0byB0aGUgZWxlbWVudCBjYW4gYmUgb3ZlcnJpZGRlbiBieSB1c2luZyB0aGUgYGRpc2FibGVkQ2xhc3NgCiAgICBhcmd1bWVudCkKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxMaW5rVG8gQHJvdXRlPSdwaG90b0dhbGxlcnknIEBkaXNhYmxlZD17e3RydWV9fT4KICAgICAgR3JlYXQgSGFtc3RlciBQaG90b3MKICAgIDwvTGlua1RvPgogICAgYGBgCiAgCiAgICAjIyMgSGFuZGxpbmcgYGhyZWZgCiAgCiAgICBgPExpbmtUbz5gIHdpbGwgdXNlIHlvdXIgYXBwbGljYXRpb24ncyBSb3V0ZXIgdG8gZmlsbCB0aGUgZWxlbWVudCdzIGBocmVmYCBwcm9wZXJ0eSB3aXRoIGEgVVJMCiAgICB0aGF0IG1hdGNoZXMgdGhlIHBhdGggdG8gdGhlIHN1cHBsaWVkIGByb3V0ZU5hbWVgLgogIAogICAgIyMjIEhhbmRsaW5nIGN1cnJlbnQgcm91dGUKICAKICAgIFRoZSBgTGlua1RvYCBjb21wb25lbnQgd2lsbCBhcHBseSBhIENTUyBjbGFzcyBuYW1lIG9mICdhY3RpdmUnIHdoZW4gdGhlIGFwcGxpY2F0aW9uJ3MgY3VycmVudAogICAgcm91dGUgbWF0Y2hlcyB0aGUgc3VwcGxpZWQgcm91dGVOYW1lLiBGb3IgZXhhbXBsZSwgaWYgdGhlIGFwcGxpY2F0aW9uJ3MgY3VycmVudCByb3V0ZSBpcwogICAgJ3Bob3RvR2FsbGVyeS5yZWNlbnQnLCB0aGVuIHRoZSBmb2xsb3dpbmcgaW52b2NhdGlvbiBvZiBgTGlua1RvYDoKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxMaW5rVG8gQHJvdXRlPSdwaG90b0dhbGxlcnkucmVjZW50Jz4KICAgICAgR3JlYXQgSGFtc3RlciBQaG90b3MKICAgIDwvTGlua1RvPgogICAgYGBgCiAgCiAgICB3aWxsIHJlc3VsdCBpbgogIAogICAgYGBgaHRtbAogICAgPGEgaHJlZj0iL2hhbXN0ZXItcGhvdG9zL3RoaXMtd2VlayIgY2xhc3M9ImFjdGl2ZSI+CiAgICAgIEdyZWF0IEhhbXN0ZXIgUGhvdG9zCiAgICA8L2E+CiAgICBgYGAKICAKICAgIFRoZSBDU1MgY2xhc3MgdXNlZCBmb3IgYWN0aXZlIGNsYXNzZXMgY2FuIGJlIGN1c3RvbWl6ZWQgYnkgcGFzc2luZyBhbiBgYWN0aXZlQ2xhc3NgIGFyZ3VtZW50OgogIAogICAgYGBgaGFuZGxlYmFycwogICAgPExpbmtUbyBAcm91dGU9J3Bob3RvR2FsbGVyeS5yZWNlbnQnIEBhY3RpdmVDbGFzcz0iY3VycmVudC11cmwiPgogICAgICBHcmVhdCBIYW1zdGVyIFBob3RvcwogICAgPC9MaW5rVG8+CiAgICBgYGAKICAKICAgIGBgYGh0bWwKICAgIDxhIGhyZWY9Ii9oYW1zdGVyLXBob3Rvcy90aGlzLXdlZWsiIGNsYXNzPSJjdXJyZW50LXVybCI+CiAgICAgIEdyZWF0IEhhbXN0ZXIgUGhvdG9zCiAgICA8L2E+CiAgICBgYGAKICAKICAgICMjIyBLZWVwaW5nIGEgbGluayBhY3RpdmUgZm9yIG90aGVyIHJvdXRlcwogIAogICAgSWYgeW91IG5lZWQgYSBsaW5rIHRvIGJlICdhY3RpdmUnIGV2ZW4gd2hlbiBpdCBkb2Vzbid0IG1hdGNoIHRoZSBjdXJyZW50IHJvdXRlLCB5b3UgY2FuIHVzZSB0aGUKICAgIGBjdXJyZW50LXdoZW5gIGFyZ3VtZW50LgogIAogICAgYGBgaGFuZGxlYmFycwogICAgPExpbmtUbyBAcm91dGU9J3Bob3RvR2FsbGVyeScgQGN1cnJlbnQtd2hlbj0ncGhvdG9zJz4KICAgICAgUGhvdG8gR2FsbGVyeQogICAgPC9MaW5rVG8+CiAgICBgYGAKICAKICAgIFRoaXMgbWF5IGJlIGhlbHBmdWwgZm9yIGtlZXBpbmcgbGlua3MgYWN0aXZlIGZvcjoKICAKICAgICogbm9uLW5lc3RlZCByb3V0ZXMgdGhhdCBhcmUgbG9naWNhbGx5IHJlbGF0ZWQKICAgICogc29tZSBzZWNvbmRhcnkgbWVudSBhcHByb2FjaGVzCiAgICAqICd0b3AgbmF2aWdhdGlvbicgd2l0aCAnc3ViIG5hdmlnYXRpb24nIHNjZW5hcmlvcwogIAogICAgQSBsaW5rIHdpbGwgYmUgYWN0aXZlIGlmIGBjdXJyZW50LXdoZW5gIGlzIGB0cnVlYCBvciB0aGUgY3VycmVudAogICAgcm91dGUgaXMgdGhlIHJvdXRlIHRoaXMgbGluayB3b3VsZCB0cmFuc2l0aW9uIHRvLgogIAogICAgVG8gbWF0Y2ggbXVsdGlwbGUgcm91dGVzICdzcGFjZS1zZXBhcmF0ZScgdGhlIHJvdXRlczoKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxMaW5rVG8gQHJvdXRlPSdnYWxsZXJ5JyBAY3VycmVudC13aGVuPSdwaG90b3MgZHJhd2luZ3MgcGFpbnRpbmdzJz4KICAgICAgQXJ0IEdhbGxlcnkKICAgIDwvTGlua1RvPgogICAgYGBgCiAgCiAgICAjIyMgU3VwcGx5aW5nIGEgbW9kZWwKICAKICAgIEFuIG9wdGlvbmFsIGBtb2RlbGAgYXJndW1lbnQgY2FuIGJlIHVzZWQgZm9yIHJvdXRlcyB3aG9zZQogICAgcGF0aHMgY29udGFpbiBkeW5hbWljIHNlZ21lbnRzLiBUaGlzIGFyZ3VtZW50IHdpbGwgYmVjb21lCiAgICB0aGUgbW9kZWwgY29udGV4dCBvZiB0aGUgbGlua2VkIHJvdXRlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICAgdGhpcy5yb3V0ZSgicGhvdG9HYWxsZXJ5Iiwge3BhdGg6ICJoYW1zdGVyLXBob3Rvcy86cGhvdG9faWQifSk7CiAgICB9KTsKICAgIGBgYAogIAogICAgYGBgaGFuZGxlYmFycwogICAgPExpbmtUbyBAcm91dGU9J3Bob3RvR2FsbGVyeScgQG1vZGVsPXt7dGhpcy5hUGhvdG99fT4KICAgICAge3thUGhvdG8udGl0bGV9fQogICAgPC9MaW5rVG8+CiAgICBgYGAKICAKICAgIGBgYGh0bWwKICAgIDxhIGhyZWY9Ii9oYW1zdGVyLXBob3Rvcy80MiI+CiAgICAgIFRvbXN0ZXIKICAgIDwvYT4KICAgIGBgYAogIAogICAgIyMjIFN1cHBseWluZyBtdWx0aXBsZSBtb2RlbHMKICAKICAgIEZvciBkZWVwLWxpbmtpbmcgdG8gcm91dGUgcGF0aHMgdGhhdCBjb250YWluIG11bHRpcGxlCiAgICBkeW5hbWljIHNlZ21lbnRzLCB0aGUgYG1vZGVsc2AgYXJndW1lbnQgY2FuIGJlIHVzZWQuCiAgCiAgICBBcyB0aGUgcm91dGVyIHRyYW5zaXRpb25zIHRocm91Z2ggdGhlIHJvdXRlIHBhdGgsIGVhY2gKICAgIHN1cHBsaWVkIG1vZGVsIGFyZ3VtZW50IHdpbGwgYmVjb21lIHRoZSBjb250ZXh0IGZvciB0aGUKICAgIHJvdXRlIHdpdGggdGhlIGR5bmFtaWMgc2VnbWVudHM6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBSb3V0ZXIubWFwKGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJvdXRlKCJwaG90b0dhbGxlcnkiLCB7IHBhdGg6ICJoYW1zdGVyLXBob3Rvcy86cGhvdG9faWQiIH0sIGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucm91dGUoImNvbW1lbnQiLCB7cGF0aDogImNvbW1lbnRzLzpjb21tZW50X2lkIn0pOwogICAgICB9KTsKICAgIH0pOwogICAgYGBgCiAgCiAgICBUaGlzIGFyZ3VtZW50IHdpbGwgYmVjb21lIHRoZSBtb2RlbCBjb250ZXh0IG9mIHRoZSBsaW5rZWQgcm91dGU6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICA8TGlua1RvIEByb3V0ZT0ncGhvdG9HYWxsZXJ5LmNvbW1lbnQnIEBtb2RlbHM9e3thcnJheSB0aGlzLmFQaG90byB0aGlzLmNvbW1lbnR9fT4KICAgICAge3tjb21tZW50LmJvZHl9fQogICAgPC9MaW5rVG8+CiAgICBgYGAKICAKICAgIGBgYGh0bWwKICAgIDxhIGhyZWY9Ii9oYW1zdGVyLXBob3Rvcy80Mi9jb21tZW50cy83MTgiPgogICAgICBBKysrIHdvdWxkIHNudWdnbGUgYWdhaW4uCiAgICA8L2E+CiAgICBgYGAKICAKICAgICMjIyBTdXBwbHlpbmcgYW4gZXhwbGljaXQgZHluYW1pYyBzZWdtZW50IHZhbHVlCiAgCiAgICBJZiB5b3UgZG9uJ3QgaGF2ZSBhIG1vZGVsIG9iamVjdCBhdmFpbGFibGUgdG8gcGFzcyB0byBgTGlua1RvYCwKICAgIGFuIG9wdGlvbmFsIHN0cmluZyBvciBpbnRlZ2VyIGFyZ3VtZW50IGNhbiBiZSBwYXNzZWQgZm9yIHJvdXRlcyB3aG9zZQogICAgcGF0aHMgY29udGFpbiBkeW5hbWljIHNlZ21lbnRzLiBUaGlzIGFyZ3VtZW50IHdpbGwgYmVjb21lIHRoZSB2YWx1ZQogICAgb2YgdGhlIGR5bmFtaWMgc2VnbWVudDoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIFJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucm91dGUoInBob3RvR2FsbGVyeSIsIHsgcGF0aDogImhhbXN0ZXItcGhvdG9zLzpwaG90b19pZCIgfSk7CiAgICB9KTsKICAgIGBgYAogIAogICAgYGBgaGFuZGxlYmFycwogICAgPExpbmtUbyBAcm91dGU9J3Bob3RvR2FsbGVyeScgQG1vZGVsPXt7YVBob3RvSWR9fT4KICAgICAge3t0aGlzLmFQaG90by50aXRsZX19CiAgICA8L0xpbmtUbz4KICAgIGBgYAogIAogICAgYGBgaHRtbAogICAgPGEgaHJlZj0iL2hhbXN0ZXItcGhvdG9zLzQyIj4KICAgICAgVG9tc3RlcgogICAgPC9hPgogICAgYGBgCiAgCiAgICBXaGVuIHRyYW5zaXRpb25pbmcgaW50byB0aGUgbGlua2VkIHJvdXRlLCB0aGUgYG1vZGVsYCBob29rIHdpbGwKICAgIGJlIHRyaWdnZXJlZCB3aXRoIHBhcmFtZXRlcnMgaW5jbHVkaW5nIHRoaXMgcGFzc2VkIGlkZW50aWZpZXIuCiAgCiAgICAjIyMgQWxsb3dpbmcgRGVmYXVsdCBBY3Rpb24KICAKICAgIEJ5IGRlZmF1bHQgdGhlIGA8TGlua1RvPmAgY29tcG9uZW50IHByZXZlbnRzIHRoZSBkZWZhdWx0IGJyb3dzZXIgYWN0aW9uIGJ5IGNhbGxpbmcKICAgIGBwcmV2ZW50RGVmYXVsdCgpYCB0byBhdm9pZCByZWxvYWRpbmcgdGhlIGJyb3dzZXIgcGFnZS4KICAKICAgIElmIHlvdSBuZWVkIHRvIHRyaWdnZXIgYSBmdWxsIGJyb3dzZXIgcmVsb2FkIHBhc3MgYEBwcmV2ZW50RGVmYXVsdD17e2ZhbHNlfX1gOgogIAogICAgYGBgaGFuZGxlYmFycwogICAgPExpbmtUbyBAcm91dGU9J3Bob3RvR2FsbGVyeScgQG1vZGVsPXt7dGhpcy5hUGhvdG9JZH19IEBwcmV2ZW50RGVmYXVsdD17e2ZhbHNlfX0+CiAgICAgIHt7dGhpcy5hUGhvdG9JZC50aXRsZX19CiAgICA8L0xpbmtUbz4KICAgIGBgYAogIAogICAgIyMjIFN1cHBseWluZyBhIGB0YWdOYW1lYAogIAogICAgQnkgZGVmYXVsdCBgPExpbmtUbz5gIHJlbmRlcnMgYW4gYDxhPmAgZWxlbWVudC4gVGhpcyBjYW4gYmUgb3ZlcnJpZGRlbiBmb3IgYSBzaW5nbGUgdXNlIG9mCiAgICBgPExpbmtUbz5gIGJ5IHN1cHBseWluZyBhIGB0YWdOYW1lYCBhcmd1bWVudDoKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxMaW5rVG8gQHJvdXRlPSdwaG90b0dhbGxlcnknIEB0YWdOYW1lPSdsaSc+CiAgICAgIEdyZWF0IEhhbXN0ZXIgUGhvdG9zCiAgICA8L0xpbmtUbz4KICAgIGBgYAogIAogICAgVGhpcyBwcm9kdWNlczoKICAKICAgIGBgYGh0bWwKICAgIDxsaT4KICAgICAgR3JlYXQgSGFtc3RlciBQaG90b3MKICAgIDwvbGk+CiAgICBgYGAKICAKICAgIEluIGdlbmVyYWwsIHRoaXMgaXMgbm90IHJlY29tbWVuZGVkLiBJbnN0ZWFkLCB5b3UgY2FuIHVzZSB0aGUgYHRyYW5zaXRpb24tdG9gIGhlbHBlciB0b2dldGhlcgogICAgd2l0aCBhIGNsaWNrIGV2ZW50IGhhbmRsZXIgb24gdGhlIEhUTUwgdGFnIG9mIHlvdXIgY2hvb3NpbmcuCiAgCiAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5jb21wb25lbnRzCiAgICBAbWV0aG9kIExpbmtUbwogICAgQHNlZSB7TGlua0NvbXBvbmVudH0KICAgIEBwdWJsaWMKICAqLwoKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyL3JvdXRpbmcKICAqLwoKICAvKioKICAgIFNlZSBbRW1iZXIuVGVtcGxhdGVzLmNvbXBvbmVudHMuTGlua1RvXSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0VtYmVyLlRlbXBsYXRlcy5jb21wb25lbnRzL21ldGhvZHMvaW5wdXQ/YW5jaG9yPUxpbmtUbykuCiAgCiAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICBAbWV0aG9kIGxpbmstdG8KICAgIEBzZWUge0VtYmVyLlRlbXBsYXRlcy5jb21wb25lbnRzLkxpbmtUb30KICAgIEBwdWJsaWMKICAqKi8KCiAgLyoqCiAgICBgTGlua0NvbXBvbmVudGAgaXMgdGhlIGludGVybmFsIGNvbXBvbmVudCBpbnZva2VkIHdpdGggYDxMaW5rVG8+YCBvciBge3tsaW5rLXRvfX1gLgogIAogICAgQGNsYXNzIExpbmtDb21wb25lbnQKICAgIEBleHRlbmRzIENvbXBvbmVudAogICAgQHNlZSB7RW1iZXIuVGVtcGxhdGVzLmNvbXBvbmVudHMuTGlua1RvfQogICAgQHB1YmxpYwogICoqLwoKICB2YXIgVU5ERUZJTkVEID0gT2JqZWN0LmZyZWV6ZSh7CiAgICB0b1N0cmluZzogZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgIHJldHVybiAnVU5ERUZJTkVEJzsKICAgIH0KICB9KTsKICB2YXIgRU1QVFlfUVVFUllfUEFSQU1TID0gT2JqZWN0LmZyZWV6ZSh7fSk7CiAgdmFyIExpbmtDb21wb25lbnQgPSBDb21wb25lbnQuZXh0ZW5kKHsKICAgIGxheW91dDogbGF5b3V0JDEsCiAgICB0YWdOYW1lOiAnYScsCgogICAgLyoqCiAgICAgIEBwcm9wZXJ0eSByb3V0ZQogICAgICBAcHVibGljCiAgICAqLwogICAgcm91dGU6IFVOREVGSU5FRCwKCiAgICAvKioKICAgICAgQHByb3BlcnR5IG1vZGVsCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBtb2RlbDogVU5ERUZJTkVELAoKICAgIC8qKgogICAgICBAcHJvcGVydHkgbW9kZWxzCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBtb2RlbHM6IFVOREVGSU5FRCwKCiAgICAvKioKICAgICAgQHByb3BlcnR5IHF1ZXJ5CiAgICAgIEBwdWJsaWMKICAgICovCiAgICBxdWVyeTogVU5ERUZJTkVELAoKICAgIC8qKgogICAgICBVc2VkIHRvIGRldGVybWluZSB3aGVuIHRoaXMgYExpbmtDb21wb25lbnRgIGlzIGFjdGl2ZS4KICAgICAgICAgQHByb3BlcnR5IGN1cnJlbnQtd2hlbgogICAgICBAcHVibGljCiAgICAqLwogICAgJ2N1cnJlbnQtd2hlbic6IG51bGwsCgogICAgLyoqCiAgICAgIFNldHMgdGhlIGB0aXRsZWAgYXR0cmlidXRlIG9mIHRoZSBgTGlua0NvbXBvbmVudGAncyBIVE1MIGVsZW1lbnQuCiAgICAgICAgIEBwcm9wZXJ0eSB0aXRsZQogICAgICBAZGVmYXVsdCBudWxsCiAgICAgIEBwdWJsaWMKICAgICoqLwogICAgdGl0bGU6IG51bGwsCgogICAgLyoqCiAgICAgIFNldHMgdGhlIGByZWxgIGF0dHJpYnV0ZSBvZiB0aGUgYExpbmtDb21wb25lbnRgJ3MgSFRNTCBlbGVtZW50LgogICAgICAgICBAcHJvcGVydHkgcmVsCiAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgQHB1YmxpYwogICAgKiovCiAgICByZWw6IG51bGwsCgogICAgLyoqCiAgICAgIFNldHMgdGhlIGB0YWJpbmRleGAgYXR0cmlidXRlIG9mIHRoZSBgTGlua0NvbXBvbmVudGAncyBIVE1MIGVsZW1lbnQuCiAgICAgICAgIEBwcm9wZXJ0eSB0YWJpbmRleAogICAgICBAZGVmYXVsdCBudWxsCiAgICAgIEBwdWJsaWMKICAgICoqLwogICAgdGFiaW5kZXg6IG51bGwsCgogICAgLyoqCiAgICAgIFNldHMgdGhlIGB0YXJnZXRgIGF0dHJpYnV0ZSBvZiB0aGUgYExpbmtDb21wb25lbnRgJ3MgSFRNTCBlbGVtZW50LgogICAgICAgICBAc2luY2UgMS44LjAKICAgICAgQHByb3BlcnR5IHRhcmdldAogICAgICBAZGVmYXVsdCBudWxsCiAgICAgIEBwdWJsaWMKICAgICoqLwogICAgdGFyZ2V0OiBudWxsLAoKICAgIC8qKgogICAgICBUaGUgQ1NTIGNsYXNzIHRvIGFwcGx5IHRvIGBMaW5rQ29tcG9uZW50YCdzIGVsZW1lbnQgd2hlbiBpdHMgYGFjdGl2ZWAKICAgICAgcHJvcGVydHkgaXMgYHRydWVgLgogICAgICAgICBAcHJvcGVydHkgYWN0aXZlQ2xhc3MKICAgICAgQHR5cGUgU3RyaW5nCiAgICAgIEBkZWZhdWx0IGFjdGl2ZQogICAgICBAcHVibGljCiAgICAqKi8KICAgIGFjdGl2ZUNsYXNzOiAnYWN0aXZlJywKCiAgICAvKioKICAgICAgVGhlIENTUyBjbGFzcyB0byBhcHBseSB0byBgTGlua0NvbXBvbmVudGAncyBlbGVtZW50IHdoZW4gaXRzIGBsb2FkaW5nYAogICAgICBwcm9wZXJ0eSBpcyBgdHJ1ZWAuCiAgICAgICAgIEBwcm9wZXJ0eSBsb2FkaW5nQ2xhc3MKICAgICAgQHR5cGUgU3RyaW5nCiAgICAgIEBkZWZhdWx0IGxvYWRpbmcKICAgICAgQHByaXZhdGUKICAgICoqLwogICAgbG9hZGluZ0NsYXNzOiAnbG9hZGluZycsCgogICAgLyoqCiAgICAgIFRoZSBDU1MgY2xhc3MgdG8gYXBwbHkgdG8gYSBgTGlua0NvbXBvbmVudGAncyBlbGVtZW50IHdoZW4gaXRzIGBkaXNhYmxlZGAKICAgICAgcHJvcGVydHkgaXMgYHRydWVgLgogICAgICAgICBAcHJvcGVydHkgZGlzYWJsZWRDbGFzcwogICAgICBAdHlwZSBTdHJpbmcKICAgICAgQGRlZmF1bHQgZGlzYWJsZWQKICAgICAgQHByaXZhdGUKICAgICoqLwogICAgZGlzYWJsZWRDbGFzczogJ2Rpc2FibGVkJywKCiAgICAvKioKICAgICAgRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBgTGlua0NvbXBvbmVudGAgd2lsbCB0cmlnZ2VyIHJvdXRpbmcgdmlhCiAgICAgIHRoZSBgcmVwbGFjZVdpdGhgIHJvdXRpbmcgc3RyYXRlZ3kuCiAgICAgICAgIEBwcm9wZXJ0eSByZXBsYWNlCiAgICAgIEB0eXBlIEJvb2xlYW4KICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgQHB1YmxpYwogICAgKiovCiAgICByZXBsYWNlOiBmYWxzZSwKCiAgICAvKioKICAgICAgQnkgZGVmYXVsdCB0aGlzIGNvbXBvbmVudCB3aWxsIGZvcndhcmQgYGhyZWZgLCBgdGl0bGVgLCBgcmVsYCwgYHRhYmluZGV4YCwgYW5kIGB0YXJnZXRgCiAgICAgIGFyZ3VtZW50cyB0byBhdHRyaWJ1dGVzIG9uIHRoZSBjb21wb25lbnQncyBlbGVtZW50LiBXaGVuIGludm9rZWQgd2l0aCBge3tsaW5rLXRvfX1gLCB5b3UgY2FuCiAgICAgIG9ubHkgY3VzdG9taXplIHRoZXNlIGF0dHJpYnV0ZXMuIFdoZW4gaW52b2tlZCB3aXRoIGA8TGlua1RvPmAsIHlvdSBjYW4ganVzdCB1c2UgSFRNTAogICAgICBhdHRyaWJ1dGVzIGRpcmVjdGx5LgogICAgICAgICBAcHJvcGVydHkgYXR0cmlidXRlQmluZGluZ3MKICAgICAgQHR5cGUgQXJyYXkgfCBTdHJpbmcKICAgICAgQGRlZmF1bHQgWyd0aXRsZScsICdyZWwnLCAndGFiaW5kZXgnLCAndGFyZ2V0J10KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ2hyZWYnLCAndGl0bGUnLCAncmVsJywgJ3RhYmluZGV4JywgJ3RhcmdldCddLAoKICAgIC8qKgogICAgICBCeSBkZWZhdWx0IHRoaXMgY29tcG9uZW50IHdpbGwgc2V0IGNsYXNzZXMgb24gaXRzIGVsZW1lbnQgd2hlbiBhbnkgb2YgdGhlIGZvbGxvd2luZyBhcmd1bWVudHMKICAgICAgYXJlIHRydXRoeToKICAgICAgICAgKiBhY3RpdmUKICAgICAgKiBsb2FkaW5nCiAgICAgICogZGlzYWJsZWQKICAgICAgICAgV2hlbiB0aGVzZSBhcmd1bWVudHMgYXJlIHRydXRoeSwgYSBjbGFzcyB3aXRoIHRoZSBzYW1lIG5hbWUgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQuIFdoZW4KICAgICAgZmFsc3ksIHRoZSBhc3NvY2lhdGVkIGNsYXNzIHdpbGwgbm90IGJlIG9uIHRoZSBlbGVtZW50LgogICAgICAgICBAcHJvcGVydHkgY2xhc3NOYW1lQmluZGluZ3MKICAgICAgQHR5cGUgQXJyYXkKICAgICAgQGRlZmF1bHQgWydhY3RpdmUnLCAnbG9hZGluZycsICdkaXNhYmxlZCcsICdlbWJlci10cmFuc2l0aW9uaW5nLWluJywgJ2VtYmVyLXRyYW5zaXRpb25pbmctb3V0J10KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGNsYXNzTmFtZUJpbmRpbmdzOiBbJ2FjdGl2ZScsICdsb2FkaW5nJywgJ2Rpc2FibGVkJywgJ3RyYW5zaXRpb25pbmdJbicsICd0cmFuc2l0aW9uaW5nT3V0J10sCgogICAgLyoqCiAgICAgIEJ5IGRlZmF1bHQgdGhpcyBjb21wb25lbnQgcmVzcG9uZHMgdG8gdGhlIGBjbGlja2AgZXZlbnQuIFdoZW4gdGhlIGNvbXBvbmVudCBlbGVtZW50IGlzIGFuCiAgICAgIGA8YT5gIGVsZW1lbnQsIGFjdGl2YXRpbmcgdGhlIGxpbmsgaW4gYW5vdGhlciB3YXksIHN1Y2ggYXMgdXNpbmcgdGhlIGtleWJvYXJkLCB0cmlnZ2VycyB0aGUKICAgICAgY2xpY2sgZXZlbnQuCiAgICAgICAgIEBwcm9wZXJ0eSBldmVudE5hbWUKICAgICAgQHR5cGUgU3RyaW5nCiAgICAgIEBkZWZhdWx0IGNsaWNrCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgZXZlbnROYW1lOiAnY2xpY2snLAogICAgLy8gdGhpcyBpcyBkb2MnZWQgaGVyZSBzbyBpdCBzaG93cyB1cCBpbiB0aGUgZXZlbnRzCiAgICAvLyBzZWN0aW9uIG9mIHRoZSBBUEkgZG9jdW1lbnRhdGlvbiwgd2hpY2ggaXMgd2hlcmUKICAgIC8vIHBlb3BsZSB3aWxsIGxpa2VseSBnbyBsb29raW5nIGZvciBpdC4KCiAgICAvKioKICAgICAgVHJpZ2dlcnMgdGhlIGBMaW5rQ29tcG9uZW50YCdzIHJvdXRpbmcgYmVoYXZpb3IuIElmCiAgICAgIGBldmVudE5hbWVgIGlzIGNoYW5nZWQgdG8gYSB2YWx1ZSBvdGhlciB0aGFuIGBjbGlja2AKICAgICAgdGhlIHJvdXRpbmcgYmVoYXZpb3Igd2lsbCB0cmlnZ2VyIG9uIHRoYXQgY3VzdG9tIGV2ZW50CiAgICAgIGluc3RlYWQuCiAgICAgICAgIEBldmVudCBjbGljawogICAgICBAcHJpdmF0ZQogICAgKi8KCiAgICAvKioKICAgICAgQW4gb3ZlcnJpZGFibGUgbWV0aG9kIGNhbGxlZCB3aGVuIGBMaW5rQ29tcG9uZW50YCBvYmplY3RzIGFyZSBpbnN0YW50aWF0ZWQuCiAgICAgICAgIEV4YW1wbGU6CiAgICAgICAgIGBgYGFwcC9jb21wb25lbnRzL215LWxpbmsuanMKICAgICAgaW1wb3J0IExpbmtDb21wb25lbnQgZnJvbSAnQGVtYmVyL3JvdXRpbmcvbGluay1jb21wb25lbnQnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBMaW5rQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgaW5pdCgpIHsKICAgICAgICAgIHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CiAgICAgICAgICBjb25zb2xlLmxvZygnRXZlbnQgaXMgJyArIHRoaXMuZ2V0KCdldmVudE5hbWUnKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICAgIE5PVEU6IElmIHlvdSBkbyBvdmVycmlkZSBgaW5pdGAgZm9yIGEgZnJhbWV3b3JrIGNsYXNzIGxpa2UgYENvbXBvbmVudGAsCiAgICAgIGJlIHN1cmUgdG8gY2FsbCBgdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKWAgaW4geW91cgogICAgICBgaW5pdGAgZGVjbGFyYXRpb24hIElmIHlvdSBkb24ndCwgRW1iZXIgbWF5IG5vdCBoYXZlIGFuIG9wcG9ydHVuaXR5IHRvCiAgICAgIGRvIGltcG9ydGFudCBzZXR1cCB3b3JrLCBhbmQgeW91J2xsIHNlZSBzdHJhbmdlIGJlaGF2aW9yIGluIHlvdXIKICAgICAgYXBwbGljYXRpb24uCiAgICAgICAgIEBtZXRob2QgaW5pdAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGluaXQ6IGZ1bmN0aW9uIGluaXQoKSB7CiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IC8vIE1hcCBkZXNpcmVkIGV2ZW50IG5hbWUgdG8gaW52b2tlIGZ1bmN0aW9uCgoKICAgICAgdmFyIGV2ZW50TmFtZSA9IHRoaXMuZXZlbnROYW1lOwogICAgICB0aGlzLm9uKGV2ZW50TmFtZSwgdGhpcywgdGhpcy5faW52b2tlKTsKICAgIH0sCiAgICBfcm91dGluZzogKDAsIF9zZXJ2aWNlLmluamVjdCkoJy1yb3V0aW5nJyksCiAgICBfY3VycmVudFJvdXRlOiAoMCwgX21ldGFsLmFsaWFzKSgnX3JvdXRpbmcuY3VycmVudFJvdXRlTmFtZScpLAogICAgX2N1cnJlbnRSb3V0ZXJTdGF0ZTogKDAsIF9tZXRhbC5hbGlhcykoJ19yb3V0aW5nLmN1cnJlbnRTdGF0ZScpLAogICAgX3RhcmdldFJvdXRlclN0YXRlOiAoMCwgX21ldGFsLmFsaWFzKSgnX3JvdXRpbmcudGFyZ2V0U3RhdGUnKSwKICAgIF9yb3V0ZTogKDAsIF9tZXRhbC5jb21wdXRlZCkoJ3JvdXRlJywgJ19jdXJyZW50Um91dGVyU3RhdGUnLCBmdW5jdGlvbiBjb21wdXRlTGlua1RvQ29tcG9uZW50Um91dGUoKSB7CiAgICAgIHZhciByb3V0ZSA9IHRoaXMucm91dGU7CiAgICAgIHJldHVybiByb3V0ZSA9PT0gVU5ERUZJTkVEID8gdGhpcy5fY3VycmVudFJvdXRlIDogcm91dGU7CiAgICB9KSwKICAgIF9tb2RlbHM6ICgwLCBfbWV0YWwuY29tcHV0ZWQpKCdtb2RlbCcsICdtb2RlbHMnLCBmdW5jdGlvbiBjb21wdXRlTGlua1RvQ29tcG9uZW50TW9kZWxzKCkgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLm1vZGVsLAogICAgICAgICAgbW9kZWxzID0gdGhpcy5tb2RlbHM7CiAgICAgIChmYWxzZSAmJiAhKG1vZGVsID09PSBVTkRFRklORUQgfHwgbW9kZWxzID09PSBVTkRFRklORUQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGNhbm5vdCBwcm92aWRlIGJvdGggdGhlIGBAbW9kZWxgIGFuZCBgQG1vZGVsc2AgYXJndW1lbnRzIHRvIHRoZSA8TGlua1RvPiBjb21wb25lbnQuJywgbW9kZWwgPT09IFVOREVGSU5FRCB8fCBtb2RlbHMgPT09IFVOREVGSU5FRCkpOwoKICAgICAgaWYgKG1vZGVsICE9PSBVTkRFRklORUQpIHsKICAgICAgICByZXR1cm4gW21vZGVsXTsKICAgICAgfSBlbHNlIGlmIChtb2RlbHMgIT09IFVOREVGSU5FRCkgewogICAgICAgIChmYWxzZSAmJiAhKEFycmF5LmlzQXJyYXkobW9kZWxzKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUaGUgYEBtb2RlbHNgIGFyZ3VtZW50IG11c3QgYmUgYW4gYXJyYXkuJywgQXJyYXkuaXNBcnJheShtb2RlbHMpKSk7CiAgICAgICAgcmV0dXJuIG1vZGVsczsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgIH0pLAogICAgX3F1ZXJ5OiAoMCwgX21ldGFsLmNvbXB1dGVkKSgncXVlcnknLCBmdW5jdGlvbiBjb21wdXRlTGlua1RvQ29tcG9uZW50UXVlcnkoKSB7CiAgICAgIHZhciBxdWVyeSA9IHRoaXMucXVlcnk7CgogICAgICBpZiAocXVlcnkgPT09IFVOREVGSU5FRCkgewogICAgICAgIHJldHVybiBFTVBUWV9RVUVSWV9QQVJBTVM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIHF1ZXJ5KTsKICAgICAgfQogICAgfSksCgogICAgLyoqCiAgICAgIEFjY2Vzc2VkIGFzIGEgY2xhc3NuYW1lIGJpbmRpbmcgdG8gYXBwbHkgdGhlIGNvbXBvbmVudCdzIGBkaXNhYmxlZENsYXNzYAogICAgICBDU1MgYGNsYXNzYCB0byB0aGUgZWxlbWVudCB3aGVuIHRoZSBsaW5rIGlzIGRpc2FibGVkLgogICAgICAgICBXaGVuIGB0cnVlYCwgaW50ZXJhY3Rpb25zIHdpdGggdGhlIGVsZW1lbnQgd2lsbCBub3QgdHJpZ2dlciByb3V0ZSBjaGFuZ2VzLgogICAgICBAcHJvcGVydHkgZGlzYWJsZWQKICAgICAgQHByaXZhdGUKICAgICovCiAgICBkaXNhYmxlZDogKDAsIF9tZXRhbC5jb21wdXRlZCkoewogICAgICBnZXQ6IGZ1bmN0aW9uIGdldChfa2V5KSB7CiAgICAgICAgLy8gYWx3YXlzIHJldHVybnMgZmFsc2UgZm9yIGBnZXRgIGJlY2F1c2UgKGR1ZSB0byB0aGUgYHNldGAganVzdCBiZWxvdykKICAgICAgICAvLyB0aGUgY2FjaGVkIHJldHVybiB2YWx1ZSBmcm9tIHRoZSBzZXQgd2lsbCBwcmV2ZW50IHRoaXMgZ2V0dGVyIGZyb20gX2V2ZXJfCiAgICAgICAgLy8gYmVpbmcgY2FsbGVkIGFmdGVyIGEgc2V0IGhhcyBvY2N1cmVkCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldChfa2V5LCB2YWx1ZSQkMSkgewogICAgICAgIHRoaXMuX2lzRGlzYWJsZWQgPSB2YWx1ZSQkMTsKICAgICAgICByZXR1cm4gdmFsdWUkJDEgPyB0aGlzLmRpc2FibGVkQ2xhc3MgOiBmYWxzZTsKICAgICAgfQogICAgfSksCgogICAgLyoqCiAgICAgIEFjY2Vzc2VkIGFzIGEgY2xhc3NuYW1lIGJpbmRpbmcgdG8gYXBwbHkgdGhlIGNvbXBvbmVudCdzIGBhY3RpdmVDbGFzc2AKICAgICAgQ1NTIGBjbGFzc2AgdG8gdGhlIGVsZW1lbnQgd2hlbiB0aGUgbGluayBpcyBhY3RpdmUuCiAgICAgICAgIFRoaXMgY29tcG9uZW50IGlzIGNvbnNpZGVyZWQgYWN0aXZlIHdoZW4gaXRzIGBjdXJyZW50V2hlbmAgcHJvcGVydHkgaXMgYHRydWVgCiAgICAgIG9yIHRoZSBhcHBsaWNhdGlvbidzIGN1cnJlbnQgcm91dGUgaXMgdGhlIHJvdXRlIHRoaXMgY29tcG9uZW50IHdvdWxkIHRyaWdnZXIKICAgICAgdHJhbnNpdGlvbnMgaW50by4KICAgICAgICAgVGhlIGBjdXJyZW50V2hlbmAgcHJvcGVydHkgY2FuIG1hdGNoIGFnYWluc3QgbXVsdGlwbGUgcm91dGVzIGJ5IHNlcGFyYXRpbmcKICAgICAgcm91dGUgbmFtZXMgdXNpbmcgdGhlIGAgYCAoc3BhY2UpIGNoYXJhY3Rlci4KICAgICAgICAgQHByb3BlcnR5IGFjdGl2ZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGFjdGl2ZTogKDAsIF9tZXRhbC5jb21wdXRlZCkoJ2FjdGl2ZUNsYXNzJywgJ19hY3RpdmUnLCBmdW5jdGlvbiBjb21wdXRlTGlua1RvQ29tcG9uZW50QWN0aXZlQ2xhc3MoKSB7CiAgICAgIHJldHVybiB0aGlzLl9hY3RpdmUgPyB0aGlzLmFjdGl2ZUNsYXNzIDogZmFsc2U7CiAgICB9KSwKICAgIF9hY3RpdmU6ICgwLCBfbWV0YWwuY29tcHV0ZWQpKCdfY3VycmVudFJvdXRlclN0YXRlJywgJ19yb3V0ZScsICdfbW9kZWxzJywgJ19xdWVyeScsICdsb2FkaW5nJywgJ2N1cnJlbnQtd2hlbicsIGZ1bmN0aW9uIGNvbXB1dGVMaW5rVG9Db21wb25lbnRBY3RpdmUoKSB7CiAgICAgIHZhciBzdGF0ZSA9IHRoaXMuX2N1cnJlbnRSb3V0ZXJTdGF0ZTsKCiAgICAgIGlmIChzdGF0ZSkgewogICAgICAgIHJldHVybiB0aGlzLl9pc0FjdGl2ZShzdGF0ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9KSwKICAgIHdpbGxCZUFjdGl2ZTogKDAsIF9tZXRhbC5jb21wdXRlZCkoJ19jdXJyZW50Um91dGVyU3RhdGUnLCAnX3RhcmdldFJvdXRlclN0YXRlJywgJ19yb3V0ZScsICdfbW9kZWxzJywgJ19xdWVyeScsICdsb2FkaW5nJywgJ2N1cnJlbnQtd2hlbicsIGZ1bmN0aW9uIGNvbXB1dGVMaW5rVG9Db21wb25lbnRXaWxsQmVBY3RpdmUoKSB7CiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5fY3VycmVudFJvdXRlclN0YXRlLAogICAgICAgICAgdGFyZ2V0ID0gdGhpcy5fdGFyZ2V0Um91dGVyU3RhdGU7CgogICAgICBpZiAoY3VycmVudCA9PT0gdGFyZ2V0KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5faXNBY3RpdmUodGFyZ2V0KTsKICAgIH0pLAogICAgX2lzQWN0aXZlOiBmdW5jdGlvbiBfaXNBY3RpdmUocm91dGVyU3RhdGUpIHsKICAgICAgaWYgKHRoaXMubG9hZGluZykgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgdmFyIGN1cnJlbnRXaGVuID0gdGhpc1snY3VycmVudC13aGVuJ107CgogICAgICBpZiAodHlwZW9mIGN1cnJlbnRXaGVuID09PSAnYm9vbGVhbicpIHsKICAgICAgICByZXR1cm4gY3VycmVudFdoZW47CiAgICAgIH0KCiAgICAgIHZhciBpc0N1cnJlbnRXaGVuU3BlY2lmaWVkID0gQm9vbGVhbihjdXJyZW50V2hlbik7CgogICAgICBpZiAoaXNDdXJyZW50V2hlblNwZWNpZmllZCkgewogICAgICAgIGN1cnJlbnRXaGVuID0gY3VycmVudFdoZW4uc3BsaXQoJyAnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjdXJyZW50V2hlbiA9IFt0aGlzLl9yb3V0ZV07CiAgICAgIH0KCiAgICAgIHZhciBtb2RlbHMgPSB0aGlzLl9tb2RlbHMsCiAgICAgICAgICBxdWVyeSA9IHRoaXMuX3F1ZXJ5LAogICAgICAgICAgcm91dGluZyA9IHRoaXMuX3JvdXRpbmc7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGN1cnJlbnRXaGVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHJvdXRpbmcuaXNBY3RpdmVGb3JSb3V0ZShtb2RlbHMsIHF1ZXJ5LCBjdXJyZW50V2hlbltpXSwgcm91dGVyU3RhdGUsIGlzQ3VycmVudFdoZW5TcGVjaWZpZWQpKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgICB0cmFuc2l0aW9uaW5nSW46ICgwLCBfbWV0YWwuY29tcHV0ZWQpKCdfYWN0aXZlJywgJ3dpbGxCZUFjdGl2ZScsIGZ1bmN0aW9uIGNvbXB1dGVMaW5rVG9Db21wb25lbnRUcmFuc2l0aW9uaW5nSW4oKSB7CiAgICAgIGlmICh0aGlzLndpbGxCZUFjdGl2ZSA9PT0gdHJ1ZSAmJiAhdGhpcy5fYWN0aXZlKSB7CiAgICAgICAgcmV0dXJuICdlbWJlci10cmFuc2l0aW9uaW5nLWluJzsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0pLAogICAgdHJhbnNpdGlvbmluZ091dDogKDAsIF9tZXRhbC5jb21wdXRlZCkoJ19hY3RpdmUnLCAnd2lsbEJlQWN0aXZlJywgZnVuY3Rpb24gY29tcHV0ZUxpbmtUb0NvbXBvbmVudFRyYW5zaXRpb25pbmdPdXQoKSB7CiAgICAgIGlmICh0aGlzLndpbGxCZUFjdGl2ZSA9PT0gZmFsc2UgJiYgdGhpcy5fYWN0aXZlKSB7CiAgICAgICAgcmV0dXJuICdlbWJlci10cmFuc2l0aW9uaW5nLW91dCc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9KSwKCiAgICAvKioKICAgICAgRXZlbnQgaGFuZGxlciB0aGF0IGludm9rZXMgdGhlIGxpbmssIGFjdGl2YXRpbmcgdGhlIGFzc29jaWF0ZWQgcm91dGUuCiAgICAgICAgIEBtZXRob2QgX2ludm9rZQogICAgICBAcGFyYW0ge0V2ZW50fSBldmVudAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9pbnZva2U6IGZ1bmN0aW9uIF9pbnZva2UoZXZlbnQpIHsKICAgICAgaWYgKCEoMCwgX3ZpZXdzLmlzU2ltcGxlQ2xpY2spKGV2ZW50KSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICB2YXIgYnViYmxlcyA9IHRoaXMuYnViYmxlcywKICAgICAgICAgIHByZXZlbnREZWZhdWx0ID0gdGhpcy5wcmV2ZW50RGVmYXVsdDsKICAgICAgdmFyIHRhcmdldCA9IHRoaXMuZWxlbWVudC50YXJnZXQ7CiAgICAgIHZhciBpc1NlbGYgPSAhdGFyZ2V0IHx8IHRhcmdldCA9PT0gJ19zZWxmJzsKCiAgICAgIGlmIChwcmV2ZW50RGVmYXVsdCAhPT0gZmFsc2UgJiYgaXNTZWxmKSB7CiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgfQoKICAgICAgaWYgKGJ1YmJsZXMgPT09IGZhbHNlKSB7CiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9pc0Rpc2FibGVkKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBpZiAodGhpcy5sb2FkaW5nKSB7CiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aAogICAgICAgIChmYWxzZSAmJiAoMCwgX2RlYnVnLndhcm4pKCdUaGlzIGxpbmsgaXMgaW4gYW4gaW5hY3RpdmUgbG9hZGluZyBzdGF0ZSBiZWNhdXNlIGF0IGxlYXN0IG9uZSBvZiBpdHMgbW9kZWxzICcgKyAnY3VycmVudGx5IGhhcyBhIG51bGwvdW5kZWZpbmVkIHZhbHVlLCBvciB0aGUgcHJvdmlkZWQgcm91dGUgbmFtZSBpcyBpbnZhbGlkLicsIGZhbHNlLCB7CiAgICAgICAgICBpZDogJ2VtYmVyLWdsaW1tZXIubGluay10by5pbmFjdGl2ZS1sb2FkaW5nLXN0YXRlJwogICAgICAgIH0pKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmICghaXNTZWxmKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB2YXIgcm91dGVOYW1lID0gdGhpcy5fcm91dGUsCiAgICAgICAgICBtb2RlbHMgPSB0aGlzLl9tb2RlbHMsCiAgICAgICAgICBxdWVyeVBhcmFtcyA9IHRoaXMuX3F1ZXJ5LAogICAgICAgICAgc2hvdWxkUmVwbGFjZSA9IHRoaXMucmVwbGFjZTsKICAgICAgdmFyIHBheWxvYWQgPSB7CiAgICAgICAgcXVlcnlQYXJhbXM6IHF1ZXJ5UGFyYW1zLAogICAgICAgIHJvdXRlTmFtZTogcm91dGVOYW1lCiAgICAgIH07CiAgICAgICgwLCBfaW5zdHJ1bWVudGF0aW9uLmZsYWdnZWRJbnN0cnVtZW50KSgnaW50ZXJhY3Rpb24ubGluay10bycsIHBheWxvYWQsIHRoaXMuX2dlbmVyYXRlVHJhbnNpdGlvbihwYXlsb2FkLCByb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMsIHNob3VsZFJlcGxhY2UpKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIF9nZW5lcmF0ZVRyYW5zaXRpb246IGZ1bmN0aW9uIF9nZW5lcmF0ZVRyYW5zaXRpb24ocGF5bG9hZCwgcXVhbGlmaWVkUm91dGVOYW1lLCBtb2RlbHMsIHF1ZXJ5UGFyYW1zLCBzaG91bGRSZXBsYWNlKSB7CiAgICAgIHZhciByb3V0aW5nID0gdGhpcy5fcm91dGluZzsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICBwYXlsb2FkLnRyYW5zaXRpb24gPSByb3V0aW5nLnRyYW5zaXRpb25UbyhxdWFsaWZpZWRSb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMsIHNob3VsZFJlcGxhY2UpOwogICAgICB9OwogICAgfSwKCiAgICAvKioKICAgICAgU2V0cyB0aGUgZWxlbWVudCdzIGBocmVmYCBhdHRyaWJ1dGUgdG8gdGhlIHVybCBmb3IKICAgICAgdGhlIGBMaW5rQ29tcG9uZW50YCdzIHRhcmdldGVkIHJvdXRlLgogICAgICAgICBJZiB0aGUgYExpbmtDb21wb25lbnRgJ3MgYHRhZ05hbWVgIGlzIGNoYW5nZWQgdG8gYSB2YWx1ZSBvdGhlcgogICAgICB0aGFuIGBhYCwgdGhpcyBwcm9wZXJ0eSB3aWxsIGJlIGlnbm9yZWQuCiAgICAgICAgIEBwcm9wZXJ0eSBocmVmCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgaHJlZjogKDAsIF9tZXRhbC5jb21wdXRlZCkoJ19jdXJyZW50Um91dGVyU3RhdGUnLCAnX3JvdXRlJywgJ19tb2RlbHMnLCAnX3F1ZXJ5JywgJ3RhZ05hbWUnLCAnbG9hZGluZycsICdsb2FkaW5nSHJlZicsIGZ1bmN0aW9uIGNvbXB1dGVMaW5rVG9Db21wb25lbnRIcmVmKCkgewogICAgICBpZiAodGhpcy50YWdOYW1lICE9PSAnYScpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmxvYWRpbmcpIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2FkaW5nSHJlZjsKICAgICAgfQoKICAgICAgdmFyIHJvdXRlID0gdGhpcy5fcm91dGUsCiAgICAgICAgICBtb2RlbHMgPSB0aGlzLl9tb2RlbHMsCiAgICAgICAgICBxdWVyeSA9IHRoaXMuX3F1ZXJ5LAogICAgICAgICAgcm91dGluZyA9IHRoaXMuX3JvdXRpbmc7CgogICAgICBpZiAoZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgKSB7CiAgICAgICAgLyoKICAgICAgICAgKiBVbmZvcnR1bmF0ZWx5LCB0byBnZXQgZGVjZW50IGVycm9yIG1lc3NhZ2VzLCB3ZSBuZWVkIHRvIGRvIHRoaXMuCiAgICAgICAgICogSW4gc29tZSBmdXR1cmUgc3RhdGUgd2Ugc2hvdWxkIGJlIGFibGUgdG8gdXNlIGEgImZlYXR1cmUgZmxhZyIKICAgICAgICAgKiB3aGljaCBhbGxvd3MgdXMgdG8gc3RyaXAgdGhpcyB3aXRob3V0IG5lZWRpbmcgdG8gY2FsbCBpdCB0d2ljZS4KICAgICAgICAgKgogICAgICAgICAqIGlmIChpc0RlYnVnQnVpbGQoKSkgewogICAgICAgICAqICAgLy8gRG8gdGhlIHVzZWZ1bCBkZWJ1ZyB0aGluZywgcHJvYmFibHkgaW5jbHVkaW5nIHRyeS9jYXRjaC4KICAgICAgICAgKiB9IGVsc2UgewogICAgICAgICAqICAgLy8gRG8gdGhlIHBlcmZvcm1hbnQgdGhpbmcuCiAgICAgICAgICogfQogICAgICAgICAqLwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gcm91dGluZy5nZW5lcmF0ZVVSTChyb3V0ZSwgbW9kZWxzLCBxdWVyeSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aAogICAgICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IGF0dGVtcHRlZCB0byBnZW5lcmF0ZSBhIGxpbmsgZm9yIHRoZSBcIiIgKyB0aGlzLnJvdXRlICsgIlwiIHJvdXRlLCBidXQgZGlkIG5vdCAiICsgInBhc3MgdGhlIG1vZGVscyByZXF1aXJlZCBmb3IgZ2VuZXJhdGluZyBpdHMgZHluYW1pYyBzZWdtZW50cy4gIiArIGUubWVzc2FnZSkpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gcm91dGluZy5nZW5lcmF0ZVVSTChyb3V0ZSwgbW9kZWxzLCBxdWVyeSk7CiAgICAgIH0KICAgIH0pLAogICAgbG9hZGluZzogKDAsIF9tZXRhbC5jb21wdXRlZCkoJ19yb3V0ZScsICdfbW9kZWxzQXJlTG9hZGVkJywgJ2xvYWRpbmdDbGFzcycsIGZ1bmN0aW9uIGNvbXB1dGVMaW5rVG9Db21wb25lbnRMb2FkaW5nKCkgewogICAgICB2YXIgcm91dGUgPSB0aGlzLl9yb3V0ZSwKICAgICAgICAgIGxvYWRlZCA9IHRoaXMuX21vZGVsc0FyZUxvYWRlZDsKCiAgICAgIGlmICghbG9hZGVkIHx8IHJvdXRlID09PSBudWxsIHx8IHJvdXRlID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2FkaW5nQ2xhc3M7CiAgICAgIH0KICAgIH0pLAogICAgX21vZGVsc0FyZUxvYWRlZDogKDAsIF9tZXRhbC5jb21wdXRlZCkoJ19tb2RlbHMnLCBmdW5jdGlvbiBjb21wdXRlTGlua1RvQ29tcG9uZW50TW9kZWxzQXJlTG9hZGVkKCkgewogICAgICB2YXIgbW9kZWxzID0gdGhpcy5fbW9kZWxzOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtb2RlbHMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgbW9kZWwgPSBtb2RlbHNbaV07CgogICAgICAgIGlmIChtb2RlbCA9PT0gbnVsbCB8fCBtb2RlbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0pLAoKICAgIC8qKgogICAgICBUaGUgZGVmYXVsdCBocmVmIHZhbHVlIHRvIHVzZSB3aGlsZSBhIGxpbmstdG8gaXMgbG9hZGluZy4KICAgICAgT25seSBhcHBsaWVzIHdoZW4gdGFnTmFtZSBpcyAnYScKICAgICAgICAgQHByb3BlcnR5IGxvYWRpbmdIcmVmCiAgICAgIEB0eXBlIFN0cmluZwogICAgICBAZGVmYXVsdCAjCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgbG9hZGluZ0hyZWY6ICcjJywKICAgIGRpZFJlY2VpdmVBdHRyczogZnVuY3Rpb24gZGlkUmVjZWl2ZUF0dHJzKCkgewogICAgICB2YXIgZGlzYWJsZWRXaGVuID0gdGhpcy5kaXNhYmxlZFdoZW47CgogICAgICBpZiAoZGlzYWJsZWRXaGVuICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLnNldCgnZGlzYWJsZWQnLCBkaXNhYmxlZFdoZW4pOwogICAgICB9CgogICAgICB2YXIgcGFyYW1zID0gdGhpcy5wYXJhbXM7CgogICAgICBpZiAoIXBhcmFtcyB8fCBwYXJhbXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgKGZhbHNlICYmICEoISh0aGlzLnJvdXRlID09PSBVTkRFRklORUQgJiYgdGhpcy5tb2RlbCA9PT0gVU5ERUZJTkVEICYmIHRoaXMubW9kZWxzID09PSBVTkRFRklORUQgJiYgdGhpcy5xdWVyeSA9PT0gVU5ERUZJTkVEKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgbXVzdCBwcm92aWRlIGF0IGxlYXN0IG9uZSBvZiB0aGUgYEByb3V0ZWAsIGBAbW9kZWxgLCBgQG1vZGVsc2Agb3IgYEBxdWVyeWAgYXJndW1lbnQgdG8gYDxMaW5rVG8+YC4nLCAhKHRoaXMucm91dGUgPT09IFVOREVGSU5FRCAmJiB0aGlzLm1vZGVsID09PSBVTkRFRklORUQgJiYgdGhpcy5tb2RlbHMgPT09IFVOREVGSU5FRCAmJiB0aGlzLnF1ZXJ5ID09PSBVTkRFRklORUQpKSk7CiAgICAgICAgdmFyIG1vZGVscyA9IHRoaXMuX21vZGVsczsKCiAgICAgICAgaWYgKG1vZGVscy5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgbGFzdE1vZGVsID0gbW9kZWxzW21vZGVscy5sZW5ndGggLSAxXTsKCiAgICAgICAgICBpZiAodHlwZW9mIGxhc3RNb2RlbCA9PT0gJ29iamVjdCcgJiYgbGFzdE1vZGVsICE9PSBudWxsICYmIGxhc3RNb2RlbC5pc1F1ZXJ5UGFyYW1zKSB7CiAgICAgICAgICAgIHRoaXMucXVlcnkgPSBsYXN0TW9kZWwudmFsdWVzOwogICAgICAgICAgICBtb2RlbHMucG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHBhcmFtcyA9IHBhcmFtcy5zbGljZSgpOyAvLyBQcm9jZXNzIHRoZSBwb3NpdGlvbmFsIGFyZ3VtZW50cywgaW4gb3JkZXIuCiAgICAgIC8vIDEuIElubGluZSBsaW5rIHRpdGxlIGNvbWVzIGZpcnN0LCBpZiBwcmVzZW50LgoKICAgICAgaWYgKCF0aGlzW0hBU19CTE9DS10pIHsKICAgICAgICB0aGlzLnNldCgnbGlua1RpdGxlJywgcGFyYW1zLnNoaWZ0KCkpOwogICAgICB9IC8vIDIuIFRoZSBsYXN0IGFyZ3VtZW50IGlzIHBvc3NpYmx5IHRoZSBgcXVlcnlgIG9iamVjdC4KCgogICAgICB2YXIgcXVlcnlQYXJhbXMgPSBwYXJhbXNbcGFyYW1zLmxlbmd0aCAtIDFdOwoKICAgICAgaWYgKHF1ZXJ5UGFyYW1zICYmIHF1ZXJ5UGFyYW1zLmlzUXVlcnlQYXJhbXMpIHsKICAgICAgICB0aGlzLnNldCgncXVlcnknLCBwYXJhbXMucG9wKCkudmFsdWVzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnNldCgncXVlcnknLCBVTkRFRklORUQpOwogICAgICB9IC8vIDMuIElmIHRoZXJlIGlzIGEgYHJvdXRlYCwgaXQgaXMgbm93IGF0IGluZGV4IDAuCgoKICAgICAgaWYgKHBhcmFtcy5sZW5ndGggPT09IDApIHsKICAgICAgICB0aGlzLnNldCgncm91dGUnLCBVTkRFRklORUQpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2V0KCdyb3V0ZScsIHBhcmFtcy5zaGlmdCgpKTsKICAgICAgfSAvLyA0LiBBbnkgcmVtYWluaW5nIGluZGljZXMgKGlmIGFueSkgYXJlIGBtb2RlbHNgLgoKCiAgICAgIHRoaXMuc2V0KCdtb2RlbCcsIFVOREVGSU5FRCk7CiAgICAgIHRoaXMuc2V0KCdtb2RlbHMnLCBwYXJhbXMpOwogICAgfQogIH0pOwogIF9leHBvcnRzLkxpbmtDb21wb25lbnQgPSBMaW5rQ29tcG9uZW50OwoKICBMaW5rQ29tcG9uZW50LnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuICdAZW1iZXIvcm91dGluZy9saW5rLWNvbXBvbmVudCc7CiAgfTsKCiAgTGlua0NvbXBvbmVudC5yZW9wZW5DbGFzcyh7CiAgICBwb3NpdGlvbmFsUGFyYW1zOiAncGFyYW1zJwogIH0pOyAvLyBAdHMtY2hlY2sKCiAgdmFyIGdldERlYnVnU3RhY2sgPSBmdW5jdGlvbiBnZXREZWJ1Z1N0YWNrKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJDYW4ndCBhY2Nlc3MgdGhlIERlYnVnU3RhY2sgY2xhc3Mgb3V0c2lkZSBvZiBkZWJ1ZyBtb2RlIik7CiAgfTsKCiAgaWYgKGZhbHNlCiAgLyogREVCVUcgKi8KICApIHsKICAgIHZhciBFbGVtZW50ID0gZnVuY3Rpb24gRWxlbWVudChuYW1lKSB7CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICB9OwoKICAgIHZhciBUZW1wbGF0ZUVsZW1lbnQgPQogICAgLyojX19QVVJFX18qLwogICAgZnVuY3Rpb24gKF9FbGVtZW50KSB7CiAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShUZW1wbGF0ZUVsZW1lbnQsIF9FbGVtZW50KTsKCiAgICAgIGZ1bmN0aW9uIFRlbXBsYXRlRWxlbWVudCgpIHsKICAgICAgICByZXR1cm4gX0VsZW1lbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgICB9CgogICAgICByZXR1cm4gVGVtcGxhdGVFbGVtZW50OwogICAgfShFbGVtZW50KTsKCiAgICB2YXIgRW5naW5lRWxlbWVudCA9CiAgICAvKiNfX1BVUkVfXyovCiAgICBmdW5jdGlvbiAoX0VsZW1lbnQyKSB7CiAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShFbmdpbmVFbGVtZW50LCBfRWxlbWVudDIpOwoKICAgICAgZnVuY3Rpb24gRW5naW5lRWxlbWVudCgpIHsKICAgICAgICByZXR1cm4gX0VsZW1lbnQyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgICAgfQoKICAgICAgcmV0dXJuIEVuZ2luZUVsZW1lbnQ7CiAgICB9KEVsZW1lbnQpOwoKICAgIHZhciBEZWJ1Z1N0YWNrSW1wbCA9CiAgICAvKiNfX1BVUkVfXyovCiAgICBmdW5jdGlvbiAoKSB7CiAgICAgIGZ1bmN0aW9uIERlYnVnU3RhY2tJbXBsKCkgewogICAgICAgIHRoaXMuX3N0YWNrID0gW107CiAgICAgIH0KCiAgICAgIHZhciBfcHJvdG8xNiA9IERlYnVnU3RhY2tJbXBsLnByb3RvdHlwZTsKCiAgICAgIF9wcm90bzE2LnB1c2ggPSBmdW5jdGlvbiBwdXNoKG5hbWUpIHsKICAgICAgICB0aGlzLl9zdGFjay5wdXNoKG5ldyBUZW1wbGF0ZUVsZW1lbnQobmFtZSkpOwogICAgICB9OwoKICAgICAgX3Byb3RvMTYucHVzaEVuZ2luZSA9IGZ1bmN0aW9uIHB1c2hFbmdpbmUobmFtZSkgewogICAgICAgIHRoaXMuX3N0YWNrLnB1c2gobmV3IEVuZ2luZUVsZW1lbnQobmFtZSkpOwogICAgICB9OwoKICAgICAgX3Byb3RvMTYucG9wID0gZnVuY3Rpb24gcG9wKCkgewogICAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5fc3RhY2sucG9wKCk7CgogICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICByZXR1cm4gZWxlbWVudC5uYW1lOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIF9wcm90bzE2LnBlZWsgPSBmdW5jdGlvbiBwZWVrKCkgewogICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoaXMuX2N1cnJlbnRUZW1wbGF0ZSgpOwoKICAgICAgICB2YXIgZW5naW5lID0gdGhpcy5fY3VycmVudEVuZ2luZSgpOwoKICAgICAgICBpZiAoZW5naW5lKSB7CiAgICAgICAgICByZXR1cm4gIlwiIiArIHRlbXBsYXRlICsgIlwiIChpbiBcIiIgKyBlbmdpbmUgKyAiXCIpIjsKICAgICAgICB9IGVsc2UgaWYgKHRlbXBsYXRlKSB7CiAgICAgICAgICByZXR1cm4gIlwiIiArIHRlbXBsYXRlICsgIlwiIjsKICAgICAgICB9CiAgICAgIH07CgogICAgICBfcHJvdG8xNi5fY3VycmVudFRlbXBsYXRlID0gZnVuY3Rpb24gX2N1cnJlbnRUZW1wbGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2V0Q3VycmVudEJ5VHlwZShUZW1wbGF0ZUVsZW1lbnQpOwogICAgICB9OwoKICAgICAgX3Byb3RvMTYuX2N1cnJlbnRFbmdpbmUgPSBmdW5jdGlvbiBfY3VycmVudEVuZ2luZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2V0Q3VycmVudEJ5VHlwZShFbmdpbmVFbGVtZW50KTsKICAgICAgfTsKCiAgICAgIF9wcm90bzE2Ll9nZXRDdXJyZW50QnlUeXBlID0gZnVuY3Rpb24gX2dldEN1cnJlbnRCeVR5cGUodHlwZSkgewogICAgICAgIGZvciAodmFyIGkgPSB0aGlzLl9zdGFjay5sZW5ndGg7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuX3N0YWNrW2ldOwoKICAgICAgICAgIGlmIChlbGVtZW50IGluc3RhbmNlb2YgdHlwZSkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudC5uYW1lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHJldHVybiBEZWJ1Z1N0YWNrSW1wbDsKICAgIH0oKTsKCiAgICBnZXREZWJ1Z1N0YWNrID0gZnVuY3Rpb24gZ2V0RGVidWdTdGFjaygpIHsKICAgICAgcmV0dXJuIG5ldyBEZWJ1Z1N0YWNrSW1wbCgpOwogICAgfTsKICB9CgogIHZhciBnZXREZWJ1Z1N0YWNrJDEgPSBnZXREZWJ1Z1N0YWNrOwogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwoKICAvKioKICAgIFRoZSBge3sjZWFjaH19YCBoZWxwZXIgbG9vcHMgb3ZlciBlbGVtZW50cyBpbiBhIGNvbGxlY3Rpb24uIEl0IGlzIGFuIGV4dGVuc2lvbgogICAgb2YgdGhlIGJhc2UgSGFuZGxlYmFycyBge3sjZWFjaH19YCBoZWxwZXIuCiAgCiAgICBUaGUgZGVmYXVsdCBiZWhhdmlvciBvZiBge3sjZWFjaH19YCBpcyB0byB5aWVsZCBpdHMgaW5uZXIgYmxvY2sgb25jZSBmb3IgZXZlcnkKICAgIGl0ZW0gaW4gYW4gYXJyYXkgcGFzc2luZyB0aGUgaXRlbSBhcyB0aGUgZmlyc3QgYmxvY2sgcGFyYW1ldGVyLgogIAogICAgQXNzdW1pbmcgdGhlIGBAZGV2ZWxvcGVyc2AgYXJndW1lbnQgY29udGFpbnMgdGhpcyBhcnJheToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIFt7IG5hbWU6ICdZZWh1ZGEnIH0seyBuYW1lOiAnVG9tJyB9LCB7IG5hbWU6ICdQYXVsJyB9XTsKICAgIGBgYAogIAogICAgYGBgaGFuZGxlYmFycwogICAgPHVsPgogICAgICB7eyNlYWNoIEBkZXZlbG9wZXJzIGFzIHxwZXJzb258fX0KICAgICAgICA8bGk+SGVsbG8sIHt7cGVyc29uLm5hbWV9fSE8L2xpPgogICAgICB7ey9lYWNofX0KICAgIDwvdWw+CiAgICBgYGAKICAKICAgIFRoZSBzYW1lIHJ1bGVzIGFwcGx5IHRvIGFycmF5cyBvZiBwcmltaXRpdmVzLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgWydZZWh1ZGEnLCAnVG9tJywgJ1BhdWwnXQogICAgYGBgCiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICA8dWw+CiAgICAgIHt7I2VhY2ggQGRldmVsb3Blck5hbWVzIGFzIHxuYW1lfH19CiAgICAgICAgPGxpPkhlbGxvLCB7e25hbWV9fSE8L2xpPgogICAgICB7ey9lYWNofX0KICAgIDwvdWw+CiAgICBgYGAKICAKICAgIER1cmluZyBpdGVyYXRpb24sIHRoZSBpbmRleCBvZiBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5IGlzIHByb3ZpZGVkIGFzIGEgc2Vjb25kIGJsb2NrCiAgICBwYXJhbWV0ZXIuCiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICA8dWw+CiAgICAgIHt7I2VhY2ggQGRldmVsb3BlcnMgYXMgfHBlcnNvbiBpbmRleHx9fQogICAgICAgIDxsaT5IZWxsbywge3twZXJzb24ubmFtZX19ISBZb3UncmUgbnVtYmVyIHt7aW5kZXh9fSBpbiBsaW5lPC9saT4KICAgICAge3svZWFjaH19CiAgICA8L3VsPgogICAgYGBgCiAgCiAgICAjIyMgU3BlY2lmeWluZyBLZXlzCiAgCiAgICBJbiBvcmRlciB0byBpbXByb3ZlIHJlbmRlcmluZyBzcGVlZCwgRW1iZXIgd2lsbCB0cnkgdG8gcmV1c2UgdGhlIERPTSBlbGVtZW50cwogICAgd2hlcmUgcG9zc2libGUuIFNwZWNpZmljYWxseSwgaWYgdGhlIHNhbWUgaXRlbSBpcyBwcmVzZW50IGluIHRoZSBhcnJheSBib3RoCiAgICBiZWZvcmUgYW5kIGFmdGVyIHRoZSBjaGFuZ2UsIGl0cyBET00gb3V0cHV0IHdpbGwgYmUgcmV1c2VkLgogIAogICAgVGhlIGBrZXlgIG9wdGlvbiBpcyB1c2VkIHRvIHRlbGwgRW1iZXIgaG93IHRvIGRldGVybWluZSBpZiB0aGUgaXRlbXMgaW4gdGhlCiAgICBhcnJheSBiZWluZyBpdGVyYXRlZCBvdmVyIHdpdGggYHt7I2VhY2h9fWAgaGFzIGNoYW5nZWQgYmV0d2VlbiByZW5kZXJzLiBCeQogICAgZGVmYXVsdCB0aGUgaXRlbSdzIG9iamVjdCBpZGVudGl0eSBpcyB1c2VkLgogIAogICAgVGhpcyBpcyB1c3VhbGx5IHN1ZmZpY2llbnQsIHNvIGluIG1vc3QgY2FzZXMsIHRoZSBga2V5YCBvcHRpb24gaXMgc2ltcGx5IG5vdAogICAgbmVlZGVkLiBIb3dldmVyLCBpbiBzb21lIHJhcmUgY2FzZXMsIHRoZSBvYmplY3RzJyBpZGVudGl0aWVzIG1heSBjaGFuZ2UgZXZlbgogICAgdGhvdWdoIHRoZXkgcmVwcmVzZW50IHRoZSBzYW1lIHVuZGVybHlpbmcgZGF0YS4KICAKICAgIEZvciBleGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgcGVvcGxlLm1hcChwZXJzb24gPT4gewogICAgICByZXR1cm4geyAuLi5wZXJzb24sIHR5cGU6ICdkZXZlbG9wZXInIH07CiAgICB9KTsKICAgIGBgYAogIAogICAgSW4gdGhpcyBjYXNlLCBlYWNoIHRpbWUgdGhlIGBwZW9wbGVgIGFycmF5IGlzIGBtYXBgLWVkIG92ZXIsIGl0IHdpbGwgcHJvZHVjZQogICAgYW4gbmV3IGFycmF5IHdpdGggY29tcGxldGVseSBkaWZmZXJlbnQgb2JqZWN0cyBiZXR3ZWVuIHJlbmRlcnMuIEluIHRoZXNlIGNhc2VzLAogICAgeW91IGNhbiBoZWxwIEVtYmVyIGRldGVybWluZSBob3cgdGhlc2Ugb2JqZWN0cyByZWxhdGVkIHRvIGVhY2ggb3RoZXIgd2l0aCB0aGUKICAgIGBrZXlgIG9wdGlvbjoKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIDx1bD4KICAgICAge3sjZWFjaCBAZGV2ZWxvcGVycyBrZXk9Im5hbWUiIGFzIHxwZXJzb258fX0KICAgICAgICA8bGk+SGVsbG8sIHt7cGVyc29uLm5hbWV9fSE8L2xpPgogICAgICB7ey9lYWNofX0KICAgIDwvdWw+CiAgICBgYGAKICAKICAgIEJ5IGRvaW5nIHNvLCBFbWJlciB3aWxsIHVzZSB0aGUgdmFsdWUgb2YgdGhlIHByb3BlcnR5IHNwZWNpZmllZCAoYHBlcnNvbi5uYW1lYAogICAgaW4gdGhlIGV4YW1wbGUpIHRvIGZpbmQgYSAibWF0Y2giIGZyb20gdGhlIHByZXZpb3VzIHJlbmRlci4gVGhhdCBpcywgaWYgRW1iZXIKICAgIGhhcyBwcmV2aW91c2x5IHNlZW4gYW4gb2JqZWN0IGZyb20gdGhlIGBAZGV2ZWxvcGVyc2AgYXJyYXkgd2l0aCBhIG1hdGNoaW5nCiAgICBuYW1lLCBpdHMgRE9NIGVsZW1lbnRzIHdpbGwgYmUgcmUtdXNlZC4KICAKICAgICMjIyB7e2Vsc2V9fSBjb25kaXRpb24KICAKICAgIGB7eyNlYWNofX1gIGNhbiBoYXZlIGEgbWF0Y2hpbmcgYHt7ZWxzZX19YC4gVGhlIGNvbnRlbnRzIG9mIHRoaXMgYmxvY2sgd2lsbCByZW5kZXIKICAgIGlmIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5LgogIAogICAgYGBgaGFuZGxlYmFycwogICAgPHVsPgogICAgICB7eyNlYWNoIEBkZXZlbG9wZXJzIGFzIHxwZXJzb258fX0KICAgICAgICA8bGk+e3twZXJzb24ubmFtZX19IGlzIGF2YWlsYWJsZSE8L2xpPgogICAgICB7e2Vsc2V9fQogICAgICAgIDxsaT5Tb3JyeSwgbm9ib2R5IGlzIGF2YWlsYWJsZSBmb3IgdGhpcyB0YXNrLjwvbGk+CiAgICAgIHt7L2VhY2h9fQogICAgPC91bD4KICAgIGBgYAogIAogICAgQG1ldGhvZCBlYWNoCiAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICBAcHVibGljCiAgICovCgogIC8qKgogICAgVGhlIGB7e2VhY2gtaW59fWAgaGVscGVyIGxvb3BzIG92ZXIgcHJvcGVydGllcyBvbiBhbiBvYmplY3QuCiAgCiAgICBGb3IgZXhhbXBsZSwgaWYgdGhlIGBAdXNlcmAgYXJndW1lbnQgY29udGFpbnMgdGhpcyBvYmplY3Q6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICB7CiAgICAgICJuYW1lIjogIlNoZWxseSBTYWlscyIsCiAgICAgICJhZ2UiOiA0MgogICAgfQogICAgYGBgCiAgCiAgICBUaGlzIHRlbXBsYXRlIHdvdWxkIGRpc3BsYXkgYWxsIHByb3BlcnRpZXMgb24gdGhlIGBAdXNlcmAKICAgIG9iamVjdCBpbiBhIGxpc3Q6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICA8dWw+CiAgICB7eyNlYWNoLWluIEB1c2VyIGFzIHxrZXkgdmFsdWV8fX0KICAgICAgPGxpPnt7a2V5fX06IHt7dmFsdWV9fTwvbGk+CiAgICB7ey9lYWNoLWlufX0KICAgIDwvdWw+CiAgICBgYGAKICAKICAgIE91dHB1dHRpbmcgdGhlaXIgbmFtZSBhbmQgYWdlLgogIAogICAgQG1ldGhvZCBlYWNoLWluCiAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICBAcHVibGljCiAgICBAc2luY2UgMi4xLjAKICAqLwoKICBfZXhwb3J0cy5nZXREZWJ1Z1N0YWNrID0gZ2V0RGVidWdTdGFjayQxOwogIHZhciBFQUNIX0lOX1JFRkVSRU5DRSA9ICgwLCBfdXRpbHMuc3ltYm9sKSgnRUFDSF9JTicpOwoKICB2YXIgRWFjaEluUmVmZXJlbmNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRWFjaEluUmVmZXJlbmNlKGlubmVyKSB7CiAgICAgIHRoaXMuaW5uZXIgPSBpbm5lcjsKICAgICAgdGhpcy50YWcgPSBpbm5lci50YWc7CiAgICAgIHRoaXNbRUFDSF9JTl9SRUZFUkVOQ0VdID0gdHJ1ZTsKICAgIH0KCiAgICB2YXIgX3Byb3RvMTcgPSBFYWNoSW5SZWZlcmVuY2UucHJvdG90eXBlOwoKICAgIF9wcm90bzE3LnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHJldHVybiB0aGlzLmlubmVyLnZhbHVlKCk7CiAgICB9OwoKICAgIF9wcm90bzE3LmdldCA9IGZ1bmN0aW9uIGdldChrZXkpIHsKICAgICAgcmV0dXJuIHRoaXMuaW5uZXIuZ2V0KGtleSk7CiAgICB9OwoKICAgIHJldHVybiBFYWNoSW5SZWZlcmVuY2U7CiAgfSgpOwoKICBmdW5jdGlvbiBpc0VhY2hJbihyZWYpIHsKICAgIHJldHVybiByZWYgIT09IG51bGwgJiYgdHlwZW9mIHJlZiA9PT0gJ29iamVjdCcgJiYgcmVmW0VBQ0hfSU5fUkVGRVJFTkNFXTsKICB9CgogIGZ1bmN0aW9uIGVhY2hJbihfdm0sIGFyZ3MpIHsKICAgIHJldHVybiBuZXcgRWFjaEluUmVmZXJlbmNlKGFyZ3MucG9zaXRpb25hbC5hdCgwKSk7CiAgfQoKICB2YXIgSVRFUkFUT1JfS0VZX0dVSUQgPSAnYmUyNzc3NTctYmJiZS00NjIwLTlmY2ItMjEzZWY0MzNjY2EyJzsKCiAgZnVuY3Rpb24gX2l0ZXJhYmxlRm9yKHJlZiwga2V5UGF0aCkgewogICAgaWYgKGlzRWFjaEluKHJlZikpIHsKICAgICAgcmV0dXJuIG5ldyBFYWNoSW5JdGVyYWJsZShyZWYsIGtleVBhdGggfHwgJ0BrZXknKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgRWFjaEl0ZXJhYmxlKHJlZiwga2V5UGF0aCB8fCAnQGlkZW50aXR5Jyk7CiAgICB9CiAgfQoKICB2YXIgQm91bmRlZEl0ZXJhdG9yID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQm91bmRlZEl0ZXJhdG9yKGxlbmd0aCwga2V5Rm9yKSB7CiAgICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoOwogICAgICB0aGlzLmtleUZvciA9IGtleUZvcjsKICAgICAgdGhpcy5wb3NpdGlvbiA9IDA7CiAgICB9CgogICAgdmFyIF9wcm90bzE4ID0gQm91bmRlZEl0ZXJhdG9yLnByb3RvdHlwZTsKCiAgICBfcHJvdG8xOC5pc0VtcHR5ID0gZnVuY3Rpb24gaXNFbXB0eSgpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICBfcHJvdG8xOC5tZW1vRm9yID0gZnVuY3Rpb24gbWVtb0Zvcihwb3NpdGlvbikgewogICAgICByZXR1cm4gcG9zaXRpb247CiAgICB9OwoKICAgIF9wcm90bzE4Lm5leHQgPSBmdW5jdGlvbiBuZXh0KCkgewogICAgICB2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGgsCiAgICAgICAgICBrZXlGb3IgPSB0aGlzLmtleUZvciwKICAgICAgICAgIHBvc2l0aW9uID0gdGhpcy5wb3NpdGlvbjsKCiAgICAgIGlmIChwb3NpdGlvbiA+PSBsZW5ndGgpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgdmFyIHZhbHVlJCQxID0gdGhpcy52YWx1ZUZvcihwb3NpdGlvbik7CiAgICAgIHZhciBtZW1vID0gdGhpcy5tZW1vRm9yKHBvc2l0aW9uKTsKICAgICAgdmFyIGtleSA9IGtleUZvcih2YWx1ZSQkMSwgbWVtbywgcG9zaXRpb24pOwogICAgICB0aGlzLnBvc2l0aW9uKys7CiAgICAgIHJldHVybiB7CiAgICAgICAga2V5OiBrZXksCiAgICAgICAgdmFsdWU6IHZhbHVlJCQxLAogICAgICAgIG1lbW86IG1lbW8KICAgICAgfTsKICAgIH07CgogICAgcmV0dXJuIEJvdW5kZWRJdGVyYXRvcjsKICB9KCk7CgogIHZhciBBcnJheUl0ZXJhdG9yID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9Cb3VuZGVkSXRlcmF0b3IpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShBcnJheUl0ZXJhdG9yLCBfQm91bmRlZEl0ZXJhdG9yKTsKCiAgICBmdW5jdGlvbiBBcnJheUl0ZXJhdG9yKGFycmF5LCBsZW5ndGgsIGtleUZvcikgewogICAgICB2YXIgX3RoaXMxMjsKCiAgICAgIF90aGlzMTIgPSBfQm91bmRlZEl0ZXJhdG9yLmNhbGwodGhpcywgbGVuZ3RoLCBrZXlGb3IpIHx8IHRoaXM7CiAgICAgIF90aGlzMTIuYXJyYXkgPSBhcnJheTsKICAgICAgcmV0dXJuIF90aGlzMTI7CiAgICB9CgogICAgQXJyYXlJdGVyYXRvci5mcm9tID0gZnVuY3Rpb24gZnJvbShhcnJheSwga2V5Rm9yKSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheS5sZW5ndGg7CgogICAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIEVNUFRZX0lURVJBVE9SOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuZXcgdGhpcyhhcnJheSwgbGVuZ3RoLCBrZXlGb3IpOwogICAgICB9CiAgICB9OwoKICAgIEFycmF5SXRlcmF0b3IuZnJvbUZvckVhY2hhYmxlID0gZnVuY3Rpb24gZnJvbUZvckVhY2hhYmxlKG9iamVjdCwga2V5Rm9yKSB7CiAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICBvYmplY3QuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgICAgIHJldHVybiBhcnJheS5wdXNoKGl0ZW0pOwogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXMuZnJvbShhcnJheSwga2V5Rm9yKTsKICAgIH07CgogICAgdmFyIF9wcm90bzE5ID0gQXJyYXlJdGVyYXRvci5wcm90b3R5cGU7CgogICAgX3Byb3RvMTkudmFsdWVGb3IgPSBmdW5jdGlvbiB2YWx1ZUZvcihwb3NpdGlvbikgewogICAgICByZXR1cm4gdGhpcy5hcnJheVtwb3NpdGlvbl07CiAgICB9OwoKICAgIHJldHVybiBBcnJheUl0ZXJhdG9yOwogIH0oQm91bmRlZEl0ZXJhdG9yKTsKCiAgdmFyIEVtYmVyQXJyYXlJdGVyYXRvciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfQm91bmRlZEl0ZXJhdG9yMikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKEVtYmVyQXJyYXlJdGVyYXRvciwgX0JvdW5kZWRJdGVyYXRvcjIpOwoKICAgIGZ1bmN0aW9uIEVtYmVyQXJyYXlJdGVyYXRvcihhcnJheSwgbGVuZ3RoLCBrZXlGb3IpIHsKICAgICAgdmFyIF90aGlzMTM7CgogICAgICBfdGhpczEzID0gX0JvdW5kZWRJdGVyYXRvcjIuY2FsbCh0aGlzLCBsZW5ndGgsIGtleUZvcikgfHwgdGhpczsKICAgICAgX3RoaXMxMy5hcnJheSA9IGFycmF5OwogICAgICByZXR1cm4gX3RoaXMxMzsKICAgIH0KCiAgICBFbWJlckFycmF5SXRlcmF0b3IuZnJvbSA9IGZ1bmN0aW9uIGZyb20oYXJyYXksIGtleUZvcikgewogICAgICB2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoKICAgICAgaWYgKGxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiBFTVBUWV9JVEVSQVRPUjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IHRoaXMoYXJyYXksIGxlbmd0aCwga2V5Rm9yKTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgX3Byb3RvMjAgPSBFbWJlckFycmF5SXRlcmF0b3IucHJvdG90eXBlOwoKICAgIF9wcm90bzIwLnZhbHVlRm9yID0gZnVuY3Rpb24gdmFsdWVGb3IocG9zaXRpb24pIHsKICAgICAgcmV0dXJuICgwLCBfbWV0YWwub2JqZWN0QXQpKHRoaXMuYXJyYXksIHBvc2l0aW9uKTsKICAgIH07CgogICAgcmV0dXJuIEVtYmVyQXJyYXlJdGVyYXRvcjsKICB9KEJvdW5kZWRJdGVyYXRvcik7CgogIHZhciBPYmplY3RJdGVyYXRvciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfQm91bmRlZEl0ZXJhdG9yMykgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKE9iamVjdEl0ZXJhdG9yLCBfQm91bmRlZEl0ZXJhdG9yMyk7CgogICAgZnVuY3Rpb24gT2JqZWN0SXRlcmF0b3Ioa2V5cywgdmFsdWVzLCBsZW5ndGgsIGtleUZvcikgewogICAgICB2YXIgX3RoaXMxNDsKCiAgICAgIF90aGlzMTQgPSBfQm91bmRlZEl0ZXJhdG9yMy5jYWxsKHRoaXMsIGxlbmd0aCwga2V5Rm9yKSB8fCB0aGlzOwogICAgICBfdGhpczE0LmtleXMgPSBrZXlzOwogICAgICBfdGhpczE0LnZhbHVlcyA9IHZhbHVlczsKICAgICAgcmV0dXJuIF90aGlzMTQ7CiAgICB9CgogICAgT2JqZWN0SXRlcmF0b3IuZnJvbUluZGV4YWJsZSA9IGZ1bmN0aW9uIGZyb21JbmRleGFibGUob2JqLCBrZXlGb3IpIHsKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmopOwogICAgICB2YXIgbGVuZ3RoID0ga2V5cy5sZW5ndGg7CgogICAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIEVNUFRZX0lURVJBVE9SOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciB2YWx1ZXMgPSBbXTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIHZhbHVlJCQxID0gdm9pZCAwOwogICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgICB2YWx1ZSQkMSA9IG9ialtrZXldOyAvLyBBZGQgdGhlIHRhZyBvZiB0aGUgcmV0dXJuZWQgdmFsdWUgaWYgaXQgaXMgYW4gYXJyYXksIHNpbmNlIGFycmF5cwogICAgICAgICAgLy8gc2hvdWxkIGFsd2F5cyBjYXVzZSB1cGRhdGVzIGlmIHRoZXkgYXJlIGNvbnN1bWVkIGFuZCB0aGVuIGNoYW5nZWQKCiAgICAgICAgICBpZiAodHJ1ZQogICAgICAgICAgLyogRU1CRVJfTUVUQUxfVFJBQ0tFRF9QUk9QRVJUSUVTICovCiAgICAgICAgICAmJiAoMCwgX21ldGFsLmlzVHJhY2tpbmcpKCkpIHsKICAgICAgICAgICAgKDAsIF9tZXRhbC5jb25zdW1lKSgoMCwgX21ldGFsLnRhZ0ZvclByb3BlcnR5KShvYmosIGtleSkpOwoKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUkJDEpIHx8ICgwLCBfdXRpbHMuaXNFbWJlckFycmF5KSh2YWx1ZSQkMSkpIHsKICAgICAgICAgICAgICAoMCwgX21ldGFsLmNvbnN1bWUpKCgwLCBfbWV0YWwudGFnRm9yUHJvcGVydHkpKHZhbHVlJCQxLCAnW10nKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICB2YWx1ZXMucHVzaCh2YWx1ZSQkMSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbmV3IHRoaXMoa2V5cywgdmFsdWVzLCBsZW5ndGgsIGtleUZvcik7CiAgICAgIH0KICAgIH07CgogICAgT2JqZWN0SXRlcmF0b3IuZnJvbUZvckVhY2hhYmxlID0gZnVuY3Rpb24gZnJvbUZvckVhY2hhYmxlKG9iaiwga2V5Rm9yKSB7CiAgICAgIHZhciBfYXJndW1lbnRzID0gYXJndW1lbnRzOwogICAgICB2YXIga2V5cyA9IFtdOwogICAgICB2YXIgdmFsdWVzID0gW107CiAgICAgIHZhciBsZW5ndGggPSAwOwogICAgICB2YXIgaXNNYXBMaWtlID0gZmFsc2U7CiAgICAgIG9iai5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSQkMSwga2V5KSB7CiAgICAgICAgaXNNYXBMaWtlID0gaXNNYXBMaWtlIHx8IF9hcmd1bWVudHMubGVuZ3RoID49IDI7CgogICAgICAgIGlmIChpc01hcExpa2UpIHsKICAgICAgICAgIGtleXMucHVzaChrZXkpOwogICAgICAgIH0KCiAgICAgICAgdmFsdWVzLnB1c2godmFsdWUkJDEpOwogICAgICAgIGxlbmd0aCsrOwogICAgICB9KTsKCiAgICAgIGlmIChsZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gRU1QVFlfSVRFUkFUT1I7CiAgICAgIH0gZWxzZSBpZiAoaXNNYXBMaWtlKSB7CiAgICAgICAgcmV0dXJuIG5ldyB0aGlzKGtleXMsIHZhbHVlcywgbGVuZ3RoLCBrZXlGb3IpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuZXcgQXJyYXlJdGVyYXRvcih2YWx1ZXMsIGxlbmd0aCwga2V5Rm9yKTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgX3Byb3RvMjEgPSBPYmplY3RJdGVyYXRvci5wcm90b3R5cGU7CgogICAgX3Byb3RvMjEudmFsdWVGb3IgPSBmdW5jdGlvbiB2YWx1ZUZvcihwb3NpdGlvbikgewogICAgICByZXR1cm4gdGhpcy52YWx1ZXNbcG9zaXRpb25dOwogICAgfTsKCiAgICBfcHJvdG8yMS5tZW1vRm9yID0gZnVuY3Rpb24gbWVtb0Zvcihwb3NpdGlvbikgewogICAgICByZXR1cm4gdGhpcy5rZXlzW3Bvc2l0aW9uXTsKICAgIH07CgogICAgcmV0dXJuIE9iamVjdEl0ZXJhdG9yOwogIH0oQm91bmRlZEl0ZXJhdG9yKTsKCiAgdmFyIE5hdGl2ZUl0ZXJhdG9yID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gTmF0aXZlSXRlcmF0b3IoaXRlcmFibGUsIHJlc3VsdCwga2V5Rm9yKSB7CiAgICAgIHRoaXMuaXRlcmFibGUgPSBpdGVyYWJsZTsKICAgICAgdGhpcy5yZXN1bHQgPSByZXN1bHQ7CiAgICAgIHRoaXMua2V5Rm9yID0ga2V5Rm9yOwogICAgICB0aGlzLnBvc2l0aW9uID0gMDsKICAgIH0KCiAgICBOYXRpdmVJdGVyYXRvci5mcm9tID0gZnVuY3Rpb24gZnJvbShpdGVyYWJsZSwga2V5Rm9yKSB7CiAgICAgIHZhciBpdGVyYXRvciA9IGl0ZXJhYmxlW1N5bWJvbC5pdGVyYXRvcl0oKTsKICAgICAgdmFyIHJlc3VsdCA9IGl0ZXJhdG9yLm5leHQoKTsKICAgICAgdmFyIHZhbHVlJCQxID0gcmVzdWx0LnZhbHVlLAogICAgICAgICAgZG9uZSA9IHJlc3VsdC5kb25lOwoKICAgICAgaWYgKGRvbmUpIHsKICAgICAgICByZXR1cm4gRU1QVFlfSVRFUkFUT1I7CiAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSQkMSkgJiYgdmFsdWUkJDEubGVuZ3RoID09PSAyKSB7CiAgICAgICAgcmV0dXJuIG5ldyB0aGlzKGl0ZXJhdG9yLCByZXN1bHQsIGtleUZvcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG5ldyBBcnJheUxpa2VOYXRpdmVJdGVyYXRvcihpdGVyYXRvciwgcmVzdWx0LCBrZXlGb3IpOwogICAgICB9CiAgICB9OwoKICAgIHZhciBfcHJvdG8yMiA9IE5hdGl2ZUl0ZXJhdG9yLnByb3RvdHlwZTsKCiAgICBfcHJvdG8yMi5pc0VtcHR5ID0gZnVuY3Rpb24gaXNFbXB0eSgpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICBfcHJvdG8yMi5uZXh0ID0gZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgdmFyIGl0ZXJhYmxlID0gdGhpcy5pdGVyYWJsZSwKICAgICAgICAgIHJlc3VsdCA9IHRoaXMucmVzdWx0LAogICAgICAgICAgcG9zaXRpb24gPSB0aGlzLnBvc2l0aW9uLAogICAgICAgICAga2V5Rm9yID0gdGhpcy5rZXlGb3I7CgogICAgICBpZiAocmVzdWx0LmRvbmUpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgdmFyIHZhbHVlJCQxID0gdGhpcy52YWx1ZUZvcihyZXN1bHQsIHBvc2l0aW9uKTsKICAgICAgdmFyIG1lbW8gPSB0aGlzLm1lbW9Gb3IocmVzdWx0LCBwb3NpdGlvbik7CiAgICAgIHZhciBrZXkgPSBrZXlGb3IodmFsdWUkJDEsIG1lbW8sIHBvc2l0aW9uKTsKICAgICAgdGhpcy5wb3NpdGlvbisrOwogICAgICB0aGlzLnJlc3VsdCA9IGl0ZXJhYmxlLm5leHQoKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBrZXk6IGtleSwKICAgICAgICB2YWx1ZTogdmFsdWUkJDEsCiAgICAgICAgbWVtbzogbWVtbwogICAgICB9OwogICAgfTsKCiAgICByZXR1cm4gTmF0aXZlSXRlcmF0b3I7CiAgfSgpOwoKICB2YXIgQXJyYXlMaWtlTmF0aXZlSXRlcmF0b3IgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX05hdGl2ZUl0ZXJhdG9yKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoQXJyYXlMaWtlTmF0aXZlSXRlcmF0b3IsIF9OYXRpdmVJdGVyYXRvcik7CgogICAgZnVuY3Rpb24gQXJyYXlMaWtlTmF0aXZlSXRlcmF0b3IoKSB7CiAgICAgIHJldHVybiBfTmF0aXZlSXRlcmF0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG8yMyA9IEFycmF5TGlrZU5hdGl2ZUl0ZXJhdG9yLnByb3RvdHlwZTsKCiAgICBfcHJvdG8yMy52YWx1ZUZvciA9IGZ1bmN0aW9uIHZhbHVlRm9yKHJlc3VsdCkgewogICAgICByZXR1cm4gcmVzdWx0LnZhbHVlOwogICAgfTsKCiAgICBfcHJvdG8yMy5tZW1vRm9yID0gZnVuY3Rpb24gbWVtb0ZvcihfcmVzdWx0LCBwb3NpdGlvbikgewogICAgICByZXR1cm4gcG9zaXRpb247CiAgICB9OwoKICAgIHJldHVybiBBcnJheUxpa2VOYXRpdmVJdGVyYXRvcjsKICB9KE5hdGl2ZUl0ZXJhdG9yKTsKCiAgdmFyIE1hcExpa2VOYXRpdmVJdGVyYXRvciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfTmF0aXZlSXRlcmF0b3IyKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoTWFwTGlrZU5hdGl2ZUl0ZXJhdG9yLCBfTmF0aXZlSXRlcmF0b3IyKTsKCiAgICBmdW5jdGlvbiBNYXBMaWtlTmF0aXZlSXRlcmF0b3IoKSB7CiAgICAgIHJldHVybiBfTmF0aXZlSXRlcmF0b3IyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgIH0KCiAgICB2YXIgX3Byb3RvMjQgPSBNYXBMaWtlTmF0aXZlSXRlcmF0b3IucHJvdG90eXBlOwoKICAgIF9wcm90bzI0LnZhbHVlRm9yID0gZnVuY3Rpb24gdmFsdWVGb3IocmVzdWx0KSB7CiAgICAgIHJldHVybiByZXN1bHQudmFsdWVbMV07CiAgICB9OwoKICAgIF9wcm90bzI0Lm1lbW9Gb3IgPSBmdW5jdGlvbiBtZW1vRm9yKHJlc3VsdCkgewogICAgICByZXR1cm4gcmVzdWx0LnZhbHVlWzBdOwogICAgfTsKCiAgICByZXR1cm4gTWFwTGlrZU5hdGl2ZUl0ZXJhdG9yOwogIH0oTmF0aXZlSXRlcmF0b3IpOwoKICB2YXIgRU1QVFlfSVRFUkFUT1IgPSB7CiAgICBpc0VtcHR5OiBmdW5jdGlvbiBpc0VtcHR5KCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCiAgICBuZXh0OiBmdW5jdGlvbiBuZXh0KCkgewogICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDYW5ub3QgY2FsbCBuZXh0KCkgb24gYW4gZW1wdHkgaXRlcmF0b3InKSk7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogIH07CgogIHZhciBFYWNoSW5JdGVyYWJsZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEVhY2hJbkl0ZXJhYmxlKHJlZiwga2V5UGF0aCkgewogICAgICB0aGlzLnJlZiA9IHJlZjsKICAgICAgdGhpcy5rZXlQYXRoID0ga2V5UGF0aDsKICAgICAgdGhpcy52YWx1ZVRhZyA9ICgwLCBfcmVmZXJlbmNlLmNyZWF0ZVVwZGF0YWJsZVRhZykoKTsKICAgICAgdGhpcy50YWcgPSAoMCwgX3JlZmVyZW5jZS5jb21iaW5lKShbcmVmLnRhZywgdGhpcy52YWx1ZVRhZ10pOwogICAgfQoKICAgIHZhciBfcHJvdG8yNSA9IEVhY2hJbkl0ZXJhYmxlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8yNS5pdGVyYXRlID0gZnVuY3Rpb24gaXRlcmF0ZSgpIHsKICAgICAgdmFyIHJlZiA9IHRoaXMucmVmLAogICAgICAgICAgdmFsdWVUYWcgPSB0aGlzLnZhbHVlVGFnOwogICAgICB2YXIgaXRlcmFibGUgPSByZWYudmFsdWUoKTsKICAgICAgdmFyIHRhZyA9ICgwLCBfbWV0YWwudGFnRm9yKShpdGVyYWJsZSk7CgogICAgICBpZiAoKDAsIF91dGlscy5pc1Byb3h5KShpdGVyYWJsZSkpIHsKICAgICAgICAvLyB0aGlzIGlzIGJlY2F1c2UgdGhlIGVhY2gtaW4gZG9lc24ndCBhY3R1YWxseSBnZXQocHJveHksICdrZXknKSBidXQgYnlwYXNzZXMgaXQKICAgICAgICAvLyBhbmQgdGhlIHByb3h5J3MgdGFnIGlzIGxhenkgdXBkYXRlZCBvbiBhY2Nlc3MKICAgICAgICBpdGVyYWJsZSA9ICgwLCBfcnVudGltZS5fY29udGVudEZvcikoaXRlcmFibGUpOwogICAgICB9CgogICAgICAoMCwgX3JlZmVyZW5jZS51cGRhdGUpKHZhbHVlVGFnLCB0YWcpOwoKICAgICAgaWYgKCFpc0luZGV4YWJsZShpdGVyYWJsZSkpIHsKICAgICAgICByZXR1cm4gRU1QVFlfSVRFUkFUT1I7CiAgICAgIH0KCiAgICAgIGlmIChBcnJheS5pc0FycmF5KGl0ZXJhYmxlKSB8fCAoMCwgX3V0aWxzLmlzRW1iZXJBcnJheSkoaXRlcmFibGUpKSB7CiAgICAgICAgcmV0dXJuIE9iamVjdEl0ZXJhdG9yLmZyb21JbmRleGFibGUoaXRlcmFibGUsIHRoaXMua2V5Rm9yKHRydWUpKTsKICAgICAgfSBlbHNlIGlmIChfdXRpbHMuSEFTX05BVElWRV9TWU1CT0wgJiYgaXNOYXRpdmVJdGVyYWJsZShpdGVyYWJsZSkpIHsKICAgICAgICByZXR1cm4gTWFwTGlrZU5hdGl2ZUl0ZXJhdG9yLmZyb20oaXRlcmFibGUsIHRoaXMua2V5Rm9yKCkpOwogICAgICB9IGVsc2UgaWYgKGhhc0ZvckVhY2goaXRlcmFibGUpKSB7CiAgICAgICAgcmV0dXJuIE9iamVjdEl0ZXJhdG9yLmZyb21Gb3JFYWNoYWJsZShpdGVyYWJsZSwgdGhpcy5rZXlGb3IoKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIE9iamVjdEl0ZXJhdG9yLmZyb21JbmRleGFibGUoaXRlcmFibGUsIHRoaXMua2V5Rm9yKHRydWUpKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8yNS52YWx1ZVJlZmVyZW5jZUZvciA9IGZ1bmN0aW9uIHZhbHVlUmVmZXJlbmNlRm9yKGl0ZW0pIHsKICAgICAgcmV0dXJuIG5ldyBVcGRhdGFibGVSZWZlcmVuY2UoaXRlbS52YWx1ZSk7CiAgICB9OwoKICAgIF9wcm90bzI1LnVwZGF0ZVZhbHVlUmVmZXJlbmNlID0gZnVuY3Rpb24gdXBkYXRlVmFsdWVSZWZlcmVuY2UocmVmLCBpdGVtKSB7CiAgICAgIHJlZi51cGRhdGUoaXRlbS52YWx1ZSk7CiAgICB9OwoKICAgIF9wcm90bzI1Lm1lbW9SZWZlcmVuY2VGb3IgPSBmdW5jdGlvbiBtZW1vUmVmZXJlbmNlRm9yKGl0ZW0pIHsKICAgICAgcmV0dXJuIG5ldyBVcGRhdGFibGVSZWZlcmVuY2UoaXRlbS5tZW1vKTsKICAgIH07CgogICAgX3Byb3RvMjUudXBkYXRlTWVtb1JlZmVyZW5jZSA9IGZ1bmN0aW9uIHVwZGF0ZU1lbW9SZWZlcmVuY2UocmVmLCBpdGVtKSB7CiAgICAgIHJlZi51cGRhdGUoaXRlbS5tZW1vKTsKICAgIH07CgogICAgX3Byb3RvMjUua2V5Rm9yID0gZnVuY3Rpb24ga2V5Rm9yKGhhc1VuaXF1ZUtleXMpIHsKICAgICAgaWYgKGhhc1VuaXF1ZUtleXMgPT09IHZvaWQgMCkgewogICAgICAgIGhhc1VuaXF1ZUtleXMgPSBmYWxzZTsKICAgICAgfQoKICAgICAgdmFyIGtleVBhdGggPSB0aGlzLmtleVBhdGg7CgogICAgICBzd2l0Y2ggKGtleVBhdGgpIHsKICAgICAgICBjYXNlICdAa2V5JzoKICAgICAgICAgIHJldHVybiBoYXNVbmlxdWVLZXlzID8gT2JqZWN0S2V5IDogVW5pcXVlKE1hcEtleSk7CgogICAgICAgIGNhc2UgJ0BpbmRleCc6CiAgICAgICAgICByZXR1cm4gSW5kZXg7CgogICAgICAgIGNhc2UgJ0BpZGVudGl0eSc6CiAgICAgICAgICByZXR1cm4gVW5pcXVlKElkZW50aXR5KTsKCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIChmYWxzZSAmJiAhKGtleVBhdGhbMF0gIT09ICdAJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJJbnZhbGlkIGtleTogIiArIGtleVBhdGgsIGtleVBhdGhbMF0gIT09ICdAJykpOwogICAgICAgICAgcmV0dXJuIFVuaXF1ZShLZXlQYXRoKGtleVBhdGgpKTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gRWFjaEluSXRlcmFibGU7CiAgfSgpOwoKICB2YXIgRWFjaEl0ZXJhYmxlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRWFjaEl0ZXJhYmxlKHJlZiwga2V5UGF0aCkgewogICAgICB0aGlzLnJlZiA9IHJlZjsKICAgICAgdGhpcy5rZXlQYXRoID0ga2V5UGF0aDsKICAgICAgdGhpcy52YWx1ZVRhZyA9ICgwLCBfcmVmZXJlbmNlLmNyZWF0ZVVwZGF0YWJsZVRhZykoKTsKICAgICAgdGhpcy50YWcgPSAoMCwgX3JlZmVyZW5jZS5jb21iaW5lKShbcmVmLnRhZywgdGhpcy52YWx1ZVRhZ10pOwogICAgfQoKICAgIHZhciBfcHJvdG8yNiA9IEVhY2hJdGVyYWJsZS5wcm90b3R5cGU7CgogICAgX3Byb3RvMjYuaXRlcmF0ZSA9IGZ1bmN0aW9uIGl0ZXJhdGUoKSB7CiAgICAgIHZhciByZWYgPSB0aGlzLnJlZiwKICAgICAgICAgIHZhbHVlVGFnID0gdGhpcy52YWx1ZVRhZzsKICAgICAgdmFyIGl0ZXJhYmxlID0gcmVmLnZhbHVlKCk7CiAgICAgICgwLCBfcmVmZXJlbmNlLnVwZGF0ZSkodmFsdWVUYWcsICgwLCBfbWV0YWwudGFnRm9yUHJvcGVydHkpKGl0ZXJhYmxlLCAnW10nKSk7CgogICAgICBpZiAoaXRlcmFibGUgPT09IG51bGwgfHwgdHlwZW9mIGl0ZXJhYmxlICE9PSAnb2JqZWN0JykgewogICAgICAgIHJldHVybiBFTVBUWV9JVEVSQVRPUjsKICAgICAgfQoKICAgICAgdmFyIGtleUZvciA9IHRoaXMua2V5Rm9yKCk7CgogICAgICBpZiAoQXJyYXkuaXNBcnJheShpdGVyYWJsZSkpIHsKICAgICAgICByZXR1cm4gQXJyYXlJdGVyYXRvci5mcm9tKGl0ZXJhYmxlLCBrZXlGb3IpOwogICAgICB9IGVsc2UgaWYgKCgwLCBfdXRpbHMuaXNFbWJlckFycmF5KShpdGVyYWJsZSkpIHsKICAgICAgICByZXR1cm4gRW1iZXJBcnJheUl0ZXJhdG9yLmZyb20oaXRlcmFibGUsIGtleUZvcik7CiAgICAgIH0gZWxzZSBpZiAoX3V0aWxzLkhBU19OQVRJVkVfU1lNQk9MICYmIGlzTmF0aXZlSXRlcmFibGUoaXRlcmFibGUpKSB7CiAgICAgICAgcmV0dXJuIEFycmF5TGlrZU5hdGl2ZUl0ZXJhdG9yLmZyb20oaXRlcmFibGUsIGtleUZvcik7CiAgICAgIH0gZWxzZSBpZiAoaGFzRm9yRWFjaChpdGVyYWJsZSkpIHsKICAgICAgICByZXR1cm4gQXJyYXlJdGVyYXRvci5mcm9tRm9yRWFjaGFibGUoaXRlcmFibGUsIGtleUZvcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIEVNUFRZX0lURVJBVE9SOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzI2LnZhbHVlUmVmZXJlbmNlRm9yID0gZnVuY3Rpb24gdmFsdWVSZWZlcmVuY2VGb3IoaXRlbSkgewogICAgICByZXR1cm4gbmV3IFVwZGF0YWJsZVJlZmVyZW5jZShpdGVtLnZhbHVlKTsKICAgIH07CgogICAgX3Byb3RvMjYudXBkYXRlVmFsdWVSZWZlcmVuY2UgPSBmdW5jdGlvbiB1cGRhdGVWYWx1ZVJlZmVyZW5jZShyZWYsIGl0ZW0pIHsKICAgICAgcmVmLnVwZGF0ZShpdGVtLnZhbHVlKTsKICAgIH07CgogICAgX3Byb3RvMjYubWVtb1JlZmVyZW5jZUZvciA9IGZ1bmN0aW9uIG1lbW9SZWZlcmVuY2VGb3IoaXRlbSkgewogICAgICByZXR1cm4gbmV3IFVwZGF0YWJsZVJlZmVyZW5jZShpdGVtLm1lbW8pOwogICAgfTsKCiAgICBfcHJvdG8yNi51cGRhdGVNZW1vUmVmZXJlbmNlID0gZnVuY3Rpb24gdXBkYXRlTWVtb1JlZmVyZW5jZShyZWYsIGl0ZW0pIHsKICAgICAgcmVmLnVwZGF0ZShpdGVtLm1lbW8pOwogICAgfTsKCiAgICBfcHJvdG8yNi5rZXlGb3IgPSBmdW5jdGlvbiBrZXlGb3IoKSB7CiAgICAgIHZhciBrZXlQYXRoID0gdGhpcy5rZXlQYXRoOwoKICAgICAgc3dpdGNoIChrZXlQYXRoKSB7CiAgICAgICAgY2FzZSAnQGluZGV4JzoKICAgICAgICAgIHJldHVybiBJbmRleDsKCiAgICAgICAgY2FzZSAnQGlkZW50aXR5JzoKICAgICAgICAgIHJldHVybiBVbmlxdWUoSWRlbnRpdHkpOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgKGZhbHNlICYmICEoa2V5UGF0aFswXSAhPT0gJ0AnKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkludmFsaWQga2V5OiAiICsga2V5UGF0aCwga2V5UGF0aFswXSAhPT0gJ0AnKSk7CiAgICAgICAgICByZXR1cm4gVW5pcXVlKEtleVBhdGgoa2V5UGF0aCkpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBFYWNoSXRlcmFibGU7CiAgfSgpOwoKICBmdW5jdGlvbiBoYXNGb3JFYWNoKHZhbHVlJCQxKSB7CiAgICByZXR1cm4gdHlwZW9mIHZhbHVlJCQxWydmb3JFYWNoJ10gPT09ICdmdW5jdGlvbic7CiAgfQoKICBmdW5jdGlvbiBpc05hdGl2ZUl0ZXJhYmxlKHZhbHVlJCQxKSB7CiAgICByZXR1cm4gdHlwZW9mIHZhbHVlJCQxW1N5bWJvbC5pdGVyYXRvcl0gPT09ICdmdW5jdGlvbic7CiAgfQoKICBmdW5jdGlvbiBpc0luZGV4YWJsZSh2YWx1ZSQkMSkgewogICAgcmV0dXJuIHZhbHVlJCQxICE9PSBudWxsICYmICh0eXBlb2YgdmFsdWUkJDEgPT09ICdvYmplY3QnIHx8IHR5cGVvZiB2YWx1ZSQkMSA9PT0gJ2Z1bmN0aW9uJyk7CiAgfSAvLyBQb3NpdGlvbiBpbiBhbiBhcnJheSBpcyBndWFyZW50ZWVkIHRvIGJlIHVuaXF1ZQoKCiAgZnVuY3Rpb24gSW5kZXgoX3ZhbHVlLCBfbWVtbywgcG9zaXRpb24pIHsKICAgIHJldHVybiBTdHJpbmcocG9zaXRpb24pOwogIH0gLy8gT2JqZWN0LmtleXMoLi4uKSBpcyBndWFyZW50ZWVkIHRvIGJlIHN0cmluZ3MgYW5kIHVuaXF1ZQoKCiAgZnVuY3Rpb24gT2JqZWN0S2V5KF92YWx1ZSwgbWVtbykgewogICAgcmV0dXJuIG1lbW87CiAgfSAvLyBNYXAga2V5cyBjYW4gYmUgYW55IG9iamVjdHMKCgogIGZ1bmN0aW9uIE1hcEtleShfdmFsdWUsIG1lbW8pIHsKICAgIHJldHVybiBJZGVudGl0eShtZW1vKTsKICB9CgogIGZ1bmN0aW9uIElkZW50aXR5KHZhbHVlJCQxKSB7CiAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSQkMSkgewogICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgIHJldHVybiB2YWx1ZSQkMTsKCiAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSQkMSk7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiAoMCwgX3V0aWxzLmd1aWRGb3IpKHZhbHVlJCQxKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIEtleVBhdGgoa2V5UGF0aCkgewogICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSQkMSkgewogICAgICByZXR1cm4gU3RyaW5nKCgwLCBfbWV0YWwuZ2V0KSh2YWx1ZSQkMSwga2V5UGF0aCkpOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIFVuaXF1ZShmdW5jKSB7CiAgICB2YXIgc2VlbiA9IHt9OwogICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSQkMSwgbWVtbywgcG9zaXRpb24pIHsKICAgICAgdmFyIGtleSA9IGZ1bmModmFsdWUkJDEsIG1lbW8sIHBvc2l0aW9uKTsKICAgICAgdmFyIGNvdW50ID0gc2VlbltrZXldOwoKICAgICAgaWYgKGNvdW50ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBzZWVuW2tleV0gPSAwOwogICAgICAgIHJldHVybiBrZXk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VlbltrZXldID0gKytjb3VudDsKICAgICAgICByZXR1cm4gIiIgKyBrZXkgKyBJVEVSQVRPUl9LRVlfR1VJRCArIGNvdW50OwogICAgICB9CiAgICB9OwogIH0KICAvKioKICBAbW9kdWxlIEBlbWJlci90ZW1wbGF0ZQogICovCgoKICB2YXIgU2FmZVN0cmluZyA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFNhZmVTdHJpbmcoc3RyaW5nKSB7CiAgICAgIHRoaXMuc3RyaW5nID0gc3RyaW5nOwogICAgfQoKICAgIHZhciBfcHJvdG8yNyA9IFNhZmVTdHJpbmcucHJvdG90eXBlOwoKICAgIF9wcm90bzI3LnRvU3RyaW5nID0gZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgIHJldHVybiAiIiArIHRoaXMuc3RyaW5nOwogICAgfTsKCiAgICBfcHJvdG8yNy50b0hUTUwgPSBmdW5jdGlvbiB0b0hUTUwoKSB7CiAgICAgIHJldHVybiB0aGlzLnRvU3RyaW5nKCk7CiAgICB9OwoKICAgIHJldHVybiBTYWZlU3RyaW5nOwogIH0oKTsKCiAgX2V4cG9ydHMuU2FmZVN0cmluZyA9IFNhZmVTdHJpbmc7CiAgdmFyIGVzY2FwZSA9IHsKICAgICcmJzogJyZhbXA7JywKICAgICc8JzogJyZsdDsnLAogICAgJz4nOiAnJmd0OycsCiAgICAnIic6ICcmcXVvdDsnLAogICAgIiciOiAnJiN4Mjc7JywKICAgICdgJzogJyYjeDYwOycsCiAgICAnPSc6ICcmI3gzRDsnCiAgfTsKICB2YXIgcG9zc2libGUgPSAvWyY8PiInYD1dLzsKICB2YXIgYmFkQ2hhcnMgPSAvWyY8PiInYD1dL2c7CgogIGZ1bmN0aW9uIGVzY2FwZUNoYXIoY2hyKSB7CiAgICByZXR1cm4gZXNjYXBlW2Nocl07CiAgfQoKICBmdW5jdGlvbiBlc2NhcGVFeHByZXNzaW9uKHN0cmluZykgewogICAgaWYgKHR5cGVvZiBzdHJpbmcgIT09ICdzdHJpbmcnKSB7CiAgICAgIC8vIGRvbid0IGVzY2FwZSBTYWZlU3RyaW5ncywgc2luY2UgdGhleSdyZSBhbHJlYWR5IHNhZmUKICAgICAgaWYgKHN0cmluZyAmJiBzdHJpbmcudG9IVE1MKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZy50b0hUTUwoKTsKICAgICAgfSBlbHNlIGlmIChzdHJpbmcgPT09IG51bGwgfHwgc3RyaW5nID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gJyc7CiAgICAgIH0gZWxzZSBpZiAoIXN0cmluZykgewogICAgICAgIHJldHVybiBTdHJpbmcoc3RyaW5nKTsKICAgICAgfSAvLyBGb3JjZSBhIHN0cmluZyBjb252ZXJzaW9uIGFzIHRoaXMgd2lsbCBiZSBkb25lIGJ5IHRoZSBhcHBlbmQgcmVnYXJkbGVzcyBhbmQKICAgICAgLy8gdGhlIHJlZ2V4IHRlc3Qgd2lsbCBkbyB0aGlzIHRyYW5zcGFyZW50bHkgYmVoaW5kIHRoZSBzY2VuZXMsIGNhdXNpbmcgaXNzdWVzIGlmCiAgICAgIC8vIGFuIG9iamVjdCdzIHRvIHN0cmluZyBoYXMgZXNjYXBlZCBjaGFyYWN0ZXJzIGluIGl0LgoKCiAgICAgIHN0cmluZyA9IFN0cmluZyhzdHJpbmcpOwogICAgfQoKICAgIGlmICghcG9zc2libGUudGVzdChzdHJpbmcpKSB7CiAgICAgIHJldHVybiBzdHJpbmc7CiAgICB9CgogICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKGJhZENoYXJzLCBlc2NhcGVDaGFyKTsKICB9CiAgLyoqCiAgICBNYXJrIGEgc3RyaW5nIGFzIHNhZmUgZm9yIHVuZXNjYXBlZCBvdXRwdXQgd2l0aCBFbWJlciB0ZW1wbGF0ZXMuIElmIHlvdQogICAgcmV0dXJuIEhUTUwgZnJvbSBhIGhlbHBlciwgdXNlIHRoaXMgZnVuY3Rpb24gdG8KICAgIGVuc3VyZSBFbWJlcidzIHJlbmRlcmluZyBsYXllciBkb2VzIG5vdCBlc2NhcGUgdGhlIEhUTUwuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBodG1sU2FmZSB9IGZyb20gJ0BlbWJlci90ZW1wbGF0ZSc7CiAgCiAgICBodG1sU2FmZSgnPGRpdj5zb21lU3RyaW5nPC9kaXY+JykKICAgIGBgYAogIAogICAgQG1ldGhvZCBodG1sU2FmZQogICAgQGZvciBAZW1iZXIvdGVtcGxhdGUKICAgIEBzdGF0aWMKICAgIEByZXR1cm4ge1NhZmVTdHJpbmd9IEEgc3RyaW5nIHRoYXQgd2lsbCBub3QgYmUgSFRNTCBlc2NhcGVkIGJ5IEhhbmRsZWJhcnMuCiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIGh0bWxTYWZlKHN0cikgewogICAgaWYgKHN0ciA9PT0gbnVsbCB8fCBzdHIgPT09IHVuZGVmaW5lZCkgewogICAgICBzdHIgPSAnJzsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0ciAhPT0gJ3N0cmluZycpIHsKICAgICAgc3RyID0gU3RyaW5nKHN0cik7CiAgICB9CgogICAgcmV0dXJuIG5ldyBTYWZlU3RyaW5nKHN0cik7CiAgfQogIC8qKgogICAgRGV0ZWN0cyBpZiBhIHN0cmluZyB3YXMgZGVjb3JhdGVkIHVzaW5nIGBodG1sU2FmZWAuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBodG1sU2FmZSwgaXNIVE1MU2FmZSB9IGZyb20gJ0BlbWJlci90ZW1wbGF0ZSc7CiAgCiAgICB2YXIgcGxhaW5TdHJpbmcgPSAncGxhaW4gc3RyaW5nJywKICAgICAgICBzYWZlU3RyaW5nID0gaHRtbFNhZmUoJzxkaXY+c29tZVZhbHVlPC9kaXY+Jyk7CiAgCiAgICBpc0hUTUxTYWZlKHBsYWluU3RyaW5nKTsgLy8gZmFsc2UKICAgIGlzSFRNTFNhZmUoc2FmZVN0cmluZyk7ICAvLyB0cnVlCiAgICBgYGAKICAKICAgIEBtZXRob2QgaXNIVE1MU2FmZQogICAgQGZvciBAZW1iZXIvdGVtcGxhdGUKICAgIEBzdGF0aWMKICAgIEByZXR1cm4ge0Jvb2xlYW59IGB0cnVlYCBpZiB0aGUgc3RyaW5nIHdhcyBkZWNvcmF0ZWQgd2l0aCBgaHRtbFNhZmVgLCBgZmFsc2VgIG90aGVyd2lzZS4KICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gaXNIVE1MU2FmZShzdHIpIHsKICAgIHJldHVybiBzdHIgIT09IG51bGwgJiYgdHlwZW9mIHN0ciA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIHN0ci50b0hUTUwgPT09ICdmdW5jdGlvbic7CiAgfQogIC8qIGdsb2JhbHMgbW9kdWxlLCBVUkwgKi8KCgogIHZhciBub2RlVVJMOwogIHZhciBwYXJzaW5nTm9kZTsKCiAgZnVuY3Rpb24gaW5zdGFsbFByb3RvY29sRm9yVVJMKGVudmlyb25tZW50KSB7CiAgICB2YXIgcHJvdG9jb2w7CgogICAgaWYgKF9icm93c2VyRW52aXJvbm1lbnQuaGFzRE9NKSB7CiAgICAgIHByb3RvY29sID0gYnJvd3NlclByb3RvY29sRm9yVVJMLmNhbGwoZW52aXJvbm1lbnQsICdmb29iYXI6YmF6Jyk7CiAgICB9IC8vIFRlc3QgdG8gc2VlIGlmIG91ciBET00gaW1wbGVtZW50YXRpb24gcGFyc2VzCiAgICAvLyBhbmQgbm9ybWFsaXplcyBVUkxzLgoKCiAgICBpZiAocHJvdG9jb2wgPT09ICdmb29iYXI6JykgewogICAgICAvLyBTd2FwIGluIHRoZSBtZXRob2QgdGhhdCBkb2Vzbid0IGRvIHRoaXMgdGVzdCBub3cgdGhhdAogICAgICAvLyB3ZSBrbm93IGl0IHdvcmtzLgogICAgICBlbnZpcm9ubWVudC5wcm90b2NvbEZvclVSTCA9IGJyb3dzZXJQcm90b2NvbEZvclVSTDsKICAgIH0gZWxzZSBpZiAodHlwZW9mIFVSTCA9PT0gJ29iamVjdCcpIHsKICAgICAgLy8gVVJMIGdsb2JhbGx5IHByb3ZpZGVkLCBsaWtlbHkgZnJvbSBGYXN0Qm9vdCdzIHNhbmRib3gKICAgICAgbm9kZVVSTCA9IFVSTDsKICAgICAgZW52aXJvbm1lbnQucHJvdG9jb2xGb3JVUkwgPSBub2RlUHJvdG9jb2xGb3JVUkw7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBtb2R1bGUgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgbW9kdWxlLnJlcXVpcmUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIGZhbGwgYmFjayB0byBvdXIgb3duIFVSTCBwYXJzaW5nLgogICAgICAvLyBHbG9iYWwgYHJlcXVpcmVgIGlzIHNoYWRvd2VkIGJ5IEVtYmVyJ3MgbG9hZGVyIHNvIHdlIGhhdmUgdG8gdXNlIHRoZSBmdWxseQogICAgICAvLyBxdWFsaWZpZWQgYG1vZHVsZS5yZXF1aXJlYC4KICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXJlcXVpcmUtaW1wb3J0cwogICAgICBub2RlVVJMID0gbW9kdWxlLnJlcXVpcmUoJ3VybCcpOwogICAgICBlbnZpcm9ubWVudC5wcm90b2NvbEZvclVSTCA9IG5vZGVQcm90b2NvbEZvclVSTDsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGZpbmQgdmFsaWQgVVJMIHBhcnNpbmcgbWVjaGFuaXNtIGZvciBVUkwgU2FuaXRpemF0aW9uJyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBicm93c2VyUHJvdG9jb2xGb3JVUkwodXJsKSB7CiAgICBpZiAoIXBhcnNpbmdOb2RlKSB7CiAgICAgIHBhcnNpbmdOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgfQoKICAgIHBhcnNpbmdOb2RlLmhyZWYgPSB1cmw7CiAgICByZXR1cm4gcGFyc2luZ05vZGUucHJvdG9jb2w7CiAgfQoKICBmdW5jdGlvbiBub2RlUHJvdG9jb2xGb3JVUkwodXJsKSB7CiAgICB2YXIgcHJvdG9jb2wgPSBudWxsOwoKICAgIGlmICh0eXBlb2YgdXJsID09PSAnc3RyaW5nJykgewogICAgICBwcm90b2NvbCA9IG5vZGVVUkwucGFyc2UodXJsKS5wcm90b2NvbDsKICAgIH0KCiAgICByZXR1cm4gcHJvdG9jb2wgPT09IG51bGwgPyAnOicgOiBwcm90b2NvbDsKICB9CgogIHZhciBHVUlEID0gMDsKCiAgdmFyIFJlZiA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFJlZih2YWx1ZSQkMSkgewogICAgICB0aGlzLmlkID0gR1VJRCsrOwogICAgICB0aGlzLnZhbHVlID0gdmFsdWUkJDE7CiAgICB9CgogICAgdmFyIF9wcm90bzI4ID0gUmVmLnByb3RvdHlwZTsKCiAgICBfcHJvdG8yOC5nZXQgPSBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLnZhbHVlOwogICAgfTsKCiAgICBfcHJvdG8yOC5yZWxlYXNlID0gZnVuY3Rpb24gcmVsZWFzZSgpIHsKICAgICAgKGZhbHNlICYmICEodGhpcy52YWx1ZSAhPT0gbnVsbCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdCVUc6IGRvdWJsZSByZWxlYXNlPycsIHRoaXMudmFsdWUgIT09IG51bGwpKTsKICAgICAgdGhpcy52YWx1ZSA9IG51bGw7CiAgICB9OwoKICAgIF9wcm90bzI4LnRvU3RyaW5nID0gZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgIHZhciBsYWJlbCA9ICJSZWYgIiArIHRoaXMuaWQ7CgogICAgICBpZiAodGhpcy52YWx1ZSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBsYWJlbCArICIgKHJlbGVhc2VkKSI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBsYWJlbCArICI6ICIgKyB0aGlzLnZhbHVlOwogICAgICAgIH0gY2F0Y2ggKF9hKSB7CiAgICAgICAgICByZXR1cm4gbGFiZWw7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBSZWY7CiAgfSgpOwoKICB2YXIgRGVidWdSZW5kZXJUcmVlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRGVidWdSZW5kZXJUcmVlKCkgewogICAgICB0aGlzLnN0YWNrID0gbmV3IF91dGlsLlN0YWNrKCk7CiAgICAgIHRoaXMucmVmcyA9IG5ldyBXZWFrTWFwKCk7CiAgICAgIHRoaXMucm9vdHMgPSBuZXcgU2V0KCk7CiAgICAgIHRoaXMubm9kZXMgPSBuZXcgV2Vha01hcCgpOwogICAgfQoKICAgIHZhciBfcHJvdG8yOSA9IERlYnVnUmVuZGVyVHJlZS5wcm90b3R5cGU7CgogICAgX3Byb3RvMjkuYmVnaW4gPSBmdW5jdGlvbiBiZWdpbigpIHsKICAgICAgdGhpcy5yZXNldCgpOwogICAgfTsKCiAgICBfcHJvdG8yOS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUoc3RhdGUsIG5vZGUpIHsKICAgICAgdGhpcy5ub2Rlcy5zZXQoc3RhdGUsICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIG5vZGUsIHsKICAgICAgICBib3VuZHM6IG51bGwsCiAgICAgICAgcmVmczogbmV3IFNldCgpCiAgICAgIH0pKTsKICAgICAgdGhpcy5hcHBlbmRDaGlsZChzdGF0ZSk7CiAgICAgIHRoaXMuZW50ZXIoc3RhdGUpOwogICAgfTsKCiAgICBfcHJvdG8yOS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUoc3RhdGUpIHsKICAgICAgdGhpcy5lbnRlcihzdGF0ZSk7CiAgICB9OwoKICAgIF9wcm90bzI5LmRpZFJlbmRlciA9IGZ1bmN0aW9uIGRpZFJlbmRlcihzdGF0ZSwgYm91bmRzKSB7CiAgICAgIChmYWxzZSAmJiAhKHRoaXMuc3RhY2suY3VycmVudCA9PT0gc3RhdGUpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQlVHOiBleHBlY3RpbmcgIiArIHRoaXMuc3RhY2suY3VycmVudCArICIsIGdvdCAiICsgc3RhdGUsIHRoaXMuc3RhY2suY3VycmVudCA9PT0gc3RhdGUpKTsKICAgICAgdGhpcy5ub2RlRm9yKHN0YXRlKS5ib3VuZHMgPSBib3VuZHM7CiAgICAgIHRoaXMuZXhpdCgpOwogICAgfTsKCiAgICBfcHJvdG8yOS53aWxsRGVzdHJveSA9IGZ1bmN0aW9uIHdpbGxEZXN0cm95KHN0YXRlKSB7CiAgICAgICgwLCBfdXRpbC5leHBlY3QpKHRoaXMucmVmcy5nZXQoc3RhdGUpLCAnQlVHOiBtaXNzaW5nIHJlZicpLnJlbGVhc2UoKTsKICAgIH07CgogICAgX3Byb3RvMjkuY29tbWl0ID0gZnVuY3Rpb24gY29tbWl0KCkgewogICAgICB0aGlzLnJlc2V0KCk7CiAgICB9OwoKICAgIF9wcm90bzI5LmNhcHR1cmUgPSBmdW5jdGlvbiBjYXB0dXJlKCkgewogICAgICByZXR1cm4gdGhpcy5jYXB0dXJlUmVmcyh0aGlzLnJvb3RzKTsKICAgIH07CgogICAgX3Byb3RvMjkucmVzZXQgPSBmdW5jdGlvbiByZXNldCgpIHsKICAgICAgaWYgKHRoaXMuc3RhY2suc2l6ZSAhPT0gMCkgewogICAgICAgIC8vIFdlIHByb2JhYmx5IGVuY291bnRlcmVkIGFuIGVycm9yIGR1cmluZyB0aGUgcmVuZGVyaW5nIGxvb3AuIFRoaXMgd2lsbAogICAgICAgIC8vIGxpa2VseSB0cmlnZ2VyIHVuZGVmaW5lZCBiZWhhdmlvciBhbmQgbWVtb3J5IGxlYWtzIGFzIHRoZSBlcnJvciBsZWZ0CiAgICAgICAgLy8gdGhpbmdzIGluIGFuIGluY29uc2lzdGVudCBzdGF0ZS4gSXQgaXMgcmVjb21tZW5kZWQgdGhhdCB0aGUgdXNlcgogICAgICAgIC8vIHJlZnJlc2ggdGhlIHBhZ2UuCiAgICAgICAgLy8gVE9ETzogV2UgY291bGQgd2FybiBoZXJlPyBCdXQgdGhpcyBoYXBwZW5zIGFsbCB0aGUgdGltZSBpbiBvdXIgdGVzdHM/CiAgICAgICAgd2hpbGUgKCF0aGlzLnN0YWNrLmlzRW1wdHkoKSkgewogICAgICAgICAgdGhpcy5zdGFjay5wb3AoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMjkuZW50ZXIgPSBmdW5jdGlvbiBlbnRlcihzdGF0ZSkgewogICAgICB0aGlzLnN0YWNrLnB1c2goc3RhdGUpOwogICAgfTsKCiAgICBfcHJvdG8yOS5leGl0ID0gZnVuY3Rpb24gZXhpdCgpIHsKICAgICAgKGZhbHNlICYmICEodGhpcy5zdGFjay5zaXplICE9PSAwKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0JVRzogdW5iYWxhbmNlZCBwb3AnLCB0aGlzLnN0YWNrLnNpemUgIT09IDApKTsKICAgICAgdGhpcy5zdGFjay5wb3AoKTsKICAgIH07CgogICAgX3Byb3RvMjkubm9kZUZvciA9IGZ1bmN0aW9uIG5vZGVGb3Ioc3RhdGUpIHsKICAgICAgcmV0dXJuICgwLCBfdXRpbC5leHBlY3QpKHRoaXMubm9kZXMuZ2V0KHN0YXRlKSwgJ0JVRzogbWlzc2luZyBub2RlJyk7CiAgICB9OwoKICAgIF9wcm90bzI5LmFwcGVuZENoaWxkID0gZnVuY3Rpb24gYXBwZW5kQ2hpbGQoc3RhdGUpIHsKICAgICAgKGZhbHNlICYmICEoIXRoaXMucmVmcy5oYXMoc3RhdGUpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0JVRzogY2hpbGQgYWxyZWFkeSBhcHBlbmRlZCcsICF0aGlzLnJlZnMuaGFzKHN0YXRlKSkpOwogICAgICB2YXIgcGFyZW50ID0gdGhpcy5zdGFjay5jdXJyZW50OwogICAgICB2YXIgcmVmID0gbmV3IFJlZihzdGF0ZSk7CiAgICAgIHRoaXMucmVmcy5zZXQoc3RhdGUsIHJlZik7CgogICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgdGhpcy5ub2RlRm9yKHBhcmVudCkucmVmcy5hZGQocmVmKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnJvb3RzLmFkZChyZWYpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzI5LmNhcHR1cmVSZWZzID0gZnVuY3Rpb24gY2FwdHVyZVJlZnMocmVmcykgewogICAgICB2YXIgX3RoaXMxNSA9IHRoaXM7CgogICAgICB2YXIgY2FwdHVyZWQgPSBbXTsKICAgICAgcmVmcy5mb3JFYWNoKGZ1bmN0aW9uIChyZWYpIHsKICAgICAgICB2YXIgc3RhdGUgPSByZWYuZ2V0KCk7CgogICAgICAgIGlmIChzdGF0ZSkgewogICAgICAgICAgY2FwdHVyZWQucHVzaChfdGhpczE1LmNhcHR1cmVOb2RlKHN0YXRlKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlZnMuZGVsZXRlKHJlZik7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIGNhcHR1cmVkOwogICAgfTsKCiAgICBfcHJvdG8yOS5jYXB0dXJlTm9kZSA9IGZ1bmN0aW9uIGNhcHR1cmVOb2RlKHN0YXRlKSB7CiAgICAgIHZhciBub2RlID0gdGhpcy5ub2RlRm9yKHN0YXRlKTsKICAgICAgdmFyIHR5cGUgPSBub2RlLnR5cGUsCiAgICAgICAgICBuYW1lID0gbm9kZS5uYW1lLAogICAgICAgICAgYXJncyA9IG5vZGUuYXJncywKICAgICAgICAgIGluc3RhbmNlID0gbm9kZS5pbnN0YW5jZSwKICAgICAgICAgIHJlZnMgPSBub2RlLnJlZnM7CiAgICAgIHZhciBib3VuZHMgPSB0aGlzLmNhcHR1cmVCb3VuZHMobm9kZSk7CiAgICAgIHZhciBjaGlsZHJlbiA9IHRoaXMuY2FwdHVyZVJlZnMocmVmcyk7CiAgICAgIHJldHVybiB7CiAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgIGFyZ3M6IGFyZ3MudmFsdWUoKSwKICAgICAgICBpbnN0YW5jZTogaW5zdGFuY2UsCiAgICAgICAgYm91bmRzOiBib3VuZHMsCiAgICAgICAgY2hpbGRyZW46IGNoaWxkcmVuCiAgICAgIH07CiAgICB9OwoKICAgIF9wcm90bzI5LmNhcHR1cmVCb3VuZHMgPSBmdW5jdGlvbiBjYXB0dXJlQm91bmRzKG5vZGUpIHsKICAgICAgdmFyIGJvdW5kcyA9ICgwLCBfdXRpbC5leHBlY3QpKG5vZGUuYm91bmRzLCAnQlVHOiBtaXNzaW5nIGJvdW5kcycpOwogICAgICB2YXIgcGFyZW50RWxlbWVudCA9IGJvdW5kcy5wYXJlbnRFbGVtZW50KCk7CiAgICAgIHZhciBmaXJzdE5vZGUgPSBib3VuZHMuZmlyc3ROb2RlKCk7CiAgICAgIHZhciBsYXN0Tm9kZSA9IGJvdW5kcy5sYXN0Tm9kZSgpOwogICAgICByZXR1cm4gewogICAgICAgIHBhcmVudEVsZW1lbnQ6IHBhcmVudEVsZW1lbnQsCiAgICAgICAgZmlyc3ROb2RlOiBmaXJzdE5vZGUsCiAgICAgICAgbGFzdE5vZGU6IGxhc3ROb2RlCiAgICAgIH07CiAgICB9OwoKICAgIHJldHVybiBEZWJ1Z1JlbmRlclRyZWU7CiAgfSgpOwoKICB2YXIgRW52aXJvbm1lbnQkMSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfRW52aXJvbm1lbnQpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShFbnZpcm9ubWVudCQxLCBfRW52aXJvbm1lbnQpOwoKICAgIGZ1bmN0aW9uIEVudmlyb25tZW50JDEoaW5qZWN0aW9ucykgewogICAgICB2YXIgX3RoaXMxNjsKCiAgICAgIF90aGlzMTYgPSBfRW52aXJvbm1lbnQuY2FsbCh0aGlzLCBpbmplY3Rpb25zKSB8fCB0aGlzOwogICAgICBfdGhpczE2LmluVHJhbnNhY3Rpb24gPSBmYWxzZTsKICAgICAgdmFyIG93bmVyID0gaW5qZWN0aW9uc1tfb3duZXIuT1dORVJdOwogICAgICBfdGhpczE2Lm93bmVyID0gb3duZXI7CiAgICAgIF90aGlzMTYuaXNJbnRlcmFjdGl2ZSA9IG93bmVyLmxvb2t1cCgnLWVudmlyb25tZW50Om1haW4nKS5pc0ludGVyYWN0aXZlOyAvLyBjYW4gYmUgcmVtb3ZlZCBvbmNlIGh0dHBzOi8vZ2l0aHViLmNvbS90aWxkZWlvL2dsaW1tZXIvcHVsbC8zMDUgbGFuZHMKCiAgICAgIF90aGlzMTYuZGVzdHJveWVkQ29tcG9uZW50cyA9IFtdOwogICAgICBpbnN0YWxsUHJvdG9jb2xGb3JVUkwoKDAsIF9lbWJlckJhYmVsLmFzc2VydFRoaXNJbml0aWFsaXplZCkoX3RoaXMxNikpOwoKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICkgewogICAgICAgIF90aGlzMTYuX2RlYnVnU3RhY2sgPSBnZXREZWJ1Z1N0YWNrJDEoKTsKICAgICAgfQoKICAgICAgaWYgKF9lbnZpcm9ubWVudDIuRU5WLl9ERUJVR19SRU5ERVJfVFJFRSkgewogICAgICAgIF90aGlzMTYuX2RlYnVnUmVuZGVyVHJlZSA9IG5ldyBEZWJ1Z1JlbmRlclRyZWUoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIF90aGlzMTY7CiAgICB9CgogICAgRW52aXJvbm1lbnQkMS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUob3B0aW9ucykgewogICAgICByZXR1cm4gbmV3IHRoaXMob3B0aW9ucyk7CiAgICB9OwoKICAgIHZhciBfcHJvdG8zMCA9IEVudmlyb25tZW50JDEucHJvdG90eXBlOwoKICAgIC8vIHRoaXMgZ2V0cyBjbG9iYmVyZWQgYnkgaW5zdGFsbFBsYXRmb3JtU3BlY2lmaWNQcm90b2NvbEZvclVSTAogICAgLy8gaXQgcmVhbGx5IHNob3VsZCBqdXN0IGRlbGVnYXRlIHRvIGEgcGxhdGZvcm0gc3BlY2lmaWMgaW5qZWN0aW9uCiAgICBfcHJvdG8zMC5wcm90b2NvbEZvclVSTCA9IGZ1bmN0aW9uIHByb3RvY29sRm9yVVJMKHMpIHsKICAgICAgcmV0dXJuIHM7CiAgICB9OwoKICAgIF9wcm90bzMwLnRvQ29uZGl0aW9uYWxSZWZlcmVuY2UgPSBmdW5jdGlvbiB0b0NvbmRpdGlvbmFsUmVmZXJlbmNlKHJlZmVyZW5jZSkgewogICAgICByZXR1cm4gQ29uZGl0aW9uYWxSZWZlcmVuY2UkMS5jcmVhdGUocmVmZXJlbmNlKTsKICAgIH07CgogICAgX3Byb3RvMzAuaXRlcmFibGVGb3IgPSBmdW5jdGlvbiBpdGVyYWJsZUZvcihyZWYsIGtleSkgewogICAgICByZXR1cm4gX2l0ZXJhYmxlRm9yKHJlZiwga2V5KTsKICAgIH07CgogICAgX3Byb3RvMzAuc2NoZWR1bGVJbnN0YWxsTW9kaWZpZXIgPSBmdW5jdGlvbiBzY2hlZHVsZUluc3RhbGxNb2RpZmllcihtb2RpZmllciwgbWFuYWdlcikgewogICAgICBpZiAodGhpcy5pc0ludGVyYWN0aXZlKSB7CiAgICAgICAgX0Vudmlyb25tZW50LnByb3RvdHlwZS5zY2hlZHVsZUluc3RhbGxNb2RpZmllci5jYWxsKHRoaXMsIG1vZGlmaWVyLCBtYW5hZ2VyKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8zMC5zY2hlZHVsZVVwZGF0ZU1vZGlmaWVyID0gZnVuY3Rpb24gc2NoZWR1bGVVcGRhdGVNb2RpZmllcihtb2RpZmllciwgbWFuYWdlcikgewogICAgICBpZiAodGhpcy5pc0ludGVyYWN0aXZlKSB7CiAgICAgICAgX0Vudmlyb25tZW50LnByb3RvdHlwZS5zY2hlZHVsZVVwZGF0ZU1vZGlmaWVyLmNhbGwodGhpcywgbW9kaWZpZXIsIG1hbmFnZXIpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzMwLmRpZERlc3Ryb3kgPSBmdW5jdGlvbiBkaWREZXN0cm95KGRlc3Ryb3lhYmxlKSB7CiAgICAgIGRlc3Ryb3lhYmxlLmRlc3Ryb3koKTsKICAgIH07CgogICAgX3Byb3RvMzAuYmVnaW4gPSBmdW5jdGlvbiBiZWdpbigpIHsKICAgICAgaWYgKF9lbnZpcm9ubWVudDIuRU5WLl9ERUJVR19SRU5ERVJfVFJFRSkgewogICAgICAgIHRoaXMuZGVidWdSZW5kZXJUcmVlLmJlZ2luKCk7CiAgICAgIH0KCiAgICAgIHRoaXMuaW5UcmFuc2FjdGlvbiA9IHRydWU7CgogICAgICBfRW52aXJvbm1lbnQucHJvdG90eXBlLmJlZ2luLmNhbGwodGhpcyk7CiAgICB9OwoKICAgIF9wcm90bzMwLmNvbW1pdCA9IGZ1bmN0aW9uIGNvbW1pdCgpIHsKICAgICAgdmFyIGRlc3Ryb3llZENvbXBvbmVudHMgPSB0aGlzLmRlc3Ryb3llZENvbXBvbmVudHM7CiAgICAgIHRoaXMuZGVzdHJveWVkQ29tcG9uZW50cyA9IFtdOyAvLyBjb21wb25lbnRzIHF1ZXVlZCBmb3IgZGVzdHJ1Y3Rpb24gbXVzdCBiZSBkZXN0cm95ZWQgYmVmb3JlIGZpcmluZwogICAgICAvLyBgZGlkQ3JlYXRlYCB0byBwcmV2ZW50IGVycm9ycyB3aGVuIHJlbW92aW5nIGFuZCBhZGRpbmcgYSBjb21wb25lbnQKICAgICAgLy8gd2l0aCB0aGUgc2FtZSBuYW1lICh3b3VsZCB0aHJvdyBhbiBlcnJvciB3aGVuIGFkZGVkIHRvIHZpZXcgcmVnaXN0cnkpCgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlc3Ryb3llZENvbXBvbmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBkZXN0cm95ZWRDb21wb25lbnRzW2ldLmRlc3Ryb3koKTsKICAgICAgfQoKICAgICAgdHJ5IHsKICAgICAgICBfRW52aXJvbm1lbnQucHJvdG90eXBlLmNvbW1pdC5jYWxsKHRoaXMpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRoaXMuaW5UcmFuc2FjdGlvbiA9IGZhbHNlOwogICAgICB9CgogICAgICBpZiAoX2Vudmlyb25tZW50Mi5FTlYuX0RFQlVHX1JFTkRFUl9UUkVFKSB7CiAgICAgICAgdGhpcy5kZWJ1Z1JlbmRlclRyZWUuY29tbWl0KCk7CiAgICAgIH0KICAgIH07CgogICAgKDAsIF9lbWJlckJhYmVsLmNyZWF0ZUNsYXNzKShFbnZpcm9ubWVudCQxLCBbewogICAgICBrZXk6ICJkZWJ1Z1N0YWNrIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgaWYgKGZhbHNlCiAgICAgICAgLyogREVCVUcgKi8KICAgICAgICApIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9kZWJ1Z1N0YWNrOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbid0IGFjY2VzcyBkZWJ1ZyBzdGFjayBvdXRzaWRlIG9mIGRlYnVnIG1vZGUiKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZGVidWdSZW5kZXJUcmVlIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgaWYgKF9lbnZpcm9ubWVudDIuRU5WLl9ERUJVR19SRU5ERVJfVFJFRSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX2RlYnVnUmVuZGVyVHJlZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW4ndCBhY2Nlc3MgZGVidWcgcmVuZGVyIHRyZWUgb3V0c2lkZSBvZiB0aGUgaW5zcGVjdG9yIChfREVCVUdfUkVOREVSX1RSRUUgZmxhZyBpcyBkaXNhYmxlZCkiKTsKICAgICAgICB9CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBFbnZpcm9ubWVudCQxOwogIH0oX3J1bnRpbWUyLkVudmlyb25tZW50KTsKCiAgX2V4cG9ydHMuRW52aXJvbm1lbnQgPSBFbnZpcm9ubWVudCQxOwoKICBpZiAoZmFsc2UKICAvKiBERUJVRyAqLwogICkgewogICAgdmFyIFN0eWxlQXR0cmlidXRlTWFuYWdlciA9CiAgICAvKiNfX1BVUkVfXyovCiAgICBmdW5jdGlvbiAoX1NpbXBsZUR5bmFtaWNBdHRyaWJ1KSB7CiAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShTdHlsZUF0dHJpYnV0ZU1hbmFnZXIsIF9TaW1wbGVEeW5hbWljQXR0cmlidSk7CgogICAgICBmdW5jdGlvbiBTdHlsZUF0dHJpYnV0ZU1hbmFnZXIoKSB7CiAgICAgICAgcmV0dXJuIF9TaW1wbGVEeW5hbWljQXR0cmlidS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICAgIH0KCiAgICAgIHZhciBfcHJvdG8zMSA9IFN0eWxlQXR0cmlidXRlTWFuYWdlci5wcm90b3R5cGU7CgogICAgICBfcHJvdG8zMS5zZXQgPSBmdW5jdGlvbiBzZXQoZG9tLCB2YWx1ZSQkMSwgZW52KSB7CiAgICAgICAgKGZhbHNlICYmICgwLCBfZGVidWcud2FybikoKDAsIF92aWV3cy5jb25zdHJ1Y3RTdHlsZURlcHJlY2F0aW9uTWVzc2FnZSkodmFsdWUkJDEpLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodmFsdWUkJDEgPT09IG51bGwgfHwgdmFsdWUkJDEgPT09IHVuZGVmaW5lZCB8fCBpc0hUTUxTYWZlKHZhbHVlJCQxKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSgpLCB7CiAgICAgICAgICBpZDogJ2VtYmVyLWh0bWxiYXJzLnN0eWxlLXhzcy13YXJuaW5nJwogICAgICAgIH0pKTsKCiAgICAgICAgX1NpbXBsZUR5bmFtaWNBdHRyaWJ1LnByb3RvdHlwZS5zZXQuY2FsbCh0aGlzLCBkb20sIHZhbHVlJCQxLCBlbnYpOwogICAgICB9OwoKICAgICAgX3Byb3RvMzEudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlKHZhbHVlJCQxLCBlbnYpIHsKICAgICAgICAoZmFsc2UgJiYgKDAsIF9kZWJ1Zy53YXJuKSgoMCwgX3ZpZXdzLmNvbnN0cnVjdFN0eWxlRGVwcmVjYXRpb25NZXNzYWdlKSh2YWx1ZSQkMSksIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh2YWx1ZSQkMSA9PT0gbnVsbCB8fCB2YWx1ZSQkMSA9PT0gdW5kZWZpbmVkIHx8IGlzSFRNTFNhZmUodmFsdWUkJDEpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9KCksIHsKICAgICAgICAgIGlkOiAnZW1iZXItaHRtbGJhcnMuc3R5bGUteHNzLXdhcm5pbmcnCiAgICAgICAgfSkpOwoKICAgICAgICBfU2ltcGxlRHluYW1pY0F0dHJpYnUucHJvdG90eXBlLnVwZGF0ZS5jYWxsKHRoaXMsIHZhbHVlJCQxLCBlbnYpOwogICAgICB9OwoKICAgICAgcmV0dXJuIFN0eWxlQXR0cmlidXRlTWFuYWdlcjsKICAgIH0oX3J1bnRpbWUyLlNpbXBsZUR5bmFtaWNBdHRyaWJ1dGUpOwoKICAgIEVudmlyb25tZW50JDEucHJvdG90eXBlLmF0dHJpYnV0ZUZvciA9IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyaWJ1dGUsIGlzVHJ1c3RpbmcsIG5hbWVzcGFjZSkgewogICAgICBpZiAoYXR0cmlidXRlID09PSAnc3R5bGUnICYmICFpc1RydXN0aW5nKSB7CiAgICAgICAgcmV0dXJuIG5ldyBTdHlsZUF0dHJpYnV0ZU1hbmFnZXIoewogICAgICAgICAgZWxlbWVudDogZWxlbWVudCwKICAgICAgICAgIG5hbWU6IGF0dHJpYnV0ZSwKICAgICAgICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBfcnVudGltZTIuRW52aXJvbm1lbnQucHJvdG90eXBlLmF0dHJpYnV0ZUZvci5jYWxsKHRoaXMsIGVsZW1lbnQsIGF0dHJpYnV0ZSwgaXNUcnVzdGluZywgbmFtZXNwYWNlKTsKICAgIH07CiAgfSAvLyBpbXBsZW1lbnRzIHRoZSBDb21wb25lbnRNYW5hZ2VyIGludGVyZmFjZSBhcyBkZWZpbmVkIGluIGdsaW1tZXI6CiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aAogIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9nbGltbWVyanMvZ2xpbW1lci12bS9ibG9iL3YwLjI0LjAtYmV0YS40L3BhY2thZ2VzLyU0MGdsaW1tZXIvcnVudGltZS9saWIvY29tcG9uZW50L2ludGVyZmFjZXMudHMjTDIxCgoKICB2YXIgQWJzdHJhY3RNYW5hZ2VyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQWJzdHJhY3RNYW5hZ2VyKCkgewogICAgICB0aGlzLmRlYnVnU3RhY2sgPSB1bmRlZmluZWQ7CiAgICB9CgogICAgdmFyIF9wcm90bzMyID0gQWJzdHJhY3RNYW5hZ2VyLnByb3RvdHlwZTsKCiAgICBfcHJvdG8zMi5wcmVwYXJlQXJncyA9IGZ1bmN0aW9uIHByZXBhcmVBcmdzKF9zdGF0ZSwgX2FyZ3MpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9OwoKICAgIF9wcm90bzMyLmRpZENyZWF0ZUVsZW1lbnQgPSBmdW5jdGlvbiBkaWRDcmVhdGVFbGVtZW50KF9jb21wb25lbnQsIF9lbGVtZW50LCBfb3BlcmF0aW9ucykge30gLy8gbm9vcAogICAgLy8gaW5oZXJpdG9ycyBzaG91bGQgYWxzbyBjYWxsIGB0aGlzLmRlYnVnU3RhY2sucG9wKClgIHRvCiAgICAvLyBlbnN1cmUgdGhlIHJlcmVuZGVyaW5nIGFzc2VydGlvbiBtZXNzYWdlcyBhcmUgcHJvcGVybHkKICAgIC8vIG1haW50YWluZWQKICAgIDsKCiAgICBfcHJvdG8zMi5kaWRSZW5kZXJMYXlvdXQgPSBmdW5jdGlvbiBkaWRSZW5kZXJMYXlvdXQoX2NvbXBvbmVudCwgX2JvdW5kcykgey8vIG5vb3AKICAgIH07CgogICAgX3Byb3RvMzIuZGlkQ3JlYXRlID0gZnVuY3Rpb24gZGlkQ3JlYXRlKF9idWNrZXQpIHt9IC8vIG5vb3AKICAgIC8vIGluaGVyaXRvcnMgc2hvdWxkIGFsc28gY2FsbCBgdGhpcy5fcHVzaFRvRGVidWdTdGFja2AKICAgIC8vIHRvIGVuc3VyZSB0aGUgcmVyZW5kZXJpbmcgYXNzZXJ0aW9uIG1lc3NhZ2VzIGFyZQogICAgLy8gcHJvcGVybHkgbWFpbnRhaW5lZAogICAgOwoKICAgIF9wcm90bzMyLnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZShfYnVja2V0LCBfZHluYW1pY1Njb3BlKSB7fSAvLyBub29wCiAgICAvLyBpbmhlcml0b3JzIHNob3VsZCBhbHNvIGNhbGwgYHRoaXMuZGVidWdTdGFjay5wb3AoKWAgdG8KICAgIC8vIGVuc3VyZSB0aGUgcmVyZW5kZXJpbmcgYXNzZXJ0aW9uIG1lc3NhZ2VzIGFyZSBwcm9wZXJseQogICAgLy8gbWFpbnRhaW5lZAogICAgOwoKICAgIF9wcm90bzMyLmRpZFVwZGF0ZUxheW91dCA9IGZ1bmN0aW9uIGRpZFVwZGF0ZUxheW91dChfYnVja2V0LCBfYm91bmRzKSB7Ly8gbm9vcAogICAgfTsKCiAgICBfcHJvdG8zMi5kaWRVcGRhdGUgPSBmdW5jdGlvbiBkaWRVcGRhdGUoX2J1Y2tldCkgey8vIG5vb3AKICAgIH07CgogICAgcmV0dXJuIEFic3RyYWN0TWFuYWdlcjsKICB9KCk7CgogIF9leHBvcnRzLkFic3RyYWN0Q29tcG9uZW50TWFuYWdlciA9IEFic3RyYWN0TWFuYWdlcjsKCiAgZnVuY3Rpb24gaW5zdHJ1bWVudGF0aW9uUGF5bG9hZChkZWYpIHsKICAgIHJldHVybiB7CiAgICAgIG9iamVjdDogZGVmLm5hbWUgKyAiOiIgKyBkZWYub3V0bGV0CiAgICB9OwogIH0KCiAgdmFyIENBUEFCSUxJVElFUyA9IHsKICAgIGR5bmFtaWNMYXlvdXQ6IGZhbHNlLAogICAgZHluYW1pY1RhZzogZmFsc2UsCiAgICBwcmVwYXJlQXJnczogZmFsc2UsCiAgICBjcmVhdGVBcmdzOiBfZW52aXJvbm1lbnQyLkVOVi5fREVCVUdfUkVOREVSX1RSRUUsCiAgICBhdHRyaWJ1dGVIb29rOiBmYWxzZSwKICAgIGVsZW1lbnRIb29rOiBmYWxzZSwKICAgIGNyZWF0ZUNhbGxlcjogZmFsc2UsCiAgICBkeW5hbWljU2NvcGU6IHRydWUsCiAgICB1cGRhdGVIb29rOiBfZW52aXJvbm1lbnQyLkVOVi5fREVCVUdfUkVOREVSX1RSRUUsCiAgICBjcmVhdGVJbnN0YW5jZTogdHJ1ZQogIH07CgogIHZhciBPdXRsZXRDb21wb25lbnRNYW5hZ2VyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9BYnN0cmFjdE1hbmFnZXIpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShPdXRsZXRDb21wb25lbnRNYW5hZ2VyLCBfQWJzdHJhY3RNYW5hZ2VyKTsKCiAgICBmdW5jdGlvbiBPdXRsZXRDb21wb25lbnRNYW5hZ2VyKCkgewogICAgICByZXR1cm4gX0Fic3RyYWN0TWFuYWdlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICB9CgogICAgdmFyIF9wcm90bzMzID0gT3V0bGV0Q29tcG9uZW50TWFuYWdlci5wcm90b3R5cGU7CgogICAgX3Byb3RvMzMuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKGVudmlyb25tZW50LCBkZWZpbml0aW9uLCBhcmdzLCBkeW5hbWljU2NvcGUpIHsKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICkgewogICAgICAgIGVudmlyb25tZW50LmRlYnVnU3RhY2sucHVzaCgidGVtcGxhdGU6IiArIGRlZmluaXRpb24udGVtcGxhdGUucmVmZXJyZXIubW9kdWxlTmFtZSk7CiAgICAgIH0KCiAgICAgIHZhciBwYXJlbnRTdGF0ZVJlZiA9IGR5bmFtaWNTY29wZS5vdXRsZXRTdGF0ZTsKICAgICAgdmFyIGN1cnJlbnRTdGF0ZVJlZiA9IGRlZmluaXRpb24ucmVmOwogICAgICBkeW5hbWljU2NvcGUub3V0bGV0U3RhdGUgPSBjdXJyZW50U3RhdGVSZWY7CiAgICAgIHZhciBzdGF0ZSA9IHsKICAgICAgICBzZWxmOiBSb290UmVmZXJlbmNlLmNyZWF0ZShkZWZpbml0aW9uLmNvbnRyb2xsZXIpLAogICAgICAgIGVudmlyb25tZW50OiBlbnZpcm9ubWVudCwKICAgICAgICBmaW5hbGl6ZTogKDAsIF9pbnN0cnVtZW50YXRpb24uX2luc3RydW1lbnRTdGFydCkoJ3JlbmRlci5vdXRsZXQnLCBpbnN0cnVtZW50YXRpb25QYXlsb2FkLCBkZWZpbml0aW9uKQogICAgICB9OwoKICAgICAgaWYgKF9lbnZpcm9ubWVudDIuRU5WLl9ERUJVR19SRU5ERVJfVFJFRSkgewogICAgICAgIHN0YXRlLm91dGxldCA9IHsKICAgICAgICAgIG5hbWU6IGRlZmluaXRpb24ub3V0bGV0CiAgICAgICAgfTsKICAgICAgICBlbnZpcm9ubWVudC5kZWJ1Z1JlbmRlclRyZWUuY3JlYXRlKHN0YXRlLm91dGxldCwgewogICAgICAgICAgdHlwZTogJ291dGxldCcsCiAgICAgICAgICBuYW1lOiBzdGF0ZS5vdXRsZXQubmFtZSwKICAgICAgICAgIGFyZ3M6IF9ydW50aW1lMi5FTVBUWV9BUkdTLAogICAgICAgICAgaW5zdGFuY2U6IHVuZGVmaW5lZAogICAgICAgIH0pOwogICAgICAgIHZhciBwYXJlbnRTdGF0ZSA9IHBhcmVudFN0YXRlUmVmLnZhbHVlKCk7CiAgICAgICAgdmFyIHBhcmVudE93bmVyID0gcGFyZW50U3RhdGUgJiYgcGFyZW50U3RhdGUucmVuZGVyICYmIHBhcmVudFN0YXRlLnJlbmRlci5vd25lcjsKICAgICAgICB2YXIgY3VycmVudE93bmVyID0gY3VycmVudFN0YXRlUmVmLnZhbHVlKCkucmVuZGVyLm93bmVyOwoKICAgICAgICBpZiAocGFyZW50T3duZXIgJiYgcGFyZW50T3duZXIgIT09IGN1cnJlbnRPd25lcikgewogICAgICAgICAgdmFyIGVuZ2luZSA9IGN1cnJlbnRPd25lcjsKICAgICAgICAgIChmYWxzZSAmJiAhKHR5cGVvZiBjdXJyZW50T3duZXIubW91bnRQb2ludCA9PT0gJ3N0cmluZycpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnaW52YWxpZCBlbmdpbmU6IG1pc3NpbmcgbW91bnRQb2ludCcsIHR5cGVvZiBjdXJyZW50T3duZXIubW91bnRQb2ludCA9PT0gJ3N0cmluZycpKTsKICAgICAgICAgIChmYWxzZSAmJiAhKGN1cnJlbnRPd25lci5yb3V0YWJsZSA9PT0gdHJ1ZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdpbnZhbGlkIGVuZ2luZTogbWlzc2luZyByb3V0YWJsZScsIGN1cnJlbnRPd25lci5yb3V0YWJsZSA9PT0gdHJ1ZSkpOwogICAgICAgICAgdmFyIG1vdW50UG9pbnQgPSBlbmdpbmUubW91bnRQb2ludDsKICAgICAgICAgIHN0YXRlLmVuZ2luZSA9IHsKICAgICAgICAgICAgbW91bnRQb2ludDogbW91bnRQb2ludAogICAgICAgICAgfTsKICAgICAgICAgIGVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS5jcmVhdGUoc3RhdGUuZW5naW5lLCB7CiAgICAgICAgICAgIHR5cGU6ICdlbmdpbmUnLAogICAgICAgICAgICBuYW1lOiBtb3VudFBvaW50LAogICAgICAgICAgICBhcmdzOiBfcnVudGltZTIuRU1QVFlfQVJHUywKICAgICAgICAgICAgaW5zdGFuY2U6IGVuZ2luZQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBlbnZpcm9ubWVudC5kZWJ1Z1JlbmRlclRyZWUuY3JlYXRlKHN0YXRlLCB7CiAgICAgICAgICB0eXBlOiAncm91dGUtdGVtcGxhdGUnLAogICAgICAgICAgbmFtZTogZGVmaW5pdGlvbi5uYW1lLAogICAgICAgICAgYXJnczogYXJncy5jYXB0dXJlKCksCiAgICAgICAgICBpbnN0YW5jZTogZGVmaW5pdGlvbi5jb250cm9sbGVyCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBzdGF0ZTsKICAgIH07CgogICAgX3Byb3RvMzMuZ2V0TGF5b3V0ID0gZnVuY3Rpb24gZ2V0TGF5b3V0KF9yZWYsIF9yZXNvbHZlcikgewogICAgICB2YXIgdGVtcGxhdGUgPSBfcmVmLnRlbXBsYXRlOwogICAgICAvLyBUaGUgcm91dGVyIGhhcyBhbHJlYWR5IHJlc29sdmVkIHRoZSB0ZW1wbGF0ZQogICAgICB2YXIgbGF5b3V0ID0gdGVtcGxhdGUuYXNMYXlvdXQoKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBoYW5kbGU6IGxheW91dC5jb21waWxlKCksCiAgICAgICAgc3ltYm9sVGFibGU6IGxheW91dC5zeW1ib2xUYWJsZQogICAgICB9OwogICAgfTsKCiAgICBfcHJvdG8zMy5nZXRDYXBhYmlsaXRpZXMgPSBmdW5jdGlvbiBnZXRDYXBhYmlsaXRpZXMoKSB7CiAgICAgIHJldHVybiBDQVBBQklMSVRJRVM7CiAgICB9OwoKICAgIF9wcm90bzMzLmdldFNlbGYgPSBmdW5jdGlvbiBnZXRTZWxmKF9yZWYyKSB7CiAgICAgIHZhciBzZWxmID0gX3JlZjIuc2VsZjsKICAgICAgcmV0dXJuIHNlbGY7CiAgICB9OwoKICAgIF9wcm90bzMzLmdldFRhZyA9IGZ1bmN0aW9uIGdldFRhZygpIHsKICAgICAgaWYgKF9lbnZpcm9ubWVudDIuRU5WLl9ERUJVR19SRU5ERVJfVFJFRSkgewogICAgICAgIC8vIHJldHVybmluZyBhIGNvbnN0IHRhZyBza2lwcyB0aGUgdXBkYXRlIGhvb2sgKFZNIEJVRz8pCiAgICAgICAgcmV0dXJuICgwLCBfcmVmZXJlbmNlLmNyZWF0ZVRhZykoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBhbiBvdXRsZXQgaGFzIG5vIGhvb2tzCiAgICAgICAgcmV0dXJuIF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzMzLmRpZFJlbmRlckxheW91dCA9IGZ1bmN0aW9uIGRpZFJlbmRlckxheW91dChzdGF0ZSwgYm91bmRzKSB7CiAgICAgIHN0YXRlLmZpbmFsaXplKCk7CgogICAgICBpZiAoZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgKSB7CiAgICAgICAgc3RhdGUuZW52aXJvbm1lbnQuZGVidWdTdGFjay5wb3AoKTsKICAgICAgfQoKICAgICAgaWYgKF9lbnZpcm9ubWVudDIuRU5WLl9ERUJVR19SRU5ERVJfVFJFRSkgewogICAgICAgIHN0YXRlLmVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS5kaWRSZW5kZXIoc3RhdGUsIGJvdW5kcyk7CgogICAgICAgIGlmIChzdGF0ZS5lbmdpbmUpIHsKICAgICAgICAgIHN0YXRlLmVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS5kaWRSZW5kZXIoc3RhdGUuZW5naW5lLCBib3VuZHMpOwogICAgICAgIH0KCiAgICAgICAgc3RhdGUuZW52aXJvbm1lbnQuZGVidWdSZW5kZXJUcmVlLmRpZFJlbmRlcihzdGF0ZS5vdXRsZXQsIGJvdW5kcyk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMzMudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlKHN0YXRlKSB7CiAgICAgIGlmIChfZW52aXJvbm1lbnQyLkVOVi5fREVCVUdfUkVOREVSX1RSRUUpIHsKICAgICAgICBzdGF0ZS5lbnZpcm9ubWVudC5kZWJ1Z1JlbmRlclRyZWUudXBkYXRlKHN0YXRlLm91dGxldCk7CgogICAgICAgIGlmIChzdGF0ZS5lbmdpbmUpIHsKICAgICAgICAgIHN0YXRlLmVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS51cGRhdGUoc3RhdGUuZW5naW5lKTsKICAgICAgICB9CgogICAgICAgIHN0YXRlLmVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS51cGRhdGUoc3RhdGUpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzMzLmRpZFVwZGF0ZUxheW91dCA9IGZ1bmN0aW9uIGRpZFVwZGF0ZUxheW91dChzdGF0ZSwgYm91bmRzKSB7CiAgICAgIGlmIChfZW52aXJvbm1lbnQyLkVOVi5fREVCVUdfUkVOREVSX1RSRUUpIHsKICAgICAgICBzdGF0ZS5lbnZpcm9ubWVudC5kZWJ1Z1JlbmRlclRyZWUuZGlkUmVuZGVyKHN0YXRlLCBib3VuZHMpOwoKICAgICAgICBpZiAoc3RhdGUuZW5naW5lKSB7CiAgICAgICAgICBzdGF0ZS5lbnZpcm9ubWVudC5kZWJ1Z1JlbmRlclRyZWUuZGlkUmVuZGVyKHN0YXRlLmVuZ2luZSwgYm91bmRzKTsKICAgICAgICB9CgogICAgICAgIHN0YXRlLmVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS5kaWRSZW5kZXIoc3RhdGUub3V0bGV0LCBib3VuZHMpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzMzLmdldERlc3RydWN0b3IgPSBmdW5jdGlvbiBnZXREZXN0cnVjdG9yKHN0YXRlKSB7CiAgICAgIGlmIChfZW52aXJvbm1lbnQyLkVOVi5fREVCVUdfUkVOREVSX1RSRUUpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICAgICAgc3RhdGUuZW52aXJvbm1lbnQuZGVidWdSZW5kZXJUcmVlLndpbGxEZXN0cm95KHN0YXRlKTsKCiAgICAgICAgICAgIGlmIChzdGF0ZS5lbmdpbmUpIHsKICAgICAgICAgICAgICBzdGF0ZS5lbnZpcm9ubWVudC5kZWJ1Z1JlbmRlclRyZWUud2lsbERlc3Ryb3koc3RhdGUuZW5naW5lKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3RhdGUuZW52aXJvbm1lbnQuZGVidWdSZW5kZXJUcmVlLndpbGxEZXN0cm95KHN0YXRlLm91dGxldCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gT3V0bGV0Q29tcG9uZW50TWFuYWdlcjsKICB9KEFic3RyYWN0TWFuYWdlcik7CgogIHZhciBPVVRMRVRfTUFOQUdFUiA9IG5ldyBPdXRsZXRDb21wb25lbnRNYW5hZ2VyKCk7CgogIHZhciBPdXRsZXRDb21wb25lbnREZWZpbml0aW9uID0gZnVuY3Rpb24gT3V0bGV0Q29tcG9uZW50RGVmaW5pdGlvbihzdGF0ZSwgbWFuYWdlcikgewogICAgaWYgKG1hbmFnZXIgPT09IHZvaWQgMCkgewogICAgICBtYW5hZ2VyID0gT1VUTEVUX01BTkFHRVI7CiAgICB9CgogICAgdGhpcy5zdGF0ZSA9IHN0YXRlOwogICAgdGhpcy5tYW5hZ2VyID0gbWFuYWdlcjsKICB9OwoKICBmdW5jdGlvbiBjcmVhdGVSb290T3V0bGV0KG91dGxldFZpZXcpIHsKICAgIGlmIChfZW52aXJvbm1lbnQyLkVOVi5fQVBQTElDQVRJT05fVEVNUExBVEVfV1JBUFBFUikgewogICAgICB2YXIgV1JBUFBFRF9DQVBBQklMSVRJRVMgPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCBDQVBBQklMSVRJRVMsIHsKICAgICAgICBkeW5hbWljVGFnOiB0cnVlLAogICAgICAgIGVsZW1lbnRIb29rOiB0cnVlCiAgICAgIH0pOwoKICAgICAgdmFyIFdyYXBwZWRPdXRsZXRDb21wb25lbnRNYW5hZ2VyID0KICAgICAgLyojX19QVVJFX18qLwogICAgICBmdW5jdGlvbiAoX091dGxldENvbXBvbmVudE1hbmFnKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKFdyYXBwZWRPdXRsZXRDb21wb25lbnRNYW5hZ2VyLCBfT3V0bGV0Q29tcG9uZW50TWFuYWcpOwoKICAgICAgICBmdW5jdGlvbiBXcmFwcGVkT3V0bGV0Q29tcG9uZW50TWFuYWdlcigpIHsKICAgICAgICAgIHJldHVybiBfT3V0bGV0Q29tcG9uZW50TWFuYWcuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgICAgIH0KCiAgICAgICAgdmFyIF9wcm90bzM0ID0gV3JhcHBlZE91dGxldENvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlOwoKICAgICAgICBfcHJvdG8zNC5nZXRUYWdOYW1lID0gZnVuY3Rpb24gZ2V0VGFnTmFtZShfY29tcG9uZW50KSB7CiAgICAgICAgICByZXR1cm4gJ2Rpdic7CiAgICAgICAgfTsKCiAgICAgICAgX3Byb3RvMzQuZ2V0TGF5b3V0ID0gZnVuY3Rpb24gZ2V0TGF5b3V0KHN0YXRlKSB7CiAgICAgICAgICAvLyBUaGUgcm91dGVyIGhhcyBhbHJlYWR5IHJlc29sdmVkIHRoZSB0ZW1wbGF0ZQogICAgICAgICAgdmFyIHRlbXBsYXRlID0gc3RhdGUudGVtcGxhdGU7CiAgICAgICAgICB2YXIgbGF5b3V0ID0gdGVtcGxhdGUuYXNXcmFwcGVkTGF5b3V0KCk7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBoYW5kbGU6IGxheW91dC5jb21waWxlKCksCiAgICAgICAgICAgIHN5bWJvbFRhYmxlOiBsYXlvdXQuc3ltYm9sVGFibGUKICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICAgICAgX3Byb3RvMzQuZ2V0Q2FwYWJpbGl0aWVzID0gZnVuY3Rpb24gZ2V0Q2FwYWJpbGl0aWVzKCkgewogICAgICAgICAgcmV0dXJuIFdSQVBQRURfQ0FQQUJJTElUSUVTOwogICAgICAgIH07CgogICAgICAgIF9wcm90bzM0LmRpZENyZWF0ZUVsZW1lbnQgPSBmdW5jdGlvbiBkaWRDcmVhdGVFbGVtZW50KGNvbXBvbmVudCwgZWxlbWVudCwgX29wZXJhdGlvbnMpIHsKICAgICAgICAgIC8vIHRvIGFkZCBHVUlEIGlkIGFuZCBjbGFzcwogICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2VtYmVyLXZpZXcnKTsKICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdpZCcsICgwLCBfdXRpbHMuZ3VpZEZvcikoY29tcG9uZW50KSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFdyYXBwZWRPdXRsZXRDb21wb25lbnRNYW5hZ2VyOwogICAgICB9KE91dGxldENvbXBvbmVudE1hbmFnZXIpOwoKICAgICAgdmFyIFdSQVBQRURfT1VUTEVUX01BTkFHRVIgPSBuZXcgV3JhcHBlZE91dGxldENvbXBvbmVudE1hbmFnZXIoKTsKICAgICAgcmV0dXJuIG5ldyBPdXRsZXRDb21wb25lbnREZWZpbml0aW9uKG91dGxldFZpZXcuc3RhdGUsIFdSQVBQRURfT1VUTEVUX01BTkFHRVIpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5ldyBPdXRsZXRDb21wb25lbnREZWZpbml0aW9uKG91dGxldFZpZXcuc3RhdGUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gTk9PUCgpIHt9CiAgLyoqCiAgICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICBSZXByZXNlbnRzIHRoZSBpbnRlcm5hbCBzdGF0ZSBvZiB0aGUgY29tcG9uZW50LgogIAogICAgQGNsYXNzIENvbXBvbmVudFN0YXRlQnVja2V0CiAgICBAcHJpdmF0ZQogICovCgoKICB2YXIgQ29tcG9uZW50U3RhdGVCdWNrZXQgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBDb21wb25lbnRTdGF0ZUJ1Y2tldChlbnZpcm9ubWVudCwgY29tcG9uZW50LCBhcmdzLCBmaW5hbGl6ZXIsIGhhc1dyYXBwZWRFbGVtZW50KSB7CiAgICAgIHRoaXMuZW52aXJvbm1lbnQgPSBlbnZpcm9ubWVudDsKICAgICAgdGhpcy5jb21wb25lbnQgPSBjb21wb25lbnQ7CiAgICAgIHRoaXMuYXJncyA9IGFyZ3M7CiAgICAgIHRoaXMuZmluYWxpemVyID0gZmluYWxpemVyOwogICAgICB0aGlzLmhhc1dyYXBwZWRFbGVtZW50ID0gaGFzV3JhcHBlZEVsZW1lbnQ7CiAgICAgIHRoaXMuY2xhc3NSZWYgPSBudWxsOwogICAgICB0aGlzLmNsYXNzUmVmID0gbnVsbDsKICAgICAgdGhpcy5hcmdzUmV2aXNpb24gPSBhcmdzID09PSBudWxsID8gMCA6ICgwLCBfcmVmZXJlbmNlLnZhbHVlKShhcmdzLnRhZyk7CiAgICB9CgogICAgdmFyIF9wcm90bzM1ID0gQ29tcG9uZW50U3RhdGVCdWNrZXQucHJvdG90eXBlOwoKICAgIF9wcm90bzM1LmRlc3Ryb3kgPSBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICB2YXIgY29tcG9uZW50ID0gdGhpcy5jb21wb25lbnQsCiAgICAgICAgICBlbnZpcm9ubWVudCA9IHRoaXMuZW52aXJvbm1lbnQ7CgogICAgICBpZiAoZW52aXJvbm1lbnQuaXNJbnRlcmFjdGl2ZSkgewogICAgICAgIGNvbXBvbmVudC50cmlnZ2VyKCd3aWxsRGVzdHJveUVsZW1lbnQnKTsKICAgICAgICBjb21wb25lbnQudHJpZ2dlcignd2lsbENsZWFyUmVuZGVyJyk7CiAgICAgICAgdmFyIGVsZW1lbnQgPSAoMCwgX3ZpZXdzLmdldFZpZXdFbGVtZW50KShjb21wb25lbnQpOwoKICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgKDAsIF92aWV3cy5jbGVhckVsZW1lbnRWaWV3KShlbGVtZW50KTsKICAgICAgICAgICgwLCBfdmlld3MuY2xlYXJWaWV3RWxlbWVudCkoY29tcG9uZW50KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGVudmlyb25tZW50LmRlc3Ryb3llZENvbXBvbmVudHMucHVzaChjb21wb25lbnQpOwogICAgfTsKCiAgICBfcHJvdG8zNS5maW5hbGl6ZSA9IGZ1bmN0aW9uIGZpbmFsaXplKCkgewogICAgICB2YXIgZmluYWxpemVyID0gdGhpcy5maW5hbGl6ZXI7CiAgICAgIGZpbmFsaXplcigpOwogICAgICB0aGlzLmZpbmFsaXplciA9IE5PT1A7CiAgICB9OwoKICAgIHJldHVybiBDb21wb25lbnRTdGF0ZUJ1Y2tldDsKICB9KCk7CgogIGZ1bmN0aW9uIHJlZmVyZW5jZUZvcktleShjb21wb25lbnQsIGtleSkgewogICAgcmV0dXJuIGNvbXBvbmVudFtST09UX1JFRl0uZ2V0KGtleSk7CiAgfQoKICBmdW5jdGlvbiByZWZlcmVuY2VGb3JQYXJ0cyhjb21wb25lbnQsIHBhcnRzKSB7CiAgICB2YXIgaXNBdHRycyA9IHBhcnRzWzBdID09PSAnYXR0cnMnOyAvLyBUT0RPIGRlcHJlY2F0ZSB0aGlzCgogICAgaWYgKGlzQXR0cnMpIHsKICAgICAgcGFydHMuc2hpZnQoKTsKCiAgICAgIGlmIChwYXJ0cy5sZW5ndGggPT09IDEpIHsKICAgICAgICByZXR1cm4gcmVmZXJlbmNlRm9yS2V5KGNvbXBvbmVudCwgcGFydHNbMF0pOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlZmVyZW5jZUZyb21QYXJ0cyhjb21wb25lbnRbUk9PVF9SRUZdLCBwYXJ0cyk7CiAgfSAvLyBUT0RPIHdlIHNob3VsZCBwcm9iYWJseSBkbyB0aGlzIHRyYW5zZm9ybSBhdCBidWlsZCB0aW1lCgoKICBmdW5jdGlvbiB3cmFwQ29tcG9uZW50Q2xhc3NBdHRyaWJ1dGUoaGFzaCkgewogICAgaWYgKGhhc2ggPT09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBrZXlzID0gaGFzaFswXSwKICAgICAgICB2YWx1ZXMgPSBoYXNoWzFdOwogICAgdmFyIGluZGV4ID0ga2V5cyA9PT0gbnVsbCA/IC0xIDoga2V5cy5pbmRleE9mKCdjbGFzcycpOwoKICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgdmFyIHZhbHVlJCQxID0gdmFsdWVzW2luZGV4XTsKCiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZSQkMSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciB0eXBlID0gdmFsdWUkJDFbMF07CgogICAgICBpZiAodHlwZSA9PT0gX3dpcmVGb3JtYXQuT3BzLkdldCB8fCB0eXBlID09PSBfd2lyZUZvcm1hdC5PcHMuTWF5YmVMb2NhbCkgewogICAgICAgIHZhciBwYXRoID0gdmFsdWUkJDFbdmFsdWUkJDEubGVuZ3RoIC0gMV07CiAgICAgICAgdmFyIHByb3BOYW1lID0gcGF0aFtwYXRoLmxlbmd0aCAtIDFdOwogICAgICAgIHZhbHVlc1tpbmRleF0gPSBbX3dpcmVGb3JtYXQuT3BzLkhlbHBlciwgJy1jbGFzcycsIFt2YWx1ZSQkMSwgcHJvcE5hbWVdLCBudWxsXTsKICAgICAgfQogICAgfQogIH0KCiAgdmFyIEF0dHJpYnV0ZUJpbmRpbmcgPSB7CiAgICBwYXJzZTogZnVuY3Rpb24gcGFyc2UobWljcm9zeW50YXgpIHsKICAgICAgdmFyIGNvbG9uSW5kZXggPSBtaWNyb3N5bnRheC5pbmRleE9mKCc6Jyk7CgogICAgICBpZiAoY29sb25JbmRleCA9PT0gLTEpIHsKICAgICAgICAoZmFsc2UgJiYgIShtaWNyb3N5bnRheCAhPT0gJ2NsYXNzJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgY2Fubm90IHVzZSBjbGFzcyBhcyBhbiBhdHRyaWJ1dGVCaW5kaW5nLCB1c2UgY2xhc3NOYW1lQmluZGluZ3MgaW5zdGVhZC4nLCBtaWNyb3N5bnRheCAhPT0gJ2NsYXNzJykpOwogICAgICAgIHJldHVybiBbbWljcm9zeW50YXgsIG1pY3Jvc3ludGF4LCB0cnVlXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcHJvcCA9IG1pY3Jvc3ludGF4LnN1YnN0cmluZygwLCBjb2xvbkluZGV4KTsKICAgICAgICB2YXIgYXR0cmlidXRlID0gbWljcm9zeW50YXguc3Vic3RyaW5nKGNvbG9uSW5kZXggKyAxKTsKICAgICAgICAoZmFsc2UgJiYgIShhdHRyaWJ1dGUgIT09ICdjbGFzcycpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGNhbm5vdCB1c2UgY2xhc3MgYXMgYW4gYXR0cmlidXRlQmluZGluZywgdXNlIGNsYXNzTmFtZUJpbmRpbmdzIGluc3RlYWQuJywgYXR0cmlidXRlICE9PSAnY2xhc3MnKSk7CiAgICAgICAgcmV0dXJuIFtwcm9wLCBhdHRyaWJ1dGUsIGZhbHNlXTsKICAgICAgfQogICAgfSwKICAgIGluc3RhbGw6IGZ1bmN0aW9uIGluc3RhbGwoX2VsZW1lbnQsIGNvbXBvbmVudCwgcGFyc2VkLCBvcGVyYXRpb25zKSB7CiAgICAgIHZhciBwcm9wID0gcGFyc2VkWzBdLAogICAgICAgICAgYXR0cmlidXRlID0gcGFyc2VkWzFdLAogICAgICAgICAgaXNTaW1wbGUgPSBwYXJzZWRbMl07CgogICAgICBpZiAoYXR0cmlidXRlID09PSAnaWQnKSB7CiAgICAgICAgdmFyIGVsZW1lbnRJZCA9ICgwLCBfbWV0YWwuZ2V0KShjb21wb25lbnQsIHByb3ApOwoKICAgICAgICBpZiAoZWxlbWVudElkID09PSB1bmRlZmluZWQgfHwgZWxlbWVudElkID09PSBudWxsKSB7CiAgICAgICAgICBlbGVtZW50SWQgPSBjb21wb25lbnQuZWxlbWVudElkOwogICAgICAgIH0KCiAgICAgICAgZWxlbWVudElkID0gX3J1bnRpbWUyLlByaW1pdGl2ZVJlZmVyZW5jZS5jcmVhdGUoZWxlbWVudElkKTsKICAgICAgICBvcGVyYXRpb25zLnNldEF0dHJpYnV0ZSgnaWQnLCBlbGVtZW50SWQsIHRydWUsIG51bGwpOyAvLyBvcGVyYXRpb25zLmFkZFN0YXRpY0F0dHJpYnV0ZShlbGVtZW50LCAnaWQnLCBlbGVtZW50SWQpOwoKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBpc1BhdGggPSBwcm9wLmluZGV4T2YoJy4nKSA+IC0xOwogICAgICB2YXIgcmVmZXJlbmNlID0gaXNQYXRoID8gcmVmZXJlbmNlRm9yUGFydHMoY29tcG9uZW50LCBwcm9wLnNwbGl0KCcuJykpIDogcmVmZXJlbmNlRm9yS2V5KGNvbXBvbmVudCwgcHJvcCk7CiAgICAgIChmYWxzZSAmJiAhKCEoaXNTaW1wbGUgJiYgaXNQYXRoKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJJbGxlZ2FsIGF0dHJpYnV0ZUJpbmRpbmc6ICciICsgcHJvcCArICInIGlzIG5vdCBhIHZhbGlkIGF0dHJpYnV0ZSBuYW1lLiIsICEoaXNTaW1wbGUgJiYgaXNQYXRoKSkpOwoKICAgICAgaWYgKGF0dHJpYnV0ZSA9PT0gJ3N0eWxlJykgewogICAgICAgIHJlZmVyZW5jZSA9IG5ldyBTdHlsZUJpbmRpbmdSZWZlcmVuY2UocmVmZXJlbmNlLCByZWZlcmVuY2VGb3JLZXkoY29tcG9uZW50LCAnaXNWaXNpYmxlJykpOwogICAgICB9CgogICAgICBvcGVyYXRpb25zLnNldEF0dHJpYnV0ZShhdHRyaWJ1dGUsIHJlZmVyZW5jZSwgZmFsc2UsIG51bGwpOyAvLyBvcGVyYXRpb25zLmFkZER5bmFtaWNBdHRyaWJ1dGUoZWxlbWVudCwgYXR0cmlidXRlLCByZWZlcmVuY2UsIGZhbHNlKTsKICAgIH0KICB9OwogIHZhciBESVNQTEFZX05PTkUgPSAnZGlzcGxheTogbm9uZTsnOwogIHZhciBTQUZFX0RJU1BMQVlfTk9ORSA9IGh0bWxTYWZlKERJU1BMQVlfTk9ORSk7CgogIHZhciBTdHlsZUJpbmRpbmdSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0NhY2hlZFJlZmVyZW5jZSkgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKFN0eWxlQmluZGluZ1JlZmVyZW5jZSwgX0NhY2hlZFJlZmVyZW5jZSk7CgogICAgZnVuY3Rpb24gU3R5bGVCaW5kaW5nUmVmZXJlbmNlKGlubmVyLCBpc1Zpc2libGUpIHsKICAgICAgdmFyIF90aGlzMTc7CgogICAgICBfdGhpczE3ID0gX0NhY2hlZFJlZmVyZW5jZS5jYWxsKHRoaXMpIHx8IHRoaXM7CiAgICAgIF90aGlzMTcuaW5uZXIgPSBpbm5lcjsKICAgICAgX3RoaXMxNy5pc1Zpc2libGUgPSBpc1Zpc2libGU7CiAgICAgIF90aGlzMTcudGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW2lubmVyLnRhZywgaXNWaXNpYmxlLnRhZ10pOwogICAgICByZXR1cm4gX3RoaXMxNzsKICAgIH0KCiAgICB2YXIgX3Byb3RvMzYgPSBTdHlsZUJpbmRpbmdSZWZlcmVuY2UucHJvdG90eXBlOwoKICAgIF9wcm90bzM2LmNvbXB1dGUgPSBmdW5jdGlvbiBjb21wdXRlKCkgewogICAgICB2YXIgdmFsdWUkJDEgPSB0aGlzLmlubmVyLnZhbHVlKCk7CiAgICAgIHZhciBpc1Zpc2libGUgPSB0aGlzLmlzVmlzaWJsZS52YWx1ZSgpOwoKICAgICAgaWYgKGlzVmlzaWJsZSAhPT0gZmFsc2UpIHsKICAgICAgICByZXR1cm4gdmFsdWUkJDE7CiAgICAgIH0gZWxzZSBpZiAoIXZhbHVlJCQxKSB7CiAgICAgICAgcmV0dXJuIFNBRkVfRElTUExBWV9OT05FOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBzdHlsZSA9IHZhbHVlJCQxICsgJyAnICsgRElTUExBWV9OT05FOwogICAgICAgIHJldHVybiBpc0hUTUxTYWZlKHZhbHVlJCQxKSA/IGh0bWxTYWZlKHN0eWxlKSA6IHN0eWxlOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBTdHlsZUJpbmRpbmdSZWZlcmVuY2U7CiAgfShfcmVmZXJlbmNlLkNhY2hlZFJlZmVyZW5jZSk7CgogIHZhciBJc1Zpc2libGVCaW5kaW5nID0gewogICAgaW5zdGFsbDogZnVuY3Rpb24gaW5zdGFsbChfZWxlbWVudCwgY29tcG9uZW50LCBvcGVyYXRpb25zKSB7CiAgICAgIG9wZXJhdGlvbnMuc2V0QXR0cmlidXRlKCdzdHlsZScsICgwLCBfcmVmZXJlbmNlLm1hcCkocmVmZXJlbmNlRm9yS2V5KGNvbXBvbmVudCwgJ2lzVmlzaWJsZScpLCB0aGlzLm1hcFN0eWxlVmFsdWUpLCBmYWxzZSwgbnVsbCk7IC8vIC8vIHRoZSB1cHN0cmVhbSB0eXBlIGZvciBhZGREeW5hbWljQXR0cmlidXRlJ3MgYHZhbHVlYCBhcmd1bWVudAogICAgICAvLyAvLyBhcHBlYXJzIHRvIGJlIGluY29ycmVjdC4gSXQgaXMgY3VycmVudGx5IGEgUmVmZXJlbmNlPHN0cmluZz4sIEkKICAgICAgLy8gLy8gdGhpbmsgaXQgc2hvdWxkIGJlIGEgUmVmZXJlbmNlPHN0cmluZ3xudWxsPi4KICAgICAgLy8gb3BlcmF0aW9ucy5hZGREeW5hbWljQXR0cmlidXRlKGVsZW1lbnQsICdzdHlsZScsIHJlZiBhcyBhbnkgYXMgUmVmZXJlbmNlPHN0cmluZz4sIGZhbHNlKTsKICAgIH0sCiAgICBtYXBTdHlsZVZhbHVlOiBmdW5jdGlvbiBtYXBTdHlsZVZhbHVlKGlzVmlzaWJsZSkgewogICAgICByZXR1cm4gaXNWaXNpYmxlID09PSBmYWxzZSA/IFNBRkVfRElTUExBWV9OT05FIDogbnVsbDsKICAgIH0KICB9OwogIHZhciBDbGFzc05hbWVCaW5kaW5nID0gewogICAgaW5zdGFsbDogZnVuY3Rpb24gaW5zdGFsbChfZWxlbWVudCwgY29tcG9uZW50LCBtaWNyb3N5bnRheCwgb3BlcmF0aW9ucykgewogICAgICB2YXIgX21pY3Jvc3ludGF4JHNwbGl0ID0gbWljcm9zeW50YXguc3BsaXQoJzonKSwKICAgICAgICAgIHByb3AgPSBfbWljcm9zeW50YXgkc3BsaXRbMF0sCiAgICAgICAgICB0cnV0aHkgPSBfbWljcm9zeW50YXgkc3BsaXRbMV0sCiAgICAgICAgICBmYWxzeSA9IF9taWNyb3N5bnRheCRzcGxpdFsyXTsKCiAgICAgIHZhciBpc1N0YXRpYyA9IHByb3AgPT09ICcnOwoKICAgICAgaWYgKGlzU3RhdGljKSB7CiAgICAgICAgb3BlcmF0aW9ucy5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgX3J1bnRpbWUyLlByaW1pdGl2ZVJlZmVyZW5jZS5jcmVhdGUodHJ1dGh5KSwgdHJ1ZSwgbnVsbCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGlzUGF0aCA9IHByb3AuaW5kZXhPZignLicpID4gLTE7CiAgICAgICAgdmFyIHBhcnRzID0gaXNQYXRoID8gcHJvcC5zcGxpdCgnLicpIDogW107CiAgICAgICAgdmFyIHZhbHVlJCQxID0gaXNQYXRoID8gcmVmZXJlbmNlRm9yUGFydHMoY29tcG9uZW50LCBwYXJ0cykgOiByZWZlcmVuY2VGb3JLZXkoY29tcG9uZW50LCBwcm9wKTsKICAgICAgICB2YXIgcmVmOwoKICAgICAgICBpZiAodHJ1dGh5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJlZiA9IG5ldyBTaW1wbGVDbGFzc05hbWVCaW5kaW5nUmVmZXJlbmNlKHZhbHVlJCQxLCBpc1BhdGggPyBwYXJ0c1twYXJ0cy5sZW5ndGggLSAxXSA6IHByb3ApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZWYgPSBuZXcgQ29sb25DbGFzc05hbWVCaW5kaW5nUmVmZXJlbmNlKHZhbHVlJCQxLCB0cnV0aHksIGZhbHN5KTsKICAgICAgICB9CgogICAgICAgIG9wZXJhdGlvbnMuc2V0QXR0cmlidXRlKCdjbGFzcycsIHJlZiwgZmFsc2UsIG51bGwpOyAvLyAvLyB0aGUgdXBzdHJlYW0gdHlwZSBmb3IgYWRkRHluYW1pY0F0dHJpYnV0ZSdzIGB2YWx1ZWAgYXJndW1lbnQKICAgICAgICAvLyAvLyBhcHBlYXJzIHRvIGJlIGluY29ycmVjdC4gSXQgaXMgY3VycmVudGx5IGEgUmVmZXJlbmNlPHN0cmluZz4sIEkKICAgICAgICAvLyAvLyB0aGluayBpdCBzaG91bGQgYmUgYSBSZWZlcmVuY2U8c3RyaW5nfG51bGw+LgogICAgICAgIC8vIG9wZXJhdGlvbnMuYWRkRHluYW1pY0F0dHJpYnV0ZShlbGVtZW50LCAnY2xhc3MnLCByZWYgYXMgYW55IGFzIFJlZmVyZW5jZTxzdHJpbmc+LCBmYWxzZSk7CiAgICAgIH0KICAgIH0KICB9OwoKICB2YXIgU2ltcGxlQ2xhc3NOYW1lQmluZGluZ1JlZmVyZW5jZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfQ2FjaGVkUmVmZXJlbmNlMikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKFNpbXBsZUNsYXNzTmFtZUJpbmRpbmdSZWZlcmVuY2UsIF9DYWNoZWRSZWZlcmVuY2UyKTsKCiAgICBmdW5jdGlvbiBTaW1wbGVDbGFzc05hbWVCaW5kaW5nUmVmZXJlbmNlKGlubmVyLCBwYXRoKSB7CiAgICAgIHZhciBfdGhpczE4OwoKICAgICAgX3RoaXMxOCA9IF9DYWNoZWRSZWZlcmVuY2UyLmNhbGwodGhpcykgfHwgdGhpczsKICAgICAgX3RoaXMxOC5pbm5lciA9IGlubmVyOwogICAgICBfdGhpczE4LnBhdGggPSBwYXRoOwogICAgICBfdGhpczE4LnRhZyA9IGlubmVyLnRhZzsKICAgICAgX3RoaXMxOC5pbm5lciA9IGlubmVyOwogICAgICBfdGhpczE4LnBhdGggPSBwYXRoOwogICAgICBfdGhpczE4LmRhc2hlcml6ZWRQYXRoID0gbnVsbDsKICAgICAgcmV0dXJuIF90aGlzMTg7CiAgICB9CgogICAgdmFyIF9wcm90bzM3ID0gU2ltcGxlQ2xhc3NOYW1lQmluZGluZ1JlZmVyZW5jZS5wcm90b3R5cGU7CgogICAgX3Byb3RvMzcuY29tcHV0ZSA9IGZ1bmN0aW9uIGNvbXB1dGUoKSB7CiAgICAgIHZhciB2YWx1ZSQkMSA9IHRoaXMuaW5uZXIudmFsdWUoKTsKCiAgICAgIGlmICh2YWx1ZSQkMSA9PT0gdHJ1ZSkgewogICAgICAgIHZhciBwYXRoID0gdGhpcy5wYXRoLAogICAgICAgICAgICBkYXNoZXJpemVkUGF0aCA9IHRoaXMuZGFzaGVyaXplZFBhdGg7CiAgICAgICAgcmV0dXJuIGRhc2hlcml6ZWRQYXRoIHx8ICh0aGlzLmRhc2hlcml6ZWRQYXRoID0gKDAsIF9zdHJpbmcuZGFzaGVyaXplKShwYXRoKSk7CiAgICAgIH0gZWxzZSBpZiAodmFsdWUkJDEgfHwgdmFsdWUkJDEgPT09IDApIHsKICAgICAgICByZXR1cm4gU3RyaW5nKHZhbHVlJCQxKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gU2ltcGxlQ2xhc3NOYW1lQmluZGluZ1JlZmVyZW5jZTsKICB9KF9yZWZlcmVuY2UuQ2FjaGVkUmVmZXJlbmNlKTsKCiAgdmFyIENvbG9uQ2xhc3NOYW1lQmluZGluZ1JlZmVyZW5jZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfQ2FjaGVkUmVmZXJlbmNlMykgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKENvbG9uQ2xhc3NOYW1lQmluZGluZ1JlZmVyZW5jZSwgX0NhY2hlZFJlZmVyZW5jZTMpOwoKICAgIGZ1bmN0aW9uIENvbG9uQ2xhc3NOYW1lQmluZGluZ1JlZmVyZW5jZShpbm5lciwgdHJ1dGh5LCBmYWxzeSkgewogICAgICB2YXIgX3RoaXMxOTsKCiAgICAgIGlmICh0cnV0aHkgPT09IHZvaWQgMCkgewogICAgICAgIHRydXRoeSA9IG51bGw7CiAgICAgIH0KCiAgICAgIGlmIChmYWxzeSA9PT0gdm9pZCAwKSB7CiAgICAgICAgZmFsc3kgPSBudWxsOwogICAgICB9CgogICAgICBfdGhpczE5ID0gX0NhY2hlZFJlZmVyZW5jZTMuY2FsbCh0aGlzKSB8fCB0aGlzOwogICAgICBfdGhpczE5LmlubmVyID0gaW5uZXI7CiAgICAgIF90aGlzMTkudHJ1dGh5ID0gdHJ1dGh5OwogICAgICBfdGhpczE5LmZhbHN5ID0gZmFsc3k7CiAgICAgIF90aGlzMTkudGFnID0gaW5uZXIudGFnOwogICAgICByZXR1cm4gX3RoaXMxOTsKICAgIH0KCiAgICB2YXIgX3Byb3RvMzggPSBDb2xvbkNsYXNzTmFtZUJpbmRpbmdSZWZlcmVuY2UucHJvdG90eXBlOwoKICAgIF9wcm90bzM4LmNvbXB1dGUgPSBmdW5jdGlvbiBjb21wdXRlKCkgewogICAgICB2YXIgaW5uZXIgPSB0aGlzLmlubmVyLAogICAgICAgICAgdHJ1dGh5ID0gdGhpcy50cnV0aHksCiAgICAgICAgICBmYWxzeSA9IHRoaXMuZmFsc3k7CiAgICAgIHJldHVybiBpbm5lci52YWx1ZSgpID8gdHJ1dGh5IDogZmFsc3k7CiAgICB9OwoKICAgIHJldHVybiBDb2xvbkNsYXNzTmFtZUJpbmRpbmdSZWZlcmVuY2U7CiAgfShfcmVmZXJlbmNlLkNhY2hlZFJlZmVyZW5jZSk7IC8vIGlucHV0cyBuZWVkZWQgYnkgQ3VybHlDb21wb25lbnRzIChhdHRycyBhbmQgcHJvcHMsIHdpdGggbXV0YWJsZQogIC8vIGNlbGxzLCBldGMpLgoKCiAgZnVuY3Rpb24gcHJvY2Vzc0NvbXBvbmVudEFyZ3MobmFtZWRBcmdzKSB7CiAgICB2YXIga2V5cyA9IG5hbWVkQXJncy5uYW1lczsKICAgIHZhciBhdHRycyA9IG5hbWVkQXJncy52YWx1ZSgpOwogICAgdmFyIHByb3BzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHZhciBhcmdzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHByb3BzW0FSR1NdID0gYXJnczsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIG5hbWUgPSBrZXlzW2ldOwogICAgICB2YXIgcmVmID0gbmFtZWRBcmdzLmdldChuYW1lKTsKICAgICAgdmFyIHZhbHVlJCQxID0gYXR0cnNbbmFtZV07CgogICAgICBpZiAodHlwZW9mIHZhbHVlJCQxID09PSAnZnVuY3Rpb24nICYmIHZhbHVlJCQxW0FDVElPTl0pIHsKICAgICAgICBhdHRyc1tuYW1lXSA9IHZhbHVlJCQxOwogICAgICB9IGVsc2UgaWYgKHJlZltVUERBVEVdKSB7CiAgICAgICAgYXR0cnNbbmFtZV0gPSBuZXcgTXV0YWJsZUNlbGwocmVmLCB2YWx1ZSQkMSk7CiAgICAgIH0KCiAgICAgIGFyZ3NbbmFtZV0gPSByZWY7CiAgICAgIHByb3BzW25hbWVdID0gdmFsdWUkJDE7CiAgICB9CgogICAgcHJvcHMuYXR0cnMgPSBhdHRyczsKICAgIHJldHVybiBwcm9wczsKICB9CgogIHZhciBSRUYgPSAoMCwgX3V0aWxzLnN5bWJvbCkoJ1JFRicpOwoKICB2YXIgTXV0YWJsZUNlbGwgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBNdXRhYmxlQ2VsbChyZWYsIHZhbHVlJCQxKSB7CiAgICAgIHRoaXNbX3ZpZXdzLk1VVEFCTEVfQ0VMTF0gPSB0cnVlOwogICAgICB0aGlzW1JFRl0gPSByZWY7CiAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZSQkMTsKICAgIH0KCiAgICB2YXIgX3Byb3RvMzkgPSBNdXRhYmxlQ2VsbC5wcm90b3R5cGU7CgogICAgX3Byb3RvMzkudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlKHZhbCkgewogICAgICB0aGlzW1JFRl1bVVBEQVRFXSh2YWwpOwogICAgfTsKCiAgICByZXR1cm4gTXV0YWJsZUNlbGw7CiAgfSgpOwoKICBmdW5jdGlvbiBhbGlhc0lkVG9FbGVtZW50SWQoYXJncywgcHJvcHMpIHsKICAgIGlmIChhcmdzLm5hbWVkLmhhcygnaWQnKSkgewogICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoCiAgICAgIChmYWxzZSAmJiAhKCFhcmdzLm5hbWVkLmhhcygnZWxlbWVudElkJykpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IGNhbm5vdCBpbnZva2UgYSBjb21wb25lbnQgd2l0aCBib3RoICdpZCcgYW5kICdlbGVtZW50SWQnIGF0IHRoZSBzYW1lIHRpbWUuIiwgIWFyZ3MubmFtZWQuaGFzKCdlbGVtZW50SWQnKSkpOwogICAgICBwcm9wcy5lbGVtZW50SWQgPSBwcm9wcy5pZDsKICAgIH0KICB9IC8vIFdlIG11c3QgdHJhdmVyc2UgdGhlIGF0dHJpYnV0ZUJpbmRpbmdzIGluIHJldmVyc2Uga2VlcGluZyB0cmFjayBvZgogIC8vIHdoYXQgaGFzIGFscmVhZHkgYmVlbiBhcHBsaWVkLiBUaGlzIGlzIGVzc2VudGlhbGx5IHJlZmluaW5nIHRoZSBjb25jYXRlbmF0ZWQKICAvLyBwcm9wZXJ0aWVzIGFwcGx5aW5nIHJpZ2h0IHRvIGxlZnQuCgoKICBmdW5jdGlvbiBhcHBseUF0dHJpYnV0ZUJpbmRpbmdzKGVsZW1lbnQsIGF0dHJpYnV0ZUJpbmRpbmdzLCBjb21wb25lbnQsIG9wZXJhdGlvbnMpIHsKICAgIHZhciBzZWVuID0gW107CiAgICB2YXIgaSA9IGF0dHJpYnV0ZUJpbmRpbmdzLmxlbmd0aCAtIDE7CgogICAgd2hpbGUgKGkgIT09IC0xKSB7CiAgICAgIHZhciBiaW5kaW5nID0gYXR0cmlidXRlQmluZGluZ3NbaV07CiAgICAgIHZhciBwYXJzZWQgPSBBdHRyaWJ1dGVCaW5kaW5nLnBhcnNlKGJpbmRpbmcpOwogICAgICB2YXIgYXR0cmlidXRlID0gcGFyc2VkWzFdOwoKICAgICAgaWYgKHNlZW4uaW5kZXhPZihhdHRyaWJ1dGUpID09PSAtMSkgewogICAgICAgIHNlZW4ucHVzaChhdHRyaWJ1dGUpOwogICAgICAgIEF0dHJpYnV0ZUJpbmRpbmcuaW5zdGFsbChlbGVtZW50LCBjb21wb25lbnQsIHBhcnNlZCwgb3BlcmF0aW9ucyk7CiAgICAgIH0KCiAgICAgIGktLTsKICAgIH0KCiAgICBpZiAoc2Vlbi5pbmRleE9mKCdpZCcpID09PSAtMSkgewogICAgICB2YXIgaWQkJDEgPSBjb21wb25lbnQuZWxlbWVudElkID8gY29tcG9uZW50LmVsZW1lbnRJZCA6ICgwLCBfdXRpbHMuZ3VpZEZvcikoY29tcG9uZW50KTsKICAgICAgb3BlcmF0aW9ucy5zZXRBdHRyaWJ1dGUoJ2lkJywgX3J1bnRpbWUyLlByaW1pdGl2ZVJlZmVyZW5jZS5jcmVhdGUoaWQkJDEpLCBmYWxzZSwgbnVsbCk7CiAgICB9CgogICAgaWYgKHNlZW4uaW5kZXhPZignc3R5bGUnKSA9PT0gLTEpIHsKICAgICAgSXNWaXNpYmxlQmluZGluZy5pbnN0YWxsKGVsZW1lbnQsIGNvbXBvbmVudCwgb3BlcmF0aW9ucyk7CiAgICB9CiAgfQoKICB2YXIgREVGQVVMVF9MQVlPVVQgPSAoMCwgX2NvbnRhaW5lci5wcml2YXRpemUpKF90ZW1wbGF0ZU9iamVjdDIoKSk7CiAgdmFyIEVNUFRZX1BPU0lUSU9OQUxfQVJHUyA9IFtdOwogICgwLCBfZGVidWcuZGVidWdGcmVlemUpKEVNUFRZX1BPU0lUSU9OQUxfQVJHUyk7CgogIHZhciBDdXJseUNvbXBvbmVudE1hbmFnZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0Fic3RyYWN0TWFuYWdlcjIpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShDdXJseUNvbXBvbmVudE1hbmFnZXIsIF9BYnN0cmFjdE1hbmFnZXIyKTsKCiAgICBmdW5jdGlvbiBDdXJseUNvbXBvbmVudE1hbmFnZXIoKSB7CiAgICAgIHJldHVybiBfQWJzdHJhY3RNYW5hZ2VyMi5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICB9CgogICAgdmFyIF9wcm90bzQwID0gQ3VybHlDb21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZTsKCiAgICBfcHJvdG80MC5nZXRMYXlvdXQgPSBmdW5jdGlvbiBnZXRMYXlvdXQoc3RhdGUsIF9yZXNvbHZlcikgewogICAgICByZXR1cm4gewogICAgICAgIC8vIFRPRE8gZml4CiAgICAgICAgaGFuZGxlOiBzdGF0ZS5oYW5kbGUsCiAgICAgICAgc3ltYm9sVGFibGU6IHN0YXRlLnN5bWJvbFRhYmxlCiAgICAgIH07CiAgICB9OwoKICAgIF9wcm90bzQwLnRlbXBsYXRlRm9yID0gZnVuY3Rpb24gdGVtcGxhdGVGb3IoY29tcG9uZW50KSB7CiAgICAgIHZhciBsYXlvdXQgPSBjb21wb25lbnQubGF5b3V0LAogICAgICAgICAgbGF5b3V0TmFtZSA9IGNvbXBvbmVudC5sYXlvdXROYW1lOwogICAgICB2YXIgb3duZXIgPSAoMCwgX293bmVyLmdldE93bmVyKShjb21wb25lbnQpOwogICAgICB2YXIgZmFjdG9yeTsKCiAgICAgIGlmIChsYXlvdXQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmIChsYXlvdXROYW1lICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciBfZmFjdG9yeSA9IG93bmVyLmxvb2t1cCgidGVtcGxhdGU6IiArIGxheW91dE5hbWUpOwoKICAgICAgICAgIChmYWxzZSAmJiAhKF9mYWN0b3J5ICE9PSB1bmRlZmluZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiTGF5b3V0IGAiICsgbGF5b3V0TmFtZSArICJgIG5vdCBmb3VuZCEiLCBfZmFjdG9yeSAhPT0gdW5kZWZpbmVkKSk7CiAgICAgICAgICBmYWN0b3J5ID0gX2ZhY3Rvcnk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZhY3RvcnkgPSBvd25lci5sb29rdXAoREVGQVVMVF9MQVlPVVQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpc1RlbXBsYXRlRmFjdG9yeShsYXlvdXQpKSB7CiAgICAgICAgZmFjdG9yeSA9IGxheW91dDsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB3ZSB3ZXJlIHByb3ZpZGVkIGFuIGluc3RhbmNlIGFscmVhZHkKICAgICAgICByZXR1cm4gbGF5b3V0OwogICAgICB9CgogICAgICByZXR1cm4gZmFjdG9yeShvd25lcik7CiAgICB9OwoKICAgIF9wcm90bzQwLmdldER5bmFtaWNMYXlvdXQgPSBmdW5jdGlvbiBnZXREeW5hbWljTGF5b3V0KF9yZWYzKSB7CiAgICAgIHZhciBjb21wb25lbnQgPSBfcmVmMy5jb21wb25lbnQ7CiAgICAgIHZhciB0ZW1wbGF0ZSQkMSA9IHRoaXMudGVtcGxhdGVGb3IoY29tcG9uZW50KTsKICAgICAgdmFyIGxheW91dCA9IHRlbXBsYXRlJCQxLmFzV3JhcHBlZExheW91dCgpOwogICAgICByZXR1cm4gewogICAgICAgIGhhbmRsZTogbGF5b3V0LmNvbXBpbGUoKSwKICAgICAgICBzeW1ib2xUYWJsZTogbGF5b3V0LnN5bWJvbFRhYmxlCiAgICAgIH07CiAgICB9OwoKICAgIF9wcm90bzQwLmdldFRhZ05hbWUgPSBmdW5jdGlvbiBnZXRUYWdOYW1lKHN0YXRlKSB7CiAgICAgIHZhciBjb21wb25lbnQgPSBzdGF0ZS5jb21wb25lbnQsCiAgICAgICAgICBoYXNXcmFwcGVkRWxlbWVudCA9IHN0YXRlLmhhc1dyYXBwZWRFbGVtZW50OwoKICAgICAgaWYgKCFoYXNXcmFwcGVkRWxlbWVudCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICByZXR1cm4gY29tcG9uZW50ICYmIGNvbXBvbmVudC50YWdOYW1lIHx8ICdkaXYnOwogICAgfTsKCiAgICBfcHJvdG80MC5nZXRDYXBhYmlsaXRpZXMgPSBmdW5jdGlvbiBnZXRDYXBhYmlsaXRpZXMoc3RhdGUpIHsKICAgICAgcmV0dXJuIHN0YXRlLmNhcGFiaWxpdGllczsKICAgIH07CgogICAgX3Byb3RvNDAucHJlcGFyZUFyZ3MgPSBmdW5jdGlvbiBwcmVwYXJlQXJncyhzdGF0ZSwgYXJncykgewogICAgICBpZiAoYXJncy5uYW1lZC5oYXMoJ19fQVJHU19fJykpIHsKICAgICAgICB2YXIgX19hcmdzX18gPSBhcmdzLm5hbWVkLmdldCgnX19BUkdTX18nKS52YWx1ZSgpOwoKICAgICAgICB2YXIgcHJlcGFyZWQgPSB7CiAgICAgICAgICBwb3NpdGlvbmFsOiBFTVBUWV9QT1NJVElPTkFMX0FSR1MsCiAgICAgICAgICBuYW1lZDogKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7fSwgYXJncy5uYW1lZC5jYXB0dXJlKCkubWFwLCBfX2FyZ3NfXykKICAgICAgICB9OwoKICAgICAgICBpZiAoZmFsc2UKICAgICAgICAvKiBERUJVRyAqLwogICAgICAgICkgewogICAgICAgICAgZGVsZXRlIHByZXBhcmVkLm5hbWVkLl9fQVJHU19fOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHByZXBhcmVkOwogICAgICB9CgogICAgICB2YXIgcG9zaXRpb25hbFBhcmFtcyA9IHN0YXRlLkNvbXBvbmVudENsYXNzLmNsYXNzLnBvc2l0aW9uYWxQYXJhbXM7IC8vIGVhcmx5IGV4aXRzCgogICAgICBpZiAocG9zaXRpb25hbFBhcmFtcyA9PT0gdW5kZWZpbmVkIHx8IHBvc2l0aW9uYWxQYXJhbXMgPT09IG51bGwgfHwgYXJncy5wb3NpdGlvbmFsLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICB2YXIgbmFtZWQ7CgogICAgICBpZiAodHlwZW9mIHBvc2l0aW9uYWxQYXJhbXMgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdmFyIF9uYW1lZDsKCiAgICAgICAgKGZhbHNlICYmICEoIWFyZ3MubmFtZWQuaGFzKHBvc2l0aW9uYWxQYXJhbXMpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIllvdSBjYW5ub3Qgc3BlY2lmeSBwb3NpdGlvbmFsIHBhcmFtZXRlcnMgYW5kIHRoZSBoYXNoIGFyZ3VtZW50IGAiICsgcG9zaXRpb25hbFBhcmFtcyArICJgLiIsICFhcmdzLm5hbWVkLmhhcyhwb3NpdGlvbmFsUGFyYW1zKSkpOwogICAgICAgIG5hbWVkID0gKF9uYW1lZCA9IHt9LCBfbmFtZWRbcG9zaXRpb25hbFBhcmFtc10gPSBhcmdzLnBvc2l0aW9uYWwuY2FwdHVyZSgpLCBfbmFtZWQpOwogICAgICAgICgwLCBfcG9seWZpbGxzLmFzc2lnbikobmFtZWQsIGFyZ3MubmFtZWQuY2FwdHVyZSgpLm1hcCk7CiAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShwb3NpdGlvbmFsUGFyYW1zKSAmJiBwb3NpdGlvbmFsUGFyYW1zLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgY291bnQgPSBNYXRoLm1pbihwb3NpdGlvbmFsUGFyYW1zLmxlbmd0aCwgYXJncy5wb3NpdGlvbmFsLmxlbmd0aCk7CiAgICAgICAgbmFtZWQgPSB7fTsKICAgICAgICAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKG5hbWVkLCBhcmdzLm5hbWVkLmNhcHR1cmUoKS5tYXApOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgIHZhciBuYW1lID0gcG9zaXRpb25hbFBhcmFtc1tpXTsKICAgICAgICAgIChmYWxzZSAmJiAhKCFhcmdzLm5hbWVkLmhhcyhuYW1lKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJZb3UgY2Fubm90IHNwZWNpZnkgYm90aCBhIHBvc2l0aW9uYWwgcGFyYW0gKGF0IHBvc2l0aW9uICIgKyBpICsgIikgYW5kIHRoZSBoYXNoIGFyZ3VtZW50IGAiICsgbmFtZSArICJgLiIsICFhcmdzLm5hbWVkLmhhcyhuYW1lKSkpOwogICAgICAgICAgbmFtZWRbbmFtZV0gPSBhcmdzLnBvc2l0aW9uYWwuYXQoaSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIHBvc2l0aW9uYWw6IF91dGlsLkVNUFRZX0FSUkFZLAogICAgICAgIG5hbWVkOiBuYW1lZAogICAgICB9OwogICAgfQogICAgLyoKICAgICAqIFRoaXMgaG9vayBpcyByZXNwb25zaWJsZSBmb3IgYWN0dWFsbHkgaW5zdGFudGlhdGluZyB0aGUgY29tcG9uZW50IGluc3RhbmNlLgogICAgICogSXQgYWxzbyBpcyB3aGVyZSB3ZSBwZXJmb3JtIGFkZGl0aW9uYWwgYm9va2tlZXBpbmcgdG8gc3VwcG9ydCBsZWdhY3kKICAgICAqIGZlYXR1cmVzIGxpa2UgZXhwb3NlZCBieSB2aWV3IG1peGlucyBsaWtlIENoaWxkVmlld1N1cHBvcnQsIEFjdGlvblN1cHBvcnQsCiAgICAgKiBldGMuCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG80MC5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUoZW52aXJvbm1lbnQsIHN0YXRlLCBhcmdzLCBkeW5hbWljU2NvcGUsIGNhbGxlclNlbGZSZWYsIGhhc0Jsb2NrKSB7CiAgICAgIGlmIChmYWxzZQogICAgICAvKiBERUJVRyAqLwogICAgICApIHsKICAgICAgICBlbnZpcm9ubWVudC5kZWJ1Z1N0YWNrLnB1c2goImNvbXBvbmVudDoiICsgc3RhdGUubmFtZSk7CiAgICAgIH0gLy8gR2V0IHRoZSBuZWFyZXN0IGNvbmNyZXRlIGNvbXBvbmVudCBpbnN0YW5jZSBmcm9tIHRoZSBzY29wZS4gIlZpcnR1YWwiCiAgICAgIC8vIGNvbXBvbmVudHMgd2lsbCBiZSBza2lwcGVkLgoKCiAgICAgIHZhciBwYXJlbnRWaWV3ID0gZHluYW1pY1Njb3BlLnZpZXc7IC8vIEdldCB0aGUgRW1iZXIuQ29tcG9uZW50IHN1YmNsYXNzIHRvIGluc3RhbnRpYXRlIGZvciB0aGlzIGNvbXBvbmVudC4KCiAgICAgIHZhciBmYWN0b3J5ID0gc3RhdGUuQ29tcG9uZW50Q2xhc3M7IC8vIENhcHR1cmUgdGhlIGFyZ3VtZW50cywgd2hpY2ggdGVsbHMgR2xpbW1lciB0byBnaXZlIHVzIG91ciBvd24sIHN0YWJsZQogICAgICAvLyBjb3B5IG9mIHRoZSBBcmd1bWVudHMgb2JqZWN0IHRoYXQgaXMgc2FmZSB0byBob2xkIG9uIHRvIGJldHdlZW4gcmVuZGVycy4KCiAgICAgIHZhciBjYXB0dXJlZEFyZ3MgPSBhcmdzLm5hbWVkLmNhcHR1cmUoKTsKICAgICAgdmFyIHByb3BzID0gcHJvY2Vzc0NvbXBvbmVudEFyZ3MoY2FwdHVyZWRBcmdzKTsgLy8gQWxpYXMgYGlkYCBhcmd1bWVudCB0byBgZWxlbWVudElkYCBwcm9wZXJ0eSBvbiB0aGUgY29tcG9uZW50IGluc3RhbmNlLgoKICAgICAgYWxpYXNJZFRvRWxlbWVudElkKGFyZ3MsIHByb3BzKTsgLy8gU2V0IGNvbXBvbmVudCBpbnN0YW5jZSdzIHBhcmVudFZpZXcgcHJvcGVydHkgdG8gcG9pbnQgdG8gbmVhcmVzdCBjb25jcmV0ZQogICAgICAvLyBjb21wb25lbnQuCgogICAgICBwcm9wcy5wYXJlbnRWaWV3ID0gcGFyZW50VmlldzsgLy8gU2V0IHdoZXRoZXIgdGhpcyBjb21wb25lbnQgd2FzIGludm9rZWQgd2l0aCBhIGJsb2NrCiAgICAgIC8vIChge3sjbXktY29tcG9uZW50fX17ey9teS1jb21wb25lbnR9fWApIG9yIHdpdGhvdXQgb25lCiAgICAgIC8vIChge3tteS1jb21wb25lbnR9fWApLgoKICAgICAgcHJvcHNbSEFTX0JMT0NLXSA9IGhhc0Jsb2NrOyAvLyBTYXZlIHRoZSBjdXJyZW50IGB0aGlzYCBjb250ZXh0IG9mIHRoZSB0ZW1wbGF0ZSBhcyB0aGUgY29tcG9uZW50J3MKICAgICAgLy8gYF90YXJnZXRgLCBzbyBidWJibGVkIGFjdGlvbnMgYXJlIHJvdXRlZCB0byB0aGUgcmlnaHQgcGxhY2UuCgogICAgICBwcm9wcy5fdGFyZ2V0ID0gY2FsbGVyU2VsZlJlZi52YWx1ZSgpOyAvLyBzdGF0aWMgbGF5b3V0IGFzc2VydHMgQ3VycmllZERlZmluaXRpb24KCiAgICAgIGlmIChzdGF0ZS50ZW1wbGF0ZSkgewogICAgICAgIHByb3BzLmxheW91dCA9IHN0YXRlLnRlbXBsYXRlOwogICAgICB9IC8vIGNhbGxlcjoKICAgICAgLy8gPEZhSWNvbiBAbmFtZT0iYnVnIiAvPgogICAgICAvLwogICAgICAvLyBjYWxsZWU6CiAgICAgIC8vIDxpIGNsYXNzPSJmYS17e0BuYW1lfX0iPjwvaT4KICAgICAgLy8gTm93IHRoYXQgd2UndmUgYnVpbHQgdXAgYWxsIG9mIHRoZSBwcm9wZXJ0aWVzIHRvIHNldCBvbiB0aGUgY29tcG9uZW50IGluc3RhbmNlLAogICAgICAvLyBhY3R1YWxseSBjcmVhdGUgaXQuCgoKICAgICAgdmFyIGNvbXBvbmVudCA9IGZhY3RvcnkuY3JlYXRlKHByb3BzKTsKICAgICAgdmFyIGZpbmFsaXplciA9ICgwLCBfaW5zdHJ1bWVudGF0aW9uLl9pbnN0cnVtZW50U3RhcnQpKCdyZW5kZXIuY29tcG9uZW50JywgaW5pdGlhbFJlbmRlckluc3RydW1lbnREZXRhaWxzLCBjb21wb25lbnQpOyAvLyBXZSBiZWNvbWUgdGhlIG5ldyBwYXJlbnRWaWV3IGZvciBkb3duc3RyZWFtIGNvbXBvbmVudHMsIHNvIHNhdmUgb3VyCiAgICAgIC8vIGNvbXBvbmVudCBvZmYgb24gdGhlIGR5bmFtaWMgc2NvcGUuCgogICAgICBkeW5hbWljU2NvcGUudmlldyA9IGNvbXBvbmVudDsgLy8gVW5sZXNzIHdlJ3JlIHRoZSByb290IGNvbXBvbmVudCwgd2UgbmVlZCB0byBhZGQgb3Vyc2VsdmVzIHRvIG91ciBwYXJlbnQKICAgICAgLy8gY29tcG9uZW50J3MgY2hpbGRWaWV3cyBhcnJheS4KCiAgICAgIGlmIChwYXJlbnRWaWV3ICE9PSBudWxsICYmIHBhcmVudFZpZXcgIT09IHVuZGVmaW5lZCkgewogICAgICAgICgwLCBfdmlld3MuYWRkQ2hpbGRWaWV3KShwYXJlbnRWaWV3LCBjb21wb25lbnQpOwogICAgICB9CgogICAgICBjb21wb25lbnQudHJpZ2dlcignZGlkUmVjZWl2ZUF0dHJzJyk7CiAgICAgIHZhciBoYXNXcmFwcGVkRWxlbWVudCA9IGNvbXBvbmVudC50YWdOYW1lICE9PSAnJzsgLy8gV2UgdXN1YWxseSBkbyB0aGlzIGluIHRoZSBgZGlkQ3JlYXRlRWxlbWVudGAsIGJ1dCB0aGF0IGhvb2sgZG9lc24ndCBmaXJlIGZvciB0YWdsZXNzIGNvbXBvbmVudHMKCiAgICAgIGlmICghaGFzV3JhcHBlZEVsZW1lbnQpIHsKICAgICAgICBpZiAoZW52aXJvbm1lbnQuaXNJbnRlcmFjdGl2ZSkgewogICAgICAgICAgY29tcG9uZW50LnRyaWdnZXIoJ3dpbGxSZW5kZXInKTsKICAgICAgICB9CgogICAgICAgIGNvbXBvbmVudC5fdHJhbnNpdGlvblRvKCdoYXNFbGVtZW50Jyk7CgogICAgICAgIGlmIChlbnZpcm9ubWVudC5pc0ludGVyYWN0aXZlKSB7CiAgICAgICAgICBjb21wb25lbnQudHJpZ2dlcignd2lsbEluc2VydEVsZW1lbnQnKTsKICAgICAgICB9CiAgICAgIH0gLy8gVHJhY2sgYWRkaXRpb25hbCBsaWZlY3ljbGUgbWV0YWRhdGEgYWJvdXQgdGhpcyBjb21wb25lbnQgaW4gYSBzdGF0ZSBidWNrZXQuCiAgICAgIC8vIEVzc2VudGlhbGx5IHdlJ3JlIHNhdmluZyBvZmYgYWxsIHRoZSBzdGF0ZSB3ZSdsbCBuZWVkIGluIHRoZSBmdXR1cmUuCgoKICAgICAgdmFyIGJ1Y2tldCA9IG5ldyBDb21wb25lbnRTdGF0ZUJ1Y2tldChlbnZpcm9ubWVudCwgY29tcG9uZW50LCBjYXB0dXJlZEFyZ3MsIGZpbmFsaXplciwgaGFzV3JhcHBlZEVsZW1lbnQpOwoKICAgICAgaWYgKGFyZ3MubmFtZWQuaGFzKCdjbGFzcycpKSB7CiAgICAgICAgYnVja2V0LmNsYXNzUmVmID0gYXJncy5uYW1lZC5nZXQoJ2NsYXNzJyk7CiAgICAgIH0KCiAgICAgIGlmIChmYWxzZQogICAgICAvKiBERUJVRyAqLwogICAgICApIHsKICAgICAgICBwcm9jZXNzQ29tcG9uZW50SW5pdGlhbGl6YXRpb25Bc3NlcnRpb25zKGNvbXBvbmVudCwgcHJvcHMpOwogICAgICB9CgogICAgICBpZiAoZW52aXJvbm1lbnQuaXNJbnRlcmFjdGl2ZSAmJiBoYXNXcmFwcGVkRWxlbWVudCkgewogICAgICAgIGNvbXBvbmVudC50cmlnZ2VyKCd3aWxsUmVuZGVyJyk7CiAgICAgIH0KCiAgICAgIGlmIChfZW52aXJvbm1lbnQyLkVOVi5fREVCVUdfUkVOREVSX1RSRUUpIHsKICAgICAgICBlbnZpcm9ubWVudC5kZWJ1Z1JlbmRlclRyZWUuY3JlYXRlKGJ1Y2tldCwgewogICAgICAgICAgdHlwZTogJ2NvbXBvbmVudCcsCiAgICAgICAgICBuYW1lOiBzdGF0ZS5uYW1lLAogICAgICAgICAgYXJnczogYXJncy5jYXB0dXJlKCksCiAgICAgICAgICBpbnN0YW5jZTogY29tcG9uZW50CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBidWNrZXQ7CiAgICB9OwoKICAgIF9wcm90bzQwLmdldFNlbGYgPSBmdW5jdGlvbiBnZXRTZWxmKF9yZWY0KSB7CiAgICAgIHZhciBjb21wb25lbnQgPSBfcmVmNC5jb21wb25lbnQ7CiAgICAgIHJldHVybiBjb21wb25lbnRbUk9PVF9SRUZdOwogICAgfTsKCiAgICBfcHJvdG80MC5kaWRDcmVhdGVFbGVtZW50ID0gZnVuY3Rpb24gZGlkQ3JlYXRlRWxlbWVudChfcmVmNSwgZWxlbWVudCwgb3BlcmF0aW9ucykgewogICAgICB2YXIgY29tcG9uZW50ID0gX3JlZjUuY29tcG9uZW50LAogICAgICAgICAgY2xhc3NSZWYgPSBfcmVmNS5jbGFzc1JlZiwKICAgICAgICAgIGVudmlyb25tZW50ID0gX3JlZjUuZW52aXJvbm1lbnQ7CiAgICAgICgwLCBfdmlld3Muc2V0Vmlld0VsZW1lbnQpKGNvbXBvbmVudCwgZWxlbWVudCk7CiAgICAgICgwLCBfdmlld3Muc2V0RWxlbWVudFZpZXcpKGVsZW1lbnQsIGNvbXBvbmVudCk7CiAgICAgIHZhciBhdHRyaWJ1dGVCaW5kaW5ncyA9IGNvbXBvbmVudC5hdHRyaWJ1dGVCaW5kaW5ncywKICAgICAgICAgIGNsYXNzTmFtZXMgPSBjb21wb25lbnQuY2xhc3NOYW1lcywKICAgICAgICAgIGNsYXNzTmFtZUJpbmRpbmdzID0gY29tcG9uZW50LmNsYXNzTmFtZUJpbmRpbmdzOwoKICAgICAgaWYgKGF0dHJpYnV0ZUJpbmRpbmdzICYmIGF0dHJpYnV0ZUJpbmRpbmdzLmxlbmd0aCkgewogICAgICAgIGFwcGx5QXR0cmlidXRlQmluZGluZ3MoZWxlbWVudCwgYXR0cmlidXRlQmluZGluZ3MsIGNvbXBvbmVudCwgb3BlcmF0aW9ucyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGlkJCQxID0gY29tcG9uZW50LmVsZW1lbnRJZCA/IGNvbXBvbmVudC5lbGVtZW50SWQgOiAoMCwgX3V0aWxzLmd1aWRGb3IpKGNvbXBvbmVudCk7CiAgICAgICAgb3BlcmF0aW9ucy5zZXRBdHRyaWJ1dGUoJ2lkJywgX3J1bnRpbWUyLlByaW1pdGl2ZVJlZmVyZW5jZS5jcmVhdGUoaWQkJDEpLCBmYWxzZSwgbnVsbCk7CiAgICAgICAgSXNWaXNpYmxlQmluZGluZy5pbnN0YWxsKGVsZW1lbnQsIGNvbXBvbmVudCwgb3BlcmF0aW9ucyk7CiAgICAgIH0KCiAgICAgIGlmIChjbGFzc1JlZikgewogICAgICAgIHZhciByZWYgPSBuZXcgU2ltcGxlQ2xhc3NOYW1lQmluZGluZ1JlZmVyZW5jZShjbGFzc1JlZiwgY2xhc3NSZWZbJ3Byb3BlcnR5S2V5J10pOwogICAgICAgIG9wZXJhdGlvbnMuc2V0QXR0cmlidXRlKCdjbGFzcycsIHJlZiwgZmFsc2UsIG51bGwpOwogICAgICB9CgogICAgICBpZiAoY2xhc3NOYW1lcyAmJiBjbGFzc05hbWVzLmxlbmd0aCkgewogICAgICAgIGNsYXNzTmFtZXMuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgb3BlcmF0aW9ucy5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgX3J1bnRpbWUyLlByaW1pdGl2ZVJlZmVyZW5jZS5jcmVhdGUobmFtZSksIGZhbHNlLCBudWxsKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgaWYgKGNsYXNzTmFtZUJpbmRpbmdzICYmIGNsYXNzTmFtZUJpbmRpbmdzLmxlbmd0aCkgewogICAgICAgIGNsYXNzTmFtZUJpbmRpbmdzLmZvckVhY2goZnVuY3Rpb24gKGJpbmRpbmcpIHsKICAgICAgICAgIENsYXNzTmFtZUJpbmRpbmcuaW5zdGFsbChlbGVtZW50LCBjb21wb25lbnQsIGJpbmRpbmcsIG9wZXJhdGlvbnMpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBvcGVyYXRpb25zLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCBfcnVudGltZTIuUHJpbWl0aXZlUmVmZXJlbmNlLmNyZWF0ZSgnZW1iZXItdmlldycpLCBmYWxzZSwgbnVsbCk7CgogICAgICBpZiAoJ2FyaWFSb2xlJyBpbiBjb21wb25lbnQpIHsKICAgICAgICBvcGVyYXRpb25zLnNldEF0dHJpYnV0ZSgncm9sZScsIHJlZmVyZW5jZUZvcktleShjb21wb25lbnQsICdhcmlhUm9sZScpLCBmYWxzZSwgbnVsbCk7CiAgICAgIH0KCiAgICAgIGNvbXBvbmVudC5fdHJhbnNpdGlvblRvKCdoYXNFbGVtZW50Jyk7CgogICAgICBpZiAoZW52aXJvbm1lbnQuaXNJbnRlcmFjdGl2ZSkgewogICAgICAgIGNvbXBvbmVudC50cmlnZ2VyKCd3aWxsSW5zZXJ0RWxlbWVudCcpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzQwLmRpZFJlbmRlckxheW91dCA9IGZ1bmN0aW9uIGRpZFJlbmRlckxheW91dChidWNrZXQsIGJvdW5kcykgewogICAgICBidWNrZXQuY29tcG9uZW50W0JPVU5EU10gPSBib3VuZHM7CiAgICAgIGJ1Y2tldC5maW5hbGl6ZSgpOwoKICAgICAgaWYgKF9lbnZpcm9ubWVudDIuRU5WLl9ERUJVR19SRU5ERVJfVFJFRSkgewogICAgICAgIGJ1Y2tldC5lbnZpcm9ubWVudC5kZWJ1Z1JlbmRlclRyZWUuZGlkUmVuZGVyKGJ1Y2tldCwgYm91bmRzKTsKICAgICAgfQoKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICkgewogICAgICAgIGJ1Y2tldC5lbnZpcm9ubWVudC5kZWJ1Z1N0YWNrLnBvcCgpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzQwLmdldFRhZyA9IGZ1bmN0aW9uIGdldFRhZyhfcmVmNikgewogICAgICB2YXIgYXJncyA9IF9yZWY2LmFyZ3MsCiAgICAgICAgICBjb21wb25lbnQgPSBfcmVmNi5jb21wb25lbnQ7CiAgICAgIHJldHVybiBhcmdzID8gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW2FyZ3MudGFnLCBjb21wb25lbnRbRElSVFlfVEFHXV0pIDogY29tcG9uZW50W0RJUlRZX1RBR107CiAgICB9OwoKICAgIF9wcm90bzQwLmRpZENyZWF0ZSA9IGZ1bmN0aW9uIGRpZENyZWF0ZShfcmVmNykgewogICAgICB2YXIgY29tcG9uZW50ID0gX3JlZjcuY29tcG9uZW50LAogICAgICAgICAgZW52aXJvbm1lbnQgPSBfcmVmNy5lbnZpcm9ubWVudDsKCiAgICAgIGlmIChlbnZpcm9ubWVudC5pc0ludGVyYWN0aXZlKSB7CiAgICAgICAgY29tcG9uZW50Ll90cmFuc2l0aW9uVG8oJ2luRE9NJyk7CgogICAgICAgIGNvbXBvbmVudC50cmlnZ2VyKCdkaWRJbnNlcnRFbGVtZW50Jyk7CiAgICAgICAgY29tcG9uZW50LnRyaWdnZXIoJ2RpZFJlbmRlcicpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzQwLnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZShidWNrZXQpIHsKICAgICAgdmFyIGNvbXBvbmVudCA9IGJ1Y2tldC5jb21wb25lbnQsCiAgICAgICAgICBhcmdzID0gYnVja2V0LmFyZ3MsCiAgICAgICAgICBhcmdzUmV2aXNpb24gPSBidWNrZXQuYXJnc1JldmlzaW9uLAogICAgICAgICAgZW52aXJvbm1lbnQgPSBidWNrZXQuZW52aXJvbm1lbnQ7CgogICAgICBpZiAoX2Vudmlyb25tZW50Mi5FTlYuX0RFQlVHX1JFTkRFUl9UUkVFKSB7CiAgICAgICAgZW52aXJvbm1lbnQuZGVidWdSZW5kZXJUcmVlLnVwZGF0ZShidWNrZXQpOwogICAgICB9CgogICAgICBpZiAoZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgKSB7CiAgICAgICAgZW52aXJvbm1lbnQuZGVidWdTdGFjay5wdXNoKGNvbXBvbmVudC5fZGVidWdDb250YWluZXJLZXkpOwogICAgICB9CgogICAgICBidWNrZXQuZmluYWxpemVyID0gKDAsIF9pbnN0cnVtZW50YXRpb24uX2luc3RydW1lbnRTdGFydCkoJ3JlbmRlci5jb21wb25lbnQnLCByZXJlbmRlckluc3RydW1lbnREZXRhaWxzLCBjb21wb25lbnQpOwoKICAgICAgaWYgKGFyZ3MgJiYgISgwLCBfcmVmZXJlbmNlLnZhbGlkYXRlKShhcmdzLnRhZywgYXJnc1JldmlzaW9uKSkgewogICAgICAgIHZhciBwcm9wcyA9IHByb2Nlc3NDb21wb25lbnRBcmdzKGFyZ3MpOwogICAgICAgIGJ1Y2tldC5hcmdzUmV2aXNpb24gPSAoMCwgX3JlZmVyZW5jZS52YWx1ZSkoYXJncy50YWcpOwogICAgICAgIGNvbXBvbmVudFtJU19ESVNQQVRDSElOR19BVFRSU10gPSB0cnVlOwogICAgICAgIGNvbXBvbmVudC5zZXRQcm9wZXJ0aWVzKHByb3BzKTsKICAgICAgICBjb21wb25lbnRbSVNfRElTUEFUQ0hJTkdfQVRUUlNdID0gZmFsc2U7CiAgICAgICAgY29tcG9uZW50LnRyaWdnZXIoJ2RpZFVwZGF0ZUF0dHJzJyk7CiAgICAgICAgY29tcG9uZW50LnRyaWdnZXIoJ2RpZFJlY2VpdmVBdHRycycpOwogICAgICB9CgogICAgICBpZiAoZW52aXJvbm1lbnQuaXNJbnRlcmFjdGl2ZSkgewogICAgICAgIGNvbXBvbmVudC50cmlnZ2VyKCd3aWxsVXBkYXRlJyk7CiAgICAgICAgY29tcG9uZW50LnRyaWdnZXIoJ3dpbGxSZW5kZXInKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG80MC5kaWRVcGRhdGVMYXlvdXQgPSBmdW5jdGlvbiBkaWRVcGRhdGVMYXlvdXQoYnVja2V0LCBib3VuZHMpIHsKICAgICAgYnVja2V0LmZpbmFsaXplKCk7CgogICAgICBpZiAoX2Vudmlyb25tZW50Mi5FTlYuX0RFQlVHX1JFTkRFUl9UUkVFKSB7CiAgICAgICAgYnVja2V0LmVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS5kaWRSZW5kZXIoYnVja2V0LCBib3VuZHMpOwogICAgICB9CgogICAgICBpZiAoZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgKSB7CiAgICAgICAgYnVja2V0LmVudmlyb25tZW50LmRlYnVnU3RhY2sucG9wKCk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNDAuZGlkVXBkYXRlID0gZnVuY3Rpb24gZGlkVXBkYXRlKF9yZWY4KSB7CiAgICAgIHZhciBjb21wb25lbnQgPSBfcmVmOC5jb21wb25lbnQsCiAgICAgICAgICBlbnZpcm9ubWVudCA9IF9yZWY4LmVudmlyb25tZW50OwoKICAgICAgaWYgKGVudmlyb25tZW50LmlzSW50ZXJhY3RpdmUpIHsKICAgICAgICBjb21wb25lbnQudHJpZ2dlcignZGlkVXBkYXRlJyk7CiAgICAgICAgY29tcG9uZW50LnRyaWdnZXIoJ2RpZFJlbmRlcicpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzQwLmdldERlc3RydWN0b3IgPSBmdW5jdGlvbiBnZXREZXN0cnVjdG9yKGJ1Y2tldCkgewogICAgICBpZiAoX2Vudmlyb25tZW50Mi5FTlYuX0RFQlVHX1JFTkRFUl9UUkVFKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICAgICAgIGJ1Y2tldC5lbnZpcm9ubWVudC5kZWJ1Z1JlbmRlclRyZWUud2lsbERlc3Ryb3koYnVja2V0KTsKICAgICAgICAgICAgYnVja2V0LmRlc3Ryb3koKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBidWNrZXQ7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIEN1cmx5Q29tcG9uZW50TWFuYWdlcjsKICB9KEFic3RyYWN0TWFuYWdlcik7CgogIGZ1bmN0aW9uIHByb2Nlc3NDb21wb25lbnRJbml0aWFsaXphdGlvbkFzc2VydGlvbnMoY29tcG9uZW50LCBwcm9wcykgewogICAgKGZhbHNlICYmICEoZnVuY3Rpb24gKCkgewogICAgICB2YXIgY2xhc3NOYW1lQmluZGluZ3MgPSBjb21wb25lbnQuY2xhc3NOYW1lQmluZGluZ3M7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNsYXNzTmFtZUJpbmRpbmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGJpbmRpbmcgPSBjbGFzc05hbWVCaW5kaW5nc1tpXTsKCiAgICAgICAgaWYgKHR5cGVvZiBiaW5kaW5nICE9PSAnc3RyaW5nJyB8fCBiaW5kaW5nLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiY2xhc3NOYW1lQmluZGluZ3MgbXVzdCBiZSBub24tZW1wdHkgc3RyaW5nczogIiArIGNvbXBvbmVudCwgZnVuY3Rpb24gKCkgewogICAgICB2YXIgY2xhc3NOYW1lQmluZGluZ3MgPSBjb21wb25lbnQuY2xhc3NOYW1lQmluZGluZ3M7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNsYXNzTmFtZUJpbmRpbmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGJpbmRpbmcgPSBjbGFzc05hbWVCaW5kaW5nc1tpXTsKCiAgICAgICAgaWYgKHR5cGVvZiBiaW5kaW5nICE9PSAnc3RyaW5nJyB8fCBiaW5kaW5nLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KCkpKTsKICAgIChmYWxzZSAmJiAhKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNsYXNzTmFtZUJpbmRpbmdzID0gY29tcG9uZW50LmNsYXNzTmFtZUJpbmRpbmdzOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjbGFzc05hbWVCaW5kaW5ncy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBiaW5kaW5nID0gY2xhc3NOYW1lQmluZGluZ3NbaV07CgogICAgICAgIGlmIChiaW5kaW5nLnNwbGl0KCcgJykubGVuZ3RoID4gMSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiY2xhc3NOYW1lQmluZGluZ3MgbXVzdCBub3QgaGF2ZSBzcGFjZXMgaW4gdGhlbTogIiArIGNvbXBvbmVudCwgZnVuY3Rpb24gKCkgewogICAgICB2YXIgY2xhc3NOYW1lQmluZGluZ3MgPSBjb21wb25lbnQuY2xhc3NOYW1lQmluZGluZ3M7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNsYXNzTmFtZUJpbmRpbmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGJpbmRpbmcgPSBjbGFzc05hbWVCaW5kaW5nc1tpXTsKCiAgICAgICAgaWYgKGJpbmRpbmcuc3BsaXQoJyAnKS5sZW5ndGggPiAxKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0oKSkpOwogICAgKGZhbHNlICYmICEoY29tcG9uZW50LnRhZ05hbWUgIT09ICcnIHx8ICFjb21wb25lbnQuY2xhc3NOYW1lQmluZGluZ3MgfHwgY29tcG9uZW50LmNsYXNzTmFtZUJpbmRpbmdzLmxlbmd0aCA9PT0gMCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJZb3UgY2Fubm90IHVzZSBgY2xhc3NOYW1lQmluZGluZ3NgIG9uIGEgdGFnLWxlc3MgY29tcG9uZW50OiAiICsgY29tcG9uZW50LCBjb21wb25lbnQudGFnTmFtZSAhPT0gJycgfHwgIWNvbXBvbmVudC5jbGFzc05hbWVCaW5kaW5ncyB8fCBjb21wb25lbnQuY2xhc3NOYW1lQmluZGluZ3MubGVuZ3RoID09PSAwKSk7CiAgICAoZmFsc2UgJiYgIShjb21wb25lbnQudGFnTmFtZSAhPT0gJycgfHwgcHJvcHMuaWQgPT09IGNvbXBvbmVudC5lbGVtZW50SWQgfHwgIWNvbXBvbmVudC5lbGVtZW50SWQgJiYgY29tcG9uZW50LmVsZW1lbnRJZCAhPT0gJycpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IGNhbm5vdCB1c2UgYGVsZW1lbnRJZGAgb24gYSB0YWctbGVzcyBjb21wb25lbnQ6ICIgKyBjb21wb25lbnQsIGNvbXBvbmVudC50YWdOYW1lICE9PSAnJyB8fCBwcm9wcy5pZCA9PT0gY29tcG9uZW50LmVsZW1lbnRJZCB8fCAhY29tcG9uZW50LmVsZW1lbnRJZCAmJiBjb21wb25lbnQuZWxlbWVudElkICE9PSAnJykpOwogICAgKGZhbHNlICYmICEoY29tcG9uZW50LnRhZ05hbWUgIT09ICcnIHx8ICFjb21wb25lbnQuYXR0cmlidXRlQmluZGluZ3MgfHwgY29tcG9uZW50LmF0dHJpYnV0ZUJpbmRpbmdzLmxlbmd0aCA9PT0gMCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJZb3UgY2Fubm90IHVzZSBgYXR0cmlidXRlQmluZGluZ3NgIG9uIGEgdGFnLWxlc3MgY29tcG9uZW50OiAiICsgY29tcG9uZW50LCBjb21wb25lbnQudGFnTmFtZSAhPT0gJycgfHwgIWNvbXBvbmVudC5hdHRyaWJ1dGVCaW5kaW5ncyB8fCBjb21wb25lbnQuYXR0cmlidXRlQmluZGluZ3MubGVuZ3RoID09PSAwKSk7CiAgfQoKICBmdW5jdGlvbiBpbml0aWFsUmVuZGVySW5zdHJ1bWVudERldGFpbHMoY29tcG9uZW50KSB7CiAgICByZXR1cm4gY29tcG9uZW50Lmluc3RydW1lbnREZXRhaWxzKHsKICAgICAgaW5pdGlhbFJlbmRlcjogdHJ1ZQogICAgfSk7CiAgfQoKICBmdW5jdGlvbiByZXJlbmRlckluc3RydW1lbnREZXRhaWxzKGNvbXBvbmVudCkgewogICAgcmV0dXJuIGNvbXBvbmVudC5pbnN0cnVtZW50RGV0YWlscyh7CiAgICAgIGluaXRpYWxSZW5kZXI6IGZhbHNlCiAgICB9KTsKICB9CgogIHZhciBDVVJMWV9DQVBBQklMSVRJRVMgPSB7CiAgICBkeW5hbWljTGF5b3V0OiB0cnVlLAogICAgZHluYW1pY1RhZzogdHJ1ZSwKICAgIHByZXBhcmVBcmdzOiB0cnVlLAogICAgY3JlYXRlQXJnczogdHJ1ZSwKICAgIGF0dHJpYnV0ZUhvb2s6IHRydWUsCiAgICBlbGVtZW50SG9vazogdHJ1ZSwKICAgIGNyZWF0ZUNhbGxlcjogdHJ1ZSwKICAgIGR5bmFtaWNTY29wZTogdHJ1ZSwKICAgIHVwZGF0ZUhvb2s6IHRydWUsCiAgICBjcmVhdGVJbnN0YW5jZTogdHJ1ZQogIH07CiAgdmFyIENVUkxZX0NPTVBPTkVOVF9NQU5BR0VSID0gbmV3IEN1cmx5Q29tcG9uZW50TWFuYWdlcigpOwoKICB2YXIgQ3VybHlDb21wb25lbnREZWZpbml0aW9uID0gLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXNoYWRvd2VkLXZhcmlhYmxlCiAgZnVuY3Rpb24gQ3VybHlDb21wb25lbnREZWZpbml0aW9uKG5hbWUsIENvbXBvbmVudENsYXNzLCBoYW5kbGUsIHRlbXBsYXRlJCQxLCBhcmdzKSB7CiAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgdGhpcy5Db21wb25lbnRDbGFzcyA9IENvbXBvbmVudENsYXNzOwogICAgdGhpcy5oYW5kbGUgPSBoYW5kbGU7CiAgICB0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGUkJDE7CiAgICB0aGlzLm1hbmFnZXIgPSBDVVJMWV9DT01QT05FTlRfTUFOQUdFUjsKICAgIHZhciBsYXlvdXQgPSB0ZW1wbGF0ZSQkMSAmJiB0ZW1wbGF0ZSQkMS5hc0xheW91dCgpOwogICAgdmFyIHN5bWJvbFRhYmxlID0gbGF5b3V0ID8gbGF5b3V0LnN5bWJvbFRhYmxlIDogdW5kZWZpbmVkOwogICAgdGhpcy5zeW1ib2xUYWJsZSA9IHN5bWJvbFRhYmxlOwogICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlJCQxOwogICAgdGhpcy5hcmdzID0gYXJnczsKICAgIHRoaXMuc3RhdGUgPSB7CiAgICAgIG5hbWU6IG5hbWUsCiAgICAgIENvbXBvbmVudENsYXNzOiBDb21wb25lbnRDbGFzcywKICAgICAgaGFuZGxlOiBoYW5kbGUsCiAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZSQkMSwKICAgICAgY2FwYWJpbGl0aWVzOiBDVVJMWV9DQVBBQklMSVRJRVMsCiAgICAgIHN5bWJvbFRhYmxlOiBzeW1ib2xUYWJsZQogICAgfTsKICB9OwoKICB2YXIgUm9vdENvbXBvbmVudE1hbmFnZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0N1cmx5Q29tcG9uZW50TWFuYWdlKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoUm9vdENvbXBvbmVudE1hbmFnZXIsIF9DdXJseUNvbXBvbmVudE1hbmFnZSk7CgogICAgZnVuY3Rpb24gUm9vdENvbXBvbmVudE1hbmFnZXIoY29tcG9uZW50KSB7CiAgICAgIHZhciBfdGhpczIwOwoKICAgICAgX3RoaXMyMCA9IF9DdXJseUNvbXBvbmVudE1hbmFnZS5jYWxsKHRoaXMpIHx8IHRoaXM7CiAgICAgIF90aGlzMjAuY29tcG9uZW50ID0gY29tcG9uZW50OwogICAgICByZXR1cm4gX3RoaXMyMDsKICAgIH0KCiAgICB2YXIgX3Byb3RvNDEgPSBSb290Q29tcG9uZW50TWFuYWdlci5wcm90b3R5cGU7CgogICAgX3Byb3RvNDEuZ2V0TGF5b3V0ID0gZnVuY3Rpb24gZ2V0TGF5b3V0KF9zdGF0ZSkgewogICAgICB2YXIgdGVtcGxhdGUgPSB0aGlzLnRlbXBsYXRlRm9yKHRoaXMuY29tcG9uZW50KTsKICAgICAgdmFyIGxheW91dCA9IHRlbXBsYXRlLmFzV3JhcHBlZExheW91dCgpOwogICAgICByZXR1cm4gewogICAgICAgIGhhbmRsZTogbGF5b3V0LmNvbXBpbGUoKSwKICAgICAgICBzeW1ib2xUYWJsZTogbGF5b3V0LnN5bWJvbFRhYmxlCiAgICAgIH07CiAgICB9OwoKICAgIF9wcm90bzQxLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShlbnZpcm9ubWVudCwgc3RhdGUsIF9hcmdzLCBkeW5hbWljU2NvcGUpIHsKICAgICAgdmFyIGNvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50OwoKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICkgewogICAgICAgIGVudmlyb25tZW50LmRlYnVnU3RhY2sucHVzaChjb21wb25lbnQuX2RlYnVnQ29udGFpbmVyS2V5KTsKICAgICAgfQoKICAgICAgdmFyIGZpbmFsaXplciA9ICgwLCBfaW5zdHJ1bWVudGF0aW9uLl9pbnN0cnVtZW50U3RhcnQpKCdyZW5kZXIuY29tcG9uZW50JywgaW5pdGlhbFJlbmRlckluc3RydW1lbnREZXRhaWxzLCBjb21wb25lbnQpOwogICAgICBkeW5hbWljU2NvcGUudmlldyA9IGNvbXBvbmVudDsKICAgICAgdmFyIGhhc1dyYXBwZWRFbGVtZW50ID0gY29tcG9uZW50LnRhZ05hbWUgIT09ICcnOyAvLyBXZSB1c3VhbGx5IGRvIHRoaXMgaW4gdGhlIGBkaWRDcmVhdGVFbGVtZW50YCwgYnV0IHRoYXQgaG9vayBkb2Vzbid0IGZpcmUgZm9yIHRhZ2xlc3MgY29tcG9uZW50cwoKICAgICAgaWYgKCFoYXNXcmFwcGVkRWxlbWVudCkgewogICAgICAgIGlmIChlbnZpcm9ubWVudC5pc0ludGVyYWN0aXZlKSB7CiAgICAgICAgICBjb21wb25lbnQudHJpZ2dlcignd2lsbFJlbmRlcicpOwogICAgICAgIH0KCiAgICAgICAgY29tcG9uZW50Ll90cmFuc2l0aW9uVG8oJ2hhc0VsZW1lbnQnKTsKCiAgICAgICAgaWYgKGVudmlyb25tZW50LmlzSW50ZXJhY3RpdmUpIHsKICAgICAgICAgIGNvbXBvbmVudC50cmlnZ2VyKCd3aWxsSW5zZXJ0RWxlbWVudCcpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICkgewogICAgICAgIHByb2Nlc3NDb21wb25lbnRJbml0aWFsaXphdGlvbkFzc2VydGlvbnMoY29tcG9uZW50LCB7fSk7CiAgICAgIH0KCiAgICAgIHZhciBidWNrZXQgPSBuZXcgQ29tcG9uZW50U3RhdGVCdWNrZXQoZW52aXJvbm1lbnQsIGNvbXBvbmVudCwgbnVsbCwgZmluYWxpemVyLCBoYXNXcmFwcGVkRWxlbWVudCk7CgogICAgICBpZiAoX2Vudmlyb25tZW50Mi5FTlYuX0RFQlVHX1JFTkRFUl9UUkVFKSB7CiAgICAgICAgZW52aXJvbm1lbnQuZGVidWdSZW5kZXJUcmVlLmNyZWF0ZShidWNrZXQsIHsKICAgICAgICAgIHR5cGU6ICdjb21wb25lbnQnLAogICAgICAgICAgbmFtZTogc3RhdGUubmFtZSwKICAgICAgICAgIGFyZ3M6IF9ydW50aW1lMi5FTVBUWV9BUkdTLAogICAgICAgICAgaW5zdGFuY2U6IGNvbXBvbmVudAogICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gYnVja2V0OwogICAgfTsKCiAgICByZXR1cm4gUm9vdENvbXBvbmVudE1hbmFnZXI7CiAgfShDdXJseUNvbXBvbmVudE1hbmFnZXIpOyAvLyBST09UIGlzIHRoZSB0b3AtbGV2ZWwgdGVtcGxhdGUgaXQgaGFzIG5vdGhpbmcgYnV0IG9uZSB5aWVsZC4KICAvLyBpdCBpcyBzdXBwb3NlZCB0byBoYXZlIGEgZHVtbXkgZWxlbWVudAoKCiAgdmFyIFJPT1RfQ0FQQUJJTElUSUVTID0gewogICAgZHluYW1pY0xheW91dDogZmFsc2UsCiAgICBkeW5hbWljVGFnOiB0cnVlLAogICAgcHJlcGFyZUFyZ3M6IGZhbHNlLAogICAgY3JlYXRlQXJnczogZmFsc2UsCiAgICBhdHRyaWJ1dGVIb29rOiB0cnVlLAogICAgZWxlbWVudEhvb2s6IHRydWUsCiAgICBjcmVhdGVDYWxsZXI6IHRydWUsCiAgICBkeW5hbWljU2NvcGU6IHRydWUsCiAgICB1cGRhdGVIb29rOiB0cnVlLAogICAgY3JlYXRlSW5zdGFuY2U6IHRydWUKICB9OwoKICB2YXIgUm9vdENvbXBvbmVudERlZmluaXRpb24gPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBSb290Q29tcG9uZW50RGVmaW5pdGlvbihjb21wb25lbnQpIHsKICAgICAgdGhpcy5jb21wb25lbnQgPSBjb21wb25lbnQ7CiAgICAgIHZhciBtYW5hZ2VyID0gbmV3IFJvb3RDb21wb25lbnRNYW5hZ2VyKGNvbXBvbmVudCk7CiAgICAgIHRoaXMubWFuYWdlciA9IG1hbmFnZXI7CgogICAgICB2YXIgZmFjdG9yeSA9IF9jb250YWluZXIuRkFDVE9SWV9GT1IuZ2V0KGNvbXBvbmVudCk7CgogICAgICB0aGlzLnN0YXRlID0gewogICAgICAgIG5hbWU6IGZhY3RvcnkuZnVsbE5hbWUuc2xpY2UoMTApLAogICAgICAgIGNhcGFiaWxpdGllczogUk9PVF9DQVBBQklMSVRJRVMsCiAgICAgICAgQ29tcG9uZW50Q2xhc3M6IGZhY3RvcnksCiAgICAgICAgaGFuZGxlOiBudWxsCiAgICAgIH07CiAgICB9CgogICAgdmFyIF9wcm90bzQyID0gUm9vdENvbXBvbmVudERlZmluaXRpb24ucHJvdG90eXBlOwoKICAgIF9wcm90bzQyLmdldFRhZyA9IGZ1bmN0aW9uIGdldFRhZyhfcmVmOSkgewogICAgICB2YXIgY29tcG9uZW50ID0gX3JlZjkuY29tcG9uZW50OwogICAgICByZXR1cm4gY29tcG9uZW50W0RJUlRZX1RBR107CiAgICB9OwoKICAgIHJldHVybiBSb290Q29tcG9uZW50RGVmaW5pdGlvbjsKICB9KCk7CgogIHZhciBEeW5hbWljU2NvcGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBEeW5hbWljU2NvcGUodmlldywgb3V0bGV0U3RhdGUpIHsKICAgICAgdGhpcy52aWV3ID0gdmlldzsKICAgICAgdGhpcy5vdXRsZXRTdGF0ZSA9IG91dGxldFN0YXRlOwogICAgfQoKICAgIHZhciBfcHJvdG80MyA9IER5bmFtaWNTY29wZS5wcm90b3R5cGU7CgogICAgX3Byb3RvNDMuY2hpbGQgPSBmdW5jdGlvbiBjaGlsZCgpIHsKICAgICAgcmV0dXJuIG5ldyBEeW5hbWljU2NvcGUodGhpcy52aWV3LCB0aGlzLm91dGxldFN0YXRlKTsKICAgIH07CgogICAgX3Byb3RvNDMuZ2V0ID0gZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoCiAgICAgIChmYWxzZSAmJiAhKGtleSA9PT0gJ291dGxldFN0YXRlJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJVc2luZyBgLWdldC1keW5hbWljLXNjb3BlYCBpcyBvbmx5IHN1cHBvcnRlZCBmb3IgYG91dGxldFN0YXRlYCAoeW91IHVzZWQgYCIgKyBrZXkgKyAiYCkuIiwga2V5ID09PSAnb3V0bGV0U3RhdGUnKSk7CiAgICAgIHJldHVybiB0aGlzLm91dGxldFN0YXRlOwogICAgfTsKCiAgICBfcHJvdG80My5zZXQgPSBmdW5jdGlvbiBzZXQoa2V5LCB2YWx1ZSQkMSkgewogICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoCiAgICAgIChmYWxzZSAmJiAhKGtleSA9PT0gJ291dGxldFN0YXRlJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJVc2luZyBgLXdpdGgtZHluYW1pYy1zY29wZWAgaXMgb25seSBzdXBwb3J0ZWQgZm9yIGBvdXRsZXRTdGF0ZWAgKHlvdSB1c2VkIGAiICsga2V5ICsgImApLiIsIGtleSA9PT0gJ291dGxldFN0YXRlJykpOwogICAgICB0aGlzLm91dGxldFN0YXRlID0gdmFsdWUkJDE7CiAgICAgIHJldHVybiB2YWx1ZSQkMTsKICAgIH07CgogICAgcmV0dXJuIER5bmFtaWNTY29wZTsKICB9KCk7CgogIHZhciBSb290U3RhdGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBSb290U3RhdGUocm9vdCwgZW52LCB0ZW1wbGF0ZSwgc2VsZiwgcGFyZW50RWxlbWVudCwgZHluYW1pY1Njb3BlLCBidWlsZGVyKSB7CiAgICAgIHZhciBfdGhpczIxID0gdGhpczsKCiAgICAgIChmYWxzZSAmJiAhKHRlbXBsYXRlICE9PSB1bmRlZmluZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IGNhbm5vdCByZW5kZXIgYCIgKyBzZWxmLnZhbHVlKCkgKyAiYCB3aXRob3V0IGEgdGVtcGxhdGUuIiwgdGVtcGxhdGUgIT09IHVuZGVmaW5lZCkpOwogICAgICB0aGlzLmlkID0gKDAsIF92aWV3cy5nZXRWaWV3SWQpKHJvb3QpOwogICAgICB0aGlzLmVudiA9IGVudjsKICAgICAgdGhpcy5yb290ID0gcm9vdDsKICAgICAgdGhpcy5yZXN1bHQgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuc2hvdWxkUmVmbHVzaCA9IGZhbHNlOwogICAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlOwogICAgICB2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucyA9IHsKICAgICAgICBhbHdheXNSZXZhbGlkYXRlOiBmYWxzZQogICAgICB9OwoKICAgICAgdGhpcy5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGxheW91dCA9IHRlbXBsYXRlLmFzTGF5b3V0KCk7CiAgICAgICAgdmFyIGhhbmRsZSA9IGxheW91dC5jb21waWxlKCk7CiAgICAgICAgdmFyIGl0ZXJhdG9yID0gKDAsIF9ydW50aW1lMi5yZW5kZXJNYWluKShsYXlvdXRbJ2NvbXBpbGVyJ10ucHJvZ3JhbSwgZW52LCBzZWxmLCBkeW5hbWljU2NvcGUsIGJ1aWxkZXIoZW52LCB7CiAgICAgICAgICBlbGVtZW50OiBwYXJlbnRFbGVtZW50LAogICAgICAgICAgbmV4dFNpYmxpbmc6IG51bGwKICAgICAgICB9KSwgaGFuZGxlKTsKICAgICAgICB2YXIgaXRlcmF0b3JSZXN1bHQ7CgogICAgICAgIGRvIHsKICAgICAgICAgIGl0ZXJhdG9yUmVzdWx0ID0gaXRlcmF0b3IubmV4dCgpOwogICAgICAgIH0gd2hpbGUgKCFpdGVyYXRvclJlc3VsdC5kb25lKTsKCiAgICAgICAgdmFyIHJlc3VsdCA9IF90aGlzMjEucmVzdWx0ID0gaXRlcmF0b3JSZXN1bHQudmFsdWU7IC8vIG92ZXJyaWRlIC5yZW5kZXIgZnVuY3Rpb24gYWZ0ZXIgaW5pdGlhbCByZW5kZXIKCiAgICAgICAgX3RoaXMyMS5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gcmVzdWx0LnJlcmVuZGVyKG9wdGlvbnMpOwogICAgICAgIH07CiAgICAgIH07CiAgICB9CgogICAgdmFyIF9wcm90bzQ0ID0gUm9vdFN0YXRlLnByb3RvdHlwZTsKCiAgICBfcHJvdG80NC5pc0ZvciA9IGZ1bmN0aW9uIGlzRm9yKHBvc3NpYmxlUm9vdCkgewogICAgICByZXR1cm4gdGhpcy5yb290ID09PSBwb3NzaWJsZVJvb3Q7CiAgICB9OwoKICAgIF9wcm90bzQ0LmRlc3Ryb3kgPSBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICB2YXIgcmVzdWx0ID0gdGhpcy5yZXN1bHQsCiAgICAgICAgICBlbnYgPSB0aGlzLmVudjsKICAgICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlOwogICAgICB0aGlzLmVudiA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5yb290ID0gbnVsbDsKICAgICAgdGhpcy5yZXN1bHQgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMucmVuZGVyID0gdW5kZWZpbmVkOwoKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIC8qCiAgICAgICAgIEhhbmRsZXMgdGhlc2Ugc2NlbmFyaW9zOgogICAgICAgICAgICAgICAgKiBXaGVuIHJvb3RzIGFyZSByZW1vdmVkIGR1cmluZyBzdGFuZGFyZCByZW5kZXJpbmcgcHJvY2VzcywgYSB0cmFuc2FjdGlvbiBleGlzdHMgYWxyZWFkeQogICAgICAgICAgIGAuYmVnaW4oKWAgLyBgLmNvbW1pdCgpYCBhcmUgbm90IG5lZWRlZC4KICAgICAgICAgKiBXaGVuIHJvb3RzIGFyZSBiZWluZyBkZXN0cm95ZWQgbWFudWFsbHkgKGBjb21wb25lbnQuYXBwZW5kKCk7IGNvbXBvbmVudC5kZXN0cm95KCkgY2FzZSksIG5vCiAgICAgICAgICAgdHJhbnNhY3Rpb24gZXhpc3RzIGFscmVhZHkuCiAgICAgICAgICogV2hlbiByb290cyBhcmUgYmVpbmcgZGVzdHJveWVkIGR1cmluZyBgUmVuZGVyZXIjZGVzdHJveWAsIG5vIHRyYW5zYWN0aW9uIGV4aXN0cwogICAgICAgICAgICAgICAgKi8KICAgICAgICB2YXIgbmVlZHNUcmFuc2FjdGlvbiA9ICFlbnYuaW5UcmFuc2FjdGlvbjsKCiAgICAgICAgaWYgKG5lZWRzVHJhbnNhY3Rpb24pIHsKICAgICAgICAgIGVudi5iZWdpbigpOwogICAgICAgIH0KCiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJlc3VsdC5kZXN0cm95KCk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmIChuZWVkc1RyYW5zYWN0aW9uKSB7CiAgICAgICAgICAgIGVudi5jb21taXQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIFJvb3RTdGF0ZTsKICB9KCk7CgogIHZhciByZW5kZXJlcnMgPSBbXTsKCiAgZnVuY3Rpb24gX3Jlc2V0UmVuZGVyZXJzKCkgewogICAgcmVuZGVyZXJzLmxlbmd0aCA9IDA7CiAgfQoKICBmdW5jdGlvbiByZWdpc3RlcihyZW5kZXJlcikgewogICAgKGZhbHNlICYmICEocmVuZGVyZXJzLmluZGV4T2YocmVuZGVyZXIpID09PSAtMSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDYW5ub3QgcmVnaXN0ZXIgdGhlIHNhbWUgcmVuZGVyZXIgdHdpY2UnLCByZW5kZXJlcnMuaW5kZXhPZihyZW5kZXJlcikgPT09IC0xKSk7CiAgICByZW5kZXJlcnMucHVzaChyZW5kZXJlcik7CiAgfQoKICBmdW5jdGlvbiBkZXJlZ2lzdGVyKHJlbmRlcmVyKSB7CiAgICB2YXIgaW5kZXggPSByZW5kZXJlcnMuaW5kZXhPZihyZW5kZXJlcik7CiAgICAoZmFsc2UgJiYgIShpbmRleCAhPT0gLTEpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ2Fubm90IGRlcmVnaXN0ZXIgdW5rbm93biB1bnJlZ2lzdGVyZWQgcmVuZGVyZXInLCBpbmRleCAhPT0gLTEpKTsKICAgIHJlbmRlcmVycy5zcGxpY2UoaW5kZXgsIDEpOwogIH0KCiAgZnVuY3Rpb24gbG9vcEJlZ2luKCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZW5kZXJlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgcmVuZGVyZXJzW2ldLl9zY2hlZHVsZVJldmFsaWRhdGUoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIEsoKSB7CiAgICAvKiBub29wICovCiAgfQoKICB2YXIgcmVuZGVyU2V0dGxlZERlZmVycmVkID0gbnVsbDsKICAvKgogICAgUmV0dXJucyBhIHByb21pc2Ugd2hpY2ggd2lsbCByZXNvbHZlIHdoZW4gcmVuZGVyaW5nIGhhcyBzZXR0bGVkLiBTZXR0bGVkIGluCiAgICB0aGlzIGNvbnRleHQgaXMgZGVmaW5lZCBhcyB3aGVuIGFsbCBvZiB0aGUgdGFncyBpbiB1c2UgYXJlICJjdXJyZW50IiAoZS5nLgogICAgYHJlbmRlcmVycy5ldmVyeShyID0+IHIuX2lzVmFsaWQoKSlgKS4gV2hlbiB0aGlzIGlzIGNoZWNrZWQgYXQgdGhlIF9lbmRfIG9mCiAgICB0aGUgcnVuIGxvb3AsIHRoaXMgZXNzZW50aWFsbHkgZ3VhcmFudGVlcyB0aGF0IGFsbCByZW5kZXJpbmcgaXMgY29tcGxldGVkLgogIAogICAgQG1ldGhvZCByZW5kZXJTZXR0bGVkCiAgICBAcmV0dXJucyB7UHJvbWlzZTx2b2lkPn0gYSBwcm9taXNlIHdoaWNoIGZ1bGZpbGxzIHdoZW4gcmVuZGVyaW5nIGhhcyBzZXR0bGVkCiAgKi8KCiAgZnVuY3Rpb24gcmVuZGVyU2V0dGxlZCgpIHsKICAgIGlmIChyZW5kZXJTZXR0bGVkRGVmZXJyZWQgPT09IG51bGwpIHsKICAgICAgcmVuZGVyU2V0dGxlZERlZmVycmVkID0gX3JzdnAuZGVmYXVsdC5kZWZlcigpOyAvLyBpZiB0aGVyZSBpcyBubyBjdXJyZW50IHJ1bmxvb3AsIHRoZSBwcm9taXNlIGNyZWF0ZWQgYWJvdmUgd2lsbCBub3QgaGF2ZQogICAgICAvLyBhIGNoYW5jZSB0byByZXNvbHZlIChiZWNhdXNlIGl0cyByZXNvbHZlZCBpbiBiYWNrYnVybmVyJ3MgImVuZCIgZXZlbnQpCgogICAgICBpZiAoISgwLCBfcnVubG9vcC5nZXRDdXJyZW50UnVuTG9vcCkoKSkgewogICAgICAgIC8vIGVuc3VyZSBhIHJ1bmxvb3AgaGFzIGJlZW4ga2lja2VkIG9mZgogICAgICAgIF9ydW5sb29wLmJhY2tidXJuZXIuc2NoZWR1bGUoJ2FjdGlvbnMnLCBudWxsLCBLKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByZW5kZXJTZXR0bGVkRGVmZXJyZWQucHJvbWlzZTsKICB9CgogIGZ1bmN0aW9uIHJlc29sdmVSZW5kZXJQcm9taXNlKCkgewogICAgaWYgKHJlbmRlclNldHRsZWREZWZlcnJlZCAhPT0gbnVsbCkgewogICAgICB2YXIgcmVzb2x2ZSA9IHJlbmRlclNldHRsZWREZWZlcnJlZC5yZXNvbHZlOwogICAgICByZW5kZXJTZXR0bGVkRGVmZXJyZWQgPSBudWxsOwoKICAgICAgX3J1bmxvb3AuYmFja2J1cm5lci5qb2luKG51bGwsIHJlc29sdmUpOwogICAgfQogIH0KCiAgdmFyIGxvb3BzID0gMDsKCiAgZnVuY3Rpb24gbG9vcEVuZCgpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVuZGVyZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICghcmVuZGVyZXJzW2ldLl9pc1ZhbGlkKCkpIHsKICAgICAgICBpZiAobG9vcHMgPiBfZW52aXJvbm1lbnQyLkVOVi5fUkVSRU5ERVJfTE9PUF9MSU1JVCkgewogICAgICAgICAgbG9vcHMgPSAwOyAvLyBUT0RPOiBkbyBzb21ldGhpbmcgYmV0dGVyCgogICAgICAgICAgcmVuZGVyZXJzW2ldLmRlc3Ryb3koKTsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignaW5maW5pdGUgcmVuZGVyaW5nIGludmFsaWRhdGlvbiBkZXRlY3RlZCcpOwogICAgICAgIH0KCiAgICAgICAgbG9vcHMrKzsKICAgICAgICByZXR1cm4gX3J1bmxvb3AuYmFja2J1cm5lci5qb2luKG51bGwsIEspOwogICAgICB9CiAgICB9CgogICAgbG9vcHMgPSAwOwogICAgcmVzb2x2ZVJlbmRlclByb21pc2UoKTsKICB9CgogIF9ydW5sb29wLmJhY2tidXJuZXIub24oJ2JlZ2luJywgbG9vcEJlZ2luKTsKCiAgX3J1bmxvb3AuYmFja2J1cm5lci5vbignZW5kJywgbG9vcEVuZCk7CgogIHZhciBSZW5kZXJlciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFJlbmRlcmVyKGVudiwgcm9vdFRlbXBsYXRlLCB2aWV3UmVnaXN0cnksIGRlc3RpbmVkRm9yRE9NLCBidWlsZGVyKSB7CiAgICAgIGlmIChkZXN0aW5lZEZvckRPTSA9PT0gdm9pZCAwKSB7CiAgICAgICAgZGVzdGluZWRGb3JET00gPSBmYWxzZTsKICAgICAgfQoKICAgICAgaWYgKGJ1aWxkZXIgPT09IHZvaWQgMCkgewogICAgICAgIGJ1aWxkZXIgPSBfcnVudGltZTIuY2xpZW50QnVpbGRlcjsKICAgICAgfQoKICAgICAgdGhpcy5fZW52ID0gZW52OwogICAgICB0aGlzLl9yb290VGVtcGxhdGUgPSByb290VGVtcGxhdGUoZW52Lm93bmVyKTsKICAgICAgdGhpcy5fdmlld1JlZ2lzdHJ5ID0gdmlld1JlZ2lzdHJ5OwogICAgICB0aGlzLl9kZXN0aW5lZEZvckRPTSA9IGRlc3RpbmVkRm9yRE9NOwogICAgICB0aGlzLl9kZXN0cm95ZWQgPSBmYWxzZTsKICAgICAgdGhpcy5fcm9vdHMgPSBbXTsKICAgICAgdGhpcy5fbGFzdFJldmlzaW9uID0gLTE7CiAgICAgIHRoaXMuX2lzUmVuZGVyaW5nUm9vdHMgPSBmYWxzZTsKICAgICAgdGhpcy5fcmVtb3ZlZFJvb3RzID0gW107CiAgICAgIHRoaXMuX2J1aWxkZXIgPSBidWlsZGVyOwogICAgfSAvLyByZW5kZXJlciBIT09LUwoKCiAgICB2YXIgX3Byb3RvNDUgPSBSZW5kZXJlci5wcm90b3R5cGU7CgogICAgX3Byb3RvNDUuYXBwZW5kT3V0bGV0VmlldyA9IGZ1bmN0aW9uIGFwcGVuZE91dGxldFZpZXcodmlldywgdGFyZ2V0KSB7CiAgICAgIHZhciBkZWZpbml0aW9uID0gY3JlYXRlUm9vdE91dGxldCh2aWV3KTsKCiAgICAgIHRoaXMuX2FwcGVuZERlZmluaXRpb24odmlldywgKDAsIF9ydW50aW1lMi5jdXJyeSkoZGVmaW5pdGlvbiksIHRhcmdldCk7CiAgICB9OwoKICAgIF9wcm90bzQ1LmFwcGVuZFRvID0gZnVuY3Rpb24gYXBwZW5kVG8odmlldywgdGFyZ2V0KSB7CiAgICAgIHZhciBkZWZpbml0aW9uID0gbmV3IFJvb3RDb21wb25lbnREZWZpbml0aW9uKHZpZXcpOwoKICAgICAgdGhpcy5fYXBwZW5kRGVmaW5pdGlvbih2aWV3LCAoMCwgX3J1bnRpbWUyLmN1cnJ5KShkZWZpbml0aW9uKSwgdGFyZ2V0KTsKICAgIH07CgogICAgX3Byb3RvNDUuX2FwcGVuZERlZmluaXRpb24gPSBmdW5jdGlvbiBfYXBwZW5kRGVmaW5pdGlvbihyb290LCBkZWZpbml0aW9uLCB0YXJnZXQpIHsKICAgICAgdmFyIHNlbGYgPSBuZXcgVW5ib3VuZFJlZmVyZW5jZShkZWZpbml0aW9uKTsKICAgICAgdmFyIGR5bmFtaWNTY29wZSA9IG5ldyBEeW5hbWljU2NvcGUobnVsbCwgX3J1bnRpbWUyLlVOREVGSU5FRF9SRUZFUkVOQ0UpOwogICAgICB2YXIgcm9vdFN0YXRlID0gbmV3IFJvb3RTdGF0ZShyb290LCB0aGlzLl9lbnYsIHRoaXMuX3Jvb3RUZW1wbGF0ZSwgc2VsZiwgdGFyZ2V0LCBkeW5hbWljU2NvcGUsIHRoaXMuX2J1aWxkZXIpOwoKICAgICAgdGhpcy5fcmVuZGVyUm9vdChyb290U3RhdGUpOwogICAgfTsKCiAgICBfcHJvdG80NS5yZXJlbmRlciA9IGZ1bmN0aW9uIHJlcmVuZGVyKCkgewogICAgICB0aGlzLl9zY2hlZHVsZVJldmFsaWRhdGUoKTsKICAgIH07CgogICAgX3Byb3RvNDUucmVnaXN0ZXIgPSBmdW5jdGlvbiByZWdpc3Rlcih2aWV3KSB7CiAgICAgIHZhciBpZCA9ICgwLCBfdmlld3MuZ2V0Vmlld0lkKSh2aWV3KTsKICAgICAgKGZhbHNlICYmICEoIXRoaXMuX3ZpZXdSZWdpc3RyeVtpZF0pICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQXR0ZW1wdGVkIHRvIHJlZ2lzdGVyIGEgdmlldyB3aXRoIGFuIGlkIGFscmVhZHkgaW4gdXNlOiAnICsgaWQsICF0aGlzLl92aWV3UmVnaXN0cnlbaWRdKSk7CiAgICAgIHRoaXMuX3ZpZXdSZWdpc3RyeVtpZF0gPSB2aWV3OwogICAgfTsKCiAgICBfcHJvdG80NS51bnJlZ2lzdGVyID0gZnVuY3Rpb24gdW5yZWdpc3Rlcih2aWV3KSB7CiAgICAgIGRlbGV0ZSB0aGlzLl92aWV3UmVnaXN0cnlbKDAsIF92aWV3cy5nZXRWaWV3SWQpKHZpZXcpXTsKICAgIH07CgogICAgX3Byb3RvNDUucmVtb3ZlID0gZnVuY3Rpb24gcmVtb3ZlKHZpZXcpIHsKICAgICAgdmlldy5fdHJhbnNpdGlvblRvKCdkZXN0cm95aW5nJyk7CgogICAgICB0aGlzLmNsZWFudXBSb290Rm9yKHZpZXcpOwoKICAgICAgaWYgKHRoaXMuX2Rlc3RpbmVkRm9yRE9NKSB7CiAgICAgICAgdmlldy50cmlnZ2VyKCdkaWREZXN0cm95RWxlbWVudCcpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzQ1LmNsZWFudXBSb290Rm9yID0gZnVuY3Rpb24gY2xlYW51cFJvb3RGb3IodmlldykgewogICAgICAvLyBubyBuZWVkIHRvIGNsZWFudXAgcm9vdHMgaWYgd2UgaGF2ZSBhbHJlYWR5IGJlZW4gZGVzdHJveWVkCiAgICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciByb290cyA9IHRoaXMuX3Jvb3RzOyAvLyB0cmF2ZXJzZSBpbiByZXZlcnNlIHNvIHdlIGNhbiByZW1vdmUgaXRlbXMKICAgICAgLy8gd2l0aG91dCBtdWNraW5nIHVwIHRoZSBpbmRleAoKICAgICAgdmFyIGkgPSB0aGlzLl9yb290cy5sZW5ndGg7CgogICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgdmFyIHJvb3QgPSByb290c1tpXTsKCiAgICAgICAgaWYgKHJvb3QuaXNGb3IodmlldykpIHsKICAgICAgICAgIHJvb3QuZGVzdHJveSgpOwogICAgICAgICAgcm9vdHMuc3BsaWNlKGksIDEpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG80NS5kZXN0cm95ID0gZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5fZGVzdHJveWVkID0gdHJ1ZTsKCiAgICAgIHRoaXMuX2NsZWFyQWxsUm9vdHMoKTsKICAgIH07CgogICAgX3Byb3RvNDUuZ2V0Qm91bmRzID0gZnVuY3Rpb24gZ2V0Qm91bmRzKHZpZXcpIHsKICAgICAgdmFyIGJvdW5kcyA9IHZpZXdbQk9VTkRTXTsKICAgICAgKGZhbHNlICYmICEoQm9vbGVhbihib3VuZHMpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ29iamVjdCBwYXNzZWQgdG8gZ2V0Qm91bmRzIG11c3QgaGF2ZSB0aGUgQk9VTkRTIHN5bWJvbCBhcyBhIHByb3BlcnR5JywgQm9vbGVhbihib3VuZHMpKSk7CiAgICAgIHZhciBwYXJlbnRFbGVtZW50ID0gYm91bmRzLnBhcmVudEVsZW1lbnQoKTsKICAgICAgdmFyIGZpcnN0Tm9kZSA9IGJvdW5kcy5maXJzdE5vZGUoKTsKICAgICAgdmFyIGxhc3ROb2RlID0gYm91bmRzLmxhc3ROb2RlKCk7CiAgICAgIHJldHVybiB7CiAgICAgICAgcGFyZW50RWxlbWVudDogcGFyZW50RWxlbWVudCwKICAgICAgICBmaXJzdE5vZGU6IGZpcnN0Tm9kZSwKICAgICAgICBsYXN0Tm9kZTogbGFzdE5vZGUKICAgICAgfTsKICAgIH07CgogICAgX3Byb3RvNDUuY3JlYXRlRWxlbWVudCA9IGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQodGFnTmFtZSkgewogICAgICByZXR1cm4gdGhpcy5fZW52LmdldEFwcGVuZE9wZXJhdGlvbnMoKS5jcmVhdGVFbGVtZW50KHRhZ05hbWUpOwogICAgfTsKCiAgICBfcHJvdG80NS5fcmVuZGVyUm9vdCA9IGZ1bmN0aW9uIF9yZW5kZXJSb290KHJvb3QpIHsKICAgICAgdmFyIHJvb3RzID0gdGhpcy5fcm9vdHM7CiAgICAgIHJvb3RzLnB1c2gocm9vdCk7CgogICAgICBpZiAocm9vdHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgcmVnaXN0ZXIodGhpcyk7CiAgICAgIH0KCiAgICAgIHRoaXMuX3JlbmRlclJvb3RzVHJhbnNhY3Rpb24oKTsKICAgIH07CgogICAgX3Byb3RvNDUuX3JlbmRlclJvb3RzID0gZnVuY3Rpb24gX3JlbmRlclJvb3RzKCkgewogICAgICB2YXIgcm9vdHMgPSB0aGlzLl9yb290cywKICAgICAgICAgIGVudiA9IHRoaXMuX2VudiwKICAgICAgICAgIHJlbW92ZWRSb290cyA9IHRoaXMuX3JlbW92ZWRSb290czsKICAgICAgdmFyIGdsb2JhbFNob3VsZFJlZmx1c2ggPSBmYWxzZTsKICAgICAgdmFyIGluaXRpYWxSb290c0xlbmd0aDsKCiAgICAgIGRvIHsKICAgICAgICBlbnYuYmVnaW4oKTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIC8vIGVuc3VyZSB0aGF0IGZvciB0aGUgZmlyc3QgaXRlcmF0aW9uIG9mIHRoZSBsb29wCiAgICAgICAgICAvLyBlYWNoIHJvb3QgaXMgcHJvY2Vzc2VkCiAgICAgICAgICBpbml0aWFsUm9vdHNMZW5ndGggPSByb290cy5sZW5ndGg7CiAgICAgICAgICBnbG9iYWxTaG91bGRSZWZsdXNoID0gZmFsc2U7CgogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByb290cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgcm9vdCA9IHJvb3RzW2ldOwoKICAgICAgICAgICAgaWYgKHJvb3QuZGVzdHJveWVkKSB7CiAgICAgICAgICAgICAgLy8gYWRkIHRvIHRoZSBsaXN0IG9mIHJvb3RzIHRvIGJlIHJlbW92ZWQKICAgICAgICAgICAgICAvLyB0aGV5IHdpbGwgYmUgcmVtb3ZlZCBmcm9tIGB0aGlzLl9yb290c2AgbGF0ZXIKICAgICAgICAgICAgICByZW1vdmVkUm9vdHMucHVzaChyb290KTsgLy8gc2tpcCBvdmVyIHJvb3RzIHRoYXQgaGF2ZSBiZWVuIG1hcmtlZCBhcyBkZXN0cm95ZWQKCiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBzaG91bGRSZWZsdXNoID0gcm9vdC5zaG91bGRSZWZsdXNoOyAvLyB3aGVuIHByb2Nlc3Npbmcgbm9uLWluaXRpYWwgcmVmbHVzaCBsb29wcywKICAgICAgICAgICAgLy8gZG8gbm90IHByb2Nlc3MgbW9yZSByb290cyB0aGFuIG5lZWRlZAoKICAgICAgICAgICAgaWYgKGkgPj0gaW5pdGlhbFJvb3RzTGVuZ3RoICYmICFzaG91bGRSZWZsdXNoKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJvb3Qub3B0aW9ucy5hbHdheXNSZXZhbGlkYXRlID0gc2hvdWxkUmVmbHVzaDsgLy8gdHJhY2sgc2hvdWxkUmVmbHVzaCBiYXNlZCBvbiB0aGlzIHJvb3RzIHJlbmRlciByZXN1bHQKCiAgICAgICAgICAgIHNob3VsZFJlZmx1c2ggPSByb290LnNob3VsZFJlZmx1c2ggPSAoMCwgX21ldGFsLnJ1bkluVHJhbnNhY3Rpb24pKHJvb3QsICdyZW5kZXInKTsgLy8gZ2xvYmFsU2hvdWxkUmVmbHVzaCBzaG91bGQgYmUgYHRydWVgIGlmICphbnkqIG9mCiAgICAgICAgICAgIC8vIHRoZSByb290cyBuZWVkIHRvIHJlZmx1c2gKCiAgICAgICAgICAgIGdsb2JhbFNob3VsZFJlZmx1c2ggPSBnbG9iYWxTaG91bGRSZWZsdXNoIHx8IHNob3VsZFJlZmx1c2g7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5fbGFzdFJldmlzaW9uID0gKDAsIF9yZWZlcmVuY2UudmFsdWUpKF9yZWZlcmVuY2UuQ1VSUkVOVF9UQUcpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBlbnYuY29tbWl0KCk7CiAgICAgICAgfQogICAgICB9IHdoaWxlIChnbG9iYWxTaG91bGRSZWZsdXNoIHx8IHJvb3RzLmxlbmd0aCA+IGluaXRpYWxSb290c0xlbmd0aCk7IC8vIHJlbW92ZSBhbnkgcm9vdHMgdGhhdCB3ZXJlIGRlc3Ryb3llZCBkdXJpbmcgdGhpcyB0cmFuc2FjdGlvbgoKCiAgICAgIHdoaWxlIChyZW1vdmVkUm9vdHMubGVuZ3RoKSB7CiAgICAgICAgdmFyIF9yb290ID0gcmVtb3ZlZFJvb3RzLnBvcCgpOwoKICAgICAgICB2YXIgcm9vdEluZGV4ID0gcm9vdHMuaW5kZXhPZihfcm9vdCk7CiAgICAgICAgcm9vdHMuc3BsaWNlKHJvb3RJbmRleCwgMSk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9yb290cy5sZW5ndGggPT09IDApIHsKICAgICAgICBkZXJlZ2lzdGVyKHRoaXMpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzQ1Ll9yZW5kZXJSb290c1RyYW5zYWN0aW9uID0gZnVuY3Rpb24gX3JlbmRlclJvb3RzVHJhbnNhY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLl9pc1JlbmRlcmluZ1Jvb3RzKSB7CiAgICAgICAgLy8gY3VycmVudGx5IHJlbmRlcmluZyByb290cywgYSBuZXcgcm9vdCB3YXMgYWRkZWQgYW5kIHdpbGwKICAgICAgICAvLyBiZSBwcm9jZXNzZWQgYnkgdGhlIGV4aXN0aW5nIF9yZW5kZXJSb290cyBpbnZvY2F0aW9uCiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vIHVzZWQgdG8gcHJldmVudCBjYWxsaW5nIF9yZW5kZXJSb290cyBhZ2FpbiAoc2VlIGFib3ZlKQogICAgICAvLyB3aGlsZSB3ZSBhcmUgYWN0aXZlbHkgcmVuZGVyaW5nIHJvb3RzCgoKICAgICAgdGhpcy5faXNSZW5kZXJpbmdSb290cyA9IHRydWU7CiAgICAgIHZhciBjb21wbGV0ZWRXaXRob3V0RXJyb3IgPSBmYWxzZTsKCiAgICAgIHRyeSB7CiAgICAgICAgdGhpcy5fcmVuZGVyUm9vdHMoKTsKCiAgICAgICAgY29tcGxldGVkV2l0aG91dEVycm9yID0gdHJ1ZTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBpZiAoIWNvbXBsZXRlZFdpdGhvdXRFcnJvcikgewogICAgICAgICAgdGhpcy5fbGFzdFJldmlzaW9uID0gKDAsIF9yZWZlcmVuY2UudmFsdWUpKF9yZWZlcmVuY2UuQ1VSUkVOVF9UQUcpOwoKICAgICAgICAgIGlmICh0aGlzLl9lbnYuaW5UcmFuc2FjdGlvbiA9PT0gdHJ1ZSkgewogICAgICAgICAgICB0aGlzLl9lbnYuY29tbWl0KCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9pc1JlbmRlcmluZ1Jvb3RzID0gZmFsc2U7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNDUuX2NsZWFyQWxsUm9vdHMgPSBmdW5jdGlvbiBfY2xlYXJBbGxSb290cygpIHsKICAgICAgdmFyIHJvb3RzID0gdGhpcy5fcm9vdHM7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvb3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIHJvb3QgPSByb290c1tpXTsKICAgICAgICByb290LmRlc3Ryb3koKTsKICAgICAgfQoKICAgICAgdGhpcy5fcmVtb3ZlZFJvb3RzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMuX3Jvb3RzID0gW107IC8vIGlmIHJvb3RzIHdlcmUgcHJlc2VudCBiZWZvcmUgZGVzdHJveWluZwogICAgICAvLyBkZXJlZ2lzdGVyIHRoaXMgcmVuZGVyZXIgaW5zdGFuY2UKCiAgICAgIGlmIChyb290cy5sZW5ndGgpIHsKICAgICAgICBkZXJlZ2lzdGVyKHRoaXMpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzQ1Ll9zY2hlZHVsZVJldmFsaWRhdGUgPSBmdW5jdGlvbiBfc2NoZWR1bGVSZXZhbGlkYXRlKCkgewogICAgICBfcnVubG9vcC5iYWNrYnVybmVyLnNjaGVkdWxlT25jZSgncmVuZGVyJywgdGhpcywgdGhpcy5fcmV2YWxpZGF0ZSk7CiAgICB9OwoKICAgIF9wcm90bzQ1Ll9pc1ZhbGlkID0gZnVuY3Rpb24gX2lzVmFsaWQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9kZXN0cm95ZWQgfHwgdGhpcy5fcm9vdHMubGVuZ3RoID09PSAwIHx8ICgwLCBfcmVmZXJlbmNlLnZhbGlkYXRlKShfcmVmZXJlbmNlLkNVUlJFTlRfVEFHLCB0aGlzLl9sYXN0UmV2aXNpb24pOwogICAgfTsKCiAgICBfcHJvdG80NS5fcmV2YWxpZGF0ZSA9IGZ1bmN0aW9uIF9yZXZhbGlkYXRlKCkgewogICAgICBpZiAodGhpcy5faXNWYWxpZCgpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl9yZW5kZXJSb290c1RyYW5zYWN0aW9uKCk7CiAgICB9OwoKICAgIHJldHVybiBSZW5kZXJlcjsKICB9KCk7CgogIF9leHBvcnRzLlJlbmRlcmVyID0gUmVuZGVyZXI7CgogIHZhciBJbmVydFJlbmRlcmVyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9SZW5kZXJlcikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKEluZXJ0UmVuZGVyZXIsIF9SZW5kZXJlcik7CgogICAgZnVuY3Rpb24gSW5lcnRSZW5kZXJlcigpIHsKICAgICAgcmV0dXJuIF9SZW5kZXJlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICB9CgogICAgSW5lcnRSZW5kZXJlci5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUoX3JlZjEwKSB7CiAgICAgIHZhciBlbnYgPSBfcmVmMTAuZW52LAogICAgICAgICAgcm9vdFRlbXBsYXRlID0gX3JlZjEwLnJvb3RUZW1wbGF0ZSwKICAgICAgICAgIF92aWV3UmVnaXN0cnkgPSBfcmVmMTAuX3ZpZXdSZWdpc3RyeSwKICAgICAgICAgIGJ1aWxkZXIgPSBfcmVmMTAuYnVpbGRlcjsKICAgICAgcmV0dXJuIG5ldyB0aGlzKGVudiwgcm9vdFRlbXBsYXRlLCBfdmlld1JlZ2lzdHJ5LCBmYWxzZSwgYnVpbGRlcik7CiAgICB9OwoKICAgIHZhciBfcHJvdG80NiA9IEluZXJ0UmVuZGVyZXIucHJvdG90eXBlOwoKICAgIF9wcm90bzQ2LmdldEVsZW1lbnQgPSBmdW5jdGlvbiBnZXRFbGVtZW50KF92aWV3KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQWNjZXNzaW5nIGB0aGlzLmVsZW1lbnRgIGlzIG5vdCBhbGxvd2VkIGluIG5vbi1pbnRlcmFjdGl2ZSBlbnZpcm9ubWVudHMgKHN1Y2ggYXMgRmFzdEJvb3QpLicpOwogICAgfTsKCiAgICByZXR1cm4gSW5lcnRSZW5kZXJlcjsKICB9KFJlbmRlcmVyKTsKCiAgX2V4cG9ydHMuSW5lcnRSZW5kZXJlciA9IEluZXJ0UmVuZGVyZXI7CgogIHZhciBJbnRlcmFjdGl2ZVJlbmRlcmVyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9SZW5kZXJlcjIpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShJbnRlcmFjdGl2ZVJlbmRlcmVyLCBfUmVuZGVyZXIyKTsKCiAgICBmdW5jdGlvbiBJbnRlcmFjdGl2ZVJlbmRlcmVyKCkgewogICAgICByZXR1cm4gX1JlbmRlcmVyMi5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICB9CgogICAgSW50ZXJhY3RpdmVSZW5kZXJlci5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUoX3JlZjExKSB7CiAgICAgIHZhciBlbnYgPSBfcmVmMTEuZW52LAogICAgICAgICAgcm9vdFRlbXBsYXRlID0gX3JlZjExLnJvb3RUZW1wbGF0ZSwKICAgICAgICAgIF92aWV3UmVnaXN0cnkgPSBfcmVmMTEuX3ZpZXdSZWdpc3RyeSwKICAgICAgICAgIGJ1aWxkZXIgPSBfcmVmMTEuYnVpbGRlcjsKICAgICAgcmV0dXJuIG5ldyB0aGlzKGVudiwgcm9vdFRlbXBsYXRlLCBfdmlld1JlZ2lzdHJ5LCB0cnVlLCBidWlsZGVyKTsKICAgIH07CgogICAgdmFyIF9wcm90bzQ3ID0gSW50ZXJhY3RpdmVSZW5kZXJlci5wcm90b3R5cGU7CgogICAgX3Byb3RvNDcuZ2V0RWxlbWVudCA9IGZ1bmN0aW9uIGdldEVsZW1lbnQodmlldykgewogICAgICByZXR1cm4gKDAsIF92aWV3cy5nZXRWaWV3RWxlbWVudCkodmlldyk7CiAgICB9OwoKICAgIHJldHVybiBJbnRlcmFjdGl2ZVJlbmRlcmVyOwogIH0oUmVuZGVyZXIpOwoKICBfZXhwb3J0cy5JbnRlcmFjdGl2ZVJlbmRlcmVyID0gSW50ZXJhY3RpdmVSZW5kZXJlcjsKICB2YXIgVEVNUExBVEVTID0ge307CgogIGZ1bmN0aW9uIHNldFRlbXBsYXRlcyh0ZW1wbGF0ZXMpIHsKICAgIFRFTVBMQVRFUyA9IHRlbXBsYXRlczsKICB9CgogIGZ1bmN0aW9uIGdldFRlbXBsYXRlcygpIHsKICAgIHJldHVybiBURU1QTEFURVM7CiAgfQoKICBmdW5jdGlvbiBnZXRUZW1wbGF0ZShuYW1lKSB7CiAgICBpZiAoVEVNUExBVEVTLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgIHJldHVybiBURU1QTEFURVNbbmFtZV07CiAgICB9CiAgfQoKICBmdW5jdGlvbiBoYXNUZW1wbGF0ZShuYW1lKSB7CiAgICByZXR1cm4gVEVNUExBVEVTLmhhc093blByb3BlcnR5KG5hbWUpOwogIH0KCiAgZnVuY3Rpb24gc2V0VGVtcGxhdGUobmFtZSwgdGVtcGxhdGUpIHsKICAgIHJldHVybiBURU1QTEFURVNbbmFtZV0gPSB0ZW1wbGF0ZTsKICB9CgogIHZhciBJbnRlcm5hbENvbXBvbmVudERlZmluaXRpb24gPSBmdW5jdGlvbiBJbnRlcm5hbENvbXBvbmVudERlZmluaXRpb24obWFuYWdlciwgQ29tcG9uZW50Q2xhc3MsIGxheW91dCkgewogICAgdGhpcy5tYW5hZ2VyID0gbWFuYWdlcjsKICAgIHRoaXMuc3RhdGUgPSB7CiAgICAgIENvbXBvbmVudENsYXNzOiBDb21wb25lbnRDbGFzcywKICAgICAgbGF5b3V0OiBsYXlvdXQKICAgIH07CiAgfTsKCiAgdmFyIEludGVybmFsTWFuYWdlciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfQWJzdHJhY3RNYW5hZ2VyMykgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKEludGVybmFsTWFuYWdlciwgX0Fic3RyYWN0TWFuYWdlcjMpOwoKICAgIGZ1bmN0aW9uIEludGVybmFsTWFuYWdlcihvd25lcikgewogICAgICB2YXIgX3RoaXMyMjsKCiAgICAgIF90aGlzMjIgPSBfQWJzdHJhY3RNYW5hZ2VyMy5jYWxsKHRoaXMpIHx8IHRoaXM7CiAgICAgIF90aGlzMjIub3duZXIgPSBvd25lcjsKICAgICAgcmV0dXJuIF90aGlzMjI7CiAgICB9CgogICAgdmFyIF9wcm90bzQ4ID0gSW50ZXJuYWxNYW5hZ2VyLnByb3RvdHlwZTsKCiAgICBfcHJvdG80OC5nZXRMYXlvdXQgPSBmdW5jdGlvbiBnZXRMYXlvdXQoX3JlZjEyKSB7CiAgICAgIHZhciBfbGF5b3V0ID0gX3JlZjEyLmxheW91dDsKCiAgICAgIHZhciBsYXlvdXQgPSBfbGF5b3V0LmFzTGF5b3V0KCk7CgogICAgICByZXR1cm4gewogICAgICAgIGhhbmRsZTogbGF5b3V0LmNvbXBpbGUoKSwKICAgICAgICBzeW1ib2xUYWJsZTogbGF5b3V0LnN5bWJvbFRhYmxlCiAgICAgIH07CiAgICB9OwoKICAgIHJldHVybiBJbnRlcm5hbE1hbmFnZXI7CiAgfShBYnN0cmFjdE1hbmFnZXIpOwoKICB2YXIgQ0FQQUJJTElUSUVTJDEgPSB7CiAgICBkeW5hbWljTGF5b3V0OiBmYWxzZSwKICAgIGR5bmFtaWNUYWc6IGZhbHNlLAogICAgcHJlcGFyZUFyZ3M6IHRydWUsCiAgICBjcmVhdGVBcmdzOiB0cnVlLAogICAgYXR0cmlidXRlSG9vazogZmFsc2UsCiAgICBlbGVtZW50SG9vazogZmFsc2UsCiAgICBjcmVhdGVDYWxsZXI6IHRydWUsCiAgICBkeW5hbWljU2NvcGU6IGZhbHNlLAogICAgdXBkYXRlSG9vazogdHJ1ZSwKICAgIGNyZWF0ZUluc3RhbmNlOiB0cnVlCiAgfTsKICB2YXIgRU1QVFlfUE9TSVRJT05BTF9BUkdTJDEgPSBbXTsKICAoMCwgX2RlYnVnLmRlYnVnRnJlZXplKShFTVBUWV9QT1NJVElPTkFMX0FSR1MkMSk7CgogIHZhciBJbnB1dENvbXBvbmVudE1hbmFnZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0ludGVybmFsTWFuYWdlcikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKElucHV0Q29tcG9uZW50TWFuYWdlciwgX0ludGVybmFsTWFuYWdlcik7CgogICAgZnVuY3Rpb24gSW5wdXRDb21wb25lbnRNYW5hZ2VyKCkgewogICAgICByZXR1cm4gX0ludGVybmFsTWFuYWdlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICB9CgogICAgdmFyIF9wcm90bzQ5ID0gSW5wdXRDb21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZTsKCiAgICBfcHJvdG80OS5nZXRDYXBhYmlsaXRpZXMgPSBmdW5jdGlvbiBnZXRDYXBhYmlsaXRpZXMoKSB7CiAgICAgIHJldHVybiBDQVBBQklMSVRJRVMkMTsKICAgIH07CgogICAgX3Byb3RvNDkucHJlcGFyZUFyZ3MgPSBmdW5jdGlvbiBwcmVwYXJlQXJncyhfc3RhdGUsIGFyZ3MpIHsKICAgICAgKGZhbHNlICYmICEoYXJncy5wb3NpdGlvbmFsLmxlbmd0aCA9PT0gMCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUaGUgYDxJbnB1dCAvPmAgY29tcG9uZW50IGRvZXMgbm90IHRha2UgYW55IHBvc2l0aW9uYWwgYXJndW1lbnRzJywgYXJncy5wb3NpdGlvbmFsLmxlbmd0aCA9PT0gMCkpOwogICAgICB2YXIgX19BUkdTX18gPSBhcmdzLm5hbWVkLmNhcHR1cmUoKS5tYXA7CiAgICAgIHJldHVybiB7CiAgICAgICAgcG9zaXRpb25hbDogRU1QVFlfUE9TSVRJT05BTF9BUkdTJDEsCiAgICAgICAgbmFtZWQ6IHsKICAgICAgICAgIF9fQVJHU19fOiBuZXcgUm9vdFJlZmVyZW5jZShfX0FSR1NfXyksCiAgICAgICAgICB0eXBlOiBhcmdzLm5hbWVkLmdldCgndHlwZScpCiAgICAgICAgfQogICAgICB9OwogICAgfTsKCiAgICBfcHJvdG80OS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUoZW52LCBfcmVmMTMsIGFyZ3MsIF9keW5hbWljU2NvcGUsIGNhbGxlcikgewogICAgICB2YXIgQ29tcG9uZW50Q2xhc3MgPSBfcmVmMTMuQ29tcG9uZW50Q2xhc3M7CiAgICAgIChmYWxzZSAmJiAhKCgwLCBfcmVmZXJlbmNlLmlzQ29uc3QpKGNhbGxlcikpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnY2FsbGVyIG11c3QgYmUgY29uc3QnLCAoMCwgX3JlZmVyZW5jZS5pc0NvbnN0KShjYWxsZXIpKSk7CiAgICAgIHZhciB0eXBlID0gYXJncy5uYW1lZC5nZXQoJ3R5cGUnKTsKICAgICAgdmFyIGluc3RhbmNlID0gQ29tcG9uZW50Q2xhc3MuY3JlYXRlKHsKICAgICAgICBjYWxsZXI6IGNhbGxlci52YWx1ZSgpLAogICAgICAgIHR5cGU6IHR5cGUudmFsdWUoKQogICAgICB9KTsKICAgICAgdmFyIHN0YXRlID0gewogICAgICAgIGVudjogZW52LAogICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgaW5zdGFuY2U6IGluc3RhbmNlCiAgICAgIH07CgogICAgICBpZiAoX2Vudmlyb25tZW50Mi5FTlYuX0RFQlVHX1JFTkRFUl9UUkVFKSB7CiAgICAgICAgZW52LmRlYnVnUmVuZGVyVHJlZS5jcmVhdGUoc3RhdGUsIHsKICAgICAgICAgIHR5cGU6ICdjb21wb25lbnQnLAogICAgICAgICAgbmFtZTogJ2lucHV0JywKICAgICAgICAgIGFyZ3M6IGFyZ3MuY2FwdHVyZSgpLAogICAgICAgICAgaW5zdGFuY2U6IGluc3RhbmNlCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBzdGF0ZTsKICAgIH07CgogICAgX3Byb3RvNDkuZ2V0U2VsZiA9IGZ1bmN0aW9uIGdldFNlbGYoX3JlZjE0KSB7CiAgICAgIHZhciBpbnN0YW5jZSA9IF9yZWYxNC5pbnN0YW5jZTsKICAgICAgcmV0dXJuIG5ldyBSb290UmVmZXJlbmNlKGluc3RhbmNlKTsKICAgIH07CgogICAgX3Byb3RvNDkuZ2V0VGFnID0gZnVuY3Rpb24gZ2V0VGFnKCkgewogICAgICBpZiAoX2Vudmlyb25tZW50Mi5FTlYuX0RFQlVHX1JFTkRFUl9UUkVFKSB7CiAgICAgICAgLy8gcmV0dXJuaW5nIGEgY29uc3QgdGFnIHNraXBzIHRoZSB1cGRhdGUgaG9vayAoVk0gQlVHPykKICAgICAgICByZXR1cm4gKDAsIF9yZWZlcmVuY2UuY3JlYXRlVGFnKSgpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGFuIG91dGxldCBoYXMgbm8gaG9va3MKICAgICAgICByZXR1cm4gX3JlZmVyZW5jZS5DT05TVEFOVF9UQUc7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNDkuZGlkUmVuZGVyTGF5b3V0ID0gZnVuY3Rpb24gZGlkUmVuZGVyTGF5b3V0KHN0YXRlLCBib3VuZHMpIHsKICAgICAgaWYgKF9lbnZpcm9ubWVudDIuRU5WLl9ERUJVR19SRU5ERVJfVFJFRSkgewogICAgICAgIHN0YXRlLmVudi5kZWJ1Z1JlbmRlclRyZWUuZGlkUmVuZGVyKHN0YXRlLCBib3VuZHMpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzQ5LnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZShzdGF0ZSkgewogICAgICAoMCwgX21ldGFsLnNldCkoc3RhdGUuaW5zdGFuY2UsICd0eXBlJywgc3RhdGUudHlwZS52YWx1ZSgpKTsKCiAgICAgIGlmIChfZW52aXJvbm1lbnQyLkVOVi5fREVCVUdfUkVOREVSX1RSRUUpIHsKICAgICAgICBzdGF0ZS5lbnYuZGVidWdSZW5kZXJUcmVlLnVwZGF0ZShzdGF0ZSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNDkuZGlkVXBkYXRlTGF5b3V0ID0gZnVuY3Rpb24gZGlkVXBkYXRlTGF5b3V0KHN0YXRlLCBib3VuZHMpIHsKICAgICAgaWYgKF9lbnZpcm9ubWVudDIuRU5WLl9ERUJVR19SRU5ERVJfVFJFRSkgewogICAgICAgIHN0YXRlLmVudi5kZWJ1Z1JlbmRlclRyZWUuZGlkUmVuZGVyKHN0YXRlLCBib3VuZHMpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzQ5LmdldERlc3RydWN0b3IgPSBmdW5jdGlvbiBnZXREZXN0cnVjdG9yKHN0YXRlKSB7CiAgICAgIGlmIChfZW52aXJvbm1lbnQyLkVOVi5fREVCVUdfUkVOREVSX1RSRUUpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICAgICAgc3RhdGUuZW52LmRlYnVnUmVuZGVyVHJlZS53aWxsRGVzdHJveShzdGF0ZSk7CiAgICAgICAgICAgIHN0YXRlLmluc3RhbmNlLmRlc3Ryb3koKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBzdGF0ZS5pbnN0YW5jZTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gSW5wdXRDb21wb25lbnRNYW5hZ2VyOwogIH0oSW50ZXJuYWxNYW5hZ2VyKTsKCiAgdmFyIElucHV0Q29tcG9uZW50TWFuYWdlckZhY3RvcnkgPSBmdW5jdGlvbiBJbnB1dENvbXBvbmVudE1hbmFnZXJGYWN0b3J5KG93bmVyKSB7CiAgICByZXR1cm4gbmV3IElucHV0Q29tcG9uZW50TWFuYWdlcihvd25lcik7CiAgfTsKCiAgdmFyIE1BTkFHRVJTID0gbmV3IFdlYWtNYXAoKTsKICB2YXIgZ2V0UHJvdG90eXBlT2YgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Y7CgogIGZ1bmN0aW9uIHNldE1hbmFnZXIod3JhcHBlciwgb2JqKSB7CiAgICBNQU5BR0VSUy5zZXQob2JqLCB3cmFwcGVyKTsKICAgIHJldHVybiBvYmo7CiAgfQoKICBmdW5jdGlvbiBnZXRNYW5hZ2VyKG9iaikgewogICAgdmFyIHBvaW50ZXIgPSBvYmo7CgogICAgd2hpbGUgKHBvaW50ZXIgIT09IHVuZGVmaW5lZCAmJiBwb2ludGVyICE9PSBudWxsKSB7CiAgICAgIHZhciBtYW5hZ2VyID0gTUFOQUdFUlMuZ2V0KHBvaW50ZXIpOwoKICAgICAgaWYgKG1hbmFnZXIgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBtYW5hZ2VyOwogICAgICB9CgogICAgICBwb2ludGVyID0gZ2V0UHJvdG90eXBlT2YocG9pbnRlcik7CiAgICB9CgogICAgcmV0dXJuIG51bGw7CiAgfQogIC8qKgogIEBtb2R1bGUgQGVtYmVyL2NvbXBvbmVudAogICovCgogIC8qKgogICAgU2VlIFtFbWJlci5UZW1wbGF0ZXMuY29tcG9uZW50cy5JbnB1dF0oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9FbWJlci5UZW1wbGF0ZXMuY29tcG9uZW50cy9tZXRob2RzL0lucHV0P2FuY2hvcj1JbnB1dCkuCiAgCiAgICBAbWV0aG9kIGlucHV0CiAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICBAcGFyYW0ge0hhc2h9IG9wdGlvbnMKICAgIEBwdWJsaWMKICAgICovCgogIC8qKgogICAgVGhlIGBJbnB1dGAgY29tcG9uZW50IGxldHMgeW91IGNyZWF0ZSBhbiBIVE1MIGA8aW5wdXQ+YCBlbGVtZW50LgogIAogICAgYGBgaGFuZGxlYmFycwogICAgPElucHV0IEB2YWx1ZT0iOTg3IiAvPgogICAgYGBgCiAgCiAgICBjcmVhdGVzIGFuIGA8aW5wdXQ+YCBlbGVtZW50IHdpdGggYHR5cGU9InRleHQiYCBhbmQgdmFsdWUgc2V0IHRvIDk4Ny4KICAKICAgICMjIyBUZXh0IGZpZWxkCiAgCiAgICBJZiBubyBgdHlwZWAgYXJndW1lbnQgaXMgc3BlY2lmaWVkLCBhIGRlZmF1bHQgb2YgdHlwZSAndGV4dCcgaXMgdXNlZC4KICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIFNlYXJjaDoKICAgIDxJbnB1dCBAdmFsdWU9e3t0aGlzLnNlYXJjaFdvcmR9fT4KICAgIGBgYAogIAogICAgSW4gdGhpcyBleGFtcGxlLCB0aGUgaW5pdGlhbCB2YWx1ZSBpbiB0aGUgYDxpbnB1dD5gIHdpbGwgYmUgc2V0IHRvIHRoZSB2YWx1ZSBvZgogICAgYHRoaXMuc2VhcmNoV29yZGAuIElmIHRoZSB1c2VyIGNoYW5nZXMgdGhlIHRleHQsIHRoZSB2YWx1ZSBvZiBgdGhpcy5zZWFyY2hXb3JkYCB3aWxsIGFsc28gYmUKICAgIHVwZGF0ZWQuCiAgCiAgICAjIyMgQWN0aW9ucwogIAogICAgVGhlIGBJbnB1dGAgY29tcG9uZW50IHRha2VzIGEgbnVtYmVyIG9mIGFyZ3VtZW50cyB3aXRoIGNhbGxiYWNrcyB0aGF0IGFyZSBpbnZva2VkIGluIHJlc3BvbnNlIHRvCiAgICB1c2VyIGV2ZW50cy4KICAKICAgICogYGVudGVyYAogICAgKiBgaW5zZXJ0LW5ld2xpbmVgCiAgICAqIGBlc2NhcGUtcHJlc3NgCiAgICAqIGBmb2N1cy1pbmAKICAgICogYGZvY3VzLW91dGAKICAgICogYGtleS1wcmVzc2AKICAgICogYGtleS11cGAKICAKICAgIFRoZXNlIGNhbGxiYWNrcyBhcmUgcGFzc2VkIHRvIGBJbnB1dGAgbGlrZSB0aGlzOgogIAogICAgYGBgaGFuZGxlYmFycwogICAgPElucHV0IEB2YWx1ZT17e3RoaXMuc2VhcmNoV29yZH19IEBlbnRlcj17e3RoaXMucXVlcnl9fSAvPgogICAgYGBgCiAgCiAgICAjIyMgYDxpbnB1dD5gIEhUTUwgQXR0cmlidXRlcyB0byBBdm9pZAogIAogICAgSW4gbW9zdCBjYXNlcywgaWYgeW91IHdhbnQgdG8gcGFzcyBhbiBhdHRyaWJ1dGUgdG8gdGhlIHVuZGVybHlpbmcgSFRNTCBgPGlucHV0PmAgZWxlbWVudCwgeW91CiAgICBjYW4gcGFzcyB0aGUgYXR0cmlidXRlIGRpcmVjdGx5LCBqdXN0IGxpa2UgYW55IG90aGVyIEVtYmVyIGNvbXBvbmVudC4KICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxJbnB1dCBAdHlwZT0idGV4dCIgc2l6ZT0iMTAiIC8+CiAgICBgYGAKICAKICAgIEluIHRoaXMgZXhhbXBsZSwgdGhlIGBzaXplYCBhdHRyaWJ1dGUgd2lsbCBiZSBhcHBsaWVkIHRvIHRoZSB1bmRlcmx5aW5nIGA8aW5wdXQ+YCBlbGVtZW50IGluIHRoZQogICAgb3V0cHV0dGVkIEhUTUwuCiAgCiAgICBIb3dldmVyLCB0aGVyZSBhcmUgYSBmZXcgYXR0cmlidXRlcyB3aGVyZSB5b3UgKiptdXN0KiogdXNlIHRoZSBgQGAgdmVyc2lvbi4KICAKICAgICogYEB0eXBlYDogVGhpcyBhcmd1bWVudCBpcyB1c2VkIHRvIGNvbnRyb2wgd2hpY2ggRW1iZXIgY29tcG9uZW50IGlzIHVzZWQgdW5kZXIgdGhlIGhvb2QKICAgICogYEB2YWx1ZWA6IFRoZSBgQHZhbHVlYCBhcmd1bWVudCBpbnN0YWxscyBhIHR3by13YXkgYmluZGluZyBvbnRvIHRoZSBlbGVtZW50LiBJZiB5b3Ugd2FudGVkIGEKICAgICAgb25lLXdheSBiaW5kaW5nLCB1c2UgYDxpbnB1dD5gIHdpdGggdGhlIGB2YWx1ZWAgcHJvcGVydHkgYW5kIHRoZSBgaW5wdXRgIGV2ZW50IGluc3RlYWQuCiAgICAqIGBAY2hlY2tlZGAgKGZvciBjaGVja2JveGVzKTogbGlrZSBgQHZhbHVlYCwgdGhlIGBAY2hlY2tlZGAgYXJndW1lbnQgaW5zdGFsbHMgYSB0d28td2F5IGJpbmRpbmcKICAgICAgb250byB0aGUgZWxlbWVudC4gSWYgeW91IHdhbnRlZCBhIG9uZS13YXkgYmluZGluZywgdXNlIGA8aW5wdXQgdHlwZT0iY2hlY2tib3giPmAgd2l0aAogICAgICBgY2hlY2tlZGAgYW5kIHRoZSBgaW5wdXRgIGV2ZW50IGluc3RlYWQuCiAgCiAgICAjIyMgRXh0ZW5kaW5nIGBUZXh0RmllbGRgCiAgCiAgICBJbnRlcm5hbGx5LCBgPElucHV0IEB0eXBlPSJ0ZXh0IiAvPmAgY3JlYXRlcyBhbiBpbnN0YW5jZSBvZiBgVGV4dEZpZWxkYCwgcGFzc2luZyBhcmd1bWVudHMgZnJvbQogICAgdGhlIGhlbHBlciB0byBgVGV4dEZpZWxkYCdzIGBjcmVhdGVgIG1ldGhvZC4gU3ViY2xhc3NpbmcgYFRleHRGaWVsZGAgaXMgc3VwcG9ydGVkIGJ1dCBub3QKICAgIHJlY29tbWVuZGVkLgogIAogICAgU2VlIFtUZXh0RmllbGRdKC9lbWJlci9yZWxlYXNlL2NsYXNzZXMvVGV4dEZpZWxkKQogIAogICAgIyMjIENoZWNrYm94CiAgCiAgICBUbyBjcmVhdGUgYW4gYDxpbnB1dCB0eXBlPSJjaGVja2JveCI+YDoKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIEVtYmVyaXplIEV2ZXJ5dGhpbmc6CiAgICA8SW5wdXQgQHR5cGU9ImNoZWNrYm94IiBAY2hlY2tlZD17e3RoaXMuaXNFbWJlcml6ZWR9fSBuYW1lPSJpc0VtYmVyaXplZCIgLz4KICAgIGBgYAogIAogICAgVGhpcyB3aWxsIGJpbmQgdGhlIGNoZWNrZWQgc3RhdGUgb2YgdGhpcyBjaGVja2JveCB0byB0aGUgdmFsdWUgb2YgYGlzRW1iZXJpemVkYCAtLSBpZiBlaXRoZXIgb25lCiAgICBjaGFuZ2VzLCBpdCB3aWxsIGJlIHJlZmxlY3RlZCBpbiB0aGUgb3RoZXIuCiAgCiAgICAjIyMgRXh0ZW5kaW5nIGBDaGVja2JveGAKICAKICAgIEludGVybmFsbHksIGA8SW5wdXQgQHR5cGU9ImNoZWNrYm94IiAvPmAgY3JlYXRlcyBhbiBpbnN0YW5jZSBvZiBgQ2hlY2tib3hgLiBTdWJjbGFzc2luZwogICAgYFRleHRGaWVsZGAgaXMgc3VwcG9ydGVkIGJ1dCBub3QgcmVjb21tZW5kZWQuCiAgCiAgICBTZWUgW0NoZWNrYm94XSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0NoZWNrYm94KQogIAogICAgQG1ldGhvZCBJbnB1dAogICAgQGZvciBFbWJlci5UZW1wbGF0ZXMuY29tcG9uZW50cwogICAgQHNlZSB7VGV4dEZpZWxkfQogICAgQHNlZSB7Q2hlY2tib3h9CiAgICBAcGFyYW0ge0hhc2h9IG9wdGlvbnMKICAgIEBwdWJsaWMKICAqLwoKCiAgdmFyIElucHV0ID0gX3J1bnRpbWUuT2JqZWN0LmV4dGVuZCh7CiAgICBpc0NoZWNrYm94OiAoMCwgX21ldGFsLmNvbXB1dGVkKSgndHlwZScsIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMudHlwZSA9PT0gJ2NoZWNrYm94JzsKICAgIH0pCiAgfSk7CgogIHNldE1hbmFnZXIoewogICAgZmFjdG9yeTogSW5wdXRDb21wb25lbnRNYW5hZ2VyRmFjdG9yeSwKICAgIGludGVybmFsOiB0cnVlLAogICAgdHlwZTogJ2NvbXBvbmVudCcKICB9LCBJbnB1dCk7CgogIElucHV0LnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuICdAZW1iZXIvY29tcG9uZW50L2lucHV0JzsKICB9OyAvLy88cmVmZXJlbmNlIHBhdGg9Ii4vc2ltcGxlLWRvbS5kLnRzIiAvPgoKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICBDYWxscyBbU3RyaW5nLmxvY10oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9TdHJpbmcvbWV0aG9kcy9sb2M/YW5jaG9yPWxvYykgd2l0aCB0aGUKICAgIHByb3ZpZGVkIHN0cmluZy4gVGhpcyBpcyBhIGNvbnZlbmllbnQgd2F5IHRvIGxvY2FsaXplIHRleHQgd2l0aGluIGEgdGVtcGxhdGUuCiAgICBGb3IgZXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIEVtYmVyLlNUUklOR1MgPSB7CiAgICAgICdfd2VsY29tZV8nOiAnQm9uam91cicKICAgIH07CiAgICBgYGAKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxkaXYgY2xhc3M9J21lc3NhZ2UnPgogICAgICB7e2xvYyAnX3dlbGNvbWVfJ319CiAgICA8L2Rpdj4KICAgIGBgYAogIAogICAgYGBgaHRtbAogICAgPGRpdiBjbGFzcz0nbWVzc2FnZSc+CiAgICAgIEJvbmpvdXIKICAgIDwvZGl2PgogICAgYGBgCiAgCiAgICBTZWUgW1N0cmluZy5sb2NdKC9lbWJlci9yZWxlYXNlL2NsYXNzZXMvU3RyaW5nL21ldGhvZHMvbG9jP2FuY2hvcj1sb2MpIGZvciBob3cgdG8KICAgIHNldCB1cCBsb2NhbGl6ZWQgc3RyaW5nIHJlZmVyZW5jZXMuCiAgCiAgICBAbWV0aG9kIGxvYwogICAgQGZvciBFbWJlci5UZW1wbGF0ZXMuaGVscGVycwogICAgQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3RyaW5nIHRvIGZvcm1hdC4KICAgIEBzZWUge1N0cmluZyNsb2N9CiAgICBAcHVibGljCiAgKi8KCgogIHZhciBsb2MkMSA9IGhlbHBlcihmdW5jdGlvbiAocGFyYW1zKSB7CiAgICByZXR1cm4gX3N0cmluZy5sb2MuYXBwbHkobnVsbCwgcGFyYW1zCiAgICAvKiBsZXQgdGhlIG90aGVyIHNpZGUgaGFuZGxlIGVycm9ycyAqLwogICAgKTsKICB9KTsKCiAgdmFyIENvbXBpbGVUaW1lTG9va3VwID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQ29tcGlsZVRpbWVMb29rdXAocmVzb2x2ZXIpIHsKICAgICAgdGhpcy5yZXNvbHZlciA9IHJlc29sdmVyOwogICAgfQoKICAgIHZhciBfcHJvdG81MCA9IENvbXBpbGVUaW1lTG9va3VwLnByb3RvdHlwZTsKCiAgICBfcHJvdG81MC5nZXRDYXBhYmlsaXRpZXMgPSBmdW5jdGlvbiBnZXRDYXBhYmlsaXRpZXMoaGFuZGxlKSB7CiAgICAgIHZhciBkZWZpbml0aW9uID0gdGhpcy5yZXNvbHZlci5yZXNvbHZlKGhhbmRsZSk7CiAgICAgIHZhciBtYW5hZ2VyID0gZGVmaW5pdGlvbi5tYW5hZ2VyLAogICAgICAgICAgc3RhdGUgPSBkZWZpbml0aW9uLnN0YXRlOwogICAgICByZXR1cm4gbWFuYWdlci5nZXRDYXBhYmlsaXRpZXMoc3RhdGUpOwogICAgfTsKCiAgICBfcHJvdG81MC5nZXRMYXlvdXQgPSBmdW5jdGlvbiBnZXRMYXlvdXQoaGFuZGxlKSB7CiAgICAgIHZhciBfdGhpcyRyZXNvbHZlciRyZXNvbHYgPSB0aGlzLnJlc29sdmVyLnJlc29sdmUoaGFuZGxlKSwKICAgICAgICAgIG1hbmFnZXIgPSBfdGhpcyRyZXNvbHZlciRyZXNvbHYubWFuYWdlciwKICAgICAgICAgIHN0YXRlID0gX3RoaXMkcmVzb2x2ZXIkcmVzb2x2LnN0YXRlOwoKICAgICAgdmFyIGNhcGFiaWxpdGllcyA9IG1hbmFnZXIuZ2V0Q2FwYWJpbGl0aWVzKHN0YXRlKTsKCiAgICAgIGlmIChjYXBhYmlsaXRpZXMuZHluYW1pY0xheW91dCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICB2YXIgaW52b2NhdGlvbiA9IG1hbmFnZXIuZ2V0TGF5b3V0KHN0YXRlLCB0aGlzLnJlc29sdmVyKTsKICAgICAgcmV0dXJuIHsKICAgICAgICAvLyBUT0RPOiB0aGlzIHNlZW1zIHdlaXJkLCBpdCBhbHJlYWR5IGlzIGNvbXBpbGVkCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gY29tcGlsZSgpIHsKICAgICAgICAgIHJldHVybiBpbnZvY2F0aW9uLmhhbmRsZTsKICAgICAgICB9LAogICAgICAgIHN5bWJvbFRhYmxlOiBpbnZvY2F0aW9uLnN5bWJvbFRhYmxlCiAgICAgIH07CiAgICB9OwoKICAgIF9wcm90bzUwLmxvb2t1cEhlbHBlciA9IGZ1bmN0aW9uIGxvb2t1cEhlbHBlcihuYW1lLCByZWZlcnJlcikgewogICAgICByZXR1cm4gdGhpcy5yZXNvbHZlci5sb29rdXBIZWxwZXIobmFtZSwgcmVmZXJyZXIpOwogICAgfTsKCiAgICBfcHJvdG81MC5sb29rdXBNb2RpZmllciA9IGZ1bmN0aW9uIGxvb2t1cE1vZGlmaWVyKG5hbWUsIHJlZmVycmVyKSB7CiAgICAgIHJldHVybiB0aGlzLnJlc29sdmVyLmxvb2t1cE1vZGlmaWVyKG5hbWUsIHJlZmVycmVyKTsKICAgIH07CgogICAgX3Byb3RvNTAubG9va3VwQ29tcG9uZW50RGVmaW5pdGlvbiA9IGZ1bmN0aW9uIGxvb2t1cENvbXBvbmVudERlZmluaXRpb24obmFtZSwgcmVmZXJyZXIpIHsKICAgICAgcmV0dXJuIHRoaXMucmVzb2x2ZXIubG9va3VwQ29tcG9uZW50SGFuZGxlKG5hbWUsIHJlZmVycmVyKTsKICAgIH07CgogICAgX3Byb3RvNTAubG9va3VwUGFydGlhbCA9IGZ1bmN0aW9uIGxvb2t1cFBhcnRpYWwobmFtZSwgcmVmZXJyZXIpIHsKICAgICAgcmV0dXJuIHRoaXMucmVzb2x2ZXIubG9va3VwUGFydGlhbChuYW1lLCByZWZlcnJlcik7CiAgICB9OwoKICAgIHJldHVybiBDb21waWxlVGltZUxvb2t1cDsKICB9KCk7CgogIHZhciBDQVBBQklMSVRJRVMkMiA9IHsKICAgIGR5bmFtaWNMYXlvdXQ6IGZhbHNlLAogICAgZHluYW1pY1RhZzogZmFsc2UsCiAgICBwcmVwYXJlQXJnczogZmFsc2UsCiAgICBjcmVhdGVBcmdzOiB0cnVlLAogICAgYXR0cmlidXRlSG9vazogZmFsc2UsCiAgICBlbGVtZW50SG9vazogZmFsc2UsCiAgICBjcmVhdGVDYWxsZXI6IGZhbHNlLAogICAgZHluYW1pY1Njb3BlOiB0cnVlLAogICAgdXBkYXRlSG9vazogdHJ1ZSwKICAgIGNyZWF0ZUluc3RhbmNlOiB0cnVlCiAgfTsKCiAgZnVuY3Rpb24gY2FwYWJpbGl0aWVzKG1hbmFnZXJBUEksIG9wdGlvbnMpIHsKICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgb3B0aW9ucyA9IHt9OwogICAgfQoKICAgIChmYWxzZSAmJiAhKG1hbmFnZXJBUEkgPT09ICczLjQnIHx8IG1hbmFnZXJBUEkgPT09ICczLjEzJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdJbnZhbGlkIGNvbXBvbmVudCBtYW5hZ2VyIGNvbXBhdGliaWxpdHkgc3BlY2lmaWVkJywgbWFuYWdlckFQSSA9PT0gJzMuNCcgfHwgbWFuYWdlckFQSSA9PT0gJzMuMTMnKSk7CiAgICB2YXIgdXBkYXRlSG9vayA9IHRydWU7CiAgICB7CiAgICAgIHVwZGF0ZUhvb2sgPSBtYW5hZ2VyQVBJID09PSAnMy4xMycgPyBCb29sZWFuKG9wdGlvbnMudXBkYXRlSG9vaykgOiB0cnVlOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgYXN5bmNMaWZlQ3ljbGVDYWxsYmFja3M6IEJvb2xlYW4ob3B0aW9ucy5hc3luY0xpZmVjeWNsZUNhbGxiYWNrcyksCiAgICAgIGRlc3RydWN0b3I6IEJvb2xlYW4ob3B0aW9ucy5kZXN0cnVjdG9yKSwKICAgICAgdXBkYXRlSG9vazogdXBkYXRlSG9vawogICAgfTsKICB9CgogIGZ1bmN0aW9uIGhhc0FzeW5jTGlmZUN5Y2xlQ2FsbGJhY2tzKGRlbGVnYXRlKSB7CiAgICByZXR1cm4gZGVsZWdhdGUuY2FwYWJpbGl0aWVzLmFzeW5jTGlmZUN5Y2xlQ2FsbGJhY2tzOwogIH0KCiAgZnVuY3Rpb24gaGFzVXBkYXRlSG9vayhkZWxlZ2F0ZSkgewogICAgcmV0dXJuIGRlbGVnYXRlLmNhcGFiaWxpdGllcy51cGRhdGVIb29rOwogIH0KCiAgZnVuY3Rpb24gaGFzQXN5bmNVcGRhdGVIb29rKGRlbGVnYXRlKSB7CiAgICByZXR1cm4gaGFzQXN5bmNMaWZlQ3ljbGVDYWxsYmFja3MoZGVsZWdhdGUpICYmIGhhc1VwZGF0ZUhvb2soZGVsZWdhdGUpOwogIH0KCiAgZnVuY3Rpb24gaGFzRGVzdHJ1Y3RvcnMoZGVsZWdhdGUpIHsKICAgIHJldHVybiBkZWxlZ2F0ZS5jYXBhYmlsaXRpZXMuZGVzdHJ1Y3RvcjsKICB9CiAgLyoqCiAgICBUaGUgQ3VzdG9tQ29tcG9uZW50TWFuYWdlciBhbGxvd3MgYWRkb25zIHRvIHByb3ZpZGUgY3VzdG9tIGNvbXBvbmVudAogICAgaW1wbGVtZW50YXRpb25zIHRoYXQgaW50ZWdyYXRlIHNlYW1sZXNzbHkgaW50byBFbWJlci4gVGhpcyBpcyBhY2NvbXBsaXNoZWQKICAgIHRocm91Z2ggYSBkZWxlZ2F0ZSwgcmVnaXN0ZXJlZCB3aXRoIHRoZSBjdXN0b20gY29tcG9uZW50IG1hbmFnZXIsIHdoaWNoCiAgICBpbXBsZW1lbnRzIGEgc2V0IG9mIGhvb2tzIHRoYXQgZGV0ZXJtaW5lIGNvbXBvbmVudCBiZWhhdmlvci4KICAKICAgIFRvIGNyZWF0ZSBhIGN1c3RvbSBjb21wb25lbnQgbWFuYWdlciwgaW5zdGFudGlhdGUgYSBuZXcgQ3VzdG9tQ29tcG9uZW50TWFuYWdlcgogICAgY2xhc3MgYW5kIHBhc3MgdGhlIGRlbGVnYXRlIGFzIHRoZSBmaXJzdCBhcmd1bWVudDoKICAKICAgIGBgYGpzCiAgICBsZXQgbWFuYWdlciA9IG5ldyBDdXN0b21Db21wb25lbnRNYW5hZ2VyKHsKICAgICAgLy8gLi4uZGVsZWdhdGUgaW1wbGVtZW50YXRpb24uLi4KICAgIH0pOwogICAgYGBgCiAgCiAgICAjIyBEZWxlZ2F0ZSBIb29rcwogIAogICAgVGhyb3VnaG91dCB0aGUgbGlmZWN5Y2xlIG9mIGEgY29tcG9uZW50LCB0aGUgY29tcG9uZW50IG1hbmFnZXIgd2lsbCBpbnZva2UKICAgIGRlbGVnYXRlIGhvb2tzIHRoYXQgYXJlIHJlc3BvbnNpYmxlIGZvciBzdXJmYWNpbmcgdGhvc2UgbGlmZWN5Y2xlIGNoYW5nZXMgdG8KICAgIHRoZSBlbmQgZGV2ZWxvcGVyLgogIAogICAgKiBgY3JlYXRlKClgIC0gaW52b2tlZCB3aGVuIGEgbmV3IGluc3RhbmNlIG9mIGEgY29tcG9uZW50IHNob3VsZCBiZSBjcmVhdGVkCiAgICAqIGB1cGRhdGUoKWAgLSBpbnZva2VkIHdoZW4gdGhlIGFyZ3VtZW50cyBwYXNzZWQgdG8gYSBjb21wb25lbnQgY2hhbmdlCiAgICAqIGBnZXRDb250ZXh0KClgIC0gcmV0dXJucyB0aGUgb2JqZWN0IHRoYXQgc2hvdWxkIGJlCiAgKi8KCgogIHZhciBDdXN0b21Db21wb25lbnRNYW5hZ2VyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9BYnN0cmFjdE1hbmFnZXI0KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoQ3VzdG9tQ29tcG9uZW50TWFuYWdlciwgX0Fic3RyYWN0TWFuYWdlcjQpOwoKICAgIGZ1bmN0aW9uIEN1c3RvbUNvbXBvbmVudE1hbmFnZXIoKSB7CiAgICAgIHJldHVybiBfQWJzdHJhY3RNYW5hZ2VyNC5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICB9CgogICAgdmFyIF9wcm90bzUxID0gQ3VzdG9tQ29tcG9uZW50TWFuYWdlci5wcm90b3R5cGU7CgogICAgX3Byb3RvNTEuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKGVudiwgZGVmaW5pdGlvbiwgYXJncykgewogICAgICB2YXIgZGVsZWdhdGUgPSBkZWZpbml0aW9uLmRlbGVnYXRlOwogICAgICB2YXIgY2FwdHVyZWRBcmdzID0gYXJncy5jYXB0dXJlKCk7CiAgICAgIHZhciB2YWx1ZSQkMTsKICAgICAgdmFyIG5hbWVkQXJnc1Byb3h5ID0ge307CiAgICAgIHsKICAgICAgICBpZiAoX3V0aWxzLkhBU19OQVRJVkVfUFJPWFkpIHsKICAgICAgICAgIHZhciBoYW5kbGVyID0gewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldChfdGFyZ2V0LCBwcm9wKSB7CiAgICAgICAgICAgICAgaWYgKGNhcHR1cmVkQXJncy5uYW1lZC5oYXMocHJvcCkpIHsKICAgICAgICAgICAgICAgIHZhciByZWYgPSBjYXB0dXJlZEFyZ3MubmFtZWQuZ2V0KHByb3ApOwogICAgICAgICAgICAgICAgKDAsIF9tZXRhbC5jb25zdW1lKShyZWYudGFnKTsKICAgICAgICAgICAgICAgIHJldHVybiByZWYudmFsdWUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGhhczogZnVuY3Rpb24gaGFzKF90YXJnZXQsIHByb3ApIHsKICAgICAgICAgICAgICByZXR1cm4gY2FwdHVyZWRBcmdzLm5hbWVkLmhhcyhwcm9wKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb3duS2V5czogZnVuY3Rpb24gb3duS2V5cyhfdGFyZ2V0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNhcHR1cmVkQXJncy5uYW1lZC5uYW1lczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOiBmdW5jdGlvbiBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoX3RhcmdldCwgcHJvcCkgewogICAgICAgICAgICAgIChmYWxzZSAmJiAhKGNhcHR1cmVkQXJncy5uYW1lZC5oYXMocHJvcCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnYXJncyBwcm94aWVzIGRvIG5vdCBoYXZlIHJlYWwgcHJvcGVydHkgZGVzY3JpcHRvcnMsIHNvIHlvdSBzaG91bGQgbmV2ZXIgbmVlZCB0byBjYWxsIGdldE93blByb3BlcnR5RGVzY3JpcHRvciB5b3Vyc2VsZi4gVGhpcyBjb2RlIGV4aXN0cyBmb3IgZW51bWVyYWJpbGl0eSwgc3VjaCBhcyBpbiBmb3ItaW4gbG9vcHMgYW5kIE9iamVjdC5rZXlzKCknLCBjYXB0dXJlZEFyZ3MubmFtZWQuaGFzKHByb3ApKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICAgIGlmIChmYWxzZQogICAgICAgICAgLyogREVCVUcgKi8KICAgICAgICAgICkgewogICAgICAgICAgICBoYW5kbGVyLnNldCA9IGZ1bmN0aW9uIChfdGFyZ2V0LCBwcm9wKSB7CiAgICAgICAgICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IGF0dGVtcHRlZCB0byBzZXQgIiArIGRlZmluaXRpb24uQ29tcG9uZW50Q2xhc3MuY2xhc3MgKyAiIyIgKyBTdHJpbmcocHJvcCkgKyAiIG9uIGEgY29tcG9uZW50cyBhcmd1bWVudHMuIENvbXBvbmVudCBhcmd1bWVudHMgYXJlIGltbXV0YWJsZSBhbmQgY2Fubm90IGJlIHVwZGF0ZWQgZGlyZWN0bHksIHRoZXkgYWx3YXlzIHJlcHJlc2VudCB0aGUgdmFsdWVzIHRoYXQgYXJlIHBhc3NlZCB0byB5b3VyIGNvbXBvbmVudC4gSWYgeW91IHdhbnQgdG8gc2V0IGRlZmF1bHQgdmFsdWVzLCB5b3Ugc2hvdWxkIHVzZSBhIGdldHRlciBpbnN0ZWFkIikpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KCiAgICAgICAgICBuYW1lZEFyZ3NQcm94eSA9IG5ldyBQcm94eShuYW1lZEFyZ3NQcm94eSwgaGFuZGxlcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNhcHR1cmVkQXJncy5uYW1lZC5uYW1lcy5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShuYW1lZEFyZ3NQcm94eSwgbmFtZSwgewogICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICAgICAgdmFyIHJlZiA9IGNhcHR1cmVkQXJncy5uYW1lZC5nZXQobmFtZSk7CiAgICAgICAgICAgICAgICAoMCwgX21ldGFsLmNvbnN1bWUpKHJlZi50YWcpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlZi52YWx1ZSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF9tZXRhbC5BUkdTX1BST1hZX1RBR1Muc2V0KG5hbWVkQXJnc1Byb3h5LCBjYXB0dXJlZEFyZ3MubmFtZWQpOwoKICAgICAgICB2YWx1ZSQkMSA9IHsKICAgICAgICAgIG5hbWVkOiBuYW1lZEFyZ3NQcm94eSwKICAgICAgICAgIHBvc2l0aW9uYWw6IGNhcHR1cmVkQXJncy5wb3NpdGlvbmFsLnZhbHVlKCkKICAgICAgICB9OwogICAgICB9CiAgICAgIHZhciBjb21wb25lbnQgPSBkZWxlZ2F0ZS5jcmVhdGVDb21wb25lbnQoZGVmaW5pdGlvbi5Db21wb25lbnRDbGFzcy5jbGFzcywgdmFsdWUkJDEpOwogICAgICB2YXIgYnVja2V0ID0gbmV3IEN1c3RvbUNvbXBvbmVudFN0YXRlKGRlbGVnYXRlLCBjb21wb25lbnQsIGNhcHR1cmVkQXJncywgZW52LCBuYW1lZEFyZ3NQcm94eSk7CgogICAgICBpZiAoX2Vudmlyb25tZW50Mi5FTlYuX0RFQlVHX1JFTkRFUl9UUkVFKSB7CiAgICAgICAgZW52LmRlYnVnUmVuZGVyVHJlZS5jcmVhdGUoYnVja2V0LCB7CiAgICAgICAgICB0eXBlOiAnY29tcG9uZW50JywKICAgICAgICAgIG5hbWU6IGRlZmluaXRpb24ubmFtZSwKICAgICAgICAgIGFyZ3M6IGFyZ3MuY2FwdHVyZSgpLAogICAgICAgICAgaW5zdGFuY2U6IGNvbXBvbmVudAogICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gYnVja2V0OwogICAgfTsKCiAgICBfcHJvdG81MS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUoYnVja2V0KSB7CiAgICAgIGlmIChfZW52aXJvbm1lbnQyLkVOVi5fREVCVUdfUkVOREVSX1RSRUUpIHsKICAgICAgICBidWNrZXQuZW52LmRlYnVnUmVuZGVyVHJlZS51cGRhdGUoYnVja2V0KTsKICAgICAgfQoKICAgICAgdmFyIGRlbGVnYXRlID0gYnVja2V0LmRlbGVnYXRlLAogICAgICAgICAgY29tcG9uZW50ID0gYnVja2V0LmNvbXBvbmVudCwKICAgICAgICAgIGFyZ3MgPSBidWNrZXQuYXJncywKICAgICAgICAgIG5hbWVkQXJnc1Byb3h5ID0gYnVja2V0Lm5hbWVkQXJnc1Byb3h5OwogICAgICB2YXIgdmFsdWUkJDE7CiAgICAgIHsKICAgICAgICB2YWx1ZSQkMSA9IHsKICAgICAgICAgIG5hbWVkOiBuYW1lZEFyZ3NQcm94eSwKICAgICAgICAgIHBvc2l0aW9uYWw6IGFyZ3MucG9zaXRpb25hbC52YWx1ZSgpCiAgICAgICAgfTsKICAgICAgfQoKICAgICAgaWYgKGhhc1VwZGF0ZUhvb2soZGVsZWdhdGUpKSB7CiAgICAgICAgZGVsZWdhdGUudXBkYXRlQ29tcG9uZW50KGNvbXBvbmVudCwgdmFsdWUkJDEpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzUxLmRpZENyZWF0ZSA9IGZ1bmN0aW9uIGRpZENyZWF0ZShfcmVmMTUpIHsKICAgICAgdmFyIGRlbGVnYXRlID0gX3JlZjE1LmRlbGVnYXRlLAogICAgICAgICAgY29tcG9uZW50ID0gX3JlZjE1LmNvbXBvbmVudDsKCiAgICAgIGlmIChoYXNBc3luY0xpZmVDeWNsZUNhbGxiYWNrcyhkZWxlZ2F0ZSkpIHsKICAgICAgICBkZWxlZ2F0ZS5kaWRDcmVhdGVDb21wb25lbnQoY29tcG9uZW50KTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG81MS5kaWRVcGRhdGUgPSBmdW5jdGlvbiBkaWRVcGRhdGUoX3JlZjE2KSB7CiAgICAgIHZhciBkZWxlZ2F0ZSA9IF9yZWYxNi5kZWxlZ2F0ZSwKICAgICAgICAgIGNvbXBvbmVudCA9IF9yZWYxNi5jb21wb25lbnQ7CgogICAgICBpZiAoaGFzQXN5bmNVcGRhdGVIb29rKGRlbGVnYXRlKSkgewogICAgICAgIGRlbGVnYXRlLmRpZFVwZGF0ZUNvbXBvbmVudChjb21wb25lbnQpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzUxLmdldENvbnRleHQgPSBmdW5jdGlvbiBnZXRDb250ZXh0KF9yZWYxNykgewogICAgICB2YXIgZGVsZWdhdGUgPSBfcmVmMTcuZGVsZWdhdGUsCiAgICAgICAgICBjb21wb25lbnQgPSBfcmVmMTcuY29tcG9uZW50OwogICAgICBkZWxlZ2F0ZS5nZXRDb250ZXh0KGNvbXBvbmVudCk7CiAgICB9OwoKICAgIF9wcm90bzUxLmdldFNlbGYgPSBmdW5jdGlvbiBnZXRTZWxmKF9yZWYxOCkgewogICAgICB2YXIgZGVsZWdhdGUgPSBfcmVmMTguZGVsZWdhdGUsCiAgICAgICAgICBjb21wb25lbnQgPSBfcmVmMTguY29tcG9uZW50OwogICAgICByZXR1cm4gUm9vdFJlZmVyZW5jZS5jcmVhdGUoZGVsZWdhdGUuZ2V0Q29udGV4dChjb21wb25lbnQpKTsKICAgIH07CgogICAgX3Byb3RvNTEuZ2V0RGVzdHJ1Y3RvciA9IGZ1bmN0aW9uIGdldERlc3RydWN0b3Ioc3RhdGUpIHsKICAgICAgdmFyIGRlc3RydWN0b3IgPSBudWxsOwoKICAgICAgaWYgKGhhc0Rlc3RydWN0b3JzKHN0YXRlLmRlbGVnYXRlKSkgewogICAgICAgIGRlc3RydWN0b3IgPSBzdGF0ZTsKICAgICAgfQoKICAgICAgaWYgKF9lbnZpcm9ubWVudDIuRU5WLl9ERUJVR19SRU5ERVJfVFJFRSkgewogICAgICAgIHZhciBpbm5lciA9IGRlc3RydWN0b3I7CiAgICAgICAgZGVzdHJ1Y3RvciA9IHsKICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICAgICAgIHN0YXRlLmVudi5kZWJ1Z1JlbmRlclRyZWUud2lsbERlc3Ryb3koc3RhdGUpOwoKICAgICAgICAgICAgaWYgKGlubmVyKSB7CiAgICAgICAgICAgICAgaW5uZXIuZGVzdHJveSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgcmV0dXJuIGRlc3RydWN0b3I7CiAgICB9OwoKICAgIF9wcm90bzUxLmdldENhcGFiaWxpdGllcyA9IGZ1bmN0aW9uIGdldENhcGFiaWxpdGllcyhfcmVmMTkpIHsKICAgICAgdmFyIGRlbGVnYXRlID0gX3JlZjE5LmRlbGVnYXRlOwogICAgICByZXR1cm4gKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7fSwgQ0FQQUJJTElUSUVTJDIsIHsKICAgICAgICB1cGRhdGVIb29rOiBfZW52aXJvbm1lbnQyLkVOVi5fREVCVUdfUkVOREVSX1RSRUUgfHwgZGVsZWdhdGUuY2FwYWJpbGl0aWVzLnVwZGF0ZUhvb2sKICAgICAgfSk7CiAgICB9OwoKICAgIF9wcm90bzUxLmdldFRhZyA9IGZ1bmN0aW9uIGdldFRhZyhfcmVmMjApIHsKICAgICAgdmFyIGFyZ3MgPSBfcmVmMjAuYXJnczsKCiAgICAgIGlmICgoMCwgX3JlZmVyZW5jZS5pc0NvbnN0KShhcmdzKSkgewogICAgICAgIC8vIHJldHVybmluZyBhIGNvbnN0IHRhZyBza2lwcyB0aGUgdXBkYXRlIGhvb2sgKFZNIEJVRz8pCiAgICAgICAgcmV0dXJuICgwLCBfcmVmZXJlbmNlLmNyZWF0ZVRhZykoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gYXJncy50YWc7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNTEuZGlkUmVuZGVyTGF5b3V0ID0gZnVuY3Rpb24gZGlkUmVuZGVyTGF5b3V0KGJ1Y2tldCwgYm91bmRzKSB7CiAgICAgIGlmIChfZW52aXJvbm1lbnQyLkVOVi5fREVCVUdfUkVOREVSX1RSRUUpIHsKICAgICAgICBidWNrZXQuZW52LmRlYnVnUmVuZGVyVHJlZS5kaWRSZW5kZXIoYnVja2V0LCBib3VuZHMpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzUxLmRpZFVwZGF0ZUxheW91dCA9IGZ1bmN0aW9uIGRpZFVwZGF0ZUxheW91dChidWNrZXQsIGJvdW5kcykgewogICAgICBpZiAoX2Vudmlyb25tZW50Mi5FTlYuX0RFQlVHX1JFTkRFUl9UUkVFKSB7CiAgICAgICAgYnVja2V0LmVudi5kZWJ1Z1JlbmRlclRyZWUuZGlkUmVuZGVyKGJ1Y2tldCwgYm91bmRzKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG81MS5nZXRMYXlvdXQgPSBmdW5jdGlvbiBnZXRMYXlvdXQoc3RhdGUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBoYW5kbGU6IHN0YXRlLnRlbXBsYXRlLmFzTGF5b3V0KCkuY29tcGlsZSgpLAogICAgICAgIHN5bWJvbFRhYmxlOiBzdGF0ZS5zeW1ib2xUYWJsZQogICAgICB9OwogICAgfTsKCiAgICByZXR1cm4gQ3VzdG9tQ29tcG9uZW50TWFuYWdlcjsKICB9KEFic3RyYWN0TWFuYWdlcik7CgogIHZhciBDVVNUT01fQ09NUE9ORU5UX01BTkFHRVIgPSBuZXcgQ3VzdG9tQ29tcG9uZW50TWFuYWdlcigpOwogIC8qKgogICAqIFN0b3JlcyBpbnRlcm5hbCBzdGF0ZSBhYm91dCBhIGNvbXBvbmVudCBpbnN0YW5jZSBhZnRlciBpdCdzIGJlZW4gY3JlYXRlZC4KICAgKi8KCiAgdmFyIEN1c3RvbUNvbXBvbmVudFN0YXRlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQ3VzdG9tQ29tcG9uZW50U3RhdGUoZGVsZWdhdGUsIGNvbXBvbmVudCwgYXJncywgZW52LCBuYW1lZEFyZ3NQcm94eSkgewogICAgICB0aGlzLmRlbGVnYXRlID0gZGVsZWdhdGU7CiAgICAgIHRoaXMuY29tcG9uZW50ID0gY29tcG9uZW50OwogICAgICB0aGlzLmFyZ3MgPSBhcmdzOwogICAgICB0aGlzLmVudiA9IGVudjsKICAgICAgdGhpcy5uYW1lZEFyZ3NQcm94eSA9IG5hbWVkQXJnc1Byb3h5OwogICAgfQoKICAgIHZhciBfcHJvdG81MiA9IEN1c3RvbUNvbXBvbmVudFN0YXRlLnByb3RvdHlwZTsKCiAgICBfcHJvdG81Mi5kZXN0cm95ID0gZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgdmFyIGRlbGVnYXRlID0gdGhpcy5kZWxlZ2F0ZSwKICAgICAgICAgIGNvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50OwoKICAgICAgaWYgKGhhc0Rlc3RydWN0b3JzKGRlbGVnYXRlKSkgewogICAgICAgIGRlbGVnYXRlLmRlc3Ryb3lDb21wb25lbnQoY29tcG9uZW50KTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gQ3VzdG9tQ29tcG9uZW50U3RhdGU7CiAgfSgpOwoKICB2YXIgQ3VzdG9tTWFuYWdlckRlZmluaXRpb24gPSBmdW5jdGlvbiBDdXN0b21NYW5hZ2VyRGVmaW5pdGlvbihuYW1lLCBDb21wb25lbnRDbGFzcywgZGVsZWdhdGUsIHRlbXBsYXRlKSB7CiAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgdGhpcy5Db21wb25lbnRDbGFzcyA9IENvbXBvbmVudENsYXNzOwogICAgdGhpcy5kZWxlZ2F0ZSA9IGRlbGVnYXRlOwogICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgdGhpcy5tYW5hZ2VyID0gQ1VTVE9NX0NPTVBPTkVOVF9NQU5BR0VSOwogICAgdmFyIGxheW91dCA9IHRlbXBsYXRlLmFzTGF5b3V0KCk7CiAgICB2YXIgc3ltYm9sVGFibGUgPSBsYXlvdXQuc3ltYm9sVGFibGU7CiAgICB0aGlzLnN5bWJvbFRhYmxlID0gc3ltYm9sVGFibGU7CiAgICB0aGlzLnN0YXRlID0gewogICAgICBuYW1lOiBuYW1lLAogICAgICBDb21wb25lbnRDbGFzczogQ29tcG9uZW50Q2xhc3MsCiAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZSwKICAgICAgc3ltYm9sVGFibGU6IHN5bWJvbFRhYmxlLAogICAgICBkZWxlZ2F0ZTogZGVsZWdhdGUKICAgIH07CiAgfTsKCiAgdmFyIENBUEFCSUxJVElFUyQzID0gewogICAgZHluYW1pY0xheW91dDogZmFsc2UsCiAgICBkeW5hbWljVGFnOiBmYWxzZSwKICAgIHByZXBhcmVBcmdzOiBmYWxzZSwKICAgIGNyZWF0ZUFyZ3M6IF9lbnZpcm9ubWVudDIuRU5WLl9ERUJVR19SRU5ERVJfVFJFRSwKICAgIGF0dHJpYnV0ZUhvb2s6IGZhbHNlLAogICAgZWxlbWVudEhvb2s6IGZhbHNlLAogICAgY3JlYXRlQ2FsbGVyOiBmYWxzZSwKICAgIGR5bmFtaWNTY29wZTogZmFsc2UsCiAgICB1cGRhdGVIb29rOiBfZW52aXJvbm1lbnQyLkVOVi5fREVCVUdfUkVOREVSX1RSRUUsCiAgICBjcmVhdGVJbnN0YW5jZTogdHJ1ZQogIH07CgogIHZhciBUZW1wbGF0ZU9ubHlDb21wb25lbnRNYW5hZ2VyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9BYnN0cmFjdE1hbmFnZXI1KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoVGVtcGxhdGVPbmx5Q29tcG9uZW50TWFuYWdlciwgX0Fic3RyYWN0TWFuYWdlcjUpOwoKICAgIGZ1bmN0aW9uIFRlbXBsYXRlT25seUNvbXBvbmVudE1hbmFnZXIoKSB7CiAgICAgIHJldHVybiBfQWJzdHJhY3RNYW5hZ2VyNS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICB9CgogICAgdmFyIF9wcm90bzUzID0gVGVtcGxhdGVPbmx5Q29tcG9uZW50TWFuYWdlci5wcm90b3R5cGU7CgogICAgX3Byb3RvNTMuZ2V0TGF5b3V0ID0gZnVuY3Rpb24gZ2V0TGF5b3V0KF9yZWYyMSkgewogICAgICB2YXIgdGVtcGxhdGUgPSBfcmVmMjEudGVtcGxhdGU7CiAgICAgIHZhciBsYXlvdXQgPSB0ZW1wbGF0ZS5hc0xheW91dCgpOwogICAgICByZXR1cm4gewogICAgICAgIGhhbmRsZTogbGF5b3V0LmNvbXBpbGUoKSwKICAgICAgICBzeW1ib2xUYWJsZTogbGF5b3V0LnN5bWJvbFRhYmxlCiAgICAgIH07CiAgICB9OwoKICAgIF9wcm90bzUzLmdldENhcGFiaWxpdGllcyA9IGZ1bmN0aW9uIGdldENhcGFiaWxpdGllcygpIHsKICAgICAgcmV0dXJuIENBUEFCSUxJVElFUyQzOwogICAgfTsKCiAgICBfcHJvdG81My5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUoZW52aXJvbm1lbnQsIF9yZWYyMiwgYXJncykgewogICAgICB2YXIgbmFtZSA9IF9yZWYyMi5uYW1lOwoKICAgICAgaWYgKF9lbnZpcm9ubWVudDIuRU5WLl9ERUJVR19SRU5ERVJfVFJFRSkgewogICAgICAgIHZhciBidWNrZXQgPSB7CiAgICAgICAgICBlbnZpcm9ubWVudDogZW52aXJvbm1lbnQKICAgICAgICB9OwogICAgICAgIGVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS5jcmVhdGUoYnVja2V0LCB7CiAgICAgICAgICB0eXBlOiAnY29tcG9uZW50JywKICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICBhcmdzOiBhcmdzLmNhcHR1cmUoKSwKICAgICAgICAgIGluc3RhbmNlOiBudWxsCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGJ1Y2tldDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG81My5nZXRTZWxmID0gZnVuY3Rpb24gZ2V0U2VsZigpIHsKICAgICAgcmV0dXJuIF9ydW50aW1lMi5OVUxMX1JFRkVSRU5DRTsKICAgIH07CgogICAgX3Byb3RvNTMuZ2V0VGFnID0gZnVuY3Rpb24gZ2V0VGFnKCkgewogICAgICBpZiAoX2Vudmlyb25tZW50Mi5FTlYuX0RFQlVHX1JFTkRFUl9UUkVFKSB7CiAgICAgICAgLy8gcmV0dXJuaW5nIGEgY29uc3QgdGFnIHNraXBzIHRoZSB1cGRhdGUgaG9vayAoVk0gQlVHPykKICAgICAgICByZXR1cm4gKDAsIF9yZWZlcmVuY2UuY3JlYXRlVGFnKSgpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGFuIG91dGxldCBoYXMgbm8gaG9va3MKICAgICAgICByZXR1cm4gX3JlZmVyZW5jZS5DT05TVEFOVF9UQUc7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNTMuZ2V0RGVzdHJ1Y3RvciA9IGZ1bmN0aW9uIGdldERlc3RydWN0b3IoYnVja2V0KSB7CiAgICAgIGlmIChfZW52aXJvbm1lbnQyLkVOVi5fREVCVUdfUkVOREVSX1RSRUUpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICAgICAgYnVja2V0LmVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS53aWxsRGVzdHJveShidWNrZXQpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNTMuZGlkUmVuZGVyTGF5b3V0ID0gZnVuY3Rpb24gZGlkUmVuZGVyTGF5b3V0KGJ1Y2tldCwgYm91bmRzKSB7CiAgICAgIGlmIChfZW52aXJvbm1lbnQyLkVOVi5fREVCVUdfUkVOREVSX1RSRUUpIHsKICAgICAgICBidWNrZXQuZW52aXJvbm1lbnQuZGVidWdSZW5kZXJUcmVlLmRpZFJlbmRlcihidWNrZXQsIGJvdW5kcyk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNTMudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlKGJ1Y2tldCkgewogICAgICBpZiAoX2Vudmlyb25tZW50Mi5FTlYuX0RFQlVHX1JFTkRFUl9UUkVFKSB7CiAgICAgICAgYnVja2V0LmVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS51cGRhdGUoYnVja2V0KTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG81My5kaWRVcGRhdGVMYXlvdXQgPSBmdW5jdGlvbiBkaWRVcGRhdGVMYXlvdXQoYnVja2V0LCBib3VuZHMpIHsKICAgICAgaWYgKF9lbnZpcm9ubWVudDIuRU5WLl9ERUJVR19SRU5ERVJfVFJFRSkgewogICAgICAgIGJ1Y2tldC5lbnZpcm9ubWVudC5kZWJ1Z1JlbmRlclRyZWUuZGlkUmVuZGVyKGJ1Y2tldCwgYm91bmRzKTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gVGVtcGxhdGVPbmx5Q29tcG9uZW50TWFuYWdlcjsKICB9KEFic3RyYWN0TWFuYWdlcik7CgogIHZhciBNQU5BR0VSID0gbmV3IFRlbXBsYXRlT25seUNvbXBvbmVudE1hbmFnZXIoKTsKCiAgdmFyIFRlbXBsYXRlT25seUNvbXBvbmVudERlZmluaXRpb24gPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBUZW1wbGF0ZU9ubHlDb21wb25lbnREZWZpbml0aW9uKG5hbWUsIHRlbXBsYXRlKSB7CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgICAgdGhpcy5tYW5hZ2VyID0gTUFOQUdFUjsKICAgIH0KCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKFRlbXBsYXRlT25seUNvbXBvbmVudERlZmluaXRpb24sIFt7CiAgICAgIGtleTogInN0YXRlIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBUZW1wbGF0ZU9ubHlDb21wb25lbnREZWZpbml0aW9uOwogIH0oKTsKCiAgdmFyIGhlbHBlciQxOwoKICBpZiAoZmFsc2UKICAvKiBERUJVRyAqLwogICkgewogICAgdmFyIENvbXBvbmVudEFzc2VydGlvblJlZmVyZW5jZSA9CiAgICAvKiNfX1BVUkVfXyovCiAgICBmdW5jdGlvbiAoKSB7CiAgICAgIGZ1bmN0aW9uIENvbXBvbmVudEFzc2VydGlvblJlZmVyZW5jZShjb21wb25lbnQsIG1lc3NhZ2UpIHsKICAgICAgICB0aGlzLmNvbXBvbmVudCA9IGNvbXBvbmVudDsKICAgICAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgICAgIHRoaXMudGFnID0gY29tcG9uZW50LnRhZzsKICAgICAgfQoKICAgICAgdmFyIF9wcm90bzU0ID0gQ29tcG9uZW50QXNzZXJ0aW9uUmVmZXJlbmNlLnByb3RvdHlwZTsKCiAgICAgIF9wcm90bzU0LnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgdmFyIHZhbHVlJCQxID0gdGhpcy5jb21wb25lbnQudmFsdWUoKTsKICAgICAgICAoZmFsc2UgJiYgISh0eXBlb2YgdmFsdWUkJDEgIT09ICdzdHJpbmcnKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkodGhpcy5tZXNzYWdlLCB0eXBlb2YgdmFsdWUkJDEgIT09ICdzdHJpbmcnKSk7CiAgICAgICAgcmV0dXJuIHZhbHVlJCQxOwogICAgICB9OwoKICAgICAgX3Byb3RvNTQuZ2V0ID0gZnVuY3Rpb24gZ2V0KHByb3BlcnR5KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29tcG9uZW50LmdldChwcm9wZXJ0eSk7CiAgICAgIH07CgogICAgICByZXR1cm4gQ29tcG9uZW50QXNzZXJ0aW9uUmVmZXJlbmNlOwogICAgfSgpOwoKICAgIGhlbHBlciQxID0gZnVuY3Rpb24gaGVscGVyJDEoX3ZtLCBhcmdzKSB7CiAgICAgIHJldHVybiBuZXcgQ29tcG9uZW50QXNzZXJ0aW9uUmVmZXJlbmNlKGFyZ3MucG9zaXRpb25hbC5hdCgwKSwgYXJncy5wb3NpdGlvbmFsLmF0KDEpLnZhbHVlKCkpOwogICAgfTsKICB9IGVsc2UgewogICAgaGVscGVyJDEgPSBmdW5jdGlvbiBoZWxwZXIkMShfdm0sIGFyZ3MpIHsKICAgICAgcmV0dXJuIGFyZ3MucG9zaXRpb25hbC5hdCgwKTsKICAgIH07CiAgfQoKICB2YXIgY29tcG9uZW50QXNzZXJ0aW9uSGVscGVyID0gaGVscGVyJDE7CgogIGZ1bmN0aW9uIGNsYXNzSGVscGVyKF9yZWYyMykgewogICAgdmFyIHBvc2l0aW9uYWwgPSBfcmVmMjMucG9zaXRpb25hbDsKICAgIHZhciBwYXRoID0gcG9zaXRpb25hbC5hdCgwKTsKICAgIHZhciBhcmdzID0gcG9zaXRpb25hbC5sZW5ndGg7CiAgICB2YXIgdmFsdWUkJDEgPSBwYXRoLnZhbHVlKCk7CgogICAgaWYgKHZhbHVlJCQxID09PSB0cnVlKSB7CiAgICAgIGlmIChhcmdzID4gMSkgewogICAgICAgIHJldHVybiAoMCwgX3N0cmluZy5kYXNoZXJpemUpKHBvc2l0aW9uYWwuYXQoMSkudmFsdWUoKSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIGlmICh2YWx1ZSQkMSA9PT0gZmFsc2UpIHsKICAgICAgaWYgKGFyZ3MgPiAyKSB7CiAgICAgICAgcmV0dXJuICgwLCBfc3RyaW5nLmRhc2hlcml6ZSkocG9zaXRpb25hbC5hdCgyKS52YWx1ZSgpKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgcmV0dXJuIHZhbHVlJCQxOwogIH0KCiAgZnVuY3Rpb24gY2xhc3NIZWxwZXIkMShfdm0sIGFyZ3MpIHsKICAgIHJldHVybiBuZXcgSW50ZXJuYWxIZWxwZXJSZWZlcmVuY2UoY2xhc3NIZWxwZXIsIGFyZ3MuY2FwdHVyZSgpKTsKICB9CgogIGZ1bmN0aW9uIGlucHV0VHlwZUhlbHBlcihfcmVmMjQpIHsKICAgIHZhciBwb3NpdGlvbmFsID0gX3JlZjI0LnBvc2l0aW9uYWw7CiAgICB2YXIgdHlwZSA9IHBvc2l0aW9uYWwuYXQoMCkudmFsdWUoKTsKCiAgICBpZiAodHlwZSA9PT0gJ2NoZWNrYm94JykgewogICAgICByZXR1cm4gJy1jaGVja2JveCc7CiAgICB9CgogICAgcmV0dXJuICctdGV4dC1maWVsZCc7CiAgfQoKICBmdW5jdGlvbiBpbnB1dFR5cGVIZWxwZXIkMShfdm0sIGFyZ3MpIHsKICAgIHJldHVybiBuZXcgSW50ZXJuYWxIZWxwZXJSZWZlcmVuY2UoaW5wdXRUeXBlSGVscGVyLCBhcmdzLmNhcHR1cmUoKSk7CiAgfQoKICBmdW5jdGlvbiBub3JtYWxpemVDbGFzcyhfcmVmMjUpIHsKICAgIHZhciBwb3NpdGlvbmFsID0gX3JlZjI1LnBvc2l0aW9uYWw7CiAgICB2YXIgY2xhc3NOYW1lUGFydHMgPSBwb3NpdGlvbmFsLmF0KDApLnZhbHVlKCkuc3BsaXQoJy4nKTsKICAgIHZhciBjbGFzc05hbWUgPSBjbGFzc05hbWVQYXJ0c1tjbGFzc05hbWVQYXJ0cy5sZW5ndGggLSAxXTsKICAgIHZhciB2YWx1ZSQkMSA9IHBvc2l0aW9uYWwuYXQoMSkudmFsdWUoKTsKCiAgICBpZiAodmFsdWUkJDEgPT09IHRydWUpIHsKICAgICAgcmV0dXJuICgwLCBfc3RyaW5nLmRhc2hlcml6ZSkoY2xhc3NOYW1lKTsKICAgIH0gZWxzZSBpZiAoIXZhbHVlJCQxICYmIHZhbHVlJCQxICE9PSAwKSB7CiAgICAgIHJldHVybiAnJzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBTdHJpbmcodmFsdWUkJDEpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gbm9ybWFsaXplQ2xhc3NIZWxwZXIoX3ZtLCBhcmdzKSB7CiAgICByZXR1cm4gbmV3IEludGVybmFsSGVscGVyUmVmZXJlbmNlKG5vcm1hbGl6ZUNsYXNzLCBhcmdzLmNhcHR1cmUoKSk7CiAgfQogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwoKICAvKioKICAgIFRoZSBge3thY3Rpb259fWAgaGVscGVyIHByb3ZpZGVzIGEgd2F5IHRvIHBhc3MgdHJpZ2dlcnMgZm9yIGJlaGF2aW9yICh1c3VhbGx5CiAgICBqdXN0IGEgZnVuY3Rpb24pIGJldHdlZW4gY29tcG9uZW50cywgYW5kIGludG8gY29tcG9uZW50cyBmcm9tIGNvbnRyb2xsZXJzLgogIAogICAgIyMjIFBhc3NpbmcgZnVuY3Rpb25zIHdpdGggdGhlIGFjdGlvbiBoZWxwZXIKICAKICAgIFRoZXJlIGFyZSB0aHJlZSBjb250ZXh0cyBhbiBhY3Rpb24gaGVscGVyIGNhbiBiZSB1c2VkIGluLiBUaGUgZmlyc3QgdHdvCiAgICBjb250ZXh0cyB0byBkaXNjdXNzIGFyZSBhdHRyaWJ1dGUgY29udGV4dCwgYW5kIEhhbmRsZWJhcnMgdmFsdWUgY29udGV4dC4KICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIHt7ISBBbiBleGFtcGxlIG9mIGF0dHJpYnV0ZSBjb250ZXh0IH19CiAgICA8ZGl2IG9uY2xpY2s9e3thY3Rpb24gInNhdmUifX0+PC9kaXY+CiAgICB7eyEgRXhhbXBsZXMgb2YgSGFuZGxlYmFycyB2YWx1ZSBjb250ZXh0IH19CiAgICB7e2lucHV0IG9uLWlucHV0PShhY3Rpb24gInNhdmUiKX19CiAgICB7e3lpZWxkIChhY3Rpb24gInJlZnJlc2hEYXRhIikgYW5kQW5vdGhlclBhcmFtfX0KICAgIGBgYAogIAogICAgSW4gdGhlc2UgY29udGV4dHMsCiAgICB0aGUgaGVscGVyIGlzIGNhbGxlZCBhICJjbG9zdXJlIGFjdGlvbiIgaGVscGVyLiBJdHMgYmVoYXZpb3IgaXMgc2ltcGxlOgogICAgSWYgcGFzc2VkIGEgZnVuY3Rpb24gbmFtZSwgcmVhZCB0aGF0IGZ1bmN0aW9uIG9mZiB0aGUgYGFjdGlvbnNgIHByb3BlcnR5CiAgICBvZiB0aGUgY3VycmVudCBjb250ZXh0LiBPbmNlIHRoYXQgZnVuY3Rpb24gaXMgcmVhZCwgb3IgaW1tZWRpYXRlbHkgaWYgYSBmdW5jdGlvbiB3YXMKICAgIHBhc3NlZCwgY3JlYXRlIGEgY2xvc3VyZSBvdmVyIHRoYXQgZnVuY3Rpb24gYW5kIGFueSBhcmd1bWVudHMuCiAgICBUaGUgcmVzdWx0aW5nIHZhbHVlIG9mIGFuIGFjdGlvbiBoZWxwZXIgdXNlZCB0aGlzIHdheSBpcyBzaW1wbHkgYSBmdW5jdGlvbi4KICAKICAgIEZvciBleGFtcGxlLCBpbiB0aGUgYXR0cmlidXRlIGNvbnRleHQ6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7eyEgQW4gZXhhbXBsZSBvZiBhdHRyaWJ1dGUgY29udGV4dCB9fQogICAgPGRpdiBvbmNsaWNrPXt7YWN0aW9uICJzYXZlIn19PjwvZGl2PgogICAgYGBgCiAgCiAgICBUaGUgcmVzdWx0aW5nIHRlbXBsYXRlIHJlbmRlciBsb2dpYyB3b3VsZCBiZToKICAKICAgIGBgYGpzCiAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICB2YXIgYWN0aW9uRnVuY3Rpb24gPSAoZnVuY3Rpb24oY29udGV4dCl7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gY29udGV4dC5hY3Rpb25zLnNhdmUuYXBwbHkoY29udGV4dCwgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0pKGNvbnRleHQpOwogICAgZGl2Lm9uY2xpY2sgPSBhY3Rpb25GdW5jdGlvbjsKICAgIGBgYAogIAogICAgVGh1cyB3aGVuIHRoZSBkaXYgaXMgY2xpY2tlZCwgdGhlIGFjdGlvbiBvbiB0aGF0IGNvbnRleHQgaXMgY2FsbGVkLgogICAgQmVjYXVzZSB0aGUgYGFjdGlvbkZ1bmN0aW9uYCBpcyBqdXN0IGEgZnVuY3Rpb24sIGNsb3N1cmUgYWN0aW9ucyBjYW4gYmUKICAgIHBhc3NlZCBiZXR3ZWVuIGNvbXBvbmVudHMgYW5kIHN0aWxsIGV4ZWN1dGUgaW4gdGhlIGNvcnJlY3QgY29udGV4dC4KICAKICAgIEhlcmUgaXMgYW4gZXhhbXBsZSBhY3Rpb24gaGFuZGxlciBvbiBhIGNvbXBvbmVudDoKICAKICAgIGBgYGFwcC9jb21wb25lbnRzL215LWNvbXBvbmVudC5qcwogICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZ2xpbW1lci9jb21wb25lbnQnOwogICAgaW1wb3J0IHsgYWN0aW9uIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBleHRlbmRzIENvbXBvbmVudCB7CiAgICAgIEBhY3Rpb24KICAgICAgc2F2ZSgpIHsKICAgICAgICB0aGlzLm1vZGVsLnNhdmUoKTsKICAgICAgfQogICAgfQogICAgYGBgCiAgCiAgICBBY3Rpb25zIGFyZSBhbHdheXMgbG9va2VkIHVwIG9uIHRoZSBgYWN0aW9uc2AgcHJvcGVydHkgb2YgdGhlIGN1cnJlbnQgY29udGV4dC4KICAgIFRoaXMgYXZvaWRzIGNvbGxpc2lvbnMgaW4gdGhlIG5hbWluZyBvZiBjb21tb24gYWN0aW9ucywgc3VjaCBhcyBgZGVzdHJveWAuCiAgICBUd28gb3B0aW9ucyBjYW4gYmUgcGFzc2VkIHRvIHRoZSBgYWN0aW9uYCBoZWxwZXIgd2hlbiBpdCBpcyB1c2VkIGluIHRoaXMgd2F5LgogIAogICAgKiBgdGFyZ2V0PXNvbWVQcm9wZXJ0eWAgd2lsbCBsb29rIHRvIGBzb21lUHJvcGVydHlgIGluc3RlYWQgb2YgdGhlIGN1cnJlbnQKICAgICAgY29udGV4dCBmb3IgdGhlIGBhY3Rpb25zYCBoYXNoLiBUaGlzIGNhbiBiZSB1c2VmdWwgd2hlbiB0YXJnZXRpbmcgYQogICAgICBzZXJ2aWNlIGZvciBhY3Rpb25zLgogICAgKiBgdmFsdWU9InRhcmdldC52YWx1ZSJgIHdpbGwgcmVhZCB0aGUgcGF0aCBgdGFyZ2V0LnZhbHVlYCBvZmYgdGhlIGZpcnN0CiAgICAgIGFyZ3VtZW50IHRvIHRoZSBhY3Rpb24gd2hlbiBpdCBpcyBjYWxsZWQgYW5kIHJld3JpdGUgdGhlIGZpcnN0IGFyZ3VtZW50CiAgICAgIHRvIGJlIHRoYXQgdmFsdWUuIFRoaXMgaXMgdXNlZnVsIHdoZW4gYXR0YWNoaW5nIGFjdGlvbnMgdG8gZXZlbnQgbGlzdGVuZXJzLgogIAogICAgIyMjIEludm9raW5nIGFuIGFjdGlvbgogIAogICAgQ2xvc3VyZSBhY3Rpb25zIGN1cnJ5IGJvdGggdGhlaXIgc2NvcGUgYW5kIGFueSBhcmd1bWVudHMuIFdoZW4gaW52b2tlZCwgYW55CiAgICBhZGRpdGlvbmFsIGFyZ3VtZW50cyBhcmUgYWRkZWQgdG8gdGhlIGFscmVhZHkgY3VycmllZCBsaXN0LgogICAgQWN0aW9ucyBzaG91bGQgYmUgaW52b2tlZCB1c2luZyB0aGUgW3NlbmRBY3Rpb25dKC9lbWJlci9yZWxlYXNlL2NsYXNzZXMvQ29tcG9uZW50L21ldGhvZHMvc2VuZEFjdGlvbj9hbmNob3I9c2VuZEFjdGlvbikKICAgIG1ldGhvZC4gVGhlIGZpcnN0IGFyZ3VtZW50IHRvIGBzZW5kQWN0aW9uYCBpcyB0aGUgYWN0aW9uIHRvIGJlIGNhbGxlZCwgYW5kCiAgICBhZGRpdGlvbmFsIGFyZ3VtZW50cyBhcmUgcGFzc2VkIHRvIHRoZSBhY3Rpb24gZnVuY3Rpb24uIFRoaXMgaGFzIGludGVyZXN0aW5nCiAgICBwcm9wZXJ0aWVzIGNvbWJpbmVkIHdpdGggY3Vycnlpbmcgb2YgYXJndW1lbnRzLiBGb3IgZXhhbXBsZToKICAKICAgIGBgYGFwcC9jb21wb25lbnRzL3VwZGF0ZS1uYW1lLmpzCiAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BnbGltbWVyL2NvbXBvbmVudCc7CiAgICBpbXBvcnQgeyBhY3Rpb24gfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIGV4dGVuZHMgQ29tcG9uZW50IHsKICAgICAgQGFjdGlvbgogICAgICBzZXROYW1lKG1vZGVsLCBuYW1lKSB7CiAgICAgICAgbW9kZWwuc2V0KCduYW1lJywgbmFtZSk7CiAgICAgIH0KICAgIH0KICAgIGBgYAogIAogICAgYGBgYXBwL2NvbXBvbmVudHMvdXBkYXRlLW5hbWUuaGJzCiAgICB7e2lucHV0IG9uLWlucHV0PShhY3Rpb24gKGFjdGlvbiAnc2V0TmFtZScgQG1vZGVsKSB2YWx1ZT0idGFyZ2V0LnZhbHVlIil9fQogICAgYGBgCiAgCiAgICBUaGUgZmlyc3QgYXJndW1lbnQgKGBAbW9kZWxgKSB3YXMgY3VycmllZCBvdmVyLCBhbmQgdGhlIHJ1bi10aW1lIGFyZ3VtZW50IChgZXZlbnRgKQogICAgYmVjb21lcyBhIHNlY29uZCBhcmd1bWVudC4gQWN0aW9uIGNhbGxzIGNhbiBiZSBuZXN0ZWQgdGhpcyB3YXkgYmVjYXVzZSBlYWNoIHNpbXBseQogICAgcmV0dXJucyBhIGZ1bmN0aW9uLiBBbnkgZnVuY3Rpb24gY2FuIGJlIHBhc3NlZCB0byB0aGUgYHt7YWN0aW9ufX1gIGhlbHBlciwgaW5jbHVkaW5nCiAgICBvdGhlciBhY3Rpb25zLgogIAogICAgQWN0aW9ucyBpbnZva2VkIHdpdGggYHNlbmRBY3Rpb25gIGhhdmUgdGhlIHNhbWUgY3VycnlpbmcgYmVoYXZpb3IgYXMgZGVtb25zdHJhdGVkCiAgICB3aXRoIGBvbi1pbnB1dGAgYWJvdmUuIEZvciBleGFtcGxlOgogIAogICAgYGBgYXBwL2NvbXBvbmVudHMvbXktaW5wdXQuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGdsaW1tZXIvY29tcG9uZW50JzsKICAgIGltcG9ydCB7IGFjdGlvbiB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgZXh0ZW5kcyBDb21wb25lbnQgewogICAgICBAYWN0aW9uCiAgICAgIHNldE5hbWUobW9kZWwsIG5hbWUpIHsKICAgICAgICBtb2RlbC5zZXQoJ25hbWUnLCBuYW1lKTsKICAgICAgfQogICAgfQogICAgYGBgCiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICA8TXlJbnB1dCBAc3VibWl0PXt7YWN0aW9uICdzZXROYW1lJyBAbW9kZWx9fSAvPgogICAgYGBgCiAgCiAgICBvcgogIAogICAgYGBgaGFuZGxlYmFycwogICAge3tteS1pbnB1dCBzdWJtaXQ9KGFjdGlvbiAnc2V0TmFtZScgQG1vZGVsKX19CiAgICBgYGAKICAKICAgIGBgYGFwcC9jb21wb25lbnRzL215LWNvbXBvbmVudC5qcwogICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICBjbGljaygpIHsKICAgICAgICAvLyBOb3RlIHRoYXQgbW9kZWwgaXMgbm90IHBhc3NlZCwgaXQgd2FzIGN1cnJpZWQgaW4gdGhlIHRlbXBsYXRlCiAgICAgICAgdGhpcy5zZW5kQWN0aW9uKCdzdWJtaXQnLCAnYm9iJyk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICAjIyMgQXR0YWNoaW5nIGFjdGlvbnMgdG8gRE9NIGVsZW1lbnRzCiAgCiAgICBUaGUgdGhpcmQgY29udGV4dCBvZiB0aGUgYHt7YWN0aW9ufX1gIGhlbHBlciBjYW4gYmUgY2FsbGVkICJlbGVtZW50IHNwYWNlIi4KICAgIEZvciBleGFtcGxlOgogIAogICAgYGBgaGFuZGxlYmFycwogICAge3shIEFuIGV4YW1wbGUgb2YgZWxlbWVudCBzcGFjZSB9fQogICAgPGRpdiB7e2FjdGlvbiAic2F2ZSJ9fT48L2Rpdj4KICAgIGBgYAogIAogICAgVXNlZCB0aGlzIHdheSwgdGhlIGB7e2FjdGlvbn19YCBoZWxwZXIgcHJvdmlkZXMgYSB1c2VmdWwgc2hvcnRjdXQgZm9yCiAgICByZWdpc3RlcmluZyBhbiBIVE1MIGVsZW1lbnQgaW4gYSB0ZW1wbGF0ZSBmb3IgYSBzaW5nbGUgRE9NIGV2ZW50IGFuZAogICAgZm9yd2FyZGluZyB0aGF0IGludGVyYWN0aW9uIHRvIHRoZSB0ZW1wbGF0ZSdzIGNvbnRleHQgKGNvbnRyb2xsZXIgb3IgY29tcG9uZW50KS4KICAgIElmIHRoZSBjb250ZXh0IG9mIGEgdGVtcGxhdGUgaXMgYSBjb250cm9sbGVyLCBhY3Rpb25zIHVzZWQgdGhpcyB3YXkgd2lsbAogICAgYnViYmxlIHRvIHJvdXRlcyB3aGVuIHRoZSBjb250cm9sbGVyIGRvZXMgbm90IGltcGxlbWVudCB0aGUgc3BlY2lmaWVkIGFjdGlvbi4KICAgIE9uY2UgYW4gYWN0aW9uIGhpdHMgYSByb3V0ZSwgaXQgd2lsbCBidWJibGUgdGhyb3VnaCB0aGUgcm91dGUgaGllcmFyY2h5LgogIAogICAgIyMjIEV2ZW50IFByb3BhZ2F0aW9uCiAgCiAgICBge3thY3Rpb259fWAgaGVscGVycyBjYWxsZWQgaW4gZWxlbWVudCBzcGFjZSBjYW4gY29udHJvbCBldmVudCBidWJibGluZy4gTm90ZQogICAgdGhhdCB0aGUgY2xvc3VyZSBzdHlsZSBhY3Rpb25zIGNhbm5vdC4KICAKICAgIEV2ZW50cyB0cmlnZ2VyZWQgdGhyb3VnaCB0aGUgYWN0aW9uIGhlbHBlciB3aWxsIGF1dG9tYXRpY2FsbHkgaGF2ZQogICAgYC5wcmV2ZW50RGVmYXVsdCgpYCBjYWxsZWQgb24gdGhlbS4gWW91IGRvIG5vdCBuZWVkIHRvIGRvIHNvIGluIHlvdXIgZXZlbnQKICAgIGhhbmRsZXJzLiBJZiB5b3UgbmVlZCB0byBhbGxvdyBldmVudCBwcm9wYWdhdGlvbiAodG8gaGFuZGxlIGZpbGUgaW5wdXRzIGZvcgogICAgZXhhbXBsZSkgeW91IGNhbiBzdXBwbHkgdGhlIGBwcmV2ZW50RGVmYXVsdD1mYWxzZWAgb3B0aW9uIHRvIHRoZSBge3thY3Rpb259fWAgaGVscGVyOgogIAogICAgYGBgaGFuZGxlYmFycwogICAgPGRpdiB7e2FjdGlvbiAic2F5SGVsbG8iIHByZXZlbnREZWZhdWx0PWZhbHNlfX0+CiAgICAgIDxpbnB1dCB0eXBlPSJmaWxlIiAvPgogICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIC8+CiAgICA8L2Rpdj4KICAgIGBgYAogIAogICAgVG8gZGlzYWJsZSBidWJibGluZywgcGFzcyBgYnViYmxlcz1mYWxzZWAgdG8gdGhlIGhlbHBlcjoKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxidXR0b24ge3thY3Rpb24gJ2VkaXQnIHBvc3QgYnViYmxlcz1mYWxzZX19PkVkaXQ8L2J1dHRvbj4KICAgIGBgYAogIAogICAgVG8gZGlzYWJsZSBidWJibGluZyB3aXRoIGNsb3N1cmUgc3R5bGUgYWN0aW9ucyB5b3UgbXVzdCBjcmVhdGUgeW91ciBvd24KICAgIHdyYXBwZXIgaGVscGVyIHRoYXQgbWFrZXMgdXNlIG9mIGBldmVudC5zdG9wUHJvcGFnYXRpb24oKWA6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICA8ZGl2IG9uY2xpY2s9e3tkaXNhYmxlLWJ1YmJsaW5nIChhY3Rpb24gInNheUhlbGxvIil9fT5IZWxsbzwvZGl2PgogICAgYGBgCiAgCiAgICBgYGBhcHAvaGVscGVycy9kaXNhYmxlLWJ1YmJsaW5nLmpzCiAgICBpbXBvcnQgeyBoZWxwZXIgfSBmcm9tICdAZW1iZXIvY29tcG9uZW50L2hlbHBlcic7CiAgCiAgICBleHBvcnQgZnVuY3Rpb24gZGlzYWJsZUJ1YmJsaW5nKFthY3Rpb25dKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihldmVudCkgewogICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgIHJldHVybiBhY3Rpb24oZXZlbnQpOwogICAgICB9OwogICAgfQogICAgZXhwb3J0IGRlZmF1bHQgaGVscGVyKGRpc2FibGVCdWJibGluZyk7CiAgICBgYGAKICAKICAgIElmIHlvdSBuZWVkIHRoZSBkZWZhdWx0IGhhbmRsZXIgdG8gdHJpZ2dlciB5b3Ugc2hvdWxkIGVpdGhlciByZWdpc3RlciB5b3VyCiAgICBvd24gZXZlbnQgaGFuZGxlciwgb3IgdXNlIGV2ZW50IG1ldGhvZHMgb24geW91ciB2aWV3IGNsYXNzLiBTZWUKICAgIFsiUmVzcG9uZGluZyB0byBCcm93c2VyIEV2ZW50cyJdKC9lbWJlci9yZWxlYXNlL2NsYXNzZXMvQ29tcG9uZW50KQogICAgaW4gdGhlIGRvY3VtZW50YXRpb24gZm9yIGBDb21wb25lbnRgIGZvciBtb3JlIGluZm9ybWF0aW9uLgogIAogICAgIyMjIFNwZWNpZnlpbmcgRE9NIGV2ZW50IHR5cGUKICAKICAgIGB7e2FjdGlvbn19YCBoZWxwZXJzIGNhbGxlZCBpbiBlbGVtZW50IHNwYWNlIGNhbiBzcGVjaWZ5IGFuIGV2ZW50IHR5cGUuCiAgICBCeSBkZWZhdWx0IHRoZSBge3thY3Rpb259fWAgaGVscGVyIHJlZ2lzdGVycyBmb3IgRE9NIGBjbGlja2AgZXZlbnRzLiBZb3UgY2FuCiAgICBzdXBwbHkgYW4gYG9uYCBvcHRpb24gdG8gdGhlIGhlbHBlciB0byBzcGVjaWZ5IGEgZGlmZmVyZW50IERPTSBldmVudCBuYW1lOgogIAogICAgYGBgaGFuZGxlYmFycwogICAgPGRpdiB7e2FjdGlvbiAiYW5BY3Rpb25OYW1lIiBvbj0iZG91YmxlQ2xpY2sifX0+CiAgICAgIGNsaWNrIG1lCiAgICA8L2Rpdj4KICAgIGBgYAogIAogICAgU2VlIFsiRXZlbnQgTmFtZXMiXSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0NvbXBvbmVudCkgZm9yIGEgbGlzdCBvZgogICAgYWNjZXB0YWJsZSBET00gZXZlbnQgbmFtZXMuCiAgCiAgICAjIyMgU3BlY2lmeWluZyB3aGl0ZWxpc3RlZCBtb2RpZmllciBrZXlzCiAgCiAgICBge3thY3Rpb259fWAgaGVscGVycyBjYWxsZWQgaW4gZWxlbWVudCBzcGFjZSBjYW4gc3BlY2lmeSBtb2RpZmllciBrZXlzLgogICAgQnkgZGVmYXVsdCB0aGUgYHt7YWN0aW9ufX1gIGhlbHBlciB3aWxsIGlnbm9yZSBjbGljayBldmVudHMgd2l0aCBwcmVzc2VkIG1vZGlmaWVyCiAgICBrZXlzLiBZb3UgY2FuIHN1cHBseSBhbiBgYWxsb3dlZEtleXNgIG9wdGlvbiB0byBzcGVjaWZ5IHdoaWNoIGtleXMgc2hvdWxkIG5vdCBiZSBpZ25vcmVkLgogIAogICAgYGBgaGFuZGxlYmFycwogICAgPGRpdiB7e2FjdGlvbiAiYW5BY3Rpb25OYW1lIiBhbGxvd2VkS2V5cz0iYWx0In19PgogICAgICBjbGljayBtZQogICAgPC9kaXY+CiAgICBgYGAKICAKICAgIFRoaXMgd2F5IHRoZSBhY3Rpb24gd2lsbCBmaXJlIHdoZW4gY2xpY2tpbmcgd2l0aCB0aGUgYWx0IGtleSBwcmVzc2VkIGRvd24uCiAgICBBbHRlcm5hdGl2ZWx5LCBzdXBwbHkgImFueSIgdG8gdGhlIGBhbGxvd2VkS2V5c2Agb3B0aW9uIHRvIGFjY2VwdCBhbnkgY29tYmluYXRpb24gb2YgbW9kaWZpZXIga2V5cy4KICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxkaXYge3thY3Rpb24gImFuQWN0aW9uTmFtZSIgYWxsb3dlZEtleXM9ImFueSJ9fT4KICAgICAgY2xpY2sgbWUgd2l0aCBhbnkga2V5IHByZXNzZWQKICAgIDwvZGl2PgogICAgYGBgCiAgCiAgICAjIyMgU3BlY2lmeWluZyBhIFRhcmdldAogIAogICAgQSBgdGFyZ2V0YCBvcHRpb24gY2FuIGJlIHByb3ZpZGVkIHRvIHRoZSBoZWxwZXIgdG8gY2hhbmdlCiAgICB3aGljaCBvYmplY3Qgd2lsbCByZWNlaXZlIHRoZSBtZXRob2QgY2FsbC4gVGhpcyBvcHRpb24gbXVzdCBiZSBhIHBhdGgKICAgIHRvIGFuIG9iamVjdCwgYWNjZXNzaWJsZSBpbiB0aGUgY3VycmVudCBjb250ZXh0OgogIAogICAgYGBgYXBwL3RlbXBsYXRlcy9hcHBsaWNhdGlvbi5oYnMKICAgIDxkaXYge3thY3Rpb24gImFuQWN0aW9uTmFtZSIgdGFyZ2V0PXNvbWVTZXJ2aWNlfX0+CiAgICAgIGNsaWNrIG1lCiAgICA8L2Rpdj4KICAgIGBgYAogIAogICAgYGBgYXBwL2NvbnRyb2xsZXJzL2FwcGxpY2F0aW9uLmpzCiAgICBpbXBvcnQgQ29udHJvbGxlciBmcm9tICdAZW1iZXIvY29udHJvbGxlcic7CiAgICBpbXBvcnQgeyBpbmplY3QgYXMgc2VydmljZSB9IGZyb20gJ0BlbWJlci9zZXJ2aWNlJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIGV4dGVuZHMgQ29udHJvbGxlciB7CiAgICAgIEBzZXJ2aWNlIHNvbWVTZXJ2aWNlOwogICAgfQogICAgYGBgCiAgCiAgICBAbWV0aG9kIGFjdGlvbgogICAgQGZvciBFbWJlci5UZW1wbGF0ZXMuaGVscGVycwogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBhY3Rpb24oX3ZtLCBhcmdzKSB7CiAgICB2YXIgbmFtZWQgPSBhcmdzLm5hbWVkLAogICAgICAgIHBvc2l0aW9uYWwgPSBhcmdzLnBvc2l0aW9uYWw7CiAgICB2YXIgY2FwdHVyZWRBcmdzID0gcG9zaXRpb25hbC5jYXB0dXJlKCk7IC8vIFRoZSBmaXJzdCB0d28gYXJndW1lbnQgc2xvdHMgYXJlIHJlc2VydmVkLgogICAgLy8gcG9zWzBdIGlzIHRoZSBjb250ZXh0IChvciBgdGhpc2ApCiAgICAvLyBwb3NbMV0gaXMgdGhlIGFjdGlvbiBuYW1lIG9yIGZ1bmN0aW9uCiAgICAvLyBBbnl0aGluZyBlbHNlIGlzIGFuIGFjdGlvbiBhcmd1bWVudC4KCiAgICB2YXIgX2NhcHR1cmVkQXJncyRyZWZlcmVuID0gY2FwdHVyZWRBcmdzLnJlZmVyZW5jZXMsCiAgICAgICAgY29udGV4dCA9IF9jYXB0dXJlZEFyZ3MkcmVmZXJlblswXSwKICAgICAgICBhY3Rpb24gPSBfY2FwdHVyZWRBcmdzJHJlZmVyZW5bMV0sCiAgICAgICAgcmVzdEFyZ3MgPSBfY2FwdHVyZWRBcmdzJHJlZmVyZW4uc2xpY2UoMik7IC8vIFRPRE86IElzIHRoZXJlIGEgYmV0dGVyIHdheSBvZiBkb2luZyB0aGlzPwoKCiAgICB2YXIgZGVidWdLZXkgPSBhY3Rpb24ucHJvcGVydHlLZXk7CiAgICB2YXIgdGFyZ2V0ID0gbmFtZWQuaGFzKCd0YXJnZXQnKSA/IG5hbWVkLmdldCgndGFyZ2V0JykgOiBjb250ZXh0OwogICAgdmFyIHByb2Nlc3NBcmdzID0gbWFrZUFyZ3NQcm9jZXNzb3IobmFtZWQuaGFzKCd2YWx1ZScpICYmIG5hbWVkLmdldCgndmFsdWUnKSwgcmVzdEFyZ3MpOwogICAgdmFyIGZuOwoKICAgIGlmICh0eXBlb2YgYWN0aW9uW0lOVk9LRV0gPT09ICdmdW5jdGlvbicpIHsKICAgICAgZm4gPSBtYWtlQ2xvc3VyZUFjdGlvbihhY3Rpb24sIGFjdGlvbiwgYWN0aW9uW0lOVk9LRV0sIHByb2Nlc3NBcmdzLCBkZWJ1Z0tleSk7CiAgICB9IGVsc2UgaWYgKCgwLCBfcmVmZXJlbmNlLmlzQ29uc3QpKHRhcmdldCkgJiYgKDAsIF9yZWZlcmVuY2UuaXNDb25zdCkoYWN0aW9uKSkgewogICAgICBmbiA9IG1ha2VDbG9zdXJlQWN0aW9uKGNvbnRleHQudmFsdWUoKSwgdGFyZ2V0LnZhbHVlKCksIGFjdGlvbi52YWx1ZSgpLCBwcm9jZXNzQXJncywgZGVidWdLZXkpOwogICAgfSBlbHNlIHsKICAgICAgZm4gPSBtYWtlRHluYW1pY0Nsb3N1cmVBY3Rpb24oY29udGV4dC52YWx1ZSgpLCB0YXJnZXQsIGFjdGlvbiwgcHJvY2Vzc0FyZ3MsIGRlYnVnS2V5KTsKICAgIH0KCiAgICBmbltBQ1RJT05dID0gdHJ1ZTsKICAgIHJldHVybiBuZXcgVW5ib3VuZFJlZmVyZW5jZShmbik7CiAgfQoKICBmdW5jdGlvbiBOT09QJDEoYXJncykgewogICAgcmV0dXJuIGFyZ3M7CiAgfQoKICBmdW5jdGlvbiBtYWtlQXJnc1Byb2Nlc3Nvcih2YWx1ZVBhdGhSZWYsIGFjdGlvbkFyZ3NSZWYpIHsKICAgIHZhciBtZXJnZUFyZ3M7CgogICAgaWYgKGFjdGlvbkFyZ3NSZWYubGVuZ3RoID4gMCkgewogICAgICBtZXJnZUFyZ3MgPSBmdW5jdGlvbiBtZXJnZUFyZ3MoYXJncykgewogICAgICAgIHJldHVybiBhY3Rpb25BcmdzUmVmLm1hcChmdW5jdGlvbiAocmVmKSB7CiAgICAgICAgICByZXR1cm4gcmVmLnZhbHVlKCk7CiAgICAgICAgfSkuY29uY2F0KGFyZ3MpOwogICAgICB9OwogICAgfQoKICAgIHZhciByZWFkVmFsdWU7CgogICAgaWYgKHZhbHVlUGF0aFJlZikgewogICAgICByZWFkVmFsdWUgPSBmdW5jdGlvbiByZWFkVmFsdWUoYXJncykgewogICAgICAgIHZhciB2YWx1ZVBhdGggPSB2YWx1ZVBhdGhSZWYudmFsdWUoKTsKCiAgICAgICAgaWYgKHZhbHVlUGF0aCAmJiBhcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGFyZ3NbMF0gPSAoMCwgX21ldGFsLmdldCkoYXJnc1swXSwgdmFsdWVQYXRoKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBhcmdzOwogICAgICB9OwogICAgfQoKICAgIGlmIChtZXJnZUFyZ3MgJiYgcmVhZFZhbHVlKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoYXJncykgewogICAgICAgIHJldHVybiByZWFkVmFsdWUobWVyZ2VBcmdzKGFyZ3MpKTsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBtZXJnZUFyZ3MgfHwgcmVhZFZhbHVlIHx8IE5PT1AkMTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG1ha2VEeW5hbWljQ2xvc3VyZUFjdGlvbihjb250ZXh0LCB0YXJnZXRSZWYsIGFjdGlvblJlZiwgcHJvY2Vzc0FyZ3MsIGRlYnVnS2V5KSB7CiAgICAvLyBXZSBkb24ndCBhbGxvdyB1bmRlZmluZWQvbnVsbCB2YWx1ZXMsIHNvIHRoaXMgY3JlYXRlcyBhIHRocm93LWF3YXkgYWN0aW9uIHRvIHRyaWdnZXIgdGhlIGFzc2VydGlvbnMKICAgIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICkgewogICAgICBtYWtlQ2xvc3VyZUFjdGlvbihjb250ZXh0LCB0YXJnZXRSZWYudmFsdWUoKSwgYWN0aW9uUmVmLnZhbHVlKCksIHByb2Nlc3NBcmdzLCBkZWJ1Z0tleSk7CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIG1ha2VDbG9zdXJlQWN0aW9uKGNvbnRleHQsIHRhcmdldFJlZi52YWx1ZSgpLCBhY3Rpb25SZWYudmFsdWUoKSwgcHJvY2Vzc0FyZ3MsIGRlYnVnS2V5KS5hcHBseSh2b2lkIDAsIGFyZ3VtZW50cyk7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gbWFrZUNsb3N1cmVBY3Rpb24oY29udGV4dCwgdGFyZ2V0LCBhY3Rpb24sIHByb2Nlc3NBcmdzLCBkZWJ1Z0tleSkgewogICAgdmFyIHNlbGY7CiAgICB2YXIgZm47CiAgICAoZmFsc2UgJiYgIShhY3Rpb24gIT09IHVuZGVmaW5lZCAmJiBhY3Rpb24gIT09IG51bGwpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQWN0aW9uIHBhc3NlZCBpcyBudWxsIG9yIHVuZGVmaW5lZCBpbiAoYWN0aW9uKSBmcm9tICIgKyB0YXJnZXQgKyAiLiIsIGFjdGlvbiAhPT0gdW5kZWZpbmVkICYmIGFjdGlvbiAhPT0gbnVsbCkpOwoKICAgIGlmICh0eXBlb2YgYWN0aW9uW0lOVk9LRV0gPT09ICdmdW5jdGlvbicpIHsKICAgICAgc2VsZiA9IGFjdGlvbjsKICAgICAgZm4gPSBhY3Rpb25bSU5WT0tFXTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciB0eXBlb2ZBY3Rpb24gPSB0eXBlb2YgYWN0aW9uOwoKICAgICAgaWYgKHR5cGVvZkFjdGlvbiA9PT0gJ3N0cmluZycpIHsKICAgICAgICBzZWxmID0gdGFyZ2V0OwogICAgICAgIGZuID0gdGFyZ2V0LmFjdGlvbnMgJiYgdGFyZ2V0LmFjdGlvbnNbYWN0aW9uXTsKICAgICAgICAoZmFsc2UgJiYgIShmbikgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJBbiBhY3Rpb24gbmFtZWQgJyIgKyBhY3Rpb24gKyAiJyB3YXMgbm90IGZvdW5kIGluICIgKyB0YXJnZXQsIGZuKSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mQWN0aW9uID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgc2VsZiA9IGNvbnRleHQ7CiAgICAgICAgZm4gPSBhY3Rpb247CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aAogICAgICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkFuIGFjdGlvbiBjb3VsZCBub3QgYmUgbWFkZSBmb3IgYCIgKyAoZGVidWdLZXkgfHwgYWN0aW9uKSArICJgIGluICIgKyB0YXJnZXQgKyAiLiBQbGVhc2UgY29uZmlybSB0aGF0IHlvdSBhcmUgdXNpbmcgZWl0aGVyIGEgcXVvdGVkIGFjdGlvbiBuYW1lIChpLmUuIGAoYWN0aW9uICciICsgKGRlYnVnS2V5IHx8ICdteUFjdGlvbicpICsgIicpYCkgb3IgYSBmdW5jdGlvbiBhdmFpbGFibGUgaW4gIiArIHRhcmdldCArICIuIiwgZmFsc2UpKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5MiA9IDA7IF9rZXkyIDwgX2xlbjsgX2tleTIrKykgewogICAgICAgIGFyZ3NbX2tleTJdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgfQoKICAgICAgdmFyIHBheWxvYWQgPSB7CiAgICAgICAgdGFyZ2V0OiBzZWxmLAogICAgICAgIGFyZ3M6IGFyZ3MsCiAgICAgICAgbGFiZWw6ICdAZ2xpbW1lci9jbG9zdXJlLWFjdGlvbicKICAgICAgfTsKICAgICAgcmV0dXJuICgwLCBfaW5zdHJ1bWVudGF0aW9uLmZsYWdnZWRJbnN0cnVtZW50KSgnaW50ZXJhY3Rpb24uZW1iZXItYWN0aW9uJywgcGF5bG9hZCwgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBfcnVubG9vcC5qb2luLmFwcGx5KHZvaWQgMCwgW3NlbGYsIGZuXS5jb25jYXQocHJvY2Vzc0FyZ3MoYXJncykpKTsKICAgICAgfSk7CiAgICB9OwogIH0KICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICAgVXNlIHRoZSBge3thcnJheX19YCBoZWxwZXIgdG8gY3JlYXRlIGFuIGFycmF5IHRvIHBhc3MgYXMgYW4gb3B0aW9uIHRvIHlvdXIKICAgICBjb21wb25lbnRzLgogIAogICAgIGBgYGhhbmRsZWJhcnMKICAgICA8TXlDb21wb25lbnQgQHBlb3BsZT17e2FycmF5CiAgICAgICAnVG9tIERhZGUnCiAgICAgICAnWWVodWRhIEthdHonCiAgICAgICB0aGlzLm15T3RoZXJQZXJzb259fQogICAgIC8+CiAgICAgYGBgCiAgICAgIG9yCiAgICAgYGBgaGFuZGxlYmFycwogICAgIHt7bXktY29tcG9uZW50IHBlb3BsZT0oYXJyYXkKICAgICAgICdUb20gRGFkZScKICAgICAgICdZZWh1ZGEgS2F0eicKICAgICAgIHRoaXMubXlPdGhlclBlcnNvbikKICAgICB9fQogICAgIGBgYAogIAogICAgIFdvdWxkIHJlc3VsdCBpbiBhbiBvYmplY3Qgc3VjaCBhczoKICAKICAgICBgYGBqcwogICAgIFsnVG9tIERhdGUnLCAnWWVodWRhIEthdHonLCB0aGlzLmdldCgnbXlPdGhlclBlcnNvbicpXQogICAgIGBgYAogIAogICAgIFdoZXJlIHRoZSAzcmQgaXRlbSBpbiB0aGUgYXJyYXkgaXMgYm91bmQgdG8gdXBkYXRlcyBvZiB0aGUgYG15T3RoZXJQZXJzb25gIHByb3BlcnR5LgogIAogICAgIEBtZXRob2QgYXJyYXkKICAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICAgQHBhcmFtIHtBcnJheX0gb3B0aW9ucwogICAgIEByZXR1cm4ge0FycmF5fSBBcnJheQogICAgIEBzaW5jZSAzLjguMAogICAgIEBwdWJsaWMKICAgKi8KCgogIGZ1bmN0aW9uIGFycmF5KF92bSwgYXJncykgewogICAgcmV0dXJuIGFyZ3MucG9zaXRpb25hbC5jYXB0dXJlKCk7CiAgfQoKICB2YXIgaXNFbXB0eSA9IGZ1bmN0aW9uIGlzRW1wdHkodmFsdWUkJDEpIHsKICAgIHJldHVybiB2YWx1ZSQkMSA9PT0gbnVsbCB8fCB2YWx1ZSQkMSA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiB2YWx1ZSQkMS50b1N0cmluZyAhPT0gJ2Z1bmN0aW9uJzsKICB9OwoKICB2YXIgbm9ybWFsaXplVGV4dFZhbHVlID0gZnVuY3Rpb24gbm9ybWFsaXplVGV4dFZhbHVlKHZhbHVlJCQxKSB7CiAgICBpZiAoaXNFbXB0eSh2YWx1ZSQkMSkpIHsKICAgICAgcmV0dXJuICcnOwogICAgfQoKICAgIHJldHVybiBTdHJpbmcodmFsdWUkJDEpOwogIH07CiAgLyoqCiAgQG1vZHVsZSBlbWJlcgogICovCgogIC8qKgogICAgQ29uY2F0ZW5hdGVzIHRoZSBnaXZlbiBhcmd1bWVudHMgaW50byBhIHN0cmluZy4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7e3NvbWUtY29tcG9uZW50IG5hbWU9KGNvbmNhdCBmaXJzdE5hbWUgIiAiIGxhc3ROYW1lKX19CiAgCiAgICB7eyEgd291bGQgcGFzcyBuYW1lPSI8Zmlyc3QgbmFtZSB2YWx1ZT4gPGxhc3QgbmFtZSB2YWx1ZT4iIHRvIHRoZSBjb21wb25lbnR9fQogICAgYGBgCiAgCiAgICBvciBmb3IgYW5nbGUgYnJhY2tldCBpbnZvY2F0aW9uLCB5b3UgYWN0dWFsbHkgZG9uJ3QgbmVlZCBjb25jYXQgYXQgYWxsLgogIAogICAgYGBgaGFuZGxlYmFycwogICAgPFNvbWVDb21wb25lbnQgQG5hbWU9Int7Zmlyc3ROYW1lfX0ge3tsYXN0TmFtZX19IiAvPgogICAgYGBgCiAgCiAgICBAcHVibGljCiAgICBAbWV0aG9kIGNvbmNhdAogICAgQGZvciBFbWJlci5UZW1wbGF0ZXMuaGVscGVycwogICAgQHNpbmNlIDEuMTMuMAogICovCgoKICBmdW5jdGlvbiBjb25jYXQoX3JlZjI2KSB7CiAgICB2YXIgcG9zaXRpb25hbCA9IF9yZWYyNi5wb3NpdGlvbmFsOwogICAgcmV0dXJuIHBvc2l0aW9uYWwudmFsdWUoKS5tYXAobm9ybWFsaXplVGV4dFZhbHVlKS5qb2luKCcnKTsKICB9CgogIGZ1bmN0aW9uIGNvbmNhdCQxKF92bSwgYXJncykgewogICAgcmV0dXJuIG5ldyBJbnRlcm5hbEhlbHBlclJlZmVyZW5jZShjb25jYXQsIGFyZ3MuY2FwdHVyZSgpKTsKICB9CgogIGZ1bmN0aW9uIGJ1aWxkVW50b3VjaGFibGVUaGlzKHNvdXJjZSkgewogICAgdmFyIGNvbnRleHQgPSBudWxsOwoKICAgIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICYmIF91dGlscy5IQVNfTkFUSVZFX1BST1hZKSB7CiAgICAgIHZhciBhc3NlcnRPblByb3BlcnR5ID0gZnVuY3Rpb24gYXNzZXJ0T25Qcm9wZXJ0eShwcm9wZXJ0eSkgewogICAgICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIllvdSBhY2Nlc3NlZCBgdGhpcy4iICsgU3RyaW5nKHByb3BlcnR5KSArICJgIGZyb20gYSBmdW5jdGlvbiBwYXNzZWQgdG8gdGhlICIgKyBzb3VyY2UgKyAiLCBidXQgdGhlIGZ1bmN0aW9uIGl0c2VsZiB3YXMgbm90IGJvdW5kIHRvIGEgdmFsaWQgYHRoaXNgIGNvbnRleHQuIENvbnNpZGVyIHVwZGF0aW5nIHRvIHVzYWdlIG9mIGBAYWN0aW9uYC4iKSk7CiAgICAgIH07CgogICAgICBjb250ZXh0ID0gbmV3IFByb3h5KHt9LCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoX3RhcmdldCwgcHJvcGVydHkpIHsKICAgICAgICAgIGFzc2VydE9uUHJvcGVydHkocHJvcGVydHkpOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoX3RhcmdldCwgcHJvcGVydHkpIHsKICAgICAgICAgIGFzc2VydE9uUHJvcGVydHkocHJvcGVydHkpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgaGFzOiBmdW5jdGlvbiBoYXMoX3RhcmdldCwgcHJvcGVydHkpIHsKICAgICAgICAgIGFzc2VydE9uUHJvcGVydHkocHJvcGVydHkpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIGNvbnRleHQ7CiAgfQoKICB2YXIgY29udGV4dCA9IGJ1aWxkVW50b3VjaGFibGVUaGlzKCdgZm5gIGhlbHBlcicpOwogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwoKICAvKioKICAgIFRoZSBgZm5gIGhlbHBlciBhbGxvd3MgeW91IHRvIGVuc3VyZSBhIGZ1bmN0aW9uIHRoYXQgeW91IGFyZSBwYXNzaW5nIG9mZgogICAgdG8gYW5vdGhlciBjb21wb25lbnQsIGhlbHBlciwgb3IgbW9kaWZpZXIgaGFzIGFjY2VzcyB0byBhcmd1bWVudHMgdGhhdCBhcmUKICAgIGF2YWlsYWJsZSBpbiB0aGUgdGVtcGxhdGUuCiAgCiAgICBGb3IgZXhhbXBsZSwgaWYgeW91IGhhdmUgYW4gYGVhY2hgIGhlbHBlciBsb29waW5nIG92ZXIgYSBudW1iZXIgb2YgaXRlbXMsIHlvdQogICAgbWF5IG5lZWQgdG8gcGFzcyBhIGZ1bmN0aW9uIHRoYXQgZXhwZWN0cyB0byByZWNlaXZlIHRoZSBpdGVtIGFzIGFuIGFyZ3VtZW50CiAgICB0byBhIGNvbXBvbmVudCBpbnZva2VkIHdpdGhpbiB0aGUgbG9vcC4gSGVyZSdzIGhvdyB5b3UgY291bGQgdXNlIHRoZSBgZm5gCiAgICBoZWxwZXIgdG8gcGFzcyBib3RoIHRoZSBmdW5jdGlvbiBhbmQgaXRzIGFyZ3VtZW50cyB0b2dldGhlcjoKICAKICAgICAgYGBgYXBwL3RlbXBsYXRlcy9jb21wb25lbnRzL2l0ZW1zLWxpc3RpbmcuaGJzCiAgICB7eyNlYWNoIEBpdGVtcyBhcyB8aXRlbXx9fQogICAgICA8RGlzcGxheUl0ZW0gQGl0ZW09aXRlbSBAc2VsZWN0PXt7Zm4gdGhpcy5oYW5kbGVTZWxlY3RlZCBpdGVtfX0gLz4KICAgIHt7L2VhY2h9fQogICAgYGBgCiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9pdGVtcy1saXN0LmpzCiAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BnbGltbWVyL2NvbXBvbmVudCc7CiAgICBpbXBvcnQgeyBhY3Rpb24gfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIEl0ZW1zTGlzdCBleHRlbmRzIENvbXBvbmVudCB7CiAgICAgIEBhY3Rpb24KICAgICAgaGFuZGxlU2VsZWN0ZWQoaXRlbSkgewogICAgICAgIC8vIC4uLnNuaXAuLi4KICAgICAgfQogICAgfQogICAgYGBgCiAgCiAgICBJbiB0aGlzIGNhc2UgdGhlIGBkaXNwbGF5LWl0ZW1gIGNvbXBvbmVudCB3aWxsIHJlY2VpdmUgYSBub3JtYWwgZnVuY3Rpb24KICAgIHRoYXQgaXQgY2FuIGludm9rZS4gV2hlbiBpdCBpbnZva2VzIHRoZSBmdW5jdGlvbiwgdGhlIGBoYW5kbGVTZWxlY3RlZGAKICAgIGZ1bmN0aW9uIHdpbGwgcmVjZWl2ZSB0aGUgYGl0ZW1gIGFuZCBhbnkgYXJndW1lbnRzIHBhc3NlZCwgdGhhbmtzIHRvIHRoZQogICAgYGZuYCBoZWxwZXIuCiAgCiAgICBMZXQncyB0YWtlIGxvb2sgYXQgd2hhdCB0aGF0IG1lYW5zIGluIGEgY291cGxlIGNpcmN1bXN0YW5jZXM6CiAgCiAgICAtIFdoZW4gaW52b2tlZCBhcyBgdGhpcy5hcmdzLnNlbGVjdCgpYCB0aGUgYGhhbmRsZVNlbGVjdGVkYCBmdW5jdGlvbiB3aWxsCiAgICAgIHJlY2VpdmUgdGhlIGBpdGVtYCBmcm9tIHRoZSBsb29wIGFzIGl0cyBmaXJzdCBhbmQgb25seSBhcmd1bWVudC4KICAgIC0gV2hlbiBpbnZva2VkIGFzIGB0aGlzLmFyZ3Muc2VsZWN0KCdmb28nKWAgdGhlIGBoYW5kbGVTZWxlY3RlZGAgZnVuY3Rpb24KICAgICAgd2lsbCByZWNlaXZlIHRoZSBgaXRlbWAgZnJvbSB0aGUgbG9vcCBhcyBpdHMgZmlyc3QgYXJndW1lbnQgYW5kIHRoZQogICAgICBzdHJpbmcgYCdmb28nYCBhcyBpdHMgc2Vjb25kIGFyZ3VtZW50LgogIAogICAgSW4gdGhlIGV4YW1wbGUgYWJvdmUsIHdlIHVzZWQgYEBhY3Rpb25gIHRvIGVuc3VyZSB0aGF0IGBoYW5kbGVTZWxlY3RlZGAgaXMKICAgIHByb3Blcmx5IGJvdW5kIHRvIHRoZSBgaXRlbXMtbGlzdGAsIGJ1dCBsZXQncyBleHBsb3JlIHdoYXQgaGFwcGVucyBpZiB3ZQogICAgbGVmdCBvdXQgYEBhY3Rpb25gOgogIAogICAgYGBgYXBwL2NvbXBvbmVudHMvaXRlbXMtbGlzdC5qcwogICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZ2xpbW1lci9jb21wb25lbnQnOwogIAogICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgSXRlbXNMaXN0IGV4dGVuZHMgQ29tcG9uZW50IHsKICAgICAgaGFuZGxlU2VsZWN0ZWQoaXRlbSkgewogICAgICAgIC8vIC4uLnNuaXAuLi4KICAgICAgfQogICAgfQogICAgYGBgCiAgCiAgICBJbiB0aGlzIGV4YW1wbGUsIHdoZW4gYGhhbmRsZVNlbGVjdGVkYCBpcyBpbnZva2VkIGluc2lkZSB0aGUgYGRpc3BsYXktaXRlbWAKICAgIGNvbXBvbmVudCwgaXQgd2lsbCAqKm5vdCoqIGhhdmUgYWNjZXNzIHRvIHRoZSBjb21wb25lbnQgaW5zdGFuY2UuIEluIG90aGVyCiAgICB3b3JkcywgaXQgd2lsbCBoYXZlIG5vIGB0aGlzYCBjb250ZXh0LCBzbyBwbGVhc2UgbWFrZSBzdXJlIHlvdXIgZnVuY3Rpb25zCiAgICBhcmUgYm91bmQgKHZpYSBgQGFjdGlvbmAgb3Igb3RoZXIgbWVhbnMpIGJlZm9yZSBwYXNzaW5nIGludG8gYGZuYCEKICAKICAgIFNlZSBhbHNvIFtwYXJ0aWFsIGFwcGxpY2F0aW9uXShodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9QYXJ0aWFsX2FwcGxpY2F0aW9uKS4KICAKICAgIEBtZXRob2QgZm4KICAgIEBmb3IgRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMKICAgIEBwdWJsaWMKICAgIEBzaW5jZSAzLjExLjAKICAqLwoKICBmdW5jdGlvbiBmbkhlbHBlcihfcmVmMjcpIHsKICAgIHZhciBwb3NpdGlvbmFsID0gX3JlZjI3LnBvc2l0aW9uYWw7CiAgICB2YXIgY2FsbGJhY2tSZWYgPSBwb3NpdGlvbmFsLmF0KDApOwoKICAgIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICYmIHR5cGVvZiBjYWxsYmFja1JlZltJTlZPS0VdICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHZhciBjYWxsYmFjayA9IGNhbGxiYWNrUmVmLnZhbHVlKCk7CiAgICAgIChmYWxzZSAmJiAhKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJZb3UgbXVzdCBwYXNzIGEgZnVuY3Rpb24gYXMgdGhlIGBmbmAgaGVscGVycyBmaXJzdCBhcmd1bWVudCwgeW91IHBhc3NlZCAiICsgY2FsbGJhY2ssIHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykpOwogICAgfQoKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfcG9zaXRpb25hbCR2YWx1ZSA9IHBvc2l0aW9uYWwudmFsdWUoKSwKICAgICAgICAgIGZuID0gX3Bvc2l0aW9uYWwkdmFsdWVbMF0sCiAgICAgICAgICBhcmdzID0gX3Bvc2l0aW9uYWwkdmFsdWUuc2xpY2UoMSk7CgogICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGludm9jYXRpb25BcmdzID0gbmV3IEFycmF5KF9sZW4yKSwgX2tleTMgPSAwOyBfa2V5MyA8IF9sZW4yOyBfa2V5MysrKSB7CiAgICAgICAgaW52b2NhdGlvbkFyZ3NbX2tleTNdID0gYXJndW1lbnRzW19rZXkzXTsKICAgICAgfQoKICAgICAgaWYgKHR5cGVvZiBjYWxsYmFja1JlZltJTlZPS0VdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgLy8gcmVmZXJlbmNlcyB3aXRoIHRoZSBJTlZPS0Ugc3ltYm9sIGV4cGVjdCB0aGUgZnVuY3Rpb24gYmVoaW5kCiAgICAgICAgLy8gdGhlIHN5bWJvbCB0byBiZSBib3VuZCB0byB0aGUgcmVmZXJlbmNlCiAgICAgICAgcmV0dXJuIGNhbGxiYWNrUmVmW0lOVk9LRV0uYXBwbHkoY2FsbGJhY2tSZWYsIGFyZ3MuY29uY2F0KGludm9jYXRpb25BcmdzKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZuWydjYWxsJ10uYXBwbHkoZm4sIFtjb250ZXh0XS5jb25jYXQoYXJncywgaW52b2NhdGlvbkFyZ3MpKTsKICAgICAgfQogICAgfTsKICB9CgogIGZ1bmN0aW9uIGZuKF92bSwgYXJncykgewogICAgcmV0dXJuIG5ldyBJbnRlcm5hbEhlbHBlclJlZmVyZW5jZShmbkhlbHBlciwgYXJncy5jYXB0dXJlKCkpOwogIH0KICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICBEeW5hbWljYWxseSBsb29rIHVwIGEgcHJvcGVydHkgb24gYW4gb2JqZWN0LiBUaGUgc2Vjb25kIGFyZ3VtZW50IHRvIGB7e2dldH19YAogICAgc2hvdWxkIGhhdmUgYSBzdHJpbmcgdmFsdWUsIGFsdGhvdWdoIGl0IGNhbiBiZSBib3VuZC4KICAKICAgIEZvciBleGFtcGxlLCB0aGVzZSB0d28gdXNhZ2VzIGFyZSBlcXVpdmFsZW50OgogIAogICAgYGBgaGFuZGxlYmFycwogICAge3twZXJzb24uaGVpZ2h0fX0KICAgIHt7Z2V0IHBlcnNvbiAiaGVpZ2h0In19CiAgICBgYGAKICAKICAgIElmIHRoZXJlIHdlcmUgc2V2ZXJhbCBmYWN0cyBhYm91dCBhIHBlcnNvbiwgdGhlIGB7e2dldH19YCBoZWxwZXIgY2FuIGR5bmFtaWNhbGx5CiAgICBwaWNrIG9uZToKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIHt7Z2V0IHBlcnNvbiBmYWN0TmFtZX19CiAgICBgYGAKICAKICAgIEZvciBhIG1vcmUgY29tcGxleCBleGFtcGxlLCB0aGlzIHRlbXBsYXRlIHdvdWxkIGFsbG93IHRoZSB1c2VyIHRvIHN3aXRjaAogICAgYmV0d2VlbiBzaG93aW5nIHRoZSB1c2VyJ3MgaGVpZ2h0IGFuZCB3ZWlnaHQgd2l0aCBhIGNsaWNrOgogIAogICAgYGBgaGFuZGxlYmFycwogICAge3tnZXQgcGVyc29uIGZhY3ROYW1lfX0KICAgIDxidXR0b24ge3thY3Rpb24gKGZuIChtdXQgZmFjdE5hbWUpKSAiaGVpZ2h0In19PlNob3cgaGVpZ2h0PC9idXR0b24+CiAgICA8YnV0dG9uIHt7YWN0aW9uIChmbiAobXV0IGZhY3ROYW1lKSkgIndlaWdodCJ9fT5TaG93IHdlaWdodDwvYnV0dG9uPgogICAgYGBgCiAgCiAgICBUaGUgYHt7Z2V0fX1gIGhlbHBlciBjYW4gYWxzbyByZXNwZWN0IG11dGFibGUgdmFsdWVzIGl0c2VsZi4gRm9yIGV4YW1wbGU6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7e2lucHV0IHZhbHVlPShtdXQgKGdldCBwZXJzb24gZmFjdE5hbWUpKSB0eXBlPSJ0ZXh0In19CiAgICA8YnV0dG9uIHt7YWN0aW9uIChmbiAobXV0IGZhY3ROYW1lKSkgImhlaWdodCJ9fT5TaG93IGhlaWdodDwvYnV0dG9uPgogICAgPGJ1dHRvbiB7e2FjdGlvbiAoZm4gKG11dCBmYWN0TmFtZSkpICJ3ZWlnaHQifX0+U2hvdyB3ZWlnaHQ8L2J1dHRvbj4KICAgIGBgYAogIAogICAgV291bGQgYWxsb3cgdGhlIHVzZXIgdG8gc3dhcCB3aGF0IGZhY3QgaXMgYmVpbmcgZGlzcGxheWVkLCBhbmQgYWxzbyBlZGl0CiAgICB0aGF0IGZhY3QgdmlhIGEgdHdvLXdheSBtdXRhYmxlIGJpbmRpbmcuCiAgCiAgICBAcHVibGljCiAgICBAbWV0aG9kIGdldAogICAgQGZvciBFbWJlci5UZW1wbGF0ZXMuaGVscGVycwogICAgQHNpbmNlIDIuMS4wCiAgICovCgoKICBmdW5jdGlvbiBnZXQkMShfdm0sIGFyZ3MpIHsKICAgIHJldHVybiBHZXRIZWxwZXJSZWZlcmVuY2UuY3JlYXRlKGFyZ3MucG9zaXRpb25hbC5hdCgwKSwgYXJncy5wb3NpdGlvbmFsLmF0KDEpKTsKICB9CgogIGZ1bmN0aW9uIHJlZmVyZW5jZUZyb21QYXRoKHNvdXJjZSwgcGF0aCkgewogICAgdmFyIGlubmVyUmVmZXJlbmNlOwoKICAgIGlmIChwYXRoID09PSB1bmRlZmluZWQgfHwgcGF0aCA9PT0gbnVsbCB8fCBwYXRoID09PSAnJykgewogICAgICBpbm5lclJlZmVyZW5jZSA9IF9ydW50aW1lMi5OVUxMX1JFRkVSRU5DRTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHBhdGggPT09ICdzdHJpbmcnICYmIHBhdGguaW5kZXhPZignLicpID4gLTEpIHsKICAgICAgaW5uZXJSZWZlcmVuY2UgPSByZWZlcmVuY2VGcm9tUGFydHMoc291cmNlLCBwYXRoLnNwbGl0KCcuJykpOwogICAgfSBlbHNlIHsKICAgICAgaW5uZXJSZWZlcmVuY2UgPSBzb3VyY2UuZ2V0KHBhdGgpOwogICAgfQoKICAgIHJldHVybiBpbm5lclJlZmVyZW5jZTsKICB9CgogIHZhciBHZXRIZWxwZXJSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0NhY2hlZFJlZmVyZW5jZSQ2KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoR2V0SGVscGVyUmVmZXJlbmNlLCBfQ2FjaGVkUmVmZXJlbmNlJDYpOwoKICAgIEdldEhlbHBlclJlZmVyZW5jZS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUoc291cmNlUmVmZXJlbmNlLCBwYXRoUmVmZXJlbmNlKSB7CiAgICAgIGlmICgoMCwgX3JlZmVyZW5jZS5pc0NvbnN0KShwYXRoUmVmZXJlbmNlKSkgewogICAgICAgIHZhciBwYXRoID0gcGF0aFJlZmVyZW5jZS52YWx1ZSgpOwogICAgICAgIHJldHVybiByZWZlcmVuY2VGcm9tUGF0aChzb3VyY2VSZWZlcmVuY2UsIHBhdGgpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuZXcgR2V0SGVscGVyUmVmZXJlbmNlKHNvdXJjZVJlZmVyZW5jZSwgcGF0aFJlZmVyZW5jZSk7CiAgICAgIH0KICAgIH07CgogICAgZnVuY3Rpb24gR2V0SGVscGVyUmVmZXJlbmNlKHNvdXJjZVJlZmVyZW5jZSwgcGF0aFJlZmVyZW5jZSkgewogICAgICB2YXIgX3RoaXMyMzsKCiAgICAgIF90aGlzMjMgPSBfQ2FjaGVkUmVmZXJlbmNlJDYuY2FsbCh0aGlzKSB8fCB0aGlzOwogICAgICBfdGhpczIzLnNvdXJjZVJlZmVyZW5jZSA9IHNvdXJjZVJlZmVyZW5jZTsKICAgICAgX3RoaXMyMy5wYXRoUmVmZXJlbmNlID0gcGF0aFJlZmVyZW5jZTsKICAgICAgX3RoaXMyMy5sYXN0UGF0aCA9IG51bGw7CiAgICAgIF90aGlzMjMuaW5uZXJSZWZlcmVuY2UgPSBfcnVudGltZTIuTlVMTF9SRUZFUkVOQ0U7CiAgICAgIHZhciBpbm5lclRhZyA9IF90aGlzMjMuaW5uZXJUYWcgPSAoMCwgX3JlZmVyZW5jZS5jcmVhdGVVcGRhdGFibGVUYWcpKCk7CiAgICAgIF90aGlzMjMudGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW3NvdXJjZVJlZmVyZW5jZS50YWcsIHBhdGhSZWZlcmVuY2UudGFnLCBpbm5lclRhZ10pOwogICAgICByZXR1cm4gX3RoaXMyMzsKICAgIH0KCiAgICB2YXIgX3Byb3RvNTUgPSBHZXRIZWxwZXJSZWZlcmVuY2UucHJvdG90eXBlOwoKICAgIF9wcm90bzU1LmNvbXB1dGUgPSBmdW5jdGlvbiBjb21wdXRlKCkgewogICAgICB2YXIgbGFzdFBhdGggPSB0aGlzLmxhc3RQYXRoLAogICAgICAgICAgaW5uZXJSZWZlcmVuY2UgPSB0aGlzLmlubmVyUmVmZXJlbmNlLAogICAgICAgICAgaW5uZXJUYWcgPSB0aGlzLmlubmVyVGFnOwogICAgICB2YXIgcGF0aCA9IHRoaXMucGF0aFJlZmVyZW5jZS52YWx1ZSgpOwoKICAgICAgaWYgKHBhdGggIT09IGxhc3RQYXRoKSB7CiAgICAgICAgaW5uZXJSZWZlcmVuY2UgPSByZWZlcmVuY2VGcm9tUGF0aCh0aGlzLnNvdXJjZVJlZmVyZW5jZSwgcGF0aCk7CiAgICAgICAgKDAsIF9yZWZlcmVuY2UudXBkYXRlKShpbm5lclRhZywgaW5uZXJSZWZlcmVuY2UudGFnKTsKICAgICAgICB0aGlzLmlubmVyUmVmZXJlbmNlID0gaW5uZXJSZWZlcmVuY2U7CiAgICAgICAgdGhpcy5sYXN0UGF0aCA9IHBhdGg7CiAgICAgIH0KCiAgICAgIHJldHVybiBpbm5lclJlZmVyZW5jZS52YWx1ZSgpOwogICAgfTsKCiAgICBfcHJvdG81NVtVUERBVEVdID0gZnVuY3Rpb24gKHZhbHVlJCQxKSB7CiAgICAgICgwLCBfbWV0YWwuc2V0KSh0aGlzLnNvdXJjZVJlZmVyZW5jZS52YWx1ZSgpLCB0aGlzLnBhdGhSZWZlcmVuY2UudmFsdWUoKSwgdmFsdWUkJDEpOwogICAgfTsKCiAgICByZXR1cm4gR2V0SGVscGVyUmVmZXJlbmNlOwogIH0oQ2FjaGVkUmVmZXJlbmNlJDEpOwogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwoKICAvKioKICAgICBVc2UgdGhlIGB7e2hhc2h9fWAgaGVscGVyIHRvIGNyZWF0ZSBhIGhhc2ggdG8gcGFzcyBhcyBhbiBvcHRpb24gdG8geW91cgogICAgIGNvbXBvbmVudHMuIFRoaXMgaXMgc3BlY2lhbGx5IHVzZWZ1bCBmb3IgY29udGV4dHVhbCBjb21wb25lbnRzIHdoZXJlIHlvdSBjYW4KICAgICBqdXN0IHlpZWxkIGEgaGFzaDoKICAKICAgICBgYGBoYW5kbGViYXJzCiAgICAge3t5aWVsZCAoaGFzaAogICAgICAgIG5hbWU9J1NhcmFoJwogICAgICAgIHRpdGxlPW9mZmljZQogICAgICl9fQogICAgIGBgYAogIAogICAgIFdvdWxkIHJlc3VsdCBpbiBhbiBvYmplY3Qgc3VjaCBhczoKICAKICAgICBgYGBqcwogICAgIHsgbmFtZTogJ1NhcmFoJywgdGl0bGU6IHRoaXMuZ2V0KCdvZmZpY2UnKSB9CiAgICAgYGBgCiAgCiAgICAgV2hlcmUgdGhlIGB0aXRsZWAgaXMgYm91bmQgdG8gdXBkYXRlcyBvZiB0aGUgYG9mZmljZWAgcHJvcGVydHkuCiAgCiAgICAgTm90ZSB0aGF0IHRoZSBoYXNoIGlzIGFuIGVtcHR5IG9iamVjdCB3aXRoIG5vIHByb3RvdHlwZSBjaGFpbiwgdGhlcmVmb3JlCiAgICAgY29tbW9uIG1ldGhvZHMgbGlrZSBgdG9TdHJpbmdgIGFyZSBub3QgYXZhaWxhYmxlIGluIHRoZSByZXN1bHRpbmcgaGFzaC4KICAgICBJZiB5b3UgbmVlZCB0byB1c2Ugc3VjaCBhIG1ldGhvZCwgeW91IGNhbiB1c2UgdGhlIGBjYWxsYCBvciBgYXBwbHlgCiAgICAgYXBwcm9hY2g6CiAgCiAgICAgYGBganMKICAgICBmdW5jdGlvbiB0b1N0cmluZyhvYmopIHsKICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmFwcGx5KG9iaik7CiAgICAgfQogICAgIGBgYAogIAogICAgIEBtZXRob2QgaGFzaAogICAgIEBmb3IgRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMKICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgIEByZXR1cm4ge09iamVjdH0gSGFzaAogICAgIEBzaW5jZSAyLjMuMAogICAgIEBwdWJsaWMKICAgKi8KCgogIGZ1bmN0aW9uIGhhc2goX3ZtLCBhcmdzKSB7CiAgICByZXR1cm4gYXJncy5uYW1lZC5jYXB0dXJlKCk7CiAgfQogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwoKCiAgdmFyIENvbmRpdGlvbmFsSGVscGVyUmVmZXJlbmNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9DYWNoZWRSZWZlcmVuY2UkNykgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKENvbmRpdGlvbmFsSGVscGVyUmVmZXJlbmNlLCBfQ2FjaGVkUmVmZXJlbmNlJDcpOwoKICAgIENvbmRpdGlvbmFsSGVscGVyUmVmZXJlbmNlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShfY29uZFJlZiwgdHJ1dGh5UmVmLCBmYWxzeVJlZikgewogICAgICB2YXIgY29uZFJlZiA9IENvbmRpdGlvbmFsUmVmZXJlbmNlJDEuY3JlYXRlKF9jb25kUmVmKTsKCiAgICAgIGlmICgoMCwgX3JlZmVyZW5jZS5pc0NvbnN0KShjb25kUmVmKSkgewogICAgICAgIHJldHVybiBjb25kUmVmLnZhbHVlKCkgPyB0cnV0aHlSZWYgOiBmYWxzeVJlZjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IENvbmRpdGlvbmFsSGVscGVyUmVmZXJlbmNlKGNvbmRSZWYsIHRydXRoeVJlZiwgZmFsc3lSZWYpOwogICAgICB9CiAgICB9OwoKICAgIGZ1bmN0aW9uIENvbmRpdGlvbmFsSGVscGVyUmVmZXJlbmNlKGNvbmQsIHRydXRoeSwgZmFsc3kpIHsKICAgICAgdmFyIF90aGlzMjQ7CgogICAgICBfdGhpczI0ID0gX0NhY2hlZFJlZmVyZW5jZSQ3LmNhbGwodGhpcykgfHwgdGhpczsKICAgICAgX3RoaXMyNC5icmFuY2hUYWcgPSAoMCwgX3JlZmVyZW5jZS5jcmVhdGVVcGRhdGFibGVUYWcpKCk7CiAgICAgIF90aGlzMjQudGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW2NvbmQudGFnLCBfdGhpczI0LmJyYW5jaFRhZ10pOwogICAgICBfdGhpczI0LmNvbmQgPSBjb25kOwogICAgICBfdGhpczI0LnRydXRoeSA9IHRydXRoeTsKICAgICAgX3RoaXMyNC5mYWxzeSA9IGZhbHN5OwogICAgICByZXR1cm4gX3RoaXMyNDsKICAgIH0KCiAgICB2YXIgX3Byb3RvNTYgPSBDb25kaXRpb25hbEhlbHBlclJlZmVyZW5jZS5wcm90b3R5cGU7CgogICAgX3Byb3RvNTYuY29tcHV0ZSA9IGZ1bmN0aW9uIGNvbXB1dGUoKSB7CiAgICAgIHZhciBicmFuY2ggPSB0aGlzLmNvbmQudmFsdWUoKSA/IHRoaXMudHJ1dGh5IDogdGhpcy5mYWxzeTsKICAgICAgKDAsIF9yZWZlcmVuY2UudXBkYXRlKSh0aGlzLmJyYW5jaFRhZywgYnJhbmNoLnRhZyk7CiAgICAgIHJldHVybiBicmFuY2gudmFsdWUoKTsKICAgIH07CgogICAgcmV0dXJuIENvbmRpdGlvbmFsSGVscGVyUmVmZXJlbmNlOwogIH0oQ2FjaGVkUmVmZXJlbmNlJDEpOwogIC8qKgogICAgVGhlIGBpZmAgaGVscGVyIGFsbG93cyB5b3UgdG8gY29uZGl0aW9uYWxseSByZW5kZXIgb25lIG9mIHR3byBicmFuY2hlcywKICAgIGRlcGVuZGluZyBvbiB0aGUgInRydXRoaW5lc3MiIG9mIGEgcHJvcGVydHkuCiAgICBGb3IgZXhhbXBsZSB0aGUgZm9sbG93aW5nIHZhbHVlcyBhcmUgYWxsIGZhbHNleTogYGZhbHNlYCwgYHVuZGVmaW5lZGAsIGBudWxsYCwgYCIiYCwgYDBgLCBgTmFOYCBvciBhbiBlbXB0eSBhcnJheS4KICAKICAgIFRoaXMgaGVscGVyIGhhcyB0d28gZm9ybXMsIGJsb2NrIGFuZCBpbmxpbmUuCiAgCiAgICAjIyBCbG9jayBmb3JtCiAgCiAgICBZb3UgY2FuIHVzZSB0aGUgYmxvY2sgZm9ybSBvZiBgaWZgIHRvIGNvbmRpdGlvbmFsbHkgcmVuZGVyIGEgc2VjdGlvbiBvZiB0aGUgdGVtcGxhdGUuCiAgCiAgICBUbyB1c2UgaXQsIHBhc3MgdGhlIGNvbmRpdGlvbmFsIHZhbHVlIHRvIHRoZSBgaWZgIGhlbHBlciwKICAgIHVzaW5nIHRoZSBibG9jayBmb3JtIHRvIHdyYXAgdGhlIHNlY3Rpb24gb2YgdGVtcGxhdGUgeW91IHdhbnQgdG8gY29uZGl0aW9uYWxseSByZW5kZXIuCiAgICBMaWtlIHNvOgogIAogICAgYGBgaGFuZGxlYmFycwogICAge3shIHdpbGwgbm90IHJlbmRlciBpZiBmb28gaXMgZmFsc2V5fX0KICAgIHt7I2lmIGZvb319CiAgICAgIFdlbGNvbWUgdG8gdGhlIHt7Zm9vLmJhcn19CiAgICB7ey9pZn19CiAgICBgYGAKICAKICAgIFlvdSBjYW4gYWxzbyBzcGVjaWZ5IGEgdGVtcGxhdGUgdG8gc2hvdyBpZiB0aGUgcHJvcGVydHkgaXMgZmFsc2V5IGJ5IHVzaW5nCiAgICB0aGUgYGVsc2VgIGhlbHBlci4KICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIHt7ISBpcyBpdCByYWluaW5nIG91dHNpZGU/fX0KICAgIHt7I2lmIGlzUmFpbmluZ319CiAgICAgIFllcywgZ3JhYiBhbiB1bWJyZWxsYSEKICAgIHt7ZWxzZX19CiAgICAgIE5vLCBpdCdzIGxvdmVseSBvdXRzaWRlIQogICAge3svaWZ9fQogICAgYGBgCiAgCiAgICBZb3UgYXJlIGFsc28gYWJsZSB0byBjb21iaW5lIGBlbHNlYCBhbmQgYGlmYCBoZWxwZXJzIHRvIGNyZWF0ZSBtb3JlIGNvbXBsZXgKICAgIGNvbmRpdGlvbmFsIGxvZ2ljLgogIAogICAgYGBgaGFuZGxlYmFycwogICAge3sjaWYgaXNNb3JuaW5nfX0KICAgICAgR29vZCBtb3JuaW5nCiAgICB7e2Vsc2UgaWYgaXNBZnRlcm5vb259fQogICAgICBHb29kIGFmdGVybm9vbgogICAge3tlbHNlfX0KICAgICAgR29vZCBuaWdodAogICAge3svaWZ9fQogICAgYGBgCiAgCiAgICAjIyBJbmxpbmUgZm9ybQogIAogICAgVGhlIGlubGluZSBgaWZgIGhlbHBlciBjb25kaXRpb25hbGx5IHJlbmRlcnMgYSBzaW5nbGUgcHJvcGVydHkgb3Igc3RyaW5nLgogIAogICAgSW4gdGhpcyBmb3JtLCB0aGUgYGlmYCBoZWxwZXIgcmVjZWl2ZXMgdGhyZWUgYXJndW1lbnRzLCB0aGUgY29uZGl0aW9uYWwgdmFsdWUsCiAgICB0aGUgdmFsdWUgdG8gcmVuZGVyIHdoZW4gdHJ1dGh5LCBhbmQgdGhlIHZhbHVlIHRvIHJlbmRlciB3aGVuIGZhbHNleS4KICAKICAgIEZvciBleGFtcGxlLCBpZiBgdXNlTG9uZ0dyZWV0aW5nYCBpcyB0cnV0aHksIHRoZSBmb2xsb3dpbmc6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7e2lmIHVzZUxvbmdHcmVldGluZyAiSGVsbG8iICJIaSJ9fSBBbGV4CiAgICBgYGAKICAKICAgIFdpbGwgcmVuZGVyOgogIAogICAgYGBgaHRtbAogICAgSGVsbG8gQWxleAogICAgYGBgCiAgCiAgICAjIyMgTmVzdGVkIGBpZmAKICAKICAgIFlvdSBjYW4gdXNlIHRoZSBgaWZgIGhlbHBlciBpbnNpZGUgYW5vdGhlciBoZWxwZXIgYXMgYSBuZXN0ZWQgaGVscGVyOgogIAogICAgYGBgaGFuZGxlYmFycwogICAgPFNvbWVDb21wb25lbnQgQGhlaWdodD17e2lmIGlzQmlnICIxMDAiICIxMCJ9fSAvPgogICAgYGBgCiAgCiAgICBvcgogIAogICAgYGBgaGFuZGxlYmFycwogICAge3tzb21lLWNvbXBvbmVudCBoZWlnaHQ9KGlmIGlzQmlnICIxMDAiICIxMCIpfX0KICAgIGBgYAogIAogICAgT25lIGRldGFpbCB0byBrZWVwIGluIG1pbmQgaXMgdGhhdCBib3RoIGJyYW5jaGVzIG9mIHRoZSBgaWZgIGhlbHBlciB3aWxsIGJlIGV2YWx1YXRlZCwKICAgIHNvIGlmIHlvdSBoYXZlIGB7e2lmIGNvbmRpdGlvbiAiZm9vIiAoZXhwZW5zaXZlLW9wZXJhdGlvbiAiYmFyIilgLAogICAgYGV4cGVuc2l2ZS1vcGVyYXRpb25gIHdpbGwgYWx3YXlzIGNhbGN1bGF0ZS4KICAKICAgIEBtZXRob2QgaWYKICAgIEBmb3IgRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gaW5saW5lSWYoX3ZtLCBfcmVmMjgpIHsKICAgIHZhciBwb3NpdGlvbmFsID0gX3JlZjI4LnBvc2l0aW9uYWw7CiAgICAoZmFsc2UgJiYgIShwb3NpdGlvbmFsLmxlbmd0aCA9PT0gMyB8fCBwb3NpdGlvbmFsLmxlbmd0aCA9PT0gMikgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUaGUgaW5saW5lIGZvcm0gb2YgdGhlIGBpZmAgaGVscGVyIGV4cGVjdHMgdHdvIG9yIHRocmVlIGFyZ3VtZW50cywgZS5nLiAnICsgJ2B7e2lmIHRyaWFsRXhwaXJlZCAiRXhwaXJlZCIgZXhwaXJ5RGF0ZX19YC4nLCBwb3NpdGlvbmFsLmxlbmd0aCA9PT0gMyB8fCBwb3NpdGlvbmFsLmxlbmd0aCA9PT0gMikpOwogICAgcmV0dXJuIENvbmRpdGlvbmFsSGVscGVyUmVmZXJlbmNlLmNyZWF0ZShwb3NpdGlvbmFsLmF0KDApLCBwb3NpdGlvbmFsLmF0KDEpLCBwb3NpdGlvbmFsLmF0KDIpKTsKICB9CiAgLyoqCiAgICBUaGUgYHVubGVzc2AgaGVscGVyIGlzIHRoZSBpbnZlcnNlIG9mIHRoZSBgaWZgIGhlbHBlci4gSXQgZGlzcGxheXMgaWYgYSB2YWx1ZQogICAgaXMgZmFsc2V5ICgibm90IHRydWUiIG9yICJpcyBmYWxzZSIpLiBFeGFtcGxlIHZhbHVlcyB0aGF0IHdpbGwgZGlzcGxheSB3aXRoCiAgICBgdW5sZXNzYDogYGZhbHNlYCwgYHVuZGVmaW5lZGAsIGBudWxsYCwgYCIiYCwgYDBgLCBgTmFOYCBvciBhbiBlbXB0eSBhcnJheS4KICAKICAgICMjIElubGluZSBmb3JtCiAgCiAgICBUaGUgaW5saW5lIGB1bmxlc3NgIGhlbHBlciBjb25kaXRpb25hbGx5IHJlbmRlcnMgYSBzaW5nbGUgcHJvcGVydHkgb3Igc3RyaW5nLgogICAgVGhpcyBoZWxwZXIgYWN0cyBsaWtlIGEgdGVybmFyeSBvcGVyYXRvci4gSWYgdGhlIGZpcnN0IHByb3BlcnR5IGlzIGZhbHN5LAogICAgdGhlIHNlY29uZCBhcmd1bWVudCB3aWxsIGJlIGRpc3BsYXllZCwgb3RoZXJ3aXNlLCB0aGUgdGhpcmQgYXJndW1lbnQgd2lsbCBiZQogICAgZGlzcGxheWVkCiAgCiAgICBGb3IgZXhhbXBsZSwgaWYgYHVzZUxvbmdHcmVldGluZ2AgaXMgZmFsc2UgYmVsb3c6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7e3VubGVzcyB1c2VMb25nR3JlZXRpbmcgIkhpIiAiSGVsbG8ifX0gQmVuCiAgICBgYGAKICAKICAgIFRoZW4gaXQgd2lsbCBkaXNwbGF5OgogIAogICAgYGBgaHRtbAogICAgSGkKICAgIGBgYAogIAogICAgWW91IGNhbiB1c2UgdGhlIGB1bmxlc3NgIGhlbHBlciBpbnNpZGUgYW5vdGhlciBoZWxwZXIgYXMgYSBzdWJleHByZXNzaW9uLgogICAgSWYgaXNCaWcgaXMgbm90IHRydWUsIGl0IHdpbGwgc2V0IHRoZSBoZWlnaHQgdG8gMTA6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7eyEgSWYgaXNCaWcgaXMgbm90IHRydWUsIGl0IHdpbGwgc2V0IHRoZSBoZWlnaHQgdG8gMTAufX0KICAgIDxTb21lQ29tcG9uZW50IEBoZWlnaHQ9e3t1bmxlc3MgaXNCaWcgIjEwIiAiMTAwIn19IC8+CiAgICBgYGAKICAKICAgIG9yCiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7e3NvbWUtY29tcG9uZW50IGhlaWdodD0odW5sZXNzIGlzQmlnICIxMCIgIjEwMCIpfX0KICAgIGBgYAogIAogICAgIyMgQmxvY2sgZm9ybQogIAogICAgTGlrZSB0aGUgYGlmYCBoZWxwZXIsIGB1bmxlc3NgIGhlbHBlciBhbHNvIGhhcyBhIGJsb2NrIGZvcm0uCiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7eyEgSWYgZ3JlZXRpbmdzIGFyZSBmb3VuZCwgdGhlIHRleHQgYmVsb3cgd2lsbCBub3QgcmVuZGVyLn19CiAgICB7eyN1bmxlc3MgZ3JlZXRpbmdzfX0KICAgICAgTm8gZ3JlZXRpbmdzIHdlcmUgZm91bmQuIFdoeSBub3Qgc2V0IG9uZT8KICAgIHt7L3VubGVzc319CiAgICBgYGAKICAKICAgIFlvdSBjYW4gYWxzbyB1c2UgYW4gYGVsc2VgIGhlbHBlciB3aXRoIHRoZSBgdW5sZXNzYCBibG9jay4gVGhlCiAgICBgZWxzZWAgd2lsbCBkaXNwbGF5IGlmIHRoZSB2YWx1ZSBpcyB0cnV0aHkuCiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7eyEgSXMgdGhlIHVzZXIgbG9nZ2VkIGluP319CiAgICB7eyN1bmxlc3MgdXNlckRhdGF9fQogICAgICBQbGVhc2UgbG9naW4uCiAgICB7e2Vsc2V9fQogICAgICBXZWxjb21lIGJhY2shCiAgICB7ey91bmxlc3N9fQogICAgYGBgCiAgCiAgICBJZiBgdXNlckRhdGFgIGlzIGZhbHNlLCB1bmRlZmluZWQsIG51bGwsIG9yIGVtcHR5IGluIHRoZSBhYm92ZSBleGFtcGxlLAogICAgdGhlbiBpdCB3aWxsIHJlbmRlcjoKICAKICAgIGBgYGh0bWwKICAgIFBsZWFzZSBsb2dpbi4KICAgIGBgYAogIAogICAgQG1ldGhvZCB1bmxlc3MKICAgIEBmb3IgRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gaW5saW5lVW5sZXNzKF92bSwgX3JlZjI5KSB7CiAgICB2YXIgcG9zaXRpb25hbCA9IF9yZWYyOS5wb3NpdGlvbmFsOwogICAgKGZhbHNlICYmICEocG9zaXRpb25hbC5sZW5ndGggPT09IDMgfHwgcG9zaXRpb25hbC5sZW5ndGggPT09IDIpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnVGhlIGlubGluZSBmb3JtIG9mIHRoZSBgdW5sZXNzYCBoZWxwZXIgZXhwZWN0cyB0d28gb3IgdGhyZWUgYXJndW1lbnRzLCBlLmcuICcgKyAnYHt7dW5sZXNzIGlzRmlyc3RMb2dpbiAiV2VsY29tZSBiYWNrISJ9fWAuJywgcG9zaXRpb25hbC5sZW5ndGggPT09IDMgfHwgcG9zaXRpb25hbC5sZW5ndGggPT09IDIpKTsKICAgIHJldHVybiBDb25kaXRpb25hbEhlbHBlclJlZmVyZW5jZS5jcmVhdGUocG9zaXRpb25hbC5hdCgwKSwgcG9zaXRpb25hbC5hdCgyKSwgcG9zaXRpb25hbC5hdCgxKSk7CiAgfQogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwoKICAvKioKICAgIGBsb2dgIGFsbG93cyB5b3UgdG8gb3V0cHV0IHRoZSB2YWx1ZSBvZiB2YXJpYWJsZXMgaW4gdGhlIGN1cnJlbnQgcmVuZGVyaW5nCiAgICBjb250ZXh0LiBgbG9nYCBhbHNvIGFjY2VwdHMgcHJpbWl0aXZlIHR5cGVzIHN1Y2ggYXMgc3RyaW5ncyBvciBudW1iZXJzLgogIAogICAgYGBgaGFuZGxlYmFycwogICAge3tsb2cgIm15VmFyaWFibGU6IiBteVZhcmlhYmxlIH19CiAgICBgYGAKICAKICAgIEBtZXRob2QgbG9nCiAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICBAcGFyYW0ge0FycmF5fSBwYXJhbXMKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gbG9nKF9yZWYzMCkgewogICAgdmFyIF9jb25zb2xlOwoKICAgIHZhciBwb3NpdGlvbmFsID0gX3JlZjMwLnBvc2l0aW9uYWw7CgogICAgLyogZXNsaW50LWRpc2FibGUgbm8tY29uc29sZSAqLwogICAgKF9jb25zb2xlID0gY29uc29sZSkubG9nLmFwcGx5KF9jb25zb2xlLCBwb3NpdGlvbmFsLnZhbHVlKCkpOwogICAgLyogZXNsaW50LWVuYWJsZSBuby1jb25zb2xlICovCgogIH0KCiAgZnVuY3Rpb24gbG9nJDEoX3ZtLCBhcmdzKSB7CiAgICByZXR1cm4gbmV3IEludGVybmFsSGVscGVyUmVmZXJlbmNlKGxvZywgYXJncy5jYXB0dXJlKCkpOwogIH0KICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICBUaGUgYG11dGAgaGVscGVyIGxldHMgeW91IF9fY2xlYXJseSBzcGVjaWZ5X18gdGhhdCBhIGNoaWxkIGBDb21wb25lbnRgIGNhbiB1cGRhdGUgdGhlCiAgICAobXV0YWJsZSkgdmFsdWUgcGFzc2VkIHRvIGl0LCB3aGljaCB3aWxsIF9fY2hhbmdlIHRoZSB2YWx1ZSBvZiB0aGUgcGFyZW50IGNvbXBvbmVudF9fLgogIAogICAgVG8gc3BlY2lmeSB0aGF0IGEgcGFyYW1ldGVyIGlzIG11dGFibGUsIHdoZW4gaW52b2tpbmcgdGhlIGNoaWxkIGBDb21wb25lbnRgOgogIAogICAgYGBgaGFuZGxlYmFycwogICAgPE15Q2hpbGQgQGNoaWxkQ2xpY2tDb3VudD17e2ZuIChtdXQgdG90YWxDbGlja3MpfX0gLz4KICAgIGBgYAogIAogICAgIG9yCiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7e215LWNoaWxkIGNoaWxkQ2xpY2tDb3VudD0obXV0IHRvdGFsQ2xpY2tzKX19CiAgICBgYGAKICAKICAgIFRoZSBjaGlsZCBgQ29tcG9uZW50YCBjYW4gdGhlbiBtb2RpZnkgdGhlIHBhcmVudCdzIHZhbHVlIGp1c3QgYnkgbW9kaWZ5aW5nIGl0cyBvd24KICAgIHByb3BlcnR5OgogIAogICAgYGBgamF2YXNjcmlwdAogICAgLy8gbXktY2hpbGQuanMKICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICBjbGljaygpIHsKICAgICAgICB0aGlzLmluY3JlbWVudFByb3BlcnR5KCdjaGlsZENsaWNrQ291bnQnKTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIE5vdGUgdGhhdCBmb3IgY3VybHkgY29tcG9uZW50cyAoYHt7bXktY29tcG9uZW50fX1gKSB0aGUgYmluZGluZ3MgYXJlIGFscmVhZHkgbXV0YWJsZSwKICAgIG1ha2luZyB0aGUgYG11dGAgdW5uZWNlc3NhcnkuCiAgCiAgICBBZGRpdGlvbmFsbHksIHRoZSBgbXV0YCBoZWxwZXIgY2FuIGJlIGNvbWJpbmVkIHdpdGggdGhlIGBmbmAgaGVscGVyIHRvCiAgICBtdXRhdGUgYSB2YWx1ZS4gRm9yIGV4YW1wbGU6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICA8TXlDaGlsZCBAY2hpbGRDbGlja0NvdW50PXt7dGhpcy50b3RhbENsaWNrc319IEBjbGljay1jb3VudC1jaGFuZ2U9e3tmbiAobXV0IHRvdGFsQ2xpY2tzKSl9fSAvPgogICAgYGBgCiAgCiAgICBvcgogIAogICAgYGBgaGFuZGxlYmFycwogICAge3tteS1jaGlsZCBjaGlsZENsaWNrQ291bnQ9dG90YWxDbGlja3MgY2xpY2stY291bnQtY2hhbmdlPShmbiAobXV0IHRvdGFsQ2xpY2tzKSl9fQogICAgYGBgCiAgCiAgICBUaGUgY2hpbGQgYENvbXBvbmVudGAgd291bGQgaW52b2tlIHRoZSBmdW5jdGlvbiB3aXRoIHRoZSBuZXcgY2xpY2sgdmFsdWU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICAvLyBteS1jaGlsZC5qcwogICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgIGNsaWNrKCkgewogICAgICAgIHRoaXMuZ2V0KCdjbGljay1jb3VudC1jaGFuZ2UnKSh0aGlzLmdldCgnY2hpbGRDbGlja0NvdW50JykgKyAxKTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIFRoZSBgbXV0YCBoZWxwZXIgY2hhbmdlcyB0aGUgYHRvdGFsQ2xpY2tzYCB2YWx1ZSB0byB3aGF0IHdhcyBwcm92aWRlZCBhcyB0aGUgYGZuYCBhcmd1bWVudC4KICAKICAgIFRoZSBgbXV0YCBoZWxwZXIsIHdoZW4gdXNlZCB3aXRoIGBmbmAsIHdpbGwgcmV0dXJuIGEgZnVuY3Rpb24gdGhhdAogICAgc2V0cyB0aGUgdmFsdWUgcGFzc2VkIHRvIGBtdXRgIHRvIGl0cyBmaXJzdCBhcmd1bWVudC4gQXMgYW4gZXhhbXBsZSwgd2UgY2FuIGNyZWF0ZSBhCiAgICBidXR0b24gdGhhdCBpbmNyZW1lbnRzIGEgdmFsdWUgcGFzc2luZyB0aGUgdmFsdWUgZGlyZWN0bHkgdG8gdGhlIGBmbmA6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7eyEgaW5jIGhlbHBlciBpcyBub3QgcHJvdmlkZWQgYnkgRW1iZXIgfX0KICAgIDxidXR0b24gb25jbGljaz17e2ZuIChtdXQgY291bnQpIChpbmMgY291bnQpfX0+CiAgICAgIEluY3JlbWVudCBjb3VudAogICAgPC9idXR0b24+CiAgICBgYGAKICAKICAgIFlvdSBjYW4gYWxzbyB1c2UgdGhlIGB2YWx1ZWAgb3B0aW9uOgogIAogICAgYGBgaGFuZGxlYmFycwogICAgPGlucHV0IHZhbHVlPXt7bmFtZX19IG9uaW5wdXQ9e3tmbiAobXV0IG5hbWUpIHZhbHVlPSJ0YXJnZXQudmFsdWUifX0+CiAgICBgYGAKICAKICAgIEBtZXRob2QgbXV0CiAgICBAcGFyYW0ge09iamVjdH0gW2F0dHJdIHRoZSAidHdvLXdheSIgYXR0cmlidXRlIHRoYXQgY2FuIGJlIG1vZGlmaWVkLgogICAgQGZvciBFbWJlci5UZW1wbGF0ZXMuaGVscGVycwogICAgQHB1YmxpYwogICovCgoKICB2YXIgTVVUX1JFRkVSRU5DRSA9ICgwLCBfdXRpbHMuc3ltYm9sKSgnTVVUJyk7CiAgdmFyIFNPVVJDRSA9ICgwLCBfdXRpbHMuc3ltYm9sKSgnU09VUkNFJyk7CgogIGZ1bmN0aW9uIGlzTXV0KHJlZikgewogICAgcmV0dXJuIHJlZiAmJiByZWZbTVVUX1JFRkVSRU5DRV07CiAgfQoKICBmdW5jdGlvbiB1bk11dChyZWYpIHsKICAgIHJldHVybiByZWZbU09VUkNFXSB8fCByZWY7CiAgfQoKICBmdW5jdGlvbiBtdXQoX3ZtLCBhcmdzKSB7CiAgICB2YXIgcmF3UmVmID0gYXJncy5wb3NpdGlvbmFsLmF0KDApOwoKICAgIGlmIChpc011dChyYXdSZWYpKSB7CiAgICAgIHJldHVybiByYXdSZWY7CiAgICB9IC8vIFRPRE86IEltcHJvdmUgdGhpcyBlcnJvciBtZXNzYWdlLiBUaGlzIGNvdmVycyBhdCBsZWFzdCB0d28gZGlzdGluY3QKICAgIC8vIGNhc2VzOgogICAgLy8KICAgIC8vIDEuIChtdXQgIm5vdCBhIHBhdGgiKSDigJMgcGFzc2luZyBhIGxpdGVyYWwsIHJlc3VsdCBmcm9tIGEgaGVscGVyCiAgICAvLyAgICBpbnZvY2F0aW9uLCBldGMKICAgIC8vCiAgICAvLyAyLiAobXV0IHJlY2VpdmVkVmFsdWUpIOKAkyBwYXNzaW5nIGEgdmFsdWUgcmVjZWl2ZWQgZnJvbSB0aGUgY2FsbGVyCiAgICAvLyAgICB0aGF0IHdhcyBvcmlnaW5hbGx5IGRlcml2ZWQgZnJvbSBhIGxpdGVyYWwsIHJlc3VsdCBmcm9tIGEgaGVscGVyCiAgICAvLyAgICBpbnZvY2F0aW9uLCBldGMKICAgIC8vCiAgICAvLyBUaGlzIG1lc3NhZ2UgaXMgYWxyaWdodCBmb3IgdGhlIGZpcnN0IGNhc2UsIGJ1dCBjb3VsZCBiZSBxdWl0ZQogICAgLy8gY29uZnVzaW5nIGZvciB0aGUgc2Vjb25kIGNhc2UuCgoKICAgIChmYWxzZSAmJiAhKHJhd1JlZltVUERBVEVdKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW4gb25seSBwYXNzIGEgcGF0aCB0byBtdXQnLCByYXdSZWZbVVBEQVRFXSkpOwogICAgdmFyIHdyYXBwZWRSZWYgPSBPYmplY3QuY3JlYXRlKHJhd1JlZik7CiAgICB3cmFwcGVkUmVmW1NPVVJDRV0gPSByYXdSZWY7CiAgICB3cmFwcGVkUmVmW0lOVk9LRV0gPSByYXdSZWZbVVBEQVRFXTsKICAgIHdyYXBwZWRSZWZbTVVUX1JFRkVSRU5DRV0gPSB0cnVlOwogICAgcmV0dXJuIHdyYXBwZWRSZWY7CiAgfQogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwoKICAvKioKICAgIFRoaXMgaXMgYSBoZWxwZXIgdG8gYmUgdXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIHRoZSBsaW5rLXRvIGhlbHBlci4KICAgIEl0IHdpbGwgc3VwcGx5IHVybCBxdWVyeSBwYXJhbWV0ZXJzIHRvIHRoZSB0YXJnZXQgcm91dGUuCiAgCiAgICBAZXhhbXBsZSBJbiB0aGlzIGV4YW1wbGUgd2UgYXJlIHNldHRpbmcgdGhlIGBkaXJlY3Rpb25gIHF1ZXJ5IHBhcmFtIHRvIHRoZSB2YWx1ZSBgImFzYyJgCiAgCiAgICBgYGBhcHAvdGVtcGxhdGVzL2FwcGxpY2F0aW9uLmhicwogICAgPExpbmtUbwogICAgICBAcm91dGU9InBvc3RzIgogICAgICB7e3F1ZXJ5LXBhcmFtcyBkaXJlY3Rpb249ImFzYyJ9fQogICAgPgogICAgICBTb3J0CiAgICA8L0xpbmtUbz4KICAgIGBgYAogIAogICAgQG1ldGhvZCBxdWVyeS1wYXJhbXMKICAgIEBmb3IgRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMKICAgIEBwYXJhbSB7T2JqZWN0fSBoYXNoIHRha2VzIGEgaGFzaCBvZiBxdWVyeSBwYXJhbWV0ZXJzCiAgICBAcmV0dXJuIHtPYmplY3R9IEEgYFF1ZXJ5UGFyYW1zYCBvYmplY3QgZm9yIGB7e2xpbmstdG99fWAKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gcXVlcnlQYXJhbXMoX3JlZjMxKSB7CiAgICB2YXIgcG9zaXRpb25hbCA9IF9yZWYzMS5wb3NpdGlvbmFsLAogICAgICAgIG5hbWVkID0gX3JlZjMxLm5hbWVkOwogICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aAogICAgKGZhbHNlICYmICEocG9zaXRpb25hbC52YWx1ZSgpLmxlbmd0aCA9PT0gMCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJUaGUgYHF1ZXJ5LXBhcmFtc2AgaGVscGVyIG9ubHkgYWNjZXB0cyBoYXNoIHBhcmFtZXRlcnMsIGUuZy4gKHF1ZXJ5LXBhcmFtcyBxdWVyeVBhcmFtUHJvcGVydHlOYW1lPSdmb28nKSBhcyBvcHBvc2VkIHRvIGp1c3QgKHF1ZXJ5LXBhcmFtcyAnZm9vJykiLCBwb3NpdGlvbmFsLnZhbHVlKCkubGVuZ3RoID09PSAwKSk7CiAgICByZXR1cm4gbmV3IF9yb3V0aW5nLlF1ZXJ5UGFyYW1zKCgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIG5hbWVkLnZhbHVlKCkpKTsKICB9CgogIGZ1bmN0aW9uIHF1ZXJ5UGFyYW1zJDEoX3ZtLCBhcmdzKSB7CiAgICByZXR1cm4gbmV3IEludGVybmFsSGVscGVyUmVmZXJlbmNlKHF1ZXJ5UGFyYW1zLCBhcmdzLmNhcHR1cmUoKSk7CiAgfQogIC8qKgogICAgVGhlIGByZWFkb25seWAgaGVscGVyIGxldCdzIHlvdSBzcGVjaWZ5IHRoYXQgYSBiaW5kaW5nIGlzIG9uZS13YXkgb25seSwKICAgIGluc3RlYWQgb2YgdHdvLXdheS4KICAgIFdoZW4geW91IHBhc3MgYSBgcmVhZG9ubHlgIGJpbmRpbmcgZnJvbSBhbiBvdXRlciBjb250ZXh0IChlLmcuIHBhcmVudCBjb21wb25lbnQpLAogICAgdG8gdG8gYW4gaW5uZXIgY29udGV4dCAoZS5nLiBjaGlsZCBjb21wb25lbnQpLCB5b3UgYXJlIHNheWluZyB0aGF0IGNoYW5naW5nIHRoYXQKICAgIHByb3BlcnR5IGluIHRoZSBpbm5lciBjb250ZXh0IGRvZXMgbm90IGNoYW5nZSB0aGUgdmFsdWUgaW4gdGhlIG91dGVyIGNvbnRleHQuCiAgCiAgICBUbyBzcGVjaWZ5IHRoYXQgYSBiaW5kaW5nIGlzIHJlYWQtb25seSwgd2hlbiBpbnZva2luZyB0aGUgY2hpbGQgYENvbXBvbmVudGA6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9teS1wYXJlbnQuanMKICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICB0b3RhbENsaWNrczogMwogICAgfSk7CiAgICBgYGAKICAKICAgIGBgYGFwcC90ZW1wbGF0ZXMvY29tcG9uZW50cy9teS1wYXJlbnQuaGJzCiAgICB7e2xvZyB0b3RhbENsaWNrc319IC8vIC0+IDMKICAgIDxNeUNoaWxkIEBjaGlsZENsaWNrQ291bnQ9e3tyZWFkb25seSB0b3RhbENsaWNrc319IC8+CiAgICBgYGAKICAgIGBgYAogICAge3tteS1jaGlsZCBjaGlsZENsaWNrQ291bnQ9KHJlYWRvbmx5IHRvdGFsQ2xpY2tzKX19CiAgICBgYGAKICAKICAgIE5vdywgd2hlbiB5b3UgdXBkYXRlIGBjaGlsZENsaWNrQ291bnRgOgogIAogICAgYGBgYXBwL2NvbXBvbmVudHMvbXktY2hpbGQuanMKICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICBjbGljaygpIHsKICAgICAgICB0aGlzLmluY3JlbWVudFByb3BlcnR5KCdjaGlsZENsaWNrQ291bnQnKTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIFRoZSB2YWx1ZSB1cGRhdGVzIGluIHRoZSBjaGlsZCBjb21wb25lbnQsIGJ1dCBub3QgdGhlIHBhcmVudCBjb21wb25lbnQ6CiAgCiAgICBgYGBhcHAvdGVtcGxhdGVzL2NvbXBvbmVudHMvbXktY2hpbGQuaGJzCiAgICB7e2xvZyBjaGlsZENsaWNrQ291bnR9fSAvLy0+IDQKICAgIGBgYAogIAogICAgYGBgYXBwL3RlbXBsYXRlcy9jb21wb25lbnRzL215LXBhcmVudC5oYnMKICAgIHt7bG9nIHRvdGFsQ2xpY2tzfX0gLy8tPiAzCiAgICA8TXlDaGlsZCBAY2hpbGRDbGlja0NvdW50PXt7cmVhZG9ubHkgdG90YWxDbGlja3N9fSAvPgogICAgYGBgCiAgICBvcgogICAgYGBgYXBwL3RlbXBsYXRlcy9jb21wb25lbnRzL215LXBhcmVudC5oYnMKICAgIHt7bG9nIHRvdGFsQ2xpY2tzfX0gLy8tPiAzCiAgICB7e215LWNoaWxkIGNoaWxkQ2xpY2tDb3VudD0ocmVhZG9ubHkgdG90YWxDbGlja3MpfX0KICAgIGBgYAogIAogICAgIyMjIE9iamVjdHMgYW5kIEFycmF5cwogIAogICAgV2hlbiBwYXNzaW5nIGEgcHJvcGVydHkgdGhhdCBpcyBhIGNvbXBsZXggb2JqZWN0IChlLmcuIG9iamVjdCwgYXJyYXkpIGluc3RlYWQgb2YgYSBwcmltaXRpdmUgb2JqZWN0IChlLmcuIG51bWJlciwgc3RyaW5nKSwKICAgIG9ubHkgdGhlIHJlZmVyZW5jZSB0byB0aGUgb2JqZWN0IGlzIHByb3RlY3RlZCB1c2luZyB0aGUgcmVhZG9ubHkgaGVscGVyLgogICAgVGhpcyBtZWFucyB0aGF0IHlvdSBjYW4gY2hhbmdlIHByb3BlcnRpZXMgb2YgdGhlIG9iamVjdCBib3RoIG9uIHRoZSBwYXJlbnQgY29tcG9uZW50LCBhcyB3ZWxsIGFzIHRoZSBjaGlsZCBjb21wb25lbnQuCiAgICBUaGUgYHJlYWRvbmx5YCBiaW5kaW5nIGJlaGF2ZXMgc2ltaWxhciB0byB0aGUgYGNvbnN0YCBrZXl3b3JkIGluIEphdmFTY3JpcHQuCiAgCiAgICBMZXQncyBsb29rIGF0IGFuIGV4YW1wbGU6CiAgCiAgICBGaXJzdCBsZXQncyBzZXQgdXAgdGhlIHBhcmVudCBjb21wb25lbnQ6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9teS1wYXJlbnQuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgY2xpY2tzOiBudWxsLAogIAogICAgICBpbml0KCkgewogICAgICAgIHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CiAgICAgICAgdGhpcy5zZXQoJ2NsaWNrcycsIHsgdG90YWw6IDMgfSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBgYGBhcHAvdGVtcGxhdGVzL2NvbXBvbmVudHMvbXktcGFyZW50LmhicwogICAge3tsb2cgY2xpY2tzLnRvdGFsfX0gLy8tPiAzCiAgICA8TXlDaGlsZCBAY2hpbGRDbGlja3M9e3tyZWFkb25seSBjbGlja3N9fSAvPgogICAgYGBgCiAgICBgYGBhcHAvdGVtcGxhdGVzL2NvbXBvbmVudHMvbXktcGFyZW50LmhicwogICAge3tsb2cgY2xpY2tzLnRvdGFsfX0gLy8tPiAzCiAgICB7e215LWNoaWxkIGNoaWxkQ2xpY2tzPShyZWFkb25seSBjbGlja3MpfX0KICAgIGBgYAogIAogICAgTm93LCBpZiB5b3UgdXBkYXRlIHRoZSBgdG90YWxgIHByb3BlcnR5IG9mIGBjaGlsZENsaWNrc2A6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9teS1jaGlsZC5qcwogICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICBjbGljaygpIHsKICAgICAgICB0aGlzLmdldCgnY2xpY2tzJykuaW5jcmVtZW50UHJvcGVydHkoJ3RvdGFsJyk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBZb3Ugd2lsbCBzZWUgdGhlIGZvbGxvd2luZyBoYXBwZW46CiAgCiAgICBgYGBhcHAvdGVtcGxhdGVzL2NvbXBvbmVudHMvbXktcGFyZW50LmhicwogICAge3tsb2cgY2xpY2tzLnRvdGFsfX0gLy8tPiA0CiAgICA8TXlDaGlsZCBAY2hpbGRDbGlja3M9e3tyZWFkb25seSBjbGlja3N9fSAvPgogICAgYGBgCiAgICBvcgogICAgYGBgYXBwL3RlbXBsYXRlcy9jb21wb25lbnRzL215LXBhcmVudC5oYnMKICAgIHt7bG9nIGNsaWNrcy50b3RhbH19IC8vLT4gNAogICAge3tteS1jaGlsZCBjaGlsZENsaWNrcz0ocmVhZG9ubHkgY2xpY2tzKX19CiAgICBgYGAKICAKICAgIGBgYGFwcC90ZW1wbGF0ZXMvY29tcG9uZW50cy9teS1jaGlsZC5oYnMKICAgIHt7bG9nIGNoaWxkQ2xpY2tzLnRvdGFsfX0gLy8tPiA0CiAgICBgYGAKICAKICAgIEBtZXRob2QgcmVhZG9ubHkKICAgIEBwYXJhbSB7T2JqZWN0fSBbYXR0cl0gdGhlIHJlYWQtb25seSBhdHRyaWJ1dGUuCiAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICBAcHJpdmF0ZQogICovCgoKICBmdW5jdGlvbiByZWFkb25seShfdm0sIGFyZ3MpIHsKICAgIHZhciByZWYgPSB1bk11dChhcmdzLnBvc2l0aW9uYWwuYXQoMCkpOwogICAgcmV0dXJuIG5ldyBSZWFkb25seVJlZmVyZW5jZShyZWYpOwogIH0KICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICBUaGUgYHt7dW5ib3VuZH19YCBoZWxwZXIgZGlzY29ubmVjdHMgdGhlIG9uZS13YXkgYmluZGluZyBvZiBhIHByb3BlcnR5LAogICAgZXNzZW50aWFsbHkgZnJlZXppbmcgaXRzIHZhbHVlIGF0IHRoZSBtb21lbnQgb2YgcmVuZGVyaW5nLiBGb3IgZXhhbXBsZSwKICAgIGluIHRoaXMgZXhhbXBsZSB0aGUgZGlzcGxheSBvZiB0aGUgdmFyaWFibGUgYG5hbWVgIHdpbGwgbm90IGNoYW5nZSBldmVuCiAgICBpZiBpdCBpcyBzZXQgd2l0aCBhIG5ldyB2YWx1ZToKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIHt7dW5ib3VuZCBuYW1lfX0KICAgIGBgYAogIAogICAgTGlrZSBhbnkgaGVscGVyLCB0aGUgYHVuYm91bmRgIGhlbHBlciBjYW4gYWNjZXB0IGEgbmVzdGVkIGhlbHBlciBleHByZXNzaW9uLgogICAgVGhpcyBhbGxvd3MgZm9yIGN1c3RvbSBoZWxwZXJzIHRvIGJlIHJlbmRlcmVkIHVuYm91bmQ6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7e3VuYm91bmQgKHNvbWUtY3VzdG9tLWhlbHBlcil9fQogICAge3t1bmJvdW5kIChjYXBpdGFsaXplIG5hbWUpfX0KICAgIHt7ISBZb3UgY2FuIHVzZSBhbnkgaGVscGVyLCBpbmNsdWRpbmcgdW5ib3VuZCwgaW4gYSBuZXN0ZWQgZXhwcmVzc2lvbiB9fQogICAge3tjYXBpdGFsaXplICh1bmJvdW5kIG5hbWUpfX0KICAgIGBgYAogIAogICAgVGhlIGB1bmJvdW5kYCBoZWxwZXIgb25seSBhY2NlcHRzIGEgc2luZ2xlIGFyZ3VtZW50LCBhbmQgaXQgcmV0dXJuIGFuCiAgICB1bmJvdW5kIHZhbHVlLgogIAogICAgQG1ldGhvZCB1bmJvdW5kCiAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIHVuYm91bmQoX3ZtLCBhcmdzKSB7CiAgICAoZmFsc2UgJiYgIShhcmdzLnBvc2l0aW9uYWwubGVuZ3RoID09PSAxICYmIGFyZ3MubmFtZWQubGVuZ3RoID09PSAwKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ3VuYm91bmQgaGVscGVyIGNhbm5vdCBiZSBjYWxsZWQgd2l0aCBtdWx0aXBsZSBwYXJhbXMgb3IgaGFzaCBwYXJhbXMnLCBhcmdzLnBvc2l0aW9uYWwubGVuZ3RoID09PSAxICYmIGFyZ3MubmFtZWQubGVuZ3RoID09PSAwKSk7CiAgICByZXR1cm4gVW5ib3VuZFJlZmVyZW5jZS5jcmVhdGUoYXJncy5wb3NpdGlvbmFsLmF0KDApLnZhbHVlKCkpOwogIH0KCiAgdmFyIE1PRElGSUVSUyA9IFsnYWx0JywgJ3NoaWZ0JywgJ21ldGEnLCAnY3RybCddOwogIHZhciBQT0lOVEVSX0VWRU5UX1RZUEVfUkVHRVggPSAvXmNsaWNrfG1vdXNlfHRvdWNoLzsKCiAgZnVuY3Rpb24gaXNBbGxvd2VkRXZlbnQoZXZlbnQsIGFsbG93ZWRLZXlzKSB7CiAgICBpZiAoYWxsb3dlZEtleXMgPT09IG51bGwgfHwgYWxsb3dlZEtleXMgPT09IHVuZGVmaW5lZCkgewogICAgICBpZiAoUE9JTlRFUl9FVkVOVF9UWVBFX1JFR0VYLnRlc3QoZXZlbnQudHlwZSkpIHsKICAgICAgICByZXR1cm4gKDAsIF92aWV3cy5pc1NpbXBsZUNsaWNrKShldmVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYWxsb3dlZEtleXMgPSAnJzsKICAgICAgfQogICAgfQoKICAgIGlmIChhbGxvd2VkS2V5cy5pbmRleE9mKCdhbnknKSA+PSAwKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgTU9ESUZJRVJTLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChldmVudFtNT0RJRklFUlNbaV0gKyAnS2V5J10gJiYgYWxsb3dlZEtleXMuaW5kZXhPZihNT0RJRklFUlNbaV0pID09PSAtMSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0cnVlOwogIH0KCiAgdmFyIEFjdGlvbkhlbHBlciA9IHsKICAgIC8vIHJlZ2lzdGVyZWRBY3Rpb25zIGlzIHJlLWV4cG9ydGVkIGZvciBjb21wYXRpYmlsaXR5IHdpdGggb2xkZXIgcGx1Z2lucwogICAgLy8gdGhhdCB3ZXJlIHVzaW5nIHRoaXMgdW5kb2N1bWVudGVkIEFQSS4KICAgIHJlZ2lzdGVyZWRBY3Rpb25zOiBfdmlld3MuQWN0aW9uTWFuYWdlci5yZWdpc3RlcmVkQWN0aW9ucywKICAgIHJlZ2lzdGVyQWN0aW9uOiBmdW5jdGlvbiByZWdpc3RlckFjdGlvbihhY3Rpb25TdGF0ZSkgewogICAgICB2YXIgYWN0aW9uSWQgPSBhY3Rpb25TdGF0ZS5hY3Rpb25JZDsKICAgICAgX3ZpZXdzLkFjdGlvbk1hbmFnZXIucmVnaXN0ZXJlZEFjdGlvbnNbYWN0aW9uSWRdID0gYWN0aW9uU3RhdGU7CiAgICAgIHJldHVybiBhY3Rpb25JZDsKICAgIH0sCiAgICB1bnJlZ2lzdGVyQWN0aW9uOiBmdW5jdGlvbiB1bnJlZ2lzdGVyQWN0aW9uKGFjdGlvblN0YXRlKSB7CiAgICAgIHZhciBhY3Rpb25JZCA9IGFjdGlvblN0YXRlLmFjdGlvbklkOwogICAgICBkZWxldGUgX3ZpZXdzLkFjdGlvbk1hbmFnZXIucmVnaXN0ZXJlZEFjdGlvbnNbYWN0aW9uSWRdOwogICAgfQogIH07CgogIHZhciBBY3Rpb25TdGF0ZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEFjdGlvblN0YXRlKGVsZW1lbnQsIGFjdGlvbklkLCBhY3Rpb25OYW1lLCBhY3Rpb25BcmdzLCBuYW1lZEFyZ3MsIHBvc2l0aW9uYWxBcmdzLCBpbXBsaWNpdFRhcmdldCwgZG9tLCB0YWcpIHsKICAgICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKICAgICAgdGhpcy5hY3Rpb25JZCA9IGFjdGlvbklkOwogICAgICB0aGlzLmFjdGlvbk5hbWUgPSBhY3Rpb25OYW1lOwogICAgICB0aGlzLmFjdGlvbkFyZ3MgPSBhY3Rpb25BcmdzOwogICAgICB0aGlzLm5hbWVkQXJncyA9IG5hbWVkQXJnczsKICAgICAgdGhpcy5wb3NpdGlvbmFsID0gcG9zaXRpb25hbEFyZ3M7CiAgICAgIHRoaXMuaW1wbGljaXRUYXJnZXQgPSBpbXBsaWNpdFRhcmdldDsKICAgICAgdGhpcy5kb20gPSBkb207CiAgICAgIHRoaXMuZXZlbnROYW1lID0gdGhpcy5nZXRFdmVudE5hbWUoKTsKICAgICAgdGhpcy50YWcgPSB0YWc7CiAgICB9CgogICAgdmFyIF9wcm90bzU3ID0gQWN0aW9uU3RhdGUucHJvdG90eXBlOwoKICAgIF9wcm90bzU3LmdldEV2ZW50TmFtZSA9IGZ1bmN0aW9uIGdldEV2ZW50TmFtZSgpIHsKICAgICAgcmV0dXJuIHRoaXMubmFtZWRBcmdzLmdldCgnb24nKS52YWx1ZSgpIHx8ICdjbGljayc7CiAgICB9OwoKICAgIF9wcm90bzU3LmdldEFjdGlvbkFyZ3MgPSBmdW5jdGlvbiBnZXRBY3Rpb25BcmdzKCkgewogICAgICB2YXIgcmVzdWx0ID0gbmV3IEFycmF5KHRoaXMuYWN0aW9uQXJncy5sZW5ndGgpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmFjdGlvbkFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICByZXN1bHRbaV0gPSB0aGlzLmFjdGlvbkFyZ3NbaV0udmFsdWUoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CgogICAgX3Byb3RvNTcuZ2V0VGFyZ2V0ID0gZnVuY3Rpb24gZ2V0VGFyZ2V0KCkgewogICAgICB2YXIgaW1wbGljaXRUYXJnZXQgPSB0aGlzLmltcGxpY2l0VGFyZ2V0LAogICAgICAgICAgbmFtZWRBcmdzID0gdGhpcy5uYW1lZEFyZ3M7CiAgICAgIHZhciB0YXJnZXQ7CgogICAgICBpZiAobmFtZWRBcmdzLmhhcygndGFyZ2V0JykpIHsKICAgICAgICB0YXJnZXQgPSBuYW1lZEFyZ3MuZ2V0KCd0YXJnZXQnKS52YWx1ZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIHRhcmdldCA9IGltcGxpY2l0VGFyZ2V0LnZhbHVlKCk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9OwoKICAgIF9wcm90bzU3LmhhbmRsZXIgPSBmdW5jdGlvbiBoYW5kbGVyKGV2ZW50KSB7CiAgICAgIHZhciBfdGhpczI1ID0gdGhpczsKCiAgICAgIHZhciBhY3Rpb25OYW1lID0gdGhpcy5hY3Rpb25OYW1lLAogICAgICAgICAgbmFtZWRBcmdzID0gdGhpcy5uYW1lZEFyZ3M7CiAgICAgIHZhciBidWJibGVzID0gbmFtZWRBcmdzLmdldCgnYnViYmxlcycpOwogICAgICB2YXIgcHJldmVudERlZmF1bHQgPSBuYW1lZEFyZ3MuZ2V0KCdwcmV2ZW50RGVmYXVsdCcpOwogICAgICB2YXIgYWxsb3dlZEtleXMgPSBuYW1lZEFyZ3MuZ2V0KCdhbGxvd2VkS2V5cycpOwogICAgICB2YXIgdGFyZ2V0ID0gdGhpcy5nZXRUYXJnZXQoKTsKICAgICAgdmFyIHNob3VsZEJ1YmJsZSA9IGJ1YmJsZXMudmFsdWUoKSAhPT0gZmFsc2U7CgogICAgICBpZiAoIWlzQWxsb3dlZEV2ZW50KGV2ZW50LCBhbGxvd2VkS2V5cy52YWx1ZSgpKSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICBpZiAocHJldmVudERlZmF1bHQudmFsdWUoKSAhPT0gZmFsc2UpIHsKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CgogICAgICBpZiAoIXNob3VsZEJ1YmJsZSkgewogICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICB9CgogICAgICAoMCwgX3J1bmxvb3Auam9pbikoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBhcmdzID0gX3RoaXMyNS5nZXRBY3Rpb25BcmdzKCk7CgogICAgICAgIHZhciBwYXlsb2FkID0gewogICAgICAgICAgYXJnczogYXJncywKICAgICAgICAgIHRhcmdldDogdGFyZ2V0LAogICAgICAgICAgbmFtZTogbnVsbAogICAgICAgIH07CgogICAgICAgIGlmICh0eXBlb2YgYWN0aW9uTmFtZVtJTlZPS0VdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAoMCwgX2luc3RydW1lbnRhdGlvbi5mbGFnZ2VkSW5zdHJ1bWVudCkoJ2ludGVyYWN0aW9uLmVtYmVyLWFjdGlvbicsIHBheWxvYWQsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgYWN0aW9uTmFtZVtJTlZPS0VdLmFwcGx5KGFjdGlvbk5hbWUsIGFyZ3MpOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIGFjdGlvbk5hbWUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICgwLCBfaW5zdHJ1bWVudGF0aW9uLmZsYWdnZWRJbnN0cnVtZW50KSgnaW50ZXJhY3Rpb24uZW1iZXItYWN0aW9uJywgcGF5bG9hZCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBhY3Rpb25OYW1lLmFwcGx5KHRhcmdldCwgYXJncyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHBheWxvYWQubmFtZSA9IGFjdGlvbk5hbWU7CgogICAgICAgIGlmICh0YXJnZXQuc2VuZCkgewogICAgICAgICAgKDAsIF9pbnN0cnVtZW50YXRpb24uZmxhZ2dlZEluc3RydW1lbnQpKCdpbnRlcmFjdGlvbi5lbWJlci1hY3Rpb24nLCBwYXlsb2FkLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRhcmdldC5zZW5kLmFwcGx5KHRhcmdldCwgW2FjdGlvbk5hbWVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgKGZhbHNlICYmICEodHlwZW9mIHRhcmdldFthY3Rpb25OYW1lXSA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJUaGUgYWN0aW9uICciICsgYWN0aW9uTmFtZSArICInIGRpZCBub3QgZXhpc3Qgb24gIiArIHRhcmdldCwgdHlwZW9mIHRhcmdldFthY3Rpb25OYW1lXSA9PT0gJ2Z1bmN0aW9uJykpOwogICAgICAgICAgKDAsIF9pbnN0cnVtZW50YXRpb24uZmxhZ2dlZEluc3RydW1lbnQpKCdpbnRlcmFjdGlvbi5lbWJlci1hY3Rpb24nLCBwYXlsb2FkLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRhcmdldFthY3Rpb25OYW1lXS5hcHBseSh0YXJnZXQsIGFyZ3MpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHNob3VsZEJ1YmJsZTsKICAgIH07CgogICAgX3Byb3RvNTcuZGVzdHJveSA9IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgIEFjdGlvbkhlbHBlci51bnJlZ2lzdGVyQWN0aW9uKHRoaXMpOwogICAgfTsKCiAgICByZXR1cm4gQWN0aW9uU3RhdGU7CiAgfSgpOyAvLyBpbXBsZW1lbnRzIE1vZGlmaWVyTWFuYWdlcjxBY3Rpb24+CgoKICB2YXIgQWN0aW9uTW9kaWZpZXJNYW5hZ2VyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQWN0aW9uTW9kaWZpZXJNYW5hZ2VyKCkge30KCiAgICB2YXIgX3Byb3RvNTggPSBBY3Rpb25Nb2RpZmllck1hbmFnZXIucHJvdG90eXBlOwoKICAgIF9wcm90bzU4LmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShlbGVtZW50LCBfc3RhdGUsIGFyZ3MsIF9keW5hbWljU2NvcGUsIGRvbSkgewogICAgICB2YXIgX2FyZ3MkY2FwdHVyZSA9IGFyZ3MuY2FwdHVyZSgpLAogICAgICAgICAgbmFtZWQgPSBfYXJncyRjYXB0dXJlLm5hbWVkLAogICAgICAgICAgcG9zaXRpb25hbCA9IF9hcmdzJGNhcHR1cmUucG9zaXRpb25hbCwKICAgICAgICAgIHRhZyA9IF9hcmdzJGNhcHR1cmUudGFnOwoKICAgICAgdmFyIGltcGxpY2l0VGFyZ2V0OwogICAgICB2YXIgYWN0aW9uTmFtZTsKICAgICAgdmFyIGFjdGlvbk5hbWVSZWY7CgogICAgICBpZiAocG9zaXRpb25hbC5sZW5ndGggPiAxKSB7CiAgICAgICAgaW1wbGljaXRUYXJnZXQgPSBwb3NpdGlvbmFsLmF0KDApOwogICAgICAgIGFjdGlvbk5hbWVSZWYgPSBwb3NpdGlvbmFsLmF0KDEpOwoKICAgICAgICBpZiAoYWN0aW9uTmFtZVJlZltJTlZPS0VdKSB7CiAgICAgICAgICBhY3Rpb25OYW1lID0gYWN0aW9uTmFtZVJlZjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGFjdGlvbkxhYmVsID0gYWN0aW9uTmFtZVJlZi5wcm9wZXJ0eUtleTsKICAgICAgICAgIGFjdGlvbk5hbWUgPSBhY3Rpb25OYW1lUmVmLnZhbHVlKCk7CiAgICAgICAgICAoZmFsc2UgJiYgISh0eXBlb2YgYWN0aW9uTmFtZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIGFjdGlvbk5hbWUgPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IHNwZWNpZmllZCBhIHF1b3RlbGVzcyBwYXRoLCBgJyArIGFjdGlvbkxhYmVsICsgJ2AsIHRvIHRoZSAnICsgJ3t7YWN0aW9ufX0gaGVscGVyIHdoaWNoIGRpZCBub3QgcmVzb2x2ZSB0byBhbiBhY3Rpb24gbmFtZSAoYSAnICsgJ3N0cmluZykuIFBlcmhhcHMgeW91IG1lYW50IHRvIHVzZSBhIHF1b3RlZCBhY3Rpb25OYW1lPyAoZS5nLiAnICsgJ3t7YWN0aW9uICInICsgYWN0aW9uTGFiZWwgKyAnIn19KS4nLCB0eXBlb2YgYWN0aW9uTmFtZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIGFjdGlvbk5hbWUgPT09ICdmdW5jdGlvbicpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBhY3Rpb25BcmdzID0gW107IC8vIFRoZSBmaXJzdCB0d28gYXJndW1lbnRzIGFyZSAoMSkgYHRoaXNgIGFuZCAoMikgdGhlIGFjdGlvbiBuYW1lLgogICAgICAvLyBFdmVyeXRoaW5nIGVsc2UgaXMgYSBwYXJhbS4KCiAgICAgIGZvciAodmFyIGkgPSAyOyBpIDwgcG9zaXRpb25hbC5sZW5ndGg7IGkrKykgewogICAgICAgIGFjdGlvbkFyZ3MucHVzaChwb3NpdGlvbmFsLmF0KGkpKTsKICAgICAgfQoKICAgICAgdmFyIGFjdGlvbklkID0gKDAsIF91dGlscy51dWlkKSgpOwogICAgICB2YXIgYWN0aW9uU3RhdGUgPSBuZXcgQWN0aW9uU3RhdGUoZWxlbWVudCwgYWN0aW9uSWQsIGFjdGlvbk5hbWUsIGFjdGlvbkFyZ3MsIG5hbWVkLCBwb3NpdGlvbmFsLCBpbXBsaWNpdFRhcmdldCwgZG9tLCB0YWcpOwogICAgICAoZmFsc2UgJiYgIShhY3Rpb25TdGF0ZS5ldmVudE5hbWUgIT09ICdtb3VzZUVudGVyJyAmJiBhY3Rpb25TdGF0ZS5ldmVudE5hbWUgIT09ICdtb3VzZUxlYXZlJyAmJiBhY3Rpb25TdGF0ZS5ldmVudE5hbWUgIT09ICdtb3VzZU1vdmUnKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoIlVzaW5nIHRoZSBge3thY3Rpb259fWAgbW9kaWZpZXIgd2l0aCBgIiArIGFjdGlvblN0YXRlLmV2ZW50TmFtZSArICJgIGV2ZW50cyBoYXMgYmVlbiBkZXByZWNhdGVkLiIsIGFjdGlvblN0YXRlLmV2ZW50TmFtZSAhPT0gJ21vdXNlRW50ZXInICYmIGFjdGlvblN0YXRlLmV2ZW50TmFtZSAhPT0gJ21vdXNlTGVhdmUnICYmIGFjdGlvblN0YXRlLmV2ZW50TmFtZSAhPT0gJ21vdXNlTW92ZScsIHsKICAgICAgICBpZDogJ2VtYmVyLXZpZXdzLmV2ZW50LWRpc3BhdGNoZXIubW91c2VlbnRlci1sZWF2ZS1tb3ZlJywKICAgICAgICB1bnRpbDogJzQuMC4wJywKICAgICAgICB1cmw6ICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92My54I3RvY19hY3Rpb24tbW91c2VlbnRlci1sZWF2ZS1tb3ZlJwogICAgICB9KSk7CiAgICAgIHJldHVybiBhY3Rpb25TdGF0ZTsKICAgIH07CgogICAgX3Byb3RvNTguaW5zdGFsbCA9IGZ1bmN0aW9uIGluc3RhbGwoYWN0aW9uU3RhdGUpIHsKICAgICAgdmFyIGRvbSA9IGFjdGlvblN0YXRlLmRvbSwKICAgICAgICAgIGVsZW1lbnQgPSBhY3Rpb25TdGF0ZS5lbGVtZW50LAogICAgICAgICAgYWN0aW9uSWQgPSBhY3Rpb25TdGF0ZS5hY3Rpb25JZDsKICAgICAgQWN0aW9uSGVscGVyLnJlZ2lzdGVyQWN0aW9uKGFjdGlvblN0YXRlKTsKICAgICAgZG9tLnNldEF0dHJpYnV0ZShlbGVtZW50LCAnZGF0YS1lbWJlci1hY3Rpb24nLCAnJyk7CiAgICAgIGRvbS5zZXRBdHRyaWJ1dGUoZWxlbWVudCwgImRhdGEtZW1iZXItYWN0aW9uLSIgKyBhY3Rpb25JZCwgYWN0aW9uSWQpOwogICAgfTsKCiAgICBfcHJvdG81OC51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUoYWN0aW9uU3RhdGUpIHsKICAgICAgdmFyIHBvc2l0aW9uYWwgPSBhY3Rpb25TdGF0ZS5wb3NpdGlvbmFsOwogICAgICB2YXIgYWN0aW9uTmFtZVJlZiA9IHBvc2l0aW9uYWwuYXQoMSk7CgogICAgICBpZiAoIWFjdGlvbk5hbWVSZWZbSU5WT0tFXSkgewogICAgICAgIGFjdGlvblN0YXRlLmFjdGlvbk5hbWUgPSBhY3Rpb25OYW1lUmVmLnZhbHVlKCk7CiAgICAgIH0KCiAgICAgIGFjdGlvblN0YXRlLmV2ZW50TmFtZSA9IGFjdGlvblN0YXRlLmdldEV2ZW50TmFtZSgpOwogICAgfTsKCiAgICBfcHJvdG81OC5nZXRUYWcgPSBmdW5jdGlvbiBnZXRUYWcoYWN0aW9uU3RhdGUpIHsKICAgICAgcmV0dXJuIGFjdGlvblN0YXRlLnRhZzsKICAgIH07CgogICAgX3Byb3RvNTguZ2V0RGVzdHJ1Y3RvciA9IGZ1bmN0aW9uIGdldERlc3RydWN0b3IobW9kaWZpZXIpIHsKICAgICAgcmV0dXJuIG1vZGlmaWVyOwogICAgfTsKCiAgICByZXR1cm4gQWN0aW9uTW9kaWZpZXJNYW5hZ2VyOwogIH0oKTsKCiAgZnVuY3Rpb24gY2FwYWJpbGl0aWVzJDEobWFuYWdlckFQSSwgb3B0aW9uYWxGZWF0dXJlcykgewogICAgaWYgKG9wdGlvbmFsRmVhdHVyZXMgPT09IHZvaWQgMCkgewogICAgICBvcHRpb25hbEZlYXR1cmVzID0ge307CiAgICB9CgogICAgaWYgKG1hbmFnZXJBUEkgIT09ICczLjEzJykgewogICAgICBtYW5hZ2VyQVBJID0gJzMuMTMnOwogICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCdNb2RpZmllciBtYW5hZ2VyIGNhcGFiaWxpdGllcyBub3cgcmVxdWlyZSB5b3UgdG8gcGFzcyBhIHZhbGlkIHZlcnNpb24gd2hlbiBiZWluZyBnZW5lcmF0ZWQuIFZhbGlkIHZlcnNpb25zIGluY2x1ZGU6IDMuMTMnLCBmYWxzZSwgewogICAgICAgIHVudGlsOiAnMy4xNy4wJywKICAgICAgICBpZDogJ2ltcGxpY2l0LW1vZGlmaWVyLW1hbmFnZXItY2FwYWJpbGl0aWVzJwogICAgICB9KSk7CiAgICB9CgogICAgKGZhbHNlICYmICEobWFuYWdlckFQSSA9PT0gJzMuMTMnKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0ludmFsaWQgbW9kaWZpZXIgbWFuYWdlciBjb21wYXRpYmlsaXR5IHNwZWNpZmllZCcsIG1hbmFnZXJBUEkgPT09ICczLjEzJykpOwogICAgcmV0dXJuIHsKICAgICAgZGlzYWJsZUF1dG9UcmFja2luZzogQm9vbGVhbihvcHRpb25hbEZlYXR1cmVzLmRpc2FibGVBdXRvVHJhY2tpbmcpCiAgICB9OwogIH0KCiAgdmFyIEN1c3RvbU1vZGlmaWVyRGVmaW5pdGlvbiA9IGZ1bmN0aW9uIEN1c3RvbU1vZGlmaWVyRGVmaW5pdGlvbihuYW1lLCBNb2RpZmllckNsYXNzLCBkZWxlZ2F0ZSwgaXNJbnRlcmFjdGl2ZSkgewogICAgdGhpcy5uYW1lID0gbmFtZTsKICAgIHRoaXMuTW9kaWZpZXJDbGFzcyA9IE1vZGlmaWVyQ2xhc3M7CiAgICB0aGlzLmRlbGVnYXRlID0gZGVsZWdhdGU7CiAgICB0aGlzLnN0YXRlID0gewogICAgICBNb2RpZmllckNsYXNzOiBNb2RpZmllckNsYXNzLAogICAgICBuYW1lOiBuYW1lLAogICAgICBkZWxlZ2F0ZTogZGVsZWdhdGUKICAgIH07CiAgICB0aGlzLm1hbmFnZXIgPSBpc0ludGVyYWN0aXZlID8gQ1VTVE9NX0lOVEVSQUNUSVZFX01PRElGSUVSX01BTkFHRVIgOiBDVVNUT01fTk9OX0lOVEVSQUNUSVZFX01PRElGSUVSX01BTkFHRVI7CiAgfTsKCiAgdmFyIEN1c3RvbU1vZGlmaWVyU3RhdGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBDdXN0b21Nb2RpZmllclN0YXRlKGVsZW1lbnQsIGRlbGVnYXRlLCBtb2RpZmllciwgYXJncykgewogICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICB0aGlzLmRlbGVnYXRlID0gZGVsZWdhdGU7CiAgICAgIHRoaXMubW9kaWZpZXIgPSBtb2RpZmllcjsKICAgICAgdGhpcy5hcmdzID0gYXJnczsKICAgICAgdGhpcy50YWcgPSAoMCwgX3JlZmVyZW5jZS5jcmVhdGVVcGRhdGFibGVUYWcpKCk7CiAgICB9CgogICAgdmFyIF9wcm90bzU5ID0gQ3VzdG9tTW9kaWZpZXJTdGF0ZS5wcm90b3R5cGU7CgogICAgX3Byb3RvNTkuZGVzdHJveSA9IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgIHZhciBkZWxlZ2F0ZSA9IHRoaXMuZGVsZWdhdGUsCiAgICAgICAgICBtb2RpZmllciA9IHRoaXMubW9kaWZpZXIsCiAgICAgICAgICBhcmdzID0gdGhpcy5hcmdzOwogICAgICBkZWxlZ2F0ZS5kZXN0cm95TW9kaWZpZXIobW9kaWZpZXIsIGFyZ3MudmFsdWUoKSk7CiAgICB9OwoKICAgIHJldHVybiBDdXN0b21Nb2RpZmllclN0YXRlOwogIH0oKTsKICAvKioKICAgIFRoZSBDdXN0b21Nb2RpZmllck1hbmFnZXIgYWxsb3dzIGFkZG9ucyB0byBwcm92aWRlIGN1c3RvbSBtb2RpZmllcgogICAgaW1wbGVtZW50YXRpb25zIHRoYXQgaW50ZWdyYXRlIHNlYW1sZXNzbHkgaW50byBFbWJlci4gVGhpcyBpcyBhY2NvbXBsaXNoZWQKICAgIHRocm91Z2ggYSBkZWxlZ2F0ZSwgcmVnaXN0ZXJlZCB3aXRoIHRoZSBjdXN0b20gbW9kaWZpZXIgbWFuYWdlciwgd2hpY2gKICAgIGltcGxlbWVudHMgYSBzZXQgb2YgaG9va3MgdGhhdCBkZXRlcm1pbmUgbW9kaWZpZXIgYmVoYXZpb3IuCiAgICBUbyBjcmVhdGUgYSBjdXN0b20gbW9kaWZpZXIgbWFuYWdlciwgaW5zdGFudGlhdGUgYSBuZXcgQ3VzdG9tTW9kaWZpZXJNYW5hZ2VyCiAgICBjbGFzcyBhbmQgcGFzcyB0aGUgZGVsZWdhdGUgYXMgdGhlIGZpcnN0IGFyZ3VtZW50OgogIAogICAgYGBganMKICAgIGxldCBtYW5hZ2VyID0gbmV3IEN1c3RvbU1vZGlmaWVyTWFuYWdlcih7CiAgICAgIC8vIC4uLmRlbGVnYXRlIGltcGxlbWVudGF0aW9uLi4uCiAgICB9KTsKICAgIGBgYAogIAogICAgIyMgRGVsZWdhdGUgSG9va3MKICAKICAgIFRocm91Z2hvdXQgdGhlIGxpZmVjeWNsZSBvZiBhIG1vZGlmaWVyLCB0aGUgbW9kaWZpZXIgbWFuYWdlciB3aWxsIGludm9rZQogICAgZGVsZWdhdGUgaG9va3MgdGhhdCBhcmUgcmVzcG9uc2libGUgZm9yIHN1cmZhY2luZyB0aG9zZSBsaWZlY3ljbGUgY2hhbmdlcyB0bwogICAgdGhlIGVuZCBkZXZlbG9wZXIuCiAgICAqIGBjcmVhdGVNb2RpZmllcigpYCAtIGludm9rZWQgd2hlbiBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGlmaWVyIHNob3VsZCBiZSBjcmVhdGVkCiAgICAqIGBpbnN0YWxsTW9kaWZpZXIoKWAgLSBpbnZva2VkIHdoZW4gdGhlIG1vZGlmaWVyIGlzIGluc3RhbGxlZCBvbiB0aGUgZWxlbWVudAogICAgKiBgdXBkYXRlTW9kaWZpZXIoKWAgLSBpbnZva2VkIHdoZW4gdGhlIGFyZ3VtZW50cyBwYXNzZWQgdG8gYSBtb2RpZmllciBjaGFuZ2UKICAgICogYGRlc3Ryb3lNb2RpZmllcigpYCAtIGludm9rZWQgd2hlbiB0aGUgbW9kaWZpZXIgaXMgYWJvdXQgdG8gYmUgZGVzdHJveWVkCiAgKi8KCgogIHZhciBJbnRlcmFjdGl2ZUN1c3RvbU1vZGlmaWVyTWFuYWdlciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEludGVyYWN0aXZlQ3VzdG9tTW9kaWZpZXJNYW5hZ2VyKCkge30KCiAgICB2YXIgX3Byb3RvNjAgPSBJbnRlcmFjdGl2ZUN1c3RvbU1vZGlmaWVyTWFuYWdlci5wcm90b3R5cGU7CgogICAgX3Byb3RvNjAuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKGVsZW1lbnQsIGRlZmluaXRpb24sIGFyZ3MpIHsKICAgICAgdmFyIGRlbGVnYXRlID0gZGVmaW5pdGlvbi5kZWxlZ2F0ZSwKICAgICAgICAgIE1vZGlmaWVyQ2xhc3MgPSBkZWZpbml0aW9uLk1vZGlmaWVyQ2xhc3M7CiAgICAgIHZhciBjYXB0dXJlZEFyZ3MgPSBhcmdzLmNhcHR1cmUoKTsKICAgICAgdmFyIGluc3RhbmNlID0gZGVmaW5pdGlvbi5kZWxlZ2F0ZS5jcmVhdGVNb2RpZmllcihNb2RpZmllckNsYXNzLCBjYXB0dXJlZEFyZ3MudmFsdWUoKSk7CgogICAgICBpZiAoZGVsZWdhdGUuY2FwYWJpbGl0aWVzID09PSB1bmRlZmluZWQpIHsKICAgICAgICBkZWxlZ2F0ZS5jYXBhYmlsaXRpZXMgPSBjYXBhYmlsaXRpZXMkMSgnMy4xMycpOwogICAgICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoJ0N1c3RvbSBtb2RpZmllciBtYW5hZ2VycyBtdXN0IGRlZmluZSB0aGVpciBjYXBhYmlsaXRpZXMgdXNpbmcgdGhlIGNhcGFiaWxpdGllcygpIGhlbHBlciBmdW5jdGlvbicsIGZhbHNlLCB7CiAgICAgICAgICB1bnRpbDogJzMuMTcuMCcsCiAgICAgICAgICBpZDogJ2ltcGxpY2l0LW1vZGlmaWVyLW1hbmFnZXItY2FwYWJpbGl0aWVzJwogICAgICAgIH0pKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG5ldyBDdXN0b21Nb2RpZmllclN0YXRlKGVsZW1lbnQsIGRlbGVnYXRlLCBpbnN0YW5jZSwgY2FwdHVyZWRBcmdzKTsKICAgIH07CgogICAgX3Byb3RvNjAuZ2V0VGFnID0gZnVuY3Rpb24gZ2V0VGFnKF9yZWYzMikgewogICAgICB2YXIgYXJncyA9IF9yZWYzMi5hcmdzLAogICAgICAgICAgdGFnID0gX3JlZjMyLnRhZzsKICAgICAgcmV0dXJuICgwLCBfcmVmZXJlbmNlLmNvbWJpbmUpKFt0YWcsIGFyZ3MudGFnXSk7CiAgICB9OwoKICAgIF9wcm90bzYwLmluc3RhbGwgPSBmdW5jdGlvbiBpbnN0YWxsKHN0YXRlKSB7CiAgICAgIHZhciBlbGVtZW50ID0gc3RhdGUuZWxlbWVudCwKICAgICAgICAgIGFyZ3MgPSBzdGF0ZS5hcmdzLAogICAgICAgICAgZGVsZWdhdGUgPSBzdGF0ZS5kZWxlZ2F0ZSwKICAgICAgICAgIG1vZGlmaWVyID0gc3RhdGUubW9kaWZpZXIsCiAgICAgICAgICB0YWcgPSBzdGF0ZS50YWc7CiAgICAgIHZhciBjYXBhYmlsaXRpZXMgPSBkZWxlZ2F0ZS5jYXBhYmlsaXRpZXM7CgogICAgICBpZiAoY2FwYWJpbGl0aWVzLmRpc2FibGVBdXRvVHJhY2tpbmcgPT09IHRydWUpIHsKICAgICAgICAoMCwgX21ldGFsLnVudHJhY2spKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBkZWxlZ2F0ZS5pbnN0YWxsTW9kaWZpZXIobW9kaWZpZXIsIGVsZW1lbnQsIGFyZ3MudmFsdWUoKSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGNvbWJpbmVkVHJhY2tpbmdUYWcgPSAoMCwgX21ldGFsLnRyYWNrKShmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gZGVsZWdhdGUuaW5zdGFsbE1vZGlmaWVyKG1vZGlmaWVyLCBlbGVtZW50LCBhcmdzLnZhbHVlKCkpOwogICAgICAgIH0pOwogICAgICAgICgwLCBfcmVmZXJlbmNlLnVwZGF0ZSkodGFnLCBjb21iaW5lZFRyYWNraW5nVGFnKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG82MC51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUoc3RhdGUpIHsKICAgICAgdmFyIGFyZ3MgPSBzdGF0ZS5hcmdzLAogICAgICAgICAgZGVsZWdhdGUgPSBzdGF0ZS5kZWxlZ2F0ZSwKICAgICAgICAgIG1vZGlmaWVyID0gc3RhdGUubW9kaWZpZXIsCiAgICAgICAgICB0YWcgPSBzdGF0ZS50YWc7CiAgICAgIHZhciBjYXBhYmlsaXRpZXMgPSBkZWxlZ2F0ZS5jYXBhYmlsaXRpZXM7CgogICAgICBpZiAoY2FwYWJpbGl0aWVzLmRpc2FibGVBdXRvVHJhY2tpbmcgPT09IHRydWUpIHsKICAgICAgICAoMCwgX21ldGFsLnVudHJhY2spKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBkZWxlZ2F0ZS51cGRhdGVNb2RpZmllcihtb2RpZmllciwgYXJncy52YWx1ZSgpKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgY29tYmluZWRUcmFja2luZ1RhZyA9ICgwLCBfbWV0YWwudHJhY2spKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBkZWxlZ2F0ZS51cGRhdGVNb2RpZmllcihtb2RpZmllciwgYXJncy52YWx1ZSgpKTsKICAgICAgICB9KTsKICAgICAgICAoMCwgX3JlZmVyZW5jZS51cGRhdGUpKHRhZywgY29tYmluZWRUcmFja2luZ1RhZyk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNjAuZ2V0RGVzdHJ1Y3RvciA9IGZ1bmN0aW9uIGdldERlc3RydWN0b3Ioc3RhdGUpIHsKICAgICAgcmV0dXJuIHN0YXRlOwogICAgfTsKCiAgICByZXR1cm4gSW50ZXJhY3RpdmVDdXN0b21Nb2RpZmllck1hbmFnZXI7CiAgfSgpOwoKICB2YXIgTm9uSW50ZXJhY3RpdmVDdXN0b21Nb2RpZmllck1hbmFnZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBOb25JbnRlcmFjdGl2ZUN1c3RvbU1vZGlmaWVyTWFuYWdlcigpIHt9CgogICAgdmFyIF9wcm90bzYxID0gTm9uSW50ZXJhY3RpdmVDdXN0b21Nb2RpZmllck1hbmFnZXIucHJvdG90eXBlOwoKICAgIF9wcm90bzYxLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZSgpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9OwoKICAgIF9wcm90bzYxLmdldFRhZyA9IGZ1bmN0aW9uIGdldFRhZygpIHsKICAgICAgcmV0dXJuIF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHOwogICAgfTsKCiAgICBfcHJvdG82MS5pbnN0YWxsID0gZnVuY3Rpb24gaW5zdGFsbCgpIHt9OwoKICAgIF9wcm90bzYxLnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZSgpIHt9OwoKICAgIF9wcm90bzYxLmdldERlc3RydWN0b3IgPSBmdW5jdGlvbiBnZXREZXN0cnVjdG9yKCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH07CgogICAgcmV0dXJuIE5vbkludGVyYWN0aXZlQ3VzdG9tTW9kaWZpZXJNYW5hZ2VyOwogIH0oKTsKCiAgdmFyIENVU1RPTV9JTlRFUkFDVElWRV9NT0RJRklFUl9NQU5BR0VSID0gbmV3IEludGVyYWN0aXZlQ3VzdG9tTW9kaWZpZXJNYW5hZ2VyKCk7CiAgdmFyIENVU1RPTV9OT05fSU5URVJBQ1RJVkVfTU9ESUZJRVJfTUFOQUdFUiA9IG5ldyBOb25JbnRlcmFjdGl2ZUN1c3RvbU1vZGlmaWVyTWFuYWdlcigpOwogIHZhciB1bnRvdWNoYWJsZUNvbnRleHQgPSBidWlsZFVudG91Y2hhYmxlVGhpcygnYG9uYCBtb2RpZmllcicpOwogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwoKICAvKgogICAgSW50ZXJuZXQgRXhwbG9yZXIgMTEgZG9lcyBub3Qgc3VwcG9ydCBgb25jZWAgYW5kIGFsc28gZG9lcyBub3Qgc3VwcG9ydAogICAgcGFzc2luZyBgZXZlbnRPcHRpb25zYC4gSW4gc29tZSBzaXR1YXRpb25zIGl0IHRoZW4gdGhyb3dzIGEgd2VpcmQgc2NyaXB0CiAgICBlcnJvciwgbGlrZToKICAKICAgIGBgYAogICAgQ291bGQgbm90IGNvbXBsZXRlIHRoZSBvcGVyYXRpb24gZHVlIHRvIGVycm9yIDgwMDIwMTAxCiAgICBgYGAKICAKICAgIFRoaXMgZmxhZyBkZXRlcm1pbmVzLCB3aGV0aGVyIGB7IG9uY2U6IHRydWUgfWAgYW5kIHRodXMgYWxzbyBldmVudCBvcHRpb25zIGluCiAgICBnZW5lcmFsIGFyZSBzdXBwb3J0ZWQuCiAgKi8KCiAgdmFyIFNVUFBPUlRTX0VWRU5UX09QVElPTlMgPSBmdW5jdGlvbiAoKSB7CiAgICB0cnkgewogICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIHZhciBjb3VudGVyID0gMDsKICAgICAgZGl2LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjb3VudGVyKys7CiAgICAgIH0sIHsKICAgICAgICBvbmNlOiB0cnVlCiAgICAgIH0pOwogICAgICB2YXIgZXZlbnQ7CgogICAgICBpZiAodHlwZW9mIEV2ZW50ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgZXZlbnQgPSBuZXcgRXZlbnQoJ2NsaWNrJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnRXZlbnQnKTsKICAgICAgICBldmVudC5pbml0RXZlbnQoJ2NsaWNrJywgdHJ1ZSwgdHJ1ZSk7CiAgICAgIH0KCiAgICAgIGRpdi5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgZGl2LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICByZXR1cm4gY291bnRlciA9PT0gMTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9KCk7CgogIHZhciBPbk1vZGlmaWVyU3RhdGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBPbk1vZGlmaWVyU3RhdGUoZWxlbWVudCwgYXJncykgewogICAgICB0aGlzLnNob3VsZFVwZGF0ZSA9IHRydWU7CiAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgIHRoaXMuYXJncyA9IGFyZ3M7CiAgICAgIHRoaXMudGFnID0gYXJncy50YWc7CiAgICB9CgogICAgdmFyIF9wcm90bzYyID0gT25Nb2RpZmllclN0YXRlLnByb3RvdHlwZTsKCiAgICBfcHJvdG82Mi51cGRhdGVGcm9tQXJncyA9IGZ1bmN0aW9uIHVwZGF0ZUZyb21BcmdzKCkgewogICAgICB2YXIgYXJncyA9IHRoaXMuYXJnczsKCiAgICAgIHZhciBfYXJncyRuYW1lZCR2YWx1ZSA9IGFyZ3MubmFtZWQudmFsdWUoKSwKICAgICAgICAgIG9uY2UgPSBfYXJncyRuYW1lZCR2YWx1ZS5vbmNlLAogICAgICAgICAgcGFzc2l2ZSA9IF9hcmdzJG5hbWVkJHZhbHVlLnBhc3NpdmUsCiAgICAgICAgICBjYXB0dXJlID0gX2FyZ3MkbmFtZWQkdmFsdWUuY2FwdHVyZTsKCiAgICAgIGlmIChvbmNlICE9PSB0aGlzLm9uY2UpIHsKICAgICAgICB0aGlzLm9uY2UgPSBvbmNlOwogICAgICAgIHRoaXMuc2hvdWxkVXBkYXRlID0gdHJ1ZTsKICAgICAgfQoKICAgICAgaWYgKHBhc3NpdmUgIT09IHRoaXMucGFzc2l2ZSkgewogICAgICAgIHRoaXMucGFzc2l2ZSA9IHBhc3NpdmU7CiAgICAgICAgdGhpcy5zaG91bGRVcGRhdGUgPSB0cnVlOwogICAgICB9CgogICAgICBpZiAoY2FwdHVyZSAhPT0gdGhpcy5jYXB0dXJlKSB7CiAgICAgICAgdGhpcy5jYXB0dXJlID0gY2FwdHVyZTsKICAgICAgICB0aGlzLnNob3VsZFVwZGF0ZSA9IHRydWU7CiAgICAgIH0KCiAgICAgIHZhciBvcHRpb25zOwoKICAgICAgaWYgKG9uY2UgfHwgcGFzc2l2ZSB8fCBjYXB0dXJlKSB7CiAgICAgICAgb3B0aW9ucyA9IHRoaXMub3B0aW9ucyA9IHsKICAgICAgICAgIG9uY2U6IG9uY2UsCiAgICAgICAgICBwYXNzaXZlOiBwYXNzaXZlLAogICAgICAgICAgY2FwdHVyZTogY2FwdHVyZQogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcHRpb25zID0gdW5kZWZpbmVkOwogICAgICB9CgogICAgICAoZmFsc2UgJiYgIShhcmdzLnBvc2l0aW9uYWwuYXQoMCkgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgYXJncy5wb3NpdGlvbmFsLmF0KDApLnZhbHVlKCkgPT09ICdzdHJpbmcnKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBtdXN0IHBhc3MgYSB2YWxpZCBET00gZXZlbnQgbmFtZSBhcyB0aGUgZmlyc3QgYXJndW1lbnQgdG8gdGhlIGBvbmAgbW9kaWZpZXInLCBhcmdzLnBvc2l0aW9uYWwuYXQoMCkgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgYXJncy5wb3NpdGlvbmFsLmF0KDApLnZhbHVlKCkgPT09ICdzdHJpbmcnKSk7CiAgICAgIHZhciBldmVudE5hbWUgPSBhcmdzLnBvc2l0aW9uYWwuYXQoMCkudmFsdWUoKTsKCiAgICAgIGlmIChldmVudE5hbWUgIT09IHRoaXMuZXZlbnROYW1lKSB7CiAgICAgICAgdGhpcy5ldmVudE5hbWUgPSBldmVudE5hbWU7CiAgICAgICAgdGhpcy5zaG91bGRVcGRhdGUgPSB0cnVlOwogICAgICB9CgogICAgICAoZmFsc2UgJiYgIShhcmdzLnBvc2l0aW9uYWwuYXQoMSkgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgYXJncy5wb3NpdGlvbmFsLmF0KDEpLnZhbHVlKCkgPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IG11c3QgcGFzcyBhIGZ1bmN0aW9uIGFzIHRoZSBzZWNvbmQgYXJndW1lbnQgdG8gdGhlIGBvbmAgbW9kaWZpZXInLCBhcmdzLnBvc2l0aW9uYWwuYXQoMSkgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgYXJncy5wb3NpdGlvbmFsLmF0KDEpLnZhbHVlKCkgPT09ICdmdW5jdGlvbicpKTsKICAgICAgdmFyIHVzZXJQcm92aWRlZENhbGxiYWNrID0gYXJncy5wb3NpdGlvbmFsLmF0KDEpLnZhbHVlKCk7CgogICAgICBpZiAodXNlclByb3ZpZGVkQ2FsbGJhY2sgIT09IHRoaXMudXNlclByb3ZpZGVkQ2FsbGJhY2spIHsKICAgICAgICB0aGlzLnVzZXJQcm92aWRlZENhbGxiYWNrID0gdXNlclByb3ZpZGVkQ2FsbGJhY2s7CiAgICAgICAgdGhpcy5zaG91bGRVcGRhdGUgPSB0cnVlOwogICAgICB9CgogICAgICAoZmFsc2UgJiYgIShhcmdzLnBvc2l0aW9uYWwubGVuZ3RoID09PSAyKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIllvdSBjYW4gb25seSBwYXNzIHR3byBwb3NpdGlvbmFsIGFyZ3VtZW50cyAoZXZlbnQgbmFtZSBhbmQgY2FsbGJhY2spIHRvIHRoZSBgb25gIG1vZGlmaWVyLCBidXQgeW91IHByb3ZpZGVkICIgKyBhcmdzLnBvc2l0aW9uYWwubGVuZ3RoICsgIi4gQ29uc2lkZXIgdXNpbmcgdGhlIGBmbmAgaGVscGVyIHRvIHByb3ZpZGUgYWRkaXRpb25hbCBhcmd1bWVudHMgdG8gdGhlIGBvbmAgY2FsbGJhY2suIiwgYXJncy5wb3NpdGlvbmFsLmxlbmd0aCA9PT0gMikpOwogICAgICB2YXIgbmVlZHNDdXN0b21DYWxsYmFjayA9IFNVUFBPUlRTX0VWRU5UX09QVElPTlMgPT09IGZhbHNlICYmIG9uY2UgfHwKICAgICAgLyogbmVlZHMgbWFudWFsIG9uY2UgaW1wbGVtZW50YXRpb24gKi8KICAgICAgZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgJiYgcGFzc2l2ZQogICAgICAvKiBuZWVkcyBwYXNzaXZlIGVuZm9yY2VtZW50ICovCiAgICAgIDsKCiAgICAgIGlmICh0aGlzLnNob3VsZFVwZGF0ZSkgewogICAgICAgIGlmIChuZWVkc0N1c3RvbUNhbGxiYWNrKSB7CiAgICAgICAgICB2YXIgY2FsbGJhY2sgPSB0aGlzLmNhbGxiYWNrID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChmYWxzZQogICAgICAgICAgICAvKiBERUJVRyAqLwogICAgICAgICAgICAmJiBwYXNzaXZlKSB7CiAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJZb3UgbWFya2VkIHRoaXMgbGlzdGVuZXIgYXMgJ3Bhc3NpdmUnLCBtZWFuaW5nIHRoYXQgeW91IG11c3Qgbm90IGNhbGwgJ2V2ZW50LnByZXZlbnREZWZhdWx0KCknOiBcblxuIiArIHVzZXJQcm92aWRlZENhbGxiYWNrKSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFTVVBQT1JUU19FVkVOVF9PUFRJT05TICYmIG9uY2UpIHsKICAgICAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyKHRoaXMsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIG9wdGlvbnMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdXNlclByb3ZpZGVkQ2FsbGJhY2suY2FsbCh1bnRvdWNoYWJsZUNvbnRleHQsIGV2ZW50KTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIGlmIChmYWxzZQogICAgICAgIC8qIERFQlVHICovCiAgICAgICAgKSB7CiAgICAgICAgICAvLyBwcmV2ZW50IHRoZSBjYWxsYmFjayBmcm9tIGJlaW5nIGJvdW5kIHRvIHRoZSBlbGVtZW50CiAgICAgICAgICB0aGlzLmNhbGxiYWNrID0gdXNlclByb3ZpZGVkQ2FsbGJhY2suYmluZCh1bnRvdWNoYWJsZUNvbnRleHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmNhbGxiYWNrID0gdXNlclByb3ZpZGVkQ2FsbGJhY2s7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzYyLmRlc3Ryb3kgPSBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZWxlbWVudCwKICAgICAgICAgIGV2ZW50TmFtZSA9IHRoaXMuZXZlbnROYW1lLAogICAgICAgICAgY2FsbGJhY2sgPSB0aGlzLmNhbGxiYWNrLAogICAgICAgICAgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcihlbGVtZW50LCBldmVudE5hbWUsIGNhbGxiYWNrLCBvcHRpb25zKTsKICAgIH07CgogICAgcmV0dXJuIE9uTW9kaWZpZXJTdGF0ZTsKICB9KCk7CgogIHZhciBhZGRzID0gMDsKICB2YXIgcmVtb3ZlcyA9IDA7CgogIGZ1bmN0aW9uIHJlbW92ZUV2ZW50TGlzdGVuZXIoZWxlbWVudCwgZXZlbnROYW1lLCBjYWxsYmFjaywgb3B0aW9ucykgewogICAgcmVtb3ZlcysrOwoKICAgIGlmIChTVVBQT1JUU19FVkVOVF9PUFRJT05TKSB7CiAgICAgIC8vIHdoZW4gb3B0aW9ucyBhcmUgc3VwcG9ydGVkLCB1c2UgdGhlbSBhY3Jvc3MgdGhlIGJvYXJkCiAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGNhbGxiYWNrLCBvcHRpb25zKTsKICAgIH0gZWxzZSBpZiAob3B0aW9ucyAhPT0gdW5kZWZpbmVkICYmIG9wdGlvbnMuY2FwdHVyZSkgewogICAgICAvLyB1c2VkIG9ubHkgaW4gdGhlIGZvbGxvd2luZyBjYXNlOgogICAgICAvLwogICAgICAvLyBgeyBvbmNlOiB0cnVlIHwgZmFsc2UsIHBhc3NpdmU6IHRydWUgfCBmYWxzZSwgY2FwdHVyZTogdHJ1ZSB9CiAgICAgIC8vCiAgICAgIC8vIGBvbmNlYCBpcyBoYW5kbGVkIHZpYSBhIGN1c3RvbSBjYWxsYmFjayB0aGF0IHJlbW92ZXMgYWZ0ZXIgZmlyc3QKICAgICAgLy8gaW52b2NhdGlvbiBzbyB3ZSBvbmx5IGNhcmUgYWJvdXQgY2FwdHVyZSBoZXJlIGFzIGEgYm9vbGVhbgogICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBjYWxsYmFjaywgdHJ1ZSk7CiAgICB9IGVsc2UgewogICAgICAvLyB1c2VkIG9ubHkgaW4gdGhlIGZvbGxvd2luZyBjYXNlczoKICAgICAgLy8KICAgICAgLy8gKiB3aGVyZSB0aGVyZSBpcyBubyBvcHRpb25zCiAgICAgIC8vICogYHsgb25jZTogdHJ1ZSB8IGZhbHNlLCBwYXNzaXZlOiB0cnVlIHwgZmFsc2UsIGNhcHR1cmU6IGZhbHNlIH0KICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgY2FsbGJhY2spOwogICAgfQogIH0KCiAgZnVuY3Rpb24gYWRkRXZlbnRMaXN0ZW5lcihlbGVtZW50LCBldmVudE5hbWUsIGNhbGxiYWNrLCBvcHRpb25zKSB7CiAgICBhZGRzKys7CgogICAgaWYgKFNVUFBPUlRTX0VWRU5UX09QVElPTlMpIHsKICAgICAgLy8gd2hlbiBvcHRpb25zIGFyZSBzdXBwb3J0ZWQsIHVzZSB0aGVtIGFjcm9zcyB0aGUgYm9hcmQKICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgY2FsbGJhY2ssIG9wdGlvbnMpOwogICAgfSBlbHNlIGlmIChvcHRpb25zICE9PSB1bmRlZmluZWQgJiYgb3B0aW9ucy5jYXB0dXJlKSB7CiAgICAgIC8vIHVzZWQgb25seSBpbiB0aGUgZm9sbG93aW5nIGNhc2U6CiAgICAgIC8vCiAgICAgIC8vIGB7IG9uY2U6IHRydWUgfCBmYWxzZSwgcGFzc2l2ZTogdHJ1ZSB8IGZhbHNlLCBjYXB0dXJlOiB0cnVlIH0KICAgICAgLy8KICAgICAgLy8gYG9uY2VgIGlzIGhhbmRsZWQgdmlhIGEgY3VzdG9tIGNhbGxiYWNrIHRoYXQgcmVtb3ZlcyBhZnRlciBmaXJzdAogICAgICAvLyBpbnZvY2F0aW9uIHNvIHdlIG9ubHkgY2FyZSBhYm91dCBjYXB0dXJlIGhlcmUgYXMgYSBib29sZWFuCiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGNhbGxiYWNrLCB0cnVlKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHVzZWQgb25seSBpbiB0aGUgZm9sbG93aW5nIGNhc2VzOgogICAgICAvLwogICAgICAvLyAqIHdoZXJlIHRoZXJlIGlzIG5vIG9wdGlvbnMKICAgICAgLy8gKiBgeyBvbmNlOiB0cnVlIHwgZmFsc2UsIHBhc3NpdmU6IHRydWUgfCBmYWxzZSwgY2FwdHVyZTogZmFsc2UgfQogICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBjYWxsYmFjayk7CiAgICB9CiAgfQogIC8qKgogICAgVGhlIGB7e29ufX1gIG1vZGlmaWVyIGxldHMgeW91IGVhc2lseSBhZGQgZXZlbnQgbGlzdGVuZXJzIChpdCB1c2VzCiAgICBbRXZlbnRUYXJnZXQuYWRkRXZlbnRMaXN0ZW5lcl0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0V2ZW50VGFyZ2V0L2FkZEV2ZW50TGlzdGVuZXIpCiAgICBpbnRlcm5hbGx5KS4KICAKICAgIEZvciBleGFtcGxlLCBpZiB5b3UnZCBsaWtlIHRvIHJ1biBhIGZ1bmN0aW9uIG9uIHlvdXIgY29tcG9uZW50IHdoZW4gYSBgPGJ1dHRvbj5gCiAgICBpbiB0aGUgY29tcG9uZW50cyB0ZW1wbGF0ZSBpcyBjbGlja2VkIHlvdSBtaWdodCBkbyBzb21ldGhpbmcgbGlrZToKICAKICAgIGBgYGFwcC90ZW1wbGF0ZXMvY29tcG9uZW50cy9saWtlLXBvc3QuaGJzCiAgICA8YnV0dG9uIHt7b24gJ2NsaWNrJyB0aGlzLnNhdmVMaWtlfX0+TGlrZSB0aGlzIHBvc3QhPC9idXR0b24+CiAgICBgYGAKICAKICAgIGBgYGFwcC9jb21wb25lbnRzL2xpa2UtcG9zdC5qcwogICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZ2xpbW1lci9jb21wb25lbnQnOwogICAgaW1wb3J0IHsgYWN0aW9uIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBMaWtlUG9zdENvbXBvbmVudCBleHRlbmRzIENvbXBvbmVudCB7CiAgICAgIEBhY3Rpb24KICAgICAgc2F2ZUxpa2UoKSB7CiAgICAgICAgLy8gc29tZW9uZSBsaWtlcyB5b3VyIHBvc3QhCiAgICAgICAgLy8gYmV0dGVyIHNlbmQgYSByZXF1ZXN0IG9mZiB0byB5b3VyIHNlcnZlci4uLgogICAgICB9CiAgICB9CiAgICBgYGAKICAKICAgICMjIyBBcmd1bWVudHMKICAKICAgIGB7e29ufX1gIGFjY2VwdHMgdHdvIHBvc2l0aW9uYWwgYXJndW1lbnRzLCBhbmQgYSBmZXcgbmFtZWQgYXJndW1lbnRzLgogIAogICAgVGhlIHBvc2l0aW9uYWwgYXJndW1lbnRzIGFyZToKICAKICAgIC0gYGV2ZW50YCAtLSB0aGUgbmFtZSB0byB1c2Ugd2hlbiBjYWxsaW5nIGBhZGRFdmVudExpc3RlbmVyYAogICAgLSBgY2FsbGJhY2tgIC0tIHRoZSBmdW5jdGlvbiB0byBiZSBwYXNzZWQgdG8gYGFkZEV2ZW50TGlzdGVuZXJgCiAgCiAgICBUaGUgbmFtZWQgYXJndW1lbnRzIGFyZToKICAKICAgIC0gY2FwdHVyZSAtLSBhIGB0cnVlYCB2YWx1ZSBpbmRpY2F0ZXMgdGhhdCBldmVudHMgb2YgdGhpcyB0eXBlIHdpbGwgYmUgZGlzcGF0Y2hlZAogICAgICB0byB0aGUgcmVnaXN0ZXJlZCBsaXN0ZW5lciBiZWZvcmUgYmVpbmcgZGlzcGF0Y2hlZCB0byBhbnkgRXZlbnRUYXJnZXQgYmVuZWF0aCBpdAogICAgICBpbiB0aGUgRE9NIHRyZWUuCiAgICAtIG9uY2UgLS0gaW5kaWNhdGVzIHRoYXQgdGhlIGxpc3RlbmVyIHNob3VsZCBiZSBpbnZva2VkIGF0IG1vc3Qgb25jZSBhZnRlciBiZWluZwogICAgICBhZGRlZC4gSWYgdHJ1ZSwgdGhlIGxpc3RlbmVyIHdvdWxkIGJlIGF1dG9tYXRpY2FsbHkgcmVtb3ZlZCB3aGVuIGludm9rZWQuCiAgICAtIHBhc3NpdmUgLS0gaWYgYHRydWVgLCBpbmRpY2F0ZXMgdGhhdCB0aGUgZnVuY3Rpb24gc3BlY2lmaWVkIGJ5IGxpc3RlbmVyIHdpbGwgbmV2ZXIKICAgICAgY2FsbCBwcmV2ZW50RGVmYXVsdCgpLiBJZiBhIHBhc3NpdmUgbGlzdGVuZXIgZG9lcyBjYWxsIHByZXZlbnREZWZhdWx0KCksIHRoZSB1c2VyCiAgICAgIGFnZW50IHdpbGwgZG8gbm90aGluZyBvdGhlciB0aGFuIGdlbmVyYXRlIGEgY29uc29sZSB3YXJuaW5nLiBTZWUKICAgICAgW0ltcHJvdmluZyBzY3JvbGxpbmcgcGVyZm9ybWFuY2Ugd2l0aCBwYXNzaXZlIGxpc3RlbmVyc10oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0V2ZW50VGFyZ2V0L2FkZEV2ZW50TGlzdGVuZXIjSW1wcm92aW5nX3Njcm9sbGluZ19wZXJmb3JtYW5jZV93aXRoX3Bhc3NpdmVfbGlzdGVuZXJzKQogICAgICB0byBsZWFybiBtb3JlLgogIAogICAgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHBhc3NlZCB0byBge3tvbn19YCB3aWxsIHJlY2VpdmUgYW55IGFyZ3VtZW50cyB0aGF0IGFyZSBwYXNzZWQKICAgIHRvIHRoZSBldmVudCBoYW5kbGVyLiBNb3N0IGNvbW1vbmx5IHRoaXMgd291bGQgYmUgdGhlIGBldmVudGAgaXRzZWxmLgogIAogICAgSWYgeW91IHdvdWxkIGxpa2UgdG8gcGFzcyBhZGRpdGlvbmFsIGFyZ3VtZW50cyB0byB0aGUgZnVuY3Rpb24geW91IHNob3VsZCB1c2UKICAgIHRoZSBge3tmbn19YCBoZWxwZXIuCiAgCiAgICBGb3IgZXhhbXBsZSwgaW4gb3VyIGV4YW1wbGUgY2FzZSBhYm92ZSBpZiB5b3UnZCBsaWtlIHRvIHBhc3MgaW4gdGhlIHBvc3QgdGhhdAogICAgd2FzIGJlaW5nIGxpa2VkIHdoZW4gdGhlIGJ1dHRvbiBpcyBjbGlja2VkIHlvdSBjb3VsZCBkbyBzb21ldGhpbmcgbGlrZToKICAKICAgIGBgYGFwcC90ZW1wbGF0ZXMvY29tcG9uZW50cy9saWtlLXBvc3QuanMKICAgIDxidXR0b24ge3tvbiAnY2xpY2snIChmbiB0aGlzLnNhdmVMaWtlIEBwb3N0KX19Pkxpa2UgdGhpcyBwb3N0ITwvYnV0dG9uPgogICAgYGBgCiAgCiAgICBJbiB0aGlzIGNhc2UsIHRoZSBgc2F2ZUxpa2VgIGZ1bmN0aW9uIHdpbGwgcmVjZWl2ZSB0d28gYXJndW1lbnRzOiB0aGUgY2xpY2sgZXZlbnQKICAgIGFuZCB0aGUgdmFsdWUgb2YgYEBwb3N0YC4KICAKICAgICMjIyBGdW5jdGlvbiBDb250ZXh0CiAgCiAgICBJbiB0aGUgZXhhbXBsZSBhYm92ZSwgd2UgdXNlZCBgQGFjdGlvbmAgdG8gZW5zdXJlIHRoYXQgYGxpa2VQb3N0YCBpcwogICAgcHJvcGVybHkgYm91bmQgdG8gdGhlIGBpdGVtcy1saXN0YCwgYnV0IGxldCdzIGV4cGxvcmUgd2hhdCBoYXBwZW5zIGlmIHdlCiAgICBsZWZ0IG91dCBgQGFjdGlvbmA6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9saWtlLXBvc3QuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGdsaW1tZXIvY29tcG9uZW50JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIExpa2VQb3N0Q29tcG9uZW50IGV4dGVuZHMgQ29tcG9uZW50IHsKICAgICAgc2F2ZUxpa2UoKSB7CiAgICAgICAgLy8gLi4uc25pcC4uLgogICAgICB9CiAgICB9CiAgICBgYGAKICAKICAgIEluIHRoaXMgZXhhbXBsZSwgd2hlbiB0aGUgYnV0dG9uIGlzIGNsaWNrZWQgYHNhdmVMaWtlYCB3aWxsIGJlIGludm9rZWQsCiAgICBpdCB3aWxsICoqbm90KiogaGF2ZSBhY2Nlc3MgdG8gdGhlIGNvbXBvbmVudCBpbnN0YW5jZS4gSW4gb3RoZXIKICAgIHdvcmRzLCBpdCB3aWxsIGhhdmUgbm8gYHRoaXNgIGNvbnRleHQsIHNvIHBsZWFzZSBtYWtlIHN1cmUgeW91ciBmdW5jdGlvbnMKICAgIGFyZSBib3VuZCAodmlhIGBAYWN0aW9uYCBvciBvdGhlciBtZWFucykgYmVmb3JlIHBhc3NpbmcgaW50byBgb25gIQogIAogICAgQG1ldGhvZCBvbgogICAgQGZvciBFbWJlci5UZW1wbGF0ZXMuaGVscGVycwogICAgQHB1YmxpYwogICAgQHNpbmNlIDMuMTEuMAogICovCgoKICB2YXIgT25Nb2RpZmllck1hbmFnZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBPbk1vZGlmaWVyTWFuYWdlcihpc0ludGVyYWN0aXZlKSB7CiAgICAgIHRoaXMuU1VQUE9SVFNfRVZFTlRfT1BUSU9OUyA9IFNVUFBPUlRTX0VWRU5UX09QVElPTlM7CiAgICAgIHRoaXMuaXNJbnRlcmFjdGl2ZSA9IGlzSW50ZXJhY3RpdmU7CiAgICB9CgogICAgdmFyIF9wcm90bzYzID0gT25Nb2RpZmllck1hbmFnZXIucHJvdG90eXBlOwoKICAgIF9wcm90bzYzLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShlbGVtZW50LCBfc3RhdGUsIGFyZ3MpIHsKICAgICAgaWYgKCF0aGlzLmlzSW50ZXJhY3RpdmUpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgdmFyIGNhcHR1cmVkQXJncyA9IGFyZ3MuY2FwdHVyZSgpOwogICAgICByZXR1cm4gbmV3IE9uTW9kaWZpZXJTdGF0ZShlbGVtZW50LCBjYXB0dXJlZEFyZ3MpOwogICAgfTsKCiAgICBfcHJvdG82My5nZXRUYWcgPSBmdW5jdGlvbiBnZXRUYWcoc3RhdGUpIHsKICAgICAgaWYgKHN0YXRlID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHOwogICAgICB9CgogICAgICByZXR1cm4gc3RhdGUudGFnOwogICAgfTsKCiAgICBfcHJvdG82My5pbnN0YWxsID0gZnVuY3Rpb24gaW5zdGFsbChzdGF0ZSkgewogICAgICBpZiAoc3RhdGUgPT09IG51bGwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHN0YXRlLnVwZGF0ZUZyb21BcmdzKCk7CiAgICAgIHZhciBlbGVtZW50ID0gc3RhdGUuZWxlbWVudCwKICAgICAgICAgIGV2ZW50TmFtZSA9IHN0YXRlLmV2ZW50TmFtZSwKICAgICAgICAgIGNhbGxiYWNrID0gc3RhdGUuY2FsbGJhY2ssCiAgICAgICAgICBvcHRpb25zID0gc3RhdGUub3B0aW9uczsKICAgICAgYWRkRXZlbnRMaXN0ZW5lcihlbGVtZW50LCBldmVudE5hbWUsIGNhbGxiYWNrLCBvcHRpb25zKTsKICAgICAgc3RhdGUuc2hvdWxkVXBkYXRlID0gZmFsc2U7CiAgICB9OwoKICAgIF9wcm90bzYzLnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZShzdGF0ZSkgewogICAgICBpZiAoc3RhdGUgPT09IG51bGwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gc3Rhc2ggcHJpb3Igc3RhdGUgZm9yIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIKCgogICAgICB2YXIgZWxlbWVudCA9IHN0YXRlLmVsZW1lbnQsCiAgICAgICAgICBldmVudE5hbWUgPSBzdGF0ZS5ldmVudE5hbWUsCiAgICAgICAgICBjYWxsYmFjayA9IHN0YXRlLmNhbGxiYWNrLAogICAgICAgICAgb3B0aW9ucyA9IHN0YXRlLm9wdGlvbnM7CiAgICAgIHN0YXRlLnVwZGF0ZUZyb21BcmdzKCk7CgogICAgICBpZiAoIXN0YXRlLnNob3VsZFVwZGF0ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfSAvLyB1c2UgcHJpb3Igc3RhdGUgdmFsdWVzIGZvciByZW1vdmFsCgoKICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcihlbGVtZW50LCBldmVudE5hbWUsIGNhbGxiYWNrLCBvcHRpb25zKTsgLy8gcmVhZCB1cGRhdGVkIHZhbHVlcyBmcm9tIHRoZSBzdGF0ZSBvYmplY3QKCiAgICAgIGFkZEV2ZW50TGlzdGVuZXIoc3RhdGUuZWxlbWVudCwgc3RhdGUuZXZlbnROYW1lLCBzdGF0ZS5jYWxsYmFjaywgc3RhdGUub3B0aW9ucyk7CiAgICAgIHN0YXRlLnNob3VsZFVwZGF0ZSA9IGZhbHNlOwogICAgfTsKCiAgICBfcHJvdG82My5nZXREZXN0cnVjdG9yID0gZnVuY3Rpb24gZ2V0RGVzdHJ1Y3RvcihzdGF0ZSkgewogICAgICByZXR1cm4gc3RhdGU7CiAgICB9OwoKICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoT25Nb2RpZmllck1hbmFnZXIsIFt7CiAgICAgIGtleTogImNvdW50ZXJzIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGFkZHM6IGFkZHMsCiAgICAgICAgICByZW1vdmVzOiByZW1vdmVzCiAgICAgICAgfTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIE9uTW9kaWZpZXJNYW5hZ2VyOwogIH0oKTsKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICAgIFRoZSBgbGV0YCBoZWxwZXIgcmVjZWl2ZXMgb25lIG9yIG1vcmUgcG9zaXRpb25hbCBhcmd1bWVudHMgYW5kIHlpZWxkcwogICAgICB0aGVtIG91dCBhcyBibG9jayBwYXJhbXMuCiAgCiAgICAgIFRoaXMgYWxsb3dzIHRoZSBkZXZlbG9wZXIgdG8gaW50cm9kdWNlIHNob3J0ZXIgbmFtZXMgZm9yIGNlcnRhaW4gY29tcHV0YXRpb25zCiAgICAgIGluIHRoZSB0ZW1wbGF0ZS4KICAKICAgICAgVGhpcyBpcyBlc3BlY2lhbGx5IHVzZWZ1bCBpZiB5b3UgYXJlIHBhc3NpbmcgcHJvcGVydGllcyB0byBhIGNvbXBvbmVudAogICAgICB0aGF0IHJlY2VpdmVzIGEgbG90IG9mIG9wdGlvbnMgYW5kIHlvdSB3YW50IHRvIGNsZWFuIHVwIHRoZSBpbnZvY2F0aW9uLgogIAogICAgICBGb3IgdGhlIGZvbGxvd2luZyBleGFtcGxlLCB0aGUgdGVtcGxhdGUgcmVjZWl2ZXMgYSBgcG9zdGAgb2JqZWN0IHdpdGgKICAgICAgYGNvbnRlbnRgIGFuZCBgdGl0bGVgIHByb3BlcnRpZXMuCiAgCiAgICAgIFdlIGFyZSBnb2luZyB0byBjYWxsIHRoZSBgbXktcG9zdGAgY29tcG9uZW50LCBwYXNzaW5nIGEgdGl0bGUgd2hpY2ggaXMKICAgICAgdGhlIHRpdGxlIG9mIHRoZSBwb3N0IHN1ZmZpeGVkIHdpdGggdGhlIG5hbWUgb2YgdGhlIGJsb2csIHRoZSBjb250ZW50CiAgICAgIG9mIHRoZSBwb3N0LCBhbmQgYSBzZXJpZXMgb2Ygb3B0aW9ucyBkZWZpbmVkIGluLXBsYWNlLgogIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7I2xldAogICAgICAgICAgKGNvbmNhdCBwb3N0LnRpdGxlICcgfCBUaGUgRW1iZXIuanMgQmxvZycpCiAgICAgICAgICBwb3N0LmNvbnRlbnQKICAgICAgICAgIChoYXNoCiAgICAgICAgICAgIHRoZW1lPSJoaWdoLWNvbnRyYXN0IgogICAgICAgICAgICBlbmFibGVDb21tZW50cz10cnVlCiAgICAgICAgICApCiAgICAgICAgICBhcyB8dGl0bGUgY29udGVudCBvcHRpb25zfAogICAgICB9fQogICAgICAgIDxNeVBvc3QgQHRpdGxlPXt7dGl0bGV9fSBAY29udGVudD17e2NvbnRlbnR9fSBAb3B0aW9ucz17e29wdGlvbnN9fSAvPgogICAgICB7ey9sZXR9fQogICAgYGBgCiAgIG9yCiAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7I2xldAogICAgICAgICAgKGNvbmNhdCBwb3N0LnRpdGxlICcgfCBUaGUgRW1iZXIuanMgQmxvZycpCiAgICAgICAgICBwb3N0LmNvbnRlbnQKICAgICAgICAgIChoYXNoCiAgICAgICAgICAgIHRoZW1lPSJoaWdoLWNvbnRyYXN0IgogICAgICAgICAgICBlbmFibGVDb21tZW50cz10cnVlCiAgICAgICAgICApCiAgICAgICAgICBhcyB8dGl0bGUgY29udGVudCBvcHRpb25zfAogICAgICB9fQogICAgICAgIHt7bXktcG9zdCB0aXRsZT10aXRsZSBjb250ZW50PWNvbnRlbnQgb3B0aW9ucz1vcHRpb25zfX0KICAgICAge3svbGV0fX0KICAgIGBgYAogIAogICAgQG1ldGhvZCBsZXQKICAgIEBmb3IgRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gYmxvY2tMZXRNYWNybyhwYXJhbXMsIF9oYXNoLCB0ZW1wbGF0ZSwgX2ludmVyc2UsIGJ1aWxkZXIpIHsKICAgIGlmICh0ZW1wbGF0ZSAhPT0gbnVsbCkgewogICAgICBpZiAocGFyYW1zICE9PSBudWxsKSB7CiAgICAgICAgYnVpbGRlci5jb21waWxlUGFyYW1zKHBhcmFtcyk7CiAgICAgICAgYnVpbGRlci5pbnZva2VTdGF0aWNCbG9jayh0ZW1wbGF0ZSwgcGFyYW1zLmxlbmd0aCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnVpbGRlci5pbnZva2VTdGF0aWModGVtcGxhdGUpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfQoKICB2YXIgQ0FQQUJJTElUSUVTJDQgPSB7CiAgICBkeW5hbWljTGF5b3V0OiB0cnVlLAogICAgZHluYW1pY1RhZzogZmFsc2UsCiAgICBwcmVwYXJlQXJnczogZmFsc2UsCiAgICBjcmVhdGVBcmdzOiB0cnVlLAogICAgYXR0cmlidXRlSG9vazogZmFsc2UsCiAgICBlbGVtZW50SG9vazogZmFsc2UsCiAgICBjcmVhdGVDYWxsZXI6IHRydWUsCiAgICBkeW5hbWljU2NvcGU6IHRydWUsCiAgICB1cGRhdGVIb29rOiB0cnVlLAogICAgY3JlYXRlSW5zdGFuY2U6IHRydWUKICB9OyAvLyBUT0RPCiAgLy8gVGhpcyAiZGlzYWJsZXMiIHRoZSAiQG1vZGVsIiBmZWF0dXJlIGJ5IG1ha2luZyB0aGUgYXJnIHVudHlwYWJsZSBzeW50YXRpY2FsbHkKICAvLyBEZWxldGUgdGhpcyB3aGVuIEVNQkVSX1JPVVRJTkdfTU9ERUxfQVJHIGhhcyBzaGlwcGVkCgogIHZhciBNT0RFTF9BUkdfTkFNRSA9ICdtb2RlbCc7CgogIHZhciBNb3VudE1hbmFnZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0Fic3RyYWN0TWFuYWdlcjYpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShNb3VudE1hbmFnZXIsIF9BYnN0cmFjdE1hbmFnZXI2KTsKCiAgICBmdW5jdGlvbiBNb3VudE1hbmFnZXIoKSB7CiAgICAgIHJldHVybiBfQWJzdHJhY3RNYW5hZ2VyNi5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICB9CgogICAgdmFyIF9wcm90bzY0ID0gTW91bnRNYW5hZ2VyLnByb3RvdHlwZTsKCiAgICBfcHJvdG82NC5nZXREeW5hbWljTGF5b3V0ID0gZnVuY3Rpb24gZ2V0RHluYW1pY0xheW91dChzdGF0ZSwgXykgewogICAgICB2YXIgdGVtcGxhdGVGYWN0b3J5JCQxID0gc3RhdGUuZW5naW5lLmxvb2t1cCgndGVtcGxhdGU6YXBwbGljYXRpb24nKTsKICAgICAgdmFyIHRlbXBsYXRlID0gdGVtcGxhdGVGYWN0b3J5JCQxKHN0YXRlLmVuZ2luZSk7CiAgICAgIHZhciBsYXlvdXQgPSB0ZW1wbGF0ZS5hc0xheW91dCgpOwogICAgICByZXR1cm4gewogICAgICAgIGhhbmRsZTogbGF5b3V0LmNvbXBpbGUoKSwKICAgICAgICBzeW1ib2xUYWJsZTogbGF5b3V0LnN5bWJvbFRhYmxlCiAgICAgIH07CiAgICB9OwoKICAgIF9wcm90bzY0LmdldENhcGFiaWxpdGllcyA9IGZ1bmN0aW9uIGdldENhcGFiaWxpdGllcygpIHsKICAgICAgcmV0dXJuIENBUEFCSUxJVElFUyQ0OwogICAgfTsKCiAgICBfcHJvdG82NC5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUoZW52aXJvbm1lbnQsIF9yZWYzMywgYXJncykgewogICAgICB2YXIgbmFtZSA9IF9yZWYzMy5uYW1lOwoKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICkgewogICAgICAgIGVudmlyb25tZW50LmRlYnVnU3RhY2sucHVzaEVuZ2luZSgiZW5naW5lOiIgKyBuYW1lKTsKICAgICAgfSAvLyBUT0RPCiAgICAgIC8vIG1vdW50IGlzIGEgcnVudGltZSBoZWxwZXIsIHRoaXMgc2hvdWxkbid0IHVzZSBkeW5hbWljIGxheW91dAogICAgICAvLyB3ZSBzaG91bGQgcmVzb2x2ZSB0aGUgZW5naW5lIGFwcCB0ZW1wbGF0ZSBpbiB0aGUgaGVscGVyCiAgICAgIC8vIGl0IGFsc28gc2hvdWxkIHVzZSB0aGUgb3duZXIgdGhhdCBsb29rZWQgdXAgdGhlIG1vdW50IGhlbHBlci4KCgogICAgICB2YXIgZW5naW5lID0gZW52aXJvbm1lbnQub3duZXIuYnVpbGRDaGlsZEVuZ2luZUluc3RhbmNlKG5hbWUpOwogICAgICBlbmdpbmUuYm9vdCgpOwogICAgICB2YXIgYXBwbGljYXRpb25GYWN0b3J5ID0gZW5naW5lLmZhY3RvcnlGb3IoImNvbnRyb2xsZXI6YXBwbGljYXRpb24iKTsKICAgICAgdmFyIGNvbnRyb2xsZXJGYWN0b3J5ID0gYXBwbGljYXRpb25GYWN0b3J5IHx8ICgwLCBfcm91dGluZy5nZW5lcmF0ZUNvbnRyb2xsZXJGYWN0b3J5KShlbmdpbmUsICdhcHBsaWNhdGlvbicpOwogICAgICB2YXIgY29udHJvbGxlcjsKICAgICAgdmFyIHNlbGY7CiAgICAgIHZhciBidWNrZXQ7CiAgICAgIHZhciBtb2RlbFJlZjsKCiAgICAgIGlmIChhcmdzLm5hbWVkLmhhcyhNT0RFTF9BUkdfTkFNRSkpIHsKICAgICAgICBtb2RlbFJlZiA9IGFyZ3MubmFtZWQuZ2V0KE1PREVMX0FSR19OQU1FKTsKICAgICAgfQoKICAgICAgaWYgKG1vZGVsUmVmID09PSB1bmRlZmluZWQpIHsKICAgICAgICBjb250cm9sbGVyID0gY29udHJvbGxlckZhY3RvcnkuY3JlYXRlKCk7CiAgICAgICAgc2VsZiA9IG5ldyBSb290UmVmZXJlbmNlKGNvbnRyb2xsZXIpOwogICAgICAgIGJ1Y2tldCA9IHsKICAgICAgICAgIGVuZ2luZTogZW5naW5lLAogICAgICAgICAgY29udHJvbGxlcjogY29udHJvbGxlciwKICAgICAgICAgIHNlbGY6IHNlbGYsCiAgICAgICAgICBlbnZpcm9ubWVudDogZW52aXJvbm1lbnQKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBtb2RlbCA9IG1vZGVsUmVmLnZhbHVlKCk7CiAgICAgICAgY29udHJvbGxlciA9IGNvbnRyb2xsZXJGYWN0b3J5LmNyZWF0ZSh7CiAgICAgICAgICBtb2RlbDogbW9kZWwKICAgICAgICB9KTsKICAgICAgICBzZWxmID0gbmV3IFJvb3RSZWZlcmVuY2UoY29udHJvbGxlcik7CiAgICAgICAgYnVja2V0ID0gewogICAgICAgICAgZW5naW5lOiBlbmdpbmUsCiAgICAgICAgICBjb250cm9sbGVyOiBjb250cm9sbGVyLAogICAgICAgICAgc2VsZjogc2VsZiwKICAgICAgICAgIG1vZGVsUmVmOiBtb2RlbFJlZiwKICAgICAgICAgIGVudmlyb25tZW50OiBlbnZpcm9ubWVudAogICAgICAgIH07CiAgICAgIH0KCiAgICAgIGlmIChfZW52aXJvbm1lbnQyLkVOVi5fREVCVUdfUkVOREVSX1RSRUUpIHsKICAgICAgICBlbnZpcm9ubWVudC5kZWJ1Z1JlbmRlclRyZWUuY3JlYXRlKGJ1Y2tldCwgewogICAgICAgICAgdHlwZTogJ2VuZ2luZScsCiAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgYXJnczogYXJncy5jYXB0dXJlKCksCiAgICAgICAgICBpbnN0YW5jZTogZW5naW5lCiAgICAgICAgfSk7CiAgICAgICAgZW52aXJvbm1lbnQuZGVidWdSZW5kZXJUcmVlLmNyZWF0ZShjb250cm9sbGVyLCB7CiAgICAgICAgICB0eXBlOiAncm91dGUtdGVtcGxhdGUnLAogICAgICAgICAgbmFtZTogJ2FwcGxpY2F0aW9uJywKICAgICAgICAgIGFyZ3M6IGFyZ3MuY2FwdHVyZSgpLAogICAgICAgICAgaW5zdGFuY2U6IGNvbnRyb2xsZXIKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgcmV0dXJuIGJ1Y2tldDsKICAgIH07CgogICAgX3Byb3RvNjQuZ2V0U2VsZiA9IGZ1bmN0aW9uIGdldFNlbGYoX3JlZjM0KSB7CiAgICAgIHZhciBzZWxmID0gX3JlZjM0LnNlbGY7CiAgICAgIHJldHVybiBzZWxmOwogICAgfTsKCiAgICBfcHJvdG82NC5nZXRUYWcgPSBmdW5jdGlvbiBnZXRUYWcoc3RhdGUpIHsKICAgICAgdmFyIHRhZyA9IF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHOwoKICAgICAgaWYgKHN0YXRlLm1vZGVsUmVmKSB7CiAgICAgICAgdGFnID0gc3RhdGUubW9kZWxSZWYudGFnOwogICAgICB9CgogICAgICBpZiAoX2Vudmlyb25tZW50Mi5FTlYuX0RFQlVHX1JFTkRFUl9UUkVFICYmICgwLCBfcmVmZXJlbmNlLmlzQ29uc3RUYWcpKHRhZykpIHsKICAgICAgICB0YWcgPSAoMCwgX3JlZmVyZW5jZS5jcmVhdGVUYWcpKCk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0YWc7CiAgICB9OwoKICAgIF9wcm90bzY0LmdldERlc3RydWN0b3IgPSBmdW5jdGlvbiBnZXREZXN0cnVjdG9yKGJ1Y2tldCkgewogICAgICB2YXIgZW5naW5lID0gYnVja2V0LmVuZ2luZSwKICAgICAgICAgIGVudmlyb25tZW50ID0gYnVja2V0LmVudmlyb25tZW50LAogICAgICAgICAgY29udHJvbGxlciA9IGJ1Y2tldC5jb250cm9sbGVyOwoKICAgICAgaWYgKF9lbnZpcm9ubWVudDIuRU5WLl9ERUJVR19SRU5ERVJfVFJFRSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICAgICAgICBlbnZpcm9ubWVudC5kZWJ1Z1JlbmRlclRyZWUud2lsbERlc3Ryb3koY29udHJvbGxlcik7CiAgICAgICAgICAgIGVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS53aWxsRGVzdHJveShidWNrZXQpOwogICAgICAgICAgICBlbmdpbmUuZGVzdHJveSgpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGVuZ2luZTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG82NC5kaWRSZW5kZXJMYXlvdXQgPSBmdW5jdGlvbiBkaWRSZW5kZXJMYXlvdXQoYnVja2V0LCBib3VuZHMpIHsKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICkgewogICAgICAgIGJ1Y2tldC5lbnZpcm9ubWVudC5kZWJ1Z1N0YWNrLnBvcCgpOwogICAgICB9CgogICAgICBpZiAoX2Vudmlyb25tZW50Mi5FTlYuX0RFQlVHX1JFTkRFUl9UUkVFKSB7CiAgICAgICAgYnVja2V0LmVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS5kaWRSZW5kZXIoYnVja2V0LmNvbnRyb2xsZXIsIGJvdW5kcyk7CiAgICAgICAgYnVja2V0LmVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS5kaWRSZW5kZXIoYnVja2V0LCBib3VuZHMpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzY0LnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZShidWNrZXQpIHsKICAgICAgdmFyIGNvbnRyb2xsZXIgPSBidWNrZXQuY29udHJvbGxlciwKICAgICAgICAgIGVudmlyb25tZW50ID0gYnVja2V0LmVudmlyb25tZW50LAogICAgICAgICAgbW9kZWxSZWYgPSBidWNrZXQubW9kZWxSZWY7CgogICAgICBpZiAobW9kZWxSZWYgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGNvbnRyb2xsZXIuc2V0KCdtb2RlbCcsIG1vZGVsUmVmLnZhbHVlKCkpOwogICAgICB9CgogICAgICBpZiAoX2Vudmlyb25tZW50Mi5FTlYuX0RFQlVHX1JFTkRFUl9UUkVFKSB7CiAgICAgICAgZW52aXJvbm1lbnQuZGVidWdSZW5kZXJUcmVlLnVwZGF0ZShidWNrZXQpOwogICAgICAgIGVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS51cGRhdGUoYnVja2V0LmNvbnRyb2xsZXIpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzY0LmRpZFVwZGF0ZUxheW91dCA9IGZ1bmN0aW9uIGRpZFVwZGF0ZUxheW91dChidWNrZXQsIGJvdW5kcykgewogICAgICBpZiAoX2Vudmlyb25tZW50Mi5FTlYuX0RFQlVHX1JFTkRFUl9UUkVFKSB7CiAgICAgICAgYnVja2V0LmVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS5kaWRSZW5kZXIoYnVja2V0LmNvbnRyb2xsZXIsIGJvdW5kcyk7CiAgICAgICAgYnVja2V0LmVudmlyb25tZW50LmRlYnVnUmVuZGVyVHJlZS5kaWRSZW5kZXIoYnVja2V0LCBib3VuZHMpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBNb3VudE1hbmFnZXI7CiAgfShBYnN0cmFjdE1hbmFnZXIpOwoKICB2YXIgTU9VTlRfTUFOQUdFUiA9IG5ldyBNb3VudE1hbmFnZXIoKTsKCiAgdmFyIE1vdW50RGVmaW5pdGlvbiA9IGZ1bmN0aW9uIE1vdW50RGVmaW5pdGlvbihuYW1lKSB7CiAgICB0aGlzLm1hbmFnZXIgPSBNT1VOVF9NQU5BR0VSOwogICAgdGhpcy5zdGF0ZSA9IHsKICAgICAgbmFtZTogbmFtZQogICAgfTsKICB9OwoKICBmdW5jdGlvbiBtb3VudEhlbHBlcih2bSwgYXJncykgewogICAgdmFyIGVudiA9IHZtLmVudjsKICAgIHZhciBuYW1lUmVmID0gYXJncy5wb3NpdGlvbmFsLmF0KDApOwogICAgdmFyIGNhcHR1cmVkID0gbnVsbDsgLy8gVE9ETzogdGhlIGZ1bmN0aW9uYWlsdHkgdG8gY3JlYXRlIGEgcHJvcGVyIENhcHR1cmVkQXJndW1lbnQgc2hvdWxkIGJlCiAgICAvLyBleHBvcnRlZCBieSBnbGltbWVyLCBvciB0aGF0IGl0IHNob3VsZCBwcm92aWRlIGFuIG92ZXJsb2FkIGZvciBgY3VycnlgCiAgICAvLyB0aGF0IHRha2VzIGBQcmVwYXJlZEFyZ3VtZW50c2AKCiAgICBpZiAoYXJncy5uYW1lZC5oYXMoJ21vZGVsJykpIHsKICAgICAgKGZhbHNlICYmICEoYXJncy5uYW1lZC5sZW5ndGggPT09IDEpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnW0JVR10gdGhpcyBzaG91bGQgYWxyZWFkeSBiZSBjaGVja2VkIGJ5IHRoZSBtYWNybycsIGFyZ3MubmFtZWQubGVuZ3RoID09PSAxKSk7CiAgICAgIHZhciBuYW1lZCA9IGFyZ3MubmFtZWQuY2FwdHVyZSgpOwogICAgICB2YXIgdGFnID0gbmFtZWQudGFnOyAvLyBUT0RPIGRlbGV0ZSBtZSBhZnRlciBFTUJFUl9ST1VUSU5HX01PREVMX0FSRyBoYXMgc2hpcHBlZAoKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICYmIE1PREVMX0FSR19OQU1FICE9PSAnbW9kZWwnKSB7CiAgICAgICAgKGZhbHNlICYmICEobmFtZWRbJ19tYXAnXSA9PT0gbnVsbCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdbQlVHXSBuYW1lZC5fbWFwIGlzIG5vdCBudWxsJywgbmFtZWRbJ19tYXAnXSA9PT0gbnVsbCkpOwogICAgICAgIG5hbWVkLm5hbWVzID0gW01PREVMX0FSR19OQU1FXTsKICAgICAgfQoKICAgICAgY2FwdHVyZWQgPSB7CiAgICAgICAgdGFnOiB0YWcsCiAgICAgICAgcG9zaXRpb25hbDogX3J1bnRpbWUyLkVNUFRZX0FSR1MucG9zaXRpb25hbCwKICAgICAgICBuYW1lZDogbmFtZWQsCiAgICAgICAgbGVuZ3RoOiAxLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG5hbWVkOiB0aGlzLm5hbWVkLnZhbHVlKCksCiAgICAgICAgICAgIHBvc2l0aW9uYWw6IHRoaXMucG9zaXRpb25hbC52YWx1ZSgpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gbmV3IER5bmFtaWNFbmdpbmVSZWZlcmVuY2UobmFtZVJlZiwgZW52LCBjYXB0dXJlZCk7CiAgfQogIC8qKgogICAgVGhlIGB7e21vdW50fX1gIGhlbHBlciBsZXRzIHlvdSBlbWJlZCBhIHJvdXRlbGVzcyBlbmdpbmUgaW4gYSB0ZW1wbGF0ZS4KICAgIE1vdW50aW5nIGFuIGVuZ2luZSB3aWxsIGNhdXNlIGFuIGluc3RhbmNlIHRvIGJlIGJvb3RlZCBhbmQgaXRzIGBhcHBsaWNhdGlvbmAKICAgIHRlbXBsYXRlIHRvIGJlIHJlbmRlcmVkLgogIAogICAgRm9yIGV4YW1wbGUsIHRoZSBmb2xsb3dpbmcgdGVtcGxhdGUgbW91bnRzIHRoZSBgZW1iZXItY2hhdGAgZW5naW5lOgogIAogICAgYGBgaGFuZGxlYmFycwogICAge3shIGFwcGxpY2F0aW9uLmhicyB9fQogICAge3ttb3VudCAiZW1iZXItY2hhdCJ9fQogICAgYGBgCiAgCiAgICBBZGRpdGlvbmFsbHksIHlvdSBjYW4gYWxzbyBwYXNzIGluIGEgYG1vZGVsYCBhcmd1bWVudCB0aGF0IHdpbGwgYmUKICAgIHNldCBhcyB0aGUgZW5naW5lcyBtb2RlbC4gVGhpcyBjYW4gYmUgYW4gZXhpc3Rpbmcgb2JqZWN0OgogIAogICAgYGBgCiAgICA8ZGl2PgogICAgICB7e21vdW50ICdhZG1pbicgbW9kZWw9dXNlclNldHRpbmdzfX0KICAgIDwvZGl2PgogICAgYGBgCiAgCiAgICBPciBhbiBpbmxpbmUgYGhhc2hgLCBhbmQgeW91IGNhbiBldmVuIHBhc3MgY29tcG9uZW50czoKICAKICAgIGBgYAogICAgPGRpdj4KICAgICAgPGgxPkFwcGxpY2F0aW9uIHRlbXBsYXRlITwvaDE+CiAgICAgIHt7bW91bnQgJ2FkbWluJyBtb2RlbD0oaGFzaAogICAgICAgICAgdGl0bGU9J1NlY3JldCBBZG1pbicKICAgICAgICAgIHNpZ25JbkJ1dHRvbj0oY29tcG9uZW50ICdzaWduLWluLWJ1dHRvbicpCiAgICAgICl9fQogICAgPC9kaXY+CiAgICBgYGAKICAKICAgIEBtZXRob2QgbW91bnQKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGVuZ2luZSB0byBtb3VudC4KICAgIEBwYXJhbSB7T2JqZWN0fSBbbW9kZWxdIE9iamVjdCB0aGF0IHdpbGwgYmUgc2V0IGFzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgbW9kZWwgb2YgdGhlIGVuZ2luZS4KICAgIEBmb3IgRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gbW91bnRNYWNybyhfbmFtZSwgcGFyYW1zLCBoYXNoLCBidWlsZGVyKSB7CiAgICAoZmFsc2UgJiYgIShwYXJhbXMubGVuZ3RoID09PSAxKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW4gb25seSBwYXNzIGEgc2luZ2xlIHBvc2l0aW9uYWwgYXJndW1lbnQgdG8gdGhlIHt7bW91bnR9fSBoZWxwZXIsIGUuZy4ge3ttb3VudCAiY2hhdC1lbmdpbmUifX0uJywgcGFyYW1zLmxlbmd0aCA9PT0gMSkpOwoKICAgIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICYmIGhhc2gpIHsKICAgICAgdmFyIGtleXMgPSBoYXNoWzBdOwogICAgICB2YXIgZXh0cmEgPSBrZXlzLmZpbHRlcihmdW5jdGlvbiAoaykgewogICAgICAgIHJldHVybiBrICE9PSAnbW9kZWwnOwogICAgICB9KTsKICAgICAgKGZhbHNlICYmICEoZXh0cmEubGVuZ3RoID09PSAwKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW4gb25seSBwYXNzIGEgYG1vZGVsYCBhcmd1bWVudCB0byB0aGUge3ttb3VudH19IGhlbHBlciwgJyArICdlLmcuIHt7bW91bnQgInByb2ZpbGUtZW5naW5lIiBtb2RlbD10aGlzLnByb2ZpbGV9fS4gJyArICgiWW91IHBhc3NlZCAiICsgZXh0cmEuam9pbignLCcpICsgIi4iKSwgZXh0cmEubGVuZ3RoID09PSAwKSk7CiAgICB9CgogICAgdmFyIGV4cHIgPSBbX3dpcmVGb3JtYXQuT3BzLkhlbHBlciwgJy1tb3VudCcsIHBhcmFtcyB8fCBbXSwgaGFzaF07CiAgICBidWlsZGVyLmR5bmFtaWNDb21wb25lbnQoZXhwciwgbnVsbCwgW10sIG51bGwsIGZhbHNlLCBudWxsLCBudWxsKTsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgdmFyIER5bmFtaWNFbmdpbmVSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBEeW5hbWljRW5naW5lUmVmZXJlbmNlKG5hbWVSZWYsIGVudiwgYXJncykgewogICAgICB0aGlzLm5hbWVSZWYgPSBuYW1lUmVmOwogICAgICB0aGlzLmVudiA9IGVudjsKICAgICAgdGhpcy5hcmdzID0gYXJnczsKICAgICAgdGhpcy5fbGFzdE5hbWUgPSBudWxsOwogICAgICB0aGlzLl9sYXN0RGVmID0gbnVsbDsKICAgICAgdGhpcy50YWcgPSBuYW1lUmVmLnRhZzsKICAgIH0KCiAgICB2YXIgX3Byb3RvNjUgPSBEeW5hbWljRW5naW5lUmVmZXJlbmNlLnByb3RvdHlwZTsKCiAgICBfcHJvdG82NS52YWx1ZSA9IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICB2YXIgZW52ID0gdGhpcy5lbnYsCiAgICAgICAgICBuYW1lUmVmID0gdGhpcy5uYW1lUmVmLAogICAgICAgICAgYXJncyA9IHRoaXMuYXJnczsKICAgICAgdmFyIG5hbWUgPSBuYW1lUmVmLnZhbHVlKCk7CgogICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgaWYgKHRoaXMuX2xhc3ROYW1lID09PSBuYW1lKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fbGFzdERlZjsKICAgICAgICB9CgogICAgICAgIChmYWxzZSAmJiAhKGVudi5vd25lci5oYXNSZWdpc3RyYXRpb24oImVuZ2luZToiICsgbmFtZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IHVzZWQgYHt7bW91bnQgJyIgKyBuYW1lICsgIid9fWAsIGJ1dCB0aGUgZW5naW5lICciICsgbmFtZSArICInIGNhbiBub3QgYmUgZm91bmQuIiwgZW52Lm93bmVyLmhhc1JlZ2lzdHJhdGlvbigiZW5naW5lOiIgKyBuYW1lKSkpOwoKICAgICAgICBpZiAoIWVudi5vd25lci5oYXNSZWdpc3RyYXRpb24oImVuZ2luZToiICsgbmFtZSkpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fbGFzdE5hbWUgPSBuYW1lOwogICAgICAgIHRoaXMuX2xhc3REZWYgPSAoMCwgX3J1bnRpbWUyLmN1cnJ5KShuZXcgTW91bnREZWZpbml0aW9uKG5hbWUpLCBhcmdzKTsKICAgICAgICByZXR1cm4gdGhpcy5fbGFzdERlZjsKICAgICAgfSBlbHNlIHsKICAgICAgICAoZmFsc2UgJiYgIShuYW1lID09PSBudWxsIHx8IG5hbWUgPT09IHVuZGVmaW5lZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJJbnZhbGlkIGVuZ2luZSBuYW1lICciICsgbmFtZSArICInIHNwZWNpZmllZCwgZW5naW5lIG5hbWUgbXVzdCBiZSBlaXRoZXIgYSBzdHJpbmcsIG51bGwgb3IgdW5kZWZpbmVkLiIsIG5hbWUgPT09IG51bGwgfHwgbmFtZSA9PT0gdW5kZWZpbmVkKSk7CiAgICAgICAgdGhpcy5fbGFzdERlZiA9IG51bGw7CiAgICAgICAgdGhpcy5fbGFzdE5hbWUgPSBudWxsOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzY1LmdldCA9IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9ydW50aW1lMi5VTkRFRklORURfUkVGRVJFTkNFOwogICAgfTsKCiAgICByZXR1cm4gRHluYW1pY0VuZ2luZVJlZmVyZW5jZTsKICB9KCk7CiAgLyoqCiAgICogUmVwcmVzZW50cyB0aGUgcm9vdCBvdXRsZXQuCiAgICovCgoKICB2YXIgUm9vdE91dGxldFJlZmVyZW5jZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFJvb3RPdXRsZXRSZWZlcmVuY2Uob3V0bGV0U3RhdGUpIHsKICAgICAgdGhpcy5vdXRsZXRTdGF0ZSA9IG91dGxldFN0YXRlOwogICAgICB0aGlzLnRhZyA9ICgwLCBfcmVmZXJlbmNlLmNyZWF0ZVRhZykoKTsKICAgIH0KCiAgICB2YXIgX3Byb3RvNjYgPSBSb290T3V0bGV0UmVmZXJlbmNlLnByb3RvdHlwZTsKCiAgICBfcHJvdG82Ni5nZXQgPSBmdW5jdGlvbiBnZXQoa2V5KSB7CiAgICAgIHJldHVybiBuZXcgUGF0aFJlZmVyZW5jZSh0aGlzLCBrZXkpOwogICAgfTsKCiAgICBfcHJvdG82Ni52YWx1ZSA9IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICByZXR1cm4gdGhpcy5vdXRsZXRTdGF0ZTsKICAgIH07CgogICAgX3Byb3RvNjYudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlKHN0YXRlKSB7CiAgICAgIHRoaXMub3V0bGV0U3RhdGUub3V0bGV0cy5tYWluID0gc3RhdGU7CiAgICAgICgwLCBfcmVmZXJlbmNlLmRpcnR5KSh0aGlzLnRhZyk7CiAgICB9OwoKICAgIHJldHVybiBSb290T3V0bGV0UmVmZXJlbmNlOwogIH0oKTsKICAvKioKICAgKiBSZXByZXNlbnRzIHRoZSBjb25uZWN0ZWQgb3V0bGV0LgogICAqLwoKCiAgdmFyIE91dGxldFJlZmVyZW5jZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIE91dGxldFJlZmVyZW5jZShwYXJlbnRTdGF0ZVJlZiwgb3V0bGV0TmFtZVJlZikgewogICAgICB0aGlzLnBhcmVudFN0YXRlUmVmID0gcGFyZW50U3RhdGVSZWY7CiAgICAgIHRoaXMub3V0bGV0TmFtZVJlZiA9IG91dGxldE5hbWVSZWY7CiAgICAgIHRoaXMudGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW3BhcmVudFN0YXRlUmVmLnRhZywgb3V0bGV0TmFtZVJlZi50YWddKTsKICAgIH0KCiAgICB2YXIgX3Byb3RvNjcgPSBPdXRsZXRSZWZlcmVuY2UucHJvdG90eXBlOwoKICAgIF9wcm90bzY3LnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHZhciBvdXRsZXRTdGF0ZSA9IHRoaXMucGFyZW50U3RhdGVSZWYudmFsdWUoKTsKICAgICAgdmFyIG91dGxldHMgPSBvdXRsZXRTdGF0ZSA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogb3V0bGV0U3RhdGUub3V0bGV0czsKICAgICAgcmV0dXJuIG91dGxldHMgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IG91dGxldHNbdGhpcy5vdXRsZXROYW1lUmVmLnZhbHVlKCldOwogICAgfTsKCiAgICBfcHJvdG82Ny5nZXQgPSBmdW5jdGlvbiBnZXQoa2V5KSB7CiAgICAgIHJldHVybiBuZXcgUGF0aFJlZmVyZW5jZSh0aGlzLCBrZXkpOwogICAgfTsKCiAgICByZXR1cm4gT3V0bGV0UmVmZXJlbmNlOwogIH0oKTsKICAvKioKICAgKiBPdXRsZXQgc3RhdGUgaXMgZGlydGllZCBmcm9tIHJvb3QuCiAgICogVGhpcyBqdXN0IHVzaW5nIHRoZSBwYXJlbnQgdGFnIGZvciBkaXJ0aW5lc3MuCiAgICovCgoKICB2YXIgUGF0aFJlZmVyZW5jZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFBhdGhSZWZlcmVuY2UocGFyZW50LCBrZXkpIHsKICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAgIHRoaXMua2V5ID0ga2V5OwogICAgICB0aGlzLnRhZyA9IHBhcmVudC50YWc7CiAgICB9CgogICAgdmFyIF9wcm90bzY4ID0gUGF0aFJlZmVyZW5jZS5wcm90b3R5cGU7CgogICAgX3Byb3RvNjguZ2V0ID0gZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICByZXR1cm4gbmV3IFBhdGhSZWZlcmVuY2UodGhpcywga2V5KTsKICAgIH07CgogICAgX3Byb3RvNjgudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdmFyIHBhcmVudCA9IHRoaXMucGFyZW50LnZhbHVlKCk7CiAgICAgIHJldHVybiBwYXJlbnQgJiYgcGFyZW50W3RoaXMua2V5XTsKICAgIH07CgogICAgcmV0dXJuIFBhdGhSZWZlcmVuY2U7CiAgfSgpOwogIC8qKgogICAgVGhlIGB7e291dGxldH19YCBoZWxwZXIgbGV0cyB5b3Ugc3BlY2lmeSB3aGVyZSBhIGNoaWxkIHJvdXRlIHdpbGwgcmVuZGVyIGluCiAgICB5b3VyIHRlbXBsYXRlLiBBbiBpbXBvcnRhbnQgdXNlIG9mIHRoZSBge3tvdXRsZXR9fWAgaGVscGVyIGlzIGluIHlvdXIKICAgIGFwcGxpY2F0aW9uJ3MgYGFwcGxpY2F0aW9uLmhic2AgZmlsZToKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIHt7ISBhcHAvdGVtcGxhdGVzL2FwcGxpY2F0aW9uLmhicyB9fQogICAgPCEtLSBoZWFkZXIgY29udGVudCBnb2VzIGhlcmUsIGFuZCB3aWxsIGFsd2F5cyBkaXNwbGF5IC0tPgogICAgPE15SGVhZGVyIC8+CiAgICA8ZGl2IGNsYXNzPSJteS1keW5hbWljLWNvbnRlbnQiPgogICAgICA8IS0tIHRoaXMgY29udGVudCB3aWxsIGNoYW5nZSBiYXNlZCBvbiB0aGUgY3VycmVudCByb3V0ZSwgd2hpY2ggZGVwZW5kcyBvbiB0aGUgY3VycmVudCBVUkwgLS0+CiAgICAgIHt7b3V0bGV0fX0KICAgIDwvZGl2PgogICAgPCEtLSBmb290ZXIgY29udGVudCBnb2VzIGhlcmUsIGFuZCB3aWxsIGFsd2F5cyBkaXNwbGF5IC0tPgogICAgPE15Rm9vdGVyIC8+CiAgICBgYGAKICAKICAgIFlvdSBtYXkgYWxzbyBzcGVjaWZ5IGEgbmFtZSBmb3IgdGhlIGB7e291dGxldH19YCwgd2hpY2ggaXMgdXNlZnVsIHdoZW4gdXNpbmcgbW9yZSB0aGFuIG9uZQogICAgYHt7b3V0bGV0fX1gIGluIGEgdGVtcGxhdGU6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7e291dGxldCAibWVudSJ9fQogICAge3tvdXRsZXQgInNpZGViYXIifX0KICAgIHt7b3V0bGV0ICJtYWluIn19CiAgICBgYGAKICAKICAgIFlvdXIgcm91dGVzIGNhbiB0aGVuIHJlbmRlciBpbnRvIGEgc3BlY2lmaWMgb25lIG9mIHRoZXNlIGBvdXRsZXRgcyBieSBzcGVjaWZ5aW5nIHRoZSBgb3V0bGV0YAogICAgYXR0cmlidXRlIGluIHlvdXIgYHJlbmRlclRlbXBsYXRlYCBmdW5jdGlvbjoKICAKICAgIGBgYGFwcC9yb3V0ZXMvbWVudS5qcwogICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgIHJlbmRlclRlbXBsYXRlKCkgewogICAgICAgIHRoaXMucmVuZGVyKHsgb3V0bGV0OiAnbWVudScgfSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBTZWUgdGhlIFtyb3V0aW5nIGd1aWRlXShodHRwczovL2d1aWRlcy5lbWJlcmpzLmNvbS9yZWxlYXNlL3JvdXRpbmcvcmVuZGVyaW5nLWEtdGVtcGxhdGUvKSBmb3IgbW9yZQogICAgaW5mb3JtYXRpb24gb24gaG93IHlvdXIgYHJvdXRlYCBpbnRlcmFjdHMgd2l0aCB0aGUgYHt7b3V0bGV0fX1gIGhlbHBlci4KICAgIE5vdGU6IFlvdXIgY29udGVudCBfX3dpbGwgbm90IHJlbmRlcl9fIGlmIHRoZXJlIGlzbid0IGFuIGB7e291dGxldH19YCBmb3IgaXQuCiAgCiAgICBAbWV0aG9kIG91dGxldAogICAgQHBhcmFtIHtTdHJpbmd9IFtuYW1lXQogICAgQGZvciBFbWJlci5UZW1wbGF0ZXMuaGVscGVycwogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBvdXRsZXRIZWxwZXIodm0sIGFyZ3MpIHsKICAgIHZhciBzY29wZSA9IHZtLmR5bmFtaWNTY29wZSgpOwogICAgdmFyIG5hbWVSZWY7CgogICAgaWYgKGFyZ3MucG9zaXRpb25hbC5sZW5ndGggPT09IDApIHsKICAgICAgbmFtZVJlZiA9IG5ldyBfcmVmZXJlbmNlLkNvbnN0UmVmZXJlbmNlKCdtYWluJyk7CiAgICB9IGVsc2UgewogICAgICBuYW1lUmVmID0gYXJncy5wb3NpdGlvbmFsLmF0KDApOwogICAgfQoKICAgIHJldHVybiBuZXcgT3V0bGV0Q29tcG9uZW50UmVmZXJlbmNlKG5ldyBPdXRsZXRSZWZlcmVuY2Uoc2NvcGUub3V0bGV0U3RhdGUsIG5hbWVSZWYpKTsKICB9CgogIGZ1bmN0aW9uIG91dGxldE1hY3JvKF9uYW1lLCBwYXJhbXMsIGhhc2gsIGJ1aWxkZXIpIHsKICAgIHZhciBleHByID0gW193aXJlRm9ybWF0Lk9wcy5IZWxwZXIsICctb3V0bGV0JywgcGFyYW1zIHx8IFtdLCBoYXNoXTsKICAgIGJ1aWxkZXIuZHluYW1pY0NvbXBvbmVudChleHByLCBudWxsLCBbXSwgbnVsbCwgZmFsc2UsIG51bGwsIG51bGwpOwogICAgcmV0dXJuIHRydWU7CiAgfQoKICB2YXIgT3V0bGV0TW9kZWxSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBPdXRsZXRNb2RlbFJlZmVyZW5jZShwYXJlbnQpIHsKICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAgIHRoaXMudGFnID0gcGFyZW50LnRhZzsKICAgIH0KCiAgICB2YXIgX3Byb3RvNjkgPSBPdXRsZXRNb2RlbFJlZmVyZW5jZS5wcm90b3R5cGU7CgogICAgX3Byb3RvNjkudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdmFyIHN0YXRlID0gdGhpcy5wYXJlbnQudmFsdWUoKTsKCiAgICAgIGlmIChzdGF0ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgdmFyIHJlbmRlciA9IHN0YXRlLnJlbmRlcjsKCiAgICAgIGlmIChyZW5kZXIgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIH0KCiAgICAgIHJldHVybiByZW5kZXIubW9kZWw7CiAgICB9OwoKICAgIF9wcm90bzY5LmdldCA9IGZ1bmN0aW9uIGdldChwcm9wZXJ0eSkgewogICAgICBpZiAoZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgKSB7CiAgICAgICAgLy8gVGhpcyBndWFyZW50ZWVzIHRoYXQgd2UgcHJlc2VydmUgdGhlIGBkZWJ1ZygpYCBvdXRwdXQgYmVsb3cKICAgICAgICByZXR1cm4gbmV3IE5lc3RlZFByb3BlcnR5UmVmZXJlbmNlKHRoaXMsIHByb3BlcnR5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gUHJvcGVydHlSZWZlcmVuY2UuY3JlYXRlKHRoaXMsIHByb3BlcnR5KTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gT3V0bGV0TW9kZWxSZWZlcmVuY2U7CiAgfSgpOwoKICBpZiAoZmFsc2UKICAvKiBERUJVRyAqLwogICkgewogICAgT3V0bGV0TW9kZWxSZWZlcmVuY2UucHJvdG90eXBlWydkZWJ1ZyddID0gZnVuY3Rpb24gZGVidWcoKSB7CiAgICAgIHJldHVybiAnQG1vZGVsJzsKICAgIH07CiAgfQoKICB2YXIgT3V0bGV0Q29tcG9uZW50UmVmZXJlbmNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gT3V0bGV0Q29tcG9uZW50UmVmZXJlbmNlKG91dGxldFJlZikgewogICAgICB0aGlzLm91dGxldFJlZiA9IG91dGxldFJlZjsKICAgICAgdGhpcy5hcmdzID0gbnVsbDsKICAgICAgdGhpcy5kZWZpbml0aW9uID0gbnVsbDsKICAgICAgdGhpcy5sYXN0U3RhdGUgPSBudWxsOyAvLyBUaGUgcm91dGVyIGFsd2F5cyBkaXJ0aWVzIHRoZSByb290IHN0YXRlLgoKICAgICAgdmFyIHRhZyA9IHRoaXMudGFnID0gb3V0bGV0UmVmLnRhZzsKICAgICAgewogICAgICAgIHZhciBtb2RlbFJlZiA9IG5ldyBPdXRsZXRNb2RlbFJlZmVyZW5jZShvdXRsZXRSZWYpOwogICAgICAgIHZhciBtYXAkJDEgPSAoMCwgX3V0aWwuZGljdCkoKTsKICAgICAgICBtYXAkJDEubW9kZWwgPSBtb2RlbFJlZjsgLy8gVE9ETzogdGhlIGZ1bmN0aW9uYWlsdHkgdG8gY3JlYXRlIGEgcHJvcGVyIENhcHR1cmVkQXJndW1lbnQgc2hvdWxkIGJlCiAgICAgICAgLy8gZXhwb3J0ZWQgYnkgZ2xpbW1lciwgb3IgdGhhdCBpdCBzaG91bGQgcHJvdmlkZSBhbiBvdmVybG9hZCBmb3IgYGN1cnJ5YAogICAgICAgIC8vIHRoYXQgdGFrZXMgYFByZXBhcmVkQXJndW1lbnRzYAoKICAgICAgICB0aGlzLmFyZ3MgPSB7CiAgICAgICAgICB0YWc6IHRhZywKICAgICAgICAgIHBvc2l0aW9uYWw6IF9ydW50aW1lMi5FTVBUWV9BUkdTLnBvc2l0aW9uYWwsCiAgICAgICAgICBuYW1lZDogewogICAgICAgICAgICB0YWc6IHRhZywKICAgICAgICAgICAgbWFwOiBtYXAkJDEsCiAgICAgICAgICAgIG5hbWVzOiBbJ21vZGVsJ10sCiAgICAgICAgICAgIHJlZmVyZW5jZXM6IFttb2RlbFJlZl0sCiAgICAgICAgICAgIGxlbmd0aDogMSwKICAgICAgICAgICAgaGFzOiBmdW5jdGlvbiBoYXMoa2V5KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGtleSA9PT0gJ21vZGVsJzsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoa2V5KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGtleSA9PT0gJ21vZGVsJyA/IG1vZGVsUmVmIDogX3J1bnRpbWUyLlVOREVGSU5FRF9SRUZFUkVOQ0U7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgICAgICB2YXIgbW9kZWwgPSBtb2RlbFJlZi52YWx1ZSgpOwogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBtb2RlbDogbW9kZWwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgbGVuZ3RoOiAxLAogICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIG5hbWVkOiB0aGlzLm5hbWVkLnZhbHVlKCksCiAgICAgICAgICAgICAgcG9zaXRpb25hbDogdGhpcy5wb3NpdGlvbmFsLnZhbHVlKCkKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICB9CgogICAgdmFyIF9wcm90bzcwID0gT3V0bGV0Q29tcG9uZW50UmVmZXJlbmNlLnByb3RvdHlwZTsKCiAgICBfcHJvdG83MC52YWx1ZSA9IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICB2YXIgc3RhdGUgPSBzdGF0ZUZvcih0aGlzLm91dGxldFJlZik7CgogICAgICBpZiAodmFsaWRhdGUkMShzdGF0ZSwgdGhpcy5sYXN0U3RhdGUpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVmaW5pdGlvbjsKICAgICAgfQoKICAgICAgdGhpcy5sYXN0U3RhdGUgPSBzdGF0ZTsKICAgICAgdmFyIGRlZmluaXRpb24gPSBudWxsOwoKICAgICAgaWYgKHN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgZGVmaW5pdGlvbiA9ICgwLCBfcnVudGltZTIuY3VycnkpKG5ldyBPdXRsZXRDb21wb25lbnREZWZpbml0aW9uKHN0YXRlKSwgdGhpcy5hcmdzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuZGVmaW5pdGlvbiA9IGRlZmluaXRpb247CiAgICB9OwoKICAgIF9wcm90bzcwLmdldCA9IGZ1bmN0aW9uIGdldChfa2V5KSB7CiAgICAgIHJldHVybiBfcnVudGltZTIuVU5ERUZJTkVEX1JFRkVSRU5DRTsKICAgIH07CgogICAgcmV0dXJuIE91dGxldENvbXBvbmVudFJlZmVyZW5jZTsKICB9KCk7CgogIGZ1bmN0aW9uIHN0YXRlRm9yKHJlZikgewogICAgdmFyIG91dGxldCA9IHJlZi52YWx1ZSgpOwogICAgaWYgKG91dGxldCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgIHZhciByZW5kZXIgPSBvdXRsZXQucmVuZGVyOwogICAgaWYgKHJlbmRlciA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgIHZhciB0ZW1wbGF0ZSQkMSA9IHJlbmRlci50ZW1wbGF0ZTsKICAgIGlmICh0ZW1wbGF0ZSQkMSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsgLy8gdGhpcyBndWFyZCBjYW4gYmUgcmVtb3ZlZCBvbmNlIEBlbWJlci90ZXN0LWhlbHBlcnNAMS42LjAgaGFzICJhZ2VkIG91dCIKICAgIC8vIGFuZCBpcyBubyBsb25nZXIgY29uc2lkZXJlZCBzdXBwb3J0ZWQKCiAgICBpZiAoaXNUZW1wbGF0ZUZhY3RvcnkodGVtcGxhdGUkJDEpKSB7CiAgICAgIHRlbXBsYXRlJCQxID0gdGVtcGxhdGUkJDEocmVuZGVyLm93bmVyKTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICByZWY6IHJlZiwKICAgICAgbmFtZTogcmVuZGVyLm5hbWUsCiAgICAgIG91dGxldDogcmVuZGVyLm91dGxldCwKICAgICAgdGVtcGxhdGU6IHRlbXBsYXRlJCQxLAogICAgICBjb250cm9sbGVyOiByZW5kZXIuY29udHJvbGxlciwKICAgICAgbW9kZWw6IHJlbmRlci5tb2RlbAogICAgfTsKICB9CgogIGZ1bmN0aW9uIHZhbGlkYXRlJDEoc3RhdGUsIGxhc3RTdGF0ZSkgewogICAgaWYgKHN0YXRlID09PSBudWxsKSB7CiAgICAgIHJldHVybiBsYXN0U3RhdGUgPT09IG51bGw7CiAgICB9CgogICAgaWYgKGxhc3RTdGF0ZSA9PT0gbnVsbCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIHN0YXRlLnRlbXBsYXRlID09PSBsYXN0U3RhdGUudGVtcGxhdGUgJiYgc3RhdGUuY29udHJvbGxlciA9PT0gbGFzdFN0YXRlLmNvbnRyb2xsZXI7CiAgfQoKICBmdW5jdGlvbiBoYXNoVG9BcmdzKGhhc2gpIHsKICAgIGlmIChoYXNoID09PSBudWxsKSByZXR1cm4gbnVsbDsKICAgIHZhciBuYW1lcyA9IGhhc2hbMF0ubWFwKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgcmV0dXJuICJAIiArIGtleTsKICAgIH0pOwogICAgcmV0dXJuIFtuYW1lcywgaGFzaFsxXV07CiAgfQoKICBmdW5jdGlvbiByZWZpbmVJbmxpbmVTeW50YXgobmFtZSwgcGFyYW1zLCBoYXNoLCBidWlsZGVyKSB7CiAgICAoZmFsc2UgJiYgISghKGJ1aWxkZXIuY29tcGlsZXJbJ3Jlc29sdmVyJ11bJ3Jlc29sdmVyJ11bJ2J1aWx0SW5IZWxwZXJzJ11bbmFtZV0gJiYgYnVpbGRlci5yZWZlcnJlci5vd25lci5oYXNSZWdpc3RyYXRpb24oImhlbHBlcjoiICsgbmFtZSkpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIllvdSBhdHRlbXB0ZWQgdG8gb3ZlcndyaXRlIHRoZSBidWlsdC1pbiBoZWxwZXIgXCIiICsgbmFtZSArICJcIiB3aGljaCBpcyBub3QgYWxsb3dlZC4gUGxlYXNlIHJlbmFtZSB0aGUgaGVscGVyLiIsICEoYnVpbGRlci5jb21waWxlclsncmVzb2x2ZXInXVsncmVzb2x2ZXInXVsnYnVpbHRJbkhlbHBlcnMnXVtuYW1lXSAmJiBidWlsZGVyLnJlZmVycmVyLm93bmVyLmhhc1JlZ2lzdHJhdGlvbigiaGVscGVyOiIgKyBuYW1lKSkpKTsKICAgIHZhciBoYW5kbGUgPSBidWlsZGVyLmNvbXBpbGVyWydyZXNvbHZlciddLmxvb2t1cENvbXBvbmVudERlZmluaXRpb24obmFtZSwgYnVpbGRlci5yZWZlcnJlcik7CgogICAgaWYgKGhhbmRsZSAhPT0gbnVsbCkgewogICAgICBidWlsZGVyLmNvbXBvbmVudC5zdGF0aWMoaGFuZGxlLCBbcGFyYW1zID09PSBudWxsID8gW10gOiBwYXJhbXMsIGhhc2hUb0FyZ3MoaGFzaCksIG51bGwsIG51bGxdKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgZnVuY3Rpb24gcmVmaW5lQmxvY2tTeW50YXgobmFtZSwgcGFyYW1zLCBoYXNoLCB0ZW1wbGF0ZSwgaW52ZXJzZSwgYnVpbGRlcikgewogICAgdmFyIGhhbmRsZSA9IGJ1aWxkZXIuY29tcGlsZXJbJ3Jlc29sdmVyJ10ubG9va3VwQ29tcG9uZW50RGVmaW5pdGlvbihuYW1lLCBidWlsZGVyLnJlZmVycmVyKTsKCiAgICBpZiAoaGFuZGxlICE9PSBudWxsKSB7CiAgICAgIHdyYXBDb21wb25lbnRDbGFzc0F0dHJpYnV0ZShoYXNoKTsKICAgICAgYnVpbGRlci5jb21wb25lbnQuc3RhdGljKGhhbmRsZSwgW3BhcmFtcywgaGFzaFRvQXJncyhoYXNoKSwgdGVtcGxhdGUsIGludmVyc2VdKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgKGZhbHNlICYmICEoYnVpbGRlci5yZWZlcnJlci5vd25lci5oYXNSZWdpc3RyYXRpb24oImhlbHBlcjoiICsgbmFtZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQSBjb21wb25lbnQgb3IgaGVscGVyIG5hbWVkIFwiIiArIG5hbWUgKyAiXCIgY291bGQgbm90IGJlIGZvdW5kIiwgYnVpbGRlci5yZWZlcnJlci5vd25lci5oYXNSZWdpc3RyYXRpb24oImhlbHBlcjoiICsgbmFtZSkpKTsKICAgIChmYWxzZSAmJiAhKCFmdW5jdGlvbiAoKSB7CiAgICAgIHZhciByZXNvbHZlciA9IGJ1aWxkZXIuY29tcGlsZXJbJ3Jlc29sdmVyJ11bJ3Jlc29sdmVyJ107CiAgICAgIHZhciBfYnVpbGRlciRyZWZlcnJlciA9IGJ1aWxkZXIucmVmZXJyZXIsCiAgICAgICAgICBvd25lciA9IF9idWlsZGVyJHJlZmVycmVyLm93bmVyLAogICAgICAgICAgbW9kdWxlTmFtZSA9IF9idWlsZGVyJHJlZmVycmVyLm1vZHVsZU5hbWU7CgogICAgICBpZiAobmFtZSA9PT0gJ2NvbXBvbmVudCcgfHwgcmVzb2x2ZXJbJ2J1aWx0SW5IZWxwZXJzJ11bbmFtZV0pIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgICAgc291cmNlOiAidGVtcGxhdGU6IiArIG1vZHVsZU5hbWUKICAgICAgfTsKICAgICAgcmV0dXJuIG93bmVyLmhhc1JlZ2lzdHJhdGlvbigiaGVscGVyOiIgKyBuYW1lLCBvcHRpb25zKSB8fCBvd25lci5oYXNSZWdpc3RyYXRpb24oImhlbHBlcjoiICsgbmFtZSk7CiAgICB9KCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiSGVscGVycyBtYXkgbm90IGJlIHVzZWQgaW4gdGhlIGJsb2NrIGZvcm0sIGZvciBleGFtcGxlIHt7IyIgKyBuYW1lICsgIn19e3svIiArIG5hbWUgKyAifX0uIFBsZWFzZSB1c2UgYSBjb21wb25lbnQsIG9yIGFsdGVybmF0aXZlbHkgdXNlIHRoZSBoZWxwZXIgaW4gY29tYmluYXRpb24gd2l0aCBhIGJ1aWx0LWluIEVtYmVyIGhlbHBlciwgZm9yIGV4YW1wbGUge3sjaWYgKCIgKyBuYW1lICsgIil9fXt7L2lmfX0uIiwgIWZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHJlc29sdmVyID0gYnVpbGRlci5jb21waWxlclsncmVzb2x2ZXInXVsncmVzb2x2ZXInXTsKICAgICAgdmFyIF9idWlsZGVyJHJlZmVycmVyID0gYnVpbGRlci5yZWZlcnJlciwKICAgICAgICAgIG93bmVyID0gX2J1aWxkZXIkcmVmZXJyZXIub3duZXIsCiAgICAgICAgICBtb2R1bGVOYW1lID0gX2J1aWxkZXIkcmVmZXJyZXIubW9kdWxlTmFtZTsKCiAgICAgIGlmIChuYW1lID09PSAnY29tcG9uZW50JyB8fCByZXNvbHZlclsnYnVpbHRJbkhlbHBlcnMnXVtuYW1lXSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgICBzb3VyY2U6ICJ0ZW1wbGF0ZToiICsgbW9kdWxlTmFtZQogICAgICB9OwogICAgICByZXR1cm4gb3duZXIuaGFzUmVnaXN0cmF0aW9uKCJoZWxwZXI6IiArIG5hbWUsIG9wdGlvbnMpIHx8IG93bmVyLmhhc1JlZ2lzdHJhdGlvbigiaGVscGVyOiIgKyBuYW1lKTsKICAgIH0oKSkpOwogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgdmFyIGV4cGVyaW1lbnRhbE1hY3JvcyA9IFtdOyAvLyBUaGlzIGlzIGEgcHJpdmF0ZSBBUEkgdG8gYWxsb3cgZm9yIGV4cGVyaW1lbnRhbCBtYWNyb3MKICAvLyB0byBiZSBjcmVhdGVkIGluIHVzZXIgc3BhY2UuIFJlZ2lzdGVyaW5nIGEgbWFjcm8gc2hvdWxkCiAgLy8gc2hvdWxkIGJlIGRvbmUgaW4gYW4gaW5pdGlhbGl6ZXIuCgogIF9leHBvcnRzLl9leHBlcmltZW50YWxNYWNyb3MgPSBleHBlcmltZW50YWxNYWNyb3M7CgogIGZ1bmN0aW9uIHJlZ2lzdGVyTWFjcm9zKG1hY3JvKSB7CiAgICBleHBlcmltZW50YWxNYWNyb3MucHVzaChtYWNybyk7CiAgfQoKICBmdW5jdGlvbiBwb3B1bGF0ZU1hY3JvcyhtYWNyb3MpIHsKICAgIHZhciBpbmxpbmVzID0gbWFjcm9zLmlubGluZXMsCiAgICAgICAgYmxvY2tzID0gbWFjcm9zLmJsb2NrczsKICAgIGlubGluZXMuYWRkKCdvdXRsZXQnLCBvdXRsZXRNYWNybyk7CiAgICBpbmxpbmVzLmFkZCgnbW91bnQnLCBtb3VudE1hY3JvKTsKICAgIGlubGluZXMuYWRkTWlzc2luZyhyZWZpbmVJbmxpbmVTeW50YXgpOwogICAgYmxvY2tzLmFkZCgnbGV0JywgYmxvY2tMZXRNYWNybyk7CiAgICBibG9ja3MuYWRkTWlzc2luZyhyZWZpbmVCbG9ja1N5bnRheCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBleHBlcmltZW50YWxNYWNyb3MubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIG1hY3JvID0gZXhwZXJpbWVudGFsTWFjcm9zW2ldOwogICAgICBtYWNybyhibG9ja3MsIGlubGluZXMpOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGJsb2NrczogYmxvY2tzLAogICAgICBpbmxpbmVzOiBpbmxpbmVzCiAgICB9OwogIH0KCiAgdmFyIFRFTVBMQVRFUyQxID0gbmV3IFdlYWtNYXAoKTsKICB2YXIgZ2V0UHJvdG90eXBlT2YkMSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKCiAgZnVuY3Rpb24gc2V0Q29tcG9uZW50VGVtcGxhdGUoZmFjdG9yeSwgb2JqKSB7CiAgICAoZmFsc2UgJiYgIShvYmogIT09IG51bGwgJiYgKHR5cGVvZiBvYmogPT09ICdvYmplY3QnIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkNhbm5vdCBjYWxsIGBzZXRDb21wb25lbnRUZW1wbGF0ZWAgb24gYCIgKyAoMCwgX3V0aWxzLnRvU3RyaW5nKShvYmopICsgImAiLCBvYmogIT09IG51bGwgJiYgKHR5cGVvZiBvYmogPT09ICdvYmplY3QnIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpKSk7CiAgICAoZmFsc2UgJiYgISghVEVNUExBVEVTJDEuaGFzKG9iaikpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQ2Fubm90IGNhbGwgYHNldENvbXBvbmVudFRlbXBsYXRlYCBtdWx0aXBsZSB0aW1lcyBvbiB0aGUgc2FtZSBjbGFzcyAoYCIgKyBvYmogKyAiYCkiLCAhVEVNUExBVEVTJDEuaGFzKG9iaikpKTsKICAgIFRFTVBMQVRFUyQxLnNldChvYmosIGZhY3RvcnkpOwogICAgcmV0dXJuIG9iajsKICB9CgogIGZ1bmN0aW9uIGdldENvbXBvbmVudFRlbXBsYXRlKG9iaikgewogICAgdmFyIHBvaW50ZXIgPSBvYmo7CgogICAgd2hpbGUgKHBvaW50ZXIgIT09IHVuZGVmaW5lZCAmJiBwb2ludGVyICE9PSBudWxsKSB7CiAgICAgIHZhciBfdGVtcGxhdGUgPSBURU1QTEFURVMkMS5nZXQocG9pbnRlcik7CgogICAgICBpZiAoX3RlbXBsYXRlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gX3RlbXBsYXRlOwogICAgICB9CgogICAgICBwb2ludGVyID0gZ2V0UHJvdG90eXBlT2YkMShwb2ludGVyKTsKICAgIH0KCiAgICByZXR1cm4gbnVsbDsKICB9CgogIGZ1bmN0aW9uIHNldE1vZGlmaWVyTWFuYWdlcihmYWN0b3J5LCBvYmopIHsKICAgIHJldHVybiBzZXRNYW5hZ2VyKHsKICAgICAgZmFjdG9yeTogZmFjdG9yeSwKICAgICAgaW50ZXJuYWw6IGZhbHNlLAogICAgICB0eXBlOiAnbW9kaWZpZXInCiAgICB9LCBvYmopOwogIH0KCiAgZnVuY3Rpb24gZ2V0TW9kaWZpZXJNYW5hZ2VyKG9iaikgewogICAgdmFyIHdyYXBwZXIgPSBnZXRNYW5hZ2VyKG9iaik7CgogICAgaWYgKHdyYXBwZXIgJiYgIXdyYXBwZXIuaW50ZXJuYWwgJiYgd3JhcHBlci50eXBlID09PSAnbW9kaWZpZXInKSB7CiAgICAgIHJldHVybiB3cmFwcGVyLmZhY3Rvcnk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW5zdHJ1bWVudGF0aW9uUGF5bG9hZCQxKG5hbWUpIHsKICAgIHJldHVybiB7CiAgICAgIG9iamVjdDogImNvbXBvbmVudDoiICsgbmFtZQogICAgfTsKICB9CgogIGZ1bmN0aW9uIG1ha2VPcHRpb25zKG1vZHVsZU5hbWUsIG5hbWVzcGFjZSkgewogICAgcmV0dXJuIHsKICAgICAgc291cmNlOiBtb2R1bGVOYW1lICE9PSB1bmRlZmluZWQgPyAidGVtcGxhdGU6IiArIG1vZHVsZU5hbWUgOiB1bmRlZmluZWQsCiAgICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gY29tcG9uZW50Rm9yKG5hbWUsIG93bmVyLCBvcHRpb25zKSB7CiAgICB2YXIgZnVsbE5hbWUgPSAiY29tcG9uZW50OiIgKyBuYW1lOwogICAgcmV0dXJuIG93bmVyLmZhY3RvcnlGb3IoZnVsbE5hbWUsIG9wdGlvbnMpIHx8IG51bGw7CiAgfQoKICBmdW5jdGlvbiBsYXlvdXRGb3IobmFtZSwgb3duZXIsIG9wdGlvbnMpIHsKICAgIHZhciB0ZW1wbGF0ZUZ1bGxOYW1lID0gInRlbXBsYXRlOmNvbXBvbmVudHMvIiArIG5hbWU7CiAgICByZXR1cm4gb3duZXIubG9va3VwKHRlbXBsYXRlRnVsbE5hbWUsIG9wdGlvbnMpIHx8IG51bGw7CiAgfQoKICBmdW5jdGlvbiBsb29rdXBDb21wb25lbnRQYWlyKG93bmVyLCBuYW1lLCBvcHRpb25zKSB7CiAgICB2YXIgY29tcG9uZW50ID0gY29tcG9uZW50Rm9yKG5hbWUsIG93bmVyLCBvcHRpb25zKTsKICAgIHsKICAgICAgaWYgKGNvbXBvbmVudCAhPT0gbnVsbCAmJiBjb21wb25lbnQuY2xhc3MgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhciBfbGF5b3V0MiA9IGdldENvbXBvbmVudFRlbXBsYXRlKGNvbXBvbmVudC5jbGFzcyk7CgogICAgICAgIGlmIChfbGF5b3V0MiAhPT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgY29tcG9uZW50OiBjb21wb25lbnQsCiAgICAgICAgICAgIGxheW91dDogX2xheW91dDIKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICB2YXIgbGF5b3V0ID0gbGF5b3V0Rm9yKG5hbWUsIG93bmVyLCBvcHRpb25zKTsKCiAgICBpZiAoY29tcG9uZW50ID09PSBudWxsICYmIGxheW91dCA9PT0gbnVsbCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgY29tcG9uZW50OiBjb21wb25lbnQsCiAgICAgICAgbGF5b3V0OiBsYXlvdXQKICAgICAgfTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGxvb2t1cENvbXBvbmVudChvd25lciwgbmFtZSwgb3B0aW9ucykgewogICAgaWYgKG9wdGlvbnMuc291cmNlIHx8IG9wdGlvbnMubmFtZXNwYWNlKSB7CiAgICAgIHZhciBwYWlyID0gbG9va3VwQ29tcG9uZW50UGFpcihvd25lciwgbmFtZSwgb3B0aW9ucyk7CgogICAgICBpZiAocGFpciAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiBwYWlyOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGxvb2t1cENvbXBvbmVudFBhaXIob3duZXIsIG5hbWUpOwogIH0KCiAgdmFyIEJVSUxUSU5TX0hFTFBFUlMgPSB7CiAgICBpZjogaW5saW5lSWYsCiAgICBhY3Rpb246IGFjdGlvbiwKICAgIGFycmF5OiBhcnJheSwKICAgIGNvbmNhdDogY29uY2F0JDEsCiAgICBmbjogZm4sCiAgICBnZXQ6IGdldCQxLAogICAgaGFzaDogaGFzaCwKICAgIGxvZzogbG9nJDEsCiAgICBtdXQ6IG11dCwKICAgICdxdWVyeS1wYXJhbXMnOiBxdWVyeVBhcmFtcyQxLAogICAgcmVhZG9ubHk6IHJlYWRvbmx5LAogICAgdW5ib3VuZDogdW5ib3VuZCwKICAgIHVubGVzczogaW5saW5lVW5sZXNzLAogICAgJy1jbGFzcyc6IGNsYXNzSGVscGVyJDEsCiAgICAnLWVhY2gtaW4nOiBlYWNoSW4sCiAgICAnLWlucHV0LXR5cGUnOiBpbnB1dFR5cGVIZWxwZXIkMSwKICAgICctbm9ybWFsaXplLWNsYXNzJzogbm9ybWFsaXplQ2xhc3NIZWxwZXIsCiAgICAnLWdldC1keW5hbWljLXZhcic6IF9ydW50aW1lMi5nZXREeW5hbWljVmFyLAogICAgJy1tb3VudCc6IG1vdW50SGVscGVyLAogICAgJy1vdXRsZXQnOiBvdXRsZXRIZWxwZXIsCiAgICAnLWFzc2VydC1pbXBsaWNpdC1jb21wb25lbnQtaGVscGVyLWFyZ3VtZW50JzogY29tcG9uZW50QXNzZXJ0aW9uSGVscGVyCiAgfTsKCiAgdmFyIFJ1bnRpbWVSZXNvbHZlciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFJ1bnRpbWVSZXNvbHZlcihpc0ludGVyYWN0aXZlKSB7CiAgICAgIHRoaXMuaGFuZGxlcyA9IFt1bmRlZmluZWRdOwogICAgICB0aGlzLm9ialRvSGFuZGxlID0gbmV3IFdlYWtNYXAoKTsKICAgICAgdGhpcy5idWlsdEluSGVscGVycyA9IEJVSUxUSU5TX0hFTFBFUlM7CiAgICAgIHRoaXMuY29tcG9uZW50RGVmaW5pdGlvbkNhY2hlID0gbmV3IE1hcCgpOwogICAgICB0aGlzLmNvbXBvbmVudERlZmluaXRpb25Db3VudCA9IDA7CiAgICAgIHRoaXMuaGVscGVyRGVmaW5pdGlvbkNvdW50ID0gMDsKICAgICAgdmFyIG1hY3JvcyA9IG5ldyBfb3Bjb2RlQ29tcGlsZXIuTWFjcm9zKCk7CiAgICAgIHBvcHVsYXRlTWFjcm9zKG1hY3Jvcyk7CiAgICAgIHRoaXMuY29tcGlsZXIgPSBuZXcgX29wY29kZUNvbXBpbGVyLkxhenlDb21waWxlcihuZXcgQ29tcGlsZVRpbWVMb29rdXAodGhpcyksIHRoaXMsIG1hY3Jvcyk7CiAgICAgIHRoaXMuaXNJbnRlcmFjdGl2ZSA9IGlzSW50ZXJhY3RpdmU7CiAgICAgIHRoaXMuYnVpbHRJbk1vZGlmaWVycyA9IHsKICAgICAgICBhY3Rpb246IHsKICAgICAgICAgIG1hbmFnZXI6IG5ldyBBY3Rpb25Nb2RpZmllck1hbmFnZXIoKSwKICAgICAgICAgIHN0YXRlOiBudWxsCiAgICAgICAgfSwKICAgICAgICBvbjogewogICAgICAgICAgbWFuYWdlcjogbmV3IE9uTW9kaWZpZXJNYW5hZ2VyKGlzSW50ZXJhY3RpdmUpLAogICAgICAgICAgc3RhdGU6IG51bGwKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICAvKioqICBJUnVudGltZVJlc29sdmVyICoqKi8KCiAgICAvKioKICAgICAqIHB1YmxpYyBjb21wb25lbnREZWZIYW5kbGVDb3VudCA9IDA7CiAgICAgKiBDYWxsZWQgd2hpbGUgZXhlY3V0aW5nIEFwcGVuZCBPcC5QdXNoRHluYW1pY0NvbXBvbmVudE1hbmFnZXIgaWYgc3RyaW5nCiAgICAgKi8KCgogICAgdmFyIF9wcm90bzcxID0gUnVudGltZVJlc29sdmVyLnByb3RvdHlwZTsKCiAgICBfcHJvdG83MS5sb29rdXBDb21wb25lbnREZWZpbml0aW9uID0gZnVuY3Rpb24gbG9va3VwQ29tcG9uZW50RGVmaW5pdGlvbihuYW1lLCBtZXRhKSB7CiAgICAgIHZhciBoYW5kbGUgPSB0aGlzLmxvb2t1cENvbXBvbmVudEhhbmRsZShuYW1lLCBtZXRhKTsKCiAgICAgIGlmIChoYW5kbGUgPT09IG51bGwpIHsKICAgICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJDb3VsZCBub3QgZmluZCBjb21wb25lbnQgbmFtZWQgXCIiICsgbmFtZSArICJcIiAobm8gY29tcG9uZW50IG9yIHRlbXBsYXRlIHdpdGggdGhhdCBuYW1lIHdhcyBmb3VuZCkiKSk7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLnJlc29sdmUoaGFuZGxlKTsKICAgIH07CgogICAgX3Byb3RvNzEubG9va3VwQ29tcG9uZW50SGFuZGxlID0gZnVuY3Rpb24gbG9va3VwQ29tcG9uZW50SGFuZGxlKG5hbWUsIG1ldGEpIHsKICAgICAgdmFyIG5leHRIYW5kbGUgPSB0aGlzLmhhbmRsZXMubGVuZ3RoOwogICAgICB2YXIgaGFuZGxlID0gdGhpcy5oYW5kbGUodGhpcy5fbG9va3VwQ29tcG9uZW50RGVmaW5pdGlvbihuYW1lLCBtZXRhKSk7CiAgICAgIChmYWxzZSAmJiAhKCEobmFtZSA9PT0gJ3RleHQtYXJlYScgJiYgaGFuZGxlID09PSBudWxsKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDb3VsZCBub3QgZmluZCBjb21wb25lbnQgYDxUZXh0QXJlYSAvPmAgKGRpZCB5b3UgbWVhbiBgPFRleHRhcmVhIC8+YD8pJywgIShuYW1lID09PSAndGV4dC1hcmVhJyAmJiBoYW5kbGUgPT09IG51bGwpKSk7CgogICAgICBpZiAobmV4dEhhbmRsZSA9PT0gaGFuZGxlKSB7CiAgICAgICAgdGhpcy5jb21wb25lbnREZWZpbml0aW9uQ291bnQrKzsKICAgICAgfQoKICAgICAgcmV0dXJuIGhhbmRsZTsKICAgIH0KICAgIC8qKgogICAgICogQ2FsbGVkIGJ5IFJ1bnRpbWVDb25zdGFudHMgdG8gbG9va3VwIHVucmVzb2x2ZWQgaGFuZGxlcy4KICAgICAqLwogICAgOwoKICAgIF9wcm90bzcxLnJlc29sdmUgPSBmdW5jdGlvbiByZXNvbHZlKGhhbmRsZSkgewogICAgICByZXR1cm4gdGhpcy5oYW5kbGVzW2hhbmRsZV07CiAgICB9IC8vIEVuZCBJUnVudGltZVJlc29sdmVyCgogICAgLyoqCiAgICAgKiBDYWxsZWQgYnkgQ29tcGlsZVRpbWVMb29rdXAgY29tcGlsaW5nIFVua25vd24gb3IgSGVscGVyIE9wQ29kZQogICAgICovCiAgICA7CgogICAgX3Byb3RvNzEubG9va3VwSGVscGVyID0gZnVuY3Rpb24gbG9va3VwSGVscGVyKG5hbWUsIG1ldGEpIHsKICAgICAgdmFyIG5leHRIYW5kbGUgPSB0aGlzLmhhbmRsZXMubGVuZ3RoOwoKICAgICAgdmFyIGhlbHBlciQkMSA9IHRoaXMuX2xvb2t1cEhlbHBlcihuYW1lLCBtZXRhKTsKCiAgICAgIGlmIChoZWxwZXIkJDEgIT09IG51bGwpIHsKICAgICAgICB2YXIgaGFuZGxlID0gdGhpcy5oYW5kbGUoaGVscGVyJCQxKTsKCiAgICAgICAgaWYgKG5leHRIYW5kbGUgPT09IGhhbmRsZSkgewogICAgICAgICAgdGhpcy5oZWxwZXJEZWZpbml0aW9uQ291bnQrKzsKICAgICAgICB9CgogICAgICAgIHJldHVybiBoYW5kbGU7CiAgICAgIH0KCiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgLyoqCiAgICAgKiBDYWxsZWQgYnkgQ29tcGlsZVRpbWVMb29rdXAgY29tcGlsaW5nIHRoZQogICAgICovCiAgICA7CgogICAgX3Byb3RvNzEubG9va3VwTW9kaWZpZXIgPSBmdW5jdGlvbiBsb29rdXBNb2RpZmllcihuYW1lLCBtZXRhKSB7CiAgICAgIHJldHVybiB0aGlzLmhhbmRsZSh0aGlzLl9sb29rdXBNb2RpZmllcihuYW1lLCBtZXRhKSk7CiAgICB9CiAgICAvKioKICAgICAqIENhbGxlZCBieSBDb21waWxlVGltZUxvb2t1cCB0byBsb29rdXAgcGFydGlhbAogICAgICovCiAgICA7CgogICAgX3Byb3RvNzEubG9va3VwUGFydGlhbCA9IGZ1bmN0aW9uIGxvb2t1cFBhcnRpYWwobmFtZSwgbWV0YSkgewogICAgICB2YXIgcGFydGlhbCA9IHRoaXMuX2xvb2t1cFBhcnRpYWwobmFtZSwgbWV0YSk7CgogICAgICByZXR1cm4gdGhpcy5oYW5kbGUocGFydGlhbCk7CiAgICB9IC8vIGVuZCBDb21waWxlVGltZUxvb2t1cAogICAgLy8gbmVlZGVkIGZvciBsYXp5IGNvbXBpbGUgdGltZSBsb29rdXAKICAgIDsKCiAgICBfcHJvdG83MS5oYW5kbGUgPSBmdW5jdGlvbiBoYW5kbGUob2JqKSB7CiAgICAgIGlmIChvYmogPT09IHVuZGVmaW5lZCB8fCBvYmogPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgdmFyIGhhbmRsZSA9IHRoaXMub2JqVG9IYW5kbGUuZ2V0KG9iaik7CgogICAgICBpZiAoaGFuZGxlID09PSB1bmRlZmluZWQpIHsKICAgICAgICBoYW5kbGUgPSB0aGlzLmhhbmRsZXMucHVzaChvYmopIC0gMTsKICAgICAgICB0aGlzLm9ialRvSGFuZGxlLnNldChvYmosIGhhbmRsZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBoYW5kbGU7CiAgICB9OwoKICAgIF9wcm90bzcxLl9sb29rdXBIZWxwZXIgPSBmdW5jdGlvbiBfbG9va3VwSGVscGVyKF9uYW1lLCBtZXRhKSB7CiAgICAgIHZhciBoZWxwZXIkJDEgPSB0aGlzLmJ1aWx0SW5IZWxwZXJzW19uYW1lXTsKCiAgICAgIGlmIChoZWxwZXIkJDEgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBoZWxwZXIkJDE7CiAgICAgIH0KCiAgICAgIHZhciBvd25lciA9IG1ldGEub3duZXIsCiAgICAgICAgICBtb2R1bGVOYW1lID0gbWV0YS5tb2R1bGVOYW1lOwogICAgICB2YXIgbmFtZSA9IF9uYW1lOwogICAgICB2YXIgbmFtZXNwYWNlID0gdW5kZWZpbmVkOwogICAgICB2YXIgb3B0aW9ucyA9IG1ha2VPcHRpb25zKG1vZHVsZU5hbWUsIG5hbWVzcGFjZSk7CiAgICAgIHZhciBmYWN0b3J5ID0gb3duZXIuZmFjdG9yeUZvcigiaGVscGVyOiIgKyBuYW1lLCBvcHRpb25zKSB8fCBvd25lci5mYWN0b3J5Rm9yKCJoZWxwZXI6IiArIG5hbWUpOwoKICAgICAgaWYgKCFpc0hlbHBlckZhY3RvcnkoZmFjdG9yeSkpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2bSwgYXJncykgewogICAgICAgIHZhciBoZWxwZXIkJDEgPSBmYWN0b3J5LmNyZWF0ZSgpOwoKICAgICAgICBpZiAoaXNTaW1wbGVIZWxwZXIoaGVscGVyJCQxKSkgewogICAgICAgICAgcmV0dXJuIFNpbXBsZUhlbHBlclJlZmVyZW5jZS5jcmVhdGUoaGVscGVyJCQxLmNvbXB1dGUsIGFyZ3MuY2FwdHVyZSgpKTsKICAgICAgICB9CgogICAgICAgIHZtLm5ld0Rlc3Ryb3lhYmxlKGhlbHBlciQkMSk7CiAgICAgICAgcmV0dXJuIENsYXNzQmFzZWRIZWxwZXJSZWZlcmVuY2UuY3JlYXRlKGhlbHBlciQkMSwgYXJncy5jYXB0dXJlKCkpOwogICAgICB9OwogICAgfTsKCiAgICBfcHJvdG83MS5fbG9va3VwUGFydGlhbCA9IGZ1bmN0aW9uIF9sb29rdXBQYXJ0aWFsKG5hbWUsIG1ldGEpIHsKICAgICAgdmFyIHRlbXBsYXRlRmFjdG9yeSQkMSA9ICgwLCBfdmlld3MubG9va3VwUGFydGlhbCkobmFtZSwgbWV0YS5vd25lcik7CiAgICAgIHZhciB0ZW1wbGF0ZSA9IHRlbXBsYXRlRmFjdG9yeSQkMShtZXRhLm93bmVyKTsKICAgICAgcmV0dXJuIG5ldyBfb3Bjb2RlQ29tcGlsZXIuUGFydGlhbERlZmluaXRpb24obmFtZSwgdGVtcGxhdGUpOwogICAgfTsKCiAgICBfcHJvdG83MS5fbG9va3VwTW9kaWZpZXIgPSBmdW5jdGlvbiBfbG9va3VwTW9kaWZpZXIobmFtZSwgbWV0YSkgewogICAgICB2YXIgYnVpbHRpbiA9IHRoaXMuYnVpbHRJbk1vZGlmaWVyc1tuYW1lXTsKCiAgICAgIGlmIChidWlsdGluID09PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgb3duZXIgPSBtZXRhLm93bmVyOwogICAgICAgIHZhciBtb2RpZmllciA9IG93bmVyLmZhY3RvcnlGb3IoIm1vZGlmaWVyOiIgKyBuYW1lKTsKCiAgICAgICAgaWYgKG1vZGlmaWVyICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciBtYW5hZ2VyRmFjdG9yeSA9IGdldE1vZGlmaWVyTWFuYWdlcihtb2RpZmllci5jbGFzcyk7CiAgICAgICAgICB2YXIgbWFuYWdlciA9IG1hbmFnZXJGYWN0b3J5KG93bmVyKTsKICAgICAgICAgIHJldHVybiBuZXcgQ3VzdG9tTW9kaWZpZXJEZWZpbml0aW9uKG5hbWUsIG1vZGlmaWVyLCBtYW5hZ2VyLCB0aGlzLmlzSW50ZXJhY3RpdmUpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGJ1aWx0aW47CiAgICB9OwoKICAgIF9wcm90bzcxLl9wYXJzZU5hbWVGb3JOYW1lc3BhY2UgPSBmdW5jdGlvbiBfcGFyc2VOYW1lRm9yTmFtZXNwYWNlKF9uYW1lKSB7CiAgICAgIHZhciBuYW1lID0gX25hbWU7CiAgICAgIHZhciBuYW1lc3BhY2UgPSB1bmRlZmluZWQ7CgogICAgICB2YXIgbmFtZXNwYWNlRGVsaW1pdGVyT2Zmc2V0ID0gX25hbWUuaW5kZXhPZignOjonKTsKCiAgICAgIGlmIChuYW1lc3BhY2VEZWxpbWl0ZXJPZmZzZXQgIT09IC0xKSB7CiAgICAgICAgbmFtZSA9IF9uYW1lLnNsaWNlKG5hbWVzcGFjZURlbGltaXRlck9mZnNldCArIDIpOwogICAgICAgIG5hbWVzcGFjZSA9IF9uYW1lLnNsaWNlKDAsIG5hbWVzcGFjZURlbGltaXRlck9mZnNldCk7CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZQogICAgICB9OwogICAgfTsKCiAgICBfcHJvdG83MS5fbG9va3VwQ29tcG9uZW50RGVmaW5pdGlvbiA9IGZ1bmN0aW9uIF9sb29rdXBDb21wb25lbnREZWZpbml0aW9uKF9uYW1lLCBfcmVmMzUpIHsKICAgICAgdmFyIG1vZHVsZU5hbWUgPSBfcmVmMzUubW9kdWxlTmFtZSwKICAgICAgICAgIG93bmVyID0gX3JlZjM1Lm93bmVyOwogICAgICB2YXIgbmFtZSA9IF9uYW1lOwogICAgICB2YXIgbmFtZXNwYWNlID0gdW5kZWZpbmVkOwogICAgICB2YXIgcGFpciA9IGxvb2t1cENvbXBvbmVudChvd25lciwgbmFtZSwgbWFrZU9wdGlvbnMobW9kdWxlTmFtZSwgbmFtZXNwYWNlKSk7CgogICAgICBpZiAocGFpciA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICB2YXIgbGF5b3V0ID0gbnVsbDsKICAgICAgdmFyIGtleTsKCiAgICAgIGlmIChwYWlyLmNvbXBvbmVudCA9PT0gbnVsbCkgewogICAgICAgIGtleSA9IGxheW91dCA9IHBhaXIubGF5b3V0KG93bmVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBrZXkgPSBwYWlyLmNvbXBvbmVudDsKICAgICAgfQoKICAgICAgdmFyIGNhY2hlZENvbXBvbmVudERlZmluaXRpb24gPSB0aGlzLmNvbXBvbmVudERlZmluaXRpb25DYWNoZS5nZXQoa2V5KTsKCiAgICAgIGlmIChjYWNoZWRDb21wb25lbnREZWZpbml0aW9uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gY2FjaGVkQ29tcG9uZW50RGVmaW5pdGlvbjsKICAgICAgfQoKICAgICAgaWYgKGxheW91dCA9PT0gbnVsbCAmJiBwYWlyLmxheW91dCAhPT0gbnVsbCkgewogICAgICAgIGxheW91dCA9IHBhaXIubGF5b3V0KG93bmVyKTsKICAgICAgfQoKICAgICAgdmFyIGZpbmFsaXplciA9ICgwLCBfaW5zdHJ1bWVudGF0aW9uLl9pbnN0cnVtZW50U3RhcnQpKCdyZW5kZXIuZ2V0Q29tcG9uZW50RGVmaW5pdGlvbicsIGluc3RydW1lbnRhdGlvblBheWxvYWQkMSwgbmFtZSk7CiAgICAgIHZhciBkZWZpbml0aW9uID0gbnVsbDsKCiAgICAgIGlmIChwYWlyLmNvbXBvbmVudCA9PT0gbnVsbCkgewogICAgICAgIGlmIChfZW52aXJvbm1lbnQyLkVOVi5fVEVNUExBVEVfT05MWV9HTElNTUVSX0NPTVBPTkVOVFMpIHsKICAgICAgICAgIGRlZmluaXRpb24gPSBuZXcgVGVtcGxhdGVPbmx5Q29tcG9uZW50RGVmaW5pdGlvbihuYW1lLCBsYXlvdXQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0cnVlCiAgICAgIC8qIEVNQkVSX0dMSU1NRVJfU0VUX0NPTVBPTkVOVF9URU1QTEFURSAqLwogICAgICAmJiAoMCwgX3RlbXBsYXRlT25seS5pc1RlbXBsYXRlT25seUNvbXBvbmVudCkocGFpci5jb21wb25lbnQuY2xhc3MpKSB7CiAgICAgICAgZGVmaW5pdGlvbiA9IG5ldyBUZW1wbGF0ZU9ubHlDb21wb25lbnREZWZpbml0aW9uKG5hbWUsIGxheW91dCk7CiAgICAgIH0KCiAgICAgIGlmIChwYWlyLmNvbXBvbmVudCAhPT0gbnVsbCkgewogICAgICAgIChmYWxzZSAmJiAhKHBhaXIuY29tcG9uZW50LmNsYXNzICE9PSB1bmRlZmluZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgibWlzc2luZyBjb21wb25lbnQgY2xhc3MgIiArIG5hbWUsIHBhaXIuY29tcG9uZW50LmNsYXNzICE9PSB1bmRlZmluZWQpKTsKICAgICAgICB2YXIgQ29tcG9uZW50Q2xhc3MgPSBwYWlyLmNvbXBvbmVudC5jbGFzczsKICAgICAgICB2YXIgd3JhcHBlciA9IGdldE1hbmFnZXIoQ29tcG9uZW50Q2xhc3MpOwoKICAgICAgICBpZiAod3JhcHBlciAhPT0gbnVsbCAmJiB3cmFwcGVyLnR5cGUgPT09ICdjb21wb25lbnQnKSB7CiAgICAgICAgICB2YXIgZmFjdG9yeSA9IHdyYXBwZXIuZmFjdG9yeTsKCiAgICAgICAgICBpZiAod3JhcHBlci5pbnRlcm5hbCkgewogICAgICAgICAgICAoZmFsc2UgJiYgIShwYWlyLmxheW91dCAhPT0gbnVsbCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJtaXNzaW5nIGxheW91dCBmb3IgaW50ZXJuYWwgY29tcG9uZW50ICIgKyBuYW1lLCBwYWlyLmxheW91dCAhPT0gbnVsbCkpOwogICAgICAgICAgICBkZWZpbml0aW9uID0gbmV3IEludGVybmFsQ29tcG9uZW50RGVmaW5pdGlvbihmYWN0b3J5KG93bmVyKSwgQ29tcG9uZW50Q2xhc3MsIGxheW91dCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkZWZpbml0aW9uID0gbmV3IEN1c3RvbU1hbmFnZXJEZWZpbml0aW9uKG5hbWUsIHBhaXIuY29tcG9uZW50LCBmYWN0b3J5KG93bmVyKSwgbGF5b3V0ICE9PSBudWxsID8gbGF5b3V0IDogb3duZXIubG9va3VwKCgwLCBfY29udGFpbmVyLnByaXZhdGl6ZSkoX3RlbXBsYXRlT2JqZWN0MygpKSkob3duZXIpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChkZWZpbml0aW9uID09PSBudWxsKSB7CiAgICAgICAgZGVmaW5pdGlvbiA9IG5ldyBDdXJseUNvbXBvbmVudERlZmluaXRpb24obmFtZSwgcGFpci5jb21wb25lbnQgfHwgb3duZXIuZmFjdG9yeUZvcigoMCwgX2NvbnRhaW5lci5wcml2YXRpemUpKF90ZW1wbGF0ZU9iamVjdDQoKSkpLCBudWxsLCBsYXlvdXQpOwogICAgICB9CgogICAgICBmaW5hbGl6ZXIoKTsKICAgICAgdGhpcy5jb21wb25lbnREZWZpbml0aW9uQ2FjaGUuc2V0KGtleSwgZGVmaW5pdGlvbik7CiAgICAgIHJldHVybiBkZWZpbml0aW9uOwogICAgfTsKCiAgICByZXR1cm4gUnVudGltZVJlc29sdmVyOwogIH0oKTsKCiAgdmFyIFRlbXBsYXRlQ29tcGlsZXIgPSB7CiAgICBjcmVhdGU6IGZ1bmN0aW9uIGNyZWF0ZShfcmVmMzYpIHsKICAgICAgdmFyIGVudmlyb25tZW50ID0gX3JlZjM2LmVudmlyb25tZW50OwogICAgICByZXR1cm4gbmV3IFJ1bnRpbWVSZXNvbHZlcihlbnZpcm9ubWVudC5pc0ludGVyYWN0aXZlKS5jb21waWxlcjsKICAgIH0KICB9OwogIHZhciBDb21wb25lbnRUZW1wbGF0ZSA9IHRlbXBsYXRlKHsKICAgICJpZCI6ICJjaGZRY0g4MyIsCiAgICAiYmxvY2siOiAie1wic3ltYm9sc1wiOltcIiZkZWZhdWx0XCJdLFwic3RhdGVtZW50c1wiOltbMTQsMV1dLFwiaGFzRXZhbFwiOmZhbHNlfSIsCiAgICAibWV0YSI6IHsKICAgICAgIm1vZHVsZU5hbWUiOiAicGFja2FnZXMvQGVtYmVyLy1pbnRlcm5hbHMvZ2xpbW1lci9saWIvdGVtcGxhdGVzL2NvbXBvbmVudC5oYnMiCiAgICB9CiAgfSk7CiAgdmFyIElucHV0VGVtcGxhdGUgPSB0ZW1wbGF0ZSh7CiAgICAiaWQiOiAiTldaekxTSUkiLAogICAgImJsb2NrIjogIntcInN5bWJvbHNcIjpbXCJDaGVja2JveFwiLFwiVGV4dEZpZWxkXCIsXCJAX19BUkdTX19cIixcIiZhdHRyc1wiXSxcInN0YXRlbWVudHNcIjpbWzQsXCJsZXRcIixbWzI4LFwiY29tcG9uZW50XCIsW1wiLWNoZWNrYm94XCJdLG51bGxdLFsyOCxcImNvbXBvbmVudFwiLFtcIi10ZXh0LWZpZWxkXCJdLG51bGxdXSxudWxsLHtcInN0YXRlbWVudHNcIjpbWzQsXCJpZlwiLFtbMjMsMCxbXCJpc0NoZWNrYm94XCJdXV0sbnVsbCx7XCJzdGF0ZW1lbnRzXCI6W1s2LFsyMywxLFtdXSxbWzEzLDRdXSxbW1wiQHRhcmdldFwiLFwiQF9fQVJHU19fXCJdLFtbMjMsMCxbXCJjYWxsZXJcIl1dLFsyMywzLFtdXV1dXV0sXCJwYXJhbWV0ZXJzXCI6W119LHtcInN0YXRlbWVudHNcIjpbWzYsWzIzLDIsW11dLFtbMTMsNF1dLFtbXCJAdGFyZ2V0XCIsXCJAX19BUkdTX19cIl0sW1syMywwLFtcImNhbGxlclwiXV0sWzIzLDMsW11dXV1dXSxcInBhcmFtZXRlcnNcIjpbXX1dXSxcInBhcmFtZXRlcnNcIjpbMSwyXX0sbnVsbF1dLFwiaGFzRXZhbFwiOmZhbHNlfSIsCiAgICAibWV0YSI6IHsKICAgICAgIm1vZHVsZU5hbWUiOiAicGFja2FnZXMvQGVtYmVyLy1pbnRlcm5hbHMvZ2xpbW1lci9saWIvdGVtcGxhdGVzL2lucHV0LmhicyIKICAgIH0KICB9KTsKICB2YXIgT3V0bGV0VGVtcGxhdGUgPSB0ZW1wbGF0ZSh7CiAgICAiaWQiOiAiZmZBTDZIRGwiLAogICAgImJsb2NrIjogIntcInN5bWJvbHNcIjpbXSxcInN0YXRlbWVudHNcIjpbWzEsWzIyLFwib3V0bGV0XCJdLGZhbHNlXV0sXCJoYXNFdmFsXCI6ZmFsc2V9IiwKICAgICJtZXRhIjogewogICAgICAibW9kdWxlTmFtZSI6ICJwYWNrYWdlcy9AZW1iZXIvLWludGVybmFscy9nbGltbWVyL2xpYi90ZW1wbGF0ZXMvb3V0bGV0LmhicyIKICAgIH0KICB9KTsKICB2YXIgVE9QX0xFVkVMX05BTUUgPSAnLXRvcC1sZXZlbCc7CiAgdmFyIFRPUF9MRVZFTF9PVVRMRVQgPSAnbWFpbic7CgogIHZhciBPdXRsZXRWaWV3ID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gT3V0bGV0VmlldyhfZW52aXJvbm1lbnQsIHJlbmRlcmVyLCBvd25lciwgdGVtcGxhdGUpIHsKICAgICAgdGhpcy5fZW52aXJvbm1lbnQgPSBfZW52aXJvbm1lbnQ7CiAgICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlcjsKICAgICAgdGhpcy5vd25lciA9IG93bmVyOwogICAgICB0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CiAgICAgIHZhciByZWYgPSB0aGlzLnJlZiA9IG5ldyBSb290T3V0bGV0UmVmZXJlbmNlKHsKICAgICAgICBvdXRsZXRzOiB7CiAgICAgICAgICBtYWluOiB1bmRlZmluZWQKICAgICAgICB9LAogICAgICAgIHJlbmRlcjogewogICAgICAgICAgb3duZXI6IG93bmVyLAogICAgICAgICAgaW50bzogdW5kZWZpbmVkLAogICAgICAgICAgb3V0bGV0OiBUT1BfTEVWRUxfT1VUTEVULAogICAgICAgICAgbmFtZTogVE9QX0xFVkVMX05BTUUsCiAgICAgICAgICBjb250cm9sbGVyOiB1bmRlZmluZWQsCiAgICAgICAgICBtb2RlbDogdW5kZWZpbmVkLAogICAgICAgICAgdGVtcGxhdGU6IHRlbXBsYXRlCiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhpcy5zdGF0ZSA9IHsKICAgICAgICByZWY6IHJlZiwKICAgICAgICBuYW1lOiBUT1BfTEVWRUxfTkFNRSwKICAgICAgICBvdXRsZXQ6IFRPUF9MRVZFTF9PVVRMRVQsCiAgICAgICAgdGVtcGxhdGU6IHRlbXBsYXRlLAogICAgICAgIGNvbnRyb2xsZXI6IHVuZGVmaW5lZCwKICAgICAgICBtb2RlbDogdW5kZWZpbmVkCiAgICAgIH07CiAgICB9CgogICAgT3V0bGV0Vmlldy5leHRlbmQgPSBmdW5jdGlvbiBleHRlbmQoaW5qZWN0aW9ucykgewogICAgICByZXR1cm4gKAogICAgICAgIC8qI19fUFVSRV9fKi8KICAgICAgICBmdW5jdGlvbiAoX091dGxldFZpZXcpIHsKICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShfY2xhc3MsIF9PdXRsZXRWaWV3KTsKCiAgICAgICAgICBmdW5jdGlvbiBfY2xhc3MoKSB7CiAgICAgICAgICAgIHJldHVybiBfT3V0bGV0Vmlldy5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICAgICAgICB9CgogICAgICAgICAgX2NsYXNzLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShvcHRpb25zKSB7CiAgICAgICAgICAgIGlmIChvcHRpb25zKSB7CiAgICAgICAgICAgICAgcmV0dXJuIF9PdXRsZXRWaWV3LmNyZWF0ZS5jYWxsKHRoaXMsICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIGluamVjdGlvbnMsIG9wdGlvbnMpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gX091dGxldFZpZXcuY3JlYXRlLmNhbGwodGhpcywgaW5qZWN0aW9ucyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgcmV0dXJuIF9jbGFzczsKICAgICAgICB9KE91dGxldFZpZXcpCiAgICAgICk7CiAgICB9OwoKICAgIE91dGxldFZpZXcucmVvcGVuQ2xhc3MgPSBmdW5jdGlvbiByZW9wZW5DbGFzcyhpbmplY3Rpb25zKSB7CiAgICAgICgwLCBfcG9seWZpbGxzLmFzc2lnbikodGhpcywgaW5qZWN0aW9ucyk7CiAgICB9OwoKICAgIE91dGxldFZpZXcuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKG9wdGlvbnMpIHsKICAgICAgdmFyIF9lbnZpcm9ubWVudCA9IG9wdGlvbnMuX2Vudmlyb25tZW50LAogICAgICAgICAgcmVuZGVyZXIgPSBvcHRpb25zLnJlbmRlcmVyLAogICAgICAgICAgdGVtcGxhdGVGYWN0b3J5JCQxID0gb3B0aW9ucy50ZW1wbGF0ZTsKICAgICAgdmFyIG93bmVyID0gb3B0aW9uc1tfb3duZXIuT1dORVJdOwogICAgICB2YXIgdGVtcGxhdGUgPSB0ZW1wbGF0ZUZhY3RvcnkkJDEob3duZXIpOwogICAgICByZXR1cm4gbmV3IE91dGxldFZpZXcoX2Vudmlyb25tZW50LCByZW5kZXJlciwgb3duZXIsIHRlbXBsYXRlKTsKICAgIH07CgogICAgdmFyIF9wcm90bzcyID0gT3V0bGV0Vmlldy5wcm90b3R5cGU7CgogICAgX3Byb3RvNzIuYXBwZW5kVG8gPSBmdW5jdGlvbiBhcHBlbmRUbyhzZWxlY3RvcikgewogICAgICB2YXIgdGFyZ2V0OwoKICAgICAgaWYgKHRoaXMuX2Vudmlyb25tZW50Lmhhc0RPTSkgewogICAgICAgIHRhcmdldCA9IHR5cGVvZiBzZWxlY3RvciA9PT0gJ3N0cmluZycgPyBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKSA6IHNlbGVjdG9yOwogICAgICB9IGVsc2UgewogICAgICAgIHRhcmdldCA9IHNlbGVjdG9yOwogICAgICB9CgogICAgICAoMCwgX3J1bmxvb3Auc2NoZWR1bGUpKCdyZW5kZXInLCB0aGlzLnJlbmRlcmVyLCAnYXBwZW5kT3V0bGV0VmlldycsIHRoaXMsIHRhcmdldCk7CiAgICB9OwoKICAgIF9wcm90bzcyLnJlcmVuZGVyID0gZnVuY3Rpb24gcmVyZW5kZXIoKSB7CiAgICAgIC8qKi8KICAgIH07CgogICAgX3Byb3RvNzIuc2V0T3V0bGV0U3RhdGUgPSBmdW5jdGlvbiBzZXRPdXRsZXRTdGF0ZShzdGF0ZSkgewogICAgICB0aGlzLnJlZi51cGRhdGUoc3RhdGUpOwogICAgfTsKCiAgICBfcHJvdG83Mi5kZXN0cm95ID0gZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgLyoqLwogICAgfTsKCiAgICByZXR1cm4gT3V0bGV0VmlldzsKICB9KCk7CgogIF9leHBvcnRzLk91dGxldFZpZXcgPSBPdXRsZXRWaWV3OwoKICBmdW5jdGlvbiBzZXR1cEFwcGxpY2F0aW9uUmVnaXN0cnkocmVnaXN0cnkpIHsKICAgIHJlZ2lzdHJ5LmluamVjdGlvbignc2VydmljZTotZ2xpbW1lci1lbnZpcm9ubWVudCcsICdhcHBlbmRPcGVyYXRpb25zJywgJ3NlcnZpY2U6LWRvbS10cmVlLWNvbnN0cnVjdGlvbicpOwogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdyZW5kZXJlcicsICdlbnYnLCAnc2VydmljZTotZ2xpbW1lci1lbnZpcm9ubWVudCcpOyAvLyBiZWNhdXNlIHdlIGFyZSB1c2luZyBpbmplY3Rpb25zIHdlIGNhbid0IHVzZSBpbnN0YW50aWF0ZSBmYWxzZQogICAgLy8gd2UgbmVlZCB0byB1c2UgYmluZCgpIHRvIGNvcHkgdGhlIGZ1bmN0aW9uIHNvIGZhY3RvcnkgZm9yCiAgICAvLyBhc3NvY2lhdGlvbiB3b24ndCBsZWFrCgogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3NlcnZpY2U6LWRvbS1idWlsZGVyJywgewogICAgICBjcmVhdGU6IGZ1bmN0aW9uIGNyZWF0ZShfcmVmMzcpIHsKICAgICAgICB2YXIgYm9vdE9wdGlvbnMgPSBfcmVmMzcuYm9vdE9wdGlvbnM7CiAgICAgICAgdmFyIF9yZW5kZXJNb2RlID0gYm9vdE9wdGlvbnMuX3JlbmRlck1vZGU7CgogICAgICAgIHN3aXRjaCAoX3JlbmRlck1vZGUpIHsKICAgICAgICAgIGNhc2UgJ3NlcmlhbGl6ZSc6CiAgICAgICAgICAgIHJldHVybiBfbm9kZS5zZXJpYWxpemVCdWlsZGVyLmJpbmQobnVsbCk7CgogICAgICAgICAgY2FzZSAncmVoeWRyYXRlJzoKICAgICAgICAgICAgcmV0dXJuIF9ydW50aW1lMi5yZWh5ZHJhdGlvbkJ1aWxkZXIuYmluZChudWxsKTsKCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICByZXR1cm4gX3J1bnRpbWUyLmNsaWVudEJ1aWxkZXIuYmluZChudWxsKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdzZXJ2aWNlOi1kb20tYnVpbGRlcicsICdib290T3B0aW9ucycsICctZW52aXJvbm1lbnQ6bWFpbicpOwogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdyZW5kZXJlcicsICdidWlsZGVyJywgJ3NlcnZpY2U6LWRvbS1idWlsZGVyJyk7CiAgICByZWdpc3RyeS5yZWdpc3RlcigoMCwgX2NvbnRhaW5lci5wcml2YXRpemUpKF90ZW1wbGF0ZU9iamVjdDUoKSksIFJvb3RUZW1wbGF0ZSk7CiAgICByZWdpc3RyeS5pbmplY3Rpb24oJ3JlbmRlcmVyJywgJ3Jvb3RUZW1wbGF0ZScsICgwLCBfY29udGFpbmVyLnByaXZhdGl6ZSkoX3RlbXBsYXRlT2JqZWN0NigpKSk7CiAgICByZWdpc3RyeS5yZWdpc3RlcigncmVuZGVyZXI6LWRvbScsIEludGVyYWN0aXZlUmVuZGVyZXIpOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3JlbmRlcmVyOi1pbmVydCcsIEluZXJ0UmVuZGVyZXIpOwoKICAgIGlmIChfYnJvd3NlckVudmlyb25tZW50Lmhhc0RPTSkgewogICAgICByZWdpc3RyeS5pbmplY3Rpb24oJ3NlcnZpY2U6LWdsaW1tZXItZW52aXJvbm1lbnQnLCAndXBkYXRlT3BlcmF0aW9ucycsICdzZXJ2aWNlOi1kb20tY2hhbmdlcycpOwogICAgfQoKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdzZXJ2aWNlOi1kb20tY2hhbmdlcycsIHsKICAgICAgY3JlYXRlOiBmdW5jdGlvbiBjcmVhdGUoX3JlZjM4KSB7CiAgICAgICAgdmFyIGRvY3VtZW50ID0gX3JlZjM4LmRvY3VtZW50OwogICAgICAgIHJldHVybiBuZXcgX3J1bnRpbWUyLkRPTUNoYW5nZXMoZG9jdW1lbnQpOwogICAgICB9CiAgICB9KTsKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdzZXJ2aWNlOi1kb20tdHJlZS1jb25zdHJ1Y3Rpb24nLCB7CiAgICAgIGNyZWF0ZTogZnVuY3Rpb24gY3JlYXRlKF9yZWYzOSkgewogICAgICAgIHZhciBkb2N1bWVudCA9IF9yZWYzOS5kb2N1bWVudDsKICAgICAgICB2YXIgSW1wbGVtZW50YXRpb24gPSBfYnJvd3NlckVudmlyb25tZW50Lmhhc0RPTSA/IF9ydW50aW1lMi5ET01UcmVlQ29uc3RydWN0aW9uIDogX25vZGUuTm9kZURPTVRyZWVDb25zdHJ1Y3Rpb247CiAgICAgICAgcmV0dXJuIG5ldyBJbXBsZW1lbnRhdGlvbihkb2N1bWVudCk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gc2V0dXBFbmdpbmVSZWdpc3RyeShyZWdpc3RyeSkgewogICAgcmVnaXN0cnkub3B0aW9uc0ZvclR5cGUoJ3RlbXBsYXRlJywgewogICAgICBpbnN0YW50aWF0ZTogZmFsc2UKICAgIH0pOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3ZpZXc6LW91dGxldCcsIE91dGxldFZpZXcpOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3RlbXBsYXRlOi1vdXRsZXQnLCBPdXRsZXRUZW1wbGF0ZSk7CiAgICByZWdpc3RyeS5pbmplY3Rpb24oJ3ZpZXc6LW91dGxldCcsICd0ZW1wbGF0ZScsICd0ZW1wbGF0ZTotb3V0bGV0Jyk7CiAgICByZWdpc3RyeS5pbmplY3Rpb24oJ3NlcnZpY2U6LWRvbS1jaGFuZ2VzJywgJ2RvY3VtZW50JywgJ3NlcnZpY2U6LWRvY3VtZW50Jyk7CiAgICByZWdpc3RyeS5pbmplY3Rpb24oJ3NlcnZpY2U6LWRvbS10cmVlLWNvbnN0cnVjdGlvbicsICdkb2N1bWVudCcsICdzZXJ2aWNlOi1kb2N1bWVudCcpOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoKDAsIF9jb250YWluZXIucHJpdmF0aXplKShfdGVtcGxhdGVPYmplY3Q3KCkpLCBDb21wb25lbnRUZW1wbGF0ZSk7CiAgICByZWdpc3RyeS5yZWdpc3Rlcignc2VydmljZTotZ2xpbW1lci1lbnZpcm9ubWVudCcsIEVudmlyb25tZW50JDEpOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoKDAsIF9jb250YWluZXIucHJpdmF0aXplKShfdGVtcGxhdGVPYmplY3Q4KCkpLCBUZW1wbGF0ZUNvbXBpbGVyKTsKICAgIHJlZ2lzdHJ5LmluamVjdGlvbigoMCwgX2NvbnRhaW5lci5wcml2YXRpemUpKF90ZW1wbGF0ZU9iamVjdDkoKSksICdlbnZpcm9ubWVudCcsICctZW52aXJvbm1lbnQ6bWFpbicpOwogICAgcmVnaXN0cnkub3B0aW9uc0ZvclR5cGUoJ2hlbHBlcicsIHsKICAgICAgaW5zdGFudGlhdGU6IGZhbHNlCiAgICB9KTsKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdoZWxwZXI6bG9jJywgbG9jJDEpOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2NvbXBvbmVudDotdGV4dC1maWVsZCcsIFRleHRGaWVsZCk7CiAgICByZWdpc3RyeS5yZWdpc3RlcignY29tcG9uZW50Oi1jaGVja2JveCcsIENoZWNrYm94KTsKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdjb21wb25lbnQ6bGluay10bycsIExpbmtDb21wb25lbnQpOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2NvbXBvbmVudDppbnB1dCcsIElucHV0KTsKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCd0ZW1wbGF0ZTpjb21wb25lbnRzL2lucHV0JywgSW5wdXRUZW1wbGF0ZSk7CiAgICByZWdpc3RyeS5yZWdpc3RlcignY29tcG9uZW50OnRleHRhcmVhJywgVGV4dEFyZWEpOwoKICAgIGlmICghX2Vudmlyb25tZW50Mi5FTlYuX1RFTVBMQVRFX09OTFlfR0xJTU1FUl9DT01QT05FTlRTKSB7CiAgICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCgwLCBfY29udGFpbmVyLnByaXZhdGl6ZSkoX3RlbXBsYXRlT2JqZWN0MTAoKSksIENvbXBvbmVudCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBzZXRDb21wb25lbnRNYW5hZ2VyKHN0cmluZ09yRnVuY3Rpb24sIG9iaikgewogICAgdmFyIGZhY3Rvcnk7CgogICAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuQ09NUE9ORU5UX01BTkFHRVJfU1RSSU5HX0xPT0tVUCAmJiB0eXBlb2Ygc3RyaW5nT3JGdW5jdGlvbiA9PT0gJ3N0cmluZycpIHsKICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgnUGFzc2luZyB0aGUgbmFtZSBvZiB0aGUgY29tcG9uZW50IG1hbmFnZXIgdG8gInNldHVwQ29tcG9uZW50TWFuYWdlciIgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIHBhc3MgYSBmdW5jdGlvbiB0aGF0IHByb2R1Y2VzIGFuIGluc3RhbmNlIG9mIHRoZSBtYW5hZ2VyLicsIGZhbHNlLCB7CiAgICAgICAgaWQ6ICdkZXByZWNhdGUtc3RyaW5nLWJhc2VkLWNvbXBvbmVudC1tYW5hZ2VyJywKICAgICAgICB1bnRpbDogJzQuMC4wJywKICAgICAgICB1cmw6ICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92My54LyN0b2NfY29tcG9uZW50LW1hbmFnZXItc3RyaW5nLWxvb2t1cCcKICAgICAgfSkpOwoKICAgICAgZmFjdG9yeSA9IGZ1bmN0aW9uIGZhY3Rvcnkob3duZXIpIHsKICAgICAgICByZXR1cm4gb3duZXIubG9va3VwKCJjb21wb25lbnQtbWFuYWdlcjoiICsgc3RyaW5nT3JGdW5jdGlvbik7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBmYWN0b3J5ID0gc3RyaW5nT3JGdW5jdGlvbjsKICAgIH0KCiAgICByZXR1cm4gc2V0TWFuYWdlcih7CiAgICAgIGZhY3Rvcnk6IGZhY3RvcnksCiAgICAgIGludGVybmFsOiBmYWxzZSwKICAgICAgdHlwZTogJ2NvbXBvbmVudCcKICAgIH0sIG9iaik7CiAgfQoKICBmdW5jdGlvbiBnZXRDb21wb25lbnRNYW5hZ2VyKG9iaikgewogICAgdmFyIHdyYXBwZXIgPSBnZXRNYW5hZ2VyKG9iaik7CgogICAgaWYgKHdyYXBwZXIgJiYgIXdyYXBwZXIuaW50ZXJuYWwgJiYgd3JhcHBlci50eXBlID09PSAnY29tcG9uZW50JykgewogICAgICByZXR1cm4gd3JhcHBlci5mYWN0b3J5OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KICB9CiAgLyoqCiAgICBbR2xpbW1lcl0oaHR0cHM6Ly9naXRodWIuY29tL3RpbGRlaW8vZ2xpbW1lcikgaXMgYSB0ZW1wbGF0aW5nIGVuZ2luZSB1c2VkIGJ5IEVtYmVyLmpzIHRoYXQgaXMgY29tcGF0aWJsZSB3aXRoIGEgc3Vic2V0IG9mIHRoZSBbSGFuZGxlYmFyc10oaHR0cDovL2hhbmRsZWJhcnNqcy5jb20vKSBzeW50YXguCiAgCiAgICAjIyMgU2hvd2luZyBhIHByb3BlcnR5CiAgCiAgICBUZW1wbGF0ZXMgbWFuYWdlIHRoZSBmbG93IG9mIGFuIGFwcGxpY2F0aW9uJ3MgVUksIGFuZCBkaXNwbGF5IHN0YXRlICh0aHJvdWdoCiAgICB0aGUgRE9NKSB0byBhIHVzZXIuIEZvciBleGFtcGxlLCBnaXZlbiBhIGNvbXBvbmVudCB3aXRoIHRoZSBwcm9wZXJ0eSAibmFtZSIsCiAgICB0aGF0IGNvbXBvbmVudCdzIHRlbXBsYXRlIGNhbiB1c2UgdGhlIG5hbWUgaW4gc2V2ZXJhbCB3YXlzOgogIAogICAgYGBgYXBwL2NvbXBvbmVudHMvcGVyc29uLXByb2ZpbGUuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgbmFtZTogJ0ppbGwnCiAgICB9KTsKICAgIGBgYAogIAogICAgYGBgYXBwL3RlbXBsYXRlcy9jb21wb25lbnRzL3BlcnNvbi1wcm9maWxlLmhicwogICAge3tuYW1lfX0KICAgIDxkaXY+e3tuYW1lfX08L2Rpdj4KICAgIDxzcGFuIGRhdGEtbmFtZT17e25hbWV9fT48L3NwYW4+CiAgICBgYGAKICAKICAgIEFueSB0aW1lIHRoZSAibmFtZSIgcHJvcGVydHkgb24gdGhlIGNvbXBvbmVudCBjaGFuZ2VzLCB0aGUgRE9NIHdpbGwgYmUKICAgIHVwZGF0ZWQuCiAgCiAgICBQcm9wZXJ0aWVzIGNhbiBiZSBjaGFpbmVkIGFzIHdlbGw6CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICB7e2FVc2VyTW9kZWwubmFtZX19CiAgICA8ZGl2Pnt7bGlzdE9mVXNlcnMuZmlyc3RPYmplY3QubmFtZX19PC9kaXY+CiAgICBgYGAKICAKICAgICMjIyBVc2luZyBFbWJlciBoZWxwZXJzCiAgCiAgICBXaGVuIGNvbnRlbnQgaXMgcGFzc2VkIGluIG11c3RhY2hlcyBge3t9fWAsIEVtYmVyIHdpbGwgZmlyc3QgdHJ5IHRvIGZpbmQgYSBoZWxwZXIKICAgIG9yIGNvbXBvbmVudCB3aXRoIHRoYXQgbmFtZS4gRm9yIGV4YW1wbGUsIHRoZSBgaWZgIGhlbHBlcjoKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIHt7aWYgbmFtZSAiSSBoYXZlIGEgbmFtZSIgIkkgaGF2ZSBubyBuYW1lIn19CiAgICA8c3BhbiBkYXRhLWhhcy1uYW1lPXt7aWYgbmFtZSB0cnVlfX0+PC9zcGFuPgogICAgYGBgCiAgCiAgICBUaGUgcmV0dXJuZWQgdmFsdWUgaXMgcGxhY2VkIHdoZXJlIHRoZSBge3t9fWAgaXMgY2FsbGVkLiBUaGUgYWJvdmUgc3R5bGUgaXMKICAgIGNhbGxlZCAiaW5saW5lIi4gQSBzZWNvbmQgc3R5bGUgb2YgaGVscGVyIHVzYWdlIGlzIGNhbGxlZCAiYmxvY2siLiBGb3IgZXhhbXBsZToKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIHt7I2lmIG5hbWV9fQogICAgSSBoYXZlIGEgbmFtZQogICAge3tlbHNlfX0KICAgIEkgaGF2ZSBubyBuYW1lCiAgICB7ey9pZn19CiAgICBgYGAKICAKICAgIFRoZSBibG9jayBmb3JtIG9mIGhlbHBlcnMgYWxsb3dzIHlvdSB0byBjb250cm9sIGhvdyB0aGUgVUkgaXMgY3JlYXRlZCBiYXNlZAogICAgb24gdGhlIHZhbHVlcyBvZiBwcm9wZXJ0aWVzLgogICAgQSB0aGlyZCBmb3JtIG9mIGhlbHBlciBpcyBjYWxsZWQgIm5lc3RlZCIuIEZvciBleGFtcGxlIGhlcmUgdGhlIGNvbmNhdAogICAgaGVscGVyIHdpbGwgYWRkICIgRG9lIiB0byBhIGRpc3BsYXllZCBuYW1lIGlmIHRoZSBwZXJzb24gaGFzIG5vIGxhc3QgbmFtZToKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxzcGFuIGRhdGEtbmFtZT17e2NvbmNhdCBmaXJzdE5hbWUgKAogICAgaWYgbGFzdE5hbWUgKGNvbmNhdCAiICIgbGFzdE5hbWUpICJEb2UiCiAgICApfX0+PC9zcGFuPgogICAgYGBgCiAgCiAgICBFbWJlcidzIGJ1aWx0LWluIGhlbHBlcnMgYXJlIGRlc2NyaWJlZCB1bmRlciB0aGUgW0VtYmVyLlRlbXBsYXRlcy5oZWxwZXJzXSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0VtYmVyLlRlbXBsYXRlcy5oZWxwZXJzKQogICAgbmFtZXNwYWNlLiBEb2N1bWVudGF0aW9uIG9uIGNyZWF0aW5nIGN1c3RvbSBoZWxwZXJzIGNhbiBiZSBmb3VuZCB1bmRlcgogICAgW2hlbHBlcl0oL2VtYmVyL3JlbGVhc2UvZnVuY3Rpb25zL0BlbWJlciUyRmNvbXBvbmVudCUyRmhlbHBlci9oZWxwZXIpIChvcgogICAgdW5kZXIgW0hlbHBlcl0oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9IZWxwZXIpIGlmIGEgaGVscGVyIHJlcXVpcmVzIGFjY2VzcyB0bwogICAgZGVwZW5kZW5jeSBpbmplY3Rpb24pLgogIAogICAgIyMjIEludm9raW5nIGEgQ29tcG9uZW50CiAgCiAgICBFbWJlciBjb21wb25lbnRzIHJlcHJlc2VudCBzdGF0ZSB0byB0aGUgVUkgb2YgYW4gYXBwbGljYXRpb24uIEZ1cnRoZXIKICAgIHJlYWRpbmcgb24gY29tcG9uZW50cyBjYW4gYmUgZm91bmQgdW5kZXIgW0NvbXBvbmVudF0oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9Db21wb25lbnQpLgogIAogICAgQG1vZHVsZSBAZW1iZXIvY29tcG9uZW50CiAgICBAbWFpbiBAZW1iZXIvY29tcG9uZW50CiAgICBAcHVibGljCiAgICovCgp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9tZXRhL2luZGV4IiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGEvbGliL21ldGEiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfbWV0YSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiY291bnRlcnMiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfbWV0YS5jb3VudGVyczsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJkZWxldGVNZXRhIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX21ldGEuZGVsZXRlTWV0YTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJNZXRhIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX21ldGEuTWV0YTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJtZXRhIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX21ldGEubWV0YTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJwZWVrTWV0YSIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9tZXRhLnBlZWtNZXRhOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgInNldE1ldGEiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfbWV0YS5zZXRNZXRhOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIlVOREVGSU5FRCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9tZXRhLlVOREVGSU5FRDsKICAgIH0KICB9KTsKfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YS9saWIvbWV0YSIsIFsiZXhwb3J0cyIsICJlbWJlci1iYWJlbCIsICJAZW1iZXIvLWludGVybmFscy91dGlscyIsICJAZW1iZXIvZGVidWciLCAiQGdsaW1tZXIvcmVmZXJlbmNlIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2VtYmVyQmFiZWwsIF91dGlscywgX2RlYnVnLCBfcmVmZXJlbmNlKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5zZXRNZXRhID0gc2V0TWV0YTsKICBfZXhwb3J0cy5wZWVrTWV0YSA9IHBlZWtNZXRhOwogIF9leHBvcnRzLmRlbGV0ZU1ldGEgPSBkZWxldGVNZXRhOwogIF9leHBvcnRzLmNvdW50ZXJzID0gX2V4cG9ydHMubWV0YSA9IF9leHBvcnRzLk1ldGEgPSBfZXhwb3J0cy5VTkRFRklORUQgPSB2b2lkIDA7CiAgdmFyIG9iamVjdFByb3RvdHlwZSA9IE9iamVjdC5wcm90b3R5cGU7CiAgdmFyIGNvdW50ZXJzOwogIF9leHBvcnRzLmNvdW50ZXJzID0gY291bnRlcnM7CgogIGlmIChmYWxzZQogIC8qIERFQlVHICovCiAgKSB7CiAgICBfZXhwb3J0cy5jb3VudGVycyA9IGNvdW50ZXJzID0gewogICAgICBwZWVrQ2FsbHM6IDAsCiAgICAgIHBlZWtQcm90b3R5cGVXYWxrczogMCwKICAgICAgc2V0Q2FsbHM6IDAsCiAgICAgIGRlbGV0ZUNhbGxzOiAwLAogICAgICBtZXRhQ2FsbHM6IDAsCiAgICAgIG1ldGFJbnN0YW50aWF0ZWQ6IDAsCiAgICAgIG1hdGNoaW5nTGlzdGVuZXJzQ2FsbHM6IDAsCiAgICAgIG9ic2VydmVyRXZlbnRzQ2FsbHM6IDAsCiAgICAgIGFkZFRvTGlzdGVuZXJzQ2FsbHM6IDAsCiAgICAgIHJlbW92ZUZyb21MaXN0ZW5lcnNDYWxsczogMCwKICAgICAgcmVtb3ZlQWxsTGlzdGVuZXJzQ2FsbHM6IDAsCiAgICAgIGxpc3RlbmVyc0luaGVyaXRlZDogMCwKICAgICAgbGlzdGVuZXJzRmxhdHRlbmVkOiAwLAogICAgICBwYXJlbnRMaXN0ZW5lcnNVc2VkOiAwLAogICAgICBmbGF0dGVuZWRMaXN0ZW5lcnNDYWxsczogMCwKICAgICAgcmVvcGVuc0FmdGVyRmxhdHRlbjogMCwKICAgICAgcmVhZGFibGVMYXp5Q2hhaW5zQ2FsbHM6IDAsCiAgICAgIHdyaXRhYmxlTGF6eUNoYWluc0NhbGxzOiAwCiAgICB9OwogIH0KICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCgogIHZhciBVTkRFRklORUQgPSAoMCwgX3V0aWxzLnN5bWJvbCkoJ3VuZGVmaW5lZCcpOwogIF9leHBvcnRzLlVOREVGSU5FRCA9IFVOREVGSU5FRDsKICB2YXIgY3VycmVudExpc3RlbmVyVmVyc2lvbiA9IDE7CgogIHZhciBNZXRhID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gTWV0YShvYmopIHsKICAgICAgdGhpcy5fbGlzdGVuZXJzVmVyc2lvbiA9IDE7CiAgICAgIHRoaXMuX2luaGVyaXRlZEVuZCA9IC0xOwogICAgICB0aGlzLl9mbGF0dGVuZWRWZXJzaW9uID0gMDsKCiAgICAgIGlmIChmYWxzZQogICAgICAvKiBERUJVRyAqLwogICAgICApIHsKICAgICAgICBjb3VudGVycy5tZXRhSW5zdGFudGlhdGVkKys7CiAgICAgICAgdGhpcy5fdmFsdWVzID0gdW5kZWZpbmVkOwogICAgICB9CgogICAgICB0aGlzLl9wYXJlbnQgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuX2Rlc2NyaXB0b3JzID0gdW5kZWZpbmVkOwogICAgICB0aGlzLl93YXRjaGluZyA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5fbWl4aW5zID0gdW5kZWZpbmVkOwogICAgICB0aGlzLl9kZXBzID0gdW5kZWZpbmVkOwogICAgICB0aGlzLl9jaGFpbldhdGNoZXJzID0gdW5kZWZpbmVkOwogICAgICB0aGlzLl9jaGFpbnMgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuX3RhZyA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5fdGFncyA9IHVuZGVmaW5lZDsgLy8gaW5pdGlhbCB2YWx1ZSBmb3IgYWxsIGZsYWdzIHJpZ2h0IG5vdyBpcyBmYWxzZQogICAgICAvLyBzZWUgRkxBR1MgY29uc3QgZm9yIGRldGFpbGVkIGxpc3Qgb2YgZmxhZ3MgdXNlZAoKICAgICAgdGhpcy5fZmxhZ3MgPSAwCiAgICAgIC8qIE5PTkUgKi8KICAgICAgOyAvLyB1c2VkIG9ubHkgaW50ZXJuYWxseQoKICAgICAgdGhpcy5zb3VyY2UgPSBvYmo7CiAgICAgIHRoaXMucHJvdG8gPSBvYmouY29uc3RydWN0b3IgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IG9iai5jb25zdHJ1Y3Rvci5wcm90b3R5cGU7CiAgICAgIHRoaXMuX2xpc3RlbmVycyA9IHVuZGVmaW5lZDsKICAgIH0KCiAgICB2YXIgX3Byb3RvID0gTWV0YS5wcm90b3R5cGU7CgogICAgX3Byb3RvLnNldEluaXRpYWxpemluZyA9IGZ1bmN0aW9uIHNldEluaXRpYWxpemluZygpIHsKICAgICAgdGhpcy5fZmxhZ3MgfD0gOAogICAgICAvKiBJTklUSUFMSVpJTkcgKi8KICAgICAgOwogICAgfTsKCiAgICBfcHJvdG8udW5zZXRJbml0aWFsaXppbmcgPSBmdW5jdGlvbiB1bnNldEluaXRpYWxpemluZygpIHsKICAgICAgdGhpcy5fZmxhZ3MgXj0gOAogICAgICAvKiBJTklUSUFMSVpJTkcgKi8KICAgICAgOwogICAgfTsKCiAgICBfcHJvdG8uaXNJbml0aWFsaXppbmcgPSBmdW5jdGlvbiBpc0luaXRpYWxpemluZygpIHsKICAgICAgcmV0dXJuIHRoaXMuX2hhc0ZsYWcoOAogICAgICAvKiBJTklUSUFMSVpJTkcgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvLmlzUHJvdG90eXBlTWV0YSA9IGZ1bmN0aW9uIGlzUHJvdG90eXBlTWV0YShvYmopIHsKICAgICAgcmV0dXJuIHRoaXMucHJvdG8gPT09IHRoaXMuc291cmNlICYmIHRoaXMuc291cmNlID09PSBvYmo7CiAgICB9OwoKICAgIF9wcm90by5kZXN0cm95ID0gZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgaWYgKHRoaXMuaXNNZXRhRGVzdHJveWVkKCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuc2V0TWV0YURlc3Ryb3llZCgpOyAvLyByZW1vdmUgY2hhaW5XYXRjaGVycyB0byByZW1vdmUgY2lyY3VsYXIgcmVmZXJlbmNlcyB0aGF0IHdvdWxkIHByZXZlbnQgR0MKCiAgICAgIHZhciBjaGFpbnMgPSB0aGlzLnJlYWRhYmxlQ2hhaW5zKCk7CgogICAgICBpZiAoY2hhaW5zICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBjaGFpbnMuZGVzdHJveSgpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5pc1NvdXJjZURlc3Ryb3lpbmcgPSBmdW5jdGlvbiBpc1NvdXJjZURlc3Ryb3lpbmcoKSB7CiAgICAgIHJldHVybiB0aGlzLl9oYXNGbGFnKDEKICAgICAgLyogU09VUkNFX0RFU1RST1lJTkcgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvLnNldFNvdXJjZURlc3Ryb3lpbmcgPSBmdW5jdGlvbiBzZXRTb3VyY2VEZXN0cm95aW5nKCkgewogICAgICB0aGlzLl9mbGFncyB8PSAxCiAgICAgIC8qIFNPVVJDRV9ERVNUUk9ZSU5HICovCiAgICAgIDsKICAgIH07CgogICAgX3Byb3RvLmlzU291cmNlRGVzdHJveWVkID0gZnVuY3Rpb24gaXNTb3VyY2VEZXN0cm95ZWQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9oYXNGbGFnKDIKICAgICAgLyogU09VUkNFX0RFU1RST1lFRCAqLwogICAgICApOwogICAgfTsKCiAgICBfcHJvdG8uc2V0U291cmNlRGVzdHJveWVkID0gZnVuY3Rpb24gc2V0U291cmNlRGVzdHJveWVkKCkgewogICAgICB0aGlzLl9mbGFncyB8PSAyCiAgICAgIC8qIFNPVVJDRV9ERVNUUk9ZRUQgKi8KICAgICAgOwogICAgfTsKCiAgICBfcHJvdG8uaXNNZXRhRGVzdHJveWVkID0gZnVuY3Rpb24gaXNNZXRhRGVzdHJveWVkKCkgewogICAgICByZXR1cm4gdGhpcy5faGFzRmxhZyg0CiAgICAgIC8qIE1FVEFfREVTVFJPWUVEICovCiAgICAgICk7CiAgICB9OwoKICAgIF9wcm90by5zZXRNZXRhRGVzdHJveWVkID0gZnVuY3Rpb24gc2V0TWV0YURlc3Ryb3llZCgpIHsKICAgICAgdGhpcy5fZmxhZ3MgfD0gNAogICAgICAvKiBNRVRBX0RFU1RST1lFRCAqLwogICAgICA7CiAgICB9OwoKICAgIF9wcm90by5faGFzRmxhZyA9IGZ1bmN0aW9uIF9oYXNGbGFnKGZsYWcpIHsKICAgICAgcmV0dXJuICh0aGlzLl9mbGFncyAmIGZsYWcpID09PSBmbGFnOwogICAgfTsKCiAgICBfcHJvdG8uX2dldE9yQ3JlYXRlT3duTWFwID0gZnVuY3Rpb24gX2dldE9yQ3JlYXRlT3duTWFwKGtleSkgewogICAgICByZXR1cm4gdGhpc1trZXldIHx8ICh0aGlzW2tleV0gPSBPYmplY3QuY3JlYXRlKG51bGwpKTsKICAgIH07CgogICAgX3Byb3RvLl9nZXRPckNyZWF0ZU93blNldCA9IGZ1bmN0aW9uIF9nZXRPckNyZWF0ZU93blNldChrZXkpIHsKICAgICAgcmV0dXJuIHRoaXNba2V5XSB8fCAodGhpc1trZXldID0gbmV3IFNldCgpKTsKICAgIH07CgogICAgX3Byb3RvLl9maW5kSW5oZXJpdGVkMSA9IGZ1bmN0aW9uIF9maW5kSW5oZXJpdGVkMShrZXkpIHsKICAgICAgdmFyIHBvaW50ZXIgPSB0aGlzOwoKICAgICAgd2hpbGUgKHBvaW50ZXIgIT09IG51bGwpIHsKICAgICAgICB2YXIgbWFwID0gcG9pbnRlcltrZXldOwoKICAgICAgICBpZiAobWFwICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJldHVybiBtYXA7CiAgICAgICAgfQoKICAgICAgICBwb2ludGVyID0gcG9pbnRlci5wYXJlbnQ7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLl9maW5kSW5oZXJpdGVkMiA9IGZ1bmN0aW9uIF9maW5kSW5oZXJpdGVkMihrZXksIHN1YmtleSkgewogICAgICB2YXIgcG9pbnRlciA9IHRoaXM7CgogICAgICB3aGlsZSAocG9pbnRlciAhPT0gbnVsbCkgewogICAgICAgIHZhciBtYXAgPSBwb2ludGVyW2tleV07CgogICAgICAgIGlmIChtYXAgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdmFyIHZhbHVlID0gbWFwW3N1YmtleV07CgogICAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIucGFyZW50OwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5fZmluZEluaGVyaXRlZDMgPSBmdW5jdGlvbiBfZmluZEluaGVyaXRlZDMoa2V5LCBzdWJrZXksIHN1YnN1YmtleSkgewogICAgICB2YXIgcG9pbnRlciA9IHRoaXM7CgogICAgICB3aGlsZSAocG9pbnRlciAhPT0gbnVsbCkgewogICAgICAgIHZhciBtYXAgPSBwb2ludGVyW2tleV07CgogICAgICAgIGlmIChtYXAgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdmFyIHN1Ym1hcCA9IG1hcFtzdWJrZXldOwoKICAgICAgICAgIGlmIChzdWJtYXAgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBzdWJtYXBbc3Vic3Via2V5XTsKCiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBwb2ludGVyID0gcG9pbnRlci5wYXJlbnQ7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLl9maW5kSW5oZXJpdGVkTWFwID0gZnVuY3Rpb24gX2ZpbmRJbmhlcml0ZWRNYXAoa2V5LCBzdWJrZXkpIHsKICAgICAgdmFyIHBvaW50ZXIgPSB0aGlzOwoKICAgICAgd2hpbGUgKHBvaW50ZXIgIT09IG51bGwpIHsKICAgICAgICB2YXIgbWFwID0gcG9pbnRlcltrZXldOwoKICAgICAgICBpZiAobWFwICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IG1hcC5nZXQoc3Via2V5KTsKCiAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBwb2ludGVyID0gcG9pbnRlci5wYXJlbnQ7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLl9oYXNJbkluaGVyaXRlZFNldCA9IGZ1bmN0aW9uIF9oYXNJbkluaGVyaXRlZFNldChrZXksIHZhbHVlKSB7CiAgICAgIHZhciBwb2ludGVyID0gdGhpczsKCiAgICAgIHdoaWxlIChwb2ludGVyICE9PSBudWxsKSB7CiAgICAgICAgdmFyIHNldCA9IHBvaW50ZXJba2V5XTsKCiAgICAgICAgaWYgKHNldCAhPT0gdW5kZWZpbmVkICYmIHNldC5oYXModmFsdWUpKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHBvaW50ZXIgPSBwb2ludGVyLnBhcmVudDsKICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSAvLyBJbXBsZW1lbnRzIGEgbWVtYmVyIHRoYXQgcHJvdmlkZXMgYSBsYXppbHkgY3JlYXRlZCBtYXAgb2YgbWFwcywKICAgIC8vIHdpdGggaW5oZXJpdGFuY2UgYXQgYm90aCBsZXZlbHMuCiAgICA7CgogICAgX3Byb3RvLndyaXRlRGVwcyA9IGZ1bmN0aW9uIHdyaXRlRGVwcyhzdWJrZXksIGl0ZW1rZXksIGNvdW50KSB7CiAgICAgIChmYWxzZSAmJiAhKCF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkodGhpcy5pc01ldGFEZXN0cm95ZWQoKSA/ICJDYW5ub3QgbW9kaWZ5IGRlcGVuZGVudCBrZXlzIGZvciBgIiArIGl0ZW1rZXkgKyAiYCBvbiBgIiArICgwLCBfdXRpbHMudG9TdHJpbmcpKHRoaXMuc291cmNlKSArICJgIGFmdGVyIGl0IGhhcyBiZWVuIGRlc3Ryb3llZC4iIDogJycsICF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSk7CgogICAgICB2YXIgb3V0ZXJNYXAgPSB0aGlzLl9nZXRPckNyZWF0ZU93bk1hcCgnX2RlcHMnKTsKCiAgICAgIHZhciBpbm5lck1hcCA9IG91dGVyTWFwW3N1YmtleV07CgogICAgICBpZiAoaW5uZXJNYXAgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGlubmVyTWFwID0gb3V0ZXJNYXBbc3Via2V5XSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIH0KCiAgICAgIGlubmVyTWFwW2l0ZW1rZXldID0gY291bnQ7CiAgICB9OwoKICAgIF9wcm90by5wZWVrRGVwcyA9IGZ1bmN0aW9uIHBlZWtEZXBzKHN1YmtleSwgaXRlbWtleSkgewogICAgICB2YXIgdmFsID0gdGhpcy5fZmluZEluaGVyaXRlZDMoJ19kZXBzJywgc3Via2V5LCBpdGVta2V5KTsKCiAgICAgIHJldHVybiB2YWwgPT09IHVuZGVmaW5lZCA/IDAgOiB2YWw7CiAgICB9OwoKICAgIF9wcm90by5oYXNEZXBzID0gZnVuY3Rpb24gaGFzRGVwcyhzdWJrZXkpIHsKICAgICAgdmFyIHZhbCA9IHRoaXMuX2ZpbmRJbmhlcml0ZWQyKCdfZGVwcycsIHN1YmtleSk7CgogICAgICByZXR1cm4gdmFsICE9PSB1bmRlZmluZWQ7CiAgICB9OwoKICAgIF9wcm90by5mb3JFYWNoSW5EZXBzID0gZnVuY3Rpb24gZm9yRWFjaEluRGVwcyhzdWJrZXksIGZuKSB7CiAgICAgIHZhciBwb2ludGVyID0gdGhpczsKICAgICAgdmFyIHNlZW47CgogICAgICB3aGlsZSAocG9pbnRlciAhPT0gbnVsbCkgewogICAgICAgIHZhciBtYXAgPSBwb2ludGVyLl9kZXBzOwoKICAgICAgICBpZiAobWFwICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciBpbm5lck1hcCA9IG1hcFtzdWJrZXldOwoKICAgICAgICAgIGlmIChpbm5lck1hcCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHNlZW4gPSBzZWVuID09PSB1bmRlZmluZWQgPyBuZXcgU2V0KCkgOiBzZWVuOwoKICAgICAgICAgICAgZm9yICh2YXIgaW5uZXJLZXkgaW4gaW5uZXJNYXApIHsKICAgICAgICAgICAgICBpZiAoIXNlZW4uaGFzKGlubmVyS2V5KSkgewogICAgICAgICAgICAgICAgc2Vlbi5hZGQoaW5uZXJLZXkpOwoKICAgICAgICAgICAgICAgIGlmIChpbm5lck1hcFtpbm5lcktleV0gPiAwKSB7CiAgICAgICAgICAgICAgICAgIGZuKGlubmVyS2V5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBvaW50ZXIgPSBwb2ludGVyLnBhcmVudDsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8ud3JpdGFibGVUYWdzID0gZnVuY3Rpb24gd3JpdGFibGVUYWdzKCkgewogICAgICByZXR1cm4gdGhpcy5fZ2V0T3JDcmVhdGVPd25NYXAoJ190YWdzJyk7CiAgICB9OwoKICAgIF9wcm90by5yZWFkYWJsZVRhZ3MgPSBmdW5jdGlvbiByZWFkYWJsZVRhZ3MoKSB7CiAgICAgIHJldHVybiB0aGlzLl90YWdzOwogICAgfTsKCiAgICBfcHJvdG8ud3JpdGFibGVUYWcgPSBmdW5jdGlvbiB3cml0YWJsZVRhZygpIHsKICAgICAgKGZhbHNlICYmICEoIXRoaXMuaXNNZXRhRGVzdHJveWVkKCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSh0aGlzLmlzTWV0YURlc3Ryb3llZCgpID8gIkNhbm5vdCBjcmVhdGUgYSBuZXcgdGFnIGZvciBgIiArICgwLCBfdXRpbHMudG9TdHJpbmcpKHRoaXMuc291cmNlKSArICJgIGFmdGVyIGl0IGhhcyBiZWVuIGRlc3Ryb3llZC4iIDogJycsICF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSk7CiAgICAgIHZhciByZXQgPSB0aGlzLl90YWc7CgogICAgICBpZiAocmV0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXQgPSB0aGlzLl90YWcgPSAoMCwgX3JlZmVyZW5jZS5jcmVhdGVVcGRhdGFibGVUYWcpKCk7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXQ7CiAgICB9OwoKICAgIF9wcm90by5yZWFkYWJsZVRhZyA9IGZ1bmN0aW9uIHJlYWRhYmxlVGFnKCkgewogICAgICByZXR1cm4gdGhpcy5fdGFnOwogICAgfTsKCiAgICBfcHJvdG8ud3JpdGFibGVMYXp5Q2hhaW5zRm9yID0gZnVuY3Rpb24gd3JpdGFibGVMYXp5Q2hhaW5zRm9yKGtleSkgewogICAgICBpZiAoZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgKSB7CiAgICAgICAgY291bnRlcnMud3JpdGFibGVMYXp5Q2hhaW5zQ2FsbHMrKzsKICAgICAgfQoKICAgICAgdmFyIGxhenlDaGFpbnMgPSB0aGlzLl9nZXRPckNyZWF0ZU93bk1hcCgnX2xhenlDaGFpbnMnKTsKCiAgICAgIGlmICghKGtleSBpbiBsYXp5Q2hhaW5zKSkgewogICAgICAgIGxhenlDaGFpbnNba2V5XSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBsYXp5Q2hhaW5zW2tleV07CiAgICB9OwoKICAgIF9wcm90by5yZWFkYWJsZUxhenlDaGFpbnNGb3IgPSBmdW5jdGlvbiByZWFkYWJsZUxhenlDaGFpbnNGb3Ioa2V5KSB7CiAgICAgIGlmIChmYWxzZQogICAgICAvKiBERUJVRyAqLwogICAgICApIHsKICAgICAgICBjb3VudGVycy5yZWFkYWJsZUxhenlDaGFpbnNDYWxscysrOwogICAgICB9CgogICAgICB2YXIgbGF6eUNoYWlucyA9IHRoaXMuX2xhenlDaGFpbnM7CgogICAgICBpZiAobGF6eUNoYWlucyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIGxhenlDaGFpbnNba2V5XTsKICAgICAgfQoKICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH07CgogICAgX3Byb3RvLndyaXRhYmxlQ2hhaW5XYXRjaGVycyA9IGZ1bmN0aW9uIHdyaXRhYmxlQ2hhaW5XYXRjaGVycyhjcmVhdGUpIHsKICAgICAgKGZhbHNlICYmICEoIXRoaXMuaXNNZXRhRGVzdHJveWVkKCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSh0aGlzLmlzTWV0YURlc3Ryb3llZCgpID8gIkNhbm5vdCBjcmVhdGUgYSBuZXcgY2hhaW4gd2F0Y2hlciBmb3IgYCIgKyAoMCwgX3V0aWxzLnRvU3RyaW5nKSh0aGlzLnNvdXJjZSkgKyAiYCBhZnRlciBpdCBoYXMgYmVlbiBkZXN0cm95ZWQuIiA6ICcnLCAhdGhpcy5pc01ldGFEZXN0cm95ZWQoKSkpOwogICAgICB2YXIgcmV0ID0gdGhpcy5fY2hhaW5XYXRjaGVyczsKCiAgICAgIGlmIChyZXQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldCA9IHRoaXMuX2NoYWluV2F0Y2hlcnMgPSBjcmVhdGUodGhpcy5zb3VyY2UpOwogICAgICB9CgogICAgICByZXR1cm4gcmV0OwogICAgfTsKCiAgICBfcHJvdG8ucmVhZGFibGVDaGFpbldhdGNoZXJzID0gZnVuY3Rpb24gcmVhZGFibGVDaGFpbldhdGNoZXJzKCkgewogICAgICByZXR1cm4gdGhpcy5fY2hhaW5XYXRjaGVyczsKICAgIH07CgogICAgX3Byb3RvLndyaXRhYmxlQ2hhaW5zID0gZnVuY3Rpb24gd3JpdGFibGVDaGFpbnMoY3JlYXRlKSB7CiAgICAgIChmYWxzZSAmJiAhKCF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkodGhpcy5pc01ldGFEZXN0cm95ZWQoKSA/ICJDYW5ub3QgY3JlYXRlIGEgbmV3IGNoYWlucyBmb3IgYCIgKyAoMCwgX3V0aWxzLnRvU3RyaW5nKSh0aGlzLnNvdXJjZSkgKyAiYCBhZnRlciBpdCBoYXMgYmVlbiBkZXN0cm95ZWQuIiA6ICcnLCAhdGhpcy5pc01ldGFEZXN0cm95ZWQoKSkpOwogICAgICB2YXIgcmV0ID0gdGhpcy5fY2hhaW5zOwoKICAgICAgaWYgKHJldCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5fY2hhaW5zID0gcmV0ID0gY3JlYXRlKHRoaXMuc291cmNlKTsKICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy5wYXJlbnQ7CgogICAgICAgIGlmIChwYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgIHZhciBwYXJlbnRDaGFpbnMgPSBwYXJlbnQud3JpdGFibGVDaGFpbnMoY3JlYXRlKTsKICAgICAgICAgIHBhcmVudENoYWlucy5jb3B5VG8ocmV0KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByZXQ7CiAgICB9OwoKICAgIF9wcm90by5yZWFkYWJsZUNoYWlucyA9IGZ1bmN0aW9uIHJlYWRhYmxlQ2hhaW5zKCkgewogICAgICByZXR1cm4gdGhpcy5fZmluZEluaGVyaXRlZDEoJ19jaGFpbnMnKTsKICAgIH07CgogICAgX3Byb3RvLndyaXRlV2F0Y2hpbmcgPSBmdW5jdGlvbiB3cml0ZVdhdGNoaW5nKHN1YmtleSwgdmFsdWUpIHsKICAgICAgKGZhbHNlICYmICEoIXRoaXMuaXNNZXRhRGVzdHJveWVkKCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSh0aGlzLmlzTWV0YURlc3Ryb3llZCgpID8gIkNhbm5vdCB1cGRhdGUgd2F0Y2hlcnMgZm9yIGAiICsgc3Via2V5ICsgImAgb24gYCIgKyAoMCwgX3V0aWxzLnRvU3RyaW5nKSh0aGlzLnNvdXJjZSkgKyAiYCBhZnRlciBpdCBoYXMgYmVlbiBkZXN0cm95ZWQuIiA6ICcnLCAhdGhpcy5pc01ldGFEZXN0cm95ZWQoKSkpOwoKICAgICAgdmFyIG1hcCA9IHRoaXMuX2dldE9yQ3JlYXRlT3duTWFwKCdfd2F0Y2hpbmcnKTsKCiAgICAgIG1hcFtzdWJrZXldID0gdmFsdWU7CiAgICB9OwoKICAgIF9wcm90by5wZWVrV2F0Y2hpbmcgPSBmdW5jdGlvbiBwZWVrV2F0Y2hpbmcoc3Via2V5KSB7CiAgICAgIHZhciBjb3VudCA9IHRoaXMuX2ZpbmRJbmhlcml0ZWQyKCdfd2F0Y2hpbmcnLCBzdWJrZXkpOwoKICAgICAgcmV0dXJuIGNvdW50ID09PSB1bmRlZmluZWQgPyAwIDogY291bnQ7CiAgICB9OwoKICAgIF9wcm90by5hZGRNaXhpbiA9IGZ1bmN0aW9uIGFkZE1peGluKG1peGluKSB7CiAgICAgIChmYWxzZSAmJiAhKCF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkodGhpcy5pc01ldGFEZXN0cm95ZWQoKSA/ICJDYW5ub3QgYWRkIG1peGlucyBvZiBgIiArICgwLCBfdXRpbHMudG9TdHJpbmcpKG1peGluKSArICJgIG9uIGAiICsgKDAsIF91dGlscy50b1N0cmluZykodGhpcy5zb3VyY2UpICsgImAgY2FsbCBhZGRNaXhpbiBhZnRlciBpdCBoYXMgYmVlbiBkZXN0cm95ZWQuIiA6ICcnLCAhdGhpcy5pc01ldGFEZXN0cm95ZWQoKSkpOwoKICAgICAgdmFyIHNldCA9IHRoaXMuX2dldE9yQ3JlYXRlT3duU2V0KCdfbWl4aW5zJyk7CgogICAgICBzZXQuYWRkKG1peGluKTsKICAgIH07CgogICAgX3Byb3RvLmhhc01peGluID0gZnVuY3Rpb24gaGFzTWl4aW4obWl4aW4pIHsKICAgICAgcmV0dXJuIHRoaXMuX2hhc0luSW5oZXJpdGVkU2V0KCdfbWl4aW5zJywgbWl4aW4pOwogICAgfTsKCiAgICBfcHJvdG8uZm9yRWFjaE1peGlucyA9IGZ1bmN0aW9uIGZvckVhY2hNaXhpbnMoZm4pIHsKICAgICAgdmFyIHBvaW50ZXIgPSB0aGlzOwogICAgICB2YXIgc2VlbjsKCiAgICAgIHdoaWxlIChwb2ludGVyICE9PSBudWxsKSB7CiAgICAgICAgdmFyIHNldCA9IHBvaW50ZXIuX21peGluczsKCiAgICAgICAgaWYgKHNldCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBzZWVuID0gc2VlbiA9PT0gdW5kZWZpbmVkID8gbmV3IFNldCgpIDogc2VlbjsgLy8gVE9ETyBjbGVhbnVwIHR5cGluZyBoZXJlCgogICAgICAgICAgc2V0LmZvckVhY2goZnVuY3Rpb24gKG1peGluKSB7CiAgICAgICAgICAgIGlmICghc2Vlbi5oYXMobWl4aW4pKSB7CiAgICAgICAgICAgICAgc2Vlbi5hZGQobWl4aW4pOwogICAgICAgICAgICAgIGZuKG1peGluKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBwb2ludGVyID0gcG9pbnRlci5wYXJlbnQ7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLndyaXRlRGVzY3JpcHRvcnMgPSBmdW5jdGlvbiB3cml0ZURlc2NyaXB0b3JzKHN1YmtleSwgdmFsdWUpIHsKICAgICAgKGZhbHNlICYmICEoIXRoaXMuaXNNZXRhRGVzdHJveWVkKCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSh0aGlzLmlzTWV0YURlc3Ryb3llZCgpID8gIkNhbm5vdCB1cGRhdGUgZGVzY3JpcHRvcnMgZm9yIGAiICsgc3Via2V5ICsgImAgb24gYCIgKyAoMCwgX3V0aWxzLnRvU3RyaW5nKSh0aGlzLnNvdXJjZSkgKyAiYCBhZnRlciBpdCBoYXMgYmVlbiBkZXN0cm95ZWQuIiA6ICcnLCAhdGhpcy5pc01ldGFEZXN0cm95ZWQoKSkpOwogICAgICB2YXIgbWFwID0gdGhpcy5fZGVzY3JpcHRvcnMgfHwgKHRoaXMuX2Rlc2NyaXB0b3JzID0gbmV3IE1hcCgpKTsKICAgICAgbWFwLnNldChzdWJrZXksIHZhbHVlKTsKICAgIH07CgogICAgX3Byb3RvLnBlZWtEZXNjcmlwdG9ycyA9IGZ1bmN0aW9uIHBlZWtEZXNjcmlwdG9ycyhzdWJrZXkpIHsKICAgICAgdmFyIHBvc3NpYmxlRGVzYyA9IHRoaXMuX2ZpbmRJbmhlcml0ZWRNYXAoJ19kZXNjcmlwdG9ycycsIHN1YmtleSk7CgogICAgICByZXR1cm4gcG9zc2libGVEZXNjID09PSBVTkRFRklORUQgPyB1bmRlZmluZWQgOiBwb3NzaWJsZURlc2M7CiAgICB9OwoKICAgIF9wcm90by5yZW1vdmVEZXNjcmlwdG9ycyA9IGZ1bmN0aW9uIHJlbW92ZURlc2NyaXB0b3JzKHN1YmtleSkgewogICAgICB0aGlzLndyaXRlRGVzY3JpcHRvcnMoc3Via2V5LCBVTkRFRklORUQpOwogICAgfTsKCiAgICBfcHJvdG8uZm9yRWFjaERlc2NyaXB0b3JzID0gZnVuY3Rpb24gZm9yRWFjaERlc2NyaXB0b3JzKGZuKSB7CiAgICAgIHZhciBwb2ludGVyID0gdGhpczsKICAgICAgdmFyIHNlZW47CgogICAgICB3aGlsZSAocG9pbnRlciAhPT0gbnVsbCkgewogICAgICAgIHZhciBtYXAgPSBwb2ludGVyLl9kZXNjcmlwdG9yczsKCiAgICAgICAgaWYgKG1hcCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBzZWVuID0gc2VlbiA9PT0gdW5kZWZpbmVkID8gbmV3IFNldCgpIDogc2VlbjsKICAgICAgICAgIG1hcC5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgIGlmICghc2Vlbi5oYXMoa2V5KSkgewogICAgICAgICAgICAgIHNlZW4uYWRkKGtleSk7CgogICAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gVU5ERUZJTkVEKSB7CiAgICAgICAgICAgICAgICBmbihrZXksIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIucGFyZW50OwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5hZGRUb0xpc3RlbmVycyA9IGZ1bmN0aW9uIGFkZFRvTGlzdGVuZXJzKGV2ZW50TmFtZSwgdGFyZ2V0LCBtZXRob2QsIG9uY2UsIHN5bmMpIHsKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICkgewogICAgICAgIGNvdW50ZXJzLmFkZFRvTGlzdGVuZXJzQ2FsbHMrKzsKICAgICAgfQoKICAgICAgdGhpcy5wdXNoTGlzdGVuZXIoZXZlbnROYW1lLCB0YXJnZXQsIG1ldGhvZCwgb25jZSA/IDEKICAgICAgLyogT05DRSAqLwogICAgICA6IDAKICAgICAgLyogQUREICovCiAgICAgICwgc3luYyk7CiAgICB9OwoKICAgIF9wcm90by5yZW1vdmVGcm9tTGlzdGVuZXJzID0gZnVuY3Rpb24gcmVtb3ZlRnJvbUxpc3RlbmVycyhldmVudE5hbWUsIHRhcmdldCwgbWV0aG9kKSB7CiAgICAgIGlmIChmYWxzZQogICAgICAvKiBERUJVRyAqLwogICAgICApIHsKICAgICAgICBjb3VudGVycy5yZW1vdmVGcm9tTGlzdGVuZXJzQ2FsbHMrKzsKICAgICAgfQoKICAgICAgdGhpcy5wdXNoTGlzdGVuZXIoZXZlbnROYW1lLCB0YXJnZXQsIG1ldGhvZCwgMgogICAgICAvKiBSRU1PVkUgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvLnB1c2hMaXN0ZW5lciA9IGZ1bmN0aW9uIHB1c2hMaXN0ZW5lcihldmVudCwgdGFyZ2V0LCBtZXRob2QsIGtpbmQsIHN5bmMpIHsKICAgICAgaWYgKHN5bmMgPT09IHZvaWQgMCkgewogICAgICAgIHN5bmMgPSBmYWxzZTsKICAgICAgfQoKICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMud3JpdGFibGVMaXN0ZW5lcnMoKTsKICAgICAgdmFyIGkgPSBpbmRleE9mTGlzdGVuZXIobGlzdGVuZXJzLCBldmVudCwgdGFyZ2V0LCBtZXRob2QpOyAvLyByZW1vdmUgaWYgZm91bmQgbGlzdGVuZXIgd2FzIGluaGVyaXRlZAoKICAgICAgaWYgKGkgIT09IC0xICYmIGkgPCB0aGlzLl9pbmhlcml0ZWRFbmQpIHsKICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKGksIDEpOwogICAgICAgIHRoaXMuX2luaGVyaXRlZEVuZC0tOwogICAgICAgIGkgPSAtMTsKICAgICAgfSAvLyBpZiBub3QgZm91bmQsIHB1c2guIE5vdGUgdGhhdCB3ZSBtdXN0IGFsd2F5cyBwdXNoIGlmIGEgbGlzdGVuZXIgaXMgbm90CiAgICAgIC8vIGZvdW5kLCBldmVuIGluIHRoZSBjYXNlIG9mIGEgZnVuY3Rpb24gbGlzdGVuZXIgcmVtb3ZlLCBiZWNhdXNlIHdlIG1heSBiZQogICAgICAvLyBhdHRlbXB0aW5nIHRvIGFkZCBvciByZW1vdmUgbGlzdGVuZXJzIF9iZWZvcmVfIGZsYXR0ZW5pbmcgaGFzIG9jY3VyZWQuCgoKICAgICAgaWYgKGkgPT09IC0xKSB7CiAgICAgICAgKGZhbHNlICYmICEoISh0aGlzLmlzUHJvdG90eXBlTWV0YSh0aGlzLnNvdXJjZSkgJiYgdHlwZW9mIG1ldGhvZCA9PT0gJ2Z1bmN0aW9uJykpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGNhbm5vdCBhZGQgZnVuY3Rpb24gbGlzdGVuZXJzIHRvIHByb3RvdHlwZXMuIENvbnZlcnQgdGhlIGxpc3RlbmVyIHRvIGEgc3RyaW5nIGxpc3RlbmVyLCBvciBhZGQgaXQgdG8gdGhlIGluc3RhbmNlIGluc3RlYWQuJywgISh0aGlzLmlzUHJvdG90eXBlTWV0YSh0aGlzLnNvdXJjZSkgJiYgdHlwZW9mIG1ldGhvZCA9PT0gJ2Z1bmN0aW9uJykpKTsKICAgICAgICAoZmFsc2UgJiYgISghKCF0aGlzLmlzUHJvdG90eXBlTWV0YSh0aGlzLnNvdXJjZSkgJiYgdHlwZW9mIG1ldGhvZCA9PT0gJ2Z1bmN0aW9uJyAmJiBraW5kID09PSAyCiAgICAgICAgLyogUkVNT1ZFICovCiAgICAgICAgKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgYXR0ZW1wdGVkIHRvIHJlbW92ZSBhIGZ1bmN0aW9uIGxpc3RlbmVyIHdoaWNoIGRpZCBub3QgZXhpc3Qgb24gdGhlIGluc3RhbmNlLCB3aGljaCBtZWFucyB5b3UgbWF5IGhhdmUgYXR0ZW1wdGVkIHRvIHJlbW92ZSBpdCBiZWZvcmUgaXQgd2FzIGFkZGVkLicsICEoIXRoaXMuaXNQcm90b3R5cGVNZXRhKHRoaXMuc291cmNlKSAmJiB0eXBlb2YgbWV0aG9kID09PSAnZnVuY3Rpb24nICYmIGtpbmQgPT09IDIpKSk7CiAgICAgICAgbGlzdGVuZXJzLnB1c2goewogICAgICAgICAgZXZlbnQ6IGV2ZW50LAogICAgICAgICAgdGFyZ2V0OiB0YXJnZXQsCiAgICAgICAgICBtZXRob2Q6IG1ldGhvZCwKICAgICAgICAgIGtpbmQ6IGtpbmQsCiAgICAgICAgICBzeW5jOiBzeW5jCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGxpc3RlbmVyID0gbGlzdGVuZXJzW2ldOyAvLyBJZiB0aGUgbGlzdGVuZXIgaXMgb3VyIG93biBsaXN0ZW5lciBhbmQgd2UgYXJlIHRyeWluZyB0byByZW1vdmUgaXQsIHdlCiAgICAgICAgLy8gd2FudCB0byBzcGxpY2UgaXQgb3V0IGVudGlyZWx5IHNvIHdlIGRvbid0IGhvbGQgb250byBhIHJlZmVyZW5jZS4KCiAgICAgICAgaWYgKGtpbmQgPT09IDIKICAgICAgICAvKiBSRU1PVkUgKi8KICAgICAgICAmJiBsaXN0ZW5lci5raW5kICE9PSAyCiAgICAgICAgLyogUkVNT1ZFICovCiAgICAgICAgKSB7CiAgICAgICAgICAgIGxpc3RlbmVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgKGZhbHNlICYmICEoIShsaXN0ZW5lci5raW5kID09PSAwCiAgICAgICAgICAvKiBBREQgKi8KICAgICAgICAgICYmIGtpbmQgPT09IDAKICAgICAgICAgIC8qIEFERCAqLwogICAgICAgICAgJiYgbGlzdGVuZXIuc3luYyAhPT0gc3luYykpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IGF0dGVtcHRlZCB0byBhZGQgYW4gb2JzZXJ2ZXIgZm9yIHRoZSBzYW1lIG1ldGhvZCBvbiAnIiArIGV2ZW50LnNwbGl0KCc6JylbMF0gKyAiJyB0d2ljZSB0byAiICsgdGFyZ2V0ICsgIiBhcyBib3RoIHN5bmMgYW5kIGFzeW5jLiBPYnNlcnZlcnMgbXVzdCBiZSBlaXRoZXIgc3luYyBvciBhc3luYywgdGhleSBjYW5ub3QgYmUgYm90aC4gVGhpcyBpcyBsaWtlbHkgYSBtaXN0YWtlLCB5b3Ugc2hvdWxkIGVpdGhlciByZW1vdmUgdGhlIGNvZGUgdGhhdCBhZGRlZCB0aGUgb2JzZXJ2ZXIgYSBzZWNvbmQgdGltZSwgb3IgdXBkYXRlIGl0IHRvIGFsd2F5cyBiZSBzeW5jIG9yIGFzeW5jLiBUaGUgbWV0aG9kIHdhcyAiICsgbWV0aG9kICsgIi4iLCAhKGxpc3RlbmVyLmtpbmQgPT09IDAgJiYga2luZCA9PT0gMCAmJiBsaXN0ZW5lci5zeW5jICE9PSBzeW5jKSkpOyAvLyB1cGRhdGUgb3duIGxpc3RlbmVyCgogICAgICAgICAgbGlzdGVuZXIua2luZCA9IGtpbmQ7CiAgICAgICAgICBsaXN0ZW5lci5zeW5jID0gc3luYzsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLndyaXRhYmxlTGlzdGVuZXJzID0gZnVuY3Rpb24gd3JpdGFibGVMaXN0ZW5lcnMoKSB7CiAgICAgIC8vIENoZWNrIGlmIHdlIG5lZWQgdG8gaW52YWxpZGF0ZSBhbmQgcmVmbGF0dGVuLiBXZSBuZWVkIHRvIGRvIHRoaXMgaWYgd2UKICAgICAgLy8gaGF2ZSBhbHJlYWR5IGZsYXR0ZW5lZCAoZmxhdHRlbmVkIHZlcnNpb24gaXMgdGhlIGN1cnJlbnQgdmVyc2lvbikgYW5kCiAgICAgIC8vIHdlIGFyZSBlaXRoZXIgd3JpdGluZyB0byBhIHByb3RvdHlwZSBtZXRhIE9SIHdlIGhhdmUgbmV2ZXIgaW5oZXJpdGVkLCBhbmQKICAgICAgLy8gbWF5IGhhdmUgY2FjaGVkIHRoZSBwYXJlbnQncyBsaXN0ZW5lcnMuCiAgICAgIGlmICh0aGlzLl9mbGF0dGVuZWRWZXJzaW9uID09PSBjdXJyZW50TGlzdGVuZXJWZXJzaW9uICYmICh0aGlzLnNvdXJjZSA9PT0gdGhpcy5wcm90byB8fCB0aGlzLl9pbmhlcml0ZWRFbmQgPT09IC0xKSkgewogICAgICAgIGlmIChmYWxzZQogICAgICAgIC8qIERFQlVHICovCiAgICAgICAgKSB7CiAgICAgICAgICBjb3VudGVycy5yZW9wZW5zQWZ0ZXJGbGF0dGVuKys7CiAgICAgICAgfQoKICAgICAgICBjdXJyZW50TGlzdGVuZXJWZXJzaW9uKys7CiAgICAgIH0gLy8gSW5oZXJpdGVkIGVuZCBoYXMgbm90IGJlZW4gc2V0LCB0aGVuIHdlIGhhdmUgbmV2ZXIgY3JlYXRlZCBvdXIgb3duCiAgICAgIC8vIGxpc3RlbmVycywgYnV0IG1heSBoYXZlIGNhY2hlZCB0aGUgcGFyZW50J3MKCgogICAgICBpZiAodGhpcy5faW5oZXJpdGVkRW5kID09PSAtMSkgewogICAgICAgIHRoaXMuX2luaGVyaXRlZEVuZCA9IDA7CiAgICAgICAgdGhpcy5fbGlzdGVuZXJzID0gW107CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLl9saXN0ZW5lcnM7CiAgICB9CiAgICAvKioKICAgICAgRmxhdHRlbmluZyBpcyBiYXNlZCBvbiBhIGdsb2JhbCByZXZpc2lvbiBjb3VudGVyLiBJZiB0aGUgcmV2aXNpb24gaGFzCiAgICAgIGJ1bXBlZCBpdCBtZWFucyB0aGF0IHNvbWV3aGVyZSBpbiBhIGNsYXNzIGluaGVyaXRhbmNlIGNoYWluIHNvbWV0aGluZyBoYXMKICAgICAgY2hhbmdlZCwgc28gd2UgbmVlZCB0byByZWZsYXR0ZW4gZXZlcnl0aGluZy4gVGhpcyBjYW4gb25seSBoYXBwZW4gaWY6CiAgICAgICAgIDEuIEEgbWV0YSBoYXMgYmVlbiBmbGF0dGVuZWQgKGxpc3RlbmVyIGhhcyBiZWVuIGNhbGxlZCkKICAgICAgMi4gVGhlIG1ldGEgaXMgYSBwcm90b3R5cGUgbWV0YSB3aXRoIGNoaWxkcmVuIHdobyBoYXZlIGluaGVyaXRlZCBpdHMKICAgICAgICAgbGlzdGVuZXJzCiAgICAgIDMuIEEgbmV3IGxpc3RlbmVyIGlzIHN1YnNlcXVlbnRseSBhZGRlZCB0byB0aGUgbWV0YSAoZS5nLiB2aWEgYC5yZW9wZW4oKWApCiAgICAgICAgIFRoaXMgaXMgYSB2ZXJ5IHJhcmUgb2NjdXJlbmNlLCBzbyB3aGlsZSB0aGUgY291bnRlciBpcyBnbG9iYWwgaXQgc2hvdWxkbid0CiAgICAgIGJlIHVwZGF0ZWQgdmVyeSBvZnRlbiBpbiBwcmFjdGljZS4KICAgICovCiAgICA7CgogICAgX3Byb3RvLmZsYXR0ZW5lZExpc3RlbmVycyA9IGZ1bmN0aW9uIGZsYXR0ZW5lZExpc3RlbmVycygpIHsKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICkgewogICAgICAgIGNvdW50ZXJzLmZsYXR0ZW5lZExpc3RlbmVyc0NhbGxzKys7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9mbGF0dGVuZWRWZXJzaW9uIDwgY3VycmVudExpc3RlbmVyVmVyc2lvbikgewogICAgICAgIGlmIChmYWxzZQogICAgICAgIC8qIERFQlVHICovCiAgICAgICAgKSB7CiAgICAgICAgICBjb3VudGVycy5saXN0ZW5lcnNGbGF0dGVuZWQrKzsKICAgICAgICB9CgogICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLnBhcmVudDsKCiAgICAgICAgaWYgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgLy8gY29tcHV0ZQogICAgICAgICAgdmFyIHBhcmVudExpc3RlbmVycyA9IHBhcmVudC5mbGF0dGVuZWRMaXN0ZW5lcnMoKTsKCiAgICAgICAgICBpZiAocGFyZW50TGlzdGVuZXJzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2xpc3RlbmVycyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgLy8gSWYgdGhpcyBpbnN0YW5jZSBkb2Vzbid0IGhhdmUgYW55IG9mIGl0cyBvd24gbGlzdGVuZXJzICh3cml0YWJsZUxpc3RlbmVycwogICAgICAgICAgICAgIC8vIGhhcyBuZXZlciBiZWVuIGNhbGxlZCkgdGhlbiB3ZSBkb24ndCBuZWVkIHRvIGRvIGFueSBmbGF0dGVuaW5nLCByZXR1cm4KICAgICAgICAgICAgICAvLyB0aGUgcGFyZW50J3MgbGlzdGVuZXJzIGluc3RlYWQuCiAgICAgICAgICAgICAgaWYgKGZhbHNlCiAgICAgICAgICAgICAgLyogREVCVUcgKi8KICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIGNvdW50ZXJzLnBhcmVudExpc3RlbmVyc1VzZWQrKzsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHRoaXMuX2xpc3RlbmVycyA9IHBhcmVudExpc3RlbmVyczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwoKICAgICAgICAgICAgICBpZiAodGhpcy5faW5oZXJpdGVkRW5kID4gMCkgewogICAgICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZSgwLCB0aGlzLl9pbmhlcml0ZWRFbmQpOwogICAgICAgICAgICAgICAgdGhpcy5faW5oZXJpdGVkRW5kID0gMDsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyZW50TGlzdGVuZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXIgPSBwYXJlbnRMaXN0ZW5lcnNbaV07CiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBpbmRleE9mTGlzdGVuZXIobGlzdGVuZXJzLCBsaXN0ZW5lci5ldmVudCwgbGlzdGVuZXIudGFyZ2V0LCBsaXN0ZW5lci5tZXRob2QpOwoKICAgICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgaWYgKGZhbHNlCiAgICAgICAgICAgICAgICAgIC8qIERFQlVHICovCiAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgIGNvdW50ZXJzLmxpc3RlbmVyc0luaGVyaXRlZCsrOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMudW5zaGlmdChsaXN0ZW5lcik7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2luaGVyaXRlZEVuZCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5fZmxhdHRlbmVkVmVyc2lvbiA9IGN1cnJlbnRMaXN0ZW5lclZlcnNpb247CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLl9saXN0ZW5lcnM7CiAgICB9OwoKICAgIF9wcm90by5tYXRjaGluZ0xpc3RlbmVycyA9IGZ1bmN0aW9uIG1hdGNoaW5nTGlzdGVuZXJzKGV2ZW50TmFtZSkgewogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5mbGF0dGVuZWRMaXN0ZW5lcnMoKTsKICAgICAgdmFyIHJlc3VsdDsKCiAgICAgIGlmIChmYWxzZQogICAgICAvKiBERUJVRyAqLwogICAgICApIHsKICAgICAgICBjb3VudGVycy5tYXRjaGluZ0xpc3RlbmVyc0NhbGxzKys7CiAgICAgIH0KCiAgICAgIGlmIChsaXN0ZW5lcnMgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGZvciAodmFyIGluZGV4ID0gMDsgaW5kZXggPCBsaXN0ZW5lcnMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICB2YXIgbGlzdGVuZXIgPSBsaXN0ZW5lcnNbaW5kZXhdOyAvLyBSRU1PVkUgbGlzdGVuZXJzIGFyZSBwbGFjZWhvbGRlcnMgdGhhdCB0ZWxsIHVzIG5vdCB0bwogICAgICAgICAgLy8gaW5oZXJpdCwgc28gdGhleSBuZXZlciBtYXRjaC4gT25seSBBREQgYW5kIE9OQ0UgY2FuIG1hdGNoLgoKICAgICAgICAgIGlmIChsaXN0ZW5lci5ldmVudCA9PT0gZXZlbnROYW1lICYmIChsaXN0ZW5lci5raW5kID09PSAwCiAgICAgICAgICAvKiBBREQgKi8KICAgICAgICAgIHx8IGxpc3RlbmVyLmtpbmQgPT09IDEKICAgICAgICAgIC8qIE9OQ0UgKi8KICAgICAgICAgICkpIHsKICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgLy8gd2UgY3JlYXRlIHRoaXMgYXJyYXkgb25seSBhZnRlciB3ZSd2ZSBmb3VuZCBhIGxpc3RlbmVyIHRoYXQKICAgICAgICAgICAgICAvLyBtYXRjaGVzIHRvIGF2b2lkIGFsbG9jYXRpb25zIHdoZW4gbm8gbWF0Y2hlcyBhcmUgZm91bmQuCiAgICAgICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGxpc3RlbmVyLnRhcmdldCwgbGlzdGVuZXIubWV0aG9kLCBsaXN0ZW5lci5raW5kID09PSAxCiAgICAgICAgICAgIC8qIE9OQ0UgKi8KICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwoKICAgIF9wcm90by5vYnNlcnZlckV2ZW50cyA9IGZ1bmN0aW9uIG9ic2VydmVyRXZlbnRzKCkgewogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5mbGF0dGVuZWRMaXN0ZW5lcnMoKTsKICAgICAgdmFyIHJlc3VsdDsKCiAgICAgIGlmIChmYWxzZQogICAgICAvKiBERUJVRyAqLwogICAgICApIHsKICAgICAgICBjb3VudGVycy5vYnNlcnZlckV2ZW50c0NhbGxzKys7CiAgICAgIH0KCiAgICAgIGlmIChsaXN0ZW5lcnMgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGZvciAodmFyIGluZGV4ID0gMDsgaW5kZXggPCBsaXN0ZW5lcnMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICB2YXIgbGlzdGVuZXIgPSBsaXN0ZW5lcnNbaW5kZXhdOyAvLyBSRU1PVkUgbGlzdGVuZXJzIGFyZSBwbGFjZWhvbGRlcnMgdGhhdCB0ZWxsIHVzIG5vdCB0bwogICAgICAgICAgLy8gaW5oZXJpdCwgc28gdGhleSBuZXZlciBtYXRjaC4gT25seSBBREQgYW5kIE9OQ0UgY2FuIG1hdGNoLgoKICAgICAgICAgIGlmICgobGlzdGVuZXIua2luZCA9PT0gMAogICAgICAgICAgLyogQUREICovCiAgICAgICAgICB8fCBsaXN0ZW5lci5raW5kID09PSAxCiAgICAgICAgICAvKiBPTkNFICovCiAgICAgICAgICApICYmIGxpc3RlbmVyLmV2ZW50LmluZGV4T2YoJzpjaGFuZ2UnKSAhPT0gLTEpIHsKICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgLy8gd2UgY3JlYXRlIHRoaXMgYXJyYXkgb25seSBhZnRlciB3ZSd2ZSBmb3VuZCBhIGxpc3RlbmVyIHRoYXQKICAgICAgICAgICAgICAvLyBtYXRjaGVzIHRvIGF2b2lkIGFsbG9jYXRpb25zIHdoZW4gbm8gbWF0Y2hlcyBhcmUgZm91bmQuCiAgICAgICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGxpc3RlbmVyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwoKICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoTWV0YSwgW3sKICAgICAga2V5OiAicGFyZW50IiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgdmFyIHBhcmVudCA9IHRoaXMuX3BhcmVudDsKCiAgICAgICAgaWYgKHBhcmVudCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB2YXIgcHJvdG8gPSBnZXRQcm90b3R5cGVPZih0aGlzLnNvdXJjZSk7CiAgICAgICAgICB0aGlzLl9wYXJlbnQgPSBwYXJlbnQgPSBwcm90byA9PT0gbnVsbCB8fCBwcm90byA9PT0gb2JqZWN0UHJvdG90eXBlID8gbnVsbCA6IG1ldGEocHJvdG8pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHBhcmVudDsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIE1ldGE7CiAgfSgpOwoKICBfZXhwb3J0cy5NZXRhID0gTWV0YTsKCiAgaWYgKGZhbHNlCiAgLyogREVCVUcgKi8KICApIHsKICAgIE1ldGEucHJvdG90eXBlLndyaXRlVmFsdWVzID0gZnVuY3Rpb24gKHN1YmtleSwgdmFsdWUpIHsKICAgICAgKGZhbHNlICYmICEoIXRoaXMuaXNNZXRhRGVzdHJveWVkKCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSh0aGlzLmlzTWV0YURlc3Ryb3llZCgpID8gIkNhbm5vdCBzZXQgdGhlIHZhbHVlIG9mIGAiICsgc3Via2V5ICsgImAgb24gYCIgKyAoMCwgX3V0aWxzLnRvU3RyaW5nKSh0aGlzLnNvdXJjZSkgKyAiYCBhZnRlciBpdCBoYXMgYmVlbiBkZXN0cm95ZWQuIiA6ICcnLCAhdGhpcy5pc01ldGFEZXN0cm95ZWQoKSkpOwoKICAgICAgdmFyIG1hcCA9IHRoaXMuX2dldE9yQ3JlYXRlT3duTWFwKCdfdmFsdWVzJyk7CgogICAgICBtYXBbc3Via2V5XSA9IHZhbHVlID09PSB1bmRlZmluZWQgPyBVTkRFRklORUQgOiB2YWx1ZTsKICAgIH07CgogICAgTWV0YS5wcm90b3R5cGUucGVla1ZhbHVlcyA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgdmFyIHZhbCA9IHRoaXMuX2ZpbmRJbmhlcml0ZWQyKCdfdmFsdWVzJywga2V5KTsKCiAgICAgIHJldHVybiB2YWwgPT09IFVOREVGSU5FRCA/IHVuZGVmaW5lZCA6IHZhbDsKICAgIH07CgogICAgTWV0YS5wcm90b3R5cGUuZGVsZXRlRnJvbVZhbHVlcyA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgZGVsZXRlIHRoaXMuX2dldE9yQ3JlYXRlT3duTWFwKCdfdmFsdWVzJylba2V5XTsKICAgIH07CgogICAgTWV0YS5wcm90b3R5cGUucmVhZEluaGVyaXRlZFZhbHVlID0gZnVuY3Rpb24gKGtleSkgewogICAgICByZXR1cm4gdGhpcy5fZmluZEluaGVyaXRlZDIoJ192YWx1ZXMnLCBrZXkpOwogICAgfTsKCiAgICBNZXRhLnByb3RvdHlwZS53cml0ZVZhbHVlID0gZnVuY3Rpb24gKG9iaiwga2V5LCB2YWx1ZSkgewogICAgICB2YXIgZGVzY3JpcHRvciA9ICgwLCBfdXRpbHMubG9va3VwRGVzY3JpcHRvcikob2JqLCBrZXkpOwogICAgICB2YXIgaXNNYW5kYXRvcnlTZXR0ZXIgPSBkZXNjcmlwdG9yICE9PSBudWxsICYmIGRlc2NyaXB0b3Iuc2V0ICYmIGRlc2NyaXB0b3Iuc2V0LmlzTWFuZGF0b3J5U2V0dGVyOwoKICAgICAgaWYgKGlzTWFuZGF0b3J5U2V0dGVyKSB7CiAgICAgICAgdGhpcy53cml0ZVZhbHVlcyhrZXksIHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvYmpba2V5XSA9IHZhbHVlOwogICAgICB9CiAgICB9OwogIH0KCiAgdmFyIGdldFByb3RvdHlwZU9mID0gT2JqZWN0LmdldFByb3RvdHlwZU9mOwogIHZhciBtZXRhU3RvcmUgPSBuZXcgV2Vha01hcCgpOwoKICBmdW5jdGlvbiBzZXRNZXRhKG9iaiwgbWV0YSkgewogICAgKGZhbHNlICYmICEob2JqICE9PSBudWxsKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0Nhbm5vdCBjYWxsIGBzZXRNZXRhYCBvbiBudWxsJywgb2JqICE9PSBudWxsKSk7CiAgICAoZmFsc2UgJiYgIShvYmogIT09IHVuZGVmaW5lZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDYW5ub3QgY2FsbCBgc2V0TWV0YWAgb24gdW5kZWZpbmVkJywgb2JqICE9PSB1bmRlZmluZWQpKTsKICAgIChmYWxzZSAmJiAhKHR5cGVvZiBvYmogPT09ICdvYmplY3QnIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQ2Fubm90IGNhbGwgYHNldE1ldGFgIG9uICIgKyB0eXBlb2Ygb2JqLCB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyB8fCB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nKSk7CgogICAgaWYgKGZhbHNlCiAgICAvKiBERUJVRyAqLwogICAgKSB7CiAgICAgIGNvdW50ZXJzLnNldENhbGxzKys7CiAgICB9CgogICAgbWV0YVN0b3JlLnNldChvYmosIG1ldGEpOwogIH0KCiAgZnVuY3Rpb24gcGVla01ldGEob2JqKSB7CiAgICAoZmFsc2UgJiYgIShvYmogIT09IG51bGwpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ2Fubm90IGNhbGwgYHBlZWtNZXRhYCBvbiBudWxsJywgb2JqICE9PSBudWxsKSk7CiAgICAoZmFsc2UgJiYgIShvYmogIT09IHVuZGVmaW5lZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDYW5ub3QgY2FsbCBgcGVla01ldGFgIG9uIHVuZGVmaW5lZCcsIG9iaiAhPT0gdW5kZWZpbmVkKSk7CiAgICAoZmFsc2UgJiYgISh0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyB8fCB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkNhbm5vdCBjYWxsIGBwZWVrTWV0YWAgb24gIiArIHR5cGVvZiBvYmosIHR5cGVvZiBvYmogPT09ICdvYmplY3QnIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpKTsKCiAgICBpZiAoZmFsc2UKICAgIC8qIERFQlVHICovCiAgICApIHsKICAgICAgY291bnRlcnMucGVla0NhbGxzKys7CiAgICB9CgogICAgdmFyIG1ldGEgPSBtZXRhU3RvcmUuZ2V0KG9iaik7CgogICAgaWYgKG1ldGEgIT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gbWV0YTsKICAgIH0KCiAgICB2YXIgcG9pbnRlciA9IGdldFByb3RvdHlwZU9mKG9iaik7CgogICAgd2hpbGUgKHBvaW50ZXIgIT09IG51bGwpIHsKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICkgewogICAgICAgIGNvdW50ZXJzLnBlZWtQcm90b3R5cGVXYWxrcysrOwogICAgICB9CgogICAgICBtZXRhID0gbWV0YVN0b3JlLmdldChwb2ludGVyKTsKCiAgICAgIGlmIChtZXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAobWV0YS5wcm90byAhPT0gcG9pbnRlcikgewogICAgICAgICAgLy8gVGhlIG1ldGEgd2FzIGEgcHJvdG90eXBlIG1ldGEgd2hpY2ggd2FzIG5vdCBtYXJrZWQgYXMgaW5pdGlhbGl6aW5nLgogICAgICAgICAgLy8gVGhpcyBjYW4gaGFwcGVuIHdoZW4gYSBwcm90b3R5cGUgY2hhaW4gd2FzIGNyZWF0ZWQgbWFudWFsbHkgdmlhCiAgICAgICAgICAvLyBPYmplY3QuY3JlYXRlKCkgYW5kIHRoZSBzb3VyY2Ugb2JqZWN0IGRvZXMgbm90IGhhdmUgYSBjb25zdHJ1Y3Rvci4KICAgICAgICAgIG1ldGEucHJvdG8gPSBwb2ludGVyOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG1ldGE7CiAgICAgIH0KCiAgICAgIHBvaW50ZXIgPSBnZXRQcm90b3R5cGVPZihwb2ludGVyKTsKICAgIH0KCiAgICByZXR1cm4gbnVsbDsKICB9CiAgLyoqCiAgICBUZWFycyBkb3duIHRoZSBtZXRhIG9uIGFuIG9iamVjdCBzbyB0aGF0IGl0IGNhbiBiZSBnYXJiYWdlIGNvbGxlY3RlZC4KICAgIE11bHRpcGxlIGNhbGxzIHdpbGwgaGF2ZSBubyBlZmZlY3QuCiAgCiAgICBAbWV0aG9kIGRlbGV0ZU1ldGEKICAgIEBmb3IgRW1iZXIKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogIHRoZSBvYmplY3QgdG8gZGVzdHJveQogICAgQHJldHVybiB7dm9pZH0KICAgIEBwcml2YXRlCiAgKi8KCgogIGZ1bmN0aW9uIGRlbGV0ZU1ldGEob2JqKSB7CiAgICAoZmFsc2UgJiYgIShvYmogIT09IG51bGwpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ2Fubm90IGNhbGwgYGRlbGV0ZU1ldGFgIG9uIG51bGwnLCBvYmogIT09IG51bGwpKTsKICAgIChmYWxzZSAmJiAhKG9iaiAhPT0gdW5kZWZpbmVkKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0Nhbm5vdCBjYWxsIGBkZWxldGVNZXRhYCBvbiB1bmRlZmluZWQnLCBvYmogIT09IHVuZGVmaW5lZCkpOwogICAgKGZhbHNlICYmICEodHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJDYW5ub3QgY2FsbCBgZGVsZXRlTWV0YWAgb24gIiArIHR5cGVvZiBvYmosIHR5cGVvZiBvYmogPT09ICdvYmplY3QnIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpKTsKCiAgICBpZiAoZmFsc2UKICAgIC8qIERFQlVHICovCiAgICApIHsKICAgICAgY291bnRlcnMuZGVsZXRlQ2FsbHMrKzsKICAgIH0KCiAgICB2YXIgbWV0YSA9IHBlZWtNZXRhKG9iaik7CgogICAgaWYgKG1ldGEgIT09IG51bGwpIHsKICAgICAgbWV0YS5kZXN0cm95KCk7CiAgICB9CiAgfQogIC8qKgogICAgUmV0cmlldmVzIHRoZSBtZXRhIGhhc2ggZm9yIGFuIG9iamVjdC4gSWYgYHdyaXRhYmxlYCBpcyB0cnVlIGVuc3VyZXMgdGhlCiAgICBoYXNoIGlzIHdyaXRhYmxlIGZvciB0aGlzIG9iamVjdCBhcyB3ZWxsLgogIAogICAgVGhlIG1ldGEgb2JqZWN0IGNvbnRhaW5zIGluZm9ybWF0aW9uIGFib3V0IGNvbXB1dGVkIHByb3BlcnR5IGRlc2NyaXB0b3JzIGFzCiAgICB3ZWxsIGFzIGFueSB3YXRjaGVkIHByb3BlcnRpZXMgYW5kIG90aGVyIGluZm9ybWF0aW9uLiBZb3UgZ2VuZXJhbGx5IHdpbGwKICAgIG5vdCBhY2Nlc3MgdGhpcyBpbmZvcm1hdGlvbiBkaXJlY3RseSBidXQgaW5zdGVhZCB3b3JrIHdpdGggaGlnaGVyIGxldmVsCiAgICBtZXRob2RzIHRoYXQgbWFuaXB1bGF0ZSB0aGlzIGhhc2ggaW5kaXJlY3RseS4KICAKICAgIEBtZXRob2QgbWV0YQogICAgQGZvciBFbWJlcgogICAgQHByaXZhdGUKICAKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIG9iamVjdCB0byByZXRyaWV2ZSBtZXRhIGZvcgogICAgQHBhcmFtIHtCb29sZWFufSBbd3JpdGFibGU9dHJ1ZV0gUGFzcyBgZmFsc2VgIGlmIHlvdSBkbyBub3QgaW50ZW5kIHRvIG1vZGlmeQogICAgICB0aGUgbWV0YSBoYXNoLCBhbGxvd2luZyB0aGUgbWV0aG9kIHRvIGF2b2lkIG1ha2luZyBhbiB1bm5lY2Vzc2FyeSBjb3B5LgogICAgQHJldHVybiB7T2JqZWN0fSB0aGUgbWV0YSBoYXNoIGZvciBhbiBvYmplY3QKICAqLwoKCiAgdmFyIG1ldGEgPSBmdW5jdGlvbiBtZXRhKG9iaikgewogICAgKGZhbHNlICYmICEob2JqICE9PSBudWxsKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0Nhbm5vdCBjYWxsIGBtZXRhYCBvbiBudWxsJywgb2JqICE9PSBudWxsKSk7CiAgICAoZmFsc2UgJiYgIShvYmogIT09IHVuZGVmaW5lZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDYW5ub3QgY2FsbCBgbWV0YWAgb24gdW5kZWZpbmVkJywgb2JqICE9PSB1bmRlZmluZWQpKTsKICAgIChmYWxzZSAmJiAhKHR5cGVvZiBvYmogPT09ICdvYmplY3QnIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQ2Fubm90IGNhbGwgYG1ldGFgIG9uICIgKyB0eXBlb2Ygb2JqLCB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyB8fCB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nKSk7CgogICAgaWYgKGZhbHNlCiAgICAvKiBERUJVRyAqLwogICAgKSB7CiAgICAgIGNvdW50ZXJzLm1ldGFDYWxscysrOwogICAgfQoKICAgIHZhciBtYXliZU1ldGEgPSBwZWVrTWV0YShvYmopOyAvLyByZW1vdmUgdGhpcyBjb2RlLCBpbi1mYXZvciBvZiBleHBsaWNpdCBwYXJlbnQKCiAgICBpZiAobWF5YmVNZXRhICE9PSBudWxsICYmIG1heWJlTWV0YS5zb3VyY2UgPT09IG9iaikgewogICAgICByZXR1cm4gbWF5YmVNZXRhOwogICAgfQoKICAgIHZhciBuZXdNZXRhID0gbmV3IE1ldGEob2JqKTsKICAgIHNldE1ldGEob2JqLCBuZXdNZXRhKTsKICAgIHJldHVybiBuZXdNZXRhOwogIH07CgogIF9leHBvcnRzLm1ldGEgPSBtZXRhOwoKICBpZiAoZmFsc2UKICAvKiBERUJVRyAqLwogICkgewogICAgbWV0YS5fY291bnRlcnMgPSBjb3VudGVyczsKICB9CgogIGZ1bmN0aW9uIGluZGV4T2ZMaXN0ZW5lcihsaXN0ZW5lcnMsIGV2ZW50LCB0YXJnZXQsIG1ldGhvZCkgewogICAgZm9yICh2YXIgaSA9IGxpc3RlbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICB2YXIgbGlzdGVuZXIgPSBsaXN0ZW5lcnNbaV07CgogICAgICBpZiAobGlzdGVuZXIuZXZlbnQgPT09IGV2ZW50ICYmIGxpc3RlbmVyLnRhcmdldCA9PT0gdGFyZ2V0ICYmIGxpc3RlbmVyLm1ldGhvZCA9PT0gbWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gLTE7CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9tZXRhbC9pbmRleCIsIFsiZXhwb3J0cyIsICJlbWJlci1iYWJlbCIsICJAZW1iZXIvcG9seWZpbGxzIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGEiLCAiQGVtYmVyLy1pbnRlcm5hbHMvdXRpbHMiLCAiQGVtYmVyL2RlYnVnIiwgIkBlbWJlci9ydW5sb29wIiwgIkBnbGltbWVyL3JlZmVyZW5jZSIsICJAZW1iZXIvLWludGVybmFscy9lbnZpcm9ubWVudCIsICJAZW1iZXIvZXJyb3IiLCAiZW1iZXIvdmVyc2lvbiIsICJAZW1iZXIvZGVwcmVjYXRlZC1mZWF0dXJlcyIsICJAZW1iZXIvLWludGVybmFscy9vd25lciJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9lbWJlckJhYmVsLCBfcG9seWZpbGxzLCBfbWV0YTIsIF91dGlscywgX2RlYnVnLCBfcnVubG9vcCwgX3JlZmVyZW5jZSwgX2Vudmlyb25tZW50LCBfZXJyb3IsIF92ZXJzaW9uLCBfZGVwcmVjYXRlZEZlYXR1cmVzLCBfb3duZXIpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmNvbXB1dGVkID0gY29tcHV0ZWQ7CiAgX2V4cG9ydHMuaXNDb21wdXRlZCA9IGlzQ29tcHV0ZWQ7CiAgX2V4cG9ydHMuZ2V0Q2FjaGVGb3IgPSBnZXRDYWNoZUZvcjsKICBfZXhwb3J0cy5nZXRDYWNoZWRWYWx1ZUZvciA9IGdldENhY2hlZFZhbHVlRm9yOwogIF9leHBvcnRzLnBlZWtDYWNoZUZvciA9IHBlZWtDYWNoZUZvcjsKICBfZXhwb3J0cy5hbGlhcyA9IGFsaWFzOwogIF9leHBvcnRzLmRlcHJlY2F0ZVByb3BlcnR5ID0gZGVwcmVjYXRlUHJvcGVydHk7CiAgX2V4cG9ydHMuX2dldFBhdGggPSBfZ2V0UGF0aDsKICBfZXhwb3J0cy5nZXQgPSBfZ2V0MjsKICBfZXhwb3J0cy5nZXRXaXRoRGVmYXVsdCA9IGdldFdpdGhEZWZhdWx0OwogIF9leHBvcnRzLnNldCA9IF9zZXQyOwogIF9leHBvcnRzLnRyeVNldCA9IHRyeVNldDsKICBfZXhwb3J0cy5vYmplY3RBdCA9IG9iamVjdEF0OwogIF9leHBvcnRzLnJlcGxhY2UgPSByZXBsYWNlOwogIF9leHBvcnRzLnJlcGxhY2VJbk5hdGl2ZUFycmF5ID0gcmVwbGFjZUluTmF0aXZlQXJyYXk7CiAgX2V4cG9ydHMuYWRkQXJyYXlPYnNlcnZlciA9IGFkZEFycmF5T2JzZXJ2ZXI7CiAgX2V4cG9ydHMucmVtb3ZlQXJyYXlPYnNlcnZlciA9IHJlbW92ZUFycmF5T2JzZXJ2ZXI7CiAgX2V4cG9ydHMuYXJyYXlDb250ZW50V2lsbENoYW5nZSA9IGFycmF5Q29udGVudFdpbGxDaGFuZ2U7CiAgX2V4cG9ydHMuYXJyYXlDb250ZW50RGlkQ2hhbmdlID0gYXJyYXlDb250ZW50RGlkQ2hhbmdlOwogIF9leHBvcnRzLmVhY2hQcm94eUZvciA9IGVhY2hQcm94eUZvcjsKICBfZXhwb3J0cy5lYWNoUHJveHlBcnJheVdpbGxDaGFuZ2UgPSBlYWNoUHJveHlBcnJheVdpbGxDaGFuZ2U7CiAgX2V4cG9ydHMuZWFjaFByb3h5QXJyYXlEaWRDaGFuZ2UgPSBlYWNoUHJveHlBcnJheURpZENoYW5nZTsKICBfZXhwb3J0cy5hZGRMaXN0ZW5lciA9IGFkZExpc3RlbmVyOwogIF9leHBvcnRzLmhhc0xpc3RlbmVycyA9IGhhc0xpc3RlbmVyczsKICBfZXhwb3J0cy5vbiA9IG9uOwogIF9leHBvcnRzLnJlbW92ZUxpc3RlbmVyID0gcmVtb3ZlTGlzdGVuZXI7CiAgX2V4cG9ydHMuc2VuZEV2ZW50ID0gc2VuZEV2ZW50OwogIF9leHBvcnRzLmlzTm9uZSA9IGlzTm9uZTsKICBfZXhwb3J0cy5pc0VtcHR5ID0gaXNFbXB0eTsKICBfZXhwb3J0cy5pc0JsYW5rID0gaXNCbGFuazsKICBfZXhwb3J0cy5pc1ByZXNlbnQgPSBpc1ByZXNlbnQ7CiAgX2V4cG9ydHMuYmVnaW5Qcm9wZXJ0eUNoYW5nZXMgPSBiZWdpblByb3BlcnR5Q2hhbmdlczsKICBfZXhwb3J0cy5jaGFuZ2VQcm9wZXJ0aWVzID0gY2hhbmdlUHJvcGVydGllczsKICBfZXhwb3J0cy5lbmRQcm9wZXJ0eUNoYW5nZXMgPSBlbmRQcm9wZXJ0eUNoYW5nZXM7CiAgX2V4cG9ydHMubm90aWZ5UHJvcGVydHlDaGFuZ2UgPSBub3RpZnlQcm9wZXJ0eUNoYW5nZTsKICBfZXhwb3J0cy5vdmVycmlkZUNoYWlucyA9IG92ZXJyaWRlQ2hhaW5zOwogIF9leHBvcnRzLmRlZmluZVByb3BlcnR5ID0gZGVmaW5lUHJvcGVydHk7CiAgX2V4cG9ydHMuaXNFbGVtZW50RGVzY3JpcHRvciA9IGlzRWxlbWVudERlc2NyaXB0b3I7CiAgX2V4cG9ydHMubmF0aXZlRGVzY0RlY29yYXRvciA9IG5hdGl2ZURlc2NEZWNvcmF0b3I7CiAgX2V4cG9ydHMuZGVzY3JpcHRvckZvckRlY29yYXRvciA9IGRlc2NyaXB0b3JGb3JEZWNvcmF0b3I7CiAgX2V4cG9ydHMuZGVzY3JpcHRvckZvclByb3BlcnR5ID0gZGVzY3JpcHRvckZvclByb3BlcnR5OwogIF9leHBvcnRzLmlzQ2xhc3NpY0RlY29yYXRvciA9IGlzQ2xhc3NpY0RlY29yYXRvcjsKICBfZXhwb3J0cy5zZXRDbGFzc2ljRGVjb3JhdG9yID0gc2V0Q2xhc3NpY0RlY29yYXRvcjsKICBfZXhwb3J0cy53YXRjaEtleSA9IHdhdGNoS2V5OwogIF9leHBvcnRzLnVud2F0Y2hLZXkgPSB1bndhdGNoS2V5OwogIF9leHBvcnRzLmZpbmlzaENoYWlucyA9IGZpbmlzaENoYWluczsKICBfZXhwb3J0cy5yZW1vdmVDaGFpbldhdGNoZXIgPSByZW1vdmVDaGFpbldhdGNoZXI7CiAgX2V4cG9ydHMuZ2V0Q2hhaW5UYWdzRm9yS2V5ID0gZ2V0Q2hhaW5UYWdzRm9yS2V5OwogIF9leHBvcnRzLndhdGNoUGF0aCA9IHdhdGNoUGF0aDsKICBfZXhwb3J0cy51bndhdGNoUGF0aCA9IHVud2F0Y2hQYXRoOwogIF9leHBvcnRzLmlzV2F0Y2hpbmcgPSBpc1dhdGNoaW5nOwogIF9leHBvcnRzLnVud2F0Y2ggPSB1bndhdGNoOwogIF9leHBvcnRzLndhdGNoID0gd2F0Y2g7CiAgX2V4cG9ydHMud2F0Y2hlckNvdW50ID0gd2F0Y2hlckNvdW50OwogIF9leHBvcnRzLmdldFByb3BlcnRpZXMgPSBnZXRQcm9wZXJ0aWVzOwogIF9leHBvcnRzLnNldFByb3BlcnRpZXMgPSBzZXRQcm9wZXJ0aWVzOwogIF9leHBvcnRzLmV4cGFuZFByb3BlcnRpZXMgPSBleHBhbmRQcm9wZXJ0aWVzOwogIF9leHBvcnRzLmFkZE9ic2VydmVyID0gYWRkT2JzZXJ2ZXI7CiAgX2V4cG9ydHMuYWN0aXZhdGVPYnNlcnZlciA9IGFjdGl2YXRlT2JzZXJ2ZXI7CiAgX2V4cG9ydHMucmVtb3ZlT2JzZXJ2ZXIgPSByZW1vdmVPYnNlcnZlcjsKICBfZXhwb3J0cy5mbHVzaEFzeW5jT2JzZXJ2ZXJzID0gZmx1c2hBc3luY09ic2VydmVyczsKICBfZXhwb3J0cy5taXhpbiA9IG1peGluOwogIF9leHBvcnRzLm9ic2VydmVyID0gb2JzZXJ2ZXI7CiAgX2V4cG9ydHMuYXBwbHlNaXhpbiA9IGFwcGx5TWl4aW47CiAgX2V4cG9ydHMuaW5qZWN0ID0gaW5qZWN0OwogIF9leHBvcnRzLnRhZ0ZvclByb3BlcnR5ID0gdGFnRm9yUHJvcGVydHk7CiAgX2V4cG9ydHMudGFnRm9yID0gdGFnRm9yOwogIF9leHBvcnRzLm1hcmtPYmplY3RBc0RpcnR5ID0gbWFya09iamVjdEFzRGlydHk7CiAgX2V4cG9ydHMuY29uc3VtZSA9IGNvbnN1bWU7CiAgX2V4cG9ydHMudHJhY2tlZCA9IHRyYWNrZWQ7CiAgX2V4cG9ydHMudHJhY2sgPSB0cmFjazsKICBfZXhwb3J0cy51bnRyYWNrID0gdW50cmFjazsKICBfZXhwb3J0cy5pc1RyYWNraW5nID0gaXNUcmFja2luZzsKICBfZXhwb3J0cy5hZGROYW1lc3BhY2UgPSBhZGROYW1lc3BhY2U7CiAgX2V4cG9ydHMuY2xhc3NUb1N0cmluZyA9IGNsYXNzVG9TdHJpbmc7CiAgX2V4cG9ydHMuZmluZE5hbWVzcGFjZSA9IGZpbmROYW1lc3BhY2U7CiAgX2V4cG9ydHMuZmluZE5hbWVzcGFjZXMgPSBmaW5kTmFtZXNwYWNlczsKICBfZXhwb3J0cy5wcm9jZXNzTmFtZXNwYWNlID0gcHJvY2Vzc05hbWVzcGFjZTsKICBfZXhwb3J0cy5wcm9jZXNzQWxsTmFtZXNwYWNlcyA9IHByb2Nlc3NBbGxOYW1lc3BhY2VzOwogIF9leHBvcnRzLnJlbW92ZU5hbWVzcGFjZSA9IHJlbW92ZU5hbWVzcGFjZTsKICBfZXhwb3J0cy5pc05hbWVzcGFjZVNlYXJjaERpc2FibGVkID0gaXNTZWFyY2hEaXNhYmxlZDsKICBfZXhwb3J0cy5zZXROYW1lc3BhY2VTZWFyY2hEaXNhYmxlZCA9IHNldFNlYXJjaERpc2FibGVkOwogIF9leHBvcnRzLk5BTUVTUEFDRVNfQllfSUQgPSBfZXhwb3J0cy5OQU1FU1BBQ0VTID0gX2V4cG9ydHMuVHJhY2tlciA9IF9leHBvcnRzLmFzc2VydE5vdFJlbmRlcmVkID0gX2V4cG9ydHMuZGlkUmVuZGVyID0gX2V4cG9ydHMucnVuSW5UcmFuc2FjdGlvbiA9IF9leHBvcnRzLlVOS05PV05fUFJPUEVSVFlfVEFHID0gX2V4cG9ydHMuREVCVUdfSU5KRUNUSU9OX0ZVTkNUSU9OUyA9IF9leHBvcnRzLmFsaWFzTWV0aG9kID0gX2V4cG9ydHMuTWl4aW4gPSBfZXhwb3J0cy5MaWJyYXJpZXMgPSBfZXhwb3J0cy5saWJyYXJpZXMgPSBfZXhwb3J0cy5BUkdTX1BST1hZX1RBR1MgPSBfZXhwb3J0cy5DaGFpbk5vZGUgPSBfZXhwb3J0cy5QUk9QRVJUWV9ESURfQ0hBTkdFID0gX2V4cG9ydHMuUFJPWFlfQ09OVEVOVCA9IF9leHBvcnRzLkNvbXB1dGVkUHJvcGVydHkgPSBfZXhwb3J0cy5fZ2xvYmFsc0NvbXB1dGVkID0gdm9pZCAwOwogIHZhciBDT01QVVRFRF9QUk9QRVJUWV9DQUNIRURfVkFMVUVTID0gbmV3IFdlYWtNYXAoKTsKICB2YXIgQ09NUFVURURfUFJPUEVSVFlfTEFTVF9SRVZJU0lPTiA9IG5ldyBXZWFrTWFwKCk7CgogIGZ1bmN0aW9uIGdldENhY2hlRm9yKG9iaikgewogICAgdmFyIGNhY2hlID0gQ09NUFVURURfUFJPUEVSVFlfQ0FDSEVEX1ZBTFVFUy5nZXQob2JqKTsKCiAgICBpZiAoY2FjaGUgPT09IHVuZGVmaW5lZCkgewogICAgICBjYWNoZSA9IG5ldyBNYXAoKTsKICAgICAgQ09NUFVURURfUFJPUEVSVFlfQ0FDSEVEX1ZBTFVFUy5zZXQob2JqLCBjYWNoZSk7CiAgICB9CgogICAgcmV0dXJuIGNhY2hlOwogIH0KICAvKioKICAgIFJldHVybnMgdGhlIGNhY2hlZCB2YWx1ZSBmb3IgYSBwcm9wZXJ0eSwgaWYgb25lIGV4aXN0cy4KICAgIFRoaXMgY2FuIGJlIHVzZWZ1bCBmb3IgcGVla2luZyBhdCB0aGUgdmFsdWUgb2YgYSBjb21wdXRlZAogICAgcHJvcGVydHkgdGhhdCBpcyBnZW5lcmF0ZWQgbGF6aWx5LCB3aXRob3V0IGFjY2lkZW50YWxseSBjYXVzaW5nCiAgICBpdCB0byBiZSBjcmVhdGVkLgogIAogICAgQG1ldGhvZCBjYWNoZUZvcgogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2ludGVybmFscwogICAgQHBhcmFtIHtPYmplY3R9IG9iaiB0aGUgb2JqZWN0IHdob3NlIHByb3BlcnR5IHlvdSB3YW50IHRvIGNoZWNrCiAgICBAcGFyYW0ge1N0cmluZ30ga2V5IHRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB3aG9zZSBjYWNoZWQgdmFsdWUgeW91IHdhbnQKICAgICAgdG8gcmV0dXJuCiAgICBAcmV0dXJuIHtPYmplY3R9IHRoZSBjYWNoZWQgdmFsdWUKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gZ2V0Q2FjaGVkVmFsdWVGb3Iob2JqLCBrZXkpIHsKICAgIHZhciBjYWNoZSA9IENPTVBVVEVEX1BST1BFUlRZX0NBQ0hFRF9WQUxVRVMuZ2V0KG9iaik7CgogICAgaWYgKGNhY2hlICE9PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIGNhY2hlLmdldChrZXkpOwogICAgfQogIH0KCiAgdmFyIHNldExhc3RSZXZpc2lvbkZvcjsKICB2YXIgZ2V0TGFzdFJldmlzaW9uRm9yOwogIHsKICAgIHNldExhc3RSZXZpc2lvbkZvciA9IGZ1bmN0aW9uIHNldExhc3RSZXZpc2lvbkZvcihvYmosIGtleSwgcmV2aXNpb24pIHsKICAgICAgdmFyIGNhY2hlID0gQ09NUFVURURfUFJPUEVSVFlfTEFTVF9SRVZJU0lPTi5nZXQob2JqKTsKCiAgICAgIGlmIChjYWNoZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgY2FjaGUgPSBuZXcgTWFwKCk7CiAgICAgICAgQ09NUFVURURfUFJPUEVSVFlfTEFTVF9SRVZJU0lPTi5zZXQob2JqLCBjYWNoZSk7CiAgICAgIH0KCiAgICAgIGNhY2hlLnNldChrZXksIHJldmlzaW9uKTsKICAgIH07CgogICAgZ2V0TGFzdFJldmlzaW9uRm9yID0gZnVuY3Rpb24gZ2V0TGFzdFJldmlzaW9uRm9yKG9iaiwga2V5KSB7CiAgICAgIHZhciBjYWNoZSA9IENPTVBVVEVEX1BST1BFUlRZX0xBU1RfUkVWSVNJT04uZ2V0KG9iaik7CgogICAgICBpZiAoY2FjaGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiAwOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciByZXZpc2lvbiA9IGNhY2hlLmdldChrZXkpOwogICAgICAgIHJldHVybiByZXZpc2lvbiA9PT0gdW5kZWZpbmVkID8gMCA6IHJldmlzaW9uOwogICAgICB9CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gcGVla0NhY2hlRm9yKG9iaikgewogICAgcmV0dXJuIENPTVBVVEVEX1BST1BFUlRZX0NBQ0hFRF9WQUxVRVMuZ2V0KG9iaik7CiAgfQoKICB2YXIgRUFDSF9QUk9YSUVTID0gbmV3IFdlYWtNYXAoKTsKCiAgZnVuY3Rpb24gZWFjaFByb3h5QXJyYXlXaWxsQ2hhbmdlKGFycmF5LCBpZHgsIHJlbW92ZWRDbnQsIGFkZGVkQ250KSB7CiAgICB2YXIgZWFjaFByb3h5ID0gRUFDSF9QUk9YSUVTLmdldChhcnJheSk7CgogICAgaWYgKGVhY2hQcm94eSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGVhY2hQcm94eS5hcnJheVdpbGxDaGFuZ2UoYXJyYXksIGlkeCwgcmVtb3ZlZENudCwgYWRkZWRDbnQpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZWFjaFByb3h5QXJyYXlEaWRDaGFuZ2UoYXJyYXksIGlkeCwgcmVtb3ZlZENudCwgYWRkZWRDbnQpIHsKICAgIHZhciBlYWNoUHJveHkgPSBFQUNIX1BST1hJRVMuZ2V0KGFycmF5KTsKCiAgICBpZiAoZWFjaFByb3h5ICE9PSB1bmRlZmluZWQpIHsKICAgICAgZWFjaFByb3h5LmFycmF5RGlkQ2hhbmdlKGFycmF5LCBpZHgsIHJlbW92ZWRDbnQsIGFkZGVkQ250KTsKICAgIH0KICB9CiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgKi8KCiAgLyoKICAgIFRoZSBldmVudCBzeXN0ZW0gdXNlcyBhIHNlcmllcyBvZiBuZXN0ZWQgaGFzaGVzIHRvIHN0b3JlIGxpc3RlbmVycyBvbiBhbgogICAgb2JqZWN0LiBXaGVuIGEgbGlzdGVuZXIgaXMgcmVnaXN0ZXJlZCwgb3Igd2hlbiBhbiBldmVudCBhcnJpdmVzLCB0aGVzZQogICAgaGFzaGVzIGFyZSBjb25zdWx0ZWQgdG8gZGV0ZXJtaW5lIHdoaWNoIHRhcmdldCBhbmQgYWN0aW9uIHBhaXIgdG8gaW52b2tlLgogIAogICAgVGhlIGhhc2hlcyBhcmUgc3RvcmVkIGluIHRoZSBvYmplY3QncyBtZXRhIGhhc2gsIGFuZCBsb29rIGxpa2UgdGhpczoKICAKICAgICAgICAvLyBPYmplY3QncyBtZXRhIGhhc2gKICAgICAgICB7CiAgICAgICAgICBsaXN0ZW5lcnM6IHsgICAgICAgLy8gdmFyaWFibGUgbmFtZTogYGxpc3RlbmVyU2V0YAogICAgICAgICAgICAiZm9vOmNoYW5nZSI6IFsgLy8gdmFyaWFibGUgbmFtZTogYGFjdGlvbnNgCiAgICAgICAgICAgICAgdGFyZ2V0LCBtZXRob2QsIG9uY2UKICAgICAgICAgICAgXQogICAgICAgICAgfQogICAgICAgIH0KICAKICAqLwoKICAvKioKICAgIEFkZCBhbiBldmVudCBsaXN0ZW5lcgogIAogICAgQG1ldGhvZCBhZGRMaXN0ZW5lcgogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2V2ZW50cwogICAgQHBhcmFtIG9iagogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50TmFtZQogICAgQHBhcmFtIHtPYmplY3R8RnVuY3Rpb259IHRhcmdldCBBIHRhcmdldCBvYmplY3Qgb3IgYSBmdW5jdGlvbgogICAgQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IG1ldGhvZCBBIGZ1bmN0aW9uIG9yIHRoZSBuYW1lIG9mIGEgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIG9uIGB0YXJnZXRgCiAgICBAcGFyYW0ge0Jvb2xlYW59IG9uY2UgQSBmbGFnIHdoZXRoZXIgYSBmdW5jdGlvbiBzaG91bGQgb25seSBiZSBjYWxsZWQgb25jZQogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBhZGRMaXN0ZW5lcihvYmosIGV2ZW50TmFtZSwgdGFyZ2V0LCBtZXRob2QsIG9uY2UsIHN5bmMpIHsKICAgIGlmIChzeW5jID09PSB2b2lkIDApIHsKICAgICAgc3luYyA9IHRydWU7CiAgICB9CgogICAgKGZhbHNlICYmICEoQm9vbGVhbihvYmopICYmIEJvb2xlYW4oZXZlbnROYW1lKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgbXVzdCBwYXNzIGF0IGxlYXN0IGFuIG9iamVjdCBhbmQgZXZlbnQgbmFtZSB0byBhZGRMaXN0ZW5lcicsIEJvb2xlYW4ob2JqKSAmJiBCb29sZWFuKGV2ZW50TmFtZSkpKTsKCiAgICBpZiAoIW1ldGhvZCAmJiAnZnVuY3Rpb24nID09PSB0eXBlb2YgdGFyZ2V0KSB7CiAgICAgIG1ldGhvZCA9IHRhcmdldDsKICAgICAgdGFyZ2V0ID0gbnVsbDsKICAgIH0KCiAgICAoMCwgX21ldGEyLm1ldGEpKG9iaikuYWRkVG9MaXN0ZW5lcnMoZXZlbnROYW1lLCB0YXJnZXQsIG1ldGhvZCwgb25jZSA9PT0gdHJ1ZSwgc3luYyk7CiAgfQogIC8qKgogICAgUmVtb3ZlIGFuIGV2ZW50IGxpc3RlbmVyCiAgCiAgICBBcmd1bWVudHMgc2hvdWxkIG1hdGNoIHRob3NlIHBhc3NlZCB0byBgYWRkTGlzdGVuZXJgLgogIAogICAgQG1ldGhvZCByZW1vdmVMaXN0ZW5lcgogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2V2ZW50cwogICAgQHBhcmFtIG9iagogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50TmFtZQogICAgQHBhcmFtIHtPYmplY3R8RnVuY3Rpb259IHRhcmdldCBBIHRhcmdldCBvYmplY3Qgb3IgYSBmdW5jdGlvbgogICAgQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IG1ldGhvZCBBIGZ1bmN0aW9uIG9yIHRoZSBuYW1lIG9mIGEgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIG9uIGB0YXJnZXRgCiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIHJlbW92ZUxpc3RlbmVyKG9iaiwgZXZlbnROYW1lLCB0YXJnZXRPckZ1bmN0aW9uLCBmdW5jdGlvbk9yTmFtZSkgewogICAgKGZhbHNlICYmICEoQm9vbGVhbihvYmopICYmIEJvb2xlYW4oZXZlbnROYW1lKSAmJiAodHlwZW9mIHRhcmdldE9yRnVuY3Rpb24gPT09ICdmdW5jdGlvbicgfHwgdHlwZW9mIHRhcmdldE9yRnVuY3Rpb24gPT09ICdvYmplY3QnICYmIEJvb2xlYW4oZnVuY3Rpb25Pck5hbWUpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgbXVzdCBwYXNzIGF0IGxlYXN0IGFuIG9iamVjdCwgZXZlbnQgbmFtZSwgYW5kIG1ldGhvZCBvciB0YXJnZXQgYW5kIG1ldGhvZC9tZXRob2QgbmFtZSB0byByZW1vdmVMaXN0ZW5lcicsIEJvb2xlYW4ob2JqKSAmJiBCb29sZWFuKGV2ZW50TmFtZSkgJiYgKHR5cGVvZiB0YXJnZXRPckZ1bmN0aW9uID09PSAnZnVuY3Rpb24nIHx8IHR5cGVvZiB0YXJnZXRPckZ1bmN0aW9uID09PSAnb2JqZWN0JyAmJiBCb29sZWFuKGZ1bmN0aW9uT3JOYW1lKSkpKTsKICAgIHZhciB0YXJnZXQsIG1ldGhvZDsKCiAgICBpZiAodHlwZW9mIHRhcmdldE9yRnVuY3Rpb24gPT09ICdvYmplY3QnKSB7CiAgICAgIHRhcmdldCA9IHRhcmdldE9yRnVuY3Rpb247CiAgICAgIG1ldGhvZCA9IGZ1bmN0aW9uT3JOYW1lOwogICAgfSBlbHNlIHsKICAgICAgdGFyZ2V0ID0gbnVsbDsKICAgICAgbWV0aG9kID0gdGFyZ2V0T3JGdW5jdGlvbjsKICAgIH0KCiAgICB2YXIgbSA9ICgwLCBfbWV0YTIubWV0YSkob2JqKTsKICAgIG0ucmVtb3ZlRnJvbUxpc3RlbmVycyhldmVudE5hbWUsIHRhcmdldCwgbWV0aG9kKTsKICB9CiAgLyoqCiAgICBTZW5kIGFuIGV2ZW50LiBUaGUgZXhlY3V0aW9uIG9mIHN1c3BlbmRlZCBsaXN0ZW5lcnMKICAgIGlzIHNraXBwZWQsIGFuZCBvbmNlIGxpc3RlbmVycyBhcmUgcmVtb3ZlZC4gQSBsaXN0ZW5lciB3aXRob3V0CiAgICBhIHRhcmdldCBpcyBleGVjdXRlZCBvbiB0aGUgcGFzc2VkIG9iamVjdC4gSWYgYW4gYXJyYXkgb2YgYWN0aW9ucwogICAgaXMgbm90IHBhc3NlZCwgdGhlIGFjdGlvbnMgc3RvcmVkIG9uIHRoZSBwYXNzZWQgb2JqZWN0IGFyZSBpbnZva2VkLgogIAogICAgQG1ldGhvZCBzZW5kRXZlbnQKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL29iamVjdC9ldmVudHMKICAgIEBwYXJhbSBvYmoKICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudE5hbWUKICAgIEBwYXJhbSB7QXJyYXl9IHBhcmFtcyBPcHRpb25hbCBwYXJhbWV0ZXJzIGZvciBlYWNoIGxpc3RlbmVyLgogICAgQHJldHVybiB7Qm9vbGVhbn0gaWYgdGhlIGV2ZW50IHdhcyBkZWxpdmVyZWQgdG8gb25lIG9yIG1vcmUgYWN0aW9ucwogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBzZW5kRXZlbnQob2JqLCBldmVudE5hbWUsIHBhcmFtcywgYWN0aW9ucywgX21ldGEpIHsKICAgIGlmIChhY3Rpb25zID09PSB1bmRlZmluZWQpIHsKICAgICAgdmFyIG1ldGEkJDEgPSBfbWV0YSA9PT0gdW5kZWZpbmVkID8gKDAsIF9tZXRhMi5wZWVrTWV0YSkob2JqKSA6IF9tZXRhOwogICAgICBhY3Rpb25zID0gdHlwZW9mIG1ldGEkJDEgPT09ICdvYmplY3QnICYmIG1ldGEkJDEgIT09IG51bGwgPyBtZXRhJCQxLm1hdGNoaW5nTGlzdGVuZXJzKGV2ZW50TmFtZSkgOiB1bmRlZmluZWQ7CiAgICB9CgogICAgaWYgKGFjdGlvbnMgPT09IHVuZGVmaW5lZCB8fCBhY3Rpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgZm9yICh2YXIgaSA9IGFjdGlvbnMubGVuZ3RoIC0gMzsgaSA+PSAwOyBpIC09IDMpIHsKICAgICAgLy8gbG9vcGluZyBpbiByZXZlcnNlIGZvciBvbmNlIGxpc3RlbmVycwogICAgICB2YXIgdGFyZ2V0ID0gYWN0aW9uc1tpXTsKICAgICAgdmFyIG1ldGhvZCA9IGFjdGlvbnNbaSArIDFdOwogICAgICB2YXIgb25jZSA9IGFjdGlvbnNbaSArIDJdOwoKICAgICAgaWYgKCFtZXRob2QpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgaWYgKG9uY2UpIHsKICAgICAgICByZW1vdmVMaXN0ZW5lcihvYmosIGV2ZW50TmFtZSwgdGFyZ2V0LCBtZXRob2QpOwogICAgICB9CgogICAgICBpZiAoIXRhcmdldCkgewogICAgICAgIHRhcmdldCA9IG9iajsKICAgICAgfQoKICAgICAgaWYgKCdzdHJpbmcnID09PSB0eXBlb2YgbWV0aG9kKSB7CiAgICAgICAgbWV0aG9kID0gdGFyZ2V0W21ldGhvZF07CiAgICAgIH0KCiAgICAgIG1ldGhvZC5hcHBseSh0YXJnZXQsIHBhcmFtcyk7CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfQogIC8qKgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgaGFzTGlzdGVuZXJzCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QvZXZlbnRzCiAgICBAcGFyYW0gb2JqCiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnROYW1lCiAgICBAcmV0dXJuIHtCb29sZWFufSBpZiBgb2JqYCBoYXMgbGlzdGVuZXJzIGZvciBldmVudCBgZXZlbnROYW1lYAogICovCgoKICBmdW5jdGlvbiBoYXNMaXN0ZW5lcnMob2JqLCBldmVudE5hbWUpIHsKICAgIHZhciBtZXRhJCQxID0gKDAsIF9tZXRhMi5wZWVrTWV0YSkob2JqKTsKCiAgICBpZiAobWV0YSQkMSA9PT0gbnVsbCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgdmFyIG1hdGNoZWQgPSBtZXRhJCQxLm1hdGNoaW5nTGlzdGVuZXJzKGV2ZW50TmFtZSk7CiAgICByZXR1cm4gbWF0Y2hlZCAhPT0gdW5kZWZpbmVkICYmIG1hdGNoZWQubGVuZ3RoID4gMDsKICB9CiAgLyoqCiAgICBEZWZpbmUgYSBwcm9wZXJ0eSBhcyBhIGZ1bmN0aW9uIHRoYXQgc2hvdWxkIGJlIGV4ZWN1dGVkIHdoZW4KICAgIGEgc3BlY2lmaWVkIGV2ZW50IG9yIGV2ZW50cyBhcmUgdHJpZ2dlcmVkLgogIAogICAgYGBgIGphdmFzY3JpcHQKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IG9uIH0gZnJvbSAnQGVtYmVyL29iamVjdC9ldmVudGVkJzsKICAgIGltcG9ydCB7IHNlbmRFdmVudCB9IGZyb20gJ0BlbWJlci9vYmplY3QvZXZlbnRzJzsKICAKICAgIGxldCBKb2IgPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICBsb2dDb21wbGV0ZWQ6IG9uKCdjb21wbGV0ZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICBjb25zb2xlLmxvZygnSm9iIGNvbXBsZXRlZCEnKTsKICAgICAgfSkKICAgIH0pOwogIAogICAgbGV0IGpvYiA9IEpvYi5jcmVhdGUoKTsKICAKICAgIHNlbmRFdmVudChqb2IsICdjb21wbGV0ZWQnKTsgLy8gTG9ncyAnSm9iIGNvbXBsZXRlZCEnCiAgIGBgYAogIAogICAgQG1ldGhvZCBvbgogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2V2ZW50ZWQKICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudE5hbWVzKgogICAgQHBhcmFtIHtGdW5jdGlvbn0gZnVuYwogICAgQHJldHVybiB7RnVuY3Rpb259IHRoZSBsaXN0ZW5lciBmdW5jdGlvbiwgcGFzc2VkIGFzIGxhc3QgYXJndW1lbnQgdG8gb24oLi4uKQogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBvbigpIHsKICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5MiA9IDA7IF9rZXkyIDwgX2xlbjsgX2tleTIrKykgewogICAgICBhcmdzW19rZXkyXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICB9CgogICAgdmFyIGZ1bmMgPSBhcmdzLnBvcCgpOwogICAgdmFyIGV2ZW50cyA9IGFyZ3M7CiAgICAoZmFsc2UgJiYgISh0eXBlb2YgZnVuYyA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdvbiBleHBlY3RzIGZ1bmN0aW9uIGFzIGxhc3QgYXJndW1lbnQnLCB0eXBlb2YgZnVuYyA9PT0gJ2Z1bmN0aW9uJykpOwogICAgKGZhbHNlICYmICEoZXZlbnRzLmxlbmd0aCA+IDAgJiYgZXZlbnRzLmV2ZXJ5KGZ1bmN0aW9uIChwKSB7CiAgICAgIHJldHVybiB0eXBlb2YgcCA9PT0gJ3N0cmluZycgJiYgcC5sZW5ndGggPiAwOwogICAgfSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnb24gY2FsbGVkIHdpdGhvdXQgdmFsaWQgZXZlbnQgbmFtZXMnLCBldmVudHMubGVuZ3RoID4gMCAmJiBldmVudHMuZXZlcnkoZnVuY3Rpb24gKHApIHsKICAgICAgcmV0dXJuIHR5cGVvZiBwID09PSAnc3RyaW5nJyAmJiBwLmxlbmd0aCA+IDA7CiAgICB9KSkpOwogICAgKDAsIF91dGlscy5zZXRMaXN0ZW5lcnMpKGZ1bmMsIGV2ZW50cyk7CiAgICByZXR1cm4gZnVuYzsKICB9CgogIHZhciBBRlRFUl9PQlNFUlZFUlMgPSAnOmNoYW5nZSc7CgogIGZ1bmN0aW9uIGNoYW5nZUV2ZW50KGtleU5hbWUpIHsKICAgIHJldHVybiBrZXlOYW1lICsgQUZURVJfT0JTRVJWRVJTOwogIH0KCiAgdmFyIERFQ09SQVRPUl9ERVNDUklQVE9SX01BUCA9IG5ldyBXZWFrTWFwKCk7CiAgLyoqCiAgICBSZXR1cm5zIHRoZSBDUCBkZXNjcmlwdG9yIGFzc29jYWl0ZWQgd2l0aCBgb2JqYCBhbmQgYGtleU5hbWVgLCBpZiBhbnkuCiAgCiAgICBAbWV0aG9kIGRlc2NyaXB0b3JGb3JQcm9wZXJ0eQogICAgQHBhcmFtIHtPYmplY3R9IG9iaiB0aGUgb2JqZWN0IHRvIGNoZWNrCiAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSB0aGUga2V5IHRvIGNoZWNrCiAgICBAcmV0dXJuIHtEZXNjcmlwdG9yfQogICAgQHByaXZhdGUKICAqLwoKICBmdW5jdGlvbiBkZXNjcmlwdG9yRm9yUHJvcGVydHkob2JqLCBrZXlOYW1lLCBfbWV0YSkgewogICAgKGZhbHNlICYmICEob2JqICE9PSBudWxsKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0Nhbm5vdCBjYWxsIGBkZXNjcmlwdG9yRm9yUHJvcGVydHlgIG9uIG51bGwnLCBvYmogIT09IG51bGwpKTsKICAgIChmYWxzZSAmJiAhKG9iaiAhPT0gdW5kZWZpbmVkKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0Nhbm5vdCBjYWxsIGBkZXNjcmlwdG9yRm9yUHJvcGVydHlgIG9uIHVuZGVmaW5lZCcsIG9iaiAhPT0gdW5kZWZpbmVkKSk7CiAgICAoZmFsc2UgJiYgISh0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyB8fCB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkNhbm5vdCBjYWxsIGBkZXNjcmlwdG9yRm9yUHJvcGVydHlgIG9uICIgKyB0eXBlb2Ygb2JqLCB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyB8fCB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nKSk7CiAgICB2YXIgbWV0YSQkMSA9IF9tZXRhID09PSB1bmRlZmluZWQgPyAoMCwgX21ldGEyLnBlZWtNZXRhKShvYmopIDogX21ldGE7CgogICAgaWYgKG1ldGEkJDEgIT09IG51bGwpIHsKICAgICAgcmV0dXJuIG1ldGEkJDEucGVla0Rlc2NyaXB0b3JzKGtleU5hbWUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZGVzY3JpcHRvckZvckRlY29yYXRvcihkZWMpIHsKICAgIHJldHVybiBERUNPUkFUT1JfREVTQ1JJUFRPUl9NQVAuZ2V0KGRlYyk7CiAgfQogIC8qKgogICAgQ2hlY2sgd2hldGhlciBhIHZhbHVlIGlzIGEgZGVjb3JhdG9yCiAgCiAgICBAbWV0aG9kIGlzQ2xhc3NpY0RlY29yYXRvcgogICAgQHBhcmFtIHthbnl9IHBvc3NpYmxlRGVzYyB0aGUgdmFsdWUgdG8gY2hlY2sKICAgIEByZXR1cm4ge2Jvb2xlYW59CiAgICBAcHJpdmF0ZQogICovCgoKICBmdW5jdGlvbiBpc0NsYXNzaWNEZWNvcmF0b3IoZGVjKSB7CiAgICByZXR1cm4gZGVjICE9PSBudWxsICYmIGRlYyAhPT0gdW5kZWZpbmVkICYmIERFQ09SQVRPUl9ERVNDUklQVE9SX01BUC5oYXMoZGVjKTsKICB9CiAgLyoqCiAgICBTZXQgYSB2YWx1ZSBhcyBhIGRlY29yYXRvcgogIAogICAgQG1ldGhvZCBzZXRDbGFzc2ljRGVjb3JhdG9yCiAgICBAcGFyYW0ge2Z1bmN0aW9ufSBkZWNvcmF0b3IgdGhlIHZhbHVlIHRvIG1hcmsgYXMgYSBkZWNvcmF0b3IKICAgIEBwcml2YXRlCiAgKi8KCgogIGZ1bmN0aW9uIHNldENsYXNzaWNEZWNvcmF0b3IoZGVjLCB2YWx1ZSQkMSkgewogICAgaWYgKHZhbHVlJCQxID09PSB2b2lkIDApIHsKICAgICAgdmFsdWUkJDEgPSB0cnVlOwogICAgfQoKICAgIERFQ09SQVRPUl9ERVNDUklQVE9SX01BUC5zZXQoZGVjLCB2YWx1ZSQkMSk7CiAgfQoKICB2YXIgZmlyc3REb3RJbmRleENhY2hlID0gbmV3IF91dGlscy5DYWNoZSgxMDAwLCBmdW5jdGlvbiAoa2V5KSB7CiAgICByZXR1cm4ga2V5LmluZGV4T2YoJy4nKTsKICB9KTsKCiAgZnVuY3Rpb24gaXNQYXRoKHBhdGgpIHsKICAgIHJldHVybiB0eXBlb2YgcGF0aCA9PT0gJ3N0cmluZycgJiYgZmlyc3REb3RJbmRleENhY2hlLmdldChwYXRoKSAhPT0gLTE7CiAgfQogIC8qKgogIEBtb2R1bGUgQGVtYmVyL29iamVjdAogICovCiAgLy8gREVGSU5JTkcgUFJPUEVSVElFUyBBUEkKICAvLwoKCiAgZnVuY3Rpb24gTUFOREFUT1JZX1NFVFRFUl9GVU5DVElPTihuYW1lKSB7CiAgICBmdW5jdGlvbiBTRVRURVJfRlVOQ1RJT04odmFsdWUkJDEpIHsKICAgICAgdmFyIG0gPSAoMCwgX21ldGEyLnBlZWtNZXRhKSh0aGlzKTsKCiAgICAgIGlmIChtLmlzSW5pdGlhbGl6aW5nKCkgfHwgbS5pc1Byb3RvdHlwZU1ldGEodGhpcykpIHsKICAgICAgICBtLndyaXRlVmFsdWVzKG5hbWUsIHZhbHVlJCQxKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJZb3UgbXVzdCB1c2Ugc2V0KCkgdG8gc2V0IHRoZSBgIiArIG5hbWUgKyAiYCBwcm9wZXJ0eSAob2YgIiArIHRoaXMgKyAiKSB0byBgIiArIHZhbHVlJCQxICsgImAuIiwgZmFsc2UpKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKFNFVFRFUl9GVU5DVElPTiwgewogICAgICBpc01hbmRhdG9yeVNldHRlcjogdHJ1ZQogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBERUZBVUxUX0dFVFRFUl9GVU5DVElPTihuYW1lKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gR0VUVEVSX0ZVTkNUSU9OKCkgewogICAgICB2YXIgbWV0YSQkMSA9ICgwLCBfbWV0YTIucGVla01ldGEpKHRoaXMpOwoKICAgICAgaWYgKG1ldGEkJDEgIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gbWV0YSQkMS5wZWVrVmFsdWVzKG5hbWUpOwogICAgICB9CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gSU5IRVJJVElOR19HRVRURVJfRlVOQ1RJT04obmFtZSkgewogICAgZnVuY3Rpb24gSUdFVFRFUl9GVU5DVElPTigpIHsKICAgICAgdmFyIG1ldGEkJDEgPSAoMCwgX21ldGEyLnBlZWtNZXRhKSh0aGlzKTsKICAgICAgdmFyIHZhbDsKCiAgICAgIGlmIChtZXRhJCQxICE9PSBudWxsKSB7CiAgICAgICAgdmFsID0gbWV0YSQkMS5yZWFkSW5oZXJpdGVkVmFsdWUobmFtZSk7CgogICAgICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdmFyIHByb3RvID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpOwogICAgICAgICAgdmFsID0gcHJvdG8gPT09IG51bGwgPyB1bmRlZmluZWQgOiBwcm90b1tuYW1lXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFsID0gdmFsID09PSBfbWV0YTIuVU5ERUZJTkVEID8gdW5kZWZpbmVkIDogdmFsOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHZhbDsKICAgIH0KCiAgICByZXR1cm4gKDAsIF9wb2x5ZmlsbHMuYXNzaWduKShJR0VUVEVSX0ZVTkNUSU9OLCB7CiAgICAgIGlzSW5oZXJpdGluZ0dldHRlcjogdHJ1ZQogICAgfSk7CiAgfQogIC8qKgogICAgTk9URTogVGhpcyBpcyBhIGxvdy1sZXZlbCBtZXRob2QgdXNlZCBieSBvdGhlciBwYXJ0cyBvZiB0aGUgQVBJLiBZb3UgYWxtb3N0CiAgICBuZXZlciB3YW50IHRvIGNhbGwgdGhpcyBtZXRob2QgZGlyZWN0bHkuIEluc3RlYWQgeW91IHNob3VsZCB1c2UKICAgIGBtaXhpbigpYCB0byBkZWZpbmUgbmV3IHByb3BlcnRpZXMuCiAgCiAgICBEZWZpbmVzIGEgcHJvcGVydHkgb24gYW4gb2JqZWN0LiBUaGlzIG1ldGhvZCB3b3JrcyBtdWNoIGxpa2UgdGhlIEVTNQogICAgYE9iamVjdC5kZWZpbmVQcm9wZXJ0eSgpYCBtZXRob2QgZXhjZXB0IHRoYXQgaXQgY2FuIGFsc28gYWNjZXB0IGNvbXB1dGVkCiAgICBwcm9wZXJ0aWVzIGFuZCBvdGhlciBzcGVjaWFsIGRlc2NyaXB0b3JzLgogIAogICAgTm9ybWFsbHkgdGhpcyBtZXRob2QgdGFrZXMgb25seSB0aHJlZSBwYXJhbWV0ZXJzLiBIb3dldmVyIGlmIHlvdSBwYXNzIGFuCiAgICBpbnN0YW5jZSBvZiBgRGVzY3JpcHRvcmAgYXMgdGhlIHRoaXJkIHBhcmFtIHRoZW4geW91IGNhbiBwYXNzIGFuCiAgICBvcHRpb25hbCB2YWx1ZSBhcyB0aGUgZm91cnRoIHBhcmFtZXRlci4gVGhpcyBpcyBvZnRlbiBtb3JlIGVmZmljaWVudCB0aGFuCiAgICBjcmVhdGluZyBuZXcgZGVzY3JpcHRvciBoYXNoZXMgZm9yIGVhY2ggcHJvcGVydHkuCiAgCiAgICAjIyBFeGFtcGxlcwogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgZGVmaW5lUHJvcGVydHksIGNvbXB1dGVkIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICAvLyBFUzUgY29tcGF0aWJsZSBtb2RlCiAgICBkZWZpbmVQcm9wZXJ0eShjb250YWN0LCAnZmlyc3ROYW1lJywgewogICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgdmFsdWU6ICdDaGFybGVzJwogICAgfSk7CiAgCiAgICAvLyBkZWZpbmUgYSBzaW1wbGUgcHJvcGVydHkKICAgIGRlZmluZVByb3BlcnR5KGNvbnRhY3QsICdsYXN0TmFtZScsIHVuZGVmaW5lZCwgJ0pvbGxleScpOwogIAogICAgLy8gZGVmaW5lIGEgY29tcHV0ZWQgcHJvcGVydHkKICAgIGRlZmluZVByb3BlcnR5KGNvbnRhY3QsICdmdWxsTmFtZScsIGNvbXB1dGVkKCdmaXJzdE5hbWUnLCAnbGFzdE5hbWUnLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuZmlyc3ROYW1lKycgJyt0aGlzLmxhc3ROYW1lOwogICAgfSkpOwogICAgYGBgCiAgCiAgICBAcHVibGljCiAgICBAbWV0aG9kIGRlZmluZVByb3BlcnR5CiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogdGhlIG9iamVjdCB0byBkZWZpbmUgdGhpcyBwcm9wZXJ0eSBvbi4gVGhpcyBtYXkgYmUgYSBwcm90b3R5cGUuCiAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSB0aGUgbmFtZSBvZiB0aGUgcHJvcGVydHkKICAgIEBwYXJhbSB7RGVzY3JpcHRvcn0gW2Rlc2NdIGFuIGluc3RhbmNlIG9mIGBEZXNjcmlwdG9yYCAodHlwaWNhbGx5IGEKICAgICAgY29tcHV0ZWQgcHJvcGVydHkpIG9yIGFuIEVTNSBkZXNjcmlwdG9yLgogICAgICBZb3UgbXVzdCBwcm92aWRlIHRoaXMgb3IgYGRhdGFgIGJ1dCBub3QgYm90aC4KICAgIEBwYXJhbSB7Kn0gW2RhdGFdIHNvbWV0aGluZyBvdGhlciB0aGFuIGEgZGVzY3JpcHRvciwgdGhhdCB3aWxsCiAgICAgIGJlY29tZSB0aGUgZXhwbGljaXQgdmFsdWUgb2YgdGhpcyBwcm9wZXJ0eS4KICAqLwoKCiAgZnVuY3Rpb24gZGVmaW5lUHJvcGVydHkob2JqLCBrZXlOYW1lLCBkZXNjLCBkYXRhLCBtZXRhJCQxKSB7CiAgICBpZiAobWV0YSQkMSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIG1ldGEkJDEgPSAoMCwgX21ldGEyLm1ldGEpKG9iaik7CiAgICB9CgogICAgdmFyIHdhdGNoaW5nID0gbWV0YSQkMS5wZWVrV2F0Y2hpbmcoa2V5TmFtZSkgPiAwOwogICAgdmFyIHByZXZpb3VzRGVzYyA9IGRlc2NyaXB0b3JGb3JQcm9wZXJ0eShvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgdmFyIHdhc0Rlc2NyaXB0b3IgPSBwcmV2aW91c0Rlc2MgIT09IHVuZGVmaW5lZDsKCiAgICBpZiAod2FzRGVzY3JpcHRvcikgewogICAgICBwcmV2aW91c0Rlc2MudGVhcmRvd24ob2JqLCBrZXlOYW1lLCBtZXRhJCQxKTsKICAgIH0gLy8gdXNlZCB0byB0cmFjayBpZiB0aGUgdGhlIHByb3BlcnR5IGJlaW5nIGRlZmluZWQgYmUgZW51bWVyYWJsZQoKCiAgICB2YXIgZW51bWVyYWJsZSA9IHRydWU7IC8vIEVtYmVyLk5hdGl2ZUFycmF5IGlzIGEgbm9ybWFsIEVtYmVyLk1peGluIHRoYXQgd2UgbWl4IGludG8gYEFycmF5LnByb3RvdHlwZWAgd2hlbiBwcm90b3R5cGUgZXh0ZW5zaW9ucyBhcmUgZW5hYmxlZAogICAgLy8gbXV0YXRpbmcgYSBuYXRpdmUgb2JqZWN0IHByb3RvdHlwZSBsaWtlIHRoaXMgc2hvdWxkIF9ub3RfIHJlc3VsdCBpbiBlbnVtZXJhYmxlIHByb3BlcnRpZXMgYmVpbmcgYWRkZWQgKG9yIHdlIGhhdmUgc2lnbmlmaWNhbnQKICAgIC8vIGlzc3VlcyB3aXRoIHRoaW5ncyBsaWtlIGRlZXAgZXF1YWxpdHkgY2hlY2tzIGZyb20gdGVzdCBmcmFtZXdvcmtzLCBvciB0aGluZ3MgbGlrZSBqUXVlcnkuZXh0ZW5kKHRydWUsIFtdLCBbXSkpLgogICAgLy8KICAgIC8vIHRoaXMgaXMgYSBoYWNrLCBhbmQgd2Ugc2hvdWxkIHN0b3AgbXV0YXRpbmcgdGhlIGFycmF5IHByb3RvdHlwZSBieSBkZWZhdWx0IPCfmKsKCiAgICBpZiAob2JqID09PSBBcnJheS5wcm90b3R5cGUpIHsKICAgICAgZW51bWVyYWJsZSA9IGZhbHNlOwogICAgfQoKICAgIHZhciB2YWx1ZSQkMTsKCiAgICBpZiAoaXNDbGFzc2ljRGVjb3JhdG9yKGRlc2MpKSB7CiAgICAgIHZhciBwcm9wZXJ0eURlc2M7CgogICAgICBpZiAoZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgKSB7CiAgICAgICAgcHJvcGVydHlEZXNjID0gZGVzYyhvYmosIGtleU5hbWUsIHVuZGVmaW5lZCwgbWV0YSQkMSwgdHJ1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcHJvcGVydHlEZXNjID0gZGVzYyhvYmosIGtleU5hbWUsIHVuZGVmaW5lZCwgbWV0YSQkMSk7CiAgICAgIH0KCiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleU5hbWUsIHByb3BlcnR5RGVzYyk7IC8vIHBhc3MgdGhlIGRlY29yYXRvciBmdW5jdGlvbiBmb3J3YXJkIGZvciBiYWNrd2FyZHMgY29tcGF0CgogICAgICB2YWx1ZSQkMSA9IGRlc2M7CiAgICB9IGVsc2UgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCB8fCBkZXNjID09PSBudWxsKSB7CiAgICAgIHZhbHVlJCQxID0gZGF0YTsKCiAgICAgIGlmIChmYWxzZQogICAgICAvKiBERUJVRyAqLwogICAgICAmJiB3YXRjaGluZykgewogICAgICAgIG1ldGEkJDEud3JpdGVWYWx1ZXMoa2V5TmFtZSwgZGF0YSk7CiAgICAgICAgdmFyIGRlZmF1bHREZXNjcmlwdG9yID0gewogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgZW51bWVyYWJsZTogZW51bWVyYWJsZSwKICAgICAgICAgIHNldDogTUFOREFUT1JZX1NFVFRFUl9GVU5DVElPTihrZXlOYW1lKSwKICAgICAgICAgIGdldDogREVGQVVMVF9HRVRURVJfRlVOQ1RJT04oa2V5TmFtZSkKICAgICAgICB9OwogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleU5hbWUsIGRlZmF1bHREZXNjcmlwdG9yKTsKICAgICAgfSBlbHNlIGlmICh3YXNEZXNjcmlwdG9yIHx8IGVudW1lcmFibGUgPT09IGZhbHNlKSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgewogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgZW51bWVyYWJsZTogZW51bWVyYWJsZSwKICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgdmFsdWU6IHZhbHVlJCQxCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHRydWUKICAgICAgICAvKiBFTUJFUl9NRVRBTF9UUkFDS0VEX1BST1BFUlRJRVMgKi8KICAgICAgICAmJiBmYWxzZQogICAgICAgIC8qIERFQlVHICovCiAgICAgICAgKSB7CiAgICAgICAgICAoMCwgX3V0aWxzLnNldFdpdGhNYW5kYXRvcnlTZXR0ZXIpKG9iaiwga2V5TmFtZSwgZGF0YSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9ialtrZXlOYW1lXSA9IGRhdGE7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YWx1ZSQkMSA9IGRlc2M7IC8vIGZhbGxiYWNrIHRvIEVTNQoKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgZGVzYyk7CiAgICB9IC8vIGlmIGtleSBpcyBiZWluZyB3YXRjaGVkLCBvdmVycmlkZSBjaGFpbnMgdGhhdAogICAgLy8gd2VyZSBpbml0aWFsaXplZCB3aXRoIHRoZSBwcm90b3R5cGUKCgogICAgewogICAgICBpZiAoIW1ldGEkJDEuaXNQcm90b3R5cGVNZXRhKG9iaikpIHsKICAgICAgICByZXZhbGlkYXRlT2JzZXJ2ZXJzKG9iaik7CiAgICAgIH0KICAgIH0gLy8gVGhlIGB2YWx1ZWAgcGFzc2VkIHRvIHRoZSBgZGlkRGVmaW5lUHJvcGVydHlgIGhvb2sgaXMKICAgIC8vIGVpdGhlciB0aGUgZGVzY3JpcHRvciBvciBkYXRhLCB3aGljaGV2ZXIgd2FzIHBhc3NlZC4KCiAgICBpZiAodHlwZW9mIG9iai5kaWREZWZpbmVQcm9wZXJ0eSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBvYmouZGlkRGVmaW5lUHJvcGVydHkob2JqLCBrZXlOYW1lLCB2YWx1ZSQkMSk7CiAgICB9CiAgfQoKICB2YXIgaGFuZGxlTWFuZGF0b3J5U2V0dGVyOwoKICBmdW5jdGlvbiB3YXRjaEtleShvYmosIGtleU5hbWUsIF9tZXRhKSB7CiAgICB2YXIgbWV0YSQkMSA9IF9tZXRhID09PSB1bmRlZmluZWQgPyAoMCwgX21ldGEyLm1ldGEpKG9iaikgOiBfbWV0YTsKICAgIHZhciBjb3VudCA9IG1ldGEkJDEucGVla1dhdGNoaW5nKGtleU5hbWUpOwogICAgbWV0YSQkMS53cml0ZVdhdGNoaW5nKGtleU5hbWUsIGNvdW50ICsgMSk7CgogICAgaWYgKGNvdW50ID09PSAwKSB7CiAgICAgIC8vIGFjdGl2YXRlIHdhdGNoaW5nIGZpcnN0IHRpbWUKICAgICAgdmFyIHBvc3NpYmxlRGVzYyA9IGRlc2NyaXB0b3JGb3JQcm9wZXJ0eShvYmosIGtleU5hbWUsIG1ldGEkJDEpOwoKICAgICAgaWYgKHBvc3NpYmxlRGVzYyAhPT0gdW5kZWZpbmVkICYmIHBvc3NpYmxlRGVzYy53aWxsV2F0Y2ggIT09IHVuZGVmaW5lZCkgewogICAgICAgIHBvc3NpYmxlRGVzYy53aWxsV2F0Y2gob2JqLCBrZXlOYW1lLCBtZXRhJCQxKTsKICAgICAgfQoKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICkgewogICAgICAgIC8vIE5PVEU6IHRoaXMgaXMgZHJvcHBlZCBmb3IgcHJvZCArIG1pbmlmaWVkIGJ1aWxkcwogICAgICAgIGhhbmRsZU1hbmRhdG9yeVNldHRlcihtZXRhJCQxLCBvYmosIGtleU5hbWUpOwogICAgICB9CiAgICB9CiAgfQoKICBpZiAoZmFsc2UKICAvKiBERUJVRyAqLwogICkgewogICAgdmFyIF9oYXNPd25Qcm9wZXJ0eSA9IGZ1bmN0aW9uIF9oYXNPd25Qcm9wZXJ0eShvYmosIGtleSkgewogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKICAgIH07CgogICAgdmFyIF9wcm9wZXJ0eUlzRW51bWVyYWJsZSA9IGZ1bmN0aW9uIF9wcm9wZXJ0eUlzRW51bWVyYWJsZShvYmosIGtleSkgewogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKG9iaiwga2V5KTsKICAgIH07IC8vIEZ1dHVyZSB0cmF2ZWxlciwgYWx0aG91Z2ggdGhpcyBjb2RlIGxvb2tzIHNjYXJ5LiBJdCBtZXJlbHkgZXhpc3RzIGluCiAgICAvLyBkZXZlbG9wbWVudCB0byBhaWQgaW4gZGV2ZWxvcG1lbnQgYXNlcnRpb25zLiBQcm9kdWN0aW9uIGJ1aWxkcyBvZgogICAgLy8gZW1iZXIgc3RyaXAgdGhpcyBlbnRpcmUgYmxvY2sgb3V0CgoKICAgIGhhbmRsZU1hbmRhdG9yeVNldHRlciA9IGZ1bmN0aW9uIGhhbmRsZU1hbmRhdG9yeVNldHRlcihtLCBvYmosIGtleU5hbWUpIHsKICAgICAgdmFyIGRlc2NyaXB0b3IgPSAoMCwgX3V0aWxzLmxvb2t1cERlc2NyaXB0b3IpKG9iaiwga2V5TmFtZSk7CiAgICAgIHZhciBoYXNEZXNjcmlwdG9yID0gZGVzY3JpcHRvciAhPT0gbnVsbDsKICAgICAgdmFyIHBvc3NpYmxlRGVzYyA9IGhhc0Rlc2NyaXB0b3IgJiYgZGVzY3JpcHRvci52YWx1ZTsKCiAgICAgIGlmIChpc0NsYXNzaWNEZWNvcmF0b3IocG9zc2libGVEZXNjKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGNvbmZpZ3VyYWJsZSA9IGhhc0Rlc2NyaXB0b3IgPyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA6IHRydWU7CiAgICAgIHZhciBpc1dyaXRhYmxlID0gaGFzRGVzY3JpcHRvciA/IGRlc2NyaXB0b3Iud3JpdGFibGUgOiB0cnVlOwogICAgICB2YXIgaGFzVmFsdWUgPSBoYXNEZXNjcmlwdG9yID8gJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yIDogdHJ1ZTsgLy8gdGhpcyB4IGluIFkgZGVvcHRzLCBzbyBrZWVwaW5nIGl0IGluIHRoaXMgZnVuY3Rpb24gaXMgYmV0dGVyOwoKICAgICAgaWYgKGNvbmZpZ3VyYWJsZSAmJiBpc1dyaXRhYmxlICYmIGhhc1ZhbHVlICYmIGtleU5hbWUgaW4gb2JqKSB7CiAgICAgICAgdmFyIGRlc2MgPSB7CiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICBzZXQ6IE1BTkRBVE9SWV9TRVRURVJfRlVOQ1RJT04oa2V5TmFtZSksCiAgICAgICAgICBlbnVtZXJhYmxlOiBfcHJvcGVydHlJc0VudW1lcmFibGUob2JqLCBrZXlOYW1lKSwKICAgICAgICAgIGdldDogdW5kZWZpbmVkCiAgICAgICAgfTsKCiAgICAgICAgaWYgKF9oYXNPd25Qcm9wZXJ0eShvYmosIGtleU5hbWUpKSB7CiAgICAgICAgICBtLndyaXRlVmFsdWVzKGtleU5hbWUsIG9ialtrZXlOYW1lXSk7CiAgICAgICAgICBkZXNjLmdldCA9IERFRkFVTFRfR0VUVEVSX0ZVTkNUSU9OKGtleU5hbWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZXNjLmdldCA9IElOSEVSSVRJTkdfR0VUVEVSX0ZVTkNUSU9OKGtleU5hbWUpOwogICAgICAgIH0KCiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgZGVzYyk7CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiB1bndhdGNoS2V5KG9iaiwga2V5TmFtZSwgX21ldGEpIHsKICAgIHZhciBtZXRhJCQxID0gX21ldGEgPT09IHVuZGVmaW5lZCA/ICgwLCBfbWV0YTIucGVla01ldGEpKG9iaikgOiBfbWV0YTsgLy8gZG8gbm90aGluZyBvZiB0aGlzIG9iamVjdCBoYXMgYWxyZWFkeSBiZWVuIGRlc3Ryb3llZAoKICAgIGlmIChtZXRhJCQxID09PSBudWxsIHx8IG1ldGEkJDEuaXNTb3VyY2VEZXN0cm95ZWQoKSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGNvdW50ID0gbWV0YSQkMS5wZWVrV2F0Y2hpbmcoa2V5TmFtZSk7CgogICAgaWYgKGNvdW50ID09PSAxKSB7CiAgICAgIG1ldGEkJDEud3JpdGVXYXRjaGluZyhrZXlOYW1lLCAwKTsKICAgICAgdmFyIHBvc3NpYmxlRGVzYyA9IGRlc2NyaXB0b3JGb3JQcm9wZXJ0eShvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgICB2YXIgaXNEZXNjcmlwdG9yID0gcG9zc2libGVEZXNjICE9PSB1bmRlZmluZWQ7CgogICAgICBpZiAoaXNEZXNjcmlwdG9yICYmIHBvc3NpYmxlRGVzYy5kaWRVbndhdGNoICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBwb3NzaWJsZURlc2MuZGlkVW53YXRjaChvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgICB9CgogICAgICBpZiAodHlwZW9mIG9iai5kaWRVbndhdGNoUHJvcGVydHkgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBvYmouZGlkVW53YXRjaFByb3BlcnR5KGtleU5hbWUpOwogICAgICB9CgogICAgICBpZiAoZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgKSB7CiAgICAgICAgLy8gSXQgaXMgdHJ1ZSwgdGhlIGZvbGxvd2luZyBjb2RlIGxvb2tzIHF1aXRlIFdBVC4gQnV0IGhhdmUgbm8gZmVhciwgSXQKICAgICAgICAvLyBleGlzdHMgcHVyZWx5IHRvIGltcHJvdmUgZGV2ZWxvcG1lbnQgZXJnb25vbWljcyBhbmQgaXMgcmVtb3ZlZCBmcm9tCiAgICAgICAgLy8gZW1iZXIubWluLmpzIGFuZCBlbWJlci5wcm9kLmpzIGJ1aWxkcy4KICAgICAgICAvLwogICAgICAgIC8vIFNvbWUgZnVydGhlciBjb250ZXh0OiBPbmNlIGEgcHJvcGVydHkgaXMgd2F0Y2hlZCBieSBlbWJlciwgYnlwYXNzaW5nIGBzZXRgCiAgICAgICAgLy8gZm9yIG11dGF0aW9uLCB3aWxsIGJ5cGFzcyBvYnNlcnZhdGlvbi4gVGhpcyBjb2RlIGV4aXN0cyB0byBhc3NlcnQgd2hlbgogICAgICAgIC8vIHRoYXQgb2NjdXJzLCBhbmQgYXR0ZW1wdCB0byBwcm92aWRlIG1vcmUgaGVscGZ1bCBmZWVkYmFjay4gVGhlIGFsdGVybmF0aXZlCiAgICAgICAgLy8gaXMgdHJpY2t5IHRvIGRlYnVnIHBhcnRpYWxseSBvYnNlcnZhYmxlIHByb3BlcnRpZXMuCiAgICAgICAgaWYgKCFpc0Rlc2NyaXB0b3IgJiYga2V5TmFtZSBpbiBvYmopIHsKICAgICAgICAgIHZhciBtYXliZU1hbmRhdG9yeURlc2NyaXB0b3IgPSAoMCwgX3V0aWxzLmxvb2t1cERlc2NyaXB0b3IpKG9iaiwga2V5TmFtZSk7CgogICAgICAgICAgaWYgKG1heWJlTWFuZGF0b3J5RGVzY3JpcHRvciAmJiBtYXliZU1hbmRhdG9yeURlc2NyaXB0b3Iuc2V0ICYmIG1heWJlTWFuZGF0b3J5RGVzY3JpcHRvci5zZXQuaXNNYW5kYXRvcnlTZXR0ZXIpIHsKICAgICAgICAgICAgaWYgKG1heWJlTWFuZGF0b3J5RGVzY3JpcHRvci5nZXQgJiYgbWF5YmVNYW5kYXRvcnlEZXNjcmlwdG9yLmdldC5pc0luaGVyaXRpbmdHZXR0ZXIpIHsKICAgICAgICAgICAgICB2YXIgcG9zc2libGVWYWx1ZSA9IG1ldGEkJDEucmVhZEluaGVyaXRlZFZhbHVlKGtleU5hbWUpOwoKICAgICAgICAgICAgICBpZiAocG9zc2libGVWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgb2JqW2tleU5hbWVdOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgewogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBPYmplY3QucHJvdG90eXBlLnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwob2JqLCBrZXlOYW1lKSwKICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgICB2YWx1ZTogbWV0YSQkMS5wZWVrVmFsdWVzKGtleU5hbWUpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBtZXRhJCQxLmRlbGV0ZUZyb21WYWx1ZXMoa2V5TmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKGNvdW50ID4gMSkgewogICAgICBtZXRhJCQxLndyaXRlV2F0Y2hpbmcoa2V5TmFtZSwgY291bnQgLSAxKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGVhY2hQcm94eUZvcihhcnJheSkgewogICAgdmFyIGVhY2hQcm94eSA9IEVBQ0hfUFJPWElFUy5nZXQoYXJyYXkpOwoKICAgIGlmIChlYWNoUHJveHkgPT09IHVuZGVmaW5lZCkgewogICAgICBlYWNoUHJveHkgPSBuZXcgRWFjaFByb3h5KGFycmF5KTsKICAgICAgRUFDSF9QUk9YSUVTLnNldChhcnJheSwgZWFjaFByb3h5KTsKICAgIH0KCiAgICByZXR1cm4gZWFjaFByb3h5OwogIH0KCiAgdmFyIEVhY2hQcm94eSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEVhY2hQcm94eShjb250ZW50KSB7CiAgICAgIHRoaXMuX2NvbnRlbnQgPSBjb250ZW50OwogICAgICB0aGlzLl9rZXlzID0gdW5kZWZpbmVkOwogICAgICAoMCwgX21ldGEyLm1ldGEpKHRoaXMpOwogICAgfSAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgICAvLyBBUlJBWSBDSEFOR0VTCiAgICAvLyBJbnZva2VzIHdoZW5ldmVyIHRoZSBjb250ZW50IGFycmF5IGl0c2VsZiBjaGFuZ2VzLgoKCiAgICB2YXIgX3Byb3RvID0gRWFjaFByb3h5LnByb3RvdHlwZTsKCiAgICBfcHJvdG8uYXJyYXlXaWxsQ2hhbmdlID0gZnVuY3Rpb24gYXJyYXlXaWxsQ2hhbmdlKGNvbnRlbnQsIGlkeCwgcmVtb3ZlZENudAogICAgLyosIGFkZGVkQ250ICovCiAgICApIHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11bnVzZWQtdmFycwogICAgICB2YXIga2V5cyA9IHRoaXMuX2tleXM7CgogICAgICBpZiAoIWtleXMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBsaW0gPSByZW1vdmVkQ250ID4gMCA/IGlkeCArIHJlbW92ZWRDbnQgOiAtMTsKCiAgICAgIGlmIChsaW0gPiAwKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGtleXMpIHsKICAgICAgICAgIHJlbW92ZU9ic2VydmVyRm9yQ29udGVudEtleShjb250ZW50LCBrZXksIHRoaXMsIGlkeCwgbGltKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLmFycmF5RGlkQ2hhbmdlID0gZnVuY3Rpb24gYXJyYXlEaWRDaGFuZ2UoY29udGVudCwgaWR4LCBfcmVtb3ZlZENudCwgYWRkZWRDbnQpIHsKICAgICAgdmFyIGtleXMgPSB0aGlzLl9rZXlzOwoKICAgICAgaWYgKCFrZXlzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgbGltID0gYWRkZWRDbnQgPiAwID8gaWR4ICsgYWRkZWRDbnQgOiAtMTsKICAgICAgdmFyIG1ldGEkJDEgPSAoMCwgX21ldGEyLnBlZWtNZXRhKSh0aGlzKTsKCiAgICAgIGZvciAodmFyIGtleSBpbiBrZXlzKSB7CiAgICAgICAgaWYgKGxpbSA+IDApIHsKICAgICAgICAgIGFkZE9ic2VydmVyRm9yQ29udGVudEtleShjb250ZW50LCBrZXksIHRoaXMsIGlkeCwgbGltKTsKICAgICAgICB9CgogICAgICAgIG5vdGlmeVByb3BlcnR5Q2hhbmdlKHRoaXMsIGtleSwgbWV0YSQkMSk7CiAgICAgIH0KICAgIH0gLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogICAgLy8gTElTVEVOIEZPUiBORVcgT0JTRVJWRVJTIEFORCBPVEhFUiBFVkVOVCBMSVNURU5FUlMKICAgIC8vIFN0YXJ0IG1vbml0b3Jpbmcga2V5cyBiYXNlZCBvbiB3aG8gaXMgbGlzdGVuaW5nLi4uCiAgICA7CgogICAgX3Byb3RvLndpbGxXYXRjaFByb3BlcnR5ID0gZnVuY3Rpb24gd2lsbFdhdGNoUHJvcGVydHkocHJvcGVydHkpIHsKICAgICAgdGhpcy5iZWdpbk9ic2VydmluZ0NvbnRlbnRLZXkocHJvcGVydHkpOwogICAgfTsKCiAgICBfcHJvdG8uZGlkVW53YXRjaFByb3BlcnR5ID0gZnVuY3Rpb24gZGlkVW53YXRjaFByb3BlcnR5KHByb3BlcnR5KSB7CiAgICAgIHRoaXMuc3RvcE9ic2VydmluZ0NvbnRlbnRLZXkocHJvcGVydHkpOwogICAgfSAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgICAvLyBDT05URU5UIEtFWSBPQlNFUlZJTkcKICAgIC8vIEFjdHVhbCB3YXRjaCBrZXlzIG9uIHRoZSBzb3VyY2UgY29udGVudC4KICAgIDsKCiAgICBfcHJvdG8uYmVnaW5PYnNlcnZpbmdDb250ZW50S2V5ID0gZnVuY3Rpb24gYmVnaW5PYnNlcnZpbmdDb250ZW50S2V5KGtleU5hbWUpIHsKICAgICAgdmFyIGtleXMgPSB0aGlzLl9rZXlzOwoKICAgICAgaWYgKGtleXMgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGtleXMgPSB0aGlzLl9rZXlzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgfQoKICAgICAgaWYgKCFrZXlzW2tleU5hbWVdKSB7CiAgICAgICAga2V5c1trZXlOYW1lXSA9IDE7CiAgICAgICAgdmFyIGNvbnRlbnQgPSB0aGlzLl9jb250ZW50OwogICAgICAgIHZhciBsZW4gPSBjb250ZW50Lmxlbmd0aDsKICAgICAgICBhZGRPYnNlcnZlckZvckNvbnRlbnRLZXkoY29udGVudCwga2V5TmFtZSwgdGhpcywgMCwgbGVuKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBrZXlzW2tleU5hbWVdKys7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLnN0b3BPYnNlcnZpbmdDb250ZW50S2V5ID0gZnVuY3Rpb24gc3RvcE9ic2VydmluZ0NvbnRlbnRLZXkoa2V5TmFtZSkgewogICAgICB2YXIga2V5cyA9IHRoaXMuX2tleXM7CgogICAgICBpZiAoa2V5cyAhPT0gdW5kZWZpbmVkICYmIGtleXNba2V5TmFtZV0gPiAwICYmIC0ta2V5c1trZXlOYW1lXSA8PSAwKSB7CiAgICAgICAgdmFyIGNvbnRlbnQgPSB0aGlzLl9jb250ZW50OwogICAgICAgIHZhciBsZW4gPSBjb250ZW50Lmxlbmd0aDsKICAgICAgICByZW1vdmVPYnNlcnZlckZvckNvbnRlbnRLZXkoY29udGVudCwga2V5TmFtZSwgdGhpcywgMCwgbGVuKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uY29udGVudEtleURpZENoYW5nZSA9IGZ1bmN0aW9uIGNvbnRlbnRLZXlEaWRDaGFuZ2UoX29iaiwga2V5TmFtZSkgewogICAgICBub3RpZnlQcm9wZXJ0eUNoYW5nZSh0aGlzLCBrZXlOYW1lKTsKICAgIH07CgogICAgcmV0dXJuIEVhY2hQcm94eTsKICB9KCk7CgogIGZ1bmN0aW9uIGFkZE9ic2VydmVyRm9yQ29udGVudEtleShjb250ZW50LCBrZXlOYW1lLCBwcm94eSwgaWR4LCBsb2MpIHsKICAgIHdoaWxlICgtLWxvYyA+PSBpZHgpIHsKICAgICAgdmFyIGl0ZW0gPSBvYmplY3RBdChjb250ZW50LCBsb2MpOwoKICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICAoZmFsc2UgJiYgISh0eXBlb2YgaXRlbSA9PT0gJ29iamVjdCcpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiV2hlbiB1c2luZyBAZWFjaCB0byBvYnNlcnZlIHRoZSBhcnJheSBgIiArIGNvbnRlbnQudG9TdHJpbmcoKSArICJgLCB0aGUgYXJyYXkgbXVzdCByZXR1cm4gYW4gb2JqZWN0IiwgdHlwZW9mIGl0ZW0gPT09ICdvYmplY3QnKSk7CiAgICAgICAgYWRkT2JzZXJ2ZXIoaXRlbSwga2V5TmFtZSwgcHJveHksICdjb250ZW50S2V5RGlkQ2hhbmdlJyk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbW92ZU9ic2VydmVyRm9yQ29udGVudEtleShjb250ZW50LCBrZXlOYW1lLCBwcm94eSwgaWR4LCBsb2MpIHsKICAgIHdoaWxlICgtLWxvYyA+PSBpZHgpIHsKICAgICAgdmFyIGl0ZW0gPSBvYmplY3RBdChjb250ZW50LCBsb2MpOwoKICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICByZW1vdmVPYnNlcnZlcihpdGVtLCBrZXlOYW1lLCBwcm94eSwgJ2NvbnRlbnRLZXlEaWRDaGFuZ2UnKTsKICAgICAgfQogICAgfQogIH0KCiAgdmFyIFVOS05PV05fUFJPUEVSVFlfVEFHID0gKDAsIF91dGlscy5zeW1ib2wpKCdVTktOT1dOX1BST1BFUlRZX1RBRycpOwogIF9leHBvcnRzLlVOS05PV05fUFJPUEVSVFlfVEFHID0gVU5LTk9XTl9QUk9QRVJUWV9UQUc7CgogIGZ1bmN0aW9uIHRhZ0ZvclByb3BlcnR5KG9iamVjdCwgcHJvcGVydHlLZXksIF9tZXRhKSB7CiAgICB2YXIgb2JqZWN0VHlwZSA9IHR5cGVvZiBvYmplY3Q7CgogICAgaWYgKG9iamVjdFR5cGUgIT09ICdmdW5jdGlvbicgJiYgKG9iamVjdFR5cGUgIT09ICdvYmplY3QnIHx8IG9iamVjdCA9PT0gbnVsbCkpIHsKICAgICAgcmV0dXJuIF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHOwogICAgfQoKICAgIHZhciBtZXRhJCQxID0gX21ldGEgPT09IHVuZGVmaW5lZCA/ICgwLCBfbWV0YTIubWV0YSkob2JqZWN0KSA6IF9tZXRhOwogICAgewogICAgICBpZiAoIShwcm9wZXJ0eUtleSBpbiBvYmplY3QpICYmIHR5cGVvZiBvYmplY3RbVU5LTk9XTl9QUk9QRVJUWV9UQUddID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIG9iamVjdFtVTktOT1dOX1BST1BFUlRZX1RBR10ocHJvcGVydHlLZXkpOwogICAgICB9CiAgICB9CiAgICB2YXIgdGFncyA9IG1ldGEkJDEud3JpdGFibGVUYWdzKCk7CiAgICB2YXIgdGFnID0gdGFnc1twcm9wZXJ0eUtleV07CgogICAgaWYgKHRhZykgewogICAgICByZXR1cm4gdGFnOwogICAgfQoKICAgIHsKICAgICAgdmFyIG5ld1RhZyA9ICgwLCBfcmVmZXJlbmNlLmNyZWF0ZVVwZGF0YWJsZVRhZykoKTsKCiAgICAgIGlmIChmYWxzZQogICAgICAvKiBERUJVRyAqLwogICAgICApIHsKICAgICAgICB7CiAgICAgICAgICAoMCwgX3V0aWxzLnNldHVwTWFuZGF0b3J5U2V0dGVyKShvYmplY3QsIHByb3BlcnR5S2V5KTsKICAgICAgICB9CiAgICAgICAgbmV3VGFnLl9wcm9wZXJ0eUtleSA9IHByb3BlcnR5S2V5OwogICAgICB9CgogICAgICByZXR1cm4gdGFnc1twcm9wZXJ0eUtleV0gPSBuZXdUYWc7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB0YWdGb3Iob2JqZWN0LCBfbWV0YSkgewogICAgaWYgKHR5cGVvZiBvYmplY3QgPT09ICdvYmplY3QnICYmIG9iamVjdCAhPT0gbnVsbCkgewogICAgICB2YXIgbWV0YSQkMSA9IF9tZXRhID09PSB1bmRlZmluZWQgPyAoMCwgX21ldGEyLm1ldGEpKG9iamVjdCkgOiBfbWV0YTsKCiAgICAgIGlmICghbWV0YSQkMS5pc01ldGFEZXN0cm95ZWQoKSkgewogICAgICAgIHJldHVybiBtZXRhJCQxLndyaXRhYmxlVGFnKCk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gX3JlZmVyZW5jZS5DT05TVEFOVF9UQUc7CiAgfQoKICBmdW5jdGlvbiBtYXJrT2JqZWN0QXNEaXJ0eShvYmosIHByb3BlcnR5S2V5LCBfbWV0YSkgewogICAgdmFyIG1ldGEkJDEgPSBfbWV0YSA9PT0gdW5kZWZpbmVkID8gKDAsIF9tZXRhMi5tZXRhKShvYmopIDogX21ldGE7CiAgICB2YXIgb2JqZWN0VGFnID0gbWV0YSQkMS5yZWFkYWJsZVRhZygpOwoKICAgIGlmIChvYmplY3RUYWcgIT09IHVuZGVmaW5lZCkgewogICAgICAoMCwgX3JlZmVyZW5jZS5kaXJ0eSkob2JqZWN0VGFnKTsKICAgIH0KCiAgICB2YXIgdGFncyA9IG1ldGEkJDEucmVhZGFibGVUYWdzKCk7CiAgICB2YXIgcHJvcGVydHlUYWcgPSB0YWdzICE9PSB1bmRlZmluZWQgPyB0YWdzW3Byb3BlcnR5S2V5XSA6IHVuZGVmaW5lZDsKCiAgICBpZiAocHJvcGVydHlUYWcgIT09IHVuZGVmaW5lZCkgewogICAgICAoMCwgX3JlZmVyZW5jZS5kaXJ0eSkocHJvcGVydHlUYWcpOwogICAgfQoKICAgIGlmIChvYmplY3RUYWcgIT09IHVuZGVmaW5lZCB8fCBwcm9wZXJ0eVRhZyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGVuc3VyZVJ1bmxvb3AoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGVuc3VyZVJ1bmxvb3AoKSB7CiAgICBfcnVubG9vcC5iYWNrYnVybmVyLmVuc3VyZUluc3RhbmNlKCk7CiAgfQoKICBmdW5jdGlvbiBpc0VsZW1lbnREZXNjcmlwdG9yKGFyZ3MpIHsKICAgIHZhciBtYXliZVRhcmdldCA9IGFyZ3NbMF0sCiAgICAgICAgbWF5YmVLZXkgPSBhcmdzWzFdLAogICAgICAgIG1heWJlRGVzYyA9IGFyZ3NbMl07CiAgICByZXR1cm4gKC8vIEVuc3VyZSB3ZSBoYXZlIHRoZSByaWdodCBudW1iZXIgb2YgYXJncwogICAgICBhcmdzLmxlbmd0aCA9PT0gMyAmJiAoIC8vIE1ha2Ugc3VyZSB0aGUgdGFyZ2V0IGlzIGEgY2xhc3Mgb3Igb2JqZWN0IChwcm90b3R5cGUpCiAgICAgIHR5cGVvZiBtYXliZVRhcmdldCA9PT0gJ2Z1bmN0aW9uJyB8fCB0eXBlb2YgbWF5YmVUYXJnZXQgPT09ICdvYmplY3QnICYmIG1heWJlVGFyZ2V0ICE9PSBudWxsKSAmJiAvLyBNYWtlIHN1cmUgdGhlIGtleSBpcyBhIHN0cmluZwogICAgICB0eXBlb2YgbWF5YmVLZXkgPT09ICdzdHJpbmcnICYmICggLy8gTWFrZSBzdXJlIHRoZSBkZXNjcmlwdG9yIGlzIHRoZSByaWdodCBzaGFwZQogICAgICB0eXBlb2YgbWF5YmVEZXNjID09PSAnb2JqZWN0JyAmJiBtYXliZURlc2MgIT09IG51bGwgJiYgJ2VudW1lcmFibGUnIGluIG1heWJlRGVzYyAmJiAnY29uZmlndXJhYmxlJyBpbiBtYXliZURlc2MgfHwgLy8gVFMgY29tcGF0aWJpbGl0eQogICAgICBtYXliZURlc2MgPT09IHVuZGVmaW5lZCkKICAgICk7CiAgfSAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgLy8gREVQRU5ERU5UIEtFWVMKICAvLwoKCiAgZnVuY3Rpb24gYWRkRGVwZW5kZW50S2V5cyhkZXNjLCBvYmosIGtleU5hbWUsIG1ldGEkJDEpIHsKICAgIC8vIHRoZSBkZXNjcmlwdG9yIGhhcyBhIGxpc3Qgb2YgZGVwZW5kZW50IGtleXMsIHNvCiAgICAvLyBhZGQgYWxsIG9mIGl0cyBkZXBlbmRlbnQga2V5cy4KICAgIHZhciBkZXBLZXlzID0gZGVzYy5fZGVwZW5kZW50S2V5czsKCiAgICBpZiAoZGVwS2V5cyA9PT0gbnVsbCB8fCBkZXBLZXlzID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGZvciAodmFyIGlkeCA9IDA7IGlkeCA8IGRlcEtleXMubGVuZ3RoOyBpZHgrKykgewogICAgICB2YXIgZGVwS2V5ID0gZGVwS2V5c1tpZHhdOyAvLyBJbmNyZW1lbnQgdGhlIG51bWJlciBvZiB0aW1lcyBkZXBLZXkgZGVwZW5kcyBvbiBrZXlOYW1lLgoKICAgICAgbWV0YSQkMS53cml0ZURlcHMoZGVwS2V5LCBrZXlOYW1lLCBtZXRhJCQxLnBlZWtEZXBzKGRlcEtleSwga2V5TmFtZSkgKyAxKTsgLy8gV2F0Y2ggdGhlIGRlcEtleQoKICAgICAgd2F0Y2gob2JqLCBkZXBLZXksIG1ldGEkJDEpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlRGVwZW5kZW50S2V5cyhkZXNjLCBvYmosIGtleU5hbWUsIG1ldGEkJDEpIHsKICAgIC8vIHRoZSBkZXNjcmlwdG9yIGhhcyBhIGxpc3Qgb2YgZGVwZW5kZW50IGtleXMsIHNvCiAgICAvLyByZW1vdmUgYWxsIG9mIGl0cyBkZXBlbmRlbnQga2V5cy4KICAgIHZhciBkZXBLZXlzID0gZGVzYy5fZGVwZW5kZW50S2V5czsKCiAgICBpZiAoZGVwS2V5cyA9PT0gbnVsbCB8fCBkZXBLZXlzID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGZvciAodmFyIGlkeCA9IDA7IGlkeCA8IGRlcEtleXMubGVuZ3RoOyBpZHgrKykgewogICAgICB2YXIgZGVwS2V5ID0gZGVwS2V5c1tpZHhdOyAvLyBEZWNyZW1lbnQgdGhlIG51bWJlciBvZiB0aW1lcyBkZXBLZXkgZGVwZW5kcyBvbiBrZXlOYW1lLgoKICAgICAgbWV0YSQkMS53cml0ZURlcHMoZGVwS2V5LCBrZXlOYW1lLCBtZXRhJCQxLnBlZWtEZXBzKGRlcEtleSwga2V5TmFtZSkgLSAxKTsgLy8gVW53YXRjaCB0aGUgZGVwS2V5CgogICAgICB1bndhdGNoKG9iaiwgZGVwS2V5LCBtZXRhJCQxKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG5hdGl2ZURlc2NEZWNvcmF0b3IocHJvcGVydHlEZXNjKSB7CiAgICB2YXIgZGVjb3JhdG9yID0gZnVuY3Rpb24gZGVjb3JhdG9yKCkgewogICAgICByZXR1cm4gcHJvcGVydHlEZXNjOwogICAgfTsKCiAgICBzZXRDbGFzc2ljRGVjb3JhdG9yKGRlY29yYXRvcik7CiAgICByZXR1cm4gZGVjb3JhdG9yOwogIH0KICAvKioKICAgIE9iamVjdHMgb2YgdGhpcyB0eXBlIGNhbiBpbXBsZW1lbnQgYW4gaW50ZXJmYWNlIHRvIHJlc3BvbmQgdG8gcmVxdWVzdHMgdG8KICAgIGdldCBhbmQgc2V0LiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBoYW5kbGVzIHNpbXBsZSBwcm9wZXJ0aWVzLgogIAogICAgQGNsYXNzIERlc2NyaXB0b3IKICAgIEBwcml2YXRlCiAgKi8KCgogIHZhciBDb21wdXRlZERlc2NyaXB0b3IgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBDb21wdXRlZERlc2NyaXB0b3IoKSB7CiAgICAgIHRoaXMuZW51bWVyYWJsZSA9IHRydWU7CiAgICAgIHRoaXMuY29uZmlndXJhYmxlID0gdHJ1ZTsKICAgICAgdGhpcy5fZGVwZW5kZW50S2V5cyA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5fbWV0YSA9IHVuZGVmaW5lZDsKICAgIH0KCiAgICB2YXIgX3Byb3RvMiA9IENvbXB1dGVkRGVzY3JpcHRvci5wcm90b3R5cGU7CgogICAgX3Byb3RvMi5zZXR1cCA9IGZ1bmN0aW9uIHNldHVwKF9vYmosIGtleU5hbWUsIF9wcm9wZXJ0eURlc2MsIG1ldGEkJDEpIHsKICAgICAgbWV0YSQkMS53cml0ZURlc2NyaXB0b3JzKGtleU5hbWUsIHRoaXMpOwogICAgfTsKCiAgICBfcHJvdG8yLnRlYXJkb3duID0gZnVuY3Rpb24gdGVhcmRvd24oX29iaiwga2V5TmFtZSwgbWV0YSQkMSkgewogICAgICBtZXRhJCQxLnJlbW92ZURlc2NyaXB0b3JzKGtleU5hbWUpOwogICAgfTsKCiAgICByZXR1cm4gQ29tcHV0ZWREZXNjcmlwdG9yOwogIH0oKTsKCiAgZnVuY3Rpb24gREVTQ1JJUFRPUl9HRVRURVJfRlVOQ1RJT04obmFtZSwgZGVzY3JpcHRvcikgewogICAgcmV0dXJuIGZ1bmN0aW9uIENQR0VUVEVSX0ZVTkNUSU9OKCkgewogICAgICByZXR1cm4gZGVzY3JpcHRvci5nZXQodGhpcywgbmFtZSk7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gREVTQ1JJUFRPUl9TRVRURVJfRlVOQ1RJT04obmFtZSwgZGVzY3JpcHRvcikgewogICAgdmFyIGZ1bmMgPSBmdW5jdGlvbiBDUFNFVFRFUl9GVU5DVElPTih2YWx1ZSQkMSkgewogICAgICByZXR1cm4gZGVzY3JpcHRvci5zZXQodGhpcywgbmFtZSwgdmFsdWUkJDEpOwogICAgfTsKCiAgICBDUF9TRVRURVJfRlVOQ1MuYWRkKGZ1bmMpOwogICAgcmV0dXJuIGZ1bmM7CiAgfQoKICB2YXIgQ1BfU0VUVEVSX0ZVTkNTID0gbmV3IF9wb2x5ZmlsbHMuX1dlYWtTZXQoKTsKCiAgZnVuY3Rpb24gbWFrZUNvbXB1dGVkRGVjb3JhdG9yKGRlc2MsIERlY29yYXRvckNsYXNzKSB7CiAgICB2YXIgZGVjb3JhdG9yID0gZnVuY3Rpb24gQ09NUFVURURfREVDT1JBVE9SKHRhcmdldCwga2V5LCBwcm9wZXJ0eURlc2MsIG1heWJlTWV0YSwgaXNDbGFzc2ljRGVjb3JhdG9yJCQxKSB7CiAgICAgIChmYWxzZSAmJiAhKGlzQ2xhc3NpY0RlY29yYXRvciQkMSB8fCAhcHJvcGVydHlEZXNjIHx8ICFwcm9wZXJ0eURlc2MuZ2V0IHx8IHByb3BlcnR5RGVzYy5nZXQudG9TdHJpbmcoKS5pbmRleE9mKCdDUEdFVFRFUl9GVU5DVElPTicpID09PSAtMSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJPbmx5IG9uZSBjb21wdXRlZCBwcm9wZXJ0eSBkZWNvcmF0b3IgY2FuIGJlIGFwcGxpZWQgdG8gYSBjbGFzcyBmaWVsZCBvciBhY2Nlc3NvciwgYnV0ICciICsga2V5ICsgIicgd2FzIGRlY29yYXRlZCB0d2ljZS4gWW91IG1heSBoYXZlIGFkZGVkIHRoZSBkZWNvcmF0b3IgdG8gYm90aCBhIGdldHRlciBhbmQgc2V0dGVyLCB3aGljaCBpcyB1bmVjZXNzYXJ5LiIsIGlzQ2xhc3NpY0RlY29yYXRvciQkMSB8fCAhcHJvcGVydHlEZXNjIHx8ICFwcm9wZXJ0eURlc2MuZ2V0IHx8IHByb3BlcnR5RGVzYy5nZXQudG9TdHJpbmcoKS5pbmRleE9mKCdDUEdFVFRFUl9GVU5DVElPTicpID09PSAtMSkpOwogICAgICB2YXIgbWV0YSQkMSA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDMgPyAoMCwgX21ldGEyLm1ldGEpKHRhcmdldCkgOiBtYXliZU1ldGE7CiAgICAgIGRlc2Muc2V0dXAodGFyZ2V0LCBrZXksIHByb3BlcnR5RGVzYywgbWV0YSQkMSk7CiAgICAgIHZhciBjb21wdXRlZERlc2MgPSB7CiAgICAgICAgZW51bWVyYWJsZTogZGVzYy5lbnVtZXJhYmxlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogZGVzYy5jb25maWd1cmFibGUsCiAgICAgICAgZ2V0OiBERVNDUklQVE9SX0dFVFRFUl9GVU5DVElPTihrZXksIGRlc2MpCiAgICAgIH07CiAgICAgIHsKICAgICAgICBjb21wdXRlZERlc2Muc2V0ID0gREVTQ1JJUFRPUl9TRVRURVJfRlVOQ1RJT04oa2V5LCBkZXNjKTsKICAgICAgfQogICAgICByZXR1cm4gY29tcHV0ZWREZXNjOwogICAgfTsKCiAgICBzZXRDbGFzc2ljRGVjb3JhdG9yKGRlY29yYXRvciwgZGVzYyk7CiAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YoZGVjb3JhdG9yLCBEZWNvcmF0b3JDbGFzcy5wcm90b3R5cGUpOwogICAgcmV0dXJuIGRlY29yYXRvcjsKICB9CiAgLyoqCiAgICBBbiBvYmplY3QgdGhhdCB0aGF0IHRyYWNrcyBAdHJhY2tlZCBwcm9wZXJ0aWVzIHRoYXQgd2VyZSBjb25zdW1lZC4KICAKICAgIEBwcml2YXRlCiAgKi8KCgogIHZhciBUcmFja2VyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gVHJhY2tlcigpIHsKICAgICAgdGhpcy50YWdzID0gbmV3IFNldCgpOwogICAgICB0aGlzLmxhc3QgPSBudWxsOwogICAgfQoKICAgIHZhciBfcHJvdG8zID0gVHJhY2tlci5wcm90b3R5cGU7CgogICAgX3Byb3RvMy5hZGQgPSBmdW5jdGlvbiBhZGQodGFnKSB7CiAgICAgIHRoaXMudGFncy5hZGQodGFnKTsKICAgICAgdGhpcy5sYXN0ID0gdGFnOwogICAgfTsKCiAgICBfcHJvdG8zLmNvbWJpbmUgPSBmdW5jdGlvbiBjb21iaW5lKCkgewogICAgICBpZiAodGhpcy50YWdzLnNpemUgPT09IDApIHsKICAgICAgICByZXR1cm4gX3JlZmVyZW5jZS5DT05TVEFOVF9UQUc7CiAgICAgIH0gZWxzZSBpZiAodGhpcy50YWdzLnNpemUgPT09IDEpIHsKICAgICAgICByZXR1cm4gdGhpcy5sYXN0OwogICAgICB9IGVsc2UgewogICAgICAgIHZhciB0YWdzID0gW107CiAgICAgICAgdGhpcy50YWdzLmZvckVhY2goZnVuY3Rpb24gKHRhZykgewogICAgICAgICAgcmV0dXJuIHRhZ3MucHVzaCh0YWcpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiAoMCwgX3JlZmVyZW5jZS5jb21iaW5lKSh0YWdzKTsKICAgICAgfQogICAgfTsKCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKFRyYWNrZXIsIFt7CiAgICAgIGtleTogInNpemUiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy50YWdzLnNpemU7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBUcmFja2VyOwogIH0oKTsKCiAgX2V4cG9ydHMuVHJhY2tlciA9IFRyYWNrZXI7CgogIGZ1bmN0aW9uIHRyYWNrZWQoKSB7CiAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjIpLCBfa2V5MyA9IDA7IF9rZXkzIDwgX2xlbjI7IF9rZXkzKyspIHsKICAgICAgYXJnc1tfa2V5M10gPSBhcmd1bWVudHNbX2tleTNdOwogICAgfQoKICAgIChmYWxzZSAmJiAhKCEoaXNFbGVtZW50RGVzY3JpcHRvcihhcmdzLnNsaWNlKDAsIDMpKSAmJiBhcmdzLmxlbmd0aCA9PT0gNSAmJiBhcmdzWzRdID09PSB0cnVlKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJAdHJhY2tlZCBjYW4gb25seSBiZSB1c2VkIGRpcmVjdGx5IGFzIGEgbmF0aXZlIGRlY29yYXRvci4gSWYgeW91J3JlIHVzaW5nIHRyYWNrZWQgaW4gY2xhc3NpYyBjbGFzc2VzLCBhZGQgcGFyZW50aGVzaXMgdG8gY2FsbCBpdCBsaWtlIGEgZnVuY3Rpb246IHRyYWNrZWQoKSIsICEoaXNFbGVtZW50RGVzY3JpcHRvcihhcmdzLnNsaWNlKDAsIDMpKSAmJiBhcmdzLmxlbmd0aCA9PT0gNSAmJiBhcmdzWzRdID09PSB0cnVlKSkpOwoKICAgIGlmICghaXNFbGVtZW50RGVzY3JpcHRvcihhcmdzKSkgewogICAgICB2YXIgcHJvcGVydHlEZXNjID0gYXJnc1swXTsKICAgICAgKGZhbHNlICYmICEoYXJncy5sZW5ndGggPT09IDAgfHwgdHlwZW9mIHByb3BlcnR5RGVzYyA9PT0gJ29iamVjdCcgJiYgcHJvcGVydHlEZXNjICE9PSBudWxsKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoInRyYWNrZWQoKSBtYXkgb25seSByZWNlaXZlIGFuIG9wdGlvbnMgb2JqZWN0IGNvbnRhaW5pbmcgJ3ZhbHVlJyBvciAnaW5pdGlhbGl6ZXInLCByZWNlaXZlZCAiICsgcHJvcGVydHlEZXNjLCBhcmdzLmxlbmd0aCA9PT0gMCB8fCB0eXBlb2YgcHJvcGVydHlEZXNjID09PSAnb2JqZWN0JyAmJiBwcm9wZXJ0eURlc2MgIT09IG51bGwpKTsKCiAgICAgIGlmIChmYWxzZQogICAgICAvKiBERUJVRyAqLwogICAgICAmJiBwcm9wZXJ0eURlc2MpIHsKICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHByb3BlcnR5RGVzYyk7CiAgICAgICAgKGZhbHNlICYmICEoa2V5cy5sZW5ndGggPD0gMSAmJiAoa2V5c1swXSA9PT0gdW5kZWZpbmVkIHx8IGtleXNbMF0gPT09ICd2YWx1ZScgfHwga2V5c1swXSA9PT0gJ2luaXRpYWxpemVyJykpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiVGhlIG9wdGlvbnMgb2JqZWN0IHBhc3NlZCB0byB0cmFja2VkKCkgbWF5IG9ubHkgY29udGFpbiBhICd2YWx1ZScgb3IgJ2luaXRpYWxpemVyJyBwcm9wZXJ0eSwgbm90IGJvdGguIFJlY2VpdmVkOiBbIiArIGtleXMgKyAiXSIsIGtleXMubGVuZ3RoIDw9IDEgJiYgKGtleXNbMF0gPT09IHVuZGVmaW5lZCB8fCBrZXlzWzBdID09PSAndmFsdWUnIHx8IGtleXNbMF0gPT09ICdpbml0aWFsaXplcicpKSk7CiAgICAgICAgKGZhbHNlICYmICEoISgnaW5pdGlhbGl6ZXInIGluIHByb3BlcnR5RGVzYykgfHwgdHlwZW9mIHByb3BlcnR5RGVzYy5pbml0aWFsaXplciA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJUaGUgaW5pdGlhbGl6ZXIgcGFzc2VkIHRvIHRyYWNrZWQgbXVzdCBiZSBhIGZ1bmN0aW9uLiBSZWNlaXZlZCAiICsgcHJvcGVydHlEZXNjLmluaXRpYWxpemVyLCAhKCdpbml0aWFsaXplcicgaW4gcHJvcGVydHlEZXNjKSB8fCB0eXBlb2YgcHJvcGVydHlEZXNjLmluaXRpYWxpemVyID09PSAnZnVuY3Rpb24nKSk7CiAgICAgIH0KCiAgICAgIHZhciBpbml0aWFsaXplciA9IHByb3BlcnR5RGVzYyA/IHByb3BlcnR5RGVzYy5pbml0aWFsaXplciA6IHVuZGVmaW5lZDsKICAgICAgdmFyIHZhbHVlJCQxID0gcHJvcGVydHlEZXNjID8gcHJvcGVydHlEZXNjLnZhbHVlIDogdW5kZWZpbmVkOwoKICAgICAgdmFyIGRlY29yYXRvciA9IGZ1bmN0aW9uIGRlY29yYXRvcih0YXJnZXQsIGtleSwgX2Rlc2MsIF9tZXRhLCBpc0NsYXNzaWNEZWNvcmF0b3IkJDEpIHsKICAgICAgICAoZmFsc2UgJiYgIShpc0NsYXNzaWNEZWNvcmF0b3IkJDEpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IGF0dGVtcHRlZCB0byBzZXQgYSBkZWZhdWx0IHZhbHVlIGZvciAiICsga2V5ICsgIiB3aXRoIHRoZSBAdHJhY2tlZCh7IHZhbHVlOiAnZGVmYXVsdCcgfSkgc3ludGF4LiBZb3UgY2FuIG9ubHkgdXNlIHRoaXMgc3ludGF4IHdpdGggY2xhc3NpYyBjbGFzc2VzLiBGb3IgbmF0aXZlIGNsYXNzZXMsIHlvdSBjYW4gdXNlIGNsYXNzIGluaXRpYWxpemVyczogQHRyYWNrZWQgZmllbGQgPSAnZGVmYXVsdCc7IiwgaXNDbGFzc2ljRGVjb3JhdG9yJCQxKSk7CiAgICAgICAgdmFyIGZpZWxkRGVzYyA9IHsKICAgICAgICAgIGluaXRpYWxpemVyOiBpbml0aWFsaXplciB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSQkMTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJldHVybiBkZXNjcmlwdG9yRm9yRmllbGQoW3RhcmdldCwga2V5LCBmaWVsZERlc2NdKTsKICAgICAgfTsKCiAgICAgIHNldENsYXNzaWNEZWNvcmF0b3IoZGVjb3JhdG9yKTsKICAgICAgcmV0dXJuIGRlY29yYXRvcjsKICAgIH0KCiAgICByZXR1cm4gZGVzY3JpcHRvckZvckZpZWxkKGFyZ3MpOwogIH0KCiAgaWYgKGZhbHNlCiAgLyogREVCVUcgKi8KICApIHsKICAgIC8vIE5vcm1hbGx5IHRoaXMgaXNuJ3QgYSBjbGFzc2ljIGRlY29yYXRvciwgYnV0IHdlIHdhbnQgdG8gdGhyb3cgYSBoZWxwZnVsCiAgICAvLyBlcnJvciBpbiBkZXZlbG9wbWVudCBzbyB3ZSBuZWVkIGl0IHRvIHRyZWF0IGl0IGxpa2Ugb25lCiAgICBzZXRDbGFzc2ljRGVjb3JhdG9yKHRyYWNrZWQpOwogIH0KCiAgZnVuY3Rpb24gZGVzY3JpcHRvckZvckZpZWxkKF9yZWYpIHsKICAgIHZhciBfdGFyZ2V0ID0gX3JlZlswXSwKICAgICAgICBrZXkgPSBfcmVmWzFdLAogICAgICAgIGRlc2MgPSBfcmVmWzJdOwogICAgKGZhbHNlICYmICEoIWRlc2MgfHwgIWRlc2MudmFsdWUgJiYgIWRlc2MuZ2V0ICYmICFkZXNjLnNldCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJZb3UgYXR0ZW1wdGVkIHRvIHVzZSBAdHJhY2tlZCBvbiAiICsga2V5ICsgIiwgYnV0IHRoYXQgZWxlbWVudCBpcyBub3QgYSBjbGFzcyBmaWVsZC4gQHRyYWNrZWQgaXMgb25seSB1c2FibGUgb24gY2xhc3MgZmllbGRzLiBOYXRpdmUgZ2V0dGVycyBhbmQgc2V0dGVycyB3aWxsIGF1dG90cmFjayBhZGQgYW55IHRyYWNrZWQgZmllbGRzIHRoZXkgZW5jb3VudGVyLCBzbyB0aGVyZSBpcyBubyBuZWVkIG1hcmsgZ2V0dGVycyBhbmQgc2V0dGVycyB3aXRoIEB0cmFja2VkLiIsICFkZXNjIHx8ICFkZXNjLnZhbHVlICYmICFkZXNjLmdldCAmJiAhZGVzYy5zZXQpKTsKICAgIHZhciBpbml0aWFsaXplciA9IGRlc2MgPyBkZXNjLmluaXRpYWxpemVyIDogdW5kZWZpbmVkOwogICAgdmFyIHZhbHVlcyA9IG5ldyBXZWFrTWFwKCk7CiAgICB2YXIgaGFzSW5pdGlhbGl6ZXIgPSB0eXBlb2YgaW5pdGlhbGl6ZXIgPT09ICdmdW5jdGlvbic7CiAgICByZXR1cm4gewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHZhciBwcm9wZXJ0eVRhZyA9IHRhZ0ZvclByb3BlcnR5KHRoaXMsIGtleSk7CiAgICAgICAgaWYgKENVUlJFTlRfVFJBQ0tFUikgQ1VSUkVOVF9UUkFDS0VSLmFkZChwcm9wZXJ0eVRhZyk7CiAgICAgICAgdmFyIHZhbHVlJCQxOyAvLyBJZiB0aGUgZmllbGQgaGFzIG5ldmVyIGJlZW4gaW5pdGlhbGl6ZWQsIHdlIHNob3VsZCBpbml0aWFsaXplIGl0CgogICAgICAgIGlmIChoYXNJbml0aWFsaXplciAmJiAhdmFsdWVzLmhhcyh0aGlzKSkgewogICAgICAgICAgdmFsdWUkJDEgPSBpbml0aWFsaXplci5jYWxsKHRoaXMpOwogICAgICAgICAgdmFsdWVzLnNldCh0aGlzLCB2YWx1ZSQkMSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhbHVlJCQxID0gdmFsdWVzLmdldCh0aGlzKTsKICAgICAgICB9IC8vIEFkZCB0aGUgdGFnIG9mIHRoZSByZXR1cm5lZCB2YWx1ZSBpZiBpdCBpcyBhbiBhcnJheSwgc2luY2UgYXJyYXlzCiAgICAgICAgLy8gc2hvdWxkIGFsd2F5cyBjYXVzZSB1cGRhdGVzIGlmIHRoZXkgYXJlIGNvbnN1bWVkIGFuZCB0aGVuIGNoYW5nZWQKCgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlJCQxKSB8fCAoMCwgX3V0aWxzLmlzRW1iZXJBcnJheSkodmFsdWUkJDEpKSB7CiAgICAgICAgICAoMCwgX3JlZmVyZW5jZS51cGRhdGUpKHByb3BlcnR5VGFnLCB0YWdGb3JQcm9wZXJ0eSh2YWx1ZSQkMSwgJ1tdJykpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbHVlJCQxOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldChuZXdWYWx1ZSkgewogICAgICAgIG1hcmtPYmplY3RBc0RpcnR5KHRoaXMsIGtleSk7CiAgICAgICAgdmFsdWVzLnNldCh0aGlzLCBuZXdWYWx1ZSk7CgogICAgICAgIGlmIChwcm9wZXJ0eURpZENoYW5nZSAhPT0gbnVsbCkgewogICAgICAgICAgcHJvcGVydHlEaWRDaGFuZ2UoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfQogIC8qKgogICAgQHByaXZhdGUKICAKICAgIFdoZW5ldmVyIGEgdHJhY2tlZCBjb21wdXRlZCBwcm9wZXJ0eSBpcyBlbnRlcmVkLCB0aGUgY3VycmVudCB0cmFja2VyIGlzCiAgICBzYXZlZCBvZmYgYW5kIGEgbmV3IHRyYWNrZXIgaXMgcmVwbGFjZWQuCiAgCiAgICBBbnkgdHJhY2tlZCBwcm9wZXJ0aWVzIGNvbnN1bWVkIGFyZSBhZGRlZCB0byB0aGUgY3VycmVudCB0cmFja2VyLgogIAogICAgV2hlbiBhIHRyYWNrZWQgY29tcHV0ZWQgcHJvcGVydHkgaXMgZXhpdGVkLCB0aGUgdHJhY2tlcidzIHRhZ3MgYXJlCiAgICBjb21iaW5lZCBhbmQgYWRkZWQgdG8gdGhlIHBhcmVudCB0cmFja2VyLgogIAogICAgVGhlIGNvbnNlcXVlbmNlIGlzIHRoYXQgZWFjaCB0cmFja2VkIGNvbXB1dGVkIHByb3BlcnR5IGhhcyBhIHRhZwogICAgdGhhdCBjb3JyZXNwb25kcyB0byB0aGUgdHJhY2tlZCBwcm9wZXJ0aWVzIGNvbnN1bWVkIGluc2lkZSBvZgogICAgaXRzZWxmLCBpbmNsdWRpbmcgY2hpbGQgdHJhY2tlZCBjb21wdXRlZCBwcm9wZXJ0aWVzLgogICovCgoKICB2YXIgQ1VSUkVOVF9UUkFDS0VSID0gbnVsbDsKCiAgZnVuY3Rpb24gdHJhY2soY2FsbGJhY2spIHsKICAgIHZhciBwYXJlbnQgPSBDVVJSRU5UX1RSQUNLRVI7CiAgICB2YXIgY3VycmVudCA9IG5ldyBUcmFja2VyKCk7CiAgICBDVVJSRU5UX1RSQUNLRVIgPSBjdXJyZW50OwoKICAgIHRyeSB7CiAgICAgIGNhbGxiYWNrKCk7CiAgICB9IGZpbmFsbHkgewogICAgICBDVVJSRU5UX1RSQUNLRVIgPSBwYXJlbnQ7CiAgICB9CgogICAgcmV0dXJuIGN1cnJlbnQuY29tYmluZSgpOwogIH0KCiAgZnVuY3Rpb24gY29uc3VtZSh0YWcpIHsKICAgIGlmIChDVVJSRU5UX1RSQUNLRVIgIT09IG51bGwpIHsKICAgICAgQ1VSUkVOVF9UUkFDS0VSLmFkZCh0YWcpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaXNUcmFja2luZygpIHsKICAgIHJldHVybiBDVVJSRU5UX1RSQUNLRVIgIT09IG51bGw7CiAgfQoKICBmdW5jdGlvbiB1bnRyYWNrKGNhbGxiYWNrKSB7CiAgICB2YXIgcGFyZW50ID0gQ1VSUkVOVF9UUkFDS0VSOwogICAgQ1VSUkVOVF9UUkFDS0VSID0gbnVsbDsKCiAgICB0cnkgewogICAgICBjYWxsYmFjaygpOwogICAgfSBmaW5hbGx5IHsKICAgICAgQ1VSUkVOVF9UUkFDS0VSID0gcGFyZW50OwogICAgfQogIH0KCiAgdmFyIHByb3BlcnR5RGlkQ2hhbmdlID0gbnVsbDsKICAvKioKICBAbW9kdWxlIEBlbWJlci9vYmplY3QKICAqLwoKICB2YXIgUFJPWFlfQ09OVEVOVCA9ICgwLCBfdXRpbHMuc3ltYm9sKSgnUFJPWFlfQ09OVEVOVCcpOwogIF9leHBvcnRzLlBST1hZX0NPTlRFTlQgPSBQUk9YWV9DT05URU5UOwogIHZhciBnZXRQb3NzaWJsZU1hbmRhdG9yeVByb3h5VmFsdWU7CgogIGlmIChmYWxzZQogIC8qIERFQlVHICovCiAgJiYgX3V0aWxzLkhBU19OQVRJVkVfUFJPWFkpIHsKICAgIGdldFBvc3NpYmxlTWFuZGF0b3J5UHJveHlWYWx1ZSA9IGZ1bmN0aW9uIGdldFBvc3NpYmxlTWFuZGF0b3J5UHJveHlWYWx1ZShvYmosIGtleU5hbWUpIHsKICAgICAgdmFyIGNvbnRlbnQgPSBvYmpbUFJPWFlfQ09OVEVOVF07CgogICAgICBpZiAoY29udGVudCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIG9ialtrZXlOYW1lXTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvKiBnbG9iYWwgUmVmbGVjdCAqLwogICAgICAgIHJldHVybiBSZWZsZWN0LmdldChjb250ZW50LCBrZXlOYW1lLCBvYmopOwogICAgICB9CiAgICB9OwogIH0gLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogIC8vIEdFVCBBTkQgU0VUCiAgLy8KICAvLyBJZiB3ZSBhcmUgb24gYSBwbGF0Zm9ybSB0aGF0IHN1cHBvcnRzIGFjY2Vzc29ycyB3ZSBjYW4gdXNlIHRob3NlLgogIC8vIE90aGVyd2lzZSBzaW11bGF0ZSBhY2Nlc3NvcnMgYnkgbG9va2luZyB1cCB0aGUgcHJvcGVydHkgZGlyZWN0bHkgb24gdGhlCiAgLy8gb2JqZWN0LgoKICAvKioKICAgIEdldHMgdGhlIHZhbHVlIG9mIGEgcHJvcGVydHkgb24gYW4gb2JqZWN0LiBJZiB0aGUgcHJvcGVydHkgaXMgY29tcHV0ZWQsCiAgICB0aGUgZnVuY3Rpb24gd2lsbCBiZSBpbnZva2VkLiBJZiB0aGUgcHJvcGVydHkgaXMgbm90IGRlZmluZWQgYnV0IHRoZQogICAgb2JqZWN0IGltcGxlbWVudHMgdGhlIGB1bmtub3duUHJvcGVydHlgIG1ldGhvZCB0aGVuIHRoYXQgd2lsbCBiZSBpbnZva2VkLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgZ2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBnZXQob2JqLCAibmFtZSIpOwogICAgYGBgCiAgCiAgICBJZiB5b3UgcGxhbiB0byBydW4gb24gSUU4IGFuZCBvbGRlciBicm93c2VycyB0aGVuIHlvdSBzaG91bGQgdXNlIHRoaXMKICAgIG1ldGhvZCBhbnl0aW1lIHlvdSB3YW50IHRvIHJldHJpZXZlIGEgcHJvcGVydHkgb24gYW4gb2JqZWN0IHRoYXQgeW91IGRvbid0CiAgICBrbm93IGZvciBzdXJlIGlzIHByaXZhdGUuIChQcm9wZXJ0aWVzIGJlZ2lubmluZyB3aXRoIGFuIHVuZGVyc2NvcmUgJ18nCiAgICBhcmUgY29uc2lkZXJlZCBwcml2YXRlLikKICAKICAgIE9uIGFsbCBuZXdlciBicm93c2VycywgeW91IG9ubHkgbmVlZCB0byB1c2UgdGhpcyBtZXRob2QgdG8gcmV0cmlldmUKICAgIHByb3BlcnRpZXMgaWYgdGhlIHByb3BlcnR5IG1pZ2h0IG5vdCBiZSBkZWZpbmVkIG9uIHRoZSBvYmplY3QgYW5kIHlvdSB3YW50CiAgICB0byByZXNwZWN0IHRoZSBgdW5rbm93blByb3BlcnR5YCBoYW5kbGVyLiBPdGhlcndpc2UgeW91IGNhbiBpZ25vcmUgdGhpcwogICAgbWV0aG9kLgogIAogICAgTm90ZSB0aGF0IGlmIHRoZSBvYmplY3QgaXRzZWxmIGlzIGB1bmRlZmluZWRgLCB0aGlzIG1ldGhvZCB3aWxsIHRocm93CiAgICBhbiBlcnJvci4KICAKICAgIEBtZXRob2QgZ2V0CiAgICBAZm9yIEBlbWJlci9vYmplY3QKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIG9iamVjdCB0byByZXRyaWV2ZSBmcm9tLgogICAgQHBhcmFtIHtTdHJpbmd9IGtleU5hbWUgVGhlIHByb3BlcnR5IGtleSB0byByZXRyaWV2ZQogICAgQHJldHVybiB7T2JqZWN0fSB0aGUgcHJvcGVydHkgdmFsdWUgb3IgYG51bGxgLgogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBfZ2V0MihvYmosIGtleU5hbWUpIHsKICAgIChmYWxzZSAmJiAhKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiR2V0IG11c3QgYmUgY2FsbGVkIHdpdGggdHdvIGFyZ3VtZW50czsgYW4gb2JqZWN0IGFuZCBhIHByb3BlcnR5IGtleSIsIGFyZ3VtZW50cy5sZW5ndGggPT09IDIpKTsKICAgIChmYWxzZSAmJiAhKG9iaiAhPT0gdW5kZWZpbmVkICYmIG9iaiAhPT0gbnVsbCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJDYW5ub3QgY2FsbCBnZXQgd2l0aCAnIiArIGtleU5hbWUgKyAiJyBvbiBhbiB1bmRlZmluZWQgb2JqZWN0LiIsIG9iaiAhPT0gdW5kZWZpbmVkICYmIG9iaiAhPT0gbnVsbCkpOwogICAgKGZhbHNlICYmICEodHlwZW9mIGtleU5hbWUgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiBrZXlOYW1lID09PSAnbnVtYmVyJyAmJiAhaXNOYU4oa2V5TmFtZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiVGhlIGtleSBwcm92aWRlZCB0byBnZXQgbXVzdCBiZSBhIHN0cmluZyBvciBudW1iZXIsIHlvdSBwYXNzZWQgIiArIGtleU5hbWUsIHR5cGVvZiBrZXlOYW1lID09PSAnc3RyaW5nJyB8fCB0eXBlb2Yga2V5TmFtZSA9PT0gJ251bWJlcicgJiYgIWlzTmFOKGtleU5hbWUpKSk7CiAgICAoZmFsc2UgJiYgISh0eXBlb2Yga2V5TmFtZSAhPT0gJ3N0cmluZycgfHwga2V5TmFtZS5sYXN0SW5kZXhPZigndGhpcy4nLCAwKSAhPT0gMCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCIndGhpcycgaW4gcGF0aHMgaXMgbm90IHN1cHBvcnRlZCIsIHR5cGVvZiBrZXlOYW1lICE9PSAnc3RyaW5nJyB8fCBrZXlOYW1lLmxhc3RJbmRleE9mKCd0aGlzLicsIDApICE9PSAwKSk7CiAgICB2YXIgdHlwZSA9IHR5cGVvZiBvYmo7CiAgICB2YXIgaXNPYmplY3QgPSB0eXBlID09PSAnb2JqZWN0JzsKICAgIHZhciBpc0Z1bmN0aW9uID0gdHlwZSA9PT0gJ2Z1bmN0aW9uJzsKICAgIHZhciBpc09iamVjdExpa2UgPSBpc09iamVjdCB8fCBpc0Z1bmN0aW9uOwoKICAgIGlmIChpc1BhdGgoa2V5TmFtZSkpIHsKICAgICAgcmV0dXJuIGlzT2JqZWN0TGlrZSA/IF9nZXRQYXRoKG9iaiwga2V5TmFtZSkgOiB1bmRlZmluZWQ7CiAgICB9CgogICAgdmFyIHZhbHVlJCQxOwoKICAgIGlmIChpc09iamVjdExpa2UpIHsKICAgICAgdmFyIHRyYWNraW5nID0gaXNUcmFja2luZygpOwogICAgICB7CiAgICAgICAgaWYgKHRyYWNraW5nKSB7CiAgICAgICAgICBjb25zdW1lKHRhZ0ZvclByb3BlcnR5KG9iaiwga2V5TmFtZSkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICYmIF91dGlscy5IQVNfTkFUSVZFX1BST1hZKSB7CiAgICAgICAgdmFsdWUkJDEgPSBnZXRQb3NzaWJsZU1hbmRhdG9yeVByb3h5VmFsdWUob2JqLCBrZXlOYW1lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YWx1ZSQkMSA9IG9ialtrZXlOYW1lXTsKICAgICAgfSAvLyBBZGQgdGhlIHRhZyBvZiB0aGUgcmV0dXJuZWQgdmFsdWUgaWYgaXQgaXMgYW4gYXJyYXksIHNpbmNlIGFycmF5cwogICAgICAvLyBzaG91bGQgYWx3YXlzIGNhdXNlIHVwZGF0ZXMgaWYgdGhleSBhcmUgY29uc3VtZWQgYW5kIHRoZW4gY2hhbmdlZAoKCiAgICAgIGlmICh0cnVlCiAgICAgIC8qIEVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyAqLwogICAgICAmJiB0cmFja2luZyAmJiAoQXJyYXkuaXNBcnJheSh2YWx1ZSQkMSkgfHwgKDAsIF91dGlscy5pc0VtYmVyQXJyYXkpKHZhbHVlJCQxKSkpIHsKICAgICAgICBjb25zdW1lKHRhZ0ZvclByb3BlcnR5KHZhbHVlJCQxLCAnW10nKSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhbHVlJCQxID0gb2JqW2tleU5hbWVdOwogICAgfQoKICAgIGlmICh2YWx1ZSQkMSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGlmIChpc09iamVjdCAmJiAhKGtleU5hbWUgaW4gb2JqKSAmJiB0eXBlb2Ygb2JqLnVua25vd25Qcm9wZXJ0eSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiBvYmoudW5rbm93blByb3BlcnR5KGtleU5hbWUpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHZhbHVlJCQxOwogIH0KCiAgZnVuY3Rpb24gX2dldFBhdGgocm9vdCwgcGF0aCkgewogICAgdmFyIG9iaiA9IHJvb3Q7CiAgICB2YXIgcGFydHMgPSB0eXBlb2YgcGF0aCA9PT0gJ3N0cmluZycgPyBwYXRoLnNwbGl0KCcuJykgOiBwYXRoOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKG9iaiA9PT0gdW5kZWZpbmVkIHx8IG9iaiA9PT0gbnVsbCB8fCBvYmouaXNEZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICB9CgogICAgICBvYmogPSBfZ2V0MihvYmosIHBhcnRzW2ldKTsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH0KICAvKioKICAgIFJldHJpZXZlcyB0aGUgdmFsdWUgb2YgYSBwcm9wZXJ0eSBmcm9tIGFuIE9iamVjdCwgb3IgYSBkZWZhdWx0IHZhbHVlIGluIHRoZQogICAgY2FzZSB0aGF0IHRoZSBwcm9wZXJ0eSByZXR1cm5zIGB1bmRlZmluZWRgLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgZ2V0V2l0aERlZmF1bHQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGdldFdpdGhEZWZhdWx0KHBlcnNvbiwgJ2xhc3ROYW1lJywgJ0RvZScpOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIGdldFdpdGhEZWZhdWx0CiAgICBAZm9yIEBlbWJlci9vYmplY3QKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIG9iamVjdCB0byByZXRyaWV2ZSBmcm9tLgogICAgQHBhcmFtIHtTdHJpbmd9IGtleU5hbWUgVGhlIG5hbWUgb2YgdGhlIHByb3BlcnR5IHRvIHJldHJpZXZlCiAgICBAcGFyYW0ge09iamVjdH0gZGVmYXVsdFZhbHVlIFRoZSB2YWx1ZSB0byByZXR1cm4gaWYgdGhlIHByb3BlcnR5IHZhbHVlIGlzIHVuZGVmaW5lZAogICAgQHJldHVybiB7T2JqZWN0fSBUaGUgcHJvcGVydHkgdmFsdWUgb3IgdGhlIGRlZmF1bHRWYWx1ZS4KICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gZ2V0V2l0aERlZmF1bHQocm9vdCwga2V5LCBkZWZhdWx0VmFsdWUpIHsKICAgIHZhciB2YWx1ZSQkMSA9IF9nZXQyKHJvb3QsIGtleSk7CgogICAgaWYgKHZhbHVlJCQxID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgIH0KCiAgICByZXR1cm4gdmFsdWUkJDE7CiAgfQoKICBmdW5jdGlvbiBpc09iamVjdChvYmopIHsKICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJiBvYmogIT09IG51bGw7CiAgfQoKICBmdW5jdGlvbiBpc1ZvbGF0aWxlKG9iaiwga2V5TmFtZSwgbWV0YSQkMSkgewogICAgdmFyIGRlc2MgPSBkZXNjcmlwdG9yRm9yUHJvcGVydHkob2JqLCBrZXlOYW1lLCBtZXRhJCQxKTsKICAgIHJldHVybiAhKGRlc2MgIT09IHVuZGVmaW5lZCAmJiBkZXNjLl92b2xhdGlsZSA9PT0gZmFsc2UpOwogIH0KCiAgdmFyIENoYWluV2F0Y2hlcnMgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBDaGFpbldhdGNoZXJzKCkgewogICAgICAvLyBjaGFpbiBub2RlcyB0aGF0IHJlZmVyZW5jZSBhIGtleSBpbiB0aGlzIG9iaiBieSBrZXkKICAgICAgLy8gd2Ugb25seSBjcmVhdGUgQ2hhaW5XYXRjaGVycyB3aGVuIHdlIGFyZSBnb2luZyB0byBhZGQgdGhlbQogICAgICAvLyBzbyBjcmVhdGUgdGhpcyB1cGZyb250CiAgICAgIHRoaXMuY2hhaW5zID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIH0KCiAgICB2YXIgX3Byb3RvNCA9IENoYWluV2F0Y2hlcnMucHJvdG90eXBlOwoKICAgIF9wcm90bzQuYWRkID0gZnVuY3Rpb24gYWRkKGtleSwgbm9kZSkgewogICAgICB2YXIgbm9kZXMgPSB0aGlzLmNoYWluc1trZXldOwoKICAgICAgaWYgKG5vZGVzID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLmNoYWluc1trZXldID0gW25vZGVdOwogICAgICB9IGVsc2UgewogICAgICAgIG5vZGVzLnB1c2gobm9kZSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNC5yZW1vdmUgPSBmdW5jdGlvbiByZW1vdmUoa2V5LCBub2RlKSB7CiAgICAgIHZhciBub2RlcyA9IHRoaXMuY2hhaW5zW2tleV07CgogICAgICBpZiAobm9kZXMgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChub2Rlc1tpXSA9PT0gbm9kZSkgewogICAgICAgICAgICBub2Rlcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG80LmhhcyA9IGZ1bmN0aW9uIGhhcyhrZXksIG5vZGUpIHsKICAgICAgdmFyIG5vZGVzID0gdGhpcy5jaGFpbnNba2V5XTsKCiAgICAgIGlmIChub2RlcyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKG5vZGVzW2ldID09PSBub2RlKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICBfcHJvdG80LnJldmFsaWRhdGVBbGwgPSBmdW5jdGlvbiByZXZhbGlkYXRlQWxsKCkgewogICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5jaGFpbnMpIHsKICAgICAgICB0aGlzLm5vdGlmeShrZXksIHRydWUsIHVuZGVmaW5lZCk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNC5yZXZhbGlkYXRlID0gZnVuY3Rpb24gcmV2YWxpZGF0ZShrZXkpIHsKICAgICAgdGhpcy5ub3RpZnkoa2V5LCB0cnVlLCB1bmRlZmluZWQpOwogICAgfSAvLyBrZXk6IHRoZSBzdHJpbmcga2V5IHRoYXQgaXMgcGFydCBvZiBhIHBhdGggY2hhbmdlZAogICAgLy8gcmV2YWxpZGF0ZTogYm9vbGVhbjsgdGhlIGNoYWlucyB0aGF0IGFyZSB3YXRjaGluZyB0aGlzIHZhbHVlIHNob3VsZCByZXZhbGlkYXRlCiAgICAvLyBjYWxsYmFjazogZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSBvYmplY3QgYW5kIHBhdGggdGhhdAogICAgLy8gICAgICAgICAgIHdpbGwgYmUvYXJlIGludmFsaWRhdGVkIGJ5IHRoaXMga2V5IGNoYW5nZSwgZGVwZW5kaW5nIG9uCiAgICAvLyAgICAgICAgICAgd2hldGhlciB0aGUgcmV2YWxpZGF0ZSBmbGFnIGlzIHBhc3NlZAogICAgOwoKICAgIF9wcm90bzQubm90aWZ5ID0gZnVuY3Rpb24gbm90aWZ5KGtleSwgcmV2YWxpZGF0ZSwgY2FsbGJhY2spIHsKICAgICAgdmFyIG5vZGVzID0gdGhpcy5jaGFpbnNba2V5XTsKCiAgICAgIGlmIChub2RlcyA9PT0gdW5kZWZpbmVkIHx8IG5vZGVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGFmZmVjdGVkID0gdW5kZWZpbmVkOwoKICAgICAgaWYgKGNhbGxiYWNrICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBhZmZlY3RlZCA9IFtdOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbm9kZXNbaV0ubm90aWZ5KHJldmFsaWRhdGUsIGFmZmVjdGVkKTsKICAgICAgfQoKICAgICAgaWYgKGNhbGxiYWNrID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gd2UgZ2F0aGVyIGNhbGxiYWNrcyBzbyB3ZSBkb24ndCBub3RpZnkgdGhlbSBkdXJpbmcgcmV2YWxpZGF0aW9uCgoKICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGFmZmVjdGVkLmxlbmd0aDsgX2kgKz0gMikgewogICAgICAgIHZhciBvYmogPSBhZmZlY3RlZFtfaV07CiAgICAgICAgdmFyIHBhdGggPSBhZmZlY3RlZFtfaSArIDFdOwogICAgICAgIGNhbGxiYWNrKG9iaiwgcGF0aCk7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIENoYWluV2F0Y2hlcnM7CiAgfSgpOwoKICBmdW5jdGlvbiBtYWtlQ2hhaW5XYXRjaGVyKCkgewogICAgcmV0dXJuIG5ldyBDaGFpbldhdGNoZXJzKCk7CiAgfQoKICBmdW5jdGlvbiBtYWtlQ2hhaW5Ob2RlKG9iaikgewogICAgcmV0dXJuIG5ldyBDaGFpbk5vZGUobnVsbCwgbnVsbCwgb2JqKTsKICB9CgogIGZ1bmN0aW9uIGFkZENoYWluV2F0Y2hlcihvYmosIGtleU5hbWUsIG5vZGUpIHsKICAgIHZhciBtID0gKDAsIF9tZXRhMi5tZXRhKShvYmopOwogICAgbS53cml0YWJsZUNoYWluV2F0Y2hlcnMobWFrZUNoYWluV2F0Y2hlcikuYWRkKGtleU5hbWUsIG5vZGUpOwogICAgd2F0Y2hLZXkob2JqLCBrZXlOYW1lLCBtKTsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZUNoYWluV2F0Y2hlcihvYmosIGtleU5hbWUsIG5vZGUsIF9tZXRhKSB7CiAgICBpZiAoIWlzT2JqZWN0KG9iaikpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBtZXRhJCQxID0gX21ldGEgPT09IHVuZGVmaW5lZCA/ICgwLCBfbWV0YTIucGVla01ldGEpKG9iaikgOiBfbWV0YTsKCiAgICBpZiAobWV0YSQkMSA9PT0gbnVsbCB8fCBtZXRhJCQxLmlzU291cmNlRGVzdHJveWluZygpIHx8IG1ldGEkJDEuaXNNZXRhRGVzdHJveWVkKCkgfHwgbWV0YSQkMS5yZWFkYWJsZUNoYWluV2F0Y2hlcnMoKSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybjsKICAgIH0gLy8gbWFrZSBtZXRhIHdyaXRhYmxlCgoKICAgIG1ldGEkJDEgPSAoMCwgX21ldGEyLm1ldGEpKG9iaik7CiAgICBtZXRhJCQxLnJlYWRhYmxlQ2hhaW5XYXRjaGVycygpLnJlbW92ZShrZXlOYW1lLCBub2RlKTsKICAgIHVud2F0Y2hLZXkob2JqLCBrZXlOYW1lLCBtZXRhJCQxKTsKICB9CgogIHZhciBOT0RFX1NUQUNLID0gW107CgogIGZ1bmN0aW9uIGRlc3Ryb3lSb290KHJvb3QpIHsKICAgIHB1c2hDaGlsZHJlbihyb290KTsKCiAgICB3aGlsZSAoTk9ERV9TVEFDSy5sZW5ndGggPiAwKSB7CiAgICAgIHZhciBub2RlID0gTk9ERV9TVEFDSy5wb3AoKTsKICAgICAgcHVzaENoaWxkcmVuKG5vZGUpOwogICAgICBkZXN0cm95T25lKG5vZGUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZGVzdHJveU9uZShub2RlKSB7CiAgICBpZiAobm9kZS5pc1dhdGNoaW5nKSB7CiAgICAgIHJlbW92ZUNoYWluV2F0Y2hlcihub2RlLm9iamVjdCwgbm9kZS5rZXksIG5vZGUpOwogICAgICBub2RlLmlzV2F0Y2hpbmcgPSBmYWxzZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHB1c2hDaGlsZHJlbihub2RlKSB7CiAgICB2YXIgbm9kZXMgPSBub2RlLmNoYWluczsKCiAgICBpZiAobm9kZXMgIT09IHVuZGVmaW5lZCkgewogICAgICBmb3IgKHZhciBrZXkgaW4gbm9kZXMpIHsKICAgICAgICBpZiAobm9kZXNba2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBOT0RFX1NUQUNLLnB1c2gobm9kZXNba2V5XSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSAvLyBBIENoYWluTm9kZSB3YXRjaGVzIGEgc2luZ2xlIGtleSBvbiBhbiBvYmplY3QuIElmIHlvdSBwcm92aWRlIGEgc3RhcnRpbmcKICAvLyB2YWx1ZSBmb3IgdGhlIGtleSB0aGVuIHRoZSBub2RlIHdvbid0IGFjdHVhbGx5IHdhdGNoIGl0LiBGb3IgYSByb290IG5vZGUKICAvLyBwYXNzIG51bGwgZm9yIHBhcmVudCBhbmQga2V5IGFuZCBvYmplY3QgZm9yIHZhbHVlLgoKCiAgdmFyIENoYWluTm9kZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIENoYWluTm9kZShwYXJlbnQsIGtleSwgdmFsdWUkJDEpIHsKICAgICAgdGhpcy5wYXRocyA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5pc1dhdGNoaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuY2hhaW5zID0gdW5kZWZpbmVkOwogICAgICB0aGlzLm9iamVjdCA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5jb3VudCA9IDA7CiAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgdGhpcy5jb250ZW50ID0gdmFsdWUkJDE7IC8vIEl0IGlzIGZhbHNlIGZvciB0aGUgcm9vdCBvZiBhIGNoYWluIChiZWNhdXNlIHdlIGhhdmUgbm8gcGFyZW50KQoKICAgICAgdmFyIGlzV2F0Y2hpbmcgPSB0aGlzLmlzV2F0Y2hpbmcgPSBwYXJlbnQgIT09IG51bGw7CgogICAgICBpZiAoaXNXYXRjaGluZykgewogICAgICAgIHZhciBwYXJlbnRWYWx1ZSA9IHBhcmVudC52YWx1ZSgpOwoKICAgICAgICBpZiAoaXNPYmplY3QocGFyZW50VmFsdWUpKSB7CiAgICAgICAgICB0aGlzLm9iamVjdCA9IHBhcmVudFZhbHVlOwogICAgICAgICAgYWRkQ2hhaW5XYXRjaGVyKHBhcmVudFZhbHVlLCBrZXksIHRoaXMpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHZhciBfcHJvdG81ID0gQ2hhaW5Ob2RlLnByb3RvdHlwZTsKCiAgICBfcHJvdG81LnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIGlmICh0aGlzLmNvbnRlbnQgPT09IHVuZGVmaW5lZCAmJiB0aGlzLmlzV2F0Y2hpbmcpIHsKICAgICAgICB2YXIgb2JqID0gdGhpcy5wYXJlbnQudmFsdWUoKTsKICAgICAgICB0aGlzLmNvbnRlbnQgPSBsYXp5R2V0KG9iaiwgdGhpcy5rZXkpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5jb250ZW50OwogICAgfTsKCiAgICBfcHJvdG81LmRlc3Ryb3kgPSBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICAvLyBjaGVjayBpZiByb290CiAgICAgIGlmICh0aGlzLnBhcmVudCA9PT0gbnVsbCkgewogICAgICAgIGRlc3Ryb3lSb290KHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIGRlc3Ryb3lPbmUodGhpcyk7CiAgICAgIH0KICAgIH0gLy8gY29waWVzIGEgdG9wIGxldmVsIG9iamVjdCBvbmx5CiAgICA7CgogICAgX3Byb3RvNS5jb3B5VG8gPSBmdW5jdGlvbiBjb3B5VG8odGFyZ2V0KSB7CiAgICAgIHZhciBwYXRocyA9IHRoaXMucGF0aHM7CgogICAgICBpZiAocGF0aHMgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhciBwYXRoOwoKICAgICAgICBmb3IgKHBhdGggaW4gcGF0aHMpIHsKICAgICAgICAgIGlmIChwYXRoc1twYXRoXSA+IDApIHsKICAgICAgICAgICAgdGFyZ2V0LmFkZChwYXRoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gLy8gY2FsbGVkIG9uIHRoZSByb290IG5vZGUgb2YgYSBjaGFpbiB0byBzZXR1cCB3YXRjaGVycyBvbiB0aGUgc3BlY2lmaWVkCiAgICAvLyBwYXRoLgogICAgOwoKICAgIF9wcm90bzUuYWRkID0gZnVuY3Rpb24gYWRkKHBhdGgpIHsKICAgICAgdmFyIHBhdGhzID0gdGhpcy5wYXRocyB8fCAodGhpcy5wYXRocyA9IHt9KTsKICAgICAgcGF0aHNbcGF0aF0gPSAocGF0aHNbcGF0aF0gfHwgMCkgKyAxOwogICAgICB2YXIgdGFpbHMgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICAgIHRoaXMuY2hhaW4odGFpbHMuc2hpZnQoKSwgdGFpbHMpOwogICAgfSAvLyBjYWxsZWQgb24gdGhlIHJvb3Qgbm9kZSBvZiBhIGNoYWluIHRvIHRlYXJkb3duIHdhdGNoZXIgb24gdGhlIHNwZWNpZmllZAogICAgLy8gcGF0aAogICAgOwoKICAgIF9wcm90bzUucmVtb3ZlID0gZnVuY3Rpb24gcmVtb3ZlKHBhdGgpIHsKICAgICAgdmFyIHBhdGhzID0gdGhpcy5wYXRoczsKCiAgICAgIGlmIChwYXRocyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAocGF0aHNbcGF0aF0gPiAwKSB7CiAgICAgICAgcGF0aHNbcGF0aF0tLTsKICAgICAgfQoKICAgICAgdmFyIHRhaWxzID0gcGF0aC5zcGxpdCgnLicpOwogICAgICB0aGlzLnVuY2hhaW4odGFpbHMuc2hpZnQoKSwgdGFpbHMpOwogICAgfTsKCiAgICBfcHJvdG81LmNoYWluID0gZnVuY3Rpb24gY2hhaW4oa2V5LCB0YWlscykgewogICAgICB2YXIgY2hhaW5zID0gdGhpcy5jaGFpbnM7CgogICAgICBpZiAoY2hhaW5zID09PSB1bmRlZmluZWQpIHsKICAgICAgICBjaGFpbnMgPSB0aGlzLmNoYWlucyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIH0KCiAgICAgIHZhciBub2RlID0gY2hhaW5zW2tleV07CgogICAgICBpZiAobm9kZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgbm9kZSA9IGNoYWluc1trZXldID0gbmV3IENoYWluTm9kZSh0aGlzLCBrZXksIHVuZGVmaW5lZCk7CiAgICAgIH0KCiAgICAgIG5vZGUuY291bnQrKzsgLy8gY291bnQgY2hhaW5zLi4uCiAgICAgIC8vIGNoYWluIHJlc3Qgb2YgcGF0aCBpZiB0aGVyZSBpcyBvbmUKCiAgICAgIGlmICh0YWlscy5sZW5ndGggPiAwKSB7CiAgICAgICAgbm9kZS5jaGFpbih0YWlscy5zaGlmdCgpLCB0YWlscyk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNS51bmNoYWluID0gZnVuY3Rpb24gdW5jaGFpbihrZXksIHRhaWxzKSB7CiAgICAgIHZhciBjaGFpbnMgPSB0aGlzLmNoYWluczsKICAgICAgdmFyIG5vZGUgPSBjaGFpbnNba2V5XTsgLy8gdW5jaGFpbiByZXN0IG9mIHBhdGggZmlyc3QuLi4KCiAgICAgIGlmICh0YWlscy5sZW5ndGggPiAwKSB7CiAgICAgICAgbm9kZS51bmNoYWluKHRhaWxzLnNoaWZ0KCksIHRhaWxzKTsKICAgICAgfSAvLyBkZWxldGUgbm9kZSBpZiBuZWVkZWQuCgoKICAgICAgbm9kZS5jb3VudC0tOwoKICAgICAgaWYgKG5vZGUuY291bnQgPD0gMCkgewogICAgICAgIGNoYWluc1tub2RlLmtleV0gPSB1bmRlZmluZWQ7CiAgICAgICAgbm9kZS5kZXN0cm95KCk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNS5ub3RpZnkgPSBmdW5jdGlvbiBub3RpZnkocmV2YWxpZGF0ZSwgYWZmZWN0ZWQpIHsKICAgICAgaWYgKHJldmFsaWRhdGUgJiYgdGhpcy5pc1dhdGNoaW5nKSB7CiAgICAgICAgdmFyIHBhcmVudFZhbHVlID0gdGhpcy5wYXJlbnQudmFsdWUoKTsKCiAgICAgICAgaWYgKHBhcmVudFZhbHVlICE9PSB0aGlzLm9iamVjdCkgewogICAgICAgICAgcmVtb3ZlQ2hhaW5XYXRjaGVyKHRoaXMub2JqZWN0LCB0aGlzLmtleSwgdGhpcyk7CgogICAgICAgICAgaWYgKGlzT2JqZWN0KHBhcmVudFZhbHVlKSkgewogICAgICAgICAgICB0aGlzLm9iamVjdCA9IHBhcmVudFZhbHVlOwogICAgICAgICAgICBhZGRDaGFpbldhdGNoZXIocGFyZW50VmFsdWUsIHRoaXMua2V5LCB0aGlzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMub2JqZWN0ID0gdW5kZWZpbmVkOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb250ZW50ID0gdW5kZWZpbmVkOwogICAgICB9IC8vIHRoZW4gbm90aWZ5IGNoYWlucy4uLgoKCiAgICAgIHZhciBjaGFpbnMgPSB0aGlzLmNoYWluczsKCiAgICAgIGlmIChjaGFpbnMgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhciBub2RlOwoKICAgICAgICBmb3IgKHZhciBrZXkgaW4gY2hhaW5zKSB7CiAgICAgICAgICBub2RlID0gY2hhaW5zW2tleV07CgogICAgICAgICAgaWYgKG5vZGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBub2RlLm5vdGlmeShyZXZhbGlkYXRlLCBhZmZlY3RlZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoYWZmZWN0ZWQgIT09IHVuZGVmaW5lZCAmJiB0aGlzLnBhcmVudCAhPT0gbnVsbCkgewogICAgICAgIHRoaXMucGFyZW50LnBvcHVsYXRlQWZmZWN0ZWQodGhpcy5rZXksIDEsIGFmZmVjdGVkKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG81LnBvcHVsYXRlQWZmZWN0ZWQgPSBmdW5jdGlvbiBwb3B1bGF0ZUFmZmVjdGVkKHBhdGgsIGRlcHRoLCBhZmZlY3RlZCkgewogICAgICBpZiAodGhpcy5rZXkpIHsKICAgICAgICBwYXRoID0gdGhpcy5rZXkgKyAiLiIgKyBwYXRoOwogICAgICB9CgogICAgICBpZiAodGhpcy5wYXJlbnQgIT09IG51bGwpIHsKICAgICAgICB0aGlzLnBhcmVudC5wb3B1bGF0ZUFmZmVjdGVkKHBhdGgsIGRlcHRoICsgMSwgYWZmZWN0ZWQpOwogICAgICB9IGVsc2UgaWYgKGRlcHRoID4gMSkgewogICAgICAgIGFmZmVjdGVkLnB1c2godGhpcy52YWx1ZSgpLCBwYXRoKTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gQ2hhaW5Ob2RlOwogIH0oKTsKCiAgX2V4cG9ydHMuQ2hhaW5Ob2RlID0gQ2hhaW5Ob2RlOwoKICBmdW5jdGlvbiBsYXp5R2V0KG9iaiwga2V5KSB7CiAgICBpZiAoIWlzT2JqZWN0KG9iaikpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBtZXRhJCQxID0gKDAsIF9tZXRhMi5wZWVrTWV0YSkob2JqKTsgLy8gY2hlY2sgaWYgb2JqZWN0IG1lYW50IG9ubHkgdG8gYmUgYSBwcm90b3R5cGUKCiAgICBpZiAobWV0YSQkMSAhPT0gbnVsbCAmJiBtZXRhJCQxLnByb3RvID09PSBvYmopIHsKICAgICAgcmV0dXJuOwogICAgfSAvLyBVc2UgYGdldGAgaWYgdGhlIHJldHVybiB2YWx1ZSBpcyBhbiBFYWNoUHJveHkgb3IgYW4gdW5jYWNoZWFibGUgdmFsdWUuCgoKICAgIGlmIChrZXkgPT09ICdAZWFjaCcpIHsKICAgICAgcmV0dXJuIGVhY2hQcm94eUZvcihvYmopOwogICAgfSBlbHNlIGlmIChpc1ZvbGF0aWxlKG9iaiwga2V5LCBtZXRhJCQxKSkgewogICAgICByZXR1cm4gX2dldDIob2JqLCBrZXkpOyAvLyBPdGhlcndpc2UgYXR0ZW1wdCB0byBnZXQgdGhlIGNhY2hlZCB2YWx1ZSBvZiB0aGUgY29tcHV0ZWQgcHJvcGVydHkKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBnZXRDYWNoZWRWYWx1ZUZvcihvYmosIGtleSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBmaW5pc2hDaGFpbnMobWV0YSQkMSkgewogICAgLy8gZmluaXNoIGFueSBjdXJyZW50IGNoYWlucyBub2RlIHdhdGNoZXJzIHRoYXQgcmVmZXJlbmNlIG9iagogICAgdmFyIGNoYWluV2F0Y2hlcnMgPSBtZXRhJCQxLnJlYWRhYmxlQ2hhaW5XYXRjaGVycygpOwoKICAgIGlmIChjaGFpbldhdGNoZXJzICE9PSB1bmRlZmluZWQpIHsKICAgICAgY2hhaW5XYXRjaGVycy5yZXZhbGlkYXRlQWxsKCk7CiAgICB9IC8vIGVuc3VyZSB0aGF0IGlmIHdlIGhhdmUgaW5oZXJpdGVkIGFueSBjaGFpbnMgdGhleSBoYXZlIGJlZW4KICAgIC8vIGNvcGllZCBvbnRvIG91ciBvd24gbWV0YS4KCgogICAgaWYgKG1ldGEkJDEucmVhZGFibGVDaGFpbnMoKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIG1ldGEkJDEud3JpdGFibGVDaGFpbnMobWFrZUNoYWluTm9kZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB3YXRjaFBhdGgob2JqLCBrZXlQYXRoLCBtZXRhJCQxKSB7CiAgICB2YXIgbSA9IG1ldGEkJDEgPT09IHVuZGVmaW5lZCA/ICgwLCBfbWV0YTIubWV0YSkob2JqKSA6IG1ldGEkJDE7CiAgICB2YXIgY291bnRlciA9IG0ucGVla1dhdGNoaW5nKGtleVBhdGgpOwogICAgbS53cml0ZVdhdGNoaW5nKGtleVBhdGgsIGNvdW50ZXIgKyAxKTsKCiAgICBpZiAoY291bnRlciA9PT0gMCkgewogICAgICAvLyBhY3RpdmF0ZSB3YXRjaGluZyBmaXJzdCB0aW1lCiAgICAgIG0ud3JpdGFibGVDaGFpbnMobWFrZUNoYWluTm9kZSkuYWRkKGtleVBhdGgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdW53YXRjaFBhdGgob2JqLCBrZXlQYXRoLCBtZXRhJCQxKSB7CiAgICB2YXIgbSA9IG1ldGEkJDEgPT09IHVuZGVmaW5lZCA/ICgwLCBfbWV0YTIucGVla01ldGEpKG9iaikgOiBtZXRhJCQxOwoKICAgIGlmIChtID09PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgY291bnRlciA9IG0ucGVla1dhdGNoaW5nKGtleVBhdGgpOwoKICAgIGlmIChjb3VudGVyID4gMCkgewogICAgICBtLndyaXRlV2F0Y2hpbmcoa2V5UGF0aCwgY291bnRlciAtIDEpOwoKICAgICAgaWYgKGNvdW50ZXIgPT09IDEpIHsKICAgICAgICBtLndyaXRhYmxlQ2hhaW5zKG1ha2VDaGFpbk5vZGUpLnJlbW92ZShrZXlQYXRoKTsKICAgICAgfQogICAgfQogIH0KICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICBTdGFydHMgd2F0Y2hpbmcgYSBwcm9wZXJ0eSBvbiBhbiBvYmplY3QuIFdoZW5ldmVyIHRoZSBwcm9wZXJ0eSBjaGFuZ2VzLAogICAgaW52b2tlcyBgRW1iZXIubm90aWZ5UHJvcGVydHlDaGFuZ2VgLiBUaGlzIGlzIHRoZSBwcmltaXRpdmUgdXNlZCBieSBvYnNlcnZlcnMKICAgIGFuZCBkZXBlbmRlbnQga2V5czsgdXN1YWxseSB5b3Ugd2lsbCBuZXZlciBjYWxsIHRoaXMgbWV0aG9kIGRpcmVjdGx5IGJ1dCBpbnN0ZWFkCiAgICB1c2UgaGlnaGVyIGxldmVsIG1ldGhvZHMgbGlrZSBgYWRkT2JzZXJ2ZXIoKWAuCiAgCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCB3YXRjaAogICAgQGZvciBFbWJlcgogICAgQHBhcmFtIG9iagogICAgQHBhcmFtIHtTdHJpbmd9IGtleVBhdGgKICAgIEBwYXJhbSB7T2JqZWN0fSBtZXRhCiAgKi8KCgogIGZ1bmN0aW9uIHdhdGNoKG9iaiwga2V5UGF0aCwgbWV0YSQkMSkgewogICAgaWYgKGlzUGF0aChrZXlQYXRoKSkgewogICAgICB3YXRjaFBhdGgob2JqLCBrZXlQYXRoLCBtZXRhJCQxKTsKICAgIH0gZWxzZSB7CiAgICAgIHdhdGNoS2V5KG9iaiwga2V5UGF0aCwgbWV0YSQkMSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc1dhdGNoaW5nKG9iaiwga2V5KSB7CiAgICByZXR1cm4gd2F0Y2hlckNvdW50KG9iaiwga2V5KSA+IDA7CiAgfQoKICBmdW5jdGlvbiB3YXRjaGVyQ291bnQob2JqLCBrZXkpIHsKICAgIHZhciBtZXRhJCQxID0gKDAsIF9tZXRhMi5wZWVrTWV0YSkob2JqKTsKICAgIHJldHVybiBtZXRhJCQxICE9PSBudWxsICYmIG1ldGEkJDEucGVla1dhdGNoaW5nKGtleSkgfHwgMDsKICB9CiAgLyoqCiAgICBTdG9wcyB3YXRjaGluZyBhIHByb3BlcnR5IG9uIGFuIG9iamVjdC4gVXN1YWxseSB5b3Ugd2lsbCBuZXZlciBjYWxsIHRoaXMgbWV0aG9kIGRpcmVjdGx5IGJ1dCBpbnN0ZWFkCiAgICB1c2UgaGlnaGVyIGxldmVsIG1ldGhvZHMgbGlrZSBgcmVtb3ZlT2JzZXJ2ZXIoKWAuCiAgCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCB1bndhdGNoCiAgICBAZm9yIEVtYmVyCiAgICBAcGFyYW0gb2JqCiAgICBAcGFyYW0ge1N0cmluZ30ga2V5UGF0aAogICAgQHBhcmFtIHtPYmplY3R9IG1ldGEKICAqLwoKCiAgZnVuY3Rpb24gdW53YXRjaChvYmosIGtleVBhdGgsIG1ldGEkJDEpIHsKICAgIGlmIChpc1BhdGgoa2V5UGF0aCkpIHsKICAgICAgdW53YXRjaFBhdGgob2JqLCBrZXlQYXRoLCBtZXRhJCQxKTsKICAgIH0gZWxzZSB7CiAgICAgIHVud2F0Y2hLZXkob2JqLCBrZXlQYXRoLCBtZXRhJCQxKTsKICAgIH0KICB9CgogIHZhciBTWU5DX0RFRkFVTFQgPSAhX2Vudmlyb25tZW50LkVOVi5fREVGQVVMVF9BU1lOQ19PQlNFUlZFUlM7CiAgdmFyIFNZTkNfT0JTRVJWRVJTID0gbmV3IE1hcCgpOwogIHZhciBBU1lOQ19PQlNFUlZFUlMgPSBuZXcgTWFwKCk7CiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgKi8KCiAgLyoqCiAgICBAbWV0aG9kIGFkZE9ic2VydmVyCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3Qvb2JzZXJ2ZXJzCiAgICBAcGFyYW0gb2JqCiAgICBAcGFyYW0ge1N0cmluZ30gcGF0aAogICAgQHBhcmFtIHtPYmplY3R8RnVuY3Rpb259IHRhcmdldAogICAgQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IFttZXRob2RdCiAgICBAcHVibGljCiAgKi8KCiAgZnVuY3Rpb24gYWRkT2JzZXJ2ZXIob2JqLCBwYXRoLCB0YXJnZXQsIG1ldGhvZCwgc3luYykgewogICAgaWYgKHN5bmMgPT09IHZvaWQgMCkgewogICAgICBzeW5jID0gU1lOQ19ERUZBVUxUOwogICAgfQoKICAgIHZhciBldmVudE5hbWUgPSBjaGFuZ2VFdmVudChwYXRoKTsKICAgIGFkZExpc3RlbmVyKG9iaiwgZXZlbnROYW1lLCB0YXJnZXQsIG1ldGhvZCwgZmFsc2UsIHN5bmMpOwogICAgewogICAgICB2YXIgbWV0YSQkMSA9ICgwLCBfbWV0YTIucGVla01ldGEpKG9iaik7CgogICAgICBpZiAobWV0YSQkMSA9PT0gbnVsbCB8fCAhKG1ldGEkJDEuaXNQcm90b3R5cGVNZXRhKG9iaikgfHwgbWV0YSQkMS5pc0luaXRpYWxpemluZygpKSkgewogICAgICAgIGFjdGl2YXRlT2JzZXJ2ZXIob2JqLCBldmVudE5hbWUsIHN5bmMpOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAgQG1ldGhvZCByZW1vdmVPYnNlcnZlcgogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L29ic2VydmVycwogICAgQHBhcmFtIG9iagogICAgQHBhcmFtIHtTdHJpbmd9IHBhdGgKICAgIEBwYXJhbSB7T2JqZWN0fEZ1bmN0aW9ufSB0YXJnZXQKICAgIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBbbWV0aG9kXQogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiByZW1vdmVPYnNlcnZlcihvYmosIHBhdGgsIHRhcmdldCwgbWV0aG9kLCBzeW5jKSB7CiAgICBpZiAoc3luYyA9PT0gdm9pZCAwKSB7CiAgICAgIHN5bmMgPSBTWU5DX0RFRkFVTFQ7CiAgICB9CgogICAgdmFyIGV2ZW50TmFtZSA9IGNoYW5nZUV2ZW50KHBhdGgpOwogICAgewogICAgICB2YXIgbWV0YSQkMSA9ICgwLCBfbWV0YTIucGVla01ldGEpKG9iaik7CgogICAgICBpZiAobWV0YSQkMSA9PT0gbnVsbCB8fCAhKG1ldGEkJDEuaXNQcm90b3R5cGVNZXRhKG9iaikgfHwgbWV0YSQkMS5pc0luaXRpYWxpemluZygpKSkgewogICAgICAgIGRlYWN0aXZhdGVPYnNlcnZlcihvYmosIGV2ZW50TmFtZSwgc3luYyk7CiAgICAgIH0KICAgIH0KICAgIHJlbW92ZUxpc3RlbmVyKG9iaiwgZXZlbnROYW1lLCB0YXJnZXQsIG1ldGhvZCk7CiAgfQoKICBmdW5jdGlvbiBnZXRPckNyZWF0ZUFjdGl2ZU9ic2VydmVyc0Zvcih0YXJnZXQsIHN5bmMpIHsKICAgIHZhciBvYnNlcnZlck1hcCA9IHN5bmMgPT09IHRydWUgPyBTWU5DX09CU0VSVkVSUyA6IEFTWU5DX09CU0VSVkVSUzsKCiAgICBpZiAoIW9ic2VydmVyTWFwLmhhcyh0YXJnZXQpKSB7CiAgICAgIG9ic2VydmVyTWFwLnNldCh0YXJnZXQsIG5ldyBNYXAoKSk7CiAgICB9CgogICAgcmV0dXJuIG9ic2VydmVyTWFwLmdldCh0YXJnZXQpOwogIH0KCiAgZnVuY3Rpb24gYWN0aXZhdGVPYnNlcnZlcih0YXJnZXQsIGV2ZW50TmFtZSwgc3luYykgewogICAgaWYgKHN5bmMgPT09IHZvaWQgMCkgewogICAgICBzeW5jID0gZmFsc2U7CiAgICB9CgogICAgdmFyIGFjdGl2ZU9ic2VydmVycyA9IGdldE9yQ3JlYXRlQWN0aXZlT2JzZXJ2ZXJzRm9yKHRhcmdldCwgc3luYyk7CgogICAgaWYgKGFjdGl2ZU9ic2VydmVycy5oYXMoZXZlbnROYW1lKSkgewogICAgICBhY3RpdmVPYnNlcnZlcnMuZ2V0KGV2ZW50TmFtZSkuY291bnQrKzsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBfZXZlbnROYW1lJHNwbGl0ID0gZXZlbnROYW1lLnNwbGl0KCc6JyksCiAgICAgICAgICBwYXRoID0gX2V2ZW50TmFtZSRzcGxpdFswXTsKCiAgICAgIHZhciB0YWcgPSAoMCwgX3JlZmVyZW5jZS5jb21iaW5lKShnZXRDaGFpblRhZ3NGb3JLZXkodGFyZ2V0LCBwYXRoKSk7CiAgICAgIGFjdGl2ZU9ic2VydmVycy5zZXQoZXZlbnROYW1lLCB7CiAgICAgICAgY291bnQ6IDEsCiAgICAgICAgcGF0aDogcGF0aCwKICAgICAgICB0YWc6IHRhZywKICAgICAgICBsYXN0UmV2aXNpb246ICgwLCBfcmVmZXJlbmNlLnZhbHVlKSh0YWcpLAogICAgICAgIHN1c3BlbmRlZDogZmFsc2UKICAgICAgfSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkZWFjdGl2YXRlT2JzZXJ2ZXIodGFyZ2V0LCBldmVudE5hbWUsIHN5bmMpIHsKICAgIGlmIChzeW5jID09PSB2b2lkIDApIHsKICAgICAgc3luYyA9IGZhbHNlOwogICAgfQoKICAgIHZhciBvYnNlcnZlck1hcCA9IHN5bmMgPT09IHRydWUgPyBTWU5DX09CU0VSVkVSUyA6IEFTWU5DX09CU0VSVkVSUzsKICAgIHZhciBhY3RpdmVPYnNlcnZlcnMgPSBvYnNlcnZlck1hcC5nZXQodGFyZ2V0KTsKCiAgICBpZiAoYWN0aXZlT2JzZXJ2ZXJzICE9PSB1bmRlZmluZWQpIHsKICAgICAgdmFyIF9vYnNlcnZlciA9IGFjdGl2ZU9ic2VydmVycy5nZXQoZXZlbnROYW1lKTsKCiAgICAgIF9vYnNlcnZlci5jb3VudC0tOwoKICAgICAgaWYgKF9vYnNlcnZlci5jb3VudCA9PT0gMCkgewogICAgICAgIGFjdGl2ZU9ic2VydmVycy5kZWxldGUoZXZlbnROYW1lKTsKCiAgICAgICAgaWYgKGFjdGl2ZU9ic2VydmVycy5zaXplID09PSAwKSB7CiAgICAgICAgICBvYnNlcnZlck1hcC5kZWxldGUodGFyZ2V0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogUHJpbWFyaWx5IHVzZWQgZm9yIGNhc2VzIHdoZXJlIHdlIGFyZSByZWRlZmluaW5nIGEgY2xhc3MsIGUuZy4gbWl4aW5zL3Jlb3BlbgogICAqIGJlaW5nIGFwcGxpZWQgbGF0ZXIuIFJldmFsaWRhdGVzIGFsbCB0aGUgb2JzZXJ2ZXJzLCByZXNldHRpbmcgdGhlaXIgdGFncy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHRhcmdldAogICAqLwoKCiAgZnVuY3Rpb24gcmV2YWxpZGF0ZU9ic2VydmVycyh0YXJnZXQpIHsKICAgIGlmIChBU1lOQ19PQlNFUlZFUlMuaGFzKHRhcmdldCkpIHsKICAgICAgQVNZTkNfT0JTRVJWRVJTLmdldCh0YXJnZXQpLmZvckVhY2goZnVuY3Rpb24gKG9ic2VydmVyKSB7CiAgICAgICAgb2JzZXJ2ZXIudGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoZ2V0Q2hhaW5UYWdzRm9yS2V5KHRhcmdldCwgb2JzZXJ2ZXIucGF0aCkpOwogICAgICAgIG9ic2VydmVyLmxhc3RSZXZpc2lvbiA9ICgwLCBfcmVmZXJlbmNlLnZhbHVlKShvYnNlcnZlci50YWcpOwogICAgICB9KTsKICAgIH0KCiAgICBpZiAoU1lOQ19PQlNFUlZFUlMuaGFzKHRhcmdldCkpIHsKICAgICAgU1lOQ19PQlNFUlZFUlMuZ2V0KHRhcmdldCkuZm9yRWFjaChmdW5jdGlvbiAob2JzZXJ2ZXIpIHsKICAgICAgICBvYnNlcnZlci50YWcgPSAoMCwgX3JlZmVyZW5jZS5jb21iaW5lKShnZXRDaGFpblRhZ3NGb3JLZXkodGFyZ2V0LCBvYnNlcnZlci5wYXRoKSk7CiAgICAgICAgb2JzZXJ2ZXIubGFzdFJldmlzaW9uID0gKDAsIF9yZWZlcmVuY2UudmFsdWUpKG9ic2VydmVyLnRhZyk7CiAgICAgIH0pOwogICAgfQogIH0KCiAgdmFyIGxhc3RLbm93blJldmlzaW9uID0gMDsKCiAgZnVuY3Rpb24gZmx1c2hBc3luY09ic2VydmVycyhzaG91bGRTY2hlZHVsZSkgewogICAgaWYgKHNob3VsZFNjaGVkdWxlID09PSB2b2lkIDApIHsKICAgICAgc2hvdWxkU2NoZWR1bGUgPSB0cnVlOwogICAgfQoKICAgIGlmIChsYXN0S25vd25SZXZpc2lvbiA9PT0gKDAsIF9yZWZlcmVuY2UudmFsdWUpKF9yZWZlcmVuY2UuQ1VSUkVOVF9UQUcpKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBsYXN0S25vd25SZXZpc2lvbiA9ICgwLCBfcmVmZXJlbmNlLnZhbHVlKShfcmVmZXJlbmNlLkNVUlJFTlRfVEFHKTsKICAgIEFTWU5DX09CU0VSVkVSUy5mb3JFYWNoKGZ1bmN0aW9uIChhY3RpdmVPYnNlcnZlcnMsIHRhcmdldCkgewogICAgICB2YXIgbWV0YSQkMSA9ICgwLCBfbWV0YTIucGVla01ldGEpKHRhcmdldCk7CgogICAgICBpZiAobWV0YSQkMSAmJiAobWV0YSQkMS5pc1NvdXJjZURlc3Ryb3lpbmcoKSB8fCBtZXRhJCQxLmlzTWV0YURlc3Ryb3llZCgpKSkgewogICAgICAgIEFTWU5DX09CU0VSVkVSUy5kZWxldGUodGFyZ2V0KTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGFjdGl2ZU9ic2VydmVycy5mb3JFYWNoKGZ1bmN0aW9uIChvYnNlcnZlciwgZXZlbnROYW1lKSB7CiAgICAgICAgaWYgKCEoMCwgX3JlZmVyZW5jZS52YWxpZGF0ZSkob2JzZXJ2ZXIudGFnLCBvYnNlcnZlci5sYXN0UmV2aXNpb24pKSB7CiAgICAgICAgICB2YXIgc2VuZE9ic2VydmVyID0gZnVuY3Rpb24gc2VuZE9ic2VydmVyKCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHNlbmRFdmVudCh0YXJnZXQsIGV2ZW50TmFtZSwgW3RhcmdldCwgb2JzZXJ2ZXIucGF0aF0pOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIG9ic2VydmVyLnRhZyA9ICgwLCBfcmVmZXJlbmNlLmNvbWJpbmUpKGdldENoYWluVGFnc0ZvcktleSh0YXJnZXQsIG9ic2VydmVyLnBhdGgpKTsKICAgICAgICAgICAgICBvYnNlcnZlci5sYXN0UmV2aXNpb24gPSAoMCwgX3JlZmVyZW5jZS52YWx1ZSkob2JzZXJ2ZXIudGFnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICBpZiAoc2hvdWxkU2NoZWR1bGUpIHsKICAgICAgICAgICAgKDAsIF9ydW5sb29wLnNjaGVkdWxlKSgnYWN0aW9ucycsIHNlbmRPYnNlcnZlcik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZW5kT2JzZXJ2ZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBmbHVzaFN5bmNPYnNlcnZlcnMoKSB7CiAgICAvLyBXaGVuIGZsdXNoaW5nIHN5bmNocm9ub3VzIG9ic2VydmVycywgd2Uga25vdyB0aGF0IHNvbWV0aGluZyBoYXMgY2hhbmdlZCAod2UKICAgIC8vIG9ubHkgZG8gdGhpcyBkdXJpbmcgYSBub3RpZnlQcm9wZXJ0eUNoYW5nZSksIHNvIHRoZXJlJ3Mgbm8gcmVhc29uIHRvIGNoZWNrCiAgICAvLyBhIGdsb2JhbCByZXZpc2lvbi4KICAgIFNZTkNfT0JTRVJWRVJTLmZvckVhY2goZnVuY3Rpb24gKGFjdGl2ZU9ic2VydmVycywgdGFyZ2V0KSB7CiAgICAgIHZhciBtZXRhJCQxID0gKDAsIF9tZXRhMi5wZWVrTWV0YSkodGFyZ2V0KTsKCiAgICAgIGlmIChtZXRhJCQxICYmIChtZXRhJCQxLmlzU291cmNlRGVzdHJveWluZygpIHx8IG1ldGEkJDEuaXNNZXRhRGVzdHJveWVkKCkpKSB7CiAgICAgICAgU1lOQ19PQlNFUlZFUlMuZGVsZXRlKHRhcmdldCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBhY3RpdmVPYnNlcnZlcnMuZm9yRWFjaChmdW5jdGlvbiAob2JzZXJ2ZXIsIGV2ZW50TmFtZSkgewogICAgICAgIGlmICghb2JzZXJ2ZXIuc3VzcGVuZGVkICYmICEoMCwgX3JlZmVyZW5jZS52YWxpZGF0ZSkob2JzZXJ2ZXIudGFnLCBvYnNlcnZlci5sYXN0UmV2aXNpb24pKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBvYnNlcnZlci5zdXNwZW5kZWQgPSB0cnVlOwogICAgICAgICAgICBzZW5kRXZlbnQodGFyZ2V0LCBldmVudE5hbWUsIFt0YXJnZXQsIG9ic2VydmVyLnBhdGhdKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIG9ic2VydmVyLnRhZyA9ICgwLCBfcmVmZXJlbmNlLmNvbWJpbmUpKGdldENoYWluVGFnc0ZvcktleSh0YXJnZXQsIG9ic2VydmVyLnBhdGgpKTsKICAgICAgICAgICAgb2JzZXJ2ZXIubGFzdFJldmlzaW9uID0gKDAsIF9yZWZlcmVuY2UudmFsdWUpKG9ic2VydmVyLnRhZyk7CiAgICAgICAgICAgIG9ic2VydmVyLnN1c3BlbmRlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHNldE9ic2VydmVyU3VzcGVuZGVkKHRhcmdldCwgcHJvcGVydHksIHN1c3BlbmRlZCkgewogICAgdmFyIGFjdGl2ZU9ic2VydmVycyA9IFNZTkNfT0JTRVJWRVJTLmdldCh0YXJnZXQpOwoKICAgIGlmICghYWN0aXZlT2JzZXJ2ZXJzKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgb2JzZXJ2ZXIgPSBhY3RpdmVPYnNlcnZlcnMuZ2V0KGNoYW5nZUV2ZW50KHByb3BlcnR5KSk7CgogICAgaWYgKG9ic2VydmVyKSB7CiAgICAgIG9ic2VydmVyLnN1c3BlbmRlZCA9IHN1c3BlbmRlZDsKICAgIH0KICB9CgogIHZhciBydW5JblRyYW5zYWN0aW9uOwogIF9leHBvcnRzLnJ1bkluVHJhbnNhY3Rpb24gPSBydW5JblRyYW5zYWN0aW9uOwogIHZhciBkaWRSZW5kZXI7CiAgX2V4cG9ydHMuZGlkUmVuZGVyID0gZGlkUmVuZGVyOwogIHZhciBhc3NlcnROb3RSZW5kZXJlZDsgLy8gZGV0ZWN0LWJhY2t0cmFja2luZy1yZXJlbmRlciBieSBkZWZhdWx0IGlzIGRlYnVnIGJ1aWxkIG9ubHkKCiAgX2V4cG9ydHMuYXNzZXJ0Tm90UmVuZGVyZWQgPSBhc3NlcnROb3RSZW5kZXJlZDsKCiAgaWYgKGZhbHNlCiAgLyogREVCVUcgKi8KICApIHsKICAgIC8vIHRoZXJlIGFyZSAyIHN0YXRlcwogICAgLy8gREVCVUcKICAgIC8vIHRyYWNrcyBsYXN0UmVmIGFuZCBsYXN0UmVuZGVyZWRJbiBwZXIgcmVuZGVyZWQgb2JqZWN0IGFuZCBrZXkgZHVyaW5nIGEgdHJhbnNhY3Rpb24KICAgIC8vIHJlbGVhc2UgZXZlcnl0aGluZyB2aWEgbm9ybWFsIHdlYWttYXAgc2VtYW50aWNzIGJ5IGp1c3QgZGVyZWZlbmNpbmcgdGhlIHdlYWttYXAKICAgIC8vIFJFTEVBU0UKICAgIC8vIHRyYWNrcyB0cmFuc2FjdGlvbklkIHBlciByZW5kZXJlZCBvYmplY3QgYW5kIGtleSBkdXJpbmcgYSB0cmFuc2FjdGlvbgogICAgLy8gcmVsZWFzZSBldmVyeXRoaW5nIHZpYSBub3JtYWwgd2Vha21hcCBzZW1hbnRpY3MgYnkganVzdCBkZXJlZmVuY2luZyB0aGUgd2Vha21hcAogICAgdmFyIFRyYW5zYWN0aW9uUnVubmVyID0KICAgIC8qI19fUFVSRV9fKi8KICAgIGZ1bmN0aW9uICgpIHsKICAgICAgZnVuY3Rpb24gVHJhbnNhY3Rpb25SdW5uZXIoKSB7CiAgICAgICAgdGhpcy50cmFuc2FjdGlvbklkID0gMDsKICAgICAgICB0aGlzLmluVHJhbnNhY3Rpb24gPSBmYWxzZTsKICAgICAgICB0aGlzLnNob3VsZFJlZmx1c2ggPSBmYWxzZTsKICAgICAgICB0aGlzLndlYWtNYXAgPSBuZXcgV2Vha01hcCgpOwoKICAgICAgICBpZiAoZmFsc2UKICAgICAgICAvKiBERUJVRyAqLwogICAgICAgICkgewogICAgICAgICAgLy8gdHJhY2sgdGVtcGxhdGVzCiAgICAgICAgICB0aGlzLmRlYnVnU3RhY2sgPSB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgX3Byb3RvNiA9IFRyYW5zYWN0aW9uUnVubmVyLnByb3RvdHlwZTsKCiAgICAgIF9wcm90bzYucnVuSW5UcmFuc2FjdGlvbiA9IGZ1bmN0aW9uIHJ1bkluVHJhbnNhY3Rpb24oY29udGV4dCQkMSwgbWV0aG9kTmFtZSkgewogICAgICAgIHRoaXMuYmVmb3JlKGNvbnRleHQkJDEpOwoKICAgICAgICB0cnkgewogICAgICAgICAgY29udGV4dCQkMVttZXRob2ROYW1lXSgpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICB0aGlzLmFmdGVyKCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5zaG91bGRSZWZsdXNoOwogICAgICB9OwoKICAgICAgX3Byb3RvNi5kaWRSZW5kZXIgPSBmdW5jdGlvbiBkaWRSZW5kZXIob2JqZWN0LCBrZXksIHJlZmVyZW5jZSkgewogICAgICAgIGlmICghdGhpcy5pblRyYW5zYWN0aW9uKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoZmFsc2UKICAgICAgICAvKiBERUJVRyAqLwogICAgICAgICkgewogICAgICAgICAgdGhpcy5zZXRLZXkob2JqZWN0LCBrZXksIHsKICAgICAgICAgICAgbGFzdFJlZjogcmVmZXJlbmNlLAogICAgICAgICAgICBsYXN0UmVuZGVyZWRJbjogdGhpcy5kZWJ1Z1N0YWNrLnBlZWsoKQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuc2V0S2V5KG9iamVjdCwga2V5LCB0aGlzLnRyYW5zYWN0aW9uSWQpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIF9wcm90bzYuYXNzZXJ0Tm90UmVuZGVyZWQgPSBmdW5jdGlvbiBhc3NlcnROb3RSZW5kZXJlZChvYmplY3QsIGtleSkgewogICAgICAgIGlmICghdGhpcy5pblRyYW5zYWN0aW9uKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5oYXNSZW5kZXJlZChvYmplY3QsIGtleSkpIHsKICAgICAgICAgIGlmIChmYWxzZQogICAgICAgICAgLyogREVCVUcgKi8KICAgICAgICAgICkgewogICAgICAgICAgICB2YXIgX3RoaXMkZ2V0S2V5ID0gdGhpcy5nZXRLZXkob2JqZWN0LCBrZXkpLAogICAgICAgICAgICAgICAgbGFzdFJlZiA9IF90aGlzJGdldEtleS5sYXN0UmVmLAogICAgICAgICAgICAgICAgbGFzdFJlbmRlcmVkSW4gPSBfdGhpcyRnZXRLZXkubGFzdFJlbmRlcmVkSW47CgogICAgICAgICAgICB2YXIgY3VycmVudGx5SW4gPSB0aGlzLmRlYnVnU3RhY2sucGVlaygpOwogICAgICAgICAgICB2YXIgbGFiZWwgPSAnJzsKCiAgICAgICAgICAgIGlmIChsYXN0UmVmICYmIHR5cGVvZiBsYXN0UmVmLmRlYnVnID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgbGFiZWwgPSAiYXMgYCIgKyBsYXN0UmVmLmRlYnVnKCkgKyAiYCBpbiAiICsgbGFzdFJlbmRlcmVkSW47CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbGFiZWwgPSAiaW4gIiArIGxhc3RSZW5kZXJlZEluOwogICAgICAgICAgICB9CgogICAgICAgICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJZb3UgbW9kaWZpZWQgYCIgKyBvYmplY3QgKyAiYCB0d2ljZSBpbiBhIHNpbmdsZSByZW5kZXIuIEl0IHdhcyBmaXJzdCByZW5kZXJlZCAiICsgbGFiZWwgKyAiIGFuZCB0aGVuIG1vZGlmaWVkIGxhdGVyIGluICIgKyBjdXJyZW50bHlJbiArICIuIFRoaXMgd2FzIHVucmVsaWFibGUgYW5kIHNsb3cgaW4gRW1iZXIgMS54IGFuZCBpcyBubyBsb25nZXIgc3VwcG9ydGVkLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2VtYmVyanMvZW1iZXIuanMvaXNzdWVzLzEzOTQ4IGZvciBtb3JlIGRldGFpbHMuIiwgZmFsc2UpKTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLnNob3VsZFJlZmx1c2ggPSB0cnVlOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIF9wcm90bzYuaGFzUmVuZGVyZWQgPSBmdW5jdGlvbiBoYXNSZW5kZXJlZChvYmplY3QsIGtleSkgewogICAgICAgIGlmICghdGhpcy5pblRyYW5zYWN0aW9uKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoZmFsc2UKICAgICAgICAvKiBERUJVRyAqLwogICAgICAgICkgewogICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0S2V5KG9iamVjdCwga2V5KSAhPT0gdW5kZWZpbmVkOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0S2V5KG9iamVjdCwga2V5KSA9PT0gdGhpcy50cmFuc2FjdGlvbklkOwogICAgICB9OwoKICAgICAgX3Byb3RvNi5iZWZvcmUgPSBmdW5jdGlvbiBiZWZvcmUoY29udGV4dCQkMSkgewogICAgICAgIHRoaXMuaW5UcmFuc2FjdGlvbiA9IHRydWU7CiAgICAgICAgdGhpcy5zaG91bGRSZWZsdXNoID0gZmFsc2U7CgogICAgICAgIGlmIChmYWxzZQogICAgICAgIC8qIERFQlVHICovCiAgICAgICAgKSB7CiAgICAgICAgICB0aGlzLmRlYnVnU3RhY2sgPSBjb250ZXh0JCQxLmVudi5kZWJ1Z1N0YWNrOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIF9wcm90bzYuYWZ0ZXIgPSBmdW5jdGlvbiBhZnRlcigpIHsKICAgICAgICB0aGlzLnRyYW5zYWN0aW9uSWQrKzsKICAgICAgICB0aGlzLmluVHJhbnNhY3Rpb24gPSBmYWxzZTsKCiAgICAgICAgaWYgKGZhbHNlCiAgICAgICAgLyogREVCVUcgKi8KICAgICAgICApIHsKICAgICAgICAgIHRoaXMuZGVidWdTdGFjayA9IHVuZGVmaW5lZDsKICAgICAgICB9CgogICAgICAgIHRoaXMuY2xlYXJPYmplY3RNYXAoKTsKICAgICAgfTsKCiAgICAgIF9wcm90bzYuY3JlYXRlTWFwID0gZnVuY3Rpb24gY3JlYXRlTWFwKG9iamVjdCkgewogICAgICAgIHZhciBtYXAgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgIHRoaXMud2Vha01hcC5zZXQob2JqZWN0LCBtYXApOwogICAgICAgIHJldHVybiBtYXA7CiAgICAgIH07CgogICAgICBfcHJvdG82LmdldE9yQ3JlYXRlTWFwID0gZnVuY3Rpb24gZ2V0T3JDcmVhdGVNYXAob2JqZWN0KSB7CiAgICAgICAgdmFyIG1hcCA9IHRoaXMud2Vha01hcC5nZXQob2JqZWN0KTsKCiAgICAgICAgaWYgKG1hcCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBtYXAgPSB0aGlzLmNyZWF0ZU1hcChvYmplY3QpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgfTsKCiAgICAgIF9wcm90bzYuc2V0S2V5ID0gZnVuY3Rpb24gc2V0S2V5KG9iamVjdCwga2V5LCB2YWx1ZSQkMSkgewogICAgICAgIHZhciBtYXAgPSB0aGlzLmdldE9yQ3JlYXRlTWFwKG9iamVjdCk7CiAgICAgICAgbWFwW2tleV0gPSB2YWx1ZSQkMTsKICAgICAgfTsKCiAgICAgIF9wcm90bzYuZ2V0S2V5ID0gZnVuY3Rpb24gZ2V0S2V5KG9iamVjdCwga2V5KSB7CiAgICAgICAgdmFyIG1hcCA9IHRoaXMud2Vha01hcC5nZXQob2JqZWN0KTsKCiAgICAgICAgaWYgKG1hcCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gbWFwW2tleV07CiAgICAgICAgfQogICAgICB9OwoKICAgICAgX3Byb3RvNi5jbGVhck9iamVjdE1hcCA9IGZ1bmN0aW9uIGNsZWFyT2JqZWN0TWFwKCkgewogICAgICAgIHRoaXMud2Vha01hcCA9IG5ldyBXZWFrTWFwKCk7CiAgICAgIH07CgogICAgICByZXR1cm4gVHJhbnNhY3Rpb25SdW5uZXI7CiAgICB9KCk7CgogICAgdmFyIHJ1bm5lciA9IG5ldyBUcmFuc2FjdGlvblJ1bm5lcigpOwoKICAgIF9leHBvcnRzLnJ1bkluVHJhbnNhY3Rpb24gPSBydW5JblRyYW5zYWN0aW9uID0gZnVuY3Rpb24gcnVuSW5UcmFuc2FjdGlvbigpIHsKICAgICAgcmV0dXJuIHJ1bm5lci5ydW5JblRyYW5zYWN0aW9uLmFwcGx5KHJ1bm5lciwgYXJndW1lbnRzKTsKICAgIH07CgogICAgX2V4cG9ydHMuZGlkUmVuZGVyID0gZGlkUmVuZGVyID0gZnVuY3Rpb24gZGlkUmVuZGVyKCkgewogICAgICByZXR1cm4gcnVubmVyLmRpZFJlbmRlci5hcHBseShydW5uZXIsIGFyZ3VtZW50cyk7CiAgICB9OwoKICAgIF9leHBvcnRzLmFzc2VydE5vdFJlbmRlcmVkID0gYXNzZXJ0Tm90UmVuZGVyZWQgPSBmdW5jdGlvbiBhc3NlcnROb3RSZW5kZXJlZCgpIHsKICAgICAgcmV0dXJuIHJ1bm5lci5hc3NlcnROb3RSZW5kZXJlZC5hcHBseShydW5uZXIsIGFyZ3VtZW50cyk7CiAgICB9OwogIH0gZWxzZSB7CiAgICAvLyBpbiBwcm9kdWN0aW9uIGRvIG5vdGhpbmcgdG8gZGV0ZWN0IHJlZmx1c2hlcwogICAgX2V4cG9ydHMucnVuSW5UcmFuc2FjdGlvbiA9IHJ1bkluVHJhbnNhY3Rpb24gPSBmdW5jdGlvbiBydW5JblRyYW5zYWN0aW9uKGNvbnRleHQkJDEsIG1ldGhvZE5hbWUpIHsKICAgICAgY29udGV4dCQkMVttZXRob2ROYW1lXSgpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwogIH0KICAvKioKICAgQG1vZHVsZSBlbWJlcgogICBAcHJpdmF0ZQogICAqLwoKCiAgdmFyIFBST1BFUlRZX0RJRF9DSEFOR0UgPSAoMCwgX3V0aWxzLnN5bWJvbCkoJ1BST1BFUlRZX0RJRF9DSEFOR0UnKTsKICBfZXhwb3J0cy5QUk9QRVJUWV9ESURfQ0hBTkdFID0gUFJPUEVSVFlfRElEX0NIQU5HRTsKICB2YXIgZGVmZXJyZWQgPSAwOwogIC8qKgogICAgVGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQganVzdCBhZnRlciBhbiBvYmplY3QgcHJvcGVydHkgaGFzIGNoYW5nZWQuCiAgICBJdCB3aWxsIG5vdGlmeSBhbnkgb2JzZXJ2ZXJzIGFuZCBjbGVhciBjYWNoZXMgYW1vbmcgb3RoZXIgdGhpbmdzLgogIAogICAgTm9ybWFsbHkgeW91IHdpbGwgbm90IG5lZWQgdG8gY2FsbCB0aGlzIG1ldGhvZCBkaXJlY3RseSBidXQgaWYgZm9yIHNvbWUKICAgIHJlYXNvbiB5b3UgY2FuJ3QgZGlyZWN0bHkgd2F0Y2ggYSBwcm9wZXJ0eSB5b3UgY2FuIGludm9rZSB0aGlzIG1ldGhvZAogICAgbWFudWFsbHkuCiAgCiAgICBAbWV0aG9kIG5vdGlmeVByb3BlcnR5Q2hhbmdlCiAgICBAZm9yIEBlbWJlci9vYmplY3QKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIG9iamVjdCB3aXRoIHRoZSBwcm9wZXJ0eSB0aGF0IHdpbGwgY2hhbmdlCiAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgcHJvcGVydHkga2V5IChvciBwYXRoKSB0aGF0IHdpbGwgY2hhbmdlLgogICAgQHBhcmFtIHtNZXRhfSBtZXRhIFRoZSBvYmplY3RzIG1ldGEuCiAgICBAcmV0dXJuIHt2b2lkfQogICAgQHNpbmNlIDMuMS4wCiAgICBAcHVibGljCiAgKi8KCiAgZnVuY3Rpb24gbm90aWZ5UHJvcGVydHlDaGFuZ2Uob2JqLCBrZXlOYW1lLCBfbWV0YSkgewogICAgdmFyIG1ldGEkJDEgPSBfbWV0YSA9PT0gdW5kZWZpbmVkID8gKDAsIF9tZXRhMi5wZWVrTWV0YSkob2JqKSA6IF9tZXRhOwoKICAgIGlmIChtZXRhJCQxICE9PSBudWxsICYmIChtZXRhJCQxLmlzSW5pdGlhbGl6aW5nKCkgfHwgbWV0YSQkMS5pc1Byb3RvdHlwZU1ldGEob2JqKSkpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChtZXRhJCQxICE9PSBudWxsKSB7CiAgICAgIG1hcmtPYmplY3RBc0RpcnR5KG9iaiwga2V5TmFtZSwgbWV0YSQkMSk7CiAgICB9CgogICAgaWYgKHRydWUKICAgIC8qIEVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyAqLwogICAgJiYgZGVmZXJyZWQgPD0gMCkgewogICAgICBmbHVzaFN5bmNPYnNlcnZlcnMoKTsKICAgIH0KCiAgICBpZiAoUFJPUEVSVFlfRElEX0NIQU5HRSBpbiBvYmopIHsKICAgICAgb2JqW1BST1BFUlRZX0RJRF9DSEFOR0VdKGtleU5hbWUpOwogICAgfQoKICAgIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICkgewogICAgICBhc3NlcnROb3RSZW5kZXJlZChvYmosIGtleU5hbWUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gb3ZlcnJpZGVDaGFpbnMoX29iaiwga2V5TmFtZSwgbWV0YSQkMSkgewogICAgdmFyIGNoYWluV2F0Y2hlcnMgPSBtZXRhJCQxLnJlYWRhYmxlQ2hhaW5XYXRjaGVycygpOwoKICAgIGlmIChjaGFpbldhdGNoZXJzICE9PSB1bmRlZmluZWQpIHsKICAgICAgY2hhaW5XYXRjaGVycy5yZXZhbGlkYXRlKGtleU5hbWUpOwogICAgfQogIH0KICAvKioKICAgIEBtZXRob2QgYmVnaW5Qcm9wZXJ0eUNoYW5nZXMKICAgIEBjaGFpbmFibGUKICAgIEBwcml2YXRlCiAgKi8KCgogIGZ1bmN0aW9uIGJlZ2luUHJvcGVydHlDaGFuZ2VzKCkgewogICAgZGVmZXJyZWQrKzsKICB9CiAgLyoqCiAgICBAbWV0aG9kIGVuZFByb3BlcnR5Q2hhbmdlcwogICAgQHByaXZhdGUKICAqLwoKCiAgZnVuY3Rpb24gZW5kUHJvcGVydHlDaGFuZ2VzKCkgewogICAgZGVmZXJyZWQtLTsKCiAgICBpZiAoZGVmZXJyZWQgPD0gMCkgewogICAgICB7CiAgICAgICAgZmx1c2hTeW5jT2JzZXJ2ZXJzKCk7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICBNYWtlIGEgc2VyaWVzIG9mIHByb3BlcnR5IGNoYW5nZXMgdG9nZXRoZXIgaW4gYW4KICAgIGV4Y2VwdGlvbi1zYWZlIHdheS4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIEVtYmVyLmNoYW5nZVByb3BlcnRpZXMoZnVuY3Rpb24oKSB7CiAgICAgIG9iajEuc2V0KCdmb28nLCBtYXlCbG93VXBXaGVuU2V0KTsKICAgICAgb2JqMi5zZXQoJ2JhcicsIGJheik7CiAgICB9KTsKICAgIGBgYAogIAogICAgQG1ldGhvZCBjaGFuZ2VQcm9wZXJ0aWVzCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjawogICAgQHByaXZhdGUKICAqLwoKCiAgZnVuY3Rpb24gY2hhbmdlUHJvcGVydGllcyhjYWxsYmFjaykgewogICAgYmVnaW5Qcm9wZXJ0eUNoYW5nZXMoKTsKCiAgICB0cnkgewogICAgICBjYWxsYmFjaygpOwogICAgfSBmaW5hbGx5IHsKICAgICAgZW5kUHJvcGVydHlDaGFuZ2VzKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhcnJheUNvbnRlbnRXaWxsQ2hhbmdlKGFycmF5LCBzdGFydElkeCwgcmVtb3ZlQW10LCBhZGRBbXQpIHsKICAgIC8vIGlmIG5vIGFyZ3MgYXJlIHBhc3NlZCBhc3N1bWUgZXZlcnl0aGluZyBjaGFuZ2VzCiAgICBpZiAoc3RhcnRJZHggPT09IHVuZGVmaW5lZCkgewogICAgICBzdGFydElkeCA9IDA7CiAgICAgIHJlbW92ZUFtdCA9IGFkZEFtdCA9IC0xOwogICAgfSBlbHNlIHsKICAgICAgaWYgKHJlbW92ZUFtdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmVtb3ZlQW10ID0gLTE7CiAgICAgIH0KCiAgICAgIGlmIChhZGRBbXQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGFkZEFtdCA9IC0xOwogICAgICB9CiAgICB9CgogICAgc2VuZEV2ZW50KGFycmF5LCAnQGFycmF5OmJlZm9yZScsIFthcnJheSwgc3RhcnRJZHgsIHJlbW92ZUFtdCwgYWRkQW10XSk7CiAgICByZXR1cm4gYXJyYXk7CiAgfQoKICBmdW5jdGlvbiBhcnJheUNvbnRlbnREaWRDaGFuZ2UoYXJyYXksIHN0YXJ0SWR4LCByZW1vdmVBbXQsIGFkZEFtdCkgewogICAgLy8gaWYgbm8gYXJncyBhcmUgcGFzc2VkIGFzc3VtZSBldmVyeXRoaW5nIGNoYW5nZXMKICAgIGlmIChzdGFydElkeCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHN0YXJ0SWR4ID0gMDsKICAgICAgcmVtb3ZlQW10ID0gYWRkQW10ID0gLTE7CiAgICB9IGVsc2UgewogICAgICBpZiAocmVtb3ZlQW10ID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZW1vdmVBbXQgPSAtMTsKICAgICAgfQoKICAgICAgaWYgKGFkZEFtdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgYWRkQW10ID0gLTE7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgbWV0YSQkMSA9ICgwLCBfbWV0YTIucGVla01ldGEpKGFycmF5KTsKCiAgICBpZiAoYWRkQW10IDwgMCB8fCByZW1vdmVBbXQgPCAwIHx8IGFkZEFtdCAtIHJlbW92ZUFtdCAhPT0gMCkgewogICAgICBub3RpZnlQcm9wZXJ0eUNoYW5nZShhcnJheSwgJ2xlbmd0aCcsIG1ldGEkJDEpOwogICAgfQoKICAgIG5vdGlmeVByb3BlcnR5Q2hhbmdlKGFycmF5LCAnW10nLCBtZXRhJCQxKTsKICAgIHNlbmRFdmVudChhcnJheSwgJ0BhcnJheTpjaGFuZ2UnLCBbYXJyYXksIHN0YXJ0SWR4LCByZW1vdmVBbXQsIGFkZEFtdF0pOwogICAgdmFyIGNhY2hlID0gcGVla0NhY2hlRm9yKGFycmF5KTsKCiAgICBpZiAoY2FjaGUgIT09IHVuZGVmaW5lZCkgewogICAgICB2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgICB2YXIgYWRkZWRBbW91bnQgPSBhZGRBbXQgPT09IC0xID8gMCA6IGFkZEFtdDsKICAgICAgdmFyIHJlbW92ZWRBbW91bnQgPSByZW1vdmVBbXQgPT09IC0xID8gMCA6IHJlbW92ZUFtdDsKICAgICAgdmFyIGRlbHRhID0gYWRkZWRBbW91bnQgLSByZW1vdmVkQW1vdW50OwogICAgICB2YXIgcHJldmlvdXNMZW5ndGggPSBsZW5ndGggLSBkZWx0YTsKICAgICAgdmFyIG5vcm1hbFN0YXJ0SWR4ID0gc3RhcnRJZHggPCAwID8gcHJldmlvdXNMZW5ndGggKyBzdGFydElkeCA6IHN0YXJ0SWR4OwoKICAgICAgaWYgKGNhY2hlLmhhcygnZmlyc3RPYmplY3QnKSAmJiBub3JtYWxTdGFydElkeCA9PT0gMCkgewogICAgICAgIG5vdGlmeVByb3BlcnR5Q2hhbmdlKGFycmF5LCAnZmlyc3RPYmplY3QnLCBtZXRhJCQxKTsKICAgICAgfQoKICAgICAgaWYgKGNhY2hlLmhhcygnbGFzdE9iamVjdCcpKSB7CiAgICAgICAgdmFyIHByZXZpb3VzTGFzdEluZGV4ID0gcHJldmlvdXNMZW5ndGggLSAxOwogICAgICAgIHZhciBsYXN0QWZmZWN0ZWRJbmRleCA9IG5vcm1hbFN0YXJ0SWR4ICsgcmVtb3ZlZEFtb3VudDsKCiAgICAgICAgaWYgKHByZXZpb3VzTGFzdEluZGV4IDwgbGFzdEFmZmVjdGVkSW5kZXgpIHsKICAgICAgICAgIG5vdGlmeVByb3BlcnR5Q2hhbmdlKGFycmF5LCAnbGFzdE9iamVjdCcsIG1ldGEkJDEpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiBhcnJheTsKICB9CgogIHZhciBFTVBUWV9BUlJBWSA9IE9iamVjdC5mcmVlemUoW10pOwoKICBmdW5jdGlvbiBvYmplY3RBdChhcnJheSwgaW5kZXgpIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGFycmF5KSkgewogICAgICByZXR1cm4gYXJyYXlbaW5kZXhdOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGFycmF5Lm9iamVjdEF0KGluZGV4KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlcGxhY2UoYXJyYXksIHN0YXJ0LCBkZWxldGVDb3VudCwgaXRlbXMpIHsKICAgIGlmIChpdGVtcyA9PT0gdm9pZCAwKSB7CiAgICAgIGl0ZW1zID0gRU1QVFlfQVJSQVk7CiAgICB9CgogICAgaWYgKEFycmF5LmlzQXJyYXkoYXJyYXkpKSB7CiAgICAgIHJlcGxhY2VJbk5hdGl2ZUFycmF5KGFycmF5LCBzdGFydCwgZGVsZXRlQ291bnQsIGl0ZW1zKTsKICAgIH0gZWxzZSB7CiAgICAgIGFycmF5LnJlcGxhY2Uoc3RhcnQsIGRlbGV0ZUNvdW50LCBpdGVtcyk7CiAgICB9CiAgfQoKICB2YXIgQ0hVTktfU0laRSA9IDYwMDAwOyAvLyBUbyBhdm9pZCBvdmVyZmxvd2luZyB0aGUgc3RhY2ssIHdlIHNwbGljZSB1cCB0byBDSFVOS19TSVpFIGl0ZW1zIGF0IGEgdGltZS4KICAvLyBTZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTU2NTg4IGZvciBtb3JlIGRldGFpbHMuCgogIGZ1bmN0aW9uIHJlcGxhY2VJbk5hdGl2ZUFycmF5KGFycmF5LCBzdGFydCwgZGVsZXRlQ291bnQsIGl0ZW1zKSB7CiAgICBhcnJheUNvbnRlbnRXaWxsQ2hhbmdlKGFycmF5LCBzdGFydCwgZGVsZXRlQ291bnQsIGl0ZW1zLmxlbmd0aCk7CgogICAgaWYgKGl0ZW1zLmxlbmd0aCA8PSBDSFVOS19TSVpFKSB7CiAgICAgIGFycmF5LnNwbGljZS5hcHBseShhcnJheSwgW3N0YXJ0LCBkZWxldGVDb3VudF0uY29uY2F0KGl0ZW1zKSk7CiAgICB9IGVsc2UgewogICAgICBhcnJheS5zcGxpY2Uoc3RhcnQsIGRlbGV0ZUNvdW50KTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpICs9IENIVU5LX1NJWkUpIHsKICAgICAgICB2YXIgY2h1bmsgPSBpdGVtcy5zbGljZShpLCBpICsgQ0hVTktfU0laRSk7CiAgICAgICAgYXJyYXkuc3BsaWNlLmFwcGx5KGFycmF5LCBbc3RhcnQgKyBpLCAwXS5jb25jYXQoY2h1bmspKTsKICAgICAgfQogICAgfQoKICAgIGFycmF5Q29udGVudERpZENoYW5nZShhcnJheSwgc3RhcnQsIGRlbGV0ZUNvdW50LCBpdGVtcy5sZW5ndGgpOwogIH0KCiAgZnVuY3Rpb24gYXJyYXlPYnNlcnZlcnNIZWxwZXIob2JqLCB0YXJnZXQsIG9wdHMsIG9wZXJhdGlvbiwgbm90aWZ5KSB7CiAgICB2YXIgd2lsbENoYW5nZSA9IG9wdHMgJiYgb3B0cy53aWxsQ2hhbmdlIHx8ICdhcnJheVdpbGxDaGFuZ2UnOwogICAgdmFyIGRpZENoYW5nZSA9IG9wdHMgJiYgb3B0cy5kaWRDaGFuZ2UgfHwgJ2FycmF5RGlkQ2hhbmdlJzsKCiAgICB2YXIgaGFzT2JzZXJ2ZXJzID0gX2dldDIob2JqLCAnaGFzQXJyYXlPYnNlcnZlcnMnKTsKCiAgICBvcGVyYXRpb24ob2JqLCAnQGFycmF5OmJlZm9yZScsIHRhcmdldCwgd2lsbENoYW5nZSk7CiAgICBvcGVyYXRpb24ob2JqLCAnQGFycmF5OmNoYW5nZScsIHRhcmdldCwgZGlkQ2hhbmdlKTsKCiAgICBpZiAoaGFzT2JzZXJ2ZXJzID09PSBub3RpZnkpIHsKICAgICAgbm90aWZ5UHJvcGVydHlDaGFuZ2Uob2JqLCAnaGFzQXJyYXlPYnNlcnZlcnMnKTsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH0KCiAgZnVuY3Rpb24gYWRkQXJyYXlPYnNlcnZlcihhcnJheSwgdGFyZ2V0LCBvcHRzKSB7CiAgICByZXR1cm4gYXJyYXlPYnNlcnZlcnNIZWxwZXIoYXJyYXksIHRhcmdldCwgb3B0cywgYWRkTGlzdGVuZXIsIGZhbHNlKTsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZUFycmF5T2JzZXJ2ZXIoYXJyYXksIHRhcmdldCwgb3B0cykgewogICAgcmV0dXJuIGFycmF5T2JzZXJ2ZXJzSGVscGVyKGFycmF5LCB0YXJnZXQsIG9wdHMsIHJlbW92ZUxpc3RlbmVyLCB0cnVlKTsKICB9CgogIHZhciBBUkdTX1BST1hZX1RBR1MgPSBuZXcgV2Vha01hcCgpOwogIF9leHBvcnRzLkFSR1NfUFJPWFlfVEFHUyA9IEFSR1NfUFJPWFlfVEFHUzsKCiAgZnVuY3Rpb24gZmluaXNoTGF6eUNoYWlucyhvYmosIGtleSwgdmFsdWUkJDEpIHsKICAgIHZhciBtZXRhJCQxID0gKDAsIF9tZXRhMi5wZWVrTWV0YSkob2JqKTsKICAgIHZhciBsYXp5VGFncyA9IG1ldGEkJDEgIT09IG51bGwgPyBtZXRhJCQxLnJlYWRhYmxlTGF6eUNoYWluc0ZvcihrZXkpIDogdW5kZWZpbmVkOwoKICAgIGlmIChsYXp5VGFncyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAodmFsdWUkJDEgPT09IG51bGwgfHwgdHlwZW9mIHZhbHVlJCQxICE9PSAnb2JqZWN0JyAmJiB0eXBlb2YgdmFsdWUkJDEgIT09ICdmdW5jdGlvbicpIHsKICAgICAgZm9yICh2YXIgcGF0aCBpbiBsYXp5VGFncykgewogICAgICAgIGRlbGV0ZSBsYXp5VGFnc1twYXRoXTsKICAgICAgfQoKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGZvciAodmFyIF9wYXRoIGluIGxhenlUYWdzKSB7CiAgICAgIHZhciB0YWcgPSBsYXp5VGFnc1tfcGF0aF07CiAgICAgICgwLCBfcmVmZXJlbmNlLnVwZGF0ZSkodGFnLCAoMCwgX3JlZmVyZW5jZS5jb21iaW5lKShnZXRDaGFpblRhZ3NGb3JLZXkodmFsdWUkJDEsIF9wYXRoKSkpOwogICAgICBkZWxldGUgbGF6eVRhZ3NbX3BhdGhdOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2V0Q2hhaW5UYWdzRm9yS2V5cyhvYmosIGtleXMpIHsKICAgIHZhciBjaGFpblRhZ3MgPSBbXTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY2hhaW5UYWdzLnB1c2guYXBwbHkoY2hhaW5UYWdzLCBnZXRDaGFpblRhZ3NGb3JLZXkob2JqLCBrZXlzW2ldKSk7CiAgICB9CgogICAgcmV0dXJuIGNoYWluVGFnczsKICB9CgogIGZ1bmN0aW9uIGdldENoYWluVGFnc0ZvcktleShvYmosIHBhdGgpIHsKICAgIHZhciBjaGFpblRhZ3MgPSBbXTsKICAgIHZhciBjdXJyZW50ID0gb2JqOwogICAgdmFyIHBhdGhMZW5ndGggPSBwYXRoLmxlbmd0aDsKICAgIHZhciBzZWdtZW50RW5kID0gLTE7IC8vIHByZXZlbnQgY2xvc3VyZXMKCiAgICB2YXIgc2VnbWVudCwgZGVzY3JpcHRvcjsgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnN0YW50LWNvbmRpdGlvbgoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIHZhciBjdXJyZW50VHlwZSA9IHR5cGVvZiBjdXJyZW50OwoKICAgICAgaWYgKGN1cnJlbnQgPT09IG51bGwgfHwgY3VycmVudFR5cGUgIT09ICdvYmplY3QnICYmIGN1cnJlbnRUeXBlICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgLy8gd2UndmUgaGl0IHRoZSBlbmQgb2YgdGhlIGNoYWluIGZvciBub3csIGJyZWFrIG91dAogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICB2YXIgbGFzdFNlZ21lbnRFbmQgPSBzZWdtZW50RW5kICsgMTsKICAgICAgc2VnbWVudEVuZCA9IHBhdGguaW5kZXhPZignLicsIGxhc3RTZWdtZW50RW5kKTsKCiAgICAgIGlmIChzZWdtZW50RW5kID09PSAtMSkgewogICAgICAgIHNlZ21lbnRFbmQgPSBwYXRoTGVuZ3RoOwogICAgICB9CgogICAgICBzZWdtZW50ID0gcGF0aC5zbGljZShsYXN0U2VnbWVudEVuZCwgc2VnbWVudEVuZCk7IC8vIElmIHRoZSBzZWdtZW50IGlzIGFuIEBlYWNoLCB3ZSBjYW4gcHJvY2VzcyBpdCBhbmQgdGhlbiBicmVhawoKICAgICAgaWYgKHNlZ21lbnQgPT09ICdAZWFjaCcgJiYgc2VnbWVudEVuZCAhPT0gcGF0aExlbmd0aCkgewogICAgICAgIGxhc3RTZWdtZW50RW5kID0gc2VnbWVudEVuZCArIDE7CiAgICAgICAgc2VnbWVudEVuZCA9IHBhdGguaW5kZXhPZignLicsIGxhc3RTZWdtZW50RW5kKTsgLy8gVGhlcmUgc2hvdWxkIGJlIGV4YWN0bHkgb25lIHNlZ21lbnQgYWZ0ZXIgYW4gYEBlYWNoYCAoaS5lLiBgQGVhY2guZm9vYCwgbm90IGBAZWFjaC5mb28uYmFyYCkKCiAgICAgICAgKGZhbHNlICYmICEoc2VnbWVudEVuZCA9PT0gLTEpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgiV2hlbiB1c2luZyBAZWFjaCBpbiBhIGRlcGVuZGVudC1rZXkgb3IgYW4gb2JzZXJ2ZXIsICIgKyAieW91IGNhbiBvbmx5IGNoYWluIG9uZSBwcm9wZXJ0eSBsZXZlbCBkZWVwIGFmdGVyICIgKyAoInRoZSBAZWFjaC4gVGhhdCBpcywgYCIgKyBwYXRoLnNsaWNlKDAsIHNlZ21lbnRFbmQpICsgImAgIikgKyAoImlzIGFsbG93ZWQgYnV0IGAiICsgcGF0aCArICJgICh3aGljaCBpcyB3aGF0IHlvdSBwYXNzZWQpICIpICsgImlzIG5vdC5cblxuIiArICJUaGlzIHdhcyBuZXZlciBzdXBwb3J0ZWQuIEN1cnJlbnRseSwgdGhlIGV4dHJhIHNlZ21lbnRzICIgKyAoImFyZSBzaWxlbnRseSBpZ25vcmVkLCBpLmUuIGAiICsgcGF0aCArICJgIGJlaGF2ZXMgZXhhY3RseSAiKSArICgidGhlIHNhbWUgYXMgYCIgKyBwYXRoLnNsaWNlKDAsIHNlZ21lbnRFbmQpICsgImAuICIpICsgIkluIHRoZSBmdXR1cmUsIHRoaXMgd2lsbCB0aHJvdyBhbiBlcnJvci5cblxuIiArICJJZiB0aGUgY3VycmVudCBiZWhhdmlvciBpcyBhY2NlcHRhYmxlIGZvciB5b3VyIHVzZSBjYXNlLCAiICsgInBsZWFzZSByZW1vdmUgdGhlIGV4dHJhbmVvdXMgc2VnbWVudHMgYnkgY2hhbmdpbmcgeW91ciAiICsgKCJrZXkgdG8gYCIgKyBwYXRoLnNsaWNlKDAsIHNlZ21lbnRFbmQpICsgImAuICIpICsgIk90aGVyd2lzZSwgcGxlYXNlIGNyZWF0ZSBhbiBpbnRlcm1lZGlhcnkgY29tcHV0ZWQgcHJvcGVydHkgIiArICJvciBzd2l0Y2ggdG8gdXNpbmcgdHJhY2tlZCBwcm9wZXJ0aWVzLiIsIHNlZ21lbnRFbmQgPT09IC0xLCB7CiAgICAgICAgICB1bnRpbDogJzMuMTcuMCcsCiAgICAgICAgICBpZDogJ2VtYmVyLW1ldGFsLmNvbXB1dGVkLWRlZXAtZWFjaCcKICAgICAgICB9KSk7CiAgICAgICAgdmFyIGFyckxlbmd0aCA9IGN1cnJlbnQubGVuZ3RoOwoKICAgICAgICBpZiAodHlwZW9mIGFyckxlbmd0aCAhPT0gJ251bWJlcicgfHwgLy8gVE9ETzogc2hvdWxkIHRoZSBzZWNvbmQgdGVzdCBiZSBgaXNFbWJlckFycmF5YCBpbnN0ZWFkPwogICAgICAgICEoQXJyYXkuaXNBcnJheShjdXJyZW50KSB8fCAnb2JqZWN0QXQnIGluIGN1cnJlbnQpKSB7CiAgICAgICAgICAvLyBJZiB0aGUgY3VycmVudCBvYmplY3QgaXNuJ3QgYW4gYXJyYXksIHRoZXJlJ3Mgbm90aGluZyBlbHNlIHRvIGRvLAogICAgICAgICAgLy8gd2UgZG9uJ3Qgd2F0Y2ggaW5kaXZpZHVhbCBwcm9wZXJ0aWVzLiBCcmVhayBvdXQgb2YgdGhlIGxvb3AuCiAgICAgICAgICBicmVhazsKICAgICAgICB9IGVsc2UgaWYgKGFyckxlbmd0aCA9PT0gMCkgewogICAgICAgICAgLy8gRmFzdCBwYXRoIGZvciBlbXB0eSBhcnJheXMKICAgICAgICAgIGNoYWluVGFncy5wdXNoKHRhZ0ZvclByb3BlcnR5KGN1cnJlbnQsICdbXScpKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgaWYgKHNlZ21lbnRFbmQgPT09IC0xKSB7CiAgICAgICAgICBzZWdtZW50ID0gcGF0aC5zbGljZShsYXN0U2VnbWVudEVuZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIERlcHJlY2F0ZWQsIHJlbW92ZSBvbmNlIHdlIHR1cm4gdGhlIGRlcHJlY2F0aW9uIGludG8gYW4gYXNzZXJ0aW9uCiAgICAgICAgICBzZWdtZW50ID0gcGF0aC5zbGljZShsYXN0U2VnbWVudEVuZCwgc2VnbWVudEVuZCk7CiAgICAgICAgfSAvLyBQdXNoIHRoZSB0YWdzIGZvciBlYWNoIGl0ZW0ncyBwcm9wZXJ0eQoKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJMZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGl0ZW0gPSBvYmplY3RBdChjdXJyZW50LCBpKTsKCiAgICAgICAgICBpZiAoaXRlbSkgewogICAgICAgICAgICAoZmFsc2UgJiYgISh0eXBlb2YgaXRlbSA9PT0gJ29iamVjdCcpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiV2hlbiB1c2luZyBAZWFjaCB0byBvYnNlcnZlIHRoZSBhcnJheSBgIiArIGN1cnJlbnQudG9TdHJpbmcoKSArICJgLCB0aGUgaXRlbXMgaW4gdGhlIGFycmF5IG11c3QgYmUgb2JqZWN0cyIsIHR5cGVvZiBpdGVtID09PSAnb2JqZWN0JykpOwogICAgICAgICAgICBjaGFpblRhZ3MucHVzaCh0YWdGb3JQcm9wZXJ0eShpdGVtLCBzZWdtZW50KSk7CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBQdXNoIHRoZSB0YWcgZm9yIHRoZSBhcnJheSBsZW5ndGggaXRzZWxmCgoKICAgICAgICBjaGFpblRhZ3MucHVzaCh0YWdGb3JQcm9wZXJ0eShjdXJyZW50LCAnW10nKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0gLy8gSWYgdGhlIHNlZ21lbnQgaXMgbGlua2luZyB0byBhbiBhcmdzIHByb3h5LCB3ZSBuZWVkIHRvIG1hbnVhbGx5IGFjY2VzcwogICAgICAvLyB0aGUgdGFncyBmb3IgdGhlIGFyZ3MsIHNpbmNlIHRoZXkgYXJlIGRpcmVjdCByZWZlcmVuY2VzIGFuZCBkb24ndCBoYXZlIGEKICAgICAgLy8gdGFnRm9yUHJvcGVydHkuIFdlIHRoZW4gY29udGludWUgY2hhaW5pbmcgbGlrZSBub3JtYWwgYWZ0ZXIgaXQsIHNpbmNlCiAgICAgIC8vIHlvdSBjb3VsZCBjaGFpbiBvZmYgYW4gYXJnIGlmIGl0IHdlcmUgYW4gb2JqZWN0LCBmb3IgaW5zdGFuY2UuCgoKICAgICAgaWYgKHNlZ21lbnQgPT09ICdhcmdzJyAmJiBBUkdTX1BST1hZX1RBR1MuaGFzKGN1cnJlbnQuYXJncykpIHsKICAgICAgICAoZmFsc2UgJiYgIShzZWdtZW50RW5kICE9PSBwYXRoTGVuZ3RoKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIldoZW4gd2F0Y2hpbmcgdGhlICdhcmdzJyBvbiBhIEdsaW1tZXJDb21wb25lbnQsIHlvdSBtdXN0IHdhdGNoIGEgdmFsdWUgb24gdGhlIGFyZ3MuIFlvdSBjYW5ub3Qgd2F0Y2ggdGhlIG9iamVjdCBpdHNlbGYsIGFzIGl0IG5ldmVyIGNoYW5nZXMuIiwgc2VnbWVudEVuZCAhPT0gcGF0aExlbmd0aCkpOwogICAgICAgIGxhc3RTZWdtZW50RW5kID0gc2VnbWVudEVuZCArIDE7CiAgICAgICAgc2VnbWVudEVuZCA9IHBhdGguaW5kZXhPZignLicsIGxhc3RTZWdtZW50RW5kKTsKCiAgICAgICAgaWYgKHNlZ21lbnRFbmQgPT09IC0xKSB7CiAgICAgICAgICBzZWdtZW50RW5kID0gcGF0aExlbmd0aDsKICAgICAgICB9CgogICAgICAgIHNlZ21lbnQgPSBwYXRoLnNsaWNlKGxhc3RTZWdtZW50RW5kLCBzZWdtZW50RW5kKTsKICAgICAgICB2YXIgbmFtZWRBcmdzID0gQVJHU19QUk9YWV9UQUdTLmdldChjdXJyZW50LmFyZ3MpOwogICAgICAgIHZhciByZWYgPSBuYW1lZEFyZ3MuZ2V0KHNlZ21lbnQpOwogICAgICAgIGNoYWluVGFncy5wdXNoKHJlZi50YWcpOyAvLyBXZSBzdGlsbCBuZWVkIHRvIGJyZWFrIGlmIHdlJ3JlIGF0IHRoZSBlbmQgb2YgdGhlIHBhdGguCgogICAgICAgIGlmIChzZWdtZW50RW5kID09PSBwYXRoTGVuZ3RoKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9IC8vIE90aGVyd2lzZSwgc2V0IHRoZSBjdXJyZW50IHZhbHVlIGFuZCB0aGVuIGNvbnRpbnVlIHRvIHRoZSBuZXh0IHNlZ21lbnQKCgogICAgICAgIGN1cnJlbnQgPSByZWYudmFsdWUoKTsKICAgICAgICBjb250aW51ZTsKICAgICAgfSAvLyBUT0RPOiBBc3NlcnQgdGhhdCBjdXJyZW50W3NlZ21lbnRdIGlzbid0IGFuIHVuZGVjb3JhdGVkLCBub24tTUFOREFUT1JZX1NFVFRFUi9kZXBlbmRlbnRLZXlDb21wYXQgZ2V0dGVyCgoKICAgICAgdmFyIHByb3BlcnR5VGFnID0gdGFnRm9yUHJvcGVydHkoY3VycmVudCwgc2VnbWVudCk7CiAgICAgIGRlc2NyaXB0b3IgPSBkZXNjcmlwdG9yRm9yUHJvcGVydHkoY3VycmVudCwgc2VnbWVudCk7CiAgICAgIGNoYWluVGFncy5wdXNoKHByb3BlcnR5VGFnKTsgLy8gSWYgdGhlIGtleSB3YXMgYW4gYWxpYXMsIHdlIHNob3VsZCBhbHdheXMgZ2V0IHRoZSBuZXh0IHZhbHVlIGluIG9yZGVyIHRvCiAgICAgIC8vIGJvb3RzdHJhcCB0aGUgYWxpYXMuIFRoaXMgaXMgYmVjYXVzZSBhbGlhc2VzLCB1bmxpa2Ugb3RoZXIgQ1BzLCBzaG91bGQKICAgICAgLy8gYWx3YXlzIGJlIGluIHN5bmMgd2l0aCB0aGUgYWxpYXNlZCB2YWx1ZS4KCiAgICAgIGlmIChkZXNjcmlwdG9yICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIGRlc2NyaXB0b3IuYWx0S2V5ID09PSAnc3RyaW5nJykgewogICAgICAgIGN1cnJlbnQgPSBjdXJyZW50W3NlZ21lbnRdOyAvLyBXZSBzdGlsbCBuZWVkIHRvIGJyZWFrIGlmIHdlJ3JlIGF0IHRoZSBlbmQgb2YgdGhlIHBhdGguCgogICAgICAgIGlmIChzZWdtZW50RW5kID09PSBwYXRoTGVuZ3RoKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9IC8vIE90aGVyd2lzZSwgY29udGludWUgdG8gcHJvY2VzcyB0aGUgbmV4dCBzZWdtZW50CgoKICAgICAgICBjb250aW51ZTsKICAgICAgfSAvLyBJZiB3ZSdyZSBhdCB0aGUgZW5kIG9mIHRoZSBwYXRoLCBwcm9jZXNzaW5nIHRoZSBsYXN0IHNlZ21lbnQsIGFuZCBpdCdzCiAgICAgIC8vIG5vdCBhbiBhbGlhcywgd2Ugc2hvdWxkIF9ub3RfIGdldCB0aGUgbGFzdCB2YWx1ZSwgc2luY2Ugd2UgYWxyZWFkeSBoYXZlCiAgICAgIC8vIGl0cyB0YWcuIFRoZXJlJ3Mgbm8gcmVhc29uIHRvIGFjY2VzcyBpdCBhbmQgZG8gbW9yZSB3b3JrLgoKCiAgICAgIGlmIChzZWdtZW50RW5kID09PSBwYXRoTGVuZ3RoKSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIGlmIChkZXNjcmlwdG9yID09PSB1bmRlZmluZWQpIHsKICAgICAgICAvLyBJZiB0aGUgZGVzY3JpcHRvciBpcyB1bmRlZmluZWQsIHRoZW4gaXRzIGEgbm9ybWFsIHByb3BlcnR5LCBzbyB3ZSBzaG91bGQKICAgICAgICAvLyBsb29rdXAgdGhlIHZhbHVlIHRvIGNoYWluIG9mZiBvZiBsaWtlIG5vcm1hbC4KICAgICAgICBpZiAoIShzZWdtZW50IGluIGN1cnJlbnQpICYmIHR5cGVvZiBjdXJyZW50LnVua25vd25Qcm9wZXJ0eSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQudW5rbm93blByb3BlcnR5KHNlZ21lbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdXJyZW50ID0gY3VycmVudFtzZWdtZW50XTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSWYgdGhlIGRlc2NyaXB0b3IgaXMgZGVmaW5lZCwgdGhlbiBpdHMgYSBub3JtYWwgQ1AgKG5vdCBhbiBhbGlhcywgd2hpY2gKICAgICAgICAvLyB3b3VsZCBoYXZlIGJlZW4gaGFuZGxlZCBlYXJsaWVyKS4gV2UgZ2V0IHRoZSBsYXN0IHJldmlzaW9uIHRvIGNoZWNrIGlmCiAgICAgICAgLy8gdGhlIENQIGlzIHN0aWxsIHZhbGlkLCBhbmQgaWYgc28gd2UgdXNlIHRoZSBjYWNoZWQgdmFsdWUuIElmIG5vdCwgdGhlbgogICAgICAgIC8vIHdlIGNyZWF0ZSBhIGxhenkgY2hhaW4gbG9va3VwLCBhbmQgdGhlIG5leHQgdGltZSB0aGUgQ1AgaXMgY2FsdWN1bGF0ZWQsCiAgICAgICAgLy8gaXQgd2lsbCB1cGRhdGUgdGhhdCBsYXp5IGNoYWluLgogICAgICAgIHZhciBsYXN0UmV2aXNpb24gPSBnZXRMYXN0UmV2aXNpb25Gb3IoY3VycmVudCwgc2VnbWVudCk7CgogICAgICAgIGlmICgoMCwgX3JlZmVyZW5jZS52YWxpZGF0ZSkocHJvcGVydHlUYWcsIGxhc3RSZXZpc2lvbikpIHsKICAgICAgICAgIGN1cnJlbnQgPSBwZWVrQ2FjaGVGb3IoY3VycmVudCkuZ2V0KHNlZ21lbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgbGF6eUNoYWlucyA9ICgwLCBfbWV0YTIubWV0YSkoY3VycmVudCkud3JpdGFibGVMYXp5Q2hhaW5zRm9yKHNlZ21lbnQpOwogICAgICAgICAgdmFyIHJlc3QgPSBwYXRoLnN1YnN0cihzZWdtZW50RW5kICsgMSk7CiAgICAgICAgICB2YXIgcGxhY2Vob2xkZXJUYWcgPSBsYXp5Q2hhaW5zW3Jlc3RdOwoKICAgICAgICAgIGlmIChwbGFjZWhvbGRlclRhZyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHBsYWNlaG9sZGVyVGFnID0gbGF6eUNoYWluc1tyZXN0XSA9ICgwLCBfcmVmZXJlbmNlLmNyZWF0ZVVwZGF0YWJsZVRhZykoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBjaGFpblRhZ3MucHVzaChwbGFjZWhvbGRlclRhZyk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gY2hhaW5UYWdzOwogIH0KICAvKioKICBAbW9kdWxlIEBlbWJlci9vYmplY3QKICAqLwoKCiAgdmFyIEVORF9XSVRIX0VBQ0hfUkVHRVggPSAvXC5AZWFjaCQvOwogIC8qKgogICAgRXhwYW5kcyBgcGF0dGVybmAsIGludm9raW5nIGBjYWxsYmFja2AgZm9yIGVhY2ggZXhwYW5zaW9uLgogIAogICAgVGhlIG9ubHkgcGF0dGVybiBzdXBwb3J0ZWQgaXMgYnJhY2UtZXhwYW5zaW9uLCBhbnl0aGluZyBlbHNlIHdpbGwgYmUgcGFzc2VkCiAgICBvbmNlIHRvIGBjYWxsYmFja2AgZGlyZWN0bHkuCiAgCiAgICBFeGFtcGxlCiAgCiAgICBgYGBqcwogICAgaW1wb3J0IHsgZXhwYW5kUHJvcGVydGllcyB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgZnVuY3Rpb24gZWNobyhhcmcpeyBjb25zb2xlLmxvZyhhcmcpOyB9CiAgCiAgICBleHBhbmRQcm9wZXJ0aWVzKCdmb28uYmFyJywgZWNobyk7ICAgICAgICAgICAgICAvLz0+ICdmb28uYmFyJwogICAgZXhwYW5kUHJvcGVydGllcygne2ZvbyxiYXJ9JywgZWNobyk7ICAgICAgICAgICAgLy89PiAnZm9vJywgJ2JhcicKICAgIGV4cGFuZFByb3BlcnRpZXMoJ2Zvby57YmFyLGJhen0nLCBlY2hvKTsgICAgICAgIC8vPT4gJ2Zvby5iYXInLCAnZm9vLmJheicKICAgIGV4cGFuZFByb3BlcnRpZXMoJ3tmb28sYmFyfS5iYXonLCBlY2hvKTsgICAgICAgIC8vPT4gJ2Zvby5iYXonLCAnYmFyLmJheicKICAgIGV4cGFuZFByb3BlcnRpZXMoJ2Zvby57YmFyLGJhen0uW10nLCBlY2hvKSAgICAgIC8vPT4gJ2Zvby5iYXIuW10nLCAnZm9vLmJhei5bXScKICAgIGV4cGFuZFByb3BlcnRpZXMoJ3tmb28sYmFyfS57c3BhbSxlZ2dzfScsIGVjaG8pIC8vPT4gJ2Zvby5zcGFtJywgJ2Zvby5lZ2dzJywgJ2Jhci5zcGFtJywgJ2Jhci5lZ2dzJwogICAgZXhwYW5kUHJvcGVydGllcygne2Zvb30uYmFyLntiYXp9JykgICAgICAgICAgICAgLy89PiAnZm9vLmJhci5iYXonCiAgICBgYGAKICAKICAgIEBtZXRob2QgZXhwYW5kUHJvcGVydGllcwogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAcHVibGljCiAgICBAcGFyYW0ge1N0cmluZ30gcGF0dGVybiBUaGUgcHJvcGVydHkgcGF0dGVybiB0byBleHBhbmQuCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgdG8gaW52b2tlLiAgSXQgaXMgaW52b2tlZCBvbmNlIHBlcgogICAgZXhwYW5zaW9uLCBhbmQgaXMgcGFzc2VkIHRoZSBleHBhbnNpb24uCiAgKi8KCiAgZnVuY3Rpb24gZXhwYW5kUHJvcGVydGllcyhwYXR0ZXJuLCBjYWxsYmFjaykgewogICAgKGZhbHNlICYmICEodHlwZW9mIHBhdHRlcm4gPT09ICdzdHJpbmcnKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkEgY29tcHV0ZWQgcHJvcGVydHkga2V5IG11c3QgYmUgYSBzdHJpbmcsIHlvdSBwYXNzZWQgIiArIHR5cGVvZiBwYXR0ZXJuICsgIiAiICsgcGF0dGVybiwgdHlwZW9mIHBhdHRlcm4gPT09ICdzdHJpbmcnKSk7CiAgICAoZmFsc2UgJiYgIShwYXR0ZXJuLmluZGV4T2YoJyAnKSA9PT0gLTEpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQnJhY2UgZXhwYW5kZWQgcHJvcGVydGllcyBjYW5ub3QgY29udGFpbiBzcGFjZXMsIGUuZy4gInVzZXIue2ZpcnN0TmFtZSwgbGFzdE5hbWV9IiBzaG91bGQgYmUgInVzZXIue2ZpcnN0TmFtZSxsYXN0TmFtZX0iJywgcGF0dGVybi5pbmRleE9mKCcgJykgPT09IC0xKSk7IC8vIHJlZ2V4IHRvIGxvb2sgZm9yIGRvdWJsZSBvcGVuLCBkb3VibGUgY2xvc2UsIG9yIHVuY2xvc2VkIGJyYWNlcwoKICAgIChmYWxzZSAmJiAhKHBhdHRlcm4ubWF0Y2goL1x7W159e10qXHt8XH1bXn17XSpcfXxce1tefV0qJC9nKSA9PT0gbnVsbCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJCcmFjZSBleHBhbmRlZCBwcm9wZXJ0aWVzIGhhdmUgdG8gYmUgYmFsYW5jZWQgYW5kIGNhbm5vdCBiZSBuZXN0ZWQsIHBhdHRlcm46ICIgKyBwYXR0ZXJuLCBwYXR0ZXJuLm1hdGNoKC9ce1tefXtdKlx7fFx9W159e10qXH18XHtbXn1dKiQvZykgPT09IG51bGwpKTsKICAgIHZhciBzdGFydCA9IHBhdHRlcm4uaW5kZXhPZigneycpOwoKICAgIGlmIChzdGFydCA8IDApIHsKICAgICAgY2FsbGJhY2socGF0dGVybi5yZXBsYWNlKEVORF9XSVRIX0VBQ0hfUkVHRVgsICcuW10nKSk7CiAgICB9IGVsc2UgewogICAgICBkaXZlKCcnLCBwYXR0ZXJuLCBzdGFydCwgY2FsbGJhY2spOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZGl2ZShwcmVmaXgsIHBhdHRlcm4sIHN0YXJ0LCBjYWxsYmFjaykgewogICAgdmFyIGVuZCA9IHBhdHRlcm4uaW5kZXhPZignfScpLAogICAgICAgIGkgPSAwLAogICAgICAgIG5ld1N0YXJ0LAogICAgICAgIGFycmF5TGVuZ3RoOwogICAgdmFyIHRlbXBBcnIgPSBwYXR0ZXJuLnN1YnN0cmluZyhzdGFydCArIDEsIGVuZCkuc3BsaXQoJywnKTsKICAgIHZhciBhZnRlciA9IHBhdHRlcm4uc3Vic3RyaW5nKGVuZCArIDEpOwogICAgcHJlZml4ID0gcHJlZml4ICsgcGF0dGVybi5zdWJzdHJpbmcoMCwgc3RhcnQpOwogICAgYXJyYXlMZW5ndGggPSB0ZW1wQXJyLmxlbmd0aDsKCiAgICB3aGlsZSAoaSA8IGFycmF5TGVuZ3RoKSB7CiAgICAgIG5ld1N0YXJ0ID0gYWZ0ZXIuaW5kZXhPZigneycpOwoKICAgICAgaWYgKG5ld1N0YXJ0IDwgMCkgewogICAgICAgIGNhbGxiYWNrKChwcmVmaXggKyB0ZW1wQXJyW2krK10gKyBhZnRlcikucmVwbGFjZShFTkRfV0lUSF9FQUNIX1JFR0VYLCAnLltdJykpOwogICAgICB9IGVsc2UgewogICAgICAgIGRpdmUocHJlZml4ICsgdGVtcEFycltpKytdLCBhZnRlciwgbmV3U3RhcnQsIGNhbGxiYWNrKTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgKi8KCiAgLyoqCiAgICBTZXRzIHRoZSB2YWx1ZSBvZiBhIHByb3BlcnR5IG9uIGFuIG9iamVjdCwgcmVzcGVjdGluZyBjb21wdXRlZCBwcm9wZXJ0aWVzCiAgICBhbmQgbm90aWZ5aW5nIG9ic2VydmVycyBhbmQgb3RoZXIgbGlzdGVuZXJzIG9mIHRoZSBjaGFuZ2UuCiAgICBJZiB0aGUgc3BlY2lmaWVkIHByb3BlcnR5IGlzIG5vdCBkZWZpbmVkIG9uIHRoZSBvYmplY3QgYW5kIHRoZSBvYmplY3QKICAgIGltcGxlbWVudHMgdGhlIGBzZXRVbmtub3duUHJvcGVydHlgIG1ldGhvZCwgdGhlbiBpbnN0ZWFkIG9mIHNldHRpbmcgdGhlCiAgICB2YWx1ZSBvZiB0aGUgcHJvcGVydHkgb24gdGhlIG9iamVjdCwgaXRzIGBzZXRVbmtub3duUHJvcGVydHlgIGhhbmRsZXIKICAgIHdpbGwgYmUgaW52b2tlZCB3aXRoIHRoZSB0d28gcGFyYW1ldGVycyBga2V5TmFtZWAgYW5kIGB2YWx1ZWAuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIHNldChvYmosICJuYW1lIiwgdmFsdWUpOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIHNldAogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0CiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gbW9kaWZ5LgogICAgQHBhcmFtIHtTdHJpbmd9IGtleU5hbWUgVGhlIHByb3BlcnR5IGtleSB0byBzZXQKICAgIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2V0CiAgICBAcmV0dXJuIHtPYmplY3R9IHRoZSBwYXNzZWQgdmFsdWUuCiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIF9zZXQyKG9iaiwga2V5TmFtZSwgdmFsdWUkJDEsIHRvbGVyYW50KSB7CiAgICAoZmFsc2UgJiYgIShhcmd1bWVudHMubGVuZ3RoID09PSAzIHx8IGFyZ3VtZW50cy5sZW5ndGggPT09IDQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiU2V0IG11c3QgYmUgY2FsbGVkIHdpdGggdGhyZWUgb3IgZm91ciBhcmd1bWVudHM7IGFuIG9iamVjdCwgYSBwcm9wZXJ0eSBrZXksIGEgdmFsdWUgYW5kIHRvbGVyYW50IHRydWUvZmFsc2UiLCBhcmd1bWVudHMubGVuZ3RoID09PSAzIHx8IGFyZ3VtZW50cy5sZW5ndGggPT09IDQpKTsKICAgIChmYWxzZSAmJiAhKG9iaiAmJiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyB8fCB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkNhbm5vdCBjYWxsIHNldCB3aXRoICciICsga2V5TmFtZSArICInIG9uIGFuIHVuZGVmaW5lZCBvYmplY3QuIiwgb2JqICYmIHR5cGVvZiBvYmogPT09ICdvYmplY3QnIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpKTsKICAgIChmYWxzZSAmJiAhKHR5cGVvZiBrZXlOYW1lID09PSAnc3RyaW5nJyB8fCB0eXBlb2Yga2V5TmFtZSA9PT0gJ251bWJlcicgJiYgIWlzTmFOKGtleU5hbWUpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIlRoZSBrZXkgcHJvdmlkZWQgdG8gc2V0IG11c3QgYmUgYSBzdHJpbmcgb3IgbnVtYmVyLCB5b3UgcGFzc2VkICIgKyBrZXlOYW1lLCB0eXBlb2Yga2V5TmFtZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIGtleU5hbWUgPT09ICdudW1iZXInICYmICFpc05hTihrZXlOYW1lKSkpOwogICAgKGZhbHNlICYmICEodHlwZW9mIGtleU5hbWUgIT09ICdzdHJpbmcnIHx8IGtleU5hbWUubGFzdEluZGV4T2YoJ3RoaXMuJywgMCkgIT09IDApICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiJ3RoaXMnIGluIHBhdGhzIGlzIG5vdCBzdXBwb3J0ZWQiLCB0eXBlb2Yga2V5TmFtZSAhPT0gJ3N0cmluZycgfHwga2V5TmFtZS5sYXN0SW5kZXhPZigndGhpcy4nLCAwKSAhPT0gMCkpOwoKICAgIGlmIChvYmouaXNEZXN0cm95ZWQpIHsKICAgICAgKGZhbHNlICYmICEodG9sZXJhbnQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiY2FsbGluZyBzZXQgb24gZGVzdHJveWVkIG9iamVjdDogIiArICgwLCBfdXRpbHMudG9TdHJpbmcpKG9iaikgKyAiLiIgKyBrZXlOYW1lICsgIiA9ICIgKyAoMCwgX3V0aWxzLnRvU3RyaW5nKSh2YWx1ZSQkMSksIHRvbGVyYW50KSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoaXNQYXRoKGtleU5hbWUpKSB7CiAgICAgIHJldHVybiBzZXRQYXRoKG9iaiwga2V5TmFtZSwgdmFsdWUkJDEsIHRvbGVyYW50KTsKICAgIH0KCiAgICB2YXIgbWV0YSQkMSA9ICgwLCBfbWV0YTIucGVla01ldGEpKG9iaik7CiAgICB7CiAgICAgIHZhciBkZXNjcmlwdG9yID0gKDAsIF91dGlscy5sb29rdXBEZXNjcmlwdG9yKShvYmosIGtleU5hbWUpOwogICAgICB2YXIgc2V0dGVyID0gZGVzY3JpcHRvciA9PT0gbnVsbCA/IHVuZGVmaW5lZCA6IGRlc2NyaXB0b3Iuc2V0OwoKICAgICAgaWYgKHNldHRlciAhPT0gdW5kZWZpbmVkICYmIENQX1NFVFRFUl9GVU5DUy5oYXMoc2V0dGVyKSkgewogICAgICAgIG9ialtrZXlOYW1lXSA9IHZhbHVlJCQxOwogICAgICAgIHJldHVybiB2YWx1ZSQkMTsKICAgICAgfQogICAgfQogICAgdmFyIGN1cnJlbnRWYWx1ZTsKCiAgICBpZiAoZmFsc2UKICAgIC8qIERFQlVHICovCiAgICAmJiBfdXRpbHMuSEFTX05BVElWRV9QUk9YWSkgewogICAgICBjdXJyZW50VmFsdWUgPSBnZXRQb3NzaWJsZU1hbmRhdG9yeVByb3h5VmFsdWUob2JqLCBrZXlOYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIGN1cnJlbnRWYWx1ZSA9IG9ialtrZXlOYW1lXTsKICAgIH0KCiAgICBpZiAoY3VycmVudFZhbHVlID09PSB1bmRlZmluZWQgJiYgJ29iamVjdCcgPT09IHR5cGVvZiBvYmogJiYgIShrZXlOYW1lIGluIG9iaikgJiYgdHlwZW9mIG9iai5zZXRVbmtub3duUHJvcGVydHkgPT09ICdmdW5jdGlvbicpIHsKICAgICAgLyogdW5rbm93biBwcm9wZXJ0eSAqLwogICAgICBvYmouc2V0VW5rbm93blByb3BlcnR5KGtleU5hbWUsIHZhbHVlJCQxKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChmYWxzZQogICAgICAvKiBERUJVRyAqLwogICAgICApIHsKICAgICAgICB7CiAgICAgICAgICAoMCwgX3V0aWxzLnNldFdpdGhNYW5kYXRvcnlTZXR0ZXIpKG9iaiwga2V5TmFtZSwgdmFsdWUkJDEpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBvYmpba2V5TmFtZV0gPSB2YWx1ZSQkMTsKICAgICAgfQoKICAgICAgaWYgKGN1cnJlbnRWYWx1ZSAhPT0gdmFsdWUkJDEpIHsKICAgICAgICBub3RpZnlQcm9wZXJ0eUNoYW5nZShvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHZhbHVlJCQxOwogIH0KCiAgZnVuY3Rpb24gc2V0UGF0aChyb290LCBwYXRoLCB2YWx1ZSQkMSwgdG9sZXJhbnQpIHsKICAgIHZhciBwYXJ0cyA9IHBhdGguc3BsaXQoJy4nKTsKICAgIHZhciBrZXlOYW1lID0gcGFydHMucG9wKCk7CiAgICAoZmFsc2UgJiYgIShrZXlOYW1lLnRyaW0oKS5sZW5ndGggPiAwKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1Byb3BlcnR5IHNldCBmYWlsZWQ6IFlvdSBwYXNzZWQgYW4gZW1wdHkgcGF0aCcsIGtleU5hbWUudHJpbSgpLmxlbmd0aCA+IDApKTsKCiAgICB2YXIgbmV3Um9vdCA9IF9nZXRQYXRoKHJvb3QsIHBhcnRzKTsKCiAgICBpZiAobmV3Um9vdCAhPT0gbnVsbCAmJiBuZXdSb290ICE9PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIF9zZXQyKG5ld1Jvb3QsIGtleU5hbWUsIHZhbHVlJCQxKTsKICAgIH0gZWxzZSBpZiAoIXRvbGVyYW50KSB7CiAgICAgIHRocm93IG5ldyBfZXJyb3IuZGVmYXVsdCgiUHJvcGVydHkgc2V0IGZhaWxlZDogb2JqZWN0IGluIHBhdGggXCIiICsgcGFydHMuam9pbignLicpICsgIlwiIGNvdWxkIG5vdCBiZSBmb3VuZC4iKTsKICAgIH0KICB9CiAgLyoqCiAgICBFcnJvci10b2xlcmFudCBmb3JtIG9mIGBzZXRgLiBXaWxsIG5vdCBibG93IHVwIGlmIGFueSBwYXJ0IG9mIHRoZQogICAgY2hhaW4gaXMgYHVuZGVmaW5lZGAsIGBudWxsYCwgb3IgZGVzdHJveWVkLgogIAogICAgVGhpcyBpcyBwcmltYXJpbHkgdXNlZCB3aGVuIHN5bmNpbmcgYmluZGluZ3MsIHdoaWNoIG1heSB0cnkgdG8gdXBkYXRlIGFmdGVyCiAgICBhbiBvYmplY3QgaGFzIGJlZW4gZGVzdHJveWVkLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgdHJ5U2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBsZXQgb2JqID0geyBuYW1lOiAiWm9leSIgfTsKICAgIHRyeVNldChvYmosICJjb250YWN0cy50d2l0dGVyIiwgIkBlbWJlcmpzIik7CiAgICBgYGAKICAKICAgIEBtZXRob2QgdHJ5U2V0CiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QKICAgIEBwYXJhbSB7T2JqZWN0fSByb290IFRoZSBvYmplY3QgdG8gbW9kaWZ5LgogICAgQHBhcmFtIHtTdHJpbmd9IHBhdGggVGhlIHByb3BlcnR5IHBhdGggdG8gc2V0CiAgICBAcGFyYW0ge09iamVjdH0gdmFsdWUgVGhlIHZhbHVlIHRvIHNldAogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiB0cnlTZXQocm9vdCwgcGF0aCwgdmFsdWUkJDEpIHsKICAgIHJldHVybiBfc2V0Mihyb290LCBwYXRoLCB2YWx1ZSQkMSwgdHJ1ZSk7CiAgfQogIC8qKgogIEBtb2R1bGUgQGVtYmVyL29iamVjdAogICovCgoKICB2YXIgREVFUF9FQUNIX1JFR0VYID0gL1wuQGVhY2hcLlteLl0rXC4vOwoKICBmdW5jdGlvbiBub29wKCkge30KICAvKioKICAgIGBAY29tcHV0ZWRgIGlzIGEgZGVjb3JhdG9yIHRoYXQgdHVybnMgYSBKYXZhU2NyaXB0IGdldHRlciBhbmQgc2V0dGVyIGludG8gYQogICAgY29tcHV0ZWQgcHJvcGVydHksIHdoaWNoIGlzIGEgX2NhY2hlZCwgdHJhY2thYmxlIHZhbHVlXy4gQnkgZGVmYXVsdCB0aGUgZ2V0dGVyCiAgICB3aWxsIG9ubHkgYmUgY2FsbGVkIG9uY2UgYW5kIHRoZSByZXN1bHQgd2lsbCBiZSBjYWNoZWQuIFlvdSBjYW4gc3BlY2lmeQogICAgdmFyaW91cyBwcm9wZXJ0aWVzIHRoYXQgeW91ciBjb21wdXRlZCBwcm9wZXJ0eSBkZXBlbmRzIG9uLiBUaGlzIHdpbGwgZm9yY2UgdGhlCiAgICBjYWNoZWQgcmVzdWx0IHRvIGJlIGNsZWFyZWQgaWYgdGhlIGRlcGVuZGVuY2llcyBhcmUgbW9kaWZpZWQsIGFuZCBsYXppbHkgcmVjb21wdXRlZCB0aGUgbmV4dCB0aW1lIHNvbWV0aGluZyBhc2tzIGZvciBpdC4KICAKICAgIEluIHRoZSBmb2xsb3dpbmcgZXhhbXBsZSB3ZSBkZWNvcmF0ZSBhIGdldHRlciAtIGBmdWxsTmFtZWAgLSAgYnkgY2FsbGluZwogICAgYGNvbXB1dGVkYCB3aXRoIHRoZSBwcm9wZXJ0eSBkZXBlbmRlbmNpZXMgKGBmaXJzdE5hbWVgIGFuZCBgbGFzdE5hbWVgKSBhcwogICAgYXJndW1lbnRzLiBUaGUgYGZ1bGxOYW1lYCBnZXR0ZXIgd2lsbCBiZSBjYWxsZWQgb25jZSAocmVnYXJkbGVzcyBvZiBob3cgbWFueQogICAgdGltZXMgaXQgaXMgYWNjZXNzZWQpIGFzIGxvbmcgYXMgaXRzIGRlcGVuZGVuY2llcyBkbyBub3QgY2hhbmdlLiBPbmNlCiAgICBgZmlyc3ROYW1lYCBvciBgbGFzdE5hbWVgIGFyZSB1cGRhdGVkIGFueSBmdXR1cmUgY2FsbHMgdG8gYGZ1bGxOYW1lYCB3aWxsCiAgICBpbmNvcnBvcmF0ZSB0aGUgbmV3IHZhbHVlcywgYW5kIGFueSB3YXRjaGVycyBvZiB0aGUgdmFsdWUgc3VjaCBhcyB0ZW1wbGF0ZXMKICAgIHdpbGwgYmUgdXBkYXRlZDoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGNvbXB1dGVkLCBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGNsYXNzIFBlcnNvbiB7CiAgICAgIGNvbnN0cnVjdG9yKGZpcnN0TmFtZSwgbGFzdE5hbWUpIHsKICAgICAgICBzZXQodGhpcywgJ2ZpcnN0TmFtZScsIGZpcnN0TmFtZSk7CiAgICAgICAgc2V0KHRoaXMsICdsYXN0TmFtZScsIGxhc3ROYW1lKTsKICAgICAgfQogIAogICAgICBAY29tcHV0ZWQoJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScpCiAgICAgIGdldCBmdWxsTmFtZSgpIHsKICAgICAgICByZXR1cm4gYCR7dGhpcy5maXJzdE5hbWV9ICR7dGhpcy5sYXN0TmFtZX1gOwogICAgICB9CiAgICB9KTsKICAKICAgIGxldCB0b20gPSBuZXcgUGVyc29uKCdUb20nLCAnRGFsZScpOwogIAogICAgdG9tLmZ1bGxOYW1lOyAvLyAnVG9tIERhbGUnCiAgICBgYGAKICAKICAgIFlvdSBjYW4gYWxzbyBwcm92aWRlIGEgc2V0dGVyLCB3aGljaCB3aWxsIGJlIHVzZWQgd2hlbiB1cGRhdGluZyB0aGUgY29tcHV0ZWQKICAgIHByb3BlcnR5LiBFbWJlcidzIGBzZXRgIGZ1bmN0aW9uIG11c3QgYmUgdXNlZCB0byB1cGRhdGUgdGhlIHByb3BlcnR5CiAgICBzaW5jZSBpdCB3aWxsIGFsc28gbm90aWZ5IG9ic2VydmVycyBvZiB0aGUgcHJvcGVydHk6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBjb21wdXRlZCwgc2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBjbGFzcyBQZXJzb24gewogICAgICBjb25zdHJ1Y3RvcihmaXJzdE5hbWUsIGxhc3ROYW1lKSB7CiAgICAgICAgc2V0KHRoaXMsICdmaXJzdE5hbWUnLCBmaXJzdE5hbWUpOwogICAgICAgIHNldCh0aGlzLCAnbGFzdE5hbWUnLCBsYXN0TmFtZSk7CiAgICAgIH0KICAKICAgICAgQGNvbXB1dGVkKCdmaXJzdE5hbWUnLCAnbGFzdE5hbWUnKQogICAgICBnZXQgZnVsbE5hbWUoKSB7CiAgICAgICAgcmV0dXJuIGAke3RoaXMuZmlyc3ROYW1lfSAke3RoaXMubGFzdE5hbWV9YDsKICAgICAgfQogIAogICAgICBzZXQgZnVsbE5hbWUodmFsdWUpIHsKICAgICAgICBsZXQgW2ZpcnN0TmFtZSwgbGFzdE5hbWVdID0gdmFsdWUuc3BsaXQoJyAnKTsKICAKICAgICAgICBzZXQodGhpcywgJ2ZpcnN0TmFtZScsIGZpcnN0TmFtZSk7CiAgICAgICAgc2V0KHRoaXMsICdsYXN0TmFtZScsIGxhc3ROYW1lKTsKICAgICAgfQogICAgfSk7CiAgCiAgICBsZXQgcGVyc29uID0gbmV3IFBlcnNvbigpOwogIAogICAgc2V0KHBlcnNvbiwgJ2Z1bGxOYW1lJywgJ1BldGVyIFdhZ2VuZXQnKTsKICAgIHBlcnNvbi5maXJzdE5hbWU7IC8vICdQZXRlcicKICAgIHBlcnNvbi5sYXN0TmFtZTsgIC8vICdXYWdlbmV0JwogICAgYGBgCiAgCiAgICBZb3UgY2FuIGFsc28gcGFzcyBhIGdldHRlciBmdW5jdGlvbiBvciBvYmplY3Qgd2l0aCBgZ2V0YCBhbmQgYHNldGAgZnVuY3Rpb25zCiAgICBhcyB0aGUgbGFzdCBhcmd1bWVudCB0byB0aGUgY29tcHV0ZWQgZGVjb3JhdG9yLiBUaGlzIGFsbG93cyB5b3UgdG8gZGVmaW5lCiAgICBjb21wdXRlZCBwcm9wZXJ0eSBfbWFjcm9zXzoKICAKICAgIGBgYGpzCiAgICBpbXBvcnQgeyBjb21wdXRlZCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgZnVuY3Rpb24gam9pbiguLi5rZXlzKSB7CiAgICAgIHJldHVybiBjb21wdXRlZCguLi5rZXlzLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4ga2V5cy5tYXAoa2V5ID0+IHRoaXNba2V5XSkuam9pbignICcpOwogICAgICB9KTsKICAgIH0KICAKICAgIGNsYXNzIFBlcnNvbiB7CiAgICAgIEBqb2luKCdmaXJzdE5hbWUnLCAnbGFzdE5hbWUnKQogICAgICBmdWxsTmFtZTsKICAgIH0KICAgIGBgYAogIAogICAgTm90ZSB0aGF0IHdoZW4gZGVmaW5lZCB0aGlzIHdheSwgZ2V0dGVycyBhbmQgc2V0dGVycyByZWNlaXZlIHRoZSBfa2V5XyBvZiB0aGUKICAgIHByb3BlcnR5IHRoZXkgYXJlIGRlY29yYXRpbmcgYXMgdGhlIGZpcnN0IGFyZ3VtZW50LiBTZXR0ZXJzIHJlY2VpdmUgdGhlIHZhbHVlCiAgICB0aGV5IGFyZSBzZXR0aW5nIHRvIGFzIHRoZSBzZWNvbmQgYXJndW1lbnQgaW5zdGVhZC4gQWRkaXRpb25hbGx5LCBzZXR0ZXJzIG11c3QKICAgIF9yZXR1cm5fIHRoZSB2YWx1ZSB0aGF0IHNob3VsZCBiZSBjYWNoZWQ6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBjb21wdXRlZCwgc2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBmdW5jdGlvbiBmdWxsTmFtZU1hY3JvKGZpcnN0TmFtZUtleSwgbGFzdE5hbWVLZXkpIHsKICAgICAgcmV0dXJuIGNvbXB1dGVkKGZpcnN0TmFtZUtleSwgbGFzdE5hbWVLZXksIHsKICAgICAgICBnZXQoKSB7CiAgICAgICAgICByZXR1cm4gYCR7dGhpc1tmaXJzdE5hbWVLZXldfSAke3RoaXNbbGFzdE5hbWVLZXldfWA7CiAgICAgICAgfQogIAogICAgICAgIHNldChrZXksIHZhbHVlKSB7CiAgICAgICAgICBsZXQgW2ZpcnN0TmFtZSwgbGFzdE5hbWVdID0gdmFsdWUuc3BsaXQoJyAnKTsKICAKICAgICAgICAgIHNldCh0aGlzLCBmaXJzdE5hbWVLZXksIGZpcnN0TmFtZSk7CiAgICAgICAgICBzZXQodGhpcywgbGFzdE5hbWVLZXksIGxhc3ROYW1lKTsKICAKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIAogICAgY2xhc3MgUGVyc29uIHsKICAgICAgY29uc3RydWN0b3IoZmlyc3ROYW1lLCBsYXN0TmFtZSkgewogICAgICAgIHNldCh0aGlzLCAnZmlyc3ROYW1lJywgZmlyc3ROYW1lKTsKICAgICAgICBzZXQodGhpcywgJ2xhc3ROYW1lJywgbGFzdE5hbWUpOwogICAgICB9CiAgCiAgICAgIEBmdWxsTmFtZU1hY3JvIGZ1bGxOYW1lOwogICAgfSk7CiAgCiAgICBsZXQgcGVyc29uID0gbmV3IFBlcnNvbigpOwogIAogICAgc2V0KHBlcnNvbiwgJ2Z1bGxOYW1lJywgJ1BldGVyIFdhZ2VuZXQnKTsKICAgIHBlcnNvbi5maXJzdE5hbWU7IC8vICdQZXRlcicKICAgIHBlcnNvbi5sYXN0TmFtZTsgIC8vICdXYWdlbmV0JwogICAgYGBgCiAgCiAgICBDb21wdXRlZCBwcm9wZXJ0aWVzIGNhbiBhbHNvIGJlIHVzZWQgaW4gY2xhc3NpYyBjbGFzc2VzLiBUbyBkbyB0aGlzLCB3ZQogICAgcHJvdmlkZSB0aGUgZ2V0dGVyIGFuZCBzZXR0ZXIgYXMgdGhlIGxhc3QgYXJndW1lbnQgbGlrZSB3ZSB3b3VsZCBmb3IgYSBtYWNybywKICAgIGFuZCB3ZSBhc3NpZ24gaXQgdG8gYSBwcm9wZXJ0eSBvbiB0aGUgY2xhc3MgZGVmaW5pdGlvbi4gVGhpcyBpcyBhbiBfYW5vbnltb3VzXwogICAgY29tcHV0ZWQgbWFjcm86CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgRW1iZXJPYmplY3QsIHsgY29tcHV0ZWQsIHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgbGV0IFBlcnNvbiA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIC8vIHRoZXNlIHdpbGwgYmUgc3VwcGxpZWQgYnkgYGNyZWF0ZWAKICAgICAgZmlyc3ROYW1lOiBudWxsLAogICAgICBsYXN0TmFtZTogbnVsbCwKICAKICAgICAgZnVsbE5hbWU6IGNvbXB1dGVkKCdmaXJzdE5hbWUnLCAnbGFzdE5hbWUnLCB7CiAgICAgICAgZ2V0KCkgewogICAgICAgICAgcmV0dXJuIGAke3RoaXMuZmlyc3ROYW1lfSAke3RoaXMubGFzdE5hbWV9YDsKICAgICAgICB9CiAgCiAgICAgICAgc2V0KGtleSwgdmFsdWUpIHsKICAgICAgICAgIGxldCBbZmlyc3ROYW1lLCBsYXN0TmFtZV0gPSB2YWx1ZS5zcGxpdCgnICcpOwogIAogICAgICAgICAgc2V0KHRoaXMsICdmaXJzdE5hbWUnLCBmaXJzdE5hbWUpOwogICAgICAgICAgc2V0KHRoaXMsICdsYXN0TmFtZScsIGxhc3ROYW1lKTsKICAKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9KTsKICAKICAgIGxldCB0b20gPSBQZXJzb24uY3JlYXRlKHsKICAgICAgZmlyc3ROYW1lOiAnVG9tJywKICAgICAgbGFzdE5hbWU6ICdEYWxlJwogICAgfSk7CiAgCiAgICB0b20uZ2V0KCdmdWxsTmFtZScpIC8vICdUb20gRGFsZScKICAgIGBgYAogIAogICAgWW91IGNhbiBvdmVyd3JpdGUgY29tcHV0ZWQgcHJvcGVydHkgd2l0aG91dCBzZXR0ZXJzIHdpdGggYSBub3JtYWwgcHJvcGVydHkgKG5vCiAgICBsb25nZXIgY29tcHV0ZWQpIHRoYXQgd29uJ3QgY2hhbmdlIGlmIGRlcGVuZGVuY2llcyBjaGFuZ2UuIFlvdSBjYW4gYWxzbyBtYXJrCiAgICBjb21wdXRlZCBwcm9wZXJ0eSBhcyBgLnJlYWRPbmx5KClgIGFuZCBibG9jayBhbGwgYXR0ZW1wdHMgdG8gc2V0IGl0LgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgY29tcHV0ZWQsIHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgY2xhc3MgUGVyc29uIHsKICAgICAgY29uc3RydWN0b3IoZmlyc3ROYW1lLCBsYXN0TmFtZSkgewogICAgICAgIHNldCh0aGlzLCAnZmlyc3ROYW1lJywgZmlyc3ROYW1lKTsKICAgICAgICBzZXQodGhpcywgJ2xhc3ROYW1lJywgbGFzdE5hbWUpOwogICAgICB9CiAgCiAgICAgIEBjb21wdXRlZCgnZmlyc3ROYW1lJywgJ2xhc3ROYW1lJykucmVhZE9ubHkoKQogICAgICBnZXQgZnVsbE5hbWUoKSB7CiAgICAgICAgcmV0dXJuIGAke3RoaXMuZmlyc3ROYW1lfSAke3RoaXMubGFzdE5hbWV9YDsKICAgICAgfQogICAgfSk7CiAgCiAgICBsZXQgcGVyc29uID0gbmV3IFBlcnNvbigpOwogICAgcGVyc29uLnNldCgnZnVsbE5hbWUnLCAnUGV0ZXIgV2FnZW5ldCcpOyAvLyBVbmNhdWdodCBFcnJvcjogQ2Fubm90IHNldCByZWFkLW9ubHkgcHJvcGVydHkgImZ1bGxOYW1lIiBvbiBvYmplY3Q6IDwoLi4uKTplbWJlclhYWD4KICAgIGBgYAogIAogICAgQWRkaXRpb25hbCByZXNvdXJjZXM6CiAgICAtIFtEZWNvcmF0b3JzIFJGQ10oaHR0cHM6Ly9naXRodWIuY29tL2VtYmVyanMvcmZjcy9ibG9iL21hc3Rlci90ZXh0LzA0MDgtZGVjb3JhdG9ycy5tZCkKICAgIC0gW05ldyBDUCBzeW50YXggUkZDXShodHRwczovL2dpdGh1Yi5jb20vZW1iZXJqcy9yZmNzL2Jsb2IvbWFzdGVyL3RleHQvMDAxMS1pbXByb3ZlZC1jcC1zeW50YXgubWQpCiAgICAtIFtOZXcgY29tcHV0ZWQgc3ludGF4IGV4cGxhaW5lZCBpbiAiRW1iZXIgMS4xMiByZWxlYXNlZCIgXShodHRwczovL2VtYmVyanMuY29tL2Jsb2cvMjAxNS8wNS8xMy9lbWJlci0xLTEyLXJlbGVhc2VkLmh0bWwjdG9jX25ldy1jb21wdXRlZC1zeW50YXgpCiAgCiAgICBAY2xhc3MgQ29tcHV0ZWRQcm9wZXJ0eQogICAgQHB1YmxpYwogICovCgoKICB2YXIgQ29tcHV0ZWRQcm9wZXJ0eSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfQ29tcHV0ZWREZXNjcmlwdG9yKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoQ29tcHV0ZWRQcm9wZXJ0eSwgX0NvbXB1dGVkRGVzY3JpcHRvcik7CgogICAgZnVuY3Rpb24gQ29tcHV0ZWRQcm9wZXJ0eShhcmdzKSB7CiAgICAgIHZhciBfdGhpczsKCiAgICAgIF90aGlzID0gX0NvbXB1dGVkRGVzY3JpcHRvci5jYWxsKHRoaXMpIHx8IHRoaXM7CiAgICAgIF90aGlzLl92b2xhdGlsZSA9IGZhbHNlOwogICAgICBfdGhpcy5fcmVhZE9ubHkgPSBmYWxzZTsKICAgICAgX3RoaXMuX3N1c3BlbmRlZCA9IHVuZGVmaW5lZDsKICAgICAgX3RoaXMuX2hhc0NvbmZpZyA9IGZhbHNlOwogICAgICBfdGhpcy5fZ2V0dGVyID0gdW5kZWZpbmVkOwogICAgICBfdGhpcy5fc2V0dGVyID0gdW5kZWZpbmVkOwogICAgICB2YXIgbWF5YmVDb25maWcgPSBhcmdzW2FyZ3MubGVuZ3RoIC0gMV07CgogICAgICBpZiAodHlwZW9mIG1heWJlQ29uZmlnID09PSAnZnVuY3Rpb24nIHx8IG1heWJlQ29uZmlnICE9PSBudWxsICYmIHR5cGVvZiBtYXliZUNvbmZpZyA9PT0gJ29iamVjdCcpIHsKICAgICAgICBfdGhpcy5faGFzQ29uZmlnID0gdHJ1ZTsKICAgICAgICB2YXIgY29uZmlnID0gYXJncy5wb3AoKTsKCiAgICAgICAgaWYgKHR5cGVvZiBjb25maWcgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIChmYWxzZSAmJiAhKCFpc0NsYXNzaWNEZWNvcmF0b3IoY29uZmlnKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJZb3UgYXR0ZW1wdGVkIHRvIHBhc3MgYSBjb21wdXRlZCBwcm9wZXJ0eSBpbnN0YW5jZSB0byBjb21wdXRlZCgpLiBDb21wdXRlZCBwcm9wZXJ0eSBpbnN0YW5jZXMgYXJlIGRlY29yYXRvciBmdW5jdGlvbnMsIGFuZCBjYW5ub3QgYmUgcGFzc2VkIHRvIGNvbXB1dGVkKCkgYmVjYXVzZSB0aGV5IGNhbm5vdCBiZSB0dXJuZWQgaW50byBkZWNvcmF0b3JzIHR3aWNlIiwgIWlzQ2xhc3NpY0RlY29yYXRvcihjb25maWcpKSk7CiAgICAgICAgICBfdGhpcy5fZ2V0dGVyID0gY29uZmlnOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgb2JqZWN0Q29uZmlnID0gY29uZmlnOwogICAgICAgICAgKGZhbHNlICYmICEodHlwZW9mIG9iamVjdENvbmZpZyA9PT0gJ29iamVjdCcgJiYgIUFycmF5LmlzQXJyYXkob2JqZWN0Q29uZmlnKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdjb21wdXRlZCBleHBlY3RzIGEgZnVuY3Rpb24gb3IgYW4gb2JqZWN0IGFzIGxhc3QgYXJndW1lbnQuJywgdHlwZW9mIG9iamVjdENvbmZpZyA9PT0gJ29iamVjdCcgJiYgIUFycmF5LmlzQXJyYXkob2JqZWN0Q29uZmlnKSkpOwogICAgICAgICAgKGZhbHNlICYmICEoT2JqZWN0LmtleXMob2JqZWN0Q29uZmlnKS5ldmVyeShmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHJldHVybiBrZXkgPT09ICdnZXQnIHx8IGtleSA9PT0gJ3NldCc7CiAgICAgICAgICB9KSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDb25maWcgb2JqZWN0IHBhc3NlZCB0byBjb21wdXRlZCBjYW4gb25seSBjb250YWluIGBnZXRgIGFuZCBgc2V0YCBrZXlzLicsIE9iamVjdC5rZXlzKG9iamVjdENvbmZpZykuZXZlcnkoZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICByZXR1cm4ga2V5ID09PSAnZ2V0JyB8fCBrZXkgPT09ICdzZXQnOwogICAgICAgICAgfSkpKTsKICAgICAgICAgIChmYWxzZSAmJiAhKEJvb2xlYW4ob2JqZWN0Q29uZmlnLmdldCkgfHwgQm9vbGVhbihvYmplY3RDb25maWcuc2V0KSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDb21wdXRlZCBwcm9wZXJ0aWVzIG11c3QgcmVjZWl2ZSBhIGdldHRlciBvciBhIHNldHRlciwgeW91IHBhc3NlZCBub25lLicsIEJvb2xlYW4ob2JqZWN0Q29uZmlnLmdldCkgfHwgQm9vbGVhbihvYmplY3RDb25maWcuc2V0KSkpOwogICAgICAgICAgX3RoaXMuX2dldHRlciA9IG9iamVjdENvbmZpZy5nZXQgfHwgbm9vcDsKICAgICAgICAgIF90aGlzLl9zZXR0ZXIgPSBvYmplY3RDb25maWcuc2V0OwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgIHZhciBfdGhpczI7CgogICAgICAgIChfdGhpczIgPSBfdGhpcykuX3Byb3BlcnR5LmFwcGx5KF90aGlzMiwgYXJncyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICB2YXIgX3Byb3RvNyA9IENvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlOwoKICAgIF9wcm90bzcuc2V0dXAgPSBmdW5jdGlvbiBzZXR1cChvYmosIGtleU5hbWUsIHByb3BlcnR5RGVzYywgbWV0YSQkMSkgewogICAgICBfQ29tcHV0ZWREZXNjcmlwdG9yLnByb3RvdHlwZS5zZXR1cC5jYWxsKHRoaXMsIG9iaiwga2V5TmFtZSwgcHJvcGVydHlEZXNjLCBtZXRhJCQxKTsKCiAgICAgIChmYWxzZSAmJiAhKCEocHJvcGVydHlEZXNjICYmIHR5cGVvZiBwcm9wZXJ0eURlc2MudmFsdWUgPT09ICdmdW5jdGlvbicpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkBjb21wdXRlZCBjYW4gb25seSBiZSB1c2VkIG9uIGFjY2Vzc29ycyBvciBmaWVsZHMsIGF0dGVtcHRlZCB0byB1c2UgaXQgd2l0aCAiICsga2V5TmFtZSArICIgYnV0IHRoYXQgd2FzIGEgbWV0aG9kLiBUcnkgY29udmVydGluZyBpdCB0byBhIGdldHRlciAoZS5nLiBgZ2V0ICIgKyBrZXlOYW1lICsgIigpIHt9YCkiLCAhKHByb3BlcnR5RGVzYyAmJiB0eXBlb2YgcHJvcGVydHlEZXNjLnZhbHVlID09PSAnZnVuY3Rpb24nKSkpOwogICAgICAoZmFsc2UgJiYgISghcHJvcGVydHlEZXNjIHx8ICFwcm9wZXJ0eURlc2MuaW5pdGlhbGl6ZXIpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQGNvbXB1dGVkIGNhbiBvbmx5IGJlIHVzZWQgb24gZW1wdHkgZmllbGRzLiAiICsga2V5TmFtZSArICIgaGFzIGFuIGluaXRpYWwgdmFsdWUgKGUuZy4gYCIgKyBrZXlOYW1lICsgIiA9IHNvbWVWYWx1ZWApIiwgIXByb3BlcnR5RGVzYyB8fCAhcHJvcGVydHlEZXNjLmluaXRpYWxpemVyKSk7CiAgICAgIChmYWxzZSAmJiAhKCEodGhpcy5faGFzQ29uZmlnICYmIHByb3BlcnR5RGVzYyAmJiAodHlwZW9mIHByb3BlcnR5RGVzYy5nZXQgPT09ICdmdW5jdGlvbicgfHwgdHlwZW9mIHByb3BlcnR5RGVzYy5zZXQgPT09ICdmdW5jdGlvbicpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJBdHRlbXB0ZWQgdG8gYXBwbHkgYSBjb21wdXRlZCBwcm9wZXJ0eSB0aGF0IGFscmVhZHkgaGFzIGEgZ2V0dGVyL3NldHRlciB0byBhICIgKyBrZXlOYW1lICsgIiwgYnV0IGl0IGlzIGEgbWV0aG9kIG9yIGFuIGFjY2Vzc29yLiBJZiB5b3UgcGFzc2VkIEBjb21wdXRlZCBhIGZ1bmN0aW9uIG9yIGdldHRlci9zZXR0ZXIgKGUuZy4gYEBjb21wdXRlZCh7IGdldCgpIHsgLi4uIH0gfSlgKSwgdGhlbiBpdCBtdXN0IGJlIGFwcGxpZWQgdG8gYSBmaWVsZCIsICEodGhpcy5faGFzQ29uZmlnICYmIHByb3BlcnR5RGVzYyAmJiAodHlwZW9mIHByb3BlcnR5RGVzYy5nZXQgPT09ICdmdW5jdGlvbicgfHwgdHlwZW9mIHByb3BlcnR5RGVzYy5zZXQgPT09ICdmdW5jdGlvbicpKSkpOwoKICAgICAgaWYgKHRoaXMuX2hhc0NvbmZpZyA9PT0gZmFsc2UpIHsKICAgICAgICAoZmFsc2UgJiYgIShwcm9wZXJ0eURlc2MgJiYgKHR5cGVvZiBwcm9wZXJ0eURlc2MuZ2V0ID09PSAnZnVuY3Rpb24nIHx8IHR5cGVvZiBwcm9wZXJ0eURlc2Muc2V0ID09PSAnZnVuY3Rpb24nKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJBdHRlbXB0ZWQgdG8gdXNlIEBjb21wdXRlZCBvbiAiICsga2V5TmFtZSArICIsIGJ1dCBpdCBkaWQgbm90IGhhdmUgYSBnZXR0ZXIgb3IgYSBzZXR0ZXIuIFlvdSBtdXN0IGVpdGhlciBwYXNzIGEgZ2V0IGEgZnVuY3Rpb24gb3IgZ2V0dGVyL3NldHRlciB0byBAY29tcHV0ZWQgZGlyZWN0bHkgKGUuZy4gYEBjb21wdXRlZCh7IGdldCgpIHsgLi4uIH0gfSlgKSBvciBhcHBseSBAY29tcHV0ZWQgZGlyZWN0bHkgdG8gYSBnZXR0ZXIvc2V0dGVyIiwgcHJvcGVydHlEZXNjICYmICh0eXBlb2YgcHJvcGVydHlEZXNjLmdldCA9PT0gJ2Z1bmN0aW9uJyB8fCB0eXBlb2YgcHJvcGVydHlEZXNjLnNldCA9PT0gJ2Z1bmN0aW9uJykpKTsKICAgICAgICB2YXIgX2dldCA9IHByb3BlcnR5RGVzYy5nZXQsCiAgICAgICAgICAgIHNldCQkMSA9IHByb3BlcnR5RGVzYy5zZXQ7CgogICAgICAgIGlmIChfZ2V0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHRoaXMuX2dldHRlciA9IF9nZXQ7CiAgICAgICAgfQoKICAgICAgICBpZiAoc2V0JCQxICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHRoaXMuX3NldHRlciA9IGZ1bmN0aW9uIHNldHRlcldyYXBwZXIoX2tleSwgdmFsdWUkJDEpIHsKICAgICAgICAgICAgdmFyIHJldCA9IHNldCQkMS5jYWxsKHRoaXMsIHZhbHVlJCQxKTsKCiAgICAgICAgICAgIGlmIChfZ2V0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIHJldCA9PT0gJ3VuZGVmaW5lZCcgPyBfZ2V0LmNhbGwodGhpcykgOiByZXQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgIENhbGwgb24gYSBjb21wdXRlZCBwcm9wZXJ0eSB0byBzZXQgaXQgaW50byBub24tY2FjaGVkIG1vZGUuIFdoZW4gaW4gdGhpcwogICAgICBtb2RlIHRoZSBjb21wdXRlZCBwcm9wZXJ0eSB3aWxsIG5vdCBhdXRvbWF0aWNhbGx5IGNhY2hlIHRoZSByZXR1cm4gdmFsdWUuCiAgICAgIEl0IGFsc28gZG9lcyBub3QgYXV0b21hdGljYWxseSBmaXJlIGFueSBjaGFuZ2UgZXZlbnRzLiBZb3UgbXVzdCBtYW51YWxseSBub3RpZnkKICAgICAgYW55IGNoYW5nZXMgaWYgeW91IHdhbnQgdG8gb2JzZXJ2ZSB0aGlzIHByb3BlcnR5LgogICAgICBEZXBlbmRlbmN5IGtleXMgaGF2ZSBubyBlZmZlY3Qgb24gdm9sYXRpbGUgcHJvcGVydGllcyBhcyB0aGV5IGFyZSBmb3IgY2FjaGUKICAgICAgaW52YWxpZGF0aW9uIGFuZCBub3RpZmljYXRpb24gd2hlbiBjYWNoZWQgdmFsdWUgaXMgaW52YWxpZGF0ZWQuCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IGNvbXB1dGVkIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgIGxldCBvdXRzaWRlU2VydmljZSA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgdmFsdWU6IGNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIE91dHNpZGVTZXJ2aWNlLmdldFZhbHVlKCk7CiAgICAgICAgfSkudm9sYXRpbGUoKQogICAgICB9KS5jcmVhdGUoKTsKICAgICAgYGBgCiAgICAgIEBtZXRob2Qgdm9sYXRpbGUKICAgICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gdGhpcwogICAgICBAY2hhaW5hYmxlCiAgICAgIEBwdWJsaWMKICAgICovCiAgICA7CgogICAgX3Byb3RvNy52b2xhdGlsZSA9IGZ1bmN0aW9uIHZvbGF0aWxlKCkgewogICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCdTZXR0aW5nIGEgY29tcHV0ZWQgcHJvcGVydHkgYXMgdm9sYXRpbGUgaGFzIGJlZW4gZGVwcmVjYXRlZC4gSW5zdGVhZCwgY29uc2lkZXIgdXNpbmcgYSBuYXRpdmUgZ2V0dGVyIHdpdGggbmF0aXZlIGNsYXNzIHN5bnRheC4nLCBmYWxzZSwgewogICAgICAgIGlkOiAnY29tcHV0ZWQtcHJvcGVydHkudm9sYXRpbGUnLAogICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgIHVybDogJ2h0dHBzOi8vZW1iZXJqcy5jb20vZGVwcmVjYXRpb25zL3YzLngjdG9jX2NvbXB1dGVkLXByb3BlcnR5LXZvbGF0aWxlJwogICAgICB9KSk7CiAgICAgIHRoaXMuX3ZvbGF0aWxlID0gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICBDYWxsIG9uIGEgY29tcHV0ZWQgcHJvcGVydHkgdG8gc2V0IGl0IGludG8gcmVhZC1vbmx5IG1vZGUuIFdoZW4gaW4gdGhpcwogICAgICBtb2RlIHRoZSBjb21wdXRlZCBwcm9wZXJ0eSB3aWxsIHRocm93IGFuIGVycm9yIHdoZW4gc2V0LgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBFbWJlck9iamVjdCwgeyBjb21wdXRlZCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICBsZXQgUGVyc29uID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgICBndWlkOiBjb21wdXRlZChmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiAnZ3VpZC1ndWlkLWd1aWQnOwogICAgICAgIH0pLnJlYWRPbmx5KCkKICAgICAgfSk7CiAgICAgIGxldCBwZXJzb24gPSBQZXJzb24uY3JlYXRlKCk7CiAgICAgIHBlcnNvbi5zZXQoJ2d1aWQnLCAnbmV3LWd1aWQnKTsgLy8gd2lsbCB0aHJvdyBhbiBleGNlcHRpb24KICAgICAgYGBgCiAgICAgIEBtZXRob2QgcmVhZE9ubHkKICAgICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gdGhpcwogICAgICBAY2hhaW5hYmxlCiAgICAgIEBwdWJsaWMKICAgICovCiAgICA7CgogICAgX3Byb3RvNy5yZWFkT25seSA9IGZ1bmN0aW9uIHJlYWRPbmx5KCkgewogICAgICB0aGlzLl9yZWFkT25seSA9IHRydWU7CiAgICAgIChmYWxzZSAmJiAhKCEodGhpcy5fcmVhZE9ubHkgJiYgdGhpcy5fc2V0dGVyICYmIHRoaXMuX3NldHRlciAhPT0gdGhpcy5fZ2V0dGVyKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDb21wdXRlZCBwcm9wZXJ0aWVzIHRoYXQgZGVmaW5lIGEgc2V0dGVyIHVzaW5nIHRoZSBuZXcgc3ludGF4IGNhbm5vdCBiZSByZWFkLW9ubHknLCAhKHRoaXMuX3JlYWRPbmx5ICYmIHRoaXMuX3NldHRlciAmJiB0aGlzLl9zZXR0ZXIgIT09IHRoaXMuX2dldHRlcikpKTsKICAgIH0KICAgIC8qKgogICAgICBTZXRzIHRoZSBkZXBlbmRlbnQga2V5cyBvbiB0aGlzIGNvbXB1dGVkIHByb3BlcnR5LiBQYXNzIGFueSBudW1iZXIgb2YKICAgICAgYXJndW1lbnRzIGNvbnRhaW5pbmcga2V5IHBhdGhzIHRoYXQgdGhpcyBjb21wdXRlZCBwcm9wZXJ0eSBkZXBlbmRzIG9uLgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBFbWJlck9iamVjdCwgeyBjb21wdXRlZCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICBsZXQgUHJlc2lkZW50ID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgICBmdWxsTmFtZTogY29tcHV0ZWQoJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KCdmaXJzdE5hbWUnKSArICcgJyArIHRoaXMuZ2V0KCdsYXN0TmFtZScpOwogICAgICAgICAgLy8gVGVsbCBFbWJlciB0aGF0IHRoaXMgY29tcHV0ZWQgcHJvcGVydHkgZGVwZW5kcyBvbiBmaXJzdE5hbWUKICAgICAgICAgIC8vIGFuZCBsYXN0TmFtZQogICAgICAgIH0pCiAgICAgIH0pOwogICAgICBsZXQgcHJlc2lkZW50ID0gUHJlc2lkZW50LmNyZWF0ZSh7CiAgICAgICAgZmlyc3ROYW1lOiAnQmFyYWNrJywKICAgICAgICBsYXN0TmFtZTogJ09iYW1hJwogICAgICB9KTsKICAgICAgcHJlc2lkZW50LmdldCgnZnVsbE5hbWUnKTsgLy8gJ0JhcmFjayBPYmFtYScKICAgICAgYGBgCiAgICAgIEBtZXRob2QgcHJvcGVydHkKICAgICAgQHBhcmFtIHtTdHJpbmd9IHBhdGgqIHplcm8gb3IgbW9yZSBwcm9wZXJ0eSBwYXRocwogICAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSB0aGlzCiAgICAgIEBjaGFpbmFibGUKICAgICAgQHB1YmxpYwogICAgKi8KICAgIDsKCiAgICBfcHJvdG83LnByb3BlcnR5ID0gZnVuY3Rpb24gcHJvcGVydHkoKSB7CiAgICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoJ1NldHRpbmcgZGVwZW5kZW5jeSBrZXlzIHVzaW5nIHRoZSBgLnByb3BlcnR5KClgIG1vZGlmaWVyIGhhcyBiZWVuIGRlcHJlY2F0ZWQuIFBhc3MgdGhlIGRlcGVuZGVuY3kga2V5cyBkaXJlY3RseSB0byBjb21wdXRlZCBhcyBhcmd1bWVudHMgaW5zdGVhZC4gSWYgeW91IGFyZSB1c2luZyBgLnByb3BlcnR5KClgIG9uIGEgY29tcHV0ZWQgcHJvcGVydHkgbWFjcm8sIGNvbnNpZGVyIHJlZmFjdG9yaW5nIHlvdXIgbWFjcm8gdG8gcmVjZWl2ZSBhZGRpdGlvbmFsIGRlcGVuZGVudCBrZXlzIGluIGl0cyBpbml0aWFsIGRlY2xhcmF0aW9uLicsIGZhbHNlLCB7CiAgICAgICAgaWQ6ICdjb21wdXRlZC1wcm9wZXJ0eS5wcm9wZXJ0eScsCiAgICAgICAgdW50aWw6ICc0LjAuMCcsCiAgICAgICAgdXJsOiAnaHR0cHM6Ly9lbWJlcmpzLmNvbS9kZXByZWNhdGlvbnMvdjMueCN0b2NfY29tcHV0ZWQtcHJvcGVydHktcHJvcGVydHknCiAgICAgIH0pKTsKCiAgICAgIHRoaXMuX3Byb3BlcnR5LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwoKICAgIF9wcm90bzcuX3Byb3BlcnR5ID0gZnVuY3Rpb24gX3Byb3BlcnR5KCkgewogICAgICB2YXIgYXJncyA9IFtdOwoKICAgICAgZnVuY3Rpb24gYWRkQXJnKHByb3BlcnR5KSB7CiAgICAgICAgKGZhbHNlICYmICgwLCBfZGVidWcud2FybikoIkRlcGVuZGVudCBrZXlzIGNvbnRhaW5pbmcgQGVhY2ggb25seSB3b3JrIG9uZSBsZXZlbCBkZWVwLiAiICsgKCJZb3UgdXNlZCB0aGUga2V5IFwiIiArIHByb3BlcnR5ICsgIlwiIHdoaWNoIGlzIGludmFsaWQuICIpICsgIlBsZWFzZSBjcmVhdGUgYW4gaW50ZXJtZWRpYXJ5IGNvbXB1dGVkIHByb3BlcnR5LiIsIERFRVBfRUFDSF9SRUdFWC50ZXN0KHByb3BlcnR5KSA9PT0gZmFsc2UsIHsKICAgICAgICAgIGlkOiAnZW1iZXItbWV0YWwuY29tcHV0ZWQtZGVlcC1lYWNoJwogICAgICAgIH0pKTsKICAgICAgICBhcmdzLnB1c2gocHJvcGVydHkpOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIGV4cGFuZFByb3BlcnRpZXMoaSA8IDAgfHwgYXJndW1lbnRzLmxlbmd0aCA8PSBpID8gdW5kZWZpbmVkIDogYXJndW1lbnRzW2ldLCBhZGRBcmcpOwogICAgICB9CgogICAgICB0aGlzLl9kZXBlbmRlbnRLZXlzID0gYXJnczsKICAgIH0KICAgIC8qKgogICAgICBJbiBzb21lIGNhc2VzLCB5b3UgbWF5IHdhbnQgdG8gYW5ub3RhdGUgY29tcHV0ZWQgcHJvcGVydGllcyB3aXRoIGFkZGl0aW9uYWwKICAgICAgbWV0YWRhdGEgYWJvdXQgaG93IHRoZXkgZnVuY3Rpb24gb3Igd2hhdCB2YWx1ZXMgdGhleSBvcGVyYXRlIG9uLiBGb3IgZXhhbXBsZSwKICAgICAgY29tcHV0ZWQgcHJvcGVydHkgZnVuY3Rpb25zIG1heSBjbG9zZSBvdmVyIHZhcmlhYmxlcyB0aGF0IGFyZSB0aGVuIG5vIGxvbmdlcgogICAgICBhdmFpbGFibGUgZm9yIGludHJvc3BlY3Rpb24uCiAgICAgIFlvdSBjYW4gcGFzcyBhIGhhc2ggb2YgdGhlc2UgdmFsdWVzIHRvIGEgY29tcHV0ZWQgcHJvcGVydHkgbGlrZSB0aGlzOgogICAgICBgYGAKICAgICAgaW1wb3J0IHsgY29tcHV0ZWQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICAgaW1wb3J0IFBlcnNvbiBmcm9tICdteS1hcHAvdXRpbHMvcGVyc29uJzsKICAgICAgcGVyc29uOiBjb21wdXRlZChmdW5jdGlvbigpIHsKICAgICAgICBsZXQgcGVyc29uSWQgPSB0aGlzLmdldCgncGVyc29uSWQnKTsKICAgICAgICByZXR1cm4gUGVyc29uLmNyZWF0ZSh7IGlkOiBwZXJzb25JZCB9KTsKICAgICAgfSkubWV0YSh7IHR5cGU6IFBlcnNvbiB9KQogICAgICBgYGAKICAgICAgVGhlIGhhc2ggdGhhdCB5b3UgcGFzcyB0byB0aGUgYG1ldGEoKWAgZnVuY3Rpb24gd2lsbCBiZSBzYXZlZCBvbiB0aGUKICAgICAgY29tcHV0ZWQgcHJvcGVydHkgZGVzY3JpcHRvciB1bmRlciB0aGUgYF9tZXRhYCBrZXkuIEVtYmVyIHJ1bnRpbWUKICAgICAgZXhwb3NlcyBhIHB1YmxpYyBBUEkgZm9yIHJldHJpZXZpbmcgdGhlc2UgdmFsdWVzIGZyb20gY2xhc3NlcywKICAgICAgdmlhIHRoZSBgbWV0YUZvclByb3BlcnR5KClgIGZ1bmN0aW9uLgogICAgICBAbWV0aG9kIG1ldGEKICAgICAgQHBhcmFtIHtPYmplY3R9IG1ldGEKICAgICAgQGNoYWluYWJsZQogICAgICBAcHVibGljCiAgICAqLwogICAgLy8gaW52YWxpZGF0ZSBjYWNoZSB3aGVuIENQIGtleSBjaGFuZ2VzCiAgICA7CgogICAgX3Byb3RvNy5kaWRDaGFuZ2UgPSBmdW5jdGlvbiBkaWRDaGFuZ2Uob2JqLCBrZXlOYW1lKSB7CiAgICAgIC8vIF9zdXNwZW5kZWQgaXMgc2V0IHZpYSBhIENQLnNldCB0byBlbnN1cmUgd2UgZG9uJ3QgY2xlYXIKICAgICAgLy8gdGhlIGNhY2hlZCB2YWx1ZSBzZXQgYnkgdGhlIHNldHRlcgogICAgICBpZiAodGhpcy5fdm9sYXRpbGUgfHwgdGhpcy5fc3VzcGVuZGVkID09PSBvYmopIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gZG9uJ3QgY3JlYXRlIG9iamVjdHMganVzdCB0byBpbnZhbGlkYXRlCgoKICAgICAgdmFyIG1ldGEkJDEgPSAoMCwgX21ldGEyLnBlZWtNZXRhKShvYmopOwoKICAgICAgaWYgKG1ldGEkJDEgPT09IG51bGwgfHwgbWV0YSQkMS5zb3VyY2UgIT09IG9iaikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGNhY2hlID0gcGVla0NhY2hlRm9yKG9iaik7CgogICAgICBpZiAoY2FjaGUgIT09IHVuZGVmaW5lZCAmJiBjYWNoZS5kZWxldGUoa2V5TmFtZSkpIHsKICAgICAgICByZW1vdmVEZXBlbmRlbnRLZXlzKHRoaXMsIG9iaiwga2V5TmFtZSwgbWV0YSQkMSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNy5nZXQgPSBmdW5jdGlvbiBnZXQob2JqLCBrZXlOYW1lKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgaWYgKHRoaXMuX3ZvbGF0aWxlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2dldHRlci5jYWxsKG9iaiwga2V5TmFtZSk7CiAgICAgIH0KCiAgICAgIHZhciBjYWNoZSA9IGdldENhY2hlRm9yKG9iaik7CiAgICAgIHsKICAgICAgICB2YXIgcHJvcGVydHlUYWcgPSB0YWdGb3JQcm9wZXJ0eShvYmosIGtleU5hbWUpOwogICAgICAgIHZhciByZXQ7CgogICAgICAgIGlmIChjYWNoZS5oYXMoa2V5TmFtZSkgJiYgKDAsIF9yZWZlcmVuY2UudmFsaWRhdGUpKHByb3BlcnR5VGFnLCBnZXRMYXN0UmV2aXNpb25Gb3Iob2JqLCBrZXlOYW1lKSkpIHsKICAgICAgICAgIHJldCA9IGNhY2hlLmdldChrZXlOYW1lKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gRm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCB3ZSBvbmx5IHRocm93IGlmIHRoZSBDUCBoYXMgYW55IGRlcGVuZGVuY2llcy4gQ1BzIHdpdGhvdXQgZGVwZW5kZW5jaWVzCiAgICAgICAgICAvLyBzaG91bGQgYmUgYWxsb3dlZCwgZXZlbiBhZnRlciB0aGUgb2JqZWN0IGhhcyBiZWVuIGRlc3Ryb3llZCwgd2hpY2ggaXMgd2h5IHdlIGNoZWNrIF9kZXBlbmRlbnRLZXlzLgogICAgICAgICAgKGZhbHNlICYmICEodGhpcy5fZGVwZW5kZW50S2V5cyA9PT0gdW5kZWZpbmVkIHx8ICEoMCwgX21ldGEyLm1ldGEpKG9iaikuaXNNZXRhRGVzdHJveWVkKCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQXR0ZW1wdGVkIHRvIGFjY2VzcyB0aGUgY29tcHV0ZWQgIiArIG9iaiArICIuIiArIGtleU5hbWUgKyAiIG9uIGEgZGVzdHJveWVkIG9iamVjdCwgd2hpY2ggaXMgbm90IGFsbG93ZWQiLCB0aGlzLl9kZXBlbmRlbnRLZXlzID09PSB1bmRlZmluZWQgfHwgISgwLCBfbWV0YTIubWV0YSkob2JqKS5pc01ldGFEZXN0cm95ZWQoKSkpOwogICAgICAgICAgdmFyIHVwc3RyZWFtVGFnID0gdW5kZWZpbmVkOwoKICAgICAgICAgIGlmICh0aGlzLl9hdXRvID09PSB0cnVlKSB7CiAgICAgICAgICAgIHVwc3RyZWFtVGFnID0gdHJhY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldCA9IF90aGlzMy5fZ2V0dGVyLmNhbGwob2JqLCBrZXlOYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBDcmVhdGUgYSB0cmFja2VyIHRoYXQgYWJzb3JicyBhbnkgdHJhY2thYmxlIGFjdGlvbnMgaW5zaWRlIHRoZSBDUAogICAgICAgICAgICB1bnRyYWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXQgPSBfdGhpczMuX2dldHRlci5jYWxsKG9iaiwga2V5TmFtZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICh0aGlzLl9kZXBlbmRlbnRLZXlzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdmFyIHRhZyA9ICgwLCBfcmVmZXJlbmNlLmNvbWJpbmUpKGdldENoYWluVGFnc0ZvcktleXMob2JqLCB0aGlzLl9kZXBlbmRlbnRLZXlzKSk7CiAgICAgICAgICAgIHVwc3RyZWFtVGFnID0gdXBzdHJlYW1UYWcgPT09IHVuZGVmaW5lZCA/IHRhZyA6ICgwLCBfcmVmZXJlbmNlLmNvbWJpbmUpKFt1cHN0cmVhbVRhZywgdGFnXSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHVwc3RyZWFtVGFnICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgKDAsIF9yZWZlcmVuY2UudXBkYXRlKShwcm9wZXJ0eVRhZywgdXBzdHJlYW1UYWcpOwogICAgICAgICAgfQoKICAgICAgICAgIHNldExhc3RSZXZpc2lvbkZvcihvYmosIGtleU5hbWUsICgwLCBfcmVmZXJlbmNlLnZhbHVlKShwcm9wZXJ0eVRhZykpOwogICAgICAgICAgY2FjaGUuc2V0KGtleU5hbWUsIHJldCk7CiAgICAgICAgICBmaW5pc2hMYXp5Q2hhaW5zKG9iaiwga2V5TmFtZSwgcmV0KTsKICAgICAgICB9CgogICAgICAgIGNvbnN1bWUocHJvcGVydHlUYWcpOyAvLyBBZGQgdGhlIHRhZyBvZiB0aGUgcmV0dXJuZWQgdmFsdWUgaWYgaXQgaXMgYW4gYXJyYXksIHNpbmNlIGFycmF5cwogICAgICAgIC8vIHNob3VsZCBhbHdheXMgY2F1c2UgdXBkYXRlcyBpZiB0aGV5IGFyZSBjb25zdW1lZCBhbmQgdGhlbiBjaGFuZ2VkCgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJldCkgfHwgKDAsIF91dGlscy5pc0VtYmVyQXJyYXkpKHJldCkpIHsKICAgICAgICAgIGNvbnN1bWUodGFnRm9yUHJvcGVydHkocmV0LCAnW10nKSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmV0OwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzcuc2V0ID0gZnVuY3Rpb24gc2V0KG9iaiwga2V5TmFtZSwgdmFsdWUkJDEpIHsKICAgICAgaWYgKHRoaXMuX3JlYWRPbmx5KSB7CiAgICAgICAgdGhpcy5fdGhyb3dSZWFkT25seUVycm9yKG9iaiwga2V5TmFtZSk7CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5fc2V0dGVyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY2xvYmJlclNldChvYmosIGtleU5hbWUsIHZhbHVlJCQxKTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX3ZvbGF0aWxlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudm9sYXRpbGVTZXQob2JqLCBrZXlOYW1lLCB2YWx1ZSQkMSk7CiAgICAgIH0KCiAgICAgIHsKICAgICAgICB2YXIgcmV0OwoKICAgICAgICB0cnkgewogICAgICAgICAgYmVnaW5Qcm9wZXJ0eUNoYW5nZXMoKTsKICAgICAgICAgIHJldCA9IHRoaXMuX3NldChvYmosIGtleU5hbWUsIHZhbHVlJCQxKTsKICAgICAgICAgIGZpbmlzaExhenlDaGFpbnMob2JqLCBrZXlOYW1lLCByZXQpOwogICAgICAgICAgdmFyIHByb3BlcnR5VGFnID0gdGFnRm9yUHJvcGVydHkob2JqLCBrZXlOYW1lKTsKCiAgICAgICAgICBpZiAodGhpcy5fZGVwZW5kZW50S2V5cyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICgwLCBfcmVmZXJlbmNlLnVwZGF0ZSkocHJvcGVydHlUYWcsICgwLCBfcmVmZXJlbmNlLmNvbWJpbmUpKGdldENoYWluVGFnc0ZvcktleXMob2JqLCB0aGlzLl9kZXBlbmRlbnRLZXlzKSkpOwogICAgICAgICAgfQoKICAgICAgICAgIHNldExhc3RSZXZpc2lvbkZvcihvYmosIGtleU5hbWUsICgwLCBfcmVmZXJlbmNlLnZhbHVlKShwcm9wZXJ0eVRhZykpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBlbmRQcm9wZXJ0eUNoYW5nZXMoKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNy5fdGhyb3dSZWFkT25seUVycm9yID0gZnVuY3Rpb24gX3Rocm93UmVhZE9ubHlFcnJvcihvYmosIGtleU5hbWUpIHsKICAgICAgdGhyb3cgbmV3IF9lcnJvci5kZWZhdWx0KCJDYW5ub3Qgc2V0IHJlYWQtb25seSBwcm9wZXJ0eSBcIiIgKyBrZXlOYW1lICsgIlwiIG9uIG9iamVjdDogIiArICgwLCBfdXRpbHMuaW5zcGVjdCkob2JqKSk7CiAgICB9OwoKICAgIF9wcm90bzcuY2xvYmJlclNldCA9IGZ1bmN0aW9uIGNsb2JiZXJTZXQob2JqLCBrZXlOYW1lLCB2YWx1ZSQkMSkgewogICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCJUaGUgIiArICgwLCBfdXRpbHMudG9TdHJpbmcpKG9iaikgKyAiIyIgKyBrZXlOYW1lICsgIiBjb21wdXRlZCBwcm9wZXJ0eSB3YXMganVzdCBvdmVycmlkZW4uIFRoaXMgcmVtb3ZlcyB0aGUgY29tcHV0ZWQgcHJvcGVydHkgYW5kIHJlcGxhY2VzIGl0IHdpdGggYSBwbGFpbiB2YWx1ZSwgYW5kIGhhcyBiZWVuIGRlcHJlY2F0ZWQuIElmIHlvdSB3YW50IHRoaXMgYmVoYXZpb3IsIGNvbnNpZGVyIGRlZmluaW5nIGEgc2V0dGVyIHdoaWNoIGRvZXMgaXQgbWFudWFsbHkuIiwgZmFsc2UsIHsKICAgICAgICBpZDogJ2NvbXB1dGVkLXByb3BlcnR5Lm92ZXJyaWRlJywKICAgICAgICB1bnRpbDogJzQuMC4wJywKICAgICAgICB1cmw6ICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92My54I3RvY19jb21wdXRlZC1wcm9wZXJ0eS1vdmVycmlkZScKICAgICAgfSkpOwogICAgICB2YXIgY2FjaGVkVmFsdWUgPSBnZXRDYWNoZWRWYWx1ZUZvcihvYmosIGtleU5hbWUpOwogICAgICBkZWZpbmVQcm9wZXJ0eShvYmosIGtleU5hbWUsIG51bGwsIGNhY2hlZFZhbHVlKTsKCiAgICAgIF9zZXQyKG9iaiwga2V5TmFtZSwgdmFsdWUkJDEpOwoKICAgICAgcmV0dXJuIHZhbHVlJCQxOwogICAgfTsKCiAgICBfcHJvdG83LnZvbGF0aWxlU2V0ID0gZnVuY3Rpb24gdm9sYXRpbGVTZXQob2JqLCBrZXlOYW1lLCB2YWx1ZSQkMSkgewogICAgICByZXR1cm4gdGhpcy5fc2V0dGVyLmNhbGwob2JqLCBrZXlOYW1lLCB2YWx1ZSQkMSk7CiAgICB9OwoKICAgIF9wcm90bzcuc2V0V2l0aFN1c3BlbmQgPSBmdW5jdGlvbiBzZXRXaXRoU3VzcGVuZChvYmosIGtleU5hbWUsIHZhbHVlJCQxKSB7CiAgICAgIHZhciBvbGRTdXNwZW5kZWQgPSB0aGlzLl9zdXNwZW5kZWQ7CiAgICAgIHRoaXMuX3N1c3BlbmRlZCA9IG9iajsKCiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3NldChvYmosIGtleU5hbWUsIHZhbHVlJCQxKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICB0aGlzLl9zdXNwZW5kZWQgPSBvbGRTdXNwZW5kZWQ7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNy5fc2V0ID0gZnVuY3Rpb24gX3NldChvYmosIGtleU5hbWUsIHZhbHVlJCQxKSB7CiAgICAgIHZhciBjYWNoZSA9IGdldENhY2hlRm9yKG9iaik7CiAgICAgIHZhciBoYWRDYWNoZWRWYWx1ZSA9IGNhY2hlLmhhcyhrZXlOYW1lKTsKICAgICAgdmFyIGNhY2hlZFZhbHVlID0gY2FjaGUuZ2V0KGtleU5hbWUpOwogICAgICB2YXIgcmV0OwogICAgICB7CiAgICAgICAgc2V0T2JzZXJ2ZXJTdXNwZW5kZWQob2JqLCBrZXlOYW1lLCB0cnVlKTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldCA9IHRoaXMuX3NldHRlci5jYWxsKG9iaiwga2V5TmFtZSwgdmFsdWUkJDEsIGNhY2hlZFZhbHVlKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgc2V0T2JzZXJ2ZXJTdXNwZW5kZWQob2JqLCBrZXlOYW1lLCBmYWxzZSk7CiAgICAgICAgfQogICAgICB9IC8vIGFsbG93cyBzZXR0ZXIgdG8gcmV0dXJuIHRoZSBzYW1lIHZhbHVlIHRoYXQgaXMgY2FjaGVkIGFscmVhZHkKCiAgICAgIGlmIChoYWRDYWNoZWRWYWx1ZSAmJiBjYWNoZWRWYWx1ZSA9PT0gcmV0KSB7CiAgICAgICAgcmV0dXJuIHJldDsKICAgICAgfQoKICAgICAgdmFyIG1ldGEkJDEgPSAoMCwgX21ldGEyLm1ldGEpKG9iaik7CiAgICAgIGNhY2hlLnNldChrZXlOYW1lLCByZXQpOwogICAgICBub3RpZnlQcm9wZXJ0eUNoYW5nZShvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgICByZXR1cm4gcmV0OwogICAgfQogICAgLyogY2FsbGVkIGJlZm9yZSBwcm9wZXJ0eSBpcyBvdmVycmlkZGVuICovCiAgICA7CgogICAgX3Byb3RvNy50ZWFyZG93biA9IGZ1bmN0aW9uIHRlYXJkb3duKG9iaiwga2V5TmFtZSwgbWV0YSQkMSkgewogICAgICBpZiAoIXRoaXMuX3ZvbGF0aWxlKSB7CiAgICAgICAgdmFyIGNhY2hlID0gcGVla0NhY2hlRm9yKG9iaik7CgogICAgICAgIGlmIChjYWNoZSAhPT0gdW5kZWZpbmVkICYmIGNhY2hlLmRlbGV0ZShrZXlOYW1lKSkgewogICAgICAgICAgcmVtb3ZlRGVwZW5kZW50S2V5cyh0aGlzLCBvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgX0NvbXB1dGVkRGVzY3JpcHRvci5wcm90b3R5cGUudGVhcmRvd24uY2FsbCh0aGlzLCBvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgfTsKCiAgICByZXR1cm4gQ29tcHV0ZWRQcm9wZXJ0eTsKICB9KENvbXB1dGVkRGVzY3JpcHRvcik7CgogIF9leHBvcnRzLkNvbXB1dGVkUHJvcGVydHkgPSBDb21wdXRlZFByb3BlcnR5OwogIHsKICAgIENvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlLmF1dG8gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX2F1dG8gPSB0cnVlOwogICAgfTsKICB9IC8vIFRPRE86IFRoaXMgY2xhc3MgY2FuIGJlIHN2ZWx0ZWQgb25jZSBgbWV0YWAgaGFzIGJlZW4gZGVwcmVjYXRlZAoKICB2YXIgQ29tcHV0ZWREZWNvcmF0b3JJbXBsID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9GdW5jdGlvbikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKENvbXB1dGVkRGVjb3JhdG9ySW1wbCwgX0Z1bmN0aW9uKTsKCiAgICBmdW5jdGlvbiBDb21wdXRlZERlY29yYXRvckltcGwoKSB7CiAgICAgIHJldHVybiBfRnVuY3Rpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG84ID0gQ29tcHV0ZWREZWNvcmF0b3JJbXBsLnByb3RvdHlwZTsKCiAgICBfcHJvdG84LnJlYWRPbmx5ID0gZnVuY3Rpb24gcmVhZE9ubHkoKSB7CiAgICAgIGRlc2NyaXB0b3JGb3JEZWNvcmF0b3IodGhpcykucmVhZE9ubHkoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIF9wcm90bzgudm9sYXRpbGUgPSBmdW5jdGlvbiB2b2xhdGlsZSgpIHsKICAgICAgZGVzY3JpcHRvckZvckRlY29yYXRvcih0aGlzKS52b2xhdGlsZSgpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgX3Byb3RvOC5wcm9wZXJ0eSA9IGZ1bmN0aW9uIHByb3BlcnR5KCkgewogICAgICB2YXIgX2Rlc2NyaXB0b3JGb3JEZWNvcmF0OwoKICAgICAgKF9kZXNjcmlwdG9yRm9yRGVjb3JhdCA9IGRlc2NyaXB0b3JGb3JEZWNvcmF0b3IodGhpcykpLnByb3BlcnR5LmFwcGx5KF9kZXNjcmlwdG9yRm9yRGVjb3JhdCwgYXJndW1lbnRzKTsKCiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICBfcHJvdG84Lm1ldGEgPSBmdW5jdGlvbiBtZXRhKG1ldGEkJDEpIHsKICAgICAgdmFyIHByb3AgPSBkZXNjcmlwdG9yRm9yRGVjb3JhdG9yKHRoaXMpOwoKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gcHJvcC5fbWV0YSB8fCB7fTsKICAgICAgfSBlbHNlIHsKICAgICAgICBwcm9wLl9tZXRhID0gbWV0YSQkMTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgfSAvLyBUT0RPOiBSZW1vdmUgdGhpcyB3aGVuIHdlIGNhbiBwcm92aWRlIGFsdGVybmF0aXZlcyBpbiB0aGUgZWNvc3lzdGVtIHRvCiAgICAvLyBhZGRvbnMgc3VjaCBhcyBlbWJlci1tYWNyby1oZWxwZXJzIHRoYXQgdXNlIGl0LgogICAgOwoKICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoQ29tcHV0ZWREZWNvcmF0b3JJbXBsLCBbewogICAgICBrZXk6ICJfZ2V0dGVyIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIGRlc2NyaXB0b3JGb3JEZWNvcmF0b3IodGhpcykuX2dldHRlcjsKICAgICAgfSAvLyBUT0RPOiBSZWZhY3RvciB0aGlzLCB0aGlzIGlzIGFuIGludGVybmFsIEFQSSBvbmx5CgogICAgfSwgewogICAgICBrZXk6ICJlbnVtZXJhYmxlIiwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQodmFsdWUkJDEpIHsKICAgICAgICBkZXNjcmlwdG9yRm9yRGVjb3JhdG9yKHRoaXMpLmVudW1lcmFibGUgPSB2YWx1ZSQkMTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIENvbXB1dGVkRGVjb3JhdG9ySW1wbDsKICB9KCgwLCBfZW1iZXJCYWJlbC53cmFwTmF0aXZlU3VwZXIpKEZ1bmN0aW9uKSk7CgogIGZ1bmN0aW9uIGNvbXB1dGVkKCkgewogICAgZm9yICh2YXIgX2xlbjMgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4zKSwgX2tleTQgPSAwOyBfa2V5NCA8IF9sZW4zOyBfa2V5NCsrKSB7CiAgICAgIGFyZ3NbX2tleTRdID0gYXJndW1lbnRzW19rZXk0XTsKICAgIH0KCiAgICAoZmFsc2UgJiYgISghKGlzRWxlbWVudERlc2NyaXB0b3IoYXJncy5zbGljZSgwLCAzKSkgJiYgYXJncy5sZW5ndGggPT09IDUgJiYgYXJnc1s0XSA9PT0gdHJ1ZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQGNvbXB1dGVkIGNhbiBvbmx5IGJlIHVzZWQgZGlyZWN0bHkgYXMgYSBuYXRpdmUgZGVjb3JhdG9yLiBJZiB5b3UncmUgdXNpbmcgdHJhY2tlZCBpbiBjbGFzc2ljIGNsYXNzZXMsIGFkZCBwYXJlbnRoZXNpcyB0byBjYWxsIGl0IGxpa2UgYSBmdW5jdGlvbjogY29tcHV0ZWQoKSIsICEoaXNFbGVtZW50RGVzY3JpcHRvcihhcmdzLnNsaWNlKDAsIDMpKSAmJiBhcmdzLmxlbmd0aCA9PT0gNSAmJiBhcmdzWzRdID09PSB0cnVlKSkpOwoKICAgIGlmIChpc0VsZW1lbnREZXNjcmlwdG9yKGFyZ3MpKSB7CiAgICAgIHZhciBkZWNvcmF0b3IgPSBtYWtlQ29tcHV0ZWREZWNvcmF0b3IobmV3IENvbXB1dGVkUHJvcGVydHkoW10pLCBDb21wdXRlZERlY29yYXRvckltcGwpOwogICAgICByZXR1cm4gZGVjb3JhdG9yKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0pOwogICAgfQoKICAgIHJldHVybiBtYWtlQ29tcHV0ZWREZWNvcmF0b3IobmV3IENvbXB1dGVkUHJvcGVydHkoYXJncyksIENvbXB1dGVkRGVjb3JhdG9ySW1wbCk7CiAgfQogIC8qKgogICAgQWxsb3dzIGNoZWNraW5nIGlmIGEgZ2l2ZW4gcHJvcGVydHkgb24gYW4gb2JqZWN0IGlzIGEgY29tcHV0ZWQgcHJvcGVydHkuIEZvciB0aGUgbW9zdCBwYXJ0LAogICAgdGhpcyBkb2Vzbid0IG1hdHRlciAoeW91IHdvdWxkIG5vcm1hbGx5IGp1c3QgYWNjZXNzIHRoZSBwcm9wZXJ0eSBkaXJlY3RseSBhbmQgdXNlIGl0cyB2YWx1ZSksCiAgICBidXQgZm9yIHNvbWUgdG9vbGluZyBzcGVjaWZpYyBzY2VuYXJpb3MgKGUuZy4gdGhlIGVtYmVyLWluc3BlY3RvcikgaXQgaXMgaW1wb3J0YW50IHRvCiAgICBkaWZmZXJlbnRpYXRlIGlmIGEgcHJvcGVydHkgaXMgYSBjb21wdXRlZCBwcm9wZXJ0eSBvciBhICJub3JtYWwiIHByb3BlcnR5LgogIAogICAgVGhpcyB3aWxsIHdvcmsgb24gZWl0aGVyIGEgY2xhc3MncyBwcm90b3R5cGUgb3IgYW4gaW5zdGFuY2UgaXRzZWxmLgogIAogICAgQHN0YXRpYwogICAgQG1ldGhvZCBpc0NvbXB1dGVkCiAgICBAZm9yIEBlbWJlci9kZWJ1ZwogICAgQHByaXZhdGUKICAgKi8KCgogIGZ1bmN0aW9uIGlzQ29tcHV0ZWQob2JqLCBrZXkpIHsKICAgIHJldHVybiBCb29sZWFuKGRlc2NyaXB0b3JGb3JQcm9wZXJ0eShvYmosIGtleSkpOwogIH0KCiAgdmFyIF9nbG9iYWxzQ29tcHV0ZWQgPSBjb21wdXRlZC5iaW5kKG51bGwpOwoKICBfZXhwb3J0cy5fZ2xvYmFsc0NvbXB1dGVkID0gX2dsb2JhbHNDb21wdXRlZDsKICB2YXIgQ09OU1VNRUQgPSBPYmplY3QuZnJlZXplKHt9KTsKCiAgZnVuY3Rpb24gYWxpYXMoYWx0S2V5KSB7CiAgICAoZmFsc2UgJiYgISghaXNFbGVtZW50RGVzY3JpcHRvcihBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgYXR0ZW1wdGVkIHRvIHVzZSBAYWxpYXMgYXMgYSBkZWNvcmF0b3IgZGlyZWN0bHksIGJ1dCBpdCByZXF1aXJlcyBhIGBhbHRLZXlgIHBhcmFtZXRlcicsICFpc0VsZW1lbnREZXNjcmlwdG9yKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKSk7CiAgICByZXR1cm4gbWFrZUNvbXB1dGVkRGVjb3JhdG9yKG5ldyBBbGlhc2VkUHJvcGVydHkoYWx0S2V5KSwgQWxpYXNEZWNvcmF0b3JJbXBsKTsKICB9IC8vIFRPRE86IFRoaXMgY2xhc3MgY2FuIGJlIHN2ZWx0ZWQgb25jZSBgbWV0YWAgaGFzIGJlZW4gZGVwcmVjYXRlZAoKCiAgdmFyIEFsaWFzRGVjb3JhdG9ySW1wbCA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfRnVuY3Rpb24yKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoQWxpYXNEZWNvcmF0b3JJbXBsLCBfRnVuY3Rpb24yKTsKCiAgICBmdW5jdGlvbiBBbGlhc0RlY29yYXRvckltcGwoKSB7CiAgICAgIHJldHVybiBfRnVuY3Rpb24yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgIH0KCiAgICB2YXIgX3Byb3RvOSA9IEFsaWFzRGVjb3JhdG9ySW1wbC5wcm90b3R5cGU7CgogICAgX3Byb3RvOS5yZWFkT25seSA9IGZ1bmN0aW9uIHJlYWRPbmx5KCkgewogICAgICBkZXNjcmlwdG9yRm9yRGVjb3JhdG9yKHRoaXMpLnJlYWRPbmx5KCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICBfcHJvdG85Lm9uZVdheSA9IGZ1bmN0aW9uIG9uZVdheSgpIHsKICAgICAgZGVzY3JpcHRvckZvckRlY29yYXRvcih0aGlzKS5vbmVXYXkoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIF9wcm90bzkubWV0YSA9IGZ1bmN0aW9uIG1ldGEobWV0YSQkMSkgewogICAgICB2YXIgcHJvcCA9IGRlc2NyaXB0b3JGb3JEZWNvcmF0b3IodGhpcyk7CgogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiBwcm9wLl9tZXRhIHx8IHt9OwogICAgICB9IGVsc2UgewogICAgICAgIHByb3AuX21ldGEgPSBtZXRhJCQxOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBBbGlhc0RlY29yYXRvckltcGw7CiAgfSgoMCwgX2VtYmVyQmFiZWwud3JhcE5hdGl2ZVN1cGVyKShGdW5jdGlvbikpOwoKICB2YXIgQWxpYXNlZFByb3BlcnR5ID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9Db21wdXRlZERlc2NyaXB0b3IyKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoQWxpYXNlZFByb3BlcnR5LCBfQ29tcHV0ZWREZXNjcmlwdG9yMik7CgogICAgZnVuY3Rpb24gQWxpYXNlZFByb3BlcnR5KGFsdEtleSkgewogICAgICB2YXIgX3RoaXM0OwoKICAgICAgX3RoaXM0ID0gX0NvbXB1dGVkRGVzY3JpcHRvcjIuY2FsbCh0aGlzKSB8fCB0aGlzOwogICAgICBfdGhpczQuYWx0S2V5ID0gYWx0S2V5OwogICAgICByZXR1cm4gX3RoaXM0OwogICAgfQoKICAgIHZhciBfcHJvdG8xMCA9IEFsaWFzZWRQcm9wZXJ0eS5wcm90b3R5cGU7CgogICAgX3Byb3RvMTAuc2V0dXAgPSBmdW5jdGlvbiBzZXR1cChvYmosIGtleU5hbWUsIHByb3BlcnR5RGVzYywgbWV0YSQkMSkgewogICAgICAoZmFsc2UgJiYgISh0aGlzLmFsdEtleSAhPT0ga2V5TmFtZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJTZXR0aW5nIGFsaWFzICciICsga2V5TmFtZSArICInIG9uIHNlbGYiLCB0aGlzLmFsdEtleSAhPT0ga2V5TmFtZSkpOwoKICAgICAgX0NvbXB1dGVkRGVzY3JpcHRvcjIucHJvdG90eXBlLnNldHVwLmNhbGwodGhpcywgb2JqLCBrZXlOYW1lLCBwcm9wZXJ0eURlc2MsIG1ldGEkJDEpOwogICAgfTsKCiAgICBfcHJvdG8xMC50ZWFyZG93biA9IGZ1bmN0aW9uIHRlYXJkb3duKG9iaiwga2V5TmFtZSwgbWV0YSQkMSkgewogICAgICBfQ29tcHV0ZWREZXNjcmlwdG9yMi5wcm90b3R5cGUudGVhcmRvd24uY2FsbCh0aGlzLCBvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgfTsKCiAgICBfcHJvdG8xMC53aWxsV2F0Y2ggPSBmdW5jdGlvbiB3aWxsV2F0Y2gob2JqLCBrZXlOYW1lLCBtZXRhJCQxKSB7fTsKCiAgICBfcHJvdG8xMC5nZXQgPSBmdW5jdGlvbiBnZXQob2JqLCBrZXlOYW1lKSB7CiAgICAgIHZhciBfdGhpczUgPSB0aGlzOwoKICAgICAgdmFyIHJldDsKICAgICAgewogICAgICAgIHZhciBwcm9wZXJ0eVRhZyA9IHRhZ0ZvclByb3BlcnR5KG9iaiwga2V5TmFtZSk7IC8vIFdlIGRvbid0IHVzZSB0aGUgdGFnIHNpbmNlIENQcyBhcmUgbm90IGF1dG9tYXRpYywgd2UganVzdCB3YW50IHRvIGF2b2lkCiAgICAgICAgLy8gYW55dGhpbmcgdHJhY2tpbmcgd2hpbGUgd2UgZ2V0IHRoZSBhbHRLZXkKCiAgICAgICAgdW50cmFjayhmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXQgPSBfZ2V0MihvYmosIF90aGlzNS5hbHRLZXkpOwogICAgICAgIH0pOwogICAgICAgIHZhciBsYXN0UmV2aXNpb24gPSBnZXRMYXN0UmV2aXNpb25Gb3Iob2JqLCBrZXlOYW1lKTsKCiAgICAgICAgaWYgKCEoMCwgX3JlZmVyZW5jZS52YWxpZGF0ZSkocHJvcGVydHlUYWcsIGxhc3RSZXZpc2lvbikpIHsKICAgICAgICAgICgwLCBfcmVmZXJlbmNlLnVwZGF0ZSkocHJvcGVydHlUYWcsICgwLCBfcmVmZXJlbmNlLmNvbWJpbmUpKGdldENoYWluVGFnc0ZvcktleShvYmosIHRoaXMuYWx0S2V5KSkpOwogICAgICAgICAgc2V0TGFzdFJldmlzaW9uRm9yKG9iaiwga2V5TmFtZSwgKDAsIF9yZWZlcmVuY2UudmFsdWUpKHByb3BlcnR5VGFnKSk7CiAgICAgICAgICBmaW5pc2hMYXp5Q2hhaW5zKG9iaiwga2V5TmFtZSwgcmV0KTsKICAgICAgICB9CgogICAgICAgIGNvbnN1bWUocHJvcGVydHlUYWcpOwogICAgICB9CiAgICAgIHJldHVybiByZXQ7CiAgICB9OwoKICAgIF9wcm90bzEwLnVuY29uc3VtZSA9IGZ1bmN0aW9uIHVuY29uc3VtZShvYmosIGtleU5hbWUsIG1ldGEkJDEpIHsKICAgICAgdmFyIHdhc0NvbnN1bWVkID0gZ2V0Q2FjaGVkVmFsdWVGb3Iob2JqLCBrZXlOYW1lKSA9PT0gQ09OU1VNRUQ7CgogICAgICBpZiAod2FzQ29uc3VtZWQgfHwgbWV0YSQkMS5wZWVrV2F0Y2hpbmcoa2V5TmFtZSkgPiAwKSB7CiAgICAgICAgcmVtb3ZlRGVwZW5kZW50S2V5cyh0aGlzLCBvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgICB9CgogICAgICBpZiAod2FzQ29uc3VtZWQpIHsKICAgICAgICBnZXRDYWNoZUZvcihvYmopLmRlbGV0ZShrZXlOYW1lKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8xMC5jb25zdW1lID0gZnVuY3Rpb24gY29uc3VtZShvYmosIGtleU5hbWUsIG1ldGEkJDEpIHsKICAgICAgdmFyIGNhY2hlID0gZ2V0Q2FjaGVGb3Iob2JqKTsKCiAgICAgIGlmIChjYWNoZS5nZXQoa2V5TmFtZSkgIT09IENPTlNVTUVEKSB7CiAgICAgICAgY2FjaGUuc2V0KGtleU5hbWUsIENPTlNVTUVEKTsKICAgICAgICBhZGREZXBlbmRlbnRLZXlzKHRoaXMsIG9iaiwga2V5TmFtZSwgbWV0YSQkMSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMTAuc2V0ID0gZnVuY3Rpb24gc2V0KG9iaiwgX2tleU5hbWUsIHZhbHVlJCQxKSB7CiAgICAgIHJldHVybiBfc2V0MihvYmosIHRoaXMuYWx0S2V5LCB2YWx1ZSQkMSk7CiAgICB9OwoKICAgIF9wcm90bzEwLnJlYWRPbmx5ID0gZnVuY3Rpb24gcmVhZE9ubHkoKSB7CiAgICAgIHRoaXMuc2V0ID0gQWxpYXNlZFByb3BlcnR5X3JlYWRPbmx5U2V0OwogICAgfTsKCiAgICBfcHJvdG8xMC5vbmVXYXkgPSBmdW5jdGlvbiBvbmVXYXkoKSB7CiAgICAgIHRoaXMuc2V0ID0gQWxpYXNlZFByb3BlcnR5X29uZVdheVNldDsKICAgIH07CgogICAgcmV0dXJuIEFsaWFzZWRQcm9wZXJ0eTsKICB9KENvbXB1dGVkRGVzY3JpcHRvcik7CgogIGZ1bmN0aW9uIEFsaWFzZWRQcm9wZXJ0eV9yZWFkT25seVNldChvYmosIGtleU5hbWUpIHsKICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW51c2VkLXZhcnMKICAgIHRocm93IG5ldyBfZXJyb3IuZGVmYXVsdCgiQ2Fubm90IHNldCByZWFkLW9ubHkgcHJvcGVydHkgJyIgKyBrZXlOYW1lICsgIicgb24gb2JqZWN0OiAiICsgKDAsIF91dGlscy5pbnNwZWN0KShvYmopKTsKICB9CgogIGZ1bmN0aW9uIEFsaWFzZWRQcm9wZXJ0eV9vbmVXYXlTZXQob2JqLCBrZXlOYW1lLCB2YWx1ZSQkMSkgewogICAgZGVmaW5lUHJvcGVydHkob2JqLCBrZXlOYW1lLCBudWxsKTsKICAgIHJldHVybiBfc2V0MihvYmosIGtleU5hbWUsIHZhbHVlJCQxKTsKICB9CiAgLyoqCiAgQG1vZHVsZSBlbWJlcgogICovCgogIC8qKgogICAgVXNlZCBpbnRlcm5hbGx5IHRvIGFsbG93IGNoYW5naW5nIHByb3BlcnRpZXMgaW4gYSBiYWNrd2FyZHMgY29tcGF0aWJsZSB3YXksIGFuZCBwcmludCBhIGhlbHBmdWwKICAgIGRlcHJlY2F0aW9uIHdhcm5pbmcuCiAgCiAgICBAbWV0aG9kIGRlcHJlY2F0ZVByb3BlcnR5CiAgICBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gYWRkIHRoZSBkZXByZWNhdGVkIHByb3BlcnR5IHRvLgogICAgQHBhcmFtIHtTdHJpbmd9IGRlcHJlY2F0ZWRLZXkgVGhlIHByb3BlcnR5IHRvIGFkZCAoYW5kIHByaW50IGRlcHJlY2F0aW9uIHdhcm5pbmdzIHVwb24gYWNjZXNzaW5nKS4KICAgIEBwYXJhbSB7U3RyaW5nfSBuZXdLZXkgVGhlIHByb3BlcnR5IHRoYXQgd2lsbCBiZSBhbGlhc2VkLgogICAgQHByaXZhdGUKICAgIEBzaW5jZSAxLjcuMAogICovCgoKICBmdW5jdGlvbiBkZXByZWNhdGVQcm9wZXJ0eShvYmplY3QsIGRlcHJlY2F0ZWRLZXksIG5ld0tleSwgb3B0aW9ucykgewogICAgZnVuY3Rpb24gX2RlcHJlY2F0ZSgpIHsKICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgiVXNhZ2Ugb2YgYCIgKyBkZXByZWNhdGVkS2V5ICsgImAgaXMgZGVwcmVjYXRlZCwgdXNlIGAiICsgbmV3S2V5ICsgImAgaW5zdGVhZC4iLCBmYWxzZSwgb3B0aW9ucykpOwogICAgfQoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmplY3QsIGRlcHJlY2F0ZWRLZXksIHsKICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQodmFsdWUkJDEpIHsKICAgICAgICBfZGVwcmVjYXRlKCk7CgogICAgICAgIF9zZXQyKHRoaXMsIG5ld0tleSwgdmFsdWUkJDEpOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICBfZGVwcmVjYXRlKCk7CgogICAgICAgIHJldHVybiBfZ2V0Mih0aGlzLCBuZXdLZXkpOwogICAgICB9CiAgICB9KTsKICB9CiAgLyoqCiAgIEBtb2R1bGUgQGVtYmVyL3V0aWxzCiAgKi8KCiAgLyoqCiAgICBSZXR1cm5zIHRydWUgaWYgdGhlIHBhc3NlZCB2YWx1ZSBpcyBudWxsIG9yIHVuZGVmaW5lZC4gVGhpcyBhdm9pZHMgZXJyb3JzCiAgICBmcm9tIEpTTGludCBjb21wbGFpbmluZyBhYm91dCB1c2Ugb2YgPT0sIHdoaWNoIGNhbiBiZSB0ZWNobmljYWxseQogICAgY29uZnVzaW5nLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaXNOb25lKCk7ICAgICAgICAgICAgICAvLyB0cnVlCiAgICBpc05vbmUobnVsbCk7ICAgICAgICAgIC8vIHRydWUKICAgIGlzTm9uZSh1bmRlZmluZWQpOyAgICAgLy8gdHJ1ZQogICAgaXNOb25lKCcnKTsgICAgICAgICAgICAvLyBmYWxzZQogICAgaXNOb25lKFtdKTsgICAgICAgICAgICAvLyBmYWxzZQogICAgaXNOb25lKGZ1bmN0aW9uKCkge30pOyAvLyBmYWxzZQogICAgYGBgCiAgCiAgICBAbWV0aG9kIGlzTm9uZQogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvdXRpbHMKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogVmFsdWUgdG8gdGVzdAogICAgQHJldHVybiB7Qm9vbGVhbn0KICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gaXNOb25lKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gbnVsbCB8fCBvYmogPT09IHVuZGVmaW5lZDsKICB9CiAgLyoqCiAgIEBtb2R1bGUgQGVtYmVyL3V0aWxzCiAgKi8KCiAgLyoqCiAgICBWZXJpZmllcyB0aGF0IGEgdmFsdWUgaXMgYG51bGxgIG9yIGB1bmRlZmluZWRgLCBhbiBlbXB0eSBzdHJpbmcsIG9yIGFuIGVtcHR5CiAgICBhcnJheS4KICAKICAgIENvbnN0cmFpbnMgdGhlIHJ1bGVzIG9uIGBpc05vbmVgIGJ5IHJldHVybmluZyB0cnVlIGZvciBlbXB0eSBzdHJpbmdzIGFuZAogICAgZW1wdHkgYXJyYXlzLgogIAogICAgSWYgdGhlIHZhbHVlIGlzIGFuIG9iamVjdCB3aXRoIGEgYHNpemVgIHByb3BlcnR5IG9mIHR5cGUgbnVtYmVyLCBpdCBpcyB1c2VkCiAgICB0byBjaGVjayBlbXB0aW5lc3MuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpc0VtcHR5KCk7ICAgICAgICAgICAgICAgICAvLyB0cnVlCiAgICBpc0VtcHR5KG51bGwpOyAgICAgICAgICAgICAvLyB0cnVlCiAgICBpc0VtcHR5KHVuZGVmaW5lZCk7ICAgICAgICAvLyB0cnVlCiAgICBpc0VtcHR5KCcnKTsgICAgICAgICAgICAgICAvLyB0cnVlCiAgICBpc0VtcHR5KFtdKTsgICAgICAgICAgICAgICAvLyB0cnVlCiAgICBpc0VtcHR5KHsgc2l6ZTogMH0pOyAgICAgICAvLyB0cnVlCiAgICBpc0VtcHR5KHt9KTsgICAgICAgICAgICAgICAvLyBmYWxzZQogICAgaXNFbXB0eSgnQWRhbSBIYXdraW5zJyk7ICAgLy8gZmFsc2UKICAgIGlzRW1wdHkoWzAsMSwyXSk7ICAgICAgICAgIC8vIGZhbHNlCiAgICBpc0VtcHR5KCdcblx0Jyk7ICAgICAgICAgICAvLyBmYWxzZQogICAgaXNFbXB0eSgnICAnKTsgICAgICAgICAgICAgLy8gZmFsc2UKICAgIGlzRW1wdHkoeyBzaXplOiAxIH0pICAgICAgIC8vIGZhbHNlCiAgICBpc0VtcHR5KHsgc2l6ZTogKCkgPT4gMCB9KSAvLyBmYWxzZQogICAgYGBgCiAgCiAgICBAbWV0aG9kIGlzRW1wdHkKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL3V0aWxzCiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFZhbHVlIHRvIHRlc3QKICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIGlzRW1wdHkob2JqKSB7CiAgICB2YXIgbm9uZSA9IG9iaiA9PT0gbnVsbCB8fCBvYmogPT09IHVuZGVmaW5lZDsKCiAgICBpZiAobm9uZSkgewogICAgICByZXR1cm4gbm9uZTsKICAgIH0KCiAgICBpZiAodHlwZW9mIG9iai5zaXplID09PSAnbnVtYmVyJykgewogICAgICByZXR1cm4gIW9iai5zaXplOwogICAgfQoKICAgIHZhciBvYmplY3RUeXBlID0gdHlwZW9mIG9iajsKCiAgICBpZiAob2JqZWN0VHlwZSA9PT0gJ29iamVjdCcpIHsKICAgICAgdmFyIHNpemUgPSBfZ2V0MihvYmosICdzaXplJyk7CgogICAgICBpZiAodHlwZW9mIHNpemUgPT09ICdudW1iZXInKSB7CiAgICAgICAgcmV0dXJuICFzaXplOwogICAgICB9CiAgICB9CgogICAgaWYgKHR5cGVvZiBvYmoubGVuZ3RoID09PSAnbnVtYmVyJyAmJiBvYmplY3RUeXBlICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHJldHVybiAhb2JqLmxlbmd0aDsKICAgIH0KCiAgICBpZiAob2JqZWN0VHlwZSA9PT0gJ29iamVjdCcpIHsKICAgICAgdmFyIGxlbmd0aCA9IF9nZXQyKG9iaiwgJ2xlbmd0aCcpOwoKICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT09ICdudW1iZXInKSB7CiAgICAgICAgcmV0dXJuICFsZW5ndGg7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZmFsc2U7CiAgfQogIC8qKgogICBAbW9kdWxlIEBlbWJlci91dGlscwogICovCgogIC8qKgogICAgQSB2YWx1ZSBpcyBibGFuayBpZiBpdCBpcyBlbXB0eSBvciBhIHdoaXRlc3BhY2Ugc3RyaW5nLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgaXNCbGFuayB9IGZyb20gJ0BlbWJlci91dGlscyc7CiAgCiAgICBpc0JsYW5rKCk7ICAgICAgICAgICAgICAgIC8vIHRydWUKICAgIGlzQmxhbmsobnVsbCk7ICAgICAgICAgICAgLy8gdHJ1ZQogICAgaXNCbGFuayh1bmRlZmluZWQpOyAgICAgICAvLyB0cnVlCiAgICBpc0JsYW5rKCcnKTsgICAgICAgICAgICAgIC8vIHRydWUKICAgIGlzQmxhbmsoW10pOyAgICAgICAgICAgICAgLy8gdHJ1ZQogICAgaXNCbGFuaygnXG5cdCcpOyAgICAgICAgICAvLyB0cnVlCiAgICBpc0JsYW5rKCcgICcpOyAgICAgICAgICAgIC8vIHRydWUKICAgIGlzQmxhbmsoe30pOyAgICAgICAgICAgICAgLy8gZmFsc2UKICAgIGlzQmxhbmsoJ1xuXHQgSGVsbG8nKTsgICAgLy8gZmFsc2UKICAgIGlzQmxhbmsoJ0hlbGxvIHdvcmxkJyk7ICAgLy8gZmFsc2UKICAgIGlzQmxhbmsoWzEsMiwzXSk7ICAgICAgICAgLy8gZmFsc2UKICAgIGBgYAogIAogICAgQG1ldGhvZCBpc0JsYW5rCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci91dGlscwogICAgQHBhcmFtIHtPYmplY3R9IG9iaiBWYWx1ZSB0byB0ZXN0CiAgICBAcmV0dXJuIHtCb29sZWFufQogICAgQHNpbmNlIDEuNS4wCiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIGlzQmxhbmsob2JqKSB7CiAgICByZXR1cm4gaXNFbXB0eShvYmopIHx8IHR5cGVvZiBvYmogPT09ICdzdHJpbmcnICYmIC9cUy8udGVzdChvYmopID09PSBmYWxzZTsKICB9CiAgLyoqCiAgIEBtb2R1bGUgQGVtYmVyL3V0aWxzCiAgKi8KCiAgLyoqCiAgICBBIHZhbHVlIGlzIHByZXNlbnQgaWYgaXQgbm90IGBpc0JsYW5rYC4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGlzUHJlc2VudCgpOyAgICAgICAgICAgICAgICAvLyBmYWxzZQogICAgaXNQcmVzZW50KG51bGwpOyAgICAgICAgICAgIC8vIGZhbHNlCiAgICBpc1ByZXNlbnQodW5kZWZpbmVkKTsgICAgICAgLy8gZmFsc2UKICAgIGlzUHJlc2VudCgnJyk7ICAgICAgICAgICAgICAvLyBmYWxzZQogICAgaXNQcmVzZW50KCcgICcpOyAgICAgICAgICAgIC8vIGZhbHNlCiAgICBpc1ByZXNlbnQoJ1xuXHQnKTsgICAgICAgICAgLy8gZmFsc2UKICAgIGlzUHJlc2VudChbXSk7ICAgICAgICAgICAgICAvLyBmYWxzZQogICAgaXNQcmVzZW50KHsgbGVuZ3RoOiAwIH0pOyAgIC8vIGZhbHNlCiAgICBpc1ByZXNlbnQoZmFsc2UpOyAgICAgICAgICAgLy8gdHJ1ZQogICAgaXNQcmVzZW50KHRydWUpOyAgICAgICAgICAgIC8vIHRydWUKICAgIGlzUHJlc2VudCgnc3RyaW5nJyk7ICAgICAgICAvLyB0cnVlCiAgICBpc1ByZXNlbnQoMCk7ICAgICAgICAgICAgICAgLy8gdHJ1ZQogICAgaXNQcmVzZW50KGZ1bmN0aW9uKCkge30pOyAgIC8vIHRydWUKICAgIGlzUHJlc2VudCh7fSk7ICAgICAgICAgICAgICAvLyB0cnVlCiAgICBpc1ByZXNlbnQoJ1xuXHQgSGVsbG8nKTsgICAgLy8gdHJ1ZQogICAgaXNQcmVzZW50KFsxLCAyLCAzXSk7ICAgICAgIC8vIHRydWUKICAgIGBgYAogIAogICAgQG1ldGhvZCBpc1ByZXNlbnQKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL3V0aWxzCiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFZhbHVlIHRvIHRlc3QKICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICBAc2luY2UgMS44LjAKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gaXNQcmVzZW50KG9iaikgewogICAgcmV0dXJuICFpc0JsYW5rKG9iaik7CiAgfQogIC8qKgogICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICBIZWxwZXIgY2xhc3MgdGhhdCBhbGxvd3MgeW91IHRvIHJlZ2lzdGVyIHlvdXIgbGlicmFyeSB3aXRoIEVtYmVyLgogIAogICAgU2luZ2xldG9uIGNyZWF0ZWQgYXQgYEVtYmVyLmxpYnJhcmllc2AuCiAgCiAgICBAY2xhc3MgTGlicmFyaWVzCiAgICBAY29uc3RydWN0b3IKICAgIEBwcml2YXRlCiAgKi8KCgogIHZhciBMaWJyYXJpZXMgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBMaWJyYXJpZXMoKSB7CiAgICAgIHRoaXMuX3JlZ2lzdHJ5ID0gW107CiAgICAgIHRoaXMuX2NvcmVMaWJJbmRleCA9IDA7CiAgICB9CgogICAgdmFyIF9wcm90bzExID0gTGlicmFyaWVzLnByb3RvdHlwZTsKCiAgICBfcHJvdG8xMS5fZ2V0TGlicmFyeUJ5TmFtZSA9IGZ1bmN0aW9uIF9nZXRMaWJyYXJ5QnlOYW1lKG5hbWUpIHsKICAgICAgdmFyIGxpYnMgPSB0aGlzLl9yZWdpc3RyeTsKICAgICAgdmFyIGNvdW50ID0gbGlicy5sZW5ndGg7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICBpZiAobGlic1tpXS5uYW1lID09PSBuYW1lKSB7CiAgICAgICAgICByZXR1cm4gbGlic1tpXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9OwoKICAgIF9wcm90bzExLnJlZ2lzdGVyID0gZnVuY3Rpb24gcmVnaXN0ZXIobmFtZSwgdmVyc2lvbiwgaXNDb3JlTGlicmFyeSkgewogICAgICB2YXIgaW5kZXggPSB0aGlzLl9yZWdpc3RyeS5sZW5ndGg7CgogICAgICBpZiAoIXRoaXMuX2dldExpYnJhcnlCeU5hbWUobmFtZSkpIHsKICAgICAgICBpZiAoaXNDb3JlTGlicmFyeSkgewogICAgICAgICAgaW5kZXggPSB0aGlzLl9jb3JlTGliSW5kZXgrKzsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3JlZ2lzdHJ5LnNwbGljZShpbmRleCwgMCwgewogICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgIHZlcnNpb246IHZlcnNpb24KICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAoZmFsc2UgJiYgKDAsIF9kZWJ1Zy53YXJuKSgiTGlicmFyeSBcIiIgKyBuYW1lICsgIlwiIGlzIGFscmVhZHkgcmVnaXN0ZXJlZCB3aXRoIEVtYmVyLiIsIGZhbHNlLCB7CiAgICAgICAgICBpZDogJ2VtYmVyLW1ldGFsLmxpYnJhcmllcy1yZWdpc3RlcicKICAgICAgICB9KSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMTEucmVnaXN0ZXJDb3JlTGlicmFyeSA9IGZ1bmN0aW9uIHJlZ2lzdGVyQ29yZUxpYnJhcnkobmFtZSwgdmVyc2lvbikgewogICAgICB0aGlzLnJlZ2lzdGVyKG5hbWUsIHZlcnNpb24sIHRydWUpOwogICAgfTsKCiAgICBfcHJvdG8xMS5kZVJlZ2lzdGVyID0gZnVuY3Rpb24gZGVSZWdpc3RlcihuYW1lKSB7CiAgICAgIHZhciBsaWIgPSB0aGlzLl9nZXRMaWJyYXJ5QnlOYW1lKG5hbWUpOwoKICAgICAgdmFyIGluZGV4OwoKICAgICAgaWYgKGxpYikgewogICAgICAgIGluZGV4ID0gdGhpcy5fcmVnaXN0cnkuaW5kZXhPZihsaWIpOwoKICAgICAgICB0aGlzLl9yZWdpc3RyeS5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBMaWJyYXJpZXM7CiAgfSgpOwoKICBfZXhwb3J0cy5MaWJyYXJpZXMgPSBMaWJyYXJpZXM7CgogIGlmIChmYWxzZQogIC8qIERFQlVHICovCiAgKSB7CiAgICBMaWJyYXJpZXMucHJvdG90eXBlLmxvZ1ZlcnNpb25zID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgbGlicyA9IHRoaXMuX3JlZ2lzdHJ5OwogICAgICB2YXIgbmFtZUxlbmd0aHMgPSBsaWJzLm1hcChmdW5jdGlvbiAoaXRlbSkgewogICAgICAgIHJldHVybiBfZ2V0MihpdGVtLCAnbmFtZS5sZW5ndGgnKTsKICAgICAgfSk7CiAgICAgIHZhciBtYXhOYW1lTGVuZ3RoID0gTWF0aC5tYXguYXBwbHkobnVsbCwgbmFtZUxlbmd0aHMpOwogICAgICAoMCwgX2RlYnVnLmRlYnVnKSgnLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLScpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaWJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGxpYiA9IGxpYnNbaV07CiAgICAgICAgdmFyIHNwYWNlcyA9IG5ldyBBcnJheShtYXhOYW1lTGVuZ3RoIC0gbGliLm5hbWUubGVuZ3RoICsgMSkuam9pbignICcpOwogICAgICAgICgwLCBfZGVidWcuZGVidWcpKFtsaWIubmFtZSwgc3BhY2VzLCAnIDogJywgbGliLnZlcnNpb25dLmpvaW4oJycpKTsKICAgICAgfQoKICAgICAgKDAsIF9kZWJ1Zy5kZWJ1ZykoJy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0nKTsKICAgIH07CiAgfQoKICB2YXIgTElCUkFSSUVTID0gbmV3IExpYnJhcmllcygpOwogIF9leHBvcnRzLmxpYnJhcmllcyA9IExJQlJBUklFUzsKICBMSUJSQVJJRVMucmVnaXN0ZXJDb3JlTGlicmFyeSgnRW1iZXInLCBfdmVyc2lvbi5kZWZhdWx0KTsKICAvKioKICAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgKi8KCiAgLyoqCiAgICBUbyBnZXQgbXVsdGlwbGUgcHJvcGVydGllcyBhdCBvbmNlLCBjYWxsIGBnZXRQcm9wZXJ0aWVzYAogICAgd2l0aCBhbiBvYmplY3QgZm9sbG93ZWQgYnkgYSBsaXN0IG9mIHN0cmluZ3Mgb3IgYW4gYXJyYXk6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBnZXRQcm9wZXJ0aWVzIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBnZXRQcm9wZXJ0aWVzKHJlY29yZCwgJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScsICd6aXBDb2RlJyk7CiAgICAvLyB7IGZpcnN0TmFtZTogJ0pvaG4nLCBsYXN0TmFtZTogJ0RvZScsIHppcENvZGU6ICcxMDAxMScgfQogICAgYGBgCiAgCiAgICBpcyBlcXVpdmFsZW50IHRvOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgZ2V0UHJvcGVydGllcyB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgZ2V0UHJvcGVydGllcyhyZWNvcmQsIFsnZmlyc3ROYW1lJywgJ2xhc3ROYW1lJywgJ3ppcENvZGUnXSk7CiAgICAvLyB7IGZpcnN0TmFtZTogJ0pvaG4nLCBsYXN0TmFtZTogJ0RvZScsIHppcENvZGU6ICcxMDAxMScgfQogICAgYGBgCiAgCiAgICBAbWV0aG9kIGdldFByb3BlcnRpZXMKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL29iamVjdAogICAgQHBhcmFtIHtPYmplY3R9IG9iagogICAgQHBhcmFtIHtTdHJpbmcuLi58QXJyYXl9IGxpc3Qgb2Yga2V5cyB0byBnZXQKICAgIEByZXR1cm4ge09iamVjdH0KICAgIEBwdWJsaWMKICAqLwoKICBmdW5jdGlvbiBnZXRQcm9wZXJ0aWVzKG9iaiwga2V5cykgewogICAgdmFyIHJldCA9IHt9OwogICAgdmFyIHByb3BlcnR5TmFtZXMgPSBhcmd1bWVudHM7CiAgICB2YXIgaSA9IDE7CgogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgQXJyYXkuaXNBcnJheShrZXlzKSkgewogICAgICBpID0gMDsKICAgICAgcHJvcGVydHlOYW1lcyA9IGFyZ3VtZW50c1sxXTsKICAgIH0KCiAgICBmb3IgKDsgaSA8IHByb3BlcnR5TmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgcmV0W3Byb3BlcnR5TmFtZXNbaV1dID0gX2dldDIob2JqLCBwcm9wZXJ0eU5hbWVzW2ldKTsKICAgIH0KCiAgICByZXR1cm4gcmV0OwogIH0KICAvKioKICAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgKi8KCiAgLyoqCiAgICBTZXQgYSBsaXN0IG9mIHByb3BlcnRpZXMgb24gYW4gb2JqZWN0LiBUaGVzZSBwcm9wZXJ0aWVzIGFyZSBzZXQgaW5zaWRlCiAgICBhIHNpbmdsZSBgYmVnaW5Qcm9wZXJ0eUNoYW5nZXNgIGFuZCBgZW5kUHJvcGVydHlDaGFuZ2VzYCBiYXRjaCwgc28KICAgIG9ic2VydmVycyB3aWxsIGJlIGJ1ZmZlcmVkLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgbGV0IGFuT2JqZWN0ID0gRW1iZXJPYmplY3QuY3JlYXRlKCk7CiAgCiAgICBhbk9iamVjdC5zZXRQcm9wZXJ0aWVzKHsKICAgICAgZmlyc3ROYW1lOiAnU3RhbmxleScsCiAgICAgIGxhc3ROYW1lOiAnU3R1YXJ0JywKICAgICAgYWdlOiAyMQogICAgfSk7CiAgICBgYGAKICAKICAgIEBtZXRob2Qgc2V0UHJvcGVydGllcwogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0CiAgICBAcGFyYW0gb2JqCiAgICBAcGFyYW0ge09iamVjdH0gcHJvcGVydGllcwogICAgQHJldHVybiBwcm9wZXJ0aWVzCiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIHNldFByb3BlcnRpZXMob2JqLCBwcm9wZXJ0aWVzKSB7CiAgICBpZiAocHJvcGVydGllcyA9PT0gbnVsbCB8fCB0eXBlb2YgcHJvcGVydGllcyAhPT0gJ29iamVjdCcpIHsKICAgICAgcmV0dXJuIHByb3BlcnRpZXM7CiAgICB9CgogICAgY2hhbmdlUHJvcGVydGllcyhmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBwcm9wcyA9IE9iamVjdC5rZXlzKHByb3BlcnRpZXMpOwogICAgICB2YXIgcHJvcGVydHlOYW1lOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgewogICAgICAgIHByb3BlcnR5TmFtZSA9IHByb3BzW2ldOwoKICAgICAgICBfc2V0MihvYmosIHByb3BlcnR5TmFtZSwgcHJvcGVydGllc1twcm9wZXJ0eU5hbWVdKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcHJvcGVydGllczsKICB9IC8vIG1vdmUgaW50byBpdHMgb3duIHBhY2thZ2UKICAvLyBpdCBpcyBuZWVkZWQgYnkgTWl4aW4gZm9yIGNsYXNzVG9TdHJpbmcKICAvLyBtYXliZSBtb3ZlIGl0IGludG8gZW52aXJvbm1lbnQKCgogIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgdmFyIHNlYXJjaERpc2FibGVkID0gZmFsc2U7CiAgdmFyIGZsYWdzID0gewogICAgX3NldDogMCwKICAgIF91bnByb2Nlc3NlZE5hbWVzcGFjZXM6IGZhbHNlLAoKICAgIGdldCB1bnByb2Nlc3NlZE5hbWVzcGFjZXMoKSB7CiAgICAgIHJldHVybiB0aGlzLl91bnByb2Nlc3NlZE5hbWVzcGFjZXM7CiAgICB9LAoKICAgIHNldCB1bnByb2Nlc3NlZE5hbWVzcGFjZXModikgewogICAgICB0aGlzLl9zZXQrKzsKICAgICAgdGhpcy5fdW5wcm9jZXNzZWROYW1lc3BhY2VzID0gdjsKICAgIH0KCiAgfTsKICB2YXIgdW5wcm9jZXNzZWRNaXhpbnMgPSBmYWxzZTsKICB2YXIgTkFNRVNQQUNFUyA9IFtdOwogIF9leHBvcnRzLk5BTUVTUEFDRVMgPSBOQU1FU1BBQ0VTOwogIHZhciBOQU1FU1BBQ0VTX0JZX0lEID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICBfZXhwb3J0cy5OQU1FU1BBQ0VTX0JZX0lEID0gTkFNRVNQQUNFU19CWV9JRDsKCiAgZnVuY3Rpb24gYWRkTmFtZXNwYWNlKG5hbWVzcGFjZSkgewogICAgZmxhZ3MudW5wcm9jZXNzZWROYW1lc3BhY2VzID0gdHJ1ZTsKICAgIE5BTUVTUEFDRVMucHVzaChuYW1lc3BhY2UpOwogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlTmFtZXNwYWNlKG5hbWVzcGFjZSkgewogICAgdmFyIG5hbWUgPSAoMCwgX3V0aWxzLmdldE5hbWUpKG5hbWVzcGFjZSk7CiAgICBkZWxldGUgTkFNRVNQQUNFU19CWV9JRFtuYW1lXTsKICAgIE5BTUVTUEFDRVMuc3BsaWNlKE5BTUVTUEFDRVMuaW5kZXhPZihuYW1lc3BhY2UpLCAxKTsKCiAgICBpZiAobmFtZSBpbiBfZW52aXJvbm1lbnQuY29udGV4dC5sb29rdXAgJiYgbmFtZXNwYWNlID09PSBfZW52aXJvbm1lbnQuY29udGV4dC5sb29rdXBbbmFtZV0pIHsKICAgICAgX2Vudmlyb25tZW50LmNvbnRleHQubG9va3VwW25hbWVdID0gdW5kZWZpbmVkOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZmluZE5hbWVzcGFjZXMoKSB7CiAgICBpZiAoIWZsYWdzLnVucHJvY2Vzc2VkTmFtZXNwYWNlcykgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGxvb2t1cCA9IF9lbnZpcm9ubWVudC5jb250ZXh0Lmxvb2t1cDsKICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMobG9va3VwKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGtleSA9IGtleXNbaV07IC8vIE9ubHkgcHJvY2VzcyBlbnRpdGllcyB0aGF0IHN0YXJ0IHdpdGggdXBwZXJjYXNlIEEtWgoKICAgICAgaWYgKCFpc1VwcGVyY2FzZShrZXkuY2hhckNvZGVBdCgwKSkpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgdmFyIG9iaiA9IHRyeUlzTmFtZXNwYWNlKGxvb2t1cCwga2V5KTsKCiAgICAgIGlmIChvYmopIHsKICAgICAgICAoMCwgX3V0aWxzLnNldE5hbWUpKG9iaiwga2V5KTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZmluZE5hbWVzcGFjZShuYW1lKSB7CiAgICBpZiAoIXNlYXJjaERpc2FibGVkKSB7CiAgICAgIHByb2Nlc3NBbGxOYW1lc3BhY2VzKCk7CiAgICB9CgogICAgcmV0dXJuIE5BTUVTUEFDRVNfQllfSURbbmFtZV07CiAgfQoKICBmdW5jdGlvbiBwcm9jZXNzTmFtZXNwYWNlKG5hbWVzcGFjZSkgewogICAgX3Byb2Nlc3NOYW1lc3BhY2UoW25hbWVzcGFjZS50b1N0cmluZygpXSwgbmFtZXNwYWNlLCBuZXcgU2V0KCkpOwogIH0KCiAgZnVuY3Rpb24gcHJvY2Vzc0FsbE5hbWVzcGFjZXMoKSB7CiAgICB2YXIgdW5wcm9jZXNzZWROYW1lc3BhY2VzID0gZmxhZ3MudW5wcm9jZXNzZWROYW1lc3BhY2VzOwoKICAgIGlmICh1bnByb2Nlc3NlZE5hbWVzcGFjZXMpIHsKICAgICAgZmluZE5hbWVzcGFjZXMoKTsKICAgICAgZmxhZ3MudW5wcm9jZXNzZWROYW1lc3BhY2VzID0gZmFsc2U7CiAgICB9CgogICAgaWYgKHVucHJvY2Vzc2VkTmFtZXNwYWNlcyB8fCB1bnByb2Nlc3NlZE1peGlucykgewogICAgICB2YXIgbmFtZXNwYWNlcyA9IE5BTUVTUEFDRVM7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5hbWVzcGFjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBwcm9jZXNzTmFtZXNwYWNlKG5hbWVzcGFjZXNbaV0pOwogICAgICB9CgogICAgICB1bnByb2Nlc3NlZE1peGlucyA9IGZhbHNlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY2xhc3NUb1N0cmluZygpIHsKICAgIHZhciBuYW1lID0gKDAsIF91dGlscy5nZXROYW1lKSh0aGlzKTsKCiAgICBpZiAobmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgIHJldHVybiBuYW1lOwogICAgfQoKICAgIG5hbWUgPSBjYWxjdWxhdGVUb1N0cmluZyh0aGlzKTsKICAgICgwLCBfdXRpbHMuc2V0TmFtZSkodGhpcywgbmFtZSk7CiAgICByZXR1cm4gbmFtZTsKICB9CgogIGZ1bmN0aW9uIGlzU2VhcmNoRGlzYWJsZWQoKSB7CiAgICByZXR1cm4gc2VhcmNoRGlzYWJsZWQ7CiAgfQoKICBmdW5jdGlvbiBzZXRTZWFyY2hEaXNhYmxlZChmbGFnKSB7CiAgICBzZWFyY2hEaXNhYmxlZCA9IEJvb2xlYW4oZmxhZyk7CiAgfQoKICBmdW5jdGlvbiBzZXRVbnByb2Nlc3NlZE1peGlucygpIHsKICAgIHVucHJvY2Vzc2VkTWl4aW5zID0gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIF9wcm9jZXNzTmFtZXNwYWNlKHBhdGhzLCByb290LCBzZWVuKSB7CiAgICB2YXIgaWR4ID0gcGF0aHMubGVuZ3RoOwogICAgdmFyIGlkID0gcGF0aHMuam9pbignLicpOwogICAgTkFNRVNQQUNFU19CWV9JRFtpZF0gPSByb290OwogICAgKDAsIF91dGlscy5zZXROYW1lKShyb290LCBpZCk7IC8vIExvb3Agb3ZlciBhbGwgb2YgdGhlIGtleXMgaW4gdGhlIG5hbWVzcGFjZSwgbG9va2luZyBmb3IgY2xhc3NlcwoKICAgIGZvciAodmFyIGtleSBpbiByb290KSB7CiAgICAgIGlmICghaGFzT3duUHJvcGVydHkuY2FsbChyb290LCBrZXkpKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIHZhciBvYmogPSByb290W2tleV07IC8vIElmIHdlIGFyZSBwcm9jZXNzaW5nIHRoZSBgRW1iZXJgIG5hbWVzcGFjZSwgZm9yIGV4YW1wbGUsIHRoZQogICAgICAvLyBgcGF0aHNgIHdpbGwgc3RhcnQgd2l0aCBgWyJFbWJlciJdYC4gRXZlcnkgaXRlcmF0aW9uIHRocm91Z2gKICAgICAgLy8gdGhlIGxvb3Agd2lsbCB1cGRhdGUgdGhlICoqc2Vjb25kKiogZWxlbWVudCBvZiB0aGlzIGxpc3Qgd2l0aAogICAgICAvLyB0aGUga2V5LCBzbyBwcm9jZXNzaW5nIGBFbWJlci5WaWV3YCB3aWxsIG1ha2UgdGhlIEFycmF5CiAgICAgIC8vIGBbJ0VtYmVyJywgJ1ZpZXcnXWAuCgogICAgICBwYXRoc1tpZHhdID0ga2V5OyAvLyBJZiB3ZSBoYXZlIGZvdW5kIGFuIHVucHJvY2Vzc2VkIGNsYXNzCgogICAgICBpZiAob2JqICYmIG9iai50b1N0cmluZyA9PT0gY2xhc3NUb1N0cmluZyAmJiAoMCwgX3V0aWxzLmdldE5hbWUpKG9iaikgPT09IHZvaWQgMCkgewogICAgICAgIC8vIFJlcGxhY2UgdGhlIGNsYXNzJyBgdG9TdHJpbmdgIHdpdGggdGhlIGRvdC1zZXBhcmF0ZWQgcGF0aAogICAgICAgICgwLCBfdXRpbHMuc2V0TmFtZSkob2JqLCBwYXRocy5qb2luKCcuJykpOyAvLyBTdXBwb3J0IG5lc3RlZCBuYW1lc3BhY2VzCiAgICAgIH0gZWxzZSBpZiAob2JqICYmIG9iai5pc05hbWVzcGFjZSkgewogICAgICAgIC8vIFNraXAgYWxpYXNlZCBuYW1lc3BhY2VzCiAgICAgICAgaWYgKHNlZW4uaGFzKG9iaikpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgc2Vlbi5hZGQob2JqKTsgLy8gUHJvY2VzcyB0aGUgY2hpbGQgbmFtZXNwYWNlCgogICAgICAgIF9wcm9jZXNzTmFtZXNwYWNlKHBhdGhzLCBvYmosIHNlZW4pOwogICAgICB9CiAgICB9CgogICAgcGF0aHMubGVuZ3RoID0gaWR4OyAvLyBjdXQgb3V0IGxhc3QgaXRlbQogIH0KCiAgZnVuY3Rpb24gaXNVcHBlcmNhc2UoY29kZSkgewogICAgcmV0dXJuIGNvZGUgPj0gNjUgJiYgY29kZSA8PSA5MCAvLyBBCiAgICA7IC8vIFoKICB9CgogIGZ1bmN0aW9uIHRyeUlzTmFtZXNwYWNlKGxvb2t1cCwgcHJvcCkgewogICAgdHJ5IHsKICAgICAgdmFyIG9iaiA9IGxvb2t1cFtwcm9wXTsKICAgICAgcmV0dXJuIChvYmogIT09IG51bGwgJiYgdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJykgJiYgb2JqLmlzTmFtZXNwYWNlICYmIG9iajsKICAgIH0gY2F0Y2ggKGUpIHsvLyBjb250aW51ZQogICAgfQogIH0KCiAgZnVuY3Rpb24gY2FsY3VsYXRlVG9TdHJpbmcodGFyZ2V0KSB7CiAgICB2YXIgc3RyOwoKICAgIGlmICghc2VhcmNoRGlzYWJsZWQpIHsKICAgICAgcHJvY2Vzc0FsbE5hbWVzcGFjZXMoKTsKICAgICAgc3RyID0gKDAsIF91dGlscy5nZXROYW1lKSh0YXJnZXQpOwoKICAgICAgaWYgKHN0ciAhPT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgfQoKICAgICAgdmFyIHN1cGVyY2xhc3MgPSB0YXJnZXQ7CgogICAgICBkbyB7CiAgICAgICAgc3VwZXJjbGFzcyA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihzdXBlcmNsYXNzKTsKCiAgICAgICAgaWYgKHN1cGVyY2xhc3MgPT09IEZ1bmN0aW9uLnByb3RvdHlwZSB8fCBzdXBlcmNsYXNzID09PSBPYmplY3QucHJvdG90eXBlKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIHN0ciA9ICgwLCBfdXRpbHMuZ2V0TmFtZSkodGFyZ2V0KTsKCiAgICAgICAgaWYgKHN0ciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBzdHIgPSAiKHN1YmNsYXNzIG9mICIgKyBzdHIgKyAiKSI7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0gd2hpbGUgKHN0ciA9PT0gdm9pZCAwKTsKICAgIH0KCiAgICByZXR1cm4gc3RyIHx8ICcodW5rbm93biknOwogIH0KICAvKioKICBAbW9kdWxlIEBlbWJlci9vYmplY3QKICAqLwoKCiAgdmFyIGFfY29uY2F0ID0gQXJyYXkucHJvdG90eXBlLmNvbmNhdDsKICB2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXk7CgogIGZ1bmN0aW9uIGlzTWV0aG9kKG9iaikgewogICAgcmV0dXJuICdmdW5jdGlvbicgPT09IHR5cGVvZiBvYmogJiYgb2JqLmlzTWV0aG9kICE9PSBmYWxzZSAmJiBvYmogIT09IEJvb2xlYW4gJiYgb2JqICE9PSBPYmplY3QgJiYgb2JqICE9PSBOdW1iZXIgJiYgb2JqICE9PSBBcnJheSAmJiBvYmogIT09IERhdGUgJiYgb2JqICE9PSBTdHJpbmc7CiAgfQoKICBmdW5jdGlvbiBpc0FjY2Vzc29yKGRlc2MpIHsKICAgIHJldHVybiB0eXBlb2YgZGVzYy5nZXQgPT09ICdmdW5jdGlvbicgfHwgdHlwZW9mIGRlc2Muc2V0ID09PSAnZnVuY3Rpb24nOwogIH0KCiAgZnVuY3Rpb24gZXh0cmFjdEFjY2Vzc29ycyhwcm9wZXJ0aWVzKSB7CiAgICBpZiAocHJvcGVydGllcyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHZhciBkZXNjcmlwdG9ycyA9ICgwLCBfdXRpbHMuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycykocHJvcGVydGllcyk7CiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZGVzY3JpcHRvcnMpOwogICAgICB2YXIgaGFzQWNjZXNzb3JzID0ga2V5cy5zb21lKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICByZXR1cm4gaXNBY2Nlc3NvcihkZXNjcmlwdG9yc1trZXldKTsKICAgICAgfSk7CgogICAgICBpZiAoaGFzQWNjZXNzb3JzKSB7CiAgICAgICAgdmFyIGV4dHJhY3RlZCA9IHt9OwogICAgICAgIGtleXMuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICB2YXIgZGVzY3JpcHRvciA9IGRlc2NyaXB0b3JzW2tleV07CgogICAgICAgICAgaWYgKGlzQWNjZXNzb3IoZGVzY3JpcHRvcikpIHsKICAgICAgICAgICAgZXh0cmFjdGVkW2tleV0gPSBuYXRpdmVEZXNjRGVjb3JhdG9yKGRlc2NyaXB0b3IpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXh0cmFjdGVkW2tleV0gPSBwcm9wZXJ0aWVzW2tleV07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGV4dHJhY3RlZDsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBwcm9wZXJ0aWVzOwogIH0KCiAgdmFyIENPTlRJTlVFID0ge307CgogIGZ1bmN0aW9uIG1peGluUHJvcGVydGllcyhtaXhpbnNNZXRhLCBtaXhpbikgewogICAgaWYgKG1peGluIGluc3RhbmNlb2YgTWl4aW4pIHsKICAgICAgaWYgKG1peGluc01ldGEuaGFzTWl4aW4obWl4aW4pKSB7CiAgICAgICAgcmV0dXJuIENPTlRJTlVFOwogICAgICB9CgogICAgICBtaXhpbnNNZXRhLmFkZE1peGluKG1peGluKTsKICAgICAgcmV0dXJuIG1peGluLnByb3BlcnRpZXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbWl4aW47IC8vIGFwcGx5IGFub255bW91cyBtaXhpbiBwcm9wZXJ0aWVzCiAgICB9CiAgfQoKICBmdW5jdGlvbiBjb25jYXRlbmF0ZWRNaXhpblByb3BlcnRpZXMoY29uY2F0UHJvcCwgcHJvcHMsIHZhbHVlcywgYmFzZSkgewogICAgLy8gcmVzZXQgYmVmb3JlIGFkZGluZyBlYWNoIG5ldyBtaXhpbiB0byBwaWNrdXAgY29uY2F0cyBmcm9tIHByZXZpb3VzCiAgICB2YXIgY29uY2F0cyA9IHZhbHVlc1tjb25jYXRQcm9wXSB8fCBiYXNlW2NvbmNhdFByb3BdOwoKICAgIGlmIChwcm9wc1tjb25jYXRQcm9wXSkgewogICAgICBjb25jYXRzID0gY29uY2F0cyA/IGFfY29uY2F0LmNhbGwoY29uY2F0cywgcHJvcHNbY29uY2F0UHJvcF0pIDogcHJvcHNbY29uY2F0UHJvcF07CiAgICB9CgogICAgcmV0dXJuIGNvbmNhdHM7CiAgfQoKICBmdW5jdGlvbiBnaXZlRGVjb3JhdG9yU3VwZXIobWV0YSQkMSwga2V5LCBkZWNvcmF0b3IsIHZhbHVlcywgZGVzY3MsIGJhc2UpIHsKICAgIHZhciBwcm9wZXJ0eSA9IGRlc2NyaXB0b3JGb3JEZWNvcmF0b3IoZGVjb3JhdG9yKTsKICAgIHZhciBzdXBlclByb3BlcnR5OwoKICAgIGlmICghKHByb3BlcnR5IGluc3RhbmNlb2YgQ29tcHV0ZWRQcm9wZXJ0eSkgfHwgcHJvcGVydHkuX2dldHRlciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiBkZWNvcmF0b3I7CiAgICB9IC8vIENvbXB1dGVkIHByb3BlcnRpZXMgb3ZlcnJpZGUgbWV0aG9kcywgYW5kIGRvIG5vdCBjYWxsIHN1cGVyIHRvIHRoZW0KCgogICAgaWYgKHZhbHVlc1trZXldID09PSB1bmRlZmluZWQpIHsKICAgICAgLy8gRmluZCB0aGUgb3JpZ2luYWwgZGVzY3JpcHRvciBpbiBhIHBhcmVudCBtaXhpbgogICAgICBzdXBlclByb3BlcnR5ID0gZGVzY3JpcHRvckZvckRlY29yYXRvcihkZXNjc1trZXldKTsKICAgIH0gLy8gSWYgd2UgZGlkbid0IGZpbmQgdGhlIG9yaWdpbmFsIGRlc2NyaXB0b3IgaW4gYSBwYXJlbnQgbWl4aW4sIGZpbmQKICAgIC8vIGl0IG9uIHRoZSBvcmlnaW5hbCBvYmplY3QuCgoKICAgIGlmICghc3VwZXJQcm9wZXJ0eSkgewogICAgICBzdXBlclByb3BlcnR5ID0gZGVzY3JpcHRvckZvclByb3BlcnR5KGJhc2UsIGtleSwgbWV0YSQkMSk7CiAgICB9CgogICAgaWYgKHN1cGVyUHJvcGVydHkgPT09IHVuZGVmaW5lZCB8fCAhKHN1cGVyUHJvcGVydHkgaW5zdGFuY2VvZiBDb21wdXRlZFByb3BlcnR5KSkgewogICAgICByZXR1cm4gZGVjb3JhdG9yOwogICAgfQoKICAgIHZhciBnZXQgPSAoMCwgX3V0aWxzLndyYXApKHByb3BlcnR5Ll9nZXR0ZXIsIHN1cGVyUHJvcGVydHkuX2dldHRlcik7CiAgICB2YXIgc2V0OwoKICAgIGlmIChzdXBlclByb3BlcnR5Ll9zZXR0ZXIpIHsKICAgICAgaWYgKHByb3BlcnR5Ll9zZXR0ZXIpIHsKICAgICAgICBzZXQgPSAoMCwgX3V0aWxzLndyYXApKHByb3BlcnR5Ll9zZXR0ZXIsIHN1cGVyUHJvcGVydHkuX3NldHRlcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSWYgdGhlIHN1cGVyIHByb3BlcnR5IGhhcyBhIHNldHRlciwgd2UgZGVmYXVsdCB0byB1c2luZyBpdCBubyBtYXR0ZXIgd2hhdC4KICAgICAgICAvLyBUaGlzIGlzIGNsZWFybHkgdmVyeSBicm9rZW4gYW5kIHdlaXJkLCBidXQgaXQncyB3aGF0IHdhcyBoZXJlIHNvIHdlIGhhdmUKICAgICAgICAvLyB0byBrZWVwIGl0IHVudGlsIHRoZSBuZXh0IG1ham9yIGF0IGxlYXN0LgogICAgICAgIC8vCiAgICAgICAgLy8gVE9ETzogQWRkIGEgZGVwcmVjYXRpb24gaGVyZS4KICAgICAgICBzZXQgPSBzdXBlclByb3BlcnR5Ll9zZXR0ZXI7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHNldCA9IHByb3BlcnR5Ll9zZXR0ZXI7CiAgICB9IC8vIG9ubHkgY3JlYXRlIGEgbmV3IENQIGlmIHdlIG11c3QKCgogICAgaWYgKGdldCAhPT0gcHJvcGVydHkuX2dldHRlciB8fCBzZXQgIT09IHByb3BlcnR5Ll9zZXR0ZXIpIHsKICAgICAgLy8gU2luY2UgbXVsdGlwbGUgbWl4aW5zIG1heSBpbmhlcml0IGZyb20gdGhlIHNhbWUgcGFyZW50LCB3ZSBuZWVkCiAgICAgIC8vIHRvIGNsb25lIHRoZSBjb21wdXRlZCBwcm9wZXJ0eSBzbyB0aGF0IG90aGVyIG1peGlucyBkbyBub3QgcmVjZWl2ZQogICAgICAvLyB0aGUgd3JhcHBlZCB2ZXJzaW9uLgogICAgICB2YXIgbmV3UHJvcGVydHkgPSBPYmplY3QuY3JlYXRlKHByb3BlcnR5KTsKICAgICAgbmV3UHJvcGVydHkuX2dldHRlciA9IGdldDsKICAgICAgbmV3UHJvcGVydHkuX3NldHRlciA9IHNldDsKICAgICAgcmV0dXJuIG1ha2VDb21wdXRlZERlY29yYXRvcihuZXdQcm9wZXJ0eSwgQ29tcHV0ZWRQcm9wZXJ0eSk7CiAgICB9CgogICAgcmV0dXJuIGRlY29yYXRvcjsKICB9CgogIGZ1bmN0aW9uIGdpdmVNZXRob2RTdXBlcihvYmosIGtleSwgbWV0aG9kLCB2YWx1ZXMsIGRlc2NzKSB7CiAgICAvLyBNZXRob2RzIG92ZXJ3cml0ZSBjb21wdXRlZCBwcm9wZXJ0aWVzLCBhbmQgZG8gbm90IGNhbGwgc3VwZXIgdG8gdGhlbS4KICAgIGlmIChkZXNjc1trZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIG1ldGhvZDsKICAgIH0gLy8gRmluZCB0aGUgb3JpZ2luYWwgbWV0aG9kIGluIGEgcGFyZW50IG1peGluCgoKICAgIHZhciBzdXBlck1ldGhvZCA9IHZhbHVlc1trZXldOyAvLyBJZiB3ZSBkaWRuJ3QgZmluZCB0aGUgb3JpZ2luYWwgdmFsdWUgaW4gYSBwYXJlbnQgbWl4aW4sIGZpbmQgaXQgaW4KICAgIC8vIHRoZSBvcmlnaW5hbCBvYmplY3QKCiAgICBpZiAoc3VwZXJNZXRob2QgPT09IHVuZGVmaW5lZCAmJiBkZXNjcmlwdG9yRm9yUHJvcGVydHkob2JqLCBrZXkpID09PSB1bmRlZmluZWQpIHsKICAgICAgc3VwZXJNZXRob2QgPSBvYmpba2V5XTsKICAgIH0gLy8gT25seSB3cmFwIHRoZSBuZXcgbWV0aG9kIGlmIHRoZSBvcmlnaW5hbCBtZXRob2Qgd2FzIGEgZnVuY3Rpb24KCgogICAgaWYgKHR5cGVvZiBzdXBlck1ldGhvZCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm4gKDAsIF91dGlscy53cmFwKShtZXRob2QsIHN1cGVyTWV0aG9kKTsKICAgIH0KCiAgICByZXR1cm4gbWV0aG9kOwogIH0KCiAgZnVuY3Rpb24gYXBwbHlDb25jYXRlbmF0ZWRQcm9wZXJ0aWVzKG9iaiwga2V5LCB2YWx1ZSQkMSwgdmFsdWVzKSB7CiAgICB2YXIgYmFzZVZhbHVlID0gdmFsdWVzW2tleV0gfHwgb2JqW2tleV07CiAgICB2YXIgcmV0ID0gKDAsIF91dGlscy5tYWtlQXJyYXkpKGJhc2VWYWx1ZSkuY29uY2F0KCgwLCBfdXRpbHMubWFrZUFycmF5KSh2YWx1ZSQkMSkpOwoKICAgIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICkgewogICAgICAvLyBpdCBpcyBwb3NzaWJsZSB0byB1c2UgY29uY2F0ZW5hdGVkUHJvcGVydGllcyB3aXRoIHN0cmluZ3MgKHdoaWNoIGNhbm5vdCBiZSBmcm96ZW4pCiAgICAgIC8vIG9ubHkgZnJlZXplIG9iamVjdHMuLi4KICAgICAgaWYgKHR5cGVvZiByZXQgPT09ICdvYmplY3QnICYmIHJldCAhPT0gbnVsbCkgewogICAgICAgIC8vIHByZXZlbnQgbXV0YXRpbmcgYGNvbmNhdGVuYXRlZFByb3BlcnRpZXNgIGFycmF5IGFmdGVyIGl0IGlzIGFwcGxpZWQKICAgICAgICBPYmplY3QuZnJlZXplKHJldCk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmV0OwogIH0KCiAgZnVuY3Rpb24gYXBwbHlNZXJnZWRQcm9wZXJ0aWVzKG9iaiwga2V5LCB2YWx1ZSQkMSwgdmFsdWVzKSB7CiAgICB2YXIgYmFzZVZhbHVlID0gdmFsdWVzW2tleV0gfHwgb2JqW2tleV07CiAgICAoZmFsc2UgJiYgISghaXNBcnJheSh2YWx1ZSQkMSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IHBhc3NlZCBpbiBgIiArIEpTT04uc3RyaW5naWZ5KHZhbHVlJCQxKSArICJgIGFzIHRoZSB2YWx1ZSBmb3IgYCIgKyBrZXkgKyAiYCBidXQgYCIgKyBrZXkgKyAiYCBjYW5ub3QgYmUgYW4gQXJyYXkiLCAhaXNBcnJheSh2YWx1ZSQkMSkpKTsKCiAgICBpZiAoIWJhc2VWYWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUkJDE7CiAgICB9CgogICAgdmFyIG5ld0Jhc2UgPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCBiYXNlVmFsdWUpOwogICAgdmFyIGhhc0Z1bmN0aW9uID0gZmFsc2U7CgogICAgZm9yICh2YXIgcHJvcCBpbiB2YWx1ZSQkMSkgewogICAgICBpZiAoIXZhbHVlJCQxLmhhc093blByb3BlcnR5KHByb3ApKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIHZhciBwcm9wVmFsdWUgPSB2YWx1ZSQkMVtwcm9wXTsKCiAgICAgIGlmIChpc01ldGhvZChwcm9wVmFsdWUpKSB7CiAgICAgICAgLy8gVE9ETzogc3VwcG9ydCBmb3IgQ29tcHV0ZWQgUHJvcGVydGllcywgZXRjPwogICAgICAgIGhhc0Z1bmN0aW9uID0gdHJ1ZTsKICAgICAgICBuZXdCYXNlW3Byb3BdID0gZ2l2ZU1ldGhvZFN1cGVyKG9iaiwgcHJvcCwgcHJvcFZhbHVlLCBiYXNlVmFsdWUsIHt9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBuZXdCYXNlW3Byb3BdID0gcHJvcFZhbHVlOwogICAgICB9CiAgICB9CgogICAgaWYgKGhhc0Z1bmN0aW9uKSB7CiAgICAgIG5ld0Jhc2UuX3N1cGVyID0gX3V0aWxzLlJPT1Q7CiAgICB9CgogICAgcmV0dXJuIG5ld0Jhc2U7CiAgfQoKICBmdW5jdGlvbiBhZGROb3JtYWxpemVkUHJvcGVydHkoYmFzZSwga2V5LCB2YWx1ZSQkMSwgbWV0YSQkMSwgZGVzY3MsIHZhbHVlcywgY29uY2F0cywgbWVyZ2luZ3MpIHsKICAgIGlmIChpc0NsYXNzaWNEZWNvcmF0b3IodmFsdWUkJDEpKSB7CiAgICAgIC8vIFdyYXAgZGVzY3JpcHRvciBmdW5jdGlvbiB0byBpbXBsZW1lbnQgX3N1cGVyKCkgaWYgbmVlZGVkCiAgICAgIGRlc2NzW2tleV0gPSBnaXZlRGVjb3JhdG9yU3VwZXIobWV0YSQkMSwga2V5LCB2YWx1ZSQkMSwgdmFsdWVzLCBkZXNjcywgYmFzZSk7CiAgICAgIHZhbHVlc1trZXldID0gdW5kZWZpbmVkOwogICAgfSBlbHNlIHsKICAgICAgaWYgKGNvbmNhdHMgJiYgY29uY2F0cy5pbmRleE9mKGtleSkgPj0gMCB8fCBrZXkgPT09ICdjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzJyB8fCBrZXkgPT09ICdtZXJnZWRQcm9wZXJ0aWVzJykgewogICAgICAgIHZhbHVlJCQxID0gYXBwbHlDb25jYXRlbmF0ZWRQcm9wZXJ0aWVzKGJhc2UsIGtleSwgdmFsdWUkJDEsIHZhbHVlcyk7CiAgICAgIH0gZWxzZSBpZiAobWVyZ2luZ3MgJiYgbWVyZ2luZ3MuaW5kZXhPZihrZXkpID4gLTEpIHsKICAgICAgICB2YWx1ZSQkMSA9IGFwcGx5TWVyZ2VkUHJvcGVydGllcyhiYXNlLCBrZXksIHZhbHVlJCQxLCB2YWx1ZXMpOwogICAgICB9IGVsc2UgaWYgKGlzTWV0aG9kKHZhbHVlJCQxKSkgewogICAgICAgIHZhbHVlJCQxID0gZ2l2ZU1ldGhvZFN1cGVyKGJhc2UsIGtleSwgdmFsdWUkJDEsIHZhbHVlcywgZGVzY3MpOwogICAgICB9CgogICAgICBkZXNjc1trZXldID0gdW5kZWZpbmVkOwogICAgICB2YWx1ZXNba2V5XSA9IHZhbHVlJCQxOwogICAgfQogIH0KCiAgZnVuY3Rpb24gbWVyZ2VNaXhpbnMobWl4aW5zLCBtZXRhJCQxLCBkZXNjcywgdmFsdWVzLCBiYXNlLCBrZXlzKSB7CiAgICB2YXIgY3VycmVudE1peGluLCBwcm9wcywga2V5LCBjb25jYXRzLCBtZXJnaW5nczsKCiAgICBmdW5jdGlvbiByZW1vdmVLZXlzKGtleU5hbWUpIHsKICAgICAgZGVsZXRlIGRlc2NzW2tleU5hbWVdOwogICAgICBkZWxldGUgdmFsdWVzW2tleU5hbWVdOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWl4aW5zLmxlbmd0aDsgaSsrKSB7CiAgICAgIGN1cnJlbnRNaXhpbiA9IG1peGluc1tpXTsKICAgICAgKGZhbHNlICYmICEodHlwZW9mIGN1cnJlbnRNaXhpbiA9PT0gJ29iamVjdCcgJiYgY3VycmVudE1peGluICE9PSBudWxsICYmIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChjdXJyZW50TWl4aW4pICE9PSAnW29iamVjdCBBcnJheV0nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkV4cGVjdGVkIGhhc2ggb3IgTWl4aW4gaW5zdGFuY2UsIGdvdCAiICsgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGN1cnJlbnRNaXhpbiksIHR5cGVvZiBjdXJyZW50TWl4aW4gPT09ICdvYmplY3QnICYmIGN1cnJlbnRNaXhpbiAhPT0gbnVsbCAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoY3VycmVudE1peGluKSAhPT0gJ1tvYmplY3QgQXJyYXldJykpOwogICAgICBwcm9wcyA9IG1peGluUHJvcGVydGllcyhtZXRhJCQxLCBjdXJyZW50TWl4aW4pOwoKICAgICAgaWYgKHByb3BzID09PSBDT05USU5VRSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CgogICAgICBpZiAocHJvcHMpIHsKICAgICAgICAvLyByZW1vdmUgd2lsbE1lcmdlTWl4aW4gYWZ0ZXIgMy40IGFzIGl0IHdhcyB1c2VkIGZvciBfYWN0aW9ucwogICAgICAgIGlmIChiYXNlLndpbGxNZXJnZU1peGluKSB7CiAgICAgICAgICBiYXNlLndpbGxNZXJnZU1peGluKHByb3BzKTsKICAgICAgICB9CgogICAgICAgIGNvbmNhdHMgPSBjb25jYXRlbmF0ZWRNaXhpblByb3BlcnRpZXMoJ2NvbmNhdGVuYXRlZFByb3BlcnRpZXMnLCBwcm9wcywgdmFsdWVzLCBiYXNlKTsKICAgICAgICBtZXJnaW5ncyA9IGNvbmNhdGVuYXRlZE1peGluUHJvcGVydGllcygnbWVyZ2VkUHJvcGVydGllcycsIHByb3BzLCB2YWx1ZXMsIGJhc2UpOwoKICAgICAgICBmb3IgKGtleSBpbiBwcm9wcykgewogICAgICAgICAgaWYgKCFwcm9wcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGtleXMucHVzaChrZXkpOwogICAgICAgICAgYWRkTm9ybWFsaXplZFByb3BlcnR5KGJhc2UsIGtleSwgcHJvcHNba2V5XSwgbWV0YSQkMSwgZGVzY3MsIHZhbHVlcywgY29uY2F0cywgbWVyZ2luZ3MpOwogICAgICAgIH0gLy8gbWFudWFsbHkgY29weSB0b1N0cmluZygpIGJlY2F1c2Ugc29tZSBKUyBlbmdpbmVzIGRvIG5vdCBlbnVtZXJhdGUgaXQKCgogICAgICAgIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgndG9TdHJpbmcnKSkgewogICAgICAgICAgYmFzZS50b1N0cmluZyA9IHByb3BzLnRvU3RyaW5nOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChjdXJyZW50TWl4aW4ubWl4aW5zKSB7CiAgICAgICAgbWVyZ2VNaXhpbnMoY3VycmVudE1peGluLm1peGlucywgbWV0YSQkMSwgZGVzY3MsIHZhbHVlcywgYmFzZSwga2V5cyk7CgogICAgICAgIGlmIChjdXJyZW50TWl4aW4uX3dpdGhvdXQpIHsKICAgICAgICAgIGN1cnJlbnRNaXhpbi5fd2l0aG91dC5mb3JFYWNoKHJlbW92ZUtleXMpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgdmFyIGZvbGxvd01ldGhvZEFsaWFzOwoKICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5BTElBU19NRVRIT0QpIHsKICAgIGZvbGxvd01ldGhvZEFsaWFzID0gZnVuY3Rpb24gZm9sbG93TWV0aG9kQWxpYXMob2JqLCBhbGlhcywgZGVzY3MsIHZhbHVlcykgewogICAgICB2YXIgYWx0S2V5ID0gYWxpYXMubWV0aG9kTmFtZTsKICAgICAgdmFyIHBvc3NpYmxlRGVzYzsKICAgICAgdmFyIGRlc2MgPSBkZXNjc1thbHRLZXldOwogICAgICB2YXIgdmFsdWUkJDEgPSB2YWx1ZXNbYWx0S2V5XTsKCiAgICAgIGlmIChkZXNjICE9PSB1bmRlZmluZWQgfHwgdmFsdWUkJDEgIT09IHVuZGVmaW5lZCkgey8vIGRvIG5vdGhpbmcKICAgICAgfSBlbHNlIGlmICgocG9zc2libGVEZXNjID0gZGVzY3JpcHRvckZvclByb3BlcnR5KG9iaiwgYWx0S2V5KSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGRlc2MgPSBwb3NzaWJsZURlc2M7CiAgICAgICAgdmFsdWUkJDEgPSB1bmRlZmluZWQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVzYyA9IHVuZGVmaW5lZDsKICAgICAgICB2YWx1ZSQkMSA9IG9ialthbHRLZXldOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGRlc2M6IGRlc2MsCiAgICAgICAgdmFsdWU6IHZhbHVlJCQxCiAgICAgIH07CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gdXBkYXRlT2JzZXJ2ZXJzQW5kTGlzdGVuZXJzKG9iaiwga2V5LCBmbiwgYWRkKSB7CiAgICB2YXIgb2JzZXJ2ZXJzID0gKDAsIF91dGlscy5nZXRPYnNlcnZlcnMpKGZuKTsKICAgIHZhciBsaXN0ZW5lcnMgPSAoMCwgX3V0aWxzLmdldExpc3RlbmVycykoZm4pOwoKICAgIGlmIChvYnNlcnZlcnMgIT09IHVuZGVmaW5lZCkgewogICAgICB2YXIgdXBkYXRlT2JzZXJ2ZXIgPSBhZGQgPyBhZGRPYnNlcnZlciA6IHJlbW92ZU9ic2VydmVyOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYnNlcnZlcnMucGF0aHMubGVuZ3RoOyBpKyspIHsKICAgICAgICB1cGRhdGVPYnNlcnZlcihvYmosIG9ic2VydmVycy5wYXRoc1tpXSwgbnVsbCwga2V5LCBvYnNlcnZlcnMuc3luYyk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAobGlzdGVuZXJzICE9PSB1bmRlZmluZWQpIHsKICAgICAgdmFyIHVwZGF0ZUxpc3RlbmVyID0gYWRkID8gYWRkTGlzdGVuZXIgOiByZW1vdmVMaXN0ZW5lcjsKCiAgICAgIGZvciAodmFyIF9pMiA9IDA7IF9pMiA8IGxpc3RlbmVycy5sZW5ndGg7IF9pMisrKSB7CiAgICAgICAgdXBkYXRlTGlzdGVuZXIob2JqLCBsaXN0ZW5lcnNbX2kyXSwgbnVsbCwga2V5KTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVwbGFjZU9ic2VydmVyc0FuZExpc3RlbmVycyhvYmosIGtleSwgcHJldiwgbmV4dCkgewogICAgaWYgKHR5cGVvZiBwcmV2ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHVwZGF0ZU9ic2VydmVyc0FuZExpc3RlbmVycyhvYmosIGtleSwgcHJldiwgZmFsc2UpOwogICAgfQoKICAgIGlmICh0eXBlb2YgbmV4dCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICB1cGRhdGVPYnNlcnZlcnNBbmRMaXN0ZW5lcnMob2JqLCBrZXksIG5leHQsIHRydWUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gYXBwbHlNaXhpbihvYmosIG1peGlucykgewogICAgdmFyIGRlc2NzID0ge307CiAgICB2YXIgdmFsdWVzID0ge307CiAgICB2YXIgbWV0YSQkMSA9ICgwLCBfbWV0YTIubWV0YSkob2JqKTsKICAgIHZhciBrZXlzID0gW107CiAgICB2YXIga2V5LCB2YWx1ZSQkMSwgZGVzYzsKICAgIG9iai5fc3VwZXIgPSBfdXRpbHMuUk9PVDsgLy8gR28gdGhyb3VnaCBhbGwgbWl4aW5zIGFuZCBoYXNoZXMgcGFzc2VkIGluLCBhbmQ6CiAgICAvLwogICAgLy8gKiBIYW5kbGUgY29uY2F0ZW5hdGVkIHByb3BlcnRpZXMKICAgIC8vICogSGFuZGxlIG1lcmdlZCBwcm9wZXJ0aWVzCiAgICAvLyAqIFNldCB1cCBfc3VwZXIgd3JhcHBpbmcgaWYgbmVjZXNzYXJ5CiAgICAvLyAqIFNldCB1cCBjb21wdXRlZCBwcm9wZXJ0eSBkZXNjcmlwdG9ycwogICAgLy8gKiBDb3B5aW5nIGB0b1N0cmluZ2AgaW4gYnJva2VuIGJyb3dzZXJzCgogICAgbWVyZ2VNaXhpbnMobWl4aW5zLCBtZXRhJCQxLCBkZXNjcywgdmFsdWVzLCBvYmosIGtleXMpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICBrZXkgPSBrZXlzW2ldOwoKICAgICAgaWYgKGtleSA9PT0gJ2NvbnN0cnVjdG9yJyB8fCAhdmFsdWVzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgZGVzYyA9IGRlc2NzW2tleV07CiAgICAgIHZhbHVlJCQxID0gdmFsdWVzW2tleV07CgogICAgICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5BTElBU19NRVRIT0QpIHsKICAgICAgICB3aGlsZSAodmFsdWUkJDEgJiYgdmFsdWUkJDEgaW5zdGFuY2VvZiBBbGlhc0ltcGwpIHsKICAgICAgICAgIHZhciBmb2xsb3dlZCA9IGZvbGxvd01ldGhvZEFsaWFzKG9iaiwgdmFsdWUkJDEsIGRlc2NzLCB2YWx1ZXMpOwogICAgICAgICAgZGVzYyA9IGZvbGxvd2VkLmRlc2M7CiAgICAgICAgICB2YWx1ZSQkMSA9IGZvbGxvd2VkLnZhbHVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCAmJiB2YWx1ZSQkMSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIGlmIChkZXNjcmlwdG9yRm9yUHJvcGVydHkob2JqLCBrZXkpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXBsYWNlT2JzZXJ2ZXJzQW5kTGlzdGVuZXJzKG9iaiwga2V5LCBudWxsLCB2YWx1ZSQkMSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVwbGFjZU9ic2VydmVyc0FuZExpc3RlbmVycyhvYmosIGtleSwgb2JqW2tleV0sIHZhbHVlJCQxKTsKICAgICAgfQoKICAgICAgZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIGRlc2MsIHZhbHVlJCQxLCBtZXRhJCQxKTsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH0KICAvKioKICAgIEBtZXRob2QgbWl4aW4KICAgIEBwYXJhbSBvYmoKICAgIEBwYXJhbSBtaXhpbnMqCiAgICBAcmV0dXJuIG9iagogICAgQHByaXZhdGUKICAqLwoKCiAgZnVuY3Rpb24gbWl4aW4ob2JqKSB7CiAgICBmb3IgKHZhciBfbGVuNCA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjQgPiAxID8gX2xlbjQgLSAxIDogMCksIF9rZXk1ID0gMTsgX2tleTUgPCBfbGVuNDsgX2tleTUrKykgewogICAgICBhcmdzW19rZXk1IC0gMV0gPSBhcmd1bWVudHNbX2tleTVdOwogICAgfQoKICAgIGFwcGx5TWl4aW4ob2JqLCBhcmdzKTsKICAgIHJldHVybiBvYmo7CiAgfQogIC8qKgogICAgVGhlIGBNaXhpbmAgY2xhc3MgYWxsb3dzIHlvdSB0byBjcmVhdGUgbWl4aW5zLCB3aG9zZSBwcm9wZXJ0aWVzIGNhbiBiZQogICAgYWRkZWQgdG8gb3RoZXIgY2xhc3Nlcy4gRm9yIGluc3RhbmNlLAogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IE1peGluIGZyb20gJ0BlbWJlci9vYmplY3QvbWl4aW4nOwogIAogICAgY29uc3QgRWRpdGFibGVNaXhpbiA9IE1peGluLmNyZWF0ZSh7CiAgICAgIGVkaXQoKSB7CiAgICAgICAgY29uc29sZS5sb2coJ3N0YXJ0aW5nIHRvIGVkaXQnKTsKICAgICAgICB0aGlzLnNldCgnaXNFZGl0aW5nJywgdHJ1ZSk7CiAgICAgIH0sCiAgICAgIGlzRWRpdGluZzogZmFsc2UKICAgIH0pOwogICAgYGBgCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgRWRpdGFibGVNaXhpbiBmcm9tICcuLi9taXhpbnMvZWRpdGFibGUnOwogIAogICAgLy8gTWl4IG1peGlucyBpbnRvIGNsYXNzZXMgYnkgcGFzc2luZyB0aGVtIGFzIHRoZSBmaXJzdCBhcmd1bWVudHMgdG8KICAgIC8vIGAuZXh0ZW5kLmAKICAgIGNvbnN0IENvbW1lbnQgPSBFbWJlck9iamVjdC5leHRlbmQoRWRpdGFibGVNaXhpbiwgewogICAgICBwb3N0OiBudWxsCiAgICB9KTsKICAKICAgIGxldCBjb21tZW50ID0gQ29tbWVudC5jcmVhdGUoewogICAgICBwb3N0OiBzb21lUG9zdAogICAgfSk7CiAgCiAgICBjb21tZW50LmVkaXQoKTsgLy8gb3V0cHV0cyAnc3RhcnRpbmcgdG8gZWRpdCcKICAgIGBgYAogIAogICAgTm90ZSB0aGF0IE1peGlucyBhcmUgY3JlYXRlZCB3aXRoIGBNaXhpbi5jcmVhdGVgLCBub3QKICAgIGBNaXhpbi5leHRlbmRgLgogIAogICAgTm90ZSB0aGF0IG1peGlucyBleHRlbmQgYSBjb25zdHJ1Y3RvcidzIHByb3RvdHlwZSBzbyBhcnJheXMgYW5kIG9iamVjdCBsaXRlcmFscwogICAgZGVmaW5lZCBhcyBwcm9wZXJ0aWVzIHdpbGwgYmUgc2hhcmVkIGFtb25nc3Qgb2JqZWN0cyB0aGF0IGltcGxlbWVudCB0aGUgbWl4aW4uCiAgICBJZiB5b3Ugd2FudCB0byBkZWZpbmUgYSBwcm9wZXJ0eSBpbiBhIG1peGluIHRoYXQgaXMgbm90IHNoYXJlZCwgeW91IGNhbiBkZWZpbmUKICAgIGl0IGVpdGhlciBhcyBhIGNvbXB1dGVkIHByb3BlcnR5IG9yIGhhdmUgaXQgYmUgY3JlYXRlZCBvbiBpbml0aWFsaXphdGlvbiBvZiB0aGUgb2JqZWN0LgogIAogICAgYGBgamF2YXNjcmlwdAogICAgLy8gZmlsdGVycyBhcnJheSB3aWxsIGJlIHNoYXJlZCBhbW9uZ3N0IGFueSBvYmplY3QgaW1wbGVtZW50aW5nIG1peGluCiAgICBpbXBvcnQgTWl4aW4gZnJvbSAnQGVtYmVyL29iamVjdC9taXhpbic7CiAgICBpbXBvcnQgeyBBIH0gZnJvbSAnQGVtYmVyL2FycmF5JzsKICAKICAgIGNvbnN0IEZpbHRlcmFibGVNaXhpbiA9IE1peGluLmNyZWF0ZSh7CiAgICAgIGZpbHRlcnM6IEEoKQogICAgfSk7CiAgICBgYGAKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBNaXhpbiBmcm9tICdAZW1iZXIvb2JqZWN0L21peGluJzsKICAgIGltcG9ydCB7IEEgfSBmcm9tICdAZW1iZXIvYXJyYXknOwogICAgaW1wb3J0IHsgY29tcHV0ZWQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIC8vIGZpbHRlcnMgd2lsbCBiZSBhIHNlcGFyYXRlIGFycmF5IGZvciBldmVyeSBvYmplY3QgaW1wbGVtZW50aW5nIHRoZSBtaXhpbgogICAgY29uc3QgRmlsdGVyYWJsZU1peGluID0gTWl4aW4uY3JlYXRlKHsKICAgICAgZmlsdGVyczogY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIEEoKTsKICAgICAgfSkKICAgIH0pOwogICAgYGBgCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgTWl4aW4gZnJvbSAnQGVtYmVyL29iamVjdC9taXhpbic7CiAgICBpbXBvcnQgeyBBIH0gZnJvbSAnQGVtYmVyL2FycmF5JzsKICAKICAgIC8vIGZpbHRlcnMgd2lsbCBiZSBjcmVhdGVkIGFzIGEgc2VwYXJhdGUgYXJyYXkgZHVyaW5nIHRoZSBvYmplY3QncyBpbml0aWFsaXphdGlvbgogICAgY29uc3QgRmlsdGVyYWJsZSA9IE1peGluLmNyZWF0ZSh7CiAgICAgIGZpbHRlcnM6IG51bGwsCiAgCiAgICAgIGluaXQoKSB7CiAgICAgICAgdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgICAgICB0aGlzLnNldCgiZmlsdGVycyIsIEEoKSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBAY2xhc3MgTWl4aW4KICAgIEBwdWJsaWMKICAqLwoKCiAgdmFyIE1peGluID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gTWl4aW4obWl4aW5zLCBwcm9wZXJ0aWVzKSB7CiAgICAgIHRoaXMucHJvcGVydGllcyA9IGV4dHJhY3RBY2Nlc3NvcnMocHJvcGVydGllcyk7CiAgICAgIHRoaXMubWl4aW5zID0gYnVpbGRNaXhpbnNBcnJheShtaXhpbnMpOwogICAgICB0aGlzLm93bmVyQ29uc3RydWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuX3dpdGhvdXQgPSB1bmRlZmluZWQ7CgogICAgICBpZiAoZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgKSB7CiAgICAgICAgLyoKICAgICAgICAgIEluIGRlYnVnIGJ1aWxkcywgd2Ugc2VhbCBtaXhpbnMgdG8gaGVscCBhdm9pZCBwZXJmb3JtYW5jZSBwaXRmYWxscy4KICAgICAgICAgICAgICAgICBJbiBJRTExIHRoZXJlIGlzIGEgcXVpcmsgdGhhdCBwcmV2ZW50cyBzZWFsZWQgb2JqZWN0cyBmcm9tIGJlaW5nIGFkZGVkCiAgICAgICAgICB0byBhIFdlYWtNYXAuIFVuZm9ydHVuYXRlbHksIHRoZSBtaXhpbiBzeXN0ZW0gY3VycmVudGx5IHJlbGllcyBvbgogICAgICAgICAgd2VhayBtYXBzIGluIGBndWlkRm9yYCwgc28gd2UgbmVlZCB0byBwcmltZSB0aGUgZ3VpZCBjYWNoZSB3ZWFrIG1hcC4KICAgICAgICAqLwogICAgICAgICgwLCBfdXRpbHMuZ3VpZEZvcikodGhpcyk7CiAgICAgICAgT2JqZWN0LnNlYWwodGhpcyk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICBAbWV0aG9kIGNyZWF0ZQogICAgICBAZm9yIEBlbWJlci9vYmplY3QvbWl4aW4KICAgICAgQHN0YXRpYwogICAgICBAcGFyYW0gYXJndW1lbnRzKgogICAgICBAcHVibGljCiAgICAqLwoKCiAgICBNaXhpbi5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUoKSB7CiAgICAgIC8vIEVTNlRPRE86IHRoaXMgcmVsaWVzIG9uIGEgZ2xvYmFsIHN0YXRlPwogICAgICBzZXRVbnByb2Nlc3NlZE1peGlucygpOwogICAgICB2YXIgTSA9IHRoaXM7CgogICAgICBmb3IgKHZhciBfbGVuNSA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjUpLCBfa2V5NiA9IDA7IF9rZXk2IDwgX2xlbjU7IF9rZXk2KyspIHsKICAgICAgICBhcmdzW19rZXk2XSA9IGFyZ3VtZW50c1tfa2V5Nl07CiAgICAgIH0KCiAgICAgIHJldHVybiBuZXcgTShhcmdzLCB1bmRlZmluZWQpOwogICAgfSAvLyByZXR1cm5zIHRoZSBtaXhpbnMgY3VycmVudGx5IGFwcGxpZWQgdG8gdGhlIHNwZWNpZmllZCBvYmplY3QKICAgIC8vIFRPRE86IE1ha2UgYG1peGluYAogICAgOwoKICAgIE1peGluLm1peGlucyA9IGZ1bmN0aW9uIG1peGlucyhvYmopIHsKICAgICAgdmFyIG1ldGEkJDEgPSAoMCwgX21ldGEyLnBlZWtNZXRhKShvYmopOwogICAgICB2YXIgcmV0ID0gW107CgogICAgICBpZiAobWV0YSQkMSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0KCiAgICAgIG1ldGEkJDEuZm9yRWFjaE1peGlucyhmdW5jdGlvbiAoY3VycmVudE1peGluKSB7CiAgICAgICAgLy8gc2tpcCBwcmltaXRpdmUgbWl4aW5zIHNpbmNlIHRoZXNlIGFyZSBhbHdheXMgYW5vbnltb3VzCiAgICAgICAgaWYgKCFjdXJyZW50TWl4aW4ucHJvcGVydGllcykgewogICAgICAgICAgcmV0LnB1c2goY3VycmVudE1peGluKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gcmV0OwogICAgfQogICAgLyoqCiAgICAgIEBtZXRob2QgcmVvcGVuCiAgICAgIEBwYXJhbSBhcmd1bWVudHMqCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgOwoKICAgIHZhciBfcHJvdG8xMiA9IE1peGluLnByb3RvdHlwZTsKCiAgICBfcHJvdG8xMi5yZW9wZW4gPSBmdW5jdGlvbiByZW9wZW4oKSB7CiAgICAgIGZvciAodmFyIF9sZW42ID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuNiksIF9rZXk3ID0gMDsgX2tleTcgPCBfbGVuNjsgX2tleTcrKykgewogICAgICAgIGFyZ3NbX2tleTddID0gYXJndW1lbnRzW19rZXk3XTsKICAgICAgfQoKICAgICAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAodGhpcy5wcm9wZXJ0aWVzKSB7CiAgICAgICAgdmFyIGN1cnJlbnRNaXhpbiA9IG5ldyBNaXhpbih1bmRlZmluZWQsIHRoaXMucHJvcGVydGllcyk7CiAgICAgICAgdGhpcy5wcm9wZXJ0aWVzID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMubWl4aW5zID0gW2N1cnJlbnRNaXhpbl07CiAgICAgIH0gZWxzZSBpZiAoIXRoaXMubWl4aW5zKSB7CiAgICAgICAgdGhpcy5taXhpbnMgPSBbXTsKICAgICAgfQoKICAgICAgdGhpcy5taXhpbnMgPSB0aGlzLm1peGlucy5jb25jYXQoYnVpbGRNaXhpbnNBcnJheShhcmdzKSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgIEBtZXRob2QgYXBwbHkKICAgICAgQHBhcmFtIG9iagogICAgICBAcmV0dXJuIGFwcGxpZWQgb2JqZWN0CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgOwoKICAgIF9wcm90bzEyLmFwcGx5ID0gZnVuY3Rpb24gYXBwbHkob2JqKSB7CiAgICAgIHJldHVybiBhcHBseU1peGluKG9iaiwgW3RoaXNdKTsKICAgIH07CgogICAgX3Byb3RvMTIuYXBwbHlQYXJ0aWFsID0gZnVuY3Rpb24gYXBwbHlQYXJ0aWFsKG9iaikgewogICAgICByZXR1cm4gYXBwbHlNaXhpbihvYmosIFt0aGlzXSk7CiAgICB9CiAgICAvKioKICAgICAgQG1ldGhvZCBkZXRlY3QKICAgICAgQHBhcmFtIG9iagogICAgICBAcmV0dXJuIHtCb29sZWFufQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8xMi5kZXRlY3QgPSBmdW5jdGlvbiBkZXRlY3Qob2JqKSB7CiAgICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmIChvYmogaW5zdGFuY2VvZiBNaXhpbikgewogICAgICAgIHJldHVybiBfZGV0ZWN0KG9iaiwgdGhpcyk7CiAgICAgIH0KCiAgICAgIHZhciBtZXRhJCQxID0gKDAsIF9tZXRhMi5wZWVrTWV0YSkob2JqKTsKCiAgICAgIGlmIChtZXRhJCQxID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gbWV0YSQkMS5oYXNNaXhpbih0aGlzKTsKICAgIH07CgogICAgX3Byb3RvMTIud2l0aG91dCA9IGZ1bmN0aW9uIHdpdGhvdXQoKSB7CiAgICAgIHZhciByZXQgPSBuZXcgTWl4aW4oW3RoaXNdKTsKCiAgICAgIGZvciAodmFyIF9sZW43ID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuNyksIF9rZXk4ID0gMDsgX2tleTggPCBfbGVuNzsgX2tleTgrKykgewogICAgICAgIGFyZ3NbX2tleThdID0gYXJndW1lbnRzW19rZXk4XTsKICAgICAgfQoKICAgICAgcmV0Ll93aXRob3V0ID0gYXJnczsKICAgICAgcmV0dXJuIHJldDsKICAgIH07CgogICAgX3Byb3RvMTIua2V5cyA9IGZ1bmN0aW9uIGtleXMoKSB7CiAgICAgIHJldHVybiBfa2V5cyh0aGlzKTsKICAgIH07CgogICAgX3Byb3RvMTIudG9TdHJpbmcgPSBmdW5jdGlvbiB0b1N0cmluZygpIHsKICAgICAgcmV0dXJuICcodW5rbm93biBtaXhpbiknOwogICAgfTsKCiAgICByZXR1cm4gTWl4aW47CiAgfSgpOwoKICBfZXhwb3J0cy5NaXhpbiA9IE1peGluOwoKICBmdW5jdGlvbiBidWlsZE1peGluc0FycmF5KG1peGlucykgewogICAgdmFyIGxlbmd0aCA9IG1peGlucyAmJiBtaXhpbnMubGVuZ3RoIHx8IDA7CiAgICB2YXIgbSA9IHVuZGVmaW5lZDsKCiAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICBtID0gbmV3IEFycmF5KGxlbmd0aCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIHggPSBtaXhpbnNbaV07CiAgICAgICAgKGZhbHNlICYmICEodHlwZW9mIHggPT09ICdvYmplY3QnICYmIHggIT09IG51bGwgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHgpICE9PSAnW29iamVjdCBBcnJheV0nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkV4cGVjdGVkIGhhc2ggb3IgTWl4aW4gaW5zdGFuY2UsIGdvdCAiICsgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHgpLCB0eXBlb2YgeCA9PT0gJ29iamVjdCcgJiYgeCAhPT0gbnVsbCAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoeCkgIT09ICdbb2JqZWN0IEFycmF5XScpKTsKCiAgICAgICAgaWYgKHggaW5zdGFuY2VvZiBNaXhpbikgewogICAgICAgICAgbVtpXSA9IHg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1baV0gPSBuZXcgTWl4aW4odW5kZWZpbmVkLCB4KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbTsKICB9CgogIE1peGluLnByb3RvdHlwZS50b1N0cmluZyA9IGNsYXNzVG9TdHJpbmc7CgogIGlmIChmYWxzZQogIC8qIERFQlVHICovCiAgKSB7CiAgICBPYmplY3Quc2VhbChNaXhpbi5wcm90b3R5cGUpOwogIH0KCiAgZnVuY3Rpb24gX2RldGVjdChjdXJNaXhpbiwgdGFyZ2V0TWl4aW4sIHNlZW4pIHsKICAgIGlmIChzZWVuID09PSB2b2lkIDApIHsKICAgICAgc2VlbiA9IG5ldyBTZXQoKTsKICAgIH0KCiAgICBpZiAoc2Vlbi5oYXMoY3VyTWl4aW4pKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBzZWVuLmFkZChjdXJNaXhpbik7CgogICAgaWYgKGN1ck1peGluID09PSB0YXJnZXRNaXhpbikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICB2YXIgbWl4aW5zID0gY3VyTWl4aW4ubWl4aW5zOwoKICAgIGlmIChtaXhpbnMpIHsKICAgICAgcmV0dXJuIG1peGlucy5zb21lKGZ1bmN0aW9uIChtaXhpbikgewogICAgICAgIHJldHVybiBfZGV0ZWN0KG1peGluLCB0YXJnZXRNaXhpbiwgc2Vlbik7CiAgICAgIH0pOwogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIF9rZXlzKG1peGluLCByZXQsIHNlZW4pIHsKICAgIGlmIChyZXQgPT09IHZvaWQgMCkgewogICAgICByZXQgPSBuZXcgU2V0KCk7CiAgICB9CgogICAgaWYgKHNlZW4gPT09IHZvaWQgMCkgewogICAgICBzZWVuID0gbmV3IFNldCgpOwogICAgfQoKICAgIGlmIChzZWVuLmhhcyhtaXhpbikpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHNlZW4uYWRkKG1peGluKTsKCiAgICBpZiAobWl4aW4ucHJvcGVydGllcykgewogICAgICB2YXIgcHJvcHMgPSBPYmplY3Qua2V5cyhtaXhpbi5wcm9wZXJ0aWVzKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICByZXQuYWRkKHByb3BzW2ldKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChtaXhpbi5taXhpbnMpIHsKICAgICAgbWl4aW4ubWl4aW5zLmZvckVhY2goZnVuY3Rpb24gKHgpIHsKICAgICAgICByZXR1cm4gX2tleXMoeCwgcmV0LCBzZWVuKTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIHJldDsKICB9CgogIHZhciBBbGlhc0ltcGw7CgogIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLkFMSUFTX01FVEhPRCkgewogICAgQWxpYXNJbXBsID0gZnVuY3Rpb24gQWxpYXNJbXBsKG1ldGhvZE5hbWUpIHsKICAgICAgdGhpcy5tZXRob2ROYW1lID0gbWV0aG9kTmFtZTsKICAgIH07CiAgfQogIC8qKgogICAgTWFrZXMgYSBtZXRob2QgYXZhaWxhYmxlIHZpYSBhbiBhZGRpdGlvbmFsIG5hbWUuCiAgCiAgICBgYGBhcHAvdXRpbHMvcGVyc29uLmpzCiAgICBpbXBvcnQgRW1iZXJPYmplY3QsIHsKICAgICAgYWxpYXNNZXRob2QKICAgIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBFbWJlck9iamVjdC5leHRlbmQoewogICAgICBuYW1lKCkgewogICAgICAgIHJldHVybiAnVG9taHVkYSBLYXR6ZGFsZSc7CiAgICAgIH0sCiAgICAgIG1vbmlrZXI6IGFsaWFzTWV0aG9kKCduYW1lJykKICAgIH0pOwogICAgYGBgCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBsZXQgZ29vZEd1eSA9IFBlcnNvbi5jcmVhdGUoKTsKICAKICAgIGdvb2RHdXkubmFtZSgpOyAgICAvLyAnVG9taHVkYSBLYXR6ZGFsZScKICAgIGdvb2RHdXkubW9uaWtlcigpOyAvLyAnVG9taHVkYSBLYXR6ZGFsZScKICAgIGBgYAogIAogICAgQG1ldGhvZCBhbGlhc01ldGhvZAogICAgQHN0YXRpYwogICAgQGRlcHJlY2F0ZWQgVXNlIGEgc2hhcmVkIHV0aWxpdHkgbWV0aG9kIGluc3RlYWQKICAgIEBmb3IgQGVtYmVyL29iamVjdAogICAgQHBhcmFtIHtTdHJpbmd9IG1ldGhvZE5hbWUgbmFtZSBvZiB0aGUgbWV0aG9kIHRvIGFsaWFzCiAgICBAcHVibGljCiAgKi8KCgogIHZhciBhbGlhc01ldGhvZDsKICBfZXhwb3J0cy5hbGlhc01ldGhvZCA9IGFsaWFzTWV0aG9kOwoKICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5BTElBU19NRVRIT0QpIHsKICAgIF9leHBvcnRzLmFsaWFzTWV0aG9kID0gYWxpYXNNZXRob2QgPSBmdW5jdGlvbiBhbGlhc01ldGhvZChtZXRob2ROYW1lKSB7CiAgICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoIllvdSBhdHRlbXB0ZWQgdG8gYWxpYXMgJyIgKyBtZXRob2ROYW1lICsgIiwgYnV0IGFsaWFzTWV0aG9kIGhhcyBiZWVuIGRlcHJlY2F0ZWQuIENvbnNpZGVyIGV4dHJhY3RpbmcgdGhlIG1ldGhvZCBpbnRvIGEgc2hhcmVkIHV0aWxpdHkgZnVuY3Rpb24uIiwgZmFsc2UsIHsKICAgICAgICBpZDogJ29iamVjdC5hbGlhcy1tZXRob2QnLAogICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgIHVybDogJ2h0dHBzOi8vZW1iZXJqcy5jb20vZGVwcmVjYXRpb25zL3YzLngjdG9jX29iamVjdC1hbGlhcy1tZXRob2QnCiAgICAgIH0pKTsKICAgICAgcmV0dXJuIG5ldyBBbGlhc0ltcGwobWV0aG9kTmFtZSk7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gb2JzZXJ2ZXIoKSB7CiAgICBmb3IgKHZhciBfbGVuOCA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjgpLCBfa2V5OSA9IDA7IF9rZXk5IDwgX2xlbjg7IF9rZXk5KyspIHsKICAgICAgYXJnc1tfa2V5OV0gPSBhcmd1bWVudHNbX2tleTldOwogICAgfQoKICAgIHZhciBmdW5jT3JEZWYgPSBhcmdzLnBvcCgpOwogICAgKGZhbHNlICYmICEodHlwZW9mIGZ1bmNPckRlZiA9PT0gJ2Z1bmN0aW9uJyB8fCB0eXBlb2YgZnVuY09yRGVmID09PSAnb2JqZWN0JyAmJiBmdW5jT3JEZWYgIT09IG51bGwpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnb2JzZXJ2ZXIgbXVzdCBiZSBwcm92aWRlZCBhIGZ1bmN0aW9uIG9yIGFuIG9ic2VydmVyIGRlZmluaXRpb24nLCB0eXBlb2YgZnVuY09yRGVmID09PSAnZnVuY3Rpb24nIHx8IHR5cGVvZiBmdW5jT3JEZWYgPT09ICdvYmplY3QnICYmIGZ1bmNPckRlZiAhPT0gbnVsbCkpOwogICAgdmFyIGZ1bmMsIGRlcGVuZGVudEtleXMsIHN5bmM7CgogICAgaWYgKHR5cGVvZiBmdW5jT3JEZWYgPT09ICdmdW5jdGlvbicpIHsKICAgICAgZnVuYyA9IGZ1bmNPckRlZjsKICAgICAgZGVwZW5kZW50S2V5cyA9IGFyZ3M7CiAgICAgIHN5bmMgPSAhX2Vudmlyb25tZW50LkVOVi5fREVGQVVMVF9BU1lOQ19PQlNFUlZFUlM7CiAgICB9IGVsc2UgewogICAgICBmdW5jID0gZnVuY09yRGVmLmZuOwogICAgICBkZXBlbmRlbnRLZXlzID0gZnVuY09yRGVmLmRlcGVuZGVudEtleXM7CiAgICAgIHN5bmMgPSBmdW5jT3JEZWYuc3luYzsKICAgIH0KCiAgICAoZmFsc2UgJiYgISh0eXBlb2YgZnVuYyA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdvYnNlcnZlciBjYWxsZWQgd2l0aG91dCBhIGZ1bmN0aW9uJywgdHlwZW9mIGZ1bmMgPT09ICdmdW5jdGlvbicpKTsKICAgIChmYWxzZSAmJiAhKEFycmF5LmlzQXJyYXkoZGVwZW5kZW50S2V5cykgJiYgZGVwZW5kZW50S2V5cy5sZW5ndGggPiAwICYmIGRlcGVuZGVudEtleXMuZXZlcnkoZnVuY3Rpb24gKHApIHsKICAgICAgcmV0dXJuIHR5cGVvZiBwID09PSAnc3RyaW5nJyAmJiBCb29sZWFuKHAubGVuZ3RoKTsKICAgIH0pKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ29ic2VydmVyIGNhbGxlZCB3aXRob3V0IHZhbGlkIHBhdGgnLCBBcnJheS5pc0FycmF5KGRlcGVuZGVudEtleXMpICYmIGRlcGVuZGVudEtleXMubGVuZ3RoID4gMCAmJiBkZXBlbmRlbnRLZXlzLmV2ZXJ5KGZ1bmN0aW9uIChwKSB7CiAgICAgIHJldHVybiB0eXBlb2YgcCA9PT0gJ3N0cmluZycgJiYgQm9vbGVhbihwLmxlbmd0aCk7CiAgICB9KSkpOwogICAgKGZhbHNlICYmICEodHlwZW9mIHN5bmMgPT09ICdib29sZWFuJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdvYnNlcnZlciBjYWxsZWQgd2l0aG91dCBzeW5jJywgdHlwZW9mIHN5bmMgPT09ICdib29sZWFuJykpOwogICAgdmFyIHBhdGhzID0gW107CgogICAgdmFyIGFkZFdhdGNoZWRQcm9wZXJ0eSA9IGZ1bmN0aW9uIGFkZFdhdGNoZWRQcm9wZXJ0eShwYXRoKSB7CiAgICAgIHJldHVybiBwYXRocy5wdXNoKHBhdGgpOwogICAgfTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlcGVuZGVudEtleXMubGVuZ3RoOyArK2kpIHsKICAgICAgZXhwYW5kUHJvcGVydGllcyhkZXBlbmRlbnRLZXlzW2ldLCBhZGRXYXRjaGVkUHJvcGVydHkpOwogICAgfQoKICAgICgwLCBfdXRpbHMuc2V0T2JzZXJ2ZXJzKShmdW5jLCB7CiAgICAgIHBhdGhzOiBwYXRocywKICAgICAgc3luYzogc3luYwogICAgfSk7CiAgICByZXR1cm4gZnVuYzsKICB9CgogIHZhciBERUJVR19JTkpFQ1RJT05fRlVOQ1RJT05TOwogIF9leHBvcnRzLkRFQlVHX0lOSkVDVElPTl9GVU5DVElPTlMgPSBERUJVR19JTkpFQ1RJT05fRlVOQ1RJT05TOwoKICBpZiAoZmFsc2UKICAvKiBERUJVRyAqLwogICkgewogICAgX2V4cG9ydHMuREVCVUdfSU5KRUNUSU9OX0ZVTkNUSU9OUyA9IERFQlVHX0lOSkVDVElPTl9GVU5DVElPTlMgPSBuZXcgV2Vha01hcCgpOwogIH0KCiAgZnVuY3Rpb24gaW5qZWN0KHR5cGUpIHsKICAgIChmYWxzZSAmJiAhKHR5cGVvZiB0eXBlID09PSAnc3RyaW5nJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdhIHN0cmluZyB0eXBlIG11c3QgYmUgcHJvdmlkZWQgdG8gaW5qZWN0JywgdHlwZW9mIHR5cGUgPT09ICdzdHJpbmcnKSk7CgogICAgZm9yICh2YXIgX2xlbjkgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW45ID4gMSA/IF9sZW45IC0gMSA6IDApLCBfa2V5MTAgPSAxOyBfa2V5MTAgPCBfbGVuOTsgX2tleTEwKyspIHsKICAgICAgYXJnc1tfa2V5MTAgLSAxXSA9IGFyZ3VtZW50c1tfa2V5MTBdOwogICAgfQoKICAgIHZhciBjYWxsZWRBc0RlY29yYXRvciA9IGlzRWxlbWVudERlc2NyaXB0b3IoYXJncyk7CiAgICB2YXIgc291cmNlLCBuYW1lc3BhY2U7CiAgICB2YXIgbmFtZSA9IGNhbGxlZEFzRGVjb3JhdG9yID8gdW5kZWZpbmVkIDogYXJnc1swXTsKICAgIHZhciBvcHRpb25zID0gY2FsbGVkQXNEZWNvcmF0b3IgPyB1bmRlZmluZWQgOiBhcmdzWzFdOwoKICAgIHZhciBnZXRJbmplY3Rpb24gPSBmdW5jdGlvbiBnZXRJbmplY3Rpb24ocHJvcGVydHlOYW1lKSB7CiAgICAgIHZhciBvd25lciA9ICgwLCBfb3duZXIuZ2V0T3duZXIpKHRoaXMpIHx8IHRoaXMuY29udGFpbmVyOyAvLyBmYWxsYmFjayB0byBgY29udGFpbmVyYCBmb3IgYmFja3dhcmRzIGNvbXBhdAoKICAgICAgKGZhbHNlICYmICEoQm9vbGVhbihvd25lcikpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQXR0ZW1wdGluZyB0byBsb29rdXAgYW4gaW5qZWN0ZWQgcHJvcGVydHkgb24gYW4gb2JqZWN0IHdpdGhvdXQgYSBjb250YWluZXIsIGVuc3VyZSB0aGF0IHRoZSBvYmplY3Qgd2FzIGluc3RhbnRpYXRlZCB2aWEgYSBjb250YWluZXIuIiwgQm9vbGVhbihvd25lcikpKTsKICAgICAgcmV0dXJuIG93bmVyLmxvb2t1cCh0eXBlICsgIjoiICsgKG5hbWUgfHwgcHJvcGVydHlOYW1lKSwgewogICAgICAgIHNvdXJjZTogc291cmNlLAogICAgICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlCiAgICAgIH0pOwogICAgfTsKCiAgICBpZiAoZmFsc2UKICAgIC8qIERFQlVHICovCiAgICApIHsKICAgICAgREVCVUdfSU5KRUNUSU9OX0ZVTkNUSU9OUy5zZXQoZ2V0SW5qZWN0aW9uLCB7CiAgICAgICAgbmFtZXNwYWNlOiBuYW1lc3BhY2UsCiAgICAgICAgc291cmNlOiBzb3VyY2UsCiAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICBuYW1lOiBuYW1lCiAgICAgIH0pOwogICAgfQoKICAgIHZhciBkZWNvcmF0b3IgPSBjb21wdXRlZCh7CiAgICAgIGdldDogZ2V0SW5qZWN0aW9uLAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldChrZXlOYW1lLCB2YWx1ZSQkMSkgewogICAgICAgIGRlZmluZVByb3BlcnR5KHRoaXMsIGtleU5hbWUsIG51bGwsIHZhbHVlJCQxKTsKICAgICAgfQogICAgfSk7CgogICAgaWYgKGNhbGxlZEFzRGVjb3JhdG9yKSB7CiAgICAgIHJldHVybiBkZWNvcmF0b3IoYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZGVjb3JhdG9yOwogICAgfQogIH0KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvb3duZXIvaW5kZXgiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvdXRpbHMiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfdXRpbHMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmdldE93bmVyID0gZ2V0T3duZXI7CiAgX2V4cG9ydHMuc2V0T3duZXIgPSBzZXRPd25lcjsKICBfZXhwb3J0cy5PV05FUiA9IHZvaWQgMDsKCiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvYXBwbGljYXRpb24KICAqLwogIHZhciBPV05FUiA9ICgwLCBfdXRpbHMuc3ltYm9sKSgnT1dORVInKTsKICAvKioKICAgIEZyYW1ld29yayBvYmplY3RzIGluIGFuIEVtYmVyIGFwcGxpY2F0aW9uIChjb21wb25lbnRzLCBzZXJ2aWNlcywgcm91dGVzLCBldGMuKQogICAgYXJlIGNyZWF0ZWQgdmlhIGEgZmFjdG9yeSBhbmQgZGVwZW5kZW5jeSBpbmplY3Rpb24gc3lzdGVtLiBFYWNoIG9mIHRoZXNlCiAgICBvYmplY3RzIGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiBhbiAib3duZXIiLCB3aGljaCBoYW5kbGVkIGl0cwogICAgaW5zdGFudGlhdGlvbiBhbmQgbWFuYWdlcyBpdHMgbGlmZXRpbWUuCiAgCiAgICBgZ2V0T3duZXJgIGZldGNoZXMgdGhlIG93bmVyIG9iamVjdCByZXNwb25zaWJsZSBmb3IgYW4gaW5zdGFuY2UuIFRoaXMgY2FuCiAgICBiZSB1c2VkIHRvIGxvb2t1cCBvciByZXNvbHZlIG90aGVyIGNsYXNzIGluc3RhbmNlcywgb3IgcmVnaXN0ZXIgbmV3IGZhY3RvcmllcwogICAgaW50byB0aGUgb3duZXIuCiAgCiAgICBGb3IgZXhhbXBsZSwgdGhpcyBjb21wb25lbnQgZHluYW1pY2FsbHkgbG9va3MgdXAgYSBzZXJ2aWNlIGJhc2VkIG9uIHRoZQogICAgYGF1ZGlvVHlwZWAgcGFzc2VkIGFzIGFuIGF0dHJpYnV0ZToKICAKICAgIGBgYGFwcC9jb21wb25lbnRzL3BsYXktYXVkaW8uanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICBpbXBvcnQgeyBjb21wdXRlZCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgZ2V0T3duZXIgfSBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogIAogICAgLy8gVXNhZ2U6CiAgICAvLwogICAgLy8gICB7e3BsYXktYXVkaW8gYXVkaW9UeXBlPW1vZGVsLmF1ZGlvVHlwZSBhdWRpb0ZpbGU9bW9kZWwuZmlsZX19CiAgICAvLwogICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgIGF1ZGlvU2VydmljZTogY29tcHV0ZWQoJ2F1ZGlvVHlwZScsIGZ1bmN0aW9uKCkgewogICAgICAgIGxldCBvd25lciA9IGdldE93bmVyKHRoaXMpOwogICAgICAgIHJldHVybiBvd25lci5sb29rdXAoYHNlcnZpY2U6JHt0aGlzLmdldCgnYXVkaW9UeXBlJyl9YCk7CiAgICAgIH0pLAogIAogICAgICBjbGljaygpIHsKICAgICAgICBsZXQgcGxheWVyID0gdGhpcy5nZXQoJ2F1ZGlvU2VydmljZScpOwogICAgICAgIHBsYXllci5wbGF5KHRoaXMuZ2V0KCdhdWRpb0ZpbGUnKSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIGdldE93bmVyCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9hcHBsaWNhdGlvbgogICAgQHBhcmFtIHtPYmplY3R9IG9iamVjdCBBbiBvYmplY3Qgd2l0aCBhbiBvd25lci4KICAgIEByZXR1cm4ge09iamVjdH0gQW4gb3duZXIgb2JqZWN0LgogICAgQHNpbmNlIDIuMy4wCiAgICBAcHVibGljCiAgKi8KCiAgX2V4cG9ydHMuT1dORVIgPSBPV05FUjsKCiAgZnVuY3Rpb24gZ2V0T3duZXIob2JqZWN0KSB7CiAgICByZXR1cm4gb2JqZWN0W09XTkVSXTsKICB9CiAgLyoqCiAgICBgc2V0T3duZXJgIGZvcmNlcyBhIG5ldyBvd25lciBvbiBhIGdpdmVuIG9iamVjdCBpbnN0YW5jZS4gVGhpcyBpcyBwcmltYXJpbHkKICAgIHVzZWZ1bCBpbiBzb21lIHRlc3RpbmcgY2FzZXMuCiAgCiAgICBAbWV0aG9kIHNldE93bmVyCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9hcHBsaWNhdGlvbgogICAgQHBhcmFtIHtPYmplY3R9IG9iamVjdCBBbiBvYmplY3QgaW5zdGFuY2UuCiAgICBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBuZXcgb3duZXIgb2JqZWN0IG9mIHRoZSBvYmplY3QgaW5zdGFuY2UuCiAgICBAc2luY2UgMi4zLjAKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gc2V0T3duZXIob2JqZWN0LCBvd25lcikgewogICAgb2JqZWN0W09XTkVSXSA9IG93bmVyOwogIH0KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9pbmRleCIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy9yb3V0aW5nL2xpYi9leHQvY29udHJvbGxlciIsICJAZW1iZXIvLWludGVybmFscy9yb3V0aW5nL2xpYi9sb2NhdGlvbi9hcGkiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvbG9jYXRpb24vbm9uZV9sb2NhdGlvbiIsICJAZW1iZXIvLWludGVybmFscy9yb3V0aW5nL2xpYi9sb2NhdGlvbi9oYXNoX2xvY2F0aW9uIiwgIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL2xvY2F0aW9uL2hpc3RvcnlfbG9jYXRpb24iLCAiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvbG9jYXRpb24vYXV0b19sb2NhdGlvbiIsICJAZW1iZXIvLWludGVybmFscy9yb3V0aW5nL2xpYi9zeXN0ZW0vZ2VuZXJhdGVfY29udHJvbGxlciIsICJAZW1iZXIvLWludGVybmFscy9yb3V0aW5nL2xpYi9zeXN0ZW0vY29udHJvbGxlcl9mb3IiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvc3lzdGVtL2RzbCIsICJAZW1iZXIvLWludGVybmFscy9yb3V0aW5nL2xpYi9zeXN0ZW0vcm91dGVyIiwgIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL3N5c3RlbS9yb3V0ZSIsICJAZW1iZXIvLWludGVybmFscy9yb3V0aW5nL2xpYi9zeXN0ZW0vcXVlcnlfcGFyYW1zIiwgIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL3NlcnZpY2VzL3JvdXRpbmciLCAiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvc2VydmljZXMvcm91dGVyIiwgIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL3N5c3RlbS9jYWNoZSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9jb250cm9sbGVyLCBfYXBpLCBfbm9uZV9sb2NhdGlvbiwgX2hhc2hfbG9jYXRpb24sIF9oaXN0b3J5X2xvY2F0aW9uLCBfYXV0b19sb2NhdGlvbiwgX2dlbmVyYXRlX2NvbnRyb2xsZXIsIF9jb250cm9sbGVyX2ZvciwgX2RzbCwgX3JvdXRlciwgX3JvdXRlLCBfcXVlcnlfcGFyYW1zLCBfcm91dGluZywgX3JvdXRlcjIsIF9jYWNoZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiTG9jYXRpb24iLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfYXBpLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiTm9uZUxvY2F0aW9uIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX25vbmVfbG9jYXRpb24uZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJIYXNoTG9jYXRpb24iLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfaGFzaF9sb2NhdGlvbi5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIkhpc3RvcnlMb2NhdGlvbiIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9oaXN0b3J5X2xvY2F0aW9uLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiQXV0b0xvY2F0aW9uIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2F1dG9fbG9jYXRpb24uZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJnZW5lcmF0ZUNvbnRyb2xsZXIiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfZ2VuZXJhdGVfY29udHJvbGxlci5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImdlbmVyYXRlQ29udHJvbGxlckZhY3RvcnkiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfZ2VuZXJhdGVfY29udHJvbGxlci5nZW5lcmF0ZUNvbnRyb2xsZXJGYWN0b3J5OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImNvbnRyb2xsZXJGb3IiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfY29udHJvbGxlcl9mb3IuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJSb3V0ZXJEU0wiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfZHNsLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiUm91dGVyIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3JvdXRlci5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIlJvdXRlIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3JvdXRlLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiUXVlcnlQYXJhbXMiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcXVlcnlfcGFyYW1zLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiUm91dGluZ1NlcnZpY2UiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcm91dGluZy5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIlJvdXRlclNlcnZpY2UiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcm91dGVyMi5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIkJ1Y2tldENhY2hlIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2NhY2hlLmRlZmF1bHQ7CiAgICB9CiAgfSk7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL2V4dC9jb250cm9sbGVyIiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGFsIiwgIkBlbWJlci9jb250cm9sbGVyL2xpYi9jb250cm9sbGVyX21peGluIiwgIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL3V0aWxzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX21ldGFsLCBfY29udHJvbGxlcl9taXhpbiwgX3V0aWxzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KICBfY29udHJvbGxlcl9taXhpbi5kZWZhdWx0LnJlb3Blbih7CiAgICBjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzOiBbJ3F1ZXJ5UGFyYW1zJ10sCgogICAgLyoqCiAgICAgIERlZmluZXMgd2hpY2ggcXVlcnkgcGFyYW1ldGVycyB0aGUgY29udHJvbGxlciBhY2NlcHRzLgogICAgICBJZiB5b3UgZ2l2ZSB0aGUgbmFtZXMgYFsnY2F0ZWdvcnknLCdwYWdlJ11gIGl0IHdpbGwgYmluZAogICAgICB0aGUgdmFsdWVzIG9mIHRoZXNlIHF1ZXJ5IHBhcmFtZXRlcnMgdG8gdGhlIHZhcmlhYmxlcwogICAgICBgdGhpcy5jYXRlZ29yeWAgYW5kIGB0aGlzLnBhZ2VgLgogICAgICBCeSBkZWZhdWx0LCBFbWJlciBjb2VyY2VzIHF1ZXJ5IHBhcmFtZXRlciB2YWx1ZXMgdXNpbmcgYHRvZ2dsZVByb3BlcnR5YC4KICAgICAgVGhpcyBiZWhhdmlvciBtYXkgbGVhZCB0byB1bmV4cGVjdGVkIHJlc3VsdHMuCiAgICAgIEF2YWlsYWJsZSBxdWVyeVBhcmFtIHR5cGVzOiBgYm9vbGVhbmAsIGBudW1iZXJgLCBgYXJyYXlgLgogICAgICBJZiBxdWVyeSBwYXJhbSB0eXBlIG5vdCBzcGVjaWZpZWQsIGl0IHdpbGwgYmUgYHN0cmluZ2AuCiAgICAgIFRvIGV4cGxpY2l0bHkgY29uZmlndXJlIGEgcXVlcnkgcGFyYW1ldGVyIHByb3BlcnR5IHNvIGl0IGNvZXJjZXMgYXMgZXhwZWN0ZWQsIHlvdSBtdXN0IGRlZmluZSBhIHR5cGUgcHJvcGVydHk6CiAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICBxdWVyeVBhcmFtczogW3sKICAgICAgICAgIGNhdGVnb3J5OiB7CiAgICAgICAgICAgIHR5cGU6ICdib29sZWFuJwogICAgICAgICAgfQogICAgICAgIH1dCiAgICAgIGBgYAogICAgICAgICBAZm9yIEVtYmVyLkNvbnRyb2xsZXJNaXhpbgogICAgICBAcHJvcGVydHkgcXVlcnlQYXJhbXMKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHF1ZXJ5UGFyYW1zOiBudWxsLAoKICAgIC8qKgogICAgIFRoaXMgcHJvcGVydHkgaXMgdXBkYXRlZCB0byB2YXJpb3VzIGRpZmZlcmVudCBjYWxsYmFjayBmdW5jdGlvbnMgZGVwZW5kaW5nIG9uCiAgICAgdGhlIGN1cnJlbnQgInN0YXRlIiBvZiB0aGUgYmFja2luZyByb3V0ZS4gSXQgaXMgdXNlZCBieQogICAgIGBDb250cm9sbGVyLnByb3RvdHlwZS5fcXBDaGFuZ2VkYC4KICAgICAgICBUaGUgbWV0aG9kcyBiYWNraW5nIGVhY2ggc3RhdGUgY2FuIGJlIGZvdW5kIGluIHRoZSBgUm91dGUucHJvdG90eXBlLl9xcGAgY29tcHV0ZWQKICAgICBwcm9wZXJ0eSByZXR1cm4gdmFsdWUgKHRoZSBgLnN0YXRlc2AgcHJvcGVydHkpLiBUaGUgY3VycmVudCB2YWx1ZXMgYXJlIGxpc3RlZCBoZXJlIGZvcgogICAgIHRoZSBzYW5pdHkgb2YgZnV0dXJlIHRyYXZlbGVyczoKICAgICAgICAqIGBpbmFjdGl2ZWAgLSBUaGlzIHN0YXRlIGlzIHVzZWQgd2hlbiB0aGlzIGNvbnRyb2xsZXIgaW5zdGFuY2UgaXMgbm90IHBhcnQgb2YgdGhlIGFjdGl2ZQogICAgICAgcm91dGUgaGllcmFyY2h5LiBTZXQgaW4gYFJvdXRlLnByb3RvdHlwZS5fcmVzZXRgIChhIGByb3V0ZXIuanNgIG1pY3JvbGliIGhvb2spIGFuZAogICAgICAgYFJvdXRlLnByb3RvdHlwZS5hY3Rpb25zLmZpbmFsaXplUXVlcnlQYXJhbUNoYW5nZWAuCiAgICAgKiBgYWN0aXZlYCAtIFRoaXMgc3RhdGUgaXMgdXNlZCB3aGVuIHRoaXMgY29udHJvbGxlciBpbnN0YW5jZSBpcyBwYXJ0IG9mIHRoZSBhY3RpdmUKICAgICAgIHJvdXRlIGhpZXJhcmNoeS4gU2V0IGluIGBSb3V0ZS5wcm90b3R5cGUuYWN0aW9ucy5maW5hbGl6ZVF1ZXJ5UGFyYW1DaGFuZ2VgLgogICAgICogYGFsbG93T3ZlcnJpZGVzYCAtIFRoaXMgc3RhdGUgaXMgdXNlZCBpbiBgUm91dGUucHJvdG90eXBlLnNldHVwYCAoYHJvdXRlLmpzYCBtaWNyb2xpYiBob29rKS4KICAgICAgICAgQG1ldGhvZCBfcXBEZWxlZ2F0ZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9xcERlbGVnYXRlOiBudWxsLAoKICAgIC8qKgogICAgIER1cmluZyBgUm91dGUjc2V0dXBgIG9ic2VydmVycyBhcmUgY3JlYXRlZCB0byBpbnZva2UgdGhpcyBtZXRob2QKICAgICB3aGVuIGFueSBvZiB0aGUgcXVlcnkgcGFyYW1zIGRlY2xhcmVkIGluIGBDb250cm9sbGVyI3F1ZXJ5UGFyYW1zYCBwcm9wZXJ0eQogICAgIGFyZSBjaGFuZ2VkLgogICAgICAgIFdoZW4gaW52b2tlZCB0aGlzIG1ldGhvZCB1c2VzIHRoZSBjdXJyZW50bHkgYWN0aXZlIHF1ZXJ5IHBhcmFtIHVwZGF0ZSBkZWxlZ2F0ZQogICAgIChzZWUgYENvbnRyb2xsZXIucHJvdG90eXBlLl9xcERlbGVnYXRlYCBmb3IgZGV0YWlscykgYW5kIGludm9rZXMgaXQgd2l0aAogICAgIHRoZSBRUCBrZXkvdmFsdWUgYmVpbmcgY2hhbmdlZC4KICAgICAgICAgQG1ldGhvZCBfcXBDaGFuZ2VkCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgX3FwQ2hhbmdlZDogZnVuY3Rpb24gX3FwQ2hhbmdlZChjb250cm9sbGVyLCBfcHJvcCkgewogICAgICB2YXIgZG90SW5kZXggPSBfcHJvcC5pbmRleE9mKCcuW10nKTsKCiAgICAgIHZhciBwcm9wID0gZG90SW5kZXggPT09IC0xID8gX3Byb3AgOiBfcHJvcC5zbGljZSgwLCBkb3RJbmRleCk7CiAgICAgIHZhciBkZWxlZ2F0ZSA9IGNvbnRyb2xsZXIuX3FwRGVsZWdhdGU7CiAgICAgIHZhciB2YWx1ZSA9ICgwLCBfbWV0YWwuZ2V0KShjb250cm9sbGVyLCBwcm9wKTsKICAgICAgZGVsZWdhdGUocHJvcCwgdmFsdWUpOwogICAgfSwKCiAgICAvKioKICAgICAgVHJhbnNpdGlvbiB0aGUgYXBwbGljYXRpb24gaW50byBhbm90aGVyIHJvdXRlLiBUaGUgcm91dGUgbWF5CiAgICAgIGJlIGVpdGhlciBhIHNpbmdsZSByb3V0ZSBvciByb3V0ZSBwYXRoOgogICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGFDb250cm9sbGVyLnRyYW5zaXRpb25Ub1JvdXRlKCdibG9nUG9zdHMnKTsKICAgICAgYUNvbnRyb2xsZXIudHJhbnNpdGlvblRvUm91dGUoJ2Jsb2dQb3N0cy5yZWNlbnRFbnRyaWVzJyk7CiAgICAgIGBgYAogICAgICAgICBPcHRpb25hbGx5IHN1cHBseSBhIG1vZGVsIGZvciB0aGUgcm91dGUgaW4gcXVlc3Rpb24uIFRoZSBtb2RlbAogICAgICB3aWxsIGJlIHNlcmlhbGl6ZWQgaW50byB0aGUgVVJMIHVzaW5nIHRoZSBgc2VyaWFsaXplYCBob29rIG9mCiAgICAgIHRoZSByb3V0ZToKICAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICBhQ29udHJvbGxlci50cmFuc2l0aW9uVG9Sb3V0ZSgnYmxvZ1Bvc3QnLCBhUG9zdCk7CiAgICAgIGBgYAogICAgICAgICBJZiBhIGxpdGVyYWwgaXMgcGFzc2VkIChzdWNoIGFzIGEgbnVtYmVyIG9yIGEgc3RyaW5nKSwgaXQgd2lsbAogICAgICBiZSB0cmVhdGVkIGFzIGFuIGlkZW50aWZpZXIgaW5zdGVhZC4gSW4gdGhpcyBjYXNlLCB0aGUgYG1vZGVsYAogICAgICBob29rIG9mIHRoZSByb3V0ZSB3aWxsIGJlIHRyaWdnZXJlZDoKICAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICBhQ29udHJvbGxlci50cmFuc2l0aW9uVG9Sb3V0ZSgnYmxvZ1Bvc3QnLCAxKTsKICAgICAgYGBgCiAgICAgICAgIE11bHRpcGxlIG1vZGVscyB3aWxsIGJlIGFwcGxpZWQgbGFzdCB0byBmaXJzdCByZWN1cnNpdmVseSB1cCB0aGUKICAgICAgcm91dGUgdHJlZS4KICAgICAgICAgYGBgYXBwL3JvdXRlci5qcwogICAgICBSb3V0ZXIubWFwKGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucm91dGUoJ2Jsb2dQb3N0JywgeyBwYXRoOiAnOmJsb2dQb3N0SWQnIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5yb3V0ZSgnYmxvZ0NvbW1lbnQnLCB7IHBhdGg6ICc6YmxvZ0NvbW1lbnRJZCcsIHJlc2V0TmFtZXNwYWNlOiB0cnVlIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgYGBgCiAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgYUNvbnRyb2xsZXIudHJhbnNpdGlvblRvUm91dGUoJ2Jsb2dDb21tZW50JywgYVBvc3QsIGFDb21tZW50KTsKICAgICAgYUNvbnRyb2xsZXIudHJhbnNpdGlvblRvUm91dGUoJ2Jsb2dDb21tZW50JywgMSwgMTMpOwogICAgICBgYGAKICAgICAgICAgSXQgaXMgYWxzbyBwb3NzaWJsZSB0byBwYXNzIGEgVVJMIChhIHN0cmluZyB0aGF0IHN0YXJ0cyB3aXRoIGEKICAgICAgYC9gKS4KICAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICBhQ29udHJvbGxlci50cmFuc2l0aW9uVG9Sb3V0ZSgnLycpOwogICAgICBhQ29udHJvbGxlci50cmFuc2l0aW9uVG9Sb3V0ZSgnL2Jsb2cvcG9zdC8xL2NvbW1lbnQvMTMnKTsKICAgICAgYUNvbnRyb2xsZXIudHJhbnNpdGlvblRvUm91dGUoJy9ibG9nL3Bvc3RzP3NvcnQ9dGl0bGUnKTsKICAgICAgYGBgCiAgICAgICAgIEFuIG9wdGlvbnMgaGFzaCB3aXRoIGEgYHF1ZXJ5UGFyYW1zYCBwcm9wZXJ0eSBtYXkgYmUgcHJvdmlkZWQgYXMKICAgICAgdGhlIGZpbmFsIGFyZ3VtZW50IHRvIGFkZCBxdWVyeSBwYXJhbWV0ZXJzIHRvIHRoZSBkZXN0aW5hdGlvbiBVUkwuCiAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgYUNvbnRyb2xsZXIudHJhbnNpdGlvblRvUm91dGUoJ2Jsb2dQb3N0JywgMSwgewogICAgICAgIHF1ZXJ5UGFyYW1zOiB7IHNob3dDb21tZW50czogJ3RydWUnIH0KICAgICAgfSk7CiAgICAgICAgIC8vIGlmIHlvdSBqdXN0IHdhbnQgdG8gdHJhbnNpdGlvbiB0aGUgcXVlcnkgcGFyYW1ldGVycyB3aXRob3V0IGNoYW5naW5nIHRoZSByb3V0ZQogICAgICBhQ29udHJvbGxlci50cmFuc2l0aW9uVG9Sb3V0ZSh7IHF1ZXJ5UGFyYW1zOiB7IHNvcnQ6ICdkYXRlJyB9IH0pOwogICAgICBgYGAKICAgICAgICAgU2VlIGFsc28gW3JlcGxhY2VSb3V0ZV0oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9FbWJlci5Db250cm9sbGVyTWl4aW4vbWV0aG9kcy9yZXBsYWNlUm91dGU/YW5jaG9yPXJlcGxhY2VSb3V0ZSkuCiAgICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIHRoZSBuYW1lIG9mIHRoZSByb3V0ZSBvciBhIFVSTAogICAgICBAcGFyYW0gey4uLk9iamVjdH0gbW9kZWxzIHRoZSBtb2RlbChzKSBvciBpZGVudGlmaWVyKHMpIHRvIGJlIHVzZWQKICAgICAgICB3aGlsZSB0cmFuc2l0aW9uaW5nIHRvIHRoZSByb3V0ZS4KICAgICAgQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBvcHRpb25hbCBoYXNoIHdpdGggYSBxdWVyeVBhcmFtcyBwcm9wZXJ0eQogICAgICAgIGNvbnRhaW5pbmcgYSBtYXBwaW5nIG9mIHF1ZXJ5IHBhcmFtZXRlcnMKICAgICAgQGZvciBFbWJlci5Db250cm9sbGVyTWl4aW4KICAgICAgQG1ldGhvZCB0cmFuc2l0aW9uVG9Sb3V0ZQogICAgICBAcHVibGljCiAgICAqLwogICAgdHJhbnNpdGlvblRvUm91dGU6IGZ1bmN0aW9uIHRyYW5zaXRpb25Ub1JvdXRlKCkgewogICAgICAvLyB0YXJnZXQgbWF5IGJlIGVpdGhlciBhbm90aGVyIGNvbnRyb2xsZXIgb3IgYSByb3V0ZXIKICAgICAgdmFyIHRhcmdldCA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAndGFyZ2V0Jyk7CiAgICAgIHZhciBtZXRob2QgPSB0YXJnZXQudHJhbnNpdGlvblRvUm91dGUgfHwgdGFyZ2V0LnRyYW5zaXRpb25UbzsKCiAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIHJldHVybiBtZXRob2QuYXBwbHkodGFyZ2V0LCAoMCwgX3V0aWxzLnByZWZpeFJvdXRlTmFtZUFyZykodGhpcywgYXJncykpOwogICAgfSwKCiAgICAvKioKICAgICAgVHJhbnNpdGlvbiBpbnRvIGFub3RoZXIgcm91dGUgd2hpbGUgcmVwbGFjaW5nIHRoZSBjdXJyZW50IFVSTCwgaWYgcG9zc2libGUuCiAgICAgIFRoaXMgd2lsbCByZXBsYWNlIHRoZSBjdXJyZW50IGhpc3RvcnkgZW50cnkgaW5zdGVhZCBvZiBhZGRpbmcgYSBuZXcgb25lLgogICAgICBCZXNpZGUgdGhhdCwgaXQgaXMgaWRlbnRpY2FsIHRvIGB0cmFuc2l0aW9uVG9Sb3V0ZWAgaW4gYWxsIG90aGVyIHJlc3BlY3RzLgogICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGFDb250cm9sbGVyLnJlcGxhY2VSb3V0ZSgnYmxvZ1Bvc3RzJyk7CiAgICAgIGFDb250cm9sbGVyLnJlcGxhY2VSb3V0ZSgnYmxvZ1Bvc3RzLnJlY2VudEVudHJpZXMnKTsKICAgICAgYGBgCiAgICAgICAgIE9wdGlvbmFsbHkgc3VwcGx5IGEgbW9kZWwgZm9yIHRoZSByb3V0ZSBpbiBxdWVzdGlvbi4gVGhlIG1vZGVsCiAgICAgIHdpbGwgYmUgc2VyaWFsaXplZCBpbnRvIHRoZSBVUkwgdXNpbmcgdGhlIGBzZXJpYWxpemVgIGhvb2sgb2YKICAgICAgdGhlIHJvdXRlOgogICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGFDb250cm9sbGVyLnJlcGxhY2VSb3V0ZSgnYmxvZ1Bvc3QnLCBhUG9zdCk7CiAgICAgIGBgYAogICAgICAgICBJZiBhIGxpdGVyYWwgaXMgcGFzc2VkIChzdWNoIGFzIGEgbnVtYmVyIG9yIGEgc3RyaW5nKSwgaXQgd2lsbAogICAgICBiZSB0cmVhdGVkIGFzIGFuIGlkZW50aWZpZXIgaW5zdGVhZC4gSW4gdGhpcyBjYXNlLCB0aGUgYG1vZGVsYAogICAgICBob29rIG9mIHRoZSByb3V0ZSB3aWxsIGJlIHRyaWdnZXJlZDoKICAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICBhQ29udHJvbGxlci5yZXBsYWNlUm91dGUoJ2Jsb2dQb3N0JywgMSk7CiAgICAgIGBgYAogICAgICAgICBNdWx0aXBsZSBtb2RlbHMgd2lsbCBiZSBhcHBsaWVkIGxhc3QgdG8gZmlyc3QgcmVjdXJzaXZlbHkgdXAgdGhlCiAgICAgIHJvdXRlIHRyZWUuCiAgICAgICAgIGBgYGFwcC9yb3V0ZXIuanMKICAgICAgUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJvdXRlKCdibG9nUG9zdCcsIHsgcGF0aDogJzpibG9nUG9zdElkJyB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgIHRoaXMucm91dGUoJ2Jsb2dDb21tZW50JywgeyBwYXRoOiAnOmJsb2dDb21tZW50SWQnLCByZXNldE5hbWVzcGFjZTogdHJ1ZSB9KTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgICBgYGAKICAgICAgYUNvbnRyb2xsZXIucmVwbGFjZVJvdXRlKCdibG9nQ29tbWVudCcsIGFQb3N0LCBhQ29tbWVudCk7CiAgICAgIGFDb250cm9sbGVyLnJlcGxhY2VSb3V0ZSgnYmxvZ0NvbW1lbnQnLCAxLCAxMyk7CiAgICAgIGBgYAogICAgICAgICBJdCBpcyBhbHNvIHBvc3NpYmxlIHRvIHBhc3MgYSBVUkwgKGEgc3RyaW5nIHRoYXQgc3RhcnRzIHdpdGggYQogICAgICBgL2ApLgogICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGFDb250cm9sbGVyLnJlcGxhY2VSb3V0ZSgnLycpOwogICAgICBhQ29udHJvbGxlci5yZXBsYWNlUm91dGUoJy9ibG9nL3Bvc3QvMS9jb21tZW50LzEzJyk7CiAgICAgIGBgYAogICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgcm91dGUgb3IgYSBVUkwKICAgICAgQHBhcmFtIHsuLi5PYmplY3R9IG1vZGVscyB0aGUgbW9kZWwocykgb3IgaWRlbnRpZmllcihzKSB0byBiZSB1c2VkCiAgICAgIHdoaWxlIHRyYW5zaXRpb25pbmcgdG8gdGhlIHJvdXRlLgogICAgICBAZm9yIEVtYmVyLkNvbnRyb2xsZXJNaXhpbgogICAgICBAbWV0aG9kIHJlcGxhY2VSb3V0ZQogICAgICBAcHVibGljCiAgICAqLwogICAgcmVwbGFjZVJvdXRlOiBmdW5jdGlvbiByZXBsYWNlUm91dGUoKSB7CiAgICAgIC8vIHRhcmdldCBtYXkgYmUgZWl0aGVyIGFub3RoZXIgY29udHJvbGxlciBvciBhIHJvdXRlcgogICAgICB2YXIgdGFyZ2V0ID0gKDAsIF9tZXRhbC5nZXQpKHRoaXMsICd0YXJnZXQnKTsKICAgICAgdmFyIG1ldGhvZCA9IHRhcmdldC5yZXBsYWNlUm91dGUgfHwgdGFyZ2V0LnJlcGxhY2VXaXRoOwoKICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yKSwgX2tleTIgPSAwOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgYXJnc1tfa2V5Ml0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICB9CgogICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KHRhcmdldCwgKDAsIF91dGlscy5wcmVmaXhSb3V0ZU5hbWVBcmcpKHRoaXMsIGFyZ3MpKTsKICAgIH0KICB9KTsKCiAgdmFyIF9kZWZhdWx0ID0gX2NvbnRyb2xsZXJfbWl4aW4uZGVmYXVsdDsKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL2xvY2F0aW9uL2FwaSIsIFsiZXhwb3J0cyIsICJAZW1iZXIvZGVidWciXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZGVidWcpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIC8qKgogIEBtb2R1bGUgQGVtYmVyL3JvdXRpbmcKICAqLwoKICAvKioKICAgIExvY2F0aW9uIHJldHVybnMgYW4gaW5zdGFuY2Ugb2YgdGhlIGNvcnJlY3QgaW1wbGVtZW50YXRpb24gb2YKICAgIHRoZSBgbG9jYXRpb25gIEFQSS4KICAKICAgICMjIEltcGxlbWVudGF0aW9ucwogIAogICAgWW91IGNhbiBwYXNzIGFuIGltcGxlbWVudGF0aW9uIG5hbWUgKGBoYXNoYCwgYGhpc3RvcnlgLCBgbm9uZWAsIGBhdXRvYCkgdG8gZm9yY2UgYQogICAgcGFydGljdWxhciBpbXBsZW1lbnRhdGlvbiB0byBiZSB1c2VkIGluIHlvdXIgYXBwbGljYXRpb24uCiAgCiAgICBTZWUgW0hhc2hMb2NhdGlvbl0oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9IYXNoTG9jYXRpb24pLgogICAgU2VlIFtIaXN0b3J5TG9jYXRpb25dKC9lbWJlci9yZWxlYXNlL2NsYXNzZXMvSGlzdG9yeUxvY2F0aW9uKS4KICAgIFNlZSBbTm9uZUxvY2F0aW9uXSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL05vbmVMb2NhdGlvbikuCiAgICBTZWUgW0F1dG9Mb2NhdGlvbl0oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9BdXRvTG9jYXRpb24pLgogIAogICAgIyMgTG9jYXRpb24gQVBJCiAgCiAgICBFYWNoIGxvY2F0aW9uIGltcGxlbWVudGF0aW9uIG11c3QgcHJvdmlkZSB0aGUgZm9sbG93aW5nIG1ldGhvZHM6CiAgCiAgICAqIGltcGxlbWVudGF0aW9uOiByZXR1cm5zIHRoZSBzdHJpbmcgbmFtZSB1c2VkIHRvIHJlZmVyZW5jZSB0aGUgaW1wbGVtZW50YXRpb24uCiAgICAqIGdldFVSTDogcmV0dXJucyB0aGUgY3VycmVudCBVUkwuCiAgICAqIHNldFVSTChwYXRoKTogc2V0cyB0aGUgY3VycmVudCBVUkwuCiAgICAqIHJlcGxhY2VVUkwocGF0aCk6IHJlcGxhY2UgdGhlIGN1cnJlbnQgVVJMIChvcHRpb25hbCkuCiAgICAqIG9uVXBkYXRlVVJMKGNhbGxiYWNrKTogdHJpZ2dlcnMgdGhlIGNhbGxiYWNrIHdoZW4gdGhlIFVSTCBjaGFuZ2VzLgogICAgKiBmb3JtYXRVUkwodXJsKTogZm9ybWF0cyBgdXJsYCB0byBiZSBwbGFjZWQgaW50byBgaHJlZmAgYXR0cmlidXRlLgogICAgKiBkZXRlY3QoKSAob3B0aW9uYWwpOiBpbnN0cnVjdHMgdGhlIGxvY2F0aW9uIHRvIGRvIGFueSBmZWF0dXJlIGRldGVjdGlvbgogICAgICAgIG5lY2Vzc2FyeS4gSWYgdGhlIGxvY2F0aW9uIG5lZWRzIHRvIHJlZGlyZWN0IHRvIGEgZGlmZmVyZW50IFVSTCwgaXQKICAgICAgICBjYW4gY2FuY2VsIHJvdXRpbmcgYnkgc2V0dGluZyB0aGUgYGNhbmNlbFJvdXRlclNldHVwYCBwcm9wZXJ0eSBvbiBpdHNlbGYKICAgICAgICB0byBgZmFsc2VgLgogIAogICAgQ2FsbGluZyBzZXRVUkwgb3IgcmVwbGFjZVVSTCB3aWxsIG5vdCB0cmlnZ2VyIG9uVXBkYXRlVVJMIGNhbGxiYWNrcy4KICAKICAgICMjIEN1c3RvbSBpbXBsZW1lbnRhdGlvbgogIAogICAgRW1iZXIgc2NhbnMgYGFwcC9sb2NhdGlvbnMvKmAgZm9yIGV4dGVuZGluZyB0aGUgTG9jYXRpb24gQVBJLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBIaXN0b3J5TG9jYXRpb24gZnJvbSAnQGVtYmVyL3JvdXRpbmcvaGlzdG9yeS1sb2NhdGlvbic7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBNeUhpc3RvcnkgewogICAgICBpbXBsZW1lbnRhdGlvbjogJ215LWN1c3RvbS1oaXN0b3J5JywKICAgICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgdGhpcy5faGlzdG9yeSA9IEhpc3RvcnlMb2NhdGlvbi5jcmVhdGUoLi4uYXJndW1lbnRzKTsKICAgICAgfQogICAgICBjcmVhdGUoKSB7CiAgICAgICAgcmV0dXJuIG5ldyB0aGlzKC4uLmFyZ3VtZW50cyk7CiAgICAgIH0KICAgICAgcHVzaFN0YXRlKHBhdGgpIHsKICAgICAgICAgdGhpcy5faGlzdG9yeS5wdXNoU3RhdGUocGF0aCk7CiAgICAgIH0KICAgIH0KICAgIGBgYAogIAogICAgQGNsYXNzIExvY2F0aW9uCiAgICBAcHJpdmF0ZQogICovCiAgdmFyIF9kZWZhdWx0ID0gewogICAgLyoqCiAgICAgVGhpcyBpcyBkZXByZWNhdGVkIGluIGZhdm9yIG9mIHVzaW5nIHRoZSBjb250YWluZXIgdG8gbG9va3VwIHRoZSBsb2NhdGlvbgogICAgIGltcGxlbWVudGF0aW9uIGFzIGRlc2lyZWQuCiAgICAgICAgRm9yIGV4YW1wbGU6CiAgICAgICAgYGBgamF2YXNjcmlwdAogICAgIC8vIEdpdmVuIGEgbG9jYXRpb24gcmVnaXN0ZXJlZCBhcyBmb2xsb3dzOgogICAgIGNvbnRhaW5lci5yZWdpc3RlcignbG9jYXRpb246aGlzdG9yeS10ZXN0JywgSGlzdG9yeVRlc3RMb2NhdGlvbik7CiAgICAgICAgLy8gWW91IGNvdWxkIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSB2aWE6CiAgICAgY29udGFpbmVyLmxvb2t1cCgnbG9jYXRpb246aGlzdG9yeS10ZXN0Jyk7CiAgICAgYGBgCiAgICAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgIEByZXR1cm4ge09iamVjdH0gYW4gaW5zdGFuY2Ugb2YgYW4gaW1wbGVtZW50YXRpb24gb2YgdGhlIGBsb2NhdGlvbmAgQVBJCiAgICAgIEBkZXByZWNhdGVkIFVzZSB0aGUgY29udGFpbmVyIHRvIGxvb2t1cCB0aGUgbG9jYXRpb24gaW1wbGVtZW50YXRpb24gdGhhdCB5b3UKICAgICAgbmVlZC4KICAgICAgQHByaXZhdGUKICAgICovCiAgICBjcmVhdGU6IGZ1bmN0aW9uIGNyZWF0ZShvcHRpb25zKSB7CiAgICAgIHZhciBpbXBsZW1lbnRhdGlvbiA9IG9wdGlvbnMgJiYgb3B0aW9ucy5pbXBsZW1lbnRhdGlvbjsKICAgICAgKGZhbHNlICYmICEoQm9vbGVhbihpbXBsZW1lbnRhdGlvbikpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiTG9jYXRpb24uY3JlYXRlOiB5b3UgbXVzdCBzcGVjaWZ5IGEgJ2ltcGxlbWVudGF0aW9uJyBvcHRpb24iLCBCb29sZWFuKGltcGxlbWVudGF0aW9uKSkpOwogICAgICB2YXIgaW1wbGVtZW50YXRpb25DbGFzcyA9IHRoaXMuaW1wbGVtZW50YXRpb25zW2ltcGxlbWVudGF0aW9uXTsKICAgICAgKGZhbHNlICYmICEoQm9vbGVhbihpbXBsZW1lbnRhdGlvbkNsYXNzKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJMb2NhdGlvbi5jcmVhdGU6ICIgKyBpbXBsZW1lbnRhdGlvbiArICIgaXMgbm90IGEgdmFsaWQgaW1wbGVtZW50YXRpb24iLCBCb29sZWFuKGltcGxlbWVudGF0aW9uQ2xhc3MpKSk7CiAgICAgIHJldHVybiBpbXBsZW1lbnRhdGlvbkNsYXNzLmNyZWF0ZS5hcHBseShpbXBsZW1lbnRhdGlvbkNsYXNzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIGltcGxlbWVudGF0aW9uczoge30KICB9OwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvbG9jYXRpb24vYXV0b19sb2NhdGlvbiIsIFsiZXhwb3J0cyIsICJlbWJlci1iYWJlbCIsICJAZW1iZXIvLWludGVybmFscy9icm93c2VyLWVudmlyb25tZW50IiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGFsIiwgIkBlbWJlci8taW50ZXJuYWxzL293bmVyIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUiLCAiQGVtYmVyLy1pbnRlcm5hbHMvdXRpbHMiLCAiQGVtYmVyL2RlYnVnIiwgIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL2xvY2F0aW9uL3V0aWwiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZW1iZXJCYWJlbCwgX2Jyb3dzZXJFbnZpcm9ubWVudCwgX21ldGFsLCBfb3duZXIsIF9ydW50aW1lLCBfdXRpbHMsIF9kZWJ1ZywgX3V0aWwpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmdldEhpc3RvcnlQYXRoID0gZ2V0SGlzdG9yeVBhdGg7CiAgX2V4cG9ydHMuZ2V0SGFzaFBhdGggPSBnZXRIYXNoUGF0aDsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICBAbW9kdWxlIEBlbWJlci9yb3V0aW5nCiAgKi8KCiAgLyoqCiAgICBBdXRvTG9jYXRpb24gd2lsbCBzZWxlY3QgdGhlIGJlc3QgbG9jYXRpb24gb3B0aW9uIGJhc2VkIG9mZiBicm93c2VyCiAgICBzdXBwb3J0IHdpdGggdGhlIHByaW9yaXR5IG9yZGVyOiBoaXN0b3J5LCBoYXNoLCBub25lLgogIAogICAgQ2xlYW4gcHVzaFN0YXRlIHBhdGhzIGFjY2Vzc2VkIGJ5IGhhc2hjaGFuZ2Utb25seSBicm93c2VycyB3aWxsIGJlIHJlZGlyZWN0ZWQKICAgIHRvIHRoZSBoYXNoLWVxdWl2YWxlbnQgYW5kIHZpY2UgdmVyc2Egc28gZnV0dXJlIHRyYW5zaXRpb25zIGFyZSBjb25zaXN0ZW50LgogIAogICAgS2VlcCBpbiBtaW5kIHRoYXQgc2luY2Ugc29tZSBvZiB5b3VyIHVzZXJzIHdpbGwgdXNlIGBIaXN0b3J5TG9jYXRpb25gLCB5b3VyCiAgICBzZXJ2ZXIgbXVzdCBzZXJ2ZSB0aGUgRW1iZXIgYXBwIGF0IGFsbCB0aGUgcm91dGVzIHlvdSBkZWZpbmUuCiAgCiAgICBCcm93c2VycyB0aGF0IHN1cHBvcnQgdGhlIGBoaXN0b3J5YCBBUEkgd2lsbCB1c2UgYEhpc3RvcnlMb2NhdGlvbmAsIHRob3NlIHRoYXQKICAgIGRvIG5vdCwgYnV0IHN0aWxsIHN1cHBvcnQgdGhlIGBoYXNoY2hhbmdlYCBldmVudCB3aWxsIHVzZSBgSGFzaExvY2F0aW9uYCwgYW5kCiAgICBpbiB0aGUgcmFyZSBjYXNlIG5laXRoZXIgaXMgc3VwcG9ydGVkIHdpbGwgdXNlIGBOb25lTG9jYXRpb25gLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGFwcC9yb3V0ZXIuanMKICAgIFJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucm91dGUoJ3Bvc3RzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yb3V0ZSgnbmV3Jyk7CiAgICAgIH0pOwogICAgfSk7CiAgCiAgICBSb3V0ZXIucmVvcGVuKHsKICAgICAgbG9jYXRpb246ICdhdXRvJwogICAgfSk7CiAgICBgYGAKICAKICAgIFRoaXMgd2lsbCByZXN1bHQgaW4gYSBwb3N0cy5uZXcgdXJsIG9mIGAvcG9zdHMvbmV3YCBmb3IgbW9kZXJuIGJyb3dzZXJzIHRoYXQKICAgIHN1cHBvcnQgdGhlIGBoaXN0b3J5YCBhcGkgb3IgYC8jL3Bvc3RzL25ld2AgZm9yIG9sZGVyIG9uZXMsIGxpa2UgSW50ZXJuZXQKICAgIEV4cGxvcmVyIDkgYW5kIGJlbG93LgogIAogICAgV2hlbiBhIHVzZXIgdmlzaXRzIGEgbGluayB0byB5b3VyIGFwcGxpY2F0aW9uLCB0aGV5IHdpbGwgYmUgYXV0b21hdGljYWxseQogICAgdXBncmFkZWQgb3IgZG93bmdyYWRlZCB0byB0aGUgYXBwcm9wcmlhdGUgYExvY2F0aW9uYCBjbGFzcywgd2l0aCB0aGUgVVJMCiAgICB0cmFuc2Zvcm1lZCBhY2NvcmRpbmdseSwgaWYgbmVlZGVkLgogIAogICAgS2VlcCBpbiBtaW5kIHRoYXQgc2luY2Ugc29tZSBvZiB5b3VyIHVzZXJzIHdpbGwgdXNlIGBIaXN0b3J5TG9jYXRpb25gLCB5b3VyCiAgICBzZXJ2ZXIgbXVzdCBzZXJ2ZSB0aGUgRW1iZXIgYXBwIGF0IGFsbCB0aGUgcm91dGVzIHlvdSBkZWZpbmUuCiAgCiAgICBAY2xhc3MgQXV0b0xvY2F0aW9uCiAgICBAc3RhdGljCiAgICBAcHJvdGVjdGVkCiAgKi8KICB2YXIgQXV0b0xvY2F0aW9uID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9FbWJlck9iamVjdCkgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKEF1dG9Mb2NhdGlvbiwgX0VtYmVyT2JqZWN0KTsKCiAgICBmdW5jdGlvbiBBdXRvTG9jYXRpb24oKSB7CiAgICAgIHZhciBfdGhpczsKCiAgICAgIF90aGlzID0gX0VtYmVyT2JqZWN0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgICAgX3RoaXMuaW1wbGVtZW50YXRpb24gPSAnYXV0byc7CiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KICAgIC8qKgogICAgIENhbGxlZCBieSB0aGUgcm91dGVyIHRvIGluc3RydWN0IHRoZSBsb2NhdGlvbiB0byBkbyBhbnkgZmVhdHVyZSBkZXRlY3Rpb24KICAgICBuZWNlc3NhcnkuIEluIHRoZSBjYXNlIG9mIEF1dG9Mb2NhdGlvbiwgd2UgZGV0ZWN0IHdoZXRoZXIgdG8gdXNlIGhpc3RvcnkKICAgICBvciBoYXNoIGNvbmNyZXRlIGltcGxlbWVudGF0aW9ucy4KICAgICAgICBAcHJpdmF0ZQogICAgKi8KCgogICAgdmFyIF9wcm90byA9IEF1dG9Mb2NhdGlvbi5wcm90b3R5cGU7CgogICAgX3Byb3RvLmRldGVjdCA9IGZ1bmN0aW9uIGRldGVjdCgpIHsKICAgICAgdmFyIHJvb3RVUkwgPSB0aGlzLnJvb3RVUkw7CiAgICAgIChmYWxzZSAmJiAhKHJvb3RVUkwuY2hhckF0KHJvb3RVUkwubGVuZ3RoIC0gMSkgPT09ICcvJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdyb290VVJMIG11c3QgZW5kIHdpdGggYSB0cmFpbGluZyBmb3J3YXJkIHNsYXNoIGUuZy4gIi9hcHAvIicsIHJvb3RVUkwuY2hhckF0KHJvb3RVUkwubGVuZ3RoIC0gMSkgPT09ICcvJykpOwogICAgICB2YXIgaW1wbGVtZW50YXRpb24gPSBkZXRlY3RJbXBsZW1lbnRhdGlvbih7CiAgICAgICAgbG9jYXRpb246IHRoaXMubG9jYXRpb24sCiAgICAgICAgaGlzdG9yeTogdGhpcy5oaXN0b3J5LAogICAgICAgIHVzZXJBZ2VudDogdGhpcy51c2VyQWdlbnQsCiAgICAgICAgcm9vdFVSTDogcm9vdFVSTCwKICAgICAgICBkb2N1bWVudE1vZGU6IHRoaXMuZG9jdW1lbnRNb2RlLAogICAgICAgIGdsb2JhbDogdGhpcy5nbG9iYWwKICAgICAgfSk7CgogICAgICBpZiAoaW1wbGVtZW50YXRpb24gPT09IGZhbHNlKSB7CiAgICAgICAgKDAsIF9tZXRhbC5zZXQpKHRoaXMsICdjYW5jZWxSb3V0ZXJTZXR1cCcsIHRydWUpOwogICAgICAgIGltcGxlbWVudGF0aW9uID0gJ25vbmUnOwogICAgICB9CgogICAgICB2YXIgY29uY3JldGUgPSAoMCwgX293bmVyLmdldE93bmVyKSh0aGlzKS5sb29rdXAoImxvY2F0aW9uOiIgKyBpbXBsZW1lbnRhdGlvbik7CiAgICAgIChmYWxzZSAmJiAhKGNvbmNyZXRlICE9PSB1bmRlZmluZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQ291bGQgbm90IGZpbmQgbG9jYXRpb24gJyIgKyBpbXBsZW1lbnRhdGlvbiArICInLiIsIGNvbmNyZXRlICE9PSB1bmRlZmluZWQpKTsKICAgICAgKDAsIF9tZXRhbC5zZXQpKGNvbmNyZXRlLCAncm9vdFVSTCcsIHJvb3RVUkwpOwogICAgICAoMCwgX21ldGFsLnNldCkodGhpcywgJ2NvbmNyZXRlSW1wbGVtZW50YXRpb24nLCBjb25jcmV0ZSk7CiAgICB9OwoKICAgIF9wcm90by53aWxsRGVzdHJveSA9IGZ1bmN0aW9uIHdpbGxEZXN0cm95KCkgewogICAgICB2YXIgY29uY3JldGVJbXBsZW1lbnRhdGlvbiA9IHRoaXMuY29uY3JldGVJbXBsZW1lbnRhdGlvbjsKCiAgICAgIGlmIChjb25jcmV0ZUltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgY29uY3JldGVJbXBsZW1lbnRhdGlvbi5kZXN0cm95KCk7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIEF1dG9Mb2NhdGlvbjsKICB9KF9ydW50aW1lLk9iamVjdCk7CgogIF9leHBvcnRzLmRlZmF1bHQgPSBBdXRvTG9jYXRpb247CiAgQXV0b0xvY2F0aW9uLnJlb3Blbih7CiAgICAvKioKICAgICAgQHByaXZhdGUKICAgICAgICAgV2lsbCBiZSBwcmUtcGVuZGVkIHRvIHBhdGggdXBvbiBzdGF0ZSBjaGFuZ2UuCiAgICAgICAgIEBzaW5jZSAxLjUuMQogICAgICBAcHJvcGVydHkgcm9vdFVSTAogICAgICBAZGVmYXVsdCAnLycKICAgICovCiAgICByb290VVJMOiAnLycsCiAgICBpbml0U3RhdGU6IGRlbGVnYXRlVG9Db25jcmV0ZUltcGxlbWVudGF0aW9uKCdpbml0U3RhdGUnKSwKICAgIGdldFVSTDogZGVsZWdhdGVUb0NvbmNyZXRlSW1wbGVtZW50YXRpb24oJ2dldFVSTCcpLAogICAgc2V0VVJMOiBkZWxlZ2F0ZVRvQ29uY3JldGVJbXBsZW1lbnRhdGlvbignc2V0VVJMJyksCiAgICByZXBsYWNlVVJMOiBkZWxlZ2F0ZVRvQ29uY3JldGVJbXBsZW1lbnRhdGlvbigncmVwbGFjZVVSTCcpLAogICAgb25VcGRhdGVVUkw6IGRlbGVnYXRlVG9Db25jcmV0ZUltcGxlbWVudGF0aW9uKCdvblVwZGF0ZVVSTCcpLAogICAgZm9ybWF0VVJMOiBkZWxlZ2F0ZVRvQ29uY3JldGVJbXBsZW1lbnRhdGlvbignZm9ybWF0VVJMJyksCgogICAgLyoqCiAgICAgIEBwcml2YXRlCiAgICAgICAgIFRoZSBicm93c2VyJ3MgYGxvY2F0aW9uYCBvYmplY3QuIFRoaXMgaXMgdHlwaWNhbGx5IGVxdWl2YWxlbnQgdG8KICAgICAgYHdpbmRvdy5sb2NhdGlvbmAsIGJ1dCBtYXkgYmUgb3ZlcnJpZGRlbiBmb3IgdGVzdGluZy4KICAgICAgICAgQHByb3BlcnR5IGxvY2F0aW9uCiAgICAgIEBkZWZhdWx0IGVudmlyb25tZW50LmxvY2F0aW9uCiAgICAqLwogICAgbG9jYXRpb246IF9icm93c2VyRW52aXJvbm1lbnQubG9jYXRpb24sCgogICAgLyoqCiAgICAgIEBwcml2YXRlCiAgICAgICAgIFRoZSBicm93c2VyJ3MgYGhpc3RvcnlgIG9iamVjdC4gVGhpcyBpcyB0eXBpY2FsbHkgZXF1aXZhbGVudCB0bwogICAgICBgd2luZG93Lmhpc3RvcnlgLCBidXQgbWF5IGJlIG92ZXJyaWRkZW4gZm9yIHRlc3RpbmcuCiAgICAgICAgIEBzaW5jZSAxLjUuMQogICAgICBAcHJvcGVydHkgaGlzdG9yeQogICAgICBAZGVmYXVsdCBlbnZpcm9ubWVudC5oaXN0b3J5CiAgICAqLwogICAgaGlzdG9yeTogX2Jyb3dzZXJFbnZpcm9ubWVudC5oaXN0b3J5LAoKICAgIC8qKgogICAgIEBwcml2YXRlCiAgICAgICAgVGhlIHVzZXIgYWdlbnQncyBnbG9iYWwgdmFyaWFibGUuIEluIGJyb3dzZXJzLCB0aGlzIHdpbGwgYmUgYHdpbmRvd2AuCiAgICAgICAgQHNpbmNlIDEuMTEKICAgICBAcHJvcGVydHkgZ2xvYmFsCiAgICAgQGRlZmF1bHQgd2luZG93CiAgICAqLwogICAgZ2xvYmFsOiBfYnJvd3NlckVudmlyb25tZW50LndpbmRvdywKCiAgICAvKioKICAgICAgQHByaXZhdGUKICAgICAgICAgVGhlIGJyb3dzZXIncyBgdXNlckFnZW50YC4gVGhpcyBpcyB0eXBpY2FsbHkgZXF1aXZhbGVudCB0bwogICAgICBgbmF2aWdhdG9yLnVzZXJBZ2VudGAsIGJ1dCBtYXkgYmUgb3ZlcnJpZGRlbiBmb3IgdGVzdGluZy4KICAgICAgICAgQHNpbmNlIDEuNS4xCiAgICAgIEBwcm9wZXJ0eSB1c2VyQWdlbnQKICAgICAgQGRlZmF1bHQgZW52aXJvbm1lbnQuaGlzdG9yeQogICAgKi8KICAgIHVzZXJBZ2VudDogX2Jyb3dzZXJFbnZpcm9ubWVudC51c2VyQWdlbnQsCgogICAgLyoqCiAgICAgIEBwcml2YXRlCiAgICAgICAgIFRoaXMgcHJvcGVydHkgaXMgdXNlZCBieSB0aGUgcm91dGVyIHRvIGtub3cgd2hldGhlciB0byBjYW5jZWwgdGhlIHJvdXRpbmcKICAgICAgc2V0dXAgcHJvY2Vzcywgd2hpY2ggaXMgbmVlZGVkIHdoaWxlIHdlIHJlZGlyZWN0IHRoZSBicm93c2VyLgogICAgICAgICBAc2luY2UgMS41LjEKICAgICAgQHByb3BlcnR5IGNhbmNlbFJvdXRlclNldHVwCiAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAqLwogICAgY2FuY2VsUm91dGVyU2V0dXA6IGZhbHNlCiAgfSk7CgogIGZ1bmN0aW9uIGRlbGVnYXRlVG9Db25jcmV0ZUltcGxlbWVudGF0aW9uKG1ldGhvZE5hbWUpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBjb25jcmV0ZUltcGxlbWVudGF0aW9uID0gdGhpcy5jb25jcmV0ZUltcGxlbWVudGF0aW9uOwogICAgICAoZmFsc2UgJiYgIShCb29sZWFuKGNvbmNyZXRlSW1wbGVtZW50YXRpb24pKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkF1dG9Mb2NhdGlvbidzIGRldGVjdCgpIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIGJlZm9yZSBjYWxsaW5nIGFueSBvdGhlciBob29rcy4iLCBCb29sZWFuKGNvbmNyZXRlSW1wbGVtZW50YXRpb24pKSk7CgogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CgogICAgICByZXR1cm4gKDAsIF91dGlscy50cnlJbnZva2UpKGNvbmNyZXRlSW1wbGVtZW50YXRpb24sIG1ldGhvZE5hbWUsIGFyZ3MpOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIGRldGVjdEltcGxlbWVudGF0aW9uKG9wdGlvbnMpIHsKICAgIHZhciBsb2NhdGlvbiA9IG9wdGlvbnMubG9jYXRpb24sCiAgICAgICAgdXNlckFnZW50ID0gb3B0aW9ucy51c2VyQWdlbnQsCiAgICAgICAgaGlzdG9yeSA9IG9wdGlvbnMuaGlzdG9yeSwKICAgICAgICBkb2N1bWVudE1vZGUgPSBvcHRpb25zLmRvY3VtZW50TW9kZSwKICAgICAgICBnbG9iYWwgPSBvcHRpb25zLmdsb2JhbCwKICAgICAgICByb290VVJMID0gb3B0aW9ucy5yb290VVJMOwogICAgdmFyIGltcGxlbWVudGF0aW9uID0gJ25vbmUnOwogICAgdmFyIGNhbmNlbFJvdXRlclNldHVwID0gZmFsc2U7CiAgICB2YXIgY3VycmVudFBhdGggPSAoMCwgX3V0aWwuZ2V0RnVsbFBhdGgpKGxvY2F0aW9uKTsKCiAgICBpZiAoKDAsIF91dGlsLnN1cHBvcnRzSGlzdG9yeSkodXNlckFnZW50LCBoaXN0b3J5KSkgewogICAgICB2YXIgaGlzdG9yeVBhdGggPSBnZXRIaXN0b3J5UGF0aChyb290VVJMLCBsb2NhdGlvbik7IC8vIElmIHRoZSBicm93c2VyIHN1cHBvcnRzIGhpc3RvcnkgYW5kIHdlIGhhdmUgYSBoaXN0b3J5IHBhdGgsIHdlIGNhbiB1c2UKICAgICAgLy8gdGhlIGhpc3RvcnkgbG9jYXRpb24gd2l0aCBubyByZWRpcmVjdHMuCgogICAgICBpZiAoY3VycmVudFBhdGggPT09IGhpc3RvcnlQYXRoKSB7CiAgICAgICAgaW1wbGVtZW50YXRpb24gPSAnaGlzdG9yeSc7CiAgICAgIH0gZWxzZSBpZiAoY3VycmVudFBhdGguc3Vic3RyKDAsIDIpID09PSAnLyMnKSB7CiAgICAgICAgaGlzdG9yeS5yZXBsYWNlU3RhdGUoewogICAgICAgICAgcGF0aDogaGlzdG9yeVBhdGgKICAgICAgICB9LCAnJywgaGlzdG9yeVBhdGgpOwogICAgICAgIGltcGxlbWVudGF0aW9uID0gJ2hpc3RvcnknOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbmNlbFJvdXRlclNldHVwID0gdHJ1ZTsKICAgICAgICAoMCwgX3V0aWwucmVwbGFjZVBhdGgpKGxvY2F0aW9uLCBoaXN0b3J5UGF0aCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoKDAsIF91dGlsLnN1cHBvcnRzSGFzaENoYW5nZSkoZG9jdW1lbnRNb2RlLCBnbG9iYWwpKSB7CiAgICAgIHZhciBoYXNoUGF0aCA9IGdldEhhc2hQYXRoKHJvb3RVUkwsIGxvY2F0aW9uKTsgLy8gQmUgc3VyZSB3ZSdyZSB1c2luZyBhIGhhc2hlZCBwYXRoLCBvdGhlcndpc2UgbGV0J3Mgc3dpdGNoIG92ZXIgaXQgdG8gc28KICAgICAgLy8gd2Ugc3RhcnQgb2ZmIGNsZWFuIGFuZCBjb25zaXN0ZW50LiBXZSdsbCBjb3VudCBhbiBpbmRleCBwYXRoIHdpdGggbm8KICAgICAgLy8gaGFzaCBhcyAiZ29vZCBlbm91Z2giIGFzIHdlbGwuCgogICAgICBpZiAoY3VycmVudFBhdGggPT09IGhhc2hQYXRoIHx8IGN1cnJlbnRQYXRoID09PSAnLycgJiYgaGFzaFBhdGggPT09ICcvIy8nKSB7CiAgICAgICAgaW1wbGVtZW50YXRpb24gPSAnaGFzaCc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gT3VyIFVSTCBpc24ndCBpbiB0aGUgZXhwZWN0ZWQgaGFzaC1zdXBwb3J0ZWQgZm9ybWF0LCBzbyB3ZSB3YW50IHRvCiAgICAgICAgLy8gY2FuY2VsIHRoZSByb3V0ZXIgc2V0dXAgYW5kIHJlcGxhY2UgdGhlIFVSTCB0byBzdGFydCBvZmYgY2xlYW4KICAgICAgICBjYW5jZWxSb3V0ZXJTZXR1cCA9IHRydWU7CiAgICAgICAgKDAsIF91dGlsLnJlcGxhY2VQYXRoKShsb2NhdGlvbiwgaGFzaFBhdGgpOwogICAgICB9CiAgICB9CgogICAgaWYgKGNhbmNlbFJvdXRlclNldHVwKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gaW1wbGVtZW50YXRpb247CiAgfQogIC8qKgogICAgQHByaXZhdGUKICAKICAgIFJldHVybnMgdGhlIGN1cnJlbnQgcGF0aCBhcyBpdCBzaG91bGQgYXBwZWFyIGZvciBIaXN0b3J5TG9jYXRpb24gc3VwcG9ydGVkCiAgICBicm93c2Vycy4gVGhpcyBtYXkgdmVyeSB3ZWxsIGRpZmZlciBmcm9tIHRoZSByZWFsIGN1cnJlbnQgcGF0aCAoZS5nLiBpZiBpdAogICAgc3RhcnRzIG9mZiBhcyBhIGhhc2hlZCBVUkwpCiAgKi8KCgogIGZ1bmN0aW9uIGdldEhpc3RvcnlQYXRoKHJvb3RVUkwsIGxvY2F0aW9uKSB7CiAgICB2YXIgcGF0aCA9ICgwLCBfdXRpbC5nZXRQYXRoKShsb2NhdGlvbik7CiAgICB2YXIgaGFzaCA9ICgwLCBfdXRpbC5nZXRIYXNoKShsb2NhdGlvbik7CiAgICB2YXIgcXVlcnkgPSAoMCwgX3V0aWwuZ2V0UXVlcnkpKGxvY2F0aW9uKTsKICAgIHZhciByb290VVJMSW5kZXggPSBwYXRoLmluZGV4T2Yocm9vdFVSTCk7CiAgICB2YXIgcm91dGVIYXNoLCBoYXNoUGFydHM7CiAgICAoZmFsc2UgJiYgIShyb290VVJMSW5kZXggPT09IDApICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiUGF0aCAiICsgcGF0aCArICIgZG9lcyBub3Qgc3RhcnQgd2l0aCB0aGUgcHJvdmlkZWQgcm9vdFVSTCAiICsgcm9vdFVSTCwgcm9vdFVSTEluZGV4ID09PSAwKSk7IC8vIEJ5IGNvbnZlbnRpb24sIEVtYmVyLmpzIHJvdXRlcyB1c2luZyBIYXNoTG9jYXRpb24gYXJlIHJlcXVpcmVkIHRvIHN0YXJ0CiAgICAvLyB3aXRoIGAjL2AuIEFueXRoaW5nIGVsc2Ugc2hvdWxkIE5PVCBiZSBjb25zaWRlcmVkIGEgcm91dGUgYW5kIHNob3VsZAogICAgLy8gYmUgcGFzc2VkIHN0cmFpZ2h0IHRocm91Z2gsIHdpdGhvdXQgdHJhbnNmb3JtYXRpb24uCgogICAgaWYgKGhhc2guc3Vic3RyKDAsIDIpID09PSAnIy8nKSB7CiAgICAgIC8vIFRoZXJlIGNvdWxkIGJlIGV4dHJhIGhhc2ggc2VnbWVudHMgYWZ0ZXIgdGhlIHJvdXRlCiAgICAgIGhhc2hQYXJ0cyA9IGhhc2guc3Vic3RyKDEpLnNwbGl0KCcjJyk7IC8vIFRoZSBmaXJzdCBvbmUgaXMgYWx3YXlzIHRoZSByb3V0ZSB1cmwKCiAgICAgIHJvdXRlSGFzaCA9IGhhc2hQYXJ0cy5zaGlmdCgpOyAvLyBJZiB0aGUgcGF0aCBhbHJlYWR5IGhhcyBhIHRyYWlsaW5nIHNsYXNoLCByZW1vdmUgdGhlIG9uZQogICAgICAvLyBmcm9tIHRoZSBoYXNoZWQgcm91dGUgc28gd2UgZG9uJ3QgZG91YmxlIHVwLgoKICAgICAgaWYgKHBhdGguY2hhckF0KHBhdGgubGVuZ3RoIC0gMSkgPT09ICcvJykgewogICAgICAgIHJvdXRlSGFzaCA9IHJvdXRlSGFzaC5zdWJzdHIoMSk7CiAgICAgIH0gLy8gVGhpcyBpcyB0aGUgImV4cGVjdGVkIiBmaW5hbCBvcmRlcgoKCiAgICAgIHBhdGggKz0gcm91dGVIYXNoICsgcXVlcnk7CgogICAgICBpZiAoaGFzaFBhcnRzLmxlbmd0aCkgewogICAgICAgIHBhdGggKz0gIiMiICsgaGFzaFBhcnRzLmpvaW4oJyMnKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcGF0aCArPSBxdWVyeSArIGhhc2g7CiAgICB9CgogICAgcmV0dXJuIHBhdGg7CiAgfQogIC8qKgogICAgQHByaXZhdGUKICAKICAgIFJldHVybnMgdGhlIGN1cnJlbnQgcGF0aCBhcyBpdCBzaG91bGQgYXBwZWFyIGZvciBIYXNoTG9jYXRpb24gc3VwcG9ydGVkCiAgICBicm93c2Vycy4gVGhpcyBtYXkgdmVyeSB3ZWxsIGRpZmZlciBmcm9tIHRoZSByZWFsIGN1cnJlbnQgcGF0aC4KICAKICAgIEBtZXRob2QgX2dldEhhc2hQYXRoCiAgKi8KCgogIGZ1bmN0aW9uIGdldEhhc2hQYXRoKHJvb3RVUkwsIGxvY2F0aW9uKSB7CiAgICB2YXIgcGF0aCA9IHJvb3RVUkw7CiAgICB2YXIgaGlzdG9yeVBhdGggPSBnZXRIaXN0b3J5UGF0aChyb290VVJMLCBsb2NhdGlvbik7CiAgICB2YXIgcm91dGVQYXRoID0gaGlzdG9yeVBhdGguc3Vic3RyKHJvb3RVUkwubGVuZ3RoKTsKCiAgICBpZiAocm91dGVQYXRoICE9PSAnJykgewogICAgICBpZiAocm91dGVQYXRoWzBdICE9PSAnLycpIHsKICAgICAgICByb3V0ZVBhdGggPSAiLyIgKyByb3V0ZVBhdGg7CiAgICAgIH0KCiAgICAgIHBhdGggKz0gIiMiICsgcm91dGVQYXRoOwogICAgfQoKICAgIHJldHVybiBwYXRoOwogIH0KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvbG9jYXRpb24vaGFzaF9sb2NhdGlvbiIsIFsiZXhwb3J0cyIsICJlbWJlci1iYWJlbCIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lIiwgIkBlbWJlci9ydW5sb29wIiwgIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL2xvY2F0aW9uL3V0aWwiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZW1iZXJCYWJlbCwgX21ldGFsLCBfcnVudGltZSwgX3J1bmxvb3AsIF91dGlsKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICBAbW9kdWxlIEBlbWJlci9yb3V0aW5nCiAgKi8KCiAgLyoqCiAgICBgSGFzaExvY2F0aW9uYCBpbXBsZW1lbnRzIHRoZSBsb2NhdGlvbiBBUEkgdXNpbmcgdGhlIGJyb3dzZXIncwogICAgaGFzaC4gQXQgcHJlc2VudCwgaXQgcmVsaWVzIG9uIGEgYGhhc2hjaGFuZ2VgIGV2ZW50IGV4aXN0aW5nIGluIHRoZQogICAgYnJvd3Nlci4KICAKICAgIFVzaW5nIGBIYXNoTG9jYXRpb25gIHJlc3VsdHMgaW4gVVJMcyB3aXRoIGEgYCNgIChoYXNoIHNpZ24pIHNlcGFyYXRpbmcgdGhlCiAgICBzZXJ2ZXIgc2lkZSBVUkwgcG9ydGlvbiBvZiB0aGUgVVJMIGZyb20gdGhlIHBvcnRpb24gdGhhdCBpcyB1c2VkIGJ5IEVtYmVyLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGFwcC9yb3V0ZXIuanMKICAgIFJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucm91dGUoJ3Bvc3RzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yb3V0ZSgnbmV3Jyk7CiAgICAgIH0pOwogICAgfSk7CiAgCiAgICBSb3V0ZXIucmVvcGVuKHsKICAgICAgbG9jYXRpb246ICdoYXNoJwogICAgfSk7CiAgICBgYGAKICAKICAgIFRoaXMgd2lsbCByZXN1bHQgaW4gYSBwb3N0cy5uZXcgdXJsIG9mIGAvIy9wb3N0cy9uZXdgLgogIAogICAgQGNsYXNzIEhhc2hMb2NhdGlvbgogICAgQGV4dGVuZHMgRW1iZXJPYmplY3QKICAgIEBwcm90ZWN0ZWQKICAqLwogIHZhciBIYXNoTG9jYXRpb24gPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0VtYmVyT2JqZWN0KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoSGFzaExvY2F0aW9uLCBfRW1iZXJPYmplY3QpOwoKICAgIGZ1bmN0aW9uIEhhc2hMb2NhdGlvbigpIHsKICAgICAgdmFyIF90aGlzOwoKICAgICAgX3RoaXMgPSBfRW1iZXJPYmplY3QuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgICBfdGhpcy5pbXBsZW1lbnRhdGlvbiA9ICdoYXNoJzsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBIYXNoTG9jYXRpb24ucHJvdG90eXBlOwoKICAgIF9wcm90by5pbml0ID0gZnVuY3Rpb24gaW5pdCgpIHsKICAgICAgKDAsIF9tZXRhbC5zZXQpKHRoaXMsICdsb2NhdGlvbicsIHRoaXMuX2xvY2F0aW9uIHx8IHdpbmRvdy5sb2NhdGlvbik7CiAgICAgIHRoaXMuX2hhc2hjaGFuZ2VIYW5kbGVyID0gdW5kZWZpbmVkOwogICAgfQogICAgLyoqCiAgICAgIEBwcml2YXRlCiAgICAgICAgIFJldHVybnMgbm9ybWFsaXplZCBsb2NhdGlvbi5oYXNoCiAgICAgICAgIEBzaW5jZSAxLjUuMQogICAgICBAbWV0aG9kIGdldEhhc2gKICAgICovCiAgICA7CgogICAgX3Byb3RvLmdldEhhc2ggPSBmdW5jdGlvbiBnZXRIYXNoKCkgewogICAgICByZXR1cm4gKDAsIF91dGlsLmdldEhhc2gpKHRoaXMubG9jYXRpb24pOwogICAgfQogICAgLyoqCiAgICAgIFJldHVybnMgdGhlIG5vcm1hbGl6ZWQgVVJMLCBjb25zdHJ1Y3RlZCBmcm9tIGBsb2NhdGlvbi5oYXNoYC4KICAgICAgICAgZS5nLiBgIy9mb29gID0+IGAvZm9vYCBhcyB3ZWxsIGFzIGAjL2ZvbyNiYXJgID0+IGAvZm9vI2JhcmAuCiAgICAgICAgIEJ5IGNvbnZlbnRpb24sIGhhc2hlZCBwYXRocyBtdXN0IGJlZ2luIHdpdGggYSBmb3J3YXJkIHNsYXNoLCBvdGhlcndpc2UgdGhleQogICAgICBhcmUgbm90IHRyZWF0ZWQgYXMgYSBwYXRoIHNvIHdlIGNhbiBkaXN0aW5ndWlzaCBpbnRlbnQuCiAgICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgZ2V0VVJMCiAgICAqLwogICAgOwoKICAgIF9wcm90by5nZXRVUkwgPSBmdW5jdGlvbiBnZXRVUkwoKSB7CiAgICAgIHZhciBvcmlnaW5hbFBhdGggPSB0aGlzLmdldEhhc2goKS5zdWJzdHIoMSk7CiAgICAgIHZhciBvdXRQYXRoID0gb3JpZ2luYWxQYXRoOwoKICAgICAgaWYgKG91dFBhdGhbMF0gIT09ICcvJykgewogICAgICAgIG91dFBhdGggPSAnLyc7IC8vIE9ubHkgYWRkIHRoZSAjIGlmIHRoZSBwYXRoIGlzbid0IGVtcHR5LgogICAgICAgIC8vIFdlIGRvIE5PVCB3YW50IGAvI2Agc2luY2UgdGhlIGFtcGVyc2FuZAogICAgICAgIC8vIGlzIG9ubHkgaW5jbHVkZWQgKGNvbnZlbnRpb25hbGx5KSB3aGVuCiAgICAgICAgLy8gdGhlIGxvY2F0aW9uLmhhc2ggaGFzIGEgdmFsdWUKCiAgICAgICAgaWYgKG9yaWdpbmFsUGF0aCkgewogICAgICAgICAgb3V0UGF0aCArPSAiIyIgKyBvcmlnaW5hbFBhdGg7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gb3V0UGF0aDsKICAgIH0KICAgIC8qKgogICAgICBTZXQgdGhlIGBsb2NhdGlvbi5oYXNoYCBhbmQgcmVtZW1iZXJzIHdoYXQgd2FzIHNldC4gVGhpcyBwcmV2ZW50cwogICAgICBgb25VcGRhdGVVUkxgIGNhbGxiYWNrcyBmcm9tIHRyaWdnZXJpbmcgd2hlbiB0aGUgaGFzaCB3YXMgc2V0IGJ5CiAgICAgIGBIYXNoTG9jYXRpb25gLgogICAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIHNldFVSTAogICAgICBAcGFyYW0gcGF0aCB7U3RyaW5nfQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uc2V0VVJMID0gZnVuY3Rpb24gc2V0VVJMKHBhdGgpIHsKICAgICAgdGhpcy5sb2NhdGlvbi5oYXNoID0gcGF0aDsKICAgICAgKDAsIF9tZXRhbC5zZXQpKHRoaXMsICdsYXN0U2V0VVJMJywgcGF0aCk7CiAgICB9CiAgICAvKioKICAgICAgVXNlcyBsb2NhdGlvbi5yZXBsYWNlIHRvIHVwZGF0ZSB0aGUgdXJsIHdpdGhvdXQgYSBwYWdlIHJlbG9hZAogICAgICBvciBoaXN0b3J5IG1vZGlmaWNhdGlvbi4KICAgICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCByZXBsYWNlVVJMCiAgICAgIEBwYXJhbSBwYXRoIHtTdHJpbmd9CiAgICAqLwogICAgOwoKICAgIF9wcm90by5yZXBsYWNlVVJMID0gZnVuY3Rpb24gcmVwbGFjZVVSTChwYXRoKSB7CiAgICAgIHRoaXMubG9jYXRpb24ucmVwbGFjZSgiIyIgKyBwYXRoKTsKICAgICAgKDAsIF9tZXRhbC5zZXQpKHRoaXMsICdsYXN0U2V0VVJMJywgcGF0aCk7CiAgICB9CiAgICAvKioKICAgICAgUmVnaXN0ZXIgYSBjYWxsYmFjayB0byBiZSBpbnZva2VkIHdoZW4gdGhlIGhhc2ggY2hhbmdlcy4gVGhlc2UKICAgICAgY2FsbGJhY2tzIHdpbGwgZXhlY3V0ZSB3aGVuIHRoZSB1c2VyIHByZXNzZXMgdGhlIGJhY2sgb3IgZm9yd2FyZAogICAgICBidXR0b24sIGJ1dCBub3QgYWZ0ZXIgYHNldFVSTGAgaXMgaW52b2tlZC4KICAgICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBvblVwZGF0ZVVSTAogICAgICBAcGFyYW0gY2FsbGJhY2sge0Z1bmN0aW9ufQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ub25VcGRhdGVVUkwgPSBmdW5jdGlvbiBvblVwZGF0ZVVSTChjYWxsYmFjaykgewogICAgICB0aGlzLl9yZW1vdmVFdmVudExpc3RlbmVyKCk7CgogICAgICB0aGlzLl9oYXNoY2hhbmdlSGFuZGxlciA9ICgwLCBfcnVubG9vcC5iaW5kKSh0aGlzLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHBhdGggPSB0aGlzLmdldFVSTCgpOwoKICAgICAgICBpZiAodGhpcy5sYXN0U2V0VVJMID09PSBwYXRoKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAoMCwgX21ldGFsLnNldCkodGhpcywgJ2xhc3RTZXRVUkwnLCBudWxsKTsKICAgICAgICBjYWxsYmFjayhwYXRoKTsKICAgICAgfSk7CiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdoYXNoY2hhbmdlJywgdGhpcy5faGFzaGNoYW5nZUhhbmRsZXIpOwogICAgfQogICAgLyoqCiAgICAgIEdpdmVuIGEgVVJMLCBmb3JtYXRzIGl0IHRvIGJlIHBsYWNlZCBpbnRvIHRoZSBwYWdlIGFzIHBhcnQKICAgICAgb2YgYW4gZWxlbWVudCdzIGBocmVmYCBhdHRyaWJ1dGUuCiAgICAgICAgIFRoaXMgaXMgdXNlZCwgZm9yIGV4YW1wbGUsIHdoZW4gdXNpbmcgdGhlIHt7YWN0aW9ufX0gaGVscGVyCiAgICAgIHRvIGdlbmVyYXRlIGEgVVJMIGJhc2VkIG9uIGFuIGV2ZW50LgogICAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIGZvcm1hdFVSTAogICAgICBAcGFyYW0gdXJsIHtTdHJpbmd9CiAgICAqLwogICAgOwoKICAgIF9wcm90by5mb3JtYXRVUkwgPSBmdW5jdGlvbiBmb3JtYXRVUkwodXJsKSB7CiAgICAgIHJldHVybiAiIyIgKyB1cmw7CiAgICB9CiAgICAvKioKICAgICAgQ2xlYW5zIHVwIHRoZSBIYXNoTG9jYXRpb24gZXZlbnQgbGlzdGVuZXIuCiAgICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2Qgd2lsbERlc3Ryb3kKICAgICovCiAgICA7CgogICAgX3Byb3RvLndpbGxEZXN0cm95ID0gZnVuY3Rpb24gd2lsbERlc3Ryb3koKSB7CiAgICAgIHRoaXMuX3JlbW92ZUV2ZW50TGlzdGVuZXIoKTsKICAgIH07CgogICAgX3Byb3RvLl9yZW1vdmVFdmVudExpc3RlbmVyID0gZnVuY3Rpb24gX3JlbW92ZUV2ZW50TGlzdGVuZXIoKSB7CiAgICAgIGlmICh0aGlzLl9oYXNoY2hhbmdlSGFuZGxlcikgewogICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdoYXNoY2hhbmdlJywgdGhpcy5faGFzaGNoYW5nZUhhbmRsZXIpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBIYXNoTG9jYXRpb247CiAgfShfcnVudGltZS5PYmplY3QpOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gSGFzaExvY2F0aW9uOwp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9yb3V0aW5nL2xpYi9sb2NhdGlvbi9oaXN0b3J5X2xvY2F0aW9uIiwgWyJleHBvcnRzIiwgImVtYmVyLWJhYmVsIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGFsIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvbG9jYXRpb24vdXRpbCJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9lbWJlckJhYmVsLCBfbWV0YWwsIF9ydW50aW1lLCBfdXRpbCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvcm91dGluZwogICovCiAgdmFyIHBvcHN0YXRlRmlyZWQgPSBmYWxzZTsKCiAgZnVuY3Rpb24gX3V1aWQoKSB7CiAgICByZXR1cm4gJ3h4eHh4eHh4LXh4eHgtNHh4eC15eHh4LXh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3h5XS9nLCBmdW5jdGlvbiAoYykgewogICAgICB2YXIgciwgdjsKICAgICAgciA9IE1hdGgucmFuZG9tKCkgKiAxNiB8IDA7CiAgICAgIHYgPSBjID09PSAneCcgPyByIDogciAmIDMgfCA4OwogICAgICByZXR1cm4gdi50b1N0cmluZygxNik7CiAgICB9KTsKICB9CiAgLyoqCiAgICBIaXN0b3J5TG9jYXRpb24gaW1wbGVtZW50cyB0aGUgbG9jYXRpb24gQVBJIHVzaW5nIHRoZSBicm93c2VyJ3MKICAgIGhpc3RvcnkucHVzaFN0YXRlIEFQSS4KICAKICAgIFVzaW5nIGBIaXN0b3J5TG9jYXRpb25gIHJlc3VsdHMgaW4gVVJMcyB0aGF0IGFyZSBpbmRpc3Rpbmd1aXNoYWJsZSBmcm9tIGEKICAgIHN0YW5kYXJkIFVSTC4gVGhpcyByZWxpZXMgdXBvbiB0aGUgYnJvd3NlcidzIGBoaXN0b3J5YCBBUEkuCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgYXBwL3JvdXRlci5qcwogICAgUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICAgdGhpcy5yb3V0ZSgncG9zdHMnLCBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJvdXRlKCduZXcnKTsKICAgICAgfSk7CiAgICB9KTsKICAKICAgIFJvdXRlci5yZW9wZW4oewogICAgICBsb2NhdGlvbjogJ2hpc3RvcnknCiAgICB9KTsKICAgIGBgYAogIAogICAgVGhpcyB3aWxsIHJlc3VsdCBpbiBhIHBvc3RzLm5ldyB1cmwgb2YgYC9wb3N0cy9uZXdgLgogIAogICAgS2VlcCBpbiBtaW5kIHRoYXQgeW91ciBzZXJ2ZXIgbXVzdCBzZXJ2ZSB0aGUgRW1iZXIgYXBwIGF0IGFsbCB0aGUgcm91dGVzIHlvdQogICAgZGVmaW5lLgogIAogICAgQGNsYXNzIEhpc3RvcnlMb2NhdGlvbgogICAgQGV4dGVuZHMgRW1iZXJPYmplY3QKICAgIEBwcm90ZWN0ZWQKICAqLwoKCiAgdmFyIEhpc3RvcnlMb2NhdGlvbiA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfRW1iZXJPYmplY3QpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShIaXN0b3J5TG9jYXRpb24sIF9FbWJlck9iamVjdCk7CgogICAgZnVuY3Rpb24gSGlzdG9yeUxvY2F0aW9uKCkgewogICAgICB2YXIgX3RoaXM7CgogICAgICBfdGhpcyA9IF9FbWJlck9iamVjdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICAgIF90aGlzLmltcGxlbWVudGF0aW9uID0gJ2hpc3RvcnknOwogICAgICAvKioKICAgICAgICBXaWxsIGJlIHByZS1wZW5kZWQgdG8gcGF0aCB1cG9uIHN0YXRlIGNoYW5nZQogICAgICAgICAgICAgICBAcHJvcGVydHkgcm9vdFVSTAogICAgICAgIEBkZWZhdWx0ICcvJwogICAgICAgIEBwcml2YXRlCiAgICAgICovCgogICAgICBfdGhpcy5yb290VVJMID0gJy8nOwogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CiAgICAvKioKICAgICAgQHByaXZhdGUKICAgICAgICAgUmV0dXJucyBub3JtYWxpemVkIGxvY2F0aW9uLmhhc2gKICAgICAgICAgQG1ldGhvZCBnZXRIYXNoCiAgICAqLwoKCiAgICB2YXIgX3Byb3RvID0gSGlzdG9yeUxvY2F0aW9uLnByb3RvdHlwZTsKCiAgICBfcHJvdG8uZ2V0SGFzaCA9IGZ1bmN0aW9uIGdldEhhc2goKSB7CiAgICAgIHJldHVybiAoMCwgX3V0aWwuZ2V0SGFzaCkodGhpcy5sb2NhdGlvbik7CiAgICB9OwoKICAgIF9wcm90by5pbml0ID0gZnVuY3Rpb24gaW5pdCgpIHsKICAgICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgIHZhciBiYXNlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYmFzZScpOwogICAgICB2YXIgYmFzZVVSTCA9ICcnOwoKICAgICAgaWYgKGJhc2UpIHsKICAgICAgICBiYXNlVVJMID0gYmFzZS5nZXRBdHRyaWJ1dGUoJ2hyZWYnKTsKICAgICAgfQoKICAgICAgKDAsIF9tZXRhbC5zZXQpKHRoaXMsICdiYXNlVVJMJywgYmFzZVVSTCk7CiAgICAgICgwLCBfbWV0YWwuc2V0KSh0aGlzLCAnbG9jYXRpb24nLCB0aGlzLmxvY2F0aW9uIHx8IHdpbmRvdy5sb2NhdGlvbik7CiAgICAgIHRoaXMuX3BvcHN0YXRlSGFuZGxlciA9IHVuZGVmaW5lZDsKICAgIH0KICAgIC8qKgogICAgICBVc2VkIHRvIHNldCBzdGF0ZSBvbiBmaXJzdCBjYWxsIHRvIHNldFVSTAogICAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIGluaXRTdGF0ZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uaW5pdFN0YXRlID0gZnVuY3Rpb24gaW5pdFN0YXRlKCkgewogICAgICB2YXIgaGlzdG9yeSA9IHRoaXMuaGlzdG9yeSB8fCB3aW5kb3cuaGlzdG9yeTsKICAgICAgKDAsIF9tZXRhbC5zZXQpKHRoaXMsICdoaXN0b3J5JywgaGlzdG9yeSk7CgogICAgICBpZiAoaGlzdG9yeSAmJiAnc3RhdGUnIGluIGhpc3RvcnkpIHsKICAgICAgICB0aGlzLnN1cHBvcnRzSGlzdG9yeSA9IHRydWU7CiAgICAgIH0KCiAgICAgIHZhciBzdGF0ZSA9IHRoaXMuZ2V0U3RhdGUoKTsKICAgICAgdmFyIHBhdGggPSB0aGlzLmZvcm1hdFVSTCh0aGlzLmdldFVSTCgpKTsKCiAgICAgIGlmIChzdGF0ZSAmJiBzdGF0ZS5wYXRoID09PSBwYXRoKSB7CiAgICAgICAgLy8gcHJlc2VydmUgZXhpc3Rpbmcgc3RhdGUKICAgICAgICAvLyB1c2VkIGZvciB3ZWJraXQgd29ya2Fyb3VuZCwgc2luY2UgdGhlcmUgd2lsbCBiZSBubyBpbml0aWFsIHBvcHN0YXRlIGV2ZW50CiAgICAgICAgdGhpcy5fcHJldmlvdXNVUkwgPSB0aGlzLmdldFVSTCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucmVwbGFjZVN0YXRlKHBhdGgpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAgUmV0dXJucyB0aGUgY3VycmVudCBgbG9jYXRpb24ucGF0aG5hbWVgIHdpdGhvdXQgYHJvb3RVUkxgIG9yIGBiYXNlVVJMYAogICAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIGdldFVSTAogICAgICBAcmV0dXJuIHVybCB7U3RyaW5nfQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uZ2V0VVJMID0gZnVuY3Rpb24gZ2V0VVJMKCkgewogICAgICB2YXIgbG9jYXRpb24gPSB0aGlzLmxvY2F0aW9uLAogICAgICAgICAgcm9vdFVSTCA9IHRoaXMucm9vdFVSTCwKICAgICAgICAgIGJhc2VVUkwgPSB0aGlzLmJhc2VVUkw7CiAgICAgIHZhciBwYXRoID0gbG9jYXRpb24ucGF0aG5hbWU7IC8vIHJlbW92ZSB0cmFpbGluZyBzbGFzaGVzIGlmIHRoZXkgZXhpc3RzCgogICAgICByb290VVJMID0gcm9vdFVSTC5yZXBsYWNlKC9cLyQvLCAnJyk7CiAgICAgIGJhc2VVUkwgPSBiYXNlVVJMLnJlcGxhY2UoL1wvJC8sICcnKTsgLy8gcmVtb3ZlIGJhc2VVUkwgYW5kIHJvb3RVUkwgZnJvbSBzdGFydCBvZiBwYXRoCgogICAgICB2YXIgdXJsID0gcGF0aC5yZXBsYWNlKG5ldyBSZWdFeHAoIl4iICsgYmFzZVVSTCArICIoPz0vfCQpIiksICcnKS5yZXBsYWNlKG5ldyBSZWdFeHAoIl4iICsgcm9vdFVSTCArICIoPz0vfCQpIiksICcnKS5yZXBsYWNlKC9cL1wvL2csICcvJyk7IC8vIHJlbW92ZSBleHRyYSBzbGFzaGVzCgogICAgICB2YXIgc2VhcmNoID0gbG9jYXRpb24uc2VhcmNoIHx8ICcnOwogICAgICB1cmwgKz0gc2VhcmNoICsgdGhpcy5nZXRIYXNoKCk7CiAgICAgIHJldHVybiB1cmw7CiAgICB9CiAgICAvKioKICAgICAgVXNlcyBgaGlzdG9yeS5wdXNoU3RhdGVgIHRvIHVwZGF0ZSB0aGUgdXJsIHdpdGhvdXQgYSBwYWdlIHJlbG9hZC4KICAgICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBzZXRVUkwKICAgICAgQHBhcmFtIHBhdGgge1N0cmluZ30KICAgICovCiAgICA7CgogICAgX3Byb3RvLnNldFVSTCA9IGZ1bmN0aW9uIHNldFVSTChwYXRoKSB7CiAgICAgIHZhciBzdGF0ZSA9IHRoaXMuZ2V0U3RhdGUoKTsKICAgICAgcGF0aCA9IHRoaXMuZm9ybWF0VVJMKHBhdGgpOwoKICAgICAgaWYgKCFzdGF0ZSB8fCBzdGF0ZS5wYXRoICE9PSBwYXRoKSB7CiAgICAgICAgdGhpcy5wdXNoU3RhdGUocGF0aCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICBVc2VzIGBoaXN0b3J5LnJlcGxhY2VTdGF0ZWAgdG8gdXBkYXRlIHRoZSB1cmwgd2l0aG91dCBhIHBhZ2UgcmVsb2FkCiAgICAgIG9yIGhpc3RvcnkgbW9kaWZpY2F0aW9uLgogICAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIHJlcGxhY2VVUkwKICAgICAgQHBhcmFtIHBhdGgge1N0cmluZ30KICAgICovCiAgICA7CgogICAgX3Byb3RvLnJlcGxhY2VVUkwgPSBmdW5jdGlvbiByZXBsYWNlVVJMKHBhdGgpIHsKICAgICAgdmFyIHN0YXRlID0gdGhpcy5nZXRTdGF0ZSgpOwogICAgICBwYXRoID0gdGhpcy5mb3JtYXRVUkwocGF0aCk7CgogICAgICBpZiAoIXN0YXRlIHx8IHN0YXRlLnBhdGggIT09IHBhdGgpIHsKICAgICAgICB0aGlzLnJlcGxhY2VTdGF0ZShwYXRoKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgIEdldCB0aGUgY3VycmVudCBgaGlzdG9yeS5zdGF0ZWAuIENoZWNrcyBmb3IgaWYgYSBwb2x5ZmlsbCBpcwogICAgICByZXF1aXJlZCBhbmQgaWYgc28gZmV0Y2hlcyB0aGlzLl9oaXN0b3J5U3RhdGUuIFRoZSBzdGF0ZSByZXR1cm5lZAogICAgICBmcm9tIGdldFN0YXRlIG1heSBiZSBudWxsIGlmIGFuIGlmcmFtZSBoYXMgY2hhbmdlZCBhIHdpbmRvdydzCiAgICAgIGhpc3RvcnkuCiAgICAgICAgIFRoZSBvYmplY3QgcmV0dXJuZWQgd2lsbCBjb250YWluIGEgYHBhdGhgIGZvciB0aGUgZ2l2ZW4gc3RhdGUgYXMgd2VsbAogICAgICBhcyBhIHVuaXF1ZSBzdGF0ZSBgaWRgLiBUaGUgc3RhdGUgaW5kZXggd2lsbCBhbGxvdyB0aGUgYXBwIHRvIGRpc3Rpbmd1aXNoCiAgICAgIGJldHdlZW4gdHdvIHN0YXRlcyB3aXRoIHNpbWlsYXIgcGF0aHMgYnV0IHNob3VsZCBiZSB1bmlxdWUgZnJvbSBvbmUgYW5vdGhlci4KICAgICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBnZXRTdGF0ZQogICAgICBAcmV0dXJuIHN0YXRlIHtPYmplY3R9CiAgICAqLwogICAgOwoKICAgIF9wcm90by5nZXRTdGF0ZSA9IGZ1bmN0aW9uIGdldFN0YXRlKCkgewogICAgICBpZiAodGhpcy5zdXBwb3J0c0hpc3RvcnkpIHsKICAgICAgICByZXR1cm4gdGhpcy5oaXN0b3J5LnN0YXRlOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5faGlzdG9yeVN0YXRlOwogICAgfQogICAgLyoqCiAgICAgUHVzaGVzIGEgbmV3IHN0YXRlLgogICAgICAgIEBwcml2YXRlCiAgICAgQG1ldGhvZCBwdXNoU3RhdGUKICAgICBAcGFyYW0gcGF0aCB7U3RyaW5nfQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucHVzaFN0YXRlID0gZnVuY3Rpb24gcHVzaFN0YXRlKHBhdGgpIHsKICAgICAgdmFyIHN0YXRlID0gewogICAgICAgIHBhdGg6IHBhdGgsCiAgICAgICAgdXVpZDogX3V1aWQoKQogICAgICB9OwogICAgICB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKHN0YXRlLCBudWxsLCBwYXRoKTsKICAgICAgdGhpcy5faGlzdG9yeVN0YXRlID0gc3RhdGU7IC8vIHVzZWQgZm9yIHdlYmtpdCB3b3JrYXJvdW5kCgogICAgICB0aGlzLl9wcmV2aW91c1VSTCA9IHRoaXMuZ2V0VVJMKCk7CiAgICB9CiAgICAvKioKICAgICBSZXBsYWNlcyB0aGUgY3VycmVudCBzdGF0ZS4KICAgICAgICBAcHJpdmF0ZQogICAgIEBtZXRob2QgcmVwbGFjZVN0YXRlCiAgICAgQHBhcmFtIHBhdGgge1N0cmluZ30KICAgICovCiAgICA7CgogICAgX3Byb3RvLnJlcGxhY2VTdGF0ZSA9IGZ1bmN0aW9uIHJlcGxhY2VTdGF0ZShwYXRoKSB7CiAgICAgIHZhciBzdGF0ZSA9IHsKICAgICAgICBwYXRoOiBwYXRoLAogICAgICAgIHV1aWQ6IF91dWlkKCkKICAgICAgfTsKICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZShzdGF0ZSwgbnVsbCwgcGF0aCk7CiAgICAgIHRoaXMuX2hpc3RvcnlTdGF0ZSA9IHN0YXRlOyAvLyB1c2VkIGZvciB3ZWJraXQgd29ya2Fyb3VuZAoKICAgICAgdGhpcy5fcHJldmlvdXNVUkwgPSB0aGlzLmdldFVSTCgpOwogICAgfQogICAgLyoqCiAgICAgIFJlZ2lzdGVyIGEgY2FsbGJhY2sgdG8gYmUgaW52b2tlZCB3aGVuZXZlciB0aGUgYnJvd3NlcgogICAgICBoaXN0b3J5IGNoYW5nZXMsIGluY2x1ZGluZyB1c2luZyBmb3J3YXJkIGFuZCBiYWNrIGJ1dHRvbnMuCiAgICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2Qgb25VcGRhdGVVUkwKICAgICAgQHBhcmFtIGNhbGxiYWNrIHtGdW5jdGlvbn0KICAgICovCiAgICA7CgogICAgX3Byb3RvLm9uVXBkYXRlVVJMID0gZnVuY3Rpb24gb25VcGRhdGVVUkwoY2FsbGJhY2spIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB0aGlzLl9yZW1vdmVFdmVudExpc3RlbmVyKCk7CgogICAgICB0aGlzLl9wb3BzdGF0ZUhhbmRsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gSWdub3JlIGluaXRpYWwgcGFnZSBsb2FkIHBvcHN0YXRlIGV2ZW50IGluIENocm9tZQogICAgICAgIGlmICghcG9wc3RhdGVGaXJlZCkgewogICAgICAgICAgcG9wc3RhdGVGaXJlZCA9IHRydWU7CgogICAgICAgICAgaWYgKF90aGlzMi5nZXRVUkwoKSA9PT0gX3RoaXMyLl9wcmV2aW91c1VSTCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjYWxsYmFjayhfdGhpczIuZ2V0VVJMKCkpOwogICAgICB9OwoKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgdGhpcy5fcG9wc3RhdGVIYW5kbGVyKTsKICAgIH0KICAgIC8qKgogICAgICBVc2VkIHdoZW4gdXNpbmcgYHt7YWN0aW9ufX1gIGhlbHBlci4gIFRoZSB1cmwgaXMgYWx3YXlzIGFwcGVuZGVkIHRvIHRoZSByb290VVJMLgogICAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIGZvcm1hdFVSTAogICAgICBAcGFyYW0gdXJsIHtTdHJpbmd9CiAgICAgIEByZXR1cm4gZm9ybWF0dGVkIHVybCB7U3RyaW5nfQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uZm9ybWF0VVJMID0gZnVuY3Rpb24gZm9ybWF0VVJMKHVybCkgewogICAgICB2YXIgcm9vdFVSTCA9IHRoaXMucm9vdFVSTCwKICAgICAgICAgIGJhc2VVUkwgPSB0aGlzLmJhc2VVUkw7CgogICAgICBpZiAodXJsICE9PSAnJykgewogICAgICAgIC8vIHJlbW92ZSB0cmFpbGluZyBzbGFzaGVzIGlmIHRoZXkgZXhpc3RzCiAgICAgICAgcm9vdFVSTCA9IHJvb3RVUkwucmVwbGFjZSgvXC8kLywgJycpOwogICAgICAgIGJhc2VVUkwgPSBiYXNlVVJMLnJlcGxhY2UoL1wvJC8sICcnKTsKICAgICAgfSBlbHNlIGlmIChiYXNlVVJMWzBdID09PSAnLycgJiYgcm9vdFVSTFswXSA9PT0gJy8nKSB7CiAgICAgICAgLy8gaWYgYmFzZVVSTCBhbmQgcm9vdFVSTCBib3RoIHN0YXJ0IHdpdGggYSBzbGFzaAogICAgICAgIC8vIC4uLiByZW1vdmUgdHJhaWxpbmcgc2xhc2ggZnJvbSBiYXNlVVJMIGlmIGl0IGV4aXN0cwogICAgICAgIGJhc2VVUkwgPSBiYXNlVVJMLnJlcGxhY2UoL1wvJC8sICcnKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGJhc2VVUkwgKyByb290VVJMICsgdXJsOwogICAgfQogICAgLyoqCiAgICAgIENsZWFucyB1cCB0aGUgSGlzdG9yeUxvY2F0aW9uIGV2ZW50IGxpc3RlbmVyLgogICAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIHdpbGxEZXN0cm95CiAgICAqLwogICAgOwoKICAgIF9wcm90by53aWxsRGVzdHJveSA9IGZ1bmN0aW9uIHdpbGxEZXN0cm95KCkgewogICAgICB0aGlzLl9yZW1vdmVFdmVudExpc3RlbmVyKCk7CiAgICB9OwoKICAgIF9wcm90by5fcmVtb3ZlRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uIF9yZW1vdmVFdmVudExpc3RlbmVyKCkgewogICAgICBpZiAodGhpcy5fcG9wc3RhdGVIYW5kbGVyKSB7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgdGhpcy5fcG9wc3RhdGVIYW5kbGVyKTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gSGlzdG9yeUxvY2F0aW9uOwogIH0oX3J1bnRpbWUuT2JqZWN0KTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IEhpc3RvcnlMb2NhdGlvbjsKfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvbG9jYXRpb24vbm9uZV9sb2NhdGlvbiIsIFsiZXhwb3J0cyIsICJlbWJlci1iYWJlbCIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lIiwgIkBlbWJlci9kZWJ1ZyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9lbWJlckJhYmVsLCBfbWV0YWwsIF9ydW50aW1lLCBfZGVidWcpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIC8qKgogIEBtb2R1bGUgQGVtYmVyL3JvdXRpbmcKICAqLwoKICAvKioKICAgIE5vbmVMb2NhdGlvbiBkb2VzIG5vdCBpbnRlcmFjdCB3aXRoIHRoZSBicm93c2VyLiBJdCBpcyB1c2VmdWwgZm9yCiAgICB0ZXN0aW5nLCBvciB3aGVuIHlvdSBuZWVkIHRvIG1hbmFnZSBzdGF0ZSB3aXRoIHlvdXIgUm91dGVyLCBidXQgdGVtcG9yYXJpbHkKICAgIGRvbid0IHdhbnQgaXQgdG8gbXVjayB3aXRoIHRoZSBVUkwgKGZvciBleGFtcGxlIHdoZW4geW91IGVtYmVkIHlvdXIKICAgIGFwcGxpY2F0aW9uIGluIGEgbGFyZ2VyIHBhZ2UpLgogIAogICAgVXNpbmcgYE5vbmVMb2NhdGlvbmAgY2F1c2VzIEVtYmVyIHRvIG5vdCBzdG9yZSB0aGUgYXBwbGljYXRpb25zIFVSTCBzdGF0ZQogICAgaW4gdGhlIGFjdHVhbCBVUkwuIFRoaXMgaXMgZ2VuZXJhbGx5IHVzZWQgZm9yIHRlc3RpbmcgcHVycG9zZXMsIGFuZCBpcyBvbmUKICAgIG9mIHRoZSBjaGFuZ2VzIG1hZGUgd2hlbiBjYWxsaW5nIGBBcHAuc2V0dXBGb3JUZXN0aW5nKClgLgogIAogICAgQGNsYXNzIE5vbmVMb2NhdGlvbgogICAgQGV4dGVuZHMgRW1iZXJPYmplY3QKICAgIEBwcm90ZWN0ZWQKICAqLwogIHZhciBOb25lTG9jYXRpb24gPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0VtYmVyT2JqZWN0KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoTm9uZUxvY2F0aW9uLCBfRW1iZXJPYmplY3QpOwoKICAgIGZ1bmN0aW9uIE5vbmVMb2NhdGlvbigpIHsKICAgICAgdmFyIF90aGlzOwoKICAgICAgX3RoaXMgPSBfRW1iZXJPYmplY3QuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgICBfdGhpcy5pbXBsZW1lbnRhdGlvbiA9ICdub25lJzsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBOb25lTG9jYXRpb24ucHJvdG90eXBlOwoKICAgIF9wcm90by5kZXRlY3QgPSBmdW5jdGlvbiBkZXRlY3QoKSB7CiAgICAgIHZhciByb290VVJMID0gdGhpcy5yb290VVJMOwogICAgICAoZmFsc2UgJiYgIShyb290VVJMLmNoYXJBdChyb290VVJMLmxlbmd0aCAtIDEpID09PSAnLycpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgncm9vdFVSTCBtdXN0IGVuZCB3aXRoIGEgdHJhaWxpbmcgZm9yd2FyZCBzbGFzaCBlLmcuICIvYXBwLyInLCByb290VVJMLmNoYXJBdChyb290VVJMLmxlbmd0aCAtIDEpID09PSAnLycpKTsKICAgIH0KICAgIC8qKgogICAgICBSZXR1cm5zIHRoZSBjdXJyZW50IHBhdGggd2l0aG91dCBgcm9vdFVSTGAuCiAgICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgZ2V0VVJMCiAgICAgIEByZXR1cm4ge1N0cmluZ30gcGF0aAogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uZ2V0VVJMID0gZnVuY3Rpb24gZ2V0VVJMKCkgewogICAgICB2YXIgcGF0aCA9IHRoaXMucGF0aCwKICAgICAgICAgIHJvb3RVUkwgPSB0aGlzLnJvb3RVUkw7IC8vIHJlbW92ZSB0cmFpbGluZyBzbGFzaGVzIGlmIHRoZXkgZXhpc3RzCgogICAgICByb290VVJMID0gcm9vdFVSTC5yZXBsYWNlKC9cLyQvLCAnJyk7IC8vIHJlbW92ZSByb290VVJMIGZyb20gdXJsCgogICAgICByZXR1cm4gcGF0aC5yZXBsYWNlKG5ldyBSZWdFeHAoIl4iICsgcm9vdFVSTCArICIoPz0vfCQpIiksICcnKTsKICAgIH0KICAgIC8qKgogICAgICBTZXQgdGhlIHBhdGggYW5kIHJlbWVtYmVycyB3aGF0IHdhcyBzZXQuIFVzaW5nIHRoaXMgbWV0aG9kCiAgICAgIHRvIGNoYW5nZSB0aGUgcGF0aCB3aWxsIG5vdCBpbnZva2UgdGhlIGB1cGRhdGVVUkxgIGNhbGxiYWNrLgogICAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIHNldFVSTAogICAgICBAcGFyYW0gcGF0aCB7U3RyaW5nfQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uc2V0VVJMID0gZnVuY3Rpb24gc2V0VVJMKHBhdGgpIHsKICAgICAgKDAsIF9tZXRhbC5zZXQpKHRoaXMsICdwYXRoJywgcGF0aCk7CiAgICB9CiAgICAvKioKICAgICAgUmVnaXN0ZXIgYSBjYWxsYmFjayB0byBiZSBpbnZva2VkIHdoZW4gdGhlIHBhdGggY2hhbmdlcy4gVGhlc2UKICAgICAgY2FsbGJhY2tzIHdpbGwgZXhlY3V0ZSB3aGVuIHRoZSB1c2VyIHByZXNzZXMgdGhlIGJhY2sgb3IgZm9yd2FyZAogICAgICBidXR0b24sIGJ1dCBub3QgYWZ0ZXIgYHNldFVSTGAgaXMgaW52b2tlZC4KICAgICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBvblVwZGF0ZVVSTAogICAgICBAcGFyYW0gY2FsbGJhY2sge0Z1bmN0aW9ufQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ub25VcGRhdGVVUkwgPSBmdW5jdGlvbiBvblVwZGF0ZVVSTChjYWxsYmFjaykgewogICAgICB0aGlzLnVwZGF0ZUNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB9CiAgICAvKioKICAgICAgU2V0cyB0aGUgcGF0aCBhbmQgY2FsbHMgdGhlIGB1cGRhdGVVUkxgIGNhbGxiYWNrLgogICAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIGhhbmRsZVVSTAogICAgICBAcGFyYW0gdXJsIHtTdHJpbmd9CiAgICAqLwogICAgOwoKICAgIF9wcm90by5oYW5kbGVVUkwgPSBmdW5jdGlvbiBoYW5kbGVVUkwodXJsKSB7CiAgICAgICgwLCBfbWV0YWwuc2V0KSh0aGlzLCAncGF0aCcsIHVybCk7CiAgICAgIHRoaXMudXBkYXRlQ2FsbGJhY2sodXJsKTsKICAgIH0KICAgIC8qKgogICAgICBHaXZlbiBhIFVSTCwgZm9ybWF0cyBpdCB0byBiZSBwbGFjZWQgaW50byB0aGUgcGFnZSBhcyBwYXJ0CiAgICAgIG9mIGFuIGVsZW1lbnQncyBgaHJlZmAgYXR0cmlidXRlLgogICAgICAgICBUaGlzIGlzIHVzZWQsIGZvciBleGFtcGxlLCB3aGVuIHVzaW5nIHRoZSB7e2FjdGlvbn19IGhlbHBlcgogICAgICB0byBnZW5lcmF0ZSBhIFVSTCBiYXNlZCBvbiBhbiBldmVudC4KICAgICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBmb3JtYXRVUkwKICAgICAgQHBhcmFtIHVybCB7U3RyaW5nfQogICAgICBAcmV0dXJuIHtTdHJpbmd9IHVybAogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uZm9ybWF0VVJMID0gZnVuY3Rpb24gZm9ybWF0VVJMKHVybCkgewogICAgICB2YXIgcm9vdFVSTCA9IHRoaXMucm9vdFVSTDsKCiAgICAgIGlmICh1cmwgIT09ICcnKSB7CiAgICAgICAgLy8gcmVtb3ZlIHRyYWlsaW5nIHNsYXNoZXMgaWYgdGhleSBleGlzdHMKICAgICAgICByb290VVJMID0gcm9vdFVSTC5yZXBsYWNlKC9cLyQvLCAnJyk7CiAgICAgIH0KCiAgICAgIHJldHVybiByb290VVJMICsgdXJsOwogICAgfTsKCiAgICByZXR1cm4gTm9uZUxvY2F0aW9uOwogIH0oX3J1bnRpbWUuT2JqZWN0KTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IE5vbmVMb2NhdGlvbjsKICBOb25lTG9jYXRpb24ucmVvcGVuKHsKICAgIHBhdGg6ICcnLAoKICAgIC8qKgogICAgICBXaWxsIGJlIHByZS1wZW5kZWQgdG8gcGF0aC4KICAgICAgICAgQHByaXZhdGUKICAgICAgQHByb3BlcnR5IHJvb3RVUkwKICAgICAgQGRlZmF1bHQgJy8nCiAgICAqLwogICAgcm9vdFVSTDogJy8nCiAgfSk7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL2xvY2F0aW9uL3V0aWwiLCBbImV4cG9ydHMiXSwgZnVuY3Rpb24gKF9leHBvcnRzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5nZXRQYXRoID0gZ2V0UGF0aDsKICBfZXhwb3J0cy5nZXRRdWVyeSA9IGdldFF1ZXJ5OwogIF9leHBvcnRzLmdldEhhc2ggPSBnZXRIYXNoOwogIF9leHBvcnRzLmdldEZ1bGxQYXRoID0gZ2V0RnVsbFBhdGg7CiAgX2V4cG9ydHMuZ2V0T3JpZ2luID0gZ2V0T3JpZ2luOwogIF9leHBvcnRzLnN1cHBvcnRzSGFzaENoYW5nZSA9IHN1cHBvcnRzSGFzaENoYW5nZTsKICBfZXhwb3J0cy5zdXBwb3J0c0hpc3RvcnkgPSBzdXBwb3J0c0hpc3Rvcnk7CiAgX2V4cG9ydHMucmVwbGFjZVBhdGggPSByZXBsYWNlUGF0aDsKCiAgLyoqCiAgICBAcHJpdmF0ZQogIAogICAgUmV0dXJucyB0aGUgY3VycmVudCBgbG9jYXRpb24ucGF0aG5hbWVgLCBub3JtYWxpemVkIGZvciBJRSBpbmNvbnNpc3RlbmNpZXMuCiAgKi8KICBmdW5jdGlvbiBnZXRQYXRoKGxvY2F0aW9uKSB7CiAgICB2YXIgcGF0aG5hbWUgPSBsb2NhdGlvbi5wYXRobmFtZTsgLy8gVmFyaW91cyB2ZXJzaW9ucyBvZiBJRS9PcGVyYSBkb24ndCBhbHdheXMgcmV0dXJuIGEgbGVhZGluZyBzbGFzaAoKICAgIGlmIChwYXRobmFtZVswXSAhPT0gJy8nKSB7CiAgICAgIHBhdGhuYW1lID0gIi8iICsgcGF0aG5hbWU7CiAgICB9CgogICAgcmV0dXJuIHBhdGhuYW1lOwogIH0KICAvKioKICAgIEBwcml2YXRlCiAgCiAgICBSZXR1cm5zIHRoZSBjdXJyZW50IGBsb2NhdGlvbi5zZWFyY2hgLgogICovCgoKICBmdW5jdGlvbiBnZXRRdWVyeShsb2NhdGlvbikgewogICAgcmV0dXJuIGxvY2F0aW9uLnNlYXJjaDsKICB9CiAgLyoqCiAgICBAcHJpdmF0ZQogIAogICAgUmV0dXJucyB0aGUgaGFzaCBvciBlbXB0eSBzdHJpbmcKICAqLwoKCiAgZnVuY3Rpb24gZ2V0SGFzaChsb2NhdGlvbikgewogICAgaWYgKGxvY2F0aW9uLmhhc2ggIT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gbG9jYXRpb24uaGFzaC5zdWJzdHIoMCk7CiAgICB9CgogICAgcmV0dXJuICcnOwogIH0KCiAgZnVuY3Rpb24gZ2V0RnVsbFBhdGgobG9jYXRpb24pIHsKICAgIHJldHVybiBnZXRQYXRoKGxvY2F0aW9uKSArIGdldFF1ZXJ5KGxvY2F0aW9uKSArIGdldEhhc2gobG9jYXRpb24pOwogIH0KCiAgZnVuY3Rpb24gZ2V0T3JpZ2luKGxvY2F0aW9uKSB7CiAgICB2YXIgb3JpZ2luID0gbG9jYXRpb24ub3JpZ2luOyAvLyBPbGRlciBicm93c2VycywgZXNwZWNpYWxseSBJRSwgZG9uJ3QgaGF2ZSBvcmlnaW4KCiAgICBpZiAoIW9yaWdpbikgewogICAgICBvcmlnaW4gPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0bmFtZTsKCiAgICAgIGlmIChsb2NhdGlvbi5wb3J0KSB7CiAgICAgICAgb3JpZ2luICs9ICI6IiArIGxvY2F0aW9uLnBvcnQ7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gb3JpZ2luOwogIH0KICAvKgogICAgYGRvY3VtZW50TW9kZWAgb25seSBleGlzdCBpbiBJbnRlcm5ldCBFeHBsb3JlciwgYW5kIGl0J3MgdGVzdGVkIGJlY2F1c2UgSUU4IHJ1bm5pbmcgaW4KICAgIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgY2xhaW1zIHRvIHN1cHBvcnQgYG9uaGFzaGNoYW5nZWAgYnV0IGFjdHVhbGx5IGRvZXMgbm90LgogIAogICAgYGdsb2JhbGAgaXMgYW4gb2JqZWN0IHRoYXQgbWF5IGhhdmUgYW4gYG9uaGFzaGNoYW5nZWAgcHJvcGVydHkuCiAgCiAgICBAcHJpdmF0ZQogICAgQGZ1bmN0aW9uIHN1cHBvcnRzSGFzaENoYW5nZQogICovCgoKICBmdW5jdGlvbiBzdXBwb3J0c0hhc2hDaGFuZ2UoZG9jdW1lbnRNb2RlLCBnbG9iYWwpIHsKICAgIHJldHVybiBnbG9iYWwgJiYgJ29uaGFzaGNoYW5nZScgaW4gZ2xvYmFsICYmIChkb2N1bWVudE1vZGUgPT09IHVuZGVmaW5lZCB8fCBkb2N1bWVudE1vZGUgPiA3KTsKICB9CiAgLyoKICAgIGB1c2VyQWdlbnRgIGlzIGEgdXNlciBhZ2VudCBzdHJpbmcuIFdlIHVzZSB1c2VyIGFnZW50IHRlc3RpbmcgaGVyZSwgYmVjYXVzZQogICAgdGhlIHN0b2NrIEFuZHJvaWQgYnJvd3NlciBpcyBrbm93biB0byBoYXZlIGJ1Z2d5IHZlcnNpb25zIG9mIHRoZSBIaXN0b3J5IEFQSSwKICAgIGluIHNvbWUgQW5kcm9pZCB2ZXJzaW9ucy4KICAKICAgIEBwcml2YXRlCiAgICBAZnVuY3Rpb24gc3VwcG9ydHNIaXN0b3J5CiAgKi8KCgogIGZ1bmN0aW9uIHN1cHBvcnRzSGlzdG9yeSh1c2VyQWdlbnQsIGhpc3RvcnkpIHsKICAgIC8vIEJvb3N0ZWQgZnJvbSBNb2Rlcm5penI6IGh0dHBzOi8vZ2l0aHViLmNvbS9Nb2Rlcm5penIvTW9kZXJuaXpyL2Jsb2IvbWFzdGVyL2ZlYXR1cmUtZGV0ZWN0cy9oaXN0b3J5LmpzCiAgICAvLyBUaGUgc3RvY2sgYnJvd3NlciBvbiBBbmRyb2lkIDIuMiAmIDIuMywgYW5kIDQuMC54IHJldHVybnMgcG9zaXRpdmUgb24gaGlzdG9yeSBzdXBwb3J0CiAgICAvLyBVbmZvcnR1bmF0ZWx5IHN1cHBvcnQgaXMgcmVhbGx5IGJ1Z2d5IGFuZCB0aGVyZSBpcyBubyBjbGVhbiB3YXkgdG8gZGV0ZWN0CiAgICAvLyB0aGVzZSBidWdzLCBzbyB3ZSBmYWxsIGJhY2sgdG8gYSB1c2VyIGFnZW50IHNuaWZmIDooCiAgICAvLyBXZSBvbmx5IHdhbnQgQW5kcm9pZCAyIGFuZCA0LjAsIHN0b2NrIGJyb3dzZXIsIGFuZCBub3QgQ2hyb21lIHdoaWNoIGlkZW50aWZpZXMKICAgIC8vIGl0c2VsZiBhcyAnTW9iaWxlIFNhZmFyaScgYXMgd2VsbCwgbm9yIFdpbmRvd3MgUGhvbmUuCiAgICBpZiAoKHVzZXJBZ2VudC5pbmRleE9mKCdBbmRyb2lkIDIuJykgIT09IC0xIHx8IHVzZXJBZ2VudC5pbmRleE9mKCdBbmRyb2lkIDQuMCcpICE9PSAtMSkgJiYgdXNlckFnZW50LmluZGV4T2YoJ01vYmlsZSBTYWZhcmknKSAhPT0gLTEgJiYgdXNlckFnZW50LmluZGV4T2YoJ0Nocm9tZScpID09PSAtMSAmJiB1c2VyQWdlbnQuaW5kZXhPZignV2luZG93cyBQaG9uZScpID09PSAtMSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIEJvb2xlYW4oaGlzdG9yeSAmJiAncHVzaFN0YXRlJyBpbiBoaXN0b3J5KTsKICB9CiAgLyoqCiAgICBSZXBsYWNlcyB0aGUgY3VycmVudCBsb2NhdGlvbiwgbWFraW5nIHN1cmUgd2UgZXhwbGljaXRseSBpbmNsdWRlIHRoZSBvcmlnaW4KICAgIHRvIHByZXZlbnQgcmVkaXJlY3RpbmcgdG8gYSBkaWZmZXJlbnQgb3JpZ2luLgogIAogICAgQHByaXZhdGUKICAqLwoKCiAgZnVuY3Rpb24gcmVwbGFjZVBhdGgobG9jYXRpb24sIHBhdGgpIHsKICAgIGxvY2F0aW9uLnJlcGxhY2UoZ2V0T3JpZ2luKGxvY2F0aW9uKSArIHBhdGgpOwogIH0KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvc2VydmljZXMvcm91dGVyIiwgWyJleHBvcnRzIiwgImVtYmVyLWJhYmVsIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUiLCAiQGVtYmVyL2RlYnVnIiwgIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCAiQGVtYmVyL3NlcnZpY2UiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvdXRpbHMiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZW1iZXJCYWJlbCwgX3J1bnRpbWUsIF9kZWJ1ZywgX2NvbXB1dGVkLCBfc2VydmljZSwgX3V0aWxzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwogIHZhciBmcmVlemVSb3V0ZUluZm87CgogIGlmIChmYWxzZQogIC8qIERFQlVHICovCiAgKSB7CiAgICBmcmVlemVSb3V0ZUluZm8gPSBmdW5jdGlvbiBmcmVlemVSb3V0ZUluZm8odHJhbnNpdGlvbikgewogICAgICBpZiAodHJhbnNpdGlvbi5mcm9tICE9PSBudWxsICYmICFPYmplY3QuaXNGcm96ZW4odHJhbnNpdGlvbi5mcm9tKSkgewogICAgICAgIE9iamVjdC5mcmVlemUodHJhbnNpdGlvbi5mcm9tKTsKICAgICAgfQoKICAgICAgaWYgKHRyYW5zaXRpb24udG8gIT09IG51bGwgJiYgIU9iamVjdC5pc0Zyb3plbih0cmFuc2l0aW9uLnRvKSkgewogICAgICAgIE9iamVjdC5mcmVlemUodHJhbnNpdGlvbi50byk7CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiBjbGVhblVSTCh1cmwsIHJvb3RVUkwpIHsKICAgIGlmIChyb290VVJMID09PSAnLycpIHsKICAgICAgcmV0dXJuIHVybDsKICAgIH0KCiAgICByZXR1cm4gdXJsLnN1YnN0cihyb290VVJMLmxlbmd0aCwgdXJsLmxlbmd0aCk7CiAgfQogIC8qKgogICAgIFRoZSBSb3V0ZXIgc2VydmljZSBpcyB0aGUgcHVibGljIEFQSSB0aGF0IHByb3ZpZGVzIGFjY2VzcyB0byB0aGUgcm91dGVyLgogIAogICAgIFRoZSBpbW1lZGlhdGUgYmVuZWZpdCBvZiB0aGUgUm91dGVyIHNlcnZpY2UgaXMgdGhhdCB5b3UgY2FuIGluamVjdCBpdCBpbnRvIGNvbXBvbmVudHMsCiAgICAgZ2l2aW5nIHRoZW0gYSBmcmllbmRseSB3YXkgdG8gaW5pdGlhdGUgdHJhbnNpdGlvbnMgYW5kIGFzayBxdWVzdGlvbnMgYWJvdXQgdGhlIGN1cnJlbnQKICAgICBnbG9iYWwgcm91dGVyIHN0YXRlLgogIAogICAgIEluIHRoaXMgZXhhbXBsZSwgdGhlIFJvdXRlciBzZXJ2aWNlIGlzIGluamVjdGVkIGludG8gYSBjb21wb25lbnQgdG8gaW5pdGlhdGUgYSB0cmFuc2l0aW9uCiAgICAgdG8gYSBkZWRpY2F0ZWQgcm91dGU6CiAgCiAgICAgYGBgYXBwL2NvbXBvbmVudHMvZXhhbXBsZS5qcwogICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGdsaW1tZXIvY29tcG9uZW50JzsKICAgICBpbXBvcnQgeyBhY3Rpb24gfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICBpbXBvcnQgeyBpbmplY3QgYXMgc2VydmljZSB9IGZyb20gJ0BlbWJlci9zZXJ2aWNlJzsKICAKICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBFeGFtcGxlQ29tcG9uZW50IGV4dGVuZHMgQ29tcG9uZW50IHsKICAgICAgIEBzZXJ2aWNlIHJvdXRlcjsKICAKICAgICAgIEBhY3Rpb24KICAgICAgIG5leHQoKSB7CiAgICAgICAgIHRoaXMucm91dGVyLnRyYW5zaXRpb25Ubygnb3RoZXIucm91dGUnKTsKICAgICAgIH0KICAgICB9CiAgICAgYGBgCiAgCiAgICAgTGlrZSBhbnkgc2VydmljZSwgaXQgY2FuIGFsc28gYmUgaW5qZWN0ZWQgaW50byBoZWxwZXJzLCByb3V0ZXMsIGV0Yy4KICAKICAgICBAcHVibGljCiAgICAgQGV4dGVuZHMgU2VydmljZQogICAgIEBjbGFzcyBSb3V0ZXJTZXJ2aWNlCiAgICovCgoKICB2YXIgUm91dGVyU2VydmljZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfU2VydmljZSkgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKFJvdXRlclNlcnZpY2UsIF9TZXJ2aWNlKTsKCiAgICBmdW5jdGlvbiBSb3V0ZXJTZXJ2aWNlKCkgewogICAgICByZXR1cm4gX1NlcnZpY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBSb3V0ZXJTZXJ2aWNlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8uaW5pdCA9IGZ1bmN0aW9uIGluaXQoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBfU2VydmljZS5wcm90b3R5cGUuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgdGhpcy5fcm91dGVyLm9uKCdyb3V0ZVdpbGxDaGFuZ2UnLCBmdW5jdGlvbiAodHJhbnNpdGlvbikgewogICAgICAgIGlmIChmYWxzZQogICAgICAgIC8qIERFQlVHICovCiAgICAgICAgKSB7CiAgICAgICAgICBmcmVlemVSb3V0ZUluZm8odHJhbnNpdGlvbik7CiAgICAgICAgfQoKICAgICAgICBfdGhpcy50cmlnZ2VyKCdyb3V0ZVdpbGxDaGFuZ2UnLCB0cmFuc2l0aW9uKTsKICAgICAgfSk7CgogICAgICB0aGlzLl9yb3V0ZXIub24oJ3JvdXRlRGlkQ2hhbmdlJywgZnVuY3Rpb24gKHRyYW5zaXRpb24pIHsKICAgICAgICBpZiAoZmFsc2UKICAgICAgICAvKiBERUJVRyAqLwogICAgICAgICkgewogICAgICAgICAgZnJlZXplUm91dGVJbmZvKHRyYW5zaXRpb24pOwogICAgICAgIH0KCiAgICAgICAgX3RoaXMudHJpZ2dlcigncm91dGVEaWRDaGFuZ2UnLCB0cmFuc2l0aW9uKTsKICAgICAgfSk7CiAgICB9CiAgICAvKioKICAgICAgIFRyYW5zaXRpb24gdGhlIGFwcGxpY2F0aW9uIGludG8gYW5vdGhlciByb3V0ZS4gVGhlIHJvdXRlIG1heQogICAgICAgYmUgZWl0aGVyIGEgc2luZ2xlIHJvdXRlIG9yIHJvdXRlIHBhdGg6CiAgICAgICAgICBTZWUgW3RyYW5zaXRpb25Ub10oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9Sb3V0ZS9tZXRob2RzL3RyYW5zaXRpb25Ubz9hbmNob3I9dHJhbnNpdGlvblRvKSBmb3IgbW9yZSBpbmZvLgogICAgICAgICAgQ2FsbGluZyBgdHJhbnNpdGlvblRvYCBmcm9tIHRoZSBSb3V0ZXIgc2VydmljZSB3aWxsIGNhdXNlIGRlZmF1bHQgcXVlcnkgcGFyYW1ldGVyIHZhbHVlcyB0byBiZSBpbmNsdWRlZCBpbiB0aGUgVVJMLgogICAgICAgVGhpcyBiZWhhdmlvciBpcyBkaWZmZXJlbnQgZnJvbSBjYWxsaW5nIGB0cmFuc2l0aW9uVG9gIG9uIGEgcm91dGUgb3IgYHRyYW5zaXRpb25Ub1JvdXRlYCBvbiBhIGNvbnRyb2xsZXIuCiAgICAgICBTZWUgdGhlIFtSb3V0ZXIgU2VydmljZSBSRkNdKGh0dHBzOi8vZ2l0aHViLmNvbS9lbWJlcmpzL3JmY3MvYmxvYi9tYXN0ZXIvdGV4dC8wMDk1LXJvdXRlci1zZXJ2aWNlLm1kI3F1ZXJ5LXBhcmFtZXRlci1zZW1hbnRpY3MpIGZvciBtb3JlIGluZm8uCiAgICAgICAgICBJbiB0aGUgZm9sbG93aW5nIGV4YW1wbGUgd2UgdXNlIHRoZSBSb3V0ZXIgc2VydmljZSB0byBuYXZpZ2F0ZSB0byBhIHJvdXRlIHdpdGggYQogICAgICAgc3BlY2lmaWMgbW9kZWwgZnJvbSBhIENvbXBvbmVudC4KICAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGdsaW1tZXIvY29tcG9uZW50JzsKICAgICAgIGltcG9ydCB7IGFjdGlvbiB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgaW1wb3J0IHsgaW5qZWN0IGFzIHNlcnZpY2UgfSBmcm9tICdAZW1iZXIvc2VydmljZSc7CiAgICAgICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBleHRlbmRzIENvbXBvbmVudCB7CiAgICAgICAgIEBzZXJ2aWNlIHJvdXRlcjsKICAgICAgICAgICAgQGFjdGlvbgogICAgICAgICBnb1RvQ29tbWVudHMocG9zdCkgewogICAgICAgICAgIHRoaXMucm91dGVyLnRyYW5zaXRpb25UbygnY29tbWVudHMnLCBwb3N0KTsKICAgICAgICAgfQogICAgICAgfQogICAgICAgYGBgCiAgICAgICAgICBAbWV0aG9kIHRyYW5zaXRpb25UbwogICAgICAgQHBhcmFtIHtTdHJpbmd9IHJvdXRlTmFtZU9yVXJsIHRoZSBuYW1lIG9mIHRoZSByb3V0ZSBvciBhIFVSTAogICAgICAgQHBhcmFtIHsuLi5PYmplY3R9IG1vZGVscyB0aGUgbW9kZWwocykgb3IgaWRlbnRpZmllcihzKSB0byBiZSB1c2VkIHdoaWxlCiAgICAgICAgIHRyYW5zaXRpb25pbmcgdG8gdGhlIHJvdXRlLgogICAgICAgQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBvcHRpb25hbCBoYXNoIHdpdGggYSBxdWVyeVBhcmFtcyBwcm9wZXJ0eQogICAgICAgICBjb250YWluaW5nIGEgbWFwcGluZyBvZiBxdWVyeSBwYXJhbWV0ZXJzCiAgICAgICBAcmV0dXJuIHtUcmFuc2l0aW9ufSB0aGUgdHJhbnNpdGlvbiBvYmplY3QgYXNzb2NpYXRlZCB3aXRoIHRoaXMKICAgICAgICAgYXR0ZW1wdGVkIHRyYW5zaXRpb24KICAgICAgIEBwdWJsaWMKICAgICAqLwogICAgOwoKICAgIF9wcm90by50cmFuc2l0aW9uVG8gPSBmdW5jdGlvbiB0cmFuc2l0aW9uVG8oKSB7CiAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIGlmICgoMCwgX3V0aWxzLnJlc2VtYmxlc1VSTCkoYXJnc1swXSkpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcm91dGVyLl9kb1VSTFRyYW5zaXRpb24oJ3RyYW5zaXRpb25UbycsIGFyZ3NbMF0pOwogICAgICB9CgogICAgICB2YXIgX2V4dHJhY3RSb3V0ZUFyZ3MgPSAoMCwgX3V0aWxzLmV4dHJhY3RSb3V0ZUFyZ3MpKGFyZ3MpLAogICAgICAgICAgcm91dGVOYW1lID0gX2V4dHJhY3RSb3V0ZUFyZ3Mucm91dGVOYW1lLAogICAgICAgICAgbW9kZWxzID0gX2V4dHJhY3RSb3V0ZUFyZ3MubW9kZWxzLAogICAgICAgICAgcXVlcnlQYXJhbXMgPSBfZXh0cmFjdFJvdXRlQXJncy5xdWVyeVBhcmFtczsKCiAgICAgIHZhciB0cmFuc2l0aW9uID0gdGhpcy5fcm91dGVyLl9kb1RyYW5zaXRpb24ocm91dGVOYW1lLCBtb2RlbHMsIHF1ZXJ5UGFyYW1zLCB0cnVlKTsKCiAgICAgIHRyYW5zaXRpb25bJ19rZWVwRGVmYXVsdFF1ZXJ5UGFyYW1WYWx1ZXMnXSA9IHRydWU7CiAgICAgIHJldHVybiB0cmFuc2l0aW9uOwogICAgfQogICAgLyoqCiAgICAgICBUcmFuc2l0aW9uIGludG8gYW5vdGhlciByb3V0ZSB3aGlsZSByZXBsYWNpbmcgdGhlIGN1cnJlbnQgVVJMLCBpZiBwb3NzaWJsZS4KICAgICAgIFRoZSByb3V0ZSBtYXkgYmUgZWl0aGVyIGEgc2luZ2xlIHJvdXRlIG9yIHJvdXRlIHBhdGg6CiAgICAgICAgICBTZWUgW3JlcGxhY2VXaXRoXSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL1JvdXRlL21ldGhvZHMvcmVwbGFjZVdpdGg/YW5jaG9yPXJlcGxhY2VXaXRoKSBmb3IgbW9yZSBpbmZvLgogICAgICAgICAgQ2FsbGluZyBgcmVwbGFjZVdpdGhgIGZyb20gdGhlIFJvdXRlciBzZXJ2aWNlIHdpbGwgY2F1c2UgZGVmYXVsdCBxdWVyeSBwYXJhbWV0ZXIgdmFsdWVzIHRvIGJlIGluY2x1ZGVkIGluIHRoZSBVUkwuCiAgICAgICBUaGlzIGJlaGF2aW9yIGlzIGRpZmZlcmVudCBmcm9tIGNhbGxpbmcgYHJlcGxhY2VXaXRoYCBvbiBhIHJvdXRlLgogICAgICAgU2VlIHRoZSBbUm91dGVyIFNlcnZpY2UgUkZDXShodHRwczovL2dpdGh1Yi5jb20vZW1iZXJqcy9yZmNzL2Jsb2IvbWFzdGVyL3RleHQvMDA5NS1yb3V0ZXItc2VydmljZS5tZCNxdWVyeS1wYXJhbWV0ZXItc2VtYW50aWNzKSBmb3IgbW9yZSBpbmZvLgogICAgICAgICAgVXNhZ2UgZXhhbXBsZToKICAgICAgICAgIGBgYGFwcC9yb3V0ZXMvYXBwbGljYXRpb24uanMKICAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBleHRlbmRzIFJvdXRlIHsKICAgICAgICAgYmVmb3JlTW9kZWwoKSB7CiAgICAgICAgICAgaWYgKCFhdXRob3JpemVkKCkpewogICAgICAgICAgICAgdGhpcy5yZXBsYWNlV2l0aCgndW5hdXRob3JpemVkJyk7CiAgICAgICAgICAgfQogICAgICAgICB9CiAgICAgICB9KTsKICAgICAgIGBgYAogICAgICAgICAgQG1ldGhvZCByZXBsYWNlV2l0aAogICAgICAgQHBhcmFtIHtTdHJpbmd9IHJvdXRlTmFtZU9yVXJsIHRoZSBuYW1lIG9mIHRoZSByb3V0ZSBvciBhIFVSTAogICAgICAgQHBhcmFtIHsuLi5PYmplY3R9IG1vZGVscyB0aGUgbW9kZWwocykgb3IgaWRlbnRpZmllcihzKSB0byBiZSB1c2VkIHdoaWxlCiAgICAgICAgIHRyYW5zaXRpb25pbmcgdG8gdGhlIHJvdXRlLgogICAgICAgQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBvcHRpb25hbCBoYXNoIHdpdGggYSBxdWVyeVBhcmFtcyBwcm9wZXJ0eQogICAgICAgICBjb250YWluaW5nIGEgbWFwcGluZyBvZiBxdWVyeSBwYXJhbWV0ZXJzCiAgICAgICBAcmV0dXJuIHtUcmFuc2l0aW9ufSB0aGUgdHJhbnNpdGlvbiBvYmplY3QgYXNzb2NpYXRlZCB3aXRoIHRoaXMKICAgICAgICAgYXR0ZW1wdGVkIHRyYW5zaXRpb24KICAgICAgIEBwdWJsaWMKICAgICAqLwogICAgOwoKICAgIF9wcm90by5yZXBsYWNlV2l0aCA9IGZ1bmN0aW9uIHJlcGxhY2VXaXRoKCkKICAgIC8qIHJvdXRlTmFtZU9yVXJsLCAuLi5tb2RlbHMsIG9wdGlvbnMgKi8KICAgIHsKICAgICAgcmV0dXJuIHRoaXMudHJhbnNpdGlvblRvLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykubWV0aG9kKCdyZXBsYWNlJyk7CiAgICB9CiAgICAvKioKICAgICAgR2VuZXJhdGUgYSBVUkwgYmFzZWQgb24gdGhlIHN1cHBsaWVkIHJvdXRlIG5hbWUgYW5kIG9wdGlvbmFsbHkgYSBtb2RlbC4gVGhlCiAgICAgIFVSTCBpcyByZXR1cm5lZCBhcyBhIHN0cmluZyB0aGF0IGNhbiBiZSB1c2VkIGZvciBhbnkgcHVycG9zZS4KICAgICAgICAgSW4gdGhpcyBleGFtcGxlLCB0aGUgVVJMIGZvciB0aGUgYGF1dGhvci5ib29rc2Agcm91dGUgZm9yIGEgZ2l2ZW4gYXV0aG9yCiAgICAgIGlzIGNvcGllZCB0byB0aGUgY2xpcGJvYXJkLgogICAgICAgICBgYGBhcHAvdGVtcGxhdGVzL2FwcGxpY2F0aW9uLmhicwogICAgICA8Q29weUxpbmsgQGF1dGhvcj17e2hhc2ggaWQ9InRvbXN0ZXIiIG5hbWU9IlRvbXN0ZXIifX0gLz4KICAgICAgYGBgCiAgICAgICAgIGBgYGFwcC9jb21wb25lbnRzL2NvcHktbGluay5qcwogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BnbGltbWVyL2NvbXBvbmVudCc7CiAgICAgIGltcG9ydCB7IGluamVjdCBhcyBzZXJ2aWNlIH0gZnJvbSAnQGVtYmVyL3NlcnZpY2UnOwogICAgICBpbXBvcnQgeyBhY3Rpb24gfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ29weUxpbmtDb21wb25lbnQgZXh0ZW5kcyBDb21wb25lbnQgewogICAgICAgIEBzZXJ2aWNlIHJvdXRlcjsKICAgICAgICBAc2VydmljZSBjbGlwYm9hcmQ7CiAgICAgICAgICAgQGFjdGlvbgogICAgICAgIGNvcHlCb29rc1VSTCgpIHsKICAgICAgICAgIGlmICh0aGlzLmF1dGhvcikgewogICAgICAgICAgICBjb25zdCB1cmwgPSB0aGlzLnJvdXRlci51cmxGb3IoJ2F1dGhvci5ib29rcycsIHRoaXMuYXJncy5hdXRob3IpOwogICAgICAgICAgICB0aGlzLmNsaXBib2FyZC5zZXQodXJsKTsKICAgICAgICAgICAgLy8gQ2xpcGJvYXJkIG5vdyBoYXMgL2F1dGhvci90b21zdGVyL2Jvb2tzCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgICBKdXN0IGxpa2Ugd2l0aCBgdHJhbnNpdGlvblRvYCBhbmQgYHJlcGxhY2VXaXRoYCwgYHVybEZvcmAgY2FuIGFsc28gaGFuZGxlCiAgICAgIHF1ZXJ5IHBhcmFtZXRlcnMuCiAgICAgICAgIGBgYGFwcC90ZW1wbGF0ZXMvYXBwbGljYXRpb24uaGJzCiAgICAgIDxDb3B5TGluayBAYXV0aG9yPXt7aGFzaCBpZD0idG9tc3RlciIgbmFtZT0iVG9tc3RlciJ9fSAvPgogICAgICBgYGAKICAgICAgICAgYGBgYXBwL2NvbXBvbmVudHMvY29weS1saW5rLmpzCiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGdsaW1tZXIvY29tcG9uZW50JzsKICAgICAgaW1wb3J0IHsgaW5qZWN0IGFzIHNlcnZpY2UgfSBmcm9tICdAZW1iZXIvc2VydmljZSc7CiAgICAgIGltcG9ydCB7IGFjdGlvbiB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBDb3B5TGlua0NvbXBvbmVudCBleHRlbmRzIENvbXBvbmVudCB7CiAgICAgICAgQHNlcnZpY2Ugcm91dGVyOwogICAgICAgIEBzZXJ2aWNlIGNsaXBib2FyZDsKICAgICAgICAgICBAYWN0aW9uCiAgICAgICAgY29weU9ubHlFbWJlckJvb2tzVVJMKCkgewogICAgICAgICAgaWYgKHRoaXMuYXV0aG9yKSB7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IHRoaXMucm91dGVyLnVybEZvcignYXV0aG9yLmJvb2tzJywgdGhpcy5hdXRob3IsIHsKICAgICAgICAgICAgICBxdWVyeVBhcmFtczogeyBmaWx0ZXI6ICdlbWJlcmpzJyB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmNsaXBib2FyZC5zZXQodXJsKTsKICAgICAgICAgICAgLy8gQ2xpcGJvYXJkIG5vdyBoYXMgL2F1dGhvci90b21zdGVyL2Jvb2tzP2ZpbHRlcj1lbWJlcmpzCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgICAgQG1ldGhvZCB1cmxGb3IKICAgICAgIEBwYXJhbSB7U3RyaW5nfSByb3V0ZU5hbWUgdGhlIG5hbWUgb2YgdGhlIHJvdXRlCiAgICAgICBAcGFyYW0gey4uLk9iamVjdH0gbW9kZWxzIHRoZSBtb2RlbChzKSBvciBpZGVudGlmaWVyKHMpIHRvIGJlIHVzZWQgd2hpbGUKICAgICAgICAgdHJhbnNpdGlvbmluZyB0byB0aGUgcm91dGUuCiAgICAgICBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIG9wdGlvbmFsIGhhc2ggd2l0aCBhIHF1ZXJ5UGFyYW1zIHByb3BlcnR5CiAgICAgICAgIGNvbnRhaW5pbmcgYSBtYXBwaW5nIG9mIHF1ZXJ5IHBhcmFtZXRlcnMKICAgICAgIEByZXR1cm4ge1N0cmluZ30gdGhlIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIGdlbmVyYXRlZCBVUkwKICAgICAgIEBwdWJsaWMKICAgICAqLwogICAgOwoKICAgIF9wcm90by51cmxGb3IgPSBmdW5jdGlvbiB1cmxGb3Iocm91dGVOYW1lKSB7CiAgICAgIHZhciBfdGhpcyRfcm91dGVyOwoKICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICB9CgogICAgICByZXR1cm4gKF90aGlzJF9yb3V0ZXIgPSB0aGlzLl9yb3V0ZXIpLmdlbmVyYXRlLmFwcGx5KF90aGlzJF9yb3V0ZXIsIFtyb3V0ZU5hbWVdLmNvbmNhdChhcmdzKSk7CiAgICB9CiAgICAvKioKICAgICAgIERldGVybWluZXMgd2hldGhlciBhIHJvdXRlIGlzIGFjdGl2ZS4KICAgICAgICAgIEBtZXRob2QgaXNBY3RpdmUKICAgICAgIEBwYXJhbSB7U3RyaW5nfSByb3V0ZU5hbWUgdGhlIG5hbWUgb2YgdGhlIHJvdXRlCiAgICAgICBAcGFyYW0gey4uLk9iamVjdH0gbW9kZWxzIHRoZSBtb2RlbChzKSBvciBpZGVudGlmaWVyKHMpIHRvIGJlIHVzZWQgd2hpbGUKICAgICAgICAgdHJhbnNpdGlvbmluZyB0byB0aGUgcm91dGUuCiAgICAgICBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIG9wdGlvbmFsIGhhc2ggd2l0aCBhIHF1ZXJ5UGFyYW1zIHByb3BlcnR5CiAgICAgICAgIGNvbnRhaW5pbmcgYSBtYXBwaW5nIG9mIHF1ZXJ5IHBhcmFtZXRlcnMKICAgICAgIEByZXR1cm4ge2Jvb2xlYW59IHRydWUgaWYgdGhlIHByb3ZpZGVkIHJvdXRlTmFtZS9tb2RlbHMvcXVlcnlQYXJhbXMgYXJlIGFjdGl2ZQogICAgICAgQHB1YmxpYwogICAgICovCiAgICA7CgogICAgX3Byb3RvLmlzQWN0aXZlID0gZnVuY3Rpb24gaXNBY3RpdmUoKSB7CiAgICAgIGZvciAodmFyIF9sZW4zID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMyksIF9rZXkzID0gMDsgX2tleTMgPCBfbGVuMzsgX2tleTMrKykgewogICAgICAgIGFyZ3NbX2tleTNdID0gYXJndW1lbnRzW19rZXkzXTsKICAgICAgfQoKICAgICAgdmFyIF9leHRyYWN0Um91dGVBcmdzMiA9ICgwLCBfdXRpbHMuZXh0cmFjdFJvdXRlQXJncykoYXJncyksCiAgICAgICAgICByb3V0ZU5hbWUgPSBfZXh0cmFjdFJvdXRlQXJnczIucm91dGVOYW1lLAogICAgICAgICAgbW9kZWxzID0gX2V4dHJhY3RSb3V0ZUFyZ3MyLm1vZGVscywKICAgICAgICAgIHF1ZXJ5UGFyYW1zID0gX2V4dHJhY3RSb3V0ZUFyZ3MyLnF1ZXJ5UGFyYW1zOwoKICAgICAgdmFyIHJvdXRlck1pY3JvbGliID0gdGhpcy5fcm91dGVyLl9yb3V0ZXJNaWNyb2xpYjsKCiAgICAgIGlmICghcm91dGVyTWljcm9saWIuaXNBY3RpdmVJbnRlbnQocm91dGVOYW1lLCBtb2RlbHMpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB2YXIgaGFzUXVlcnlQYXJhbXMgPSBPYmplY3Qua2V5cyhxdWVyeVBhcmFtcykubGVuZ3RoID4gMDsKCiAgICAgIGlmIChoYXNRdWVyeVBhcmFtcykgewogICAgICAgIHRoaXMuX3JvdXRlci5fcHJlcGFyZVF1ZXJ5UGFyYW1zKHJvdXRlTmFtZSwgbW9kZWxzLCBxdWVyeVBhcmFtcywgdHJ1ZQogICAgICAgIC8qIGZyb21Sb3V0ZXJTZXJ2aWNlICovCiAgICAgICAgKTsKCiAgICAgICAgcmV0dXJuICgwLCBfdXRpbHMuc2hhbGxvd0VxdWFsKShxdWVyeVBhcmFtcywgcm91dGVyTWljcm9saWIuc3RhdGUucXVlcnlQYXJhbXMpOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICAgVGFrZXMgYSBzdHJpbmcgVVJMIGFuZCByZXR1cm5zIGEgYFJvdXRlSW5mb2AgZm9yIHRoZSBsZWFmbW9zdCByb3V0ZSByZXByZXNlbnRlZAogICAgICAgYnkgdGhlIFVSTC4gUmV0dXJucyBgbnVsbGAgaWYgdGhlIFVSTCBpcyBub3QgcmVjb2duaXplZC4gVGhpcyBtZXRob2QgZXhwZWN0cyB0bwogICAgICAgcmVjZWl2ZSB0aGUgYWN0dWFsIFVSTCBhcyBzZWVuIGJ5IHRoZSBicm93c2VyIGluY2x1ZGluZyB0aGUgYXBwJ3MgYHJvb3RVUkxgLgogICAgICAgICAgU2VlIFtSb3V0ZUluZm9dKC9lbWJlci9yZWxlYXNlL2NsYXNzZXMvUm91dGVJbmZvKSBmb3IgbW9yZSBpbmZvLgogICAgICAgICAgSW4gdGhlIGZvbGxvd2luZyBleGFtcGxlIGByZWNvZ25pemVgIGlzIHVzZWQgdG8gdmVyaWZ5IGlmIGEgcGF0aCBiZWxvbmdzIHRvIG91cgogICAgICAgYXBwbGljYXRpb24gYmVmb3JlIHRyYW5zaXRpb25pbmcgdG8gaXQuCiAgICAgICAgICBgYGAKICAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAgICBpbXBvcnQgeyBpbmplY3QgYXMgc2VydmljZSB9IGZyb20gJ0BlbWJlci9zZXJ2aWNlJzsKICAgICAgICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIGV4dGVuZHMgQ29tcG9uZW50IHsKICAgICAgICAgQHNlcnZpY2Ugcm91dGVyOwogICAgICAgICBwYXRoID0gJy8nOwogICAgICAgICAgICBjbGljaygpIHsKICAgICAgICAgICBpZiAodGhpcy5yb3V0ZXIucmVjb2duaXplKHRoaXMucGF0aCkpIHsKICAgICAgICAgICAgIHRoaXMucm91dGVyLnRyYW5zaXRpb25Ubyh0aGlzLnBhdGgpOwogICAgICAgICAgIH0KICAgICAgICAgfQogICAgICAgfQogICAgICAgYGBgCiAgICAgICAgICAgQG1ldGhvZCByZWNvZ25pemUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsCiAgICAgICAgQHB1YmxpYwogICAgICAqLwogICAgOwoKICAgIF9wcm90by5yZWNvZ25pemUgPSBmdW5jdGlvbiByZWNvZ25pemUodXJsKSB7CiAgICAgIChmYWxzZSAmJiAhKHVybC5pbmRleE9mKHRoaXMucm9vdFVSTCkgPT09IDApICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IG11c3QgcGFzcyBhIHVybCB0aGF0IGJlZ2lucyB3aXRoIHRoZSBhcHBsaWNhdGlvbidzIHJvb3RVUkwgXCIiICsgdGhpcy5yb290VVJMICsgIlwiIiwgdXJsLmluZGV4T2YodGhpcy5yb290VVJMKSA9PT0gMCkpOwogICAgICB2YXIgaW50ZXJuYWxVUkwgPSBjbGVhblVSTCh1cmwsIHRoaXMucm9vdFVSTCk7CiAgICAgIHJldHVybiB0aGlzLl9yb3V0ZXIuX3JvdXRlck1pY3JvbGliLnJlY29nbml6ZShpbnRlcm5hbFVSTCk7CiAgICB9CiAgICAvKioKICAgICAgVGFrZXMgYSBzdHJpbmcgVVJMIGFuZCByZXR1cm5zIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIGEKICAgICAgYFJvdXRlSW5mb1dpdGhBdHRyaWJ1dGVzYCBmb3IgdGhlIGxlYWZtb3N0IHJvdXRlIHJlcHJlc2VudGVkIGJ5IHRoZSBVUkwuCiAgICAgIFRoZSBwcm9taXNlIHJlamVjdHMgaWYgdGhlIFVSTCBpcyBub3QgcmVjb2duaXplZCBvciBhbiB1bmhhbmRsZWQgZXhjZXB0aW9uCiAgICAgIGlzIGVuY291bnRlcmVkLiBUaGlzIG1ldGhvZCBleHBlY3RzIHRvIHJlY2VpdmUgdGhlIGFjdHVhbCBVUkwgYXMgc2VlbiBieQogICAgICB0aGUgYnJvd3NlciBpbmNsdWRpbmcgdGhlIGFwcCdzIGByb290VVJMYC4KICAgICAgICAgICBAbWV0aG9kIHJlY29nbml6ZUFuZExvYWQKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsCiAgICAgICAgQHB1YmxpYwogICAgICovCiAgICA7CgogICAgX3Byb3RvLnJlY29nbml6ZUFuZExvYWQgPSBmdW5jdGlvbiByZWNvZ25pemVBbmRMb2FkKHVybCkgewogICAgICAoZmFsc2UgJiYgISh1cmwuaW5kZXhPZih0aGlzLnJvb3RVUkwpID09PSAwKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIllvdSBtdXN0IHBhc3MgYSB1cmwgdGhhdCBiZWdpbnMgd2l0aCB0aGUgYXBwbGljYXRpb24ncyByb290VVJMIFwiIiArIHRoaXMucm9vdFVSTCArICJcIiIsIHVybC5pbmRleE9mKHRoaXMucm9vdFVSTCkgPT09IDApKTsKICAgICAgdmFyIGludGVybmFsVVJMID0gY2xlYW5VUkwodXJsLCB0aGlzLnJvb3RVUkwpOwogICAgICByZXR1cm4gdGhpcy5fcm91dGVyLl9yb3V0ZXJNaWNyb2xpYi5yZWNvZ25pemVBbmRMb2FkKGludGVybmFsVVJMKTsKICAgIH07CgogICAgcmV0dXJuIFJvdXRlclNlcnZpY2U7CiAgfShfc2VydmljZS5kZWZhdWx0KTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IFJvdXRlclNlcnZpY2U7CiAgUm91dGVyU2VydmljZS5yZW9wZW4oX3J1bnRpbWUuRXZlbnRlZCwgewogICAgLyoqCiAgICAgICBOYW1lIG9mIHRoZSBjdXJyZW50IHJvdXRlLgogICAgICAgICAgVGhpcyBwcm9wZXJ0eSByZXByZXNlbnRzIHRoZSBsb2dpY2FsIG5hbWUgb2YgdGhlIHJvdXRlLAogICAgICAgd2hpY2ggaXMgY29tbWEgc2VwYXJhdGVkLgogICAgICAgRm9yIHRoZSBmb2xsb3dpbmcgcm91dGVyOgogICAgICAgICAgYGBgYXBwL3JvdXRlci5qcwogICAgICAgUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICAgICAgdGhpcy5yb3V0ZSgnYWJvdXQnKTsKICAgICAgICAgdGhpcy5yb3V0ZSgnYmxvZycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICB0aGlzLnJvdXRlKCdwb3N0JywgeyBwYXRoOiAnOnBvc3RfaWQnIH0pOwogICAgICAgICB9KTsKICAgICAgIH0pOwogICAgICAgYGBgCiAgICAgICAgICBJdCB3aWxsIHJldHVybjoKICAgICAgICAgICogYGluZGV4YCB3aGVuIHlvdSB2aXNpdCBgL2AKICAgICAgICogYGFib3V0YCB3aGVuIHlvdSB2aXNpdCBgL2Fib3V0YAogICAgICAgKiBgYmxvZy5pbmRleGAgd2hlbiB5b3UgdmlzaXQgYC9ibG9nYAogICAgICAgKiBgYmxvZy5wb3N0YCB3aGVuIHlvdSB2aXNpdCBgL2Jsb2cvc29tZS1wb3N0LWlkYAogICAgICAgICAgQHByb3BlcnR5IGN1cnJlbnRSb3V0ZU5hbWUKICAgICAgIEB0eXBlIFN0cmluZwogICAgICAgQHB1YmxpYwogICAgICovCiAgICBjdXJyZW50Um91dGVOYW1lOiAoMCwgX2NvbXB1dGVkLnJlYWRPbmx5KSgnX3JvdXRlci5jdXJyZW50Um91dGVOYW1lJyksCgogICAgLyoqCiAgICAgICBDdXJyZW50IFVSTCBmb3IgdGhlIGFwcGxpY2F0aW9uLgogICAgICAgICBUaGlzIHByb3BlcnR5IHJlcHJlc2VudHMgdGhlIFVSTCBwYXRoIGZvciB0aGlzIHJvdXRlLgogICAgICBGb3IgdGhlIGZvbGxvd2luZyByb3V0ZXI6CiAgICAgICAgICBgYGBhcHAvcm91dGVyLmpzCiAgICAgICBSb3V0ZXIubWFwKGZ1bmN0aW9uKCkgewogICAgICAgICB0aGlzLnJvdXRlKCdhYm91dCcpOwogICAgICAgICB0aGlzLnJvdXRlKCdibG9nJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgIHRoaXMucm91dGUoJ3Bvc3QnLCB7IHBhdGg6ICc6cG9zdF9pZCcgfSk7CiAgICAgICAgIH0pOwogICAgICAgfSk7CiAgICAgICBgYGAKICAgICAgICAgIEl0IHdpbGwgcmV0dXJuOgogICAgICAgICAgKiBgL2Agd2hlbiB5b3UgdmlzaXQgYC9gCiAgICAgICAqIGAvYWJvdXRgIHdoZW4geW91IHZpc2l0IGAvYWJvdXRgCiAgICAgICAqIGAvYmxvZ2Agd2hlbiB5b3UgdmlzaXQgYC9ibG9nYAogICAgICAgKiBgL2Jsb2cvc29tZS1wb3N0LWlkYCB3aGVuIHlvdSB2aXNpdCBgL2Jsb2cvc29tZS1wb3N0LWlkYAogICAgICAgICAgQHByb3BlcnR5IGN1cnJlbnRVUkwKICAgICAgIEB0eXBlIFN0cmluZwogICAgICAgQHB1YmxpYwogICAgICovCiAgICBjdXJyZW50VVJMOiAoMCwgX2NvbXB1dGVkLnJlYWRPbmx5KSgnX3JvdXRlci5jdXJyZW50VVJMJyksCgogICAgLyoqCiAgICAgIFRoZSBgbG9jYXRpb25gIHByb3BlcnR5IHJldHVybnMgd2hhdCBpbXBsZW1lbnRhdGlvbiBvZiB0aGUgYGxvY2F0aW9uYCBBUEkKICAgICAgeW91ciBhcHBsaWNhdGlvbiBpcyB1c2luZywgd2hpY2ggZGV0ZXJtaW5lcyB3aGF0IHR5cGUgb2YgVVJMIGlzIGJlaW5nIHVzZWQuCiAgICAgICAgIFNlZSBbTG9jYXRpb25dKC9lbWJlci9yZWxlYXNlL2NsYXNzZXMvTG9jYXRpb24pIGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICAgICBUbyBmb3JjZSBhIHBhcnRpY3VsYXIgYGxvY2F0aW9uYCBBUEkgaW1wbGVtZW50YXRpb24gdG8gYmUgdXNlZCBpbiB5b3VyCiAgICAgIGFwcGxpY2F0aW9uIHlvdSBjYW4gc2V0IGEgbG9jYXRpb24gdHlwZSBvbiB5b3VyIGBjb25maWcvZW52aXJvbm1lbnRgLgogICAgICBGb3IgZXhhbXBsZSwgdG8gc2V0IHRoZSBgaGlzdG9yeWAgdHlwZToKICAgICAgICAgYGBgY29uZmlnL2Vudmlyb25tZW50LmpzCiAgICAgICd1c2Ugc3RyaWN0JzsKICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihlbnZpcm9ubWVudCkgewogICAgICAgIGxldCBFTlYgPSB7CiAgICAgICAgICBtb2R1bGVQcmVmaXg6ICdyb3V0ZXItc2VydmljZScsCiAgICAgICAgICBlbnZpcm9ubWVudCwKICAgICAgICAgIHJvb3RVUkw6ICcvJywKICAgICAgICAgIGxvY2F0aW9uVHlwZTogJ2hpc3RvcnknLAogICAgICAgICAgLi4uCiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgICBUaGUgZm9sbG93aW5nIGxvY2F0aW9uIHR5cGVzIGFyZSBhdmFpbGFibGUgYnkgZGVmYXVsdDoKICAgICAgYGF1dG9gLCBgaGFzaGAsIGBoaXN0b3J5YCwgYG5vbmVgLgogICAgICAgICBTZWUgW0hhc2hMb2NhdGlvbl0oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9IYXNoTG9jYXRpb24pLgogICAgICBTZWUgW0hpc3RvcnlMb2NhdGlvbl0oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9IaXN0b3J5TG9jYXRpb24pLgogICAgICBTZWUgW05vbmVMb2NhdGlvbl0oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9Ob25lTG9jYXRpb24pLgogICAgICBTZWUgW0F1dG9Mb2NhdGlvbl0oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9BdXRvTG9jYXRpb24pLgogICAgICAgICBAcHJvcGVydHkgbG9jYXRpb24KICAgICAgQGRlZmF1bHQgJ2hhc2gnCiAgICAgIEBzZWUge0xvY2F0aW9ufQogICAgICBAcHVibGljCiAgICAqLwogICAgbG9jYXRpb246ICgwLCBfY29tcHV0ZWQucmVhZE9ubHkpKCdfcm91dGVyLmxvY2F0aW9uJyksCgogICAgLyoqCiAgICAgIFRoZSBgcm9vdFVSTGAgcHJvcGVydHkgcmVwcmVzZW50cyB0aGUgVVJMIG9mIHRoZSByb290IG9mCiAgICAgIHRoZSBhcHBsaWNhdGlvbiwgJy8nIGJ5IGRlZmF1bHQuCiAgICAgIFRoaXMgcHJlZml4IGlzIGFzc3VtZWQgb24gYWxsIHJvdXRlcyBkZWZpbmVkIG9uIHRoaXMgYXBwLgogICAgICAgICBJZiB5b3UgY2hhbmdlIHRoZSBgcm9vdFVSTGAgaW4geW91ciBlbnZpcm9ubWVudCBjb25maWd1cmF0aW9uCiAgICAgIGxpa2Ugc286CiAgICAgICAgIGBgYGNvbmZpZy9lbnZpcm9ubWVudC5qcwogICAgICAndXNlIHN0cmljdCc7CiAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oZW52aXJvbm1lbnQpIHsKICAgICAgICBsZXQgRU5WID0gewogICAgICAgICAgbW9kdWxlUHJlZml4OiAncm91dGVyLXNlcnZpY2UnLAogICAgICAgICAgZW52aXJvbm1lbnQsCiAgICAgICAgICByb290VVJMOiAnL215LXJvb3QnLAogICAgICAgIOKApgogICAgICAgIH0KICAgICAgXQogICAgICBgYGAKICAgICAgICAgVGhpcyBwcm9wZXJ0eSB3aWxsIHJldHVybiBgL215LXJvb3RgLgogICAgICAgICBAcHJvcGVydHkgcm9vdFVSTAogICAgICBAZGVmYXVsdCAnLycKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHJvb3RVUkw6ICgwLCBfY29tcHV0ZWQucmVhZE9ubHkpKCdfcm91dGVyLnJvb3RVUkwnKSwKCiAgICAvKioKICAgICAgVGhlIGBjdXJyZW50Um91dGVgIHByb3BlcnR5IGNvbnRhaW5zIG1ldGFkYXRhIGFib3V0IHRoZSBjdXJyZW50IGxlYWYgcm91dGUuCiAgICAgIEl0IHJldHVybnMgYSBgUm91dGVJbmZvYCBvYmplY3QgdGhhdCBoYXMgaW5mb3JtYXRpb24gbGlrZSB0aGUgcm91dGUgbmFtZSwKICAgICAgcGFyYW1zLCBxdWVyeSBwYXJhbXMgYW5kIG1vcmUuCiAgICAgICAgIFNlZSBbUm91dGVJbmZvXSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL1JvdXRlSW5mbykgZm9yIG1vcmUgaW5mby4KICAgICAgICAgVGhpcyBwcm9wZXJ0eSBpcyBndWFyYW50ZWVkIHRvIGNoYW5nZSB3aGVuZXZlciBhIHJvdXRlIHRyYW5zaXRpb24KICAgICAgaGFwcGVucyAoZXZlbiB3aGVuIHRoYXQgdHJhbnNpdGlvbiBvbmx5IGNoYW5nZXMgcGFyYW1ldGVycwogICAgICBhbmQgZG9lc24ndCBjaGFuZ2UgdGhlIGFjdGl2ZSByb3V0ZSkuCiAgICAgICAgIFVzYWdlIGV4YW1wbGU6CiAgICAgIGBgYGFwcC9jb21wb25lbnRzL2hlYWRlci5qcwogICAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGdsaW1tZXIvY29tcG9uZW50JzsKICAgICAgICBpbXBvcnQgeyBpbmplY3QgYXMgc2VydmljZSB9IGZyb20gJ0BlbWJlci9zZXJ2aWNlJzsKICAgICAgICBpbXBvcnQgeyBub3RFbXB0eSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogICAgICAgICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIGV4dGVuZHMgQ29tcG9uZW50IHsKICAgICAgICAgIEBzZXJ2aWNlIHJvdXRlcjsKICAgICAgICAgICAgIEBub3RFbXB0eSgncm91dGVyLmN1cnJlbnRSb3V0ZS5jaGlsZCcpIGlzQ2hpbGRSb3V0ZTsKICAgICAgICB9KTsKICAgICAgYGBgCiAgICAgICAgICBAcHJvcGVydHkgY3VycmVudFJvdXRlCiAgICAgICBAdHlwZSBSb3V0ZUluZm8KICAgICAgIEBwdWJsaWMKICAgICAqLwogICAgY3VycmVudFJvdXRlOiAoMCwgX2NvbXB1dGVkLnJlYWRPbmx5KSgnX3JvdXRlci5jdXJyZW50Um91dGUnKQogIH0pOwp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9yb3V0aW5nL2xpYi9zZXJ2aWNlcy9yb3V0aW5nIiwgWyJleHBvcnRzIiwgImVtYmVyLWJhYmVsIiwgIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCAiQGVtYmVyL3BvbHlmaWxscyIsICJAZW1iZXIvc2VydmljZSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9lbWJlckJhYmVsLCBfY29tcHV0ZWQsIF9wb2x5ZmlsbHMsIF9zZXJ2aWNlKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICBUaGUgUm91dGluZyBzZXJ2aWNlIGlzIHVzZWQgYnkgTGlua0NvbXBvbmVudCwgYW5kIHByb3ZpZGVzIGZhY2lsaXRpZXMgZm9yCiAgICB0aGUgY29tcG9uZW50L3ZpZXcgbGF5ZXIgdG8gaW50ZXJhY3Qgd2l0aCB0aGUgcm91dGVyLgogIAogICAgVGhpcyBpcyBhIHByaXZhdGUgc2VydmljZSBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seS4gRm9yIHB1YmxpYyB1c2FnZSwKICAgIHJlZmVyIHRvIHRoZSBgUm91dGVyYCBzZXJ2aWNlLgogIAogICAgQHByaXZhdGUKICAgIEBjbGFzcyBSb3V0aW5nU2VydmljZQogICovCiAgdmFyIFJvdXRpbmdTZXJ2aWNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9TZXJ2aWNlKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoUm91dGluZ1NlcnZpY2UsIF9TZXJ2aWNlKTsKCiAgICBmdW5jdGlvbiBSb3V0aW5nU2VydmljZSgpIHsKICAgICAgcmV0dXJuIF9TZXJ2aWNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgIH0KCiAgICB2YXIgX3Byb3RvID0gUm91dGluZ1NlcnZpY2UucHJvdG90eXBlOwoKICAgIF9wcm90by5oYXNSb3V0ZSA9IGZ1bmN0aW9uIGhhc1JvdXRlKHJvdXRlTmFtZSkgewogICAgICByZXR1cm4gdGhpcy5yb3V0ZXIuaGFzUm91dGUocm91dGVOYW1lKTsKICAgIH07CgogICAgX3Byb3RvLnRyYW5zaXRpb25UbyA9IGZ1bmN0aW9uIHRyYW5zaXRpb25Ubyhyb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMsIHNob3VsZFJlcGxhY2UpIHsKICAgICAgdmFyIHRyYW5zaXRpb24gPSB0aGlzLnJvdXRlci5fZG9UcmFuc2l0aW9uKHJvdXRlTmFtZSwgbW9kZWxzLCBxdWVyeVBhcmFtcyk7CgogICAgICBpZiAoc2hvdWxkUmVwbGFjZSkgewogICAgICAgIHRyYW5zaXRpb24ubWV0aG9kKCdyZXBsYWNlJyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cmFuc2l0aW9uOwogICAgfTsKCiAgICBfcHJvdG8ubm9ybWFsaXplUXVlcnlQYXJhbXMgPSBmdW5jdGlvbiBub3JtYWxpemVRdWVyeVBhcmFtcyhyb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMpIHsKICAgICAgdGhpcy5yb3V0ZXIuX3ByZXBhcmVRdWVyeVBhcmFtcyhyb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMpOwogICAgfTsKCiAgICBfcHJvdG8uZ2VuZXJhdGVVUkwgPSBmdW5jdGlvbiBnZW5lcmF0ZVVSTChyb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMpIHsKICAgICAgdmFyIHJvdXRlciA9IHRoaXMucm91dGVyOyAvLyByZXR1cm4gZWFybHkgd2hlbiB0aGUgcm91dGVyIG1pY3JvbGliIGlzIG5vdCBwcmVzZW50LCB3aGljaCBpcyB0aGUgY2FzZSBmb3Ige3tsaW5rLXRvfX0gaW4gaW50ZWdyYXRpb24gdGVzdHMKCiAgICAgIGlmICghcm91dGVyLl9yb3V0ZXJNaWNyb2xpYikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHZpc2libGVRdWVyeVBhcmFtcyA9IHt9OwoKICAgICAgaWYgKHF1ZXJ5UGFyYW1zKSB7CiAgICAgICAgKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh2aXNpYmxlUXVlcnlQYXJhbXMsIHF1ZXJ5UGFyYW1zKTsKICAgICAgICB0aGlzLm5vcm1hbGl6ZVF1ZXJ5UGFyYW1zKHJvdXRlTmFtZSwgbW9kZWxzLCB2aXNpYmxlUXVlcnlQYXJhbXMpOwogICAgICB9CgogICAgICByZXR1cm4gcm91dGVyLmdlbmVyYXRlLmFwcGx5KHJvdXRlciwgW3JvdXRlTmFtZV0uY29uY2F0KG1vZGVscywgW3sKICAgICAgICBxdWVyeVBhcmFtczogdmlzaWJsZVF1ZXJ5UGFyYW1zCiAgICAgIH1dKSk7CiAgICB9OwoKICAgIF9wcm90by5pc0FjdGl2ZUZvclJvdXRlID0gZnVuY3Rpb24gaXNBY3RpdmVGb3JSb3V0ZShjb250ZXh0cywgcXVlcnlQYXJhbXMsIHJvdXRlTmFtZSwgcm91dGVyU3RhdGUsIGlzQ3VycmVudFdoZW5TcGVjaWZpZWQpIHsKICAgICAgdmFyIGhhbmRsZXJzID0gdGhpcy5yb3V0ZXIuX3JvdXRlck1pY3JvbGliLnJlY29nbml6ZXIuaGFuZGxlcnNGb3Iocm91dGVOYW1lKTsKCiAgICAgIHZhciBsZWFmTmFtZSA9IGhhbmRsZXJzW2hhbmRsZXJzLmxlbmd0aCAtIDFdLmhhbmRsZXI7CiAgICAgIHZhciBtYXhpbXVtQ29udGV4dHMgPSBudW1iZXJPZkNvbnRleHRzQWNjZXB0ZWRCeUhhbmRsZXIocm91dGVOYW1lLCBoYW5kbGVycyk7IC8vIE5PVEU6IGFueSB1Z2xpbmVzcyBpbiB0aGUgY2FsY3VsYXRpb24gb2YgYWN0aXZlbmVzcyBpcyBsYXJnZWx5CiAgICAgIC8vIGR1ZSB0byB0aGUgZmFjdCB0aGF0IHdlIHN1cHBvcnQgYXV0b21hdGljIG5vcm1hbGl6aW5nIG9mCiAgICAgIC8vIGByZXNvdXJjZWAgLT4gYHJlc291cmNlLmluZGV4YCwgZXZlbiB0aG91Z2ggdGhlcmUgbWlnaHQgYmUKICAgICAgLy8gZHluYW1pYyBzZWdtZW50cyAvIHF1ZXJ5IHBhcmFtcyBkZWZpbmVkIG9uIGByZXNvdXJjZS5pbmRleGAKICAgICAgLy8gd2hpY2ggY29tcGxpY2F0ZXMgKGFuZCBtYWtlcyBzb21ld2hhdCBhbWJpZ3VvdXMpIHRoZSBjYWxjdWxhdGlvbgogICAgICAvLyBvZiBhY3RpdmVuZXNzIGZvciBsaW5rcyB0aGF0IGxpbmsgdG8gYHJlc291cmNlYCBpbnN0ZWFkIG9mCiAgICAgIC8vIGRpcmVjdGx5IHRvIGByZXNvdXJjZS5pbmRleGAuCiAgICAgIC8vIGlmIHdlIGRvbid0IGhhdmUgZW5vdWdoIGNvbnRleHRzIHJldmVydCBiYWNrIHRvIGZ1bGwgcm91dGUgbmFtZQogICAgICAvLyB0aGlzIGlzIGJlY2F1c2UgdGhlIGxlYWYgcm91dGUgd2lsbCB1c2Ugb25lIG9mIHRoZSBjb250ZXh0cwoKICAgICAgaWYgKGNvbnRleHRzLmxlbmd0aCA+IG1heGltdW1Db250ZXh0cykgewogICAgICAgIHJvdXRlTmFtZSA9IGxlYWZOYW1lOwogICAgICB9CgogICAgICByZXR1cm4gcm91dGVyU3RhdGUuaXNBY3RpdmVJbnRlbnQocm91dGVOYW1lLCBjb250ZXh0cywgcXVlcnlQYXJhbXMsICFpc0N1cnJlbnRXaGVuU3BlY2lmaWVkKTsKICAgIH07CgogICAgcmV0dXJuIFJvdXRpbmdTZXJ2aWNlOwogIH0oX3NlcnZpY2UuZGVmYXVsdCk7CgogIF9leHBvcnRzLmRlZmF1bHQgPSBSb3V0aW5nU2VydmljZTsKICBSb3V0aW5nU2VydmljZS5yZW9wZW4oewogICAgdGFyZ2V0U3RhdGU6ICgwLCBfY29tcHV0ZWQucmVhZE9ubHkpKCdyb3V0ZXIudGFyZ2V0U3RhdGUnKSwKICAgIGN1cnJlbnRTdGF0ZTogKDAsIF9jb21wdXRlZC5yZWFkT25seSkoJ3JvdXRlci5jdXJyZW50U3RhdGUnKSwKICAgIGN1cnJlbnRSb3V0ZU5hbWU6ICgwLCBfY29tcHV0ZWQucmVhZE9ubHkpKCdyb3V0ZXIuY3VycmVudFJvdXRlTmFtZScpLAogICAgY3VycmVudFBhdGg6ICgwLCBfY29tcHV0ZWQucmVhZE9ubHkpKCdyb3V0ZXIuY3VycmVudFBhdGgnKQogIH0pOwoKICBmdW5jdGlvbiBudW1iZXJPZkNvbnRleHRzQWNjZXB0ZWRCeUhhbmRsZXIoaGFuZGxlck5hbWUsIGhhbmRsZXJJbmZvcykgewogICAgdmFyIHJlcSA9IDA7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoYW5kbGVySW5mb3MubGVuZ3RoOyBpKyspIHsKICAgICAgcmVxICs9IGhhbmRsZXJJbmZvc1tpXS5uYW1lcy5sZW5ndGg7CgogICAgICBpZiAoaGFuZGxlckluZm9zW2ldLmhhbmRsZXIgPT09IGhhbmRsZXJOYW1lKSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmVxOwogIH0KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvc3lzdGVtL2NhY2hlIiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgICBBIHR3by10aWVyZWQgY2FjaGUgd2l0aCBzdXBwb3J0IGZvciBmYWxsYmFjayB2YWx1ZXMgd2hlbiBkb2luZyBsb29rdXBzLgogICAgVXNlcyAiYnVja2V0cyIgYW5kIHRoZW4gImtleXMiIHRvIGNhY2hlIHZhbHVlcy4KICAKICAgIEBwcml2YXRlCiAgICBAY2xhc3MgQnVja2V0Q2FjaGUKICAqLwogIHZhciBCdWNrZXRDYWNoZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEJ1Y2tldENhY2hlKCkgewogICAgICB0aGlzLmNhY2hlID0gbmV3IE1hcCgpOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBCdWNrZXRDYWNoZS5wcm90b3R5cGU7CgogICAgX3Byb3RvLmhhcyA9IGZ1bmN0aW9uIGhhcyhidWNrZXRLZXkpIHsKICAgICAgcmV0dXJuIHRoaXMuY2FjaGUuaGFzKGJ1Y2tldEtleSk7CiAgICB9OwoKICAgIF9wcm90by5zdGFzaCA9IGZ1bmN0aW9uIHN0YXNoKGJ1Y2tldEtleSwga2V5LCB2YWx1ZSkgewogICAgICB2YXIgYnVja2V0ID0gdGhpcy5jYWNoZS5nZXQoYnVja2V0S2V5KTsKCiAgICAgIGlmIChidWNrZXQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGJ1Y2tldCA9IG5ldyBNYXAoKTsKICAgICAgICB0aGlzLmNhY2hlLnNldChidWNrZXRLZXksIGJ1Y2tldCk7CiAgICAgIH0KCiAgICAgIGJ1Y2tldC5zZXQoa2V5LCB2YWx1ZSk7CiAgICB9OwoKICAgIF9wcm90by5sb29rdXAgPSBmdW5jdGlvbiBsb29rdXAoYnVja2V0S2V5LCBwcm9wLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgaWYgKCF0aGlzLmhhcyhidWNrZXRLZXkpKSB7CiAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgfQoKICAgICAgdmFyIGJ1Y2tldCA9IHRoaXMuY2FjaGUuZ2V0KGJ1Y2tldEtleSk7CgogICAgICBpZiAoYnVja2V0Lmhhcyhwcm9wKSkgewogICAgICAgIHJldHVybiBidWNrZXQuZ2V0KHByb3ApOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIEJ1Y2tldENhY2hlOwogIH0oKTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IEJ1Y2tldENhY2hlOwp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9yb3V0aW5nL2xpYi9zeXN0ZW0vY29udHJvbGxlcl9mb3IiLCBbImV4cG9ydHMiXSwgZnVuY3Rpb24gKF9leHBvcnRzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gY29udHJvbGxlckZvcjsKCiAgLyoqCiAgQG1vZHVsZSBlbWJlcgogICovCgogIC8qKgogICAgRmluZHMgYSBjb250cm9sbGVyIGluc3RhbmNlLgogIAogICAgQGZvciBFbWJlcgogICAgQG1ldGhvZCBjb250cm9sbGVyRm9yCiAgICBAcHJpdmF0ZQogICovCiAgZnVuY3Rpb24gY29udHJvbGxlckZvcihjb250YWluZXIsIGNvbnRyb2xsZXJOYW1lLCBsb29rdXBPcHRpb25zKSB7CiAgICByZXR1cm4gY29udGFpbmVyLmxvb2t1cCgiY29udHJvbGxlcjoiICsgY29udHJvbGxlck5hbWUsIGxvb2t1cE9wdGlvbnMpOwogIH0KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvc3lzdGVtL2RzbCIsIFsiZXhwb3J0cyIsICJAZW1iZXIvZGVidWciLCAiQGVtYmVyL3BvbHlmaWxscyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9kZWJ1ZywgX3BvbHlmaWxscykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKICB2YXIgdXVpZCA9IDA7CgogIGZ1bmN0aW9uIGlzQ2FsbGJhY2sodmFsdWUpIHsKICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbic7CiAgfQoKICBmdW5jdGlvbiBpc09wdGlvbnModmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnOwogIH0KCiAgdmFyIERTTEltcGwgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBEU0xJbXBsKG5hbWUsIG9wdGlvbnMpIHsKICAgICAgaWYgKG5hbWUgPT09IHZvaWQgMCkgewogICAgICAgIG5hbWUgPSBudWxsOwogICAgICB9CgogICAgICB0aGlzLmV4cGxpY2l0SW5kZXggPSBmYWxzZTsKICAgICAgdGhpcy5wYXJlbnQgPSBuYW1lOwogICAgICB0aGlzLmVuYWJsZUxvYWRpbmdTdWJzdGF0ZXMgPSBCb29sZWFuKG9wdGlvbnMgJiYgb3B0aW9ucy5lbmFibGVMb2FkaW5nU3Vic3RhdGVzKTsKICAgICAgdGhpcy5tYXRjaGVzID0gW107CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9CgogICAgdmFyIF9wcm90byA9IERTTEltcGwucHJvdG90eXBlOwoKICAgIF9wcm90by5yb3V0ZSA9IGZ1bmN0aW9uIHJvdXRlKG5hbWUsIF9vcHRpb25zLCBfY2FsbGJhY2spIHsKICAgICAgdmFyIG9wdGlvbnM7CiAgICAgIHZhciBjYWxsYmFjayA9IG51bGw7CiAgICAgIHZhciBkdW1teUVycm9yUm91dGUgPSAiL191bnVzZWRfZHVtbXlfZXJyb3JfcGF0aF9yb3V0ZV8iICsgbmFtZSArICIvOmVycm9yIjsKCiAgICAgIGlmIChpc0NhbGxiYWNrKF9vcHRpb25zKSkgewogICAgICAgIChmYWxzZSAmJiAhKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnVW5leHBlY3RlZCBhcmd1bWVudHMnLCBhcmd1bWVudHMubGVuZ3RoID09PSAyKSk7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICAgIGNhbGxiYWNrID0gX29wdGlvbnM7CiAgICAgIH0gZWxzZSBpZiAoaXNDYWxsYmFjayhfY2FsbGJhY2spKSB7CiAgICAgICAgKGZhbHNlICYmICEoYXJndW1lbnRzLmxlbmd0aCA9PT0gMykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdVbmV4cGVjdGVkIGFyZ3VtZW50cycsIGFyZ3VtZW50cy5sZW5ndGggPT09IDMpKTsKICAgICAgICAoZmFsc2UgJiYgIShpc09wdGlvbnMoX29wdGlvbnMpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1VuZXhwZWN0ZWQgYXJndW1lbnRzJywgaXNPcHRpb25zKF9vcHRpb25zKSkpOwogICAgICAgIG9wdGlvbnMgPSBfb3B0aW9uczsKICAgICAgICBjYWxsYmFjayA9IF9jYWxsYmFjazsKICAgICAgfSBlbHNlIHsKICAgICAgICBvcHRpb25zID0gX29wdGlvbnMgfHwge307CiAgICAgIH0KCiAgICAgIChmYWxzZSAmJiAhKGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAob3B0aW9ucy5vdmVycmlkZU5hbWVBc3NlcnRpb24gPT09IHRydWUpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIFsnYmFzaWMnLCAnYXBwbGljYXRpb24nXS5pbmRleE9mKG5hbWUpID09PSAtMTsKICAgICAgfSgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIiciICsgbmFtZSArICInIGNhbm5vdCBiZSB1c2VkIGFzIGEgcm91dGUgbmFtZS4iLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKG9wdGlvbnMub3ZlcnJpZGVOYW1lQXNzZXJ0aW9uID09PSB0cnVlKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBbJ2Jhc2ljJywgJ2FwcGxpY2F0aW9uJ10uaW5kZXhPZihuYW1lKSA9PT0gLTE7CiAgICAgIH0oKSkpOwogICAgICAoZmFsc2UgJiYgIShuYW1lLmluZGV4T2YoJzonKSA9PT0gLTEpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiJyIgKyBuYW1lICsgIicgaXMgbm90IGEgdmFsaWQgcm91dGUgbmFtZS4gSXQgY2Fubm90IGNvbnRhaW4gYSAnOicuIFlvdSBtYXkgd2FudCB0byB1c2UgdGhlICdwYXRoJyBvcHRpb24gaW5zdGVhZC4iLCBuYW1lLmluZGV4T2YoJzonKSA9PT0gLTEpKTsKCiAgICAgIGlmICh0aGlzLmVuYWJsZUxvYWRpbmdTdWJzdGF0ZXMpIHsKICAgICAgICBjcmVhdGVSb3V0ZSh0aGlzLCBuYW1lICsgIl9sb2FkaW5nIiwgewogICAgICAgICAgcmVzZXROYW1lc3BhY2U6IG9wdGlvbnMucmVzZXROYW1lc3BhY2UKICAgICAgICB9KTsKICAgICAgICBjcmVhdGVSb3V0ZSh0aGlzLCBuYW1lICsgIl9lcnJvciIsIHsKICAgICAgICAgIHJlc2V0TmFtZXNwYWNlOiBvcHRpb25zLnJlc2V0TmFtZXNwYWNlLAogICAgICAgICAgcGF0aDogZHVtbXlFcnJvclJvdXRlCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIHZhciBmdWxsTmFtZSA9IGdldEZ1bGxOYW1lKHRoaXMsIG5hbWUsIG9wdGlvbnMucmVzZXROYW1lc3BhY2UpOwogICAgICAgIHZhciBkc2wgPSBuZXcgRFNMSW1wbChmdWxsTmFtZSwgdGhpcy5vcHRpb25zKTsKICAgICAgICBjcmVhdGVSb3V0ZShkc2wsICdsb2FkaW5nJyk7CiAgICAgICAgY3JlYXRlUm91dGUoZHNsLCAnZXJyb3InLCB7CiAgICAgICAgICBwYXRoOiBkdW1teUVycm9yUm91dGUKICAgICAgICB9KTsKICAgICAgICBjYWxsYmFjay5jYWxsKGRzbCk7CiAgICAgICAgY3JlYXRlUm91dGUodGhpcywgbmFtZSwgb3B0aW9ucywgZHNsLmdlbmVyYXRlKCkpOwogICAgICB9IGVsc2UgewogICAgICAgIGNyZWF0ZVJvdXRlKHRoaXMsIG5hbWUsIG9wdGlvbnMpOwogICAgICB9CiAgICB9CiAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLWR1cGUtY2xhc3MtbWVtYmVycyAqLwogICAgOwoKICAgIF9wcm90by5wdXNoID0gZnVuY3Rpb24gcHVzaCh1cmwsIG5hbWUsIGNhbGxiYWNrLCBzZXJpYWxpemUpIHsKICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnLicpOwoKICAgICAgaWYgKHRoaXMub3B0aW9ucy5lbmdpbmVJbmZvKSB7CiAgICAgICAgdmFyIGxvY2FsRnVsbE5hbWUgPSBuYW1lLnNsaWNlKHRoaXMub3B0aW9ucy5lbmdpbmVJbmZvLmZ1bGxOYW1lLmxlbmd0aCArIDEpOwogICAgICAgIHZhciByb3V0ZUluZm8gPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHsKICAgICAgICAgIGxvY2FsRnVsbE5hbWU6IGxvY2FsRnVsbE5hbWUKICAgICAgICB9LCB0aGlzLm9wdGlvbnMuZW5naW5lSW5mbyk7CgogICAgICAgIGlmIChzZXJpYWxpemUpIHsKICAgICAgICAgIHJvdXRlSW5mby5zZXJpYWxpemVNZXRob2QgPSBzZXJpYWxpemU7CiAgICAgICAgfQoKICAgICAgICB0aGlzLm9wdGlvbnMuYWRkUm91dGVGb3JFbmdpbmUobmFtZSwgcm91dGVJbmZvKTsKICAgICAgfSBlbHNlIGlmIChzZXJpYWxpemUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkRlZmluaW5nIGEgcm91dGUgc2VyaWFsaXplciBvbiByb3V0ZSAnIiArIG5hbWUgKyAiJyBvdXRzaWRlIGFuIEVuZ2luZSBpcyBub3QgYWxsb3dlZC4iKTsKICAgICAgfQoKICAgICAgaWYgKHVybCA9PT0gJycgfHwgdXJsID09PSAnLycgfHwgcGFydHNbcGFydHMubGVuZ3RoIC0gMV0gPT09ICdpbmRleCcpIHsKICAgICAgICB0aGlzLmV4cGxpY2l0SW5kZXggPSB0cnVlOwogICAgICB9CgogICAgICB0aGlzLm1hdGNoZXMucHVzaCh1cmwsIG5hbWUsIGNhbGxiYWNrKTsKICAgIH07CgogICAgX3Byb3RvLmdlbmVyYXRlID0gZnVuY3Rpb24gZ2VuZXJhdGUoKSB7CiAgICAgIHZhciBkc2xNYXRjaGVzID0gdGhpcy5tYXRjaGVzOwoKICAgICAgaWYgKCF0aGlzLmV4cGxpY2l0SW5kZXgpIHsKICAgICAgICB0aGlzLnJvdXRlKCdpbmRleCcsIHsKICAgICAgICAgIHBhdGg6ICcvJwogICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gZnVuY3Rpb24gKG1hdGNoKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkc2xNYXRjaGVzLmxlbmd0aDsgaSArPSAzKSB7CiAgICAgICAgICBtYXRjaChkc2xNYXRjaGVzW2ldKS50byhkc2xNYXRjaGVzW2kgKyAxXSwgZHNsTWF0Y2hlc1tpICsgMl0pOwogICAgICAgIH0KICAgICAgfTsKICAgIH07CgogICAgX3Byb3RvLm1vdW50ID0gZnVuY3Rpb24gbW91bnQoX25hbWUsIG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgdmFyIGVuZ2luZVJvdXRlTWFwID0gdGhpcy5vcHRpb25zLnJlc29sdmVSb3V0ZU1hcChfbmFtZSk7CiAgICAgIHZhciBuYW1lID0gX25hbWU7CgogICAgICBpZiAob3B0aW9ucy5hcykgewogICAgICAgIG5hbWUgPSBvcHRpb25zLmFzOwogICAgICB9CgogICAgICB2YXIgZnVsbE5hbWUgPSBnZXRGdWxsTmFtZSh0aGlzLCBuYW1lLCBvcHRpb25zLnJlc2V0TmFtZXNwYWNlKTsKICAgICAgdmFyIGVuZ2luZUluZm8gPSB7CiAgICAgICAgbmFtZTogX25hbWUsCiAgICAgICAgaW5zdGFuY2VJZDogdXVpZCsrLAogICAgICAgIG1vdW50UG9pbnQ6IGZ1bGxOYW1lLAogICAgICAgIGZ1bGxOYW1lOiBmdWxsTmFtZQogICAgICB9OwogICAgICB2YXIgcGF0aCA9IG9wdGlvbnMucGF0aDsKCiAgICAgIGlmICh0eXBlb2YgcGF0aCAhPT0gJ3N0cmluZycpIHsKICAgICAgICBwYXRoID0gIi8iICsgbmFtZTsKICAgICAgfQoKICAgICAgdmFyIGNhbGxiYWNrOwogICAgICB2YXIgZHVtbXlFcnJvclJvdXRlID0gIi9fdW51c2VkX2R1bW15X2Vycm9yX3BhdGhfcm91dGVfIiArIG5hbWUgKyAiLzplcnJvciI7CgogICAgICBpZiAoZW5naW5lUm91dGVNYXApIHsKICAgICAgICB2YXIgc2hvdWxkUmVzZXRFbmdpbmVJbmZvID0gZmFsc2U7CiAgICAgICAgdmFyIG9sZEVuZ2luZUluZm8gPSB0aGlzLm9wdGlvbnMuZW5naW5lSW5mbzsKCiAgICAgICAgaWYgKG9sZEVuZ2luZUluZm8pIHsKICAgICAgICAgIHNob3VsZFJlc2V0RW5naW5lSW5mbyA9IHRydWU7CiAgICAgICAgICB0aGlzLm9wdGlvbnMuZW5naW5lSW5mbyA9IGVuZ2luZUluZm87CiAgICAgICAgfQoKICAgICAgICB2YXIgb3B0aW9uc0ZvckNoaWxkID0gKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7CiAgICAgICAgICBlbmdpbmVJbmZvOiBlbmdpbmVJbmZvCiAgICAgICAgfSwgdGhpcy5vcHRpb25zKTsKICAgICAgICB2YXIgY2hpbGREU0wgPSBuZXcgRFNMSW1wbChmdWxsTmFtZSwgb3B0aW9uc0ZvckNoaWxkKTsKICAgICAgICBjcmVhdGVSb3V0ZShjaGlsZERTTCwgJ2xvYWRpbmcnKTsKICAgICAgICBjcmVhdGVSb3V0ZShjaGlsZERTTCwgJ2Vycm9yJywgewogICAgICAgICAgcGF0aDogZHVtbXlFcnJvclJvdXRlCiAgICAgICAgfSk7CiAgICAgICAgZW5naW5lUm91dGVNYXAuY2xhc3MuY2FsbChjaGlsZERTTCk7CiAgICAgICAgY2FsbGJhY2sgPSBjaGlsZERTTC5nZW5lcmF0ZSgpOwoKICAgICAgICBpZiAoc2hvdWxkUmVzZXRFbmdpbmVJbmZvKSB7CiAgICAgICAgICB0aGlzLm9wdGlvbnMuZW5naW5lSW5mbyA9IG9sZEVuZ2luZUluZm87CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgbG9jYWxGdWxsTmFtZSA9ICdhcHBsaWNhdGlvbic7CiAgICAgIHZhciByb3V0ZUluZm8gPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHsKICAgICAgICBsb2NhbEZ1bGxOYW1lOiBsb2NhbEZ1bGxOYW1lCiAgICAgIH0sIGVuZ2luZUluZm8pOwoKICAgICAgaWYgKHRoaXMuZW5hYmxlTG9hZGluZ1N1YnN0YXRlcykgewogICAgICAgIC8vIFRoZXNlIHZhbHVlcyBhcmUgaW1wb3J0YW50IHRvIHJlZ2lzdGVyIHRoZSBsb2FkaW5nIHJvdXRlcyB1bmRlciB0aGVpcgogICAgICAgIC8vIHByb3BlciBuYW1lcyBmb3IgdGhlIFJvdXRlciBhbmQgd2l0aGluIHRoZSBFbmdpbmUncyByZWdpc3RyeS4KICAgICAgICB2YXIgc3Vic3RhdGVOYW1lID0gbmFtZSArICJfbG9hZGluZyI7CiAgICAgICAgdmFyIF9sb2NhbEZ1bGxOYW1lID0gImFwcGxpY2F0aW9uX2xvYWRpbmciOwoKICAgICAgICB2YXIgX3JvdXRlSW5mbyA9ICgwLCBfcG9seWZpbGxzLmFzc2lnbikoewogICAgICAgICAgbG9jYWxGdWxsTmFtZTogX2xvY2FsRnVsbE5hbWUKICAgICAgICB9LCBlbmdpbmVJbmZvKTsKCiAgICAgICAgY3JlYXRlUm91dGUodGhpcywgc3Vic3RhdGVOYW1lLCB7CiAgICAgICAgICByZXNldE5hbWVzcGFjZTogb3B0aW9ucy5yZXNldE5hbWVzcGFjZQogICAgICAgIH0pOwogICAgICAgIHRoaXMub3B0aW9ucy5hZGRSb3V0ZUZvckVuZ2luZShzdWJzdGF0ZU5hbWUsIF9yb3V0ZUluZm8pOwogICAgICAgIHN1YnN0YXRlTmFtZSA9IG5hbWUgKyAiX2Vycm9yIjsKICAgICAgICBfbG9jYWxGdWxsTmFtZSA9ICJhcHBsaWNhdGlvbl9lcnJvciI7CiAgICAgICAgX3JvdXRlSW5mbyA9ICgwLCBfcG9seWZpbGxzLmFzc2lnbikoewogICAgICAgICAgbG9jYWxGdWxsTmFtZTogX2xvY2FsRnVsbE5hbWUKICAgICAgICB9LCBlbmdpbmVJbmZvKTsKICAgICAgICBjcmVhdGVSb3V0ZSh0aGlzLCBzdWJzdGF0ZU5hbWUsIHsKICAgICAgICAgIHJlc2V0TmFtZXNwYWNlOiBvcHRpb25zLnJlc2V0TmFtZXNwYWNlLAogICAgICAgICAgcGF0aDogZHVtbXlFcnJvclJvdXRlCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5vcHRpb25zLmFkZFJvdXRlRm9yRW5naW5lKHN1YnN0YXRlTmFtZSwgX3JvdXRlSW5mbyk7CiAgICAgIH0KCiAgICAgIHRoaXMub3B0aW9ucy5hZGRSb3V0ZUZvckVuZ2luZShmdWxsTmFtZSwgcm91dGVJbmZvKTsKICAgICAgdGhpcy5wdXNoKHBhdGgsIGZ1bGxOYW1lLCBjYWxsYmFjayk7CiAgICB9OwoKICAgIHJldHVybiBEU0xJbXBsOwogIH0oKTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IERTTEltcGw7CgogIGZ1bmN0aW9uIGNhbk5lc3QoZHNsKSB7CiAgICByZXR1cm4gZHNsLnBhcmVudCAhPT0gJ2FwcGxpY2F0aW9uJzsKICB9CgogIGZ1bmN0aW9uIGdldEZ1bGxOYW1lKGRzbCwgbmFtZSwgcmVzZXROYW1lc3BhY2UpIHsKICAgIGlmIChjYW5OZXN0KGRzbCkgJiYgcmVzZXROYW1lc3BhY2UgIT09IHRydWUpIHsKICAgICAgcmV0dXJuIGRzbC5wYXJlbnQgKyAiLiIgKyBuYW1lOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVSb3V0ZShkc2wsIG5hbWUsIG9wdGlvbnMsIGNhbGxiYWNrKSB7CiAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgIG9wdGlvbnMgPSB7fTsKICAgIH0KCiAgICB2YXIgZnVsbE5hbWUgPSBnZXRGdWxsTmFtZShkc2wsIG5hbWUsIG9wdGlvbnMucmVzZXROYW1lc3BhY2UpOwoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5wYXRoICE9PSAnc3RyaW5nJykgewogICAgICBvcHRpb25zLnBhdGggPSAiLyIgKyBuYW1lOwogICAgfQoKICAgIGRzbC5wdXNoKG9wdGlvbnMucGF0aCwgZnVsbE5hbWUsIGNhbGxiYWNrLCBvcHRpb25zLnNlcmlhbGl6ZSk7CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9yb3V0aW5nL2xpYi9zeXN0ZW0vZW5naW5lcyIsIFtdLCBmdW5jdGlvbiAoKSB7CiAgInVzZSBzdHJpY3QiOwp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9yb3V0aW5nL2xpYi9zeXN0ZW0vZ2VuZXJhdGVfY29udHJvbGxlciIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCIsICJAZW1iZXIvZGVidWciXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfbWV0YWwsIF9kZWJ1ZykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZ2VuZXJhdGVDb250cm9sbGVyRmFjdG9yeSA9IGdlbmVyYXRlQ29udHJvbGxlckZhY3Rvcnk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IGdlbmVyYXRlQ29udHJvbGxlcjsKCiAgLyoqCiAgQG1vZHVsZSBlbWJlcgogICovCgogIC8qKgogICAgR2VuZXJhdGVzIGEgY29udHJvbGxlciBmYWN0b3J5CiAgCiAgICBAZm9yIEVtYmVyCiAgICBAbWV0aG9kIGdlbmVyYXRlQ29udHJvbGxlckZhY3RvcnkKICAgIEBwcml2YXRlCiAgKi8KICBmdW5jdGlvbiBnZW5lcmF0ZUNvbnRyb2xsZXJGYWN0b3J5KG93bmVyLCBjb250cm9sbGVyTmFtZSkgewogICAgdmFyIEZhY3RvcnkgPSBvd25lci5mYWN0b3J5Rm9yKCdjb250cm9sbGVyOmJhc2ljJykuY2xhc3M7CiAgICBGYWN0b3J5ID0gRmFjdG9yeS5leHRlbmQoewogICAgICB0b1N0cmluZzogZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgICAgcmV0dXJuICIoZ2VuZXJhdGVkICIgKyBjb250cm9sbGVyTmFtZSArICIgY29udHJvbGxlcikiOwogICAgICB9CiAgICB9KTsKICAgIHZhciBmdWxsTmFtZSA9ICJjb250cm9sbGVyOiIgKyBjb250cm9sbGVyTmFtZTsKICAgIG93bmVyLnJlZ2lzdGVyKGZ1bGxOYW1lLCBGYWN0b3J5KTsKICAgIHJldHVybiBvd25lci5mYWN0b3J5Rm9yKGZ1bGxOYW1lKTsKICB9CiAgLyoqCiAgICBHZW5lcmF0ZXMgYW5kIGluc3RhbnRpYXRlcyBhIGNvbnRyb2xsZXIgZXh0ZW5kaW5nIGZyb20gYGNvbnRyb2xsZXI6YmFzaWNgCiAgICBpZiBwcmVzZW50LCBvciBgQ29udHJvbGxlcmAgaWYgbm90LgogIAogICAgQGZvciBFbWJlcgogICAgQG1ldGhvZCBnZW5lcmF0ZUNvbnRyb2xsZXIKICAgIEBwcml2YXRlCiAgICBAc2luY2UgMS4zLjAKICAqLwoKCiAgZnVuY3Rpb24gZ2VuZXJhdGVDb250cm9sbGVyKG93bmVyLCBjb250cm9sbGVyTmFtZSkgewogICAgZ2VuZXJhdGVDb250cm9sbGVyRmFjdG9yeShvd25lciwgY29udHJvbGxlck5hbWUpOwogICAgdmFyIGZ1bGxOYW1lID0gImNvbnRyb2xsZXI6IiArIGNvbnRyb2xsZXJOYW1lOwogICAgdmFyIGluc3RhbmNlID0gb3duZXIubG9va3VwKGZ1bGxOYW1lKTsKCiAgICBpZiAoZmFsc2UKICAgIC8qIERFQlVHICovCiAgICApIHsKICAgICAgaWYgKCgwLCBfbWV0YWwuZ2V0KShpbnN0YW5jZSwgJ25hbWVzcGFjZS5MT0dfQUNUSVZFX0dFTkVSQVRJT04nKSkgewogICAgICAgICgwLCBfZGVidWcuaW5mbykoImdlbmVyYXRlZCAtPiAiICsgZnVsbE5hbWUsIHsKICAgICAgICAgIGZ1bGxOYW1lOiBmdWxsTmFtZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGluc3RhbmNlOwogIH0KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvc3lzdGVtL3F1ZXJ5X3BhcmFtcyIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIHZhciBRdWVyeVBhcmFtcyA9IGZ1bmN0aW9uIFF1ZXJ5UGFyYW1zKHZhbHVlcykgewogICAgaWYgKHZhbHVlcyA9PT0gdm9pZCAwKSB7CiAgICAgIHZhbHVlcyA9IG51bGw7CiAgICB9CgogICAgdGhpcy5pc1F1ZXJ5UGFyYW1zID0gdHJ1ZTsKICAgIHRoaXMudmFsdWVzID0gdmFsdWVzOwogIH07CgogIF9leHBvcnRzLmRlZmF1bHQgPSBRdWVyeVBhcmFtczsKfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvc3lzdGVtL3JvdXRlLWluZm8iLCBbXSwgZnVuY3Rpb24gKCkgewogICJ1c2Ugc3RyaWN0IjsKICAvKioKICAgIEEgYFJvdXRlSW5mb1dpdGhBdHRyaWJ1dGVzYCBpcyBhbiBvYmplY3QgdGhhdCBjb250YWlucwogICAgbWV0YWRhdGEsIGluY2x1ZGluZyB0aGUgcmVzb2x2ZWQgdmFsdWUgZnJvbSB0aGUgcm91dGVzCiAgICBgbW9kZWxgIGhvb2suIExpa2UgYFJvdXRlSW5mb2AsIGEgYFJvdXRlSW5mb1dpdGhBdHRyaWJ1dGVzYAogICAgcmVwcmVzZW50cyBhIHNwZWNpZmljIHJvdXRlIHdpdGhpbiBhIFRyYW5zaXRpb24uCiAgICBJdCBpcyByZWFkLW9ubHkgYW5kIGludGVybmFsbHkgaW1tdXRhYmxlLiBJdCBpcyBhbHNvIG5vdAogICAgb2JzZXJ2YWJsZSwgYmVjYXVzZSBhIFRyYW5zaXRpb24gaW5zdGFuY2UgaXMgbmV2ZXIKICAgIGNoYW5nZWQgYWZ0ZXIgY3JlYXRpb24uCiAgCiAgICBAY2xhc3MgUm91dGVJbmZvV2l0aEF0dHJpYnV0ZXMKICAgIEBwdWJsaWMKICAqLwoKICAvKioKICAgIFRoZSBkb3Qtc2VwYXJhdGVkLCBmdWxseS1xdWFsaWZpZWQgbmFtZSBvZiB0aGUKICAgIHJvdXRlLCBsaWtlICJwZW9wbGUuaW5kZXgiLgogICAgQHByb3BlcnR5IHtTdHJpbmd9IG5hbWUKICAgIEBwdWJsaWMKICAqLwoKICAvKioKICAgIFRoZSBmaW5hbCBzZWdtZW50IG9mIHRoZSBmdWxseS1xdWFsaWZpZWQgbmFtZSBvZgogICAgdGhlIHJvdXRlLCBsaWtlICJpbmRleCIKICAgIEBwcm9wZXJ0eSB7U3RyaW5nfSBsb2NhbE5hbWUKICAgIEBwdWJsaWMKICAqLwoKICAvKioKICAgIFRoZSB2YWx1ZXMgb2YgdGhlIHJvdXRlJ3MgcGFyYW1ldGVycy4gVGhlc2UgYXJlIHRoZQogICAgc2FtZSBwYXJhbXMgdGhhdCBhcmUgcmVjZWl2ZWQgYXMgYXJndW1lbnRzIHRvIHRoZQogICAgcm91dGUncyBtb2RlbCBob29rLiBDb250YWlucyBvbmx5IHRoZSBwYXJhbWV0ZXJzCiAgICB2YWxpZCBmb3IgdGhpcyByb3V0ZSwgaWYgYW55IChwYXJhbXMgZm9yIHBhcmVudCBvcgogICAgY2hpbGQgcm91dGVzIGFyZSBub3QgbWVyZ2VkKS4KICAgIEBwcm9wZXJ0eSB7T2JqZWN0fSBwYXJhbXMKICAgIEBwdWJsaWMKICAqLwoKICAvKioKICAgIFRoZSBvcmRlcmVkIGxpc3Qgb2YgdGhlIG5hbWVzIG9mIHRoZSBwYXJhbXMKICAgIHJlcXVpcmVkIGZvciB0aGlzIHJvdXRlLiBJdCB3aWxsIGNvbnRhaW4gdGhlIHNhbWUKICAgIHN0cmluZ3MgYXMgYE9iamVjdC5rZXlzKHBhcmFtcylgLCBidXQgaGVyZSB0aGUgb3JkZXIKICAgIGlzIHNpZ25pZmljYW50LiBUaGlzIGFsbG93cyB1c2VycyB0byBjb3JyZWN0bHkgcGFzcwogICAgcGFyYW1zIGludG8gcm91dGVzIHByb2dyYW1tYXRpY2FsbHkuCiAgICBAcHJvcGVydHkge0FycmF5fSBwYXJhbU5hbWVzCiAgICBAcHVibGljCiAgKi8KCiAgLyoqCiAgICBUaGUgdmFsdWVzIG9mIGFueSBxdWVyeVBhcmFtcyBvbiB0aGlzIHJvdXRlLgogICAgQHByb3BlcnR5IHtPYmplY3R9IHF1ZXJ5UGFyYW1zCiAgICBAcHVibGljCiAgKi8KCiAgLyoqCiAgICBUaGlzIGlzIHRoZSByZXNvbHZlZCByZXR1cm4gdmFsdWUgZnJvbSB0aGUKICAgIHJvdXRlJ3MgbW9kZWwgaG9vay4KICAgIEBwcm9wZXJ0eSB7T2JqZWN0fEFycmF5fFN0cmluZ30gYXR0cmlidXRlcwogICAgQHB1YmxpYwogICovCgogIC8qKgogICAgV2lsbCBjb250YWluIHRoZSByZXN1bHQgYFJvdXRlI2J1aWxkUm91dGVJbmZvTWV0YWRhdGFgCiAgICBmb3IgdGhlIGNvcnJlc3BvbmRpbmcgUm91dGUuCiAgICBAcHJvcGVydHkge0FueX0gbWV0YWRhdGEKICAgIEBwdWJsaWMKICAqLwoKICAvKioKICAgIEEgcmVmZXJlbmNlIHRvIHRoZSBwYXJlbnQgcm91dGUncyBSb3V0ZUluZm8uCiAgICBUaGlzIGNhbiBiZSB1c2VkIHRvIHRyYXZlcnNlIHVwd2FyZCB0byB0aGUgdG9wbW9zdAogICAgYFJvdXRlSW5mb2AuCiAgICBAcHJvcGVydHkge1JvdXRlSW5mb3xudWxsfSBwYXJlbnQKICAgIEBwdWJsaWMKICAqLwoKICAvKioKICAgIEEgcmVmZXJlbmNlIHRvIHRoZSBjaGlsZCByb3V0ZSdzIFJvdXRlSW5mby4KICAgIFRoaXMgY2FuIGJlIHVzZWQgdG8gdHJhdmVyc2UgZG93bndhcmQgdG8gdGhlCiAgICBsZWFmbW9zdCBgUm91dGVJbmZvYC4KICAgIEBwcm9wZXJ0eSB7Um91dGVJbmZvfG51bGx9IGNoaWxkCiAgICBAcHVibGljCiAgKi8KCiAgLyoqCiAgICBBbGxvd3MgeW91IHRvIHRyYXZlcnNlIHRocm91Z2ggdGhlIGxpbmtlZCBsaXN0CiAgICBvZiBgUm91dGVJbmZvYHMgZnJvbSB0aGUgdG9wbW9zdCB0byBsZWFmbW9zdC4KICAgIFJldHVybnMgdGhlIGZpcnN0IGBSb3V0ZUluZm9gIGluIHRoZSBsaW5rZWQgbGlzdAogICAgZm9yIHdoaWNoIHRoZSBjYWxsYmFjayByZXR1cm5zIHRydWUuCiAgCiAgICAgIFRoaXMgbWV0aG9kIGlzIHNpbWlsYXIgdG8gdGhlIGBmaW5kKClgIG1ldGhvZAogICAgICBkZWZpbmVkIGluIEVDTUFTY3JpcHQgMjAxNS4KICAKICAgICAgVGhlIGNhbGxiYWNrIG1ldGhvZCB5b3UgcHJvdmlkZSBzaG91bGQgaGF2ZSB0aGUKICAgICAgZm9sbG93aW5nIHNpZ25hdHVyZSAoYWxsIHBhcmFtZXRlcnMgYXJlIG9wdGlvbmFsKToKICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBmdW5jdGlvbihpdGVtLCBpbmRleCwgYXJyYXkpOwogICAgICBgYGAKICAKICAgICAgLSBgaXRlbWAgaXMgdGhlIGN1cnJlbnQgaXRlbSBpbiB0aGUgaXRlcmF0aW9uLgogICAgICAtIGBpbmRleGAgaXMgdGhlIGN1cnJlbnQgaW5kZXggaW4gdGhlIGl0ZXJhdGlvbi4KICAgICAgLSBgYXJyYXlgIGlzIHRoZSBhcnJheSBpdHNlbGYuCiAgCiAgICAgIEl0IHNob3VsZCByZXR1cm4gdGhlIGB0cnVlYCB0byBpbmNsdWRlIHRoZSBpdGVtIGluCiAgICAgIHRoZSByZXN1bHRzLCBgZmFsc2VgIG90aGVyd2lzZS4KICAKICAgICAgTm90ZSB0aGF0IGluIGFkZGl0aW9uIHRvIGEgY2FsbGJhY2ssIHlvdSBjYW4gYWxzbwogICAgICBwYXNzIGFuIG9wdGlvbmFsIHRhcmdldCBvYmplY3QgdGhhdCB3aWxsIGJlIHNldCBhcwogICAgICBgdGhpc2Agb24gdGhlIGNvbnRleHQuCiAgCiAgICBAbWV0aG9kIGZpbmQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIHRoZSBjYWxsYmFjayB0byBleGVjdXRlCiAgICBAcGFyYW0ge09iamVjdH0gW3RhcmdldCpdIG9wdGlvbmFsIHRhcmdldCB0byB1c2UKICAgIEByZXR1cm5zIHtPYmplY3R9IEZvdW5kIGl0ZW0gb3IgdW5kZWZpbmVkCiAgICBAcHVibGljCiAgKi8KCiAgLyoqCiAgICBBIFJvdXRlSW5mbyBpcyBhbiBvYmplY3QgdGhhdCBjb250YWlucyBtZXRhZGF0YQogICAgYWJvdXQgYSBzcGVjaWZpYyByb3V0ZSB3aXRoaW4gYSBUcmFuc2l0aW9uLiBJdCBpcwogICAgcmVhZC1vbmx5IGFuZCBpbnRlcm5hbGx5IGltbXV0YWJsZS4gSXQgaXMgYWxzbyBub3QKICAgIG9ic2VydmFibGUsIGJlY2F1c2UgYSBUcmFuc2l0aW9uIGluc3RhbmNlIGlzIG5ldmVyCiAgICBjaGFuZ2VkIGFmdGVyIGNyZWF0aW9uLgogIAogICAgQGNsYXNzIFJvdXRlSW5mbwogICAgQHB1YmxpYwogICovCgogIC8qKgogICAgVGhlIGRvdC1zZXBhcmF0ZWQsIGZ1bGx5LXF1YWxpZmllZCBuYW1lIG9mIHRoZQogICAgcm91dGUsIGxpa2UgInBlb3BsZS5pbmRleCIuCiAgICBAcHJvcGVydHkge1N0cmluZ30gbmFtZQogICAgQHB1YmxpYwogICovCgogIC8qKgogICAgVGhlIGZpbmFsIHNlZ21lbnQgb2YgdGhlIGZ1bGx5LXF1YWxpZmllZCBuYW1lIG9mCiAgICB0aGUgcm91dGUsIGxpa2UgImluZGV4IgogICAgQHByb3BlcnR5IHtTdHJpbmd9IGxvY2FsTmFtZQogICAgQHB1YmxpYwogICovCgogIC8qKgogICAgVGhlIHZhbHVlcyBvZiB0aGUgcm91dGUncyBwYXJhbWV0ZXJzLiBUaGVzZSBhcmUgdGhlCiAgICBzYW1lIHBhcmFtcyB0aGF0IGFyZSByZWNlaXZlZCBhcyBhcmd1bWVudHMgdG8gdGhlCiAgICByb3V0ZSdzIGBtb2RlbGAgaG9vay4gQ29udGFpbnMgb25seSB0aGUgcGFyYW1ldGVycwogICAgdmFsaWQgZm9yIHRoaXMgcm91dGUsIGlmIGFueSAocGFyYW1zIGZvciBwYXJlbnQgb3IKICAgIGNoaWxkIHJvdXRlcyBhcmUgbm90IG1lcmdlZCkuCiAgICBAcHJvcGVydHkge09iamVjdH0gcGFyYW1zCiAgICBAcHVibGljCiAgKi8KCiAgLyoqCiAgICBUaGUgb3JkZXJlZCBsaXN0IG9mIHRoZSBuYW1lcyBvZiB0aGUgcGFyYW1zCiAgICByZXF1aXJlZCBmb3IgdGhpcyByb3V0ZS4gSXQgd2lsbCBjb250YWluIHRoZSBzYW1lCiAgICBzdHJpbmdzIGFzIE9iamVjdC5rZXlzKHBhcmFtcyksIGJ1dCBoZXJlIHRoZSBvcmRlcgogICAgaXMgc2lnbmlmaWNhbnQuIFRoaXMgYWxsb3dzIHVzZXJzIHRvIGNvcnJlY3RseSBwYXNzCiAgICBwYXJhbXMgaW50byByb3V0ZXMgcHJvZ3JhbW1hdGljYWxseS4KICAgIEBwcm9wZXJ0eSB7QXJyYXl9IHBhcmFtTmFtZXMKICAgIEBwdWJsaWMKICAqLwoKICAvKioKICAgIFRoZSB2YWx1ZXMgb2YgYW55IHF1ZXJ5UGFyYW1zIG9uIHRoaXMgcm91dGUuCiAgICBAcHJvcGVydHkge09iamVjdH0gcXVlcnlQYXJhbXMKICAgIEBwdWJsaWMKICAqLwoKICAvKioKICAgIEEgcmVmZXJlbmNlIHRvIHRoZSBwYXJlbnQgcm91dGUncyBgUm91dGVJbmZvYC4KICAgIFRoaXMgY2FuIGJlIHVzZWQgdG8gdHJhdmVyc2UgdXB3YXJkIHRvIHRoZSB0b3Btb3N0CiAgICBgUm91dGVJbmZvYC4KICAgIEBwcm9wZXJ0eSB7Um91dGVJbmZvfG51bGx9IHBhcmVudAogICAgQHB1YmxpYwogICovCgogIC8qKgogICAgQSByZWZlcmVuY2UgdG8gdGhlIGNoaWxkIHJvdXRlJ3MgYFJvdXRlSW5mb2AuCiAgICBUaGlzIGNhbiBiZSB1c2VkIHRvIHRyYXZlcnNlIGRvd253YXJkIHRvIHRoZQogICAgbGVhZm1vc3QgYFJvdXRlSW5mb2AuCiAgICBAcHJvcGVydHkge1JvdXRlSW5mb3xudWxsfSBjaGlsZAogICAgQHB1YmxpYwogICovCgogIC8qKgogICAgQWxsb3dzIHlvdSB0byB0cmF2ZXJzZSB0aHJvdWdoIHRoZSBsaW5rZWQgbGlzdAogICAgb2YgYFJvdXRlSW5mb2BzIGZyb20gdGhlIHRvcG1vc3QgdG8gbGVhZm1vc3QuCiAgICBSZXR1cm5zIHRoZSBmaXJzdCBgUm91dGVJbmZvYCBpbiB0aGUgbGlua2VkIGxpc3QKICAgIGZvciB3aGljaCB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVlLgogIAogICAgICBUaGlzIG1ldGhvZCBpcyBzaW1pbGFyIHRvIHRoZSBgZmluZCgpYCBtZXRob2QKICAgICAgZGVmaW5lZCBpbiBFQ01BU2NyaXB0IDIwMTUuCiAgCiAgICAgIFRoZSBjYWxsYmFjayBtZXRob2QgeW91IHByb3ZpZGUgc2hvdWxkIGhhdmUgdGhlCiAgICAgIGZvbGxvd2luZyBzaWduYXR1cmUgKGFsbCBwYXJhbWV0ZXJzIGFyZSBvcHRpb25hbCk6CiAgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgZnVuY3Rpb24oaXRlbSwgaW5kZXgsIGFycmF5KTsKICAgICAgYGBgCiAgCiAgICAgIC0gYGl0ZW1gIGlzIHRoZSBjdXJyZW50IGl0ZW0gaW4gdGhlIGl0ZXJhdGlvbi4KICAgICAgLSBgaW5kZXhgIGlzIHRoZSBjdXJyZW50IGluZGV4IGluIHRoZSBpdGVyYXRpb24uCiAgICAgIC0gYGFycmF5YCBpcyB0aGUgYXJyYXkgaXRzZWxmLgogIAogICAgICBJdCBzaG91bGQgcmV0dXJuIHRoZSBgdHJ1ZWAgdG8gaW5jbHVkZSB0aGUgaXRlbSBpbgogICAgICB0aGUgcmVzdWx0cywgYGZhbHNlYCBvdGhlcndpc2UuCiAgCiAgICAgIE5vdGUgdGhhdCBpbiBhZGRpdGlvbiB0byBhIGNhbGxiYWNrLCB5b3UgY2FuIGFsc28KICAgICAgcGFzcyBhbiBvcHRpb25hbCB0YXJnZXQgb2JqZWN0IHRoYXQgd2lsbCBiZSBzZXQgYXMKICAgICAgYHRoaXNgIG9uIHRoZSBjb250ZXh0LgogIAogICAgQG1ldGhvZCBmaW5kCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayB0aGUgY2FsbGJhY2sgdG8gZXhlY3V0ZQogICAgQHBhcmFtIHtPYmplY3R9IFt0YXJnZXQqXSBvcHRpb25hbCB0YXJnZXQgdG8gdXNlCiAgICBAcmV0dXJucyB7T2JqZWN0fSBGb3VuZCBpdGVtIG9yIHVuZGVmaW5lZAogICAgQHB1YmxpYwogICovCn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL3N5c3RlbS9yb3V0ZSIsIFsiZXhwb3J0cyIsICJAZW1iZXIvcG9seWZpbGxzIiwgImVtYmVyLWJhYmVsIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGFsIiwgIkBlbWJlci8taW50ZXJuYWxzL293bmVyIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUiLCAiQGVtYmVyLy1pbnRlcm5hbHMvdXRpbHMiLCAiQGVtYmVyL2RlYnVnIiwgIkBlbWJlci9kZXByZWNhdGVkLWZlYXR1cmVzIiwgIkBlbWJlci9vYmplY3QvY29tcGF0IiwgIkBlbWJlci9ydW5sb29wIiwgIkBlbWJlci9zdHJpbmciLCAicm91dGVyX2pzIiwgIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL3V0aWxzIiwgIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL3N5c3RlbS9nZW5lcmF0ZV9jb250cm9sbGVyIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX3BvbHlmaWxscywgX2VtYmVyQmFiZWwsIF9tZXRhbCwgX293bmVyLCBfcnVudGltZSwgX3V0aWxzLCBfZGVidWcsIF9kZXByZWNhdGVkRmVhdHVyZXMsIF9jb21wYXQsIF9ydW5sb29wLCBfc3RyaW5nLCBfcm91dGVyX2pzLCBfdXRpbHMyLCBfZ2VuZXJhdGVfY29udHJvbGxlcikgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdFNlcmlhbGl6ZSA9IGRlZmF1bHRTZXJpYWxpemU7CiAgX2V4cG9ydHMuaGFzRGVmYXVsdFNlcmlhbGl6ZSA9IGhhc0RlZmF1bHRTZXJpYWxpemU7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9leHBvcnRzLlJPVVRFUl9FVkVOVF9ERVBSRUNBVElPTlMgPSBfZXhwb3J0cy5ST1VURV9DT05ORUNUSU9OUyA9IHZvaWQgMDsKICB2YXIgUk9VVEVfQ09OTkVDVElPTlMgPSBuZXcgV2Vha01hcCgpOwogIF9leHBvcnRzLlJPVVRFX0NPTk5FQ1RJT05TID0gUk9VVEVfQ09OTkVDVElPTlM7CgogIGZ1bmN0aW9uIGRlZmF1bHRTZXJpYWxpemUobW9kZWwsIHBhcmFtcykgewogICAgaWYgKHBhcmFtcy5sZW5ndGggPCAxIHx8ICFtb2RlbCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIG9iamVjdCA9IHt9OwoKICAgIGlmIChwYXJhbXMubGVuZ3RoID09PSAxKSB7CiAgICAgIHZhciBuYW1lID0gcGFyYW1zWzBdOwoKICAgICAgaWYgKG5hbWUgaW4gbW9kZWwpIHsKICAgICAgICBvYmplY3RbbmFtZV0gPSAoMCwgX21ldGFsLmdldCkobW9kZWwsIG5hbWUpOwogICAgICB9IGVsc2UgaWYgKC9faWQkLy50ZXN0KG5hbWUpKSB7CiAgICAgICAgb2JqZWN0W25hbWVdID0gKDAsIF9tZXRhbC5nZXQpKG1vZGVsLCAnaWQnKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0ID0gKDAsIF9tZXRhbC5nZXRQcm9wZXJ0aWVzKShtb2RlbCwgcGFyYW1zKTsKICAgIH0KCiAgICByZXR1cm4gb2JqZWN0OwogIH0KCiAgZnVuY3Rpb24gaGFzRGVmYXVsdFNlcmlhbGl6ZShyb3V0ZSkgewogICAgcmV0dXJuIHJvdXRlLnNlcmlhbGl6ZSA9PT0gZGVmYXVsdFNlcmlhbGl6ZTsKICB9CiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvcm91dGluZwogICovCgogIC8qKgogICAgVGhlIGBSb3V0ZWAgY2xhc3MgaXMgdXNlZCB0byBkZWZpbmUgaW5kaXZpZHVhbCByb3V0ZXMuIFJlZmVyIHRvCiAgICB0aGUgW3JvdXRpbmcgZ3VpZGVdKGh0dHBzOi8vZ3VpZGVzLmVtYmVyanMuY29tL3JlbGVhc2Uvcm91dGluZy8pIGZvciBkb2N1bWVudGF0aW9uLgogIAogICAgQGNsYXNzIFJvdXRlCiAgICBAZXh0ZW5kcyBFbWJlck9iamVjdAogICAgQHVzZXMgQWN0aW9uSGFuZGxlcgogICAgQHVzZXMgRXZlbnRlZAogICAgQHNpbmNlIDEuMC4wCiAgICBAcHVibGljCiAgKi8KCgogIHZhciBSb3V0ZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfRW1iZXJPYmplY3QpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShSb3V0ZSwgX0VtYmVyT2JqZWN0KTsKCiAgICBmdW5jdGlvbiBSb3V0ZSgpIHsKICAgICAgdmFyIF90aGlzOwoKICAgICAgX3RoaXMgPSBfRW1iZXJPYmplY3QuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgICBfdGhpcy5jb250ZXh0ID0ge307CiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KICAgIC8qKgogICAgICBUaGUgbmFtZSBvZiB0aGUgcm91dGUsIGRvdC1kZWxpbWl0ZWQuCiAgICAgICAgIEZvciBleGFtcGxlLCBhIHJvdXRlIGZvdW5kIGF0IGBhcHAvcm91dGVzL3Bvc3RzL3Bvc3QuanNgIHdpbGwgaGF2ZQogICAgICBhIGByb3V0ZU5hbWVgIG9mIGBwb3N0cy5wb3N0YC4KICAgICAgICAgQHByb3BlcnR5IHJvdXRlTmFtZQogICAgICBAZm9yIFJvdXRlCiAgICAgIEB0eXBlIFN0cmluZwogICAgICBAc2luY2UgMS4wLjAKICAgICAgQHB1YmxpYwogICAgKi8KCiAgICAvKioKICAgICAgVGhlIG5hbWUgb2YgdGhlIHJvdXRlLCBkb3QtZGVsaW1pdGVkLCBpbmNsdWRpbmcgdGhlIGVuZ2luZSBwcmVmaXgKICAgICAgaWYgYXBwbGljYWJsZS4KICAgICAgICAgRm9yIGV4YW1wbGUsIGEgcm91dGUgZm91bmQgYXQgYGFkZG9uL3JvdXRlcy9wb3N0cy9wb3N0LmpzYCB3aXRoaW4gYW4KICAgICAgZW5naW5lIG5hbWVkIGBhZG1pbmAgd2lsbCBoYXZlIGEgYGZ1bGxSb3V0ZU5hbWVgIG9mIGBhZG1pbi5wb3N0cy5wb3N0YC4KICAgICAgICAgQHByb3BlcnR5IGZ1bGxSb3V0ZU5hbWUKICAgICAgQGZvciBSb3V0ZQogICAgICBAdHlwZSBTdHJpbmcKICAgICAgQHNpbmNlIDIuMTAuMAogICAgICBAcHVibGljCiAgICAqLwoKICAgIC8qKgogICAgICBTZXRzIHRoZSBuYW1lIGZvciB0aGlzIHJvdXRlLCBpbmNsdWRpbmcgYSBmdWxseSByZXNvbHZlZCBuYW1lIGZvciByb3V0ZXMKICAgICAgaW5zaWRlIGVuZ2luZXMuCiAgICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgX3NldFJvdXRlTmFtZQogICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZQogICAgKi8KCgogICAgdmFyIF9wcm90byA9IFJvdXRlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8uX3NldFJvdXRlTmFtZSA9IGZ1bmN0aW9uIF9zZXRSb3V0ZU5hbWUobmFtZSkgewogICAgICB0aGlzLnJvdXRlTmFtZSA9IG5hbWU7CiAgICAgIHRoaXMuZnVsbFJvdXRlTmFtZSA9IGdldEVuZ2luZVJvdXRlTmFtZSgoMCwgX293bmVyLmdldE93bmVyKSh0aGlzKSwgbmFtZSk7CiAgICB9CiAgICAvKioKICAgICAgQHByaXZhdGUKICAgICAgICAgQG1ldGhvZCBfc3Rhc2hOYW1lcwogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uX3N0YXNoTmFtZXMgPSBmdW5jdGlvbiBfc3Rhc2hOYW1lcyhyb3V0ZUluZm8sIGR5bmFtaWNQYXJlbnQpIHsKICAgICAgaWYgKHRoaXMuX25hbWVzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgbmFtZXMgPSB0aGlzLl9uYW1lcyA9IHJvdXRlSW5mb1snX25hbWVzJ107CgogICAgICBpZiAoIW5hbWVzLmxlbmd0aCkgewogICAgICAgIHJvdXRlSW5mbyA9IGR5bmFtaWNQYXJlbnQ7CiAgICAgICAgbmFtZXMgPSByb3V0ZUluZm8gJiYgcm91dGVJbmZvWydfbmFtZXMnXSB8fCBbXTsKICAgICAgfQoKICAgICAgdmFyIHFwcyA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAnX3FwLnFwcycpOwogICAgICB2YXIgbmFtZVBhdGhzID0gbmV3IEFycmF5KG5hbWVzLmxlbmd0aCk7CgogICAgICBmb3IgKHZhciBhID0gMDsgYSA8IG5hbWVzLmxlbmd0aDsgKythKSB7CiAgICAgICAgbmFtZVBhdGhzW2FdID0gcm91dGVJbmZvLm5hbWUgKyAiLiIgKyBuYW1lc1thXTsKICAgICAgfQoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxcHMubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgcXAgPSBxcHNbaV07CgogICAgICAgIGlmIChxcC5zY29wZSA9PT0gJ21vZGVsJykgewogICAgICAgICAgcXAucGFydHMgPSBuYW1lUGF0aHM7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioKICAgICAgQHByaXZhdGUKICAgICAgICAgQHByb3BlcnR5IF9hY3RpdmVRUENoYW5nZWQKICAgICovCiAgICA7CgogICAgX3Byb3RvLl9hY3RpdmVRUENoYW5nZWQgPSBmdW5jdGlvbiBfYWN0aXZlUVBDaGFuZ2VkKHFwLCB2YWx1ZSkgewogICAgICB0aGlzLl9yb3V0ZXIuX2FjdGl2ZVFQQ2hhbmdlZChxcC5zY29wZWRQcm9wZXJ0eU5hbWUsIHZhbHVlKTsKICAgIH0KICAgIC8qKgogICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIF91cGRhdGluZ1FQQ2hhbmdlZAogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uX3VwZGF0aW5nUVBDaGFuZ2VkID0gZnVuY3Rpb24gX3VwZGF0aW5nUVBDaGFuZ2VkKHFwKSB7CiAgICAgIHRoaXMuX3JvdXRlci5fdXBkYXRpbmdRUENoYW5nZWQocXAudXJsS2V5KTsKICAgIH0KICAgIC8qKgogICAgICBSZXR1cm5zIGEgaGFzaCBjb250YWluaW5nIHRoZSBwYXJhbWV0ZXJzIG9mIGFuIGFuY2VzdG9yIHJvdXRlLgogICAgICAgICBZb3UgbWF5IG5vdGljZSB0aGF0IGB0aGlzLnBhcmFtc0ZvcmAgc29tZXRpbWVzIHdvcmtzIHdoZW4gcmVmZXJyaW5nIHRvIGEKICAgICAgY2hpbGQgcm91dGUsIGJ1dCB0aGlzIGJlaGF2aW9yIHNob3VsZCBub3QgYmUgcmVsaWVkIHVwb24gYXMgb25seSBhbmNlc3RvcgogICAgICByb3V0ZXMgYXJlIGNlcnRhaW4gdG8gYmUgbG9hZGVkIGluIHRpbWUuCiAgICAgICAgIEV4YW1wbGUKICAgICAgICAgYGBgYXBwL3JvdXRlci5qcwogICAgICAvLyAuLi4KICAgICAgICAgUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJvdXRlKCdtZW1iZXInLCB7IHBhdGg6ICc6bmFtZScgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLnJvdXRlKCdpbnRlcmVzdCcsIHsgcGF0aDogJzppbnRlcmVzdCcgfSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgICAgYGBgYXBwL3JvdXRlcy9tZW1iZXIuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgTWVtYmVyUm91dGUgZXh0ZW5kcyBSb3V0ZSB7CiAgICAgICAgcXVlcnlQYXJhbXMgPSB7CiAgICAgICAgICBtZW1iZXJRcDogeyByZWZyZXNoTW9kZWw6IHRydWUgfQogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgICAgYGBgYXBwL3JvdXRlcy9tZW1iZXIvaW50ZXJlc3QuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgTWVtYmVySW50ZXJlc3RSb3V0ZSBSb3V0ZSB7CiAgICAgICAgcXVlcnlQYXJhbXMgPSB7CiAgICAgICAgICBpbnRlcmVzdFFwOiB7IHJlZnJlc2hNb2RlbDogdHJ1ZSB9CiAgICAgICAgfQogICAgICAgICAgIG1vZGVsKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMucGFyYW1zRm9yKCdtZW1iZXInKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICAgIElmIHdlIHZpc2l0IGAvdHVyaW5nL21hdGhzP21lbWJlclFwPW1lbWJlciZpbnRlcmVzdFFwPWludGVyZXN0YCB0aGUgbW9kZWwgZm9yCiAgICAgIHRoZSBgbWVtYmVyLmludGVyZXN0YCByb3V0ZSBpcyBhIGhhc2ggd2l0aDoKICAgICAgICAgKiBgbmFtZWA6IGB0dXJpbmdgCiAgICAgICogYG1lbWJlclFwYDogYG1lbWJlcmAKICAgICAgICAgQG1ldGhvZCBwYXJhbXNGb3IKICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUKICAgICAgQHJldHVybiB7T2JqZWN0fSBoYXNoIGNvbnRhaW5pbmcgdGhlIHBhcmFtZXRlcnMgb2YgdGhlIHJvdXRlIGBuYW1lYAogICAgICBAc2luY2UgMS40LjAKICAgICAgQHB1YmxpYwogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucGFyYW1zRm9yID0gZnVuY3Rpb24gcGFyYW1zRm9yKG5hbWUpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB2YXIgcm91dGUgPSAoMCwgX293bmVyLmdldE93bmVyKSh0aGlzKS5sb29rdXAoInJvdXRlOiIgKyBuYW1lKTsKCiAgICAgIGlmIChyb3V0ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIHt9OwogICAgICB9CgogICAgICB2YXIgdHJhbnNpdGlvbiA9IHRoaXMuX3JvdXRlci5fcm91dGVyTWljcm9saWIuYWN0aXZlVHJhbnNpdGlvbjsKICAgICAgdmFyIHN0YXRlID0gdHJhbnNpdGlvbiA/IHRyYW5zaXRpb25bX3JvdXRlcl9qcy5TVEFURV9TWU1CT0xdIDogdGhpcy5fcm91dGVyLl9yb3V0ZXJNaWNyb2xpYi5zdGF0ZTsKICAgICAgdmFyIGZ1bGxOYW1lID0gcm91dGUuZnVsbFJvdXRlTmFtZTsKICAgICAgdmFyIHBhcmFtcyA9ICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIHN0YXRlLnBhcmFtc1tmdWxsTmFtZV0pOwogICAgICB2YXIgcXVlcnlQYXJhbXMgPSBnZXRRdWVyeVBhcmFtc0Zvcihyb3V0ZSwgc3RhdGUpOwogICAgICByZXR1cm4gT2JqZWN0LmtleXMocXVlcnlQYXJhbXMpLnJlZHVjZShmdW5jdGlvbiAocGFyYW1zLCBrZXkpIHsKICAgICAgICAoZmFsc2UgJiYgISghcGFyYW1zW2tleV0pICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiVGhlIHJvdXRlICciICsgX3RoaXMyLnJvdXRlTmFtZSArICInIGhhcyBib3RoIGEgZHluYW1pYyBzZWdtZW50IGFuZCBxdWVyeSBwYXJhbSB3aXRoIG5hbWUgJyIgKyBrZXkgKyAiJy4gUGxlYXNlIHJlbmFtZSBvbmUgdG8gYXZvaWQgY29sbGlzaW9ucy4iLCAhcGFyYW1zW2tleV0pKTsKICAgICAgICBwYXJhbXNba2V5XSA9IHF1ZXJ5UGFyYW1zW2tleV07CiAgICAgICAgcmV0dXJuIHBhcmFtczsKICAgICAgfSwgcGFyYW1zKTsKICAgIH0KICAgIC8qKgogICAgICBTZXJpYWxpemVzIHRoZSBxdWVyeSBwYXJhbWV0ZXIga2V5CiAgICAgICAgIEBtZXRob2Qgc2VyaWFsaXplUXVlcnlQYXJhbUtleQogICAgICBAcGFyYW0ge1N0cmluZ30gY29udHJvbGxlclByb3BlcnR5TmFtZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uc2VyaWFsaXplUXVlcnlQYXJhbUtleSA9IGZ1bmN0aW9uIHNlcmlhbGl6ZVF1ZXJ5UGFyYW1LZXkoY29udHJvbGxlclByb3BlcnR5TmFtZSkgewogICAgICByZXR1cm4gY29udHJvbGxlclByb3BlcnR5TmFtZTsKICAgIH0KICAgIC8qKgogICAgICBTZXJpYWxpemVzIHZhbHVlIG9mIHRoZSBxdWVyeSBwYXJhbWV0ZXIgYmFzZWQgb24gZGVmYXVsdFZhbHVlVHlwZQogICAgICAgICBAbWV0aG9kIHNlcmlhbGl6ZVF1ZXJ5UGFyYW0KICAgICAgQHBhcmFtIHtPYmplY3R9IHZhbHVlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmxLZXkKICAgICAgQHBhcmFtIHtTdHJpbmd9IGRlZmF1bHRWYWx1ZVR5cGUKICAgICAgQHByaXZhdGUKICAgICovCiAgICA7CgogICAgX3Byb3RvLnNlcmlhbGl6ZVF1ZXJ5UGFyYW0gPSBmdW5jdGlvbiBzZXJpYWxpemVRdWVyeVBhcmFtKHZhbHVlLCBfdXJsS2V5LCBkZWZhdWx0VmFsdWVUeXBlKSB7CiAgICAgIC8vIHVybEtleSBpc24ndCB1c2VkIGhlcmUsIGJ1dCBhbnlvbmUgb3ZlcnJpZGluZwogICAgICAvLyBjYW4gdXNlIGl0IHRvIHByb3ZpZGUgc2VyaWFsaXphdGlvbiBzcGVjaWZpYwogICAgICAvLyB0byBhIGNlcnRhaW4gcXVlcnkgcGFyYW0uCiAgICAgIHJldHVybiB0aGlzLl9yb3V0ZXIuX3NlcmlhbGl6ZVF1ZXJ5UGFyYW0odmFsdWUsIGRlZmF1bHRWYWx1ZVR5cGUpOwogICAgfQogICAgLyoqCiAgICAgIERlc2VyaWFsaXplcyB2YWx1ZSBvZiB0aGUgcXVlcnkgcGFyYW1ldGVyIGJhc2VkIG9uIGRlZmF1bHRWYWx1ZVR5cGUKICAgICAgICAgQG1ldGhvZCBkZXNlcmlhbGl6ZVF1ZXJ5UGFyYW0KICAgICAgQHBhcmFtIHtPYmplY3R9IHZhbHVlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmxLZXkKICAgICAgQHBhcmFtIHtTdHJpbmd9IGRlZmF1bHRWYWx1ZVR5cGUKICAgICAgQHByaXZhdGUKICAgICovCiAgICA7CgogICAgX3Byb3RvLmRlc2VyaWFsaXplUXVlcnlQYXJhbSA9IGZ1bmN0aW9uIGRlc2VyaWFsaXplUXVlcnlQYXJhbSh2YWx1ZSwgX3VybEtleSwgZGVmYXVsdFZhbHVlVHlwZSkgewogICAgICAvLyB1cmxLZXkgaXNuJ3QgdXNlZCBoZXJlLCBidXQgYW55b25lIG92ZXJyaWRpbmcKICAgICAgLy8gY2FuIHVzZSBpdCB0byBwcm92aWRlIGRlc2VyaWFsaXphdGlvbiBzcGVjaWZpYwogICAgICAvLyB0byBhIGNlcnRhaW4gcXVlcnkgcGFyYW0uCiAgICAgIHJldHVybiB0aGlzLl9yb3V0ZXIuX2Rlc2VyaWFsaXplUXVlcnlQYXJhbSh2YWx1ZSwgZGVmYXVsdFZhbHVlVHlwZSk7CiAgICB9CiAgICAvKioKICAgICAgQHByaXZhdGUKICAgICAgICAgQHByb3BlcnR5IF9vcHRpb25zRm9yUXVlcnlQYXJhbQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uX29wdGlvbnNGb3JRdWVyeVBhcmFtID0gZnVuY3Rpb24gX29wdGlvbnNGb3JRdWVyeVBhcmFtKHFwKSB7CiAgICAgIHJldHVybiAoMCwgX21ldGFsLmdldCkodGhpcywgInF1ZXJ5UGFyYW1zLiIgKyBxcC51cmxLZXkpIHx8ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAicXVlcnlQYXJhbXMuIiArIHFwLnByb3ApIHx8IHt9OwogICAgfQogICAgLyoqCiAgICAgIEEgaG9vayB5b3UgY2FuIHVzZSB0byByZXNldCBjb250cm9sbGVyIHZhbHVlcyBlaXRoZXIgd2hlbiB0aGUgbW9kZWwKICAgICAgY2hhbmdlcyBvciB0aGUgcm91dGUgaXMgZXhpdGluZy4KICAgICAgICAgYGBgYXBwL3JvdXRlcy9hcnRpY2xlcy5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBBcnRpY2xlc1JvdXRlIGV4dGVuZHMgUm91dGUgewogICAgICAgIHJlc2V0Q29udHJvbGxlcihjb250cm9sbGVyLCBpc0V4aXRpbmcsIHRyYW5zaXRpb24pIHsKICAgICAgICAgIGlmIChpc0V4aXRpbmcgJiYgdHJhbnNpdGlvbi50YXJnZXROYW1lICE9PSAnZXJyb3InKSB7CiAgICAgICAgICAgIGNvbnRyb2xsZXIuc2V0KCdwYWdlJywgMSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgICBAbWV0aG9kIHJlc2V0Q29udHJvbGxlcgogICAgICBAcGFyYW0ge0NvbnRyb2xsZXJ9IGNvbnRyb2xsZXIgaW5zdGFuY2UKICAgICAgQHBhcmFtIHtCb29sZWFufSBpc0V4aXRpbmcKICAgICAgQHBhcmFtIHtPYmplY3R9IHRyYW5zaXRpb24KICAgICAgQHNpbmNlIDEuNy4wCiAgICAgIEBwdWJsaWMKICAgICovCiAgICA7CgogICAgX3Byb3RvLnJlc2V0Q29udHJvbGxlciA9IGZ1bmN0aW9uIHJlc2V0Q29udHJvbGxlcihfY29udHJvbGxlciwgX2lzRXhpdGluZywgX3RyYW5zaXRpb24pIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAgQHByaXZhdGUKICAgICAgICAgQG1ldGhvZCBleGl0CiAgICAqLwogICAgOwoKICAgIF9wcm90by5leGl0ID0gZnVuY3Rpb24gZXhpdCgpIHsKICAgICAgdGhpcy5kZWFjdGl2YXRlKCk7CiAgICAgIHRoaXMudHJpZ2dlcignZGVhY3RpdmF0ZScpOwogICAgICB0aGlzLnRlYXJkb3duVmlld3MoKTsKICAgIH0KICAgIC8qKgogICAgICBAcHJpdmF0ZQogICAgICAgICBAbWV0aG9kIF9pbnRlcm5hbFJlc2V0CiAgICAgIEBzaW5jZSAzLjYuMAogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uX2ludGVybmFsUmVzZXQgPSBmdW5jdGlvbiBfaW50ZXJuYWxSZXNldChpc0V4aXRpbmcsIHRyYW5zaXRpb24pIHsKICAgICAgdmFyIGNvbnRyb2xsZXIgPSB0aGlzLmNvbnRyb2xsZXI7CiAgICAgIGNvbnRyb2xsZXIuX3FwRGVsZWdhdGUgPSAoMCwgX21ldGFsLmdldCkodGhpcywgJ19xcC5zdGF0ZXMuaW5hY3RpdmUnKTsKICAgICAgdGhpcy5yZXNldENvbnRyb2xsZXIoY29udHJvbGxlciwgaXNFeGl0aW5nLCB0cmFuc2l0aW9uKTsKICAgIH0KICAgIC8qKgogICAgICBAcHJpdmF0ZQogICAgICAgICBAbWV0aG9kIGVudGVyCiAgICAqLwogICAgOwoKICAgIF9wcm90by5lbnRlciA9IGZ1bmN0aW9uIGVudGVyKCkgewogICAgICBST1VURV9DT05ORUNUSU9OUy5zZXQodGhpcywgW10pOwogICAgICB0aGlzLmFjdGl2YXRlKCk7CiAgICAgIHRoaXMudHJpZ2dlcignYWN0aXZhdGUnKTsKICAgIH0KICAgIC8qKgogICAgICBUaGUgYHdpbGxUcmFuc2l0aW9uYCBhY3Rpb24gaXMgZmlyZWQgYXQgdGhlIGJlZ2lubmluZyBvZiBhbnkKICAgICAgYXR0ZW1wdGVkIHRyYW5zaXRpb24gd2l0aCBhIGBUcmFuc2l0aW9uYCBvYmplY3QgYXMgdGhlIHNvbGUKICAgICAgYXJndW1lbnQuIFRoaXMgYWN0aW9uIGNhbiBiZSB1c2VkIGZvciBhYm9ydGluZywgcmVkaXJlY3RpbmcsCiAgICAgIG9yIGRlY29yYXRpbmcgdGhlIHRyYW5zaXRpb24gZnJvbSB0aGUgY3VycmVudGx5IGFjdGl2ZSByb3V0ZXMuCiAgICAgICAgIEEgZ29vZCBleGFtcGxlIGlzIHByZXZlbnRpbmcgbmF2aWdhdGlvbiB3aGVuIGEgZm9ybSBpcwogICAgICBoYWxmLWZpbGxlZCBvdXQ6CiAgICAgICAgIGBgYGFwcC9yb3V0ZXMvY29udGFjdC1mb3JtLmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgIGltcG9ydCB7IGFjdGlvbiB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBDb250YWN0Rm9ybVJvdXRlIGV4dGVuZHMgUm91dGUgewogICAgICAgIEBhY3Rpb24KICAgICAgICB3aWxsVHJhbnNpdGlvbih0cmFuc2l0aW9uKSB7CiAgICAgICAgICBpZiAodGhpcy5jb250cm9sbGVyLmdldCgndXNlckhhc0VudGVyZWREYXRhJykpIHsKICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmRpc3BsYXlOYXZpZ2F0aW9uQ29uZmlybSgpOwogICAgICAgICAgICB0cmFuc2l0aW9uLmFib3J0KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgICBZb3UgY2FuIGFsc28gcmVkaXJlY3QgZWxzZXdoZXJlIGJ5IGNhbGxpbmcKICAgICAgYHRoaXMudHJhbnNpdGlvblRvKCdlbHNld2hlcmUnKWAgZnJvbSB3aXRoaW4gYHdpbGxUcmFuc2l0aW9uYC4KICAgICAgTm90ZSB0aGF0IGB3aWxsVHJhbnNpdGlvbmAgd2lsbCBub3QgYmUgZmlyZWQgZm9yIHRoZQogICAgICByZWRpcmVjdGluZyBgdHJhbnNpdGlvblRvYCwgc2luY2UgYHdpbGxUcmFuc2l0aW9uYCBkb2Vzbid0CiAgICAgIGZpcmUgd2hlbiB0aGVyZSBpcyBhbHJlYWR5IGEgdHJhbnNpdGlvbiB1bmRlcndheS4gSWYgeW91IHdhbnQKICAgICAgc3Vic2VxdWVudCBgd2lsbFRyYW5zaXRpb25gIGFjdGlvbnMgdG8gZmlyZSBmb3IgdGhlIHJlZGlyZWN0aW5nCiAgICAgIHRyYW5zaXRpb24sIHlvdSBtdXN0IGZpcnN0IGV4cGxpY2l0bHkgY2FsbAogICAgICBgdHJhbnNpdGlvbi5hYm9ydCgpYC4KICAgICAgICAgVG8gYWxsb3cgdGhlIGB3aWxsVHJhbnNpdGlvbmAgZXZlbnQgdG8gY29udGludWUgYnViYmxpbmcgdG8gdGhlIHBhcmVudAogICAgICByb3V0ZSwgdXNlIGByZXR1cm4gdHJ1ZTtgLiBXaGVuIHRoZSBgd2lsbFRyYW5zaXRpb25gIG1ldGhvZCBoYXMgYQogICAgICByZXR1cm4gdmFsdWUgb2YgYHRydWVgIHRoZW4gdGhlIHBhcmVudCByb3V0ZSdzIGB3aWxsVHJhbnNpdGlvbmAgbWV0aG9kCiAgICAgIHdpbGwgYmUgZmlyZWQsIGVuYWJsaW5nICJidWJibGluZyIgYmVoYXZpb3IgZm9yIHRoZSBldmVudC4KICAgICAgICAgQGV2ZW50IHdpbGxUcmFuc2l0aW9uCiAgICAgIEBwYXJhbSB7VHJhbnNpdGlvbn0gdHJhbnNpdGlvbgogICAgICBAc2luY2UgMS4wLjAKICAgICAgQHB1YmxpYwogICAgKi8KCiAgICAvKioKICAgICAgVGhlIGBkaWRUcmFuc2l0aW9uYCBhY3Rpb24gaXMgZmlyZWQgYWZ0ZXIgYSB0cmFuc2l0aW9uIGhhcwogICAgICBzdWNjZXNzZnVsbHkgYmVlbiBjb21wbGV0ZWQuIFRoaXMgb2NjdXJzIGFmdGVyIHRoZSBub3JtYWwgbW9kZWwKICAgICAgaG9va3MgKGBiZWZvcmVNb2RlbGAsIGBtb2RlbGAsIGBhZnRlck1vZGVsYCwgYHNldHVwQ29udHJvbGxlcmApCiAgICAgIGhhdmUgcmVzb2x2ZWQuIFRoZSBgZGlkVHJhbnNpdGlvbmAgYWN0aW9uIGhhcyBubyBhcmd1bWVudHMsCiAgICAgIGhvd2V2ZXIsIGl0IGNhbiBiZSB1c2VmdWwgZm9yIHRyYWNraW5nIHBhZ2Ugdmlld3Mgb3IgcmVzZXR0aW5nCiAgICAgIHN0YXRlIG9uIHRoZSBjb250cm9sbGVyLgogICAgICAgICBgYGBhcHAvcm91dGVzL2xvZ2luLmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgIGltcG9ydCB7IGFjdGlvbiB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBMb2dpblJvdXRlIGV4dGVuZHMgUm91dGUgewogICAgICAgIEBhY3Rpb24KICAgICAgICBkaWRUcmFuc2l0aW9uKCkgewogICAgICAgICAgdGhpcy5jb250cm9sbGVyLmdldCgnZXJyb3JzLmJhc2UnKS5jbGVhcigpOwogICAgICAgICAgcmV0dXJuIHRydWU7IC8vIEJ1YmJsZSB0aGUgZGlkVHJhbnNpdGlvbiBldmVudAogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgICAgQGV2ZW50IGRpZFRyYW5zaXRpb24KICAgICAgQHNpbmNlIDEuMi4wCiAgICAgIEBwdWJsaWMKICAgICovCgogICAgLyoqCiAgICAgIFRoZSBgbG9hZGluZ2AgYWN0aW9uIGlzIGZpcmVkIG9uIHRoZSByb3V0ZSB3aGVuIGEgcm91dGUncyBgbW9kZWxgCiAgICAgIGhvb2sgcmV0dXJucyBhIHByb21pc2UgdGhhdCBpcyBub3QgYWxyZWFkeSByZXNvbHZlZC4gVGhlIGN1cnJlbnQKICAgICAgYFRyYW5zaXRpb25gIG9iamVjdCBpcyB0aGUgZmlyc3QgcGFyYW1ldGVyIGFuZCB0aGUgcm91dGUgdGhhdAogICAgICB0cmlnZ2VyZWQgdGhlIGxvYWRpbmcgZXZlbnQgaXMgdGhlIHNlY29uZCBwYXJhbWV0ZXIuCiAgICAgICAgIGBgYGFwcC9yb3V0ZXMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgaW1wb3J0IHsgYWN0aW9uIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIEFwcGxpY2F0aW9uUm91dGUgZXh0ZW5kcyBSb3V0ZSB7CiAgICAgICAgQGFjdGlvbgogICAgICAgIGxvYWRpbmcodHJhbnNpdGlvbiwgcm91dGUpIHsKICAgICAgICAgIGxldCBjb250cm9sbGVyID0gdGhpcy5jb250cm9sbGVyRm9yKCdmb28nKTsKICAgICAgICAgIGNvbnRyb2xsZXIuc2V0KCdjdXJyZW50bHlMb2FkaW5nJywgdHJ1ZSk7CiAgICAgICAgICAgICB0cmFuc2l0aW9uLmZpbmFsbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnRyb2xsZXIuc2V0KCdjdXJyZW50bHlMb2FkaW5nJywgZmFsc2UpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgICBAZXZlbnQgbG9hZGluZwogICAgICBAcGFyYW0ge1RyYW5zaXRpb259IHRyYW5zaXRpb24KICAgICAgQHBhcmFtIHtSb3V0ZX0gcm91dGUgVGhlIHJvdXRlIHRoYXQgdHJpZ2dlcmVkIHRoZSBsb2FkaW5nIGV2ZW50CiAgICAgIEBzaW5jZSAxLjIuMAogICAgICBAcHVibGljCiAgICAqLwoKICAgIC8qKgogICAgICBXaGVuIGF0dGVtcHRpbmcgdG8gdHJhbnNpdGlvbiBpbnRvIGEgcm91dGUsIGFueSBvZiB0aGUgaG9va3MKICAgICAgbWF5IHJldHVybiBhIHByb21pc2UgdGhhdCByZWplY3RzLCBhdCB3aGljaCBwb2ludCBhbiBgZXJyb3JgCiAgICAgIGFjdGlvbiB3aWxsIGJlIGZpcmVkIG9uIHRoZSBwYXJ0aWFsbHktZW50ZXJlZCByb3V0ZXMsIGFsbG93aW5nCiAgICAgIGZvciBwZXItcm91dGUgZXJyb3IgaGFuZGxpbmcgbG9naWMsIG9yIHNoYXJlZCBlcnJvciBoYW5kbGluZwogICAgICBsb2dpYyBkZWZpbmVkIG9uIGEgcGFyZW50IHJvdXRlLgogICAgICAgICBIZXJlIGlzIGFuIGV4YW1wbGUgb2YgYW4gZXJyb3IgaGFuZGxlciB0aGF0IHdpbGwgYmUgaW52b2tlZAogICAgICBmb3IgcmVqZWN0ZWQgcHJvbWlzZXMgZnJvbSB0aGUgdmFyaW91cyBob29rcyBvbiB0aGUgcm91dGUsCiAgICAgIGFzIHdlbGwgYXMgYW55IHVuaGFuZGxlZCBlcnJvcnMgZnJvbSBjaGlsZCByb3V0ZXM6CiAgICAgICAgIGBgYGFwcC9yb3V0ZXMvYWRtaW4uanMKICAgICAgaW1wb3J0IHsgcmVqZWN0IH0gZnJvbSAncnN2cCc7CiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgIGltcG9ydCB7IGFjdGlvbiB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBBZG1pblJvdXRlIGV4dGVuZHMgUm91dGUgewogICAgICAgIGJlZm9yZU1vZGVsKCkgewogICAgICAgICAgcmV0dXJuIHJlamVjdCgnYmFkIHRoaW5ncyEnKTsKICAgICAgICB9CiAgICAgICAgICAgQGFjdGlvbgogICAgICAgIGVycm9yKGVycm9yLCB0cmFuc2l0aW9uKSB7CiAgICAgICAgICAvLyBBc3N1bWluZyB3ZSBnb3QgaGVyZSBkdWUgdG8gdGhlIGVycm9yIGluIGBiZWZvcmVNb2RlbGAsCiAgICAgICAgICAvLyB3ZSBjYW4gZXhwZWN0IHRoYXQgZXJyb3IgPT09ICJiYWQgdGhpbmdzISIsCiAgICAgICAgICAvLyBidXQgYSBwcm9taXNlIG1vZGVsIHJlamVjdGluZyB3b3VsZCBhbHNvCiAgICAgICAgICAvLyBjYWxsIHRoaXMgaG9vaywgYXMgd291bGQgYW55IGVycm9ycyBlbmNvdW50ZXJlZAogICAgICAgICAgLy8gaW4gYGFmdGVyTW9kZWxgLgogICAgICAgICAgICAgLy8gVGhlIGBlcnJvcmAgaG9vayBpcyBhbHNvIHByb3ZpZGVkIHRoZSBmYWlsZWQKICAgICAgICAgIC8vIGB0cmFuc2l0aW9uYCwgd2hpY2ggY2FuIGJlIHN0b3JlZCBhbmQgbGF0ZXIKICAgICAgICAgIC8vIGAucmV0cnkoKWBkIGlmIGRlc2lyZWQuCiAgICAgICAgICAgICB0aGlzLnRyYW5zaXRpb25UbygnbG9naW4nKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICAgIGBlcnJvcmAgYWN0aW9ucyB0aGF0IGJ1YmJsZSB1cCBhbGwgdGhlIHdheSB0byBgQXBwbGljYXRpb25Sb3V0ZWAKICAgICAgd2lsbCBmaXJlIGEgZGVmYXVsdCBlcnJvciBoYW5kbGVyIHRoYXQgbG9ncyB0aGUgZXJyb3IuIFlvdSBjYW4KICAgICAgc3BlY2lmeSB5b3VyIG93biBnbG9iYWwgZGVmYXVsdCBlcnJvciBoYW5kbGVyIGJ5IG92ZXJyaWRpbmcgdGhlCiAgICAgIGBlcnJvcmAgaGFuZGxlciBvbiBgQXBwbGljYXRpb25Sb3V0ZWA6CiAgICAgICAgIGBgYGFwcC9yb3V0ZXMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgaW1wb3J0IHsgYWN0aW9uIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIEFwcGxpY2F0aW9uUm91dGUgZXh0ZW5kcyBSb3V0ZSB7CiAgICAgICAgQGFjdGlvbgogICAgICAgIGVycm9yKGVycm9yLCB0cmFuc2l0aW9uKSB7CiAgICAgICAgICB0aGlzLmNvbnRyb2xsZXJGb3IoJ2Jhbm5lcicpLmRpc3BsYXlFcnJvcihlcnJvci5tZXNzYWdlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgIEBldmVudCBlcnJvcgogICAgICBAcGFyYW0ge0Vycm9yfSBlcnJvcgogICAgICBAcGFyYW0ge1RyYW5zaXRpb259IHRyYW5zaXRpb24KICAgICAgQHNpbmNlIDEuMC4wCiAgICAgIEBwdWJsaWMKICAgICovCgogICAgLyoqCiAgICAgIFRoaXMgZXZlbnQgaXMgdHJpZ2dlcmVkIHdoZW4gdGhlIHJvdXRlciBlbnRlcnMgdGhlIHJvdXRlLiBJdCBpcwogICAgICBub3QgZXhlY3V0ZWQgd2hlbiB0aGUgbW9kZWwgZm9yIHRoZSByb3V0ZSBjaGFuZ2VzLgogICAgICAgICBgYGBhcHAvcm91dGVzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCB7IG9uIH0gZnJvbSAnQGVtYmVyL29iamVjdC9ldmVudGVkJzsKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgICBjb2xsZWN0QW5hbHl0aWNzOiBvbignYWN0aXZhdGUnLCBmdW5jdGlvbigpewogICAgICAgICAgY29sbGVjdEFuYWx5dGljcygpOwogICAgICAgIH0pCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgICAgQGV2ZW50IGFjdGl2YXRlCiAgICAgIEBzaW5jZSAxLjkuMAogICAgICBAcHVibGljCiAgICAqLwoKICAgIC8qKgogICAgICBUaGlzIGV2ZW50IGlzIHRyaWdnZXJlZCB3aGVuIHRoZSByb3V0ZXIgY29tcGxldGVseSBleGl0cyB0aGlzCiAgICAgIHJvdXRlLiBJdCBpcyBub3QgZXhlY3V0ZWQgd2hlbiB0aGUgbW9kZWwgZm9yIHRoZSByb3V0ZSBjaGFuZ2VzLgogICAgICAgICBgYGBhcHAvcm91dGVzL2luZGV4LmpzCiAgICAgIGltcG9ydCB7IG9uIH0gZnJvbSAnQGVtYmVyL29iamVjdC9ldmVudGVkJzsKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgICB0cmFja1BhZ2VMZWF2ZUFuYWx5dGljczogb24oJ2RlYWN0aXZhdGUnLCBmdW5jdGlvbigpewogICAgICAgICAgdHJhY2tQYWdlTGVhdmVBbmFseXRpY3MoKTsKICAgICAgICB9KQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICAgIEBldmVudCBkZWFjdGl2YXRlCiAgICAgIEBzaW5jZSAxLjkuMAogICAgICBAcHVibGljCiAgICAqLwoKICAgIC8qKgogICAgICBUaGlzIGhvb2sgaXMgZXhlY3V0ZWQgd2hlbiB0aGUgcm91dGVyIGNvbXBsZXRlbHkgZXhpdHMgdGhpcyByb3V0ZS4gSXQgaXMKICAgICAgbm90IGV4ZWN1dGVkIHdoZW4gdGhlIG1vZGVsIGZvciB0aGUgcm91dGUgY2hhbmdlcy4KICAgICAgICAgQG1ldGhvZCBkZWFjdGl2YXRlCiAgICAgIEBzaW5jZSAxLjAuMAogICAgICBAcHVibGljCiAgICAqLwogICAgOwoKICAgIF9wcm90by5kZWFjdGl2YXRlID0gZnVuY3Rpb24gZGVhY3RpdmF0ZSgpIHt9CiAgICAvKioKICAgICAgVGhpcyBob29rIGlzIGV4ZWN1dGVkIHdoZW4gdGhlIHJvdXRlciBlbnRlcnMgdGhlIHJvdXRlLiBJdCBpcyBub3QgZXhlY3V0ZWQKICAgICAgd2hlbiB0aGUgbW9kZWwgZm9yIHRoZSByb3V0ZSBjaGFuZ2VzLgogICAgICAgICBAbWV0aG9kIGFjdGl2YXRlCiAgICAgIEBzaW5jZSAxLjAuMAogICAgICBAcHVibGljCiAgICAqLwogICAgOwoKICAgIF9wcm90by5hY3RpdmF0ZSA9IGZ1bmN0aW9uIGFjdGl2YXRlKCkge30KICAgIC8qKgogICAgICBUcmFuc2l0aW9uIHRoZSBhcHBsaWNhdGlvbiBpbnRvIGFub3RoZXIgcm91dGUuIFRoZSByb3V0ZSBtYXkKICAgICAgYmUgZWl0aGVyIGEgc2luZ2xlIHJvdXRlIG9yIHJvdXRlIHBhdGg6CiAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgdGhpcy50cmFuc2l0aW9uVG8oJ2Jsb2dQb3N0cycpOwogICAgICB0aGlzLnRyYW5zaXRpb25UbygnYmxvZ1Bvc3RzLnJlY2VudEVudHJpZXMnKTsKICAgICAgYGBgCiAgICAgICAgIE9wdGlvbmFsbHkgc3VwcGx5IGEgbW9kZWwgZm9yIHRoZSByb3V0ZSBpbiBxdWVzdGlvbi4gVGhlIG1vZGVsCiAgICAgIHdpbGwgYmUgc2VyaWFsaXplZCBpbnRvIHRoZSBVUkwgdXNpbmcgdGhlIGBzZXJpYWxpemVgIGhvb2sgb2YKICAgICAgdGhlIHJvdXRlOgogICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHRoaXMudHJhbnNpdGlvblRvKCdibG9nUG9zdCcsIGFQb3N0KTsKICAgICAgYGBgCiAgICAgICAgIElmIGEgbGl0ZXJhbCBpcyBwYXNzZWQgKHN1Y2ggYXMgYSBudW1iZXIgb3IgYSBzdHJpbmcpLCBpdCB3aWxsCiAgICAgIGJlIHRyZWF0ZWQgYXMgYW4gaWRlbnRpZmllciBpbnN0ZWFkLiBJbiB0aGlzIGNhc2UsIHRoZSBgbW9kZWxgCiAgICAgIGhvb2sgb2YgdGhlIHJvdXRlIHdpbGwgYmUgdHJpZ2dlcmVkOgogICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHRoaXMudHJhbnNpdGlvblRvKCdibG9nUG9zdCcsIDEpOwogICAgICBgYGAKICAgICAgICAgTXVsdGlwbGUgbW9kZWxzIHdpbGwgYmUgYXBwbGllZCBsYXN0IHRvIGZpcnN0IHJlY3Vyc2l2ZWx5IHVwIHRoZQogICAgICByb3V0ZSB0cmVlLgogICAgICAgICBgYGBhcHAvcm91dGVzLmpzCiAgICAgIC8vIC4uLgogICAgICAgICBSb3V0ZXIubWFwKGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucm91dGUoJ2Jsb2dQb3N0JywgeyBwYXRoOic6YmxvZ1Bvc3RJZCcgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLnJvdXRlKCdibG9nQ29tbWVudCcsIHsgcGF0aDogJzpibG9nQ29tbWVudElkJyB9KTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlcjsKICAgICAgYGBgCiAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgdGhpcy50cmFuc2l0aW9uVG8oJ2Jsb2dDb21tZW50JywgYVBvc3QsIGFDb21tZW50KTsKICAgICAgdGhpcy50cmFuc2l0aW9uVG8oJ2Jsb2dDb21tZW50JywgMSwgMTMpOwogICAgICBgYGAKICAgICAgICAgSXQgaXMgYWxzbyBwb3NzaWJsZSB0byBwYXNzIGEgVVJMIChhIHN0cmluZyB0aGF0IHN0YXJ0cyB3aXRoIGEKICAgICAgYC9gKS4KICAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICB0aGlzLnRyYW5zaXRpb25UbygnLycpOwogICAgICB0aGlzLnRyYW5zaXRpb25UbygnL2Jsb2cvcG9zdC8xL2NvbW1lbnQvMTMnKTsKICAgICAgdGhpcy50cmFuc2l0aW9uVG8oJy9ibG9nL3Bvc3RzP3NvcnQ9dGl0bGUnKTsKICAgICAgYGBgCiAgICAgICAgIEFuIG9wdGlvbnMgaGFzaCB3aXRoIGEgYHF1ZXJ5UGFyYW1zYCBwcm9wZXJ0eSBtYXkgYmUgcHJvdmlkZWQgYXMKICAgICAgdGhlIGZpbmFsIGFyZ3VtZW50IHRvIGFkZCBxdWVyeSBwYXJhbWV0ZXJzIHRvIHRoZSBkZXN0aW5hdGlvbiBVUkwuCiAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgdGhpcy50cmFuc2l0aW9uVG8oJ2Jsb2dQb3N0JywgMSwgewogICAgICAgIHF1ZXJ5UGFyYW1zOiB7IHNob3dDb21tZW50czogJ3RydWUnIH0KICAgICAgfSk7CiAgICAgICAgIC8vIGlmIHlvdSBqdXN0IHdhbnQgdG8gdHJhbnNpdGlvbiB0aGUgcXVlcnkgcGFyYW1ldGVycyB3aXRob3V0IGNoYW5naW5nIHRoZSByb3V0ZQogICAgICB0aGlzLnRyYW5zaXRpb25Ubyh7IHF1ZXJ5UGFyYW1zOiB7IHNvcnQ6ICdkYXRlJyB9IH0pOwogICAgICBgYGAKICAgICAgICAgU2VlIGFsc28gW3JlcGxhY2VXaXRoXSgjbWV0aG9kX3JlcGxhY2VXaXRoKS4KICAgICAgICAgU2ltcGxlIFRyYW5zaXRpb24gRXhhbXBsZQogICAgICAgICBgYGBhcHAvcm91dGVzLmpzCiAgICAgIC8vIC4uLgogICAgICAgICBSb3V0ZXIubWFwKGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucm91dGUoJ2luZGV4Jyk7CiAgICAgICAgdGhpcy5yb3V0ZSgnc2VjcmV0Jyk7CiAgICAgICAgdGhpcy5yb3V0ZSgnZm91ck9oRm91cicsIHsgcGF0aDogJyo6JyB9KTsKICAgICAgfSk7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlcjsKICAgICAgYGBgCiAgICAgICAgIGBgYGFwcC9yb3V0ZXMvaW5kZXguanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgaW1wb3J0IHsgYWN0aW9uIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIEluZGV4Um91dGUgZXh0ZW5kcyBSb3V0ZSB7CiAgICAgICAgQGFjdGlvbgogICAgICAgIG1vdmVUb1NlY3JldChjb250ZXh0KSB7CiAgICAgICAgICBpZiAoYXV0aG9yaXplZCgpKSB7CiAgICAgICAgICAgIHRoaXMudHJhbnNpdGlvblRvKCdzZWNyZXQnLCBjb250ZXh0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudHJhbnNpdGlvblRvKCdmb3VyT2hGb3VyJyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgICBUcmFuc2l0aW9uIHRvIGEgbmVzdGVkIHJvdXRlCiAgICAgICAgIGBgYGFwcC9yb3V0ZXIuanMKICAgICAgLy8gLi4uCiAgICAgICAgIFJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yb3V0ZSgnYXJ0aWNsZXMnLCB7IHBhdGg6ICcvYXJ0aWNsZXMnIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5yb3V0ZSgnbmV3Jyk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZXI7CiAgICAgIGBgYAogICAgICAgICBgYGBhcHAvcm91dGVzL2luZGV4LmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgIGltcG9ydCB7IGFjdGlvbiB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBJbmRleFJvdXRlIGV4dGVuZHMgUm91dGUgewogICAgICAgIEBhY3Rpb24KICAgICAgICB0cmFuc2l0aW9uVG9OZXdBcnRpY2xlKCkgewogICAgICAgICAgdGhpcy50cmFuc2l0aW9uVG8oJ2FydGljbGVzLm5ldycpOwogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgICAgTXVsdGlwbGUgTW9kZWxzIEV4YW1wbGUKICAgICAgICAgYGBgYXBwL3JvdXRlci5qcwogICAgICAvLyAuLi4KICAgICAgICAgUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJvdXRlKCdpbmRleCcpOwogICAgICAgICAgIHRoaXMucm91dGUoJ2JyZWFrZmFzdCcsIHsgcGF0aDogJzpicmVha2Zhc3RJZCcgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLnJvdXRlKCdjZXJlYWwnLCB7IHBhdGg6ICc6Y2VyZWFsSWQnIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGVyOwogICAgICBgYGAKICAgICAgICAgYGBgYXBwL3JvdXRlcy9pbmRleC5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICBpbXBvcnQgeyBhY3Rpb24gfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgSW5kZXhSb3V0ZSBleHRlbmRzIFJvdXRlIHsKICAgICAgICBAYWN0aW9uCiAgICAgICAgbW92ZVRvQ2hvY29sYXRlQ2VyZWFsKCkgewogICAgICAgICAgbGV0IGNlcmVhbCA9IHsgY2VyZWFsSWQ6ICdDaG9jb2xhdGVZdW1taW5lc3MnIH07CiAgICAgICAgICBsZXQgYnJlYWtmYXN0ID0geyBicmVha2Zhc3RJZDogJ0NlcmVhbEFuZE1pbGsnIH07CiAgICAgICAgICAgICB0aGlzLnRyYW5zaXRpb25UbygnYnJlYWtmYXN0LmNlcmVhbCcsIGJyZWFrZmFzdCwgY2VyZWFsKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICAgIE5lc3RlZCBSb3V0ZSB3aXRoIFF1ZXJ5IFN0cmluZyBFeGFtcGxlCiAgICAgICAgIGBgYGFwcC9yb3V0ZXMuanMKICAgICAgLy8gLi4uCiAgICAgICAgIFJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yb3V0ZSgnZnJ1aXRzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLnJvdXRlKCdhcHBsZXMnKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlcjsKICAgICAgYGBgCiAgICAgICAgIGBgYGFwcC9yb3V0ZXMvaW5kZXguanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgSW5kZXhSb3V0ZSBleHRlbmRzIFJvdXRlIHsKICAgICAgICBAYWN0aW9uCiAgICAgICAgdHJhbnNpdGlvblRvQXBwbGVzKCkgewogICAgICAgICAgdGhpcy50cmFuc2l0aW9uVG8oJ2ZydWl0cy5hcHBsZXMnLCB7IHF1ZXJ5UGFyYW1zOiB7IGNvbG9yOiAncmVkJyB9IH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgICAgQG1ldGhvZCB0cmFuc2l0aW9uVG8KICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIG5hbWUgb2YgdGhlIHJvdXRlIG9yIGEgVVJMCiAgICAgIEBwYXJhbSB7Li4uT2JqZWN0fSBtb2RlbHMgdGhlIG1vZGVsKHMpIG9yIGlkZW50aWZpZXIocykgdG8gYmUgdXNlZCB3aGlsZQogICAgICAgIHRyYW5zaXRpb25pbmcgdG8gdGhlIHJvdXRlLgogICAgICBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIG9wdGlvbmFsIGhhc2ggd2l0aCBhIHF1ZXJ5UGFyYW1zIHByb3BlcnR5CiAgICAgICAgY29udGFpbmluZyBhIG1hcHBpbmcgb2YgcXVlcnkgcGFyYW1ldGVycwogICAgICBAcmV0dXJuIHtUcmFuc2l0aW9ufSB0aGUgdHJhbnNpdGlvbiBvYmplY3QgYXNzb2NpYXRlZCB3aXRoIHRoaXMKICAgICAgICBhdHRlbXB0ZWQgdHJhbnNpdGlvbgogICAgICBAc2luY2UgMS4wLjAKICAgICAgQHB1YmxpYwogICAgKi8KICAgIDsKCiAgICBfcHJvdG8udHJhbnNpdGlvblRvID0gZnVuY3Rpb24gdHJhbnNpdGlvblRvKCkgewogICAgICB2YXIgX3RoaXMkX3JvdXRlcjsKCiAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW51c2VkLXZhcnMKICAgICAgcmV0dXJuIChfdGhpcyRfcm91dGVyID0gdGhpcy5fcm91dGVyKS50cmFuc2l0aW9uVG8uYXBwbHkoX3RoaXMkX3JvdXRlciwgKDAsIF91dGlsczIucHJlZml4Um91dGVOYW1lQXJnKSh0aGlzLCBhcmdzKSk7CiAgICB9CiAgICAvKioKICAgICAgUGVyZm9ybSBhIHN5bmNocm9ub3VzIHRyYW5zaXRpb24gaW50byBhbm90aGVyIHJvdXRlIHdpdGhvdXQgYXR0ZW1wdGluZwogICAgICB0byByZXNvbHZlIHByb21pc2VzLCB1cGRhdGUgdGhlIFVSTCwgb3IgYWJvcnQgYW55IGN1cnJlbnRseSBhY3RpdmUKICAgICAgYXN5bmNocm9ub3VzIHRyYW5zaXRpb25zIChpLmUuIHJlZ3VsYXIgdHJhbnNpdGlvbnMgY2F1c2VkIGJ5CiAgICAgIGB0cmFuc2l0aW9uVG9gIG9yIFVSTCBjaGFuZ2VzKS4KICAgICAgICAgVGhpcyBtZXRob2QgaXMgaGFuZHkgZm9yIHBlcmZvcm1pbmcgaW50ZXJtZWRpYXRlIHRyYW5zaXRpb25zIG9uIHRoZQogICAgICB3YXkgdG8gYSBmaW5hbCBkZXN0aW5hdGlvbiByb3V0ZSwgYW5kIGlzIGNhbGxlZCBpbnRlcm5hbGx5IGJ5IHRoZQogICAgICBkZWZhdWx0IGltcGxlbWVudGF0aW9ucyBvZiB0aGUgYGVycm9yYCBhbmQgYGxvYWRpbmdgIGhhbmRsZXJzLgogICAgICAgICBAbWV0aG9kIGludGVybWVkaWF0ZVRyYW5zaXRpb25UbwogICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgcm91dGUKICAgICAgQHBhcmFtIHsuLi5PYmplY3R9IG1vZGVscyB0aGUgbW9kZWwocykgdG8gYmUgdXNlZCB3aGlsZSB0cmFuc2l0aW9uaW5nCiAgICAgIHRvIHRoZSByb3V0ZS4KICAgICAgQHNpbmNlIDEuMi4wCiAgICAgIEBwdWJsaWMKICAgICAqLwogICAgOwoKICAgIF9wcm90by5pbnRlcm1lZGlhdGVUcmFuc2l0aW9uVG8gPSBmdW5jdGlvbiBpbnRlcm1lZGlhdGVUcmFuc2l0aW9uVG8oKSB7CiAgICAgIHZhciBfdGhpcyRfcm91dGVyMjsKCiAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiksIF9rZXkyID0gMDsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgIGFyZ3NbX2tleTJdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgfQoKICAgICAgdmFyIF9wcmVmaXhSb3V0ZU5hbWVBcmcgPSAoMCwgX3V0aWxzMi5wcmVmaXhSb3V0ZU5hbWVBcmcpKHRoaXMsIGFyZ3MpLAogICAgICAgICAgbmFtZSA9IF9wcmVmaXhSb3V0ZU5hbWVBcmdbMF0sCiAgICAgICAgICBwcmVwYXJlZEFyZ3MgPSBfcHJlZml4Um91dGVOYW1lQXJnLnNsaWNlKDEpOwoKICAgICAgKF90aGlzJF9yb3V0ZXIyID0gdGhpcy5fcm91dGVyKS5pbnRlcm1lZGlhdGVUcmFuc2l0aW9uVG8uYXBwbHkoX3RoaXMkX3JvdXRlcjIsIFtuYW1lXS5jb25jYXQocHJlcGFyZWRBcmdzKSk7CiAgICB9CiAgICAvKioKICAgICAgUmVmcmVzaCB0aGUgbW9kZWwgb24gdGhpcyByb3V0ZSBhbmQgYW55IGNoaWxkIHJvdXRlcywgZmlyaW5nIHRoZQogICAgICBgYmVmb3JlTW9kZWxgLCBgbW9kZWxgLCBhbmQgYGFmdGVyTW9kZWxgIGhvb2tzIGluIGEgc2ltaWxhciBmYXNoaW9uCiAgICAgIHRvIGhvdyByb3V0ZXMgYXJlIGVudGVyZWQgd2hlbiB0cmFuc2l0aW9uaW5nIGluIGZyb20gb3RoZXIgcm91dGUuCiAgICAgIFRoZSBjdXJyZW50IHJvdXRlIHBhcmFtcyAoZS5nLiBgYXJ0aWNsZV9pZGApIHdpbGwgYmUgcGFzc2VkIGluCiAgICAgIHRvIHRoZSByZXNwZWN0aXZlIG1vZGVsIGhvb2tzLCBhbmQgaWYgYSBkaWZmZXJlbnQgbW9kZWwgaXMgcmV0dXJuZWQsCiAgICAgIGBzZXR1cENvbnRyb2xsZXJgIGFuZCBhc3NvY2lhdGVkIHJvdXRlIGhvb2tzIHdpbGwgcmUtZmlyZSBhcyB3ZWxsLgogICAgICAgICBBbiBleGFtcGxlIHVzYWdlIG9mIHRoaXMgbWV0aG9kIGlzIHJlLXF1ZXJ5aW5nIHRoZSBzZXJ2ZXIgZm9yIHRoZQogICAgICBsYXRlc3QgaW5mb3JtYXRpb24gdXNpbmcgdGhlIHNhbWUgcGFyYW1ldGVycyBhcyB3aGVuIHRoZSByb3V0ZQogICAgICB3YXMgZmlyc3QgZW50ZXJlZC4KICAgICAgICAgTm90ZSB0aGF0IHRoaXMgd2lsbCBjYXVzZSBgbW9kZWxgIGhvb2tzIHRvIGZpcmUgZXZlbiBvbiByb3V0ZXMKICAgICAgdGhhdCB3ZXJlIHByb3ZpZGVkIGEgbW9kZWwgb2JqZWN0IHdoZW4gdGhlIHJvdXRlIHdhcyBpbml0aWFsbHkKICAgICAgZW50ZXJlZC4KICAgICAgICAgQG1ldGhvZCByZWZyZXNoCiAgICAgIEByZXR1cm4ge1RyYW5zaXRpb259IHRoZSB0cmFuc2l0aW9uIG9iamVjdCBhc3NvY2lhdGVkIHdpdGggdGhpcwogICAgICAgIGF0dGVtcHRlZCB0cmFuc2l0aW9uCiAgICAgIEBzaW5jZSAxLjQuMAogICAgICBAcHVibGljCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucmVmcmVzaCA9IGZ1bmN0aW9uIHJlZnJlc2goKSB7CiAgICAgIHJldHVybiB0aGlzLl9yb3V0ZXIuX3JvdXRlck1pY3JvbGliLnJlZnJlc2godGhpcyk7CiAgICB9CiAgICAvKioKICAgICAgVHJhbnNpdGlvbiBpbnRvIGFub3RoZXIgcm91dGUgd2hpbGUgcmVwbGFjaW5nIHRoZSBjdXJyZW50IFVSTCwgaWYgcG9zc2libGUuCiAgICAgIFRoaXMgd2lsbCByZXBsYWNlIHRoZSBjdXJyZW50IGhpc3RvcnkgZW50cnkgaW5zdGVhZCBvZiBhZGRpbmcgYSBuZXcgb25lLgogICAgICBCZXNpZGUgdGhhdCwgaXQgaXMgaWRlbnRpY2FsIHRvIGB0cmFuc2l0aW9uVG9gIGluIGFsbCBvdGhlciByZXNwZWN0cy4gU2VlCiAgICAgICd0cmFuc2l0aW9uVG8nIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uIHJlZ2FyZGluZyBtdWx0aXBsZSBtb2RlbHMuCiAgICAgICAgIEV4YW1wbGUKICAgICAgICAgYGBgYXBwL3JvdXRlci5qcwogICAgICAvLyAuLi4KICAgICAgICAgUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJvdXRlKCdpbmRleCcpOwogICAgICAgIHRoaXMucm91dGUoJ3NlY3JldCcpOwogICAgICB9KTsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGVyOwogICAgICBgYGAKICAgICAgICAgYGBgYXBwL3JvdXRlcy9zZWNyZXQuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgU2VjcmV0Um91dGUgUm91dGUgewogICAgICAgIGFmdGVyTW9kZWwoKSB7CiAgICAgICAgICBpZiAoIWF1dGhvcml6ZWQoKSl7CiAgICAgICAgICAgIHRoaXMucmVwbGFjZVdpdGgoJ2luZGV4Jyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgICBAbWV0aG9kIHJlcGxhY2VXaXRoCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIHRoZSBuYW1lIG9mIHRoZSByb3V0ZSBvciBhIFVSTAogICAgICBAcGFyYW0gey4uLk9iamVjdH0gbW9kZWxzIHRoZSBtb2RlbChzKSBvciBpZGVudGlmaWVyKHMpIHRvIGJlIHVzZWQgd2hpbGUKICAgICAgICB0cmFuc2l0aW9uaW5nIHRvIHRoZSByb3V0ZS4KICAgICAgQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBvcHRpb25hbCBoYXNoIHdpdGggYSBxdWVyeVBhcmFtcyBwcm9wZXJ0eQogICAgICAgIGNvbnRhaW5pbmcgYSBtYXBwaW5nIG9mIHF1ZXJ5IHBhcmFtZXRlcnMKICAgICAgQHJldHVybiB7VHJhbnNpdGlvbn0gdGhlIHRyYW5zaXRpb24gb2JqZWN0IGFzc29jaWF0ZWQgd2l0aCB0aGlzCiAgICAgICAgYXR0ZW1wdGVkIHRyYW5zaXRpb24KICAgICAgQHNpbmNlIDEuMC4wCiAgICAgIEBwdWJsaWMKICAgICovCiAgICA7CgogICAgX3Byb3RvLnJlcGxhY2VXaXRoID0gZnVuY3Rpb24gcmVwbGFjZVdpdGgoKSB7CiAgICAgIHZhciBfdGhpcyRfcm91dGVyMzsKCiAgICAgIGZvciAodmFyIF9sZW4zID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMyksIF9rZXkzID0gMDsgX2tleTMgPCBfbGVuMzsgX2tleTMrKykgewogICAgICAgIGFyZ3NbX2tleTNdID0gYXJndW1lbnRzW19rZXkzXTsKICAgICAgfQoKICAgICAgcmV0dXJuIChfdGhpcyRfcm91dGVyMyA9IHRoaXMuX3JvdXRlcikucmVwbGFjZVdpdGguYXBwbHkoX3RoaXMkX3JvdXRlcjMsICgwLCBfdXRpbHMyLnByZWZpeFJvdXRlTmFtZUFyZykodGhpcywgYXJncykpOwogICAgfQogICAgLyoqCiAgICAgIFRoaXMgaG9vayBpcyB0aGUgZW50cnkgcG9pbnQgZm9yIHJvdXRlci5qcwogICAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIHNldHVwCiAgICAqLwogICAgOwoKICAgIF9wcm90by5zZXR1cCA9IGZ1bmN0aW9uIHNldHVwKGNvbnRleHQsIHRyYW5zaXRpb24pIHsKICAgICAgdmFyIGNvbnRyb2xsZXJOYW1lID0gdGhpcy5jb250cm9sbGVyTmFtZSB8fCB0aGlzLnJvdXRlTmFtZTsKICAgICAgdmFyIGRlZmluZWRDb250cm9sbGVyID0gdGhpcy5jb250cm9sbGVyRm9yKGNvbnRyb2xsZXJOYW1lLCB0cnVlKTsKICAgICAgdmFyIGNvbnRyb2xsZXI7CgogICAgICBpZiAoZGVmaW5lZENvbnRyb2xsZXIpIHsKICAgICAgICBjb250cm9sbGVyID0gZGVmaW5lZENvbnRyb2xsZXI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29udHJvbGxlciA9IHRoaXMuZ2VuZXJhdGVDb250cm9sbGVyKGNvbnRyb2xsZXJOYW1lKTsKICAgICAgfSAvLyBBc3NpZ24gdGhlIHJvdXRlJ3MgY29udHJvbGxlciBzbyB0aGF0IGl0IGNhbiBtb3JlIGVhc2lseSBiZQogICAgICAvLyByZWZlcmVuY2VkIGluIGFjdGlvbiBoYW5kbGVycy4gU2lkZSBlZmZlY3RzLiBTaWRlIGVmZmVjdHMgZXZlcnl3aGVyZS4KCgogICAgICBpZiAoIXRoaXMuY29udHJvbGxlcikgewogICAgICAgIHZhciBxcCA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAnX3FwJyk7CiAgICAgICAgdmFyIHByb3BOYW1lcyA9IHFwICE9PSB1bmRlZmluZWQgPyAoMCwgX21ldGFsLmdldCkocXAsICdwcm9wZXJ0eU5hbWVzJykgOiBbXTsKICAgICAgICBhZGRRdWVyeVBhcmFtc09ic2VydmVycyhjb250cm9sbGVyLCBwcm9wTmFtZXMpOwogICAgICAgIHRoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7CiAgICAgIH0KCiAgICAgIHZhciBxdWVyeVBhcmFtcyA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAnX3FwJyk7CiAgICAgIHZhciBzdGF0ZXMgPSBxdWVyeVBhcmFtcy5zdGF0ZXM7CiAgICAgIGNvbnRyb2xsZXIuX3FwRGVsZWdhdGUgPSBzdGF0ZXMuYWxsb3dPdmVycmlkZXM7CgogICAgICBpZiAodHJhbnNpdGlvbikgewogICAgICAgIC8vIFVwZGF0ZSB0aGUgbW9kZWwgZGVwIHZhbHVlcyB1c2VkIHRvIGNhbGN1bGF0ZSBjYWNoZSBrZXlzLgogICAgICAgICgwLCBfdXRpbHMyLnN0YXNoUGFyYW1OYW1lcykodGhpcy5fcm91dGVyLCB0cmFuc2l0aW9uW19yb3V0ZXJfanMuU1RBVEVfU1lNQk9MXS5yb3V0ZUluZm9zKTsKICAgICAgICB2YXIgY2FjaGUgPSB0aGlzLl9idWNrZXRDYWNoZTsKICAgICAgICB2YXIgcGFyYW1zID0gdHJhbnNpdGlvbltfcm91dGVyX2pzLlBBUkFNU19TWU1CT0xdOwogICAgICAgIHZhciBhbGxQYXJhbXMgPSBxdWVyeVBhcmFtcy5wcm9wZXJ0eU5hbWVzOwogICAgICAgIGFsbFBhcmFtcy5mb3JFYWNoKGZ1bmN0aW9uIChwcm9wKSB7CiAgICAgICAgICB2YXIgYVFwID0gcXVlcnlQYXJhbXMubWFwW3Byb3BdOwogICAgICAgICAgYVFwLnZhbHVlcyA9IHBhcmFtczsKICAgICAgICAgIHZhciBjYWNoZUtleSA9ICgwLCBfdXRpbHMyLmNhbGN1bGF0ZUNhY2hlS2V5KShhUXAucm91dGUuZnVsbFJvdXRlTmFtZSwgYVFwLnBhcnRzLCBhUXAudmFsdWVzKTsKICAgICAgICAgIHZhciB2YWx1ZSA9IGNhY2hlLmxvb2t1cChjYWNoZUtleSwgcHJvcCwgYVFwLnVuZGVjb3JhdGVkRGVmYXVsdFZhbHVlKTsKICAgICAgICAgICgwLCBfbWV0YWwuc2V0KShjb250cm9sbGVyLCBwcm9wLCB2YWx1ZSk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIHFwVmFsdWVzID0gZ2V0UXVlcnlQYXJhbXNGb3IodGhpcywgdHJhbnNpdGlvbltfcm91dGVyX2pzLlNUQVRFX1NZTUJPTF0pOwogICAgICAgICgwLCBfbWV0YWwuc2V0UHJvcGVydGllcykoY29udHJvbGxlciwgcXBWYWx1ZXMpOwogICAgICB9CgogICAgICB0aGlzLnNldHVwQ29udHJvbGxlcihjb250cm9sbGVyLCBjb250ZXh0LCB0cmFuc2l0aW9uKTsKCiAgICAgIGlmICh0aGlzLl9lbnZpcm9ubWVudC5vcHRpb25zLnNob3VsZFJlbmRlcikgewogICAgICAgIHRoaXMucmVuZGVyVGVtcGxhdGUoY29udHJvbGxlciwgY29udGV4dCk7CiAgICAgIH0gLy8gU2V0dXAgY2FuIGNhdXNlIGNoYW5nZXMgdG8gUVBzIHdoaWNoIG5lZWQgdG8gYmUgcHJvcG9nYXRlZCBpbW1lZGlhdGVseSBpbgogICAgICAvLyBzb21lIHNpdHVhdGlvbnMuIEV2ZW50dWFsbHksIHdlIHNob3VsZCB3b3JrIG9uIG1ha2luZyB0aGVzZSBhc3luYyBzb21laG93LgoKCiAgICAgIGlmICh0cnVlCiAgICAgIC8qIEVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyAqLwogICAgICApIHsKICAgICAgICAgICgwLCBfbWV0YWwuZmx1c2hBc3luY09ic2VydmVycykoZmFsc2UpOwogICAgICAgIH0KICAgIH0KICAgIC8qCiAgICAgIENhbGxlZCB3aGVuIGEgcXVlcnkgcGFyYW1ldGVyIGZvciB0aGlzIHJvdXRlIGNoYW5nZXMsIHJlZ2FyZGxlc3Mgb2Ygd2hldGhlciB0aGUgcm91dGUKICAgICAgaXMgY3VycmVudGx5IHBhcnQgb2YgdGhlIGFjdGl2ZSByb3V0ZSBoaWVyYXJjaHkuIFRoaXMgd2lsbCB1cGRhdGUgdGhlIHF1ZXJ5IHBhcmFtZXRlcidzCiAgICAgIHZhbHVlIGluIHRoZSBjYWNoZSBzbyBpZiB0aGlzIHJvdXRlIGJlY29tZXMgYWN0aXZlLCB0aGUgY2FjaGUgdmFsdWUgaGFzIGJlZW4gdXBkYXRlZC4KICAgICovCiAgICA7CgogICAgX3Byb3RvLl9xcENoYW5nZWQgPSBmdW5jdGlvbiBfcXBDaGFuZ2VkKHByb3AsIHZhbHVlLCBxcCkgewogICAgICBpZiAoIXFwKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vIFVwZGF0ZSBtb2RlbC1kZXAgY2FjaGUKCgogICAgICB2YXIgY2FjaGUgPSB0aGlzLl9idWNrZXRDYWNoZTsKICAgICAgdmFyIGNhY2hlS2V5ID0gKDAsIF91dGlsczIuY2FsY3VsYXRlQ2FjaGVLZXkpKHFwLnJvdXRlLmZ1bGxSb3V0ZU5hbWUsIHFwLnBhcnRzLCBxcC52YWx1ZXMpOwogICAgICBjYWNoZS5zdGFzaChjYWNoZUtleSwgcHJvcCwgdmFsdWUpOwogICAgfQogICAgLyoqCiAgICAgIFRoaXMgaG9vayBpcyB0aGUgZmlyc3Qgb2YgdGhlIHJvdXRlIGVudHJ5IHZhbGlkYXRpb24gaG9va3MKICAgICAgY2FsbGVkIHdoZW4gYW4gYXR0ZW1wdCBpcyBtYWRlIHRvIHRyYW5zaXRpb24gaW50byBhIHJvdXRlCiAgICAgIG9yIG9uZSBvZiBpdHMgY2hpbGRyZW4uIEl0IGlzIGNhbGxlZCBiZWZvcmUgYG1vZGVsYCBhbmQKICAgICAgYGFmdGVyTW9kZWxgLCBhbmQgaXMgYXBwcm9wcmlhdGUgZm9yIGNhc2VzIHdoZW46CiAgICAgICAgIDEpIEEgZGVjaXNpb24gY2FuIGJlIG1hZGUgdG8gcmVkaXJlY3QgZWxzZXdoZXJlIHdpdGhvdXQKICAgICAgICAgbmVlZGluZyB0byByZXNvbHZlIHRoZSBtb2RlbCBmaXJzdC4KICAgICAgMikgQW55IGFzeW5jIG9wZXJhdGlvbnMgbmVlZCB0byBvY2N1ciBmaXJzdCBiZWZvcmUgdGhlCiAgICAgICAgIG1vZGVsIGlzIGF0dGVtcHRlZCB0byBiZSByZXNvbHZlZC4KICAgICAgICAgVGhpcyBob29rIGlzIHByb3ZpZGVkIHRoZSBjdXJyZW50IGB0cmFuc2l0aW9uYCBhdHRlbXB0CiAgICAgIGFzIGEgcGFyYW1ldGVyLCB3aGljaCBjYW4gYmUgdXNlZCB0byBgLmFib3J0KClgIHRoZSB0cmFuc2l0aW9uLAogICAgICBzYXZlIGl0IGZvciBhIGxhdGVyIGAucmV0cnkoKWAsIG9yIHJldHJpZXZlIHZhbHVlcyBzZXQKICAgICAgb24gaXQgZnJvbSBhIHByZXZpb3VzIGhvb2suIFlvdSBjYW4gYWxzbyBqdXN0IGNhbGwKICAgICAgYHRoaXMudHJhbnNpdGlvblRvYCB0byBhbm90aGVyIHJvdXRlIHRvIGltcGxpY2l0bHkKICAgICAgYWJvcnQgdGhlIGB0cmFuc2l0aW9uYC4KICAgICAgICAgWW91IGNhbiByZXR1cm4gYSBwcm9taXNlIGZyb20gdGhpcyBob29rIHRvIHBhdXNlIHRoZQogICAgICB0cmFuc2l0aW9uIHVudGlsIHRoZSBwcm9taXNlIHJlc29sdmVzIChvciByZWplY3RzKS4gVGhpcyBjb3VsZAogICAgICBiZSB1c2VmdWwsIGZvciBpbnN0YW5jZSwgZm9yIHJldHJpZXZpbmcgYXN5bmMgY29kZSBmcm9tCiAgICAgIHRoZSBzZXJ2ZXIgdGhhdCBpcyByZXF1aXJlZCB0byBlbnRlciBhIHJvdXRlLgogICAgICAgICBAbWV0aG9kIGJlZm9yZU1vZGVsCiAgICAgIEBwYXJhbSB7VHJhbnNpdGlvbn0gdHJhbnNpdGlvbgogICAgICBAcmV0dXJuIHthbnkgfCBQcm9taXNlPGFueT59IGlmIHRoZSB2YWx1ZSByZXR1cm5lZCBmcm9tIHRoaXMgaG9vayBpcwogICAgICAgIGEgcHJvbWlzZSwgdGhlIHRyYW5zaXRpb24gd2lsbCBwYXVzZSB1bnRpbCB0aGUgdHJhbnNpdGlvbgogICAgICAgIHJlc29sdmVzLiBPdGhlcndpc2UsIG5vbi1wcm9taXNlIHJldHVybiB2YWx1ZXMgYXJlIG5vdAogICAgICAgIHV0aWxpemVkIGluIGFueSB3YXkuCiAgICAgIEBzaW5jZSAxLjAuMAogICAgICBAcHVibGljCiAgICAqLwogICAgOwoKICAgIF9wcm90by5iZWZvcmVNb2RlbCA9IGZ1bmN0aW9uIGJlZm9yZU1vZGVsKCkge30KICAgIC8qKgogICAgICBUaGlzIGhvb2sgaXMgY2FsbGVkIGFmdGVyIHRoaXMgcm91dGUncyBtb2RlbCBoYXMgcmVzb2x2ZWQuCiAgICAgIEl0IGZvbGxvd3MgaWRlbnRpY2FsIGFzeW5jL3Byb21pc2Ugc2VtYW50aWNzIHRvIGBiZWZvcmVNb2RlbGAKICAgICAgYnV0IGlzIHByb3ZpZGVkIHRoZSByb3V0ZSdzIHJlc29sdmVkIG1vZGVsIGluIGFkZGl0aW9uIHRvCiAgICAgIHRoZSBgdHJhbnNpdGlvbmAsIGFuZCBpcyB0aGVyZWZvcmUgc3VpdGVkIHRvIHBlcmZvcm1pbmcKICAgICAgbG9naWMgdGhhdCBjYW4gb25seSB0YWtlIHBsYWNlIGFmdGVyIHRoZSBtb2RlbCBoYXMgYWxyZWFkeQogICAgICByZXNvbHZlZC4KICAgICAgICAgYGBgYXBwL3JvdXRlcy9wb3N0cy5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBQb3N0c1JvdXRlIGV4dGVuZHMgUm91dGUgewogICAgICAgIGFmdGVyTW9kZWwocG9zdHMsIHRyYW5zaXRpb24pIHsKICAgICAgICAgIGlmIChwb3N0cy5nZXQoJ2xlbmd0aCcpID09PSAxKSB7CiAgICAgICAgICAgIHRoaXMudHJhbnNpdGlvblRvKCdwb3N0LnNob3cnLCBwb3N0cy5nZXQoJ2ZpcnN0T2JqZWN0JykpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgICAgUmVmZXIgdG8gZG9jdW1lbnRhdGlvbiBmb3IgYGJlZm9yZU1vZGVsYCBmb3IgYSBkZXNjcmlwdGlvbgogICAgICBvZiB0cmFuc2l0aW9uLXBhdXNpbmcgc2VtYW50aWNzIHdoZW4gYSBwcm9taXNlIGlzIHJldHVybmVkCiAgICAgIGZyb20gdGhpcyBob29rLgogICAgICAgICBAbWV0aG9kIGFmdGVyTW9kZWwKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlc29sdmVkTW9kZWwgdGhlIHZhbHVlIHJldHVybmVkIGZyb20gYG1vZGVsYCwKICAgICAgICBvciBpdHMgcmVzb2x2ZWQgdmFsdWUgaWYgaXQgd2FzIGEgcHJvbWlzZQogICAgICBAcGFyYW0ge1RyYW5zaXRpb259IHRyYW5zaXRpb24KICAgICAgQHJldHVybiB7YW55IHwgUHJvbWlzZTxhbnk+fSBpZiB0aGUgdmFsdWUgcmV0dXJuZWQgZnJvbSB0aGlzIGhvb2sgaXMKICAgICAgICBhIHByb21pc2UsIHRoZSB0cmFuc2l0aW9uIHdpbGwgcGF1c2UgdW50aWwgdGhlIHRyYW5zaXRpb24KICAgICAgICByZXNvbHZlcy4gT3RoZXJ3aXNlLCBub24tcHJvbWlzZSByZXR1cm4gdmFsdWVzIGFyZSBub3QKICAgICAgICB1dGlsaXplZCBpbiBhbnkgd2F5LgogICAgICBAc2luY2UgMS4wLjAKICAgICAgQHB1YmxpYwogICAgICovCiAgICA7CgogICAgX3Byb3RvLmFmdGVyTW9kZWwgPSBmdW5jdGlvbiBhZnRlck1vZGVsKCkge30KICAgIC8qKgogICAgICBBIGhvb2sgeW91IGNhbiBpbXBsZW1lbnQgdG8gb3B0aW9uYWxseSByZWRpcmVjdCB0byBhbm90aGVyIHJvdXRlLgogICAgICAgICBJZiB5b3UgY2FsbCBgdGhpcy50cmFuc2l0aW9uVG9gIGZyb20gaW5zaWRlIG9mIHRoaXMgaG9vaywgdGhpcyByb3V0ZQogICAgICB3aWxsIG5vdCBiZSBlbnRlcmVkIGluIGZhdm9yIG9mIHRoZSBvdGhlciBob29rLgogICAgICAgICBgcmVkaXJlY3RgIGFuZCBgYWZ0ZXJNb2RlbGAgYmVoYXZlIHZlcnkgc2ltaWxhcmx5IGFuZCBhcmUKICAgICAgY2FsbGVkIGFsbW9zdCBhdCB0aGUgc2FtZSB0aW1lLCBidXQgdGhleSBoYXZlIGFuIGltcG9ydGFudAogICAgICBkaXN0aW5jdGlvbiBpbiB0aGUgY2FzZSB0aGF0LCBmcm9tIG9uZSBvZiB0aGVzZSBob29rcywgYQogICAgICByZWRpcmVjdCBpbnRvIGEgY2hpbGQgcm91dGUgb2YgdGhpcyByb3V0ZSBvY2N1cnM6IHJlZGlyZWN0cwogICAgICBmcm9tIGBhZnRlck1vZGVsYCBlc3NlbnRpYWxseSBpbnZhbGlkYXRlIHRoZSBjdXJyZW50IGF0dGVtcHQKICAgICAgdG8gZW50ZXIgdGhpcyByb3V0ZSwgYW5kIHdpbGwgcmVzdWx0IGluIHRoaXMgcm91dGUncyBgYmVmb3JlTW9kZWxgLAogICAgICBgbW9kZWxgLCBhbmQgYGFmdGVyTW9kZWxgIGhvb2tzIGJlaW5nIGZpcmVkIGFnYWluIHdpdGhpbgogICAgICB0aGUgbmV3LCByZWRpcmVjdGluZyB0cmFuc2l0aW9uLiBSZWRpcmVjdHMgdGhhdCBvY2N1ciB3aXRoaW4KICAgICAgdGhlIGByZWRpcmVjdGAgaG9vaywgb24gdGhlIG90aGVyIGhhbmQsIHdpbGwgX25vdF8gY2F1c2UKICAgICAgdGhlc2UgaG9va3MgdG8gYmUgZmlyZWQgYWdhaW4gdGhlIHNlY29uZCB0aW1lIGFyb3VuZDsgaW4KICAgICAgb3RoZXIgd29yZHMsIGJ5IHRoZSB0aW1lIHRoZSBgcmVkaXJlY3RgIGhvb2sgaGFzIGJlZW4gY2FsbGVkLAogICAgICBib3RoIHRoZSByZXNvbHZlZCBtb2RlbCBhbmQgYXR0ZW1wdGVkIGVudHJ5IGludG8gdGhpcyByb3V0ZQogICAgICBhcmUgY29uc2lkZXJlZCB0byBiZSBmdWxseSB2YWxpZGF0ZWQuCiAgICAgICAgIEBtZXRob2QgcmVkaXJlY3QKICAgICAgQHBhcmFtIHtPYmplY3R9IG1vZGVsIHRoZSBtb2RlbCBmb3IgdGhpcyByb3V0ZQogICAgICBAcGFyYW0ge1RyYW5zaXRpb259IHRyYW5zaXRpb24gdGhlIHRyYW5zaXRpb24gb2JqZWN0IGFzc29jaWF0ZWQgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uCiAgICAgIEBzaW5jZSAxLjAuMAogICAgICBAcHVibGljCiAgICAqLwogICAgOwoKICAgIF9wcm90by5yZWRpcmVjdCA9IGZ1bmN0aW9uIHJlZGlyZWN0KCkge30KICAgIC8qKgogICAgICBDYWxsZWQgd2hlbiB0aGUgY29udGV4dCBpcyBjaGFuZ2VkIGJ5IHJvdXRlci5qcy4KICAgICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBjb250ZXh0RGlkQ2hhbmdlCiAgICAqLwogICAgOwoKICAgIF9wcm90by5jb250ZXh0RGlkQ2hhbmdlID0gZnVuY3Rpb24gY29udGV4dERpZENoYW5nZSgpIHsKICAgICAgdGhpcy5jdXJyZW50TW9kZWwgPSB0aGlzLmNvbnRleHQ7CiAgICB9CiAgICAvKioKICAgICAgQSBob29rIHlvdSBjYW4gaW1wbGVtZW50IHRvIGNvbnZlcnQgdGhlIFVSTCBpbnRvIHRoZSBtb2RlbCBmb3IKICAgICAgdGhpcyByb3V0ZS4KICAgICAgICAgYGBgYXBwL3JvdXRlci5qcwogICAgICAvLyAuLi4KICAgICAgICAgUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJvdXRlKCdwb3N0JywgeyBwYXRoOiAnL3Bvc3RzLzpwb3N0X2lkJyB9KTsKICAgICAgfSk7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlcjsKICAgICAgYGBgCiAgICAgICAgIFRoZSBtb2RlbCBmb3IgdGhlIGBwb3N0YCByb3V0ZSBpcyBgc3RvcmUuZmluZFJlY29yZCgncG9zdCcsIHBhcmFtcy5wb3N0X2lkKWAuCiAgICAgICAgIEJ5IGRlZmF1bHQsIGlmIHlvdXIgcm91dGUgaGFzIGEgZHluYW1pYyBzZWdtZW50IGVuZGluZyBpbiBgX2lkYDoKICAgICAgICAgKiBUaGUgbW9kZWwgY2xhc3MgaXMgZGV0ZXJtaW5lZCBmcm9tIHRoZSBzZWdtZW50IChgcG9zdF9pZGAncwogICAgICAgIGNsYXNzIGlzIGBBcHAuUG9zdGApCiAgICAgICogVGhlIGZpbmQgbWV0aG9kIGlzIGNhbGxlZCBvbiB0aGUgbW9kZWwgY2xhc3Mgd2l0aCB0aGUgdmFsdWUgb2YKICAgICAgICB0aGUgZHluYW1pYyBzZWdtZW50LgogICAgICAgICBOb3RlIHRoYXQgZm9yIHJvdXRlcyB3aXRoIGR5bmFtaWMgc2VnbWVudHMsIHRoaXMgaG9vayBpcyBub3QgYWx3YXlzCiAgICAgIGV4ZWN1dGVkLiBJZiB0aGUgcm91dGUgaXMgZW50ZXJlZCB0aHJvdWdoIGEgdHJhbnNpdGlvbiAoZS5nLiB3aGVuCiAgICAgIHVzaW5nIHRoZSBgbGluay10b2AgSGFuZGxlYmFycyBoZWxwZXIgb3IgdGhlIGB0cmFuc2l0aW9uVG9gIG1ldGhvZAogICAgICBvZiByb3V0ZXMpLCBhbmQgYSBtb2RlbCBjb250ZXh0IGlzIGFscmVhZHkgcHJvdmlkZWQgdGhpcyBob29rCiAgICAgIGlzIG5vdCBjYWxsZWQuCiAgICAgICAgIEEgbW9kZWwgY29udGV4dCBkb2VzIG5vdCBpbmNsdWRlIGEgcHJpbWl0aXZlIHN0cmluZyBvciBudW1iZXIsCiAgICAgIHdoaWNoIGRvZXMgY2F1c2UgdGhlIG1vZGVsIGhvb2sgdG8gYmUgY2FsbGVkLgogICAgICAgICBSb3V0ZXMgd2l0aG91dCBkeW5hbWljIHNlZ21lbnRzIHdpbGwgYWx3YXlzIGV4ZWN1dGUgdGhlIG1vZGVsIGhvb2suCiAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgLy8gbm8gZHluYW1pYyBzZWdtZW50LCBtb2RlbCBob29rIGFsd2F5cyBjYWxsZWQKICAgICAgdGhpcy50cmFuc2l0aW9uVG8oJ3Bvc3RzJyk7CiAgICAgICAgIC8vIG1vZGVsIHBhc3NlZCBpbiwgc28gbW9kZWwgaG9vayBub3QgY2FsbGVkCiAgICAgIHRoZVBvc3QgPSBzdG9yZS5maW5kUmVjb3JkKCdwb3N0JywgMSk7CiAgICAgIHRoaXMudHJhbnNpdGlvblRvKCdwb3N0JywgdGhlUG9zdCk7CiAgICAgICAgIC8vIGludGVnZXIgcGFzc2VkIGluLCBtb2RlbCBob29rIGlzIGNhbGxlZAogICAgICB0aGlzLnRyYW5zaXRpb25UbygncG9zdCcsIDEpOwogICAgICAgICAvLyBtb2RlbCBpZCBwYXNzZWQgaW4sIG1vZGVsIGhvb2sgaXMgY2FsbGVkCiAgICAgIC8vIHVzZWZ1bCBmb3IgZm9yY2luZyB0aGUgaG9vayB0byBleGVjdXRlCiAgICAgIHRoZVBvc3QgPSBzdG9yZS5maW5kUmVjb3JkKCdwb3N0JywgMSk7CiAgICAgIHRoaXMudHJhbnNpdGlvblRvKCdwb3N0JywgdGhlUG9zdC5pZCk7CiAgICAgIGBgYAogICAgICAgICBUaGlzIGhvb2sgZm9sbG93cyB0aGUgYXN5bmNocm9ub3VzL3Byb21pc2Ugc2VtYW50aWNzCiAgICAgIGRlc2NyaWJlZCBpbiB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgYGJlZm9yZU1vZGVsYC4gSW4gcGFydGljdWxhciwKICAgICAgaWYgYSBwcm9taXNlIHJldHVybmVkIGZyb20gYG1vZGVsYCBmYWlscywgdGhlIGVycm9yIHdpbGwgYmUKICAgICAgaGFuZGxlZCBieSB0aGUgYGVycm9yYCBob29rIG9uIGBSb3V0ZWAuCiAgICAgICAgIEV4YW1wbGUKICAgICAgICAgYGBgYXBwL3JvdXRlcy9wb3N0LmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIFBvc3RSb3V0ZSBleHRlbmRzIFJvdXRlIHsKICAgICAgICBtb2RlbChwYXJhbXMpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnN0b3JlLmZpbmRSZWNvcmQoJ3Bvc3QnLCBwYXJhbXMucG9zdF9pZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgICBAbWV0aG9kIG1vZGVsCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgdGhlIHBhcmFtZXRlcnMgZXh0cmFjdGVkIGZyb20gdGhlIFVSTAogICAgICBAcGFyYW0ge1RyYW5zaXRpb259IHRyYW5zaXRpb24KICAgICAgQHJldHVybiB7YW55IHwgUHJvbWlzZTxhbnk+fSB0aGUgbW9kZWwgZm9yIHRoaXMgcm91dGUuIElmCiAgICAgICAgYSBwcm9taXNlIGlzIHJldHVybmVkLCB0aGUgdHJhbnNpdGlvbiB3aWxsIHBhdXNlIHVudGlsCiAgICAgICAgdGhlIHByb21pc2UgcmVzb2x2ZXMsIGFuZCB0aGUgcmVzb2x2ZWQgdmFsdWUgb2YgdGhlIHByb21pc2UKICAgICAgICB3aWxsIGJlIHVzZWQgYXMgdGhlIG1vZGVsIGZvciB0aGlzIHJvdXRlLgogICAgICBAc2luY2UgMS4wLjAKICAgICAgQHB1YmxpYwogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ubW9kZWwgPSBmdW5jdGlvbiBtb2RlbChwYXJhbXMsIHRyYW5zaXRpb24pIHsKICAgICAgdmFyIG5hbWUsIHNhd1BhcmFtcywgdmFsdWU7CiAgICAgIHZhciBxdWVyeVBhcmFtcyA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAnX3FwLm1hcCcpOwoKICAgICAgZm9yICh2YXIgcHJvcCBpbiBwYXJhbXMpIHsKICAgICAgICBpZiAocHJvcCA9PT0gJ3F1ZXJ5UGFyYW1zJyB8fCBxdWVyeVBhcmFtcyAmJiBwcm9wIGluIHF1ZXJ5UGFyYW1zKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIHZhciBtYXRjaCA9IHByb3AubWF0Y2goL14oLiopX2lkJC8pOwoKICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwpIHsKICAgICAgICAgIG5hbWUgPSBtYXRjaFsxXTsKICAgICAgICAgIHZhbHVlID0gcGFyYW1zW3Byb3BdOwogICAgICAgIH0KCiAgICAgICAgc2F3UGFyYW1zID0gdHJ1ZTsKICAgICAgfQoKICAgICAgaWYgKCFuYW1lKSB7CiAgICAgICAgaWYgKHNhd1BhcmFtcykgewogICAgICAgICAgcmV0dXJuICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIHBhcmFtcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICh0cmFuc2l0aW9uLnJlc29sdmVJbmRleCA8IDEpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiB0cmFuc2l0aW9uW19yb3V0ZXJfanMuU1RBVEVfU1lNQk9MXS5yb3V0ZUluZm9zW3RyYW5zaXRpb24ucmVzb2x2ZUluZGV4IC0gMV0uY29udGV4dDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLmZpbmRNb2RlbChuYW1lLCB2YWx1ZSk7CiAgICB9CiAgICAvKioKICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBkZXNlcmlhbGl6ZQogICAgICBAcGFyYW0ge09iamVjdH0gcGFyYW1zIHRoZSBwYXJhbWV0ZXJzIGV4dHJhY3RlZCBmcm9tIHRoZSBVUkwKICAgICAgQHBhcmFtIHtUcmFuc2l0aW9ufSB0cmFuc2l0aW9uCiAgICAgIEByZXR1cm4ge2FueSB8IFByb21pc2U8YW55Pn0gdGhlIG1vZGVsIGZvciB0aGlzIHJvdXRlLgogICAgICAgICBSb3V0ZXIuanMgaG9vay4KICAgICAqLwogICAgOwoKICAgIF9wcm90by5kZXNlcmlhbGl6ZSA9IGZ1bmN0aW9uIGRlc2VyaWFsaXplKF9wYXJhbXMsIHRyYW5zaXRpb24pIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWwodGhpcy5fcGFyYW1zRm9yKHRoaXMucm91dGVOYW1lLCBfcGFyYW1zKSwgdHJhbnNpdGlvbik7CiAgICB9CiAgICAvKioKICAgICAgICAgQG1ldGhvZCBmaW5kTW9kZWwKICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgdGhlIG1vZGVsIHR5cGUKICAgICAgQHBhcmFtIHtPYmplY3R9IHZhbHVlIHRoZSB2YWx1ZSBwYXNzZWQgdG8gZmluZAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uZmluZE1vZGVsID0gZnVuY3Rpb24gZmluZE1vZGVsKCkgewogICAgICB2YXIgX2dldDsKCiAgICAgIHJldHVybiAoX2dldCA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAnc3RvcmUnKSkuZmluZC5hcHBseShfZ2V0LCBhcmd1bWVudHMpOwogICAgfQogICAgLyoqCiAgICAgIEEgaG9vayB5b3UgY2FuIHVzZSB0byBzZXR1cCB0aGUgY29udHJvbGxlciBmb3IgdGhlIGN1cnJlbnQgcm91dGUuCiAgICAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCB3aXRoIHRoZSBjb250cm9sbGVyIGZvciB0aGUgY3VycmVudCByb3V0ZSBhbmQgdGhlCiAgICAgIG1vZGVsIHN1cHBsaWVkIGJ5IHRoZSBgbW9kZWxgIGhvb2suCiAgICAgICAgIEJ5IGRlZmF1bHQsIHRoZSBgc2V0dXBDb250cm9sbGVyYCBob29rIHNldHMgdGhlIGBtb2RlbGAgcHJvcGVydHkgb2YKICAgICAgdGhlIGNvbnRyb2xsZXIgdG8gdGhlIHNwZWNpZmllZCBgbW9kZWxgIHdoZW4gaXQgaXMgbm90IGB1bmRlZmluZWRgLgogICAgICAgICBJZiB5b3UgaW1wbGVtZW50IHRoZSBgc2V0dXBDb250cm9sbGVyYCBob29rIGluIHlvdXIgUm91dGUsIGl0IHdpbGwKICAgICAgcHJldmVudCB0aGlzIGRlZmF1bHQgYmVoYXZpb3IuIElmIHlvdSB3YW50IHRvIHByZXNlcnZlIHRoYXQgYmVoYXZpb3IKICAgICAgd2hlbiBpbXBsZW1lbnRpbmcgeW91ciBgc2V0dXBDb250cm9sbGVyYCBmdW5jdGlvbiwgbWFrZSBzdXJlIHRvIGNhbGwKICAgICAgYHN1cGVyYDoKICAgICAgICAgYGBgYXBwL3JvdXRlcy9waG90b3MuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGhvdG9zUm91dGUgZXh0ZW5kZXMgUm91dGUgewogICAgICAgIG1vZGVsKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmUuZmluZEFsbCgncGhvdG8nKTsKICAgICAgICB9CiAgICAgICAgICAgc2V0dXBDb250cm9sbGVyKGNvbnRyb2xsZXIsIG1vZGVsKSB7CiAgICAgICAgICBzdXBlci5zZXR1cENvbnRyb2xsZXIoY29udHJvbGxlciwgbW9kZWwpOwogICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyRm9yKCdhcHBsaWNhdGlvbicpLnNldCgnc2hvd2luZ1Bob3RvcycsIHRydWUpOwogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgICAgVGhlIHByb3ZpZGVkIGNvbnRyb2xsZXIgd2lsbCBiZSBvbmUgcmVzb2x2ZWQgYmFzZWQgb24gdGhlIG5hbWUKICAgICAgb2YgdGhpcyByb3V0ZS4KICAgICAgICAgSWYgbm8gZXhwbGljaXQgY29udHJvbGxlciBpcyBkZWZpbmVkLCBFbWJlciB3aWxsIGF1dG9tYXRpY2FsbHkgY3JlYXRlIG9uZS4KICAgICAgICAgQXMgYW4gZXhhbXBsZSwgY29uc2lkZXIgdGhlIHJvdXRlcjoKICAgICAgICAgYGBgYXBwL3JvdXRlci5qcwogICAgICAvLyAuLi4KICAgICAgICAgUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJvdXRlKCdwb3N0JywgeyBwYXRoOiAnL3Bvc3RzLzpwb3N0X2lkJyB9KTsKICAgICAgfSk7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlcjsKICAgICAgYGBgCiAgICAgICAgIElmIHlvdSBoYXZlIGRlZmluZWQgYSBmaWxlIGZvciB0aGUgcG9zdCBjb250cm9sbGVyLAogICAgICB0aGUgZnJhbWV3b3JrIHdpbGwgdXNlIGl0LgogICAgICBJZiBpdCBpcyBub3QgZGVmaW5lZCwgYSBiYXNpYyBgQ29udHJvbGxlcmAgaW5zdGFuY2Ugd291bGQgYmUgdXNlZC4KICAgICAgICAgQGV4YW1wbGUgQmVoYXZpb3Igb2YgYSBiYXNpYyBDb250cm9sbGVyCiAgICAgICAgIGBgYGFwcC9yb3V0ZXMvcG9zdC5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBQb3N0Um91dGUgZXh0ZW5kcyBSb3V0ZSB7CiAgICAgICAgc2V0dXBDb250cm9sbGVyKGNvbnRyb2xsZXIsIG1vZGVsKSB7CiAgICAgICAgICBjb250cm9sbGVyLnNldCgnbW9kZWwnLCBtb2RlbCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICAgIEBtZXRob2Qgc2V0dXBDb250cm9sbGVyCiAgICAgIEBwYXJhbSB7Q29udHJvbGxlcn0gY29udHJvbGxlciBpbnN0YW5jZQogICAgICBAcGFyYW0ge09iamVjdH0gbW9kZWwKICAgICAgQHNpbmNlIDEuMC4wCiAgICAgIEBwdWJsaWMKICAgICovCiAgICA7CgogICAgX3Byb3RvLnNldHVwQ29udHJvbGxlciA9IGZ1bmN0aW9uIHNldHVwQ29udHJvbGxlcihjb250cm9sbGVyLCBjb250ZXh0LCBfdHJhbnNpdGlvbikgewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVudXNlZC12YXJzCiAgICAgIGlmIChjb250cm9sbGVyICYmIGNvbnRleHQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICgwLCBfbWV0YWwuc2V0KShjb250cm9sbGVyLCAnbW9kZWwnLCBjb250ZXh0KTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgIFJldHVybnMgdGhlIGNvbnRyb2xsZXIgb2YgdGhlIGN1cnJlbnQgcm91dGUsIG9yIGEgcGFyZW50IChvciBhbnkgYW5jZXN0b3IpCiAgICAgIHJvdXRlIGluIGEgcm91dGUgaGllcmFyY2h5LgogICAgICAgICBUaGUgY29udHJvbGxlciBpbnN0YW5jZSBtdXN0IGFscmVhZHkgaGF2ZSBiZWVuIGNyZWF0ZWQsIGVpdGhlciB0aHJvdWdoIGVudGVyaW5nIHRoZQogICAgICBhc3NvY2lhdGVkIHJvdXRlIG9yIHVzaW5nIGBnZW5lcmF0ZUNvbnRyb2xsZXJgLgogICAgICAgICBgYGBhcHAvcm91dGVzL3Bvc3QuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgUG9zdFJvdXRlIGV4dGVuZHMgUm91dGUgewogICAgICAgIHNldHVwQ29udHJvbGxlcihjb250cm9sbGVyLCBwb3N0KSB7CiAgICAgICAgICBzdXBlci5zZXR1cENvbnRyb2xsZXIoY29udHJvbGxlciwgcG9zdCk7CiAgICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXJGb3IoJ3Bvc3RzJykuc2V0KCdjdXJyZW50UG9zdCcsIHBvc3QpOwogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgICAgQG1ldGhvZCBjb250cm9sbGVyRm9yCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIHRoZSBuYW1lIG9mIHRoZSByb3V0ZSBvciBjb250cm9sbGVyCiAgICAgIEByZXR1cm4ge0NvbnRyb2xsZXJ9CiAgICAgIEBzaW5jZSAxLjAuMAogICAgICBAcHVibGljCiAgICAqLwogICAgOwoKICAgIF9wcm90by5jb250cm9sbGVyRm9yID0gZnVuY3Rpb24gY29udHJvbGxlckZvcihuYW1lLCBfc2tpcEFzc2VydCkgewogICAgICB2YXIgb3duZXIgPSAoMCwgX293bmVyLmdldE93bmVyKSh0aGlzKTsKICAgICAgdmFyIHJvdXRlID0gb3duZXIubG9va3VwKCJyb3V0ZToiICsgbmFtZSk7CgogICAgICBpZiAocm91dGUgJiYgcm91dGUuY29udHJvbGxlck5hbWUpIHsKICAgICAgICBuYW1lID0gcm91dGUuY29udHJvbGxlck5hbWU7CiAgICAgIH0KCiAgICAgIHZhciBjb250cm9sbGVyID0gb3duZXIubG9va3VwKCJjb250cm9sbGVyOiIgKyBuYW1lKTsgLy8gTk9URTogV2UncmUgc3BlY2lmaWNhbGx5IGNoZWNraW5nIHRoYXQgc2tpcEFzc2VydCBpcyB0cnVlLCBiZWNhdXNlIGFjY29yZGluZwogICAgICAvLyAgIHRvIHRoZSBvbGQgQVBJIHRoZSBzZWNvbmQgcGFyYW1ldGVyIHdhcyBtb2RlbC4gV2UgZG8gbm90IHdhbnQgcGVvcGxlIHdobwogICAgICAvLyAgIHBhc3NlZCBhIG1vZGVsIHRvIHNraXAgdGhlIGFzc2VydGlvbi4KCiAgICAgIChmYWxzZSAmJiAhKGNvbnRyb2xsZXIgIT09IHVuZGVmaW5lZCB8fCBfc2tpcEFzc2VydCA9PT0gdHJ1ZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJUaGUgY29udHJvbGxlciBuYW1lZCAnIiArIG5hbWUgKyAiJyBjb3VsZCBub3QgYmUgZm91bmQuIE1ha2Ugc3VyZSB0aGF0IHRoaXMgcm91dGUgZXhpc3RzIGFuZCBoYXMgYWxyZWFkeSBiZWVuIGVudGVyZWQgYXQgbGVhc3Qgb25jZS4gSWYgeW91IGFyZSBhY2Nlc3NpbmcgYSBjb250cm9sbGVyIG5vdCBhc3NvY2lhdGVkIHdpdGggYSByb3V0ZSwgbWFrZSBzdXJlIHRoZSBjb250cm9sbGVyIGNsYXNzIGlzIGV4cGxpY2l0bHkgZGVmaW5lZC4iLCBjb250cm9sbGVyICE9PSB1bmRlZmluZWQgfHwgX3NraXBBc3NlcnQgPT09IHRydWUpKTsKICAgICAgcmV0dXJuIGNvbnRyb2xsZXI7CiAgICB9CiAgICAvKioKICAgICAgR2VuZXJhdGVzIGEgY29udHJvbGxlciBmb3IgYSByb3V0ZS4KICAgICAgICAgRXhhbXBsZQogICAgICAgICBgYGBhcHAvcm91dGVzL3Bvc3QuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgUG9zdCBleHRlbmRzIFJvdXRlIHsKICAgICAgICBzZXR1cENvbnRyb2xsZXIoY29udHJvbGxlciwgcG9zdCkgewogICAgICAgICAgc3VwZXIuc2V0dXBDb250cm9sbGVyKGNvbnRyb2xsZXIsIHBvc3QpOwogICAgICAgICAgICAgdGhpcy5nZW5lcmF0ZUNvbnRyb2xsZXIoJ3Bvc3RzJyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgICBAbWV0aG9kIGdlbmVyYXRlQ29udHJvbGxlcgogICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgY29udHJvbGxlcgogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uZ2VuZXJhdGVDb250cm9sbGVyID0gZnVuY3Rpb24gZ2VuZXJhdGVDb250cm9sbGVyKG5hbWUpIHsKICAgICAgdmFyIG93bmVyID0gKDAsIF9vd25lci5nZXRPd25lcikodGhpcyk7CiAgICAgIHJldHVybiAoMCwgX2dlbmVyYXRlX2NvbnRyb2xsZXIuZGVmYXVsdCkob3duZXIsIG5hbWUpOwogICAgfQogICAgLyoqCiAgICAgIFJldHVybnMgdGhlIHJlc29sdmVkIG1vZGVsIG9mIGEgcGFyZW50IChvciBhbnkgYW5jZXN0b3IpIHJvdXRlCiAgICAgIGluIGEgcm91dGUgaGllcmFyY2h5LiAgRHVyaW5nIGEgdHJhbnNpdGlvbiwgYWxsIHJvdXRlcwogICAgICBtdXN0IHJlc29sdmUgYSBtb2RlbCBvYmplY3QsIGFuZCBpZiBhIHJvdXRlCiAgICAgIG5lZWRzIGFjY2VzcyB0byBhIHBhcmVudCByb3V0ZSdzIG1vZGVsIGluIG9yZGVyIHRvCiAgICAgIHJlc29sdmUgYSBtb2RlbCAob3IganVzdCByZXVzZSB0aGUgbW9kZWwgZnJvbSBhIHBhcmVudCksCiAgICAgIGl0IGNhbiBjYWxsIGB0aGlzLm1vZGVsRm9yKHRoZU5hbWVPZlBhcmVudFJvdXRlKWAgdG8KICAgICAgcmV0cmlldmUgaXQuIElmIHRoZSBhbmNlc3RvciByb3V0ZSdzIG1vZGVsIHdhcyBhIHByb21pc2UsCiAgICAgIGl0cyByZXNvbHZlZCByZXN1bHQgaXMgcmV0dXJuZWQuCiAgICAgICAgIEV4YW1wbGUKICAgICAgICAgYGBgYXBwL3JvdXRlci5qcwogICAgICAvLyAuLi4KICAgICAgICAgUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJvdXRlKCdwb3N0JywgeyBwYXRoOiAnL3Bvc3RzLzpwb3N0X2lkJyB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgIHRoaXMucm91dGUoJ2NvbW1lbnRzJyk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZXI7CiAgICAgIGBgYAogICAgICAgICBgYGBhcHAvcm91dGVzL3Bvc3QvY29tbWVudHMuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgUG9zdENvbW1lbnRzUm91dGUgZXh0ZW5kcyBSb3V0ZSB7CiAgICAgICAgbW9kZWwoKSB7CiAgICAgICAgICBsZXQgcG9zdCA9IHRoaXMubW9kZWxGb3IoJ3Bvc3QnKTsKICAgICAgICAgICAgIHJldHVybiBwb3N0LmNvbW1lbnRzOwogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgICAgQG1ldGhvZCBtb2RlbEZvcgogICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgcm91dGUKICAgICAgQHJldHVybiB7T2JqZWN0fSB0aGUgbW9kZWwgb2JqZWN0CiAgICAgIEBzaW5jZSAxLjAuMAogICAgICBAcHVibGljCiAgICAqLwogICAgOwoKICAgIF9wcm90by5tb2RlbEZvciA9IGZ1bmN0aW9uIG1vZGVsRm9yKF9uYW1lKSB7CiAgICAgIHZhciBuYW1lOwogICAgICB2YXIgb3duZXIgPSAoMCwgX293bmVyLmdldE93bmVyKSh0aGlzKTsKICAgICAgdmFyIHRyYW5zaXRpb24gPSB0aGlzLl9yb3V0ZXIgJiYgdGhpcy5fcm91dGVyLl9yb3V0ZXJNaWNyb2xpYiA/IHRoaXMuX3JvdXRlci5fcm91dGVyTWljcm9saWIuYWN0aXZlVHJhbnNpdGlvbiA6IHVuZGVmaW5lZDsgLy8gT25seSBjaGFuZ2UgdGhlIHJvdXRlIG5hbWUgd2hlbiB0aGVyZSBpcyBhbiBhY3RpdmUgdHJhbnNpdGlvbi4KICAgICAgLy8gT3RoZXJ3aXNlLCB1c2UgdGhlIHBhc3NlZCBpbiByb3V0ZSBuYW1lLgoKICAgICAgaWYgKG93bmVyLnJvdXRhYmxlICYmIHRyYW5zaXRpb24gIT09IHVuZGVmaW5lZCkgewogICAgICAgIG5hbWUgPSBnZXRFbmdpbmVSb3V0ZU5hbWUob3duZXIsIF9uYW1lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBuYW1lID0gX25hbWU7CiAgICAgIH0KCiAgICAgIHZhciByb3V0ZSA9IG93bmVyLmxvb2t1cCgicm91dGU6IiArIG5hbWUpOyAvLyBJZiB3ZSBhcmUgbWlkLXRyYW5zaXRpb24sIHdlIHdhbnQgdG8gdHJ5IGFuZCBsb29rIHVwCiAgICAgIC8vIHJlc29sdmVkIHBhcmVudCBjb250ZXh0cyBvbiB0aGUgY3VycmVudCB0cmFuc2l0aW9uRXZlbnQuCgogICAgICBpZiAodHJhbnNpdGlvbiAhPT0gdW5kZWZpbmVkICYmIHRyYW5zaXRpb24gIT09IG51bGwpIHsKICAgICAgICB2YXIgbW9kZWxMb29rdXBOYW1lID0gcm91dGUgJiYgcm91dGUucm91dGVOYW1lIHx8IG5hbWU7CgogICAgICAgIGlmICh0cmFuc2l0aW9uLnJlc29sdmVkTW9kZWxzLmhhc093blByb3BlcnR5KG1vZGVsTG9va3VwTmFtZSkpIHsKICAgICAgICAgIHJldHVybiB0cmFuc2l0aW9uLnJlc29sdmVkTW9kZWxzW21vZGVsTG9va3VwTmFtZV07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gcm91dGUgJiYgcm91dGUuY3VycmVudE1vZGVsOwogICAgfQogICAgLyoqCiAgICAgIEEgaG9vayB5b3UgY2FuIHVzZSB0byByZW5kZXIgdGhlIHRlbXBsYXRlIGZvciB0aGUgY3VycmVudCByb3V0ZS4KICAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIHdpdGggdGhlIGNvbnRyb2xsZXIgZm9yIHRoZSBjdXJyZW50IHJvdXRlIGFuZCB0aGUKICAgICAgbW9kZWwgc3VwcGxpZWQgYnkgdGhlIGBtb2RlbGAgaG9vay4gQnkgZGVmYXVsdCwgaXQgcmVuZGVycyB0aGUgcm91dGUncwogICAgICB0ZW1wbGF0ZSwgY29uZmlndXJlZCB3aXRoIHRoZSBjb250cm9sbGVyIGZvciB0aGUgcm91dGUuCiAgICAgICAgIFRoaXMgbWV0aG9kIGNhbiBiZSBvdmVycmlkZGVuIHRvIHNldCB1cCBhbmQgcmVuZGVyIGFkZGl0aW9uYWwgb3IKICAgICAgYWx0ZXJuYXRpdmUgdGVtcGxhdGVzLgogICAgICAgICBgYGBhcHAvcm91dGVzL3Bvc3RzLmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIFBvc3RzUm91dGUgZXh0ZW5kcyBSb3V0ZSB7CiAgICAgICAgcmVuZGVyVGVtcGxhdGUoY29udHJvbGxlciwgbW9kZWwpIHsKICAgICAgICAgIGxldCBmYXZDb250cm9sbGVyID0gdGhpcy5jb250cm9sbGVyRm9yKCdmYXZvcml0ZVBvc3QnKTsKICAgICAgICAgICAgIC8vIFJlbmRlciB0aGUgYGZhdm9yaXRlUG9zdGAgdGVtcGxhdGUgaW50bwogICAgICAgICAgLy8gdGhlIG91dGxldCBgcG9zdHNgLCBhbmQgZGlzcGxheSB0aGUgYGZhdm9yaXRlUG9zdGAKICAgICAgICAgIC8vIGNvbnRyb2xsZXIuCiAgICAgICAgICB0aGlzLnJlbmRlcignZmF2b3JpdGVQb3N0JywgewogICAgICAgICAgICBvdXRsZXQ6ICdwb3N0cycsCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IGZhdkNvbnRyb2xsZXIKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgICAgQG1ldGhvZCByZW5kZXJUZW1wbGF0ZQogICAgICBAcGFyYW0ge09iamVjdH0gY29udHJvbGxlciB0aGUgcm91dGUncyBjb250cm9sbGVyCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2RlbCB0aGUgcm91dGUncyBtb2RlbAogICAgICBAc2luY2UgMS4wLjAKICAgICAgQHB1YmxpYwogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucmVuZGVyVGVtcGxhdGUgPSBmdW5jdGlvbiByZW5kZXJUZW1wbGF0ZShfY29udHJvbGxlciwgX21vZGVsKSB7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW51c2VkLXZhcnMKICAgICAgdGhpcy5yZW5kZXIoKTsKICAgIH0KICAgIC8qKgogICAgICBgcmVuZGVyYCBpcyB1c2VkIHRvIHJlbmRlciBhIHRlbXBsYXRlIGludG8gYSByZWdpb24gb2YgYW5vdGhlciB0ZW1wbGF0ZQogICAgICAoaW5kaWNhdGVkIGJ5IGFuIGB7e291dGxldH19YCkuIGByZW5kZXJgIGlzIHVzZWQgYm90aCBkdXJpbmcgdGhlIGVudHJ5CiAgICAgIHBoYXNlIG9mIHJvdXRpbmcgKHZpYSB0aGUgYHJlbmRlclRlbXBsYXRlYCBob29rKSBhbmQgbGF0ZXIgaW4gcmVzcG9uc2UgdG8KICAgICAgdXNlciBpbnRlcmFjdGlvbi4KICAgICAgICAgRm9yIGV4YW1wbGUsIGdpdmVuIHRoZSBmb2xsb3dpbmcgbWluaW1hbCByb3V0ZXIgYW5kIHRlbXBsYXRlczoKICAgICAgICAgYGBgYXBwL3JvdXRlci5qcwogICAgICAvLyAuLi4KICAgICAgICAgUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJvdXRlKCdwaG90b3MnKTsKICAgICAgfSk7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlcjsKICAgICAgYGBgCiAgICAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAgPCEtLSBhcHBsaWNhdGlvbi5oYnMgLS0+CiAgICAgIDxkaXYgY2xhc3M9J3NvbWV0aGluZy1pbi10aGUtYXBwLWhicyc+CiAgICAgICAge3tvdXRsZXQgImFuT3V0bGV0TmFtZSJ9fQogICAgICA8L2Rpdj4KICAgICAgYGBgCiAgICAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAgPCEtLSBwaG90b3MuaGJzIC0tPgogICAgICA8aDE+UGhvdG9zPC9oMT4KICAgICAgYGBgCiAgICAgICAgIFlvdSBjYW4gcmVuZGVyIGBwaG90b3MuaGJzYCBpbnRvIHRoZSBgImFuT3V0bGV0TmFtZSJgIG91dGxldCBvZgogICAgICBgYXBwbGljYXRpb24uaGJzYCBieSBjYWxsaW5nIGByZW5kZXJgOgogICAgICAgICBgYGBhcHAvcm91dGVzL3Bvc3QuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgUG9zdFJvdXRlIGV4dGVuZHMgUm91dGUgewogICAgICAgIHJlbmRlclRlbXBsYXRlKCkgewogICAgICAgICAgdGhpcy5yZW5kZXIoJ3Bob3RvcycsIHsKICAgICAgICAgICAgaW50bzogJ2FwcGxpY2F0aW9uJywKICAgICAgICAgICAgb3V0bGV0OiAnYW5PdXRsZXROYW1lJwogICAgICAgICAgfSkKICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICAgIGByZW5kZXJgIGFkZGl0aW9uYWxseSBhbGxvd3MgeW91IHRvIHN1cHBseSB3aGljaCBgY29udHJvbGxlcmAgYW5kCiAgICAgIGBtb2RlbGAgb2JqZWN0cyBzaG91bGQgYmUgbG9hZGVkIGFuZCBhc3NvY2lhdGVkIHdpdGggdGhlIHJlbmRlcmVkIHRlbXBsYXRlLgogICAgICAgICBgYGBhcHAvcm91dGVzL3Bvc3RzLmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIFBvc3RzUm91dGUgZXh0ZW5kcyBSb3V0ZSB7CiAgICAgICAgcmVuZGVyVGVtcGxhdGUoY29udHJvbGxlciwgbW9kZWwpewogICAgICAgICAgdGhpcy5yZW5kZXIoJ3Bvc3RzJywgeyAgICAvLyB0aGUgdGVtcGxhdGUgdG8gcmVuZGVyLCByZWZlcmVuY2VkIGJ5IG5hbWUKICAgICAgICAgICAgaW50bzogJ2FwcGxpY2F0aW9uJywgICAgLy8gdGhlIHRlbXBsYXRlIHRvIHJlbmRlciBpbnRvLCByZWZlcmVuY2VkIGJ5IG5hbWUKICAgICAgICAgICAgb3V0bGV0OiAnYW5PdXRsZXROYW1lJywgLy8gdGhlIG91dGxldCBpbnNpZGUgYG9wdGlvbnMuaW50b2AgdG8gcmVuZGVyIGludG8uCiAgICAgICAgICAgIGNvbnRyb2xsZXI6ICdzb21lQ29udHJvbGxlck5hbWUnLCAvLyB0aGUgY29udHJvbGxlciB0byB1c2UgZm9yIHRoaXMgdGVtcGxhdGUsIHJlZmVyZW5jZWQgYnkgbmFtZQogICAgICAgICAgICBtb2RlbDogbW9kZWwgICAgICAgICAgICAvLyB0aGUgbW9kZWwgdG8gc2V0IG9uIGBvcHRpb25zLmNvbnRyb2xsZXJgLgogICAgICAgICAgfSkKICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICAgIFRoZSBzdHJpbmcgdmFsdWVzIHByb3ZpZGVkIGZvciB0aGUgdGVtcGxhdGUgbmFtZSwgYW5kIGNvbnRyb2xsZXIKICAgICAgd2lsbCBldmVudHVhbGx5IHBhc3MgdGhyb3VnaCB0byB0aGUgcmVzb2x2ZXIgZm9yIGxvb2t1cC4gU2VlCiAgICAgIFJlc29sdmVyIGZvciBob3cgdGhlc2UgYXJlIG1hcHBlZCB0byBKYXZhU2NyaXB0IG9iamVjdHMgaW4geW91cgogICAgICBhcHBsaWNhdGlvbi4gVGhlIHRlbXBsYXRlIHRvIHJlbmRlciBpbnRvIG5lZWRzIHRvIGJlIHJlbGF0ZWQgdG8gIGVpdGhlciB0aGUKICAgICAgY3VycmVudCByb3V0ZSBvciBvbmUgb2YgaXRzIGFuY2VzdG9ycy4KICAgICAgICAgTm90IGFsbCBvcHRpb25zIG5lZWQgdG8gYmUgcGFzc2VkIHRvIGByZW5kZXJgLiBEZWZhdWx0IHZhbHVlcyB3aWxsIGJlIHVzZWQKICAgICAgYmFzZWQgb24gdGhlIG5hbWUgb2YgdGhlIHJvdXRlIHNwZWNpZmllZCBpbiB0aGUgcm91dGVyIG9yIHRoZSBSb3V0ZSdzCiAgICAgIGBjb250cm9sbGVyTmFtZWAgYW5kIGB0ZW1wbGF0ZU5hbWVgIHByb3BlcnRpZXMuCiAgICAgICAgIEZvciBleGFtcGxlOgogICAgICAgICBgYGBhcHAvcm91dGVyLmpzCiAgICAgIC8vIC4uLgogICAgICAgICBSb3V0ZXIubWFwKGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucm91dGUoJ2luZGV4Jyk7CiAgICAgICAgdGhpcy5yb3V0ZSgncG9zdCcsIHsgcGF0aDogJy9wb3N0cy86cG9zdF9pZCcgfSk7CiAgICAgIH0pOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZXI7CiAgICAgIGBgYAogICAgICAgICBgYGBhcHAvcm91dGVzL3Bvc3QuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgUG9zdFJvdXRlIGV4dGVuZHMgUm91dGUgewogICAgICAgIHJlbmRlclRlbXBsYXRlKCkgewogICAgICAgICAgdGhpcy5yZW5kZXIoKTsgLy8gYWxsIGRlZmF1bHRzIGFwcGx5CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgICBUaGUgbmFtZSBvZiB0aGUgcm91dGUsIGRlZmluZWQgYnkgdGhlIHJvdXRlciwgaXMgYHBvc3RgLgogICAgICAgICBUaGUgZm9sbG93aW5nIGVxdWl2YWxlbnQgZGVmYXVsdCBvcHRpb25zIHdpbGwgYmUgYXBwbGllZCB3aGVuCiAgICAgIHRoZSBSb3V0ZSBjYWxscyBgcmVuZGVyYDoKICAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICB0aGlzLnJlbmRlcigncG9zdCcsIHsgIC8vIHRoZSB0ZW1wbGF0ZSBuYW1lIGFzc29jaWF0ZWQgd2l0aCAncG9zdCcgUm91dGUKICAgICAgICBpbnRvOiAnYXBwbGljYXRpb24nLCAvLyB0aGUgcGFyZW50IHJvdXRlIHRvICdwb3N0JyBSb3V0ZQogICAgICAgIG91dGxldDogJ21haW4nLCAgICAgIC8vIHt7b3V0bGV0fX0gYW5kIHt7b3V0bGV0ICdtYWluJ319IGFyZSBzeW5vbnltb3VzLAogICAgICAgIGNvbnRyb2xsZXI6ICdwb3N0JywgIC8vIHRoZSBjb250cm9sbGVyIGFzc29jaWF0ZWQgd2l0aCB0aGUgJ3Bvc3QnIFJvdXRlCiAgICAgIH0pCiAgICAgIGBgYAogICAgICAgICBCeSBkZWZhdWx0IHRoZSBjb250cm9sbGVyJ3MgYG1vZGVsYCB3aWxsIGJlIHRoZSByb3V0ZSdzIG1vZGVsLCBzbyBpdCBkb2VzIG5vdAogICAgICBuZWVkIHRvIGJlIHBhc3NlZCB1bmxlc3MgeW91IHdpc2ggdG8gY2hhbmdlIHdoaWNoIG1vZGVsIGlzIGJlaW5nIHVzZWQuCiAgICAgICAgIEBtZXRob2QgcmVuZGVyCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIHRoZSBuYW1lIG9mIHRoZSB0ZW1wbGF0ZSB0byByZW5kZXIKICAgICAgQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSB0aGUgb3B0aW9ucwogICAgICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMuaW50b10gdGhlIHRlbXBsYXRlIHRvIHJlbmRlciBpbnRvLAogICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlZCBieSBuYW1lLiBEZWZhdWx0cyB0byB0aGUgcGFyZW50IHRlbXBsYXRlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy5vdXRsZXRdIHRoZSBvdXRsZXQgaW5zaWRlIGBvcHRpb25zLmludG9gIHRvIHJlbmRlciBpbnRvLgogICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdHMgdG8gJ21haW4nCiAgICAgIEBwYXJhbSB7U3RyaW5nfE9iamVjdH0gW29wdGlvbnMuY29udHJvbGxlcl0gdGhlIGNvbnRyb2xsZXIgdG8gdXNlIGZvciB0aGlzIHRlbXBsYXRlLAogICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlZCBieSBuYW1lIG9yIGFzIGEgY29udHJvbGxlciBpbnN0YW5jZS4gRGVmYXVsdHMgdG8gdGhlIFJvdXRlJ3MgcGFpcmVkIGNvbnRyb2xsZXIKICAgICAgQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zLm1vZGVsXSB0aGUgbW9kZWwgb2JqZWN0IHRvIHNldCBvbiBgb3B0aW9ucy5jb250cm9sbGVyYC4KICAgICAgICAgICAgICAgICAgICAgIERlZmF1bHRzIHRvIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIFJvdXRlJ3MgbW9kZWwgaG9vawogICAgICBAc2luY2UgMS4wLjAKICAgICAgQHB1YmxpYwogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucmVuZGVyID0gZnVuY3Rpb24gcmVuZGVyKF9uYW1lLCBvcHRpb25zKSB7CiAgICAgIHZhciBuYW1lOwogICAgICB2YXIgaXNEZWZhdWx0UmVuZGVyID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMDsKCiAgICAgIGlmICghaXNEZWZhdWx0UmVuZGVyKSB7CiAgICAgICAgaWYgKHR5cGVvZiBfbmFtZSA9PT0gJ29iamVjdCcgJiYgIW9wdGlvbnMpIHsKICAgICAgICAgIG5hbWUgPSB0aGlzLnRlbXBsYXRlTmFtZSB8fCB0aGlzLnJvdXRlTmFtZTsKICAgICAgICAgIG9wdGlvbnMgPSBfbmFtZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgKGZhbHNlICYmICEoISgwLCBfbWV0YWwuaXNFbXB0eSkoX25hbWUpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1RoZSBuYW1lIGluIHRoZSBnaXZlbiBhcmd1bWVudHMgaXMgdW5kZWZpbmVkIG9yIGVtcHR5IHN0cmluZycsICEoMCwgX21ldGFsLmlzRW1wdHkpKF9uYW1lKSkpOwogICAgICAgICAgbmFtZSA9IF9uYW1lOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIHJlbmRlck9wdGlvbnMgPSBidWlsZFJlbmRlck9wdGlvbnModGhpcywgaXNEZWZhdWx0UmVuZGVyLCBuYW1lLCBvcHRpb25zKTsKICAgICAgUk9VVEVfQ09OTkVDVElPTlMuZ2V0KHRoaXMpLnB1c2gocmVuZGVyT3B0aW9ucyk7CiAgICAgICgwLCBfcnVubG9vcC5vbmNlKSh0aGlzLl9yb3V0ZXIsICdfc2V0T3V0bGV0cycpOwogICAgfQogICAgLyoqCiAgICAgIERpc2Nvbm5lY3RzIGEgdmlldyB0aGF0IGhhcyBiZWVuIHJlbmRlcmVkIGludG8gYW4gb3V0bGV0LgogICAgICAgICBZb3UgbWF5IHBhc3MgYW55IG9yIGFsbCBvZiB0aGUgZm9sbG93aW5nIG9wdGlvbnMgdG8gYGRpc2Nvbm5lY3RPdXRsZXRgOgogICAgICAgICAqIGBvdXRsZXRgOiB0aGUgbmFtZSBvZiB0aGUgb3V0bGV0IHRvIGNsZWFyIChkZWZhdWx0OiAnbWFpbicpCiAgICAgICogYHBhcmVudFZpZXdgOiB0aGUgbmFtZSBvZiB0aGUgdmlldyBjb250YWluaW5nIHRoZSBvdXRsZXQgdG8gY2xlYXIKICAgICAgICAgKGRlZmF1bHQ6IHRoZSB2aWV3IHJlbmRlcmVkIGJ5IHRoZSBwYXJlbnQgcm91dGUpCiAgICAgICAgIEV4YW1wbGU6CiAgICAgICAgIGBgYGFwcC9yb3V0ZXMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgaW1wb3J0IHsgYWN0aW9uIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIEFwcGxpY2F0aW9uUm91dGUgZXh0ZW5kcyBSb3V0ZSB7CiAgICAgICAgQGFjdGlvbgogICAgICAgIHNob3dNb2RhbChldnQpIHsKICAgICAgICAgIHRoaXMucmVuZGVyKGV2dC5tb2RhbE5hbWUsIHsKICAgICAgICAgICAgb3V0bGV0OiAnbW9kYWwnLAogICAgICAgICAgICBpbnRvOiAnYXBwbGljYXRpb24nCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgICAgQGFjdGlvbgogICAgICAgIGhpZGVNb2RhbCgpIHsKICAgICAgICAgIHRoaXMuZGlzY29ubmVjdE91dGxldCh7CiAgICAgICAgICAgIG91dGxldDogJ21vZGFsJywKICAgICAgICAgICAgcGFyZW50VmlldzogJ2FwcGxpY2F0aW9uJwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgICBBbHRlcm5hdGl2ZWx5LCB5b3UgY2FuIHBhc3MgdGhlIGBvdXRsZXRgIG5hbWUgZGlyZWN0bHkgYXMgYSBzdHJpbmcuCiAgICAgICAgIEV4YW1wbGU6CiAgICAgICAgIGBgYGFwcC9yb3V0ZXMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgaW1wb3J0IHsgYWN0aW9uIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIEFwcGxpY2F0aW9uUm91dGUgZXh0ZW5kcyBSb3V0ZSB7CiAgICAgICAgQGFjdGlvbgogICAgICAgIHNob3dNb2RhbChldnQpIHsKICAgICAgICAgIC8vIC4uLgogICAgICAgIH0KICAgICAgICAgICBAYWN0aW9uCiAgICAgICAgaGlkZU1vZGFsKGV2dCkgewogICAgICAgICAgdGhpcy5kaXNjb25uZWN0T3V0bGV0KCdtb2RhbCcpOwogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgICAgQG1ldGhvZCBkaXNjb25uZWN0T3V0bGV0CiAgICAgIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gb3B0aW9ucyB0aGUgb3B0aW9ucyBoYXNoIG9yIG91dGxldCBuYW1lCiAgICAgIEBzaW5jZSAxLjAuMAogICAgICBAcHVibGljCiAgICAqLwogICAgOwoKICAgIF9wcm90by5kaXNjb25uZWN0T3V0bGV0ID0gZnVuY3Rpb24gZGlzY29ubmVjdE91dGxldChvcHRpb25zKSB7CiAgICAgIHZhciBvdXRsZXROYW1lOwogICAgICB2YXIgcGFyZW50VmlldzsKCiAgICAgIGlmIChvcHRpb25zKSB7CiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJykgewogICAgICAgICAgb3V0bGV0TmFtZSA9IG9wdGlvbnM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG91dGxldE5hbWUgPSBvcHRpb25zLm91dGxldDsKICAgICAgICAgIHBhcmVudFZpZXcgPSBvcHRpb25zLnBhcmVudFZpZXcgPyBvcHRpb25zLnBhcmVudFZpZXcucmVwbGFjZSgvXC8vZywgJy4nKSA6IHVuZGVmaW5lZDsKICAgICAgICAgIChmYWxzZSAmJiAhKCEoJ291dGxldCcgaW4gb3B0aW9ucyAmJiBvcHRpb25zLm91dGxldCA9PT0gdW5kZWZpbmVkKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgcGFzc2VkIHVuZGVmaW5lZCBhcyB0aGUgb3V0bGV0IG5hbWUuJywgISgnb3V0bGV0JyBpbiBvcHRpb25zICYmIG9wdGlvbnMub3V0bGV0ID09PSB1bmRlZmluZWQpKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBvdXRsZXROYW1lID0gb3V0bGV0TmFtZSB8fCAnbWFpbic7CgogICAgICB0aGlzLl9kaXNjb25uZWN0T3V0bGV0KG91dGxldE5hbWUsIHBhcmVudFZpZXcpOwoKICAgICAgdmFyIHJvdXRlSW5mb3MgPSB0aGlzLl9yb3V0ZXIuX3JvdXRlck1pY3JvbGliLmN1cnJlbnRSb3V0ZUluZm9zOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByb3V0ZUluZm9zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgLy8gVGhpcyBub24tbG9jYWwgc3RhdGUgbXVuZ2luZyBpcyBzYWRseSBuZWNlc3NhcnkgdG8gbWFpbnRhaW4KICAgICAgICAvLyBiYWNrd2FyZCBjb21wYXRpYmlsaXR5IHdpdGggb3VyIGV4aXN0aW5nIHNlbWFudGljcywgd2hpY2ggYWxsb3cKICAgICAgICAvLyBhbnkgcm91dGUgdG8gZGlzY29ubmVjdE91dGxldCB0aGluZ3Mgb3JpZ2luYWxseSByZW5kZXJlZCBieSBhbnkKICAgICAgICAvLyBvdGhlciByb3V0ZS4gVGhpcyBzaG91bGQgYWxsIGdldCBjdXQgaW4gMi4wLgogICAgICAgIHJvdXRlSW5mb3NbaV0ucm91dGUuX2Rpc2Nvbm5lY3RPdXRsZXQob3V0bGV0TmFtZSwgcGFyZW50Vmlldyk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLl9kaXNjb25uZWN0T3V0bGV0ID0gZnVuY3Rpb24gX2Rpc2Nvbm5lY3RPdXRsZXQob3V0bGV0TmFtZSwgcGFyZW50VmlldykgewogICAgICB2YXIgcGFyZW50ID0gcGFyZW50Um91dGUodGhpcyk7CgogICAgICBpZiAocGFyZW50ICYmIHBhcmVudFZpZXcgPT09IHBhcmVudC5yb3V0ZU5hbWUpIHsKICAgICAgICBwYXJlbnRWaWV3ID0gdW5kZWZpbmVkOwogICAgICB9CgogICAgICB2YXIgY29ubmVjdGlvbnMgPSBST1VURV9DT05ORUNUSU9OUy5nZXQodGhpcyk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbm5lY3Rpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGNvbm5lY3Rpb24gPSBjb25uZWN0aW9uc1tpXTsKCiAgICAgICAgaWYgKGNvbm5lY3Rpb24ub3V0bGV0ID09PSBvdXRsZXROYW1lICYmIGNvbm5lY3Rpb24uaW50byA9PT0gcGFyZW50VmlldykgewogICAgICAgICAgLy8gVGhpcyBuZXV0ZXJzIHRoZSBkaXNjb25uZWN0ZWQgb3V0bGV0IHN1Y2ggdGhhdCBpdCBkb2Vzbid0CiAgICAgICAgICAvLyByZW5kZXIgYW55dGhpbmcsIGJ1dCBpdCBsZWF2ZXMgYW4gZW50cnkgaW4gdGhlIG91dGxldAogICAgICAgICAgLy8gaGllcmFyY2h5IHNvIHRoYXQgYW55IGV4aXN0aW5nIG90aGVyIHJlbmRlcnMgdGhhdCB0YXJnZXQgaXQKICAgICAgICAgIC8vIGRvbid0IHN1ZGRlbmx5IGJsb3cgdXAuIFRoZXkgd2lsbCBzdGlsbCBzdGljayB0aGVtc2VsdmVzCiAgICAgICAgICAvLyBpbnRvIGl0cyBvdXRsZXRzLCB3aGljaCB3b24ndCByZW5kZXIgYW55d2hlcmUuIEFsbCBvZiB0aGlzCiAgICAgICAgICAvLyBzdGF0ZWZ1bG5lc3Mgc2hvdWxkIGdldCB0aGUgbWFjaGV0ZSBpbiAyLjAuCiAgICAgICAgICBjb25uZWN0aW9uc1tpXSA9IHsKICAgICAgICAgICAgb3duZXI6IGNvbm5lY3Rpb24ub3duZXIsCiAgICAgICAgICAgIGludG86IGNvbm5lY3Rpb24uaW50bywKICAgICAgICAgICAgb3V0bGV0OiBjb25uZWN0aW9uLm91dGxldCwKICAgICAgICAgICAgbmFtZTogY29ubmVjdGlvbi5uYW1lLAogICAgICAgICAgICBjb250cm9sbGVyOiB1bmRlZmluZWQsCiAgICAgICAgICAgIHRlbXBsYXRlOiB1bmRlZmluZWQsCiAgICAgICAgICAgIG1vZGVsOiB1bmRlZmluZWQKICAgICAgICAgIH07CiAgICAgICAgICAoMCwgX3J1bmxvb3Aub25jZSkodGhpcy5fcm91dGVyLCAnX3NldE91dGxldHMnKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIFJPVVRFX0NPTk5FQ1RJT05TLnNldCh0aGlzLCBjb25uZWN0aW9ucyk7CiAgICB9OwoKICAgIF9wcm90by53aWxsRGVzdHJveSA9IGZ1bmN0aW9uIHdpbGxEZXN0cm95KCkgewogICAgICB0aGlzLnRlYXJkb3duVmlld3MoKTsKICAgIH0KICAgIC8qKgogICAgICBAcHJpdmF0ZQogICAgICAgICBAbWV0aG9kIHRlYXJkb3duVmlld3MKICAgICovCiAgICA7CgogICAgX3Byb3RvLnRlYXJkb3duVmlld3MgPSBmdW5jdGlvbiB0ZWFyZG93blZpZXdzKCkgewogICAgICB2YXIgY29ubmVjdGlvbnMgPSBST1VURV9DT05ORUNUSU9OUy5nZXQodGhpcyk7CgogICAgICBpZiAoY29ubmVjdGlvbnMgIT09IHVuZGVmaW5lZCAmJiBjb25uZWN0aW9ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgUk9VVEVfQ09OTkVDVElPTlMuc2V0KHRoaXMsIFtdKTsKICAgICAgICAoMCwgX3J1bmxvb3Aub25jZSkodGhpcy5fcm91dGVyLCAnX3NldE91dGxldHMnKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgIEFsbG93cyB5b3UgdG8gcHJvZHVjZSBjdXN0b20gbWV0YWRhdGEgZm9yIHRoZSByb3V0ZS4KICAgICAgVGhlIHJldHVybiB2YWx1ZSBvZiB0aGlzIG1ldGhvZCB3aWxsIGJlIGF0dGF0Y2hlZCB0bwogICAgICBpdHMgY29ycmVzcG9uZGluZyBSb3V0ZUluZm9XaXRoQXR0cmlidXRlcyBvYmVqY3QuCiAgICAgICAgIEV4YW1wbGUKICAgICAgICAgYGBgYXBwL3JvdXRlcy9wb3N0cy9pbmRleC5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBQb3N0c0luZGV4Um91dGUgZXh0ZW5kcyBSb3V0ZSB7CiAgICAgICAgYnVpbGRSb3V0ZUluZm9NZXRhZGF0YSgpIHsKICAgICAgICAgIHJldHVybiB7IHRpdGxlOiAnUG9zdHMgUGFnZScgfQogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgICAgYGBgYXBwL3JvdXRlcy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICBpbXBvcnQgeyBpbmplY3QgYXMgc2VydmljZSB9IGZyb20gJ0BlbWJlci9zZXJ2aWNlJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXBwbGljYXRpb25Sb3V0ZSBleHRlbmRzIFJvdXRlIHsKICAgICAgICBAc2VydmljZSByb3V0ZXIKICAgICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgIHN1cGVyKC4uLmFyZ3VtZW50cyk7CiAgICAgICAgICAgICB0aGlzLnJvdXRlci5vbigncm91dGVEaWRDaGFuZ2UnLCB0cmFuc2l0aW9uID0+IHsKICAgICAgICAgICAgZG9jdW1lbnQudGl0bGUgPSB0cmFuc2l0aW9uLnRvLm1ldGFkYXRhLnRpdGxlOwogICAgICAgICAgICAvLyB3b3VsZCB1cGRhdGUgZG9jdW1lbnQncyB0aXRsZSB0byAiUG9zdHMgUGFnZSIKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgICAgQHJldHVybiBhbnkKICAgICAqLwogICAgOwoKICAgIF9wcm90by5idWlsZFJvdXRlSW5mb01ldGFkYXRhID0gZnVuY3Rpb24gYnVpbGRSb3V0ZUluZm9NZXRhZGF0YSgpIHt9OwoKICAgIHJldHVybiBSb3V0ZTsKICB9KF9ydW50aW1lLk9iamVjdCk7CgogIFJvdXRlLnJlb3BlbkNsYXNzKHsKICAgIGlzUm91dGVGYWN0b3J5OiB0cnVlCiAgfSk7CgogIGZ1bmN0aW9uIHBhcmVudFJvdXRlKHJvdXRlKSB7CiAgICB2YXIgcm91dGVJbmZvID0gcm91dGVJbmZvRm9yKHJvdXRlLCByb3V0ZS5fcm91dGVyLl9yb3V0ZXJNaWNyb2xpYi5zdGF0ZS5yb3V0ZUluZm9zLCAtMSk7CiAgICByZXR1cm4gcm91dGVJbmZvICYmIHJvdXRlSW5mby5yb3V0ZTsKICB9CgogIGZ1bmN0aW9uIHJvdXRlSW5mb0Zvcihyb3V0ZSwgcm91dGVJbmZvcywgb2Zmc2V0KSB7CiAgICBpZiAob2Zmc2V0ID09PSB2b2lkIDApIHsKICAgICAgb2Zmc2V0ID0gMDsKICAgIH0KCiAgICBpZiAoIXJvdXRlSW5mb3MpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBjdXJyZW50OwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcm91dGVJbmZvcy5sZW5ndGg7IGkrKykgewogICAgICBjdXJyZW50ID0gcm91dGVJbmZvc1tpXS5yb3V0ZTsKCiAgICAgIGlmIChjdXJyZW50ID09PSByb3V0ZSkgewogICAgICAgIHJldHVybiByb3V0ZUluZm9zW2kgKyBvZmZzZXRdOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuOwogIH0KCiAgZnVuY3Rpb24gYnVpbGRSZW5kZXJPcHRpb25zKHJvdXRlLCBpc0RlZmF1bHRSZW5kZXIsIF9uYW1lLCBvcHRpb25zKSB7CiAgICAoZmFsc2UgJiYgIShpc0RlZmF1bHRSZW5kZXIgfHwgIShvcHRpb25zICYmICdvdXRsZXQnIGluIG9wdGlvbnMgJiYgb3B0aW9ucy5vdXRsZXQgPT09IHVuZGVmaW5lZCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IHBhc3NlZCB1bmRlZmluZWQgYXMgdGhlIG91dGxldCBuYW1lLicsIGlzRGVmYXVsdFJlbmRlciB8fCAhKG9wdGlvbnMgJiYgJ291dGxldCcgaW4gb3B0aW9ucyAmJiBvcHRpb25zLm91dGxldCA9PT0gdW5kZWZpbmVkKSkpOwogICAgdmFyIG93bmVyID0gKDAsIF9vd25lci5nZXRPd25lcikocm91dGUpOwogICAgdmFyIG5hbWUsIHRlbXBsYXRlTmFtZSwgaW50bywgb3V0bGV0LCBtb2RlbDsKICAgIHZhciBjb250cm9sbGVyID0gdW5kZWZpbmVkOwoKICAgIGlmIChvcHRpb25zKSB7CiAgICAgIGludG8gPSBvcHRpb25zLmludG8gJiYgb3B0aW9ucy5pbnRvLnJlcGxhY2UoL1wvL2csICcuJyk7CiAgICAgIG91dGxldCA9IG9wdGlvbnMub3V0bGV0OwogICAgICBjb250cm9sbGVyID0gb3B0aW9ucy5jb250cm9sbGVyOwogICAgICBtb2RlbCA9IG9wdGlvbnMubW9kZWw7CiAgICB9CgogICAgb3V0bGV0ID0gb3V0bGV0IHx8ICdtYWluJzsKCiAgICBpZiAoaXNEZWZhdWx0UmVuZGVyKSB7CiAgICAgIG5hbWUgPSByb3V0ZS5yb3V0ZU5hbWU7CiAgICAgIHRlbXBsYXRlTmFtZSA9IHJvdXRlLnRlbXBsYXRlTmFtZSB8fCBuYW1lOwogICAgfSBlbHNlIHsKICAgICAgbmFtZSA9IF9uYW1lLnJlcGxhY2UoL1wvL2csICcuJyk7CiAgICAgIHRlbXBsYXRlTmFtZSA9IG5hbWU7CiAgICB9CgogICAgaWYgKGNvbnRyb2xsZXIgPT09IHVuZGVmaW5lZCkgewogICAgICBpZiAoaXNEZWZhdWx0UmVuZGVyKSB7CiAgICAgICAgY29udHJvbGxlciA9IHJvdXRlLmNvbnRyb2xsZXJOYW1lIHx8IG93bmVyLmxvb2t1cCgiY29udHJvbGxlcjoiICsgbmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29udHJvbGxlciA9IG93bmVyLmxvb2t1cCgiY29udHJvbGxlcjoiICsgbmFtZSkgfHwgcm91dGUuY29udHJvbGxlck5hbWUgfHwgcm91dGUucm91dGVOYW1lOwogICAgICB9CiAgICB9CgogICAgaWYgKHR5cGVvZiBjb250cm9sbGVyID09PSAnc3RyaW5nJykgewogICAgICB2YXIgY29udHJvbGxlck5hbWUgPSBjb250cm9sbGVyOwogICAgICBjb250cm9sbGVyID0gb3duZXIubG9va3VwKCJjb250cm9sbGVyOiIgKyBjb250cm9sbGVyTmFtZSk7CiAgICAgIChmYWxzZSAmJiAhKGlzRGVmYXVsdFJlbmRlciB8fCBjb250cm9sbGVyICE9PSB1bmRlZmluZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IHBhc3NlZCBgY29udHJvbGxlcjogJyIgKyBjb250cm9sbGVyTmFtZSArICInYCBpbnRvIHRoZSBgcmVuZGVyYCBtZXRob2QsIGJ1dCBubyBzdWNoIGNvbnRyb2xsZXIgY291bGQgYmUgZm91bmQuIiwgaXNEZWZhdWx0UmVuZGVyIHx8IGNvbnRyb2xsZXIgIT09IHVuZGVmaW5lZCkpOwogICAgfQoKICAgIGlmIChtb2RlbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIG1vZGVsID0gcm91dGUuY3VycmVudE1vZGVsOwogICAgfSBlbHNlIHsKICAgICAgY29udHJvbGxlci5zZXQoJ21vZGVsJywgbW9kZWwpOwogICAgfQoKICAgIHZhciB0ZW1wbGF0ZSA9IG93bmVyLmxvb2t1cCgidGVtcGxhdGU6IiArIHRlbXBsYXRlTmFtZSk7CiAgICAoZmFsc2UgJiYgIShpc0RlZmF1bHRSZW5kZXIgfHwgdGVtcGxhdGUgIT09IHVuZGVmaW5lZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJDb3VsZCBub3QgZmluZCBcIiIgKyB0ZW1wbGF0ZU5hbWUgKyAiXCIgdGVtcGxhdGUsIHZpZXcsIG9yIGNvbXBvbmVudC4iLCBpc0RlZmF1bHRSZW5kZXIgfHwgdGVtcGxhdGUgIT09IHVuZGVmaW5lZCkpOwogICAgdmFyIHBhcmVudDsKCiAgICBpZiAoaW50byAmJiAocGFyZW50ID0gcGFyZW50Um91dGUocm91dGUpKSAmJiBpbnRvID09PSBwYXJlbnQucm91dGVOYW1lKSB7CiAgICAgIGludG8gPSB1bmRlZmluZWQ7CiAgICB9CgogICAgdmFyIHJlbmRlck9wdGlvbnMgPSB7CiAgICAgIG93bmVyOiBvd25lciwKICAgICAgaW50bzogaW50bywKICAgICAgb3V0bGV0OiBvdXRsZXQsCiAgICAgIG5hbWU6IG5hbWUsCiAgICAgIGNvbnRyb2xsZXI6IGNvbnRyb2xsZXIsCiAgICAgIG1vZGVsOiBtb2RlbCwKICAgICAgdGVtcGxhdGU6IHRlbXBsYXRlICE9PSB1bmRlZmluZWQgPyB0ZW1wbGF0ZShvd25lcikgOiByb3V0ZS5fdG9wTGV2ZWxWaWV3VGVtcGxhdGUob3duZXIpCiAgICB9OwoKICAgIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICkgewogICAgICB2YXIgTE9HX1ZJRVdfTE9PS1VQUyA9ICgwLCBfbWV0YWwuZ2V0KShyb3V0ZS5fcm91dGVyLCAnbmFtZXNwYWNlLkxPR19WSUVXX0xPT0tVUFMnKTsKCiAgICAgIGlmIChMT0dfVklFV19MT09LVVBTICYmICF0ZW1wbGF0ZSkgewogICAgICAgICgwLCBfZGVidWcuaW5mbykoIkNvdWxkIG5vdCBmaW5kIFwiIiArIG5hbWUgKyAiXCIgdGVtcGxhdGUuIE5vdGhpbmcgd2lsbCBiZSByZW5kZXJlZCIsIHsKICAgICAgICAgIGZ1bGxOYW1lOiAidGVtcGxhdGU6IiArIG5hbWUKICAgICAgICB9KTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByZW5kZXJPcHRpb25zOwogIH0KCiAgZnVuY3Rpb24gZ2V0RnVsbFF1ZXJ5UGFyYW1zKHJvdXRlciwgc3RhdGUpIHsKICAgIGlmIChzdGF0ZVsnZnVsbFF1ZXJ5UGFyYW1zJ10pIHsKICAgICAgcmV0dXJuIHN0YXRlWydmdWxsUXVlcnlQYXJhbXMnXTsKICAgIH0KCiAgICBzdGF0ZVsnZnVsbFF1ZXJ5UGFyYW1zJ10gPSB7fTsKICAgICgwLCBfcG9seWZpbGxzLmFzc2lnbikoc3RhdGVbJ2Z1bGxRdWVyeVBhcmFtcyddLCBzdGF0ZS5xdWVyeVBhcmFtcyk7CgogICAgcm91dGVyLl9kZXNlcmlhbGl6ZVF1ZXJ5UGFyYW1zKHN0YXRlLnJvdXRlSW5mb3MsIHN0YXRlWydmdWxsUXVlcnlQYXJhbXMnXSk7CgogICAgcmV0dXJuIHN0YXRlWydmdWxsUXVlcnlQYXJhbXMnXTsKICB9CgogIGZ1bmN0aW9uIGdldFF1ZXJ5UGFyYW1zRm9yKHJvdXRlLCBzdGF0ZSkgewogICAgc3RhdGVbJ3F1ZXJ5UGFyYW1zRm9yJ10gPSBzdGF0ZVsncXVlcnlQYXJhbXNGb3InXSB8fCB7fTsKICAgIHZhciBuYW1lID0gcm91dGUuZnVsbFJvdXRlTmFtZTsKCiAgICBpZiAoc3RhdGVbJ3F1ZXJ5UGFyYW1zRm9yJ11bbmFtZV0pIHsKICAgICAgcmV0dXJuIHN0YXRlWydxdWVyeVBhcmFtc0ZvciddW25hbWVdOwogICAgfQoKICAgIHZhciBmdWxsUXVlcnlQYXJhbXMgPSBnZXRGdWxsUXVlcnlQYXJhbXMocm91dGUuX3JvdXRlciwgc3RhdGUpOwogICAgdmFyIHBhcmFtcyA9IHN0YXRlWydxdWVyeVBhcmFtc0ZvciddW25hbWVdID0ge307IC8vIENvcHkgb3ZlciBhbGwgdGhlIHF1ZXJ5IHBhcmFtcyBmb3IgdGhpcyByb3V0ZS9jb250cm9sbGVyIGludG8gcGFyYW1zIGhhc2guCgogICAgdmFyIHFwcyA9ICgwLCBfbWV0YWwuZ2V0KShyb3V0ZSwgJ19xcC5xcHMnKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHFwcy5sZW5ndGg7ICsraSkgewogICAgICAvLyBQdXQgZGVzZXJpYWxpemVkIHFwIG9uIHBhcmFtcyBoYXNoLgogICAgICB2YXIgcXAgPSBxcHNbaV07CiAgICAgIHZhciBxcFZhbHVlV2FzUGFzc2VkSW4gPSBxcC5wcm9wIGluIGZ1bGxRdWVyeVBhcmFtczsKICAgICAgcGFyYW1zW3FwLnByb3BdID0gcXBWYWx1ZVdhc1Bhc3NlZEluID8gZnVsbFF1ZXJ5UGFyYW1zW3FwLnByb3BdIDogY29weURlZmF1bHRWYWx1ZShxcC5kZWZhdWx0VmFsdWUpOwogICAgfQoKICAgIHJldHVybiBwYXJhbXM7CiAgfQoKICBmdW5jdGlvbiBjb3B5RGVmYXVsdFZhbHVlKHZhbHVlKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgcmV0dXJuICgwLCBfcnVudGltZS5BKSh2YWx1ZS5zbGljZSgpKTsKICAgIH0KCiAgICByZXR1cm4gdmFsdWU7CiAgfQogIC8qCiAgICBNZXJnZXMgYWxsIHF1ZXJ5IHBhcmFtZXRlcnMgZnJvbSBhIGNvbnRyb2xsZXIgd2l0aCB0aG9zZSBmcm9tCiAgICBhIHJvdXRlLCByZXR1cm5pbmcgYSBuZXcgb2JqZWN0IGFuZCBhdm9pZGluZyBhbnkgbXV0YXRpb25zIHRvCiAgICB0aGUgZXhpc3Rpbmcgb2JqZWN0cy4KICAqLwoKCiAgZnVuY3Rpb24gbWVyZ2VFYWNoUXVlcnlQYXJhbXMoY29udHJvbGxlclFQLCByb3V0ZVFQKSB7CiAgICB2YXIgcXBzID0ge307CiAgICB2YXIga2V5c0FscmVhZHlNZXJnZWRPclNraXBwYWJsZSA9IHsKICAgICAgZGVmYXVsdFZhbHVlOiB0cnVlLAogICAgICB0eXBlOiB0cnVlLAogICAgICBzY29wZTogdHJ1ZSwKICAgICAgYXM6IHRydWUKICAgIH07IC8vIGZpcnN0IGxvb3Agb3ZlciBhbGwgY29udHJvbGxlciBxcHMsIG1lcmdpbmcgdGhlbSB3aXRoIGFueSBtYXRjaGluZyByb3V0ZSBxcHMKICAgIC8vIGludG8gYSBuZXcgZW1wdHkgb2JqZWN0IHRvIGF2b2lkIG11dGF0aW5nLgoKICAgIGZvciAodmFyIGNxcE5hbWUgaW4gY29udHJvbGxlclFQKSB7CiAgICAgIGlmICghY29udHJvbGxlclFQLmhhc093blByb3BlcnR5KGNxcE5hbWUpKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIHZhciBuZXdDb250cm9sbGVyUGFyYW1ldGVyQ29uZmlndXJhdGlvbiA9IHt9OwogICAgICAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKG5ld0NvbnRyb2xsZXJQYXJhbWV0ZXJDb25maWd1cmF0aW9uLCBjb250cm9sbGVyUVBbY3FwTmFtZV0sIHJvdXRlUVBbY3FwTmFtZV0pOwogICAgICBxcHNbY3FwTmFtZV0gPSBuZXdDb250cm9sbGVyUGFyYW1ldGVyQ29uZmlndXJhdGlvbjsgLy8gYWxsb3dzIHVzIHRvIHNraXAgdGhpcyBRUCB3aGVuIHdlIGNoZWNrIHJvdXRlIFFQcy4KCiAgICAgIGtleXNBbHJlYWR5TWVyZ2VkT3JTa2lwcGFibGVbY3FwTmFtZV0gPSB0cnVlOwogICAgfSAvLyBsb29wIG92ZXIgYWxsIHJvdXRlIHFwcywgc2tpcHBpbmcgdGhvc2UgdGhhdCB3ZXJlIG1lcmdlZCBpbiB0aGUgZmlyc3QgcGFzcwogICAgLy8gYmVjYXVzZSB0aGV5IGFsc28gYXBwZWFyIGluIGNvbnRyb2xsZXIgcXBzCgoKICAgIGZvciAodmFyIHJxcE5hbWUgaW4gcm91dGVRUCkgewogICAgICBpZiAoIXJvdXRlUVAuaGFzT3duUHJvcGVydHkocnFwTmFtZSkgfHwga2V5c0FscmVhZHlNZXJnZWRPclNraXBwYWJsZVtycXBOYW1lXSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CgogICAgICB2YXIgbmV3Um91dGVQYXJhbWV0ZXJDb25maWd1cmF0aW9uID0ge307CiAgICAgICgwLCBfcG9seWZpbGxzLmFzc2lnbikobmV3Um91dGVQYXJhbWV0ZXJDb25maWd1cmF0aW9uLCByb3V0ZVFQW3JxcE5hbWVdLCBjb250cm9sbGVyUVBbcnFwTmFtZV0pOwogICAgICBxcHNbcnFwTmFtZV0gPSBuZXdSb3V0ZVBhcmFtZXRlckNvbmZpZ3VyYXRpb247CiAgICB9CgogICAgcmV0dXJuIHFwczsKICB9CgogIGZ1bmN0aW9uIGFkZFF1ZXJ5UGFyYW1zT2JzZXJ2ZXJzKGNvbnRyb2xsZXIsIHByb3BOYW1lcykgewogICAgcHJvcE5hbWVzLmZvckVhY2goZnVuY3Rpb24gKHByb3ApIHsKICAgICAgaWYgKCgwLCBfbWV0YWwuZGVzY3JpcHRvckZvclByb3BlcnR5KShjb250cm9sbGVyLCBwcm9wKSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdmFyIGRlc2MgPSAoMCwgX3V0aWxzLmxvb2t1cERlc2NyaXB0b3IpKGNvbnRyb2xsZXIsIHByb3ApOwoKICAgICAgICBpZiAoZGVzYyAhPT0gbnVsbCAmJiAodHlwZW9mIGRlc2MuZ2V0ID09PSAnZnVuY3Rpb24nIHx8IHR5cGVvZiBkZXNjLnNldCA9PT0gJ2Z1bmN0aW9uJykpIHsKICAgICAgICAgICgwLCBfbWV0YWwuZGVmaW5lUHJvcGVydHkpKGNvbnRyb2xsZXIsIHByb3AsICgwLCBfY29tcGF0LmRlcGVuZGVudEtleUNvbXBhdCkoewogICAgICAgICAgICBnZXQ6IGRlc2MuZ2V0LAogICAgICAgICAgICBzZXQ6IGRlc2Muc2V0CiAgICAgICAgICB9KSk7CiAgICAgICAgfQogICAgICB9CgogICAgICAoMCwgX21ldGFsLmFkZE9ic2VydmVyKShjb250cm9sbGVyLCBwcm9wICsgIi5bXSIsIGNvbnRyb2xsZXIsIGNvbnRyb2xsZXIuX3FwQ2hhbmdlZCwgZmFsc2UpOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBnZXRFbmdpbmVSb3V0ZU5hbWUoZW5naW5lLCByb3V0ZU5hbWUpIHsKICAgIGlmIChlbmdpbmUucm91dGFibGUpIHsKICAgICAgdmFyIHByZWZpeCA9IGVuZ2luZS5tb3VudFBvaW50OwoKICAgICAgaWYgKHJvdXRlTmFtZSA9PT0gJ2FwcGxpY2F0aW9uJykgewogICAgICAgIHJldHVybiBwcmVmaXg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHByZWZpeCArICIuIiArIHJvdXRlTmFtZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByb3V0ZU5hbWU7CiAgfQogIC8qKgogICAgICBBIGhvb2sgeW91IGNhbiBpbXBsZW1lbnQgdG8gY29udmVydCB0aGUgcm91dGUncyBtb2RlbCBpbnRvIHBhcmFtZXRlcnMKICAgICAgZm9yIHRoZSBVUkwuCiAgCiAgICAgIGBgYGFwcC9yb3V0ZXIuanMKICAgICAgLy8gLi4uCiAgCiAgICAgIFJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yb3V0ZSgncG9zdCcsIHsgcGF0aDogJy9wb3N0cy86cG9zdF9pZCcgfSk7CiAgICAgIH0pOwogIAogICAgICBgYGAKICAKICAgICAgYGBgYXBwL3JvdXRlcy9wb3N0LmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIFBvc3RSb3V0ZSBleHRlbmRzIFJvdXRlIHsKICAgICAgICBtb2RlbCh7IHBvc3RfaWQgfSkgewogICAgICAgICAgLy8gdGhlIHNlcnZlciByZXR1cm5zIGB7IGlkOiAxMiB9YAogICAgICAgICAgcmV0dXJuIGZldGNoKGAvcG9zdHMvJHtwb3N0X2lkfWA7CiAgICAgICAgfQogIAogICAgICAgIHNlcmlhbGl6ZShtb2RlbCkgewogICAgICAgICAgLy8gdGhpcyB3aWxsIG1ha2UgdGhlIFVSTCBgL3Bvc3RzLzEyYAogICAgICAgICAgcmV0dXJuIHsgcG9zdF9pZDogbW9kZWwuaWQgfTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgCiAgICAgIFRoZSBkZWZhdWx0IGBzZXJpYWxpemVgIG1ldGhvZCB3aWxsIGluc2VydCB0aGUgbW9kZWwncyBgaWRgIGludG8gdGhlCiAgICAgIHJvdXRlJ3MgZHluYW1pYyBzZWdtZW50IChpbiB0aGlzIGNhc2UsIGA6cG9zdF9pZGApIGlmIHRoZSBzZWdtZW50IGNvbnRhaW5zICdfaWQnLgogICAgICBJZiB0aGUgcm91dGUgaGFzIG11bHRpcGxlIGR5bmFtaWMgc2VnbWVudHMgb3IgZG9lcyBub3QgY29udGFpbiAnX2lkJywgYHNlcmlhbGl6ZWAKICAgICAgd2lsbCByZXR1cm4gYGdldFByb3BlcnRpZXMobW9kZWwsIHBhcmFtcylgCiAgCiAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCB3aGVuIGB0cmFuc2l0aW9uVG9gIGlzIGNhbGxlZCB3aXRoIGEgY29udGV4dAogICAgICBpbiBvcmRlciB0byBwb3B1bGF0ZSB0aGUgVVJMLgogIAogICAgICBAbWV0aG9kIHNlcmlhbGl6ZQogICAgICBAcGFyYW0ge09iamVjdH0gbW9kZWwgdGhlIHJvdXRlcyBtb2RlbAogICAgICBAcGFyYW0ge0FycmF5fSBwYXJhbXMgYW4gQXJyYXkgb2YgcGFyYW1ldGVyIG5hbWVzIGZvciB0aGUgY3VycmVudAogICAgICAgIHJvdXRlIChpbiB0aGUgZXhhbXBsZSwgYFsncG9zdF9pZCddYC4KICAgICAgQHJldHVybiB7T2JqZWN0fSB0aGUgc2VyaWFsaXplZCBwYXJhbWV0ZXJzCiAgICAgIEBzaW5jZSAxLjAuMAogICAgICBAcHVibGljCiAgICAqLwoKCiAgUm91dGUucHJvdG90eXBlLnNlcmlhbGl6ZSA9IGRlZmF1bHRTZXJpYWxpemU7CiAgUm91dGUucmVvcGVuKF9ydW50aW1lLkFjdGlvbkhhbmRsZXIsIF9ydW50aW1lLkV2ZW50ZWQsIHsKICAgIG1lcmdlZFByb3BlcnRpZXM6IFsncXVlcnlQYXJhbXMnXSwKCiAgICAvKioKICAgICAgQ29uZmlndXJhdGlvbiBoYXNoIGZvciB0aGlzIHJvdXRlJ3MgcXVlcnlQYXJhbXMuIFRoZSBwb3NzaWJsZQogICAgICBjb25maWd1cmF0aW9uIG9wdGlvbnMgYW5kIHRoZWlyIGRlZmF1bHRzIGFyZSBhcyBmb2xsb3dzCiAgICAgIChhc3N1bWluZyBhIHF1ZXJ5IHBhcmFtIHdob3NlIGNvbnRyb2xsZXIgcHJvcGVydHkgaXMgYHBhZ2VgKToKICAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICBxdWVyeVBhcmFtczogewogICAgICAgIHBhZ2U6IHsKICAgICAgICAgIC8vIEJ5IGRlZmF1bHQsIGNvbnRyb2xsZXIgcXVlcnkgcGFyYW0gcHJvcGVydGllcyBkb24ndAogICAgICAgICAgLy8gY2F1c2UgYSBmdWxsIHRyYW5zaXRpb24gd2hlbiB0aGV5IGFyZSBjaGFuZ2VkLCBidXQKICAgICAgICAgIC8vIHJhdGhlciBvbmx5IGNhdXNlIHRoZSBVUkwgdG8gdXBkYXRlLiBTZXR0aW5nCiAgICAgICAgICAvLyBgcmVmcmVzaE1vZGVsYCB0byB0cnVlIHdpbGwgY2F1c2UgYW4gImluLXBsYWNlIgogICAgICAgICAgLy8gdHJhbnNpdGlvbiB0byBvY2N1ciwgd2hlcmVieSB0aGUgbW9kZWwgaG9va3MgZm9yCiAgICAgICAgICAvLyB0aGlzIHJvdXRlIChhbmQgYW55IGNoaWxkIHJvdXRlcykgd2lsbCByZS1maXJlLCBhbGxvd2luZwogICAgICAgICAgLy8geW91IHRvIHJlbG9hZCBtb2RlbHMgKGUuZy4sIGZyb20gdGhlIHNlcnZlcikgdXNpbmcgdGhlCiAgICAgICAgICAvLyB1cGRhdGVkIHF1ZXJ5IHBhcmFtIHZhbHVlcy4KICAgICAgICAgIHJlZnJlc2hNb2RlbDogZmFsc2UsCiAgICAgICAgICAgICAvLyBCeSBkZWZhdWx0LCBjaGFuZ2VzIHRvIGNvbnRyb2xsZXIgcXVlcnkgcGFyYW0gcHJvcGVydGllcwogICAgICAgICAgLy8gY2F1c2UgdGhlIFVSTCB0byB1cGRhdGUgdmlhIGBwdXNoU3RhdGVgLCB3aGljaCBtZWFucyBhbgogICAgICAgICAgLy8gaXRlbSB3aWxsIGJlIGFkZGVkIHRvIHRoZSBicm93c2VyJ3MgaGlzdG9yeSwgYWxsb3dpbmcKICAgICAgICAgIC8vIHlvdSB0byB1c2UgdGhlIGJhY2sgYnV0dG9uIHRvIHJlc3RvcmUgdGhlIGFwcCB0byB0aGUKICAgICAgICAgIC8vIHByZXZpb3VzIHN0YXRlIGJlZm9yZSB0aGUgcXVlcnkgcGFyYW0gcHJvcGVydHkgd2FzIGNoYW5nZWQuCiAgICAgICAgICAvLyBTZXR0aW5nIGByZXBsYWNlYCB0byB0cnVlIHdpbGwgdXNlIGByZXBsYWNlU3RhdGVgIChvciBpdHMKICAgICAgICAgIC8vIGhhc2ggbG9jYXRpb24gZXF1aXZhbGVudCksIHdoaWNoIGNhdXNlcyBubyBicm93c2VyIGhpc3RvcnkKICAgICAgICAgIC8vIGl0ZW0gdG8gYmUgYWRkZWQuIFRoaXMgb3B0aW9ucyBuYW1lIGFuZCBkZWZhdWx0IHZhbHVlIGFyZQogICAgICAgICAgLy8gdGhlIHNhbWUgYXMgdGhlIGBsaW5rLXRvYCBoZWxwZXIncyBgcmVwbGFjZWAgb3B0aW9uLgogICAgICAgICAgcmVwbGFjZTogZmFsc2UsCiAgICAgICAgICAgICAvLyBCeSBkZWZhdWx0LCB0aGUgcXVlcnkgcGFyYW0gVVJMIGtleSBpcyB0aGUgc2FtZSBuYW1lIGFzCiAgICAgICAgICAvLyB0aGUgY29udHJvbGxlciBwcm9wZXJ0eSBuYW1lLiBVc2UgYGFzYCB0byBzcGVjaWZ5IGEKICAgICAgICAgIC8vIGRpZmZlcmVudCBVUkwga2V5LgogICAgICAgICAgYXM6ICdwYWdlJwogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgICAgQHByb3BlcnR5IHF1ZXJ5UGFyYW1zCiAgICAgIEBmb3IgUm91dGUKICAgICAgQHR5cGUgT2JqZWN0CiAgICAgIEBzaW5jZSAxLjYuMAogICAgICBAcHVibGljCiAgICAqLwogICAgcXVlcnlQYXJhbXM6IHt9LAoKICAgIC8qKgogICAgICBUaGUgbmFtZSBvZiB0aGUgdGVtcGxhdGUgdG8gdXNlIGJ5IGRlZmF1bHQgd2hlbiByZW5kZXJpbmcgdGhpcyByb3V0ZXMKICAgICAgdGVtcGxhdGUuCiAgICAgICAgIGBgYGFwcC9yb3V0ZXMvcG9zdHMvbGlzdC5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBleHRlbmRzIFJvdXRlIHsKICAgICAgICB0ZW1wbGF0ZU5hbWUgPSAncG9zdHMvbGlzdCcKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgICBgYGBhcHAvcm91dGVzL3Bvc3RzL2luZGV4LmpzCiAgICAgIGltcG9ydCBQb3N0c0xpc3QgZnJvbSAnLi4vcG9zdHMvbGlzdCc7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIGV4dGVuZHMgUG9zdHNMaXN0IHt9OwogICAgICBgYGAKICAgICAgICAgYGBgYXBwL3JvdXRlcy9wb3N0cy9hcmNoaXZlZC5qcwogICAgICBpbXBvcnQgUG9zdHNMaXN0IGZyb20gJy4uL3Bvc3RzL2xpc3QnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBleHRlbmRzIFBvc3RzTGlzdCB7fTsKICAgICAgYGBgCiAgICAgICAgIEBwcm9wZXJ0eSB0ZW1wbGF0ZU5hbWUKICAgICAgQHR5cGUgU3RyaW5nCiAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgQHNpbmNlIDEuNC4wCiAgICAgIEBwdWJsaWMKICAgICovCiAgICB0ZW1wbGF0ZU5hbWU6IG51bGwsCgogICAgLyoqCiAgICAgIEBwcml2YXRlCiAgICAgICAgIEBwcm9wZXJ0eSBfbmFtZXMKICAgICovCiAgICBfbmFtZXM6IG51bGwsCgogICAgLyoqCiAgICAgIFRoZSBuYW1lIG9mIHRoZSBjb250cm9sbGVyIHRvIGFzc29jaWF0ZSB3aXRoIHRoaXMgcm91dGUuCiAgICAgICAgIEJ5IGRlZmF1bHQsIEVtYmVyIHdpbGwgbG9va3VwIGEgcm91dGUncyBjb250cm9sbGVyIHRoYXQgbWF0Y2hlcyB0aGUgbmFtZQogICAgICBvZiB0aGUgcm91dGUgKGkuZS4gYHBvc3RzLm5ld2ApLiBIb3dldmVyLAogICAgICBpZiB5b3Ugd291bGQgbGlrZSB0byBkZWZpbmUgYSBzcGVjaWZpYyBjb250cm9sbGVyIHRvIHVzZSwgeW91IGNhbiBkbyBzbwogICAgICB1c2luZyB0aGlzIHByb3BlcnR5LgogICAgICAgICBUaGlzIGlzIHVzZWZ1bCBpbiBtYW55IHdheXMsIGFzIHRoZSBjb250cm9sbGVyIHNwZWNpZmllZCB3aWxsIGJlOgogICAgICAgICAqIHBhc3NlZCB0byB0aGUgYHNldHVwQ29udHJvbGxlcmAgbWV0aG9kLgogICAgICAqIHVzZWQgYXMgdGhlIGNvbnRyb2xsZXIgZm9yIHRoZSB0ZW1wbGF0ZSBiZWluZyByZW5kZXJlZCBieSB0aGUgcm91dGUuCiAgICAgICogcmV0dXJuZWQgZnJvbSBhIGNhbGwgdG8gYGNvbnRyb2xsZXJGb3JgIGZvciB0aGUgcm91dGUuCiAgICAgICAgIEBwcm9wZXJ0eSBjb250cm9sbGVyTmFtZQogICAgICBAdHlwZSBTdHJpbmcKICAgICAgQGRlZmF1bHQgbnVsbAogICAgICBAc2luY2UgMS40LjAKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGNvbnRyb2xsZXJOYW1lOiBudWxsLAoKICAgIC8qKgogICAgICBTdG9yZSBwcm9wZXJ0eSBwcm92aWRlcyBhIGhvb2sgZm9yIGRhdGEgcGVyc2lzdGVuY2UgbGlicmFyaWVzIHRvIGluamVjdCB0aGVtc2VsdmVzLgogICAgICAgICBCeSBkZWZhdWx0LCB0aGlzIHN0b3JlIHByb3BlcnR5IHByb3ZpZGVzIHRoZSBleGFjdCBzYW1lIGZ1bmN0aW9uYWxpdHkgcHJldmlvdXNseQogICAgICBpbiB0aGUgbW9kZWwgaG9vay4KICAgICAgICAgQ3VycmVudGx5LCB0aGUgcmVxdWlyZWQgaW50ZXJmYWNlIGlzOgogICAgICAgICBgc3RvcmUuZmluZChtb2RlbE5hbWUsIGZpbmRBcmd1bWVudHMpYAogICAgICAgICBAcHJvcGVydHkgc3RvcmUKICAgICAgQHR5cGUge09iamVjdH0KICAgICAgQHByaXZhdGUKICAgICovCiAgICBzdG9yZTogKDAsIF9tZXRhbC5jb21wdXRlZCkoewogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICB2YXIgb3duZXIgPSAoMCwgX293bmVyLmdldE93bmVyKSh0aGlzKTsKICAgICAgICB2YXIgcm91dGVOYW1lID0gdGhpcy5yb3V0ZU5hbWU7CiAgICAgICAgdmFyIG5hbWVzcGFjZSA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAnX3JvdXRlci5uYW1lc3BhY2UnKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZmluZDogZnVuY3Rpb24gZmluZChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgbW9kZWxDbGFzcyA9IG93bmVyLmZhY3RvcnlGb3IoIm1vZGVsOiIgKyBuYW1lKTsKICAgICAgICAgICAgKGZhbHNlICYmICEoQm9vbGVhbihtb2RlbENsYXNzKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJZb3UgdXNlZCB0aGUgZHluYW1pYyBzZWdtZW50ICIgKyBuYW1lICsgIl9pZCBpbiB5b3VyIHJvdXRlICIgKyByb3V0ZU5hbWUgKyAiLCBidXQgIiArIG5hbWVzcGFjZSArICIuIiArICgwLCBfc3RyaW5nLmNsYXNzaWZ5KShuYW1lKSArICIgZGlkIG5vdCBleGlzdCBhbmQgeW91IGRpZCBub3Qgb3ZlcnJpZGUgeW91ciByb3V0ZSdzIGBtb2RlbGAgaG9vay4iLCBCb29sZWFuKG1vZGVsQ2xhc3MpKSk7CgogICAgICAgICAgICBpZiAoIW1vZGVsQ2xhc3MpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG1vZGVsQ2xhc3MgPSBtb2RlbENsYXNzLmNsYXNzOwogICAgICAgICAgICAoZmFsc2UgJiYgISh0eXBlb2YgbW9kZWxDbGFzcy5maW5kID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoKDAsIF9zdHJpbmcuY2xhc3NpZnkpKG5hbWUpICsgIiBoYXMgbm8gbWV0aG9kIGBmaW5kYC4iLCB0eXBlb2YgbW9kZWxDbGFzcy5maW5kID09PSAnZnVuY3Rpb24nKSk7CiAgICAgICAgICAgIHJldHVybiBtb2RlbENsYXNzLmZpbmQodmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gc2V0KGtleSwgdmFsdWUpIHsKICAgICAgICAoMCwgX21ldGFsLmRlZmluZVByb3BlcnR5KSh0aGlzLCBrZXksIG51bGwsIHZhbHVlKTsKICAgICAgfQogICAgfSksCgogICAgLyoqCiAgICAgICAgQHByaXZhdGUKICAgICAgICAgICBAcHJvcGVydHkgX3FwCiAgICAgICovCiAgICBfcXA6ICgwLCBfbWV0YWwuY29tcHV0ZWQpKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICB2YXIgY29tYmluZWRRdWVyeVBhcmFtZXRlckNvbmZpZ3VyYXRpb247CiAgICAgIHZhciBjb250cm9sbGVyTmFtZSA9IHRoaXMuY29udHJvbGxlck5hbWUgfHwgdGhpcy5yb3V0ZU5hbWU7CiAgICAgIHZhciBvd25lciA9ICgwLCBfb3duZXIuZ2V0T3duZXIpKHRoaXMpOwogICAgICB2YXIgY29udHJvbGxlciA9IG93bmVyLmxvb2t1cCgiY29udHJvbGxlcjoiICsgY29udHJvbGxlck5hbWUpOwogICAgICB2YXIgcXVlcnlQYXJhbWV0ZXJDb25maWd1cmF0b24gPSAoMCwgX21ldGFsLmdldCkodGhpcywgJ3F1ZXJ5UGFyYW1zJyk7CiAgICAgIHZhciBoYXNSb3V0ZXJEZWZpbmVkUXVlcnlQYXJhbXMgPSBPYmplY3Qua2V5cyhxdWVyeVBhcmFtZXRlckNvbmZpZ3VyYXRvbikubGVuZ3RoID4gMDsKCiAgICAgIGlmIChjb250cm9sbGVyKSB7CiAgICAgICAgLy8gdGhlIGRldmVsb3BlciBoYXMgYXV0aG9yZWQgYSBjb250cm9sbGVyIGNsYXNzIGluIHRoZWlyIGFwcGxpY2F0aW9uIGZvcgogICAgICAgIC8vIHRoaXMgcm91dGUgZmluZCBpdHMgcXVlcnkgcGFyYW1zIGFuZCBub3JtYWxpemUgdGhlaXIgb2JqZWN0IHNoYXBlIHRoZW0KICAgICAgICAvLyBtZXJnZSBpbiB0aGUgcXVlcnkgcGFyYW1zIGZvciB0aGUgcm91dGUuIEFzIGEgbWVyZ2VkUHJvcGVydHksCiAgICAgICAgLy8gUm91dGUjcXVlcnlQYXJhbXMgaXMgYWx3YXlzIGF0IGxlYXN0IGB7fWAKICAgICAgICB2YXIgY29udHJvbGxlckRlZmluZWRRdWVyeVBhcmFtZXRlckNvbmZpZ3VyYXRpb24gPSAoMCwgX21ldGFsLmdldCkoY29udHJvbGxlciwgJ3F1ZXJ5UGFyYW1zJykgfHwge307CiAgICAgICAgdmFyIG5vcm1hbGl6ZWRDb250cm9sbGVyUXVlcnlQYXJhbWV0ZXJDb25maWd1cmF0aW9uID0gKDAsIF91dGlsczIubm9ybWFsaXplQ29udHJvbGxlclF1ZXJ5UGFyYW1zKShjb250cm9sbGVyRGVmaW5lZFF1ZXJ5UGFyYW1ldGVyQ29uZmlndXJhdGlvbik7CiAgICAgICAgY29tYmluZWRRdWVyeVBhcmFtZXRlckNvbmZpZ3VyYXRpb24gPSBtZXJnZUVhY2hRdWVyeVBhcmFtcyhub3JtYWxpemVkQ29udHJvbGxlclF1ZXJ5UGFyYW1ldGVyQ29uZmlndXJhdGlvbiwgcXVlcnlQYXJhbWV0ZXJDb25maWd1cmF0b24pOwogICAgICB9IGVsc2UgaWYgKGhhc1JvdXRlckRlZmluZWRRdWVyeVBhcmFtcykgewogICAgICAgIC8vIHRoZSBkZXZlbG9wZXIgaGFzIG5vdCBkZWZpbmVkIGEgY29udHJvbGxlciBidXQgKmhhcyogc3VwcGxpZWQgcm91dGUgcXVlcnkgcGFyYW1zLgogICAgICAgIC8vIEdlbmVyYXRlIGEgY2xhc3MgZm9yIHRoZW0gc28gd2UgY2FuIGxhdGVyIGluc2VydCBkZWZhdWx0IHZhbHVlcwogICAgICAgIGNvbnRyb2xsZXIgPSAoMCwgX2dlbmVyYXRlX2NvbnRyb2xsZXIuZGVmYXVsdCkob3duZXIsIGNvbnRyb2xsZXJOYW1lKTsKICAgICAgICBjb21iaW5lZFF1ZXJ5UGFyYW1ldGVyQ29uZmlndXJhdGlvbiA9IHF1ZXJ5UGFyYW1ldGVyQ29uZmlndXJhdG9uOwogICAgICB9CgogICAgICB2YXIgcXBzID0gW107CiAgICAgIHZhciBtYXAgPSB7fTsKICAgICAgdmFyIHByb3BlcnR5TmFtZXMgPSBbXTsKCiAgICAgIGZvciAodmFyIHByb3BOYW1lIGluIGNvbWJpbmVkUXVlcnlQYXJhbWV0ZXJDb25maWd1cmF0aW9uKSB7CiAgICAgICAgaWYgKCFjb21iaW5lZFF1ZXJ5UGFyYW1ldGVyQ29uZmlndXJhdGlvbi5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0gLy8gdG8gc3VwcG9ydCB0aGUgZHViaW91cyBmZWF0dXJlIG9mIHVzaW5nIHVua25vd25Qcm9wZXJ0eQogICAgICAgIC8vIG9uIHF1ZXJ5UGFyYW1zIGNvbmZpZ3VyYXRpb24KCgogICAgICAgIGlmIChwcm9wTmFtZSA9PT0gJ3Vua25vd25Qcm9wZXJ0eScgfHwgcHJvcE5hbWUgPT09ICdfc3VwZXInKSB7CiAgICAgICAgICAvLyBwb3NzaWJsZSB0b2RvOiBpc3N1ZSBkZXByZWNhdGlvbiB3YXJuaW5nPwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgZGVzYyA9IGNvbWJpbmVkUXVlcnlQYXJhbWV0ZXJDb25maWd1cmF0aW9uW3Byb3BOYW1lXTsKICAgICAgICB2YXIgc2NvcGUgPSBkZXNjLnNjb3BlIHx8ICdtb2RlbCc7CiAgICAgICAgdmFyIHBhcnRzID0gdm9pZCAwOwoKICAgICAgICBpZiAoc2NvcGUgPT09ICdjb250cm9sbGVyJykgewogICAgICAgICAgcGFydHMgPSBbXTsKICAgICAgICB9CgogICAgICAgIHZhciB1cmxLZXkgPSBkZXNjLmFzIHx8IHRoaXMuc2VyaWFsaXplUXVlcnlQYXJhbUtleShwcm9wTmFtZSk7CiAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9ICgwLCBfbWV0YWwuZ2V0KShjb250cm9sbGVyLCBwcm9wTmFtZSk7CiAgICAgICAgZGVmYXVsdFZhbHVlID0gY29weURlZmF1bHRWYWx1ZShkZWZhdWx0VmFsdWUpOwogICAgICAgIHZhciB0eXBlID0gZGVzYy50eXBlIHx8ICgwLCBfcnVudGltZS50eXBlT2YpKGRlZmF1bHRWYWx1ZSk7CiAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZVNlcmlhbGl6ZWQgPSB0aGlzLnNlcmlhbGl6ZVF1ZXJ5UGFyYW0oZGVmYXVsdFZhbHVlLCB1cmxLZXksIHR5cGUpOwogICAgICAgIHZhciBzY29wZWRQcm9wZXJ0eU5hbWUgPSBjb250cm9sbGVyTmFtZSArICI6IiArIHByb3BOYW1lOwogICAgICAgIHZhciBxcCA9IHsKICAgICAgICAgIHVuZGVjb3JhdGVkRGVmYXVsdFZhbHVlOiAoMCwgX21ldGFsLmdldCkoY29udHJvbGxlciwgcHJvcE5hbWUpLAogICAgICAgICAgZGVmYXVsdFZhbHVlOiBkZWZhdWx0VmFsdWUsCiAgICAgICAgICBzZXJpYWxpemVkRGVmYXVsdFZhbHVlOiBkZWZhdWx0VmFsdWVTZXJpYWxpemVkLAogICAgICAgICAgc2VyaWFsaXplZFZhbHVlOiBkZWZhdWx0VmFsdWVTZXJpYWxpemVkLAogICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgIHVybEtleTogdXJsS2V5LAogICAgICAgICAgcHJvcDogcHJvcE5hbWUsCiAgICAgICAgICBzY29wZWRQcm9wZXJ0eU5hbWU6IHNjb3BlZFByb3BlcnR5TmFtZSwKICAgICAgICAgIGNvbnRyb2xsZXJOYW1lOiBjb250cm9sbGVyTmFtZSwKICAgICAgICAgIHJvdXRlOiB0aGlzLAogICAgICAgICAgcGFydHM6IHBhcnRzLAogICAgICAgICAgdmFsdWVzOiBudWxsLAogICAgICAgICAgc2NvcGU6IHNjb3BlCiAgICAgICAgfTsKICAgICAgICBtYXBbcHJvcE5hbWVdID0gbWFwW3VybEtleV0gPSBtYXBbc2NvcGVkUHJvcGVydHlOYW1lXSA9IHFwOwogICAgICAgIHFwcy5wdXNoKHFwKTsKICAgICAgICBwcm9wZXJ0eU5hbWVzLnB1c2gocHJvcE5hbWUpOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIHFwczogcXBzLAogICAgICAgIG1hcDogbWFwLAogICAgICAgIHByb3BlcnR5TmFtZXM6IHByb3BlcnR5TmFtZXMsCiAgICAgICAgc3RhdGVzOiB7CiAgICAgICAgICAvKgogICAgICAgICAgICBDYWxsZWQgd2hlbiBhIHF1ZXJ5IHBhcmFtZXRlciBjaGFuZ2VzIGluIHRoZSBVUkwsIHRoaXMgcm91dGUgY2FyZXMKICAgICAgICAgICAgYWJvdXQgdGhhdCBxdWVyeSBwYXJhbWV0ZXIsIGJ1dCB0aGUgcm91dGUgaXMgbm90IGN1cnJlbnRseQogICAgICAgICAgICBpbiB0aGUgYWN0aXZlIHJvdXRlIGhpZXJhcmNoeS4KICAgICAgICAgICovCiAgICAgICAgICBpbmFjdGl2ZTogZnVuY3Rpb24gaW5hY3RpdmUocHJvcCwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIHFwID0gbWFwW3Byb3BdOwoKICAgICAgICAgICAgX3RoaXMzLl9xcENoYW5nZWQocHJvcCwgdmFsdWUsIHFwKTsKICAgICAgICAgIH0sCgogICAgICAgICAgLyoKICAgICAgICAgICAgQ2FsbGVkIHdoZW4gYSBxdWVyeSBwYXJhbWV0ZXIgY2hhbmdlcyBpbiB0aGUgVVJMLCB0aGlzIHJvdXRlIGNhcmVzCiAgICAgICAgICAgIGFib3V0IHRoYXQgcXVlcnkgcGFyYW1ldGVyLCBhbmQgdGhlIHJvdXRlIGlzIGN1cnJlbnRseQogICAgICAgICAgICBpbiB0aGUgYWN0aXZlIHJvdXRlIGhpZXJhcmNoeS4KICAgICAgICAgICovCiAgICAgICAgICBhY3RpdmU6IGZ1bmN0aW9uIGFjdGl2ZShwcm9wLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgcXAgPSBtYXBbcHJvcF07CgogICAgICAgICAgICBfdGhpczMuX3FwQ2hhbmdlZChwcm9wLCB2YWx1ZSwgcXApOwoKICAgICAgICAgICAgcmV0dXJuIF90aGlzMy5fYWN0aXZlUVBDaGFuZ2VkKHFwLCB2YWx1ZSk7CiAgICAgICAgICB9LAoKICAgICAgICAgIC8qCiAgICAgICAgICAgIENhbGxlZCB3aGVuIGEgdmFsdWUgb2YgYSBxdWVyeSBwYXJhbWV0ZXIgdGhpcyByb3V0ZSBoYW5kbGVzIGNoYW5nZXMgaW4gYSBjb250cm9sbGVyCiAgICAgICAgICAgIGFuZCB0aGUgcm91dGUgaXMgY3VycmVudGx5IGluIHRoZSBhY3RpdmUgcm91dGUgaGllcmFyY2h5LgogICAgICAgICAgKi8KICAgICAgICAgIGFsbG93T3ZlcnJpZGVzOiBmdW5jdGlvbiBhbGxvd092ZXJyaWRlcyhwcm9wLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgcXAgPSBtYXBbcHJvcF07CgogICAgICAgICAgICBfdGhpczMuX3FwQ2hhbmdlZChwcm9wLCB2YWx1ZSwgcXApOwoKICAgICAgICAgICAgcmV0dXJuIF90aGlzMy5fdXBkYXRpbmdRUENoYW5nZWQocXApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH0pLAoKICAgIC8qKgogICAgICBTZW5kcyBhbiBhY3Rpb24gdG8gdGhlIHJvdXRlciwgd2hpY2ggd2lsbCBkZWxlZ2F0ZSBpdCB0byB0aGUgY3VycmVudGx5CiAgICAgIGFjdGl2ZSByb3V0ZSBoaWVyYXJjaHkgcGVyIHRoZSBidWJibGluZyBydWxlcyBleHBsYWluZWQgdW5kZXIgYGFjdGlvbnNgLgogICAgICAgICBFeGFtcGxlCiAgICAgICAgIGBgYGFwcC9yb3V0ZXIuanMKICAgICAgLy8gLi4uCiAgICAgICAgIFJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yb3V0ZSgnaW5kZXgnKTsKICAgICAgfSk7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlcjsKICAgICAgYGBgCiAgICAgICAgIGBgYGFwcC9yb3V0ZXMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgaW1wb3J0IHsgYWN0aW9uIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIEFwcGxpY2F0aW9uUm91dGUgZXh0ZW5kcyBSb3V0ZSB7CiAgICAgICAgQGFjdGlvbgogICAgICAgIHRyYWNrKGFyZykgewogICAgICAgICAgY29uc29sZS5sb2coYXJnLCAnd2FzIGNsaWNrZWQnKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICAgIGBgYGFwcC9yb3V0ZXMvaW5kZXguanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgaW1wb3J0IHsgYWN0aW9uIH0gZnJvbSAnQGdsaW1tZXIvdHJhY2tpbmcnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBJbmRleFJvdXRlIGV4dGVuZHMgUm91dGUgewogICAgICAgIEBhY3Rpb24KICAgICAgICB0cmFja0lmRGVidWcoYXJnKSB7CiAgICAgICAgICBpZiAoZGVidWcpIHsKICAgICAgICAgICAgdGhpcy5zZW5kKCd0cmFjaycsIGFyZyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgICBAbWV0aG9kIHNlbmQKICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIG5hbWUgb2YgdGhlIGFjdGlvbiB0byB0cmlnZ2VyCiAgICAgIEBwYXJhbSB7Li4uKn0gYXJncwogICAgICBAc2luY2UgMS4wLjAKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHNlbmQ6IGZ1bmN0aW9uIHNlbmQoKSB7CiAgICAgIGZvciAodmFyIF9sZW40ID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuNCksIF9rZXk0ID0gMDsgX2tleTQgPCBfbGVuNDsgX2tleTQrKykgewogICAgICAgIGFyZ3NbX2tleTRdID0gYXJndW1lbnRzW19rZXk0XTsKICAgICAgfQoKICAgICAgKGZhbHNlICYmICEoIXRoaXMuaXNEZXN0cm95aW5nICYmICF0aGlzLmlzRGVzdHJveWVkKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkF0dGVtcHRlZCB0byBjYWxsIC5zZW5kKCkgd2l0aCB0aGUgYWN0aW9uICciICsgYXJnc1swXSArICInIG9uIHRoZSBkZXN0cm95ZWQgcm91dGUgJyIgKyB0aGlzLnJvdXRlTmFtZSArICInLiIsICF0aGlzLmlzRGVzdHJveWluZyAmJiAhdGhpcy5pc0Rlc3Ryb3llZCkpOwoKICAgICAgaWYgKHRoaXMuX3JvdXRlciAmJiB0aGlzLl9yb3V0ZXIuX3JvdXRlck1pY3JvbGliIHx8ICEoMCwgX2RlYnVnLmlzVGVzdGluZykoKSkgewogICAgICAgIHZhciBfdGhpcyRfcm91dGVyNDsKCiAgICAgICAgKF90aGlzJF9yb3V0ZXI0ID0gdGhpcy5fcm91dGVyKS5zZW5kLmFwcGx5KF90aGlzJF9yb3V0ZXI0LCBhcmdzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgbmFtZSA9IGFyZ3Muc2hpZnQoKTsKICAgICAgICB2YXIgYWN0aW9uID0gdGhpcy5hY3Rpb25zW25hbWVdOwoKICAgICAgICBpZiAoYWN0aW9uKSB7CiAgICAgICAgICByZXR1cm4gYWN0aW9uLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAgVGhlIGNvbnRyb2xsZXIgYXNzb2NpYXRlZCB3aXRoIHRoaXMgcm91dGUuCiAgICAgICAgIEV4YW1wbGUKICAgICAgICAgYGBgYXBwL3JvdXRlcy9mb3JtLmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgIGltcG9ydCB7IGFjdGlvbiB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBGb3JtUm91dGUgZXh0ZW5kcyBSb3V0ZSB7CiAgICAgICAgQGFjdGlvbgogICAgICAgIHdpbGxUcmFuc2l0aW9uKHRyYW5zaXRpb24pIHsKICAgICAgICAgIGlmICh0aGlzLmNvbnRyb2xsZXIuZ2V0KCd1c2VySGFzRW50ZXJlZERhdGEnKSAmJgogICAgICAgICAgICAgICFjb25maXJtKCdBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gYWJhbmRvbiBwcm9ncmVzcz8nKSkgewogICAgICAgICAgICB0cmFuc2l0aW9uLmFib3J0KCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBCdWJibGUgdGhlIGB3aWxsVHJhbnNpdGlvbmAgYWN0aW9uIHNvIHRoYXQKICAgICAgICAgICAgLy8gcGFyZW50IHJvdXRlcyBjYW4gZGVjaWRlIHdoZXRoZXIgb3Igbm90IHRvIGFib3J0LgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICAgIEBwcm9wZXJ0eSBjb250cm9sbGVyCiAgICAgIEB0eXBlIENvbnRyb2xsZXIKICAgICAgQHNpbmNlIDEuNi4wCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBhY3Rpb25zOiB7CiAgICAgIC8qKgogICAgICBUaGlzIGFjdGlvbiBpcyBjYWxsZWQgd2hlbiBvbmUgb3IgbW9yZSBxdWVyeSBwYXJhbXMgaGF2ZSBjaGFuZ2VkLiBCdWJibGVzLgogICAgICAgICAgIEBtZXRob2QgcXVlcnlQYXJhbXNEaWRDaGFuZ2UKICAgICAgQHBhcmFtIGNoYW5nZWQge09iamVjdH0gS2V5cyBhcmUgbmFtZXMgb2YgcXVlcnkgcGFyYW1zIHRoYXQgaGF2ZSBjaGFuZ2VkLgogICAgICBAcGFyYW0gdG90YWxQcmVzZW50IHtPYmplY3R9IEtleXMgYXJlIG5hbWVzIG9mIHF1ZXJ5IHBhcmFtcyB0aGF0IGFyZSBjdXJyZW50bHkgc2V0LgogICAgICBAcGFyYW0gcmVtb3ZlZCB7T2JqZWN0fSBLZXlzIGFyZSBuYW1lcyBvZiBxdWVyeSBwYXJhbXMgdGhhdCBoYXZlIGJlZW4gcmVtb3ZlZC4KICAgICAgQHJldHVybnMge2Jvb2xlYW59CiAgICAgIEBwcml2YXRlCiAgICAgICovCiAgICAgIHF1ZXJ5UGFyYW1zRGlkQ2hhbmdlOiBmdW5jdGlvbiBxdWVyeVBhcmFtc0RpZENoYW5nZShjaGFuZ2VkLCBfdG90YWxQcmVzZW50LCByZW1vdmVkKSB7CiAgICAgICAgdmFyIHFwTWFwID0gKDAsIF9tZXRhbC5nZXQpKHRoaXMsICdfcXAnKS5tYXA7CiAgICAgICAgdmFyIHRvdGFsQ2hhbmdlZCA9IE9iamVjdC5rZXlzKGNoYW5nZWQpLmNvbmNhdChPYmplY3Qua2V5cyhyZW1vdmVkKSk7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdG90YWxDaGFuZ2VkLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICB2YXIgcXAgPSBxcE1hcFt0b3RhbENoYW5nZWRbaV1dOwoKICAgICAgICAgIGlmIChxcCAmJiAoMCwgX21ldGFsLmdldCkodGhpcy5fb3B0aW9uc0ZvclF1ZXJ5UGFyYW0ocXApLCAncmVmcmVzaE1vZGVsJykgJiYgdGhpcy5fcm91dGVyLmN1cnJlbnRTdGF0ZSkgewogICAgICAgICAgICB0aGlzLnJlZnJlc2goKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSwKICAgICAgZmluYWxpemVRdWVyeVBhcmFtQ2hhbmdlOiBmdW5jdGlvbiBmaW5hbGl6ZVF1ZXJ5UGFyYW1DaGFuZ2UocGFyYW1zLCBmaW5hbFBhcmFtcywgdHJhbnNpdGlvbikgewogICAgICAgIGlmICh0aGlzLmZ1bGxSb3V0ZU5hbWUgIT09ICdhcHBsaWNhdGlvbicpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gLy8gVHJhbnNpdGlvbiBvYmplY3QgaXMgYWJzZW50IGZvciBpbnRlcm1lZGlhdGUgdHJhbnNpdGlvbnMuCgoKICAgICAgICBpZiAoIXRyYW5zaXRpb24pIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciByb3V0ZUluZm9zID0gdHJhbnNpdGlvbltfcm91dGVyX2pzLlNUQVRFX1NZTUJPTF0ucm91dGVJbmZvczsKICAgICAgICB2YXIgcm91dGVyID0gdGhpcy5fcm91dGVyOwoKICAgICAgICB2YXIgcXBNZXRhID0gcm91dGVyLl9xdWVyeVBhcmFtc0Zvcihyb3V0ZUluZm9zKTsKCiAgICAgICAgdmFyIGNoYW5nZXMgPSByb3V0ZXIuX3FwVXBkYXRlczsKICAgICAgICB2YXIgcXBVcGRhdGVkID0gZmFsc2U7CiAgICAgICAgdmFyIHJlcGxhY2VVcmw7CiAgICAgICAgKDAsIF91dGlsczIuc3Rhc2hQYXJhbU5hbWVzKShyb3V0ZXIsIHJvdXRlSW5mb3MpOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHFwTWV0YS5xcHMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIHZhciBxcCA9IHFwTWV0YS5xcHNbaV07CiAgICAgICAgICB2YXIgcm91dGUgPSBxcC5yb3V0ZTsKICAgICAgICAgIHZhciBjb250cm9sbGVyID0gcm91dGUuY29udHJvbGxlcjsKICAgICAgICAgIHZhciBwcmVzZW50S2V5ID0gcXAudXJsS2V5IGluIHBhcmFtcyAmJiBxcC51cmxLZXk7IC8vIERvIGEgcmV2ZXJzZSBsb29rdXAgdG8gc2VlIGlmIHRoZSBjaGFuZ2VkIHF1ZXJ5CiAgICAgICAgICAvLyBwYXJhbSBVUkwga2V5IGNvcnJlc3BvbmRzIHRvIGEgUVAgcHJvcGVydHkgb24KICAgICAgICAgIC8vIHRoaXMgY29udHJvbGxlci4KCiAgICAgICAgICB2YXIgdmFsdWUgPSB2b2lkIDAsCiAgICAgICAgICAgICAgc3ZhbHVlID0gdm9pZCAwOwoKICAgICAgICAgIGlmIChjaGFuZ2VzLmhhcyhxcC51cmxLZXkpKSB7CiAgICAgICAgICAgIC8vIFZhbHVlIHVwZGF0ZWQgaW4vYmVmb3JlIHNldHVwQ29udHJvbGxlcgogICAgICAgICAgICB2YWx1ZSA9ICgwLCBfbWV0YWwuZ2V0KShjb250cm9sbGVyLCBxcC5wcm9wKTsKICAgICAgICAgICAgc3ZhbHVlID0gcm91dGUuc2VyaWFsaXplUXVlcnlQYXJhbSh2YWx1ZSwgcXAudXJsS2V5LCBxcC50eXBlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChwcmVzZW50S2V5KSB7CiAgICAgICAgICAgICAgc3ZhbHVlID0gcGFyYW1zW3ByZXNlbnRLZXldOwoKICAgICAgICAgICAgICBpZiAoc3ZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gcm91dGUuZGVzZXJpYWxpemVRdWVyeVBhcmFtKHN2YWx1ZSwgcXAudXJsS2V5LCBxcC50eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gTm8gUVAgcHJvdmlkZWQ7IHVzZSBkZWZhdWx0IHZhbHVlLgogICAgICAgICAgICAgIHN2YWx1ZSA9IHFwLnNlcmlhbGl6ZWREZWZhdWx0VmFsdWU7CiAgICAgICAgICAgICAgdmFsdWUgPSBjb3B5RGVmYXVsdFZhbHVlKHFwLmRlZmF1bHRWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBjb250cm9sbGVyLl9xcERlbGVnYXRlID0gKDAsIF9tZXRhbC5nZXQpKHJvdXRlLCAnX3FwLnN0YXRlcy5pbmFjdGl2ZScpOwogICAgICAgICAgdmFyIHRoaXNRdWVyeVBhcmFtQ2hhbmdlZCA9IHN2YWx1ZSAhPT0gcXAuc2VyaWFsaXplZFZhbHVlOwoKICAgICAgICAgIGlmICh0aGlzUXVlcnlQYXJhbUNoYW5nZWQpIHsKICAgICAgICAgICAgaWYgKHRyYW5zaXRpb24ucXVlcnlQYXJhbXNPbmx5ICYmIHJlcGxhY2VVcmwgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSByb3V0ZS5fb3B0aW9uc0ZvclF1ZXJ5UGFyYW0ocXApOwoKICAgICAgICAgICAgICB2YXIgcmVwbGFjZUNvbmZpZ1ZhbHVlID0gKDAsIF9tZXRhbC5nZXQpKG9wdGlvbnMsICdyZXBsYWNlJyk7CgogICAgICAgICAgICAgIGlmIChyZXBsYWNlQ29uZmlnVmFsdWUpIHsKICAgICAgICAgICAgICAgIHJlcGxhY2VVcmwgPSB0cnVlOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVwbGFjZUNvbmZpZ1ZhbHVlID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgLy8gRXhwbGljaXQgcHVzaFN0YXRlIHdpbnMgb3ZlciBhbnkgb3RoZXIgcmVwbGFjZVN0YXRlcy4KICAgICAgICAgICAgICAgIHJlcGxhY2VVcmwgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICgwLCBfbWV0YWwuc2V0KShjb250cm9sbGVyLCBxcC5wcm9wLCB2YWx1ZSk7CiAgICAgICAgICAgIHFwVXBkYXRlZCA9IHRydWU7CiAgICAgICAgICB9IC8vIFN0YXNoIGN1cnJlbnQgc2VyaWFsaXplZCB2YWx1ZSBvZiBjb250cm9sbGVyLgoKCiAgICAgICAgICBxcC5zZXJpYWxpemVkVmFsdWUgPSBzdmFsdWU7CiAgICAgICAgICB2YXIgdGhpc1F1ZXJ5UGFyYW1IYXNEZWZhdWx0VmFsdWUgPSBxcC5zZXJpYWxpemVkRGVmYXVsdFZhbHVlID09PSBzdmFsdWU7CgogICAgICAgICAgaWYgKCF0aGlzUXVlcnlQYXJhbUhhc0RlZmF1bHRWYWx1ZSB8fCB0cmFuc2l0aW9uLl9rZWVwRGVmYXVsdFF1ZXJ5UGFyYW1WYWx1ZXMpIHsKICAgICAgICAgICAgZmluYWxQYXJhbXMucHVzaCh7CiAgICAgICAgICAgICAgdmFsdWU6IHN2YWx1ZSwKICAgICAgICAgICAgICB2aXNpYmxlOiB0cnVlLAogICAgICAgICAgICAgIGtleTogcHJlc2VudEtleSB8fCBxcC51cmxLZXkKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBTb21lIFFQcyBoYXZlIGJlZW4gdXBkYXRlZCwgYW5kIHRob3NlIGNoYW5nZXMgbmVlZCB0byBiZSBwcm9wb2dhdGVkCiAgICAgICAgLy8gaW1tZWRpYXRlbHkuIEV2ZW50dWFsbHksIHdlIHNob3VsZCB3b3JrIG9uIG1ha2luZyB0aGlzIGFzeW5jIHNvbWVob3cuCgoKICAgICAgICBpZiAodHJ1ZQogICAgICAgIC8qIEVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyAqLwogICAgICAgICYmIHFwVXBkYXRlZCA9PT0gdHJ1ZSkgewogICAgICAgICAgKDAsIF9tZXRhbC5mbHVzaEFzeW5jT2JzZXJ2ZXJzKShmYWxzZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAocmVwbGFjZVVybCkgewogICAgICAgICAgdHJhbnNpdGlvbi5tZXRob2QoJ3JlcGxhY2UnKTsKICAgICAgICB9CgogICAgICAgIHFwTWV0YS5xcHMuZm9yRWFjaChmdW5jdGlvbiAocXApIHsKICAgICAgICAgIHZhciByb3V0ZVFwTWV0YSA9ICgwLCBfbWV0YWwuZ2V0KShxcC5yb3V0ZSwgJ19xcCcpOwogICAgICAgICAgdmFyIGZpbmFsaXplZENvbnRyb2xsZXIgPSBxcC5yb3V0ZS5jb250cm9sbGVyOwogICAgICAgICAgZmluYWxpemVkQ29udHJvbGxlci5fcXBEZWxlZ2F0ZSA9ICgwLCBfbWV0YWwuZ2V0KShyb3V0ZVFwTWV0YSwgJ3N0YXRlcy5hY3RpdmUnKTsKICAgICAgICB9KTsKCiAgICAgICAgcm91dGVyLl9xcFVwZGF0ZXMuY2xlYXIoKTsKCiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgfSk7CiAgdmFyIFJPVVRFUl9FVkVOVF9ERVBSRUNBVElPTlM7CiAgX2V4cG9ydHMuUk9VVEVSX0VWRU5UX0RFUFJFQ0FUSU9OUyA9IFJPVVRFUl9FVkVOVF9ERVBSRUNBVElPTlM7CgogIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLlJPVVRFUl9FVkVOVFMpIHsKICAgIF9leHBvcnRzLlJPVVRFUl9FVkVOVF9ERVBSRUNBVElPTlMgPSBST1VURVJfRVZFTlRfREVQUkVDQVRJT05TID0gewogICAgICBvbjogZnVuY3Rpb24gb24obmFtZSkgewogICAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIHZhciBoYXNEaWRUcmFuc2l0aW9uID0gbmFtZSA9PT0gJ2RpZFRyYW5zaXRpb24nOwogICAgICAgIHZhciBoYXNXaWxsVHJhbnNpdGlvbiA9IG5hbWUgPT09ICd3aWxsVHJhbnNpdGlvbic7CgogICAgICAgIGlmIChoYXNEaWRUcmFuc2l0aW9uKSB7CiAgICAgICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCdZb3UgYXR0ZW1wdGVkIHRvIGxpc3RlbiB0byB0aGUgImRpZFRyYW5zaXRpb24iIGV2ZW50IHdoaWNoIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSBpbmplY3QgdGhlIHJvdXRlciBzZXJ2aWNlIGFuZCBsaXN0ZW4gdG8gdGhlICJyb3V0ZURpZENoYW5nZSIgZXZlbnQuJywgZmFsc2UsIHsKICAgICAgICAgICAgaWQ6ICdkZXByZWNhdGUtcm91dGVyLWV2ZW50cycsCiAgICAgICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgICAgICB1cmw6ICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92My54I3RvY19kZXByZWNhdGUtcm91dGVyLWV2ZW50cycKICAgICAgICAgIH0pKTsKICAgICAgICB9CgogICAgICAgIGlmIChoYXNXaWxsVHJhbnNpdGlvbikgewogICAgICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgnWW91IGF0dGVtcHRlZCB0byBsaXN0ZW4gdG8gdGhlICJ3aWxsVHJhbnNpdGlvbiIgZXZlbnQgd2hpY2ggaXMgZGVwcmVjYXRlZC4gUGxlYXNlIGluamVjdCB0aGUgcm91dGVyIHNlcnZpY2UgYW5kIGxpc3RlbiB0byB0aGUgInJvdXRlV2lsbENoYW5nZSIgZXZlbnQuJywgZmFsc2UsIHsKICAgICAgICAgICAgaWQ6ICdkZXByZWNhdGUtcm91dGVyLWV2ZW50cycsCiAgICAgICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgICAgICB1cmw6ICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92My54I3RvY19kZXByZWNhdGUtcm91dGVyLWV2ZW50cycKICAgICAgICAgIH0pKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICBSb3V0ZS5yZW9wZW4oUk9VVEVSX0VWRU5UX0RFUFJFQ0FUSU9OUywgewogICAgICBfcGFyYW1zRm9yOiBmdW5jdGlvbiBfcGFyYW1zRm9yKHJvdXRlTmFtZSwgcGFyYW1zKSB7CiAgICAgICAgdmFyIHRyYW5zaXRpb24gPSB0aGlzLl9yb3V0ZXIuX3JvdXRlck1pY3JvbGliLmFjdGl2ZVRyYW5zaXRpb247CgogICAgICAgIGlmICh0cmFuc2l0aW9uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnBhcmFtc0Zvcihyb3V0ZU5hbWUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHBhcmFtczsKICAgICAgfQogICAgfSk7CiAgfQoKICAoMCwgX3J1bnRpbWUuc2V0RnJhbWV3b3JrQ2xhc3MpKFJvdXRlKTsKICB2YXIgX2RlZmF1bHQgPSBSb3V0ZTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL3N5c3RlbS9yb3V0ZXIiLCBbImV4cG9ydHMiLCAiZW1iZXItYmFiZWwiLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiLCAiQGVtYmVyLy1pbnRlcm5hbHMvb3duZXIiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZSIsICJAZW1iZXIvZGVidWciLCAiQGVtYmVyL2RlcHJlY2F0ZWQtZmVhdHVyZXMiLCAiQGVtYmVyL2Vycm9yIiwgIkBlbWJlci9wb2x5ZmlsbHMiLCAiQGVtYmVyL3J1bmxvb3AiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvbG9jYXRpb24vYXBpIiwgIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL3V0aWxzIiwgIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL3N5c3RlbS9kc2wiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvc3lzdGVtL3JvdXRlIiwgIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL3N5c3RlbS9yb3V0ZXJfc3RhdGUiLCAicm91dGVyX2pzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2VtYmVyQmFiZWwsIF9tZXRhbCwgX293bmVyLCBfcnVudGltZSwgX2RlYnVnLCBfZGVwcmVjYXRlZEZlYXR1cmVzLCBfZXJyb3IzLCBfcG9seWZpbGxzLCBfcnVubG9vcCwgX2FwaSwgX3V0aWxzLCBfZHNsLCBfcm91dGUsIF9yb3V0ZXJfc3RhdGUsIF9yb3V0ZXJfanMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLnRyaWdnZXJFdmVudCA9IF90cmlnZ2VyRXZlbnQ7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgZnVuY3Rpb24gZGVmYXVsdERpZFRyYW5zaXRpb24oaW5mb3MpIHsKICAgIHVwZGF0ZVBhdGhzKHRoaXMpOwoKICAgIHRoaXMuX2NhbmNlbFNsb3dUcmFuc2l0aW9uVGltZXIoKTsKCiAgICB0aGlzLm5vdGlmeVByb3BlcnR5Q2hhbmdlKCd1cmwnKTsKICAgIHRoaXMuc2V0KCdjdXJyZW50U3RhdGUnLCB0aGlzLnRhcmdldFN0YXRlKTsgLy8gUHV0IHRoaXMgaW4gdGhlIHJ1bmxvb3Agc28gdXJsIHdpbGwgYmUgYWNjdXJhdGUuIFNlZW1zCiAgICAvLyBsZXNzIHN1cnByaXNpbmcgdGhhbiBkaWRUcmFuc2l0aW9uIGJlaW5nIG91dCBvZiBzeW5jLgoKICAgICgwLCBfcnVubG9vcC5vbmNlKSh0aGlzLCB0aGlzLnRyaWdnZXIsICdkaWRUcmFuc2l0aW9uJyk7CgogICAgaWYgKGZhbHNlCiAgICAvKiBERUJVRyAqLwogICAgKSB7CiAgICAgIGlmICgoMCwgX21ldGFsLmdldCkodGhpcywgJ25hbWVzcGFjZScpLkxPR19UUkFOU0lUSU9OUykgewogICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlCiAgICAgICAgY29uc29sZS5sb2coIlRyYW5zaXRpb25lZCBpbnRvICciICsgRW1iZXJSb3V0ZXIuX3JvdXRlUGF0aChpbmZvcykgKyAiJyIpOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkZWZhdWx0V2lsbFRyYW5zaXRpb24ob2xkSW5mb3MsIG5ld0luZm9zLCB0cmFuc2l0aW9uKSB7CiAgICAoMCwgX3J1bmxvb3Aub25jZSkodGhpcywgdGhpcy50cmlnZ2VyLCAnd2lsbFRyYW5zaXRpb24nLCB0cmFuc2l0aW9uKTsKCiAgICBpZiAoZmFsc2UKICAgIC8qIERFQlVHICovCiAgICApIHsKICAgICAgaWYgKCgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAnbmFtZXNwYWNlJykuTE9HX1RSQU5TSVRJT05TKSB7CiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGUKICAgICAgICBjb25zb2xlLmxvZygiUHJlcGFyaW5nIHRvIHRyYW5zaXRpb24gZnJvbSAnIiArIEVtYmVyUm91dGVyLl9yb3V0ZVBhdGgob2xkSW5mb3MpICsgIicgdG8gJyIgKyBFbWJlclJvdXRlci5fcm91dGVQYXRoKG5ld0luZm9zKSArICInIik7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIEsoKSB7CiAgICByZXR1cm4gdGhpczsKICB9CgogIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAvKioKICAgIFRoZSBgRW1iZXJSb3V0ZXJgIGNsYXNzIG1hbmFnZXMgdGhlIGFwcGxpY2F0aW9uIHN0YXRlIGFuZCBVUkxzLiBSZWZlciB0bwogICAgdGhlIFtyb3V0aW5nIGd1aWRlXShodHRwczovL2d1aWRlcy5lbWJlcmpzLmNvbS9yZWxlYXNlL3JvdXRpbmcvKSBmb3IgZG9jdW1lbnRhdGlvbi4KICAKICAgIEBjbGFzcyBFbWJlclJvdXRlcgogICAgQGV4dGVuZHMgRW1iZXJPYmplY3QKICAgIEB1c2VzIEV2ZW50ZWQKICAgIEBwdWJsaWMKICAqLwoKICB2YXIgRW1iZXJSb3V0ZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0VtYmVyT2JqZWN0KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoRW1iZXJSb3V0ZXIsIF9FbWJlck9iamVjdCk7CgogICAgZnVuY3Rpb24gRW1iZXJSb3V0ZXIoKSB7CiAgICAgIHZhciBfdGhpczsKCiAgICAgIF90aGlzID0gX0VtYmVyT2JqZWN0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgICAgX3RoaXMuY3VycmVudFVSTCA9IG51bGw7CiAgICAgIF90aGlzLmN1cnJlbnRSb3V0ZU5hbWUgPSBudWxsOwogICAgICBfdGhpcy5jdXJyZW50UGF0aCA9IG51bGw7CiAgICAgIF90aGlzLmN1cnJlbnRSb3V0ZSA9IG51bGw7CiAgICAgIF90aGlzLl9xcENhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgX3RoaXMuX3FwVXBkYXRlcyA9IG5ldyBTZXQoKTsKICAgICAgX3RoaXMuX2hhbmRsZWRFcnJvcnMgPSBuZXcgU2V0KCk7CiAgICAgIF90aGlzLl9lbmdpbmVJbnN0YW5jZXMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBfdGhpcy5fZW5naW5lSW5mb0J5Um91dGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBfdGhpcy5jdXJyZW50U3RhdGUgPSBudWxsOwogICAgICBfdGhpcy50YXJnZXRTdGF0ZSA9IG51bGw7CgogICAgICBfdGhpcy5fcmVzZXRRdWV1ZWRRdWVyeVBhcmFtZXRlckNoYW5nZXMoKTsKCiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICB2YXIgX3Byb3RvID0gRW1iZXJSb3V0ZXIucHJvdG90eXBlOwoKICAgIF9wcm90by5faW5pdFJvdXRlckpzID0gZnVuY3Rpb24gX2luaXRSb3V0ZXJKcygpIHsKICAgICAgdmFyIGxvY2F0aW9uID0gKDAsIF9tZXRhbC5nZXQpKHRoaXMsICdsb2NhdGlvbicpOwogICAgICB2YXIgcm91dGVyID0gdGhpczsKICAgICAgdmFyIG93bmVyID0gKDAsIF9vd25lci5nZXRPd25lcikodGhpcyk7CiAgICAgIHZhciBzZWVuID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCiAgICAgIHZhciBQcml2YXRlUm91dGVyID0KICAgICAgLyojX19QVVJFX18qLwogICAgICBmdW5jdGlvbiAoX1JvdXRlcikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShQcml2YXRlUm91dGVyLCBfUm91dGVyKTsKCiAgICAgICAgZnVuY3Rpb24gUHJpdmF0ZVJvdXRlcigpIHsKICAgICAgICAgIHJldHVybiBfUm91dGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgICAgICB9CgogICAgICAgIHZhciBfcHJvdG8yID0gUHJpdmF0ZVJvdXRlci5wcm90b3R5cGU7CgogICAgICAgIF9wcm90bzIuZ2V0Um91dGUgPSBmdW5jdGlvbiBnZXRSb3V0ZShuYW1lKSB7CiAgICAgICAgICB2YXIgcm91dGVOYW1lID0gbmFtZTsKICAgICAgICAgIHZhciByb3V0ZU93bmVyID0gb3duZXI7CiAgICAgICAgICB2YXIgZW5naW5lSW5mbyA9IHJvdXRlci5fZW5naW5lSW5mb0J5Um91dGVbcm91dGVOYW1lXTsKCiAgICAgICAgICBpZiAoZW5naW5lSW5mbykgewogICAgICAgICAgICB2YXIgZW5naW5lSW5zdGFuY2UgPSByb3V0ZXIuX2dldEVuZ2luZUluc3RhbmNlKGVuZ2luZUluZm8pOwoKICAgICAgICAgICAgcm91dGVPd25lciA9IGVuZ2luZUluc3RhbmNlOwogICAgICAgICAgICByb3V0ZU5hbWUgPSBlbmdpbmVJbmZvLmxvY2FsRnVsbE5hbWU7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGZ1bGxSb3V0ZU5hbWUgPSAicm91dGU6IiArIHJvdXRlTmFtZTsKICAgICAgICAgIHZhciByb3V0ZSA9IHJvdXRlT3duZXIubG9va3VwKGZ1bGxSb3V0ZU5hbWUpOwoKICAgICAgICAgIGlmIChzZWVuW25hbWVdKSB7CiAgICAgICAgICAgIHJldHVybiByb3V0ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBzZWVuW25hbWVdID0gdHJ1ZTsKCiAgICAgICAgICBpZiAoIXJvdXRlKSB7CiAgICAgICAgICAgIHZhciBEZWZhdWx0Um91dGUgPSByb3V0ZU93bmVyLmZhY3RvcnlGb3IoJ3JvdXRlOmJhc2ljJykuY2xhc3M7CiAgICAgICAgICAgIHJvdXRlT3duZXIucmVnaXN0ZXIoZnVsbFJvdXRlTmFtZSwgRGVmYXVsdFJvdXRlLmV4dGVuZCgpKTsKICAgICAgICAgICAgcm91dGUgPSByb3V0ZU93bmVyLmxvb2t1cChmdWxsUm91dGVOYW1lKTsKCiAgICAgICAgICAgIGlmIChmYWxzZQogICAgICAgICAgICAvKiBERUJVRyAqLwogICAgICAgICAgICApIHsKICAgICAgICAgICAgICBpZiAoKDAsIF9tZXRhbC5nZXQpKHJvdXRlciwgJ25hbWVzcGFjZS5MT0dfQUNUSVZFX0dFTkVSQVRJT04nKSkgewogICAgICAgICAgICAgICAgKDAsIF9kZWJ1Zy5pbmZvKSgiZ2VuZXJhdGVkIC0+ICIgKyBmdWxsUm91dGVOYW1lLCB7CiAgICAgICAgICAgICAgICAgIGZ1bGxOYW1lOiBmdWxsUm91dGVOYW1lCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByb3V0ZS5fc2V0Um91dGVOYW1lKHJvdXRlTmFtZSk7CgogICAgICAgICAgaWYgKGVuZ2luZUluZm8gJiYgISgwLCBfcm91dGUuaGFzRGVmYXVsdFNlcmlhbGl6ZSkocm91dGUpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRGVmaW5pbmcgYSBjdXN0b20gc2VyaWFsaXplIG1ldGhvZCBvbiBhbiBFbmdpbmUgcm91dGUgaXMgbm90IHN1cHBvcnRlZC4nKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gcm91dGU7CiAgICAgICAgfTsKCiAgICAgICAgX3Byb3RvMi5nZXRTZXJpYWxpemVyID0gZnVuY3Rpb24gZ2V0U2VyaWFsaXplcihuYW1lKSB7CiAgICAgICAgICB2YXIgZW5naW5lSW5mbyA9IHJvdXRlci5fZW5naW5lSW5mb0J5Um91dGVbbmFtZV07IC8vIElmIHRoaXMgaXMgbm90IGFuIEVuZ2luZSByb3V0ZSwgd2UgZmFsbCBiYWNrIHRvIHRoZSBoYW5kbGVyIGZvciBzZXJpYWxpemF0aW9uCgogICAgICAgICAgaWYgKCFlbmdpbmVJbmZvKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gZW5naW5lSW5mby5zZXJpYWxpemVNZXRob2QgfHwgX3JvdXRlLmRlZmF1bHRTZXJpYWxpemU7CiAgICAgICAgfTsKCiAgICAgICAgX3Byb3RvMi51cGRhdGVVUkwgPSBmdW5jdGlvbiB1cGRhdGVVUkwocGF0aCkgewogICAgICAgICAgKDAsIF9ydW5sb29wLm9uY2UpKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgbG9jYXRpb24uc2V0VVJMKHBhdGgpOwogICAgICAgICAgICAoMCwgX21ldGFsLnNldCkocm91dGVyLCAnY3VycmVudFVSTCcsIHBhdGgpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgX3Byb3RvMi5kaWRUcmFuc2l0aW9uID0gZnVuY3Rpb24gZGlkVHJhbnNpdGlvbihpbmZvcykgewogICAgICAgICAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuUk9VVEVSX0VWRU5UUykgewogICAgICAgICAgICBpZiAocm91dGVyLmRpZFRyYW5zaXRpb24gIT09IGRlZmF1bHREaWRUcmFuc2l0aW9uKSB7CiAgICAgICAgICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgnWW91IGF0dGVtcHRlZCB0byBvdmVycmlkZSB0aGUgImRpZFRyYW5zaXRpb24iIG1ldGhvZCB3aGljaCBpcyBkZXByZWNhdGVkLiBQbGVhc2UgaW5qZWN0IHRoZSByb3V0ZXIgc2VydmljZSBhbmQgbGlzdGVuIHRvIHRoZSAicm91dGVEaWRDaGFuZ2UiIGV2ZW50LicsIGZhbHNlLCB7CiAgICAgICAgICAgICAgICBpZDogJ2RlcHJlY2F0ZS1yb3V0ZXItZXZlbnRzJywKICAgICAgICAgICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9lbWJlcmpzLmNvbS9kZXByZWNhdGlvbnMvdjMueCN0b2NfZGVwcmVjYXRlLXJvdXRlci1ldmVudHMnCiAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgcm91dGVyLmRpZFRyYW5zaXRpb24oaW5mb3MpOwogICAgICAgIH07CgogICAgICAgIF9wcm90bzIud2lsbFRyYW5zaXRpb24gPSBmdW5jdGlvbiB3aWxsVHJhbnNpdGlvbihvbGRJbmZvcywgbmV3SW5mb3MsIHRyYW5zaXRpb24pIHsKICAgICAgICAgIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLlJPVVRFUl9FVkVOVFMpIHsKICAgICAgICAgICAgaWYgKHJvdXRlci53aWxsVHJhbnNpdGlvbiAhPT0gZGVmYXVsdFdpbGxUcmFuc2l0aW9uKSB7CiAgICAgICAgICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgnWW91IGF0dGVtcHRlZCB0byBvdmVycmlkZSB0aGUgIndpbGxUcmFuc2l0aW9uIiBtZXRob2Qgd2hpY2ggaXMgZGVwcmVjYXRlZC4gUGxlYXNlIGluamVjdCB0aGUgcm91dGVyIHNlcnZpY2UgYW5kIGxpc3RlbiB0byB0aGUgInJvdXRlV2lsbENoYW5nZSIgZXZlbnQuJywgZmFsc2UsIHsKICAgICAgICAgICAgICAgIGlkOiAnZGVwcmVjYXRlLXJvdXRlci1ldmVudHMnLAogICAgICAgICAgICAgICAgdW50aWw6ICc0LjAuMCcsCiAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92My54I3RvY19kZXByZWNhdGUtcm91dGVyLWV2ZW50cycKICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByb3V0ZXIud2lsbFRyYW5zaXRpb24ob2xkSW5mb3MsIG5ld0luZm9zLCB0cmFuc2l0aW9uKTsKICAgICAgICB9OwoKICAgICAgICBfcHJvdG8yLnRyaWdnZXJFdmVudCA9IGZ1bmN0aW9uIHRyaWdnZXJFdmVudChyb3V0ZUluZm9zLCBpZ25vcmVGYWlsdXJlLCBuYW1lLCBhcmdzKSB7CiAgICAgICAgICByZXR1cm4gX3RyaWdnZXJFdmVudC5iaW5kKHJvdXRlcikocm91dGVJbmZvcywgaWdub3JlRmFpbHVyZSwgbmFtZSwgYXJncyk7CiAgICAgICAgfTsKCiAgICAgICAgX3Byb3RvMi5yb3V0ZVdpbGxDaGFuZ2UgPSBmdW5jdGlvbiByb3V0ZVdpbGxDaGFuZ2UodHJhbnNpdGlvbikgewogICAgICAgICAgcm91dGVyLnRyaWdnZXIoJ3JvdXRlV2lsbENoYW5nZScsIHRyYW5zaXRpb24pOwogICAgICAgIH07CgogICAgICAgIF9wcm90bzIucm91dGVEaWRDaGFuZ2UgPSBmdW5jdGlvbiByb3V0ZURpZENoYW5nZSh0cmFuc2l0aW9uKSB7CiAgICAgICAgICByb3V0ZXIuc2V0KCdjdXJyZW50Um91dGUnLCB0cmFuc2l0aW9uLnRvKTsKICAgICAgICAgICgwLCBfcnVubG9vcC5vbmNlKShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJvdXRlci50cmlnZ2VyKCdyb3V0ZURpZENoYW5nZScsIHRyYW5zaXRpb24pOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgX3Byb3RvMi50cmFuc2l0aW9uRGlkRXJyb3IgPSBmdW5jdGlvbiB0cmFuc2l0aW9uRGlkRXJyb3IoZXJyb3IsIHRyYW5zaXRpb24pIHsKICAgICAgICAgIGlmIChlcnJvci53YXNBYm9ydGVkIHx8IHRyYW5zaXRpb24uaXNBYm9ydGVkKSB7CiAgICAgICAgICAgIC8vIElmIHRoZSBlcnJvciB3YXMgYSB0cmFuc2l0aW9uIGVyb3JyIG9yIHRoZSB0cmFuc2l0aW9uIGFib3J0ZWQKICAgICAgICAgICAgLy8gbG9nIHRoZSBhYm9ydC4KICAgICAgICAgICAgcmV0dXJuICgwLCBfcm91dGVyX2pzLmxvZ0Fib3J0KSh0cmFuc2l0aW9uKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIE90aGVyd2lzZSB0cmlnZ2VyIHRoZSAiZXJyb3IiIGV2ZW50IHRvIGF0dGVtcHQgYW4gaW50ZXJtZWRpYXRlCiAgICAgICAgICAgIC8vIHRyYW5zaXRpb24gaW50byBhbiBlcnJvciBzdWJzdGF0ZQogICAgICAgICAgICB0cmFuc2l0aW9uLnRyaWdnZXIoZmFsc2UsICdlcnJvcicsIGVycm9yLmVycm9yLCB0cmFuc2l0aW9uLCBlcnJvci5yb3V0ZSk7CgogICAgICAgICAgICBpZiAocm91dGVyLl9pc0Vycm9ySGFuZGxlZChlcnJvci5lcnJvcikpIHsKICAgICAgICAgICAgICAvLyBJZiB3ZSBoYW5kbGVkIHRoZSBlcnJvciB3aXRoIGEgc3Vic3RhdGUganVzdCByb2xsIHRoZSBzdGF0ZSBiYWNrIG9uCiAgICAgICAgICAgICAgLy8gdGhlIHRyYW5zaXRpb24gYW5kIHNlbmQgdGhlICJyb3V0ZURpZENoYW5nZSIgZXZlbnQgZm9yIGxhbmRpbmcgb24KICAgICAgICAgICAgICAvLyB0aGUgZXJyb3Igc3Vic3RhdGUgYW5kIHJldHVybiB0aGUgZXJyb3IuCiAgICAgICAgICAgICAgdHJhbnNpdGlvbi5yb2xsYmFjaygpOwogICAgICAgICAgICAgIHRoaXMucm91dGVEaWRDaGFuZ2UodHJhbnNpdGlvbik7CiAgICAgICAgICAgICAgcmV0dXJuIGVycm9yLmVycm9yOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIElmIGl0IHdhcyBub3QgaGFuZGxlZCwgYWJvcnQgdGhlIHRyYW5zaXRpb24gY29tcGxldGVseSBhbmQgcmV0dXJuCiAgICAgICAgICAgICAgLy8gdGhlIGVycm9yLgogICAgICAgICAgICAgIHRyYW5zaXRpb24uYWJvcnQoKTsKICAgICAgICAgICAgICByZXR1cm4gZXJyb3IuZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBfcHJvdG8yLl90cmlnZ2VyV2lsbENoYW5nZUNvbnRleHQgPSBmdW5jdGlvbiBfdHJpZ2dlcldpbGxDaGFuZ2VDb250ZXh0KCkgewogICAgICAgICAgcmV0dXJuIHJvdXRlcjsKICAgICAgICB9OwoKICAgICAgICBfcHJvdG8yLl90cmlnZ2VyV2lsbExlYXZlID0gZnVuY3Rpb24gX3RyaWdnZXJXaWxsTGVhdmUoKSB7CiAgICAgICAgICByZXR1cm4gcm91dGVyOwogICAgICAgIH07CgogICAgICAgIF9wcm90bzIucmVwbGFjZVVSTCA9IGZ1bmN0aW9uIHJlcGxhY2VVUkwodXJsKSB7CiAgICAgICAgICBpZiAobG9jYXRpb24ucmVwbGFjZVVSTCkgewogICAgICAgICAgICB2YXIgZG9SZXBsYWNlVVJMID0gZnVuY3Rpb24gZG9SZXBsYWNlVVJMKCkgewogICAgICAgICAgICAgIGxvY2F0aW9uLnJlcGxhY2VVUkwodXJsKTsKICAgICAgICAgICAgICAoMCwgX21ldGFsLnNldCkocm91dGVyLCAnY3VycmVudFVSTCcsIHVybCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAoMCwgX3J1bmxvb3Aub25jZSkoZG9SZXBsYWNlVVJMKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVVJMKHVybCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFByaXZhdGVSb3V0ZXI7CiAgICAgIH0oX3JvdXRlcl9qcy5kZWZhdWx0KTsKCiAgICAgIHZhciByb3V0ZXJNaWNyb2xpYiA9IHRoaXMuX3JvdXRlck1pY3JvbGliID0gbmV3IFByaXZhdGVSb3V0ZXIoKTsKICAgICAgdmFyIGRzbENhbGxiYWNrcyA9IHRoaXMuY29uc3RydWN0b3IuZHNsQ2FsbGJhY2tzIHx8IFtLXTsKCiAgICAgIHZhciBkc2wgPSB0aGlzLl9idWlsZERTTCgpOwoKICAgICAgZHNsLnJvdXRlKCdhcHBsaWNhdGlvbicsIHsKICAgICAgICBwYXRoOiAnLycsCiAgICAgICAgcmVzZXROYW1lc3BhY2U6IHRydWUsCiAgICAgICAgb3ZlcnJpZGVOYW1lQXNzZXJ0aW9uOiB0cnVlCiAgICAgIH0sIGZ1bmN0aW9uICgpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRzbENhbGxiYWNrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgZHNsQ2FsbGJhY2tzW2ldLmNhbGwodGhpcyk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGlmIChmYWxzZQogICAgICAvKiBERUJVRyAqLwogICAgICApIHsKICAgICAgICBpZiAoKDAsIF9tZXRhbC5nZXQpKHRoaXMsICduYW1lc3BhY2UuTE9HX1RSQU5TSVRJT05TX0lOVEVSTkFMJykpIHsKICAgICAgICAgIHJvdXRlck1pY3JvbGliLmxvZyA9IGNvbnNvbGUubG9nLmJpbmQoY29uc29sZSk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZQogICAgICAgIH0KICAgICAgfQoKICAgICAgcm91dGVyTWljcm9saWIubWFwKGRzbC5nZW5lcmF0ZSgpKTsKICAgIH07CgogICAgX3Byb3RvLl9idWlsZERTTCA9IGZ1bmN0aW9uIF9idWlsZERTTCgpIHsKICAgICAgdmFyIGVuYWJsZUxvYWRpbmdTdWJzdGF0ZXMgPSB0aGlzLl9oYXNNb2R1bGVCYXNlZFJlc29sdmVyKCk7CgogICAgICB2YXIgcm91dGVyID0gdGhpczsKICAgICAgdmFyIG93bmVyID0gKDAsIF9vd25lci5nZXRPd25lcikodGhpcyk7CiAgICAgIHZhciBvcHRpb25zID0gewogICAgICAgIGVuYWJsZUxvYWRpbmdTdWJzdGF0ZXM6IGVuYWJsZUxvYWRpbmdTdWJzdGF0ZXMsCiAgICAgICAgcmVzb2x2ZVJvdXRlTWFwOiBmdW5jdGlvbiByZXNvbHZlUm91dGVNYXAobmFtZSkgewogICAgICAgICAgcmV0dXJuIG93bmVyLmZhY3RvcnlGb3IoInJvdXRlLW1hcDoiICsgbmFtZSk7CiAgICAgICAgfSwKICAgICAgICBhZGRSb3V0ZUZvckVuZ2luZTogZnVuY3Rpb24gYWRkUm91dGVGb3JFbmdpbmUobmFtZSwgZW5naW5lSW5mbykgewogICAgICAgICAgaWYgKCFyb3V0ZXIuX2VuZ2luZUluZm9CeVJvdXRlW25hbWVdKSB7CiAgICAgICAgICAgIHJvdXRlci5fZW5naW5lSW5mb0J5Um91dGVbbmFtZV0gPSBlbmdpbmVJbmZvOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgcmV0dXJuIG5ldyBfZHNsLmRlZmF1bHQobnVsbCwgb3B0aW9ucyk7CiAgICB9CiAgICAvKgogICAgICBSZXNldHMgYWxsIHBlbmRpbmcgcXVlcnkgcGFyYW1ldGVyIGNoYW5nZXMuCiAgICAgIENhbGxlZCBhZnRlciB0cmFuc2l0aW9uaW5nIHRvIGEgbmV3IHJvdXRlCiAgICAgIGJhc2VkIG9uIHF1ZXJ5IHBhcmFtZXRlciBjaGFuZ2VzLgogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uX3Jlc2V0UXVldWVkUXVlcnlQYXJhbWV0ZXJDaGFuZ2VzID0gZnVuY3Rpb24gX3Jlc2V0UXVldWVkUXVlcnlQYXJhbWV0ZXJDaGFuZ2VzKCkgewogICAgICB0aGlzLl9xdWV1ZWRRUENoYW5nZXMgPSB7fTsKICAgIH07CgogICAgX3Byb3RvLl9oYXNNb2R1bGVCYXNlZFJlc29sdmVyID0gZnVuY3Rpb24gX2hhc01vZHVsZUJhc2VkUmVzb2x2ZXIoKSB7CiAgICAgIHZhciBvd25lciA9ICgwLCBfb3duZXIuZ2V0T3duZXIpKHRoaXMpOwoKICAgICAgaWYgKCFvd25lcikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgdmFyIHJlc29sdmVyID0gKDAsIF9tZXRhbC5nZXQpKG93bmVyLCAnYXBwbGljYXRpb24uX19yZWdpc3RyeV9fLnJlc29sdmVyLm1vZHVsZUJhc2VkUmVzb2x2ZXInKTsKICAgICAgcmV0dXJuIEJvb2xlYW4ocmVzb2x2ZXIpOwogICAgfQogICAgLyoqCiAgICAgIEluaXRpYWxpemVzIHRoZSBjdXJyZW50IHJvdXRlciBpbnN0YW5jZSBhbmQgc2V0cyB1cCB0aGUgY2hhbmdlIGhhbmRsaW5nCiAgICAgIGV2ZW50IGxpc3RlbmVycyB1c2VkIGJ5IHRoZSBpbnN0YW5jZXMgYGxvY2F0aW9uYCBpbXBsZW1lbnRhdGlvbi4KICAgICAgICAgQSBwcm9wZXJ0eSBuYW1lZCBgaW5pdGlhbFVSTGAgd2lsbCBiZSB1c2VkIHRvIGRldGVybWluZSB0aGUgaW5pdGlhbCBVUkwuCiAgICAgIElmIG5vIHZhbHVlIGlzIGZvdW5kIGAvYCB3aWxsIGJlIHVzZWQuCiAgICAgICAgIEBtZXRob2Qgc3RhcnRSb3V0aW5nCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgOwoKICAgIF9wcm90by5zdGFydFJvdXRpbmcgPSBmdW5jdGlvbiBzdGFydFJvdXRpbmcoKSB7CiAgICAgIHZhciBpbml0aWFsVVJMID0gKDAsIF9tZXRhbC5nZXQpKHRoaXMsICdpbml0aWFsVVJMJyk7CgogICAgICBpZiAodGhpcy5zZXR1cFJvdXRlcigpKSB7CiAgICAgICAgaWYgKGluaXRpYWxVUkwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgaW5pdGlhbFVSTCA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAnbG9jYXRpb24nKS5nZXRVUkwoKTsKICAgICAgICB9CgogICAgICAgIHZhciBpbml0aWFsVHJhbnNpdGlvbiA9IHRoaXMuaGFuZGxlVVJMKGluaXRpYWxVUkwpOwoKICAgICAgICBpZiAoaW5pdGlhbFRyYW5zaXRpb24gJiYgaW5pdGlhbFRyYW5zaXRpb24uZXJyb3IpIHsKICAgICAgICAgIHRocm93IGluaXRpYWxUcmFuc2l0aW9uLmVycm9yOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uc2V0dXBSb3V0ZXIgPSBmdW5jdGlvbiBzZXR1cFJvdXRlcigpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB0aGlzLl9zZXR1cExvY2F0aW9uKCk7CgogICAgICB2YXIgbG9jYXRpb24gPSAoMCwgX21ldGFsLmdldCkodGhpcywgJ2xvY2F0aW9uJyk7IC8vIEFsbG93IHRoZSBMb2NhdGlvbiBjbGFzcyB0byBjYW5jZWwgdGhlIHJvdXRlciBzZXR1cCB3aGlsZSBpdCByZWZyZXNoZXMKICAgICAgLy8gdGhlIHBhZ2UKCiAgICAgIGlmICgoMCwgX21ldGFsLmdldCkobG9jYXRpb24sICdjYW5jZWxSb3V0ZXJTZXR1cCcpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB0aGlzLl9pbml0Um91dGVySnMoKTsKCiAgICAgIGxvY2F0aW9uLm9uVXBkYXRlVVJMKGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICBfdGhpczIuaGFuZGxlVVJMKHVybCk7CiAgICAgIH0pOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CgogICAgX3Byb3RvLl9zZXRPdXRsZXRzID0gZnVuY3Rpb24gX3NldE91dGxldHMoKSB7CiAgICAgIC8vIFRoaXMgaXMgdHJpZ2dlcmVkIGFzeW5jIGR1cmluZyBSb3V0ZSN3aWxsRGVzdHJveS4KICAgICAgLy8gSWYgdGhlIHJvdXRlciBpcyBhbHNvIGJlaW5nIGRlc3Ryb3llZCB3ZSBkbyBub3Qgd2FudCB0bwogICAgICAvLyB0byBjcmVhdGUgYW5vdGhlciB0aGlzLl90b3BsZXZlbFZpZXcgKGFuZCBsZWFrIHRoZSByZW5kZXJlcikKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95aW5nIHx8IHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciByb3V0ZUluZm9zID0gdGhpcy5fcm91dGVyTWljcm9saWIuY3VycmVudFJvdXRlSW5mb3M7CiAgICAgIHZhciByb3V0ZTsKICAgICAgdmFyIGRlZmF1bHRQYXJlbnRTdGF0ZTsKICAgICAgdmFyIGxpdmVSb3V0ZXMgPSBudWxsOwoKICAgICAgaWYgKCFyb3V0ZUluZm9zKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvdXRlSW5mb3MubGVuZ3RoOyBpKyspIHsKICAgICAgICByb3V0ZSA9IHJvdXRlSW5mb3NbaV0ucm91dGU7CgogICAgICAgIHZhciBjb25uZWN0aW9ucyA9IF9yb3V0ZS5ST1VURV9DT05ORUNUSU9OUy5nZXQocm91dGUpOwoKICAgICAgICB2YXIgb3duU3RhdGUgPSB2b2lkIDA7CgogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgY29ubmVjdGlvbnMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIHZhciBhcHBlbmRlZCA9IGFwcGVuZExpdmVSb3V0ZShsaXZlUm91dGVzLCBkZWZhdWx0UGFyZW50U3RhdGUsIGNvbm5lY3Rpb25zW2pdKTsKICAgICAgICAgIGxpdmVSb3V0ZXMgPSBhcHBlbmRlZC5saXZlUm91dGVzOwoKICAgICAgICAgIGlmIChhcHBlbmRlZC5vd25TdGF0ZS5yZW5kZXIubmFtZSA9PT0gcm91dGUucm91dGVOYW1lIHx8IGFwcGVuZGVkLm93blN0YXRlLnJlbmRlci5vdXRsZXQgPT09ICdtYWluJykgewogICAgICAgICAgICBvd25TdGF0ZSA9IGFwcGVuZGVkLm93blN0YXRlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbm5lY3Rpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgb3duU3RhdGUgPSByZXByZXNlbnRFbXB0eVJvdXRlKGxpdmVSb3V0ZXMsIGRlZmF1bHRQYXJlbnRTdGF0ZSwgcm91dGUpOwogICAgICAgIH0KCiAgICAgICAgZGVmYXVsdFBhcmVudFN0YXRlID0gb3duU3RhdGU7CiAgICAgIH0gLy8gd2hlbiBhIHRyYW5zaXRpb25UbyBoYXBwZW5zIGFmdGVyIHRoZSB2YWxpZGF0aW9uIHBoYXNlCiAgICAgIC8vIGR1cmluZyB0aGUgaW5pdGlhbCB0cmFuc2l0aW9uIF9zZXRPdXRsZXRzIGlzIGNhbGxlZAogICAgICAvLyB3aGVuIG5vIHJvdXRlcyBhcmUgYWN0aXZlLiBIb3dldmVyLCBpdCB3aWxsIGdldCBjYWxsZWQKICAgICAgLy8gYWdhaW4gd2l0aCB0aGUgY29ycmVjdCB2YWx1ZXMgZHVyaW5nIHRoZSBuZXh0IHR1cm4gb2YKICAgICAgLy8gdGhlIHJ1bmxvb3AKCgogICAgICBpZiAoIWxpdmVSb3V0ZXMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5fdG9wbGV2ZWxWaWV3KSB7CiAgICAgICAgdmFyIG93bmVyID0gKDAsIF9vd25lci5nZXRPd25lcikodGhpcyk7CiAgICAgICAgdmFyIE91dGxldFZpZXcgPSBvd25lci5mYWN0b3J5Rm9yKCd2aWV3Oi1vdXRsZXQnKTsKICAgICAgICB0aGlzLl90b3BsZXZlbFZpZXcgPSBPdXRsZXRWaWV3LmNyZWF0ZSgpOwoKICAgICAgICB0aGlzLl90b3BsZXZlbFZpZXcuc2V0T3V0bGV0U3RhdGUobGl2ZVJvdXRlcyk7CgogICAgICAgIHZhciBpbnN0YW5jZSA9IG93bmVyLmxvb2t1cCgnLWFwcGxpY2F0aW9uLWluc3RhbmNlOm1haW4nKTsKICAgICAgICBpbnN0YW5jZS5kaWRDcmVhdGVSb290Vmlldyh0aGlzLl90b3BsZXZlbFZpZXcpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX3RvcGxldmVsVmlldy5zZXRPdXRsZXRTdGF0ZShsaXZlUm91dGVzKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uaGFuZGxlVVJMID0gZnVuY3Rpb24gaGFuZGxlVVJMKHVybCkgewogICAgICAvLyBVbnRpbCB3ZSBoYXZlIGFuIGVtYmVyLWlkaW9tYXRpYyB3YXkgb2YgYWNjZXNzaW5nICNoYXNoZXMsIHdlIG5lZWQgdG8KICAgICAgLy8gcmVtb3ZlIGl0IGJlY2F1c2Ugcm91dGVyLmpzIGRvZXNuJ3Qga25vdyBob3cgdG8gaGFuZGxlIGl0LgogICAgICB2YXIgX3VybCA9IHVybC5zcGxpdCgvIyguKyk/LylbMF07CiAgICAgIHJldHVybiB0aGlzLl9kb1VSTFRyYW5zaXRpb24oJ2hhbmRsZVVSTCcsIF91cmwpOwogICAgfTsKCiAgICBfcHJvdG8uX2RvVVJMVHJhbnNpdGlvbiA9IGZ1bmN0aW9uIF9kb1VSTFRyYW5zaXRpb24ocm91dGVySnNNZXRob2QsIHVybCkgewogICAgICB2YXIgdHJhbnNpdGlvbiA9IHRoaXMuX3JvdXRlck1pY3JvbGliW3JvdXRlckpzTWV0aG9kXSh1cmwgfHwgJy8nKTsKCiAgICAgIGRpZEJlZ2luVHJhbnNpdGlvbih0cmFuc2l0aW9uLCB0aGlzKTsKICAgICAgcmV0dXJuIHRyYW5zaXRpb247CiAgICB9CiAgICAvKioKICAgICAgVHJhbnNpdGlvbiB0aGUgYXBwbGljYXRpb24gaW50byBhbm90aGVyIHJvdXRlLiBUaGUgcm91dGUgbWF5CiAgICAgIGJlIGVpdGhlciBhIHNpbmdsZSByb3V0ZSBvciByb3V0ZSBwYXRoOgogICAgICAgICBTZWUgW3RyYW5zaXRpb25Ub10oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9Sb3V0ZS9tZXRob2RzL3RyYW5zaXRpb25Ubz9hbmNob3I9dHJhbnNpdGlvblRvKSBmb3IgbW9yZSBpbmZvLgogICAgICAgICBAbWV0aG9kIHRyYW5zaXRpb25UbwogICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgcm91dGUgb3IgYSBVUkwKICAgICAgQHBhcmFtIHsuLi5PYmplY3R9IG1vZGVscyB0aGUgbW9kZWwocykgb3IgaWRlbnRpZmllcihzKSB0byBiZSB1c2VkIHdoaWxlCiAgICAgICAgdHJhbnNpdGlvbmluZyB0byB0aGUgcm91dGUuCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gb3B0aW9uYWwgaGFzaCB3aXRoIGEgcXVlcnlQYXJhbXMgcHJvcGVydHkKICAgICAgICBjb250YWluaW5nIGEgbWFwcGluZyBvZiBxdWVyeSBwYXJhbWV0ZXJzCiAgICAgIEByZXR1cm4ge1RyYW5zaXRpb259IHRoZSB0cmFuc2l0aW9uIG9iamVjdCBhc3NvY2lhdGVkIHdpdGggdGhpcwogICAgICAgIGF0dGVtcHRlZCB0cmFuc2l0aW9uCiAgICAgIEBwdWJsaWMKICAgICovCiAgICA7CgogICAgX3Byb3RvLnRyYW5zaXRpb25UbyA9IGZ1bmN0aW9uIHRyYW5zaXRpb25UbygpIHsKICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgYXJnc1tfa2V5XSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgfQoKICAgICAgaWYgKCgwLCBfdXRpbHMucmVzZW1ibGVzVVJMKShhcmdzWzBdKSkgewogICAgICAgIChmYWxzZSAmJiAhKCF0aGlzLmlzRGVzdHJveWluZyAmJiAhdGhpcy5pc0Rlc3Ryb3llZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJBIHRyYW5zaXRpb24gd2FzIGF0dGVtcHRlZCBmcm9tICciICsgdGhpcy5jdXJyZW50Um91dGVOYW1lICsgIicgdG8gJyIgKyBhcmdzWzBdICsgIicgYnV0IHRoZSBhcHBsaWNhdGlvbiBpbnN0YW5jZSBoYXMgYWxyZWFkeSBiZWVuIGRlc3Ryb3llZC4iLCAhdGhpcy5pc0Rlc3Ryb3lpbmcgJiYgIXRoaXMuaXNEZXN0cm95ZWQpKTsKICAgICAgICByZXR1cm4gdGhpcy5fZG9VUkxUcmFuc2l0aW9uKCd0cmFuc2l0aW9uVG8nLCBhcmdzWzBdKTsKICAgICAgfQoKICAgICAgdmFyIF9leHRyYWN0Um91dGVBcmdzID0gKDAsIF91dGlscy5leHRyYWN0Um91dGVBcmdzKShhcmdzKSwKICAgICAgICAgIHJvdXRlTmFtZSA9IF9leHRyYWN0Um91dGVBcmdzLnJvdXRlTmFtZSwKICAgICAgICAgIG1vZGVscyA9IF9leHRyYWN0Um91dGVBcmdzLm1vZGVscywKICAgICAgICAgIHF1ZXJ5UGFyYW1zID0gX2V4dHJhY3RSb3V0ZUFyZ3MucXVlcnlQYXJhbXM7CgogICAgICAoZmFsc2UgJiYgISghdGhpcy5pc0Rlc3Ryb3lpbmcgJiYgIXRoaXMuaXNEZXN0cm95ZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQSB0cmFuc2l0aW9uIHdhcyBhdHRlbXB0ZWQgZnJvbSAnIiArIHRoaXMuY3VycmVudFJvdXRlTmFtZSArICInIHRvICciICsgcm91dGVOYW1lICsgIicgYnV0IHRoZSBhcHBsaWNhdGlvbiBpbnN0YW5jZSBoYXMgYWxyZWFkeSBiZWVuIGRlc3Ryb3llZC4iLCAhdGhpcy5pc0Rlc3Ryb3lpbmcgJiYgIXRoaXMuaXNEZXN0cm95ZWQpKTsKICAgICAgcmV0dXJuIHRoaXMuX2RvVHJhbnNpdGlvbihyb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMpOwogICAgfTsKCiAgICBfcHJvdG8uaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvID0gZnVuY3Rpb24gaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvKG5hbWUpIHsKICAgICAgdmFyIF90aGlzJF9yb3V0ZXJNaWNyb2xpYjsKCiAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiA+IDEgPyBfbGVuMiAtIDEgOiAwKSwgX2tleTIgPSAxOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgYXJnc1tfa2V5MiAtIDFdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgfQoKICAgICAgKF90aGlzJF9yb3V0ZXJNaWNyb2xpYiA9IHRoaXMuX3JvdXRlck1pY3JvbGliKS5pbnRlcm1lZGlhdGVUcmFuc2l0aW9uVG8uYXBwbHkoX3RoaXMkX3JvdXRlck1pY3JvbGliLCBbbmFtZV0uY29uY2F0KGFyZ3MpKTsKCiAgICAgIHVwZGF0ZVBhdGhzKHRoaXMpOwoKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICkgewogICAgICAgIHZhciBpbmZvcyA9IHRoaXMuX3JvdXRlck1pY3JvbGliLmN1cnJlbnRSb3V0ZUluZm9zOwoKICAgICAgICBpZiAoKDAsIF9tZXRhbC5nZXQpKHRoaXMsICduYW1lc3BhY2UnKS5MT0dfVFJBTlNJVElPTlMpIHsKICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlCiAgICAgICAgICBjb25zb2xlLmxvZygiSW50ZXJtZWRpYXRlLXRyYW5zaXRpb25lZCBpbnRvICciICsgRW1iZXJSb3V0ZXIuX3JvdXRlUGF0aChpbmZvcykgKyAiJyIpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8ucmVwbGFjZVdpdGggPSBmdW5jdGlvbiByZXBsYWNlV2l0aCgpIHsKICAgICAgcmV0dXJuIHRoaXMudHJhbnNpdGlvblRvLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykubWV0aG9kKCdyZXBsYWNlJyk7CiAgICB9OwoKICAgIF9wcm90by5nZW5lcmF0ZSA9IGZ1bmN0aW9uIGdlbmVyYXRlKG5hbWUpIHsKICAgICAgdmFyIF90aGlzJF9yb3V0ZXJNaWNyb2xpYjI7CgogICAgICBmb3IgKHZhciBfbGVuMyA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjMgPiAxID8gX2xlbjMgLSAxIDogMCksIF9rZXkzID0gMTsgX2tleTMgPCBfbGVuMzsgX2tleTMrKykgewogICAgICAgIGFyZ3NbX2tleTMgLSAxXSA9IGFyZ3VtZW50c1tfa2V5M107CiAgICAgIH0KCiAgICAgIHZhciB1cmwgPSAoX3RoaXMkX3JvdXRlck1pY3JvbGliMiA9IHRoaXMuX3JvdXRlck1pY3JvbGliKS5nZW5lcmF0ZS5hcHBseShfdGhpcyRfcm91dGVyTWljcm9saWIyLCBbbmFtZV0uY29uY2F0KGFyZ3MpKTsKCiAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmZvcm1hdFVSTCh1cmwpOwogICAgfQogICAgLyoqCiAgICAgIERldGVybWluZXMgaWYgdGhlIHN1cHBsaWVkIHJvdXRlIGlzIGN1cnJlbnRseSBhY3RpdmUuCiAgICAgICAgIEBtZXRob2QgaXNBY3RpdmUKICAgICAgQHBhcmFtIHJvdXRlTmFtZQogICAgICBAcmV0dXJuIHtCb29sZWFufQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uaXNBY3RpdmUgPSBmdW5jdGlvbiBpc0FjdGl2ZShyb3V0ZU5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JvdXRlck1pY3JvbGliLmlzQWN0aXZlKHJvdXRlTmFtZSk7CiAgICB9CiAgICAvKioKICAgICAgQW4gYWx0ZXJuYXRpdmUgZm9ybSBvZiBgaXNBY3RpdmVgIHRoYXQgZG9lc24ndCByZXF1aXJlCiAgICAgIG1hbnVhbCBjb25jYXRlbmF0aW9uIG9mIHRoZSBhcmd1bWVudHMgaW50byBhIHNpbmdsZQogICAgICBhcnJheS4KICAgICAgICAgQG1ldGhvZCBpc0FjdGl2ZUludGVudAogICAgICBAcGFyYW0gcm91dGVOYW1lCiAgICAgIEBwYXJhbSBtb2RlbHMKICAgICAgQHBhcmFtIHF1ZXJ5UGFyYW1zCiAgICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgIEBwcml2YXRlCiAgICAgIEBzaW5jZSAxLjcuMAogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uaXNBY3RpdmVJbnRlbnQgPSBmdW5jdGlvbiBpc0FjdGl2ZUludGVudChyb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMpIHsKICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFN0YXRlLmlzQWN0aXZlSW50ZW50KHJvdXRlTmFtZSwgbW9kZWxzLCBxdWVyeVBhcmFtcyk7CiAgICB9OwoKICAgIF9wcm90by5zZW5kID0gZnVuY3Rpb24gc2VuZChuYW1lKSB7CiAgICAgIHZhciBfdGhpcyRfcm91dGVyTWljcm9saWIzOwoKICAgICAgZm9yICh2YXIgX2xlbjQgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW40ID4gMSA/IF9sZW40IC0gMSA6IDApLCBfa2V5NCA9IDE7IF9rZXk0IDwgX2xlbjQ7IF9rZXk0KyspIHsKICAgICAgICBhcmdzW19rZXk0IC0gMV0gPSBhcmd1bWVudHNbX2tleTRdOwogICAgICB9CgogICAgICAvKm5hbWUsIGNvbnRleHQqLwogICAgICAoX3RoaXMkX3JvdXRlck1pY3JvbGliMyA9IHRoaXMuX3JvdXRlck1pY3JvbGliKS50cmlnZ2VyLmFwcGx5KF90aGlzJF9yb3V0ZXJNaWNyb2xpYjMsIFtuYW1lXS5jb25jYXQoYXJncykpOwogICAgfQogICAgLyoqCiAgICAgIERvZXMgdGhpcyByb3V0ZXIgaW5zdGFuY2UgaGF2ZSB0aGUgZ2l2ZW4gcm91dGUuCiAgICAgICAgIEBtZXRob2QgaGFzUm91dGUKICAgICAgQHJldHVybiB7Qm9vbGVhbn0KICAgICAgQHByaXZhdGUKICAgICovCiAgICA7CgogICAgX3Byb3RvLmhhc1JvdXRlID0gZnVuY3Rpb24gaGFzUm91dGUocm91dGUpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JvdXRlck1pY3JvbGliLmhhc1JvdXRlKHJvdXRlKTsKICAgIH0KICAgIC8qKgogICAgICBSZXNldHMgdGhlIHN0YXRlIG9mIHRoZSByb3V0ZXIgYnkgY2xlYXJpbmcgdGhlIGN1cnJlbnQgcm91dGUKICAgICAgaGFuZGxlcnMgYW5kIGRlYWN0aXZhdGluZyB0aGVtLgogICAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIHJlc2V0CiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucmVzZXQgPSBmdW5jdGlvbiByZXNldCgpIHsKICAgICAgaWYgKHRoaXMuX3JvdXRlck1pY3JvbGliKSB7CiAgICAgICAgdGhpcy5fcm91dGVyTWljcm9saWIucmVzZXQoKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8ud2lsbERlc3Ryb3kgPSBmdW5jdGlvbiB3aWxsRGVzdHJveSgpIHsKICAgICAgaWYgKHRoaXMuX3RvcGxldmVsVmlldykgewogICAgICAgIHRoaXMuX3RvcGxldmVsVmlldy5kZXN0cm95KCk7CgogICAgICAgIHRoaXMuX3RvcGxldmVsVmlldyA9IG51bGw7CiAgICAgIH0KCiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICB0aGlzLnJlc2V0KCk7CiAgICAgIHZhciBpbnN0YW5jZXMgPSB0aGlzLl9lbmdpbmVJbnN0YW5jZXM7CgogICAgICBmb3IgKHZhciBuYW1lIGluIGluc3RhbmNlcykgewogICAgICAgIGZvciAodmFyIGlkIGluIGluc3RhbmNlc1tuYW1lXSkgewogICAgICAgICAgKDAsIF9ydW5sb29wLnJ1bikoaW5zdGFuY2VzW25hbWVdW2lkXSwgJ2Rlc3Ryb3knKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qCiAgICAgIENhbGxlZCB3aGVuIGFuIGFjdGl2ZSByb3V0ZSdzIHF1ZXJ5IHBhcmFtZXRlciBoYXMgY2hhbmdlZC4KICAgICAgVGhlc2UgY2hhbmdlcyBhcmUgYmF0Y2hlZCBpbnRvIGEgcnVubG9vcCBydW4gYW5kIHRyaWdnZXIKICAgICAgYSBzaW5nbGUgdHJhbnNpdGlvbi4KICAgICovCiAgICA7CgogICAgX3Byb3RvLl9hY3RpdmVRUENoYW5nZWQgPSBmdW5jdGlvbiBfYWN0aXZlUVBDaGFuZ2VkKHF1ZXJ5UGFyYW1ldGVyTmFtZSwgbmV3VmFsdWUpIHsKICAgICAgdGhpcy5fcXVldWVkUVBDaGFuZ2VzW3F1ZXJ5UGFyYW1ldGVyTmFtZV0gPSBuZXdWYWx1ZTsKICAgICAgKDAsIF9ydW5sb29wLm9uY2UpKHRoaXMsIHRoaXMuX2ZpcmVRdWVyeVBhcmFtVHJhbnNpdGlvbik7CiAgICB9OwoKICAgIF9wcm90by5fdXBkYXRpbmdRUENoYW5nZWQgPSBmdW5jdGlvbiBfdXBkYXRpbmdRUENoYW5nZWQocXVlcnlQYXJhbWV0ZXJOYW1lKSB7CiAgICAgIHRoaXMuX3FwVXBkYXRlcy5hZGQocXVlcnlQYXJhbWV0ZXJOYW1lKTsKICAgIH0KICAgIC8qCiAgICAgIFRyaWdnZXJzIGEgdHJhbnNpdGlvbiB0byBhIHJvdXRlIGJhc2VkIG9uIHF1ZXJ5IHBhcmFtZXRlciBjaGFuZ2VzLgogICAgICBUaGlzIGlzIGNhbGxlZCBvbmNlIHBlciBydW5sb29wLCB0byBiYXRjaCBjaGFuZ2VzLgogICAgICAgICBlLmcuCiAgICAgICAgIGlmIHRoZXNlIG1ldGhvZHMgYXJlIGNhbGxlZCBpbiBzdWNjZXNzaW9uOgogICAgICB0aGlzLl9hY3RpdmVRUENoYW5nZWQoJ2ZvbycsICcxMCcpOwogICAgICAgIC8vIHJlc3VsdHMgaW4gX3F1ZXVlZFFQQ2hhbmdlcyA9IHsgZm9vOiAnMTAnIH0KICAgICAgdGhpcy5fYWN0aXZlUVBDaGFuZ2VkKCdiYXInLCBmYWxzZSk7CiAgICAgICAgLy8gcmVzdWx0cyBpbiBfcXVldWVkUVBDaGFuZ2VzID0geyBmb286ICcxMCcsIGJhcjogZmFsc2UgfQogICAgICAgICBfcXVldWVkUVBDaGFuZ2VzIHdpbGwgcmVwcmVzZW50IGJvdGggb2YgdGhlc2UgY2hhbmdlcwogICAgICBhbmQgdGhlIHRyYW5zaXRpb24gdXNpbmcgYHRyYW5zaXRpb25Ub2Agd2lsbCBiZSB0cmlnZ2VyZWQKICAgICAgb25jZS4KICAgICovCiAgICA7CgogICAgX3Byb3RvLl9maXJlUXVlcnlQYXJhbVRyYW5zaXRpb24gPSBmdW5jdGlvbiBfZmlyZVF1ZXJ5UGFyYW1UcmFuc2l0aW9uKCkgewogICAgICB0aGlzLnRyYW5zaXRpb25Ubyh7CiAgICAgICAgcXVlcnlQYXJhbXM6IHRoaXMuX3F1ZXVlZFFQQ2hhbmdlcwogICAgICB9KTsKCiAgICAgIHRoaXMuX3Jlc2V0UXVldWVkUXVlcnlQYXJhbWV0ZXJDaGFuZ2VzKCk7CiAgICB9OwoKICAgIF9wcm90by5fc2V0dXBMb2NhdGlvbiA9IGZ1bmN0aW9uIF9zZXR1cExvY2F0aW9uKCkgewogICAgICB2YXIgbG9jYXRpb24gPSB0aGlzLmxvY2F0aW9uOwogICAgICB2YXIgcm9vdFVSTCA9IHRoaXMucm9vdFVSTDsKICAgICAgdmFyIG93bmVyID0gKDAsIF9vd25lci5nZXRPd25lcikodGhpcyk7CgogICAgICBpZiAoJ3N0cmluZycgPT09IHR5cGVvZiBsb2NhdGlvbiAmJiBvd25lcikgewogICAgICAgIHZhciByZXNvbHZlZExvY2F0aW9uID0gb3duZXIubG9va3VwKCJsb2NhdGlvbjoiICsgbG9jYXRpb24pOwoKICAgICAgICBpZiAocmVzb2x2ZWRMb2NhdGlvbiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBsb2NhdGlvbiA9ICgwLCBfbWV0YWwuc2V0KSh0aGlzLCAnbG9jYXRpb24nLCByZXNvbHZlZExvY2F0aW9uKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gQWxsb3cgZm9yIGRlcHJlY2F0ZWQgcmVnaXN0cmF0aW9uIG9mIGN1c3RvbSBsb2NhdGlvbiBBUEkncwogICAgICAgICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgICAgICAgIGltcGxlbWVudGF0aW9uOiBsb2NhdGlvbgogICAgICAgICAgfTsKICAgICAgICAgIGxvY2F0aW9uID0gKDAsIF9tZXRhbC5zZXQpKHRoaXMsICdsb2NhdGlvbicsIF9hcGkuZGVmYXVsdC5jcmVhdGUob3B0aW9ucykpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGxvY2F0aW9uICE9PSBudWxsICYmIHR5cGVvZiBsb2NhdGlvbiA9PT0gJ29iamVjdCcpIHsKICAgICAgICBpZiAocm9vdFVSTCkgewogICAgICAgICAgKDAsIF9tZXRhbC5zZXQpKGxvY2F0aW9uLCAncm9vdFVSTCcsIHJvb3RVUkwpOwogICAgICAgIH0gLy8gQWxsb3cgdGhlIGxvY2F0aW9uIHRvIGRvIGFueSBmZWF0dXJlIGRldGVjdGlvbiwgc3VjaCBhcyBBdXRvTG9jYXRpb24KICAgICAgICAvLyBkZXRlY3RpbmcgaGlzdG9yeSBzdXBwb3J0LiBUaGlzIGdpdmVzIGl0IGEgY2hhbmNlIHRvIHNldCBpdHMKICAgICAgICAvLyBgY2FuY2VsUm91dGVyU2V0dXBgIHByb3BlcnR5IHdoaWNoIGFib3J0cyByb3V0aW5nLgoKCiAgICAgICAgaWYgKHR5cGVvZiBsb2NhdGlvbi5kZXRlY3QgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGxvY2F0aW9uLmRldGVjdCgpOwogICAgICAgIH0gLy8gZW5zdXJlIHRoYXQgaW5pdFN0YXRlIGlzIGNhbGxlZCBBRlRFUiB0aGUgcm9vdFVSTCBpcyBzZXQgb24KICAgICAgICAvLyB0aGUgbG9jYXRpb24gaW5zdGFuY2UKCgogICAgICAgIGlmICh0eXBlb2YgbG9jYXRpb24uaW5pdFN0YXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBsb2NhdGlvbi5pbml0U3RhdGUoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICBTZXJpYWxpemVzIHRoZSBnaXZlbiBxdWVyeSBwYXJhbXMgYWNjb3JkaW5nIHRvIHRoZWlyIFFQIG1ldGEgaW5mb3JtYXRpb24uCiAgICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgX3NlcmlhbGl6ZVF1ZXJ5UGFyYW1zCiAgICAgIEBwYXJhbSB7QXJycmF5PFJvdXRlSW5mbz59IHJvdXRlSW5mb3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5UGFyYW1zCiAgICAgIEByZXR1cm4ge1ZvaWR9CiAgICAqLwogICAgOwoKICAgIF9wcm90by5fc2VyaWFsaXplUXVlcnlQYXJhbXMgPSBmdW5jdGlvbiBfc2VyaWFsaXplUXVlcnlQYXJhbXMocm91dGVJbmZvcywgcXVlcnlQYXJhbXMpIHsKICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICBmb3JFYWNoUXVlcnlQYXJhbSh0aGlzLCByb3V0ZUluZm9zLCBxdWVyeVBhcmFtcywgZnVuY3Rpb24gKGtleSwgdmFsdWUsIHFwKSB7CiAgICAgICAgaWYgKHFwKSB7CiAgICAgICAgICBkZWxldGUgcXVlcnlQYXJhbXNba2V5XTsKICAgICAgICAgIHF1ZXJ5UGFyYW1zW3FwLnVybEtleV0gPSBxcC5yb3V0ZS5zZXJpYWxpemVRdWVyeVBhcmFtKHZhbHVlLCBxcC51cmxLZXksIHFwLnR5cGUpOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuOyAvLyBXZSBkb24ndCBzZXJpYWxpemUgdW5kZWZpbmVkIHZhbHVlcwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBxdWVyeVBhcmFtc1trZXldID0gX3RoaXMzLl9zZXJpYWxpemVRdWVyeVBhcmFtKHZhbHVlLCAoMCwgX3J1bnRpbWUudHlwZU9mKSh2YWx1ZSkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICAvKioKICAgICAgU2VyaWFsaXplcyB0aGUgdmFsdWUgb2YgYSBxdWVyeSBwYXJhbWV0ZXIgYmFzZWQgb24gYSB0eXBlCiAgICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgX3NlcmlhbGl6ZVF1ZXJ5UGFyYW0KICAgICAgQHBhcmFtIHtPYmplY3R9IHZhbHVlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICAqLwogICAgOwoKICAgIF9wcm90by5fc2VyaWFsaXplUXVlcnlQYXJhbSA9IGZ1bmN0aW9uIF9zZXJpYWxpemVRdWVyeVBhcmFtKHZhbHVlLCB0eXBlKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdhcnJheScpIHsKICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodmFsdWUpOwogICAgICB9CgogICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgIH0KICAgIC8qKgogICAgICBEZXNlcmlhbGl6ZXMgdGhlIGdpdmVuIHF1ZXJ5IHBhcmFtcyBhY2NvcmRpbmcgdG8gdGhlaXIgUVAgbWV0YSBpbmZvcm1hdGlvbi4KICAgICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBfZGVzZXJpYWxpemVRdWVyeVBhcmFtcwogICAgICBAcGFyYW0ge0FycmF5PFJvdXRlSW5mbz59IHJvdXRlSW5mb3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5UGFyYW1zCiAgICAgIEByZXR1cm4ge1ZvaWR9CiAgICAqLwogICAgOwoKICAgIF9wcm90by5fZGVzZXJpYWxpemVRdWVyeVBhcmFtcyA9IGZ1bmN0aW9uIF9kZXNlcmlhbGl6ZVF1ZXJ5UGFyYW1zKHJvdXRlSW5mb3MsIHF1ZXJ5UGFyYW1zKSB7CiAgICAgIGZvckVhY2hRdWVyeVBhcmFtKHRoaXMsIHJvdXRlSW5mb3MsIHF1ZXJ5UGFyYW1zLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSwgcXApIHsKICAgICAgICAvLyBJZiB3ZSBkb24ndCBoYXZlIFFQIG1ldGEgaW5mbyBmb3IgYSBnaXZlbiBrZXksIHRoZW4gd2UgZG8gbm90aGluZwogICAgICAgIC8vIGJlY2F1c2UgYWxsIHZhbHVlcyB3aWxsIGJlIHRyZWF0ZWQgYXMgc3RyaW5ncwogICAgICAgIGlmIChxcCkgewogICAgICAgICAgZGVsZXRlIHF1ZXJ5UGFyYW1zW2tleV07CiAgICAgICAgICBxdWVyeVBhcmFtc1txcC5wcm9wXSA9IHFwLnJvdXRlLmRlc2VyaWFsaXplUXVlcnlQYXJhbSh2YWx1ZSwgcXAudXJsS2V5LCBxcC50eXBlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgLyoqCiAgICAgIERlc2VyaWFsaXplcyB0aGUgdmFsdWUgb2YgYSBxdWVyeSBwYXJhbWV0ZXIgYmFzZWQgb24gYSBkZWZhdWx0IHR5cGUKICAgICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBfZGVzZXJpYWxpemVRdWVyeVBhcmFtCiAgICAgIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZQogICAgICBAcGFyYW0ge1N0cmluZ30gZGVmYXVsdFR5cGUKICAgICovCiAgICA7CgogICAgX3Byb3RvLl9kZXNlcmlhbGl6ZVF1ZXJ5UGFyYW0gPSBmdW5jdGlvbiBfZGVzZXJpYWxpemVRdWVyeVBhcmFtKHZhbHVlLCBkZWZhdWx0VHlwZSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfSBlbHNlIGlmIChkZWZhdWx0VHlwZSA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlID09PSAndHJ1ZSc7CiAgICAgIH0gZWxzZSBpZiAoZGVmYXVsdFR5cGUgPT09ICdudW1iZXInKSB7CiAgICAgICAgcmV0dXJuIE51bWJlcih2YWx1ZSkudmFsdWVPZigpOwogICAgICB9IGVsc2UgaWYgKGRlZmF1bHRUeXBlID09PSAnYXJyYXknKSB7CiAgICAgICAgcmV0dXJuICgwLCBfcnVudGltZS5BKShKU09OLnBhcnNlKHZhbHVlKSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIC8qKgogICAgICBSZW1vdmVzIChwcnVuZXMpIGFueSBxdWVyeSBwYXJhbXMgd2l0aCBkZWZhdWx0IHZhbHVlcyBmcm9tIHRoZSBnaXZlbiBRUAogICAgICBvYmplY3QuIERlZmF1bHQgdmFsdWVzIGFyZSBkZXRlcm1pbmVkIGZyb20gdGhlIFFQIG1ldGEgaW5mb3JtYXRpb24gcGVyIGtleS4KICAgICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBfcHJ1bmVEZWZhdWx0UXVlcnlQYXJhbVZhbHVlcwogICAgICBAcGFyYW0ge0FycmF5PFJvdXRlSW5mbz59IHJvdXRlSW5mb3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5UGFyYW1zCiAgICAgIEByZXR1cm4ge1ZvaWR9CiAgICAqLwogICAgOwoKICAgIF9wcm90by5fcHJ1bmVEZWZhdWx0UXVlcnlQYXJhbVZhbHVlcyA9IGZ1bmN0aW9uIF9wcnVuZURlZmF1bHRRdWVyeVBhcmFtVmFsdWVzKHJvdXRlSW5mb3MsIHF1ZXJ5UGFyYW1zKSB7CiAgICAgIHZhciBxcHMgPSB0aGlzLl9xdWVyeVBhcmFtc0Zvcihyb3V0ZUluZm9zKTsKCiAgICAgIGZvciAodmFyIGtleSBpbiBxdWVyeVBhcmFtcykgewogICAgICAgIHZhciBxcCA9IHFwcy5tYXBba2V5XTsKCiAgICAgICAgaWYgKHFwICYmIHFwLnNlcmlhbGl6ZWREZWZhdWx0VmFsdWUgPT09IHF1ZXJ5UGFyYW1zW2tleV0pIHsKICAgICAgICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1trZXldOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uX2RvVHJhbnNpdGlvbiA9IGZ1bmN0aW9uIF9kb1RyYW5zaXRpb24oX3RhcmdldFJvdXRlTmFtZSwgbW9kZWxzLCBfcXVlcnlQYXJhbXMsIF9rZWVwRGVmYXVsdFF1ZXJ5UGFyYW1WYWx1ZXMpIHsKICAgICAgdmFyIF90aGlzJF9yb3V0ZXJNaWNyb2xpYjQ7CgogICAgICB2YXIgdGFyZ2V0Um91dGVOYW1lID0gX3RhcmdldFJvdXRlTmFtZSB8fCAoMCwgX3V0aWxzLmdldEFjdGl2ZVRhcmdldE5hbWUpKHRoaXMuX3JvdXRlck1pY3JvbGliKTsKCiAgICAgIChmYWxzZSAmJiAhKEJvb2xlYW4odGFyZ2V0Um91dGVOYW1lKSAmJiB0aGlzLl9yb3V0ZXJNaWNyb2xpYi5oYXNSb3V0ZSh0YXJnZXRSb3V0ZU5hbWUpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIlRoZSByb3V0ZSAiICsgdGFyZ2V0Um91dGVOYW1lICsgIiB3YXMgbm90IGZvdW5kIiwgQm9vbGVhbih0YXJnZXRSb3V0ZU5hbWUpICYmIHRoaXMuX3JvdXRlck1pY3JvbGliLmhhc1JvdXRlKHRhcmdldFJvdXRlTmFtZSkpKTsKICAgICAgdmFyIHF1ZXJ5UGFyYW1zID0ge307CgogICAgICB0aGlzLl9wcm9jZXNzQWN0aXZlVHJhbnNpdGlvblF1ZXJ5UGFyYW1zKHRhcmdldFJvdXRlTmFtZSwgbW9kZWxzLCBxdWVyeVBhcmFtcywgX3F1ZXJ5UGFyYW1zKTsKCiAgICAgICgwLCBfcG9seWZpbGxzLmFzc2lnbikocXVlcnlQYXJhbXMsIF9xdWVyeVBhcmFtcyk7CgogICAgICB0aGlzLl9wcmVwYXJlUXVlcnlQYXJhbXModGFyZ2V0Um91dGVOYW1lLCBtb2RlbHMsIHF1ZXJ5UGFyYW1zLCBCb29sZWFuKF9rZWVwRGVmYXVsdFF1ZXJ5UGFyYW1WYWx1ZXMpKTsKCiAgICAgIHZhciB0cmFuc2l0aW9uID0gKF90aGlzJF9yb3V0ZXJNaWNyb2xpYjQgPSB0aGlzLl9yb3V0ZXJNaWNyb2xpYikudHJhbnNpdGlvblRvLmFwcGx5KF90aGlzJF9yb3V0ZXJNaWNyb2xpYjQsIFt0YXJnZXRSb3V0ZU5hbWVdLmNvbmNhdChtb2RlbHMsIFt7CiAgICAgICAgcXVlcnlQYXJhbXM6IHF1ZXJ5UGFyYW1zCiAgICAgIH1dKSk7CgogICAgICBkaWRCZWdpblRyYW5zaXRpb24odHJhbnNpdGlvbiwgdGhpcyk7CiAgICAgIHJldHVybiB0cmFuc2l0aW9uOwogICAgfTsKCiAgICBfcHJvdG8uX3Byb2Nlc3NBY3RpdmVUcmFuc2l0aW9uUXVlcnlQYXJhbXMgPSBmdW5jdGlvbiBfcHJvY2Vzc0FjdGl2ZVRyYW5zaXRpb25RdWVyeVBhcmFtcyh0YXJnZXRSb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMsIF9xdWVyeVBhcmFtcykgewogICAgICAvLyBtZXJnZSBpbiBhbnkgcXVlcnlQYXJhbXMgZnJvbSB0aGUgYWN0aXZlIHRyYW5zaXRpb24gd2hpY2ggY291bGQgaW5jbHVkZQogICAgICAvLyBxdWVyeVBhcmFtcyBmcm9tIHRoZSB1cmwgb24gaW5pdGlhbCBsb2FkLgogICAgICBpZiAoIXRoaXMuX3JvdXRlck1pY3JvbGliLmFjdGl2ZVRyYW5zaXRpb24pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciB1bmNoYW5nZWRRUHMgPSB7fTsKICAgICAgdmFyIHFwVXBkYXRlcyA9IHRoaXMuX3FwVXBkYXRlczsKICAgICAgdmFyIHBhcmFtcyA9IHRoaXMuX3JvdXRlck1pY3JvbGliLmFjdGl2ZVRyYW5zaXRpb25bX3JvdXRlcl9qcy5RVUVSWV9QQVJBTVNfU1lNQk9MXTsKCiAgICAgIGZvciAodmFyIGtleSBpbiBwYXJhbXMpIHsKICAgICAgICBpZiAoIXFwVXBkYXRlcy5oYXMoa2V5KSkgewogICAgICAgICAgdW5jaGFuZ2VkUVBzW2tleV0gPSBwYXJhbXNba2V5XTsKICAgICAgICB9CiAgICAgIH0gLy8gV2UgbmVlZCB0byBmdWxseSBzY29wZSBxdWVyeVBhcmFtcyBzbyB0aGF0IHdlIGNhbiBjcmVhdGUgb25lIG9iamVjdAogICAgICAvLyB0aGF0IHJlcHJlc2VudHMgYm90aCBwYXNzZWQtaW4gcXVlcnlQYXJhbXMgYW5kIG9uZXMgdGhhdCBhcmVuJ3QgY2hhbmdlZAogICAgICAvLyBmcm9tIHRoZSBhY3RpdmUgdHJhbnNpdGlvbi4KCgogICAgICB0aGlzLl9mdWxseVNjb3BlUXVlcnlQYXJhbXModGFyZ2V0Um91dGVOYW1lLCBtb2RlbHMsIF9xdWVyeVBhcmFtcyk7CgogICAgICB0aGlzLl9mdWxseVNjb3BlUXVlcnlQYXJhbXModGFyZ2V0Um91dGVOYW1lLCBtb2RlbHMsIHVuY2hhbmdlZFFQcyk7CgogICAgICAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHF1ZXJ5UGFyYW1zLCB1bmNoYW5nZWRRUHMpOwogICAgfQogICAgLyoqCiAgICAgIFByZXBhcmVzIHRoZSBxdWVyeSBwYXJhbXMgZm9yIGEgVVJMIG9yIFRyYW5zaXRpb24uIFJlc3RvcmVzIGFueSB1bmRlZmluZWQgUVAKICAgICAga2V5cy92YWx1ZXMsIHNlcmlhbGl6ZXMgYWxsIHZhbHVlcywgYW5kIHRoZW4gcHJ1bmVzIGFueSBkZWZhdWx0IHZhbHVlcy4KICAgICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBfcHJlcGFyZVF1ZXJ5UGFyYW1zCiAgICAgIEBwYXJhbSB7U3RyaW5nfSB0YXJnZXRSb3V0ZU5hbWUKICAgICAgQHBhcmFtIHtBcnJheTxPYmplY3Q+fSBtb2RlbHMKICAgICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5UGFyYW1zCiAgICAgIEBwYXJhbSB7Ym9vbGVhbn0ga2VlcERlZmF1bHRRdWVyeVBhcmFtVmFsdWVzCiAgICAgIEByZXR1cm4ge1ZvaWR9CiAgICAqLwogICAgOwoKICAgIF9wcm90by5fcHJlcGFyZVF1ZXJ5UGFyYW1zID0gZnVuY3Rpb24gX3ByZXBhcmVRdWVyeVBhcmFtcyh0YXJnZXRSb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMsIF9mcm9tUm91dGVyU2VydmljZSkgewogICAgICB2YXIgc3RhdGUgPSBjYWxjdWxhdGVQb3N0VHJhbnNpdGlvblN0YXRlKHRoaXMsIHRhcmdldFJvdXRlTmFtZSwgbW9kZWxzKTsKCiAgICAgIHRoaXMuX2h5ZHJhdGVVbnN1cHBsaWVkUXVlcnlQYXJhbXMoc3RhdGUsIHF1ZXJ5UGFyYW1zLCBCb29sZWFuKF9mcm9tUm91dGVyU2VydmljZSkpOwoKICAgICAgdGhpcy5fc2VyaWFsaXplUXVlcnlQYXJhbXMoc3RhdGUucm91dGVJbmZvcywgcXVlcnlQYXJhbXMpOwoKICAgICAgaWYgKCFfZnJvbVJvdXRlclNlcnZpY2UpIHsKICAgICAgICB0aGlzLl9wcnVuZURlZmF1bHRRdWVyeVBhcmFtVmFsdWVzKHN0YXRlLnJvdXRlSW5mb3MsIHF1ZXJ5UGFyYW1zKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgIFJldHVybnMgdGhlIG1ldGEgaW5mb3JtYXRpb24gZm9yIHRoZSBxdWVyeSBwYXJhbXMgb2YgYSBnaXZlbiByb3V0ZS4gVGhpcwogICAgICB3aWxsIGJlIG92ZXJyaWRkZW4gdG8gYWxsb3cgc3VwcG9ydCBmb3IgbGF6eSByb3V0ZXMuCiAgICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgX2dldFFQTWV0YQogICAgICBAcGFyYW0ge1JvdXRlSW5mb30gcm91dGVJbmZvCiAgICAgIEByZXR1cm4ge09iamVjdH0KICAgICovCiAgICA7CgogICAgX3Byb3RvLl9nZXRRUE1ldGEgPSBmdW5jdGlvbiBfZ2V0UVBNZXRhKHJvdXRlSW5mbykgewogICAgICB2YXIgcm91dGUgPSByb3V0ZUluZm8ucm91dGU7CiAgICAgIHJldHVybiByb3V0ZSAmJiAoMCwgX21ldGFsLmdldCkocm91dGUsICdfcXAnKTsKICAgIH0KICAgIC8qKgogICAgICBSZXR1cm5zIGEgbWVyZ2VkIHF1ZXJ5IHBhcmFtcyBtZXRhIG9iamVjdCBmb3IgYSBnaXZlbiBzZXQgb2Ygcm91dGVJbmZvcy4KICAgICAgVXNlZnVsIGZvciBrbm93aW5nIHdoYXQgcXVlcnkgcGFyYW1zIGFyZSBhdmFpbGFibGUgZm9yIGEgZ2l2ZW4gcm91dGUgaGllcmFyY2h5LgogICAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIF9xdWVyeVBhcmFtc0ZvcgogICAgICBAcGFyYW0ge0FycmF5PFJvdXRlSW5mbz59IHJvdXRlSW5mb3MKICAgICAgQHJldHVybiB7T2JqZWN0fQogICAgICovCiAgICA7CgogICAgX3Byb3RvLl9xdWVyeVBhcmFtc0ZvciA9IGZ1bmN0aW9uIF9xdWVyeVBhcmFtc0Zvcihyb3V0ZUluZm9zKSB7CiAgICAgIHZhciByb3V0ZUluZm9MZW5ndGggPSByb3V0ZUluZm9zLmxlbmd0aDsKICAgICAgdmFyIGxlYWZSb3V0ZU5hbWUgPSByb3V0ZUluZm9zW3JvdXRlSW5mb0xlbmd0aCAtIDFdLm5hbWU7CiAgICAgIHZhciBjYWNoZWQgPSB0aGlzLl9xcENhY2hlW2xlYWZSb3V0ZU5hbWVdOwoKICAgICAgaWYgKGNhY2hlZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIGNhY2hlZDsKICAgICAgfQoKICAgICAgdmFyIHNob3VsZENhY2hlID0gdHJ1ZTsKICAgICAgdmFyIG1hcCA9IHt9OwogICAgICB2YXIgcXBzID0gW107CiAgICAgIHZhciBxcHNCeVVybEtleSA9IGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgID8ge30gOiBudWxsOwogICAgICB2YXIgcXBNZXRhOwogICAgICB2YXIgcXA7CiAgICAgIHZhciB1cmxLZXk7CiAgICAgIHZhciBxcE90aGVyOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByb3V0ZUluZm9MZW5ndGg7ICsraSkgewogICAgICAgIHFwTWV0YSA9IHRoaXMuX2dldFFQTWV0YShyb3V0ZUluZm9zW2ldKTsKCiAgICAgICAgaWYgKCFxcE1ldGEpIHsKICAgICAgICAgIHNob3VsZENhY2hlID0gZmFsc2U7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9IC8vIExvb3Agb3ZlciBlYWNoIFFQIHRvIG1ha2Ugc3VyZSB3ZSBkb24ndCBoYXZlIGFueSBjb2xsaXNpb25zIGJ5IHVybEtleQoKCiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IHFwTWV0YS5xcHMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICBxcCA9IHFwTWV0YS5xcHNbX2ldOwoKICAgICAgICAgIGlmIChmYWxzZQogICAgICAgICAgLyogREVCVUcgKi8KICAgICAgICAgICkgewogICAgICAgICAgICB1cmxLZXkgPSBxcC51cmxLZXk7CiAgICAgICAgICAgIHFwT3RoZXIgPSBxcHNCeVVybEtleVt1cmxLZXldOwoKICAgICAgICAgICAgaWYgKHFwT3RoZXIgJiYgcXBPdGhlci5jb250cm9sbGVyTmFtZSAhPT0gcXAuY29udHJvbGxlck5hbWUpIHsKICAgICAgICAgICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJZb3UncmUgbm90IGFsbG93ZWQgdG8gaGF2ZSBtb3JlIHRoYW4gb25lIGNvbnRyb2xsZXIgcHJvcGVydHkgbWFwIHRvIHRoZSBzYW1lIHF1ZXJ5IHBhcmFtIGtleSwgYnV0IGJvdGggYCIgKyBxcE90aGVyLnNjb3BlZFByb3BlcnR5TmFtZSArICJgIGFuZCBgIiArIHFwLnNjb3BlZFByb3BlcnR5TmFtZSArICJgIG1hcCB0byBgIiArIHVybEtleSArICJgLiBZb3UgY2FuIGZpeCB0aGlzIGJ5IG1hcHBpbmcgb25lIG9mIHRoZSBjb250cm9sbGVyIHByb3BlcnRpZXMgdG8gYSBkaWZmZXJlbnQgcXVlcnkgcGFyYW0ga2V5IHZpYSB0aGUgYGFzYCBjb25maWcgb3B0aW9uLCBlLmcuIGAiICsgcXBPdGhlci5wcm9wICsgIjogeyBhczogJ290aGVyLSIgKyBxcE90aGVyLnByb3AgKyAiJyB9YCIsIGZhbHNlKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHFwc0J5VXJsS2V5W3VybEtleV0gPSBxcDsKICAgICAgICAgIH0KCiAgICAgICAgICBxcHMucHVzaChxcCk7CiAgICAgICAgfQoKICAgICAgICAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKG1hcCwgcXBNZXRhLm1hcCk7CiAgICAgIH0KCiAgICAgIHZhciBmaW5hbFFQTWV0YSA9IHsKICAgICAgICBxcHM6IHFwcywKICAgICAgICBtYXA6IG1hcAogICAgICB9OwoKICAgICAgaWYgKHNob3VsZENhY2hlKSB7CiAgICAgICAgdGhpcy5fcXBDYWNoZVtsZWFmUm91dGVOYW1lXSA9IGZpbmFsUVBNZXRhOwogICAgICB9CgogICAgICByZXR1cm4gZmluYWxRUE1ldGE7CiAgICB9CiAgICAvKioKICAgICAgTWFwcyBhbGwgcXVlcnkgcGFyYW0ga2V5cyB0byB0aGVpciBmdWxseSBzY29wZWQgcHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybQogICAgICBgY29udHJvbGxlck5hbWU6cHJvcE5hbWVgLgogICAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIF9mdWxseVNjb3BlUXVlcnlQYXJhbXMKICAgICAgQHBhcmFtIHtTdHJpbmd9IGxlYWZSb3V0ZU5hbWUKICAgICAgQHBhcmFtIHtBcnJheTxPYmplY3Q+fSBjb250ZXh0cwogICAgICBAcGFyYW0ge09iamVjdH0gcXVlcnlQYXJhbXMKICAgICAgQHJldHVybiB7Vm9pZH0KICAgICovCiAgICA7CgogICAgX3Byb3RvLl9mdWxseVNjb3BlUXVlcnlQYXJhbXMgPSBmdW5jdGlvbiBfZnVsbHlTY29wZVF1ZXJ5UGFyYW1zKGxlYWZSb3V0ZU5hbWUsIGNvbnRleHRzLCBxdWVyeVBhcmFtcykgewogICAgICB2YXIgc3RhdGUgPSBjYWxjdWxhdGVQb3N0VHJhbnNpdGlvblN0YXRlKHRoaXMsIGxlYWZSb3V0ZU5hbWUsIGNvbnRleHRzKTsKICAgICAgdmFyIHJvdXRlSW5mb3MgPSBzdGF0ZS5yb3V0ZUluZm9zOwogICAgICB2YXIgcXBNZXRhOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHJvdXRlSW5mb3MubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICBxcE1ldGEgPSB0aGlzLl9nZXRRUE1ldGEocm91dGVJbmZvc1tpXSk7CgogICAgICAgIGlmICghcXBNZXRhKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIHZhciBxcCA9IHZvaWQgMDsKICAgICAgICB2YXIgcHJlc2VudFByb3AgPSB2b2lkIDA7CgogICAgICAgIGZvciAodmFyIGogPSAwLCBxcExlbiA9IHFwTWV0YS5xcHMubGVuZ3RoOyBqIDwgcXBMZW47ICsraikgewogICAgICAgICAgcXAgPSBxcE1ldGEucXBzW2pdOwogICAgICAgICAgcHJlc2VudFByb3AgPSBxcC5wcm9wIGluIHF1ZXJ5UGFyYW1zICYmIHFwLnByb3AgfHwgcXAuc2NvcGVkUHJvcGVydHlOYW1lIGluIHF1ZXJ5UGFyYW1zICYmIHFwLnNjb3BlZFByb3BlcnR5TmFtZSB8fCBxcC51cmxLZXkgaW4gcXVlcnlQYXJhbXMgJiYgcXAudXJsS2V5OwoKICAgICAgICAgIGlmIChwcmVzZW50UHJvcCkgewogICAgICAgICAgICBpZiAocHJlc2VudFByb3AgIT09IHFwLnNjb3BlZFByb3BlcnR5TmFtZSkgewogICAgICAgICAgICAgIHF1ZXJ5UGFyYW1zW3FwLnNjb3BlZFByb3BlcnR5TmFtZV0gPSBxdWVyeVBhcmFtc1twcmVzZW50UHJvcF07CiAgICAgICAgICAgICAgZGVsZXRlIHF1ZXJ5UGFyYW1zW3ByZXNlbnRQcm9wXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgIEh5ZHJhdGVzIChhZGRzL3Jlc3RvcmVzKSBhbnkgcXVlcnkgcGFyYW1zIHRoYXQgaGF2ZSBwcmUtZXhpc3RpbmcgdmFsdWVzIGludG8KICAgICAgdGhlIGdpdmVuIHF1ZXJ5UGFyYW1zIGhhc2guIFRoaXMgaXMgd2hhdCBhbGxvd3MgcXVlcnkgcGFyYW1zIHRvIGJlICJzdGlja3kiCiAgICAgIGFuZCByZXN0b3JlIHRoZWlyIGxhc3Qga25vd24gdmFsdWVzIGZvciB0aGVpciBzY29wZS4KICAgICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBfaHlkcmF0ZVVuc3VwcGxpZWRRdWVyeVBhcmFtcwogICAgICBAcGFyYW0ge1RyYW5zaXRpb25TdGF0ZX0gc3RhdGUKICAgICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5UGFyYW1zCiAgICAgIEByZXR1cm4ge1ZvaWR9CiAgICAqLwogICAgOwoKICAgIF9wcm90by5faHlkcmF0ZVVuc3VwcGxpZWRRdWVyeVBhcmFtcyA9IGZ1bmN0aW9uIF9oeWRyYXRlVW5zdXBwbGllZFF1ZXJ5UGFyYW1zKHN0YXRlLCBxdWVyeVBhcmFtcywgX2Zyb21Sb3V0ZXJTZXJ2aWNlKSB7CiAgICAgIHZhciByb3V0ZUluZm9zID0gc3RhdGUucm91dGVJbmZvczsKICAgICAgdmFyIGFwcENhY2hlID0gdGhpcy5fYnVja2V0Q2FjaGU7CiAgICAgIHZhciBxcE1ldGE7CiAgICAgIHZhciBxcDsKICAgICAgdmFyIHByZXNlbnRQcm9wOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByb3V0ZUluZm9zLmxlbmd0aDsgKytpKSB7CiAgICAgICAgcXBNZXRhID0gdGhpcy5fZ2V0UVBNZXRhKHJvdXRlSW5mb3NbaV0pOwoKICAgICAgICBpZiAoIXFwTWV0YSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBqID0gMCwgcXBMZW4gPSBxcE1ldGEucXBzLmxlbmd0aDsgaiA8IHFwTGVuOyArK2opIHsKICAgICAgICAgIHFwID0gcXBNZXRhLnFwc1tqXTsKICAgICAgICAgIHByZXNlbnRQcm9wID0gcXAucHJvcCBpbiBxdWVyeVBhcmFtcyAmJiBxcC5wcm9wIHx8IHFwLnNjb3BlZFByb3BlcnR5TmFtZSBpbiBxdWVyeVBhcmFtcyAmJiBxcC5zY29wZWRQcm9wZXJ0eU5hbWUgfHwgcXAudXJsS2V5IGluIHF1ZXJ5UGFyYW1zICYmIHFwLnVybEtleTsKICAgICAgICAgIChmYWxzZSAmJiAhKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHFwLnVybEtleSA9PT0gcHJlc2VudFByb3ApIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKF9mcm9tUm91dGVyU2VydmljZSAmJiBwcmVzZW50UHJvcCAhPT0gZmFsc2UgJiYgcXAudXJsS2V5ICE9PSBxcC5wcm9wKSB7CiAgICAgICAgICAgICAgLy8gYXNzdW1wdGlvbnMgKG1haW5seSBmcm9tIGN1cnJlbnQgdHJhbnNpdGlvblRvX3Rlc3QpOgogICAgICAgICAgICAgIC8vIC0gdGhpcyBpcyBvbmx5IHN1cHBvc2VkIHRvIGJlIHJ1biB3aGVuIHRoZXJlIGlzIGFuIGFsaWFzIHRvIGEgcXVlcnkgcGFyYW0gYW5kIHRoZSBhbGlhcyBpcyB1c2VkIHRvIHNldCB0aGUgcGFyYW0KICAgICAgICAgICAgICAvLyAtIHdoZW4gdGhlcmUgaXMgbm8gYWxpYXM6IHFwLnVybEtleSA9PSBxcC5wcm9wCiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0oKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJZb3UgcGFzc2VkIHRoZSBgIiArIHByZXNlbnRQcm9wICsgImAgcXVlcnkgcGFyYW1ldGVyIGR1cmluZyBhIHRyYW5zaXRpb24gaW50byAiICsgcXAucm91dGUucm91dGVOYW1lICsgIiwgcGxlYXNlIHVwZGF0ZSB0byAiICsgcXAudXJsS2V5LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmIChxcC51cmxLZXkgPT09IHByZXNlbnRQcm9wKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChfZnJvbVJvdXRlclNlcnZpY2UgJiYgcHJlc2VudFByb3AgIT09IGZhbHNlICYmIHFwLnVybEtleSAhPT0gcXAucHJvcCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9KCkpKTsKCiAgICAgICAgICBpZiAocHJlc2VudFByb3ApIHsKICAgICAgICAgICAgaWYgKHByZXNlbnRQcm9wICE9PSBxcC5zY29wZWRQcm9wZXJ0eU5hbWUpIHsKICAgICAgICAgICAgICBxdWVyeVBhcmFtc1txcC5zY29wZWRQcm9wZXJ0eU5hbWVdID0gcXVlcnlQYXJhbXNbcHJlc2VudFByb3BdOwogICAgICAgICAgICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1twcmVzZW50UHJvcF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBjYWNoZUtleSA9ICgwLCBfdXRpbHMuY2FsY3VsYXRlQ2FjaGVLZXkpKHFwLnJvdXRlLmZ1bGxSb3V0ZU5hbWUsIHFwLnBhcnRzLCBzdGF0ZS5wYXJhbXMpOwogICAgICAgICAgICBxdWVyeVBhcmFtc1txcC5zY29wZWRQcm9wZXJ0eU5hbWVdID0gYXBwQ2FjaGUubG9va3VwKGNhY2hlS2V5LCBxcC5wcm9wLCBxcC5kZWZhdWx0VmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uX3NjaGVkdWxlTG9hZGluZ0V2ZW50ID0gZnVuY3Rpb24gX3NjaGVkdWxlTG9hZGluZ0V2ZW50KHRyYW5zaXRpb24sIG9yaWdpblJvdXRlKSB7CiAgICAgIHRoaXMuX2NhbmNlbFNsb3dUcmFuc2l0aW9uVGltZXIoKTsKCiAgICAgIHRoaXMuX3Nsb3dUcmFuc2l0aW9uVGltZXIgPSAoMCwgX3J1bmxvb3Auc2NoZWR1bGVPbmNlKSgncm91dGVyVHJhbnNpdGlvbnMnLCB0aGlzLCAnX2hhbmRsZVNsb3dUcmFuc2l0aW9uJywgdHJhbnNpdGlvbiwgb3JpZ2luUm91dGUpOwogICAgfTsKCiAgICBfcHJvdG8uX2hhbmRsZVNsb3dUcmFuc2l0aW9uID0gZnVuY3Rpb24gX2hhbmRsZVNsb3dUcmFuc2l0aW9uKHRyYW5zaXRpb24sIG9yaWdpblJvdXRlKSB7CiAgICAgIGlmICghdGhpcy5fcm91dGVyTWljcm9saWIuYWN0aXZlVHJhbnNpdGlvbikgewogICAgICAgIC8vIERvbid0IGZpcmUgYW4gZXZlbnQgaWYgd2UndmUgc2luY2UgbW92ZWQgb24gZnJvbQogICAgICAgIC8vIHRoZSB0cmFuc2l0aW9uIHRoYXQgcHV0IHVzIGluIGEgbG9hZGluZyBzdGF0ZS4KICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciB0YXJnZXRTdGF0ZSA9IG5ldyBfcm91dGVyX3N0YXRlLmRlZmF1bHQodGhpcywgdGhpcy5fcm91dGVyTWljcm9saWIsIHRoaXMuX3JvdXRlck1pY3JvbGliLmFjdGl2ZVRyYW5zaXRpb25bX3JvdXRlcl9qcy5TVEFURV9TWU1CT0xdKTsKICAgICAgdGhpcy5zZXQoJ3RhcmdldFN0YXRlJywgdGFyZ2V0U3RhdGUpOwogICAgICB0cmFuc2l0aW9uLnRyaWdnZXIodHJ1ZSwgJ2xvYWRpbmcnLCB0cmFuc2l0aW9uLCBvcmlnaW5Sb3V0ZSk7CiAgICB9OwoKICAgIF9wcm90by5fY2FuY2VsU2xvd1RyYW5zaXRpb25UaW1lciA9IGZ1bmN0aW9uIF9jYW5jZWxTbG93VHJhbnNpdGlvblRpbWVyKCkgewogICAgICBpZiAodGhpcy5fc2xvd1RyYW5zaXRpb25UaW1lcikgewogICAgICAgICgwLCBfcnVubG9vcC5jYW5jZWwpKHRoaXMuX3Nsb3dUcmFuc2l0aW9uVGltZXIpOwogICAgICB9CgogICAgICB0aGlzLl9zbG93VHJhbnNpdGlvblRpbWVyID0gbnVsbDsKICAgIH0gLy8gVGhlc2UgdGhyZWUgaGVscGVyIGZ1bmN0aW9ucyBhcmUgdXNlZCB0byBlbnN1cmUgZXJyb3JzIGFyZW4ndAogICAgLy8gcmUtcmFpc2VkIGlmIHRoZXkncmUgaGFuZGxlZCBpbiBhIHJvdXRlJ3MgZXJyb3IgYWN0aW9uLgogICAgOwoKICAgIF9wcm90by5fbWFya0Vycm9yQXNIYW5kbGVkID0gZnVuY3Rpb24gX21hcmtFcnJvckFzSGFuZGxlZChlcnJvcikgewogICAgICB0aGlzLl9oYW5kbGVkRXJyb3JzLmFkZChlcnJvcik7CiAgICB9OwoKICAgIF9wcm90by5faXNFcnJvckhhbmRsZWQgPSBmdW5jdGlvbiBfaXNFcnJvckhhbmRsZWQoZXJyb3IpIHsKICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZWRFcnJvcnMuaGFzKGVycm9yKTsKICAgIH07CgogICAgX3Byb3RvLl9jbGVhckhhbmRsZWRFcnJvciA9IGZ1bmN0aW9uIF9jbGVhckhhbmRsZWRFcnJvcihlcnJvcikgewogICAgICB0aGlzLl9oYW5kbGVkRXJyb3JzLmRlbGV0ZShlcnJvcik7CiAgICB9OwoKICAgIF9wcm90by5fZ2V0RW5naW5lSW5zdGFuY2UgPSBmdW5jdGlvbiBfZ2V0RW5naW5lSW5zdGFuY2UoX3JlZikgewogICAgICB2YXIgbmFtZSA9IF9yZWYubmFtZSwKICAgICAgICAgIGluc3RhbmNlSWQgPSBfcmVmLmluc3RhbmNlSWQsCiAgICAgICAgICBtb3VudFBvaW50ID0gX3JlZi5tb3VudFBvaW50OwogICAgICB2YXIgZW5naW5lSW5zdGFuY2VzID0gdGhpcy5fZW5naW5lSW5zdGFuY2VzOwoKICAgICAgaWYgKCFlbmdpbmVJbnN0YW5jZXNbbmFtZV0pIHsKICAgICAgICBlbmdpbmVJbnN0YW5jZXNbbmFtZV0gPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB9CgogICAgICB2YXIgZW5naW5lSW5zdGFuY2UgPSBlbmdpbmVJbnN0YW5jZXNbbmFtZV1baW5zdGFuY2VJZF07CgogICAgICBpZiAoIWVuZ2luZUluc3RhbmNlKSB7CiAgICAgICAgdmFyIG93bmVyID0gKDAsIF9vd25lci5nZXRPd25lcikodGhpcyk7CiAgICAgICAgKGZhbHNlICYmICEob3duZXIuaGFzUmVnaXN0cmF0aW9uKCJlbmdpbmU6IiArIG5hbWUpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIllvdSBhdHRlbXB0ZWQgdG8gbW91bnQgdGhlIGVuZ2luZSAnIiArIG5hbWUgKyAiJyBpbiB5b3VyIHJvdXRlciBtYXAsIGJ1dCB0aGUgZW5naW5lIGNhbiBub3QgYmUgZm91bmQuIiwgb3duZXIuaGFzUmVnaXN0cmF0aW9uKCJlbmdpbmU6IiArIG5hbWUpKSk7CiAgICAgICAgZW5naW5lSW5zdGFuY2UgPSBvd25lci5idWlsZENoaWxkRW5naW5lSW5zdGFuY2UobmFtZSwgewogICAgICAgICAgcm91dGFibGU6IHRydWUsCiAgICAgICAgICBtb3VudFBvaW50OiBtb3VudFBvaW50CiAgICAgICAgfSk7CiAgICAgICAgZW5naW5lSW5zdGFuY2UuYm9vdCgpOwogICAgICAgIGVuZ2luZUluc3RhbmNlc1tuYW1lXVtpbnN0YW5jZUlkXSA9IGVuZ2luZUluc3RhbmNlOwogICAgICB9CgogICAgICByZXR1cm4gZW5naW5lSW5zdGFuY2U7CiAgICB9OwoKICAgIHJldHVybiBFbWJlclJvdXRlcjsKICB9KF9ydW50aW1lLk9iamVjdCk7CiAgLyoKICAgIEhlbHBlciBmdW5jdGlvbiBmb3IgaXRlcmF0aW5nIG92ZXIgcm91dGVzIGluIGEgc2V0IG9mIHJvdXRlSW5mb3MgdGhhdCBhcmUKICAgIGF0IG9yIGFib3ZlIHRoZSBnaXZlbiBvcmlnaW4gcm91dGUuIEV4YW1wbGU6IGlmIGBvcmlnaW5Sb3V0ZWAgPT09ICdmb28uYmFyJwogICAgYW5kIHRoZSByb3V0ZUluZm9zIGdpdmVuIHdlcmUgZm9yICdmb28uYmFyLmJheicsIHRoZW4gdGhlIGdpdmVuIGNhbGxiYWNrCiAgICB3aWxsIGJlIGludm9rZWQgd2l0aCB0aGUgcm91dGVzIGZvciAnZm9vLmJhcicsICdmb28nLCBhbmQgJ2FwcGxpY2F0aW9uJwogICAgaW5kaXZpZHVhbGx5LgogIAogICAgSWYgdGhlIGNhbGxiYWNrIHJldHVybnMgYW55dGhpbmcgb3RoZXIgdGhhbiBgdHJ1ZWAsIHRoZW4gaXRlcmF0aW9uIHdpbGwgc3RvcC4KICAKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1JvdXRlfSBvcmlnaW5Sb3V0ZQogICAgQHBhcmFtIHtBcnJheTxSb3V0ZUluZm8+fSByb3V0ZUluZm9zCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjawogICAgQHJldHVybiB7Vm9pZH0KICAgKi8KCgogIGZ1bmN0aW9uIGZvckVhY2hSb3V0ZUFib3ZlKHJvdXRlSW5mb3MsIGNhbGxiYWNrKSB7CiAgICBmb3IgKHZhciBpID0gcm91dGVJbmZvcy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICB2YXIgcm91dGVJbmZvID0gcm91dGVJbmZvc1tpXTsKICAgICAgdmFyIHJvdXRlID0gcm91dGVJbmZvLnJvdXRlOyAvLyByb3V0ZUluZm8uaGFuZGxlciBiZWluZyBgdW5kZWZpbmVkYCBnZW5lcmFsbHkgbWVhbnMgZWl0aGVyOgogICAgICAvLwogICAgICAvLyAxLiBhbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgY3JlYXRpb24gb2YgdGhlIHJvdXRlIGluIHF1ZXN0aW9uCiAgICAgIC8vIDIuIHRoZSByb3V0ZSBpcyBhY3Jvc3MgYW4gYXN5bmMgYm91bmRhcnkgKGUuZy4gd2l0aGluIGFuIGVuZ2luZSkKICAgICAgLy8KICAgICAgLy8gSW4gYm90aCBvZiB0aGVzZSBjYXNlcywgd2UgY2Fubm90IGludm9rZSB0aGUgY2FsbGJhY2sgb24gdGhhdCBzcGVjaWZpYwogICAgICAvLyByb3V0ZSwgYmVjYXVzZSBpdCBqdXN0IGRvZXNuJ3QgZXhpc3QuLi4KCiAgICAgIGlmIChyb3V0ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIGlmIChjYWxsYmFjayhyb3V0ZSwgcm91dGVJbmZvKSAhPT0gdHJ1ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogIH0gLy8gVGhlc2UgZ2V0IGludm9rZWQgd2hlbiBhbiBhY3Rpb24gYnViYmxlcyBhYm92ZSBBcHBsaWNhdGlvblJvdXRlCiAgLy8gYW5kIGFyZSBub3QgbWVhbnQgdG8gYmUgb3ZlcnJpZGFibGUuCgoKICB2YXIgZGVmYXVsdEFjdGlvbkhhbmRsZXJzID0gewogICAgd2lsbFJlc29sdmVNb2RlbDogZnVuY3Rpb24gd2lsbFJlc29sdmVNb2RlbChfcm91dGVJbmZvcywgdHJhbnNpdGlvbiwgb3JpZ2luUm91dGUpIHsKICAgICAgdGhpcy5fc2NoZWR1bGVMb2FkaW5nRXZlbnQodHJhbnNpdGlvbiwgb3JpZ2luUm91dGUpOwogICAgfSwKICAgIC8vIEF0dGVtcHQgdG8gZmluZCBhbiBhcHByb3ByaWF0ZSBlcnJvciByb3V0ZSBvciBzdWJzdGF0ZSB0byBlbnRlci4KICAgIGVycm9yOiBmdW5jdGlvbiBlcnJvcihyb3V0ZUluZm9zLCBfZXJyb3IyLCB0cmFuc2l0aW9uKSB7CiAgICAgIHZhciByb3V0ZXIgPSB0aGlzOwogICAgICB2YXIgcm91dGVJbmZvV2l0aEVycm9yID0gcm91dGVJbmZvc1tyb3V0ZUluZm9zLmxlbmd0aCAtIDFdOwogICAgICBmb3JFYWNoUm91dGVBYm92ZShyb3V0ZUluZm9zLCBmdW5jdGlvbiAocm91dGUsIHJvdXRlSW5mbykgewogICAgICAgIC8vIFdlIGRvbid0IGNoZWNrIHRoZSBsZWFmIG1vc3Qgcm91dGVJbmZvIHNpbmNlIHRoYXQgd291bGQKICAgICAgICAvLyB0ZWNobmljYWxseSBiZSBiZWxvdyB3aGVyZSB3ZSdyZSBhdCBpbiB0aGUgcm91dGUgaGllcmFyY2h5LgogICAgICAgIGlmIChyb3V0ZUluZm8gIT09IHJvdXRlSW5mb1dpdGhFcnJvcikgewogICAgICAgICAgLy8gQ2hlY2sgZm9yIHRoZSBleGlzdGVuY2Ugb2YgYW4gJ2Vycm9yJyByb3V0ZS4KICAgICAgICAgIHZhciBlcnJvclJvdXRlTmFtZSA9IGZpbmRSb3V0ZVN0YXRlTmFtZShyb3V0ZSwgJ2Vycm9yJyk7CgogICAgICAgICAgaWYgKGVycm9yUm91dGVOYW1lKSB7CiAgICAgICAgICAgIHJvdXRlci5fbWFya0Vycm9yQXNIYW5kbGVkKF9lcnJvcjIpOwoKICAgICAgICAgICAgcm91dGVyLmludGVybWVkaWF0ZVRyYW5zaXRpb25UbyhlcnJvclJvdXRlTmFtZSwgX2Vycm9yMik7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9IC8vIENoZWNrIGZvciBhbiAnZXJyb3InIHN1YnN0YXRlIHJvdXRlCgoKICAgICAgICB2YXIgZXJyb3JTdWJzdGF0ZU5hbWUgPSBmaW5kUm91dGVTdWJzdGF0ZU5hbWUocm91dGUsICdlcnJvcicpOwoKICAgICAgICBpZiAoZXJyb3JTdWJzdGF0ZU5hbWUpIHsKICAgICAgICAgIHJvdXRlci5fbWFya0Vycm9yQXNIYW5kbGVkKF9lcnJvcjIpOwoKICAgICAgICAgIHJvdXRlci5pbnRlcm1lZGlhdGVUcmFuc2l0aW9uVG8oZXJyb3JTdWJzdGF0ZU5hbWUsIF9lcnJvcjIpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgICBsb2dFcnJvcihfZXJyb3IyLCAiRXJyb3Igd2hpbGUgcHJvY2Vzc2luZyByb3V0ZTogIiArIHRyYW5zaXRpb24udGFyZ2V0TmFtZSk7CiAgICB9LAogICAgLy8gQXR0ZW1wdCB0byBmaW5kIGFuIGFwcHJvcHJpYXRlIGxvYWRpbmcgcm91dGUgb3Igc3Vic3RhdGUgdG8gZW50ZXIuCiAgICBsb2FkaW5nOiBmdW5jdGlvbiBsb2FkaW5nKHJvdXRlSW5mb3MsIHRyYW5zaXRpb24pIHsKICAgICAgdmFyIHJvdXRlciA9IHRoaXM7CiAgICAgIHZhciByb3V0ZUluZm9XaXRoU2xvd0xvYWRpbmcgPSByb3V0ZUluZm9zW3JvdXRlSW5mb3MubGVuZ3RoIC0gMV07CiAgICAgIGZvckVhY2hSb3V0ZUFib3ZlKHJvdXRlSW5mb3MsIGZ1bmN0aW9uIChyb3V0ZSwgcm91dGVJbmZvKSB7CiAgICAgICAgLy8gV2UgZG9uJ3QgY2hlY2sgdGhlIGxlYWYgbW9zdCByb3V0ZUluZm9zIHNpbmNlIHRoYXQgd291bGQKICAgICAgICAvLyB0ZWNobmljYWxseSBiZSBiZWxvdyB3aGVyZSB3ZSdyZSBhdCBpbiB0aGUgcm91dGUgaGllcmFyY2h5LgogICAgICAgIGlmIChyb3V0ZUluZm8gIT09IHJvdXRlSW5mb1dpdGhTbG93TG9hZGluZykgewogICAgICAgICAgLy8gQ2hlY2sgZm9yIHRoZSBleGlzdGVuY2Ugb2YgYSAnbG9hZGluZycgcm91dGUuCiAgICAgICAgICB2YXIgbG9hZGluZ1JvdXRlTmFtZSA9IGZpbmRSb3V0ZVN0YXRlTmFtZShyb3V0ZSwgJ2xvYWRpbmcnKTsKCiAgICAgICAgICBpZiAobG9hZGluZ1JvdXRlTmFtZSkgewogICAgICAgICAgICByb3V0ZXIuaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvKGxvYWRpbmdSb3V0ZU5hbWUpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBDaGVjayBmb3IgbG9hZGluZyBzdWJzdGF0ZQoKCiAgICAgICAgdmFyIGxvYWRpbmdTdWJzdGF0ZU5hbWUgPSBmaW5kUm91dGVTdWJzdGF0ZU5hbWUocm91dGUsICdsb2FkaW5nJyk7CgogICAgICAgIGlmIChsb2FkaW5nU3Vic3RhdGVOYW1lKSB7CiAgICAgICAgICByb3V0ZXIuaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvKGxvYWRpbmdTdWJzdGF0ZU5hbWUpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0gLy8gRG9uJ3QgYnViYmxlIGFib3ZlIHBpdm90IHJvdXRlLgoKCiAgICAgICAgcmV0dXJuIHRyYW5zaXRpb24ucGl2b3RIYW5kbGVyICE9PSByb3V0ZTsKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gbG9nRXJyb3IoX2Vycm9yLCBpbml0aWFsTWVzc2FnZSkgewogICAgdmFyIF9jb25zb2xlOwoKICAgIHZhciBlcnJvckFyZ3MgPSBbXTsKICAgIHZhciBlcnJvcjsKCiAgICBpZiAoX2Vycm9yICYmIHR5cGVvZiBfZXJyb3IgPT09ICdvYmplY3QnICYmIHR5cGVvZiBfZXJyb3IuZXJyb3JUaHJvd24gPT09ICdvYmplY3QnKSB7CiAgICAgIGVycm9yID0gX2Vycm9yLmVycm9yVGhyb3duOwogICAgfSBlbHNlIHsKICAgICAgZXJyb3IgPSBfZXJyb3I7CiAgICB9CgogICAgaWYgKGluaXRpYWxNZXNzYWdlKSB7CiAgICAgIGVycm9yQXJncy5wdXNoKGluaXRpYWxNZXNzYWdlKTsKICAgIH0KCiAgICBpZiAoZXJyb3IpIHsKICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIHsKICAgICAgICBlcnJvckFyZ3MucHVzaChlcnJvci5tZXNzYWdlKTsKICAgICAgfQoKICAgICAgaWYgKGVycm9yLnN0YWNrKSB7CiAgICAgICAgZXJyb3JBcmdzLnB1c2goZXJyb3Iuc3RhY2spOwogICAgICB9CgogICAgICBpZiAodHlwZW9mIGVycm9yID09PSAnc3RyaW5nJykgewogICAgICAgIGVycm9yQXJncy5wdXNoKGVycm9yKTsKICAgICAgfQogICAgfQoKICAgIChfY29uc29sZSA9IGNvbnNvbGUpLmVycm9yLmFwcGx5KF9jb25zb2xlLCBlcnJvckFyZ3MpOyAvL2VzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZQoKICB9CiAgLyoqCiAgICBGaW5kcyB0aGUgbmFtZSBvZiB0aGUgc3Vic3RhdGUgcm91dGUgaWYgaXQgZXhpc3RzIGZvciB0aGUgZ2l2ZW4gcm91dGUuIEEKICAgIHN1YnN0YXRlIHJvdXRlIGlzIG9mIHRoZSBmb3JtIGByb3V0ZV9zdGF0ZWAsIHN1Y2ggYXMgYGZvb19sb2FkaW5nYC4KICAKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1JvdXRlfSByb3V0ZQogICAgQHBhcmFtIHtTdHJpbmd9IHN0YXRlCiAgICBAcmV0dXJuIHtTdHJpbmd9CiAgKi8KCgogIGZ1bmN0aW9uIGZpbmRSb3V0ZVN1YnN0YXRlTmFtZShyb3V0ZSwgc3RhdGUpIHsKICAgIHZhciBvd25lciA9ICgwLCBfb3duZXIuZ2V0T3duZXIpKHJvdXRlKTsKICAgIHZhciByb3V0ZU5hbWUgPSByb3V0ZS5yb3V0ZU5hbWUsCiAgICAgICAgZnVsbFJvdXRlTmFtZSA9IHJvdXRlLmZ1bGxSb3V0ZU5hbWUsCiAgICAgICAgcm91dGVyID0gcm91dGUuX3JvdXRlcjsKICAgIHZhciBzdWJzdGF0ZU5hbWUgPSByb3V0ZU5hbWUgKyAiXyIgKyBzdGF0ZTsKICAgIHZhciBzdWJzdGF0ZU5hbWVGdWxsID0gZnVsbFJvdXRlTmFtZSArICJfIiArIHN0YXRlOwogICAgcmV0dXJuIHJvdXRlSGFzQmVlbkRlZmluZWQob3duZXIsIHJvdXRlciwgc3Vic3RhdGVOYW1lLCBzdWJzdGF0ZU5hbWVGdWxsKSA/IHN1YnN0YXRlTmFtZUZ1bGwgOiAnJzsKICB9CiAgLyoqCiAgICBGaW5kcyB0aGUgbmFtZSBvZiB0aGUgc3RhdGUgcm91dGUgaWYgaXQgZXhpc3RzIGZvciB0aGUgZ2l2ZW4gcm91dGUuIEEgc3RhdGUKICAgIHJvdXRlIGlzIG9mIHRoZSBmb3JtIGByb3V0ZS5zdGF0ZWAsIHN1Y2ggYXMgYGZvby5sb2FkaW5nYC4gUHJvcGVybHkgSGFuZGxlcwogICAgYGFwcGxpY2F0aW9uYCBuYW1lZCByb3V0ZXMuCiAgCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtSb3V0ZX0gcm91dGUKICAgIEBwYXJhbSB7U3RyaW5nfSBzdGF0ZQogICAgQHJldHVybiB7U3RyaW5nfQogICovCgoKICBmdW5jdGlvbiBmaW5kUm91dGVTdGF0ZU5hbWUocm91dGUsIHN0YXRlKSB7CiAgICB2YXIgb3duZXIgPSAoMCwgX293bmVyLmdldE93bmVyKShyb3V0ZSk7CiAgICB2YXIgcm91dGVOYW1lID0gcm91dGUucm91dGVOYW1lLAogICAgICAgIGZ1bGxSb3V0ZU5hbWUgPSByb3V0ZS5mdWxsUm91dGVOYW1lLAogICAgICAgIHJvdXRlciA9IHJvdXRlLl9yb3V0ZXI7CiAgICB2YXIgc3RhdGVOYW1lID0gcm91dGVOYW1lID09PSAnYXBwbGljYXRpb24nID8gc3RhdGUgOiByb3V0ZU5hbWUgKyAiLiIgKyBzdGF0ZTsKICAgIHZhciBzdGF0ZU5hbWVGdWxsID0gZnVsbFJvdXRlTmFtZSA9PT0gJ2FwcGxpY2F0aW9uJyA/IHN0YXRlIDogZnVsbFJvdXRlTmFtZSArICIuIiArIHN0YXRlOwogICAgcmV0dXJuIHJvdXRlSGFzQmVlbkRlZmluZWQob3duZXIsIHJvdXRlciwgc3RhdGVOYW1lLCBzdGF0ZU5hbWVGdWxsKSA/IHN0YXRlTmFtZUZ1bGwgOiAnJzsKICB9CiAgLyoqCiAgICBEZXRlcm1pbmVzIHdoZXRoZXIgb3Igbm90IGEgcm91dGUgaGFzIGJlZW4gZGVmaW5lZCBieSBjaGVja2luZyB0aGF0IHRoZSByb3V0ZQogICAgaXMgaW4gdGhlIFJvdXRlcidzIG1hcCBhbmQgdGhlIG93bmVyIGhhcyBhIHJlZ2lzdHJhdGlvbiBmb3IgdGhhdCByb3V0ZS4KICAKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge093bmVyfSBvd25lcgogICAgQHBhcmFtIHtSb3V0ZXJ9IHJvdXRlcgogICAgQHBhcmFtIHtTdHJpbmd9IGxvY2FsTmFtZQogICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lCiAgICBAcmV0dXJuIHtCb29sZWFufQogICovCgoKICBmdW5jdGlvbiByb3V0ZUhhc0JlZW5EZWZpbmVkKG93bmVyLCByb3V0ZXIsIGxvY2FsTmFtZSwgZnVsbE5hbWUpIHsKICAgIHZhciByb3V0ZXJIYXNSb3V0ZSA9IHJvdXRlci5oYXNSb3V0ZShmdWxsTmFtZSk7CiAgICB2YXIgb3duZXJIYXNSb3V0ZSA9IG93bmVyLmhhc1JlZ2lzdHJhdGlvbigidGVtcGxhdGU6IiArIGxvY2FsTmFtZSkgfHwgb3duZXIuaGFzUmVnaXN0cmF0aW9uKCJyb3V0ZToiICsgbG9jYWxOYW1lKTsKICAgIHJldHVybiByb3V0ZXJIYXNSb3V0ZSAmJiBvd25lckhhc1JvdXRlOwogIH0KCiAgZnVuY3Rpb24gX3RyaWdnZXJFdmVudChyb3V0ZUluZm9zLCBpZ25vcmVGYWlsdXJlLCBuYW1lLCBhcmdzKSB7CiAgICBpZiAoIXJvdXRlSW5mb3MpIHsKICAgICAgaWYgKGlnbm9yZUZhaWx1cmUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRocm93IG5ldyBfZXJyb3IzLmRlZmF1bHQoIkNhbid0IHRyaWdnZXIgYWN0aW9uICciICsgbmFtZSArICInIGJlY2F1c2UgeW91ciBhcHAgaGFzbid0IGZpbmlzaGVkIHRyYW5zaXRpb25pbmcgaW50byBpdHMgZmlyc3Qgcm91dGUuIFRvIHRyaWdnZXIgYW4gYWN0aW9uIG9uIGRlc3RpbmF0aW9uIHJvdXRlcyBkdXJpbmcgYSB0cmFuc2l0aW9uLCB5b3UgY2FuIGNhbGwgYC5zZW5kKClgIG9uIHRoZSBgVHJhbnNpdGlvbmAgb2JqZWN0IHBhc3NlZCB0byB0aGUgYG1vZGVsL2JlZm9yZU1vZGVsL2FmdGVyTW9kZWxgIGhvb2tzLiIpOwogICAgfQoKICAgIHZhciBldmVudFdhc0hhbmRsZWQgPSBmYWxzZTsKICAgIHZhciByb3V0ZUluZm8sIGhhbmRsZXIsIGFjdGlvbkhhbmRsZXI7CgogICAgZm9yICh2YXIgaSA9IHJvdXRlSW5mb3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgcm91dGVJbmZvID0gcm91dGVJbmZvc1tpXTsKICAgICAgaGFuZGxlciA9IHJvdXRlSW5mby5yb3V0ZTsKICAgICAgYWN0aW9uSGFuZGxlciA9IGhhbmRsZXIgJiYgaGFuZGxlci5hY3Rpb25zICYmIGhhbmRsZXIuYWN0aW9uc1tuYW1lXTsKCiAgICAgIGlmIChhY3Rpb25IYW5kbGVyKSB7CiAgICAgICAgaWYgKGFjdGlvbkhhbmRsZXIuYXBwbHkoaGFuZGxlciwgYXJncykgPT09IHRydWUpIHsKICAgICAgICAgIGV2ZW50V2FzSGFuZGxlZCA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFNob3VsZCBvbmx5IGhpdCBoZXJlIGlmIGEgbm9uLWJ1YmJsaW5nIGVycm9yIGFjdGlvbiBpcyB0cmlnZ2VyZWQgb24gYSByb3V0ZS4KICAgICAgICAgIGlmIChuYW1lID09PSAnZXJyb3InKSB7CiAgICAgICAgICAgIGhhbmRsZXIuX3JvdXRlci5fbWFya0Vycm9yQXNIYW5kbGVkKGFyZ3NbMF0pOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICB2YXIgZGVmYXVsdEhhbmRsZXIgPSBkZWZhdWx0QWN0aW9uSGFuZGxlcnNbbmFtZV07CgogICAgaWYgKGRlZmF1bHRIYW5kbGVyKSB7CiAgICAgIGRlZmF1bHRIYW5kbGVyLmFwcGx5KHRoaXMsIFtyb3V0ZUluZm9zXS5jb25jYXQoYXJncykpOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKCFldmVudFdhc0hhbmRsZWQgJiYgIWlnbm9yZUZhaWx1cmUpIHsKICAgICAgdGhyb3cgbmV3IF9lcnJvcjMuZGVmYXVsdCgiTm90aGluZyBoYW5kbGVkIHRoZSBhY3Rpb24gJyIgKyBuYW1lICsgIicuIElmIHlvdSBkaWQgaGFuZGxlIHRoZSBhY3Rpb24sIHRoaXMgZXJyb3IgY2FuIGJlIGNhdXNlZCBieSByZXR1cm5pbmcgdHJ1ZSBmcm9tIGFuIGFjdGlvbiBoYW5kbGVyIGluIGEgY29udHJvbGxlciwgY2F1c2luZyB0aGUgYWN0aW9uIHRvIGJ1YmJsZS4iKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNhbGN1bGF0ZVBvc3RUcmFuc2l0aW9uU3RhdGUoZW1iZXJSb3V0ZXIsIGxlYWZSb3V0ZU5hbWUsIGNvbnRleHRzKSB7CiAgICB2YXIgc3RhdGUgPSBlbWJlclJvdXRlci5fcm91dGVyTWljcm9saWIuYXBwbHlJbnRlbnQobGVhZlJvdXRlTmFtZSwgY29udGV4dHMpOwoKICAgIHZhciByb3V0ZUluZm9zID0gc3RhdGUucm91dGVJbmZvcywKICAgICAgICBwYXJhbXMgPSBzdGF0ZS5wYXJhbXM7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCByb3V0ZUluZm9zLmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciByb3V0ZUluZm8gPSByb3V0ZUluZm9zW2ldOyAvLyBJZiB0aGUgcm91dGVJbmZvIGlzIG5vdCByZXNvbHZlZCwgd2Ugc2VyaWFsaXplIHRoZSBjb250ZXh0IGludG8gcGFyYW1zCgogICAgICBpZiAoIXJvdXRlSW5mby5pc1Jlc29sdmVkKSB7CiAgICAgICAgcGFyYW1zW3JvdXRlSW5mby5uYW1lXSA9IHJvdXRlSW5mby5zZXJpYWxpemUocm91dGVJbmZvLmNvbnRleHQpOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcmFtc1tyb3V0ZUluZm8ubmFtZV0gPSByb3V0ZUluZm8ucGFyYW1zOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHN0YXRlOwogIH0KCiAgZnVuY3Rpb24gdXBkYXRlUGF0aHMocm91dGVyKSB7CiAgICB2YXIgaW5mb3MgPSByb3V0ZXIuX3JvdXRlck1pY3JvbGliLmN1cnJlbnRSb3V0ZUluZm9zOwoKICAgIGlmIChpbmZvcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBwYXRoID0gRW1iZXJSb3V0ZXIuX3JvdXRlUGF0aChpbmZvcyk7CgogICAgdmFyIGN1cnJlbnRSb3V0ZU5hbWUgPSBpbmZvc1tpbmZvcy5sZW5ndGggLSAxXS5uYW1lOwogICAgdmFyIGN1cnJlbnRVUkwgPSByb3V0ZXIuZ2V0KCdsb2NhdGlvbicpLmdldFVSTCgpOwogICAgKDAsIF9tZXRhbC5zZXQpKHJvdXRlciwgJ2N1cnJlbnRQYXRoJywgcGF0aCk7CiAgICAoMCwgX21ldGFsLnNldCkocm91dGVyLCAnY3VycmVudFJvdXRlTmFtZScsIGN1cnJlbnRSb3V0ZU5hbWUpOwogICAgKDAsIF9tZXRhbC5zZXQpKHJvdXRlciwgJ2N1cnJlbnRVUkwnLCBjdXJyZW50VVJMKTsKICAgIHZhciBhcHBDb250cm9sbGVyID0gKDAsIF9vd25lci5nZXRPd25lcikocm91dGVyKS5sb29rdXAoJ2NvbnRyb2xsZXI6YXBwbGljYXRpb24nKTsKCiAgICBpZiAoIWFwcENvbnRyb2xsZXIpIHsKICAgICAgLy8gYXBwQ29udHJvbGxlciBtaWdodCBub3QgZXhpc3Qgd2hlbiB0b3AtbGV2ZWwgbG9hZGluZy9lcnJvcgogICAgICAvLyBzdWJzdGF0ZXMgaGF2ZSBiZWVuIGVudGVyZWQgc2luY2UgQXBwbGljYXRpb25Sb3V0ZSBoYXNuJ3QKICAgICAgLy8gYWN0dWFsbHkgYmVlbiBlbnRlcmVkIGF0IHRoYXQgcG9pbnQuCiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5BUFBfQ1RSTF9ST1VURVJfUFJPUFMpIHsKICAgICAgaWYgKCEoJ2N1cnJlbnRQYXRoJyBpbiBhcHBDb250cm9sbGVyKSkgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShhcHBDb250cm9sbGVyLCAnY3VycmVudFBhdGgnLCB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgnQWNjZXNzaW5nIGBjdXJyZW50UGF0aGAgb24gYGNvbnRyb2xsZXI6YXBwbGljYXRpb25gIGlzIGRlcHJlY2F0ZWQsIHVzZSB0aGUgYGN1cnJlbnRQYXRoYCBwcm9wZXJ0eSBvbiBgc2VydmljZTpyb3V0ZXJgIGluc3RlYWQuJywgZmFsc2UsIHsKICAgICAgICAgICAgICBpZDogJ2FwcGxpY2F0aW9uLWNvbnRyb2xsZXIucm91dGVyLXByb3BlcnRpZXMnLAogICAgICAgICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vZW1iZXJqcy5jb20vZGVwcmVjYXRpb25zL3YzLngjdG9jX2FwcGxpY2F0aW9uLWNvbnRyb2xsZXItcm91dGVyLXByb3BlcnRpZXMnCiAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgcmV0dXJuICgwLCBfbWV0YWwuZ2V0KShyb3V0ZXIsICdjdXJyZW50UGF0aCcpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICAoMCwgX21ldGFsLm5vdGlmeVByb3BlcnR5Q2hhbmdlKShhcHBDb250cm9sbGVyLCAnY3VycmVudFBhdGgnKTsKCiAgICAgIGlmICghKCdjdXJyZW50Um91dGVOYW1lJyBpbiBhcHBDb250cm9sbGVyKSkgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShhcHBDb250cm9sbGVyLCAnY3VycmVudFJvdXRlTmFtZScsIHsKICAgICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCdBY2Nlc3NpbmcgYGN1cnJlbnRSb3V0ZU5hbWVgIG9uIGBjb250cm9sbGVyOmFwcGxpY2F0aW9uYCBpcyBkZXByZWNhdGVkLCB1c2UgdGhlIGBjdXJyZW50Um91dGVOYW1lYCBwcm9wZXJ0eSBvbiBgc2VydmljZTpyb3V0ZXJgIGluc3RlYWQuJywgZmFsc2UsIHsKICAgICAgICAgICAgICBpZDogJ2FwcGxpY2F0aW9uLWNvbnRyb2xsZXIucm91dGVyLXByb3BlcnRpZXMnLAogICAgICAgICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vZW1iZXJqcy5jb20vZGVwcmVjYXRpb25zL3YzLngjdG9jX2FwcGxpY2F0aW9uLWNvbnRyb2xsZXItcm91dGVyLXByb3BlcnRpZXMnCiAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgcmV0dXJuICgwLCBfbWV0YWwuZ2V0KShyb3V0ZXIsICdjdXJyZW50Um91dGVOYW1lJyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgICgwLCBfbWV0YWwubm90aWZ5UHJvcGVydHlDaGFuZ2UpKGFwcENvbnRyb2xsZXIsICdjdXJyZW50Um91dGVOYW1lJyk7CiAgICB9CiAgfQoKICBFbWJlclJvdXRlci5yZW9wZW5DbGFzcyh7CiAgICAvKioKICAgICAgVGhlIGBSb3V0ZXIubWFwYCBmdW5jdGlvbiBhbGxvd3MgeW91IHRvIGRlZmluZSBtYXBwaW5ncyBmcm9tIFVSTHMgdG8gcm91dGVzCiAgICAgIGluIHlvdXIgYXBwbGljYXRpb24uIFRoZXNlIG1hcHBpbmdzIGFyZSBkZWZpbmVkIHdpdGhpbiB0aGUKICAgICAgc3VwcGxpZWQgY2FsbGJhY2sgZnVuY3Rpb24gdXNpbmcgYHRoaXMucm91dGVgLgogICAgICAgICBUaGUgZmlyc3QgcGFyYW1ldGVyIGlzIHRoZSBuYW1lIG9mIHRoZSByb3V0ZSB3aGljaCBpcyB1c2VkIGJ5IGRlZmF1bHQgYXMgdGhlCiAgICAgIHBhdGggbmFtZSBhcyB3ZWxsLgogICAgICAgICBUaGUgc2Vjb25kIHBhcmFtZXRlciBpcyB0aGUgb3B0aW9uYWwgb3B0aW9ucyBoYXNoLiBBdmFpbGFibGUgb3B0aW9ucyBhcmU6CiAgICAgICAgICAgKiBgcGF0aGA6IGFsbG93cyB5b3UgdG8gcHJvdmlkZSB5b3VyIG93biBwYXRoIGFzIHdlbGwgYXMgbWFyayBkeW5hbWljCiAgICAgICAgICBzZWdtZW50cy4KICAgICAgICAqIGByZXNldE5hbWVzcGFjZWA6IGZhbHNlIGJ5IGRlZmF1bHQ7IHdoZW4gbmVzdGluZyByb3V0ZXMsIGVtYmVyIHdpbGwKICAgICAgICAgIGNvbWJpbmUgdGhlIHJvdXRlIG5hbWVzIHRvIGZvcm0gdGhlIGZ1bGx5LXF1YWxpZmllZCByb3V0ZSBuYW1lLCB3aGljaCBpcwogICAgICAgICAgdXNlZCB3aXRoIGB7e2xpbmstdG99fWAgb3IgbWFudWFsbHkgdHJhbnNpdGlvbmluZyB0byByb3V0ZXMuIFNldHRpbmcKICAgICAgICAgIGByZXNldE5hbWVzcGFjZTogdHJ1ZWAgd2lsbCBjYXVzZSB0aGUgcm91dGUgbm90IHRvIGluaGVyaXQgZnJvbSBpdHMKICAgICAgICAgIHBhcmVudCByb3V0ZSdzIG5hbWVzLiBUaGlzIGlzIGhhbmR5IGZvciBwcmV2ZW50aW5nIGV4dHJlbWVseSBsb25nIHJvdXRlIG5hbWVzLgogICAgICAgICAgS2VlcCBpbiBtaW5kIHRoYXQgdGhlIGFjdHVhbCBVUkwgcGF0aCBiZWhhdmlvciBpcyBzdGlsbCByZXRhaW5lZC4KICAgICAgICAgVGhlIHRoaXJkIHBhcmFtZXRlciBpcyBhIGZ1bmN0aW9uLCB3aGljaCBjYW4gYmUgdXNlZCB0byBuZXN0IHJvdXRlcy4KICAgICAgTmVzdGVkIHJvdXRlcywgYnkgZGVmYXVsdCwgd2lsbCBoYXZlIHRoZSBwYXJlbnQgcm91dGUgdHJlZSdzIHJvdXRlIG5hbWUgYW5kCiAgICAgIHBhdGggcHJlcGVuZGVkIHRvIGl0J3Mgb3duLgogICAgICAgICBgYGBhcHAvcm91dGVyLmpzCiAgICAgIFJvdXRlci5tYXAoZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnJvdXRlKCdwb3N0JywgeyBwYXRoOiAnL3Bvc3QvOnBvc3RfaWQnIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5yb3V0ZSgnZWRpdCcpOwogICAgICAgICAgdGhpcy5yb3V0ZSgnY29tbWVudHMnLCB7IHJlc2V0TmFtZXNwYWNlOiB0cnVlIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnJvdXRlKCduZXcnKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgYGBgCiAgICAgICAgIEBtZXRob2QgbWFwCiAgICAgIEBwYXJhbSBjYWxsYmFjawogICAgICBAcHVibGljCiAgICAqLwogICAgbWFwOiBmdW5jdGlvbiBtYXAoY2FsbGJhY2spIHsKICAgICAgaWYgKCF0aGlzLmRzbENhbGxiYWNrcykgewogICAgICAgIHRoaXMuZHNsQ2FsbGJhY2tzID0gW107CiAgICAgICAgdGhpcy5yZW9wZW5DbGFzcyh7CiAgICAgICAgICBkc2xDYWxsYmFja3M6IHRoaXMuZHNsQ2FsbGJhY2tzCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHRoaXMuZHNsQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2spOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBfcm91dGVQYXRoOiBmdW5jdGlvbiBfcm91dGVQYXRoKHJvdXRlSW5mb3MpIHsKICAgICAgdmFyIHBhdGggPSBbXTsgLy8gV2UgaGF2ZSB0byBoYW5kbGUgY29hbGVzY2luZyByZXNvdXJjZSBuYW1lcyB0aGF0CiAgICAgIC8vIGFyZSBwcmVmaXhlZCB3aXRoIHRoZWlyIHBhcmVudCdzIG5hbWVzLCBlLmcuCiAgICAgIC8vIFsnZm9vJywgJ2Zvby5iYXIuYmF6J10gPT4gJ2Zvby5iYXIuYmF6Jywgbm90ICdmb28uZm9vLmJhci5iYXonCgogICAgICBmdW5jdGlvbiBpbnRlcnNlY3Rpb25NYXRjaGVzKGExLCBhMikgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYTEubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGlmIChhMVtpXSAhPT0gYTJbaV0pIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIHZhciBuYW1lLCBuYW1lUGFydHMsIG9sZE5hbWVQYXJ0czsKCiAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgcm91dGVJbmZvcy5sZW5ndGg7IGkrKykgewogICAgICAgIG5hbWUgPSByb3V0ZUluZm9zW2ldLm5hbWU7CiAgICAgICAgbmFtZVBhcnRzID0gbmFtZS5zcGxpdCgnLicpOwogICAgICAgIG9sZE5hbWVQYXJ0cyA9IHNsaWNlLmNhbGwocGF0aCk7CgogICAgICAgIHdoaWxlIChvbGROYW1lUGFydHMubGVuZ3RoKSB7CiAgICAgICAgICBpZiAoaW50ZXJzZWN0aW9uTWF0Y2hlcyhvbGROYW1lUGFydHMsIG5hbWVQYXJ0cykpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CgogICAgICAgICAgb2xkTmFtZVBhcnRzLnNoaWZ0KCk7CiAgICAgICAgfQoKICAgICAgICBwYXRoLnB1c2guYXBwbHkocGF0aCwgbmFtZVBhcnRzLnNsaWNlKG9sZE5hbWVQYXJ0cy5sZW5ndGgpKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBhdGguam9pbignLicpOwogICAgfQogIH0pOwoKICBmdW5jdGlvbiBkaWRCZWdpblRyYW5zaXRpb24odHJhbnNpdGlvbiwgcm91dGVyKSB7CiAgICB2YXIgcm91dGVyU3RhdGUgPSBuZXcgX3JvdXRlcl9zdGF0ZS5kZWZhdWx0KHJvdXRlciwgcm91dGVyLl9yb3V0ZXJNaWNyb2xpYiwgdHJhbnNpdGlvbltfcm91dGVyX2pzLlNUQVRFX1NZTUJPTF0pOwoKICAgIGlmICghcm91dGVyLmN1cnJlbnRTdGF0ZSkgewogICAgICByb3V0ZXIuc2V0KCdjdXJyZW50U3RhdGUnLCByb3V0ZXJTdGF0ZSk7CiAgICB9CgogICAgcm91dGVyLnNldCgndGFyZ2V0U3RhdGUnLCByb3V0ZXJTdGF0ZSk7CiAgICB0cmFuc2l0aW9uLnByb21pc2UgPSB0cmFuc2l0aW9uLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICBpZiAocm91dGVyLl9pc0Vycm9ySGFuZGxlZChlcnJvcikpIHsKICAgICAgICByb3V0ZXIuX2NsZWFySGFuZGxlZEVycm9yKGVycm9yKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgfSwgJ1RyYW5zaXRpb24gRXJyb3InKTsKICB9CgogIGZ1bmN0aW9uIGZvckVhY2hRdWVyeVBhcmFtKHJvdXRlciwgcm91dGVJbmZvcywgcXVlcnlQYXJhbXMsIGNhbGxiYWNrKSB7CiAgICB2YXIgcXBDYWNoZSA9IHJvdXRlci5fcXVlcnlQYXJhbXNGb3Iocm91dGVJbmZvcyk7CgogICAgZm9yICh2YXIga2V5IGluIHF1ZXJ5UGFyYW1zKSB7CiAgICAgIGlmICghcXVlcnlQYXJhbXMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CgogICAgICB2YXIgdmFsdWUgPSBxdWVyeVBhcmFtc1trZXldOwogICAgICB2YXIgcXAgPSBxcENhY2hlLm1hcFtrZXldOwogICAgICBjYWxsYmFjayhrZXksIHZhbHVlLCBxcCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBmaW5kTGl2ZVJvdXRlKGxpdmVSb3V0ZXMsIG5hbWUpIHsKICAgIGlmICghbGl2ZVJvdXRlcykgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHN0YWNrID0gW2xpdmVSb3V0ZXNdOwoKICAgIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7CiAgICAgIHZhciB0ZXN0ID0gc3RhY2suc2hpZnQoKTsKCiAgICAgIGlmICh0ZXN0LnJlbmRlci5uYW1lID09PSBuYW1lKSB7CiAgICAgICAgcmV0dXJuIHRlc3Q7CiAgICAgIH0KCiAgICAgIHZhciBvdXRsZXRzID0gdGVzdC5vdXRsZXRzOwoKICAgICAgZm9yICh2YXIgb3V0bGV0TmFtZSBpbiBvdXRsZXRzKSB7CiAgICAgICAgc3RhY2sucHVzaChvdXRsZXRzW291dGxldE5hbWVdKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybjsKICB9CgogIGZ1bmN0aW9uIGFwcGVuZExpdmVSb3V0ZShsaXZlUm91dGVzLCBkZWZhdWx0UGFyZW50U3RhdGUsIHJlbmRlck9wdGlvbnMpIHsKICAgIHZhciB0YXJnZXQ7CiAgICB2YXIgbXlTdGF0ZSA9IHsKICAgICAgcmVuZGVyOiByZW5kZXJPcHRpb25zLAogICAgICBvdXRsZXRzOiBPYmplY3QuY3JlYXRlKG51bGwpLAogICAgICB3YXNVc2VkOiBmYWxzZQogICAgfTsKCiAgICBpZiAocmVuZGVyT3B0aW9ucy5pbnRvKSB7CiAgICAgIHRhcmdldCA9IGZpbmRMaXZlUm91dGUobGl2ZVJvdXRlcywgcmVuZGVyT3B0aW9ucy5pbnRvKTsKICAgIH0gZWxzZSB7CiAgICAgIHRhcmdldCA9IGRlZmF1bHRQYXJlbnRTdGF0ZTsKICAgIH0KCiAgICBpZiAodGFyZ2V0KSB7CiAgICAgICgwLCBfbWV0YWwuc2V0KSh0YXJnZXQub3V0bGV0cywgcmVuZGVyT3B0aW9ucy5vdXRsZXQsIG15U3RhdGUpOwogICAgfSBlbHNlIHsKICAgICAgbGl2ZVJvdXRlcyA9IG15U3RhdGU7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgbGl2ZVJvdXRlczogbGl2ZVJvdXRlcywKICAgICAgb3duU3RhdGU6IG15U3RhdGUKICAgIH07CiAgfQoKICBmdW5jdGlvbiByZXByZXNlbnRFbXB0eVJvdXRlKGxpdmVSb3V0ZXMsIGRlZmF1bHRQYXJlbnRTdGF0ZSwgcm91dGUpIHsKICAgIC8vIHRoZSByb3V0ZSBkaWRuJ3QgcmVuZGVyIGFueXRoaW5nCiAgICB2YXIgYWxyZWFkeUFwcGVuZGVkID0gZmluZExpdmVSb3V0ZShsaXZlUm91dGVzLCByb3V0ZS5yb3V0ZU5hbWUpOwoKICAgIGlmIChhbHJlYWR5QXBwZW5kZWQpIHsKICAgICAgLy8gQnV0IHNvbWUgb3RoZXIgcm91dGUgaGFzIGFscmVhZHkgcmVuZGVyZWQgb3VyIGRlZmF1bHQKICAgICAgLy8gdGVtcGxhdGUsIHNvIHRoYXQgYmVjb21lcyB0aGUgZGVmYXVsdCB0YXJnZXQgZm9yIGFueQogICAgICAvLyBjaGlsZHJlbiB3ZSBtYXkgaGF2ZS4KICAgICAgcmV0dXJuIGFscmVhZHlBcHBlbmRlZDsKICAgIH0gZWxzZSB7CiAgICAgIC8vIENyZWF0ZSBhbiBlbnRyeSB0byByZXByZXNlbnQgb3VyIGRlZmF1bHQgdGVtcGxhdGUgbmFtZSwKICAgICAgLy8ganVzdCBzbyBvdGhlciByb3V0ZXMgY2FuIHRhcmdldCBpdCBhbmQgaW5oZXJpdCBpdHMgcGxhY2UKICAgICAgLy8gaW4gdGhlIG91dGxldCBoaWVyYXJjaHkuCiAgICAgIGRlZmF1bHRQYXJlbnRTdGF0ZS5vdXRsZXRzLm1haW4gPSB7CiAgICAgICAgcmVuZGVyOiB7CiAgICAgICAgICBuYW1lOiByb3V0ZS5yb3V0ZU5hbWUsCiAgICAgICAgICBvdXRsZXQ6ICdtYWluJwogICAgICAgIH0sCiAgICAgICAgb3V0bGV0czoge30KICAgICAgfTsKICAgICAgcmV0dXJuIGRlZmF1bHRQYXJlbnRTdGF0ZTsKICAgIH0KICB9CgogIEVtYmVyUm91dGVyLnJlb3BlbihfcnVudGltZS5FdmVudGVkLCB7CiAgICAvKioKICAgICAgSGFuZGxlcyB1cGRhdGluZyB0aGUgcGF0aHMgYW5kIG5vdGlmeWluZyBhbnkgbGlzdGVuZXJzIG9mIHRoZSBVUkwKICAgICAgY2hhbmdlLgogICAgICAgICBUcmlnZ2VycyB0aGUgcm91dGVyIGxldmVsIGBkaWRUcmFuc2l0aW9uYCBob29rLgogICAgICAgICBGb3IgZXhhbXBsZSwgdG8gbm90aWZ5IGdvb2dsZSBhbmFseXRpY3Mgd2hlbiB0aGUgcm91dGUgY2hhbmdlcywKICAgICAgeW91IGNvdWxkIHVzZSB0aGlzIGhvb2suICAoTm90ZTogcmVxdWlyZXMgYWxzbyBpbmNsdWRpbmcgR0Egc2NyaXB0cywgZXRjLikKICAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgY29uZmlnIGZyb20gJy4vY29uZmlnL2Vudmlyb25tZW50JzsKICAgICAgaW1wb3J0IEVtYmVyUm91dGVyIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlcic7CiAgICAgIGltcG9ydCB7IGluamVjdCBhcyBzZXJ2aWNlIH0gZnJvbSAnQGVtYmVyL3NlcnZpY2UnOwogICAgICAgICBsZXQgUm91dGVyID0gRW1iZXJSb3V0ZXIuZXh0ZW5kKHsKICAgICAgICBsb2NhdGlvbjogY29uZmlnLmxvY2F0aW9uVHlwZSwKICAgICAgICAgICByb3V0ZXI6IHNlcnZpY2UoKSwKICAgICAgICAgICBkaWRUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CiAgICAgICAgICAgICBnYSgnc2VuZCcsICdwYWdldmlldycsIHsKICAgICAgICAgICAgcGFnZTogdGhpcy5yb3V0ZXIuY3VycmVudFVSTCwKICAgICAgICAgICAgdGl0bGU6IHRoaXMucm91dGVyLmN1cnJlbnRSb3V0ZU5hbWUsCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgICAgQG1ldGhvZCBkaWRUcmFuc2l0aW9uCiAgICAgIEBwdWJsaWMKICAgICAgQHNpbmNlIDEuMi4wCiAgICAqLwogICAgZGlkVHJhbnNpdGlvbjogZGVmYXVsdERpZFRyYW5zaXRpb24sCgogICAgLyoqCiAgICAgIEhhbmRsZXMgbm90aWZ5aW5nIGFueSBsaXN0ZW5lcnMgb2YgYW4gaW1wZW5kaW5nIFVSTAogICAgICBjaGFuZ2UuCiAgICAgICAgIFRyaWdnZXJzIHRoZSByb3V0ZXIgbGV2ZWwgYHdpbGxUcmFuc2l0aW9uYCBob29rLgogICAgICAgICBAbWV0aG9kIHdpbGxUcmFuc2l0aW9uCiAgICAgIEBwdWJsaWMKICAgICAgQHNpbmNlIDEuMTEuMAogICAgKi8KICAgIHdpbGxUcmFuc2l0aW9uOiBkZWZhdWx0V2lsbFRyYW5zaXRpb24sCgogICAgLyoqCiAgICAgUmVwcmVzZW50cyB0aGUgVVJMIG9mIHRoZSByb290IG9mIHRoZSBhcHBsaWNhdGlvbiwgb2Z0ZW4gJy8nLiBUaGlzIHByZWZpeCBpcwogICAgIGFzc3VtZWQgb24gYWxsIHJvdXRlcyBkZWZpbmVkIG9uIHRoaXMgcm91dGVyLgogICAgICAgIEBwcm9wZXJ0eSByb290VVJMCiAgICAgQGRlZmF1bHQgJy8nCiAgICAgQHB1YmxpYwogICAgKi8KICAgIHJvb3RVUkw6ICcvJywKCiAgICAvKioKICAgICBUaGUgYGxvY2F0aW9uYCBwcm9wZXJ0eSBkZXRlcm1pbmVzIHRoZSB0eXBlIG9mIFVSTCdzIHRoYXQgeW91cgogICAgIGFwcGxpY2F0aW9uIHdpbGwgdXNlLgogICAgICAgIFRoZSBmb2xsb3dpbmcgbG9jYXRpb24gdHlwZXMgYXJlIGN1cnJlbnRseSBhdmFpbGFibGU6CiAgICAgICAgKiBgaGlzdG9yeWAgLSB1c2UgdGhlIGJyb3dzZXIncyBoaXN0b3J5IEFQSSB0byBtYWtlIHRoZSBVUkxzIGxvb2sganVzdCBsaWtlIGFueSBzdGFuZGFyZCBVUkwKICAgICAqIGBoYXNoYCAtIHVzZSBgI2AgdG8gc2VwYXJhdGUgdGhlIHNlcnZlciBwYXJ0IG9mIHRoZSBVUkwgZnJvbSB0aGUgRW1iZXIgcGFydDogYC9ibG9nLyMvcG9zdHMvbmV3YAogICAgICogYG5vbmVgIC0gZG8gbm90IHN0b3JlIHRoZSBFbWJlciBVUkwgaW4gdGhlIGFjdHVhbCBicm93c2VyIFVSTCAobWFpbmx5IHVzZWQgZm9yIHRlc3RpbmcpCiAgICAgKiBgYXV0b2AgLSB1c2UgdGhlIGJlc3Qgb3B0aW9uIGJhc2VkIG9uIGJyb3dzZXIgY2FwYWJpbGl0aWVzOiBgaGlzdG9yeWAgaWYgcG9zc2libGUsIHRoZW4gYGhhc2hgIGlmIHBvc3NpYmxlLCBvdGhlcndpc2UgYG5vbmVgCiAgICAgICAgVGhpcyB2YWx1ZSBpcyBkZWZhdWx0ZWQgdG8gYGF1dG9gIGJ5IHRoZSBgbG9jYXRpb25UeXBlYCBzZXR0aW5nIG9mIGAvY29uZmlnL2Vudmlyb25tZW50LmpzYAogICAgICAgIEBwcm9wZXJ0eSBsb2NhdGlvbgogICAgIEBkZWZhdWx0ICdoYXNoJwogICAgIEBzZWUge0xvY2F0aW9ufQogICAgIEBwdWJsaWMKICAgICovCiAgICBsb2NhdGlvbjogJ2hhc2gnLAoKICAgIC8qKgogICAgIFJlcHJlc2VudHMgdGhlIGN1cnJlbnQgVVJMLgogICAgICAgIEBwcm9wZXJ0eSB1cmwKICAgICBAdHlwZSB7U3RyaW5nfQogICAgIEBwcml2YXRlCiAgICAqLwogICAgdXJsOiAoMCwgX21ldGFsLmNvbXB1dGVkKShmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBsb2NhdGlvbiA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAnbG9jYXRpb24nKTsKCiAgICAgIGlmICh0eXBlb2YgbG9jYXRpb24gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgcmV0dXJuIGxvY2F0aW9uLmdldFVSTCgpOwogICAgfSkKICB9KTsKCiAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuUk9VVEVSX0VWRU5UUykgewogICAgRW1iZXJSb3V0ZXIucmVvcGVuKF9yb3V0ZS5ST1VURVJfRVZFTlRfREVQUkVDQVRJT05TKTsKICB9CgogIHZhciBfZGVmYXVsdCA9IEVtYmVyUm91dGVyOwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvc3lzdGVtL3JvdXRlcl9zdGF0ZSIsIFsiZXhwb3J0cyIsICJAZW1iZXIvcG9seWZpbGxzIiwgIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL3V0aWxzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX3BvbHlmaWxscywgX3V0aWxzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICB2YXIgUm91dGVyU3RhdGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBSb3V0ZXJTdGF0ZShlbWJlclJvdXRlciwgcm91dGVyLCByb3V0ZXJKc1N0YXRlKSB7CiAgICAgIHRoaXMuZW1iZXJSb3V0ZXIgPSBlbWJlclJvdXRlcjsKICAgICAgdGhpcy5yb3V0ZXIgPSByb3V0ZXI7CiAgICAgIHRoaXMucm91dGVySnNTdGF0ZSA9IHJvdXRlckpzU3RhdGU7CiAgICB9CgogICAgdmFyIF9wcm90byA9IFJvdXRlclN0YXRlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8uaXNBY3RpdmVJbnRlbnQgPSBmdW5jdGlvbiBpc0FjdGl2ZUludGVudChyb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMsIHF1ZXJ5UGFyYW1zTXVzdE1hdGNoKSB7CiAgICAgIHZhciBzdGF0ZSA9IHRoaXMucm91dGVySnNTdGF0ZTsKCiAgICAgIGlmICghdGhpcy5yb3V0ZXIuaXNBY3RpdmVJbnRlbnQocm91dGVOYW1lLCBtb2RlbHMsIHVuZGVmaW5lZCwgc3RhdGUpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBpZiAocXVlcnlQYXJhbXNNdXN0TWF0Y2ggJiYgT2JqZWN0LmtleXMocXVlcnlQYXJhbXMpLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgdmlzaWJsZVF1ZXJ5UGFyYW1zID0gKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7fSwgcXVlcnlQYXJhbXMpOwoKICAgICAgICB0aGlzLmVtYmVyUm91dGVyLl9wcmVwYXJlUXVlcnlQYXJhbXMocm91dGVOYW1lLCBtb2RlbHMsIHZpc2libGVRdWVyeVBhcmFtcyk7CgogICAgICAgIHJldHVybiAoMCwgX3V0aWxzLnNoYWxsb3dFcXVhbCkodmlzaWJsZVF1ZXJ5UGFyYW1zLCBzdGF0ZS5xdWVyeVBhcmFtcyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfTsKCiAgICByZXR1cm4gUm91dGVyU3RhdGU7CiAgfSgpOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gUm91dGVyU3RhdGU7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmcvbGliL3N5c3RlbS90cmFuc2l0aW9uIiwgW10sIGZ1bmN0aW9uICgpIHsKICAidXNlIHN0cmljdCI7CiAgLyoqCiAgICBBIFRyYW5zaXRpb24gaXMgYSB0aGVubmFibGUgKGEgcHJvbWlzZS1saWtlIG9iamVjdCkgdGhhdCByZXByZXNlbnRzCiAgICBhbiBhdHRlbXB0IHRvIHRyYW5zaXRpb24gdG8gYW5vdGhlciByb3V0ZS4gSXQgY2FuIGJlIGFib3J0ZWQsIGVpdGhlcgogICAgZXhwbGljaXRseSB2aWEgYGFib3J0YCBvciBieSBhdHRlbXB0aW5nIGFub3RoZXIgdHJhbnNpdGlvbiB3aGlsZSBhCiAgICBwcmV2aW91cyBvbmUgaXMgc3RpbGwgdW5kZXJ3YXkuIEFuIGFib3J0ZWQgdHJhbnNpdGlvbiBjYW4gYWxzbwogICAgYmUgYHJldHJ5KClgZCBsYXRlci4KICAKICAgIEBjbGFzcyBUcmFuc2l0aW9uCiAgICBAcHVibGljCiAgKi8KCiAgLyoqCiAgICBUaGUgVHJhbnNpdGlvbidzIGludGVybmFsIHByb21pc2UuIENhbGxpbmcgYC50aGVuYCBvbiB0aGlzIHByb3BlcnR5CiAgICBpcyB0aGF0IHNhbWUgYXMgY2FsbGluZyBgLnRoZW5gIG9uIHRoZSBUcmFuc2l0aW9uIG9iamVjdCBpdHNlbGYsIGJ1dAogICAgdGhpcyBwcm9wZXJ0eSBpcyBleHBvc2VkIGZvciB3aGVuIHlvdSB3YW50IHRvIHBhc3MgYXJvdW5kIGEKICAgIFRyYW5zaXRpb24ncyBwcm9taXNlLCBidXQgbm90IHRoZSBUcmFuc2l0aW9uIG9iamVjdCBpdHNlbGYsIHNpbmNlCiAgICBUcmFuc2l0aW9uIG9iamVjdCBjYW4gYmUgZXh0ZXJuYWxseSBgYWJvcnRgZWQsIHdoaWxlIHRoZSBwcm9taXNlCiAgICBjYW5ub3QuCiAgCiAgICBAcHJvcGVydHkgcHJvbWlzZQogICAgQHR5cGUge09iamVjdH0KICAgIEBwdWJsaWMKICAgICovCgogIC8qKgogICAgQ3VzdG9tIHN0YXRlIGNhbiBiZSBzdG9yZWQgb24gYSBUcmFuc2l0aW9uJ3MgYGRhdGFgIG9iamVjdC4KICAgIFRoaXMgY2FuIGJlIHVzZWZ1bCBmb3IgZGVjb3JhdGluZyBhIFRyYW5zaXRpb24gd2l0aGluIGFuIGVhcmxpZXIKICAgIGhvb2sgYW5kIHNoYXJlZCB3aXRoIGEgbGF0ZXIgaG9vay4gUHJvcGVydGllcyBzZXQgb24gYGRhdGFgIHdpbGwKICAgIGJlIGNvcGllZCB0byBuZXcgdHJhbnNpdGlvbnMgZ2VuZXJhdGVkIGJ5IGNhbGxpbmcgYHJldHJ5YCBvbiB0aGlzCiAgICB0cmFuc2l0aW9uLgogIAogICAgQHByb3BlcnR5IGRhdGEKICAgIEB0eXBlIHtPYmplY3R9CiAgICBAcHVibGljCiAgKi8KCiAgLyoqCiAgICBBIHN0YW5kYXJkIHByb21pc2UgaG9vayB0aGF0IHJlc29sdmVzIGlmIHRoZSB0cmFuc2l0aW9uCiAgICBzdWNjZWVkcyBhbmQgcmVqZWN0cyBpZiBpdCBmYWlscy9yZWRpcmVjdHMvYWJvcnRzLgogIAogICAgRm9yd2FyZHMgdG8gdGhlIGludGVybmFsIGBwcm9taXNlYCBwcm9wZXJ0eSB3aGljaCB5b3UgY2FuCiAgICB1c2UgaW4gc2l0dWF0aW9ucyB3aGVyZSB5b3Ugd2FudCB0byBwYXNzIGFyb3VuZCBhIHRoZW5uYWJsZSwKICAgIGJ1dCBub3QgdGhlIFRyYW5zaXRpb24gaXRzZWxmLgogIAogICAgQG1ldGhvZCB0aGVuCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBvbkZ1bGZpbGxlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gb25SZWplY3RlZAogICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAcmV0dXJuIHtQcm9taXNlfQogICAgQHB1YmxpYwogICovCgogIC8qKgogIAogICAgRm9yd2FyZHMgdG8gdGhlIGludGVybmFsIGBwcm9taXNlYCBwcm9wZXJ0eSB3aGljaCB5b3UgY2FuCiAgICB1c2UgaW4gc2l0dWF0aW9ucyB3aGVyZSB5b3Ugd2FudCB0byBwYXNzIGFyb3VuZCBhIHRoZW5uYWJsZSwKICAgIGJ1dCBub3QgdGhlIFRyYW5zaXRpb24gaXRzZWxmLgogIAogICAgQG1ldGhvZCBjYXRjaAogICAgQHBhcmFtIHtGdW5jdGlvbn0gb25SZWplY3Rpb24KICAgIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCBvcHRpb25hbCBzdHJpbmcgZm9yIGxhYmVsaW5nIHRoZSBwcm9taXNlLgogICAgVXNlZnVsIGZvciB0b29saW5nLgogICAgQHJldHVybiB7UHJvbWlzZX0KICAgIEBwdWJsaWMKICAqLwoKICAvKioKICAKICAgIEZvcndhcmRzIHRvIHRoZSBpbnRlcm5hbCBgcHJvbWlzZWAgcHJvcGVydHkgd2hpY2ggeW91IGNhbgogICAgdXNlIGluIHNpdHVhdGlvbnMgd2hlcmUgeW91IHdhbnQgdG8gcGFzcyBhcm91bmQgYSB0aGVubmFibGUsCiAgICBidXQgbm90IHRoZSBUcmFuc2l0aW9uIGl0c2VsZi4KICAKICAgIEBtZXRob2QgZmluYWxseQogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICAgIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCBvcHRpb25hbCBzdHJpbmcgZm9yIGxhYmVsaW5nIHRoZSBwcm9taXNlLgogICAgVXNlZnVsIGZvciB0b29saW5nLgogICAgQHJldHVybiB7UHJvbWlzZX0KICAgIEBwdWJsaWMKICAqLwoKICAvKioKICAgIEFib3J0cyB0aGUgVHJhbnNpdGlvbi4gTm90ZSB5b3UgY2FuIGFsc28gaW1wbGljaXRseSBhYm9ydCBhIHRyYW5zaXRpb24KICAgIGJ5IGluaXRpYXRpbmcgYW5vdGhlciB0cmFuc2l0aW9uIHdoaWxlIGEgcHJldmlvdXMgb25lIGlzIHVuZGVyd2F5LgogIAogICAgQG1ldGhvZCBhYm9ydAogICAgQHJldHVybiB7VHJhbnNpdGlvbn0gdGhpcyB0cmFuc2l0aW9uCiAgICBAcHVibGljCiAgKi8KCiAgLyoqCiAgCiAgICBSZXRyaWVzIGEgcHJldmlvdXNseS1hYm9ydGVkIHRyYW5zaXRpb24gKG1ha2luZyBzdXJlIHRvIGFib3J0IHRoZQogICAgdHJhbnNpdGlvbiBpZiBpdCdzIHN0aWxsIGFjdGl2ZSkuIFJldHVybnMgYSBuZXcgdHJhbnNpdGlvbiB0aGF0CiAgICByZXByZXNlbnRzIHRoZSBuZXcgYXR0ZW1wdCB0byB0cmFuc2l0aW9uLgogIAogICAgQG1ldGhvZCByZXRyeQogICAgQHJldHVybiB7VHJhbnNpdGlvbn0gbmV3IHRyYW5zaXRpb24KICAgIEBwdWJsaWMKICAgICovCgogIC8qKgogIAogICAgU2V0cyB0aGUgVVJMLWNoYW5naW5nIG1ldGhvZCB0byBiZSBlbXBsb3llZCBhdCB0aGUgZW5kIG9mIGEKICAgIHN1Y2Nlc3NmdWwgdHJhbnNpdGlvbi4gQnkgZGVmYXVsdCwgYSBuZXcgVHJhbnNpdGlvbiB3aWxsIGp1c3QKICAgIHVzZSBgdXBkYXRlVVJMYCwgYnV0IHBhc3NpbmcgJ3JlcGxhY2UnIHRvIHRoaXMgbWV0aG9kIHdpbGwKICAgIGNhdXNlIHRoZSBVUkwgdG8gdXBkYXRlIHVzaW5nICdyZXBsYWNlV2l0aCcgaW5zdGVhZC4gT21pdHRpbmcKICAgIGEgcGFyYW1ldGVyIHdpbGwgZGlzYWJsZSB0aGUgVVJMIGNoYW5nZSwgYWxsb3dpbmcgZm9yIHRyYW5zaXRpb25zCiAgICB0aGF0IGRvbid0IHVwZGF0ZSB0aGUgVVJMIGF0IGNvbXBsZXRpb24gKHRoaXMgaXMgYWxzbyB1c2VkIGZvcgogICAgaGFuZGxlVVJMLCBzaW5jZSB0aGUgVVJMIGhhcyBhbHJlYWR5IGNoYW5nZWQgYmVmb3JlIHRoZQogICAgdHJhbnNpdGlvbiB0b29rIHBsYWNlKS4KICAKICAgIEBtZXRob2QgbWV0aG9kCiAgICBAcGFyYW0ge1N0cmluZ30gbWV0aG9kIHRoZSB0eXBlIG9mIFVSTC1jaGFuZ2luZyBtZXRob2QgdG8gdXNlCiAgICAgIGF0IHRoZSBlbmQgb2YgYSB0cmFuc2l0aW9uLiBBY2NlcHRlZCB2YWx1ZXMgYXJlICdyZXBsYWNlJywKICAgICAgZmFsc3kgdmFsdWVzLCBvciBhbnkgb3RoZXIgbm9uLWZhbHN5IHZhbHVlICh3aGljaCBpcwogICAgICBpbnRlcnByZXRlZCBhcyBhbiB1cGRhdGVVUkwgdHJhbnNpdGlvbikuCiAgCiAgICBAcmV0dXJuIHtUcmFuc2l0aW9ufSB0aGlzIHRyYW5zaXRpb24KICAgIEBwdWJsaWMKICAqLwoKICAvKioKICAKICAgIEZpcmVzIGFuIGV2ZW50IG9uIHRoZSBjdXJyZW50IGxpc3Qgb2YgcmVzb2x2ZWQvcmVzb2x2aW5nCiAgICBoYW5kbGVycyB3aXRoaW4gdGhpcyB0cmFuc2l0aW9uLiBVc2VmdWwgZm9yIGZpcmluZyBldmVudHMKICAgIG9uIHJvdXRlIGhpZXJhcmNoaWVzIHRoYXQgaGF2ZW4ndCBmdWxseSBiZWVuIGVudGVyZWQgeWV0LgogIAogICAgTm90ZTogVGhpcyBtZXRob2QgaXMgYWxzbyBhbGlhc2VkIGFzIGBzZW5kYAogIAogICAgQG1ldGhvZCB0cmlnZ2VyCiAgICBAcGFyYW0ge0Jvb2xlYW59IFtpZ25vcmVGYWlsdXJlPWZhbHNlXSBhIGJvb2xlYW4gc3BlY2lmeWluZyB3aGV0aGVyIHVuaGFuZGxlZCBldmVudHMgdGhyb3cgYW4gZXJyb3IKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIHRoZSBuYW1lIG9mIHRoZSBldmVudCB0byBmaXJlCiAgICBAcHVibGljCiAgKi8KCiAgLyoqCiAgICogVGhpcyBwcm9wZXJ0eSBpcyBhIGBSb3V0ZUluZm9gIG9iamVjdCB0aGF0IHJlcHJlc2VudHMKICAgKiB3aGVyZSB0aGUgcm91dGVyIGlzIHRyYW5zaXRpb25pbmcgdG8uIEl0J3MgaW1wb3J0YW50CiAgICogdG8gbm90ZSB0aGF0IGEgYFJvdXRlSW5mb2AgaXMgYSBsaW5rZWQgbGlzdCBhbmQgdGhpcwogICAqIHByb3BlcnR5IHJlcHJlc2VudHMgdGhlIGxlYWZtb3N0IHJvdXRlLgogICAqIEBwcm9wZXJ0eSB7bnVsbHxSb3V0ZUluZm98Um91dGVJbmZvV2l0aEF0dHJpYnV0ZXN9IHRvCiAgICogQHB1YmxpYwogICAqLwoKICAvKioKICAgKiBUaGlzIHByb3BlcnR5IGlzIGEgYFJvdXRlSW5mb2Agb2JqZWN0IHRoYXQgcmVwcmVzZW50cwogICAqIHdoZXJlIHRyYW5zaXRpb24gb3JpZ2luYXRlZCBmcm9tLiBJdCdzIGltcG9ydGFudAogICAqIHRvIG5vdGUgdGhhdCBhIGBSb3V0ZUluZm9gIGlzIGEgbGlua2VkIGxpc3QgYW5kIHRoaXMKICAgKiBwcm9wZXJ0eSByZXByZXNlbnRzIHRoZSBoZWFkIG5vZGUgb2YgdGhlIGxpc3QuCiAgICogSW4gdGhlIGNhc2Ugb2YgYW4gaW5pdGlhbCByZW5kZXIsIGBmcm9tYCB3aWxsIGJlIHNldCB0bwogICAqIGBudWxsYC4KICAgKiBAcHJvcGVydHkge251bGx8Um91dGVJbmZvV2l0aEF0dHJpYnV0ZXN9IGZyb20KICAgKiBAcHVibGljCiAgICovCgogIC8qKgogICAgVHJhbnNpdGlvbnMgYXJlIGFib3J0ZWQgYW5kIHRoZWlyIHByb21pc2VzIHJlamVjdGVkCiAgICB3aGVuIHJlZGlyZWN0cyBvY2N1cjsgdGhpcyBtZXRob2QgcmV0dXJucyBhIHByb21pc2UKICAgIHRoYXQgd2lsbCBmb2xsb3cgYW55IHJlZGlyZWN0cyB0aGF0IG9jY3VyIGFuZCBmdWxmaWxsCiAgICB3aXRoIHRoZSB2YWx1ZSBmdWxmaWxsZWQgYnkgYW55IHJlZGlyZWN0aW5nIHRyYW5zaXRpb25zCiAgICB0aGF0IG9jY3VyLgogIAogICAgQG1ldGhvZCBmb2xsb3dSZWRpcmVjdHMKICAgIEByZXR1cm4ge1Byb21pc2V9IGEgcHJvbWlzZSB0aGF0IGZ1bGZpbGxzIHdpdGggdGhlIHNhbWUKICAgICAgdmFsdWUgdGhhdCB0aGUgZmluYWwgcmVkaXJlY3RpbmcgdHJhbnNpdGlvbiBmdWxmaWxscyB3aXRoCiAgICBAcHVibGljCiAgKi8KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZy9saWIvdXRpbHMiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiLCAiQGVtYmVyLy1pbnRlcm5hbHMvb3duZXIiLCAiQGVtYmVyL2Vycm9yIiwgIkBlbWJlci9wb2x5ZmlsbHMiLCAicm91dGVyX2pzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX21ldGFsLCBfb3duZXIsIF9lcnJvciwgX3BvbHlmaWxscywgX3JvdXRlcl9qcykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZXh0cmFjdFJvdXRlQXJncyA9IGV4dHJhY3RSb3V0ZUFyZ3M7CiAgX2V4cG9ydHMuZ2V0QWN0aXZlVGFyZ2V0TmFtZSA9IGdldEFjdGl2ZVRhcmdldE5hbWU7CiAgX2V4cG9ydHMuc3Rhc2hQYXJhbU5hbWVzID0gc3Rhc2hQYXJhbU5hbWVzOwogIF9leHBvcnRzLmNhbGN1bGF0ZUNhY2hlS2V5ID0gY2FsY3VsYXRlQ2FjaGVLZXk7CiAgX2V4cG9ydHMubm9ybWFsaXplQ29udHJvbGxlclF1ZXJ5UGFyYW1zID0gbm9ybWFsaXplQ29udHJvbGxlclF1ZXJ5UGFyYW1zOwogIF9leHBvcnRzLnJlc2VtYmxlc1VSTCA9IHJlc2VtYmxlc1VSTDsKICBfZXhwb3J0cy5wcmVmaXhSb3V0ZU5hbWVBcmcgPSBwcmVmaXhSb3V0ZU5hbWVBcmc7CiAgX2V4cG9ydHMuc2hhbGxvd0VxdWFsID0gc2hhbGxvd0VxdWFsOwogIHZhciBBTExfUEVSSU9EU19SRUdFWCA9IC9cLi9nOwoKICBmdW5jdGlvbiBleHRyYWN0Um91dGVBcmdzKGFyZ3MpIHsKICAgIGFyZ3MgPSBhcmdzLnNsaWNlKCk7CiAgICB2YXIgcG9zc2libGVRdWVyeVBhcmFtcyA9IGFyZ3NbYXJncy5sZW5ndGggLSAxXTsKICAgIHZhciBxdWVyeVBhcmFtczsKCiAgICBpZiAocG9zc2libGVRdWVyeVBhcmFtcyAmJiBwb3NzaWJsZVF1ZXJ5UGFyYW1zLmhhc093blByb3BlcnR5KCdxdWVyeVBhcmFtcycpKSB7CiAgICAgIHF1ZXJ5UGFyYW1zID0gYXJncy5wb3AoKS5xdWVyeVBhcmFtczsKICAgIH0gZWxzZSB7CiAgICAgIHF1ZXJ5UGFyYW1zID0ge307CiAgICB9CgogICAgdmFyIHJvdXRlTmFtZSA9IGFyZ3Muc2hpZnQoKTsKICAgIHJldHVybiB7CiAgICAgIHJvdXRlTmFtZTogcm91dGVOYW1lLAogICAgICBtb2RlbHM6IGFyZ3MsCiAgICAgIHF1ZXJ5UGFyYW1zOiBxdWVyeVBhcmFtcwogICAgfTsKICB9CgogIGZ1bmN0aW9uIGdldEFjdGl2ZVRhcmdldE5hbWUocm91dGVyKSB7CiAgICB2YXIgcm91dGVJbmZvcyA9IHJvdXRlci5hY3RpdmVUcmFuc2l0aW9uID8gcm91dGVyLmFjdGl2ZVRyYW5zaXRpb25bX3JvdXRlcl9qcy5TVEFURV9TWU1CT0xdLnJvdXRlSW5mb3MgOiByb3V0ZXIuc3RhdGUucm91dGVJbmZvczsKICAgIHJldHVybiByb3V0ZUluZm9zW3JvdXRlSW5mb3MubGVuZ3RoIC0gMV0ubmFtZTsKICB9CgogIGZ1bmN0aW9uIHN0YXNoUGFyYW1OYW1lcyhyb3V0ZXIsIHJvdXRlSW5mb3MpIHsKICAgIGlmIChyb3V0ZUluZm9zWydfbmFtZXNTdGFzaGVkJ10pIHsKICAgICAgcmV0dXJuOwogICAgfSAvLyBUaGlzIGhlbHBlciBleGlzdHMgYmVjYXVzZSByb3V0ZXIuanMvcm91dGUtcmVjb2duaXplci5qcyBhd2t3YXJkbHkKICAgIC8vIGtlZXBzIHNlcGFyYXRlIGEgcm91dGVJbmZvJ3MgbGlzdCBvZiBwYXJhbWV0ZXIgbmFtZXMgZGVwZW5kaW5nCiAgICAvLyBvbiB3aGV0aGVyIGEgVVJMIHRyYW5zaXRpb24gb3IgbmFtZWQgdHJhbnNpdGlvbiBpcyBoYXBwZW5pbmcuCiAgICAvLyBIb3BlZnVsbHkgd2UgY2FuIHJlbW92ZSB0aGlzIGluIHRoZSBmdXR1cmUuCgoKICAgIHZhciB0YXJnZXRSb3V0ZU5hbWUgPSByb3V0ZUluZm9zW3JvdXRlSW5mb3MubGVuZ3RoIC0gMV0ubmFtZTsKCiAgICB2YXIgcmVjb2dIYW5kbGVycyA9IHJvdXRlci5fcm91dGVyTWljcm9saWIucmVjb2duaXplci5oYW5kbGVyc0Zvcih0YXJnZXRSb3V0ZU5hbWUpOwoKICAgIHZhciBkeW5hbWljUGFyZW50OwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcm91dGVJbmZvcy5sZW5ndGg7ICsraSkgewogICAgICB2YXIgcm91dGVJbmZvID0gcm91dGVJbmZvc1tpXTsKICAgICAgdmFyIG5hbWVzID0gcmVjb2dIYW5kbGVyc1tpXS5uYW1lczsKCiAgICAgIGlmIChuYW1lcy5sZW5ndGgpIHsKICAgICAgICBkeW5hbWljUGFyZW50ID0gcm91dGVJbmZvOwogICAgICB9CgogICAgICByb3V0ZUluZm9bJ19uYW1lcyddID0gbmFtZXM7CiAgICAgIHZhciByb3V0ZSA9IHJvdXRlSW5mby5yb3V0ZTsKCiAgICAgIHJvdXRlLl9zdGFzaE5hbWVzKHJvdXRlSW5mbywgZHluYW1pY1BhcmVudCk7CiAgICB9CgogICAgcm91dGVJbmZvc1snX25hbWVzU3Rhc2hlZCddID0gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIF9jYWxjdWxhdGVDYWNoZVZhbHVlUHJlZml4KHByZWZpeCwgcGFydCkgewogICAgLy8gY2FsY3VsYXRlcyB0aGUgZG90IHNlcGFyYXRlZCBzZWN0aW9ucyBmcm9tIHByZWZpeCB0aGF0IGFyZSBhbHNvCiAgICAvLyBhdCB0aGUgc3RhcnQgb2YgcGFydCAtIHdoaWNoIGdpdmVzIHVzIHRoZSByb3V0ZSBuYW1lCiAgICAvLyBnaXZlbiA6IHByZWZpeCA9IHNpdGUuYXJ0aWNsZS5jb21tZW50cywgcGFydCA9IHNpdGUuYXJ0aWNsZS5pZAogICAgLy8gICAgICAtIHJldHVybnM6IHNpdGUuYXJ0aWNsZSAodXNlIGdldCh2YWx1ZXNbc2l0ZS5hcnRpY2xlXSwgJ2lkJykgdG8gZ2V0IHRoZSBkeW5hbWljIHBhcnQgLSB1c2VkIGJlbG93KQogICAgLy8gZ2l2ZW4gOiBwcmVmaXggPSBzaXRlLmFydGljbGUsIHBhcnQgPSBzaXRlLmFydGljbGUuaWQKICAgIC8vICAgICAgLSByZXR1cm5zOiBzaXRlLmFydGljbGUuICh1c2UgZ2V0KHZhbHVlc1tzaXRlLmFydGljbGVdLCAnaWQnKSB0byBnZXQgdGhlIGR5bmFtaWMgcGFydCAtIHVzZWQgYmVsb3cpCiAgICB2YXIgcHJlZml4UGFydHMgPSBwcmVmaXguc3BsaXQoJy4nKTsKICAgIHZhciBjdXJyUHJlZml4ID0gJyc7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcmVmaXhQYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgY3VyclBhcnQgPSBwcmVmaXhQYXJ0cy5zbGljZSgwLCBpICsgMSkuam9pbignLicpOwoKICAgICAgaWYgKHBhcnQuaW5kZXhPZihjdXJyUGFydCkgIT09IDApIHsKICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgY3VyclByZWZpeCA9IGN1cnJQYXJ0OwogICAgfQoKICAgIHJldHVybiBjdXJyUHJlZml4OwogIH0KICAvKgogICAgU3RvbGVuIGZyb20gQ29udHJvbGxlcgogICovCgoKICBmdW5jdGlvbiBjYWxjdWxhdGVDYWNoZUtleShwcmVmaXgsIHBhcnRzLCB2YWx1ZXMpIHsKICAgIGlmIChwYXJ0cyA9PT0gdm9pZCAwKSB7CiAgICAgIHBhcnRzID0gW107CiAgICB9CgogICAgdmFyIHN1ZmZpeGVzID0gJyc7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7ICsraSkgewogICAgICB2YXIgcGFydCA9IHBhcnRzW2ldOwoKICAgICAgdmFyIGNhY2hlVmFsdWVQcmVmaXggPSBfY2FsY3VsYXRlQ2FjaGVWYWx1ZVByZWZpeChwcmVmaXgsIHBhcnQpOwoKICAgICAgdmFyIHZhbHVlID0gdm9pZCAwOwoKICAgICAgaWYgKHZhbHVlcykgewogICAgICAgIGlmIChjYWNoZVZhbHVlUHJlZml4ICYmIGNhY2hlVmFsdWVQcmVmaXggaW4gdmFsdWVzKSB7CiAgICAgICAgICB2YXIgcGFydFJlbW92ZWRQcmVmaXggPSBwYXJ0LmluZGV4T2YoY2FjaGVWYWx1ZVByZWZpeCkgPT09IDAgPyBwYXJ0LnN1YnN0cihjYWNoZVZhbHVlUHJlZml4Lmxlbmd0aCArIDEpIDogcGFydDsKICAgICAgICAgIHZhbHVlID0gKDAsIF9tZXRhbC5nZXQpKHZhbHVlc1tjYWNoZVZhbHVlUHJlZml4XSwgcGFydFJlbW92ZWRQcmVmaXgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YWx1ZSA9ICgwLCBfbWV0YWwuZ2V0KSh2YWx1ZXMsIHBhcnQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgc3VmZml4ZXMgKz0gIjo6IiArIHBhcnQgKyAiOiIgKyB2YWx1ZTsKICAgIH0KCiAgICByZXR1cm4gcHJlZml4ICsgc3VmZml4ZXMucmVwbGFjZShBTExfUEVSSU9EU19SRUdFWCwgJy0nKTsKICB9CiAgLyoKICAgIENvbnRyb2xsZXItZGVmaW5lZCBxdWVyeSBwYXJhbWV0ZXJzIGNhbiBjb21lIGluIHRocmVlIHNoYXBlczoKICAKICAgIEFycmF5CiAgICAgIHF1ZXJ5UGFyYW1zOiBbJ2ZvbycsICdiYXInXQogICAgQXJyYXkgb2Ygc2ltcGxlIG9iamVjdHMgd2hlcmUgdmFsdWUgaXMgYW4gYWxpYXMKICAgICAgcXVlcnlQYXJhbXM6IFsKICAgICAgICB7CiAgICAgICAgICAnZm9vJzogJ3JlbmFtZV9mb29fdG9fdGhpcycKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICdiYXInOiAnY2FsbF9iYXJfdGhpc19pbnN0ZWFkJwogICAgICAgIH0KICAgICAgXQogICAgQXJyYXkgb2YgZnVsbHkgZGVmaW5lZCBvYmplY3RzCiAgICAgIHF1ZXJ5UGFyYW1zOiBbCiAgICAgICAgewogICAgICAgICAgJ2Zvbyc6IHsKICAgICAgICAgICAgYXM6ICdyZW5hbWVfZm9vX3RvX3RoaXMnCiAgICAgICAgICB9LAogICAgICAgIH0KICAgICAgICB7CiAgICAgICAgICAnYmFyJzogewogICAgICAgICAgICBhczogJ2NhbGxfYmFyX3RoaXNfaW5zdGVhZCcsCiAgICAgICAgICAgIHNjb3BlOiAnY29udHJvbGxlcicKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIF0KICAKICAgIFRoaXMgaGVscGVyIG5vcm1hbGl6ZXMgYWxsIHRocmVlIHBvc3NpYmxlIHN0eWxlcyBpbnRvIHRoZQogICAgJ0FycmF5IG9mIGZ1bGx5IGRlZmluZWQgb2JqZWN0cycgc3R5bGUuCiAgKi8KCgogIGZ1bmN0aW9uIG5vcm1hbGl6ZUNvbnRyb2xsZXJRdWVyeVBhcmFtcyhxdWVyeVBhcmFtcykgewogICAgdmFyIHFwTWFwID0ge307CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWVyeVBhcmFtcy5sZW5ndGg7ICsraSkgewogICAgICBhY2N1bXVsYXRlUXVlcnlQYXJhbURlc2NyaXB0b3JzKHF1ZXJ5UGFyYW1zW2ldLCBxcE1hcCk7CiAgICB9CgogICAgcmV0dXJuIHFwTWFwOwogIH0KCiAgZnVuY3Rpb24gYWNjdW11bGF0ZVF1ZXJ5UGFyYW1EZXNjcmlwdG9ycyhfZGVzYywgYWNjdW0pIHsKICAgIHZhciBkZXNjID0gX2Rlc2M7CiAgICB2YXIgdG1wOwoKICAgIGlmICh0eXBlb2YgZGVzYyA9PT0gJ3N0cmluZycpIHsKICAgICAgdG1wID0ge307CiAgICAgIHRtcFtkZXNjXSA9IHsKICAgICAgICBhczogbnVsbAogICAgICB9OwogICAgICBkZXNjID0gdG1wOwogICAgfQoKICAgIGZvciAodmFyIGtleSBpbiBkZXNjKSB7CiAgICAgIGlmICghZGVzYy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgc2luZ2xlRGVzYyA9IGRlc2Nba2V5XTsKCiAgICAgIGlmICh0eXBlb2Ygc2luZ2xlRGVzYyA9PT0gJ3N0cmluZycpIHsKICAgICAgICBzaW5nbGVEZXNjID0gewogICAgICAgICAgYXM6IHNpbmdsZURlc2MKICAgICAgICB9OwogICAgICB9CgogICAgICB0bXAgPSBhY2N1bVtrZXldIHx8IHsKICAgICAgICBhczogbnVsbCwKICAgICAgICBzY29wZTogJ21vZGVsJwogICAgICB9OwogICAgICAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHRtcCwgc2luZ2xlRGVzYyk7CiAgICAgIGFjY3VtW2tleV0gPSB0bXA7CiAgICB9CiAgfQogIC8qCiAgICBDaGVjayBpZiBhIHJvdXRlTmFtZSByZXNlbWJsZXMgYSB1cmwgaW5zdGVhZAogIAogICAgQHByaXZhdGUKICAqLwoKCiAgZnVuY3Rpb24gcmVzZW1ibGVzVVJMKHN0cikgewogICAgcmV0dXJuIHR5cGVvZiBzdHIgPT09ICdzdHJpbmcnICYmIChzdHIgPT09ICcnIHx8IHN0clswXSA9PT0gJy8nKTsKICB9CiAgLyoKICAgIFJldHVybnMgYW4gYXJndW1lbnRzIGFycmF5IHdoZXJlIHRoZSByb3V0ZSBuYW1lIGFyZyBpcyBwcmVmaXhlZCBiYXNlZCBvbiB0aGUgbW91bnQgcG9pbnQKICAKICAgIEBwcml2YXRlCiAgKi8KCgogIGZ1bmN0aW9uIHByZWZpeFJvdXRlTmFtZUFyZyhyb3V0ZSwgYXJncykgewogICAgdmFyIHJvdXRlTmFtZSA9IGFyZ3NbMF07CiAgICB2YXIgb3duZXIgPSAoMCwgX293bmVyLmdldE93bmVyKShyb3V0ZSk7CiAgICB2YXIgcHJlZml4ID0gb3duZXIubW91bnRQb2ludDsgLy8gb25seSBhbHRlciB0aGUgcm91dGVOYW1lIGlmIGl0J3MgYWN0dWFsbHkgcmVmZXJlbmNpbmcgYSByb3V0ZS4KCiAgICBpZiAob3duZXIucm91dGFibGUgJiYgdHlwZW9mIHJvdXRlTmFtZSA9PT0gJ3N0cmluZycpIHsKICAgICAgaWYgKHJlc2VtYmxlc1VSTChyb3V0ZU5hbWUpKSB7CiAgICAgICAgdGhyb3cgbmV3IF9lcnJvci5kZWZhdWx0KCdQcm9ncmFtbWF0aWMgdHJhbnNpdGlvbnMgYnkgVVJMIGNhbm5vdCBiZSB1c2VkIHdpdGhpbiBhbiBFbmdpbmUuIFBsZWFzZSB1c2UgdGhlIHJvdXRlIG5hbWUgaW5zdGVhZC4nKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByb3V0ZU5hbWUgPSBwcmVmaXggKyAiLiIgKyByb3V0ZU5hbWU7CiAgICAgICAgYXJnc1swXSA9IHJvdXRlTmFtZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBhcmdzOwogIH0KCiAgZnVuY3Rpb24gc2hhbGxvd0VxdWFsKGEsIGIpIHsKICAgIHZhciBrOwogICAgdmFyIGFDb3VudCA9IDA7CiAgICB2YXIgYkNvdW50ID0gMDsKCiAgICBmb3IgKGsgaW4gYSkgewogICAgICBpZiAoYS5oYXNPd25Qcm9wZXJ0eShrKSkgewogICAgICAgIGlmIChhW2tdICE9PSBiW2tdKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBhQ291bnQrKzsKICAgICAgfQogICAgfQoKICAgIGZvciAoayBpbiBiKSB7CiAgICAgIGlmIChiLmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgYkNvdW50Kys7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYUNvdW50ID09PSBiQ291bnQ7CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2luZGV4IiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL3N5c3RlbS9vYmplY3QiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvbWl4aW5zL3JlZ2lzdHJ5X3Byb3h5IiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL21peGlucy9jb250YWluZXJfcHJveHkiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvY29weSIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9jb21wYXJlIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL2lzLWVxdWFsIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL21peGlucy9hcnJheSIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9taXhpbnMvY29tcGFyYWJsZSIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9zeXN0ZW0vbmFtZXNwYWNlIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL3N5c3RlbS9hcnJheV9wcm94eSIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9zeXN0ZW0vb2JqZWN0X3Byb3h5IiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL3N5c3RlbS9jb3JlX29iamVjdCIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9taXhpbnMvYWN0aW9uX2hhbmRsZXIiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvbWl4aW5zL2NvcHlhYmxlIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL21peGlucy9lbnVtZXJhYmxlIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL21peGlucy8tcHJveHkiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvbWl4aW5zL29ic2VydmFibGUiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvbWl4aW5zL211dGFibGVfZW51bWVyYWJsZSIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9taXhpbnMvdGFyZ2V0X2FjdGlvbl9zdXBwb3J0IiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL21peGlucy9ldmVudGVkIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL21peGlucy9wcm9taXNlX3Byb3h5IiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL2V4dC9yc3ZwIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL3R5cGUtb2YiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvZXh0L2Z1bmN0aW9uIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX29iamVjdCwgX3JlZ2lzdHJ5X3Byb3h5LCBfY29udGFpbmVyX3Byb3h5LCBfY29weSwgX2NvbXBhcmUsIF9pc0VxdWFsLCBfYXJyYXksIF9jb21wYXJhYmxlLCBfbmFtZXNwYWNlLCBfYXJyYXlfcHJveHksIF9vYmplY3RfcHJveHksIF9jb3JlX29iamVjdCwgX2FjdGlvbl9oYW5kbGVyLCBfY29weWFibGUsIF9lbnVtZXJhYmxlLCBfcHJveHksIF9vYnNlcnZhYmxlLCBfbXV0YWJsZV9lbnVtZXJhYmxlLCBfdGFyZ2V0X2FjdGlvbl9zdXBwb3J0LCBfZXZlbnRlZCwgX3Byb21pc2VfcHJveHksIF9yc3ZwLCBfdHlwZU9mLCBfZnVuY3Rpb24pIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIk9iamVjdCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9vYmplY3QuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJGcmFtZXdvcmtPYmplY3QiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfb2JqZWN0LkZyYW1ld29ya09iamVjdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJSZWdpc3RyeVByb3h5TWl4aW4iLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcmVnaXN0cnlfcHJveHkuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJDb250YWluZXJQcm94eU1peGluIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2NvbnRhaW5lcl9wcm94eS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImNvcHkiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfY29weS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImNvbXBhcmUiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfY29tcGFyZS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImlzRXF1YWwiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfaXNFcXVhbC5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIkFycmF5IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2FycmF5LmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiTmF0aXZlQXJyYXkiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfYXJyYXkuTmF0aXZlQXJyYXk7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiQSIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9hcnJheS5BOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIk11dGFibGVBcnJheSIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9hcnJheS5NdXRhYmxlQXJyYXk7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAicmVtb3ZlQXQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfYXJyYXkucmVtb3ZlQXQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAidW5pcUJ5IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2FycmF5LnVuaXFCeTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJpc0FycmF5IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2FycmF5LmlzQXJyYXk7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiQ29tcGFyYWJsZSIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9jb21wYXJhYmxlLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiTmFtZXNwYWNlIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX25hbWVzcGFjZS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIkFycmF5UHJveHkiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfYXJyYXlfcHJveHkuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJPYmplY3RQcm94eSIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9vYmplY3RfcHJveHkuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJDb3JlT2JqZWN0IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2NvcmVfb2JqZWN0LmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAic2V0RnJhbWV3b3JrQ2xhc3MiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfY29yZV9vYmplY3Quc2V0RnJhbWV3b3JrQ2xhc3M7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiQWN0aW9uSGFuZGxlciIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9hY3Rpb25faGFuZGxlci5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIkNvcHlhYmxlIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2NvcHlhYmxlLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiRW51bWVyYWJsZSIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9lbnVtZXJhYmxlLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX1Byb3h5TWl4aW4iLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcHJveHkuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfY29udGVudEZvciIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9wcm94eS5jb250ZW50Rm9yOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIk9ic2VydmFibGUiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfb2JzZXJ2YWJsZS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIk11dGFibGVFbnVtZXJhYmxlIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX211dGFibGVfZW51bWVyYWJsZS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIlRhcmdldEFjdGlvblN1cHBvcnQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfdGFyZ2V0X2FjdGlvbl9zdXBwb3J0LmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiRXZlbnRlZCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9ldmVudGVkLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiUHJvbWlzZVByb3h5TWl4aW4iLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcHJvbWlzZV9wcm94eS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIlJTVlAiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcnN2cC5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIm9uZXJyb3JEZWZhdWx0IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3JzdnAub25lcnJvckRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAidHlwZU9mIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3R5cGVPZi50eXBlT2Y7CiAgICB9CiAgfSk7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL2NvbXBhcmUiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvdHlwZS1vZiIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9taXhpbnMvY29tcGFyYWJsZSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF90eXBlT2YsIF9jb21wYXJhYmxlKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gY29tcGFyZTsKICB2YXIgVFlQRV9PUkRFUiA9IHsKICAgIHVuZGVmaW5lZDogMCwKICAgIG51bGw6IDEsCiAgICBib29sZWFuOiAyLAogICAgbnVtYmVyOiAzLAogICAgc3RyaW5nOiA0LAogICAgYXJyYXk6IDUsCiAgICBvYmplY3Q6IDYsCiAgICBpbnN0YW5jZTogNywKICAgIGZ1bmN0aW9uOiA4LAogICAgY2xhc3M6IDksCiAgICBkYXRlOiAxMAogIH07IC8vCiAgLy8gdGhlIHNwYWNlc2hpcCBvcGVyYXRvcgogIC8vCiAgLy8gICAgICAgICAgICAgICAgICAgICAgYC4gX19fCiAgLy8gICAgICAgICAgICAgICAgICAgICBfXywnIF9fYC4gICAgICAgICAgICAgICAgXy4uLS0tLS4uLi5fX19fCiAgLy8gICAgICAgICBfXy4uLi0tLidgYDsuICAgLC4gICA7YGAtLS4uX18gICAgIC4nICAgICwtLl8gICAgXy4tJwogIC8vICAgXy4uLScnLS0tLS0tLScgICBgJyAgIGAnICAgYCcgICAgIE8gYGAtJycuXyAgICgsOycpIF8sJwogIC8vICwnX19fX19fX19fX19fX19fXyAgICAgICAgICAgICAgICAgICAgICAgICAgXGAtLl9gLScsJwogIC8vICBgLl8gICAgICAgICAgICAgIGBgYGBgYGBgYGBgLS0tLS0tLi4uX19fICAgJy0uLl8nLToKICAvLyAgICAgYGBgLS0uLl8gICAgICAsLiAgICAgICAgICAgICAgICAgICAgIGBgYGAtLS4uLl9fXC0uCiAgLy8gICAgICAgICAgICAgYC4tLS4gYC1gICJJTkZJTklUWSBJUyBMRVNTICAgICBfX19fICAgIHwgIHxgCiAgLy8gICAgICAgICAgICAgICBgLiBgLiAgIFRIQU4gQkVZT05EIiAgICAgICAgLCdgYGBgYC4gIDsgIDtgCiAgLy8gICAgICAgICAgICAgICAgIGAuX2AuICAgICAgICBfX19fX19fX19fICAgYC4gICAgICBcJ19fL2AKICAvLyAgICAgICAgICAgICAgICAgICAgYC06Ll9fX19fL19fX19fXy9fX18vX19fX2AuICAgICBcICBgCiAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgICAgICAgYC5fICAgIGAuICAgIFwKICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYC5fX19fX19fX19gLS4gICBgLiAgIGAuX19fCiAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU1N0ICBgLS0tLS0tJ2AKCiAgZnVuY3Rpb24gc3BhY2VzaGlwKGEsIGIpIHsKICAgIHZhciBkaWZmID0gYSAtIGI7CiAgICByZXR1cm4gKGRpZmYgPiAwKSAtIChkaWZmIDwgMCk7CiAgfQogIC8qKgogICBAbW9kdWxlIEBlbWJlci91dGlscwogICovCgogIC8qKgogICBDb21wYXJlcyB0d28gamF2YXNjcmlwdCB2YWx1ZXMgYW5kIHJldHVybnM6CiAgCiAgICAtIC0xIGlmIHRoZSBmaXJzdCBpcyBzbWFsbGVyIHRoYW4gdGhlIHNlY29uZCwKICAgIC0gMCBpZiBib3RoIGFyZSBlcXVhbCwKICAgIC0gMSBpZiB0aGUgZmlyc3QgaXMgZ3JlYXRlciB0aGFuIHRoZSBzZWNvbmQuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBjb21wYXJlIH0gZnJvbSAnQGVtYmVyL3V0aWxzJzsKICAKICAgIGNvbXBhcmUoJ2hlbGxvJywgJ2hlbGxvJyk7ICAvLyAwCiAgICBjb21wYXJlKCdhYmMnLCAnZGZnJyk7ICAgICAgLy8gLTEKICAgIGNvbXBhcmUoMiwgMSk7ICAgICAgICAgICAgICAvLyAxCiAgICBgYGAKICAKICAgSWYgdGhlIHR5cGVzIG9mIHRoZSB0d28gb2JqZWN0cyBhcmUgZGlmZmVyZW50IHByZWNlZGVuY2Ugb2NjdXJzIGluIHRoZQogICBmb2xsb3dpbmcgb3JkZXIsIHdpdGggdHlwZXMgZWFybGllciBpbiB0aGUgbGlzdCBjb25zaWRlcmVkIGA8YCB0eXBlcwogICBsYXRlciBpbiB0aGUgbGlzdDoKICAKICAgIC0gdW5kZWZpbmVkCiAgICAtIG51bGwKICAgIC0gYm9vbGVhbgogICAgLSBudW1iZXIKICAgIC0gc3RyaW5nCiAgICAtIGFycmF5CiAgICAtIG9iamVjdAogICAgLSBpbnN0YW5jZQogICAgLSBmdW5jdGlvbgogICAgLSBjbGFzcwogICAgLSBkYXRlCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBjb21wYXJlIH0gZnJvbSAnQGVtYmVyL3V0aWxzJzsKICAKICAgIGNvbXBhcmUoJ2hlbGxvJywgNTApOyAgICAgICAvLyAxCiAgICBjb21wYXJlKDUwLCAnaGVsbG8nKTsgICAgICAgLy8gLTEKICAgIGBgYAogIAogICBAbWV0aG9kIGNvbXBhcmUKICAgQGZvciBAZW1iZXIvdXRpbHMKICAgQHN0YXRpYwogICBAcGFyYW0ge09iamVjdH0gdiBGaXJzdCB2YWx1ZSB0byBjb21wYXJlCiAgIEBwYXJhbSB7T2JqZWN0fSB3IFNlY29uZCB2YWx1ZSB0byBjb21wYXJlCiAgIEByZXR1cm4ge051bWJlcn0gLTEgaWYgdiA8IHcsIDAgaWYgdiA9IHcgYW5kIDEgaWYgdiA+IHcuCiAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gY29tcGFyZSh2LCB3KSB7CiAgICBpZiAodiA9PT0gdykgewogICAgICByZXR1cm4gMDsKICAgIH0KCiAgICB2YXIgdHlwZTEgPSAoMCwgX3R5cGVPZi50eXBlT2YpKHYpOwogICAgdmFyIHR5cGUyID0gKDAsIF90eXBlT2YudHlwZU9mKSh3KTsKCiAgICBpZiAodHlwZTEgPT09ICdpbnN0YW5jZScgJiYgX2NvbXBhcmFibGUuZGVmYXVsdC5kZXRlY3QodikgJiYgdi5jb25zdHJ1Y3Rvci5jb21wYXJlKSB7CiAgICAgIHJldHVybiB2LmNvbnN0cnVjdG9yLmNvbXBhcmUodiwgdyk7CiAgICB9CgogICAgaWYgKHR5cGUyID09PSAnaW5zdGFuY2UnICYmIF9jb21wYXJhYmxlLmRlZmF1bHQuZGV0ZWN0KHcpICYmIHcuY29uc3RydWN0b3IuY29tcGFyZSkgewogICAgICByZXR1cm4gdy5jb25zdHJ1Y3Rvci5jb21wYXJlKHcsIHYpICogLTE7CiAgICB9CgogICAgdmFyIHJlcyA9IHNwYWNlc2hpcChUWVBFX09SREVSW3R5cGUxXSwgVFlQRV9PUkRFUlt0eXBlMl0pOwoKICAgIGlmIChyZXMgIT09IDApIHsKICAgICAgcmV0dXJuIHJlczsKICAgIH0gLy8gdHlwZXMgYXJlIGVxdWFsIC0gc28gd2UgaGF2ZSB0byBjaGVjayB2YWx1ZXMgbm93CgoKICAgIHN3aXRjaCAodHlwZTEpIHsKICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgcmV0dXJuIHNwYWNlc2hpcCh2LCB3KTsKCiAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgcmV0dXJuIHNwYWNlc2hpcCh2LmxvY2FsZUNvbXBhcmUodyksIDApOwoKICAgICAgY2FzZSAnYXJyYXknOgogICAgICAgIHsKICAgICAgICAgIHZhciB2TGVuID0gdi5sZW5ndGg7CiAgICAgICAgICB2YXIgd0xlbiA9IHcubGVuZ3RoOwogICAgICAgICAgdmFyIGxlbiA9IE1hdGgubWluKHZMZW4sIHdMZW4pOwoKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgdmFyIHIgPSBjb21wYXJlKHZbaV0sIHdbaV0pOwoKICAgICAgICAgICAgaWYgKHIgIT09IDApIHsKICAgICAgICAgICAgICByZXR1cm4gcjsKICAgICAgICAgICAgfQogICAgICAgICAgfSAvLyBhbGwgZWxlbWVudHMgYXJlIGVxdWFsIG5vdwogICAgICAgICAgLy8gc2hvcnRlciBhcnJheSBzaG91bGQgYmUgb3JkZXJlZCBmaXJzdAoKCiAgICAgICAgICByZXR1cm4gc3BhY2VzaGlwKHZMZW4sIHdMZW4pOwogICAgICAgIH0KCiAgICAgIGNhc2UgJ2luc3RhbmNlJzoKICAgICAgICBpZiAoX2NvbXBhcmFibGUuZGVmYXVsdC5kZXRlY3QodikpIHsKICAgICAgICAgIHJldHVybiB2LmNvbXBhcmUodiwgdyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gMDsKCiAgICAgIGNhc2UgJ2RhdGUnOgogICAgICAgIHJldHVybiBzcGFjZXNoaXAodi5nZXRUaW1lKCksIHcuZ2V0VGltZSgpKTsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIDA7CiAgICB9CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9jb3B5IiwgWyJleHBvcnRzIiwgIkBlbWJlci9kZWJ1ZyIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9zeXN0ZW0vb2JqZWN0IiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL21peGlucy9jb3B5YWJsZSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9kZWJ1ZywgX29iamVjdCwgX2NvcHlhYmxlKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gY29weTsKCiAgLyoqCiAgIEBtb2R1bGUgQGVtYmVyL29iamVjdAogICovCiAgZnVuY3Rpb24gX2NvcHkob2JqLCBkZWVwLCBzZWVuLCBjb3BpZXMpIHsKICAgIC8vIHByaW1pdGl2ZSBkYXRhIHR5cGVzIGFyZSBpbW11dGFibGUsIGp1c3QgcmV0dXJuIHRoZW0uCiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsKSB7CiAgICAgIHJldHVybiBvYmo7CiAgICB9CgogICAgdmFyIHJldCwgbG9jOyAvLyBhdm9pZCBjeWNsaWNhbCBsb29wcwoKICAgIGlmIChkZWVwICYmIChsb2MgPSBzZWVuLmluZGV4T2Yob2JqKSkgPj0gMCkgewogICAgICByZXR1cm4gY29waWVzW2xvY107CiAgICB9CgogICAgaWYgKGRlZXApIHsKICAgICAgc2Vlbi5wdXNoKG9iaik7CiAgICB9IC8vIElNUE9SVEFOVDogdGhpcyBzcGVjaWZpYyB0ZXN0IHdpbGwgZGV0ZWN0IGEgbmF0aXZlIGFycmF5IG9ubHkuIEFueSBvdGhlcgogICAgLy8gb2JqZWN0IHdpbGwgbmVlZCB0byBpbXBsZW1lbnQgQ29weWFibGUuCgoKICAgIGlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKICAgICAgcmV0ID0gb2JqLnNsaWNlKCk7CgogICAgICBpZiAoZGVlcCkgewogICAgICAgIGNvcGllcy5wdXNoKHJldCk7CiAgICAgICAgbG9jID0gcmV0Lmxlbmd0aDsKCiAgICAgICAgd2hpbGUgKC0tbG9jID49IDApIHsKICAgICAgICAgIHJldFtsb2NdID0gX2NvcHkocmV0W2xvY10sIGRlZXAsIHNlZW4sIGNvcGllcyk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKF9jb3B5YWJsZS5kZWZhdWx0LmRldGVjdChvYmopKSB7CiAgICAgIHJldCA9IG9iai5jb3B5KGRlZXAsIHNlZW4sIGNvcGllcyk7CgogICAgICBpZiAoZGVlcCkgewogICAgICAgIGNvcGllcy5wdXNoKHJldCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAob2JqIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICByZXQgPSBuZXcgRGF0ZShvYmouZ2V0VGltZSgpKTsKCiAgICAgIGlmIChkZWVwKSB7CiAgICAgICAgY29waWVzLnB1c2gocmV0KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgKGZhbHNlICYmICEoIShvYmogaW5zdGFuY2VvZiBfb2JqZWN0LmRlZmF1bHQpIHx8IF9jb3B5YWJsZS5kZWZhdWx0LmRldGVjdChvYmopKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0Nhbm5vdCBjbG9uZSBhbiBFbWJlck9iamVjdCB0aGF0IGRvZXMgbm90IGltcGxlbWVudCBDb3B5YWJsZScsICEob2JqIGluc3RhbmNlb2YgX29iamVjdC5kZWZhdWx0KSB8fCBfY29weWFibGUuZGVmYXVsdC5kZXRlY3Qob2JqKSkpOwogICAgICByZXQgPSB7fTsKCiAgICAgIGlmIChkZWVwKSB7CiAgICAgICAgY29waWVzLnB1c2gocmV0KTsKICAgICAgfQoKICAgICAgdmFyIGtleTsKCiAgICAgIGZvciAoa2V5IGluIG9iaikgewogICAgICAgIC8vIHN1cHBvcnQgTnVsbCBwcm90b3R5cGUKICAgICAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0gLy8gUHJldmVudHMgYnJvd3NlcnMgdGhhdCBkb24ndCByZXNwZWN0IG5vbi1lbnVtZXJhYmlsaXR5IGZyb20KICAgICAgICAvLyBjb3B5aW5nIGludGVybmFsIEVtYmVyIHByb3BlcnRpZXMKCgogICAgICAgIGlmIChrZXkuc3Vic3RyaW5nKDAsIDIpID09PSAnX18nKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIHJldFtrZXldID0gZGVlcCA/IF9jb3B5KG9ialtrZXldLCBkZWVwLCBzZWVuLCBjb3BpZXMpIDogb2JqW2tleV07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmV0OwogIH0KICAvKioKICAgIENyZWF0ZXMgYSBzaGFsbG93IGNvcHkgb2YgdGhlIHBhc3NlZCBvYmplY3QuIEEgZGVlcCBjb3B5IG9mIHRoZSBvYmplY3QgaXMKICAgIHJldHVybmVkIGlmIHRoZSBvcHRpb25hbCBgZGVlcGAgYXJndW1lbnQgaXMgYHRydWVgLgogIAogICAgSWYgdGhlIHBhc3NlZCBvYmplY3QgaW1wbGVtZW50cyB0aGUgYENvcHlhYmxlYCBpbnRlcmZhY2UsIHRoZW4gdGhpcwogICAgZnVuY3Rpb24gd2lsbCBkZWxlZ2F0ZSB0byB0aGUgb2JqZWN0J3MgYGNvcHkoKWAgbWV0aG9kIGFuZCByZXR1cm4gdGhlCiAgICByZXN1bHQuIFNlZSBgQ29weWFibGVgIGZvciBmdXJ0aGVyIGRldGFpbHMuCiAgCiAgICBGb3IgcHJpbWl0aXZlIHZhbHVlcyAod2hpY2ggYXJlIGltbXV0YWJsZSBpbiBKYXZhU2NyaXB0KSwgdGhlIHBhc3NlZCBvYmplY3QKICAgIGlzIHNpbXBseSByZXR1cm5lZC4KICAKICAgIEBtZXRob2QgY29weQogICAgQGRlcHJlY2F0ZWQgVXNlICdlbWJlci1jb3B5JyBhZGRvbiBpbnN0ZWFkCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QvaW50ZXJuYWxzCiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gY2xvbmUKICAgIEBwYXJhbSB7Qm9vbGVhbn0gW2RlZXA9ZmFsc2VdIElmIHRydWUsIGEgZGVlcCBjb3B5IG9mIHRoZSBvYmplY3QgaXMgbWFkZS4KICAgIEByZXR1cm4ge09iamVjdH0gVGhlIGNvcGllZCBvYmplY3QKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gY29weShvYmosIGRlZXApIHsKICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoJ1VzZSBlbWJlci1jb3B5IGFkZG9uIGluc3RlYWQgb2YgY29weSBtZXRob2QgYW5kIENvcHlhYmxlIG1peGluLicsIGZhbHNlLCB7CiAgICAgIGlkOiAnZW1iZXItcnVudGltZS5kZXByZWNhdGUtY29weS1jb3B5YWJsZScsCiAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICB1cmw6ICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92My54LyN0b2NfZW1iZXItcnVudGltZS1kZXByZWNhdGUtY29weS1jb3B5YWJsZScKICAgIH0pKTsgLy8gZmFzdCBwYXRocwoKICAgIGlmICgnb2JqZWN0JyAhPT0gdHlwZW9mIG9iaiB8fCBvYmogPT09IG51bGwpIHsKICAgICAgcmV0dXJuIG9iajsgLy8gY2FuJ3QgY29weSBwcmltaXRpdmVzCiAgICB9CgogICAgaWYgKCFBcnJheS5pc0FycmF5KG9iaikgJiYgX2NvcHlhYmxlLmRlZmF1bHQuZGV0ZWN0KG9iaikpIHsKICAgICAgcmV0dXJuIG9iai5jb3B5KGRlZXApOwogICAgfQoKICAgIHJldHVybiBfY29weShvYmosIGRlZXAsIGRlZXAgPyBbXSA6IG51bGwsIGRlZXAgPyBbXSA6IG51bGwpOwogIH0KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvZXh0L2Z1bmN0aW9uIiwgWyJAZW1iZXIvLWludGVybmFscy9lbnZpcm9ubWVudCIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCIsICJAZW1iZXIvZGVidWciLCAiQGVtYmVyL2RlcHJlY2F0ZWQtZmVhdHVyZXMiXSwgZnVuY3Rpb24gKF9lbnZpcm9ubWVudCwgX21ldGFsLCBfZGVidWcsIF9kZXByZWNhdGVkRmVhdHVyZXMpIHsKICAidXNlIHN0cmljdCI7CgogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwogIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLkZVTkNUSU9OX1BST1RPVFlQRV9FWFRFTlNJT05TICYmIF9lbnZpcm9ubWVudC5FTlYuRVhURU5EX1BST1RPVFlQRVMuRnVuY3Rpb24pIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEZ1bmN0aW9uLnByb3RvdHlwZSwgewogICAgICAvKioKICAgICAgICBUaGUgYHByb3BlcnR5YCBleHRlbnNpb24gb2YgSmF2YXNjcmlwdCdzIEZ1bmN0aW9uIHByb3RvdHlwZSBpcyBhdmFpbGFibGUKICAgICAgICB3aGVuIGBFbWJlckVOVi5FWFRFTkRfUFJPVE9UWVBFU2Agb3IgYEVtYmVyRU5WLkVYVEVORF9QUk9UT1RZUEVTLkZ1bmN0aW9uYCBpcwogICAgICAgIGB0cnVlYCwgd2hpY2ggaXMgdGhlIGRlZmF1bHQuCiAgICAgICAgIENvbXB1dGVkIHByb3BlcnRpZXMgYWxsb3cgeW91IHRvIHRyZWF0IGEgZnVuY3Rpb24gbGlrZSBhIHByb3BlcnR5OgogICAgICAgICBgYGBhcHAvdXRpbHMvcHJlc2lkZW50LmpzCiAgICAgICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBFbWJlck9iamVjdC5leHRlbmQoewogICAgICAgICAgZmlyc3ROYW1lOiAnJywKICAgICAgICAgIGxhc3ROYW1lOiAgJycsCiAgICAgICAgICAgZnVsbE5hbWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXQoJ2ZpcnN0TmFtZScpICsgJyAnICsgdGhpcy5nZXQoJ2xhc3ROYW1lJyk7CiAgICAgICAgICB9LnByb3BlcnR5KCkgLy8gQ2FsbCB0aGlzIGZsYWcgdG8gbWFyayB0aGUgZnVuY3Rpb24gYXMgYSBwcm9wZXJ0eQogICAgICAgIH0pOwogICAgICAgIGBgYAogICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgICAgbGV0IHByZXNpZGVudCA9IFByZXNpZGVudC5jcmVhdGUoewogICAgICAgICAgZmlyc3ROYW1lOiAnQmFyYWNrJywKICAgICAgICAgIGxhc3ROYW1lOiAnT2JhbWEnCiAgICAgICAgfSk7CiAgICAgICAgIHByZXNpZGVudC5nZXQoJ2Z1bGxOYW1lJyk7IC8vICdCYXJhY2sgT2JhbWEnCiAgICAgICAgYGBgCiAgICAgICAgIFRyZWF0aW5nIGEgZnVuY3Rpb24gbGlrZSBhIHByb3BlcnR5IGlzIHVzZWZ1bCBiZWNhdXNlIHRoZXkgY2FuIHdvcmsgd2l0aAogICAgICAgIGJpbmRpbmdzLCBqdXN0IGxpa2UgYW55IG90aGVyIHByb3BlcnR5LgogICAgICAgICBNYW55IGNvbXB1dGVkIHByb3BlcnRpZXMgaGF2ZSBkZXBlbmRlbmNpZXMgb24gb3RoZXIgcHJvcGVydGllcy4gRm9yCiAgICAgICAgZXhhbXBsZSwgaW4gdGhlIGFib3ZlIGV4YW1wbGUsIHRoZSBgZnVsbE5hbWVgIHByb3BlcnR5IGRlcGVuZHMgb24KICAgICAgICBgZmlyc3ROYW1lYCBhbmQgYGxhc3ROYW1lYCB0byBkZXRlcm1pbmUgaXRzIHZhbHVlLiBZb3UgY2FuIHRlbGwgRW1iZXIKICAgICAgICBhYm91dCB0aGVzZSBkZXBlbmRlbmNpZXMgbGlrZSB0aGlzOgogICAgICAgICBgYGBhcHAvdXRpbHMvcHJlc2lkZW50LmpzCiAgICAgICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgICBleHBvcnQgZGVmYXVsdCBFbWJlck9iamVjdC5leHRlbmQoewogICAgICAgICAgZmlyc3ROYW1lOiAnJywKICAgICAgICAgIGxhc3ROYW1lOiAgJycsCiAgICAgICAgICAgZnVsbE5hbWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXQoJ2ZpcnN0TmFtZScpICsgJyAnICsgdGhpcy5nZXQoJ2xhc3ROYW1lJyk7CiAgICAgICAgICAgICAvLyBUZWxsIEVtYmVyLmpzIHRoYXQgdGhpcyBjb21wdXRlZCBwcm9wZXJ0eSBkZXBlbmRzIG9uIGZpcnN0TmFtZQogICAgICAgICAgICAvLyBhbmQgbGFzdE5hbWUKICAgICAgICAgIH0ucHJvcGVydHkoJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScpCiAgICAgICAgfSk7CiAgICAgICAgYGBgCiAgICAgICAgIE1ha2Ugc3VyZSB5b3UgbGlzdCB0aGVzZSBkZXBlbmRlbmNpZXMgc28gRW1iZXIga25vd3Mgd2hlbiB0byB1cGRhdGUKICAgICAgICBiaW5kaW5ncyB0aGF0IGNvbm5lY3QgdG8gYSBjb21wdXRlZCBwcm9wZXJ0eS4gQ2hhbmdpbmcgYSBkZXBlbmRlbmN5CiAgICAgICAgd2lsbCBub3QgaW1tZWRpYXRlbHkgdHJpZ2dlciBhbiB1cGRhdGUgb2YgdGhlIGNvbXB1dGVkIHByb3BlcnR5LCBidXQKICAgICAgICB3aWxsIGluc3RlYWQgY2xlYXIgdGhlIGNhY2hlIHNvIHRoYXQgaXQgaXMgdXBkYXRlZCB3aGVuIHRoZSBuZXh0IGBnZXRgCiAgICAgICAgaXMgY2FsbGVkIG9uIHRoZSBwcm9wZXJ0eS4KICAgICAgICAgU2VlIFtDb21wdXRlZFByb3BlcnR5XSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0NvbXB1dGVkUHJvcGVydHkpLCBbQGVtYmVyL29iamVjdC9jb21wdXRlZF0oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9AZW1iZXIlMkZvYmplY3QlMkZjb21wdXRlZCkuCiAgICAgICAgIEBtZXRob2QgcHJvcGVydHkKICAgICAgICBAZm9yIEZ1bmN0aW9uCiAgICAgICAgQHB1YmxpYwogICAgICAqLwogICAgICBwcm9wZXJ0eTogewogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCJGdW5jdGlvbiBwcm90b3R5cGUgZXh0ZW5zaW9ucyBoYXZlIGJlZW4gZGVwcmVjYXRlZCwgcGxlYXNlIG1pZ3JhdGUgZnJvbSBmdW5jdGlvbigpe30ucHJvcGVydHkoJ2JhcicpIHRvIGNvbXB1dGVkKCdiYXInLCBmdW5jdGlvbigpIHt9KS4iLCBmYWxzZSwgewogICAgICAgICAgICBpZDogJ2Z1bmN0aW9uLXByb3RvdHlwZS1leHRlbnNpb25zLnByb3BlcnR5JywKICAgICAgICAgICAgdW50aWw6ICc0LjAuMCcsCiAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vZGVwcmVjYXRpb25zLmVtYmVyanMuY29tL3YzLngjdG9jX2Z1bmN0aW9uLXByb3RvdHlwZS1leHRlbnNpb25zLXByb3BlcnR5JwogICAgICAgICAgfSkpOwogICAgICAgICAgcmV0dXJuIF9tZXRhbC5jb21wdXRlZC5hcHBseSh2b2lkIDAsIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykuY29uY2F0KFt0aGlzXSkpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIFRoZSBgb2JzZXJ2ZXNgIGV4dGVuc2lvbiBvZiBKYXZhc2NyaXB0J3MgRnVuY3Rpb24gcHJvdG90eXBlIGlzIGF2YWlsYWJsZQogICAgICAgIHdoZW4gYEVtYmVyRU5WLkVYVEVORF9QUk9UT1RZUEVTYCBvciBgRW1iZXJFTlYuRVhURU5EX1BST1RPVFlQRVMuRnVuY3Rpb25gIGlzCiAgICAgICAgdHJ1ZSwgd2hpY2ggaXMgdGhlIGRlZmF1bHQuCiAgICAgICAgIFlvdSBjYW4gb2JzZXJ2ZSBwcm9wZXJ0eSBjaGFuZ2VzIHNpbXBseSBieSBhZGRpbmcgdGhlIGBvYnNlcnZlc2AKICAgICAgICBjYWxsIHRvIHRoZSBlbmQgb2YgeW91ciBtZXRob2QgZGVjbGFyYXRpb25zIGluIGNsYXNzZXMgdGhhdCB5b3Ugd3JpdGUuCiAgICAgICAgRm9yIGV4YW1wbGU6CiAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICAgIEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgICB2YWx1ZU9ic2VydmVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gRXhlY3V0ZXMgd2hlbmV2ZXIgdGhlICJ2YWx1ZSIgcHJvcGVydHkgY2hhbmdlcwogICAgICAgICAgfS5vYnNlcnZlcygndmFsdWUnKQogICAgICAgIH0pOwogICAgICAgIGBgYAogICAgICAgICBJbiB0aGUgZnV0dXJlIHRoaXMgbWV0aG9kIG1heSBiZWNvbWUgYXN5bmNocm9ub3VzLgogICAgICAgICBTZWUgYG9ic2VydmVyYC4KICAgICAgICAgQG1ldGhvZCBvYnNlcnZlcwogICAgICAgIEBmb3IgRnVuY3Rpb24KICAgICAgICBAcHVibGljCiAgICAgICovCiAgICAgIG9ic2VydmVzOiB7CiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoIkZ1bmN0aW9uIHByb3RvdHlwZSBleHRlbnNpb25zIGhhdmUgYmVlbiBkZXByZWNhdGVkLCBwbGVhc2UgbWlncmF0ZSBmcm9tIGZ1bmN0aW9uKCl7fS5vYnNlcnZlcygnZm9vJykgdG8gb2JzZXJ2ZXIoJ2ZvbycsIGZ1bmN0aW9uKCkge30pLiIsIGZhbHNlLCB7CiAgICAgICAgICAgIGlkOiAnZnVuY3Rpb24tcHJvdG90eXBlLWV4dGVuc2lvbnMub2JzZXJ2ZXMnLAogICAgICAgICAgICB1bnRpbDogJzQuMC4wJywKICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9kZXByZWNhdGlvbnMuZW1iZXJqcy5jb20vdjMueCN0b2NfZnVuY3Rpb24tcHJvdG90eXBlLWV4dGVuc2lvbnMtb2JzZXJ2ZXMnCiAgICAgICAgICB9KSk7CiAgICAgICAgICByZXR1cm4gX21ldGFsLm9ic2VydmVyLmFwcGx5KHZvaWQgMCwgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKS5jb25jYXQoW3RoaXNdKSk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgVGhlIGBvbmAgZXh0ZW5zaW9uIG9mIEphdmFzY3JpcHQncyBGdW5jdGlvbiBwcm90b3R5cGUgaXMgYXZhaWxhYmxlCiAgICAgICAgd2hlbiBgRW1iZXJFTlYuRVhURU5EX1BST1RPVFlQRVNgIG9yIGBFbWJlckVOVi5FWFRFTkRfUFJPVE9UWVBFUy5GdW5jdGlvbmAgaXMKICAgICAgICB0cnVlLCB3aGljaCBpcyB0aGUgZGVmYXVsdC4KICAgICAgICAgWW91IGNhbiBsaXN0ZW4gZm9yIGV2ZW50cyBzaW1wbHkgYnkgYWRkaW5nIHRoZSBgb25gIGNhbGwgdG8gdGhlIGVuZCBvZgogICAgICAgIHlvdXIgbWV0aG9kIGRlY2xhcmF0aW9ucyBpbiBjbGFzc2VzIG9yIG1peGlucyB0aGF0IHlvdSB3cml0ZS4gRm9yIGV4YW1wbGU6CiAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICBpbXBvcnQgTWl4aW4gZnJvbSAnQGVtYmVyL21peGluJzsKICAgICAgICAgTWl4aW4uY3JlYXRlKHsKICAgICAgICAgIGRvU29tZXRoaW5nV2l0aEVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBFeGVjdXRlcyB3aGVuZXZlciB0aGUgImRpZEluc2VydEVsZW1lbnQiIGV2ZW50IGZpcmVzCiAgICAgICAgICB9Lm9uKCdkaWRJbnNlcnRFbGVtZW50JykKICAgICAgICB9KTsKICAgICAgICBgYGAKICAgICAgICAgU2VlIGBAZW1iZXIvb2JqZWN0L2V2ZW50ZWQvb25gLgogICAgICAgICBAbWV0aG9kIG9uCiAgICAgICAgQGZvciBGdW5jdGlvbgogICAgICAgIEBwdWJsaWMKICAgICAgKi8KICAgICAgb246IHsKICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgiRnVuY3Rpb24gcHJvdG90eXBlIGV4dGVuc2lvbnMgaGF2ZSBiZWVuIGRlcHJlY2F0ZWQsIHBsZWFzZSBtaWdyYXRlIGZyb20gZnVuY3Rpb24oKXt9Lm9uKCdmb28nKSB0byBvbignZm9vJywgZnVuY3Rpb24oKSB7fSkuIiwgZmFsc2UsIHsKICAgICAgICAgICAgaWQ6ICdmdW5jdGlvbi1wcm90b3R5cGUtZXh0ZW5zaW9ucy5vbicsCiAgICAgICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgICAgICB1cmw6ICdodHRwczovL2RlcHJlY2F0aW9ucy5lbWJlcmpzLmNvbS92My54I3RvY19mdW5jdGlvbi1wcm90b3R5cGUtZXh0ZW5zaW9ucy1vbicKICAgICAgICAgIH0pKTsKICAgICAgICAgIHJldHVybiBfbWV0YWwub24uYXBwbHkodm9pZCAwLCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpLmNvbmNhdChbdGhpc10pKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvZXh0L3JzdnAiLCBbImV4cG9ydHMiLCAicnN2cCIsICJAZW1iZXIvcnVubG9vcCIsICJAZW1iZXIvLWludGVybmFscy9lcnJvci1oYW5kbGluZyIsICJAZW1iZXIvZGVidWciXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBSU1ZQLCBfcnVubG9vcCwgX2Vycm9ySGFuZGxpbmcsIF9kZWJ1ZykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMub25lcnJvckRlZmF1bHQgPSBvbmVycm9yRGVmYXVsdDsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwogIFJTVlAuY29uZmlndXJlKCdhc3luYycsIGZ1bmN0aW9uIChjYWxsYmFjaywgcHJvbWlzZSkgewogICAgX3J1bmxvb3AuYmFja2J1cm5lci5zY2hlZHVsZSgnYWN0aW9ucycsIG51bGwsIGNhbGxiYWNrLCBwcm9taXNlKTsKICB9KTsKICBSU1ZQLmNvbmZpZ3VyZSgnYWZ0ZXInLCBmdW5jdGlvbiAoY2IpIHsKICAgIF9ydW5sb29wLmJhY2tidXJuZXIuc2NoZWR1bGUoX3J1bmxvb3AuX3JzdnBFcnJvclF1ZXVlLCBudWxsLCBjYik7CiAgfSk7CiAgUlNWUC5vbignZXJyb3InLCBvbmVycm9yRGVmYXVsdCk7CgogIGZ1bmN0aW9uIG9uZXJyb3JEZWZhdWx0KHJlYXNvbikgewogICAgdmFyIGVycm9yID0gZXJyb3JGb3IocmVhc29uKTsKCiAgICBpZiAoZXJyb3IpIHsKICAgICAgdmFyIG92ZXJyaWRlRGlzcGF0Y2ggPSAoMCwgX2Vycm9ySGFuZGxpbmcuZ2V0RGlzcGF0Y2hPdmVycmlkZSkoKTsKCiAgICAgIGlmIChvdmVycmlkZURpc3BhdGNoKSB7CiAgICAgICAgb3ZlcnJpZGVEaXNwYXRjaChlcnJvcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGVycm9yRm9yKHJlYXNvbikgewogICAgaWYgKCFyZWFzb24pIHJldHVybjsKCiAgICBpZiAocmVhc29uLmVycm9yVGhyb3duKSB7CiAgICAgIHJldHVybiB1bndyYXBFcnJvclRocm93bihyZWFzb24pOwogICAgfQoKICAgIGlmIChyZWFzb24ubmFtZSA9PT0gJ1VucmVjb2duaXplZFVSTEVycm9yJykgewogICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJUaGUgVVJMICciICsgcmVhc29uLm1lc3NhZ2UgKyAiJyBkaWQgbm90IG1hdGNoIGFueSByb3V0ZXMgaW4geW91ciBhcHBsaWNhdGlvbiIsIGZhbHNlKSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAocmVhc29uLm5hbWUgPT09ICdUcmFuc2l0aW9uQWJvcnRlZCcpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHJldHVybiByZWFzb247CiAgfQoKICBmdW5jdGlvbiB1bndyYXBFcnJvclRocm93bihyZWFzb24pIHsKICAgIHZhciBlcnJvciA9IHJlYXNvbi5lcnJvclRocm93bjsKCiAgICBpZiAodHlwZW9mIGVycm9yID09PSAnc3RyaW5nJykgewogICAgICBlcnJvciA9IG5ldyBFcnJvcihlcnJvcik7CiAgICB9CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVycm9yLCAnX19yZWFzb25fd2l0aF9lcnJvcl90aHJvd25fXycsIHsKICAgICAgdmFsdWU6IHJlYXNvbiwKICAgICAgZW51bWVyYWJsZTogZmFsc2UKICAgIH0pOwogICAgcmV0dXJuIGVycm9yOwogIH0KCiAgdmFyIF9kZWZhdWx0ID0gUlNWUDsKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL2lzLWVxdWFsIiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IGlzRXF1YWw7CgogIC8qKgogICBAbW9kdWxlIEBlbWJlci91dGlscwogICovCgogIC8qKgogICAgQ29tcGFyZXMgdHdvIG9iamVjdHMsIHJldHVybmluZyB0cnVlIGlmIHRoZXkgYXJlIGVxdWFsLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgaXNFcXVhbCB9IGZyb20gJ0BlbWJlci91dGlscyc7CiAgCiAgICBpc0VxdWFsKCdoZWxsbycsICdoZWxsbycpOyAgICAgICAgICAgICAgICAgICAvLyB0cnVlCiAgICBpc0VxdWFsKDEsIDIpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmYWxzZQogICAgYGBgCiAgCiAgICBgaXNFcXVhbGAgaXMgYSBtb3JlIHNwZWNpZmljIGNvbXBhcmlzb24gdGhhbiBhIHRyaXBsZSBlcXVhbCBjb21wYXJpc29uLgogICAgSXQgd2lsbCBjYWxsIHRoZSBgaXNFcXVhbGAgaW5zdGFuY2UgbWV0aG9kIG9uIHRoZSBvYmplY3RzIGJlaW5nCiAgICBjb21wYXJlZCwgYWxsb3dpbmcgZmluZXIgY29udHJvbCBvdmVyIHdoZW4gb2JqZWN0cyBzaG91bGQgYmUgY29uc2lkZXJlZAogICAgZXF1YWwgdG8gZWFjaCBvdGhlci4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGlzRXF1YWwgfSBmcm9tICdAZW1iZXIvdXRpbHMnOwogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgbGV0IFBlcnNvbiA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGlzRXF1YWwob3RoZXIpIHsgcmV0dXJuIHRoaXMuc3NuID09IG90aGVyLnNzbjsgfQogICAgfSk7CiAgCiAgICBsZXQgcGVyc29uQSA9IFBlcnNvbi5jcmVhdGUoe25hbWU6ICdNdWhhbW1hZCBBbGknLCBzc246ICcxMjMtNDUtNjc4OSd9KTsKICAgIGxldCBwZXJzb25CID0gUGVyc29uLmNyZWF0ZSh7bmFtZTogJ0Nhc3NpdXMgQ2xheScsIHNzbjogJzEyMy00NS02Nzg5J30pOwogIAogICAgaXNFcXVhbChwZXJzb25BLCBwZXJzb25CKTsgLy8gdHJ1ZQogICAgYGBgCiAgCiAgICBEdWUgdG8gdGhlIGV4cGVuc2Ugb2YgYXJyYXkgY29tcGFyaXNvbnMsIGNvbGxlY3Rpb25zIHdpbGwgbmV2ZXIgYmUgZXF1YWwgdG8KICAgIGVhY2ggb3RoZXIgZXZlbiBpZiBlYWNoIG9mIHRoZWlyIGl0ZW1zIGFyZSBlcXVhbCB0byBlYWNoIG90aGVyLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgaXNFcXVhbCB9IGZyb20gJ0BlbWJlci91dGlscyc7CiAgCiAgICBpc0VxdWFsKFs0LCAyXSwgWzQsIDJdKTsgICAgICAgICAgICAgICAgICAgICAvLyBmYWxzZQogICAgYGBgCiAgCiAgICBAbWV0aG9kIGlzRXF1YWwKICAgIEBmb3IgQGVtYmVyL3V0aWxzCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge09iamVjdH0gYSBmaXJzdCBvYmplY3QgdG8gY29tcGFyZQogICAgQHBhcmFtIHtPYmplY3R9IGIgc2Vjb25kIG9iamVjdCB0byBjb21wYXJlCiAgICBAcmV0dXJuIHtCb29sZWFufQogICAgQHB1YmxpYwogICovCiAgZnVuY3Rpb24gaXNFcXVhbChhLCBiKSB7CiAgICBpZiAoYSAmJiB0eXBlb2YgYS5pc0VxdWFsID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHJldHVybiBhLmlzRXF1YWwoYik7CiAgICB9CgogICAgaWYgKGEgaW5zdGFuY2VvZiBEYXRlICYmIGIgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgIHJldHVybiBhLmdldFRpbWUoKSA9PT0gYi5nZXRUaW1lKCk7CiAgICB9CgogICAgcmV0dXJuIGEgPT09IGI7CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9taXhpbnMvLXByb3h5IiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGEiLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiLCAiQGVtYmVyLy1pbnRlcm5hbHMvdXRpbHMiLCAiQGVtYmVyL2RlYnVnIiwgIkBnbGltbWVyL3JlZmVyZW5jZSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9tZXRhLCBfbWV0YWwsIF91dGlscywgX2RlYnVnLCBfcmVmZXJlbmNlKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5jb250ZW50Rm9yID0gY29udGVudEZvcjsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICB2YXIgX01peGluJGNyZWF0ZTsKCiAgZnVuY3Rpb24gY29udGVudEZvcihwcm94eSwgbSkgewogICAgdmFyIGNvbnRlbnQgPSAoMCwgX21ldGFsLmdldCkocHJveHksICdjb250ZW50Jyk7CiAgICB2YXIgdGFnID0gKG0gPT09IHVuZGVmaW5lZCA/ICgwLCBfbWV0YS5tZXRhKShwcm94eSkgOiBtKS5yZWFkYWJsZVRhZygpOwoKICAgIGlmICh0YWcgIT09IHVuZGVmaW5lZCkgewogICAgICAoMCwgX3JlZmVyZW5jZS51cGRhdGUpKHRhZywgKDAsIF9tZXRhbC50YWdGb3IpKGNvbnRlbnQpKTsKICAgIH0KCiAgICByZXR1cm4gY29udGVudDsKICB9CiAgLyoqCiAgICBgRW1iZXIuUHJveHlNaXhpbmAgZm9yd2FyZHMgYWxsIHByb3BlcnRpZXMgbm90IGRlZmluZWQgYnkgdGhlIHByb3h5IGl0c2VsZgogICAgdG8gYSBwcm94aWVkIGBjb250ZW50YCBvYmplY3QuICBTZWUgT2JqZWN0UHJveHkgZm9yIG1vcmUgZGV0YWlscy4KICAKICAgIEBjbGFzcyBQcm94eU1peGluCiAgICBAbmFtZXNwYWNlIEVtYmVyCiAgICBAcHJpdmF0ZQogICovCgoKICB2YXIgX2RlZmF1bHQgPSBfbWV0YWwuTWl4aW4uY3JlYXRlKChfTWl4aW4kY3JlYXRlID0gewogICAgLyoqCiAgICAgIFRoZSBvYmplY3Qgd2hvc2UgcHJvcGVydGllcyB3aWxsIGJlIGZvcndhcmRlZC4KICAgICAgIEBwcm9wZXJ0eSBjb250ZW50CiAgICAgIEB0eXBlIHt1bmtub3dufQogICAgICBAZGVmYXVsdCBudWxsCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBjb250ZW50OiBudWxsLAogICAgaW5pdDogZnVuY3Rpb24gaW5pdCgpIHsKICAgICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICgwLCBfdXRpbHMuc2V0UHJveHkpKHRoaXMpOwogICAgICB2YXIgbSA9ICgwLCBfbWV0YS5tZXRhKSh0aGlzKTsKICAgICAgbS53cml0YWJsZVRhZygpOwogICAgfSwKICAgIHdpbGxEZXN0cm95OiBmdW5jdGlvbiB3aWxsRGVzdHJveSgpIHsKICAgICAgdGhpcy5zZXQoJ2NvbnRlbnQnLCBudWxsKTsKCiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgaXNUcnV0aHk6ICgwLCBfbWV0YWwuY29tcHV0ZWQpKCdjb250ZW50JywgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gQm9vbGVhbigoMCwgX21ldGFsLmdldCkodGhpcywgJ2NvbnRlbnQnKSk7CiAgICB9KSwKICAgIHdpbGxXYXRjaFByb3BlcnR5OiBmdW5jdGlvbiB3aWxsV2F0Y2hQcm9wZXJ0eShrZXkpIHsKICAgICAgaWYgKCF0cnVlCiAgICAgIC8qIEVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyAqLwogICAgICApIHsKICAgICAgICAgIHZhciBjb250ZW50S2V5ID0gImNvbnRlbnQuIiArIGtleTsKICAgICAgICAgICgwLCBfbWV0YWwuYWRkT2JzZXJ2ZXIpKHRoaXMsIGNvbnRlbnRLZXksIG51bGwsICdfY29udGVudFByb3BlcnR5RGlkQ2hhbmdlJyk7CiAgICAgICAgfQogICAgfSwKICAgIGRpZFVud2F0Y2hQcm9wZXJ0eTogZnVuY3Rpb24gZGlkVW53YXRjaFByb3BlcnR5KGtleSkgewogICAgICBpZiAoIXRydWUKICAgICAgLyogRU1CRVJfTUVUQUxfVFJBQ0tFRF9QUk9QRVJUSUVTICovCiAgICAgICkgewogICAgICAgICAgdmFyIGNvbnRlbnRLZXkgPSAiY29udGVudC4iICsga2V5OwogICAgICAgICAgKDAsIF9tZXRhbC5yZW1vdmVPYnNlcnZlcikodGhpcywgY29udGVudEtleSwgbnVsbCwgJ19jb250ZW50UHJvcGVydHlEaWRDaGFuZ2UnKTsKICAgICAgICB9CiAgICB9LAogICAgX2NvbnRlbnRQcm9wZXJ0eURpZENoYW5nZTogZnVuY3Rpb24gX2NvbnRlbnRQcm9wZXJ0eURpZENoYW5nZShjb250ZW50LCBjb250ZW50S2V5KSB7CiAgICAgIHZhciBrZXkgPSBjb250ZW50S2V5LnNsaWNlKDgpOyAvLyByZW1vdmUgImNvbnRlbnQuIgoKICAgICAgaWYgKGtleSBpbiB0aGlzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vIGlmIHNoYWRvd2VkIGluIHByb3h5CgoKICAgICAgKDAsIF9tZXRhbC5ub3RpZnlQcm9wZXJ0eUNoYW5nZSkodGhpcywga2V5KTsKICAgIH0KICB9LCBfTWl4aW4kY3JlYXRlW19tZXRhbC5VTktOT1dOX1BST1BFUlRZX1RBR10gPSBmdW5jdGlvbiAoa2V5KSB7CiAgICByZXR1cm4gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoKDAsIF9tZXRhbC5nZXRDaGFpblRhZ3NGb3JLZXkpKHRoaXMsICJjb250ZW50LiIgKyBrZXkpKTsKICB9LCBfTWl4aW4kY3JlYXRlLnVua25vd25Qcm9wZXJ0eSA9IGZ1bmN0aW9uIHVua25vd25Qcm9wZXJ0eShrZXkpIHsKICAgIHZhciBjb250ZW50ID0gY29udGVudEZvcih0aGlzKTsKCiAgICBpZiAoY29udGVudCkgewogICAgICByZXR1cm4gKDAsIF9tZXRhbC5nZXQpKGNvbnRlbnQsIGtleSk7CiAgICB9CiAgfSwgX01peGluJGNyZWF0ZS5zZXRVbmtub3duUHJvcGVydHkgPSBmdW5jdGlvbiBzZXRVbmtub3duUHJvcGVydHkoa2V5LCB2YWx1ZSkgewogICAgdmFyIG0gPSAoMCwgX21ldGEubWV0YSkodGhpcyk7CgogICAgaWYgKG0uaXNJbml0aWFsaXppbmcoKSB8fCBtLmlzUHJvdG90eXBlTWV0YSh0aGlzKSkgewogICAgICAvLyBpZiBtYXJrZWQgYXMgcHJvdG90eXBlIG9yIG9iamVjdCBpcyBpbml0aWFsaXppbmcgdGhlbiBqdXN0CiAgICAgIC8vIGRlZmluZVByb3BlcnR5IHJhdGhlciB0aGFuIGRlbGVnYXRlCiAgICAgICgwLCBfbWV0YWwuZGVmaW5lUHJvcGVydHkpKHRoaXMsIGtleSwgbnVsbCwgdmFsdWUpOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgdmFyIGNvbnRlbnQgPSBjb250ZW50Rm9yKHRoaXMsIG0pOwogICAgKGZhbHNlICYmICEoY29udGVudCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJDYW5ub3QgZGVsZWdhdGUgc2V0KCciICsga2V5ICsgIicsICIgKyB2YWx1ZSArICIpIHRvIHRoZSAnY29udGVudCcgcHJvcGVydHkgb2Ygb2JqZWN0IHByb3h5ICIgKyB0aGlzICsgIjogaXRzICdjb250ZW50JyBpcyB1bmRlZmluZWQuIiwgY29udGVudCkpOwogICAgcmV0dXJuICgwLCBfbWV0YWwuc2V0KShjb250ZW50LCBrZXksIHZhbHVlKTsKICB9LCBfTWl4aW4kY3JlYXRlKSk7CgogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvbWl4aW5zL2FjdGlvbl9oYW5kbGVyIiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGFsIiwgIkBlbWJlci9kZWJ1ZyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9tZXRhbCwgX2RlYnVnKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICBgRW1iZXIuQWN0aW9uSGFuZGxlcmAgaXMgYXZhaWxhYmxlIG9uIHNvbWUgZmFtaWxpYXIgY2xhc3NlcyBpbmNsdWRpbmcKICAgIGBSb3V0ZWAsIGBDb21wb25lbnRgLCBhbmQgYENvbnRyb2xsZXJgLgogICAgKEludGVybmFsbHkgdGhlIG1peGluIGlzIHVzZWQgYnkgYEVtYmVyLkNvcmVWaWV3YCwgYEVtYmVyLkNvbnRyb2xsZXJNaXhpbmAsCiAgICBhbmQgYFJvdXRlYCBhbmQgYXZhaWxhYmxlIHRvIHRoZSBhYm92ZSBjbGFzc2VzIHRocm91Z2gKICAgIGluaGVyaXRhbmNlLikKICAKICAgIEBjbGFzcyBBY3Rpb25IYW5kbGVyCiAgICBAbmFtZXNwYWNlIEVtYmVyCiAgICBAcHJpdmF0ZQogICovCiAgdmFyIEFjdGlvbkhhbmRsZXIgPSBfbWV0YWwuTWl4aW4uY3JlYXRlKHsKICAgIG1lcmdlZFByb3BlcnRpZXM6IFsnYWN0aW9ucyddLAoKICAgIC8qKgogICAgICBUaGUgY29sbGVjdGlvbiBvZiBmdW5jdGlvbnMsIGtleWVkIGJ5IG5hbWUsIGF2YWlsYWJsZSBvbiB0aGlzCiAgICAgIGBBY3Rpb25IYW5kbGVyYCBhcyBhY3Rpb24gdGFyZ2V0cy4KICAgICAgIFRoZXNlIGZ1bmN0aW9ucyB3aWxsIGJlIGludm9rZWQgd2hlbiBhIG1hdGNoaW5nIGB7e2FjdGlvbn19YCBpcyB0cmlnZ2VyZWQKICAgICAgZnJvbSB3aXRoaW4gYSB0ZW1wbGF0ZSBhbmQgdGhlIGFwcGxpY2F0aW9uJ3MgY3VycmVudCByb3V0ZSBpcyB0aGlzIHJvdXRlLgogICAgICAgQWN0aW9ucyBjYW4gYWxzbyBiZSBpbnZva2VkIGZyb20gb3RoZXIgcGFydHMgb2YgeW91ciBhcHBsaWNhdGlvbgogICAgICB2aWEgYEFjdGlvbkhhbmRsZXIjc2VuZGAuCiAgICAgICBUaGUgYGFjdGlvbnNgIGhhc2ggd2lsbCBpbmhlcml0IGFjdGlvbiBoYW5kbGVycyBmcm9tCiAgICAgIHRoZSBgYWN0aW9uc2AgaGFzaCBkZWZpbmVkIG9uIGV4dGVuZGVkIHBhcmVudCBjbGFzc2VzCiAgICAgIG9yIG1peGlucyByYXRoZXIgdGhhbiBqdXN0IHJlcGxhY2UgdGhlIGVudGlyZSBoYXNoLCBlLmcuOgogICAgICAgYGBgYXBwL21peGlucy9jYW4tZGlzcGxheS1iYW5uZXIuanMKICAgICAgaW1wb3J0IE1peGluIGZyb20gJ0BlbWJlci9taXhpbic7CiAgICAgICBleHBvcnQgZGVmYXVsdCBNaXhpbi5jcmVhdGUoewogICAgICAgIGFjdGlvbnM6IHsKICAgICAgICAgIGRpc3BsYXlCYW5uZXIobXNnKSB7CiAgICAgICAgICAgIC8vIC4uLgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgYGBgYXBwL3JvdXRlcy93ZWxjb21lLmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgIGltcG9ydCBDYW5EaXNwbGF5QmFubmVyIGZyb20gJy4uL21peGlucy9jYW4tZGlzcGxheS1iYW5uZXInOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKENhbkRpc3BsYXlCYW5uZXIsIHsKICAgICAgICBhY3Rpb25zOiB7CiAgICAgICAgICBwbGF5TXVzaWMoKSB7CiAgICAgICAgICAgIC8vIC4uLgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgICAvLyBgV2VsY29tZVJvdXRlYCwgd2hlbiBhY3RpdmUsIHdpbGwgYmUgYWJsZSB0byByZXNwb25kCiAgICAgIC8vIHRvIGJvdGggYWN0aW9ucywgc2luY2UgdGhlIGFjdGlvbnMgaGFzaCBpcyBtZXJnZWQgcmF0aGVyCiAgICAgIC8vIHRoZW4gcmVwbGFjZWQgd2hlbiBleHRlbmRpbmcgbWl4aW5zIC8gcGFyZW50IGNsYXNzZXMuCiAgICAgIHRoaXMuc2VuZCgnZGlzcGxheUJhbm5lcicpOwogICAgICB0aGlzLnNlbmQoJ3BsYXlNdXNpYycpOwogICAgICBgYGAKICAgICAgIFdpdGhpbiBhIENvbnRyb2xsZXIsIFJvdXRlIG9yIENvbXBvbmVudCdzIGFjdGlvbiBoYW5kbGVyLAogICAgICB0aGUgdmFsdWUgb2YgdGhlIGB0aGlzYCBjb250ZXh0IGlzIHRoZSBDb250cm9sbGVyLCBSb3V0ZSBvcgogICAgICBDb21wb25lbnQgb2JqZWN0OgogICAgICAgYGBgYXBwL3JvdXRlcy9zb25nLmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoewogICAgICAgIGFjdGlvbnM6IHsKICAgICAgICAgIG15QWN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXJGb3IoInNvbmciKTsKICAgICAgICAgICAgdGhpcy50cmFuc2l0aW9uVG8oIm90aGVyLnJvdXRlIik7CiAgICAgICAgICAgIC4uLgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgSXQgaXMgYWxzbyBwb3NzaWJsZSB0byBjYWxsIGB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpYCBmcm9tIHdpdGhpbiBhbgogICAgICBhY3Rpb24gaGFuZGxlciBpZiBpdCBvdmVycmlkZXMgYSBoYW5kbGVyIGRlZmluZWQgb24gYSBwYXJlbnQKICAgICAgY2xhc3Mgb3IgbWl4aW46CiAgICAgICBUYWtlIGZvciBleGFtcGxlIHRoZSBmb2xsb3dpbmcgcm91dGVzOgogICAgICAgYGBgYXBwL21peGlucy9kZWJ1Zy1yb3V0ZS5qcwogICAgICBpbXBvcnQgTWl4aW4gZnJvbSAnQGVtYmVyL21peGluJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IE1peGluLmNyZWF0ZSh7CiAgICAgICAgYWN0aW9uczogewogICAgICAgICAgZGVidWdSb3V0ZUluZm9ybWF0aW9uKCkgewogICAgICAgICAgICBjb25zb2xlLmRlYnVnKCJJdCdzIGEtbWUsIGNvbnNvbGUuZGVidWchIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBgYGBhcHAvcm91dGVzL2Fubm95aW5nLWRlYnVnLmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgIGltcG9ydCBEZWJ1Z1JvdXRlIGZyb20gJy4uL21peGlucy9kZWJ1Zy1yb3V0ZSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoRGVidWdSb3V0ZSwgewogICAgICAgIGFjdGlvbnM6IHsKICAgICAgICAgIGRlYnVnUm91dGVJbmZvcm1hdGlvbigpIHsKICAgICAgICAgICAgLy8gYWxzbyBjYWxsIHRoZSBkZWJ1Z1JvdXRlSW5mb3JtYXRpb24gb2YgbWl4ZWQgaW4gRGVidWdSb3V0ZQogICAgICAgICAgICB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpOwogICAgICAgICAgICAgLy8gc2hvdyBhZGRpdGlvbmFsIGFubm95YW5jZQogICAgICAgICAgICB3aW5kb3cuYWxlcnQoLi4uKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgICMjIEJ1YmJsaW5nCiAgICAgICBCeSBkZWZhdWx0LCBhbiBhY3Rpb24gd2lsbCBzdG9wIGJ1YmJsaW5nIG9uY2UgYSBoYW5kbGVyIGRlZmluZWQKICAgICAgb24gdGhlIGBhY3Rpb25zYCBoYXNoIGhhbmRsZXMgaXQuIFRvIGNvbnRpbnVlIGJ1YmJsaW5nIHRoZSBhY3Rpb24sCiAgICAgIHlvdSBtdXN0IHJldHVybiBgdHJ1ZWAgZnJvbSB0aGUgaGFuZGxlcjoKICAgICAgIGBgYGFwcC9yb3V0ZXIuanMKICAgICAgUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJvdXRlKCJhbGJ1bSIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5yb3V0ZSgic29uZyIpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBgYGBhcHAvcm91dGVzL2FsYnVtLmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoewogICAgICAgIGFjdGlvbnM6IHsKICAgICAgICAgIHN0YXJ0UGxheWluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBgYGBhcHAvcm91dGVzL2FsYnVtLXNvbmcuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgICAgYWN0aW9uczogewogICAgICAgICAgc3RhcnRQbGF5aW5nKCkgewogICAgICAgICAgICAvLyAuLi4KICAgICAgICAgICAgIGlmIChhY3Rpb25TaG91bGRBbHNvQmVUcmlnZ2VyZWRPblBhcmVudFJvdXRlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBwcm9wZXJ0eSBhY3Rpb25zCiAgICAgIEB0eXBlIE9iamVjdAogICAgICBAZGVmYXVsdCBudWxsCiAgICAgIEBwdWJsaWMKICAgICovCgogICAgLyoqCiAgICAgIFRyaWdnZXJzIGEgbmFtZWQgYWN0aW9uIG9uIHRoZSBgQWN0aW9uSGFuZGxlcmAuIEFueSBwYXJhbWV0ZXJzCiAgICAgIHN1cHBsaWVkIGFmdGVyIHRoZSBgYWN0aW9uTmFtZWAgc3RyaW5nIHdpbGwgYmUgcGFzc2VkIGFzIGFyZ3VtZW50cwogICAgICB0byB0aGUgYWN0aW9uIHRhcmdldCBmdW5jdGlvbi4KICAgICAgIElmIHRoZSBgQWN0aW9uSGFuZGxlcmAgaGFzIGl0cyBgdGFyZ2V0YCBwcm9wZXJ0eSBzZXQsIGFjdGlvbnMgbWF5CiAgICAgIGJ1YmJsZSB0byB0aGUgYHRhcmdldGAuIEJ1YmJsaW5nIGhhcHBlbnMgd2hlbiBhbiBgYWN0aW9uTmFtZWAgY2FuCiAgICAgIG5vdCBiZSBmb3VuZCBpbiB0aGUgYEFjdGlvbkhhbmRsZXJgJ3MgYGFjdGlvbnNgIGhhc2ggb3IgaWYgdGhlCiAgICAgIGFjdGlvbiB0YXJnZXQgZnVuY3Rpb24gcmV0dXJucyBgdHJ1ZWAuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBhcHAvcm91dGVzL3dlbGNvbWUuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgICAgYWN0aW9uczogewogICAgICAgICAgcGxheVRoZW1lKCkgewogICAgICAgICAgICB0aGlzLnNlbmQoJ3BsYXlNdXNpYycsICd0aGVtZS5tcDMnKTsKICAgICAgICAgIH0sCiAgICAgICAgICBwbGF5TXVzaWModHJhY2spIHsKICAgICAgICAgICAgLy8gLi4uCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHNlbmQKICAgICAgQHBhcmFtIHtTdHJpbmd9IGFjdGlvbk5hbWUgVGhlIGFjdGlvbiB0byB0cmlnZ2VyCiAgICAgIEBwYXJhbSB7Kn0gY29udGV4dCBhIGNvbnRleHQgdG8gc2VuZCB3aXRoIHRoZSBhY3Rpb24KICAgICAgQHB1YmxpYwogICAgKi8KICAgIHNlbmQ6IGZ1bmN0aW9uIHNlbmQoYWN0aW9uTmFtZSkgewogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuID4gMSA/IF9sZW4gLSAxIDogMCksIF9rZXkgPSAxOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIChmYWxzZSAmJiAhKCF0aGlzLmlzRGVzdHJveWluZyAmJiAhdGhpcy5pc0Rlc3Ryb3llZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJBdHRlbXB0ZWQgdG8gY2FsbCAuc2VuZCgpIHdpdGggdGhlIGFjdGlvbiAnIiArIGFjdGlvbk5hbWUgKyAiJyBvbiB0aGUgZGVzdHJveWVkIG9iamVjdCAnIiArIHRoaXMgKyAiJy4iLCAhdGhpcy5pc0Rlc3Ryb3lpbmcgJiYgIXRoaXMuaXNEZXN0cm95ZWQpKTsKCiAgICAgIGlmICh0aGlzLmFjdGlvbnMgJiYgdGhpcy5hY3Rpb25zW2FjdGlvbk5hbWVdKSB7CiAgICAgICAgdmFyIHNob3VsZEJ1YmJsZSA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXS5hcHBseSh0aGlzLCBhcmdzKSA9PT0gdHJ1ZTsKCiAgICAgICAgaWYgKCFzaG91bGRCdWJibGUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciB0YXJnZXQgPSAoMCwgX21ldGFsLmdldCkodGhpcywgJ3RhcmdldCcpOwoKICAgICAgaWYgKHRhcmdldCkgewogICAgICAgIChmYWxzZSAmJiAhKHR5cGVvZiB0YXJnZXQuc2VuZCA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJUaGUgYHRhcmdldGAgZm9yICIgKyB0aGlzICsgIiAoIiArIHRhcmdldCArICIpIGRvZXMgbm90IGhhdmUgYSBgc2VuZGAgbWV0aG9kIiwgdHlwZW9mIHRhcmdldC5zZW5kID09PSAnZnVuY3Rpb24nKSk7CiAgICAgICAgdGFyZ2V0LnNlbmQuYXBwbHkodGFyZ2V0LCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9CiAgfSk7CgogIHZhciBfZGVmYXVsdCA9IEFjdGlvbkhhbmRsZXI7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9taXhpbnMvYXJyYXkiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiLCAiQGVtYmVyLy1pbnRlcm5hbHMvdXRpbHMiLCAiQGVtYmVyL2RlYnVnIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL21peGlucy9lbnVtZXJhYmxlIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL2NvbXBhcmUiLCAiQGVtYmVyLy1pbnRlcm5hbHMvZW52aXJvbm1lbnQiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvbWl4aW5zL29ic2VydmFibGUiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvbWl4aW5zL211dGFibGVfZW51bWVyYWJsZSIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi90eXBlLW9mIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX21ldGFsLCBfdXRpbHMsIF9kZWJ1ZywgX2VudW1lcmFibGUsIF9jb21wYXJlLCBfZW52aXJvbm1lbnQsIF9vYnNlcnZhYmxlLCBfbXV0YWJsZV9lbnVtZXJhYmxlLCBfdHlwZU9mKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy51bmlxQnkgPSBfdW5pcUJ5OwogIF9leHBvcnRzLnJlbW92ZUF0ID0gX3JlbW92ZUF0OwogIF9leHBvcnRzLmlzQXJyYXkgPSBpc0FycmF5OwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZXhwb3J0cy5NdXRhYmxlQXJyYXkgPSBfZXhwb3J0cy5OYXRpdmVBcnJheSA9IF9leHBvcnRzLkEgPSB2b2lkIDA7CgogIHZhciBfTWl4aW4kY3JlYXRlLCBfTmF0aXZlQXJyYXk7CgogIHZhciBFTVBUWV9BUlJBWSA9IE9iamVjdC5mcmVlemUoW10pOwoKICB2YXIgaWRlbnRpdHlGdW5jdGlvbiA9IGZ1bmN0aW9uIGlkZW50aXR5RnVuY3Rpb24oaXRlbSkgewogICAgcmV0dXJuIGl0ZW07CiAgfTsKCiAgZnVuY3Rpb24gX3VuaXFCeShhcnJheSwga2V5KSB7CiAgICBpZiAoa2V5ID09PSB2b2lkIDApIHsKICAgICAga2V5ID0gaWRlbnRpdHlGdW5jdGlvbjsKICAgIH0KCiAgICAoZmFsc2UgJiYgIShpc0FycmF5KGFycmF5KSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJmaXJzdCBhcmd1bWVudCBwYXNzZWQgdG8gYHVuaXFCeWAgc2hvdWxkIGJlIGFycmF5IiwgaXNBcnJheShhcnJheSkpKTsKCiAgICB2YXIgcmV0ID0gX0EyKCk7CgogICAgdmFyIHNlZW4gPSBuZXcgU2V0KCk7CiAgICB2YXIgZ2V0dGVyID0gdHlwZW9mIGtleSA9PT0gJ2Z1bmN0aW9uJyA/IGtleSA6IGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHJldHVybiAoMCwgX21ldGFsLmdldCkoaXRlbSwga2V5KTsKICAgIH07CiAgICBhcnJheS5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHZhciB2YWwgPSBnZXR0ZXIoaXRlbSk7CgogICAgICBpZiAoIXNlZW4uaGFzKHZhbCkpIHsKICAgICAgICBzZWVuLmFkZCh2YWwpOwogICAgICAgIHJldC5wdXNoKGl0ZW0pOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXQ7CiAgfQoKICBmdW5jdGlvbiBpdGVyKGtleSwgdmFsdWUpIHsKICAgIHZhciB2YWx1ZVByb3ZpZGVkID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMjsKICAgIHJldHVybiB2YWx1ZVByb3ZpZGVkID8gZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSAoMCwgX21ldGFsLmdldCkoaXRlbSwga2V5KTsKICAgIH0gOiBmdW5jdGlvbiAoaXRlbSkgewogICAgICByZXR1cm4gQm9vbGVhbigoMCwgX21ldGFsLmdldCkoaXRlbSwga2V5KSk7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZmluZEluZGV4KGFycmF5LCBwcmVkaWNhdGUsIHN0YXJ0QXQpIHsKICAgIHZhciBsZW4gPSBhcnJheS5sZW5ndGg7CgogICAgZm9yICh2YXIgaW5kZXggPSBzdGFydEF0OyBpbmRleCA8IGxlbjsgaW5kZXgrKykgewogICAgICB2YXIgaXRlbSA9ICgwLCBfbWV0YWwub2JqZWN0QXQpKGFycmF5LCBpbmRleCk7CgogICAgICBpZiAocHJlZGljYXRlKGl0ZW0sIGluZGV4LCBhcnJheSkpIHsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gLTE7CiAgfQoKICBmdW5jdGlvbiBfZmluZChhcnJheSwgY2FsbGJhY2ssIHRhcmdldCkgewogICAgdmFyIHByZWRpY2F0ZSA9IGNhbGxiYWNrLmJpbmQodGFyZ2V0KTsKICAgIHZhciBpbmRleCA9IGZpbmRJbmRleChhcnJheSwgcHJlZGljYXRlLCAwKTsKICAgIHJldHVybiBpbmRleCA9PT0gLTEgPyB1bmRlZmluZWQgOiAoMCwgX21ldGFsLm9iamVjdEF0KShhcnJheSwgaW5kZXgpOwogIH0KCiAgZnVuY3Rpb24gX2FueShhcnJheSwgY2FsbGJhY2ssIHRhcmdldCkgewogICAgdmFyIHByZWRpY2F0ZSA9IGNhbGxiYWNrLmJpbmQodGFyZ2V0KTsKICAgIHJldHVybiBmaW5kSW5kZXgoYXJyYXksIHByZWRpY2F0ZSwgMCkgIT09IC0xOwogIH0KCiAgZnVuY3Rpb24gX2V2ZXJ5KGFycmF5LCBjYWxsYmFjaywgdGFyZ2V0KSB7CiAgICB2YXIgY2IgPSBjYWxsYmFjay5iaW5kKHRhcmdldCk7CgogICAgdmFyIHByZWRpY2F0ZSA9IGZ1bmN0aW9uIHByZWRpY2F0ZShpdGVtLCBpbmRleCwgYXJyYXkpIHsKICAgICAgcmV0dXJuICFjYihpdGVtLCBpbmRleCwgYXJyYXkpOwogICAgfTsKCiAgICByZXR1cm4gZmluZEluZGV4KGFycmF5LCBwcmVkaWNhdGUsIDApID09PSAtMTsKICB9CgogIGZ1bmN0aW9uIF9pbmRleE9mKGFycmF5LCB2YWwsIHN0YXJ0QXQsIHdpdGhOYU5DaGVjaykgewogICAgaWYgKHN0YXJ0QXQgPT09IHZvaWQgMCkgewogICAgICBzdGFydEF0ID0gMDsKICAgIH0KCiAgICB2YXIgbGVuID0gYXJyYXkubGVuZ3RoOwoKICAgIGlmIChzdGFydEF0IDwgMCkgewogICAgICBzdGFydEF0ICs9IGxlbjsKICAgIH0gLy8gU2FtZVZhbHVlWmVybyBjb21wYXJpc29uIChOYU4gIT09IE5hTikKCgogICAgdmFyIHByZWRpY2F0ZSA9IHdpdGhOYU5DaGVjayAmJiB2YWwgIT09IHZhbCA/IGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHJldHVybiBpdGVtICE9PSBpdGVtOwogICAgfSA6IGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHJldHVybiBpdGVtID09PSB2YWw7CiAgICB9OwogICAgcmV0dXJuIGZpbmRJbmRleChhcnJheSwgcHJlZGljYXRlLCBzdGFydEF0KTsKICB9CgogIGZ1bmN0aW9uIF9yZW1vdmVBdChhcnJheSwgaW5kZXgsIGxlbikgewogICAgaWYgKGxlbiA9PT0gdm9pZCAwKSB7CiAgICAgIGxlbiA9IDE7CiAgICB9CgogICAgKGZhbHNlICYmICEoaW5kZXggPiAtMSAmJiBpbmRleCA8IGFycmF5Lmxlbmd0aCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJgcmVtb3ZlQXRgIGluZGV4IHByb3ZpZGVkIGlzIG91dCBvZiByYW5nZSIsIGluZGV4ID4gLTEgJiYgaW5kZXggPCBhcnJheS5sZW5ndGgpKTsKICAgICgwLCBfbWV0YWwucmVwbGFjZSkoYXJyYXksIGluZGV4LCBsZW4sIEVNUFRZX0FSUkFZKTsKICAgIHJldHVybiBhcnJheTsKICB9CgogIGZ1bmN0aW9uIF9pbnNlcnRBdChhcnJheSwgaW5kZXgsIGl0ZW0pIHsKICAgIChmYWxzZSAmJiAhKGluZGV4ID4gLTEgJiYgaW5kZXggPD0gYXJyYXkubGVuZ3RoKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoImBpbnNlcnRBdGAgaW5kZXggcHJvdmlkZWQgaXMgb3V0IG9mIHJhbmdlIiwgaW5kZXggPiAtMSAmJiBpbmRleCA8PSBhcnJheS5sZW5ndGgpKTsKICAgICgwLCBfbWV0YWwucmVwbGFjZSkoYXJyYXksIGluZGV4LCAwLCBbaXRlbV0pOwogICAgcmV0dXJuIGl0ZW07CiAgfQogIC8qKgogICAgUmV0dXJucyB0cnVlIGlmIHRoZSBwYXNzZWQgb2JqZWN0IGlzIGFuIGFycmF5IG9yIEFycmF5LWxpa2UuCiAgCiAgICBPYmplY3RzIGFyZSBjb25zaWRlcmVkIEFycmF5LWxpa2UgaWYgYW55IG9mIHRoZSBmb2xsb3dpbmcgYXJlIHRydWU6CiAgCiAgICAgIC0gdGhlIG9iamVjdCBpcyBhIG5hdGl2ZSBBcnJheQogICAgICAtIHRoZSBvYmplY3QgaGFzIGFuIG9iamVjdEF0IHByb3BlcnR5CiAgICAgIC0gdGhlIG9iamVjdCBpcyBhbiBPYmplY3QsIGFuZCBoYXMgYSBsZW5ndGggcHJvcGVydHkKICAKICAgIFVubGlrZSBgdHlwZU9mYCB0aGlzIG1ldGhvZCByZXR1cm5zIHRydWUgZXZlbiBpZiB0aGUgcGFzc2VkIG9iamVjdCBpcwogICAgbm90IGZvcm1hbGx5IGFuIGFycmF5IGJ1dCBhcHBlYXJzIHRvIGJlIGFycmF5LWxpa2UgKGkuZS4gaW1wbGVtZW50cyBgQXJyYXlgKQogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgaXNBcnJheSB9IGZyb20gJ0BlbWJlci9hcnJheSc7CiAgICBpbXBvcnQgQXJyYXlQcm94eSBmcm9tICdAZW1iZXIvYXJyYXkvcHJveHknOwogIAogICAgaXNBcnJheSgpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmFsc2UKICAgIGlzQXJyYXkoW10pOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRydWUKICAgIGlzQXJyYXkoQXJyYXlQcm94eS5jcmVhdGUoeyBjb250ZW50OiBbXSB9KSk7ICAgIC8vIHRydWUKICAgIGBgYAogIAogICAgQG1ldGhvZCBpc0FycmF5CiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9hcnJheQogICAgQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHRvIHRlc3QKICAgIEByZXR1cm4ge0Jvb2xlYW59IHRydWUgaWYgdGhlIHBhc3NlZCBvYmplY3QgaXMgYW4gYXJyYXkgb3IgQXJyYXktbGlrZQogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBpc0FycmF5KF9vYmopIHsKICAgIHZhciBvYmogPSBfb2JqOwoKICAgIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICYmIF91dGlscy5IQVNfTkFUSVZFX1BST1hZICYmIHR5cGVvZiBfb2JqID09PSAnb2JqZWN0JyAmJiBfb2JqICE9PSBudWxsKSB7CiAgICAgIHZhciBwb3NzaWJsZVByb3h5Q29udGVudCA9IF9vYmpbX21ldGFsLlBST1hZX0NPTlRFTlRdOwoKICAgICAgaWYgKHBvc3NpYmxlUHJveHlDb250ZW50ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBvYmogPSBwb3NzaWJsZVByb3h5Q29udGVudDsKICAgICAgfQogICAgfQoKICAgIGlmICghb2JqIHx8IG9iai5zZXRJbnRlcnZhbCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYgKEFycmF5LmlzQXJyYXkob2JqKSB8fCBBcnJheU1peGluLmRldGVjdChvYmopKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHZhciB0eXBlID0gKDAsIF90eXBlT2YudHlwZU9mKShvYmopOwoKICAgIGlmICgnYXJyYXknID09PSB0eXBlKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHZhciBsZW5ndGggPSBvYmoubGVuZ3RoOwoKICAgIGlmICh0eXBlb2YgbGVuZ3RoID09PSAnbnVtYmVyJyAmJiBsZW5ndGggPT09IGxlbmd0aCAmJiAnb2JqZWN0JyA9PT0gdHlwZSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICByZXR1cm4gZmFsc2U7CiAgfQogIC8qCiAgICBUaGlzIGFsbG93cyB1cyB0byBkZWZpbmUgY29tcHV0ZWQgcHJvcGVydGllcyB0aGF0IGFyZSBub3QgZW51bWVyYWJsZS4KICAgIFRoZSBwcmltYXJ5IHJlYXNvbiB0aGlzIGlzIGltcG9ydGFudCBpcyB0aGF0IHdoZW4gYE5hdGl2ZUFycmF5YCBpcwogICAgYXBwbGllZCB0byBgQXJyYXkucHJvdG90eXBlYCB3ZSBuZWVkIHRvIGVuc3VyZSB0aGF0IHdlIGRvIG5vdCBhZGQgX2FueV8KICAgIG5ldyBlbnVtZXJhYmxlIHByb3BlcnRpZXMuCiAgKi8KCgogIGZ1bmN0aW9uIG5vbkVudW1lcmFibGVDb21wdXRlZCgpIHsKICAgIHZhciBwcm9wZXJ0eSA9IF9tZXRhbC5jb21wdXRlZC5hcHBseSh2b2lkIDAsIGFyZ3VtZW50cyk7CgogICAgcHJvcGVydHkuZW51bWVyYWJsZSA9IGZhbHNlOwogICAgcmV0dXJuIHByb3BlcnR5OwogIH0KCiAgZnVuY3Rpb24gbWFwQnkoa2V5KSB7CiAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24gKG5leHQpIHsKICAgICAgcmV0dXJuICgwLCBfbWV0YWwuZ2V0KShuZXh0LCBrZXkpOwogICAgfSk7CiAgfSAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgLy8gQVJSQVkKICAvLwoKICAvKioKICAgIFRoaXMgbWl4aW4gaW1wbGVtZW50cyBPYnNlcnZlci1mcmllbmRseSBBcnJheS1saWtlIGJlaGF2aW9yLiBJdCBpcyBub3QgYQogICAgY29uY3JldGUgaW1wbGVtZW50YXRpb24sIGJ1dCBpdCBjYW4gYmUgdXNlZCB1cCBieSBvdGhlciBjbGFzc2VzIHRoYXQgd2FudAogICAgdG8gYXBwZWFyIGxpa2UgYXJyYXlzLgogIAogICAgRm9yIGV4YW1wbGUsIEFycmF5UHJveHkgaXMgYSBjb25jcmV0ZSBjbGFzcyB0aGF0IGNhbiBiZSBpbnN0YW50aWF0ZWQgdG8KICAgIGltcGxlbWVudCBhcnJheS1saWtlIGJlaGF2aW9yLiBUaGlzIGNsYXNzIHVzZXMgdGhlIEFycmF5IE1peGluIGJ5IHdheSBvZgogICAgdGhlIE11dGFibGVBcnJheSBtaXhpbiwgd2hpY2ggYWxsb3dzIG9ic2VydmFibGUgY2hhbmdlcyB0byBiZSBtYWRlIHRvIHRoZQogICAgdW5kZXJseWluZyBhcnJheS4KICAKICAgIFRoaXMgbWl4aW4gZGVmaW5lcyBtZXRob2RzIHNwZWNpZmljYWxseSBmb3IgY29sbGVjdGlvbnMgdGhhdCBwcm92aWRlCiAgICBpbmRleC1vcmRlcmVkIGFjY2VzcyB0byB0aGVpciBjb250ZW50cy4gV2hlbiB5b3UgYXJlIGRlc2lnbmluZyBjb2RlIHRoYXQKICAgIG5lZWRzIHRvIGFjY2VwdCBhbnkga2luZCBvZiBBcnJheS1saWtlIG9iamVjdCwgeW91IHNob3VsZCB1c2UgdGhlc2UgbWV0aG9kcwogICAgaW5zdGVhZCBvZiBBcnJheSBwcmltaXRpdmVzIGJlY2F1c2UgdGhlc2Ugd2lsbCBwcm9wZXJseSBub3RpZnkgb2JzZXJ2ZXJzIG9mCiAgICBjaGFuZ2VzIHRvIHRoZSBhcnJheS4KICAKICAgIEFsdGhvdWdoIHRoZXNlIG1ldGhvZHMgYXJlIGVmZmljaWVudCwgdGhleSBkbyBhZGQgYSBsYXllciBvZiBpbmRpcmVjdGlvbiB0bwogICAgeW91ciBhcHBsaWNhdGlvbiBzbyBpdCBpcyBhIGdvb2QgaWRlYSB0byB1c2UgdGhlbSBvbmx5IHdoZW4geW91IG5lZWQgdGhlCiAgICBmbGV4aWJpbGl0eSBvZiB1c2luZyBib3RoIHRydWUgSmF2YVNjcmlwdCBhcnJheXMgYW5kICJ2aXJ0dWFsIiBhcnJheXMgc3VjaAogICAgYXMgY29udHJvbGxlcnMgYW5kIGNvbGxlY3Rpb25zLgogIAogICAgWW91IGNhbiB1c2UgdGhlIG1ldGhvZHMgZGVmaW5lZCBpbiB0aGlzIG1vZHVsZSB0byBhY2Nlc3MgYW5kIG1vZGlmeSBhcnJheQogICAgY29udGVudHMgaW4gYW4gb2JzZXJ2YWJsZS1mcmllbmRseSB3YXkuIFlvdSBjYW4gYWxzbyBiZSBub3RpZmllZCB3aGVuZXZlcgogICAgdGhlIG1lbWJlcnNoaXAgb2YgYW4gYXJyYXkgY2hhbmdlcyBieSB1c2luZyBgLm9ic2VydmVzKCdteUFycmF5LltdJylgLgogIAogICAgVG8gc3VwcG9ydCBgRW1iZXJBcnJheWAgaW4geW91ciBvd24gY2xhc3MsIHlvdSBtdXN0IG92ZXJyaWRlIHR3bwogICAgcHJpbWl0aXZlcyB0byB1c2UgaXQ6IGBsZW5ndGgoKWAgYW5kIGBvYmplY3RBdCgpYC4KICAKICAgIEBjbGFzcyBFbWJlckFycmF5CiAgICBAdXNlcyBFbnVtZXJhYmxlCiAgICBAc2luY2UgRW1iZXIgMC45LjAKICAgIEBwdWJsaWMKICAqLwoKCiAgdmFyIEFycmF5TWl4aW4gPSBfbWV0YWwuTWl4aW4uY3JlYXRlKF9lbnVtZXJhYmxlLmRlZmF1bHQsIChfTWl4aW4kY3JlYXRlID0ge30sIF9NaXhpbiRjcmVhdGVbX3V0aWxzLkVNQkVSX0FSUkFZXSA9IHRydWUsIF9NaXhpbiRjcmVhdGUub2JqZWN0c0F0ID0gZnVuY3Rpb24gb2JqZWN0c0F0KGluZGV4ZXMpIHsKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgcmV0dXJuIGluZGV4ZXMubWFwKGZ1bmN0aW9uIChpZHgpIHsKICAgICAgcmV0dXJuICgwLCBfbWV0YWwub2JqZWN0QXQpKF90aGlzLCBpZHgpOwogICAgfSk7CiAgfSwgX01peGluJGNyZWF0ZVsnW10nXSA9IG5vbkVudW1lcmFibGVDb21wdXRlZCh7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiBzZXQoa2V5LCB2YWx1ZSkgewogICAgICB0aGlzLnJlcGxhY2UoMCwgdGhpcy5sZW5ndGgsIHZhbHVlKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfSksIF9NaXhpbiRjcmVhdGUuZmlyc3RPYmplY3QgPSBub25FbnVtZXJhYmxlQ29tcHV0ZWQoZnVuY3Rpb24gKCkgewogICAgcmV0dXJuICgwLCBfbWV0YWwub2JqZWN0QXQpKHRoaXMsIDApOwogIH0pLnJlYWRPbmx5KCksIF9NaXhpbiRjcmVhdGUubGFzdE9iamVjdCA9IG5vbkVudW1lcmFibGVDb21wdXRlZChmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gKDAsIF9tZXRhbC5vYmplY3RBdCkodGhpcywgdGhpcy5sZW5ndGggLSAxKTsKICB9KS5yZWFkT25seSgpLCBfTWl4aW4kY3JlYXRlLnNsaWNlID0gZnVuY3Rpb24gc2xpY2UoYmVnaW5JbmRleCwgZW5kSW5kZXgpIHsKICAgIGlmIChiZWdpbkluZGV4ID09PSB2b2lkIDApIHsKICAgICAgYmVnaW5JbmRleCA9IDA7CiAgICB9CgogICAgdmFyIHJldCA9IF9BMigpOwoKICAgIHZhciBsZW5ndGggPSB0aGlzLmxlbmd0aDsKCiAgICBpZiAoYmVnaW5JbmRleCA8IDApIHsKICAgICAgYmVnaW5JbmRleCA9IGxlbmd0aCArIGJlZ2luSW5kZXg7CiAgICB9CgogICAgaWYgKGVuZEluZGV4ID09PSB1bmRlZmluZWQgfHwgZW5kSW5kZXggPiBsZW5ndGgpIHsKICAgICAgZW5kSW5kZXggPSBsZW5ndGg7CiAgICB9IGVsc2UgaWYgKGVuZEluZGV4IDwgMCkgewogICAgICBlbmRJbmRleCA9IGxlbmd0aCArIGVuZEluZGV4OwogICAgfQoKICAgIHdoaWxlIChiZWdpbkluZGV4IDwgZW5kSW5kZXgpIHsKICAgICAgcmV0W3JldC5sZW5ndGhdID0gKDAsIF9tZXRhbC5vYmplY3RBdCkodGhpcywgYmVnaW5JbmRleCsrKTsKICAgIH0KCiAgICByZXR1cm4gcmV0OwogIH0sIF9NaXhpbiRjcmVhdGUuaW5kZXhPZiA9IGZ1bmN0aW9uIGluZGV4T2Yob2JqZWN0LCBzdGFydEF0KSB7CiAgICByZXR1cm4gX2luZGV4T2YodGhpcywgb2JqZWN0LCBzdGFydEF0LCBmYWxzZSk7CiAgfSwgX01peGluJGNyZWF0ZS5sYXN0SW5kZXhPZiA9IGZ1bmN0aW9uIGxhc3RJbmRleE9mKG9iamVjdCwgc3RhcnRBdCkgewogICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwoKICAgIGlmIChzdGFydEF0ID09PSB1bmRlZmluZWQgfHwgc3RhcnRBdCA+PSBsZW4pIHsKICAgICAgc3RhcnRBdCA9IGxlbiAtIDE7CiAgICB9CgogICAgaWYgKHN0YXJ0QXQgPCAwKSB7CiAgICAgIHN0YXJ0QXQgKz0gbGVuOwogICAgfQoKICAgIGZvciAodmFyIGlkeCA9IHN0YXJ0QXQ7IGlkeCA+PSAwOyBpZHgtLSkgewogICAgICBpZiAoKDAsIF9tZXRhbC5vYmplY3RBdCkodGhpcywgaWR4KSA9PT0gb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGlkeDsKICAgICAgfQogICAgfQoKICAgIHJldHVybiAtMTsKICB9LCBfTWl4aW4kY3JlYXRlLmFkZEFycmF5T2JzZXJ2ZXIgPSBmdW5jdGlvbiBhZGRBcnJheU9ic2VydmVyKHRhcmdldCwgb3B0cykgewogICAgcmV0dXJuICgwLCBfbWV0YWwuYWRkQXJyYXlPYnNlcnZlcikodGhpcywgdGFyZ2V0LCBvcHRzKTsKICB9LCBfTWl4aW4kY3JlYXRlLnJlbW92ZUFycmF5T2JzZXJ2ZXIgPSBmdW5jdGlvbiByZW1vdmVBcnJheU9ic2VydmVyKHRhcmdldCwgb3B0cykgewogICAgcmV0dXJuICgwLCBfbWV0YWwucmVtb3ZlQXJyYXlPYnNlcnZlcikodGhpcywgdGFyZ2V0LCBvcHRzKTsKICB9LCBfTWl4aW4kY3JlYXRlLmhhc0FycmF5T2JzZXJ2ZXJzID0gbm9uRW51bWVyYWJsZUNvbXB1dGVkKGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiAoMCwgX21ldGFsLmhhc0xpc3RlbmVycykodGhpcywgJ0BhcnJheTpjaGFuZ2UnKSB8fCAoMCwgX21ldGFsLmhhc0xpc3RlbmVycykodGhpcywgJ0BhcnJheTpiZWZvcmUnKTsKICB9KSwgX01peGluJGNyZWF0ZS5hcnJheUNvbnRlbnRXaWxsQ2hhbmdlID0gZnVuY3Rpb24gYXJyYXlDb250ZW50V2lsbENoYW5nZShzdGFydElkeCwgcmVtb3ZlQW10LCBhZGRBbXQpIHsKICAgIHJldHVybiAoMCwgX21ldGFsLmFycmF5Q29udGVudFdpbGxDaGFuZ2UpKHRoaXMsIHN0YXJ0SWR4LCByZW1vdmVBbXQsIGFkZEFtdCk7CiAgfSwgX01peGluJGNyZWF0ZS5hcnJheUNvbnRlbnREaWRDaGFuZ2UgPSBmdW5jdGlvbiBhcnJheUNvbnRlbnREaWRDaGFuZ2Uoc3RhcnRJZHgsIHJlbW92ZUFtdCwgYWRkQW10KSB7CiAgICByZXR1cm4gKDAsIF9tZXRhbC5hcnJheUNvbnRlbnREaWRDaGFuZ2UpKHRoaXMsIHN0YXJ0SWR4LCByZW1vdmVBbXQsIGFkZEFtdCk7CiAgfSwgX01peGluJGNyZWF0ZS5mb3JFYWNoID0gZnVuY3Rpb24gZm9yRWFjaChjYWxsYmFjaywgdGFyZ2V0KSB7CiAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgdGFyZ2V0ID0gbnVsbDsKICAgIH0KCiAgICAoZmFsc2UgJiYgISh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnYGZvckVhY2hgIGV4cGVjdHMgYSBmdW5jdGlvbiBhcyBmaXJzdCBhcmd1bWVudC4nLCB0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpKTsKICAgIHZhciBsZW5ndGggPSB0aGlzLmxlbmd0aDsKCiAgICBmb3IgKHZhciBpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIHZhciBpdGVtID0gdGhpcy5vYmplY3RBdChpbmRleCk7CiAgICAgIGNhbGxiYWNrLmNhbGwodGFyZ2V0LCBpdGVtLCBpbmRleCwgdGhpcyk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfSwgX01peGluJGNyZWF0ZS5nZXRFYWNoID0gbWFwQnksIF9NaXhpbiRjcmVhdGUuc2V0RWFjaCA9IGZ1bmN0aW9uIHNldEVhY2goa2V5LCB2YWx1ZSkgewogICAgcmV0dXJuIHRoaXMuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgICByZXR1cm4gKDAsIF9tZXRhbC5zZXQpKGl0ZW0sIGtleSwgdmFsdWUpOwogICAgfSk7CiAgfSwgX01peGluJGNyZWF0ZS5tYXAgPSBmdW5jdGlvbiBtYXAoY2FsbGJhY2ssIHRhcmdldCkgewogICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgIHRhcmdldCA9IG51bGw7CiAgICB9CgogICAgKGZhbHNlICYmICEodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2BtYXBgIGV4cGVjdHMgYSBmdW5jdGlvbiBhcyBmaXJzdCBhcmd1bWVudC4nLCB0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpKTsKCiAgICB2YXIgcmV0ID0gX0EyKCk7CgogICAgdGhpcy5mb3JFYWNoKGZ1bmN0aW9uICh4LCBpZHgsIGkpIHsKICAgICAgcmV0dXJuIHJldFtpZHhdID0gY2FsbGJhY2suY2FsbCh0YXJnZXQsIHgsIGlkeCwgaSk7CiAgICB9KTsKICAgIHJldHVybiByZXQ7CiAgfSwgX01peGluJGNyZWF0ZS5tYXBCeSA9IG1hcEJ5LCBfTWl4aW4kY3JlYXRlLmZpbHRlciA9IGZ1bmN0aW9uIGZpbHRlcihjYWxsYmFjaywgdGFyZ2V0KSB7CiAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgdGFyZ2V0ID0gbnVsbDsKICAgIH0KCiAgICAoZmFsc2UgJiYgISh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnYGZpbHRlcmAgZXhwZWN0cyBhIGZ1bmN0aW9uIGFzIGZpcnN0IGFyZ3VtZW50LicsIHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykpOwoKICAgIHZhciByZXQgPSBfQTIoKTsKCiAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24gKHgsIGlkeCwgaSkgewogICAgICBpZiAoY2FsbGJhY2suY2FsbCh0YXJnZXQsIHgsIGlkeCwgaSkpIHsKICAgICAgICByZXQucHVzaCh4KTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmV0OwogIH0sIF9NaXhpbiRjcmVhdGUucmVqZWN0ID0gZnVuY3Rpb24gcmVqZWN0KGNhbGxiYWNrLCB0YXJnZXQpIHsKICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICB0YXJnZXQgPSBudWxsOwogICAgfQoKICAgIChmYWxzZSAmJiAhKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdgcmVqZWN0YCBleHBlY3RzIGEgZnVuY3Rpb24gYXMgZmlyc3QgYXJndW1lbnQuJywgdHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSk7CiAgICByZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gIWNhbGxiYWNrLmFwcGx5KHRhcmdldCwgYXJndW1lbnRzKTsKICAgIH0pOwogIH0sIF9NaXhpbiRjcmVhdGUuZmlsdGVyQnkgPSBmdW5jdGlvbiBmaWx0ZXJCeSgpIHsKICAgIHJldHVybiB0aGlzLmZpbHRlcihpdGVyLmFwcGx5KHZvaWQgMCwgYXJndW1lbnRzKSk7CiAgfSwgX01peGluJGNyZWF0ZS5yZWplY3RCeSA9IGZ1bmN0aW9uIHJlamVjdEJ5KCkgewogICAgcmV0dXJuIHRoaXMucmVqZWN0KGl0ZXIuYXBwbHkodm9pZCAwLCBhcmd1bWVudHMpKTsKICB9LCBfTWl4aW4kY3JlYXRlLmZpbmQgPSBmdW5jdGlvbiBmaW5kKGNhbGxiYWNrLCB0YXJnZXQpIHsKICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICB0YXJnZXQgPSBudWxsOwogICAgfQoKICAgIChmYWxzZSAmJiAhKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdgZmluZGAgZXhwZWN0cyBhIGZ1bmN0aW9uIGFzIGZpcnN0IGFyZ3VtZW50LicsIHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykpOwogICAgcmV0dXJuIF9maW5kKHRoaXMsIGNhbGxiYWNrLCB0YXJnZXQpOwogIH0sIF9NaXhpbiRjcmVhdGUuZmluZEJ5ID0gZnVuY3Rpb24gZmluZEJ5KCkgewogICAgcmV0dXJuIF9maW5kKHRoaXMsIGl0ZXIuYXBwbHkodm9pZCAwLCBhcmd1bWVudHMpKTsKICB9LCBfTWl4aW4kY3JlYXRlLmV2ZXJ5ID0gZnVuY3Rpb24gZXZlcnkoY2FsbGJhY2ssIHRhcmdldCkgewogICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgIHRhcmdldCA9IG51bGw7CiAgICB9CgogICAgKGZhbHNlICYmICEodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2BldmVyeWAgZXhwZWN0cyBhIGZ1bmN0aW9uIGFzIGZpcnN0IGFyZ3VtZW50LicsIHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykpOwogICAgcmV0dXJuIF9ldmVyeSh0aGlzLCBjYWxsYmFjaywgdGFyZ2V0KTsKICB9LCBfTWl4aW4kY3JlYXRlLmlzRXZlcnkgPSBmdW5jdGlvbiBpc0V2ZXJ5KCkgewogICAgcmV0dXJuIF9ldmVyeSh0aGlzLCBpdGVyLmFwcGx5KHZvaWQgMCwgYXJndW1lbnRzKSk7CiAgfSwgX01peGluJGNyZWF0ZS5hbnkgPSBmdW5jdGlvbiBhbnkoY2FsbGJhY2ssIHRhcmdldCkgewogICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgIHRhcmdldCA9IG51bGw7CiAgICB9CgogICAgKGZhbHNlICYmICEodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2BhbnlgIGV4cGVjdHMgYSBmdW5jdGlvbiBhcyBmaXJzdCBhcmd1bWVudC4nLCB0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpKTsKICAgIHJldHVybiBfYW55KHRoaXMsIGNhbGxiYWNrLCB0YXJnZXQpOwogIH0sIF9NaXhpbiRjcmVhdGUuaXNBbnkgPSBmdW5jdGlvbiBpc0FueSgpIHsKICAgIHJldHVybiBfYW55KHRoaXMsIGl0ZXIuYXBwbHkodm9pZCAwLCBhcmd1bWVudHMpKTsKICB9LCBfTWl4aW4kY3JlYXRlLnJlZHVjZSA9IGZ1bmN0aW9uIHJlZHVjZShjYWxsYmFjaywgaW5pdGlhbFZhbHVlKSB7CiAgICAoZmFsc2UgJiYgISh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnYHJlZHVjZWAgZXhwZWN0cyBhIGZ1bmN0aW9uIGFzIGZpcnN0IGFyZ3VtZW50LicsIHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykpOwogICAgdmFyIHJldCA9IGluaXRpYWxWYWx1ZTsKICAgIHRoaXMuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSwgaSkgewogICAgICByZXQgPSBjYWxsYmFjayhyZXQsIGl0ZW0sIGksIHRoaXMpOwogICAgfSwgdGhpcyk7CiAgICByZXR1cm4gcmV0OwogIH0sIF9NaXhpbiRjcmVhdGUuaW52b2tlID0gZnVuY3Rpb24gaW52b2tlKG1ldGhvZE5hbWUpIHsKICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICB9CgogICAgdmFyIHJldCA9IF9BMigpOwoKICAgIHRoaXMuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgICByZXR1cm4gcmV0LnB1c2goKDAsIF91dGlscy50cnlJbnZva2UpKGl0ZW0sIG1ldGhvZE5hbWUsIGFyZ3MpKTsKICAgIH0pOwogICAgcmV0dXJuIHJldDsKICB9LCBfTWl4aW4kY3JlYXRlLnRvQXJyYXkgPSBmdW5jdGlvbiB0b0FycmF5KCkgewogICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHJldHVybiBpdGVtOwogICAgfSk7CiAgfSwgX01peGluJGNyZWF0ZS5jb21wYWN0ID0gZnVuY3Rpb24gY29tcGFjdCgpIHsKICAgIHJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlICE9IG51bGw7CiAgICB9KTsKICB9LCBfTWl4aW4kY3JlYXRlLmluY2x1ZGVzID0gZnVuY3Rpb24gaW5jbHVkZXMob2JqZWN0LCBzdGFydEF0KSB7CiAgICByZXR1cm4gX2luZGV4T2YodGhpcywgb2JqZWN0LCBzdGFydEF0LCB0cnVlKSAhPT0gLTE7CiAgfSwgX01peGluJGNyZWF0ZS5zb3J0QnkgPSBmdW5jdGlvbiBzb3J0QnkoKSB7CiAgICB2YXIgc29ydEtleXMgPSBhcmd1bWVudHM7CiAgICByZXR1cm4gdGhpcy50b0FycmF5KCkuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNvcnRLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGtleSA9IHNvcnRLZXlzW2ldOwogICAgICAgIHZhciBwcm9wQSA9ICgwLCBfbWV0YWwuZ2V0KShhLCBrZXkpOwogICAgICAgIHZhciBwcm9wQiA9ICgwLCBfbWV0YWwuZ2V0KShiLCBrZXkpOyAvLyByZXR1cm4gMSBvciAtMSBlbHNlIGNvbnRpbnVlIHRvIHRoZSBuZXh0IHNvcnRLZXkKCiAgICAgICAgdmFyIGNvbXBhcmVWYWx1ZSA9ICgwLCBfY29tcGFyZS5kZWZhdWx0KShwcm9wQSwgcHJvcEIpOwoKICAgICAgICBpZiAoY29tcGFyZVZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gY29tcGFyZVZhbHVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIDA7CiAgICB9KTsKICB9LCBfTWl4aW4kY3JlYXRlLnVuaXEgPSBmdW5jdGlvbiB1bmlxKCkgewogICAgcmV0dXJuIF91bmlxQnkodGhpcyk7CiAgfSwgX01peGluJGNyZWF0ZS51bmlxQnkgPSBmdW5jdGlvbiB1bmlxQnkoa2V5KSB7CiAgICByZXR1cm4gX3VuaXFCeSh0aGlzLCBrZXkpOwogIH0sIF9NaXhpbiRjcmVhdGUud2l0aG91dCA9IGZ1bmN0aW9uIHdpdGhvdXQodmFsdWUpIHsKICAgIGlmICghdGhpcy5pbmNsdWRlcyh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIHRoaXM7IC8vIG5vdGhpbmcgdG8gZG8KICAgIH0gLy8gU2FtZVZhbHVlWmVybyBjb21wYXJpc29uIChOYU4gIT09IE5hTikKCgogICAgdmFyIHByZWRpY2F0ZSA9IHZhbHVlID09PSB2YWx1ZSA/IGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHJldHVybiBpdGVtICE9PSB2YWx1ZTsKICAgIH0gOiBmdW5jdGlvbiAoaXRlbSkgewogICAgICByZXR1cm4gaXRlbSA9PT0gaXRlbTsKICAgIH07CiAgICByZXR1cm4gdGhpcy5maWx0ZXIocHJlZGljYXRlKTsKICB9LCBfTWl4aW4kY3JlYXRlKSk7CiAgLyoqCiAgICBUaGlzIG1peGluIGRlZmluZXMgdGhlIEFQSSBmb3IgbW9kaWZ5aW5nIGFycmF5LWxpa2Ugb2JqZWN0cy4gVGhlc2UgbWV0aG9kcwogICAgY2FuIGJlIGFwcGxpZWQgb25seSB0byBhIGNvbGxlY3Rpb24gdGhhdCBrZWVwcyBpdHMgaXRlbXMgaW4gYW4gb3JkZXJlZCBzZXQuCiAgICBJdCBidWlsZHMgdXBvbiB0aGUgQXJyYXkgbWl4aW4gYW5kIGFkZHMgbWV0aG9kcyB0byBtb2RpZnkgdGhlIGFycmF5LgogICAgT25lIGNvbmNyZXRlIGltcGxlbWVudGF0aW9ucyBvZiB0aGlzIGNsYXNzIGluY2x1ZGUgQXJyYXlQcm94eS4KICAKICAgIEl0IGlzIGltcG9ydGFudCB0byB1c2UgdGhlIG1ldGhvZHMgaW4gdGhpcyBjbGFzcyB0byBtb2RpZnkgYXJyYXlzIHNvIHRoYXQKICAgIGNoYW5nZXMgYXJlIG9ic2VydmFibGUuIFRoaXMgYWxsb3dzIHRoZSBiaW5kaW5nIHN5c3RlbSBpbiBFbWJlciB0byBmdW5jdGlvbgogICAgY29ycmVjdGx5LgogIAogIAogICAgTm90ZSB0aGF0IGFuIEFycmF5IGNhbiBjaGFuZ2UgZXZlbiBpZiBpdCBkb2VzIG5vdCBpbXBsZW1lbnQgdGhpcyBtaXhpbi4KICAgIEZvciBleGFtcGxlLCBvbmUgbWlnaHQgaW1wbGVtZW50IGEgU3BhcnNlQXJyYXkgdGhhdCBjYW5ub3QgYmUgZGlyZWN0bHkKICAgIG1vZGlmaWVkLCBidXQgaWYgaXRzIHVuZGVybHlpbmcgZW51bWVyYWJsZSBjaGFuZ2VzLCBpdCB3aWxsIGNoYW5nZSBhbHNvLgogIAogICAgQGNsYXNzIE11dGFibGVBcnJheQogICAgQHVzZXMgRW1iZXJBcnJheQogICAgQHVzZXMgTXV0YWJsZUVudW1lcmFibGUKICAgIEBwdWJsaWMKICAqLwoKCiAgdmFyIE11dGFibGVBcnJheSA9IF9tZXRhbC5NaXhpbi5jcmVhdGUoQXJyYXlNaXhpbiwgX211dGFibGVfZW51bWVyYWJsZS5kZWZhdWx0LCB7CiAgICAvKioKICAgICAgX19SZXF1aXJlZC5fXyBZb3UgbXVzdCBpbXBsZW1lbnQgdGhpcyBtZXRob2QgdG8gYXBwbHkgdGhpcyBtaXhpbi4KICAgICAgIFRoaXMgaXMgb25lIG9mIHRoZSBwcmltaXRpdmVzIHlvdSBtdXN0IGltcGxlbWVudCB0byBzdXBwb3J0IGBBcnJheWAuCiAgICAgIFlvdSBzaG91bGQgcmVwbGFjZSBhbXQgb2JqZWN0cyBzdGFydGVkIGF0IGlkeCB3aXRoIHRoZSBvYmplY3RzIGluIHRoZQogICAgICBwYXNzZWQgYXJyYXkuIFlvdSBzaG91bGQgYWxzbyBjYWxsIGB0aGlzLmFycmF5Q29udGVudERpZENoYW5nZSgpYAogICAgICAgTm90ZSB0aGF0IHRoaXMgbWV0aG9kIGlzIGV4cGVjdGVkIHRvIHZhbGlkYXRlIHRoZSB0eXBlKHMpIG9mIG9iamVjdHMgdGhhdCBpdCBleHBlY3RzLgogICAgICAgQG1ldGhvZCByZXBsYWNlCiAgICAgIEBwYXJhbSB7TnVtYmVyfSBpZHggU3RhcnRpbmcgaW5kZXggaW4gdGhlIGFycmF5IHRvIHJlcGxhY2UuIElmCiAgICAgICAgaWR4ID49IGxlbmd0aCwgdGhlbiBhcHBlbmQgdG8gdGhlIGVuZCBvZiB0aGUgYXJyYXkuCiAgICAgIEBwYXJhbSB7TnVtYmVyfSBhbXQgTnVtYmVyIG9mIGVsZW1lbnRzIHRoYXQgc2hvdWxkIGJlIHJlbW92ZWQgZnJvbQogICAgICAgIHRoZSBhcnJheSwgc3RhcnRpbmcgYXQgKmlkeCouCiAgICAgIEBwYXJhbSB7RW1iZXJBcnJheX0gb2JqZWN0cyBBbiBhcnJheSBvZiB6ZXJvIG9yIG1vcmUgb2JqZWN0cyB0aGF0IHNob3VsZCBiZQogICAgICAgIGluc2VydGVkIGludG8gdGhlIGFycmF5IGF0ICppZHgqCiAgICAgIEBwdWJsaWMKICAgICovCgogICAgLyoqCiAgICAgIFJlbW92ZSBhbGwgZWxlbWVudHMgZnJvbSB0aGUgYXJyYXkuIFRoaXMgaXMgdXNlZnVsIGlmIHlvdQogICAgICB3YW50IHRvIHJldXNlIGFuIGV4aXN0aW5nIGFycmF5IHdpdGhvdXQgaGF2aW5nIHRvIHJlY3JlYXRlIGl0LgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBsZXQgY29sb3JzID0gWydyZWQnLCAnZ3JlZW4nLCAnYmx1ZSddOwogICAgICAgY29sb3JzLmxlbmd0aDsgIC8vIDMKICAgICAgY29sb3JzLmNsZWFyKCk7IC8vIFtdCiAgICAgIGNvbG9ycy5sZW5ndGg7ICAvLyAwCiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBjbGVhcgogICAgICBAcmV0dXJuIHtBcnJheX0gQW4gZW1wdHkgQXJyYXkuCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBjbGVhcjogZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aDsKCiAgICAgIGlmIChsZW4gPT09IDApIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgdGhpcy5yZXBsYWNlKDAsIGxlbiwgRU1QVFlfQVJSQVkpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqCiAgICAgIFRoaXMgd2lsbCB1c2UgdGhlIHByaW1pdGl2ZSBgcmVwbGFjZSgpYCBtZXRob2QgdG8gaW5zZXJ0IGFuIG9iamVjdCBhdCB0aGUKICAgICAgc3BlY2lmaWVkIGluZGV4LgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBsZXQgY29sb3JzID0gWydyZWQnLCAnZ3JlZW4nLCAnYmx1ZSddOwogICAgICAgY29sb3JzLmluc2VydEF0KDIsICd5ZWxsb3cnKTsgIC8vIFsncmVkJywgJ2dyZWVuJywgJ3llbGxvdycsICdibHVlJ10KICAgICAgY29sb3JzLmluc2VydEF0KDUsICdvcmFuZ2UnKTsgIC8vIEVycm9yOiBJbmRleCBvdXQgb2YgcmFuZ2UKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGluc2VydEF0CiAgICAgIEBwYXJhbSB7TnVtYmVyfSBpZHggaW5kZXggb2YgaW5zZXJ0IHRoZSBvYmplY3QgYXQuCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvYmplY3Qgb2JqZWN0IHRvIGluc2VydAogICAgICBAcmV0dXJuIHtFbWJlckFycmF5fSByZWNlaXZlcgogICAgICBAcHVibGljCiAgICAqLwogICAgaW5zZXJ0QXQ6IGZ1bmN0aW9uIGluc2VydEF0KGlkeCwgb2JqZWN0KSB7CiAgICAgIF9pbnNlcnRBdCh0aGlzLCBpZHgsIG9iamVjdCk7CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqCiAgICAgIFJlbW92ZSBhbiBvYmplY3QgYXQgdGhlIHNwZWNpZmllZCBpbmRleCB1c2luZyB0aGUgYHJlcGxhY2UoKWAgcHJpbWl0aXZlCiAgICAgIG1ldGhvZC4gWW91IGNhbiBwYXNzIGVpdGhlciBhIHNpbmdsZSBpbmRleCwgb3IgYSBzdGFydCBhbmQgYSBsZW5ndGguCiAgICAgICBJZiB5b3UgcGFzcyBhIHN0YXJ0IGFuZCBsZW5ndGggdGhhdCBpcyBiZXlvbmQgdGhlCiAgICAgIGxlbmd0aCB0aGlzIG1ldGhvZCB3aWxsIHRocm93IGFuIGFzc2VydGlvbi4KICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgbGV0IGNvbG9ycyA9IFsncmVkJywgJ2dyZWVuJywgJ2JsdWUnLCAneWVsbG93JywgJ29yYW5nZSddOwogICAgICAgY29sb3JzLnJlbW92ZUF0KDApOyAgICAgLy8gWydncmVlbicsICdibHVlJywgJ3llbGxvdycsICdvcmFuZ2UnXQogICAgICBjb2xvcnMucmVtb3ZlQXQoMiwgMik7ICAvLyBbJ2dyZWVuJywgJ2JsdWUnXQogICAgICBjb2xvcnMucmVtb3ZlQXQoNCwgMik7ICAvLyBFcnJvcjogSW5kZXggb3V0IG9mIHJhbmdlCiAgICAgIGBgYAogICAgICAgQG1ldGhvZCByZW1vdmVBdAogICAgICBAcGFyYW0ge051bWJlcn0gc3RhcnQgaW5kZXgsIHN0YXJ0IG9mIHJhbmdlCiAgICAgIEBwYXJhbSB7TnVtYmVyfSBsZW4gbGVuZ3RoIG9mIHBhc3NpbmcgcmFuZ2UKICAgICAgQHJldHVybiB7RW1iZXJBcnJheX0gcmVjZWl2ZXIKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHJlbW92ZUF0OiBmdW5jdGlvbiByZW1vdmVBdChzdGFydCwgbGVuKSB7CiAgICAgIHJldHVybiBfcmVtb3ZlQXQodGhpcywgc3RhcnQsIGxlbik7CiAgICB9LAoKICAgIC8qKgogICAgICBQdXNoIHRoZSBvYmplY3Qgb250byB0aGUgZW5kIG9mIHRoZSBhcnJheS4gV29ya3MganVzdCBsaWtlIGBwdXNoKClgIGJ1dCBpdAogICAgICBpcyBLVk8tY29tcGxpYW50LgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBsZXQgY29sb3JzID0gWydyZWQnLCAnZ3JlZW4nXTsKICAgICAgIGNvbG9ycy5wdXNoT2JqZWN0KCdibGFjaycpOyAgICAgLy8gWydyZWQnLCAnZ3JlZW4nLCAnYmxhY2snXQogICAgICBjb2xvcnMucHVzaE9iamVjdChbJ3llbGxvdyddKTsgIC8vIFsncmVkJywgJ2dyZWVuJywgWyd5ZWxsb3cnXV0KICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHB1c2hPYmplY3QKICAgICAgQHBhcmFtIHsqfSBvYmogb2JqZWN0IHRvIHB1c2gKICAgICAgQHJldHVybiBvYmplY3Qgc2FtZSBvYmplY3QgcGFzc2VkIGFzIGEgcGFyYW0KICAgICAgQHB1YmxpYwogICAgKi8KICAgIHB1c2hPYmplY3Q6IGZ1bmN0aW9uIHB1c2hPYmplY3Qob2JqKSB7CiAgICAgIHJldHVybiBfaW5zZXJ0QXQodGhpcywgdGhpcy5sZW5ndGgsIG9iaik7CiAgICB9LAoKICAgIC8qKgogICAgICBBZGQgdGhlIG9iamVjdHMgaW4gdGhlIHBhc3NlZCBhcnJheSB0byB0aGUgZW5kIG9mIHRoZSBhcnJheS4gRGVmZXJzCiAgICAgIG5vdGlmeWluZyBvYnNlcnZlcnMgb2YgdGhlIGNoYW5nZSB1bnRpbCBhbGwgb2JqZWN0cyBhcmUgYWRkZWQuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGxldCBjb2xvcnMgPSBbJ3JlZCddOwogICAgICAgY29sb3JzLnB1c2hPYmplY3RzKFsneWVsbG93JywgJ29yYW5nZSddKTsgIC8vIFsncmVkJywgJ3llbGxvdycsICdvcmFuZ2UnXQogICAgICBgYGAKICAgICAgIEBtZXRob2QgcHVzaE9iamVjdHMKICAgICAgQHBhcmFtIHtFbWJlckFycmF5fSBvYmplY3RzIHRoZSBvYmplY3RzIHRvIGFkZAogICAgICBAcmV0dXJuIHtFbWJlckFycmF5fSByZWNlaXZlcgogICAgICBAcHVibGljCiAgICAqLwogICAgcHVzaE9iamVjdHM6IGZ1bmN0aW9uIHB1c2hPYmplY3RzKG9iamVjdHMpIHsKICAgICAgdGhpcy5yZXBsYWNlKHRoaXMubGVuZ3RoLCAwLCBvYmplY3RzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8qKgogICAgICBQb3Agb2JqZWN0IGZyb20gYXJyYXkgb3IgbmlsIGlmIG5vbmUgYXJlIGxlZnQuIFdvcmtzIGp1c3QgbGlrZSBgcG9wKClgIGJ1dAogICAgICBpdCBpcyBLVk8tY29tcGxpYW50LgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBsZXQgY29sb3JzID0gWydyZWQnLCAnZ3JlZW4nLCAnYmx1ZSddOwogICAgICAgY29sb3JzLnBvcE9iamVjdCgpOyAgIC8vICdibHVlJwogICAgICBjb25zb2xlLmxvZyhjb2xvcnMpOyAgLy8gWydyZWQnLCAnZ3JlZW4nXQogICAgICBgYGAKICAgICAgIEBtZXRob2QgcG9wT2JqZWN0CiAgICAgIEByZXR1cm4gb2JqZWN0CiAgICAgIEBwdWJsaWMKICAgICovCiAgICBwb3BPYmplY3Q6IGZ1bmN0aW9uIHBvcE9iamVjdCgpIHsKICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwoKICAgICAgaWYgKGxlbiA9PT0gMCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICB2YXIgcmV0ID0gKDAsIF9tZXRhbC5vYmplY3RBdCkodGhpcywgbGVuIC0gMSk7CiAgICAgIHRoaXMucmVtb3ZlQXQobGVuIC0gMSwgMSk7CiAgICAgIHJldHVybiByZXQ7CiAgICB9LAoKICAgIC8qKgogICAgICBTaGlmdCBhbiBvYmplY3QgZnJvbSBzdGFydCBvZiBhcnJheSBvciBuaWwgaWYgbm9uZSBhcmUgbGVmdC4gV29ya3MganVzdAogICAgICBsaWtlIGBzaGlmdCgpYCBidXQgaXQgaXMgS1ZPLWNvbXBsaWFudC4KICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgbGV0IGNvbG9ycyA9IFsncmVkJywgJ2dyZWVuJywgJ2JsdWUnXTsKICAgICAgIGNvbG9ycy5zaGlmdE9iamVjdCgpOyAgLy8gJ3JlZCcKICAgICAgY29uc29sZS5sb2coY29sb3JzKTsgICAvLyBbJ2dyZWVuJywgJ2JsdWUnXQogICAgICBgYGAKICAgICAgIEBtZXRob2Qgc2hpZnRPYmplY3QKICAgICAgQHJldHVybiBvYmplY3QKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHNoaWZ0T2JqZWN0OiBmdW5jdGlvbiBzaGlmdE9iamVjdCgpIHsKICAgICAgaWYgKHRoaXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIHZhciByZXQgPSAoMCwgX21ldGFsLm9iamVjdEF0KSh0aGlzLCAwKTsKICAgICAgdGhpcy5yZW1vdmVBdCgwKTsKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCgogICAgLyoqCiAgICAgIFVuc2hpZnQgYW4gb2JqZWN0IHRvIHN0YXJ0IG9mIGFycmF5LiBXb3JrcyBqdXN0IGxpa2UgYHVuc2hpZnQoKWAgYnV0IGl0IGlzCiAgICAgIEtWTy1jb21wbGlhbnQuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGxldCBjb2xvcnMgPSBbJ3JlZCddOwogICAgICAgY29sb3JzLnVuc2hpZnRPYmplY3QoJ3llbGxvdycpOyAgICAvLyBbJ3llbGxvdycsICdyZWQnXQogICAgICBjb2xvcnMudW5zaGlmdE9iamVjdChbJ2JsYWNrJ10pOyAgIC8vIFtbJ2JsYWNrJ10sICd5ZWxsb3cnLCAncmVkJ10KICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHVuc2hpZnRPYmplY3QKICAgICAgQHBhcmFtIHsqfSBvYmogb2JqZWN0IHRvIHVuc2hpZnQKICAgICAgQHJldHVybiBvYmplY3Qgc2FtZSBvYmplY3QgcGFzc2VkIGFzIGEgcGFyYW0KICAgICAgQHB1YmxpYwogICAgKi8KICAgIHVuc2hpZnRPYmplY3Q6IGZ1bmN0aW9uIHVuc2hpZnRPYmplY3Qob2JqKSB7CiAgICAgIHJldHVybiBfaW5zZXJ0QXQodGhpcywgMCwgb2JqKTsKICAgIH0sCgogICAgLyoqCiAgICAgIEFkZHMgdGhlIG5hbWVkIG9iamVjdHMgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgYXJyYXkuIERlZmVycyBub3RpZnlpbmcKICAgICAgb2JzZXJ2ZXJzIHVudGlsIGFsbCBvYmplY3RzIGhhdmUgYmVlbiBhZGRlZC4KICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgbGV0IGNvbG9ycyA9IFsncmVkJ107CiAgICAgICBjb2xvcnMudW5zaGlmdE9iamVjdHMoWydibGFjaycsICd3aGl0ZSddKTsgICAvLyBbJ2JsYWNrJywgJ3doaXRlJywgJ3JlZCddCiAgICAgIGNvbG9ycy51bnNoaWZ0T2JqZWN0cygneWVsbG93Jyk7IC8vIFR5cGUgRXJyb3I6ICd1bmRlZmluZWQnIGlzIG5vdCBhIGZ1bmN0aW9uCiAgICAgIGBgYAogICAgICAgQG1ldGhvZCB1bnNoaWZ0T2JqZWN0cwogICAgICBAcGFyYW0ge0VudW1iZXJhYmxlfSBvYmplY3RzIHRoZSBvYmplY3RzIHRvIGFkZAogICAgICBAcmV0dXJuIHtFbWJlckFycmF5fSByZWNlaXZlcgogICAgICBAcHVibGljCiAgICAqLwogICAgdW5zaGlmdE9iamVjdHM6IGZ1bmN0aW9uIHVuc2hpZnRPYmplY3RzKG9iamVjdHMpIHsKICAgICAgdGhpcy5yZXBsYWNlKDAsIDAsIG9iamVjdHMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqCiAgICAgIFJldmVyc2Ugb2JqZWN0cyBpbiB0aGUgYXJyYXkuIFdvcmtzIGp1c3QgbGlrZSBgcmV2ZXJzZSgpYCBidXQgaXQgaXMKICAgICAgS1ZPLWNvbXBsaWFudC4KICAgICAgIEBtZXRob2QgcmV2ZXJzZU9iamVjdHMKICAgICAgQHJldHVybiB7RW1iZXJBcnJheX0gcmVjZWl2ZXIKICAgICAgIEBwdWJsaWMKICAgICovCiAgICByZXZlcnNlT2JqZWN0czogZnVuY3Rpb24gcmV2ZXJzZU9iamVjdHMoKSB7CiAgICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aDsKCiAgICAgIGlmIChsZW4gPT09IDApIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgdmFyIG9iamVjdHMgPSB0aGlzLnRvQXJyYXkoKS5yZXZlcnNlKCk7CiAgICAgIHRoaXMucmVwbGFjZSgwLCBsZW4sIG9iamVjdHMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqCiAgICAgIFJlcGxhY2UgYWxsIHRoZSByZWNlaXZlcidzIGNvbnRlbnQgd2l0aCBjb250ZW50IG9mIHRoZSBhcmd1bWVudC4KICAgICAgSWYgYXJndW1lbnQgaXMgYW4gZW1wdHkgYXJyYXkgcmVjZWl2ZXIgd2lsbCBiZSBjbGVhcmVkLgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBsZXQgY29sb3JzID0gWydyZWQnLCAnZ3JlZW4nLCAnYmx1ZSddOwogICAgICAgY29sb3JzLnNldE9iamVjdHMoWydibGFjaycsICd3aGl0ZSddKTsgIC8vIFsnYmxhY2snLCAnd2hpdGUnXQogICAgICBjb2xvcnMuc2V0T2JqZWN0cyhbXSk7ICAgICAgICAgICAgICAgICAgLy8gW10KICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHNldE9iamVjdHMKICAgICAgQHBhcmFtIHtFbWJlckFycmF5fSBvYmplY3RzIGFycmF5IHdob3NlIGNvbnRlbnQgd2lsbCBiZSB1c2VkIGZvciByZXBsYWNpbmcKICAgICAgICAgIHRoZSBjb250ZW50IG9mIHRoZSByZWNlaXZlcgogICAgICBAcmV0dXJuIHtFbWJlckFycmF5fSByZWNlaXZlciB3aXRoIHRoZSBuZXcgY29udGVudAogICAgICBAcHVibGljCiAgICAqLwogICAgc2V0T2JqZWN0czogZnVuY3Rpb24gc2V0T2JqZWN0cyhvYmplY3RzKSB7CiAgICAgIGlmIChvYmplY3RzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiB0aGlzLmNsZWFyKCk7CiAgICAgIH0KCiAgICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aDsKICAgICAgdGhpcy5yZXBsYWNlKDAsIGxlbiwgb2JqZWN0cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvKioKICAgICAgUmVtb3ZlIGFsbCBvY2N1cnJlbmNlcyBvZiBhbiBvYmplY3QgaW4gdGhlIGFycmF5LgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBsZXQgY2l0aWVzID0gWydDaGljYWdvJywgJ0JlcmxpbicsICdMaW1hJywgJ0NoaWNhZ28nXTsKICAgICAgIGNpdGllcy5yZW1vdmVPYmplY3QoJ0NoaWNhZ28nKTsgIC8vIFsnQmVybGluJywgJ0xpbWEnXQogICAgICBjaXRpZXMucmVtb3ZlT2JqZWN0KCdMaW1hJyk7ICAgICAvLyBbJ0JlcmxpbiddCiAgICAgIGNpdGllcy5yZW1vdmVPYmplY3QoJ1Rva3lvJykgICAgIC8vIFsnQmVybGluJ10KICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHJlbW92ZU9iamVjdAogICAgICBAcGFyYW0geyp9IG9iaiBvYmplY3QgdG8gcmVtb3ZlCiAgICAgIEByZXR1cm4ge0VtYmVyQXJyYXl9IHJlY2VpdmVyCiAgICAgIEBwdWJsaWMKICAgICovCiAgICByZW1vdmVPYmplY3Q6IGZ1bmN0aW9uIHJlbW92ZU9iamVjdChvYmopIHsKICAgICAgdmFyIGxvYyA9IHRoaXMubGVuZ3RoIHx8IDA7CgogICAgICB3aGlsZSAoLS1sb2MgPj0gMCkgewogICAgICAgIHZhciBjdXJPYmplY3QgPSAoMCwgX21ldGFsLm9iamVjdEF0KSh0aGlzLCBsb2MpOwoKICAgICAgICBpZiAoY3VyT2JqZWN0ID09PSBvYmopIHsKICAgICAgICAgIHRoaXMucmVtb3ZlQXQobG9jKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvKioKICAgICAgUmVtb3ZlcyBlYWNoIG9iamVjdCBpbiB0aGUgcGFzc2VkIGFycmF5IGZyb20gdGhlIHJlY2VpdmVyLgogICAgICAgQG1ldGhvZCByZW1vdmVPYmplY3RzCiAgICAgIEBwYXJhbSB7RW1iZXJBcnJheX0gb2JqZWN0cyB0aGUgb2JqZWN0cyB0byByZW1vdmUKICAgICAgQHJldHVybiB7RW1iZXJBcnJheX0gcmVjZWl2ZXIKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHJlbW92ZU9iamVjdHM6IGZ1bmN0aW9uIHJlbW92ZU9iamVjdHMob2JqZWN0cykgewogICAgICAoMCwgX21ldGFsLmJlZ2luUHJvcGVydHlDaGFuZ2VzKSgpOwoKICAgICAgZm9yICh2YXIgaSA9IG9iamVjdHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICB0aGlzLnJlbW92ZU9iamVjdChvYmplY3RzW2ldKTsKICAgICAgfQoKICAgICAgKDAsIF9tZXRhbC5lbmRQcm9wZXJ0eUNoYW5nZXMpKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvKioKICAgICAgUHVzaCB0aGUgb2JqZWN0IG9udG8gdGhlIGVuZCBvZiB0aGUgYXJyYXkgaWYgaXQgaXMgbm90IGFscmVhZHkKICAgICAgcHJlc2VudCBpbiB0aGUgYXJyYXkuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGxldCBjaXRpZXMgPSBbJ0NoaWNhZ28nLCAnQmVybGluJ107CiAgICAgICBjaXRpZXMuYWRkT2JqZWN0KCdMaW1hJyk7ICAgIC8vIFsnQ2hpY2FnbycsICdCZXJsaW4nLCAnTGltYSddCiAgICAgIGNpdGllcy5hZGRPYmplY3QoJ0JlcmxpbicpOyAgLy8gWydDaGljYWdvJywgJ0JlcmxpbicsICdMaW1hJ10KICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGFkZE9iamVjdAogICAgICBAcGFyYW0geyp9IG9iaiBvYmplY3QgdG8gYWRkLCBpZiBub3QgYWxyZWFkeSBwcmVzZW50CiAgICAgIEByZXR1cm4ge0VtYmVyQXJyYXl9IHJlY2VpdmVyCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBhZGRPYmplY3Q6IGZ1bmN0aW9uIGFkZE9iamVjdChvYmopIHsKICAgICAgdmFyIGluY2x1ZGVkID0gdGhpcy5pbmNsdWRlcyhvYmopOwoKICAgICAgaWYgKCFpbmNsdWRlZCkgewogICAgICAgIHRoaXMucHVzaE9iamVjdChvYmopOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqCiAgICAgIEFkZHMgZWFjaCBvYmplY3QgaW4gdGhlIHBhc3NlZCBhcnJheSB0byB0aGUgcmVjZWl2ZXIuCiAgICAgICBAbWV0aG9kIGFkZE9iamVjdHMKICAgICAgQHBhcmFtIHtFbWJlckFycmF5fSBvYmplY3RzIHRoZSBvYmplY3RzIHRvIGFkZC4KICAgICAgQHJldHVybiB7RW1iZXJBcnJheX0gcmVjZWl2ZXIKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGFkZE9iamVjdHM6IGZ1bmN0aW9uIGFkZE9iamVjdHMob2JqZWN0cykgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgICgwLCBfbWV0YWwuYmVnaW5Qcm9wZXJ0eUNoYW5nZXMpKCk7CiAgICAgIG9iamVjdHMuZm9yRWFjaChmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgcmV0dXJuIF90aGlzMi5hZGRPYmplY3Qob2JqKTsKICAgICAgfSk7CiAgICAgICgwLCBfbWV0YWwuZW5kUHJvcGVydHlDaGFuZ2VzKSgpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9KTsKICAvKioKICAgIENyZWF0ZXMgYW4gYEVtYmVyLk5hdGl2ZUFycmF5YCBmcm9tIGFuIEFycmF5LWxpa2Ugb2JqZWN0LgogICAgRG9lcyBub3QgbW9kaWZ5IHRoZSBvcmlnaW5hbCBvYmplY3QncyBjb250ZW50cy4gYEEoKWAgaXMgbm90IG5lZWRlZCBpZgogICAgYEVtYmVyRU5WLkVYVEVORF9QUk9UT1RZUEVTYCBpcyBgdHJ1ZWAgKHRoZSBkZWZhdWx0IHZhbHVlKS4gSG93ZXZlciwKICAgIGl0IGlzIHJlY29tbWVuZGVkIHRoYXQgeW91IHVzZSBgQSgpYCB3aGVuIGNyZWF0aW5nIGFkZG9ucyBmb3IKICAgIGVtYmVyIG9yIHdoZW4geW91IGNhbiBub3QgZ3VhcmFudGVlIHRoYXQgYEVtYmVyRU5WLkVYVEVORF9QUk9UT1RZUEVTYAogICAgd2lsbCBiZSBgdHJ1ZWAuCiAgCiAgICBFeGFtcGxlCiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9teS1jb21wb25lbnQuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICBpbXBvcnQgeyBBIH0gZnJvbSAnQGVtYmVyL2FycmF5JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICB0YWdOYW1lOiAndWwnLAogICAgICBjbGFzc05hbWVzOiBbJ3BhZ2luYXRpb24nXSwKICAKICAgICAgaW5pdCgpIHsKICAgICAgICB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpOwogIAogICAgICAgIGlmICghdGhpcy5nZXQoJ2NvbnRlbnQnKSkgewogICAgICAgICAgdGhpcy5zZXQoJ2NvbnRlbnQnLCBBKCkpOwogICAgICAgICAgdGhpcy5zZXQoJ290aGVyQ29udGVudCcsIEEoWzEsMiwzXSkpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIEBtZXRob2QgQQogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvYXJyYXkKICAgIEByZXR1cm4ge0VtYmVyLk5hdGl2ZUFycmF5fQogICAgQHB1YmxpYwogICovCiAgLy8gQWRkIEVtYmVyLkFycmF5IHRvIEFycmF5LnByb3RvdHlwZS4gUmVtb3ZlIG1ldGhvZHMgd2l0aCBuYXRpdmUKICAvLyBpbXBsZW1lbnRhdGlvbnMgYW5kIHN1cHBseSBzb21lIG1vcmUgb3B0aW1pemVkIHZlcnNpb25zIG9mIGdlbmVyaWMgbWV0aG9kcwogIC8vIGJlY2F1c2UgdGhleSBhcmUgc28gY29tbW9uLgoKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICBUaGUgTmF0aXZlQXJyYXkgbWl4aW4gY29udGFpbnMgdGhlIHByb3BlcnRpZXMgbmVlZGVkIHRvIG1ha2UgdGhlIG5hdGl2ZQogICAgQXJyYXkgc3VwcG9ydCBNdXRhYmxlQXJyYXkgYW5kIGFsbCBvZiBpdHMgZGVwZW5kZW50IEFQSXMuIFVubGVzcyB5b3UKICAgIGhhdmUgYEVtYmVyRU5WLkVYVEVORF9QUk9UT1RZUEVTYCBvciBgRW1iZXJFTlYuRVhURU5EX1BST1RPVFlQRVMuQXJyYXlgIHNldCB0bwogICAgZmFsc2UsIHRoaXMgd2lsbCBiZSBhcHBsaWVkIGF1dG9tYXRpY2FsbHkuIE90aGVyd2lzZSB5b3UgY2FuIGFwcGx5IHRoZSBtaXhpbgogICAgYXQgYW55dGltZSBieSBjYWxsaW5nIGBFbWJlci5OYXRpdmVBcnJheS5hcHBseShBcnJheS5wcm90b3R5cGUpYC4KICAKICAgIEBjbGFzcyBFbWJlci5OYXRpdmVBcnJheQogICAgQHVzZXMgTXV0YWJsZUFycmF5CiAgICBAdXNlcyBPYnNlcnZhYmxlCiAgICBAcHVibGljCiAgKi8KCgogIF9leHBvcnRzLk11dGFibGVBcnJheSA9IE11dGFibGVBcnJheTsKCiAgdmFyIE5hdGl2ZUFycmF5ID0gX21ldGFsLk1peGluLmNyZWF0ZShNdXRhYmxlQXJyYXksIF9vYnNlcnZhYmxlLmRlZmF1bHQsIHsKICAgIG9iamVjdEF0OiBmdW5jdGlvbiBvYmplY3RBdChpZHgpIHsKICAgICAgcmV0dXJuIHRoaXNbaWR4XTsKICAgIH0sCiAgICAvLyBwcmltaXRpdmUgZm9yIGFycmF5IHN1cHBvcnQuCiAgICByZXBsYWNlOiBmdW5jdGlvbiByZXBsYWNlKHN0YXJ0LCBkZWxldGVDb3VudCwgaXRlbXMpIHsKICAgICAgaWYgKGl0ZW1zID09PSB2b2lkIDApIHsKICAgICAgICBpdGVtcyA9IEVNUFRZX0FSUkFZOwogICAgICB9CgogICAgICAoZmFsc2UgJiYgIShBcnJheS5pc0FycmF5KGl0ZW1zKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUaGUgdGhpcmQgYXJndW1lbnQgdG8gcmVwbGFjZSBuZWVkcyB0byBiZSBhbiBhcnJheS4nLCBBcnJheS5pc0FycmF5KGl0ZW1zKSkpOwogICAgICAoMCwgX21ldGFsLnJlcGxhY2VJbk5hdGl2ZUFycmF5KSh0aGlzLCBzdGFydCwgZGVsZXRlQ291bnQsIGl0ZW1zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfSk7IC8vIFJlbW92ZSBhbnkgbWV0aG9kcyBpbXBsZW1lbnRlZCBuYXRpdmVseSBzbyB3ZSBkb24ndCBvdmVycmlkZSB0aGVtCgoKICBfZXhwb3J0cy5OYXRpdmVBcnJheSA9IE5hdGl2ZUFycmF5OwogIHZhciBpZ25vcmUgPSBbJ2xlbmd0aCddOwogIE5hdGl2ZUFycmF5LmtleXMoKS5mb3JFYWNoKGZ1bmN0aW9uIChtZXRob2ROYW1lKSB7CiAgICBpZiAoQXJyYXkucHJvdG90eXBlW21ldGhvZE5hbWVdKSB7CiAgICAgIGlnbm9yZS5wdXNoKG1ldGhvZE5hbWUpOwogICAgfQogIH0pOwogIF9leHBvcnRzLk5hdGl2ZUFycmF5ID0gTmF0aXZlQXJyYXkgPSAoX05hdGl2ZUFycmF5ID0gTmF0aXZlQXJyYXkpLndpdGhvdXQuYXBwbHkoX05hdGl2ZUFycmF5LCBpZ25vcmUpOwoKICB2YXIgX0EyOwoKICBfZXhwb3J0cy5BID0gX0EyOwoKICBpZiAoX2Vudmlyb25tZW50LkVOVi5FWFRFTkRfUFJPVE9UWVBFUy5BcnJheSkgewogICAgTmF0aXZlQXJyYXkuYXBwbHkoQXJyYXkucHJvdG90eXBlKTsKCiAgICBfZXhwb3J0cy5BID0gX0EyID0gZnVuY3Rpb24gQShhcnIpIHsKICAgICAgKGZhbHNlICYmICEoISh0aGlzIGluc3RhbmNlb2YgX0EyKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgY2Fubm90IGNyZWF0ZSBhbiBFbWJlciBBcnJheSB3aXRoIGBuZXcgQSgpYCwgcGxlYXNlIHVwZGF0ZSB0byBjYWxsaW5nIEEgYXMgYSBmdW5jdGlvbjogYEEoKWAnLCAhKHRoaXMgaW5zdGFuY2VvZiBfQTIpKSk7CiAgICAgIHJldHVybiBhcnIgfHwgW107CiAgICB9OwogIH0gZWxzZSB7CiAgICBfZXhwb3J0cy5BID0gX0EyID0gZnVuY3Rpb24gX0EoYXJyKSB7CiAgICAgIChmYWxzZSAmJiAhKCEodGhpcyBpbnN0YW5jZW9mIF9BMikpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGNhbm5vdCBjcmVhdGUgYW4gRW1iZXIgQXJyYXkgd2l0aCBgbmV3IEEoKWAsIHBsZWFzZSB1cGRhdGUgdG8gY2FsbGluZyBBIGFzIGEgZnVuY3Rpb246IGBBKClgJywgISh0aGlzIGluc3RhbmNlb2YgX0EyKSkpOwoKICAgICAgaWYgKCFhcnIpIHsKICAgICAgICBhcnIgPSBbXTsKICAgICAgfQoKICAgICAgcmV0dXJuIEFycmF5TWl4aW4uZGV0ZWN0KGFycikgPyBhcnIgOiBOYXRpdmVBcnJheS5hcHBseShhcnIpOwogICAgfTsKICB9CgogIHZhciBfZGVmYXVsdCA9IEFycmF5TWl4aW47CiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9taXhpbnMvY29tcGFyYWJsZSIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9tZXRhbCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgQG1vZHVsZSBlbWJlcgogICovCgogIC8qKgogICAgSW1wbGVtZW50cyBzb21lIHN0YW5kYXJkIG1ldGhvZHMgZm9yIGNvbXBhcmluZyBvYmplY3RzLiBBZGQgdGhpcyBtaXhpbiB0bwogICAgYW55IGNsYXNzIHlvdSBjcmVhdGUgdGhhdCBjYW4gY29tcGFyZSBpdHMgaW5zdGFuY2VzLgogIAogICAgWW91IHNob3VsZCBpbXBsZW1lbnQgdGhlIGBjb21wYXJlKClgIG1ldGhvZC4KICAKICAgIEBjbGFzcyBDb21wYXJhYmxlCiAgICBAbmFtZXNwYWNlIEVtYmVyCiAgICBAc2luY2UgRW1iZXIgMC45CiAgICBAcHJpdmF0ZQogICovCiAgdmFyIF9kZWZhdWx0ID0gX21ldGFsLk1peGluLmNyZWF0ZSh7CiAgICAvKioKICAgICAgX19SZXF1aXJlZC5fXyBZb3UgbXVzdCBpbXBsZW1lbnQgdGhpcyBtZXRob2QgdG8gYXBwbHkgdGhpcyBtaXhpbi4KICAgICAgIE92ZXJyaWRlIHRvIHJldHVybiB0aGUgcmVzdWx0IG9mIHRoZSBjb21wYXJpc29uIG9mIHRoZSB0d28gcGFyYW1ldGVycy4gVGhlCiAgICAgIGNvbXBhcmUgbWV0aG9kIHNob3VsZCByZXR1cm46CiAgICAgICAtIGAtMWAgaWYgYGEgPCBiYAogICAgICAtIGAwYCBpZiBgYSA9PSBiYAogICAgICAtIGAxYCBpZiBgYSA+IGJgCiAgICAgICBEZWZhdWx0IGltcGxlbWVudGF0aW9uIHJhaXNlcyBhbiBleGNlcHRpb24uCiAgICAgICBAbWV0aG9kIGNvbXBhcmUKICAgICAgQHBhcmFtIGEge09iamVjdH0gdGhlIGZpcnN0IG9iamVjdCB0byBjb21wYXJlCiAgICAgIEBwYXJhbSBiIHtPYmplY3R9IHRoZSBzZWNvbmQgb2JqZWN0IHRvIGNvbXBhcmUKICAgICAgQHJldHVybiB7TnVtYmVyfSB0aGUgcmVzdWx0IG9mIHRoZSBjb21wYXJpc29uCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgY29tcGFyZTogbnVsbAogIH0pOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL21peGlucy9jb250YWluZXJfcHJveHkiLCBbImV4cG9ydHMiLCAiQGVtYmVyL3J1bmxvb3AiLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfcnVubG9vcCwgX21ldGFsKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICBDb250YWluZXJQcm94eU1peGluIGlzIHVzZWQgdG8gcHJvdmlkZSBwdWJsaWMgYWNjZXNzIHRvIHNwZWNpZmljCiAgICBjb250YWluZXIgZnVuY3Rpb25hbGl0eS4KICAKICAgIEBjbGFzcyBDb250YWluZXJQcm94eU1peGluCiAgICBAcHJpdmF0ZQogICovCiAgdmFyIGNvbnRhaW5lclByb3h5TWl4aW4gPSB7CiAgICAvKioKICAgICBUaGUgY29udGFpbmVyIHN0b3JlcyBzdGF0ZS4KICAgICAgQHByaXZhdGUKICAgICBAcHJvcGVydHkge0VtYmVyLkNvbnRhaW5lcn0gX19jb250YWluZXJfXwogICAgICovCiAgICBfX2NvbnRhaW5lcl9fOiBudWxsLAoKICAgIC8qKgogICAgIFJldHVybnMgYW4gb2JqZWN0IHRoYXQgY2FuIGJlIHVzZWQgdG8gcHJvdmlkZSBhbiBvd25lciB0byBhCiAgICAgbWFudWFsbHkgY3JlYXRlZCBpbnN0YW5jZS4KICAgICAgRXhhbXBsZToKICAgICAgYGBgCiAgICAgaW1wb3J0IHsgZ2V0T3duZXIgfSBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogICAgICBsZXQgb3duZXIgPSBnZXRPd25lcih0aGlzKTsKICAgICAgVXNlci5jcmVhdGUoCiAgICAgICBvd25lci5vd25lckluamVjdGlvbigpLAogICAgICAgeyB1c2VybmFtZTogJ3J3amJsdWUnIH0KICAgICApCiAgICAgYGBgCiAgICAgIEBwdWJsaWMKICAgICBAbWV0aG9kIG93bmVySW5qZWN0aW9uCiAgICAgQHNpbmNlIDIuMy4wCiAgICAgQHJldHVybiB7T2JqZWN0fQogICAgKi8KICAgIG93bmVySW5qZWN0aW9uOiBmdW5jdGlvbiBvd25lckluamVjdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuX19jb250YWluZXJfXy5vd25lckluamVjdGlvbigpOwogICAgfSwKCiAgICAvKioKICAgICBHaXZlbiBhIGZ1bGxOYW1lIHJldHVybiBhIGNvcnJlc3BvbmRpbmcgaW5zdGFuY2UuCiAgICAgIFRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIGZvciBsb29rdXAgdG8gcmV0dXJuIGEgc2luZ2xldG9uIGluc3RhbmNlLgogICAgIFRoZSBzaW5nbGV0b24gaXMgc2NvcGVkIHRvIHRoZSBjb250YWluZXIsIGFsbG93aW5nIG11bHRpcGxlIGNvbnRhaW5lcnMKICAgICB0byBhbGwgaGF2ZSB0aGVpciBvd24gbG9jYWxseSBzY29wZWQgc2luZ2xldG9ucy4KICAgICAgYGBgamF2YXNjcmlwdAogICAgIGxldCByZWdpc3RyeSA9IG5ldyBSZWdpc3RyeSgpOwogICAgIGxldCBjb250YWluZXIgPSByZWdpc3RyeS5jb250YWluZXIoKTsKICAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2FwaTp0d2l0dGVyJywgVHdpdHRlcik7CiAgICAgIGxldCB0d2l0dGVyID0gY29udGFpbmVyLmxvb2t1cCgnYXBpOnR3aXR0ZXInKTsKICAgICAgdHdpdHRlciBpbnN0YW5jZW9mIFR3aXR0ZXI7IC8vID0+IHRydWUKICAgICAgLy8gYnkgZGVmYXVsdCB0aGUgY29udGFpbmVyIHdpbGwgcmV0dXJuIHNpbmdsZXRvbnMKICAgICBsZXQgdHdpdHRlcjIgPSBjb250YWluZXIubG9va3VwKCdhcGk6dHdpdHRlcicpOwogICAgIHR3aXR0ZXIyIGluc3RhbmNlb2YgVHdpdHRlcjsgLy8gPT4gdHJ1ZQogICAgICB0d2l0dGVyID09PSB0d2l0dGVyMjsgLy89PiB0cnVlCiAgICAgYGBgCiAgICAgIElmIHNpbmdsZXRvbnMgYXJlIG5vdCB3YW50ZWQgYW4gb3B0aW9uYWwgZmxhZyBjYW4gYmUgcHJvdmlkZWQgYXQgbG9va3VwLgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgbGV0IHJlZ2lzdHJ5ID0gbmV3IFJlZ2lzdHJ5KCk7CiAgICAgbGV0IGNvbnRhaW5lciA9IHJlZ2lzdHJ5LmNvbnRhaW5lcigpOwogICAgICByZWdpc3RyeS5yZWdpc3RlcignYXBpOnR3aXR0ZXInLCBUd2l0dGVyKTsKICAgICAgbGV0IHR3aXR0ZXIgPSBjb250YWluZXIubG9va3VwKCdhcGk6dHdpdHRlcicsIHsgc2luZ2xldG9uOiBmYWxzZSB9KTsKICAgICBsZXQgdHdpdHRlcjIgPSBjb250YWluZXIubG9va3VwKCdhcGk6dHdpdHRlcicsIHsgc2luZ2xldG9uOiBmYWxzZSB9KTsKICAgICAgdHdpdHRlciA9PT0gdHdpdHRlcjI7IC8vPT4gZmFsc2UKICAgICBgYGAKICAgICAgQHB1YmxpYwogICAgIEBtZXRob2QgbG9va3VwCiAgICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lCiAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICBAcmV0dXJuIHthbnl9CiAgICAgKi8KICAgIGxvb2t1cDogZnVuY3Rpb24gbG9va3VwKGZ1bGxOYW1lLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLl9fY29udGFpbmVyX18ubG9va3VwKGZ1bGxOYW1lLCBvcHRpb25zKTsKICAgIH0sCiAgICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICB2YXIgY29udGFpbmVyID0gdGhpcy5fX2NvbnRhaW5lcl9fOwoKICAgICAgaWYgKGNvbnRhaW5lcikgewogICAgICAgICgwLCBfcnVubG9vcC5qb2luKShmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb250YWluZXIuZGVzdHJveSgpOwogICAgICAgICAgKDAsIF9ydW5sb29wLnNjaGVkdWxlKSgnZGVzdHJveScsIGNvbnRhaW5lciwgJ2ZpbmFsaXplRGVzdHJveScpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICB0aGlzLl9zdXBlcigpOwogICAgfSwKCiAgICAvKioKICAgIEdpdmVuIGEgZnVsbE5hbWUgcmV0dXJuIGEgZmFjdG9yeSBtYW5hZ2VyLgogICAgIFRoaXMgbWV0aG9kIHJldHVybnMgYSBtYW5hZ2VyIHdoaWNoIGNhbiBiZSB1c2VkIGZvciBpbnRyb3NwZWN0aW9uIG9mIHRoZQogICAgZmFjdG9yeSdzIGNsYXNzIG9yIGZvciB0aGUgY3JlYXRpb24gb2YgZmFjdG9yeSBpbnN0YW5jZXMgd2l0aCBpbml0aWFsCiAgICBwcm9wZXJ0aWVzLiBUaGUgbWFuYWdlciBpcyBhbiBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgKiBgY2xhc3NgIC0gVGhlIHJlZ2lzdGVyZWQgb3IgcmVzb2x2ZWQgY2xhc3MuCiAgICAqIGBjcmVhdGVgIC0gQSBmdW5jdGlvbiB0aGF0IHdpbGwgY3JlYXRlIGFuIGluc3RhbmNlIG9mIHRoZSBjbGFzcyB3aXRoCiAgICAgIGFueSBkZXBlbmRlbmNpZXMgaW5qZWN0ZWQuCiAgICAgRm9yIGV4YW1wbGU6CiAgICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgZ2V0T3duZXIgfSBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogICAgIGxldCBvd25lciA9IGdldE93bmVyKG90aGVySW5zdGFuY2UpOwogICAgLy8gdGhlIG93bmVyIGlzIGNvbW1vbmx5IHRoZSBgYXBwbGljYXRpb25JbnN0YW5jZWAsIGFuZCBjYW4gYmUgYWNjZXNzZWQgdmlhCiAgICAvLyBhbiBpbnN0YW5jZSBpbml0aWFsaXplci4KICAgICBsZXQgZmFjdG9yeSA9IG93bmVyLmZhY3RvcnlGb3IoJ3NlcnZpY2U6YmVzcG9rZScpOwogICAgIGZhY3RvcnkuY2xhc3M7CiAgICAvLyBUaGUgcmVnaXN0ZXJlZCBvciByZXNvbHZlZCBjbGFzcy4gRm9yIGV4YW1wbGUgd2hlbiB1c2VkIHdpdGggYW4gRW1iZXItQ0xJCiAgICAvLyBhcHAsIHRoaXMgd291bGQgYmUgdGhlIGRlZmF1bHQgZXhwb3J0IGZyb20gYGFwcC9zZXJ2aWNlcy9iZXNwb2tlLmpzYC4KICAgICBsZXQgaW5zdGFuY2UgPSBmYWN0b3J5LmNyZWF0ZSh7CiAgICAgIHNvbWVQcm9wZXJ0eTogJ2FuIGluaXRpYWwgcHJvcGVydHkgdmFsdWUnCiAgICB9KTsKICAgIC8vIENyZWF0ZSBhbiBpbnN0YW5jZSB3aXRoIGFueSBpbmplY3Rpb25zIGFuZCB0aGUgcGFzc2VkIG9wdGlvbnMgYXMKICAgIC8vIGluaXRpYWwgcHJvcGVydGllcy4KICAgIGBgYAogICAgIEFueSBpbnN0YW5jZXMgY3JlYXRlZCB2aWEgdGhlIGZhY3RvcnkncyBgLmNyZWF0ZSgpYCBtZXRob2QgKm11c3QqIGJlIGRlc3Ryb3llZAogICAgbWFudWFsbHkgYnkgdGhlIGNhbGxlciBvZiBgLmNyZWF0ZSgpYC4gVHlwaWNhbGx5LCB0aGlzIGlzIGRvbmUgZHVyaW5nIHRoZSBjcmVhdGluZwogICAgb2JqZWN0cyBvd24gYGRlc3Ryb3lgIG9yIGB3aWxsRGVzdHJveWAgbWV0aG9kcy4KICAgICBAcHVibGljCiAgICBAbWV0aG9kIGZhY3RvcnlGb3IKICAgIEBwYXJhbSB7U3RyaW5nfSBmdWxsTmFtZQogICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgIEByZXR1cm4ge0ZhY3RvcnlNYW5hZ2VyfQogICAgKi8KICAgIGZhY3RvcnlGb3I6IGZ1bmN0aW9uIGZhY3RvcnlGb3IoZnVsbE5hbWUsIG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuX19jb250YWluZXJfXy5mYWN0b3J5Rm9yKGZ1bGxOYW1lLCBvcHRpb25zKTsKICAgIH0KICB9OwoKICB2YXIgX2RlZmF1bHQgPSBfbWV0YWwuTWl4aW4uY3JlYXRlKGNvbnRhaW5lclByb3h5TWl4aW4pOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL21peGlucy9jb3B5YWJsZSIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9tZXRhbCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgQG1vZHVsZSBlbWJlcgogICovCgogIC8qKgogICAgSW1wbGVtZW50cyBzb21lIHN0YW5kYXJkIG1ldGhvZHMgZm9yIGNvcHlpbmcgYW4gb2JqZWN0LiBBZGQgdGhpcyBtaXhpbiB0bwogICAgYW55IG9iamVjdCB5b3UgY3JlYXRlIHRoYXQgY2FuIGNyZWF0ZSBhIGNvcHkgb2YgaXRzZWxmLiBUaGlzIG1peGluIGlzCiAgICBhZGRlZCBhdXRvbWF0aWNhbGx5IHRvIHRoZSBidWlsdC1pbiBhcnJheS4KICAKICAgIFlvdSBzaG91bGQgZ2VuZXJhbGx5IGltcGxlbWVudCB0aGUgYGNvcHkoKWAgbWV0aG9kIHRvIHJldHVybiBhIGNvcHkgb2YgdGhlCiAgICByZWNlaXZlci4KICAKICAgIEBjbGFzcyBDb3B5YWJsZQogICAgQG5hbWVzcGFjZSBFbWJlcgogICAgQHNpbmNlIEVtYmVyIDAuOQogICAgQGRlcHJlY2F0ZWQgVXNlICdlbWJlci1jb3B5JyBhZGRvbiBpbnN0ZWFkCiAgICBAcHJpdmF0ZQogICovCiAgdmFyIF9kZWZhdWx0ID0gX21ldGFsLk1peGluLmNyZWF0ZSh7CiAgICAvKioKICAgICAgX19SZXF1aXJlZC5fXyBZb3UgbXVzdCBpbXBsZW1lbnQgdGhpcyBtZXRob2QgdG8gYXBwbHkgdGhpcyBtaXhpbi4KICAgICAgIE92ZXJyaWRlIHRvIHJldHVybiBhIGNvcHkgb2YgdGhlIHJlY2VpdmVyLiBEZWZhdWx0IGltcGxlbWVudGF0aW9uIHJhaXNlcwogICAgICBhbiBleGNlcHRpb24uCiAgICAgICBAbWV0aG9kIGNvcHkKICAgICAgQHBhcmFtIHtCb29sZWFufSBkZWVwIGlmIGB0cnVlYCwgYSBkZWVwIGNvcHkgb2YgdGhlIG9iamVjdCBzaG91bGQgYmUgbWFkZQogICAgICBAcmV0dXJuIHtPYmplY3R9IGNvcHkgb2YgcmVjZWl2ZXIKICAgICAgQHByaXZhdGUKICAgICovCiAgICBjb3B5OiBudWxsCiAgfSk7CgogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvbWl4aW5zL2VudW1lcmFibGUiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfbWV0YWwpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIC8qKgogIEBtb2R1bGUgQGVtYmVyL2VudW1lcmFibGUKICBAcHJpdmF0ZQogICovCgogIC8qKgogICAgVGhlIG1ldGhvZHMgaW4gdGhpcyBtaXhpbiBoYXZlIGJlZW4gbW92ZWQgdG8gW011dGFibGVBcnJheV0oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9NdXRhYmxlQXJyYXkpLiBUaGlzIG1peGluIGhhcwogICAgYmVlbiBpbnRlbnRpb25hbGx5IHByZXNlcnZlZCB0byBhdm9pZCBicmVha2luZyBFbnVtZXJhYmxlLmRldGVjdCBjaGVja3MKICAgIHVudGlsIHRoZSBjb21tdW5pdHkgbWlncmF0ZXMgYXdheSBmcm9tIHRoZW0uCiAgCiAgICBAY2xhc3MgRW51bWVyYWJsZQogICAgQHByaXZhdGUKICAqLwogIHZhciBfZGVmYXVsdCA9IF9tZXRhbC5NaXhpbi5jcmVhdGUoKTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9taXhpbnMvZXZlbnRlZCIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9tZXRhbCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgKi8KCiAgLyoqCiAgICBUaGlzIG1peGluIGFsbG93cyBmb3IgRW1iZXIgb2JqZWN0cyB0byBzdWJzY3JpYmUgdG8gYW5kIGVtaXQgZXZlbnRzLgogIAogICAgYGBgYXBwL3V0aWxzL3BlcnNvbi5qcwogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IEV2ZW50ZWQgZnJvbSAnQGVtYmVyL29iamVjdC9ldmVudGVkJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IEVtYmVyT2JqZWN0LmV4dGVuZChFdmVudGVkLCB7CiAgICAgIGdyZWV0KCkgewogICAgICAgIC8vIC4uLgogICAgICAgIHRoaXMudHJpZ2dlcignZ3JlZXQnKTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciBwZXJzb24gPSBQZXJzb24uY3JlYXRlKCk7CiAgCiAgICBwZXJzb24ub24oJ2dyZWV0JywgZnVuY3Rpb24oKSB7CiAgICAgIGNvbnNvbGUubG9nKCdPdXIgcGVyc29uIGhhcyBncmVldGVkJyk7CiAgICB9KTsKICAKICAgIHBlcnNvbi5ncmVldCgpOwogIAogICAgLy8gb3V0cHV0czogJ091ciBwZXJzb24gaGFzIGdyZWV0ZWQnCiAgICBgYGAKICAKICAgIFlvdSBjYW4gYWxzbyBjaGFpbiBtdWx0aXBsZSBldmVudCBzdWJzY3JpcHRpb25zOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgcGVyc29uLm9uKCdncmVldCcsIGZ1bmN0aW9uKCkgewogICAgICBjb25zb2xlLmxvZygnT3VyIHBlcnNvbiBoYXMgZ3JlZXRlZCcpOwogICAgfSkub25lKCdncmVldCcsIGZ1bmN0aW9uKCkgewogICAgICBjb25zb2xlLmxvZygnT2ZmZXIgb25lLXRpbWUgc3BlY2lhbCcpOwogICAgfSkub2ZmKCdldmVudCcsIHRoaXMsIGZvcmdldFRoaXMpOwogICAgYGBgCiAgCiAgICBAY2xhc3MgRXZlbnRlZAogICAgQHB1YmxpYwogICAqLwogIHZhciBfZGVmYXVsdCA9IF9tZXRhbC5NaXhpbi5jcmVhdGUoewogICAgLyoqCiAgICAgIFN1YnNjcmliZXMgdG8gYSBuYW1lZCBldmVudCB3aXRoIGdpdmVuIGZ1bmN0aW9uLgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBwZXJzb24ub24oJ2RpZExvYWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAvLyBmaXJlZCBvbmNlIHRoZSBwZXJzb24gaGFzIGxvYWRlZAogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBBbiBvcHRpb25hbCB0YXJnZXQgY2FuIGJlIHBhc3NlZCBpbiBhcyB0aGUgMm5kIGFyZ3VtZW50IHRoYXQgd2lsbAogICAgICBiZSBzZXQgYXMgdGhlICJ0aGlzIiBmb3IgdGhlIGNhbGxiYWNrLiBUaGlzIGlzIGEgZ29vZCB3YXkgdG8gZ2l2ZSB5b3VyCiAgICAgIGZ1bmN0aW9uIGFjY2VzcyB0byB0aGUgb2JqZWN0IHRyaWdnZXJpbmcgdGhlIGV2ZW50LiBXaGVuIHRoZSB0YXJnZXQKICAgICAgcGFyYW1ldGVyIGlzIHVzZWQgdGhlIGNhbGxiYWNrIG1ldGhvZCBiZWNvbWVzIHRoZSB0aGlyZCBhcmd1bWVudC4KICAgICAgIEBtZXRob2Qgb24KICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGV2ZW50CiAgICAgIEBwYXJhbSB7T2JqZWN0fSBbdGFyZ2V0XSBUaGUgInRoaXMiIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjawogICAgICBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gbWV0aG9kIEEgZnVuY3Rpb24gb3IgdGhlIG5hbWUgb2YgYSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgb24gYHRhcmdldGAKICAgICAgQHJldHVybiB0aGlzCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBvbjogZnVuY3Rpb24gb24obmFtZSwgdGFyZ2V0LCBtZXRob2QpIHsKICAgICAgKDAsIF9tZXRhbC5hZGRMaXN0ZW5lcikodGhpcywgbmFtZSwgdGFyZ2V0LCBtZXRob2QpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqCiAgICAgIFN1YnNjcmliZXMgYSBmdW5jdGlvbiB0byBhIG5hbWVkIGV2ZW50IGFuZCB0aGVuIGNhbmNlbHMgdGhlIHN1YnNjcmlwdGlvbgogICAgICBhZnRlciB0aGUgZmlyc3QgdGltZSB0aGUgZXZlbnQgaXMgdHJpZ2dlcmVkLiBJdCBpcyBnb29kIHRvIHVzZSBgYG9uZWBgIHdoZW4KICAgICAgeW91IG9ubHkgY2FyZSBhYm91dCB0aGUgZmlyc3QgdGltZSBhbiBldmVudCBoYXMgdGFrZW4gcGxhY2UuCiAgICAgICBUaGlzIGZ1bmN0aW9uIHRha2VzIGFuIG9wdGlvbmFsIDJuZCBhcmd1bWVudCB0aGF0IHdpbGwgYmVjb21lIHRoZSAidGhpcyIKICAgICAgdmFsdWUgZm9yIHRoZSBjYWxsYmFjay4gV2hlbiB0aGUgdGFyZ2V0IHBhcmFtZXRlciBpcyB1c2VkIHRoZSBjYWxsYmFjayBtZXRob2QKICAgICAgYmVjb21lcyB0aGUgdGhpcmQgYXJndW1lbnQuCiAgICAgICBAbWV0aG9kIG9uZQogICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQKICAgICAgQHBhcmFtIHtPYmplY3R9IFt0YXJnZXRdIFRoZSAidGhpcyIgYmluZGluZyBmb3IgdGhlIGNhbGxiYWNrCiAgICAgIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgQSBmdW5jdGlvbiBvciB0aGUgbmFtZSBvZiBhIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBvbiBgdGFyZ2V0YAogICAgICBAcmV0dXJuIHRoaXMKICAgICAgQHB1YmxpYwogICAgKi8KICAgIG9uZTogZnVuY3Rpb24gb25lKG5hbWUsIHRhcmdldCwgbWV0aG9kKSB7CiAgICAgICgwLCBfbWV0YWwuYWRkTGlzdGVuZXIpKHRoaXMsIG5hbWUsIHRhcmdldCwgbWV0aG9kLCB0cnVlKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8qKgogICAgICBUcmlnZ2VycyBhIG5hbWVkIGV2ZW50IGZvciB0aGUgb2JqZWN0LiBBbnkgYWRkaXRpb25hbCBhcmd1bWVudHMKICAgICAgd2lsbCBiZSBwYXNzZWQgYXMgcGFyYW1ldGVycyB0byB0aGUgZnVuY3Rpb25zIHRoYXQgYXJlIHN1YnNjcmliZWQgdG8gdGhlCiAgICAgIGV2ZW50LgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBwZXJzb24ub24oJ2RpZEVhdCcsIGZ1bmN0aW9uKGZvb2QpIHsKICAgICAgICBjb25zb2xlLmxvZygncGVyc29uIGF0ZSBzb21lICcgKyBmb29kKTsKICAgICAgfSk7CiAgICAgICBwZXJzb24udHJpZ2dlcignZGlkRWF0JywgJ2Jyb2Njb2xpJyk7CiAgICAgICAvLyBvdXRwdXRzOiBwZXJzb24gYXRlIHNvbWUgYnJvY2NvbGkKICAgICAgYGBgCiAgICAgIEBtZXRob2QgdHJpZ2dlcgogICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQKICAgICAgQHBhcmFtIHtPYmplY3QuLi59IGFyZ3MgT3B0aW9uYWwgYXJndW1lbnRzIHRvIHBhc3Mgb24KICAgICAgQHB1YmxpYwogICAgKi8KICAgIHRyaWdnZXI6IGZ1bmN0aW9uIHRyaWdnZXIobmFtZSkgewogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuID4gMSA/IF9sZW4gLSAxIDogMCksIF9rZXkgPSAxOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgICgwLCBfbWV0YWwuc2VuZEV2ZW50KSh0aGlzLCBuYW1lLCBhcmdzKTsKICAgIH0sCgogICAgLyoqCiAgICAgIENhbmNlbHMgc3Vic2NyaXB0aW9uIGZvciBnaXZlbiBuYW1lLCB0YXJnZXQsIGFuZCBtZXRob2QuCiAgICAgICBAbWV0aG9kIG9mZgogICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQKICAgICAgQHBhcmFtIHtPYmplY3R9IHRhcmdldCBUaGUgdGFyZ2V0IG9mIHRoZSBzdWJzY3JpcHRpb24KICAgICAgQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IG1ldGhvZCBUaGUgZnVuY3Rpb24gb3IgdGhlIG5hbWUgb2YgYSBmdW5jdGlvbiBvZiB0aGUgc3Vic2NyaXB0aW9uCiAgICAgIEByZXR1cm4gdGhpcwogICAgICBAcHVibGljCiAgICAqLwogICAgb2ZmOiBmdW5jdGlvbiBvZmYobmFtZSwgdGFyZ2V0LCBtZXRob2QpIHsKICAgICAgKDAsIF9tZXRhbC5yZW1vdmVMaXN0ZW5lcikodGhpcywgbmFtZSwgdGFyZ2V0LCBtZXRob2QpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqCiAgICAgIENoZWNrcyB0byBzZWUgaWYgb2JqZWN0IGhhcyBhbnkgc3Vic2NyaXB0aW9ucyBmb3IgbmFtZWQgZXZlbnQuCiAgICAgICBAbWV0aG9kIGhhcwogICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQKICAgICAgQHJldHVybiB7Qm9vbGVhbn0gZG9lcyB0aGUgb2JqZWN0IGhhdmUgYSBzdWJzY3JpcHRpb24gZm9yIGV2ZW50CiAgICAgIEBwdWJsaWMKICAgICAqLwogICAgaGFzOiBmdW5jdGlvbiBoYXMobmFtZSkgewogICAgICByZXR1cm4gKDAsIF9tZXRhbC5oYXNMaXN0ZW5lcnMpKHRoaXMsIG5hbWUpOwogICAgfQogIH0pOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL21peGlucy9tdXRhYmxlX2VudW1lcmFibGUiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvbWl4aW5zL2VudW1lcmFibGUiLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZW51bWVyYWJsZSwgX21ldGFsKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICBUaGUgbWV0aG9kcyBpbiB0aGlzIG1peGluIGhhdmUgYmVlbiBtb3ZlZCB0byBNdXRhYmxlQXJyYXkuIFRoaXMgbWl4aW4gaGFzCiAgICBiZWVuIGludGVudGlvbmFsbHkgcHJlc2VydmVkIHRvIGF2b2lkIGJyZWFraW5nIE11dGFibGVFbnVtZXJhYmxlLmRldGVjdAogICAgY2hlY2tzIHVudGlsIHRoZSBjb21tdW5pdHkgbWlncmF0ZXMgYXdheSBmcm9tIHRoZW0uCiAgCiAgICBAY2xhc3MgTXV0YWJsZUVudW1lcmFibGUKICAgIEBuYW1lc3BhY2UgRW1iZXIKICAgIEB1c2VzIEVudW1lcmFibGUKICAgIEBwcml2YXRlCiAgKi8KICB2YXIgX2RlZmF1bHQgPSBfbWV0YWwuTWl4aW4uY3JlYXRlKF9lbnVtZXJhYmxlLmRlZmF1bHQpOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL21peGlucy9vYnNlcnZhYmxlIiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGFsIiwgIkBlbWJlci9kZWJ1ZyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9tZXRhbCwgX2RlYnVnKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICBAbW9kdWxlIEBlbWJlci9vYmplY3QKICAqLwoKICAvKioKICAgICMjIE92ZXJ2aWV3CiAgCiAgICBUaGlzIG1peGluIHByb3ZpZGVzIHByb3BlcnRpZXMgYW5kIHByb3BlcnR5IG9ic2VydmluZyBmdW5jdGlvbmFsaXR5LCBjb3JlCiAgICBmZWF0dXJlcyBvZiB0aGUgRW1iZXIgb2JqZWN0IG1vZGVsLgogIAogICAgUHJvcGVydGllcyBhbmQgb2JzZXJ2ZXJzIGFsbG93IG9uZSBvYmplY3QgdG8gb2JzZXJ2ZSBjaGFuZ2VzIHRvIGEKICAgIHByb3BlcnR5IG9uIGFub3RoZXIgb2JqZWN0LiBUaGlzIGlzIG9uZSBvZiB0aGUgZnVuZGFtZW50YWwgd2F5cyB0aGF0CiAgICBtb2RlbHMsIGNvbnRyb2xsZXJzIGFuZCB2aWV3cyBjb21tdW5pY2F0ZSB3aXRoIGVhY2ggb3RoZXIgaW4gYW4gRW1iZXIKICAgIGFwcGxpY2F0aW9uLgogIAogICAgQW55IG9iamVjdCB0aGF0IGhhcyB0aGlzIG1peGluIGFwcGxpZWQgY2FuIGJlIHVzZWQgaW4gb2JzZXJ2ZXIKICAgIG9wZXJhdGlvbnMuIFRoYXQgaW5jbHVkZXMgYEVtYmVyT2JqZWN0YCBhbmQgbW9zdCBvYmplY3RzIHlvdSB3aWxsCiAgICBpbnRlcmFjdCB3aXRoIGFzIHlvdSB3cml0ZSB5b3VyIEVtYmVyIGFwcGxpY2F0aW9uLgogIAogICAgTm90ZSB0aGF0IHlvdSB3aWxsIG5vdCBnZW5lcmFsbHkgYXBwbHkgdGhpcyBtaXhpbiB0byBjbGFzc2VzIHlvdXJzZWxmLAogICAgYnV0IHlvdSB3aWxsIHVzZSB0aGUgZmVhdHVyZXMgcHJvdmlkZWQgYnkgdGhpcyBtb2R1bGUgZnJlcXVlbnRseSwgc28gaXQKICAgIGlzIGltcG9ydGFudCB0byB1bmRlcnN0YW5kIGhvdyB0byB1c2UgaXQuCiAgCiAgICAjIyBVc2luZyBgZ2V0KClgIGFuZCBgc2V0KClgCiAgCiAgICBCZWNhdXNlIG9mIEVtYmVyJ3Mgc3VwcG9ydCBmb3IgYmluZGluZ3MgYW5kIG9ic2VydmVycywgeW91IHdpbGwgYWx3YXlzCiAgICBhY2Nlc3MgcHJvcGVydGllcyB1c2luZyB0aGUgZ2V0IG1ldGhvZCwgYW5kIHNldCBwcm9wZXJ0aWVzIHVzaW5nIHRoZQogICAgc2V0IG1ldGhvZC4gVGhpcyBhbGxvd3MgdGhlIG9ic2VydmluZyBvYmplY3RzIHRvIGJlIG5vdGlmaWVkIGFuZAogICAgY29tcHV0ZWQgcHJvcGVydGllcyB0byBiZSBoYW5kbGVkIHByb3Blcmx5LgogIAogICAgTW9yZSBkb2N1bWVudGF0aW9uIGFib3V0IGBnZXRgIGFuZCBgc2V0YCBhcmUgYmVsb3cuCiAgCiAgICAjIyBPYnNlcnZpbmcgUHJvcGVydHkgQ2hhbmdlcwogIAogICAgWW91IHR5cGljYWxseSBvYnNlcnZlIHByb3BlcnR5IGNoYW5nZXMgc2ltcGx5IGJ5IHVzaW5nIHRoZSBgb2JzZXJ2ZXJgCiAgICBmdW5jdGlvbiBpbiBjbGFzc2VzIHRoYXQgeW91IHdyaXRlLgogIAogICAgRm9yIGV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBvYnNlcnZlciB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgdmFsdWVPYnNlcnZlcjogb2JzZXJ2ZXIoJ3ZhbHVlJywgZnVuY3Rpb24oc2VuZGVyLCBrZXksIHZhbHVlLCByZXYpIHsKICAgICAgICAvLyBFeGVjdXRlcyB3aGVuZXZlciB0aGUgInZhbHVlIiBwcm9wZXJ0eSBjaGFuZ2VzCiAgICAgICAgLy8gU2VlIHRoZSBhZGRPYnNlcnZlciBtZXRob2QgZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGNhbGxiYWNrIGFyZ3VtZW50cwogICAgICB9KQogICAgfSk7CiAgICBgYGAKICAKICAgIEFsdGhvdWdoIHRoaXMgaXMgdGhlIG1vc3QgY29tbW9uIHdheSB0byBhZGQgYW4gb2JzZXJ2ZXIsIHRoaXMgY2FwYWJpbGl0eQogICAgaXMgYWN0dWFsbHkgYnVpbHQgaW50byB0aGUgYEVtYmVyT2JqZWN0YCBjbGFzcyBvbiB0b3Agb2YgdHdvIG1ldGhvZHMKICAgIGRlZmluZWQgaW4gdGhpcyBtaXhpbjogYGFkZE9ic2VydmVyYCBhbmQgYHJlbW92ZU9ic2VydmVyYC4gWW91IGNhbiB1c2UKICAgIHRoZXNlIHR3byBtZXRob2RzIHRvIGFkZCBhbmQgcmVtb3ZlIG9ic2VydmVycyB5b3Vyc2VsZiBpZiB5b3UgbmVlZCB0bwogICAgZG8gc28gYXQgcnVudGltZS4KICAKICAgIFRvIGFkZCBhbiBvYnNlcnZlciBmb3IgYSBwcm9wZXJ0eSwgY2FsbDoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIG9iamVjdC5hZGRPYnNlcnZlcigncHJvcGVydHlLZXknLCB0YXJnZXRPYmplY3QsIHRhcmdldEFjdGlvbikKICAgIGBgYAogIAogICAgVGhpcyB3aWxsIGNhbGwgdGhlIGB0YXJnZXRBY3Rpb25gIG1ldGhvZCBvbiB0aGUgYHRhcmdldE9iamVjdGAgd2hlbmV2ZXIKICAgIHRoZSB2YWx1ZSBvZiB0aGUgYHByb3BlcnR5S2V5YCBjaGFuZ2VzLgogIAogICAgTm90ZSB0aGF0IGlmIGBwcm9wZXJ0eUtleWAgaXMgYSBjb21wdXRlZCBwcm9wZXJ0eSwgdGhlIG9ic2VydmVyIHdpbGwgYmUKICAgIGNhbGxlZCB3aGVuIGFueSBvZiB0aGUgcHJvcGVydHkgZGVwZW5kZW5jaWVzIGFyZSBjaGFuZ2VkLCBldmVuIGlmIHRoZQogICAgcmVzdWx0aW5nIHZhbHVlIG9mIHRoZSBjb21wdXRlZCBwcm9wZXJ0eSBpcyB1bmNoYW5nZWQuIFRoaXMgaXMgbmVjZXNzYXJ5CiAgICBiZWNhdXNlIGNvbXB1dGVkIHByb3BlcnRpZXMgYXJlIG5vdCBjb21wdXRlZCB1bnRpbCBgZ2V0YCBpcyBjYWxsZWQuCiAgCiAgICBAY2xhc3MgT2JzZXJ2YWJsZQogICAgQHB1YmxpYwogICovCiAgdmFyIF9kZWZhdWx0ID0gX21ldGFsLk1peGluLmNyZWF0ZSh7CiAgICAvKioKICAgICAgUmV0cmlldmVzIHRoZSB2YWx1ZSBvZiBhIHByb3BlcnR5IGZyb20gdGhlIG9iamVjdC4KICAgICAgIFRoaXMgbWV0aG9kIGlzIHVzdWFsbHkgc2ltaWxhciB0byB1c2luZyBgb2JqZWN0W2tleU5hbWVdYCBvciBgb2JqZWN0LmtleU5hbWVgLAogICAgICBob3dldmVyIGl0IHN1cHBvcnRzIGJvdGggY29tcHV0ZWQgcHJvcGVydGllcyBhbmQgdGhlIHVua25vd25Qcm9wZXJ0eQogICAgICBoYW5kbGVyLgogICAgICAgQmVjYXVzZSBgZ2V0YCB1bmlmaWVzIHRoZSBzeW50YXggZm9yIGFjY2Vzc2luZyBhbGwgdGhlc2Uga2luZHMKICAgICAgb2YgcHJvcGVydGllcywgaXQgY2FuIG1ha2UgbWFueSByZWZhY3RvcmluZ3MgZWFzaWVyLCBzdWNoIGFzIHJlcGxhY2luZyBhCiAgICAgIHNpbXBsZSBwcm9wZXJ0eSB3aXRoIGEgY29tcHV0ZWQgcHJvcGVydHksIG9yIHZpY2UgdmVyc2EuCiAgICAgICAjIyMgQ29tcHV0ZWQgUHJvcGVydGllcwogICAgICAgQ29tcHV0ZWQgcHJvcGVydGllcyBhcmUgbWV0aG9kcyBkZWZpbmVkIHdpdGggdGhlIGBwcm9wZXJ0eWAgbW9kaWZpZXIKICAgICAgZGVjbGFyZWQgYXQgdGhlIGVuZCwgc3VjaCBhczoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IHsgY29tcHV0ZWQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICAgIGZ1bGxOYW1lOiBjb21wdXRlZCgnZmlyc3ROYW1lJywgJ2xhc3ROYW1lJywgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KCdmaXJzdE5hbWUnKSArICcgJyArIHRoaXMuZ2V0KCdsYXN0TmFtZScpOwogICAgICB9KQogICAgICBgYGAKICAgICAgIFdoZW4geW91IGNhbGwgYGdldGAgb24gYSBjb21wdXRlZCBwcm9wZXJ0eSwgdGhlIGZ1bmN0aW9uIHdpbGwgYmUKICAgICAgY2FsbGVkIGFuZCB0aGUgcmV0dXJuIHZhbHVlIHdpbGwgYmUgcmV0dXJuZWQgaW5zdGVhZCBvZiB0aGUgZnVuY3Rpb24KICAgICAgaXRzZWxmLgogICAgICAgIyMjIFVua25vd24gUHJvcGVydGllcwogICAgICAgTGlrZXdpc2UsIGlmIHlvdSB0cnkgdG8gY2FsbCBgZ2V0YCBvbiBhIHByb3BlcnR5IHdob3NlIHZhbHVlIGlzCiAgICAgIGB1bmRlZmluZWRgLCB0aGUgYHVua25vd25Qcm9wZXJ0eSgpYCBtZXRob2Qgd2lsbCBiZSBjYWxsZWQgb24gdGhlIG9iamVjdC4KICAgICAgSWYgdGhpcyBtZXRob2QgcmV0dXJucyBhbnkgdmFsdWUgb3RoZXIgdGhhbiBgdW5kZWZpbmVkYCwgaXQgd2lsbCBiZSByZXR1cm5lZAogICAgICBpbnN0ZWFkLiBUaGlzIGFsbG93cyB5b3UgdG8gaW1wbGVtZW50ICJ2aXJ0dWFsIiBwcm9wZXJ0aWVzIHRoYXQgYXJlCiAgICAgIG5vdCBkZWZpbmVkIHVwZnJvbnQuCiAgICAgICBAbWV0aG9kIGdldAogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgcHJvcGVydHkgdG8gcmV0cmlldmUKICAgICAgQHJldHVybiB7T2JqZWN0fSBUaGUgcHJvcGVydHkgdmFsdWUgb3IgdW5kZWZpbmVkLgogICAgICBAcHVibGljCiAgICAqLwogICAgZ2V0OiBmdW5jdGlvbiBnZXQoa2V5TmFtZSkgewogICAgICByZXR1cm4gKDAsIF9tZXRhbC5nZXQpKHRoaXMsIGtleU5hbWUpOwogICAgfSwKCiAgICAvKioKICAgICAgVG8gZ2V0IHRoZSB2YWx1ZXMgb2YgbXVsdGlwbGUgcHJvcGVydGllcyBhdCBvbmNlLCBjYWxsIGBnZXRQcm9wZXJ0aWVzYAogICAgICB3aXRoIGEgbGlzdCBvZiBzdHJpbmdzIG9yIGFuIGFycmF5OgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICByZWNvcmQuZ2V0UHJvcGVydGllcygnZmlyc3ROYW1lJywgJ2xhc3ROYW1lJywgJ3ppcENvZGUnKTsKICAgICAgLy8geyBmaXJzdE5hbWU6ICdKb2huJywgbGFzdE5hbWU6ICdEb2UnLCB6aXBDb2RlOiAnMTAwMTEnIH0KICAgICAgYGBgCiAgICAgICBpcyBlcXVpdmFsZW50IHRvOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICByZWNvcmQuZ2V0UHJvcGVydGllcyhbJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScsICd6aXBDb2RlJ10pOwogICAgICAvLyB7IGZpcnN0TmFtZTogJ0pvaG4nLCBsYXN0TmFtZTogJ0RvZScsIHppcENvZGU6ICcxMDAxMScgfQogICAgICBgYGAKICAgICAgIEBtZXRob2QgZ2V0UHJvcGVydGllcwogICAgICBAcGFyYW0ge1N0cmluZy4uLnxBcnJheX0gbGlzdCBvZiBrZXlzIHRvIGdldAogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAgIEBwdWJsaWMKICAgICovCiAgICBnZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbiBnZXRQcm9wZXJ0aWVzKCkgewogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CgogICAgICByZXR1cm4gX21ldGFsLmdldFByb3BlcnRpZXMuYXBwbHkodm9pZCAwLCBbdGhpc10uY29uY2F0KGFyZ3MpKTsKICAgIH0sCgogICAgLyoqCiAgICAgIFNldHMgdGhlIHByb3ZpZGVkIGtleSBvciBwYXRoIHRvIHRoZSB2YWx1ZS4KICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgcmVjb3JkLnNldCgia2V5IiwgdmFsdWUpOwogICAgICBgYGAKICAgICAgIFRoaXMgbWV0aG9kIGlzIGdlbmVyYWxseSB2ZXJ5IHNpbWlsYXIgdG8gY2FsbGluZyBgb2JqZWN0WyJrZXkiXSA9IHZhbHVlYCBvcgogICAgICBgb2JqZWN0LmtleSA9IHZhbHVlYCwgZXhjZXB0IHRoYXQgaXQgcHJvdmlkZXMgc3VwcG9ydCBmb3IgY29tcHV0ZWQKICAgICAgcHJvcGVydGllcywgdGhlIGBzZXRVbmtub3duUHJvcGVydHkoKWAgbWV0aG9kIGFuZCBwcm9wZXJ0eSBvYnNlcnZlcnMuCiAgICAgICAjIyMgQ29tcHV0ZWQgUHJvcGVydGllcwogICAgICAgSWYgeW91IHRyeSB0byBzZXQgYSB2YWx1ZSBvbiBhIGtleSB0aGF0IGhhcyBhIGNvbXB1dGVkIHByb3BlcnR5IGhhbmRsZXIKICAgICAgZGVmaW5lZCAoc2VlIHRoZSBgZ2V0KClgIG1ldGhvZCBmb3IgYW4gZXhhbXBsZSksIHRoZW4gYHNldCgpYCB3aWxsIGNhbGwKICAgICAgdGhhdCBtZXRob2QsIHBhc3NpbmcgYm90aCB0aGUgdmFsdWUgYW5kIGtleSBpbnN0ZWFkIG9mIHNpbXBseSBjaGFuZ2luZwogICAgICB0aGUgdmFsdWUgaXRzZWxmLiBUaGlzIGlzIHVzZWZ1bCBmb3IgdGhvc2UgdGltZXMgd2hlbiB5b3UgbmVlZCB0bwogICAgICBpbXBsZW1lbnQgYSBwcm9wZXJ0eSB0aGF0IGlzIGNvbXBvc2VkIG9mIG9uZSBvciBtb3JlIG1lbWJlcgogICAgICBwcm9wZXJ0aWVzLgogICAgICAgIyMjIFVua25vd24gUHJvcGVydGllcwogICAgICAgSWYgeW91IHRyeSB0byBzZXQgYSB2YWx1ZSBvbiBhIGtleSB0aGF0IGlzIHVuZGVmaW5lZCBpbiB0aGUgdGFyZ2V0CiAgICAgIG9iamVjdCwgdGhlbiB0aGUgYHNldFVua25vd25Qcm9wZXJ0eSgpYCBoYW5kbGVyIHdpbGwgYmUgY2FsbGVkIGluc3RlYWQuIFRoaXMKICAgICAgZ2l2ZXMgeW91IGFuIG9wcG9ydHVuaXR5IHRvIGltcGxlbWVudCBjb21wbGV4ICJ2aXJ0dWFsIiBwcm9wZXJ0aWVzIHRoYXQKICAgICAgYXJlIG5vdCBwcmVkZWZpbmVkIG9uIHRoZSBvYmplY3QuIElmIGBzZXRVbmtub3duUHJvcGVydHkoKWAgcmV0dXJucwogICAgICB1bmRlZmluZWQsIHRoZW4gYHNldCgpYCB3aWxsIHNpbXBseSBzZXQgdGhlIHZhbHVlIG9uIHRoZSBvYmplY3QuCiAgICAgICAjIyMgUHJvcGVydHkgT2JzZXJ2ZXJzCiAgICAgICBJbiBhZGRpdGlvbiB0byBjaGFuZ2luZyB0aGUgcHJvcGVydHksIGBzZXQoKWAgd2lsbCBhbHNvIHJlZ2lzdGVyIGEgcHJvcGVydHkKICAgICAgY2hhbmdlIHdpdGggdGhlIG9iamVjdC4gVW5sZXNzIHlvdSBoYXZlIHBsYWNlZCB0aGlzIGNhbGwgaW5zaWRlIG9mIGEKICAgICAgYGJlZ2luUHJvcGVydHlDaGFuZ2VzKClgIGFuZCBgZW5kUHJvcGVydHlDaGFuZ2VzKCksYCBhbnkgImxvY2FsIiBvYnNlcnZlcnMKICAgICAgKGkuZS4gb2JzZXJ2ZXIgbWV0aG9kcyBkZWNsYXJlZCBvbiB0aGUgc2FtZSBvYmplY3QpLCB3aWxsIGJlIGNhbGxlZAogICAgICBpbW1lZGlhdGVseS4gQW55ICJyZW1vdGUiIG9ic2VydmVycyAoaS5lLiBvYnNlcnZlciBtZXRob2RzIGRlY2xhcmVkIG9uCiAgICAgIGFub3RoZXIgb2JqZWN0KSB3aWxsIGJlIHBsYWNlZCBpbiBhIHF1ZXVlIGFuZCBjYWxsZWQgYXQgYSBsYXRlciB0aW1lIGluIGEKICAgICAgY29hbGVzY2VkIG1hbm5lci4KICAgICAgIEBtZXRob2Qgc2V0CiAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXlOYW1lIFRoZSBwcm9wZXJ0eSB0byBzZXQKICAgICAgQHBhcmFtIHtPYmplY3R9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZXQgb3IgYG51bGxgLgogICAgICBAcmV0dXJuIHtPYmplY3R9IFRoZSBwYXNzZWQgdmFsdWUKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHNldDogZnVuY3Rpb24gc2V0KGtleU5hbWUsIHZhbHVlKSB7CiAgICAgIHJldHVybiAoMCwgX21ldGFsLnNldCkodGhpcywga2V5TmFtZSwgdmFsdWUpOwogICAgfSwKCiAgICAvKioKICAgICAgU2V0cyBhIGxpc3Qgb2YgcHJvcGVydGllcyBhdCBvbmNlLiBUaGVzZSBwcm9wZXJ0aWVzIGFyZSBzZXQgaW5zaWRlCiAgICAgIGEgc2luZ2xlIGBiZWdpblByb3BlcnR5Q2hhbmdlc2AgYW5kIGBlbmRQcm9wZXJ0eUNoYW5nZXNgIGJhdGNoLCBzbwogICAgICBvYnNlcnZlcnMgd2lsbCBiZSBidWZmZXJlZC4KICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgcmVjb3JkLnNldFByb3BlcnRpZXMoeyBmaXJzdE5hbWU6ICdDaGFybGVzJywgbGFzdE5hbWU6ICdKb2xsZXknIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2Qgc2V0UHJvcGVydGllcwogICAgICBAcGFyYW0ge09iamVjdH0gaGFzaCB0aGUgaGFzaCBvZiBrZXlzIGFuZCB2YWx1ZXMgdG8gc2V0CiAgICAgIEByZXR1cm4ge09iamVjdH0gVGhlIHBhc3NlZCBpbiBoYXNoCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBzZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbiBzZXRQcm9wZXJ0aWVzKGhhc2gpIHsKICAgICAgcmV0dXJuICgwLCBfbWV0YWwuc2V0UHJvcGVydGllcykodGhpcywgaGFzaCk7CiAgICB9LAoKICAgIC8qKgogICAgICBCZWdpbnMgYSBncm91cGluZyBvZiBwcm9wZXJ0eSBjaGFuZ2VzLgogICAgICAgWW91IGNhbiB1c2UgdGhpcyBtZXRob2QgdG8gZ3JvdXAgcHJvcGVydHkgY2hhbmdlcyBzbyB0aGF0IG5vdGlmaWNhdGlvbnMKICAgICAgd2lsbCBub3QgYmUgc2VudCB1bnRpbCB0aGUgY2hhbmdlcyBhcmUgZmluaXNoZWQuIElmIHlvdSBwbGFuIHRvIG1ha2UgYQogICAgICBsYXJnZSBudW1iZXIgb2YgY2hhbmdlcyB0byBhbiBvYmplY3QgYXQgb25lIHRpbWUsIHlvdSBzaG91bGQgY2FsbCB0aGlzCiAgICAgIG1ldGhvZCBhdCB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjaGFuZ2VzIHRvIGJlZ2luIGRlZmVycmluZyBjaGFuZ2UKICAgICAgbm90aWZpY2F0aW9ucy4gV2hlbiB5b3UgYXJlIGRvbmUgbWFraW5nIGNoYW5nZXMsIGNhbGwKICAgICAgYGVuZFByb3BlcnR5Q2hhbmdlcygpYCB0byBkZWxpdmVyIHRoZSBkZWZlcnJlZCBjaGFuZ2Ugbm90aWZpY2F0aW9ucyBhbmQgZW5kCiAgICAgIGRlZmVycmluZy4KICAgICAgIEBtZXRob2QgYmVnaW5Qcm9wZXJ0eUNoYW5nZXMKICAgICAgQHJldHVybiB7T2JzZXJ2YWJsZX0KICAgICAgQHByaXZhdGUKICAgICovCiAgICBiZWdpblByb3BlcnR5Q2hhbmdlczogZnVuY3Rpb24gYmVnaW5Qcm9wZXJ0eUNoYW5nZXMoKSB7CiAgICAgICgwLCBfbWV0YWwuYmVnaW5Qcm9wZXJ0eUNoYW5nZXMpKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvKioKICAgICAgRW5kcyBhIGdyb3VwaW5nIG9mIHByb3BlcnR5IGNoYW5nZXMuCiAgICAgICBZb3UgY2FuIHVzZSB0aGlzIG1ldGhvZCB0byBncm91cCBwcm9wZXJ0eSBjaGFuZ2VzIHNvIHRoYXQgbm90aWZpY2F0aW9ucwogICAgICB3aWxsIG5vdCBiZSBzZW50IHVudGlsIHRoZSBjaGFuZ2VzIGFyZSBmaW5pc2hlZC4gSWYgeW91IHBsYW4gdG8gbWFrZSBhCiAgICAgIGxhcmdlIG51bWJlciBvZiBjaGFuZ2VzIHRvIGFuIG9iamVjdCBhdCBvbmUgdGltZSwgeW91IHNob3VsZCBjYWxsCiAgICAgIGBiZWdpblByb3BlcnR5Q2hhbmdlcygpYCBhdCB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjaGFuZ2VzIHRvIGRlZmVyIGNoYW5nZQogICAgICBub3RpZmljYXRpb25zLiBXaGVuIHlvdSBhcmUgZG9uZSBtYWtpbmcgY2hhbmdlcywgY2FsbCB0aGlzIG1ldGhvZCB0bwogICAgICBkZWxpdmVyIHRoZSBkZWZlcnJlZCBjaGFuZ2Ugbm90aWZpY2F0aW9ucyBhbmQgZW5kIGRlZmVycmluZy4KICAgICAgIEBtZXRob2QgZW5kUHJvcGVydHlDaGFuZ2VzCiAgICAgIEByZXR1cm4ge09ic2VydmFibGV9CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgZW5kUHJvcGVydHlDaGFuZ2VzOiBmdW5jdGlvbiBlbmRQcm9wZXJ0eUNoYW5nZXMoKSB7CiAgICAgICgwLCBfbWV0YWwuZW5kUHJvcGVydHlDaGFuZ2VzKSgpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqCiAgICAgIE5vdGlmeSB0aGUgb2JzZXJ2ZXIgc3lzdGVtIHRoYXQgYSBwcm9wZXJ0eSBoYXMganVzdCBjaGFuZ2VkLgogICAgICAgU29tZXRpbWVzIHlvdSBuZWVkIHRvIGNoYW5nZSBhIHZhbHVlIGRpcmVjdGx5IG9yIGluZGlyZWN0bHkgd2l0aG91dAogICAgICBhY3R1YWxseSBjYWxsaW5nIGBnZXQoKWAgb3IgYHNldCgpYCBvbiBpdC4gSW4gdGhpcyBjYXNlLCB5b3UgY2FuIHVzZSB0aGlzCiAgICAgIG1ldGhvZCBpbnN0ZWFkLiBDYWxsaW5nIHRoaXMgbWV0aG9kIHdpbGwgbm90aWZ5IGFsbCBvYnNlcnZlcnMgdGhhdCB0aGUKICAgICAgcHJvcGVydHkgaGFzIHBvdGVudGlhbGx5IGNoYW5nZWQgdmFsdWUuCiAgICAgICBAbWV0aG9kIG5vdGlmeVByb3BlcnR5Q2hhbmdlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXlOYW1lIFRoZSBwcm9wZXJ0eSBrZXkgdG8gYmUgbm90aWZpZWQgYWJvdXQuCiAgICAgIEByZXR1cm4ge09ic2VydmFibGV9CiAgICAgIEBwdWJsaWMKICAgICovCiAgICBub3RpZnlQcm9wZXJ0eUNoYW5nZTogZnVuY3Rpb24gbm90aWZ5UHJvcGVydHlDaGFuZ2Uoa2V5TmFtZSkgewogICAgICAoMCwgX21ldGFsLm5vdGlmeVByb3BlcnR5Q2hhbmdlKSh0aGlzLCBrZXlOYW1lKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8qKgogICAgICBBZGRzIGFuIG9ic2VydmVyIG9uIGEgcHJvcGVydHkuCiAgICAgICBUaGlzIGlzIHRoZSBjb3JlIG1ldGhvZCB1c2VkIHRvIHJlZ2lzdGVyIGFuIG9ic2VydmVyIGZvciBhIHByb3BlcnR5LgogICAgICAgT25jZSB5b3UgY2FsbCB0aGlzIG1ldGhvZCwgYW55IHRpbWUgdGhlIGtleSdzIHZhbHVlIGlzIHNldCwgeW91ciBvYnNlcnZlcgogICAgICB3aWxsIGJlIG5vdGlmaWVkLiBOb3RlIHRoYXQgdGhlIG9ic2VydmVycyBhcmUgdHJpZ2dlcmVkIGFueSB0aW1lIHRoZQogICAgICB2YWx1ZSBpcyBzZXQsIHJlZ2FyZGxlc3Mgb2Ygd2hldGhlciBpdCBoYXMgYWN0dWFsbHkgY2hhbmdlZC4gWW91cgogICAgICBvYnNlcnZlciBzaG91bGQgYmUgcHJlcGFyZWQgdG8gaGFuZGxlIHRoYXQuCiAgICAgICBUaGVyZSBhcmUgdHdvIGNvbW1vbiBpbnZvY2F0aW9uIHBhdHRlcm5zIGZvciBgLmFkZE9ic2VydmVyKClgOgogICAgICAgLSBQYXNzaW5nIHR3byBhcmd1bWVudHM6CiAgICAgICAgLSB0aGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgdG8gb2JzZXJ2ZSAoYXMgYSBzdHJpbmcpCiAgICAgICAgLSB0aGUgZnVuY3Rpb24gdG8gaW52b2tlIChhbiBhY3R1YWwgZnVuY3Rpb24pCiAgICAgIC0gUGFzc2luZyB0aHJlZSBhcmd1bWVudHM6CiAgICAgICAgLSB0aGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgdG8gb2JzZXJ2ZSAoYXMgYSBzdHJpbmcpCiAgICAgICAgLSB0aGUgdGFyZ2V0IG9iamVjdCAod2lsbCBiZSB1c2VkIHRvIGxvb2sgdXAgYW5kIGludm9rZSBhCiAgICAgICAgICBmdW5jdGlvbiBvbikKICAgICAgICAtIHRoZSBuYW1lIG9mIHRoZSBmdW5jdGlvbiB0byBpbnZva2Ugb24gdGhlIHRhcmdldCBvYmplY3QKICAgICAgICAgIChhcyBhIHN0cmluZykuCiAgICAgICBgYGBhcHAvY29tcG9uZW50cy9teS1jb21wb25lbnQuanMKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGluaXQoKSB7CiAgICAgICAgICB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpOwogICAgICAgICAgIC8vIHRoZSBmb2xsb3dpbmcgYXJlIGVxdWl2YWxlbnQ6CiAgICAgICAgICAgLy8gdXNpbmcgdGhyZWUgYXJndW1lbnRzCiAgICAgICAgICB0aGlzLmFkZE9ic2VydmVyKCdmb28nLCB0aGlzLCAnZm9vRGlkQ2hhbmdlJyk7CiAgICAgICAgICAgLy8gdXNpbmcgdHdvIGFyZ3VtZW50cwogICAgICAgICAgdGhpcy5hZGRPYnNlcnZlcignZm9vJywgKC4uLmFyZ3MpID0+IHsKICAgICAgICAgICAgdGhpcy5mb29EaWRDaGFuZ2UoLi4uYXJncyk7CiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgICBmb29EaWRDaGFuZ2UoKSB7CiAgICAgICAgICAvLyB5b3VyIGN1c3RvbSBsb2dpYyBjb2RlCiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICAjIyMgT2JzZXJ2ZXIgTWV0aG9kcwogICAgICAgT2JzZXJ2ZXIgbWV0aG9kcyBoYXZlIHRoZSBmb2xsb3dpbmcgc2lnbmF0dXJlOgogICAgICAgYGBgYXBwL2NvbXBvbmVudHMvbXktY29tcG9uZW50LmpzCiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBpbml0KCkgewogICAgICAgICAgdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgICAgICAgIHRoaXMuYWRkT2JzZXJ2ZXIoJ2ZvbycsIHRoaXMsICdmb29EaWRDaGFuZ2UnKTsKICAgICAgICB9LAogICAgICAgICBmb29EaWRDaGFuZ2Uoc2VuZGVyLCBrZXksIHZhbHVlLCByZXYpIHsKICAgICAgICAgIC8vIHlvdXIgY29kZQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgVGhlIGBzZW5kZXJgIGlzIHRoZSBvYmplY3QgdGhhdCBjaGFuZ2VkLiBUaGUgYGtleWAgaXMgdGhlIHByb3BlcnR5IHRoYXQKICAgICAgY2hhbmdlcy4gVGhlIGB2YWx1ZWAgcHJvcGVydHkgaXMgY3VycmVudGx5IHJlc2VydmVkIGFuZCB1bnVzZWQuIFRoZSBgcmV2YAogICAgICBpcyB0aGUgbGFzdCBwcm9wZXJ0eSByZXZpc2lvbiBvZiB0aGUgb2JqZWN0IHdoZW4gaXQgY2hhbmdlZCwgd2hpY2ggeW91IGNhbgogICAgICB1c2UgdG8gZGV0ZWN0IGlmIHRoZSBrZXkgdmFsdWUgaGFzIHJlYWxseSBjaGFuZ2VkIG9yIG5vdC4KICAgICAgIFVzdWFsbHkgeW91IHdpbGwgbm90IG5lZWQgdGhlIHZhbHVlIG9yIHJldmlzaW9uIHBhcmFtZXRlcnMgYXQKICAgICAgdGhlIGVuZC4gSW4gdGhpcyBjYXNlLCBpdCBpcyBjb21tb24gdG8gd3JpdGUgb2JzZXJ2ZXIgbWV0aG9kcyB0aGF0IHRha2UKICAgICAgb25seSBhIHNlbmRlciBhbmQga2V5IHZhbHVlIGFzIHBhcmFtZXRlcnMgb3IsIGlmIHlvdSBhcmVuJ3QgaW50ZXJlc3RlZCBpbgogICAgICBhbnkgb2YgdGhlc2UgdmFsdWVzLCB0byB3cml0ZSBhbiBvYnNlcnZlciB0aGF0IGhhcyBubyBwYXJhbWV0ZXJzIGF0IGFsbC4KICAgICAgIEBtZXRob2QgYWRkT2JzZXJ2ZXIKICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleSBUaGUga2V5IHRvIG9ic2VydmUKICAgICAgQHBhcmFtIHtPYmplY3R9IHRhcmdldCBUaGUgdGFyZ2V0IG9iamVjdCB0byBpbnZva2UKICAgICAgQHBhcmFtIHtTdHJpbmd8RnVuY3Rpb259IG1ldGhvZCBUaGUgbWV0aG9kIHRvIGludm9rZQogICAgICBAcGFyYW0ge0Jvb2xlYW59IHN5bmMgV2hldGhlciB0aGUgb2JzZXJ2ZXIgaXMgc3luYyBvciBub3QKICAgICAgQHJldHVybiB7T2JzZXJ2YWJsZX0KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGFkZE9ic2VydmVyOiBmdW5jdGlvbiBhZGRPYnNlcnZlcihrZXksIHRhcmdldCwgbWV0aG9kLCBzeW5jKSB7CiAgICAgICgwLCBfbWV0YWwuYWRkT2JzZXJ2ZXIpKHRoaXMsIGtleSwgdGFyZ2V0LCBtZXRob2QsIHN5bmMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqCiAgICAgIFJlbW92ZSBhbiBvYnNlcnZlciB5b3UgaGF2ZSBwcmV2aW91c2x5IHJlZ2lzdGVyZWQgb24gdGhpcyBvYmplY3QuIFBhc3MKICAgICAgdGhlIHNhbWUga2V5LCB0YXJnZXQsIGFuZCBtZXRob2QgeW91IHBhc3NlZCB0byBgYWRkT2JzZXJ2ZXIoKWAgYW5kIHlvdXIKICAgICAgdGFyZ2V0IHdpbGwgbm8gbG9uZ2VyIHJlY2VpdmUgbm90aWZpY2F0aW9ucy4KICAgICAgIEBtZXRob2QgcmVtb3ZlT2JzZXJ2ZXIKICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleSBUaGUga2V5IHRvIG9ic2VydmUKICAgICAgQHBhcmFtIHtPYmplY3R9IHRhcmdldCBUaGUgdGFyZ2V0IG9iamVjdCB0byBpbnZva2UKICAgICAgQHBhcmFtIHtTdHJpbmd8RnVuY3Rpb259IG1ldGhvZCBUaGUgbWV0aG9kIHRvIGludm9rZQogICAgICBAcGFyYW0ge0Jvb2xlYW59IHN5bmMgV2hldGhlciB0aGUgb2JzZXJ2ZXIgaXMgYXN5bmMgb3Igbm90CiAgICAgIEByZXR1cm4ge09ic2VydmFibGV9CiAgICAgIEBwdWJsaWMKICAgICovCiAgICByZW1vdmVPYnNlcnZlcjogZnVuY3Rpb24gcmVtb3ZlT2JzZXJ2ZXIoa2V5LCB0YXJnZXQsIG1ldGhvZCwgc3luYykgewogICAgICAoMCwgX21ldGFsLnJlbW92ZU9ic2VydmVyKSh0aGlzLCBrZXksIHRhcmdldCwgbWV0aG9kLCBzeW5jKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8qKgogICAgICBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgb2JqZWN0IGN1cnJlbnRseSBoYXMgb2JzZXJ2ZXJzIHJlZ2lzdGVyZWQgZm9yIGEKICAgICAgcGFydGljdWxhciBrZXkuIFlvdSBjYW4gdXNlIHRoaXMgbWV0aG9kIHRvIHBvdGVudGlhbGx5IGRlZmVyIHBlcmZvcm1pbmcKICAgICAgYW4gZXhwZW5zaXZlIGFjdGlvbiB1bnRpbCBzb21lb25lIGJlZ2lucyBvYnNlcnZpbmcgYSBwYXJ0aWN1bGFyIHByb3BlcnR5CiAgICAgIG9uIHRoZSBvYmplY3QuCiAgICAgICBAbWV0aG9kIGhhc09ic2VydmVyRm9yCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkgS2V5IHRvIGNoZWNrCiAgICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgaGFzT2JzZXJ2ZXJGb3I6IGZ1bmN0aW9uIGhhc09ic2VydmVyRm9yKGtleSkgewogICAgICByZXR1cm4gKDAsIF9tZXRhbC5oYXNMaXN0ZW5lcnMpKHRoaXMsIGtleSArICI6Y2hhbmdlIik7CiAgICB9LAoKICAgIC8qKgogICAgICBSZXRyaWV2ZXMgdGhlIHZhbHVlIG9mIGEgcHJvcGVydHksIG9yIGEgZGVmYXVsdCB2YWx1ZSBpbiB0aGUgY2FzZSB0aGF0IHRoZQogICAgICBwcm9wZXJ0eSByZXR1cm5zIGB1bmRlZmluZWRgLgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBwZXJzb24uZ2V0V2l0aERlZmF1bHQoJ2xhc3ROYW1lJywgJ0RvZScpOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgZ2V0V2l0aERlZmF1bHQKICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleU5hbWUgVGhlIG5hbWUgb2YgdGhlIHByb3BlcnR5IHRvIHJldHJpZXZlCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBkZWZhdWx0VmFsdWUgVGhlIHZhbHVlIHRvIHJldHVybiBpZiB0aGUgcHJvcGVydHkgdmFsdWUgaXMgdW5kZWZpbmVkCiAgICAgIEByZXR1cm4ge09iamVjdH0gVGhlIHByb3BlcnR5IHZhbHVlIG9yIHRoZSBkZWZhdWx0VmFsdWUuCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBnZXRXaXRoRGVmYXVsdDogZnVuY3Rpb24gZ2V0V2l0aERlZmF1bHQoa2V5TmFtZSwgZGVmYXVsdFZhbHVlKSB7CiAgICAgIHJldHVybiAoMCwgX21ldGFsLmdldFdpdGhEZWZhdWx0KSh0aGlzLCBrZXlOYW1lLCBkZWZhdWx0VmFsdWUpOwogICAgfSwKCiAgICAvKioKICAgICAgU2V0IHRoZSB2YWx1ZSBvZiBhIHByb3BlcnR5IHRvIHRoZSBjdXJyZW50IHZhbHVlIHBsdXMgc29tZSBhbW91bnQuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHBlcnNvbi5pbmNyZW1lbnRQcm9wZXJ0eSgnYWdlJyk7CiAgICAgIHRlYW0uaW5jcmVtZW50UHJvcGVydHkoJ3Njb3JlJywgMik7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBpbmNyZW1lbnRQcm9wZXJ0eQogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgdG8gaW5jcmVtZW50CiAgICAgIEBwYXJhbSB7TnVtYmVyfSBpbmNyZW1lbnQgVGhlIGFtb3VudCB0byBpbmNyZW1lbnQgYnkuIERlZmF1bHRzIHRvIDEKICAgICAgQHJldHVybiB7TnVtYmVyfSBUaGUgbmV3IHByb3BlcnR5IHZhbHVlCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBpbmNyZW1lbnRQcm9wZXJ0eTogZnVuY3Rpb24gaW5jcmVtZW50UHJvcGVydHkoa2V5TmFtZSwgaW5jcmVtZW50KSB7CiAgICAgIGlmIChpbmNyZW1lbnQgPT09IHZvaWQgMCkgewogICAgICAgIGluY3JlbWVudCA9IDE7CiAgICAgIH0KCiAgICAgIChmYWxzZSAmJiAhKCFpc05hTihwYXJzZUZsb2F0KGluY3JlbWVudCkpICYmIGlzRmluaXRlKGluY3JlbWVudCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnTXVzdCBwYXNzIGEgbnVtZXJpYyB2YWx1ZSB0byBpbmNyZW1lbnRQcm9wZXJ0eScsICFpc05hTihwYXJzZUZsb2F0KGluY3JlbWVudCkpICYmIGlzRmluaXRlKGluY3JlbWVudCkpKTsKICAgICAgcmV0dXJuICgwLCBfbWV0YWwuc2V0KSh0aGlzLCBrZXlOYW1lLCAocGFyc2VGbG9hdCgoMCwgX21ldGFsLmdldCkodGhpcywga2V5TmFtZSkpIHx8IDApICsgaW5jcmVtZW50KTsKICAgIH0sCgogICAgLyoqCiAgICAgIFNldCB0aGUgdmFsdWUgb2YgYSBwcm9wZXJ0eSB0byB0aGUgY3VycmVudCB2YWx1ZSBtaW51cyBzb21lIGFtb3VudC4KICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgcGxheWVyLmRlY3JlbWVudFByb3BlcnR5KCdsaXZlcycpOwogICAgICBvcmMuZGVjcmVtZW50UHJvcGVydHkoJ2hlYWx0aCcsIDUpOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgZGVjcmVtZW50UHJvcGVydHkKICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleU5hbWUgVGhlIG5hbWUgb2YgdGhlIHByb3BlcnR5IHRvIGRlY3JlbWVudAogICAgICBAcGFyYW0ge051bWJlcn0gZGVjcmVtZW50IFRoZSBhbW91bnQgdG8gZGVjcmVtZW50IGJ5LiBEZWZhdWx0cyB0byAxCiAgICAgIEByZXR1cm4ge051bWJlcn0gVGhlIG5ldyBwcm9wZXJ0eSB2YWx1ZQogICAgICBAcHVibGljCiAgICAqLwogICAgZGVjcmVtZW50UHJvcGVydHk6IGZ1bmN0aW9uIGRlY3JlbWVudFByb3BlcnR5KGtleU5hbWUsIGRlY3JlbWVudCkgewogICAgICBpZiAoZGVjcmVtZW50ID09PSB2b2lkIDApIHsKICAgICAgICBkZWNyZW1lbnQgPSAxOwogICAgICB9CgogICAgICAoZmFsc2UgJiYgISghaXNOYU4ocGFyc2VGbG9hdChkZWNyZW1lbnQpKSAmJiBpc0Zpbml0ZShkZWNyZW1lbnQpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ011c3QgcGFzcyBhIG51bWVyaWMgdmFsdWUgdG8gZGVjcmVtZW50UHJvcGVydHknLCAhaXNOYU4ocGFyc2VGbG9hdChkZWNyZW1lbnQpKSAmJiBpc0Zpbml0ZShkZWNyZW1lbnQpKSk7CiAgICAgIHJldHVybiAoMCwgX21ldGFsLnNldCkodGhpcywga2V5TmFtZSwgKCgwLCBfbWV0YWwuZ2V0KSh0aGlzLCBrZXlOYW1lKSB8fCAwKSAtIGRlY3JlbWVudCk7CiAgICB9LAoKICAgIC8qKgogICAgICBTZXQgdGhlIHZhbHVlIG9mIGEgYm9vbGVhbiBwcm9wZXJ0eSB0byB0aGUgb3Bwb3NpdGUgb2YgaXRzCiAgICAgIGN1cnJlbnQgdmFsdWUuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHN0YXJzaGlwLnRvZ2dsZVByb3BlcnR5KCd3YXJwRHJpdmVFbmdhZ2VkJyk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCB0b2dnbGVQcm9wZXJ0eQogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgdG8gdG9nZ2xlCiAgICAgIEByZXR1cm4ge0Jvb2xlYW59IFRoZSBuZXcgcHJvcGVydHkgdmFsdWUKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHRvZ2dsZVByb3BlcnR5OiBmdW5jdGlvbiB0b2dnbGVQcm9wZXJ0eShrZXlOYW1lKSB7CiAgICAgIHJldHVybiAoMCwgX21ldGFsLnNldCkodGhpcywga2V5TmFtZSwgISgwLCBfbWV0YWwuZ2V0KSh0aGlzLCBrZXlOYW1lKSk7CiAgICB9LAoKICAgIC8qKgogICAgICBSZXR1cm5zIHRoZSBjYWNoZWQgdmFsdWUgb2YgYSBjb21wdXRlZCBwcm9wZXJ0eSwgaWYgaXQgZXhpc3RzLgogICAgICBUaGlzIGFsbG93cyB5b3UgdG8gaW5zcGVjdCB0aGUgdmFsdWUgb2YgYSBjb21wdXRlZCBwcm9wZXJ0eQogICAgICB3aXRob3V0IGFjY2lkZW50YWxseSBpbnZva2luZyBpdCBpZiBpdCBpcyBpbnRlbmRlZCB0byBiZQogICAgICBnZW5lcmF0ZWQgbGF6aWx5LgogICAgICAgQG1ldGhvZCBjYWNoZUZvcgogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZQogICAgICBAcmV0dXJuIHtPYmplY3R9IFRoZSBjYWNoZWQgdmFsdWUgb2YgdGhlIGNvbXB1dGVkIHByb3BlcnR5LCBpZiBhbnkKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGNhY2hlRm9yOiBmdW5jdGlvbiBjYWNoZUZvcihrZXlOYW1lKSB7CiAgICAgIHJldHVybiAoMCwgX21ldGFsLmdldENhY2hlZFZhbHVlRm9yKSh0aGlzLCBrZXlOYW1lKTsKICAgIH0KICB9KTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9taXhpbnMvcHJvbWlzZV9wcm94eSIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCIsICJAZW1iZXIvZXJyb3IiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfbWV0YWwsIF9lcnJvcikgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci9vYmplY3QKICAqLwogIGZ1bmN0aW9uIHRhcChwcm94eSwgcHJvbWlzZSkgewogICAgKDAsIF9tZXRhbC5zZXRQcm9wZXJ0aWVzKShwcm94eSwgewogICAgICBpc0Z1bGZpbGxlZDogZmFsc2UsCiAgICAgIGlzUmVqZWN0ZWQ6IGZhbHNlCiAgICB9KTsKICAgIHJldHVybiBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIGlmICghcHJveHkuaXNEZXN0cm95ZWQgJiYgIXByb3h5LmlzRGVzdHJveWluZykgewogICAgICAgICgwLCBfbWV0YWwuc2V0UHJvcGVydGllcykocHJveHksIHsKICAgICAgICAgIGNvbnRlbnQ6IHZhbHVlLAogICAgICAgICAgaXNGdWxmaWxsZWQ6IHRydWUKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICBpZiAoIXByb3h5LmlzRGVzdHJveWVkICYmICFwcm94eS5pc0Rlc3Ryb3lpbmcpIHsKICAgICAgICAoMCwgX21ldGFsLnNldFByb3BlcnRpZXMpKHByb3h5LCB7CiAgICAgICAgICByZWFzb246IHJlYXNvbiwKICAgICAgICAgIGlzUmVqZWN0ZWQ6IHRydWUKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdGhyb3cgcmVhc29uOwogICAgfSwgJ0VtYmVyOiBQcm9taXNlUHJveHknKTsKICB9CiAgLyoqCiAgICBBIGxvdyBsZXZlbCBtaXhpbiBtYWtpbmcgT2JqZWN0UHJveHkgcHJvbWlzZS1hd2FyZS4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHJlc29sdmUgfSBmcm9tICdyc3ZwJzsKICAgIGltcG9ydCAkIGZyb20gJ2pxdWVyeSc7CiAgICBpbXBvcnQgT2JqZWN0UHJveHkgZnJvbSAnQGVtYmVyL29iamVjdC9wcm94eSc7CiAgICBpbXBvcnQgUHJvbWlzZVByb3h5TWl4aW4gZnJvbSAnQGVtYmVyL29iamVjdC9wcm9taXNlLXByb3h5LW1peGluJzsKICAKICAgIGxldCBPYmplY3RQcm9taXNlUHJveHkgPSBPYmplY3RQcm94eS5leHRlbmQoUHJvbWlzZVByb3h5TWl4aW4pOwogIAogICAgbGV0IHByb3h5ID0gT2JqZWN0UHJvbWlzZVByb3h5LmNyZWF0ZSh7CiAgICAgIHByb21pc2U6IHJlc29sdmUoJC5nZXRKU09OKCcvc29tZS9yZW1vdGUvZGF0YS5qc29uJykpCiAgICB9KTsKICAKICAgIHByb3h5LnRoZW4oZnVuY3Rpb24oanNvbil7CiAgICAgICAvLyB0aGUganNvbgogICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAvLyB0aGUgcmVhc29uIHdoeSB5b3UgaGF2ZSBubyBqc29uCiAgICB9KTsKICAgIGBgYAogIAogICAgdGhlIHByb3h5IGhhcyBiaW5kYWJsZSBhdHRyaWJ1dGVzIHdoaWNoCiAgICB0cmFjayB0aGUgcHJvbWlzZXMgbGlmZSBjeWNsZQogIAogICAgYGBgamF2YXNjcmlwdAogICAgcHJveHkuZ2V0KCdpc1BlbmRpbmcnKSAgIC8vPT4gdHJ1ZQogICAgcHJveHkuZ2V0KCdpc1NldHRsZWQnKSAgLy89PiBmYWxzZQogICAgcHJveHkuZ2V0KCdpc1JlamVjdGVkJykgIC8vPT4gZmFsc2UKICAgIHByb3h5LmdldCgnaXNGdWxmaWxsZWQnKSAvLz0+IGZhbHNlCiAgICBgYGAKICAKICAgIFdoZW4gdGhlICQuZ2V0SlNPTiBjb21wbGV0ZXMsIGFuZCB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQKICAgIHdpdGgganNvbiwgdGhlIGxpZmUgY3ljbGUgYXR0cmlidXRlcyB3aWxsIHVwZGF0ZSBhY2NvcmRpbmdseS4KICAgIE5vdGUgdGhhdCAkLmdldEpTT04gZG9lc24ndCByZXR1cm4gYW4gRUNNQSBzcGVjaWZpZWQgcHJvbWlzZSwKICAgIGl0IGlzIHVzZWZ1bCB0byB3cmFwIHRoaXMgd2l0aCBhbiBgUlNWUC5yZXNvbHZlYCBzbyB0aGF0IGl0IGJlaGF2ZXMKICAgIGFzIGEgc3BlYyBjb21wbGlhbnQgcHJvbWlzZS4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIHByb3h5LmdldCgnaXNQZW5kaW5nJykgICAvLz0+IGZhbHNlCiAgICBwcm94eS5nZXQoJ2lzU2V0dGxlZCcpICAgLy89PiB0cnVlCiAgICBwcm94eS5nZXQoJ2lzUmVqZWN0ZWQnKSAgLy89PiBmYWxzZQogICAgcHJveHkuZ2V0KCdpc0Z1bGZpbGxlZCcpIC8vPT4gdHJ1ZQogICAgYGBgCiAgCiAgICBBcyB0aGUgcHJveHkgaXMgYW4gT2JqZWN0UHJveHksIGFuZCB0aGUganNvbiBub3cgaXRzIGNvbnRlbnQsCiAgICBhbGwgdGhlIGpzb24gcHJvcGVydGllcyB3aWxsIGJlIGF2YWlsYWJsZSBkaXJlY3RseSBmcm9tIHRoZSBwcm94eS4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIC8vIEFzc3VtaW5nIHRoZSBmb2xsb3dpbmcganNvbjoKICAgIHsKICAgICAgZmlyc3ROYW1lOiAnU3RlZmFuJywKICAgICAgbGFzdE5hbWU6ICdQZW5uZXInCiAgICB9CiAgCiAgICAvLyBib3RoIHByb3BlcnRpZXMgd2lsbCBhY2Nlc3NpYmxlIG9uIHRoZSBwcm94eQogICAgcHJveHkuZ2V0KCdmaXJzdE5hbWUnKSAvLz0+ICdTdGVmYW4nCiAgICBwcm94eS5nZXQoJ2xhc3ROYW1lJykgIC8vPT4gJ1Blbm5lcicKICAgIGBgYAogIAogICAgQGNsYXNzIFByb21pc2VQcm94eU1peGluCiAgICBAcHVibGljCiAgKi8KCgogIHZhciBfZGVmYXVsdCA9IF9tZXRhbC5NaXhpbi5jcmVhdGUoewogICAgLyoqCiAgICAgIElmIHRoZSBwcm94aWVkIHByb21pc2UgaXMgcmVqZWN0ZWQgdGhpcyB3aWxsIGNvbnRhaW4gdGhlIHJlYXNvbgogICAgICBwcm92aWRlZC4KICAgICAgIEBwcm9wZXJ0eSByZWFzb24KICAgICAgQGRlZmF1bHQgbnVsbAogICAgICBAcHVibGljCiAgICAqLwogICAgcmVhc29uOiBudWxsLAoKICAgIC8qKgogICAgICBPbmNlIHRoZSBwcm94aWVkIHByb21pc2UgaGFzIHNldHRsZWQgdGhpcyB3aWxsIGJlY29tZSBgZmFsc2VgLgogICAgICAgQHByb3BlcnR5IGlzUGVuZGluZwogICAgICBAZGVmYXVsdCB0cnVlCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBpc1BlbmRpbmc6ICgwLCBfbWV0YWwuY29tcHV0ZWQpKCdpc1NldHRsZWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAhKDAsIF9tZXRhbC5nZXQpKHRoaXMsICdpc1NldHRsZWQnKTsKICAgIH0pLnJlYWRPbmx5KCksCgogICAgLyoqCiAgICAgIE9uY2UgdGhlIHByb3hpZWQgcHJvbWlzZSBoYXMgc2V0dGxlZCB0aGlzIHdpbGwgYmVjb21lIGB0cnVlYC4KICAgICAgIEBwcm9wZXJ0eSBpc1NldHRsZWQKICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGlzU2V0dGxlZDogKDAsIF9tZXRhbC5jb21wdXRlZCkoJ2lzUmVqZWN0ZWQnLCAnaXNGdWxmaWxsZWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAoMCwgX21ldGFsLmdldCkodGhpcywgJ2lzUmVqZWN0ZWQnKSB8fCAoMCwgX21ldGFsLmdldCkodGhpcywgJ2lzRnVsZmlsbGVkJyk7CiAgICB9KS5yZWFkT25seSgpLAoKICAgIC8qKgogICAgICBXaWxsIGJlY29tZSBgdHJ1ZWAgaWYgdGhlIHByb3hpZWQgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAgIEBwcm9wZXJ0eSBpc1JlamVjdGVkCiAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBpc1JlamVjdGVkOiBmYWxzZSwKCiAgICAvKioKICAgICAgV2lsbCBiZWNvbWUgYHRydWVgIGlmIHRoZSBwcm94aWVkIHByb21pc2UgaXMgZnVsZmlsbGVkLgogICAgICAgQHByb3BlcnR5IGlzRnVsZmlsbGVkCiAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBpc0Z1bGZpbGxlZDogZmFsc2UsCgogICAgLyoqCiAgICAgIFRoZSBwcm9taXNlIHdob3NlIGZ1bGZpbGxtZW50IHZhbHVlIGlzIGJlaW5nIHByb3hpZWQgYnkgdGhpcyBvYmplY3QuCiAgICAgICBUaGlzIHByb3BlcnR5IG11c3QgYmUgc3BlY2lmaWVkIHVwb24gY3JlYXRpb24sIGFuZCBzaG91bGQgbm90IGJlCiAgICAgIGNoYW5nZWQgb25jZSBjcmVhdGVkLgogICAgICAgRXhhbXBsZToKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IE9iamVjdFByb3h5IGZyb20gJ0BlbWJlci9vYmplY3QvcHJveHknOwogICAgICBpbXBvcnQgUHJvbWlzZVByb3h5TWl4aW4gZnJvbSAnQGVtYmVyL29iamVjdC9wcm9taXNlLXByb3h5LW1peGluJzsKICAgICAgIE9iamVjdFByb3h5LmV4dGVuZChQcm9taXNlUHJveHlNaXhpbikuY3JlYXRlKHsKICAgICAgICBwcm9taXNlOiA8dGhlbmFibGU+CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBwcm9wZXJ0eSBwcm9taXNlCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBwcm9taXNlOiAoMCwgX21ldGFsLmNvbXB1dGVkKSh7CiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHRocm93IG5ldyBfZXJyb3IuZGVmYXVsdCgiUHJvbWlzZVByb3h5J3MgcHJvbWlzZSBtdXN0IGJlIHNldCIpOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldChrZXksIHByb21pc2UpIHsKICAgICAgICByZXR1cm4gdGFwKHRoaXMsIHByb21pc2UpOwogICAgICB9CiAgICB9KSwKCiAgICAvKioKICAgICAgQW4gYWxpYXMgdG8gdGhlIHByb3hpZWQgcHJvbWlzZSdzIGB0aGVuYC4KICAgICAgIFNlZSBSU1ZQLlByb21pc2UudGhlbi4KICAgICAgIEBtZXRob2QgdGhlbgogICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjawogICAgICBAcmV0dXJuIHtSU1ZQLlByb21pc2V9CiAgICAgIEBwdWJsaWMKICAgICovCiAgICB0aGVuOiBwcm9taXNlQWxpYXMoJ3RoZW4nKSwKCiAgICAvKioKICAgICAgQW4gYWxpYXMgdG8gdGhlIHByb3hpZWQgcHJvbWlzZSdzIGBjYXRjaGAuCiAgICAgICBTZWUgUlNWUC5Qcm9taXNlLmNhdGNoLgogICAgICAgQG1ldGhvZCBjYXRjaAogICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjawogICAgICBAcmV0dXJuIHtSU1ZQLlByb21pc2V9CiAgICAgIEBzaW5jZSAxLjMuMAogICAgICBAcHVibGljCiAgICAqLwogICAgY2F0Y2g6IHByb21pc2VBbGlhcygnY2F0Y2gnKSwKCiAgICAvKioKICAgICAgQW4gYWxpYXMgdG8gdGhlIHByb3hpZWQgcHJvbWlzZSdzIGBmaW5hbGx5YC4KICAgICAgIFNlZSBSU1ZQLlByb21pc2UuZmluYWxseS4KICAgICAgIEBtZXRob2QgZmluYWxseQogICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjawogICAgICBAcmV0dXJuIHtSU1ZQLlByb21pc2V9CiAgICAgIEBzaW5jZSAxLjMuMAogICAgICBAcHVibGljCiAgICAqLwogICAgZmluYWxseTogcHJvbWlzZUFsaWFzKCdmaW5hbGx5JykKICB9KTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0OwoKICBmdW5jdGlvbiBwcm9taXNlQWxpYXMobmFtZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHByb21pc2UgPSAoMCwgX21ldGFsLmdldCkodGhpcywgJ3Byb21pc2UnKTsKICAgICAgcmV0dXJuIHByb21pc2VbbmFtZV0uYXBwbHkocHJvbWlzZSwgYXJndW1lbnRzKTsKICAgIH07CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9taXhpbnMvcmVnaXN0cnlfcHJveHkiLCBbImV4cG9ydHMiLCAiQGVtYmVyL2RlYnVnIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGFsIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2RlYnVnLCBfbWV0YWwpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwoKICAvKioKICAgIFJlZ2lzdHJ5UHJveHlNaXhpbiBpcyB1c2VkIHRvIHByb3ZpZGUgcHVibGljIGFjY2VzcyB0byBzcGVjaWZpYwogICAgcmVnaXN0cnkgZnVuY3Rpb25hbGl0eS4KICAKICAgIEBjbGFzcyBSZWdpc3RyeVByb3h5TWl4aW4KICAgIEBwcml2YXRlCiAgKi8KICB2YXIgX2RlZmF1bHQgPSBfbWV0YWwuTWl4aW4uY3JlYXRlKHsKICAgIF9fcmVnaXN0cnlfXzogbnVsbCwKCiAgICAvKioKICAgICBHaXZlbiBhIGZ1bGxOYW1lIHJldHVybiB0aGUgY29ycmVzcG9uZGluZyBmYWN0b3J5LgogICAgICBAcHVibGljCiAgICAgQG1ldGhvZCByZXNvbHZlUmVnaXN0cmF0aW9uCiAgICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lCiAgICAgQHJldHVybiB7RnVuY3Rpb259IGZ1bGxOYW1lJ3MgZmFjdG9yeQogICAgICovCiAgICByZXNvbHZlUmVnaXN0cmF0aW9uOiBmdW5jdGlvbiByZXNvbHZlUmVnaXN0cmF0aW9uKGZ1bGxOYW1lLCBvcHRpb25zKSB7CiAgICAgIChmYWxzZSAmJiAhKHRoaXMuX19yZWdpc3RyeV9fLmlzVmFsaWRGdWxsTmFtZShmdWxsTmFtZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnZnVsbE5hbWUgbXVzdCBiZSBhIHByb3BlciBmdWxsIG5hbWUnLCB0aGlzLl9fcmVnaXN0cnlfXy5pc1ZhbGlkRnVsbE5hbWUoZnVsbE5hbWUpKSk7CiAgICAgIHJldHVybiB0aGlzLl9fcmVnaXN0cnlfXy5yZXNvbHZlKGZ1bGxOYW1lLCBvcHRpb25zKTsKICAgIH0sCgogICAgLyoqCiAgICAgIFJlZ2lzdGVycyBhIGZhY3RvcnkgdGhhdCBjYW4gYmUgdXNlZCBmb3IgZGVwZW5kZW5jeSBpbmplY3Rpb24gKHdpdGgKICAgICAgYGluamVjdGApIG9yIGZvciBzZXJ2aWNlIGxvb2t1cC4gRWFjaCBmYWN0b3J5IGlzIHJlZ2lzdGVyZWQgd2l0aAogICAgICBhIGZ1bGwgbmFtZSBpbmNsdWRpbmcgdHdvIHBhcnRzOiBgdHlwZTpuYW1lYC4KICAgICAgIEEgc2ltcGxlIGV4YW1wbGU6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBBcHBsaWNhdGlvbiBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogICAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICBsZXQgQXBwID0gQXBwbGljYXRpb24uY3JlYXRlKCk7CiAgICAgICBBcHAuT3JhbmdlID0gRW1iZXJPYmplY3QuZXh0ZW5kKCk7CiAgICAgIEFwcC5yZWdpc3RlcignZnJ1aXQ6ZmF2b3JpdGUnLCBBcHAuT3JhbmdlKTsKICAgICAgYGBgCiAgICAgICBFbWJlciB3aWxsIHJlc29sdmUgZmFjdG9yaWVzIGZyb20gdGhlIGBBcHBgIG5hbWVzcGFjZSBhdXRvbWF0aWNhbGx5LgogICAgICBGb3IgZXhhbXBsZSBgQXBwLkNhcnNDb250cm9sbGVyYCB3aWxsIGJlIGRpc2NvdmVyZWQgYW5kIHJldHVybmVkIGlmCiAgICAgIGFuIGFwcGxpY2F0aW9uIHJlcXVlc3RzIGBjb250cm9sbGVyOmNhcnNgLgogICAgICAgQW4gZXhhbXBsZSBvZiByZWdpc3RlcmluZyBhIGNvbnRyb2xsZXIgd2l0aCBhIG5vbi1zdGFuZGFyZCBuYW1lOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAgICAgaW1wb3J0IENvbnRyb2xsZXIgZnJvbSAnQGVtYmVyL2NvbnRyb2xsZXInOwogICAgICAgbGV0IEFwcCA9IEFwcGxpY2F0aW9uLmNyZWF0ZSgpOwogICAgICBsZXQgU2Vzc2lvbiA9IENvbnRyb2xsZXIuZXh0ZW5kKCk7CiAgICAgICBBcHAucmVnaXN0ZXIoJ2NvbnRyb2xsZXI6c2Vzc2lvbicsIFNlc3Npb24pOwogICAgICAgLy8gVGhlIFNlc3Npb24gY29udHJvbGxlciBjYW4gbm93IGJlIHRyZWF0ZWQgbGlrZSBhIG5vcm1hbCBjb250cm9sbGVyLAogICAgICAvLyBkZXNwaXRlIGl0cyBub24tc3RhbmRhcmQgbmFtZS4KICAgICAgQXBwLkFwcGxpY2F0aW9uQ29udHJvbGxlciA9IENvbnRyb2xsZXIuZXh0ZW5kKHsKICAgICAgICBuZWVkczogWydzZXNzaW9uJ10KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgUmVnaXN0ZXJlZCBmYWN0b3JpZXMgYXJlICoqaW5zdGFudGlhdGVkKiogYnkgaGF2aW5nIGBjcmVhdGVgCiAgICAgIGNhbGxlZCBvbiB0aGVtLiBBZGRpdGlvbmFsbHkgdGhleSBhcmUgKipzaW5nbGV0b25zKiosIGVhY2ggdGltZQogICAgICB0aGV5IGFyZSBsb29rZWQgdXAgdGhleSByZXR1cm4gdGhlIHNhbWUgaW5zdGFuY2UuCiAgICAgICBTb21lIGV4YW1wbGVzIG1vZGlmeWluZyB0aGF0IGRlZmF1bHQgYmVoYXZpb3I6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBBcHBsaWNhdGlvbiBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogICAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICBsZXQgQXBwID0gQXBwbGljYXRpb24uY3JlYXRlKCk7CiAgICAgICBBcHAuUGVyc29uID0gRW1iZXJPYmplY3QuZXh0ZW5kKCk7CiAgICAgIEFwcC5PcmFuZ2UgPSBFbWJlck9iamVjdC5leHRlbmQoKTsKICAgICAgQXBwLkVtYWlsID0gRW1iZXJPYmplY3QuZXh0ZW5kKCk7CiAgICAgIEFwcC5zZXNzaW9uID0gRW1iZXJPYmplY3QuY3JlYXRlKCk7CiAgICAgICBBcHAucmVnaXN0ZXIoJ21vZGVsOnVzZXInLCBBcHAuUGVyc29uLCB7IHNpbmdsZXRvbjogZmFsc2UgfSk7CiAgICAgIEFwcC5yZWdpc3RlcignZnJ1aXQ6ZmF2b3JpdGUnLCBBcHAuT3JhbmdlKTsKICAgICAgQXBwLnJlZ2lzdGVyKCdjb21tdW5pY2F0aW9uOm1haW4nLCBBcHAuRW1haWwsIHsgc2luZ2xldG9uOiBmYWxzZSB9KTsKICAgICAgQXBwLnJlZ2lzdGVyKCdzZXNzaW9uJywgQXBwLnNlc3Npb24sIHsgaW5zdGFudGlhdGU6IGZhbHNlIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgcmVnaXN0ZXIKICAgICAgQHBhcmFtICBmdWxsTmFtZSB7U3RyaW5nfSB0eXBlOm5hbWUgKGUuZy4sICdtb2RlbDp1c2VyJykKICAgICAgQHBhcmFtICBmYWN0b3J5IHthbnl9IChlLmcuLCBBcHAuUGVyc29uKQogICAgICBAcGFyYW0gIG9wdGlvbnMge09iamVjdH0gKG9wdGlvbmFsKSBkaXNhYmxlIGluc3RhbnRpYXRpb24gb3Igc2luZ2xldG9uIHVzYWdlCiAgICAgIEBwdWJsaWMKICAgICAqLwogICAgcmVnaXN0ZXI6IHJlZ2lzdHJ5QWxpYXMoJ3JlZ2lzdGVyJyksCgogICAgLyoqCiAgICAgVW5yZWdpc3RlciBhIGZhY3RvcnkuCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgIGxldCBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoKTsKICAgICBsZXQgVXNlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCgpOwogICAgIEFwcC5yZWdpc3RlcignbW9kZWw6dXNlcicsIFVzZXIpOwogICAgICBBcHAucmVzb2x2ZVJlZ2lzdHJhdGlvbignbW9kZWw6dXNlcicpLmNyZWF0ZSgpIGluc3RhbmNlb2YgVXNlciAvLz0+IHRydWUKICAgICAgQXBwLnVucmVnaXN0ZXIoJ21vZGVsOnVzZXInKQogICAgIEFwcC5yZXNvbHZlUmVnaXN0cmF0aW9uKCdtb2RlbDp1c2VyJykgPT09IHVuZGVmaW5lZCAvLz0+IHRydWUKICAgICBgYGAKICAgICAgQHB1YmxpYwogICAgIEBtZXRob2QgdW5yZWdpc3RlcgogICAgIEBwYXJhbSB7U3RyaW5nfSBmdWxsTmFtZQogICAgICovCiAgICB1bnJlZ2lzdGVyOiByZWdpc3RyeUFsaWFzKCd1bnJlZ2lzdGVyJyksCgogICAgLyoqCiAgICAgQ2hlY2sgaWYgYSBmYWN0b3J5IGlzIHJlZ2lzdGVyZWQuCiAgICAgIEBwdWJsaWMKICAgICBAbWV0aG9kIGhhc1JlZ2lzdHJhdGlvbgogICAgIEBwYXJhbSB7U3RyaW5nfSBmdWxsTmFtZQogICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgKi8KICAgIGhhc1JlZ2lzdHJhdGlvbjogcmVnaXN0cnlBbGlhcygnaGFzJyksCgogICAgLyoqCiAgICAgUmV0dXJuIGEgc3BlY2lmaWMgcmVnaXN0ZXJlZCBvcHRpb24gZm9yIGEgcGFydGljdWxhciBmYWN0b3J5LgogICAgICBAcHVibGljCiAgICAgQG1ldGhvZCByZWdpc3RlcmVkT3B0aW9uCiAgICAgQHBhcmFtICB7U3RyaW5nfSBmdWxsTmFtZQogICAgIEBwYXJhbSAge1N0cmluZ30gb3B0aW9uTmFtZQogICAgIEByZXR1cm4ge09iamVjdH0gb3B0aW9ucwogICAgICovCiAgICByZWdpc3RlcmVkT3B0aW9uOiByZWdpc3RyeUFsaWFzKCdnZXRPcHRpb24nKSwKCiAgICAvKioKICAgICBSZWdpc3RlciBvcHRpb25zIGZvciBhIHBhcnRpY3VsYXIgZmFjdG9yeS4KICAgICAgQHB1YmxpYwogICAgIEBtZXRob2QgcmVnaXN0ZXJPcHRpb25zCiAgICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lCiAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAqLwogICAgcmVnaXN0ZXJPcHRpb25zOiByZWdpc3RyeUFsaWFzKCdvcHRpb25zJyksCgogICAgLyoqCiAgICAgUmV0dXJuIHJlZ2lzdGVyZWQgb3B0aW9ucyBmb3IgYSBwYXJ0aWN1bGFyIGZhY3RvcnkuCiAgICAgIEBwdWJsaWMKICAgICBAbWV0aG9kIHJlZ2lzdGVyZWRPcHRpb25zCiAgICAgQHBhcmFtICB7U3RyaW5nfSBmdWxsTmFtZQogICAgIEByZXR1cm4ge09iamVjdH0gb3B0aW9ucwogICAgICovCiAgICByZWdpc3RlcmVkT3B0aW9uczogcmVnaXN0cnlBbGlhcygnZ2V0T3B0aW9ucycpLAoKICAgIC8qKgogICAgIEFsbG93IHJlZ2lzdGVyaW5nIG9wdGlvbnMgZm9yIGFsbCBmYWN0b3JpZXMgb2YgYSB0eXBlLgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgICAgIGxldCBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoKTsKICAgICBsZXQgYXBwSW5zdGFuY2UgPSBBcHAuYnVpbGRJbnN0YW5jZSgpOwogICAgICAvLyBpZiBhbGwgb2YgdHlwZSBgY29ubmVjdGlvbmAgbXVzdCBub3QgYmUgc2luZ2xldG9ucwogICAgIGFwcEluc3RhbmNlLnJlZ2lzdGVyT3B0aW9uc0ZvclR5cGUoJ2Nvbm5lY3Rpb24nLCB7IHNpbmdsZXRvbjogZmFsc2UgfSk7CiAgICAgIGFwcEluc3RhbmNlLnJlZ2lzdGVyKCdjb25uZWN0aW9uOnR3aXR0ZXInLCBUd2l0dGVyQ29ubmVjdGlvbik7CiAgICAgYXBwSW5zdGFuY2UucmVnaXN0ZXIoJ2Nvbm5lY3Rpb246ZmFjZWJvb2snLCBGYWNlYm9va0Nvbm5lY3Rpb24pOwogICAgICBsZXQgdHdpdHRlciA9IGFwcEluc3RhbmNlLmxvb2t1cCgnY29ubmVjdGlvbjp0d2l0dGVyJyk7CiAgICAgbGV0IHR3aXR0ZXIyID0gYXBwSW5zdGFuY2UubG9va3VwKCdjb25uZWN0aW9uOnR3aXR0ZXInKTsKICAgICAgdHdpdHRlciA9PT0gdHdpdHRlcjI7IC8vID0+IGZhbHNlCiAgICAgIGxldCBmYWNlYm9vayA9IGFwcEluc3RhbmNlLmxvb2t1cCgnY29ubmVjdGlvbjpmYWNlYm9vaycpOwogICAgIGxldCBmYWNlYm9vazIgPSBhcHBJbnN0YW5jZS5sb29rdXAoJ2Nvbm5lY3Rpb246ZmFjZWJvb2snKTsKICAgICAgZmFjZWJvb2sgPT09IGZhY2Vib29rMjsgLy8gPT4gZmFsc2UKICAgICBgYGAKICAgICAgQHB1YmxpYwogICAgIEBtZXRob2QgcmVnaXN0ZXJPcHRpb25zRm9yVHlwZQogICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAqLwogICAgcmVnaXN0ZXJPcHRpb25zRm9yVHlwZTogcmVnaXN0cnlBbGlhcygnb3B0aW9uc0ZvclR5cGUnKSwKCiAgICAvKioKICAgICBSZXR1cm4gdGhlIHJlZ2lzdGVyZWQgb3B0aW9ucyBmb3IgYWxsIGZhY3RvcmllcyBvZiBhIHR5cGUuCiAgICAgIEBwdWJsaWMKICAgICBAbWV0aG9kIHJlZ2lzdGVyZWRPcHRpb25zRm9yVHlwZQogICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICAgQHJldHVybiB7T2JqZWN0fSBvcHRpb25zCiAgICAgKi8KICAgIHJlZ2lzdGVyZWRPcHRpb25zRm9yVHlwZTogcmVnaXN0cnlBbGlhcygnZ2V0T3B0aW9uc0ZvclR5cGUnKSwKCiAgICAvKioKICAgICAgRGVmaW5lIGEgZGVwZW5kZW5jeSBpbmplY3Rpb24gb250byBhIHNwZWNpZmljIGZhY3Rvcnkgb3IgYWxsIGZhY3RvcmllcwogICAgICBvZiBhIHR5cGUuCiAgICAgICBXaGVuIEVtYmVyIGluc3RhbnRpYXRlcyBhIGNvbnRyb2xsZXIsIHZpZXcsIG9yIG90aGVyIGZyYW1ld29yayBjb21wb25lbnQKICAgICAgaXQgY2FuIGF0dGFjaCBhIGRlcGVuZGVuY3kgdG8gdGhhdCBjb21wb25lbnQuIFRoaXMgaXMgb2Z0ZW4gdXNlZCB0bwogICAgICBwcm92aWRlIHNlcnZpY2VzIHRvIGEgc2V0IG9mIGZyYW1ld29yayBjb21wb25lbnRzLgogICAgICAgQW4gZXhhbXBsZSBvZiBwcm92aWRpbmcgYSBzZXNzaW9uIG9iamVjdCB0byBhbGwgY29udHJvbGxlcnM6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCB7IGFsaWFzIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgICAgIGltcG9ydCBBcHBsaWNhdGlvbiBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogICAgICBpbXBvcnQgQ29udHJvbGxlciBmcm9tICdAZW1iZXIvY29udHJvbGxlcic7CiAgICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICAgIGxldCBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoKTsKICAgICAgbGV0IFNlc3Npb24gPSBFbWJlck9iamVjdC5leHRlbmQoeyBpc0F1dGhlbnRpY2F0ZWQ6IGZhbHNlIH0pOwogICAgICAgLy8gQSBmYWN0b3J5IG11c3QgYmUgcmVnaXN0ZXJlZCBiZWZvcmUgaXQgY2FuIGJlIGluamVjdGVkCiAgICAgIEFwcC5yZWdpc3Rlcignc2Vzc2lvbjptYWluJywgU2Vzc2lvbik7CiAgICAgICAvLyBJbmplY3QgJ3Nlc3Npb246bWFpbicgb250byBhbGwgZmFjdG9yaWVzIG9mIHRoZSB0eXBlICdjb250cm9sbGVyJwogICAgICAvLyB3aXRoIHRoZSBuYW1lICdzZXNzaW9uJwogICAgICBBcHAuaW5qZWN0KCdjb250cm9sbGVyJywgJ3Nlc3Npb24nLCAnc2Vzc2lvbjptYWluJyk7CiAgICAgICBBcHAuSW5kZXhDb250cm9sbGVyID0gQ29udHJvbGxlci5leHRlbmQoewogICAgICAgIGlzTG9nZ2VkSW46IGFsaWFzKCdzZXNzaW9uLmlzQXV0aGVudGljYXRlZCcpCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEluamVjdGlvbnMgY2FuIGFsc28gYmUgcGVyZm9ybWVkIG9uIHNwZWNpZmljIGZhY3Rvcmllcy4KICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgQXBwLmluamVjdCg8ZnVsbF9uYW1lIG9yIHR5cGU+LCA8cHJvcGVydHkgbmFtZT4sIDxmdWxsX25hbWU+KQogICAgICBBcHAuaW5qZWN0KCdyb3V0ZScsICdzb3VyY2UnLCAnc291cmNlOm1haW4nKQogICAgICBBcHAuaW5qZWN0KCdyb3V0ZTphcHBsaWNhdGlvbicsICdlbWFpbCcsICdtb2RlbDplbWFpbCcpCiAgICAgIGBgYAogICAgICAgSXQgaXMgaW1wb3J0YW50IHRvIG5vdGUgdGhhdCBpbmplY3Rpb25zIGNhbiBvbmx5IGJlIHBlcmZvcm1lZCBvbgogICAgICBjbGFzc2VzIHRoYXQgYXJlIGluc3RhbnRpYXRlZCBieSBFbWJlciBpdHNlbGYuIEluc3RhbnRpYXRpbmcgYSBjbGFzcwogICAgICBkaXJlY3RseSAodmlhIGBjcmVhdGVgIG9yIGBuZXdgKSBieXBhc3NlcyB0aGUgZGVwZW5kZW5jeSBpbmplY3Rpb24KICAgICAgc3lzdGVtLgogICAgICAgQHB1YmxpYwogICAgICBAbWV0aG9kIGluamVjdAogICAgICBAcGFyYW0gIGZhY3RvcnlOYW1lT3JUeXBlIHtTdHJpbmd9CiAgICAgIEBwYXJhbSAgcHJvcGVydHkge1N0cmluZ30KICAgICAgQHBhcmFtICBpbmplY3Rpb25OYW1lIHtTdHJpbmd9CiAgICAqKi8KICAgIGluamVjdDogcmVnaXN0cnlBbGlhcygnaW5qZWN0aW9uJykKICB9KTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0OwoKICBmdW5jdGlvbiByZWdpc3RyeUFsaWFzKG5hbWUpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfdGhpcyRfX3JlZ2lzdHJ5X187CgogICAgICByZXR1cm4gKF90aGlzJF9fcmVnaXN0cnlfXyA9IHRoaXMuX19yZWdpc3RyeV9fKVtuYW1lXS5hcHBseShfdGhpcyRfX3JlZ2lzdHJ5X18sIGFyZ3VtZW50cyk7CiAgICB9OwogIH0KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvbWl4aW5zL3RhcmdldF9hY3Rpb25fc3VwcG9ydCIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy9lbnZpcm9ubWVudCIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCIsICJAZW1iZXIvZGVidWciXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZW52aXJvbm1lbnQsIF9tZXRhbCwgX2RlYnVnKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgYEVtYmVyLlRhcmdldEFjdGlvblN1cHBvcnRgIGlzIGEgbWl4aW4gdGhhdCBjYW4gYmUgaW5jbHVkZWQgaW4gYSBjbGFzcwogIHRvIGFkZCBhIGB0cmlnZ2VyQWN0aW9uYCBtZXRob2Qgd2l0aCBzZW1hbnRpY3Mgc2ltaWxhciB0byB0aGUgSGFuZGxlYmFycwogIGB7e2FjdGlvbn19YCBoZWxwZXIuIEluIG5vcm1hbCBFbWJlciB1c2FnZSwgdGhlIGB7e2FjdGlvbn19YCBoZWxwZXIgaXMKICB1c3VhbGx5IHRoZSBiZXN0IGNob2ljZS4gVGhpcyBtaXhpbiBpcyBtb3N0IG9mdGVuIHVzZWZ1bCB3aGVuIHlvdSBhcmUKICBkb2luZyBtb3JlIGNvbXBsZXggZXZlbnQgaGFuZGxpbmcgaW4gQ29tcG9uZW50cy4KICAKICBAY2xhc3MgVGFyZ2V0QWN0aW9uU3VwcG9ydAogIEBuYW1lc3BhY2UgRW1iZXIKICBAZXh0ZW5kcyBNaXhpbgogIEBwcml2YXRlCiAgKi8KICB2YXIgX2RlZmF1bHQgPSBfbWV0YWwuTWl4aW4uY3JlYXRlKHsKICAgIHRhcmdldDogbnVsbCwKICAgIGFjdGlvbjogbnVsbCwKICAgIGFjdGlvbkNvbnRleHQ6IG51bGwsCiAgICBhY3Rpb25Db250ZXh0T2JqZWN0OiAoMCwgX21ldGFsLmNvbXB1dGVkKSgnYWN0aW9uQ29udGV4dCcsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGFjdGlvbkNvbnRleHQgPSAoMCwgX21ldGFsLmdldCkodGhpcywgJ2FjdGlvbkNvbnRleHQnKTsKCiAgICAgIGlmICh0eXBlb2YgYWN0aW9uQ29udGV4dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICB2YXIgdmFsdWUgPSAoMCwgX21ldGFsLmdldCkodGhpcywgYWN0aW9uQ29udGV4dCk7CgogICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB2YWx1ZSA9ICgwLCBfbWV0YWwuZ2V0KShfZW52aXJvbm1lbnQuY29udGV4dC5sb29rdXAsIGFjdGlvbkNvbnRleHQpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBhY3Rpb25Db250ZXh0OwogICAgICB9CiAgICB9KSwKCiAgICAvKioKICAgIFNlbmQgYW4gYGFjdGlvbmAgd2l0aCBhbiBgYWN0aW9uQ29udGV4dGAgdG8gYSBgdGFyZ2V0YC4gVGhlIGFjdGlvbiwgYWN0aW9uQ29udGV4dAogICAgYW5kIHRhcmdldCB3aWxsIGJlIHJldHJpZXZlZCBmcm9tIHByb3BlcnRpZXMgb2YgdGhlIG9iamVjdC4gRm9yIGV4YW1wbGU6CiAgICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgYWxpYXMgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgICBBcHAuU2F2ZUJ1dHRvblZpZXcgPSBFbWJlci5WaWV3LmV4dGVuZChFbWJlci5UYXJnZXRBY3Rpb25TdXBwb3J0LCB7CiAgICAgIHRhcmdldDogYWxpYXMoJ2NvbnRyb2xsZXInKSwKICAgICAgYWN0aW9uOiAnc2F2ZScsCiAgICAgIGFjdGlvbkNvbnRleHQ6IGFsaWFzKCdjb250ZXh0JyksCiAgICAgIGNsaWNrKCkgewogICAgICAgIHRoaXMudHJpZ2dlckFjdGlvbigpOyAvLyBTZW5kcyB0aGUgYHNhdmVgIGFjdGlvbiwgYWxvbmcgd2l0aCB0aGUgY3VycmVudCBjb250ZXh0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvIHRoZSBjdXJyZW50IGNvbnRyb2xsZXIKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAgICBUaGUgYHRhcmdldGAsIGBhY3Rpb25gLCBhbmQgYGFjdGlvbkNvbnRleHRgIGNhbiBiZSBwcm92aWRlZCBhcyBwcm9wZXJ0aWVzIG9mCiAgICBhbiBvcHRpb25hbCBvYmplY3QgYXJndW1lbnQgdG8gYHRyaWdnZXJBY3Rpb25gIGFzIHdlbGwuCiAgICAgYGBgamF2YXNjcmlwdAogICAgQXBwLlNhdmVCdXR0b25WaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoRW1iZXIuVGFyZ2V0QWN0aW9uU3VwcG9ydCwgewogICAgICBjbGljaygpIHsKICAgICAgICB0aGlzLnRyaWdnZXJBY3Rpb24oewogICAgICAgICAgYWN0aW9uOiAnc2F2ZScsCiAgICAgICAgICB0YXJnZXQ6IHRoaXMuZ2V0KCdjb250cm9sbGVyJyksCiAgICAgICAgICBhY3Rpb25Db250ZXh0OiB0aGlzLmdldCgnY29udGV4dCcpCiAgICAgICAgfSk7IC8vIFNlbmRzIHRoZSBgc2F2ZWAgYWN0aW9uLCBhbG9uZyB3aXRoIHRoZSBjdXJyZW50IGNvbnRleHQKICAgICAgICAgICAgLy8gdG8gdGhlIGN1cnJlbnQgY29udHJvbGxlcgogICAgICB9CiAgICB9KTsKICAgIGBgYAogICAgIFRoZSBgYWN0aW9uQ29udGV4dGAgZGVmYXVsdHMgdG8gdGhlIG9iamVjdCB5b3UgYXJlIG1peGluZyBgVGFyZ2V0QWN0aW9uU3VwcG9ydGAgaW50by4KICAgIEJ1dCBgdGFyZ2V0YCBhbmQgYGFjdGlvbmAgbXVzdCBiZSBzcGVjaWZpZWQgZWl0aGVyIGFzIHByb3BlcnRpZXMgb3Igd2l0aCB0aGUgYXJndW1lbnQKICAgIHRvIGB0cmlnZ2VyQWN0aW9uYCwgb3IgYSBjb21iaW5hdGlvbjoKICAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBhbGlhcyB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogICAgIEFwcC5TYXZlQnV0dG9uVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKEVtYmVyLlRhcmdldEFjdGlvblN1cHBvcnQsIHsKICAgICAgdGFyZ2V0OiBhbGlhcygnY29udHJvbGxlcicpLAogICAgICBjbGljaygpIHsKICAgICAgICB0aGlzLnRyaWdnZXJBY3Rpb24oewogICAgICAgICAgYWN0aW9uOiAnc2F2ZScKICAgICAgICB9KTsgLy8gU2VuZHMgdGhlIGBzYXZlYCBhY3Rpb24sIGFsb25nIHdpdGggYSByZWZlcmVuY2UgdG8gYHRoaXNgLAogICAgICAgICAgICAvLyB0byB0aGUgY3VycmVudCBjb250cm9sbGVyCiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgICAgQG1ldGhvZCB0cmlnZ2VyQWN0aW9uCiAgICBAcGFyYW0gb3B0cyB7T2JqZWN0fSAob3B0aW9uYWwsIHdpdGggdGhlIG9wdGlvbmFsIGtleXMgYWN0aW9uLCB0YXJnZXQgYW5kL29yIGFjdGlvbkNvbnRleHQpCiAgICBAcmV0dXJuIHtCb29sZWFufSB0cnVlIGlmIHRoZSBhY3Rpb24gd2FzIHNlbnQgc3VjY2Vzc2Z1bGx5IGFuZCBkaWQgbm90IHJldHVybiBmYWxzZQogICAgQHByaXZhdGUKICAgICovCiAgICB0cmlnZ2VyQWN0aW9uOiBmdW5jdGlvbiB0cmlnZ2VyQWN0aW9uKG9wdHMpIHsKICAgICAgaWYgKG9wdHMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdHMgPSB7fTsKICAgICAgfQoKICAgICAgdmFyIF9vcHRzID0gb3B0cywKICAgICAgICAgIGFjdGlvbiA9IF9vcHRzLmFjdGlvbiwKICAgICAgICAgIHRhcmdldCA9IF9vcHRzLnRhcmdldCwKICAgICAgICAgIGFjdGlvbkNvbnRleHQgPSBfb3B0cy5hY3Rpb25Db250ZXh0OwogICAgICBhY3Rpb24gPSBhY3Rpb24gfHwgKDAsIF9tZXRhbC5nZXQpKHRoaXMsICdhY3Rpb24nKTsKICAgICAgdGFyZ2V0ID0gdGFyZ2V0IHx8IGdldFRhcmdldCh0aGlzKTsKCiAgICAgIGlmIChhY3Rpb25Db250ZXh0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBhY3Rpb25Db250ZXh0ID0gKDAsIF9tZXRhbC5nZXQpKHRoaXMsICdhY3Rpb25Db250ZXh0T2JqZWN0JykgfHwgdGhpczsKICAgICAgfQoKICAgICAgaWYgKHRhcmdldCAmJiBhY3Rpb24pIHsKICAgICAgICB2YXIgcmV0OwoKICAgICAgICBpZiAodGFyZ2V0LnNlbmQpIHsKICAgICAgICAgIHZhciBfdGFyZ2V0OwoKICAgICAgICAgIHJldCA9IChfdGFyZ2V0ID0gdGFyZ2V0KS5zZW5kLmFwcGx5KF90YXJnZXQsIFthY3Rpb25dLmNvbmNhdChhY3Rpb25Db250ZXh0KSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBfdGFyZ2V0MjsKCiAgICAgICAgICAoZmFsc2UgJiYgISh0eXBlb2YgdGFyZ2V0W2FjdGlvbl0gPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiVGhlIGFjdGlvbiAnIiArIGFjdGlvbiArICInIGRpZCBub3QgZXhpc3Qgb24gIiArIHRhcmdldCwgdHlwZW9mIHRhcmdldFthY3Rpb25dID09PSAnZnVuY3Rpb24nKSk7CiAgICAgICAgICByZXQgPSAoX3RhcmdldDIgPSB0YXJnZXQpW2FjdGlvbl0uYXBwbHkoX3RhcmdldDIsIFtdLmNvbmNhdChhY3Rpb25Db250ZXh0KSk7CiAgICAgICAgfQoKICAgICAgICBpZiAocmV0ICE9PSBmYWxzZSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSk7CgogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKCiAgZnVuY3Rpb24gZ2V0VGFyZ2V0KGluc3RhbmNlKSB7CiAgICB2YXIgdGFyZ2V0ID0gKDAsIF9tZXRhbC5nZXQpKGluc3RhbmNlLCAndGFyZ2V0Jyk7CgogICAgaWYgKHRhcmdldCkgewogICAgICBpZiAodHlwZW9mIHRhcmdldCA9PT0gJ3N0cmluZycpIHsKICAgICAgICB2YXIgdmFsdWUgPSAoMCwgX21ldGFsLmdldCkoaW5zdGFuY2UsIHRhcmdldCk7CgogICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB2YWx1ZSA9ICgwLCBfbWV0YWwuZ2V0KShfZW52aXJvbm1lbnQuY29udGV4dC5sb29rdXAsIHRhcmdldCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgfQogICAgfQoKICAgIGlmIChpbnN0YW5jZS5fdGFyZ2V0KSB7CiAgICAgIHJldHVybiBpbnN0YW5jZS5fdGFyZ2V0OwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH0KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvc3lzdGVtL2FycmF5X3Byb3h5IiwgWyJleHBvcnRzIiwgImVtYmVyLWJhYmVsIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGFsIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL3N5c3RlbS9vYmplY3QiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvbWl4aW5zL2FycmF5IiwgIkBlbWJlci9kZWJ1ZyIsICJAZ2xpbW1lci9yZWZlcmVuY2UiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZW1iZXJCYWJlbCwgX21ldGFsLCBfb2JqZWN0LCBfYXJyYXksIF9kZWJ1ZywgX3JlZmVyZW5jZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvYXJyYXkKICAqLwogIHZhciBBUlJBWV9PQlNFUlZFUl9NQVBQSU5HID0gewogICAgd2lsbENoYW5nZTogJ19hcnJhbmdlZENvbnRlbnRBcnJheVdpbGxDaGFuZ2UnLAogICAgZGlkQ2hhbmdlOiAnX2FycmFuZ2VkQ29udGVudEFycmF5RGlkQ2hhbmdlJwogIH07CiAgLyoqCiAgICBBbiBBcnJheVByb3h5IHdyYXBzIGFueSBvdGhlciBvYmplY3QgdGhhdCBpbXBsZW1lbnRzIGBBcnJheWAgYW5kL29yCiAgICBgTXV0YWJsZUFycmF5LGAgZm9yd2FyZGluZyBhbGwgcmVxdWVzdHMuIFRoaXMgbWFrZXMgaXQgdmVyeSB1c2VmdWwgZm9yCiAgICBhIG51bWJlciBvZiBiaW5kaW5nIHVzZSBjYXNlcyBvciBvdGhlciBjYXNlcyB3aGVyZSBiZWluZyBhYmxlIHRvIHN3YXAKICAgIG91dCB0aGUgdW5kZXJseWluZyBhcnJheSBpcyB1c2VmdWwuCiAgCiAgICBBIHNpbXBsZSBleGFtcGxlIG9mIHVzYWdlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgQSB9IGZyb20gJ0BlbWJlci9hcnJheSc7CiAgICBpbXBvcnQgQXJyYXlQcm94eSBmcm9tICdAZW1iZXIvYXJyYXkvcHJveHknOwogIAogICAgbGV0IHBldHMgPSBbJ2RvZycsICdjYXQnLCAnZmlzaCddOwogICAgbGV0IGFwID0gQXJyYXlQcm94eS5jcmVhdGUoeyBjb250ZW50OiBBKHBldHMpIH0pOwogIAogICAgYXAuZ2V0KCdmaXJzdE9iamVjdCcpOyAgICAgICAgICAgICAgICAgICAgICAgIC8vICdkb2cnCiAgICBhcC5zZXQoJ2NvbnRlbnQnLCBbJ2Ftb2ViYScsICdwYXJhbWVjaXVtJ10pOwogICAgYXAuZ2V0KCdmaXJzdE9iamVjdCcpOyAgICAgICAgICAgICAgICAgICAgICAgIC8vICdhbW9lYmEnCiAgICBgYGAKICAKICAgIFRoaXMgY2xhc3MgY2FuIGFsc28gYmUgdXNlZnVsIGFzIGEgbGF5ZXIgdG8gdHJhbnNmb3JtIHRoZSBjb250ZW50cyBvZgogICAgYW4gYXJyYXksIGFzIHRoZXkgYXJlIGFjY2Vzc2VkLiBUaGlzIGNhbiBiZSBkb25lIGJ5IG92ZXJyaWRpbmcKICAgIGBvYmplY3RBdENvbnRlbnRgOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgQSB9IGZyb20gJ0BlbWJlci9hcnJheSc7CiAgICBpbXBvcnQgQXJyYXlQcm94eSBmcm9tICdAZW1iZXIvYXJyYXkvcHJveHknOwogIAogICAgbGV0IHBldHMgPSBbJ2RvZycsICdjYXQnLCAnZmlzaCddOwogICAgbGV0IGFwID0gQXJyYXlQcm94eS5jcmVhdGUoewogICAgICAgIGNvbnRlbnQ6IEEocGV0cyksCiAgICAgICAgb2JqZWN0QXRDb250ZW50OiBmdW5jdGlvbihpZHgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KCdjb250ZW50Jykub2JqZWN0QXQoaWR4KS50b1VwcGVyQ2FzZSgpOwogICAgICAgIH0KICAgIH0pOwogIAogICAgYXAuZ2V0KCdmaXJzdE9iamVjdCcpOyAvLyAuICdET0cnCiAgICBgYGAKICAKICAgIFdoZW4gb3ZlcnJpZGluZyB0aGlzIGNsYXNzLCBpdCBpcyBpbXBvcnRhbnQgdG8gcGxhY2UgdGhlIGNhbGwgdG8KICAgIGBfc3VwZXJgICphZnRlciogc2V0dGluZyBgY29udGVudGAgc28gdGhlIGludGVybmFsIG9ic2VydmVycyBoYXZlCiAgICBhIGNoYW5jZSB0byBmaXJlIHByb3Blcmx5OgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgQSB9IGZyb20gJ0BlbWJlci9hcnJheSc7CiAgICBpbXBvcnQgQXJyYXlQcm94eSBmcm9tICdAZW1iZXIvYXJyYXkvcHJveHknOwogIAogICAgZXhwb3J0IGRlZmF1bHQgQXJyYXlQcm94eS5leHRlbmQoewogICAgICBpbml0KCkgewogICAgICAgIHRoaXMuc2V0KCdjb250ZW50JywgQShbJ2RvZycsICdjYXQnLCAnZmlzaCddKSk7CiAgICAgICAgdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIEBjbGFzcyBBcnJheVByb3h5CiAgICBAZXh0ZW5kcyBFbWJlck9iamVjdAogICAgQHVzZXMgTXV0YWJsZUFycmF5CiAgICBAcHVibGljCiAgKi8KCiAgdmFyIEFycmF5UHJveHkgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0VtYmVyT2JqZWN0KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoQXJyYXlQcm94eSwgX0VtYmVyT2JqZWN0KTsKCiAgICBmdW5jdGlvbiBBcnJheVByb3h5KCkgewogICAgICByZXR1cm4gX0VtYmVyT2JqZWN0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgIH0KCiAgICB2YXIgX3Byb3RvID0gQXJyYXlQcm94eS5wcm90b3R5cGU7CgogICAgX3Byb3RvLmluaXQgPSBmdW5jdGlvbiBpbml0KCkgewogICAgICBfRW1iZXJPYmplY3QucHJvdG90eXBlLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgLyoKICAgICAgICBgdGhpcy5fb2JqZWN0c0RpcnR5SW5kZXhgIGRldGVybWluZXMgd2hpY2ggaW5kZXhlcyBpbiB0aGUgYHRoaXMuX29iamVjdHNgCiAgICAgICAgY2FjaGUgYXJlIGRpcnR5LgogICAgICAgICBJZiBgdGhpcy5fb2JqZWN0c0RpcnR5SW5kZXggPT09IC0xYCB0aGVuIG5vIGluZGV4ZXMgYXJlIGRpcnR5LgogICAgICAgIE90aGVyd2lzZSwgYW4gaW5kZXggYGlgIGlzIGRpcnR5IGlmIGBpID49IHRoaXMuX29iamVjdHNEaXJ0eUluZGV4YC4KICAgICAgICAgQ2FsbGluZyBgb2JqZWN0QXRgIHdpdGggYSBkaXJ0eSBpbmRleCB3aWxsIGNhdXNlIHRoZSBgdGhpcy5fb2JqZWN0c2AKICAgICAgICBjYWNoZSB0byBiZSByZWNvbXB1dGVkLgogICAgICAqLwoKCiAgICAgIHRoaXMuX29iamVjdHNEaXJ0eUluZGV4ID0gMDsKICAgICAgdGhpcy5fb2JqZWN0cyA9IG51bGw7CiAgICAgIHRoaXMuX2xlbmd0aERpcnR5ID0gdHJ1ZTsKICAgICAgdGhpcy5fbGVuZ3RoID0gMDsKICAgICAgdGhpcy5fYXJyYW5nZWRDb250ZW50ID0gbnVsbDsKCiAgICAgIGlmICh0cnVlCiAgICAgIC8qIEVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyAqLwogICAgICApIHsKICAgICAgICAgIHRoaXMuX2FycmFuZ2VkQ29udGVudElzVXBkYXRpbmcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuX2FycmFuZ2VkQ29udGVudFRhZyA9ICgwLCBfcmVmZXJlbmNlLmNvbWJpbmUpKCgwLCBfbWV0YWwuZ2V0Q2hhaW5UYWdzRm9yS2V5KSh0aGlzLCAnYXJyYW5nZWRDb250ZW50JykpOwogICAgICAgICAgdGhpcy5fYXJyYW5nZWRDb250ZW50UmV2aXNpb24gPSAoMCwgX3JlZmVyZW5jZS52YWx1ZSkodGhpcy5fYXJyYW5nZWRDb250ZW50VGFnKTsKICAgICAgICB9CgogICAgICB0aGlzLl9hZGRBcnJhbmdlZENvbnRlbnRBcnJheU9ic2V2ZXIoKTsKICAgIH07CgogICAgX3Byb3RvLndpbGxEZXN0cm95ID0gZnVuY3Rpb24gd2lsbERlc3Ryb3koKSB7CiAgICAgIHRoaXMuX3JlbW92ZUFycmFuZ2VkQ29udGVudEFycmF5T2JzZXZlcigpOwogICAgfQogICAgLyoqCiAgICAgIFRoZSBjb250ZW50IGFycmF5LiBNdXN0IGJlIGFuIG9iamVjdCB0aGF0IGltcGxlbWVudHMgYEFycmF5YCBhbmQvb3IKICAgICAgYE11dGFibGVBcnJheS5gCiAgICAgICBAcHJvcGVydHkgY29udGVudAogICAgICBAdHlwZSBFbWJlckFycmF5CiAgICAgIEBwdWJsaWMKICAgICovCgogICAgLyoqCiAgICAgIFNob3VsZCBhY3R1YWxseSByZXRyaWV2ZSB0aGUgb2JqZWN0IGF0IHRoZSBzcGVjaWZpZWQgaW5kZXggZnJvbSB0aGUKICAgICAgY29udGVudC4gWW91IGNhbiBvdmVycmlkZSB0aGlzIG1ldGhvZCBpbiBzdWJjbGFzc2VzIHRvIHRyYW5zZm9ybSB0aGUKICAgICAgY29udGVudCBpdGVtIHRvIHNvbWV0aGluZyBuZXcuCiAgICAgICBUaGlzIG1ldGhvZCB3aWxsIG9ubHkgYmUgY2FsbGVkIGlmIGNvbnRlbnQgaXMgbm9uLWBudWxsYC4KICAgICAgIEBtZXRob2Qgb2JqZWN0QXRDb250ZW50CiAgICAgIEBwYXJhbSB7TnVtYmVyfSBpZHggVGhlIGluZGV4IHRvIHJldHJpZXZlLgogICAgICBAcmV0dXJuIHtPYmplY3R9IHRoZSB2YWx1ZSBvciB1bmRlZmluZWQgaWYgbm9uZSBmb3VuZAogICAgICBAcHVibGljCiAgICAqLwogICAgOwoKICAgIF9wcm90by5vYmplY3RBdENvbnRlbnQgPSBmdW5jdGlvbiBvYmplY3RBdENvbnRlbnQoaWR4KSB7CiAgICAgIHJldHVybiAoMCwgX21ldGFsLm9iamVjdEF0KSgoMCwgX21ldGFsLmdldCkodGhpcywgJ2FycmFuZ2VkQ29udGVudCcpLCBpZHgpOwogICAgfSAvLyBTZWUgYWRkaXRpb25hbCBkb2NzIGZvciBgcmVwbGFjZWAgZnJvbSBgTXV0YWJsZUFycmF5YDoKICAgIC8vIGh0dHBzOi8vYXBpLmVtYmVyanMuY29tL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9NdXRhYmxlQXJyYXkvbWV0aG9kcy9yZXBsYWNlP2FuY2hvcj1yZXBsYWNlCiAgICA7CgogICAgX3Byb3RvLnJlcGxhY2UgPSBmdW5jdGlvbiByZXBsYWNlKGlkeCwgYW10LCBvYmplY3RzKSB7CiAgICAgIChmYWxzZSAmJiAhKCgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAnYXJyYW5nZWRDb250ZW50JykgPT09ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAnY29udGVudCcpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ011dGF0aW5nIGFuIGFycmFuZ2VkIEFycmF5UHJveHkgaXMgbm90IGFsbG93ZWQnLCAoMCwgX21ldGFsLmdldCkodGhpcywgJ2FycmFuZ2VkQ29udGVudCcpID09PSAoMCwgX21ldGFsLmdldCkodGhpcywgJ2NvbnRlbnQnKSkpOwogICAgICB0aGlzLnJlcGxhY2VDb250ZW50KGlkeCwgYW10LCBvYmplY3RzKTsKICAgIH0KICAgIC8qKgogICAgICBTaG91bGQgYWN0dWFsbHkgcmVwbGFjZSB0aGUgc3BlY2lmaWVkIG9iamVjdHMgb24gdGhlIGNvbnRlbnQgYXJyYXkuCiAgICAgIFlvdSBjYW4gb3ZlcnJpZGUgdGhpcyBtZXRob2QgaW4gc3ViY2xhc3NlcyB0byB0cmFuc2Zvcm0gdGhlIGNvbnRlbnQgaXRlbQogICAgICBpbnRvIHNvbWV0aGluZyBuZXcuCiAgICAgICBUaGlzIG1ldGhvZCB3aWxsIG9ubHkgYmUgY2FsbGVkIGlmIGNvbnRlbnQgaXMgbm9uLWBudWxsYC4KICAgICAgIEBtZXRob2QgcmVwbGFjZUNvbnRlbnQKICAgICAgQHBhcmFtIHtOdW1iZXJ9IGlkeCBUaGUgc3RhcnRpbmcgaW5kZXgKICAgICAgQHBhcmFtIHtOdW1iZXJ9IGFtdCBUaGUgbnVtYmVyIG9mIGl0ZW1zIHRvIHJlbW92ZSBmcm9tIHRoZSBjb250ZW50LgogICAgICBAcGFyYW0ge0VtYmVyQXJyYXl9IG9iamVjdHMgT3B0aW9uYWwgYXJyYXkgb2Ygb2JqZWN0cyB0byBpbnNlcnQgb3IgbnVsbCBpZiBubwogICAgICAgIG9iamVjdHMuCiAgICAgIEByZXR1cm4ge3ZvaWR9CiAgICAgIEBwdWJsaWMKICAgICovCiAgICA7CgogICAgX3Byb3RvLnJlcGxhY2VDb250ZW50ID0gZnVuY3Rpb24gcmVwbGFjZUNvbnRlbnQoaWR4LCBhbXQsIG9iamVjdHMpIHsKICAgICAgKDAsIF9tZXRhbC5nZXQpKHRoaXMsICdjb250ZW50JykucmVwbGFjZShpZHgsIGFtdCwgb2JqZWN0cyk7CiAgICB9IC8vIE92ZXJyaWRpbmcgb2JqZWN0QXQgaXMgbm90IHN1cHBvcnRlZC4KICAgIDsKCiAgICBfcHJvdG8ub2JqZWN0QXQgPSBmdW5jdGlvbiBvYmplY3RBdChpZHgpIHsKICAgICAgaWYgKHRydWUKICAgICAgLyogRU1CRVJfTUVUQUxfVFJBQ0tFRF9QUk9QRVJUSUVTICovCiAgICAgICkgewogICAgICAgICAgdGhpcy5fcmV2YWxpZGF0ZSgpOwogICAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9vYmplY3RzID09PSBudWxsKSB7CiAgICAgICAgdGhpcy5fb2JqZWN0cyA9IFtdOwogICAgICB9CgogICAgICBpZiAodGhpcy5fb2JqZWN0c0RpcnR5SW5kZXggIT09IC0xICYmIGlkeCA+PSB0aGlzLl9vYmplY3RzRGlydHlJbmRleCkgewogICAgICAgIHZhciBhcnJhbmdlZENvbnRlbnQgPSAoMCwgX21ldGFsLmdldCkodGhpcywgJ2FycmFuZ2VkQ29udGVudCcpOwoKICAgICAgICBpZiAoYXJyYW5nZWRDb250ZW50KSB7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gdGhpcy5fb2JqZWN0cy5sZW5ndGggPSAoMCwgX21ldGFsLmdldCkoYXJyYW5nZWRDb250ZW50LCAnbGVuZ3RoJyk7CgogICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuX29iamVjdHNEaXJ0eUluZGV4OyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5fb2JqZWN0c1tpXSA9IHRoaXMub2JqZWN0QXRDb250ZW50KGkpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl9vYmplY3RzLmxlbmd0aCA9IDA7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9vYmplY3RzRGlydHlJbmRleCA9IC0xOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fb2JqZWN0c1tpZHhdOwogICAgfSAvLyBPdmVycmlkaW5nIGxlbmd0aCBpcyBub3Qgc3VwcG9ydGVkLgogICAgOwoKICAgIF9wcm90b1tfbWV0YWwuUFJPUEVSVFlfRElEX0NIQU5HRV0gPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGlmICh0cnVlCiAgICAgIC8qIEVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyAqLwogICAgICApIHsKICAgICAgICAgIHRoaXMuX3JldmFsaWRhdGUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgIGlmIChrZXkgPT09ICdhcnJhbmdlZENvbnRlbnQnKSB7CiAgICAgICAgICB0aGlzLl91cGRhdGVBcnJhbmdlZENvbnRlbnRBcnJheSgpOwogICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnY29udGVudCcpIHsKICAgICAgICAgIHRoaXMuX2ludmFsaWRhdGUoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLl91cGRhdGVBcnJhbmdlZENvbnRlbnRBcnJheSA9IGZ1bmN0aW9uIF91cGRhdGVBcnJhbmdlZENvbnRlbnRBcnJheSgpIHsKICAgICAgdmFyIG9sZExlbmd0aCA9IHRoaXMuX29iamVjdHMgPT09IG51bGwgPyAwIDogdGhpcy5fb2JqZWN0cy5sZW5ndGg7CiAgICAgIHZhciBhcnJhbmdlZENvbnRlbnQgPSAoMCwgX21ldGFsLmdldCkodGhpcywgJ2FycmFuZ2VkQ29udGVudCcpOwogICAgICB2YXIgbmV3TGVuZ3RoID0gYXJyYW5nZWRDb250ZW50ID8gKDAsIF9tZXRhbC5nZXQpKGFycmFuZ2VkQ29udGVudCwgJ2xlbmd0aCcpIDogMDsKCiAgICAgIHRoaXMuX3JlbW92ZUFycmFuZ2VkQ29udGVudEFycmF5T2JzZXZlcigpOwoKICAgICAgdGhpcy5hcnJheUNvbnRlbnRXaWxsQ2hhbmdlKDAsIG9sZExlbmd0aCwgbmV3TGVuZ3RoKTsKCiAgICAgIHRoaXMuX2ludmFsaWRhdGUoKTsKCiAgICAgIHRoaXMuYXJyYXlDb250ZW50RGlkQ2hhbmdlKDAsIG9sZExlbmd0aCwgbmV3TGVuZ3RoKTsKCiAgICAgIHRoaXMuX2FkZEFycmFuZ2VkQ29udGVudEFycmF5T2JzZXZlcigpOwogICAgfTsKCiAgICBfcHJvdG8uX2FkZEFycmFuZ2VkQ29udGVudEFycmF5T2JzZXZlciA9IGZ1bmN0aW9uIF9hZGRBcnJhbmdlZENvbnRlbnRBcnJheU9ic2V2ZXIoKSB7CiAgICAgIHZhciBhcnJhbmdlZENvbnRlbnQgPSAoMCwgX21ldGFsLmdldCkodGhpcywgJ2FycmFuZ2VkQ29udGVudCcpOwoKICAgICAgaWYgKGFycmFuZ2VkQ29udGVudCAmJiAhYXJyYW5nZWRDb250ZW50LmlzRGVzdHJveWVkKSB7CiAgICAgICAgKGZhbHNlICYmICEoYXJyYW5nZWRDb250ZW50ICE9PSB0aGlzKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkNhbid0IHNldCBBcnJheVByb3h5J3MgY29udGVudCB0byBpdHNlbGYiLCBhcnJhbmdlZENvbnRlbnQgIT09IHRoaXMpKTsKICAgICAgICAoZmFsc2UgJiYgISgoMCwgX2FycmF5LmlzQXJyYXkpKGFycmFuZ2VkQ29udGVudCkgfHwgYXJyYW5nZWRDb250ZW50LmlzRGVzdHJveWVkKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkFycmF5UHJveHkgZXhwZWN0cyBhbiBBcnJheSBvciBBcnJheVByb3h5LCBidXQgeW91IHBhc3NlZCAiICsgdHlwZW9mIGFycmFuZ2VkQ29udGVudCwgKDAsIF9hcnJheS5pc0FycmF5KShhcnJhbmdlZENvbnRlbnQpIHx8IGFycmFuZ2VkQ29udGVudC5pc0Rlc3Ryb3llZCkpOwogICAgICAgICgwLCBfbWV0YWwuYWRkQXJyYXlPYnNlcnZlcikoYXJyYW5nZWRDb250ZW50LCB0aGlzLCBBUlJBWV9PQlNFUlZFUl9NQVBQSU5HKTsKICAgICAgICB0aGlzLl9hcnJhbmdlZENvbnRlbnQgPSBhcnJhbmdlZENvbnRlbnQ7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLl9yZW1vdmVBcnJhbmdlZENvbnRlbnRBcnJheU9ic2V2ZXIgPSBmdW5jdGlvbiBfcmVtb3ZlQXJyYW5nZWRDb250ZW50QXJyYXlPYnNldmVyKCkgewogICAgICBpZiAodGhpcy5fYXJyYW5nZWRDb250ZW50KSB7CiAgICAgICAgKDAsIF9tZXRhbC5yZW1vdmVBcnJheU9ic2VydmVyKSh0aGlzLl9hcnJhbmdlZENvbnRlbnQsIHRoaXMsIEFSUkFZX09CU0VSVkVSX01BUFBJTkcpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5fYXJyYW5nZWRDb250ZW50QXJyYXlXaWxsQ2hhbmdlID0gZnVuY3Rpb24gX2FycmFuZ2VkQ29udGVudEFycmF5V2lsbENoYW5nZSgpIHt9OwoKICAgIF9wcm90by5fYXJyYW5nZWRDb250ZW50QXJyYXlEaWRDaGFuZ2UgPSBmdW5jdGlvbiBfYXJyYW5nZWRDb250ZW50QXJyYXlEaWRDaGFuZ2UocHJveHksIGlkeCwgcmVtb3ZlZENudCwgYWRkZWRDbnQpIHsKICAgICAgdGhpcy5hcnJheUNvbnRlbnRXaWxsQ2hhbmdlKGlkeCwgcmVtb3ZlZENudCwgYWRkZWRDbnQpOwogICAgICB2YXIgZGlydHlJbmRleCA9IGlkeDsKCiAgICAgIGlmIChkaXJ0eUluZGV4IDwgMCkgewogICAgICAgIHZhciBsZW5ndGggPSAoMCwgX21ldGFsLmdldCkodGhpcy5fYXJyYW5nZWRDb250ZW50LCAnbGVuZ3RoJyk7CiAgICAgICAgZGlydHlJbmRleCArPSBsZW5ndGggKyByZW1vdmVkQ250IC0gYWRkZWRDbnQ7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9vYmplY3RzRGlydHlJbmRleCA9PT0gLTEgfHwgdGhpcy5fb2JqZWN0c0RpcnR5SW5kZXggPiBkaXJ0eUluZGV4KSB7CiAgICAgICAgdGhpcy5fb2JqZWN0c0RpcnR5SW5kZXggPSBkaXJ0eUluZGV4OwogICAgICB9CgogICAgICB0aGlzLl9sZW5ndGhEaXJ0eSA9IHRydWU7CiAgICAgIHRoaXMuYXJyYXlDb250ZW50RGlkQ2hhbmdlKGlkeCwgcmVtb3ZlZENudCwgYWRkZWRDbnQpOwogICAgfTsKCiAgICBfcHJvdG8uX2ludmFsaWRhdGUgPSBmdW5jdGlvbiBfaW52YWxpZGF0ZSgpIHsKICAgICAgdGhpcy5fb2JqZWN0c0RpcnR5SW5kZXggPSAwOwogICAgICB0aGlzLl9sZW5ndGhEaXJ0eSA9IHRydWU7CiAgICB9OwoKICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoQXJyYXlQcm94eSwgW3sKICAgICAga2V5OiAibGVuZ3RoIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgaWYgKHRydWUKICAgICAgICAvKiBFTUJFUl9NRVRBTF9UUkFDS0VEX1BST1BFUlRJRVMgKi8KICAgICAgICApIHsKICAgICAgICAgICAgdGhpcy5fcmV2YWxpZGF0ZSgpOwogICAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fbGVuZ3RoRGlydHkpIHsKICAgICAgICAgIHZhciBhcnJhbmdlZENvbnRlbnQgPSAoMCwgX21ldGFsLmdldCkodGhpcywgJ2FycmFuZ2VkQ29udGVudCcpOwogICAgICAgICAgdGhpcy5fbGVuZ3RoID0gYXJyYW5nZWRDb250ZW50ID8gKDAsIF9tZXRhbC5nZXQpKGFycmFuZ2VkQ29udGVudCwgJ2xlbmd0aCcpIDogMDsKICAgICAgICAgIHRoaXMuX2xlbmd0aERpcnR5ID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5fbGVuZ3RoOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldCh2YWx1ZSkgewogICAgICAgIHZhciBsZW5ndGggPSB0aGlzLmxlbmd0aDsKICAgICAgICB2YXIgcmVtb3ZlZENvdW50ID0gbGVuZ3RoIC0gdmFsdWU7CiAgICAgICAgdmFyIGFkZGVkOwoKICAgICAgICBpZiAocmVtb3ZlZENvdW50ID09PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfSBlbHNlIGlmIChyZW1vdmVkQ291bnQgPCAwKSB7CiAgICAgICAgICBhZGRlZCA9IG5ldyBBcnJheSgtcmVtb3ZlZENvdW50KTsKICAgICAgICAgIHJlbW92ZWRDb3VudCA9IDA7CiAgICAgICAgfQoKICAgICAgICB2YXIgY29udGVudCA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAnY29udGVudCcpOwoKICAgICAgICBpZiAoY29udGVudCkgewogICAgICAgICAgKDAsIF9tZXRhbC5yZXBsYWNlKShjb250ZW50LCB2YWx1ZSwgcmVtb3ZlZENvdW50LCBhZGRlZCk7CgogICAgICAgICAgdGhpcy5faW52YWxpZGF0ZSgpOwogICAgICAgIH0KICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEFycmF5UHJveHk7CiAgfShfb2JqZWN0LmRlZmF1bHQpOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gQXJyYXlQcm94eTsKCiAgdmFyIF9yZXZhbGlkYXRlOwoKICBpZiAodHJ1ZQogIC8qIEVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyAqLwogICkgewogICAgICBfcmV2YWxpZGF0ZSA9IGZ1bmN0aW9uIF9yZXZhbGlkYXRlKCkgewogICAgICAgIGlmICghdGhpcy5fYXJyYW5nZWRDb250ZW50SXNVcGRhdGluZyAmJiAhKDAsIF9yZWZlcmVuY2UudmFsaWRhdGUpKHRoaXMuX2FycmFuZ2VkQ29udGVudFRhZywgdGhpcy5fYXJyYW5nZWRDb250ZW50UmV2aXNpb24pKSB7CiAgICAgICAgICB0aGlzLl9hcnJhbmdlZENvbnRlbnRJc1VwZGF0aW5nID0gdHJ1ZTsKCiAgICAgICAgICB0aGlzLl91cGRhdGVBcnJhbmdlZENvbnRlbnRBcnJheSgpOwoKICAgICAgICAgIHRoaXMuX2FycmFuZ2VkQ29udGVudElzVXBkYXRpbmcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuX2FycmFuZ2VkQ29udGVudFRhZyA9ICgwLCBfcmVmZXJlbmNlLmNvbWJpbmUpKCgwLCBfbWV0YWwuZ2V0Q2hhaW5UYWdzRm9yS2V5KSh0aGlzLCAnYXJyYW5nZWRDb250ZW50JykpOwogICAgICAgICAgdGhpcy5fYXJyYW5nZWRDb250ZW50UmV2aXNpb24gPSAoMCwgX3JlZmVyZW5jZS52YWx1ZSkodGhpcy5fYXJyYW5nZWRDb250ZW50VGFnKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CgogIEFycmF5UHJveHkucmVvcGVuKF9hcnJheS5NdXRhYmxlQXJyYXksIHsKICAgIC8qKgogICAgICBUaGUgYXJyYXkgdGhhdCB0aGUgcHJveHkgcHJldGVuZHMgdG8gYmUuIEluIHRoZSBkZWZhdWx0IGBBcnJheVByb3h5YAogICAgICBpbXBsZW1lbnRhdGlvbiwgdGhpcyBhbmQgYGNvbnRlbnRgIGFyZSB0aGUgc2FtZS4gU3ViY2xhc3NlcyBvZiBgQXJyYXlQcm94eWAKICAgICAgY2FuIG92ZXJyaWRlIHRoaXMgcHJvcGVydHkgdG8gcHJvdmlkZSB0aGluZ3MgbGlrZSBzb3J0aW5nIGFuZCBmaWx0ZXJpbmcuCiAgICAgICBAcHJvcGVydHkgYXJyYW5nZWRDb250ZW50CiAgICAgIEBwdWJsaWMKICAgICovCiAgICBhcnJhbmdlZENvbnRlbnQ6ICgwLCBfbWV0YWwuYWxpYXMpKCdjb250ZW50JyksCiAgICBfcmV2YWxpZGF0ZTogX3JldmFsaWRhdGUKICB9KTsKfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvc3lzdGVtL2NvcmVfb2JqZWN0IiwgWyJleHBvcnRzIiwgImVtYmVyLWJhYmVsIiwgIkBlbWJlci8taW50ZXJuYWxzL2NvbnRhaW5lciIsICJAZW1iZXIvLWludGVybmFscy9vd25lciIsICJAZW1iZXIvcG9seWZpbGxzIiwgIkBlbWJlci8taW50ZXJuYWxzL3V0aWxzIiwgIkBlbWJlci9ydW5sb29wIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGEiLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvbWl4aW5zL2FjdGlvbl9oYW5kbGVyIiwgIkBlbWJlci9kZWJ1ZyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9lbWJlckJhYmVsLCBfY29udGFpbmVyLCBfb3duZXIsIF9wb2x5ZmlsbHMsIF91dGlscywgX3J1bmxvb3AsIF9tZXRhMiwgX21ldGFsLCBfYWN0aW9uX2hhbmRsZXIsIF9kZWJ1ZykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuc2V0RnJhbWV3b3JrQ2xhc3MgPSBzZXRGcmFtZXdvcmtDbGFzczsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyL29iamVjdAogICovCiAgdmFyIF9yZW9wZW4gPSBfbWV0YWwuTWl4aW4ucHJvdG90eXBlLnJlb3BlbjsKICB2YXIgd2FzQXBwbGllZCA9IG5ldyBfcG9seWZpbGxzLl9XZWFrU2V0KCk7CiAgdmFyIGZhY3RvcnlNYXAgPSBuZXcgV2Vha01hcCgpOwogIHZhciBwcm90b3R5cGVNaXhpbk1hcCA9IG5ldyBXZWFrTWFwKCk7CiAgdmFyIGluaXRDYWxsZWQgPSBmYWxzZQogIC8qIERFQlVHICovCiAgPyBuZXcgX3BvbHlmaWxscy5fV2Vha1NldCgpIDogdW5kZWZpbmVkOyAvLyBvbmx5IHVzZWQgaW4gZGVidWcgYnVpbGRzIHRvIGVuYWJsZSB0aGUgcHJveHkgdHJhcAoKICB2YXIgUEFTU0VEX0ZST01fQ1JFQVRFID0gZmFsc2UKICAvKiBERUJVRyAqLwogID8gKDAsIF91dGlscy5zeW1ib2wpKCdQQVNTRURfRlJPTV9DUkVBVEUnKSA6IHVuZGVmaW5lZDsKICB2YXIgRlJBTUVXT1JLX0NMQVNTRVMgPSAoMCwgX3V0aWxzLnN5bWJvbCkoJ0ZSQU1FV09SS19DTEFTUycpOwoKICBmdW5jdGlvbiBzZXRGcmFtZXdvcmtDbGFzcyhrbGFzcykgewogICAga2xhc3NbRlJBTUVXT1JLX0NMQVNTRVNdID0gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIGluaXRpYWxpemUob2JqLCBwcm9wZXJ0aWVzKSB7CiAgICB2YXIgbSA9ICgwLCBfbWV0YTIubWV0YSkob2JqKTsKCiAgICBpZiAocHJvcGVydGllcyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIChmYWxzZSAmJiAhKHR5cGVvZiBwcm9wZXJ0aWVzID09PSAnb2JqZWN0JyAmJiBwcm9wZXJ0aWVzICE9PSBudWxsKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0VtYmVyT2JqZWN0LmNyZWF0ZSBvbmx5IGFjY2VwdHMgb2JqZWN0cy4nLCB0eXBlb2YgcHJvcGVydGllcyA9PT0gJ29iamVjdCcgJiYgcHJvcGVydGllcyAhPT0gbnVsbCkpOwogICAgICAoZmFsc2UgJiYgISghKHByb3BlcnRpZXMgaW5zdGFuY2VvZiBfbWV0YWwuTWl4aW4pKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0VtYmVyT2JqZWN0LmNyZWF0ZSBubyBsb25nZXIgc3VwcG9ydHMgbWl4aW5nIGluIG90aGVyICcgKyAnZGVmaW5pdGlvbnMsIHVzZSAuZXh0ZW5kICYgLmNyZWF0ZSBzZXBhcmF0ZWx5IGluc3RlYWQuJywgIShwcm9wZXJ0aWVzIGluc3RhbmNlb2YgX21ldGFsLk1peGluKSkpOwogICAgICB2YXIgY29uY2F0ZW5hdGVkUHJvcGVydGllcyA9IG9iai5jb25jYXRlbmF0ZWRQcm9wZXJ0aWVzOwogICAgICB2YXIgbWVyZ2VkUHJvcGVydGllcyA9IG9iai5tZXJnZWRQcm9wZXJ0aWVzOwogICAgICB2YXIgaGFzQ29uY2F0ZW5hdGVkUHJvcHMgPSBjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQgJiYgY29uY2F0ZW5hdGVkUHJvcGVydGllcy5sZW5ndGggPiAwOwogICAgICB2YXIgaGFzTWVyZ2VkUHJvcHMgPSBtZXJnZWRQcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQgJiYgbWVyZ2VkUHJvcGVydGllcy5sZW5ndGggPiAwOwogICAgICB2YXIga2V5TmFtZXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5TmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIga2V5TmFtZSA9IGtleU5hbWVzW2ldOwogICAgICAgIHZhciB2YWx1ZSA9IHByb3BlcnRpZXNba2V5TmFtZV07CiAgICAgICAgKGZhbHNlICYmICEoISgwLCBfbWV0YWwuaXNDbGFzc2ljRGVjb3JhdG9yKSh2YWx1ZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnRW1iZXJPYmplY3QuY3JlYXRlIG5vIGxvbmdlciBzdXBwb3J0cyBkZWZpbmluZyBjb21wdXRlZCAnICsgJ3Byb3BlcnRpZXMuIERlZmluZSBjb21wdXRlZCBwcm9wZXJ0aWVzIHVzaW5nIGV4dGVuZCgpIG9yIHJlb3BlbigpICcgKyAnYmVmb3JlIGNhbGxpbmcgY3JlYXRlKCkuJywgISgwLCBfbWV0YWwuaXNDbGFzc2ljRGVjb3JhdG9yKSh2YWx1ZSkpKTsKICAgICAgICAoZmFsc2UgJiYgISghKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyAmJiB2YWx1ZS50b1N0cmluZygpLmluZGV4T2YoJy5fc3VwZXInKSAhPT0gLTEpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0VtYmVyT2JqZWN0LmNyZWF0ZSBubyBsb25nZXIgc3VwcG9ydHMgZGVmaW5pbmcgbWV0aG9kcyB0aGF0IGNhbGwgX3N1cGVyLicsICEodHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nICYmIHZhbHVlLnRvU3RyaW5nKCkuaW5kZXhPZignLl9zdXBlcicpICE9PSAtMSkpKTsKICAgICAgICAoZmFsc2UgJiYgISghKGtleU5hbWUgPT09ICdhY3Rpb25zJyAmJiBfYWN0aW9uX2hhbmRsZXIuZGVmYXVsdC5kZXRlY3Qob2JqKSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnYGFjdGlvbnNgIG11c3QgYmUgcHJvdmlkZWQgYXQgZXh0ZW5kIHRpbWUsIG5vdCBhdCBjcmVhdGUgdGltZSwgJyArICd3aGVuIEVtYmVyLkFjdGlvbkhhbmRsZXIgaXMgdXNlZCAoaS5lLiB2aWV3cywgY29udHJvbGxlcnMgJiByb3V0ZXMpLicsICEoa2V5TmFtZSA9PT0gJ2FjdGlvbnMnICYmIF9hY3Rpb25faGFuZGxlci5kZWZhdWx0LmRldGVjdChvYmopKSkpOwogICAgICAgIHZhciBwb3NzaWJsZURlc2MgPSAoMCwgX21ldGFsLmRlc2NyaXB0b3JGb3JQcm9wZXJ0eSkob2JqLCBrZXlOYW1lLCBtKTsKICAgICAgICB2YXIgaXNEZXNjcmlwdG9yID0gcG9zc2libGVEZXNjICE9PSB1bmRlZmluZWQ7CgogICAgICAgIGlmICghaXNEZXNjcmlwdG9yKSB7CiAgICAgICAgICB2YXIgYmFzZVZhbHVlID0gb2JqW2tleU5hbWVdOwoKICAgICAgICAgIGlmIChoYXNDb25jYXRlbmF0ZWRQcm9wcyAmJiBjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzLmluZGV4T2Yoa2V5TmFtZSkgPiAtMSkgewogICAgICAgICAgICBpZiAoYmFzZVZhbHVlKSB7CiAgICAgICAgICAgICAgdmFsdWUgPSAoMCwgX3V0aWxzLm1ha2VBcnJheSkoYmFzZVZhbHVlKS5jb25jYXQodmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhbHVlID0gKDAsIF91dGlscy5tYWtlQXJyYXkpKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGlmIChoYXNNZXJnZWRQcm9wcyAmJiBtZXJnZWRQcm9wZXJ0aWVzLmluZGV4T2Yoa2V5TmFtZSkgPiAtMSkgewogICAgICAgICAgICB2YWx1ZSA9ICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIGJhc2VWYWx1ZSwgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGlzRGVzY3JpcHRvcikgewogICAgICAgICAgcG9zc2libGVEZXNjLnNldChvYmosIGtleU5hbWUsIHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmouc2V0VW5rbm93blByb3BlcnR5ID09PSAnZnVuY3Rpb24nICYmICEoa2V5TmFtZSBpbiBvYmopKSB7CiAgICAgICAgICBvYmouc2V0VW5rbm93blByb3BlcnR5KGtleU5hbWUsIHZhbHVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGZhbHNlCiAgICAgICAgICAvKiBERUJVRyAqLwogICAgICAgICAgKSB7CiAgICAgICAgICAgICgwLCBfbWV0YWwuZGVmaW5lUHJvcGVydHkpKG9iaiwga2V5TmFtZSwgbnVsbCwgdmFsdWUsIG0pOyAvLyBzZXR1cCBtYW5kYXRvcnkgc2V0dGVyCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvYmpba2V5TmFtZV0gPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gLy8gdXNpbmcgREVCVUcgaGVyZSB0byBhdm9pZCB0aGUgZXh0cmFuZW91cyB2YXJpYWJsZSB3aGVuIG5vdCBuZWVkZWQKCgogICAgaWYgKGZhbHNlCiAgICAvKiBERUJVRyAqLwogICAgKSB7CiAgICAgIGluaXRDYWxsZWQuYWRkKG9iaik7CiAgICB9CgogICAgb2JqLmluaXQocHJvcGVydGllcyk7CiAgICBtLnVuc2V0SW5pdGlhbGl6aW5nKCk7CgogICAgaWYgKHRydWUKICAgIC8qIEVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyAqLwogICAgKSB7CiAgICAgICAgdmFyIG9ic2VydmVyRXZlbnRzID0gbS5vYnNlcnZlckV2ZW50cygpOwoKICAgICAgICBpZiAob2JzZXJ2ZXJFdmVudHMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IG9ic2VydmVyRXZlbnRzLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAoMCwgX21ldGFsLmFjdGl2YXRlT2JzZXJ2ZXIpKG9iaiwgb2JzZXJ2ZXJFdmVudHNbX2ldLmV2ZW50LCBvYnNlcnZlckV2ZW50c1tfaV0uc3luYyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAvLyByZS1lbmFibGUgY2hhaW5zCiAgICAgICgwLCBfbWV0YWwuZmluaXNoQ2hhaW5zKShtKTsKICAgIH0KCiAgICAoMCwgX21ldGFsLnNlbmRFdmVudCkob2JqLCAnaW5pdCcsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIG0pOwogIH0KICAvKioKICAgIGBDb3JlT2JqZWN0YCBpcyB0aGUgYmFzZSBjbGFzcyBmb3IgYWxsIEVtYmVyIGNvbnN0cnVjdHMuIEl0IGVzdGFibGlzaGVzIGEKICAgIGNsYXNzIHN5c3RlbSBiYXNlZCBvbiBFbWJlcidzIE1peGluIHN5c3RlbSwgYW5kIHByb3ZpZGVzIHRoZSBiYXNpcyBmb3IgdGhlCiAgICBFbWJlciBPYmplY3QgTW9kZWwuIGBDb3JlT2JqZWN0YCBzaG91bGQgZ2VuZXJhbGx5IG5vdCBiZSB1c2VkIGRpcmVjdGx5LAogICAgaW5zdGVhZCB5b3Ugc2hvdWxkIHVzZSBgRW1iZXJPYmplY3RgLgogIAogICAgIyMgVXNhZ2UKICAKICAgIFlvdSBjYW4gZGVmaW5lIGEgY2xhc3MgYnkgZXh0ZW5kaW5nIGZyb20gYENvcmVPYmplY3RgIHVzaW5nIHRoZSBgZXh0ZW5kYAogICAgbWV0aG9kOgogIAogICAgYGBganMKICAgIGNvbnN0IFBlcnNvbiA9IENvcmVPYmplY3QuZXh0ZW5kKHsKICAgICAgbmFtZTogJ1RvbXN0ZXInLAogICAgfSk7CiAgICBgYGAKICAKICAgIEZvciBkZXRhaWxlZCB1c2FnZSwgc2VlIHRoZSBbT2JqZWN0IE1vZGVsXShodHRwczovL2d1aWRlcy5lbWJlcmpzLmNvbS9yZWxlYXNlL29iamVjdC1tb2RlbC8pCiAgICBzZWN0aW9uIG9mIHRoZSBndWlkZXMuCiAgCiAgICAjIyBVc2FnZSB3aXRoIE5hdGl2ZSBDbGFzc2VzCiAgCiAgICBOYXRpdmUgSmF2YVNjcmlwdCBgY2xhc3NgIHN5bnRheCBjYW4gYmUgdXNlZCB0byBleHRlbmQgZnJvbSBhbnkgYENvcmVPYmplY3RgCiAgICBiYXNlZCBjbGFzczoKICAKICAgIGBgYGpzCiAgICBjbGFzcyBQZXJzb24gZXh0ZW5kcyBDb3JlT2JqZWN0IHsKICAgICAgaW5pdCgpIHsKICAgICAgICBzdXBlci5pbml0KC4uLmFyZ3VtZW50cyk7CiAgICAgICAgdGhpcy5uYW1lID0gJ1RvbXN0ZXInOwogICAgICB9CiAgICB9CiAgICBgYGAKICAKICAgIFNvbWUgbm90ZXMgYWJvdXQgYGNsYXNzYCB1c2FnZToKICAKICAgICogYG5ld2Agc3ludGF4IGlzIG5vdCBjdXJyZW50bHkgc3VwcG9ydGVkIHdpdGggY2xhc3NlcyB0aGF0IGV4dGVuZCBmcm9tCiAgICAgIGBFbWJlck9iamVjdGAgb3IgYENvcmVPYmplY3RgLiBZb3UgbXVzdCBjb250aW51ZSB0byB1c2UgdGhlIGBjcmVhdGVgIG1ldGhvZAogICAgICB3aGVuIG1ha2luZyBuZXcgaW5zdGFuY2VzIG9mIGNsYXNzZXMsIGV2ZW4gaWYgdGhleSBhcmUgZGVmaW5lZCB1c2luZyBuYXRpdmUKICAgICAgY2xhc3Mgc3ludGF4LiBJZiB5b3Ugd2FudCB0byB1c2UgYG5ld2Agc3ludGF4LCBjb25zaWRlciBjcmVhdGluZyBjbGFzc2VzCiAgICAgIHdoaWNoIGRvIF9ub3RfIGV4dGVuZCBmcm9tIGBFbWJlck9iamVjdGAgb3IgYENvcmVPYmplY3RgLiBFbWJlciBmZWF0dXJlcywKICAgICAgc3VjaCBhcyBjb21wdXRlZCBwcm9wZXJ0aWVzIGFuZCBkZWNvcmF0b3JzLCB3aWxsIHN0aWxsIHdvcmsgd2l0aCBiYXNlLWxlc3MKICAgICAgY2xhc3Nlcy4KICAgICogSW5zdGVhZCBvZiB1c2luZyBgdGhpcy5fc3VwZXIoKWAsIHlvdSBtdXN0IHVzZSBzdGFuZGFyZCBgc3VwZXJgIHN5bnRheCBpbgogICAgICBuYXRpdmUgY2xhc3Nlcy4gU2VlIHRoZSBbTUROIGRvY3Mgb24gY2xhc3Nlc10oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvQ2xhc3NlcyNTdXBlcl9jbGFzc19jYWxsc193aXRoX3N1cGVyKQogICAgICBmb3IgbW9yZSBkZXRhaWxzLgogICAgKiBOYXRpdmUgY2xhc3NlcyBzdXBwb3J0IHVzaW5nIFtjb25zdHJ1Y3RvcnNdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0NsYXNzZXMjQ29uc3RydWN0b3IpCiAgICAgIHRvIHNldCB1cCBuZXdseS1jcmVhdGVkIGluc3RhbmNlcy4gRW1iZXIgdXNlcyB0aGVzZSB0bywgYW1vbmcgb3RoZXIgdGhpbmdzLAogICAgICBzdXBwb3J0IGZlYXR1cmVzIHRoYXQgbmVlZCB0byByZXRyaWV2ZSBvdGhlciBlbnRpdGllcyBieSBuYW1lLCBsaWtlIFNlcnZpY2UKICAgICAgaW5qZWN0aW9uIGFuZCBgZ2V0T3duZXJgLiBUbyBlbnN1cmUgeW91ciBjdXN0b20gaW5zdGFuY2Ugc2V0dXAgbG9naWMgdGFrZXMKICAgICAgcGxhY2UgYWZ0ZXIgdGhpcyBpbXBvcnRhbnQgd29yayBpcyBkb25lLCBhdm9pZCB1c2luZyB0aGUgYGNvbnN0cnVjdG9yYCBpbgogICAgICBmYXZvciBvZiBgaW5pdGAuCiAgICAqIFByb3BlcnRpZXMgcGFzc2VkIHRvIGBjcmVhdGVgIHdpbGwgYmUgYXZhaWxhYmxlIG9uIHRoZSBpbnN0YW5jZSBieSB0aGUgdGltZQogICAgICBgaW5pdGAgcnVucywgc28gYW55IGNvZGUgdGhhdCByZXF1aXJlcyB0aGVzZSB2YWx1ZXMgc2hvdWxkIHdvcmsgYXQgdGhhdAogICAgICB0aW1lLgogICAgKiBVc2luZyBuYXRpdmUgY2xhc3NlcywgYW5kIHN3aXRjaGluZyBiYWNrIHRvIHRoZSBvbGQgRW1iZXIgT2JqZWN0IG1vZGVsIGlzCiAgICAgIGZ1bGx5IHN1cHBvcnRlZC4KICAKICAgIEBjbGFzcyBDb3JlT2JqZWN0CiAgICBAcHVibGljCiAgKi8KCgogIHZhciBDb3JlT2JqZWN0ID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgQ29yZU9iamVjdC5faW5pdEZhY3RvcnkgPSBmdW5jdGlvbiBfaW5pdEZhY3RvcnkoZmFjdG9yeSkgewogICAgICBmYWN0b3J5TWFwLnNldCh0aGlzLCBmYWN0b3J5KTsKICAgIH07CgogICAgZnVuY3Rpb24gQ29yZU9iamVjdChwYXNzZWRGcm9tQ3JlYXRlKSB7CiAgICAgIC8vIHBsdWNrIG9mZiBmYWN0b3J5CiAgICAgIHZhciBpbml0RmFjdG9yeSA9IGZhY3RvcnlNYXAuZ2V0KHRoaXMuY29uc3RydWN0b3IpOwoKICAgICAgaWYgKGluaXRGYWN0b3J5ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBmYWN0b3J5TWFwLmRlbGV0ZSh0aGlzLmNvbnN0cnVjdG9yKTsKCiAgICAgICAgX2NvbnRhaW5lci5GQUNUT1JZX0ZPUi5zZXQodGhpcywgaW5pdEZhY3RvcnkpOwogICAgICB9IC8vIHByZXBhcmUgcHJvdG90eXBlLi4uCgoKICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5wcm90bygpOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICBpZiAoZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgJiYgX3V0aWxzLkhBU19OQVRJVkVfUFJPWFkgJiYgdHlwZW9mIHNlbGYudW5rbm93blByb3BlcnR5ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdmFyIG1lc3NhZ2VGb3IgPSBmdW5jdGlvbiBtZXNzYWdlRm9yKG9iaiwgcHJvcGVydHkpIHsKICAgICAgICAgIHJldHVybiAiWW91IGF0dGVtcHRlZCB0byBhY2Nlc3MgdGhlIGAiICsgU3RyaW5nKHByb3BlcnR5KSArICJgIHByb3BlcnR5IChvZiAiICsgb2JqICsgIikuXG4iICsgIlNpbmNlIEVtYmVyIDMuMSwgdGhpcyBpcyB1c3VhbGx5IGZpbmUgYXMgeW91IG5vIGxvbmdlciBuZWVkIHRvIHVzZSBgLmdldCgpYFxuIiArICJ0byBhY2Nlc3MgY29tcHV0ZWQgcHJvcGVydGllcy4gSG93ZXZlciwgaW4gdGhpcyBjYXNlLCB0aGUgb2JqZWN0IGluIHF1ZXN0aW9uXG4iICsgImlzIGEgc3BlY2lhbCBraW5kIG9mIEVtYmVyIG9iamVjdCAoYSBwcm94eSkuIFRoZXJlZm9yZSwgaXQgaXMgc3RpbGwgbmVjZXNzYXJ5XG4iICsgKCJ0byB1c2UgYC5nZXQoJyIgKyBTdHJpbmcocHJvcGVydHkpICsgIicpYCBpbiB0aGlzIGNhc2UuXG5cbiIpICsgIklmIHlvdSBlbmNvdW50ZXJlZCB0aGlzIGVycm9yIGJlY2F1c2Ugb2YgdGhpcmQtcGFydHkgY29kZSB0aGF0IHlvdSBkb24ndCBjb250cm9sLFxuIiArICJ0aGVyZSBpcyBtb3JlIGluZm9ybWF0aW9uIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9lbWJlcmpzL2VtYmVyLmpzL2lzc3Vlcy8xNjE0OCwgYW5kXG4iICsgInlvdSBjYW4gaGVscCB1cyBpbXByb3ZlIHRoaXMgZXJyb3IgbWVzc2FnZSBieSB0ZWxsaW5nIHVzIG1vcmUgYWJvdXQgd2hhdCBoYXBwZW5lZCBpblxuIiArICJ0aGlzIHNpdHVhdGlvbi4iOwogICAgICAgIH07CiAgICAgICAgLyogZ2xvYmFscyBQcm94eSBSZWZsZWN0ICovCgoKICAgICAgICBzZWxmID0gbmV3IFByb3h5KHRoaXMsIHsKICAgICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KHRhcmdldCwgcHJvcGVydHksIHJlY2VpdmVyKSB7CiAgICAgICAgICAgIGlmIChwcm9wZXJ0eSA9PT0gX21ldGFsLlBST1hZX0NPTlRFTlQpIHsKICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgICAgICB9IGVsc2UgaWYgKCAvLyBpbml0IGNhbGxlZCB3aWxsIGJlIHNldCBvbiB0aGUgcHJveHksIG5vdCB0aGUgdGFyZ2V0LCBzbyBnZXQgd2l0aCB0aGUgcmVjZWl2ZXIKICAgICAgICAgICAgIWluaXRDYWxsZWQuaGFzKHJlY2VpdmVyKSB8fCB0eXBlb2YgcHJvcGVydHkgPT09ICdzeW1ib2wnIHx8ICgwLCBfdXRpbHMuaXNJbnRlcm5hbFN5bWJvbCkocHJvcGVydHkpIHx8IHByb3BlcnR5ID09PSAndG9KU09OJyB8fCBwcm9wZXJ0eSA9PT0gJ3RvU3RyaW5nJyB8fCBwcm9wZXJ0eSA9PT0gJ3RvU3RyaW5nRXh0ZW5zaW9uJyB8fCBwcm9wZXJ0eSA9PT0gJ2RpZERlZmluZVByb3BlcnR5JyB8fCBwcm9wZXJ0eSA9PT0gJ3dpbGxXYXRjaFByb3BlcnR5JyB8fCBwcm9wZXJ0eSA9PT0gJ2RpZFVud2F0Y2hQcm9wZXJ0eScgfHwgcHJvcGVydHkgPT09ICdkaWRBZGRMaXN0ZW5lcicgfHwgcHJvcGVydHkgPT09ICdkaWRSZW1vdmVMaXN0ZW5lcicgfHwgcHJvcGVydHkgPT09ICdpc0Rlc2NyaXB0b3InIHx8IHByb3BlcnR5ID09PSAnX29uTG9va3VwJyB8fCBwcm9wZXJ0eSBpbiB0YXJnZXQpIHsKICAgICAgICAgICAgICByZXR1cm4gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wZXJ0eSwgcmVjZWl2ZXIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgdmFsdWUgPSB0YXJnZXQudW5rbm93blByb3BlcnR5LmNhbGwocmVjZWl2ZXIsIHByb3BlcnR5KTsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAoZmFsc2UgJiYgISh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkobWVzc2FnZUZvcihyZWNlaXZlciwgcHJvcGVydHkpLCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgX2NvbnRhaW5lci5GQUNUT1JZX0ZPUi5zZXQoc2VsZiwgaW5pdEZhY3RvcnkpOwogICAgICB9IC8vIGRpc2FibGUgY2hhaW5zCgoKICAgICAgdmFyIG0gPSAoMCwgX21ldGEyLm1ldGEpKHNlbGYpOwogICAgICBtLnNldEluaXRpYWxpemluZygpOwogICAgICAoZmFsc2UgJiYgIShmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHBhc3NlZEZyb21DcmVhdGUgPT09IFBBU1NFRF9GUk9NX0NSRUFURSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAoaW5pdEZhY3RvcnkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHBhc3NlZEZyb21DcmVhdGUgPT09IGluaXRGYWN0b3J5Lm93bmVyKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkFuIEVtYmVyT2JqZWN0IGJhc2VkIGNsYXNzLCAiICsgdGhpcy5jb25zdHJ1Y3RvciArICIsIHdhcyBub3QgaW5zdGFudGlhdGVkIGNvcnJlY3RseS4gWW91IG1heSBoYXZlIGVpdGhlciB1c2VkIGBuZXdgIGluc3RlYWQgb2YgYC5jcmVhdGUoKWAsIG9yIG5vdCBwYXNzZWQgYXJndW1lbnRzIHRvIHlvdXIgY2FsbCB0byBzdXBlciBpbiB0aGUgY29uc3RydWN0b3I6IGBzdXBlciguLi5hcmd1bWVudHMpYC4gSWYgeW91IGFyZSB0cnlpbmcgdG8gdXNlIGBuZXdgLCBjb25zaWRlciB1c2luZyBuYXRpdmUgY2xhc3NlcyB3aXRob3V0IGV4dGVuZGluZyBmcm9tIEVtYmVyT2JqZWN0LiIsIGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAocGFzc2VkRnJvbUNyZWF0ZSA9PT0gUEFTU0VEX0ZST01fQ1JFQVRFKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmIChpbml0RmFjdG9yeSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAocGFzc2VkRnJvbUNyZWF0ZSA9PT0gaW5pdEZhY3Rvcnkub3duZXIpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9KCkpKTsgLy8gb25seSByZXR1cm4gd2hlbiBpbiBkZWJ1ZyBidWlsZHMgYW5kIGBzZWxmYCBpcyB0aGUgcHJveHkgY3JlYXRlZCBhYm92ZQoKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICYmIHNlbGYgIT09IHRoaXMpIHsKICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgfQogICAgfQoKICAgIHZhciBfcHJvdG8gPSBDb3JlT2JqZWN0LnByb3RvdHlwZTsKCiAgICBfcHJvdG8ucmVvcGVuID0gZnVuY3Rpb24gcmVvcGVuKCkgewogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CgogICAgICAoMCwgX21ldGFsLmFwcGx5TWl4aW4pKHRoaXMsIGFyZ3MpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICBBbiBvdmVycmlkYWJsZSBtZXRob2QgY2FsbGVkIHdoZW4gb2JqZWN0cyBhcmUgaW5zdGFudGlhdGVkLiBCeSBkZWZhdWx0LAogICAgICBkb2VzIG5vdGhpbmcgdW5sZXNzIGl0IGlzIG92ZXJyaWRkZW4gZHVyaW5nIGNsYXNzIGRlZmluaXRpb24uCiAgICAgICBFeGFtcGxlOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICBjb25zdCBQZXJzb24gPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICAgIGluaXQoKSB7CiAgICAgICAgICBhbGVydChgTmFtZSBpcyAke3RoaXMuZ2V0KCduYW1lJyl9YCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgIGxldCBzdGV2ZSA9IFBlcnNvbi5jcmVhdGUoewogICAgICAgIG5hbWU6ICdTdGV2ZScKICAgICAgfSk7CiAgICAgICAvLyBhbGVydHMgJ05hbWUgaXMgU3RldmUnLgogICAgICBgYGAKICAgICAgIE5PVEU6IElmIHlvdSBkbyBvdmVycmlkZSBgaW5pdGAgZm9yIGEgZnJhbWV3b3JrIGNsYXNzIGxpa2UgYEVtYmVyLlZpZXdgLAogICAgICBiZSBzdXJlIHRvIGNhbGwgYHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cylgIGluIHlvdXIKICAgICAgYGluaXRgIGRlY2xhcmF0aW9uISBJZiB5b3UgZG9uJ3QsIEVtYmVyIG1heSBub3QgaGF2ZSBhbiBvcHBvcnR1bml0eSB0bwogICAgICBkbyBpbXBvcnRhbnQgc2V0dXAgd29yaywgYW5kIHlvdSdsbCBzZWUgc3RyYW5nZSBiZWhhdmlvciBpbiB5b3VyCiAgICAgIGFwcGxpY2F0aW9uLgogICAgICAgQG1ldGhvZCBpbml0CiAgICAgIEBwdWJsaWMKICAgICovCiAgICA7CgogICAgX3Byb3RvLmluaXQgPSBmdW5jdGlvbiBpbml0KCkge30KICAgIC8qKgogICAgICBEZWZpbmVzIHRoZSBwcm9wZXJ0aWVzIHRoYXQgd2lsbCBiZSBjb25jYXRlbmF0ZWQgZnJvbSB0aGUgc3VwZXJjbGFzcwogICAgICAoaW5zdGVhZCBvZiBvdmVycmlkZGVuKS4KICAgICAgIEJ5IGRlZmF1bHQsIHdoZW4geW91IGV4dGVuZCBhbiBFbWJlciBjbGFzcyBhIHByb3BlcnR5IGRlZmluZWQgaW4KICAgICAgdGhlIHN1YmNsYXNzIG92ZXJyaWRlcyBhIHByb3BlcnR5IHdpdGggdGhlIHNhbWUgbmFtZSB0aGF0IGlzIGRlZmluZWQKICAgICAgaW4gdGhlIHN1cGVyY2xhc3MuIEhvd2V2ZXIsIHRoZXJlIGFyZSBzb21lIGNhc2VzIHdoZXJlIGl0IGlzIHByZWZlcmFibGUKICAgICAgdG8gYnVpbGQgdXAgYSBwcm9wZXJ0eSdzIHZhbHVlIGJ5IGNvbWJpbmluZyB0aGUgc3VwZXJjbGFzcycgcHJvcGVydHkKICAgICAgdmFsdWUgd2l0aCB0aGUgc3ViY2xhc3MnIHZhbHVlLiBBbiBleGFtcGxlIG9mIHRoaXMgaW4gdXNlIHdpdGhpbiBFbWJlcgogICAgICBpcyB0aGUgYGNsYXNzTmFtZXNgIHByb3BlcnR5IG9mIGBFbWJlci5WaWV3YC4KICAgICAgIEhlcmUgaXMgc29tZSBzYW1wbGUgY29kZSBzaG93aW5nIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gYSBjb25jYXRlbmF0ZWQKICAgICAgcHJvcGVydHkgYW5kIGEgbm9ybWFsIG9uZToKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgY29uc3QgQmFyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgICAvLyBDb25maWd1cmUgd2hpY2ggcHJvcGVydGllcyB0byBjb25jYXRlbmF0ZQogICAgICAgIGNvbmNhdGVuYXRlZFByb3BlcnRpZXM6IFsnY29uY2F0ZW5hdGVkUHJvcGVydHknXSwKICAgICAgICAgc29tZU5vbkNvbmNhdGVuYXRlZFByb3BlcnR5OiBbJ2JhciddLAogICAgICAgIGNvbmNhdGVuYXRlZFByb3BlcnR5OiBbJ2JhciddCiAgICAgIH0pOwogICAgICAgY29uc3QgRm9vQmFyID0gQmFyLmV4dGVuZCh7CiAgICAgICAgc29tZU5vbkNvbmNhdGVuYXRlZFByb3BlcnR5OiBbJ2ZvbyddLAogICAgICAgIGNvbmNhdGVuYXRlZFByb3BlcnR5OiBbJ2ZvbyddCiAgICAgIH0pOwogICAgICAgbGV0IGZvb0JhciA9IEZvb0Jhci5jcmVhdGUoKTsKICAgICAgZm9vQmFyLmdldCgnc29tZU5vbkNvbmNhdGVuYXRlZFByb3BlcnR5Jyk7IC8vIFsnZm9vJ10KICAgICAgZm9vQmFyLmdldCgnY29uY2F0ZW5hdGVkUHJvcGVydHknKTsgLy8gWydiYXInLCAnZm9vJ10KICAgICAgYGBgCiAgICAgICBUaGlzIGJlaGF2aW9yIGV4dGVuZHMgdG8gb2JqZWN0IGNyZWF0aW9uIGFzIHdlbGwuIENvbnRpbnVpbmcgdGhlCiAgICAgIGFib3ZlIGV4YW1wbGU6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGxldCBmb29CYXIgPSBGb29CYXIuY3JlYXRlKHsKICAgICAgICBzb21lTm9uQ29uY2F0ZW5hdGVkUHJvcGVydHk6IFsnYmF6J10sCiAgICAgICAgY29uY2F0ZW5hdGVkUHJvcGVydHk6IFsnYmF6J10KICAgICAgfSkKICAgICAgZm9vQmFyLmdldCgnc29tZU5vbkNvbmNhdGVuYXRlZFByb3BlcnR5Jyk7IC8vIFsnYmF6J10KICAgICAgZm9vQmFyLmdldCgnY29uY2F0ZW5hdGVkUHJvcGVydHknKTsgLy8gWydiYXInLCAnZm9vJywgJ2JheiddCiAgICAgIGBgYAogICAgICAgQWRkaW5nIGEgc2luZ2xlIHByb3BlcnR5IHRoYXQgaXMgbm90IGFuIGFycmF5IHdpbGwganVzdCBhZGQgaXQgaW4gdGhlIGFycmF5OgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBsZXQgZm9vQmFyID0gRm9vQmFyLmNyZWF0ZSh7CiAgICAgICAgY29uY2F0ZW5hdGVkUHJvcGVydHk6ICdiYXonCiAgICAgIH0pCiAgICAgIHZpZXcuZ2V0KCdjb25jYXRlbmF0ZWRQcm9wZXJ0eScpOyAvLyBbJ2JhcicsICdmb28nLCAnYmF6J10KICAgICAgYGBgCiAgICAgICBVc2luZyB0aGUgYGNvbmNhdGVuYXRlZFByb3BlcnRpZXNgIHByb3BlcnR5LCB3ZSBjYW4gdGVsbCBFbWJlciB0byBtaXggdGhlCiAgICAgIGNvbnRlbnQgb2YgdGhlIHByb3BlcnRpZXMuCiAgICAgICBJbiBgQ29tcG9uZW50YCB0aGUgYGNsYXNzTmFtZXNgLCBgY2xhc3NOYW1lQmluZGluZ3NgIGFuZAogICAgICBgYXR0cmlidXRlQmluZGluZ3NgIHByb3BlcnRpZXMgYXJlIGNvbmNhdGVuYXRlZC4KICAgICAgIFRoaXMgZmVhdHVyZSBpcyBhdmFpbGFibGUgZm9yIHlvdSB0byB1c2UgdGhyb3VnaG91dCB0aGUgRW1iZXIgb2JqZWN0IG1vZGVsLAogICAgICBhbHRob3VnaCB0eXBpY2FsIGFwcCBkZXZlbG9wZXJzIGFyZSBsaWtlbHkgdG8gdXNlIGl0IGluZnJlcXVlbnRseS4gU2luY2UKICAgICAgaXQgY2hhbmdlcyBleHBlY3RhdGlvbnMgYWJvdXQgYmVoYXZpb3Igb2YgcHJvcGVydGllcywgeW91IHNob3VsZCBwcm9wZXJseQogICAgICBkb2N1bWVudCBpdHMgdXNhZ2UgaW4gZWFjaCBpbmRpdmlkdWFsIGNvbmNhdGVuYXRlZCBwcm9wZXJ0eSAodG8gbm90CiAgICAgIG1pc2xlYWQgeW91ciB1c2VycyB0byB0aGluayB0aGV5IGNhbiBvdmVycmlkZSB0aGUgcHJvcGVydHkgaW4gYSBzdWJjbGFzcykuCiAgICAgICBAcHJvcGVydHkgY29uY2F0ZW5hdGVkUHJvcGVydGllcwogICAgICBAdHlwZSBBcnJheQogICAgICBAZGVmYXVsdCBudWxsCiAgICAgIEBwdWJsaWMKICAgICovCgogICAgLyoqCiAgICAgIERlZmluZXMgdGhlIHByb3BlcnRpZXMgdGhhdCB3aWxsIGJlIG1lcmdlZCBmcm9tIHRoZSBzdXBlcmNsYXNzCiAgICAgIChpbnN0ZWFkIG9mIG92ZXJyaWRkZW4pLgogICAgICAgQnkgZGVmYXVsdCwgd2hlbiB5b3UgZXh0ZW5kIGFuIEVtYmVyIGNsYXNzIGEgcHJvcGVydHkgZGVmaW5lZCBpbgogICAgICB0aGUgc3ViY2xhc3Mgb3ZlcnJpZGVzIGEgcHJvcGVydHkgd2l0aCB0aGUgc2FtZSBuYW1lIHRoYXQgaXMgZGVmaW5lZAogICAgICBpbiB0aGUgc3VwZXJjbGFzcy4gSG93ZXZlciwgdGhlcmUgYXJlIHNvbWUgY2FzZXMgd2hlcmUgaXQgaXMgcHJlZmVyYWJsZQogICAgICB0byBidWlsZCB1cCBhIHByb3BlcnR5J3MgdmFsdWUgYnkgbWVyZ2luZyB0aGUgc3VwZXJjbGFzcyBwcm9wZXJ0eSB2YWx1ZQogICAgICB3aXRoIHRoZSBzdWJjbGFzcyBwcm9wZXJ0eSdzIHZhbHVlLiBBbiBleGFtcGxlIG9mIHRoaXMgaW4gdXNlIHdpdGhpbiBFbWJlcgogICAgICBpcyB0aGUgYHF1ZXJ5UGFyYW1zYCBwcm9wZXJ0eSBvZiByb3V0ZXMuCiAgICAgICBIZXJlIGlzIHNvbWUgc2FtcGxlIGNvZGUgc2hvd2luZyB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuIGEgbWVyZ2VkCiAgICAgIHByb3BlcnR5IGFuZCBhIG5vcm1hbCBvbmU6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICAgIGNvbnN0IEJhciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgLy8gQ29uZmlndXJlIHdoaWNoIHByb3BlcnRpZXMgYXJlIHRvIGJlIG1lcmdlZAogICAgICAgIG1lcmdlZFByb3BlcnRpZXM6IFsnbWVyZ2VkUHJvcGVydHknXSwKICAgICAgICAgc29tZU5vbk1lcmdlZFByb3BlcnR5OiB7CiAgICAgICAgICBub25NZXJnZWQ6ICdzdXBlcmNsYXNzIHZhbHVlIG9mIG5vbk1lcmdlZCcKICAgICAgICB9LAogICAgICAgIG1lcmdlZFByb3BlcnR5OiB7CiAgICAgICAgICBwYWdlOiB7IHJlcGxhY2U6IGZhbHNlIH0sCiAgICAgICAgICBsaW1pdDogeyByZXBsYWNlOiB0cnVlIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICAgY29uc3QgRm9vQmFyID0gQmFyLmV4dGVuZCh7CiAgICAgICAgc29tZU5vbk1lcmdlZFByb3BlcnR5OiB7CiAgICAgICAgICBjb21wbGV0ZWx5Tm9uTWVyZ2VkOiAnc3ViY2xhc3MgdmFsdWUgb2Ygbm9uTWVyZ2VkJwogICAgICAgIH0sCiAgICAgICAgbWVyZ2VkUHJvcGVydHk6IHsKICAgICAgICAgIGxpbWl0OiB7IHJlcGxhY2U6IGZhbHNlIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICAgbGV0IGZvb0JhciA9IEZvb0Jhci5jcmVhdGUoKTsKICAgICAgIGZvb0Jhci5nZXQoJ3NvbWVOb25NZXJnZWRQcm9wZXJ0eScpOwogICAgICAvLyA9PiB7IGNvbXBsZXRlbHlOb25NZXJnZWQ6ICdzdWJjbGFzcyB2YWx1ZSBvZiBub25NZXJnZWQnIH0KICAgICAgLy8KICAgICAgLy8gTm90ZSB0aGUgZW50aXJlIG9iamVjdCwgaW5jbHVkaW5nIHRoZSBub25NZXJnZWQgcHJvcGVydHkgb2YKICAgICAgLy8gdGhlIHN1cGVyY2xhc3Mgb2JqZWN0LCBoYXMgYmVlbiByZXBsYWNlZAogICAgICAgZm9vQmFyLmdldCgnbWVyZ2VkUHJvcGVydHknKTsKICAgICAgLy8gPT4gewogICAgICAvLyAgIHBhZ2U6IHtyZXBsYWNlOiBmYWxzZX0sCiAgICAgIC8vICAgbGltaXQ6IHtyZXBsYWNlOiBmYWxzZX0KICAgICAgLy8gfQogICAgICAvLwogICAgICAvLyBOb3RlIHRoZSBwYWdlIHJlbWFpbnMgZnJvbSB0aGUgc3VwZXJjbGFzcywgYW5kIHRoZQogICAgICAvLyBgbGltaXRgIHByb3BlcnR5J3MgdmFsdWUgb2YgYGZhbHNlYCBoYXMgYmVlbiBtZXJnZWQgZnJvbQogICAgICAvLyB0aGUgc3ViY2xhc3MuCiAgICAgIGBgYAogICAgICAgVGhpcyBiZWhhdmlvciBpcyBub3QgYXZhaWxhYmxlIGR1cmluZyBvYmplY3QgYGNyZWF0ZWAgY2FsbHMuIEl0IGlzIG9ubHkKICAgICAgYXZhaWxhYmxlIGF0IGBleHRlbmRgIHRpbWUuCiAgICAgICBJbiBgUm91dGVgIHRoZSBgcXVlcnlQYXJhbXNgIHByb3BlcnR5IGlzIG1lcmdlZC4KICAgICAgIFRoaXMgZmVhdHVyZSBpcyBhdmFpbGFibGUgZm9yIHlvdSB0byB1c2UgdGhyb3VnaG91dCB0aGUgRW1iZXIgb2JqZWN0IG1vZGVsLAogICAgICBhbHRob3VnaCB0eXBpY2FsIGFwcCBkZXZlbG9wZXJzIGFyZSBsaWtlbHkgdG8gdXNlIGl0IGluZnJlcXVlbnRseS4gU2luY2UKICAgICAgaXQgY2hhbmdlcyBleHBlY3RhdGlvbnMgYWJvdXQgYmVoYXZpb3Igb2YgcHJvcGVydGllcywgeW91IHNob3VsZCBwcm9wZXJseQogICAgICBkb2N1bWVudCBpdHMgdXNhZ2UgaW4gZWFjaCBpbmRpdmlkdWFsIG1lcmdlZCBwcm9wZXJ0eSAodG8gbm90CiAgICAgIG1pc2xlYWQgeW91ciB1c2VycyB0byB0aGluayB0aGV5IGNhbiBvdmVycmlkZSB0aGUgcHJvcGVydHkgaW4gYSBzdWJjbGFzcykuCiAgICAgICBAcHJvcGVydHkgbWVyZ2VkUHJvcGVydGllcwogICAgICBAdHlwZSBBcnJheQogICAgICBAZGVmYXVsdCBudWxsCiAgICAgIEBwdWJsaWMKICAgICovCgogICAgLyoqCiAgICAgIERlc3Ryb3llZCBvYmplY3QgcHJvcGVydHkgZmxhZy4KICAgICAgIGlmIHRoaXMgcHJvcGVydHkgaXMgYHRydWVgIHRoZSBvYnNlcnZlcnMgYW5kIGJpbmRpbmdzIHdlcmUgYWxyZWFkeQogICAgICByZW1vdmVkIGJ5IHRoZSBlZmZlY3Qgb2YgY2FsbGluZyB0aGUgYGRlc3Ryb3koKWAgbWV0aG9kLgogICAgICAgQHByb3BlcnR5IGlzRGVzdHJveWVkCiAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgIEBwdWJsaWMKICAgICovCiAgICA7CgogICAgLyoqCiAgICAgIERlc3Ryb3lzIGFuIG9iamVjdCBieSBzZXR0aW5nIHRoZSBgaXNEZXN0cm95ZWRgIGZsYWcgYW5kIHJlbW92aW5nIGl0cwogICAgICBtZXRhZGF0YSwgd2hpY2ggZWZmZWN0aXZlbHkgZGVzdHJveXMgb2JzZXJ2ZXJzIGFuZCBiaW5kaW5ncy4KICAgICAgIElmIHlvdSB0cnkgdG8gc2V0IGEgcHJvcGVydHkgb24gYSBkZXN0cm95ZWQgb2JqZWN0LCBhbiBleGNlcHRpb24gd2lsbCBiZQogICAgICByYWlzZWQuCiAgICAgICBOb3RlIHRoYXQgZGVzdHJ1Y3Rpb24gaXMgc2NoZWR1bGVkIGZvciB0aGUgZW5kIG9mIHRoZSBydW4gbG9vcCBhbmQgZG9lcyBub3QKICAgICAgaGFwcGVuIGltbWVkaWF0ZWx5LiAgSXQgd2lsbCBzZXQgYW4gaXNEZXN0cm95aW5nIGZsYWcgaW1tZWRpYXRlbHkuCiAgICAgICBAbWV0aG9kIGRlc3Ryb3kKICAgICAgQHJldHVybiB7RW1iZXJPYmplY3R9IHJlY2VpdmVyCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBfcHJvdG8uZGVzdHJveSA9IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgIHZhciBtID0gKDAsIF9tZXRhMi5wZWVrTWV0YSkodGhpcyk7CgogICAgICBpZiAobS5pc1NvdXJjZURlc3Ryb3lpbmcoKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgbS5zZXRTb3VyY2VEZXN0cm95aW5nKCk7CiAgICAgICgwLCBfcnVubG9vcC5zY2hlZHVsZSkoJ2FjdGlvbnMnLCB0aGlzLCB0aGlzLndpbGxEZXN0cm95KTsKICAgICAgKDAsIF9ydW5sb29wLnNjaGVkdWxlKSgnZGVzdHJveScsIHRoaXMsIHRoaXMuX3NjaGVkdWxlZERlc3Ryb3ksIG0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICBPdmVycmlkZSB0byBpbXBsZW1lbnQgdGVhcmRvd24uCiAgICAgICBAbWV0aG9kIHdpbGxEZXN0cm95CiAgICAgIEBwdWJsaWMKICAgICovCiAgICA7CgogICAgX3Byb3RvLndpbGxEZXN0cm95ID0gZnVuY3Rpb24gd2lsbERlc3Ryb3koKSB7fQogICAgLyoqCiAgICAgIEludm9rZWQgYnkgdGhlIHJ1biBsb29wIHRvIGFjdHVhbGx5IGRlc3Ryb3kgdGhlIG9iamVjdC4gVGhpcyBpcwogICAgICBzY2hlZHVsZWQgZm9yIGV4ZWN1dGlvbiBieSB0aGUgYGRlc3Ryb3lgIG1ldGhvZC4KICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgX3NjaGVkdWxlZERlc3Ryb3kKICAgICovCiAgICA7CgogICAgX3Byb3RvLl9zY2hlZHVsZWREZXN0cm95ID0gZnVuY3Rpb24gX3NjaGVkdWxlZERlc3Ryb3kobSkgewogICAgICBpZiAobS5pc1NvdXJjZURlc3Ryb3llZCgpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAoMCwgX21ldGEyLmRlbGV0ZU1ldGEpKHRoaXMpOwogICAgICBtLnNldFNvdXJjZURlc3Ryb3llZCgpOwogICAgfQogICAgLyoqCiAgICAgIFJldHVybnMgYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gd2hpY2ggYXR0ZW1wdHMgdG8gcHJvdmlkZSBtb3JlIGluZm9ybWF0aW9uCiAgICAgIHRoYW4gSmF2YXNjcmlwdCdzIGB0b1N0cmluZ2AgdHlwaWNhbGx5IGRvZXMsIGluIGEgZ2VuZXJpYyB3YXkgZm9yIGFsbCBFbWJlcgogICAgICBvYmplY3RzLgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICBjb25zdCBQZXJzb24gPSBFbWJlck9iamVjdC5leHRlbmQoKTsKICAgICAgcGVyc29uID0gUGVyc29uLmNyZWF0ZSgpOwogICAgICBwZXJzb24udG9TdHJpbmcoKTsgLy89PiAiPFBlcnNvbjplbWJlcjEwMjQ+IgogICAgICBgYGAKICAgICAgIElmIHRoZSBvYmplY3QncyBjbGFzcyBpcyBub3QgZGVmaW5lZCBvbiBhbiBFbWJlciBuYW1lc3BhY2UsIGl0IHdpbGwKICAgICAgaW5kaWNhdGUgaXQgaXMgYSBzdWJjbGFzcyBvZiB0aGUgcmVnaXN0ZXJlZCBzdXBlcmNsYXNzOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBjb25zdCBTdHVkZW50ID0gUGVyc29uLmV4dGVuZCgpOwogICAgICBsZXQgc3R1ZGVudCA9IFN0dWRlbnQuY3JlYXRlKCk7CiAgICAgIHN0dWRlbnQudG9TdHJpbmcoKTsgLy89PiAiPChzdWJjbGFzcyBvZiBQZXJzb24pOmVtYmVyMTAyNT4iCiAgICAgIGBgYAogICAgICAgSWYgdGhlIG1ldGhvZCBgdG9TdHJpbmdFeHRlbnNpb25gIGlzIGRlZmluZWQsIGl0cyByZXR1cm4gdmFsdWUgd2lsbCBiZQogICAgICBpbmNsdWRlZCBpbiB0aGUgb3V0cHV0LgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBjb25zdCBUZWFjaGVyID0gUGVyc29uLmV4dGVuZCh7CiAgICAgICAgdG9TdHJpbmdFeHRlbnNpb24oKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5nZXQoJ2Z1bGxOYW1lJyk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGVhY2hlciA9IFRlYWNoZXIuY3JlYXRlKCk7CiAgICAgIHRlYWNoZXIudG9TdHJpbmcoKTsgLy89PiAiPFRlYWNoZXI6ZW1iZXIxMDI2OlRvbSBEYWxlPiIKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHRvU3RyaW5nCiAgICAgIEByZXR1cm4ge1N0cmluZ30gc3RyaW5nIHJlcHJlc2VudGF0aW9uCiAgICAgIEBwdWJsaWMKICAgICovCiAgICA7CgogICAgX3Byb3RvLnRvU3RyaW5nID0gZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgIHZhciBoYXNUb1N0cmluZ0V4dGVuc2lvbiA9IHR5cGVvZiB0aGlzLnRvU3RyaW5nRXh0ZW5zaW9uID09PSAnZnVuY3Rpb24nOwogICAgICB2YXIgZXh0ZW5zaW9uID0gaGFzVG9TdHJpbmdFeHRlbnNpb24gPyAiOiIgKyB0aGlzLnRvU3RyaW5nRXh0ZW5zaW9uKCkgOiAnJzsKICAgICAgdmFyIHJldCA9ICI8IiArICgoMCwgX3V0aWxzLmdldE5hbWUpKHRoaXMpIHx8IF9jb250YWluZXIuRkFDVE9SWV9GT1IuZ2V0KHRoaXMpIHx8IHRoaXMuY29uc3RydWN0b3IudG9TdHJpbmcoKSkgKyAiOiIgKyAoMCwgX3V0aWxzLmd1aWRGb3IpKHRoaXMpICsgZXh0ZW5zaW9uICsgIj4iOwogICAgICByZXR1cm4gcmV0OwogICAgfQogICAgLyoqCiAgICAgIENyZWF0ZXMgYSBuZXcgc3ViY2xhc3MuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICAgIGNvbnN0IFBlcnNvbiA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgc2F5KHRoaW5nKSB7CiAgICAgICAgICBhbGVydCh0aGluZyk7CiAgICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgVGhpcyBkZWZpbmVzIGEgbmV3IHN1YmNsYXNzIG9mIEVtYmVyT2JqZWN0OiBgUGVyc29uYC4gSXQgY29udGFpbnMgb25lIG1ldGhvZDogYHNheSgpYC4KICAgICAgIFlvdSBjYW4gYWxzbyBjcmVhdGUgYSBzdWJjbGFzcyBmcm9tIGFueSBleGlzdGluZyBjbGFzcyBieSBjYWxsaW5nIGl0cyBgZXh0ZW5kKClgIG1ldGhvZC4KICAgICAgRm9yIGV4YW1wbGUsIHlvdSBtaWdodCB3YW50IHRvIGNyZWF0ZSBhIHN1YmNsYXNzIG9mIEVtYmVyJ3MgYnVpbHQtaW4gYENvbXBvbmVudGAgY2xhc3M6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAgICBjb25zdCBQZXJzb25Db21wb25lbnQgPSBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICB0YWdOYW1lOiAnbGknLAogICAgICAgIGNsYXNzTmFtZUJpbmRpbmdzOiBbJ2lzQWRtaW5pc3RyYXRvciddCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFdoZW4gZGVmaW5pbmcgYSBzdWJjbGFzcywgeW91IGNhbiBvdmVycmlkZSBtZXRob2RzIGJ1dCBzdGlsbCBhY2Nlc3MgdGhlCiAgICAgIGltcGxlbWVudGF0aW9uIG9mIHlvdXIgcGFyZW50IGNsYXNzIGJ5IGNhbGxpbmcgdGhlIHNwZWNpYWwgYF9zdXBlcigpYCBtZXRob2Q6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICAgIGNvbnN0IFBlcnNvbiA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgc2F5KHRoaW5nKSB7CiAgICAgICAgICBsZXQgbmFtZSA9IHRoaXMuZ2V0KCduYW1lJyk7CiAgICAgICAgICBhbGVydChgJHtuYW1lfSBzYXlzOiAke3RoaW5nfWApOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgICBjb25zdCBTb2xkaWVyID0gUGVyc29uLmV4dGVuZCh7CiAgICAgICAgc2F5KHRoaW5nKSB7CiAgICAgICAgICB0aGlzLl9zdXBlcihgJHt0aGluZ30sIHNpciFgKTsKICAgICAgICB9LAogICAgICAgIG1hcmNoKG51bWJlck9mSG91cnMpIHsKICAgICAgICAgIGFsZXJ0KGAke3RoaXMuZ2V0KCduYW1lJyl9IG1hcmNoZXMgZm9yICR7bnVtYmVyT2ZIb3Vyc30gaG91cnMuYCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgIGxldCB5ZWh1ZGEgPSBTb2xkaWVyLmNyZWF0ZSh7CiAgICAgICAgbmFtZTogJ1llaHVkYSBLYXR6JwogICAgICB9KTsKICAgICAgIHllaHVkYS5zYXkoJ1llcycpOyAgLy8gYWxlcnRzICJZZWh1ZGEgS2F0eiBzYXlzOiBZZXMsIHNpciEiCiAgICAgIGBgYAogICAgICAgVGhlIGBjcmVhdGUoKWAgb24gbGluZSAjMTcgY3JlYXRlcyBhbiAqaW5zdGFuY2UqIG9mIHRoZSBgU29sZGllcmAgY2xhc3MuCiAgICAgIFRoZSBgZXh0ZW5kKClgIG9uIGxpbmUgIzggY3JlYXRlcyBhICpzdWJjbGFzcyogb2YgYFBlcnNvbmAuIEFueSBpbnN0YW5jZQogICAgICBvZiB0aGUgYFBlcnNvbmAgY2xhc3Mgd2lsbCAqbm90KiBoYXZlIHRoZSBgbWFyY2goKWAgbWV0aG9kLgogICAgICAgWW91IGNhbiBhbHNvIHBhc3MgYE1peGluYCBjbGFzc2VzIHRvIGFkZCBhZGRpdGlvbmFsIHByb3BlcnRpZXMgdG8gdGhlIHN1YmNsYXNzLgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgIGltcG9ydCBNaXhpbiBmcm9tICdAZW1iZXIvb2JqZWN0L21peGluJzsKICAgICAgIGNvbnN0IFBlcnNvbiA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgc2F5KHRoaW5nKSB7CiAgICAgICAgICBhbGVydChgJHt0aGlzLmdldCgnbmFtZScpfSBzYXlzOiAke3RoaW5nfWApOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgICBjb25zdCBTaW5naW5nTWl4aW4gPSBNaXhpbi5jcmVhdGUoewogICAgICAgIHNpbmcodGhpbmcpIHsKICAgICAgICAgIGFsZXJ0KGAke3RoaXMuZ2V0KCduYW1lJyl9IHNpbmdzOiBsYSBsYSBsYSAke3RoaW5nfWApOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgICBjb25zdCBCcm9hZHdheVN0YXIgPSBQZXJzb24uZXh0ZW5kKFNpbmdpbmdNaXhpbiwgewogICAgICAgIGRhbmNlKCkgewogICAgICAgICAgYWxlcnQoYCR7dGhpcy5nZXQoJ25hbWUnKX0gZGFuY2VzOiB0YXAgdGFwIHRhcCB0YXAgYCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBUaGUgYEJyb2Fkd2F5U3RhcmAgY2xhc3MgY29udGFpbnMgdGhyZWUgbWV0aG9kczogYHNheSgpYCwgYHNpbmcoKWAsIGFuZCBgZGFuY2UoKWAuCiAgICAgICBAbWV0aG9kIGV4dGVuZAogICAgICBAc3RhdGljCiAgICAgIEBmb3IgQGVtYmVyL29iamVjdAogICAgICBAcGFyYW0ge01peGlufSBbbWl4aW5zXSogT25lIG9yIG1vcmUgTWl4aW4gY2xhc3NlcwogICAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3VtZW50c10qIE9iamVjdCBjb250YWluaW5nIHZhbHVlcyB0byB1c2Ugd2l0aGluIHRoZSBuZXcgY2xhc3MKICAgICAgQHB1YmxpYwogICAgKi8KICAgIDsKCiAgICBDb3JlT2JqZWN0LmV4dGVuZCA9IGZ1bmN0aW9uIGV4dGVuZCgpIHsKICAgICAgdmFyIENsYXNzID0KICAgICAgLyojX19QVVJFX18qLwogICAgICBmdW5jdGlvbiAoX3RoaXMpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoQ2xhc3MsIF90aGlzKTsKCiAgICAgICAgZnVuY3Rpb24gQ2xhc3MoKSB7CiAgICAgICAgICByZXR1cm4gX3RoaXMuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIENsYXNzOwogICAgICB9KHRoaXMpOwoKICAgICAgX3Jlb3Blbi5hcHBseShDbGFzcy5Qcm90b3R5cGVNaXhpbiwgYXJndW1lbnRzKTsKCiAgICAgIHJldHVybiBDbGFzczsKICAgIH0KICAgIC8qKgogICAgICBDcmVhdGVzIGFuIGluc3RhbmNlIG9mIGEgY2xhc3MuIEFjY2VwdHMgZWl0aGVyIG5vIGFyZ3VtZW50cywgb3IgYW4gb2JqZWN0CiAgICAgIGNvbnRhaW5pbmcgdmFsdWVzIHRvIGluaXRpYWxpemUgdGhlIG5ld2x5IGluc3RhbnRpYXRlZCBvYmplY3Qgd2l0aC4KICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgY29uc3QgUGVyc29uID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgICBoZWxsb1dvcmxkKCkgewogICAgICAgICAgYWxlcnQoYEhpLCBteSBuYW1lIGlzICR7dGhpcy5nZXQoJ25hbWUnKX1gKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAgbGV0IHRvbSA9IFBlcnNvbi5jcmVhdGUoewogICAgICAgIG5hbWU6ICdUb20gRGFsZScKICAgICAgfSk7CiAgICAgICB0b20uaGVsbG9Xb3JsZCgpOyAvLyBhbGVydHMgIkhpLCBteSBuYW1lIGlzIFRvbSBEYWxlIi4KICAgICAgYGBgCiAgICAgICBgY3JlYXRlYCB3aWxsIGNhbGwgdGhlIGBpbml0YCBmdW5jdGlvbiBpZiBkZWZpbmVkIGR1cmluZwogICAgICBgQW55T2JqZWN0LmV4dGVuZGAKICAgICAgIElmIG5vIGFyZ3VtZW50cyBhcmUgcGFzc2VkIHRvIGBjcmVhdGVgLCBpdCB3aWxsIG5vdCBzZXQgdmFsdWVzIHRvIHRoZSBuZXcKICAgICAgaW5zdGFuY2UgZHVyaW5nIGluaXRpYWxpemF0aW9uOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBsZXQgbm9OYW1lID0gUGVyc29uLmNyZWF0ZSgpOwogICAgICBub05hbWUuaGVsbG9Xb3JsZCgpOyAvLyBhbGVydHMgdW5kZWZpbmVkCiAgICAgIGBgYAogICAgICAgTk9URTogRm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMsIHlvdSBjYW5ub3QgZGVjbGFyZSBtZXRob2RzIG9yIGNvbXB1dGVkCiAgICAgIHByb3BlcnRpZXMgZHVyaW5nIGBjcmVhdGVgLiBZb3Ugc2hvdWxkIGluc3RlYWQgZGVjbGFyZSBtZXRob2RzIGFuZCBjb21wdXRlZAogICAgICBwcm9wZXJ0aWVzIHdoZW4gdXNpbmcgYGV4dGVuZGAuCiAgICAgICBAbWV0aG9kIGNyZWF0ZQogICAgICBAZm9yIEBlbWJlci9vYmplY3QKICAgICAgQHN0YXRpYwogICAgICBAcGFyYW0gW2FyZ3VtZW50c10qCiAgICAgIEBwdWJsaWMKICAgICovCiAgICA7CgogICAgQ29yZU9iamVjdC5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUocHJvcHMsIGV4dHJhKSB7CiAgICAgIHZhciBDID0gdGhpczsKICAgICAgdmFyIGluc3RhbmNlOwoKICAgICAgaWYgKHRoaXNbRlJBTUVXT1JLX0NMQVNTRVNdKSB7CiAgICAgICAgdmFyIGluaXRGYWN0b3J5ID0gZmFjdG9yeU1hcC5nZXQodGhpcyk7CiAgICAgICAgdmFyIG93bmVyOwoKICAgICAgICBpZiAoaW5pdEZhY3RvcnkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgb3duZXIgPSBpbml0RmFjdG9yeS5vd25lcjsKICAgICAgICB9IGVsc2UgaWYgKHByb3BzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIG93bmVyID0gKDAsIF9vd25lci5nZXRPd25lcikocHJvcHMpOwogICAgICAgIH0KCiAgICAgICAgaWYgKG93bmVyID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIC8vIGZhbGxiYWNrIHRvIHBhc3NpbmcgdGhlIHNwZWNpYWwgUEFTU0VEX0ZST01fQ1JFQVRFIHN5bWJvbAogICAgICAgICAgLy8gdG8gYXZvaWQgYW4gZXJyb3Igd2hlbiBmb2xrcyBjYWxsIHRoaW5ncyBsaWtlIENvbnRyb2xsZXIuZXh0ZW5kKCkuY3JlYXRlKCkKICAgICAgICAgIC8vIHdlIHNob3VsZCBkbyBhIHN1YnNlcXVlbnQgZGVwcmVjYXRpb24gcGFzcyB0byBlbnN1cmUgdGhpcyBpc24ndCBhbGxvd2VkCiAgICAgICAgICBvd25lciA9IFBBU1NFRF9GUk9NX0NSRUFURTsKICAgICAgICB9CgogICAgICAgIGluc3RhbmNlID0gbmV3IEMob3duZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIGluc3RhbmNlID0gZmFsc2UKICAgICAgICAvKiBERUJVRyAqLwogICAgICAgID8gbmV3IEMoUEFTU0VEX0ZST01fQ1JFQVRFKSA6IG5ldyBDKCk7CiAgICAgIH0KCiAgICAgIGlmIChleHRyYSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaW5pdGlhbGl6ZShpbnN0YW5jZSwgcHJvcHMpOwogICAgICB9IGVsc2UgewogICAgICAgIGluaXRpYWxpemUoaW5zdGFuY2UsIGZsYXR0ZW5Qcm9wcy5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgfQogICAgLyoqCiAgICAgIEF1Z21lbnRzIGEgY29uc3RydWN0b3IncyBwcm90b3R5cGUgd2l0aCBhZGRpdGlvbmFsCiAgICAgIHByb3BlcnRpZXMgYW5kIGZ1bmN0aW9uczoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgY29uc3QgTXlPYmplY3QgPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICAgIG5hbWU6ICdhbiBvYmplY3QnCiAgICAgIH0pOwogICAgICAgbyA9IE15T2JqZWN0LmNyZWF0ZSgpOwogICAgICBvLmdldCgnbmFtZScpOyAvLyAnYW4gb2JqZWN0JwogICAgICAgTXlPYmplY3QucmVvcGVuKHsKICAgICAgICBzYXkobXNnKSB7CiAgICAgICAgICBjb25zb2xlLmxvZyhtc2cpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgICBvMiA9IE15T2JqZWN0LmNyZWF0ZSgpOwogICAgICBvMi5zYXkoJ2hlbGxvJyk7IC8vIGxvZ3MgImhlbGxvIgogICAgICAgby5zYXkoJ2dvb2RieWUnKTsgLy8gbG9ncyAiZ29vZGJ5ZSIKICAgICAgYGBgCiAgICAgICBUbyBhZGQgZnVuY3Rpb25zIGFuZCBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBpdHNlbGYsCiAgICAgIHNlZSBgcmVvcGVuQ2xhc3NgCiAgICAgICBAbWV0aG9kIHJlb3BlbgogICAgICBAZm9yIEBlbWJlci9vYmplY3QKICAgICAgQHN0YXRpYwogICAgICBAcHVibGljCiAgICAqLwogICAgOwoKICAgIENvcmVPYmplY3QucmVvcGVuID0gZnVuY3Rpb24gcmVvcGVuKCkgewogICAgICB0aGlzLndpbGxSZW9wZW4oKTsKCiAgICAgIF9yZW9wZW4uYXBwbHkodGhpcy5Qcm90b3R5cGVNaXhpbiwgYXJndW1lbnRzKTsKCiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICBDb3JlT2JqZWN0LndpbGxSZW9wZW4gPSBmdW5jdGlvbiB3aWxsUmVvcGVuKCkgewogICAgICB2YXIgcCA9IHRoaXMucHJvdG90eXBlOwoKICAgICAgaWYgKHdhc0FwcGxpZWQuaGFzKHApKSB7CiAgICAgICAgd2FzQXBwbGllZC5kZWxldGUocCk7IC8vIElmIHRoZSBiYXNlIG1peGluIGFscmVhZHkgZXhpc3RzIGFuZCB3YXMgYXBwbGllZCwgY3JlYXRlIGEgbmV3IG1peGluIHRvCiAgICAgICAgLy8gbWFrZSBzdXJlIHRoYXQgaXQgZ2V0cyBwcm9wZXJseSBhcHBsaWVkLiBSZXVzaW5nIHRoZSBzYW1lIG1peGluIGFmdGVyCiAgICAgICAgLy8gdGhlIGZpcnN0IGBwcm90b2AgY2FsbCB3aWxsIGNhdXNlIGl0IHRvIGdldCBza2lwcGVkLgoKICAgICAgICBpZiAocHJvdG90eXBlTWl4aW5NYXAuaGFzKHRoaXMpKSB7CiAgICAgICAgICBwcm90b3R5cGVNaXhpbk1hcC5zZXQodGhpcywgX21ldGFsLk1peGluLmNyZWF0ZSh0aGlzLlByb3RvdHlwZU1peGluKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioKICAgICAgQXVnbWVudHMgYSBjb25zdHJ1Y3RvcidzIG93biBwcm9wZXJ0aWVzIGFuZCBmdW5jdGlvbnM6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICAgIGNvbnN0IE15T2JqZWN0ID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgICBuYW1lOiAnYW4gb2JqZWN0JwogICAgICB9KTsKICAgICAgIE15T2JqZWN0LnJlb3BlbkNsYXNzKHsKICAgICAgICBjYW5CdWlsZDogZmFsc2UKICAgICAgfSk7CiAgICAgICBNeU9iamVjdC5jYW5CdWlsZDsgLy8gZmFsc2UKICAgICAgbyA9IE15T2JqZWN0LmNyZWF0ZSgpOwogICAgICBgYGAKICAgICAgIEluIG90aGVyIHdvcmRzLCB0aGlzIGNyZWF0ZXMgc3RhdGljIHByb3BlcnRpZXMgYW5kIGZ1bmN0aW9ucyBmb3IgdGhlIGNsYXNzLgogICAgICBUaGVzZSBhcmUgb25seSBhdmFpbGFibGUgb24gdGhlIGNsYXNzIGFuZCBub3Qgb24gYW55IGluc3RhbmNlIG9mIHRoYXQgY2xhc3MuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICAgIGNvbnN0IFBlcnNvbiA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgbmFtZTogJycsCiAgICAgICAgc2F5SGVsbG8oKSB7CiAgICAgICAgICBhbGVydChgSGVsbG8uIE15IG5hbWUgaXMgJHt0aGlzLmdldCgnbmFtZScpfWApOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgICBQZXJzb24ucmVvcGVuQ2xhc3MoewogICAgICAgIHNwZWNpZXM6ICdIb21vIHNhcGllbnMnLAogICAgICAgICBjcmVhdGVQZXJzb24obmFtZSkgewogICAgICAgICAgcmV0dXJuIFBlcnNvbi5jcmVhdGUoeyBuYW1lIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgICBsZXQgdG9tID0gUGVyc29uLmNyZWF0ZSh7CiAgICAgICAgbmFtZTogJ1RvbSBEYWxlJwogICAgICB9KTsKICAgICAgbGV0IHllaHVkYSA9IFBlcnNvbi5jcmVhdGVQZXJzb24oJ1llaHVkYSBLYXR6Jyk7CiAgICAgICB0b20uc2F5SGVsbG8oKTsgLy8gIkhlbGxvLiBNeSBuYW1lIGlzIFRvbSBEYWxlIgogICAgICB5ZWh1ZGEuc2F5SGVsbG8oKTsgLy8gIkhlbGxvLiBNeSBuYW1lIGlzIFllaHVkYSBLYXR6IgogICAgICBhbGVydChQZXJzb24uc3BlY2llcyk7IC8vICJIb21vIHNhcGllbnMiCiAgICAgIGBgYAogICAgICAgTm90ZSB0aGF0IGBzcGVjaWVzYCBhbmQgYGNyZWF0ZVBlcnNvbmAgYXJlICpub3QqIHZhbGlkIG9uIHRoZSBgdG9tYCBhbmQgYHllaHVkYWAKICAgICAgdmFyaWFibGVzLiBUaGV5IGFyZSBvbmx5IHZhbGlkIG9uIGBQZXJzb25gLgogICAgICAgVG8gYWRkIGZ1bmN0aW9ucyBhbmQgcHJvcGVydGllcyB0byBpbnN0YW5jZXMgb2YKICAgICAgYSBjb25zdHJ1Y3RvciBieSBleHRlbmRpbmcgdGhlIGNvbnN0cnVjdG9yJ3MgcHJvdG90eXBlCiAgICAgIHNlZSBgcmVvcGVuYAogICAgICAgQG1ldGhvZCByZW9wZW5DbGFzcwogICAgICBAZm9yIEBlbWJlci9vYmplY3QKICAgICAgQHN0YXRpYwogICAgICBAcHVibGljCiAgICAqLwogICAgOwoKICAgIENvcmVPYmplY3QucmVvcGVuQ2xhc3MgPSBmdW5jdGlvbiByZW9wZW5DbGFzcygpIHsKICAgICAgKDAsIF9tZXRhbC5hcHBseU1peGluKSh0aGlzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgQ29yZU9iamVjdC5kZXRlY3QgPSBmdW5jdGlvbiBkZXRlY3Qob2JqKSB7CiAgICAgIGlmICgnZnVuY3Rpb24nICE9PSB0eXBlb2Ygb2JqKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB3aGlsZSAob2JqKSB7CiAgICAgICAgaWYgKG9iaiA9PT0gdGhpcykgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBvYmogPSBvYmouc3VwZXJjbGFzczsKICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICBDb3JlT2JqZWN0LmRldGVjdEluc3RhbmNlID0gZnVuY3Rpb24gZGV0ZWN0SW5zdGFuY2Uob2JqKSB7CiAgICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgIEluIHNvbWUgY2FzZXMsIHlvdSBtYXkgd2FudCB0byBhbm5vdGF0ZSBjb21wdXRlZCBwcm9wZXJ0aWVzIHdpdGggYWRkaXRpb25hbAogICAgICBtZXRhZGF0YSBhYm91dCBob3cgdGhleSBmdW5jdGlvbiBvciB3aGF0IHZhbHVlcyB0aGV5IG9wZXJhdGUgb24uIEZvcgogICAgICBleGFtcGxlLCBjb21wdXRlZCBwcm9wZXJ0eSBmdW5jdGlvbnMgbWF5IGNsb3NlIG92ZXIgdmFyaWFibGVzIHRoYXQgYXJlIHRoZW4KICAgICAgbm8gbG9uZ2VyIGF2YWlsYWJsZSBmb3IgaW50cm9zcGVjdGlvbi4KICAgICAgIFlvdSBjYW4gcGFzcyBhIGhhc2ggb2YgdGhlc2UgdmFsdWVzIHRvIGEgY29tcHV0ZWQgcHJvcGVydHkgbGlrZSB0aGlzOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgeyBjb21wdXRlZCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgcGVyc29uOiBjb21wdXRlZChmdW5jdGlvbigpIHsKICAgICAgICBsZXQgcGVyc29uSWQgPSB0aGlzLmdldCgncGVyc29uSWQnKTsKICAgICAgICByZXR1cm4gUGVyc29uLmNyZWF0ZSh7IGlkOiBwZXJzb25JZCB9KTsKICAgICAgfSkubWV0YSh7IHR5cGU6IFBlcnNvbiB9KQogICAgICBgYGAKICAgICAgIE9uY2UgeW91J3ZlIGRvbmUgdGhpcywgeW91IGNhbiByZXRyaWV2ZSB0aGUgdmFsdWVzIHNhdmVkIHRvIHRoZSBjb21wdXRlZAogICAgICBwcm9wZXJ0eSBmcm9tIHlvdXIgY2xhc3MgbGlrZSB0aGlzOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBNeUNsYXNzLm1ldGFGb3JQcm9wZXJ0eSgncGVyc29uJyk7CiAgICAgIGBgYAogICAgICAgVGhpcyB3aWxsIHJldHVybiB0aGUgb3JpZ2luYWwgaGFzaCB0aGF0IHdhcyBwYXNzZWQgdG8gYG1ldGEoKWAuCiAgICAgICBAc3RhdGljCiAgICAgIEBtZXRob2QgbWV0YUZvclByb3BlcnR5CiAgICAgIEBwYXJhbSBrZXkge1N0cmluZ30gcHJvcGVydHkgbmFtZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIDsKCiAgICBDb3JlT2JqZWN0Lm1ldGFGb3JQcm9wZXJ0eSA9IGZ1bmN0aW9uIG1ldGFGb3JQcm9wZXJ0eShrZXkpIHsKICAgICAgdmFyIHByb3RvID0gdGhpcy5wcm90bygpOyAvLyBlbnN1cmUgcHJvdG90eXBlIGlzIGluaXRpYWxpemVkCgogICAgICB2YXIgcG9zc2libGVEZXNjID0gKDAsIF9tZXRhbC5kZXNjcmlwdG9yRm9yUHJvcGVydHkpKHByb3RvLCBrZXkpOwogICAgICAoZmFsc2UgJiYgIShwb3NzaWJsZURlc2MgIT09IHVuZGVmaW5lZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJtZXRhRm9yUHJvcGVydHkoKSBjb3VsZCBub3QgZmluZCBhIGNvbXB1dGVkIHByb3BlcnR5IHdpdGgga2V5ICciICsga2V5ICsgIicuIiwgcG9zc2libGVEZXNjICE9PSB1bmRlZmluZWQpKTsKICAgICAgcmV0dXJuIHBvc3NpYmxlRGVzYy5fbWV0YSB8fCB7fTsKICAgIH0KICAgIC8qKgogICAgICBJdGVyYXRlIG92ZXIgZWFjaCBjb21wdXRlZCBwcm9wZXJ0eSBmb3IgdGhlIGNsYXNzLCBwYXNzaW5nIGl0cyBuYW1lCiAgICAgIGFuZCBhbnkgYXNzb2NpYXRlZCBtZXRhZGF0YSAoc2VlIGBtZXRhRm9yUHJvcGVydHlgKSB0byB0aGUgY2FsbGJhY2suCiAgICAgICBAc3RhdGljCiAgICAgIEBtZXRob2QgZWFjaENvbXB1dGVkUHJvcGVydHkKICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICAgICAgQHBhcmFtIHtPYmplY3R9IGJpbmRpbmcKICAgICAgQHByaXZhdGUKICAgICovCiAgICA7CgogICAgQ29yZU9iamVjdC5lYWNoQ29tcHV0ZWRQcm9wZXJ0eSA9IGZ1bmN0aW9uIGVhY2hDb21wdXRlZFByb3BlcnR5KGNhbGxiYWNrLCBiaW5kaW5nKSB7CiAgICAgIGlmIChiaW5kaW5nID09PSB2b2lkIDApIHsKICAgICAgICBiaW5kaW5nID0gdGhpczsKICAgICAgfQoKICAgICAgdGhpcy5wcm90bygpOyAvLyBlbnN1cmUgcHJvdG90eXBlIGlzIGluaXRpYWxpemVkCgogICAgICB2YXIgZW1wdHkgPSB7fTsKICAgICAgKDAsIF9tZXRhMi5tZXRhKSh0aGlzLnByb3RvdHlwZSkuZm9yRWFjaERlc2NyaXB0b3JzKGZ1bmN0aW9uIChuYW1lLCBkZXNjcmlwdG9yKSB7CiAgICAgICAgaWYgKGRlc2NyaXB0b3IuZW51bWVyYWJsZSkgewogICAgICAgICAgdmFyIF9tZXRhID0gZGVzY3JpcHRvci5fbWV0YSB8fCBlbXB0eTsKCiAgICAgICAgICBjYWxsYmFjay5jYWxsKGJpbmRpbmcsIG5hbWUsIF9tZXRhKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKCiAgICBDb3JlT2JqZWN0LnByb3RvID0gZnVuY3Rpb24gcHJvdG8oKSB7CiAgICAgIHZhciBwID0gdGhpcy5wcm90b3R5cGU7CgogICAgICBpZiAoIXdhc0FwcGxpZWQuaGFzKHApKSB7CiAgICAgICAgd2FzQXBwbGllZC5hZGQocCk7CiAgICAgICAgdmFyIHBhcmVudCA9IHRoaXMuc3VwZXJjbGFzczsKCiAgICAgICAgaWYgKHBhcmVudCkgewogICAgICAgICAgcGFyZW50LnByb3RvKCk7CiAgICAgICAgfSAvLyBJZiB0aGUgcHJvdG90eXBlIG1peGluIGV4aXN0cywgYXBwbHkgaXQuIEluIHRoZSBjYXNlIG9mIG5hdGl2ZSBjbGFzc2VzLAogICAgICAgIC8vIGl0IHdpbGwgbm90IGV4aXN0ICh1bmxlc3MgdGhlIGNsYXNzIGhhcyBiZWVuIHJlb3BlbmVkKS4KCgogICAgICAgIGlmIChwcm90b3R5cGVNaXhpbk1hcC5oYXModGhpcykpIHsKICAgICAgICAgIHRoaXMuUHJvdG90eXBlTWl4aW4uYXBwbHkocCk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gcDsKICAgIH07CgogICAgKDAsIF9lbWJlckJhYmVsLmNyZWF0ZUNsYXNzKShDb3JlT2JqZWN0LCBbewogICAgICBrZXk6ICJpc0Rlc3Ryb3llZCIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiAoMCwgX21ldGEyLnBlZWtNZXRhKSh0aGlzKS5pc1NvdXJjZURlc3Ryb3llZCgpOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldCh2YWx1ZSkgewogICAgICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIllvdSBjYW5ub3Qgc2V0IGAiICsgdGhpcyArICIuaXNEZXN0cm95ZWRgIGRpcmVjdGx5LCBwbGVhc2UgdXNlIGAuZGVzdHJveSgpYC4iLCBmYWxzZSkpOwogICAgICB9CiAgICAgIC8qKgogICAgICAgIERlc3RydWN0aW9uIHNjaGVkdWxlZCBmbGFnLiBUaGUgYGRlc3Ryb3koKWAgbWV0aG9kIGhhcyBiZWVuIGNhbGxlZC4KICAgICAgICAgVGhlIG9iamVjdCBzdGF5cyBpbnRhY3QgdW50aWwgdGhlIGVuZCBvZiB0aGUgcnVuIGxvb3AgYXQgd2hpY2ggcG9pbnQKICAgICAgICB0aGUgYGlzRGVzdHJveWVkYCBmbGFnIGlzIHNldC4KICAgICAgICAgQHByb3BlcnR5IGlzRGVzdHJveWluZwogICAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgICAgQHB1YmxpYwogICAgICAqLwoKICAgIH0sIHsKICAgICAga2V5OiAiaXNEZXN0cm95aW5nIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuICgwLCBfbWV0YTIucGVla01ldGEpKHRoaXMpLmlzU291cmNlRGVzdHJveWluZygpOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldCh2YWx1ZSkgewogICAgICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIllvdSBjYW5ub3Qgc2V0IGAiICsgdGhpcyArICIuaXNEZXN0cm95aW5nYCBkaXJlY3RseSwgcGxlYXNlIHVzZSBgLmRlc3Ryb3koKWAuIiwgZmFsc2UpKTsKICAgICAgfQogICAgfV0sIFt7CiAgICAgIGtleTogIlByb3RvdHlwZU1peGluIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgdmFyIHByb3RvdHlwZU1peGluID0gcHJvdG90eXBlTWl4aW5NYXAuZ2V0KHRoaXMpOwoKICAgICAgICBpZiAocHJvdG90eXBlTWl4aW4gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcHJvdG90eXBlTWl4aW4gPSBfbWV0YWwuTWl4aW4uY3JlYXRlKCk7CiAgICAgICAgICBwcm90b3R5cGVNaXhpbi5vd25lckNvbnN0cnVjdG9yID0gdGhpczsKICAgICAgICAgIHByb3RvdHlwZU1peGluTWFwLnNldCh0aGlzLCBwcm90b3R5cGVNaXhpbik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcHJvdG90eXBlTWl4aW47CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic3VwZXJjbGFzcyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHZhciBjID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpOwogICAgICAgIHJldHVybiBjICE9PSBGdW5jdGlvbi5wcm90b3R5cGUgPyBjIDogdW5kZWZpbmVkOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQ29yZU9iamVjdDsKICB9KCk7CgogIENvcmVPYmplY3QudG9TdHJpbmcgPSBfbWV0YWwuY2xhc3NUb1N0cmluZzsKICAoMCwgX3V0aWxzLnNldE5hbWUpKENvcmVPYmplY3QsICdFbWJlci5Db3JlT2JqZWN0Jyk7CiAgQ29yZU9iamVjdC5pc0NsYXNzID0gdHJ1ZTsKICBDb3JlT2JqZWN0LmlzTWV0aG9kID0gZmFsc2U7CgogIGZ1bmN0aW9uIGZsYXR0ZW5Qcm9wcygpIHsKICAgIHZhciBjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzID0gdGhpcy5jb25jYXRlbmF0ZWRQcm9wZXJ0aWVzLAogICAgICAgIG1lcmdlZFByb3BlcnRpZXMgPSB0aGlzLm1lcmdlZFByb3BlcnRpZXM7CiAgICB2YXIgaGFzQ29uY2F0ZW5hdGVkUHJvcHMgPSBjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQgJiYgY29uY2F0ZW5hdGVkUHJvcGVydGllcy5sZW5ndGggPiAwOwogICAgdmFyIGhhc01lcmdlZFByb3BzID0gbWVyZ2VkUHJvcGVydGllcyAhPT0gdW5kZWZpbmVkICYmIG1lcmdlZFByb3BlcnRpZXMubGVuZ3RoID4gMDsKICAgIHZhciBpbml0UHJvcGVydGllcyA9IHt9OwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBwcm9wZXJ0aWVzID0gaSA8IDAgfHwgYXJndW1lbnRzLmxlbmd0aCA8PSBpID8gdW5kZWZpbmVkIDogYXJndW1lbnRzW2ldOwogICAgICAoZmFsc2UgJiYgISghKHByb3BlcnRpZXMgaW5zdGFuY2VvZiBfbWV0YWwuTWl4aW4pKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0VtYmVyT2JqZWN0LmNyZWF0ZSBubyBsb25nZXIgc3VwcG9ydHMgbWl4aW5nIGluIG90aGVyICcgKyAnZGVmaW5pdGlvbnMsIHVzZSAuZXh0ZW5kICYgLmNyZWF0ZSBzZXBhcmF0ZWx5IGluc3RlYWQuJywgIShwcm9wZXJ0aWVzIGluc3RhbmNlb2YgX21ldGFsLk1peGluKSkpOwogICAgICB2YXIga2V5TmFtZXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKTsKCiAgICAgIGZvciAodmFyIGogPSAwLCBrID0ga2V5TmFtZXMubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgdmFyIGtleU5hbWUgPSBrZXlOYW1lc1tqXTsKICAgICAgICB2YXIgdmFsdWUgPSBwcm9wZXJ0aWVzW2tleU5hbWVdOwoKICAgICAgICBpZiAoaGFzQ29uY2F0ZW5hdGVkUHJvcHMgJiYgY29uY2F0ZW5hdGVkUHJvcGVydGllcy5pbmRleE9mKGtleU5hbWUpID4gLTEpIHsKICAgICAgICAgIHZhciBiYXNlVmFsdWUgPSBpbml0UHJvcGVydGllc1trZXlOYW1lXTsKCiAgICAgICAgICBpZiAoYmFzZVZhbHVlKSB7CiAgICAgICAgICAgIHZhbHVlID0gKDAsIF91dGlscy5tYWtlQXJyYXkpKGJhc2VWYWx1ZSkuY29uY2F0KHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gKDAsIF91dGlscy5tYWtlQXJyYXkpKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChoYXNNZXJnZWRQcm9wcyAmJiBtZXJnZWRQcm9wZXJ0aWVzLmluZGV4T2Yoa2V5TmFtZSkgPiAtMSkgewogICAgICAgICAgdmFyIF9iYXNlVmFsdWUgPSBpbml0UHJvcGVydGllc1trZXlOYW1lXTsKICAgICAgICAgIHZhbHVlID0gKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7fSwgX2Jhc2VWYWx1ZSwgdmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgaW5pdFByb3BlcnRpZXNba2V5TmFtZV0gPSB2YWx1ZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBpbml0UHJvcGVydGllczsKICB9CgogIGlmIChmYWxzZQogIC8qIERFQlVHICovCiAgKSB7CiAgICAvKioKICAgICAgUHJvdmlkZXMgbG9va3VwLXRpbWUgdHlwZSB2YWxpZGF0aW9uIGZvciBpbmplY3RlZCBwcm9wZXJ0aWVzLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBfb25Mb29rdXAKICAgICovCiAgICBDb3JlT2JqZWN0Ll9vbkxvb2t1cCA9IGZ1bmN0aW9uIGluamVjdGVkUHJvcGVydHlBc3NlcnRpb24oZGVidWdDb250YWluZXJLZXkpIHsKICAgICAgdmFyIF9kZWJ1Z0NvbnRhaW5lcktleSRzcCA9IGRlYnVnQ29udGFpbmVyS2V5LnNwbGl0KCc6JyksCiAgICAgICAgICB0eXBlID0gX2RlYnVnQ29udGFpbmVyS2V5JHNwWzBdOwoKICAgICAgdmFyIHByb3RvID0gdGhpcy5wcm90bygpOwoKICAgICAgZm9yICh2YXIga2V5IGluIHByb3RvKSB7CiAgICAgICAgdmFyIGRlc2MgPSAoMCwgX21ldGFsLmRlc2NyaXB0b3JGb3JQcm9wZXJ0eSkocHJvdG8sIGtleSk7CgogICAgICAgIGlmIChkZXNjICYmIF9tZXRhbC5ERUJVR19JTkpFQ1RJT05fRlVOQ1RJT05TLmhhcyhkZXNjLl9nZXR0ZXIpKSB7CiAgICAgICAgICAoZmFsc2UgJiYgISh0eXBlID09PSAnY29udHJvbGxlcicgfHwgX21ldGFsLkRFQlVHX0lOSkVDVElPTl9GVU5DVElPTlMuZ2V0KGRlc2MuX2dldHRlcikudHlwZSAhPT0gJ2NvbnRyb2xsZXInKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkRlZmluaW5nIGAiICsga2V5ICsgImAgYXMgYW4gaW5qZWN0ZWQgY29udHJvbGxlciBwcm9wZXJ0eSBvbiBhIG5vbi1jb250cm9sbGVyIChgIiArIGRlYnVnQ29udGFpbmVyS2V5ICsgImApIGlzIG5vdCBhbGxvd2VkLiIsIHR5cGUgPT09ICdjb250cm9sbGVyJyB8fCBfbWV0YWwuREVCVUdfSU5KRUNUSU9OX0ZVTkNUSU9OUy5nZXQoZGVzYy5fZ2V0dGVyKS50eXBlICE9PSAnY29udHJvbGxlcicpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICAvKioKICAgICAgUmV0dXJucyBhIGhhc2ggb2YgcHJvcGVydHkgbmFtZXMgYW5kIGNvbnRhaW5lciBuYW1lcyB0aGF0IGluamVjdGVkCiAgICAgIHByb3BlcnRpZXMgd2lsbCBsb29rdXAgb24gdGhlIGNvbnRhaW5lciBsYXppbHkuCiAgICAgICBAbWV0aG9kIF9sYXp5SW5qZWN0aW9ucwogICAgICBAcmV0dXJuIHtPYmplY3R9IEhhc2ggb2YgYWxsIGxhenkgaW5qZWN0ZWQgcHJvcGVydHkga2V5cyB0byBjb250YWluZXIgbmFtZXMKICAgICAgQHByaXZhdGUKICAgICovCgoKICAgIENvcmVPYmplY3QuX2xhenlJbmplY3Rpb25zID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgaW5qZWN0aW9ucyA9IHt9OwogICAgICB2YXIgcHJvdG8gPSB0aGlzLnByb3RvKCk7CiAgICAgIHZhciBrZXk7CiAgICAgIHZhciBkZXNjOwoKICAgICAgZm9yIChrZXkgaW4gcHJvdG8pIHsKICAgICAgICBkZXNjID0gKDAsIF9tZXRhbC5kZXNjcmlwdG9yRm9yUHJvcGVydHkpKHByb3RvLCBrZXkpOwoKICAgICAgICBpZiAoZGVzYyAmJiBfbWV0YWwuREVCVUdfSU5KRUNUSU9OX0ZVTkNUSU9OUy5oYXMoZGVzYy5fZ2V0dGVyKSkgewogICAgICAgICAgdmFyIF9ERUJVR19JTkpFQ1RJT05fRlVOQyA9IF9tZXRhbC5ERUJVR19JTkpFQ1RJT05fRlVOQ1RJT05TLmdldChkZXNjLl9nZXR0ZXIpLAogICAgICAgICAgICAgIG5hbWVzcGFjZSA9IF9ERUJVR19JTkpFQ1RJT05fRlVOQy5uYW1lc3BhY2UsCiAgICAgICAgICAgICAgc291cmNlID0gX0RFQlVHX0lOSkVDVElPTl9GVU5DLnNvdXJjZSwKICAgICAgICAgICAgICB0eXBlID0gX0RFQlVHX0lOSkVDVElPTl9GVU5DLnR5cGUsCiAgICAgICAgICAgICAgbmFtZSA9IF9ERUJVR19JTkpFQ1RJT05fRlVOQy5uYW1lOwoKICAgICAgICAgIGluamVjdGlvbnNba2V5XSA9IHsKICAgICAgICAgICAgbmFtZXNwYWNlOiBuYW1lc3BhY2UsCiAgICAgICAgICAgIHNvdXJjZTogc291cmNlLAogICAgICAgICAgICBzcGVjaWZpZXI6IHR5cGUgKyAiOiIgKyAobmFtZSB8fCBrZXkpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGluamVjdGlvbnM7CiAgICB9OwogIH0KCiAgdmFyIF9kZWZhdWx0ID0gQ29yZU9iamVjdDsKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL3N5c3RlbS9uYW1lc3BhY2UiLCBbImV4cG9ydHMiLCAiZW1iZXItYmFiZWwiLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiLCAiQGVtYmVyLy1pbnRlcm5hbHMvdXRpbHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvc3lzdGVtL29iamVjdCJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9lbWJlckJhYmVsLCBfbWV0YWwsIF91dGlscywgX29iamVjdCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgQG1vZHVsZSBlbWJlcgogICovCiAgLy8gUHJlbG9hZGVkIGludG8gbmFtZXNwYWNlcwoKICAvKioKICAgIEEgTmFtZXNwYWNlIGlzIGFuIG9iamVjdCB1c3VhbGx5IHVzZWQgdG8gY29udGFpbiBvdGhlciBvYmplY3RzIG9yIG1ldGhvZHMKICAgIHN1Y2ggYXMgYW4gYXBwbGljYXRpb24gb3IgZnJhbWV3b3JrLiBDcmVhdGUgYSBuYW1lc3BhY2UgYW55dGltZSB5b3Ugd2FudAogICAgdG8gZGVmaW5lIG9uZSBvZiB0aGVzZSBuZXcgY29udGFpbmVycy4KICAKICAgICMgRXhhbXBsZSBVc2FnZQogIAogICAgYGBgamF2YXNjcmlwdAogICAgTXlGcmFtZXdvcmsgPSBFbWJlci5OYW1lc3BhY2UuY3JlYXRlKHsKICAgICAgVkVSU0lPTjogJzEuMC4wJwogICAgfSk7CiAgICBgYGAKICAKICAgIEBjbGFzcyBOYW1lc3BhY2UKICAgIEBuYW1lc3BhY2UgRW1iZXIKICAgIEBleHRlbmRzIEVtYmVyT2JqZWN0CiAgICBAcHVibGljCiAgKi8KICB2YXIgTmFtZXNwYWNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9FbWJlck9iamVjdCkgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKE5hbWVzcGFjZSwgX0VtYmVyT2JqZWN0KTsKCiAgICBmdW5jdGlvbiBOYW1lc3BhY2UoKSB7CiAgICAgIHJldHVybiBfRW1iZXJPYmplY3QuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBOYW1lc3BhY2UucHJvdG90eXBlOwoKICAgIF9wcm90by5pbml0ID0gZnVuY3Rpb24gaW5pdCgpIHsKICAgICAgKDAsIF9tZXRhbC5hZGROYW1lc3BhY2UpKHRoaXMpOwogICAgfTsKCiAgICBfcHJvdG8udG9TdHJpbmcgPSBmdW5jdGlvbiB0b1N0cmluZygpIHsKICAgICAgdmFyIG5hbWUgPSAoMCwgX21ldGFsLmdldCkodGhpcywgJ25hbWUnKSB8fCAoMCwgX21ldGFsLmdldCkodGhpcywgJ21vZHVsZVByZWZpeCcpOwoKICAgICAgaWYgKG5hbWUpIHsKICAgICAgICByZXR1cm4gbmFtZTsKICAgICAgfQoKICAgICAgKDAsIF9tZXRhbC5maW5kTmFtZXNwYWNlcykoKTsKICAgICAgbmFtZSA9ICgwLCBfdXRpbHMuZ2V0TmFtZSkodGhpcyk7CgogICAgICBpZiAobmFtZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgbmFtZSA9ICgwLCBfdXRpbHMuZ3VpZEZvcikodGhpcyk7CiAgICAgICAgKDAsIF91dGlscy5zZXROYW1lKSh0aGlzLCBuYW1lKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9OwoKICAgIF9wcm90by5uYW1lQ2xhc3NlcyA9IGZ1bmN0aW9uIG5hbWVDbGFzc2VzKCkgewogICAgICAoMCwgX21ldGFsLnByb2Nlc3NOYW1lc3BhY2UpKHRoaXMpOwogICAgfTsKCiAgICBfcHJvdG8uZGVzdHJveSA9IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICgwLCBfbWV0YWwucmVtb3ZlTmFtZXNwYWNlKSh0aGlzKTsKCiAgICAgIF9FbWJlck9iamVjdC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgfTsKCiAgICByZXR1cm4gTmFtZXNwYWNlOwogIH0oX29iamVjdC5kZWZhdWx0KTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IE5hbWVzcGFjZTsKICBOYW1lc3BhY2UucHJvdG90eXBlLmlzTmFtZXNwYWNlID0gdHJ1ZTsKICBOYW1lc3BhY2UuTkFNRVNQQUNFUyA9IF9tZXRhbC5OQU1FU1BBQ0VTOwogIE5hbWVzcGFjZS5OQU1FU1BBQ0VTX0JZX0lEID0gX21ldGFsLk5BTUVTUEFDRVNfQllfSUQ7CiAgTmFtZXNwYWNlLnByb2Nlc3NBbGwgPSBfbWV0YWwucHJvY2Vzc0FsbE5hbWVzcGFjZXM7CiAgTmFtZXNwYWNlLmJ5TmFtZSA9IF9tZXRhbC5maW5kTmFtZXNwYWNlOwp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9zeXN0ZW0vb2JqZWN0IiwgWyJleHBvcnRzIiwgImVtYmVyLWJhYmVsIiwgIkBlbWJlci8taW50ZXJuYWxzL2NvbnRhaW5lciIsICJAZW1iZXIvLWludGVybmFscy9vd25lciIsICJAZW1iZXIvLWludGVybmFscy91dGlscyIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9zeXN0ZW0vY29yZV9vYmplY3QiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvbWl4aW5zL29ic2VydmFibGUiLCAiQGVtYmVyL2RlYnVnIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2VtYmVyQmFiZWwsIF9jb250YWluZXIsIF9vd25lciwgX3V0aWxzLCBfbWV0YWwsIF9jb3JlX29iamVjdCwgX29ic2VydmFibGUsIF9kZWJ1ZykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuRnJhbWV3b3JrT2JqZWN0ID0gX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgKi8KICB2YXIgaW5zdGFuY2VPd25lciA9IG5ldyBXZWFrTWFwKCk7CiAgLyoqCiAgICBgRW1iZXJPYmplY3RgIGlzIHRoZSBtYWluIGJhc2UgY2xhc3MgZm9yIGFsbCBFbWJlciBvYmplY3RzLiBJdCBpcyBhIHN1YmNsYXNzCiAgICBvZiBgQ29yZU9iamVjdGAgd2l0aCB0aGUgYE9ic2VydmFibGVgIG1peGluIGFwcGxpZWQuIEZvciBkZXRhaWxzLAogICAgc2VlIHRoZSBkb2N1bWVudGF0aW9uIGZvciBlYWNoIG9mIHRoZXNlLgogIAogICAgQGNsYXNzIEVtYmVyT2JqZWN0CiAgICBAZXh0ZW5kcyBDb3JlT2JqZWN0CiAgICBAdXNlcyBPYnNlcnZhYmxlCiAgICBAcHVibGljCiAgKi8KCiAgdmFyIEVtYmVyT2JqZWN0ID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9Db3JlT2JqZWN0KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoRW1iZXJPYmplY3QsIF9Db3JlT2JqZWN0KTsKCiAgICBmdW5jdGlvbiBFbWJlck9iamVjdCgpIHsKICAgICAgcmV0dXJuIF9Db3JlT2JqZWN0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgIH0KCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKEVtYmVyT2JqZWN0LCBbewogICAgICBrZXk6ICJfZGVidWdDb250YWluZXJLZXkiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICB2YXIgZmFjdG9yeSA9IF9jb250YWluZXIuRkFDVE9SWV9GT1IuZ2V0KHRoaXMpOwoKICAgICAgICByZXR1cm4gZmFjdG9yeSAhPT0gdW5kZWZpbmVkICYmIGZhY3RvcnkuZnVsbE5hbWU7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiBfb3duZXIuT1dORVIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHZhciBvd25lciA9IGluc3RhbmNlT3duZXIuZ2V0KHRoaXMpOwoKICAgICAgICBpZiAob3duZXIgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIG93bmVyOwogICAgICAgIH0KCiAgICAgICAgdmFyIGZhY3RvcnkgPSBfY29udGFpbmVyLkZBQ1RPUllfRk9SLmdldCh0aGlzKTsKCiAgICAgICAgcmV0dXJuIGZhY3RvcnkgIT09IHVuZGVmaW5lZCAmJiBmYWN0b3J5Lm93bmVyOwogICAgICB9IC8vIHdlIG5lZWQgYSBzZXR0ZXIgaGVyZSBsYXJnZWx5IHRvIHN1cHBvcnQKICAgICAgLy8gZm9sa3MgY2FsbGluZyBgb3duZXIub3duZXJJbmplY3Rpb24oKWAgQVBJCiAgICAgICwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQodmFsdWUpIHsKICAgICAgICBpbnN0YW5jZU93bmVyLnNldCh0aGlzLCB2YWx1ZSk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBFbWJlck9iamVjdDsKICB9KF9jb3JlX29iamVjdC5kZWZhdWx0KTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IEVtYmVyT2JqZWN0OwogICgwLCBfdXRpbHMuc2V0TmFtZSkoRW1iZXJPYmplY3QsICdFbWJlci5PYmplY3QnKTsKCiAgX29ic2VydmFibGUuZGVmYXVsdC5hcHBseShFbWJlck9iamVjdC5wcm90b3R5cGUpOwoKICB2YXIgRnJhbWV3b3JrT2JqZWN0OwogIF9leHBvcnRzLkZyYW1ld29ya09iamVjdCA9IEZyYW1ld29ya09iamVjdDsKCiAgX2V4cG9ydHMuRnJhbWV3b3JrT2JqZWN0ID0gRnJhbWV3b3JrT2JqZWN0ID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9Db3JlT2JqZWN0MikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKEZyYW1ld29ya09iamVjdCwgX0NvcmVPYmplY3QyKTsKICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoRnJhbWV3b3JrT2JqZWN0LCBbewogICAgICBrZXk6ICJfZGVidWdDb250YWluZXJLZXkiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICB2YXIgZmFjdG9yeSA9IF9jb250YWluZXIuRkFDVE9SWV9GT1IuZ2V0KHRoaXMpOwoKICAgICAgICByZXR1cm4gZmFjdG9yeSAhPT0gdW5kZWZpbmVkICYmIGZhY3RvcnkuZnVsbE5hbWU7CiAgICAgIH0KICAgIH1dKTsKCiAgICBmdW5jdGlvbiBGcmFtZXdvcmtPYmplY3Qob3duZXIpIHsKICAgICAgdmFyIF90aGlzOwoKICAgICAgX3RoaXMgPSBfQ29yZU9iamVjdDIuY2FsbCh0aGlzKSB8fCB0aGlzOwogICAgICAoMCwgX293bmVyLnNldE93bmVyKSgoMCwgX2VtYmVyQmFiZWwuYXNzZXJ0VGhpc0luaXRpYWxpemVkKShfdGhpcyksIG93bmVyKTsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIHJldHVybiBGcmFtZXdvcmtPYmplY3Q7CiAgfShfY29yZV9vYmplY3QuZGVmYXVsdCk7CgogIF9vYnNlcnZhYmxlLmRlZmF1bHQuYXBwbHkoRnJhbWV3b3JrT2JqZWN0LnByb3RvdHlwZSk7CgogIGlmIChmYWxzZQogIC8qIERFQlVHICovCiAgKSB7CiAgICB2YXIgSU5JVF9XQVNfQ0FMTEVEID0gKDAsIF91dGlscy5zeW1ib2wpKCdJTklUX1dBU19DQUxMRUQnKTsKICAgIHZhciBBU1NFUlRfSU5JVF9XQVNfQ0FMTEVEID0gKDAsIF91dGlscy5zeW1ib2wpKCdBU1NFUlRfSU5JVF9XQVNfQ0FMTEVEJyk7CgogICAgX2V4cG9ydHMuRnJhbWV3b3JrT2JqZWN0ID0gRnJhbWV3b3JrT2JqZWN0ID0KICAgIC8qI19fUFVSRV9fKi8KICAgIGZ1bmN0aW9uIChfRW1iZXJPYmplY3QpIHsKICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKERlYnVnRnJhbWV3b3JrT2JqZWN0LCBfRW1iZXJPYmplY3QpOwoKICAgICAgZnVuY3Rpb24gRGVidWdGcmFtZXdvcmtPYmplY3QoKSB7CiAgICAgICAgcmV0dXJuIF9FbWJlck9iamVjdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICAgIH0KCiAgICAgIHZhciBfcHJvdG8gPSBEZWJ1Z0ZyYW1ld29ya09iamVjdC5wcm90b3R5cGU7CgogICAgICBfcHJvdG8uaW5pdCA9IGZ1bmN0aW9uIGluaXQoKSB7CiAgICAgICAgX0VtYmVyT2JqZWN0LnByb3RvdHlwZS5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIHRoaXNbSU5JVF9XQVNfQ0FMTEVEXSA9IHRydWU7CiAgICAgIH07CgogICAgICBfcHJvdG9bQVNTRVJUX0lOSVRfV0FTX0NBTExFRF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgKGZhbHNlICYmICEodGhpc1tJTklUX1dBU19DQUxMRURdKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIllvdSBtdXN0IGNhbGwgYHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7YCB3aGVuIG92ZXJyaWRpbmcgYGluaXRgIG9uIGEgZnJhbWV3b3JrIG9iamVjdC4gUGxlYXNlIHVwZGF0ZSAiICsgdGhpcyArICIgdG8gY2FsbCBgdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTtgIGZyb20gYGluaXRgLiIsIHRoaXNbSU5JVF9XQVNfQ0FMTEVEXSkpOwogICAgICB9OwoKICAgICAgcmV0dXJuIERlYnVnRnJhbWV3b3JrT2JqZWN0OwogICAgfShFbWJlck9iamVjdCk7CgogICAgKDAsIF9tZXRhbC5hZGRMaXN0ZW5lcikoRnJhbWV3b3JrT2JqZWN0LnByb3RvdHlwZSwgJ2luaXQnLCBudWxsLCBBU1NFUlRfSU5JVF9XQVNfQ0FMTEVEKTsKICB9Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUvbGliL3N5c3RlbS9vYmplY3RfcHJveHkiLCBbImV4cG9ydHMiLCAiZW1iZXItYmFiZWwiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvc3lzdGVtL29iamVjdCIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9taXhpbnMvLXByb3h5Il0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2VtYmVyQmFiZWwsIF9vYmplY3QsIF9wcm94eSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgICBgT2JqZWN0UHJveHlgIGZvcndhcmRzIGFsbCBwcm9wZXJ0aWVzIG5vdCBkZWZpbmVkIGJ5IHRoZSBwcm94eSBpdHNlbGYKICAgIHRvIGEgcHJveGllZCBgY29udGVudGAgb2JqZWN0LgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IE9iamVjdFByb3h5IGZyb20gJ0BlbWJlci9vYmplY3QvcHJveHknOwogIAogICAgb2JqZWN0ID0gRW1iZXJPYmplY3QuY3JlYXRlKHsKICAgICAgbmFtZTogJ0ZvbycKICAgIH0pOwogIAogICAgcHJveHkgPSBPYmplY3RQcm94eS5jcmVhdGUoewogICAgICBjb250ZW50OiBvYmplY3QKICAgIH0pOwogIAogICAgLy8gQWNjZXNzIGFuZCBjaGFuZ2UgZXhpc3RpbmcgcHJvcGVydGllcwogICAgcHJveHkuZ2V0KCduYW1lJykgICAgICAgICAgLy8gJ0ZvbycKICAgIHByb3h5LnNldCgnbmFtZScsICdCYXInKTsKICAgIG9iamVjdC5nZXQoJ25hbWUnKSAgICAgICAgIC8vICdCYXInCiAgCiAgICAvLyBDcmVhdGUgbmV3ICdkZXNjcmlwdGlvbicgcHJvcGVydHkgb24gYG9iamVjdGAKICAgIHByb3h5LnNldCgnZGVzY3JpcHRpb24nLCAnRm9vIGlzIGEgd2hpemJvbyBiYXonKTsKICAgIG9iamVjdC5nZXQoJ2Rlc2NyaXB0aW9uJykgIC8vICdGb28gaXMgYSB3aGl6Ym9vIGJheicKICAgIGBgYAogIAogICAgV2hpbGUgYGNvbnRlbnRgIGlzIHVuc2V0LCBzZXR0aW5nIGEgcHJvcGVydHkgdG8gYmUgZGVsZWdhdGVkIHdpbGwgdGhyb3cgYW4KICAgIEVycm9yLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IE9iamVjdFByb3h5IGZyb20gJ0BlbWJlci9vYmplY3QvcHJveHknOwogIAogICAgcHJveHkgPSBPYmplY3RQcm94eS5jcmVhdGUoewogICAgICBjb250ZW50OiBudWxsLAogICAgICBmbGFnOiBudWxsCiAgICB9KTsKICAgIHByb3h5LnNldCgnZmxhZycsIHRydWUpOwogICAgcHJveHkuZ2V0KCdmbGFnJyk7ICAgICAgICAgLy8gdHJ1ZQogICAgcHJveHkuZ2V0KCdmb28nKTsgICAgICAgICAgLy8gdW5kZWZpbmVkCiAgICBwcm94eS5zZXQoJ2ZvbycsICdkYXRhJyk7ICAvLyB0aHJvd3MgRXJyb3IKICAgIGBgYAogIAogICAgRGVsZWdhdGVkIHByb3BlcnRpZXMgY2FuIGJlIGJvdW5kIHRvIGFuZCB3aWxsIGNoYW5nZSB3aGVuIGNvbnRlbnQgaXMgdXBkYXRlZC4KICAKICAgIENvbXB1dGVkIHByb3BlcnRpZXMgb24gdGhlIHByb3h5IGl0c2VsZiBjYW4gZGVwZW5kIG9uIGRlbGVnYXRlZCBwcm9wZXJ0aWVzLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgY29tcHV0ZWQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCBPYmplY3RQcm94eSBmcm9tICdAZW1iZXIvb2JqZWN0L3Byb3h5JzsKICAKICAgIFByb3h5V2l0aENvbXB1dGVkUHJvcGVydHkgPSBPYmplY3RQcm94eS5leHRlbmQoewogICAgICBmdWxsTmFtZTogY29tcHV0ZWQoJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBmaXJzdE5hbWUgPSB0aGlzLmdldCgnZmlyc3ROYW1lJyksCiAgICAgICAgICAgIGxhc3ROYW1lID0gdGhpcy5nZXQoJ2xhc3ROYW1lJyk7CiAgICAgICAgaWYgKGZpcnN0TmFtZSAmJiBsYXN0TmFtZSkgewogICAgICAgICAgcmV0dXJuIGZpcnN0TmFtZSArICcgJyArIGxhc3ROYW1lOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmlyc3ROYW1lIHx8IGxhc3ROYW1lOwogICAgICB9KQogICAgfSk7CiAgCiAgICBwcm94eSA9IFByb3h5V2l0aENvbXB1dGVkUHJvcGVydHkuY3JlYXRlKCk7CiAgCiAgICBwcm94eS5nZXQoJ2Z1bGxOYW1lJyk7ICAvLyB1bmRlZmluZWQKICAgIHByb3h5LnNldCgnY29udGVudCcsIHsKICAgICAgZmlyc3ROYW1lOiAnVG9tJywgbGFzdE5hbWU6ICdEYWxlJwogICAgfSk7IC8vIHRyaWdnZXJzIHByb3BlcnR5IGNoYW5nZSBmb3IgZnVsbE5hbWUgb24gcHJveHkKICAKICAgIHByb3h5LmdldCgnZnVsbE5hbWUnKTsgIC8vICdUb20gRGFsZScKICAgIGBgYAogIAogICAgQGNsYXNzIE9iamVjdFByb3h5CiAgICBAZXh0ZW5kcyBFbWJlck9iamVjdAogICAgQHVzZXMgRW1iZXIuUHJveHlNaXhpbgogICAgQHB1YmxpYwogICovCiAgdmFyIE9iamVjdFByb3h5ID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9GcmFtZXdvcmtPYmplY3QpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShPYmplY3RQcm94eSwgX0ZyYW1ld29ya09iamVjdCk7CgogICAgZnVuY3Rpb24gT2JqZWN0UHJveHkoKSB7CiAgICAgIHJldHVybiBfRnJhbWV3b3JrT2JqZWN0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgIH0KCiAgICByZXR1cm4gT2JqZWN0UHJveHk7CiAgfShfb2JqZWN0LmRlZmF1bHQpOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gT2JqZWN0UHJveHk7CiAgT2JqZWN0UHJveHkuUHJvdG90eXBlTWl4aW4ucmVvcGVuKF9wcm94eS5kZWZhdWx0KTsKfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZS9saWIvdHlwZS1vZiIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lL2xpYi9zeXN0ZW0vY29yZV9vYmplY3QiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfY29yZV9vYmplY3QpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLnR5cGVPZiA9IHR5cGVPZjsKICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgLy8gVFlQSU5HICYgQVJSQVkgTUVTU0FHSU5HCiAgLy8KICB2YXIgVFlQRV9NQVAgPSB7CiAgICAnW29iamVjdCBCb29sZWFuXSc6ICdib29sZWFuJywKICAgICdbb2JqZWN0IE51bWJlcl0nOiAnbnVtYmVyJywKICAgICdbb2JqZWN0IFN0cmluZ10nOiAnc3RyaW5nJywKICAgICdbb2JqZWN0IEZ1bmN0aW9uXSc6ICdmdW5jdGlvbicsCiAgICAnW29iamVjdCBBcnJheV0nOiAnYXJyYXknLAogICAgJ1tvYmplY3QgRGF0ZV0nOiAnZGF0ZScsCiAgICAnW29iamVjdCBSZWdFeHBdJzogJ3JlZ2V4cCcsCiAgICAnW29iamVjdCBPYmplY3RdJzogJ29iamVjdCcsCiAgICAnW29iamVjdCBGaWxlTGlzdF0nOiAnZmlsZWxpc3QnCiAgfTsKICB2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwogIC8qKgogICBAbW9kdWxlIEBlbWJlci91dGlscwogICovCgogIC8qKgogICAgUmV0dXJucyBhIGNvbnNpc3RlbnQgdHlwZSBmb3IgdGhlIHBhc3NlZCBvYmplY3QuCiAgCiAgICBVc2UgdGhpcyBpbnN0ZWFkIG9mIHRoZSBidWlsdC1pbiBgdHlwZW9mYCB0byBnZXQgdGhlIHR5cGUgb2YgYW4gaXRlbS4KICAgIEl0IHdpbGwgcmV0dXJuIHRoZSBzYW1lIHJlc3VsdCBhY3Jvc3MgYWxsIGJyb3dzZXJzIGFuZCBpbmNsdWRlcyBhIGJpdAogICAgbW9yZSBkZXRhaWwuIEhlcmUgaXMgd2hhdCB3aWxsIGJlIHJldHVybmVkOgogIAogICAgICAgIHwgUmV0dXJuIFZhbHVlICB8IE1lYW5pbmcgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgIHwtLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogICAgICAgIHwgJ3N0cmluZycgICAgICB8IFN0cmluZyBwcmltaXRpdmUgb3IgU3RyaW5nIG9iamVjdC4gICAgICAgICAgICAgICAgICAgfAogICAgICAgIHwgJ251bWJlcicgICAgICB8IE51bWJlciBwcmltaXRpdmUgb3IgTnVtYmVyIG9iamVjdC4gICAgICAgICAgICAgICAgICAgfAogICAgICAgIHwgJ2Jvb2xlYW4nICAgICB8IEJvb2xlYW4gcHJpbWl0aXZlIG9yIEJvb2xlYW4gb2JqZWN0LiAgICAgICAgICAgICAgICAgfAogICAgICAgIHwgJ251bGwnICAgICAgICB8IE51bGwgdmFsdWUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgIHwgJ3VuZGVmaW5lZCcgICB8IFVuZGVmaW5lZCB2YWx1ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgIHwgJ2Z1bmN0aW9uJyAgICB8IEEgZnVuY3Rpb24gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgIHwgJ2FycmF5JyAgICAgICB8IEFuIGluc3RhbmNlIG9mIEFycmF5ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgIHwgJ3JlZ2V4cCcgICAgICB8IEFuIGluc3RhbmNlIG9mIFJlZ0V4cCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgIHwgJ2RhdGUnICAgICAgICB8IEFuIGluc3RhbmNlIG9mIERhdGUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgIHwgJ2ZpbGVsaXN0JyAgICB8IEFuIGluc3RhbmNlIG9mIEZpbGVMaXN0ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgIHwgJ2NsYXNzJyAgICAgICB8IEFuIEVtYmVyIGNsYXNzIChjcmVhdGVkIHVzaW5nIEVtYmVyT2JqZWN0LmV4dGVuZCgpKSAgfAogICAgICAgIHwgJ2luc3RhbmNlJyAgICB8IEFuIEVtYmVyIG9iamVjdCBpbnN0YW5jZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgIHwgJ2Vycm9yJyAgICAgICB8IEFuIGluc3RhbmNlIG9mIHRoZSBFcnJvciBvYmplY3QgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgIHwgJ29iamVjdCcgICAgICB8IEEgSmF2YVNjcmlwdCBvYmplY3Qgbm90IGluaGVyaXRpbmcgZnJvbSBFbWJlck9iamVjdCAgfAogIAogICAgRXhhbXBsZXM6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBBIH0gZnJvbSAnQGVtYmVyL2FycmF5JzsKICAgIGltcG9ydCB7IHR5cGVPZiB9IGZyb20gJ0BlbWJlci91dGlscyc7CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICB0eXBlT2YoKTsgICAgICAgICAgICAgICAgICAgICAgIC8vICd1bmRlZmluZWQnCiAgICB0eXBlT2YobnVsbCk7ICAgICAgICAgICAgICAgICAgIC8vICdudWxsJwogICAgdHlwZU9mKHVuZGVmaW5lZCk7ICAgICAgICAgICAgICAvLyAndW5kZWZpbmVkJwogICAgdHlwZU9mKCdtaWNoYWVsJyk7ICAgICAgICAgICAgICAvLyAnc3RyaW5nJwogICAgdHlwZU9mKG5ldyBTdHJpbmcoJ21pY2hhZWwnKSk7ICAvLyAnc3RyaW5nJwogICAgdHlwZU9mKDEwMSk7ICAgICAgICAgICAgICAgICAgICAvLyAnbnVtYmVyJwogICAgdHlwZU9mKG5ldyBOdW1iZXIoMTAxKSk7ICAgICAgICAvLyAnbnVtYmVyJwogICAgdHlwZU9mKHRydWUpOyAgICAgICAgICAgICAgICAgICAvLyAnYm9vbGVhbicKICAgIHR5cGVPZihuZXcgQm9vbGVhbih0cnVlKSk7ICAgICAgLy8gJ2Jvb2xlYW4nCiAgICB0eXBlT2YoQSk7ICAgICAgICAgICAgICAgICAgICAgIC8vICdmdW5jdGlvbicKICAgIHR5cGVPZihbMSwgMiwgOTBdKTsgICAgICAgICAgICAgLy8gJ2FycmF5JwogICAgdHlwZU9mKC9hYmMvKTsgICAgICAgICAgICAgICAgICAvLyAncmVnZXhwJwogICAgdHlwZU9mKG5ldyBEYXRlKCkpOyAgICAgICAgICAgICAvLyAnZGF0ZScKICAgIHR5cGVPZihldmVudC50YXJnZXQuZmlsZXMpOyAgICAgLy8gJ2ZpbGVsaXN0JwogICAgdHlwZU9mKEVtYmVyT2JqZWN0LmV4dGVuZCgpKTsgICAvLyAnY2xhc3MnCiAgICB0eXBlT2YoRW1iZXJPYmplY3QuY3JlYXRlKCkpOyAgIC8vICdpbnN0YW5jZScKICAgIHR5cGVPZihuZXcgRXJyb3IoJ3RlYW1vY2lsJykpOyAgLy8gJ2Vycm9yJwogIAogICAgLy8gJ25vcm1hbCcgSmF2YVNjcmlwdCBvYmplY3QKICAgIHR5cGVPZih7IGE6ICdiJyB9KTsgICAgICAgICAgICAgLy8gJ29iamVjdCcKICAgIGBgYAogIAogICAgQG1ldGhvZCB0eXBlT2YKICAgIEBmb3IgQGVtYmVyL3V0aWxzCiAgICBAcGFyYW0ge09iamVjdH0gaXRlbSB0aGUgaXRlbSB0byBjaGVjawogICAgQHJldHVybiB7U3RyaW5nfSB0aGUgdHlwZQogICAgQHB1YmxpYwogICAgQHN0YXRpYwogICovCgogIGZ1bmN0aW9uIHR5cGVPZihpdGVtKSB7CiAgICBpZiAoaXRlbSA9PT0gbnVsbCkgewogICAgICByZXR1cm4gJ251bGwnOwogICAgfQoKICAgIGlmIChpdGVtID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuICd1bmRlZmluZWQnOwogICAgfQoKICAgIHZhciByZXQgPSBUWVBFX01BUFt0b1N0cmluZy5jYWxsKGl0ZW0pXSB8fCAnb2JqZWN0JzsKCiAgICBpZiAocmV0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGlmIChfY29yZV9vYmplY3QuZGVmYXVsdC5kZXRlY3QoaXRlbSkpIHsKICAgICAgICByZXQgPSAnY2xhc3MnOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHJldCA9PT0gJ29iamVjdCcpIHsKICAgICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgIHJldCA9ICdlcnJvcic7CiAgICAgIH0gZWxzZSBpZiAoaXRlbSBpbnN0YW5jZW9mIF9jb3JlX29iamVjdC5kZWZhdWx0KSB7CiAgICAgICAgcmV0ID0gJ2luc3RhbmNlJzsKICAgICAgfSBlbHNlIGlmIChpdGVtIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgIHJldCA9ICdkYXRlJzsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByZXQ7CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy91dGlscy9pbmRleCIsIFsiZXhwb3J0cyIsICJAZW1iZXIvcG9seWZpbGxzIiwgIkBlbWJlci9kZWJ1ZyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9wb2x5ZmlsbHMsIF9kZWJ1ZykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuc3ltYm9sID0gc3ltYm9sOwogIF9leHBvcnRzLmlzSW50ZXJuYWxTeW1ib2wgPSBpc0ludGVybmFsU3ltYm9sOwogIF9leHBvcnRzLmRpY3Rpb25hcnkgPSBtYWtlRGljdGlvbmFyeTsKICBfZXhwb3J0cy51dWlkID0gdXVpZDsKICBfZXhwb3J0cy5nZW5lcmF0ZUd1aWQgPSBnZW5lcmF0ZUd1aWQ7CiAgX2V4cG9ydHMuZ3VpZEZvciA9IGd1aWRGb3I7CiAgX2V4cG9ydHMuaW50ZXJuID0gaW50ZXJuOwogIF9leHBvcnRzLndyYXAgPSB3cmFwOwogIF9leHBvcnRzLmdldE9ic2VydmVycyA9IGdldE9ic2VydmVyczsKICBfZXhwb3J0cy5nZXRMaXN0ZW5lcnMgPSBnZXRMaXN0ZW5lcnM7CiAgX2V4cG9ydHMuc2V0T2JzZXJ2ZXJzID0gc2V0T2JzZXJ2ZXJzOwogIF9leHBvcnRzLnNldExpc3RlbmVycyA9IHNldExpc3RlbmVyczsKICBfZXhwb3J0cy5pbnNwZWN0ID0gaW5zcGVjdDsKICBfZXhwb3J0cy5sb29rdXBEZXNjcmlwdG9yID0gbG9va3VwRGVzY3JpcHRvcjsKICBfZXhwb3J0cy5jYW5JbnZva2UgPSBjYW5JbnZva2U7CiAgX2V4cG9ydHMudHJ5SW52b2tlID0gdHJ5SW52b2tlOwogIF9leHBvcnRzLm1ha2VBcnJheSA9IG1ha2VBcnJheTsKICBfZXhwb3J0cy5nZXROYW1lID0gZ2V0TmFtZTsKICBfZXhwb3J0cy5zZXROYW1lID0gc2V0TmFtZTsKICBfZXhwb3J0cy50b1N0cmluZyA9IHRvU3RyaW5nOwogIF9leHBvcnRzLmlzUHJveHkgPSBpc1Byb3h5OwogIF9leHBvcnRzLnNldFByb3h5ID0gc2V0UHJveHk7CiAgX2V4cG9ydHMuaXNFbWJlckFycmF5ID0gaXNFbWJlckFycmF5OwogIF9leHBvcnRzLnNldFdpdGhNYW5kYXRvcnlTZXR0ZXIgPSBfZXhwb3J0cy50ZWFyZG93bk1hbmRhdG9yeVNldHRlciA9IF9leHBvcnRzLnNldHVwTWFuZGF0b3J5U2V0dGVyID0gX2V4cG9ydHMuRU1CRVJfQVJSQVkgPSBfZXhwb3J0cy5DYWNoZSA9IF9leHBvcnRzLkhBU19OQVRJVkVfUFJPWFkgPSBfZXhwb3J0cy5IQVNfTkFUSVZFX1NZTUJPTCA9IF9leHBvcnRzLlJPT1QgPSBfZXhwb3J0cy5jaGVja0hhc1N1cGVyID0gX2V4cG9ydHMuR1VJRF9LRVkgPSBfZXhwb3J0cy5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID0gdm9pZCAwOwoKICAvKioKICAgIFN0cm9uZ2x5IGhpbnQgcnVudGltZXMgdG8gaW50ZXJuIHRoZSBwcm92aWRlZCBzdHJpbmcuCiAgCiAgICBXaGVuIGRvIEkgbmVlZCB0byB1c2UgdGhpcyBmdW5jdGlvbj8KICAKICAgIEZvciB0aGUgbW9zdCBwYXJ0LCBuZXZlci4gUHJlLW1hdHVyZSBvcHRpbWl6YXRpb24gaXMgYmFkLCBhbmQgb2Z0ZW4gdGhlCiAgICBydW50aW1lIGRvZXMgZXhhY3RseSB3aGF0IHlvdSBuZWVkIGl0IHRvLCBhbmQgbW9yZSBvZnRlbiB0aGUgdHJhZGUtb2ZmIGlzbid0CiAgICB3b3J0aCBpdC4KICAKICAgIFdoeT8KICAKICAgIFJ1bnRpbWVzIHN0b3JlIHN0cmluZ3MgaW4gYXQgbGVhc3QgMiBkaWZmZXJlbnQgcmVwcmVzZW50YXRpb25zOgogICAgUm9wZXMgYW5kIFN5bWJvbHMgKGludGVybmVkIHN0cmluZ3MpLiBUaGUgUm9wZSBwcm92aWRlcyBhIG1lbW9yeSBlZmZpY2llbnQKICAgIGRhdGEtc3RydWN0dXJlIGZvciBzdHJpbmdzIGNyZWF0ZWQgZnJvbSBjb25jYXRlbmF0aW9uIG9yIHNvbWUgb3RoZXIgc3RyaW5nCiAgICBtYW5pcHVsYXRpb24gbGlrZSBzcGxpdHRpbmcuCiAgCiAgICBVbmZvcnR1bmF0ZWx5IGNoZWNraW5nIGVxdWFsaXR5IG9mIGRpZmZlcmVudCByb3BlcyBjYW4gYmUgcXVpdGUgY29zdGx5IGFzCiAgICBydW50aW1lcyBtdXN0IHJlc29ydCB0byBjbGV2ZXIgc3RyaW5nIGNvbXBhcmlzb24gYWxnb3JpdGhtcy4gVGhlc2UKICAgIGFsZ29yaXRobXMgdHlwaWNhbGx5IGNvc3QgaW4gcHJvcG9ydGlvbiB0byB0aGUgbGVuZ3RoIG9mIHRoZSBzdHJpbmcuCiAgICBMdWNraWx5LCB0aGlzIGlzIHdoZXJlIHRoZSBTeW1ib2xzIChpbnRlcm5lZCBzdHJpbmdzKSBzaGluZS4gQXMgU3ltYm9scyBhcmUKICAgIHVuaXF1ZSBieSB0aGVpciBzdHJpbmcgY29udGVudCwgZXF1YWxpdHkgY2hlY2tzIGNhbiBiZSBkb25lIGJ5IHBvaW50ZXIKICAgIGNvbXBhcmlzb24uCiAgCiAgICBIb3cgZG8gSSBrbm93IGlmIG15IHN0cmluZyBpcyBhIHJvcGUgb3Igc3ltYm9sPwogIAogICAgVHlwaWNhbGx5ICh3YXJuaW5nIGdlbmVyYWwgc3dlZXBpbmcgc3RhdGVtZW50LCBidXQgdHJ1dGh5IGluIHJ1bnRpbWVzIGF0CiAgICBwcmVzZW50KSBzdGF0aWMgc3RyaW5ncyBjcmVhdGVkIGFzIHBhcnQgb2YgdGhlIEpTIHNvdXJjZSBhcmUgaW50ZXJuZWQuCiAgICBTdHJpbmdzIG9mdGVuIHVzZWQgZm9yIGNvbXBhcmlzb25zIGNhbiBiZSBpbnRlcm5lZCBhdCBydW50aW1lIGlmIHNvbWUKICAgIGNyaXRlcmlhIGFyZSBtZXQuICBPbmUgb2YgdGhlc2UgY3JpdGVyaWEgY2FuIGJlIHRoZSBzaXplIG9mIHRoZSBlbnRpcmUgcm9wZS4KICAgIEZvciBleGFtcGxlLCBpbiBjaHJvbWUgMzggYSByb3BlIGxvbmdlciB0aGVuIDEyIGNoYXJhY3RlcnMgd2lsbCBub3QKICAgIGludGVybiwgbm9yIHdpbGwgc2VnbWVudHMgb2YgdGhhdCByb3BlLgogIAogICAgU29tZSBudW1iZXJzOiBodHRwOi8vanNwZXJmLmNvbS9ldmFsLXZzLWtleXMvOAogIAogICAgS25vd24gVHJpY2vihKIKICAKICAgIEBwcml2YXRlCiAgICBAcmV0dXJuIHtTdHJpbmd9IGludGVybmVkIHZlcnNpb24gb2YgdGhlIHByb3ZpZGVkIHN0cmluZwogICovCiAgZnVuY3Rpb24gaW50ZXJuKHN0cikgewogICAgdmFyIG9iaiA9IHt9OwogICAgb2JqW3N0cl0gPSAxOwoKICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgaWYgKGtleSA9PT0gc3RyKSB7CiAgICAgICAgcmV0dXJuIGtleTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBzdHI7CiAgfQogIC8qKgogICAgUmV0dXJucyB3aGV0aGVyIFR5cGUodmFsdWUpIGlzIE9iamVjdC4KICAKICAgIFVzZWZ1bCBmb3IgY2hlY2tpbmcgd2hldGhlciBhIHZhbHVlIGlzIGEgdmFsaWQgV2Vha01hcCBrZXkuCiAgCiAgICBSZWZzOiBodHRwczovL3RjMzkuZ2l0aHViLmlvL2VjbWEyNjIvI3NlYy10eXBlb2Ytb3BlcmF0b3ItcnVudGltZS1zZW1hbnRpY3MtZXZhbHVhdGlvbgogICAgICAgICAgaHR0cHM6Ly90YzM5LmdpdGh1Yi5pby9lY21hMjYyLyNzZWMtd2Vha21hcC5wcm90b3R5cGUuc2V0CiAgCiAgICBAcHJpdmF0ZQogICAgQGZ1bmN0aW9uIGlzT2JqZWN0CiAgKi8KCgogIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nKTsKICB9CiAgLyoqCiAgIEBtb2R1bGUgQGVtYmVyL29iamVjdAogICovCgogIC8qKgogICBQcmV2aW91c2x5IHdlIHVzZWQgYEVtYmVyLiQudXVpZGAsIGhvd2V2ZXIgYCQudXVpZGAgaGFzIGJlZW4gcmVtb3ZlZCBmcm9tCiAgIGpRdWVyeSBtYXN0ZXIuIFdlJ2xsIGp1c3QgYm9vdHN0cmFwIG91ciBvd24gdXVpZCBub3cuCiAgCiAgIEBwcml2YXRlCiAgIEByZXR1cm4ge051bWJlcn0gdGhlIHV1aWQKICAgKi8KCgogIHZhciBfdXVpZCA9IDA7CiAgLyoqCiAgIEdlbmVyYXRlcyBhIHVuaXZlcnNhbGx5IHVuaXF1ZSBpZGVudGlmaWVyLiBUaGlzIG1ldGhvZAogICBpcyB1c2VkIGludGVybmFsbHkgYnkgRW1iZXIgZm9yIGFzc2lzdGluZyB3aXRoCiAgIHRoZSBnZW5lcmF0aW9uIG9mIEdVSUQncyBhbmQgb3RoZXIgdW5pcXVlIGlkZW50aWZpZXJzLgogIAogICBAcHVibGljCiAgIEByZXR1cm4ge051bWJlcn0gW2Rlc2NyaXB0aW9uXQogICAqLwoKICBmdW5jdGlvbiB1dWlkKCkgewogICAgcmV0dXJuICsrX3V1aWQ7CiAgfQogIC8qKgogICBQcmVmaXggdXNlZCBmb3IgZ3VpZHMgdGhyb3VnaCBvdXQgRW1iZXIuCiAgIEBwcml2YXRlCiAgIEBwcm9wZXJ0eSBHVUlEX1BSRUZJWAogICBAZm9yIEVtYmVyCiAgIEB0eXBlIFN0cmluZwogICBAZmluYWwKICAgKi8KCgogIHZhciBHVUlEX1BSRUZJWCA9ICdlbWJlcic7IC8vIFVzZWQgZm9yIGd1aWQgZ2VuZXJhdGlvbi4uLgoKICB2YXIgT0JKRUNUX0dVSURTID0gbmV3IFdlYWtNYXAoKTsKICB2YXIgTk9OX09CSkVDVF9HVUlEUyA9IG5ldyBNYXAoKTsKICAvKioKICAgIEEgdW5pcXVlIGtleSB1c2VkIHRvIGFzc2lnbiBndWlkcyBhbmQgb3RoZXIgcHJpdmF0ZSBtZXRhZGF0YSB0byBvYmplY3RzLgogICAgSWYgeW91IGluc3BlY3QgYW4gb2JqZWN0IGluIHlvdXIgYnJvd3NlciBkZWJ1Z2dlciB5b3Ugd2lsbCBvZnRlbiBzZWUgdGhlc2UuCiAgICBUaGV5IGNhbiBiZSBzYWZlbHkgaWdub3JlZC4KICAKICAgIE9uIGJyb3dzZXJzIHRoYXQgc3VwcG9ydCBpdCwgdGhlc2UgcHJvcGVydGllcyBhcmUgYWRkZWQgd2l0aCBlbnVtZXJhdGlvbgogICAgZGlzYWJsZWQgc28gdGhleSB3b24ndCBzaG93IHVwIHdoZW4geW91IGl0ZXJhdGUgb3ZlciB5b3VyIHByb3BlcnRpZXMuCiAgCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IEdVSURfS0VZCiAgICBAZm9yIEVtYmVyCiAgICBAdHlwZSBTdHJpbmcKICAgIEBmaW5hbAogICovCgogIHZhciBHVUlEX0tFWSA9IGludGVybigiX19lbWJlciIgKyBEYXRlLm5vdygpKTsKICAvKioKICAgIEdlbmVyYXRlcyBhIG5ldyBndWlkLCBvcHRpb25hbGx5IHNhdmluZyB0aGUgZ3VpZCB0byB0aGUgb2JqZWN0IHRoYXQgeW91CiAgICBwYXNzIGluLiBZb3Ugd2lsbCByYXJlbHkgbmVlZCB0byB1c2UgdGhpcyBtZXRob2QuIEluc3RlYWQgeW91IHNob3VsZAogICAgY2FsbCBgZ3VpZEZvcihvYmopYCwgd2hpY2ggcmV0dXJuIGFuIGV4aXN0aW5nIGd1aWQgaWYgYXZhaWxhYmxlLgogIAogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZ2VuZXJhdGVHdWlkCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QvaW50ZXJuYWxzCiAgICBAcGFyYW0ge09iamVjdH0gW29ial0gT2JqZWN0IHRoZSBndWlkIHdpbGwgYmUgdXNlZCBmb3IuIElmIHBhc3NlZCBpbiwgdGhlIGd1aWQgd2lsbAogICAgICBiZSBzYXZlZCBvbiB0aGUgb2JqZWN0IGFuZCByZXVzZWQgd2hlbmV2ZXIgeW91IHBhc3MgdGhlIHNhbWUgb2JqZWN0CiAgICAgIGFnYWluLgogIAogICAgICBJZiBubyBvYmplY3QgaXMgcGFzc2VkLCBqdXN0IGdlbmVyYXRlIGEgbmV3IGd1aWQuCiAgICBAcGFyYW0ge1N0cmluZ30gW3ByZWZpeF0gUHJlZml4IHRvIHBsYWNlIGluIGZyb250IG9mIHRoZSBndWlkLiBVc2VmdWwgd2hlbiB5b3Ugd2FudCB0bwogICAgICBzZXBhcmF0ZSB0aGUgZ3VpZCBpbnRvIHNlcGFyYXRlIG5hbWVzcGFjZXMuCiAgICBAcmV0dXJuIHtTdHJpbmd9IHRoZSBndWlkCiAgKi8KCiAgX2V4cG9ydHMuR1VJRF9LRVkgPSBHVUlEX0tFWTsKCiAgZnVuY3Rpb24gZ2VuZXJhdGVHdWlkKG9iaiwgcHJlZml4KSB7CiAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgcHJlZml4ID0gR1VJRF9QUkVGSVg7CiAgICB9CgogICAgdmFyIGd1aWQgPSBwcmVmaXggKyB1dWlkKCk7CgogICAgaWYgKGlzT2JqZWN0KG9iaikpIHsKICAgICAgT0JKRUNUX0dVSURTLnNldChvYmosIGd1aWQpOwogICAgfQoKICAgIHJldHVybiBndWlkOwogIH0KICAvKioKICAgIFJldHVybnMgYSB1bmlxdWUgaWQgZm9yIHRoZSBvYmplY3QuIElmIHRoZSBvYmplY3QgZG9lcyBub3QgeWV0IGhhdmUgYSBndWlkLAogICAgb25lIHdpbGwgYmUgYXNzaWduZWQgdG8gaXQuIFlvdSBjYW4gY2FsbCB0aGlzIG9uIGFueSBvYmplY3QsCiAgICBgRW1iZXJPYmplY3RgLWJhc2VkIG9yIG5vdC4KICAKICAgIFlvdSBjYW4gYWxzbyB1c2UgdGhpcyBtZXRob2Qgb24gRE9NIEVsZW1lbnQgb2JqZWN0cy4KICAKICAgIEBwdWJsaWMKICAgIEBzdGF0aWMKICAgIEBtZXRob2QgZ3VpZEZvcgogICAgQGZvciBAZW1iZXIvb2JqZWN0L2ludGVybmFscwogICAgQHBhcmFtIHtPYmplY3R9IG9iaiBhbnkgb2JqZWN0LCBzdHJpbmcsIG51bWJlciwgRWxlbWVudCwgb3IgcHJpbWl0aXZlCiAgICBAcmV0dXJuIHtTdHJpbmd9IHRoZSB1bmlxdWUgZ3VpZCBmb3IgdGhpcyBpbnN0YW5jZS4KICAqLwoKCiAgZnVuY3Rpb24gZ3VpZEZvcih2YWx1ZSkgewogICAgdmFyIGd1aWQ7CgogICAgaWYgKGlzT2JqZWN0KHZhbHVlKSkgewogICAgICBndWlkID0gT0JKRUNUX0dVSURTLmdldCh2YWx1ZSk7CgogICAgICBpZiAoZ3VpZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgZ3VpZCA9IEdVSURfUFJFRklYICsgdXVpZCgpOwogICAgICAgIE9CSkVDVF9HVUlEUy5zZXQodmFsdWUsIGd1aWQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBndWlkID0gTk9OX09CSkVDVF9HVUlEUy5nZXQodmFsdWUpOwoKICAgICAgaWYgKGd1aWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhciB0eXBlID0gdHlwZW9mIHZhbHVlOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGd1aWQgPSAnc3QnICsgdXVpZCgpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIGd1aWQgPSAnbnUnICsgdXVpZCgpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3N5bWJvbCcpIHsKICAgICAgICAgIGd1aWQgPSAnc3knICsgdXVpZCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBndWlkID0gJygnICsgdmFsdWUgKyAnKSc7CiAgICAgICAgfQoKICAgICAgICBOT05fT0JKRUNUX0dVSURTLnNldCh2YWx1ZSwgZ3VpZCk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZ3VpZDsKICB9CgogIHZhciBHRU5FUkFURURfU1lNQk9MUyA9IFtdOwoKICBmdW5jdGlvbiBpc0ludGVybmFsU3ltYm9sKHBvc3NpYmxlU3ltYm9sKSB7CiAgICByZXR1cm4gR0VORVJBVEVEX1NZTUJPTFMuaW5kZXhPZihwb3NzaWJsZVN5bWJvbCkgIT09IC0xOwogIH0KCiAgZnVuY3Rpb24gc3ltYm9sKGRlYnVnTmFtZSkgewogICAgLy8gVE9ETzogSW52ZXN0aWdhdGUgdXNpbmcgcGxhdGZvcm0gc3ltYm9scywgYnV0IHdlIGRvIG5vdAogICAgLy8gd2FudCB0byByZXF1aXJlIG5vbi1lbnVtZXJhYmlsaXR5IGZvciB0aGlzIEFQSSwgd2hpY2gKICAgIC8vIHdvdWxkIGludHJvZHVjZSBhIGxhcmdlIGNvc3QuCiAgICB2YXIgaWQgPSBHVUlEX0tFWSArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIERhdGUubm93KCkpOwogICAgdmFyIHN5bWJvbCA9IGludGVybigiX18iICsgZGVidWdOYW1lICsgaWQgKyAiX18iKTsKICAgIEdFTkVSQVRFRF9TWU1CT0xTLnB1c2goc3ltYm9sKTsKICAgIHJldHVybiBzeW1ib2w7CiAgfSAvLyB0aGUgZGVsZXRlIGlzIG1lYW50IHRvIGhpbnQgYXQgcnVudGltZXMgdGhhdCB0aGlzIG9iamVjdCBzaG91bGQgcmVtYWluIGluCiAgLy8gZGljdGlvbmFyeSBtb2RlLiBUaGlzIGlzIGNsZWFybHkgYSBydW50aW1lIHNwZWNpZmljIGhhY2ssIGJ1dCBjdXJyZW50bHkgaXQKICAvLyBhcHBlYXJzIHdvcnRod2hpbGUgaW4gc29tZSB1c2VjYXNlcy4gUGxlYXNlIG5vdGUsIHRoZXNlIGRlbGV0ZXMgZG8gaW5jcmVhc2UKICAvLyB0aGUgY29zdCBvZiBjcmVhdGlvbiBkcmFtYXRpY2FsbHkgb3ZlciBhIHBsYWluIE9iamVjdC5jcmVhdGUuIEFuZCBhcyB0aGlzCiAgLy8gb25seSBtYWtlcyBzZW5zZSBmb3IgbG9uZy1saXZlZCBkaWN0aW9uYXJpZXMgdGhhdCBhcmVuJ3QgaW5zdGFudGlhdGVkIG9mdGVuLgoKCiAgZnVuY3Rpb24gbWFrZURpY3Rpb25hcnkocGFyZW50KSB7CiAgICB2YXIgZGljdCA9IE9iamVjdC5jcmVhdGUocGFyZW50KTsKICAgIGRpY3RbJ19kaWN0J10gPSBudWxsOwogICAgZGVsZXRlIGRpY3RbJ19kaWN0J107CiAgICByZXR1cm4gZGljdDsKICB9CgogIHZhciBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzOwoKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgIT09IHVuZGVmaW5lZCkgewogICAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzOwogIH0gZWxzZSB7CiAgICBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID0gZnVuY3Rpb24gZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhvYmopIHsKICAgICAgdmFyIGRlc2NyaXB0b3JzID0ge307CiAgICAgIE9iamVjdC5rZXlzKG9iaikuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgZGVzY3JpcHRvcnNba2V5XSA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGRlc2NyaXB0b3JzOwogICAgfTsKICB9CgogIHZhciBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzJDEgPSBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzOwogIF9leHBvcnRzLmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPSBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzJDE7CiAgdmFyIEhBU19TVVBFUl9QQVRURVJOID0gL1wuKF9zdXBlcnxjYWxsXCh0aGlzfGFwcGx5XCh0aGlzKS87CiAgdmFyIGZuVG9TdHJpbmcgPSBGdW5jdGlvbi5wcm90b3R5cGUudG9TdHJpbmc7CgogIHZhciBjaGVja0hhc1N1cGVyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNvdXJjZUF2YWlsYWJsZSA9IGZuVG9TdHJpbmcuY2FsbChmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSkuaW5kZXhPZigncmV0dXJuIHRoaXMnKSA+IC0xOwoKICAgIGlmIChzb3VyY2VBdmFpbGFibGUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIGNoZWNrSGFzU3VwZXIoZnVuYykgewogICAgICAgIHJldHVybiBIQVNfU1VQRVJfUEFUVEVSTi50ZXN0KGZuVG9TdHJpbmcuY2FsbChmdW5jKSk7CiAgICAgIH07CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uIGNoZWNrSGFzU3VwZXIoKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfTsKICB9KCk7CgogIF9leHBvcnRzLmNoZWNrSGFzU3VwZXIgPSBjaGVja0hhc1N1cGVyOwogIHZhciBIQVNfU1VQRVJfTUFQID0gbmV3IFdlYWtNYXAoKTsKICB2YXIgUk9PVCA9IE9iamVjdC5mcmVlemUoZnVuY3Rpb24gKCkge30pOwogIF9leHBvcnRzLlJPT1QgPSBST09UOwogIEhBU19TVVBFUl9NQVAuc2V0KFJPT1QsIGZhbHNlKTsKCiAgZnVuY3Rpb24gaGFzU3VwZXIoZnVuYykgewogICAgdmFyIGhhc1N1cGVyID0gSEFTX1NVUEVSX01BUC5nZXQoZnVuYyk7CgogICAgaWYgKGhhc1N1cGVyID09PSB1bmRlZmluZWQpIHsKICAgICAgaGFzU3VwZXIgPSBjaGVja0hhc1N1cGVyKGZ1bmMpOwogICAgICBIQVNfU1VQRVJfTUFQLnNldChmdW5jLCBoYXNTdXBlcik7CiAgICB9CgogICAgcmV0dXJuIGhhc1N1cGVyOwogIH0KCiAgdmFyIE9CU0VSVkVSU19NQVAgPSBuZXcgV2Vha01hcCgpOwoKICBmdW5jdGlvbiBzZXRPYnNlcnZlcnMoZnVuYywgb2JzZXJ2ZXJzKSB7CiAgICBPQlNFUlZFUlNfTUFQLnNldChmdW5jLCBvYnNlcnZlcnMpOwogIH0KCiAgZnVuY3Rpb24gZ2V0T2JzZXJ2ZXJzKGZ1bmMpIHsKICAgIHJldHVybiBPQlNFUlZFUlNfTUFQLmdldChmdW5jKTsKICB9CgogIHZhciBMSVNURU5FUlNfTUFQID0gbmV3IFdlYWtNYXAoKTsKCiAgZnVuY3Rpb24gc2V0TGlzdGVuZXJzKGZ1bmMsIGxpc3RlbmVycykgewogICAgaWYgKGxpc3RlbmVycykgewogICAgICBMSVNURU5FUlNfTUFQLnNldChmdW5jLCBsaXN0ZW5lcnMpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2V0TGlzdGVuZXJzKGZ1bmMpIHsKICAgIHJldHVybiBMSVNURU5FUlNfTUFQLmdldChmdW5jKTsKICB9CgogIHZhciBJU19XUkFQUEVEX0ZVTkNUSU9OX1NFVCA9IG5ldyBfcG9seWZpbGxzLl9XZWFrU2V0KCk7CiAgLyoqCiAgICBXcmFwcyB0aGUgcGFzc2VkIGZ1bmN0aW9uIHNvIHRoYXQgYHRoaXMuX3N1cGVyYCB3aWxsIHBvaW50IHRvIHRoZSBzdXBlckZ1bmMKICAgIHdoZW4gdGhlIGZ1bmN0aW9uIGlzIGludm9rZWQuIFRoaXMgaXMgdGhlIHByaW1pdGl2ZSB3ZSB1c2UgdG8gaW1wbGVtZW50CiAgICBjYWxscyB0byBzdXBlci4KICAKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIHdyYXAKICAgIEBmb3IgRW1iZXIKICAgIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGNhbGwKICAgIEBwYXJhbSB7RnVuY3Rpb259IHN1cGVyRnVuYyBUaGUgc3VwZXIgZnVuY3Rpb24uCiAgICBAcmV0dXJuIHtGdW5jdGlvbn0gd3JhcHBlZCBmdW5jdGlvbi4KICAqLwoKICBmdW5jdGlvbiB3cmFwKGZ1bmMsIHN1cGVyRnVuYykgewogICAgaWYgKCFoYXNTdXBlcihmdW5jKSkgewogICAgICByZXR1cm4gZnVuYzsKICAgIH0gLy8gZW5zdXJlIGFuIHVud3JhcHBlZCBzdXBlciB0aGF0IGNhbGxzIF9zdXBlciBpcyB3cmFwcGVkIHdpdGggYSB0ZXJtaW5hbCBfc3VwZXIKCgogICAgaWYgKCFJU19XUkFQUEVEX0ZVTkNUSU9OX1NFVC5oYXMoc3VwZXJGdW5jKSAmJiBoYXNTdXBlcihzdXBlckZ1bmMpKSB7CiAgICAgIHJldHVybiBfd3JhcChmdW5jLCBfd3JhcChzdXBlckZ1bmMsIFJPT1QpKTsKICAgIH0KCiAgICByZXR1cm4gX3dyYXAoZnVuYywgc3VwZXJGdW5jKTsKICB9CgogIGZ1bmN0aW9uIF93cmFwKGZ1bmMsIHN1cGVyRnVuYykgewogICAgZnVuY3Rpb24gc3VwZXJXcmFwcGVyKCkgewogICAgICB2YXIgb3JpZyA9IHRoaXMuX3N1cGVyOwogICAgICB0aGlzLl9zdXBlciA9IHN1cGVyRnVuYzsKICAgICAgdmFyIHJldCA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgdGhpcy5fc3VwZXIgPSBvcmlnOwogICAgICByZXR1cm4gcmV0OwogICAgfQoKICAgIElTX1dSQVBQRURfRlVOQ1RJT05fU0VULmFkZChzdXBlcldyYXBwZXIpOwogICAgc2V0T2JzZXJ2ZXJzKHN1cGVyV3JhcHBlciwgZ2V0T2JzZXJ2ZXJzKGZ1bmMpKTsKICAgIHNldExpc3RlbmVycyhzdXBlcldyYXBwZXIsIGdldExpc3RlbmVycyhmdW5jKSk7CiAgICByZXR1cm4gc3VwZXJXcmFwcGVyOwogIH0KCiAgdmFyIG9iamVjdFRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKICB2YXIgZnVuY3Rpb25Ub1N0cmluZyA9IEZ1bmN0aW9uLnByb3RvdHlwZS50b1N0cmluZzsKICB2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXk7CiAgdmFyIG9iamVjdEtleXMgPSBPYmplY3Qua2V5czsKICB2YXIgc3RyaW5naWZ5ID0gSlNPTi5zdHJpbmdpZnk7CiAgdmFyIExJU1RfTElNSVQgPSAxMDA7CiAgdmFyIERFUFRIX0xJTUlUID0gNDsKICB2YXIgU0FGRV9LRVkgPSAvXltcdyRdKyQvOwogIC8qKgogICBAbW9kdWxlIEBlbWJlci9kZWJ1ZwogICovCgogIC8qKgogICAgQ29udmVuaWVuY2UgbWV0aG9kIHRvIGluc3BlY3QgYW4gb2JqZWN0LiBUaGlzIG1ldGhvZCB3aWxsIGF0dGVtcHQgdG8KICAgIGNvbnZlcnQgdGhlIG9iamVjdCBpbnRvIGEgdXNlZnVsIHN0cmluZyBkZXNjcmlwdGlvbi4KICAKICAgIEl0IGlzIGEgcHJldHR5IHNpbXBsZSBpbXBsZW1lbnRhdGlvbi4gSWYgeW91IHdhbnQgc29tZXRoaW5nIG1vcmUgcm9idXN0LAogICAgdXNlIHNvbWV0aGluZyBsaWtlIEpTRHVtcDogaHR0cHM6Ly9naXRodWIuY29tL05WL2pzRHVtcAogIAogICAgQG1ldGhvZCBpbnNwZWN0CiAgICBAc3RhdGljCiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgeW91IHdhbnQgdG8gaW5zcGVjdC4KICAgIEByZXR1cm4ge1N0cmluZ30gQSBkZXNjcmlwdGlvbiBvZiB0aGUgb2JqZWN0CiAgICBAc2luY2UgMS40LjAKICAgIEBwcml2YXRlCiAgKi8KCiAgZnVuY3Rpb24gaW5zcGVjdChvYmopIHsKICAgIC8vIGRldGVjdCBOb2RlIHV0aWwuaW5zcGVjdCBjYWxsIGluc3BlY3QoZGVwdGg6IG51bWJlciwgb3B0czogb2JqZWN0KQogICAgaWYgKHR5cGVvZiBvYmogPT09ICdudW1iZXInICYmIGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgcmV0dXJuIGluc3BlY3RWYWx1ZShvYmosIDApOwogIH0KCiAgZnVuY3Rpb24gaW5zcGVjdFZhbHVlKHZhbHVlLCBkZXB0aCwgc2VlbikgewogICAgdmFyIHZhbHVlSXNBcnJheSA9IGZhbHNlOwoKICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgIGNhc2UgJ3VuZGVmaW5lZCc6CiAgICAgICAgcmV0dXJuICd1bmRlZmluZWQnOwoKICAgICAgY2FzZSAnb2JqZWN0JzoKICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHJldHVybiAnbnVsbCc7CgogICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgdmFsdWVJc0FycmF5ID0gdHJ1ZTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0gLy8gaXMgdG9TdHJpbmcgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZyBvciB1bmRlZmluZWQgdGhlbiB0cmF2ZXJzZQoKCiAgICAgICAgaWYgKHZhbHVlLnRvU3RyaW5nID09PSBvYmplY3RUb1N0cmluZyB8fCB2YWx1ZS50b1N0cmluZyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9IC8vIGN1c3RvbSB0b1N0cmluZwoKCiAgICAgICAgcmV0dXJuIHZhbHVlLnRvU3RyaW5nKCk7CgogICAgICBjYXNlICdmdW5jdGlvbic6CiAgICAgICAgcmV0dXJuIHZhbHVlLnRvU3RyaW5nID09PSBmdW5jdGlvblRvU3RyaW5nID8gdmFsdWUubmFtZSA/ICJbRnVuY3Rpb246IiArIHZhbHVlLm5hbWUgKyAiXSIgOiAiW0Z1bmN0aW9uXSIgOiB2YWx1ZS50b1N0cmluZygpOwoKICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICByZXR1cm4gc3RyaW5naWZ5KHZhbHVlKTsKCiAgICAgIGNhc2UgJ3N5bWJvbCc6CiAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICBjYXNlICdudW1iZXInOgogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiB2YWx1ZS50b1N0cmluZygpOwogICAgfQoKICAgIGlmIChzZWVuID09PSB1bmRlZmluZWQpIHsKICAgICAgc2VlbiA9IG5ldyBfcG9seWZpbGxzLl9XZWFrU2V0KCk7CiAgICB9IGVsc2UgewogICAgICBpZiAoc2Vlbi5oYXModmFsdWUpKSByZXR1cm4gIltDaXJjdWxhcl0iOwogICAgfQoKICAgIHNlZW4uYWRkKHZhbHVlKTsKICAgIHJldHVybiB2YWx1ZUlzQXJyYXkgPyBpbnNwZWN0QXJyYXkodmFsdWUsIGRlcHRoICsgMSwgc2VlbikgOiBpbnNwZWN0T2JqZWN0KHZhbHVlLCBkZXB0aCArIDEsIHNlZW4pOwogIH0KCiAgZnVuY3Rpb24gaW5zcGVjdEtleShrZXkpIHsKICAgIHJldHVybiBTQUZFX0tFWS50ZXN0KGtleSkgPyBrZXkgOiBzdHJpbmdpZnkoa2V5KTsKICB9CgogIGZ1bmN0aW9uIGluc3BlY3RPYmplY3Qob2JqLCBkZXB0aCwgc2VlbikgewogICAgaWYgKGRlcHRoID4gREVQVEhfTElNSVQpIHsKICAgICAgcmV0dXJuICdbT2JqZWN0XSc7CiAgICB9CgogICAgdmFyIHMgPSAneyc7CiAgICB2YXIga2V5cyA9IG9iamVjdEtleXMob2JqKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgcyArPSBpID09PSAwID8gJyAnIDogJywgJzsKCiAgICAgIGlmIChpID49IExJU1RfTElNSVQpIHsKICAgICAgICBzICs9ICIuLi4gIiArIChrZXlzLmxlbmd0aCAtIExJU1RfTElNSVQpICsgIiBtb3JlIGtleXMiOwogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgcyArPSBpbnNwZWN0S2V5KGtleSkgKyAnOiAnICsgaW5zcGVjdFZhbHVlKG9ialtrZXldLCBkZXB0aCwgc2Vlbik7CiAgICB9CgogICAgcyArPSAnIH0nOwogICAgcmV0dXJuIHM7CiAgfQoKICBmdW5jdGlvbiBpbnNwZWN0QXJyYXkoYXJyLCBkZXB0aCwgc2VlbikgewogICAgaWYgKGRlcHRoID4gREVQVEhfTElNSVQpIHsKICAgICAgcmV0dXJuICdbQXJyYXldJzsKICAgIH0KCiAgICB2YXIgcyA9ICdbJzsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewogICAgICBzICs9IGkgPT09IDAgPyAnICcgOiAnLCAnOwoKICAgICAgaWYgKGkgPj0gTElTVF9MSU1JVCkgewogICAgICAgIHMgKz0gIi4uLiAiICsgKGFyci5sZW5ndGggLSBMSVNUX0xJTUlUKSArICIgbW9yZSBpdGVtcyI7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIHMgKz0gaW5zcGVjdFZhbHVlKGFycltpXSwgZGVwdGgsIHNlZW4pOwogICAgfQoKICAgIHMgKz0gJyBdJzsKICAgIHJldHVybiBzOwogIH0KCiAgZnVuY3Rpb24gbG9va3VwRGVzY3JpcHRvcihvYmosIGtleU5hbWUpIHsKICAgIHZhciBjdXJyZW50ID0gb2JqOwoKICAgIGRvIHsKICAgICAgdmFyIGRlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGN1cnJlbnQsIGtleU5hbWUpOwoKICAgICAgaWYgKGRlc2NyaXB0b3IgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBkZXNjcmlwdG9yOwogICAgICB9CgogICAgICBjdXJyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGN1cnJlbnQpOwogICAgfSB3aGlsZSAoY3VycmVudCAhPT0gbnVsbCk7CgogICAgcmV0dXJuIG51bGw7CiAgfQogIC8qKgogICAgQ2hlY2tzIHRvIHNlZSBpZiB0aGUgYG1ldGhvZE5hbWVgIGV4aXN0cyBvbiB0aGUgYG9iamAuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBsZXQgZm9vID0geyBiYXI6IGZ1bmN0aW9uKCkgeyByZXR1cm4gJ2Jhcic7IH0sIGJhejogbnVsbCB9OwogIAogICAgRW1iZXIuY2FuSW52b2tlKGZvbywgJ2JhcicpOyAvLyB0cnVlCiAgICBFbWJlci5jYW5JbnZva2UoZm9vLCAnYmF6Jyk7IC8vIGZhbHNlCiAgICBFbWJlci5jYW5JbnZva2UoZm9vLCAnYmF0Jyk7IC8vIGZhbHNlCiAgICBgYGAKICAKICAgIEBtZXRob2QgY2FuSW52b2tlCiAgICBAZm9yIEVtYmVyCiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gY2hlY2sgZm9yIHRoZSBtZXRob2QKICAgIEBwYXJhbSB7U3RyaW5nfSBtZXRob2ROYW1lIFRoZSBtZXRob2QgbmFtZSB0byBjaGVjayBmb3IKICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICBAcHJpdmF0ZQogICovCgoKICBmdW5jdGlvbiBjYW5JbnZva2Uob2JqLCBtZXRob2ROYW1lKSB7CiAgICByZXR1cm4gb2JqICE9PSBudWxsICYmIG9iaiAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBvYmpbbWV0aG9kTmFtZV0gPT09ICdmdW5jdGlvbic7CiAgfQogIC8qKgogICAgQG1vZHVsZSBAZW1iZXIvdXRpbHMKICAqLwoKICAvKioKICAgIENoZWNrcyB0byBzZWUgaWYgdGhlIGBtZXRob2ROYW1lYCBleGlzdHMgb24gdGhlIGBvYmpgLAogICAgYW5kIGlmIGl0IGRvZXMsIGludm9rZXMgaXQgd2l0aCB0aGUgYXJndW1lbnRzIHBhc3NlZC4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHRyeUludm9rZSB9IGZyb20gJ0BlbWJlci91dGlscyc7CiAgCiAgICBsZXQgZCA9IG5ldyBEYXRlKCcwMy8xNS8yMDEzJyk7CiAgCiAgICB0cnlJbnZva2UoZCwgJ2dldFRpbWUnKTsgICAgICAgICAgICAgIC8vIDEzNjMzMjAwMDAwMDAKICAgIHRyeUludm9rZShkLCAnc2V0RnVsbFllYXInLCBbMjAxNF0pOyAgLy8gMTM5NDg1NjAwMDAwMAogICAgdHJ5SW52b2tlKGQsICdub1N1Y2hNZXRob2QnLCBbMjAxNF0pOyAvLyB1bmRlZmluZWQKICAgIGBgYAogIAogICAgQG1ldGhvZCB0cnlJbnZva2UKICAgIEBmb3IgQGVtYmVyL3V0aWxzCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gY2hlY2sgZm9yIHRoZSBtZXRob2QKICAgIEBwYXJhbSB7U3RyaW5nfSBtZXRob2ROYW1lIFRoZSBtZXRob2QgbmFtZSB0byBjaGVjayBmb3IKICAgIEBwYXJhbSB7QXJyYXl9IFthcmdzXSBUaGUgYXJndW1lbnRzIHRvIHBhc3MgdG8gdGhlIG1ldGhvZAogICAgQHJldHVybiB7Kn0gdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgaW52b2tlZCBtZXRob2Qgb3IgdW5kZWZpbmVkIGlmIGl0IGNhbm5vdCBiZSBpbnZva2VkCiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIHRyeUludm9rZShvYmosIG1ldGhvZE5hbWUsIGFyZ3MpIHsKICAgIGlmIChjYW5JbnZva2Uob2JqLCBtZXRob2ROYW1lKSkgewogICAgICB2YXIgbWV0aG9kID0gb2JqW21ldGhvZE5hbWVdOwogICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KG9iaiwgYXJncyk7CiAgICB9CiAgfQoKICB2YXIgaXNBcnJheSQxID0gQXJyYXkuaXNBcnJheTsKCiAgZnVuY3Rpb24gbWFrZUFycmF5KG9iaikgewogICAgaWYgKG9iaiA9PT0gbnVsbCB8fCBvYmogPT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gW107CiAgICB9CgogICAgcmV0dXJuIGlzQXJyYXkkMShvYmopID8gb2JqIDogW29ial07CiAgfQoKICB2YXIgTkFNRVMgPSBuZXcgV2Vha01hcCgpOwoKICBmdW5jdGlvbiBzZXROYW1lKG9iaiwgbmFtZSkgewogICAgaWYgKGlzT2JqZWN0KG9iaikpIE5BTUVTLnNldChvYmosIG5hbWUpOwogIH0KCiAgZnVuY3Rpb24gZ2V0TmFtZShvYmopIHsKICAgIHJldHVybiBOQU1FUy5nZXQob2JqKTsKICB9CgogIHZhciBvYmplY3RUb1N0cmluZyQxID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKCiAgZnVuY3Rpb24gaXNOb25lKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gbnVsbCB8fCBvYmogPT09IHVuZGVmaW5lZDsKICB9CiAgLyoKICAgQSBgdG9TdHJpbmdgIHV0aWwgZnVuY3Rpb24gdGhhdCBzdXBwb3J0cyBvYmplY3RzIHdpdGhvdXQgYSBgdG9TdHJpbmdgCiAgIG1ldGhvZCwgZS5nLiBhbiBvYmplY3QgY3JlYXRlZCB3aXRoIGBPYmplY3QuY3JlYXRlKG51bGwpYC4KICAqLwoKCiAgZnVuY3Rpb24gdG9TdHJpbmcob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ3N0cmluZycpIHsKICAgICAgcmV0dXJuIG9iajsKICAgIH0KCiAgICBpZiAobnVsbCA9PT0gb2JqKSByZXR1cm4gJ251bGwnOwogICAgaWYgKHVuZGVmaW5lZCA9PT0gb2JqKSByZXR1cm4gJ3VuZGVmaW5lZCc7CgogICAgaWYgKEFycmF5LmlzQXJyYXkob2JqKSkgewogICAgICAvLyBSZWltcGxlbWVudCBBcnJheS5wcm90b3R5cGUuam9pbiBhY2NvcmRpbmcgdG8gc3BlYyAoMjIuMS4zLjEzKQogICAgICAvLyBDaGFuZ2luZyBUb1N0cmluZyhlbGVtZW50KSB3aXRoIHRoaXMgc2FmZSB2ZXJzaW9uIG9mIFRvU3RyaW5nLgogICAgICB2YXIgciA9ICcnOwoKICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBvYmoubGVuZ3RoOyBrKyspIHsKICAgICAgICBpZiAoayA+IDApIHsKICAgICAgICAgIHIgKz0gJywnOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFpc05vbmUob2JqW2tdKSkgewogICAgICAgICAgciArPSB0b1N0cmluZyhvYmpba10pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHI7CiAgICB9CgogICAgaWYgKHR5cGVvZiBvYmoudG9TdHJpbmcgPT09ICdmdW5jdGlvbicpIHsKICAgICAgcmV0dXJuIG9iai50b1N0cmluZygpOwogICAgfQoKICAgIHJldHVybiBvYmplY3RUb1N0cmluZyQxLmNhbGwob2JqKTsKICB9CgogIHZhciBIQVNfTkFUSVZFX1NZTUJPTCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0eXBlb2YgU3ltYm9sICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gdHlwZW9mIFN5bWJvbCgpID09PSAnc3ltYm9sJzsKICB9KCk7CgogIF9leHBvcnRzLkhBU19OQVRJVkVfU1lNQk9MID0gSEFTX05BVElWRV9TWU1CT0w7CiAgdmFyIEhBU19OQVRJVkVfUFJPWFkgPSB0eXBlb2YgUHJveHkgPT09ICdmdW5jdGlvbic7CiAgX2V4cG9ydHMuSEFTX05BVElWRV9QUk9YWSA9IEhBU19OQVRJVkVfUFJPWFk7CiAgdmFyIFBST1hJRVMgPSBuZXcgX3BvbHlmaWxscy5fV2Vha1NldCgpOwoKICBmdW5jdGlvbiBpc1Byb3h5KHZhbHVlKSB7CiAgICBpZiAoaXNPYmplY3QodmFsdWUpKSB7CiAgICAgIHJldHVybiBQUk9YSUVTLmhhcyh2YWx1ZSk7CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgZnVuY3Rpb24gc2V0UHJveHkob2JqZWN0KSB7CiAgICBpZiAoaXNPYmplY3Qob2JqZWN0KSkgewogICAgICBQUk9YSUVTLmFkZChvYmplY3QpOwogICAgfQogIH0KCiAgdmFyIENhY2hlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQ2FjaGUobGltaXQsIGZ1bmMsIHN0b3JlKSB7CiAgICAgIHRoaXMubGltaXQgPSBsaW1pdDsKICAgICAgdGhpcy5mdW5jID0gZnVuYzsKICAgICAgdGhpcy5zdG9yZSA9IHN0b3JlOwogICAgICB0aGlzLnNpemUgPSAwOwogICAgICB0aGlzLm1pc3NlcyA9IDA7CiAgICAgIHRoaXMuaGl0cyA9IDA7CiAgICAgIHRoaXMuc3RvcmUgPSBzdG9yZSB8fCBuZXcgTWFwKCk7CiAgICB9CgogICAgdmFyIF9wcm90byA9IENhY2hlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8uZ2V0ID0gZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICBpZiAodGhpcy5zdG9yZS5oYXMoa2V5KSkgewogICAgICAgIHRoaXMuaGl0cysrOwogICAgICAgIHJldHVybiB0aGlzLnN0b3JlLmdldChrZXkpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubWlzc2VzKys7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0KGtleSwgdGhpcy5mdW5jKGtleSkpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5zZXQgPSBmdW5jdGlvbiBzZXQoa2V5LCB2YWx1ZSkgewogICAgICBpZiAodGhpcy5saW1pdCA+IHRoaXMuc2l6ZSkgewogICAgICAgIHRoaXMuc2l6ZSsrOwogICAgICAgIHRoaXMuc3RvcmUuc2V0KGtleSwgdmFsdWUpOwogICAgICB9CgogICAgICByZXR1cm4gdmFsdWU7CiAgICB9OwoKICAgIF9wcm90by5wdXJnZSA9IGZ1bmN0aW9uIHB1cmdlKCkgewogICAgICB0aGlzLnN0b3JlLmNsZWFyKCk7CiAgICAgIHRoaXMuc2l6ZSA9IDA7CiAgICAgIHRoaXMuaGl0cyA9IDA7CiAgICAgIHRoaXMubWlzc2VzID0gMDsKICAgIH07CgogICAgcmV0dXJuIENhY2hlOwogIH0oKTsKCiAgX2V4cG9ydHMuQ2FjaGUgPSBDYWNoZTsKICB2YXIgRU1CRVJfQVJSQVkgPSBzeW1ib2woJ0VNQkVSX0FSUkFZJyk7CiAgX2V4cG9ydHMuRU1CRVJfQVJSQVkgPSBFTUJFUl9BUlJBWTsKCiAgZnVuY3Rpb24gaXNFbWJlckFycmF5KG9iaikgewogICAgcmV0dXJuIG9iaiAmJiBvYmpbRU1CRVJfQVJSQVldOwogIH0KCiAgdmFyIHNldHVwTWFuZGF0b3J5U2V0dGVyOwogIF9leHBvcnRzLnNldHVwTWFuZGF0b3J5U2V0dGVyID0gc2V0dXBNYW5kYXRvcnlTZXR0ZXI7CiAgdmFyIHRlYXJkb3duTWFuZGF0b3J5U2V0dGVyOwogIF9leHBvcnRzLnRlYXJkb3duTWFuZGF0b3J5U2V0dGVyID0gdGVhcmRvd25NYW5kYXRvcnlTZXR0ZXI7CiAgdmFyIHNldFdpdGhNYW5kYXRvcnlTZXR0ZXI7CiAgX2V4cG9ydHMuc2V0V2l0aE1hbmRhdG9yeVNldHRlciA9IHNldFdpdGhNYW5kYXRvcnlTZXR0ZXI7CgogIGlmIChmYWxzZQogIC8qIERFQlVHICovCiAgJiYgdHJ1ZQogIC8qIEVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyAqLwogICkgewogICAgICB2YXIgTUFOREFUT1JZX1NFVFRFUlMgPSBuZXcgV2Vha01hcCgpOwoKICAgICAgdmFyIF9wcm9wZXJ0eUlzRW51bWVyYWJsZSA9IGZ1bmN0aW9uIF9wcm9wZXJ0eUlzRW51bWVyYWJsZShvYmosIGtleSkgewogICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwob2JqLCBrZXkpOwogICAgICB9OwoKICAgICAgX2V4cG9ydHMuc2V0dXBNYW5kYXRvcnlTZXR0ZXIgPSBzZXR1cE1hbmRhdG9yeVNldHRlciA9IGZ1bmN0aW9uIHNldHVwTWFuZGF0b3J5U2V0dGVyKG9iaiwga2V5TmFtZSkgewogICAgICAgIHZhciBkZXNjID0gbG9va3VwRGVzY3JpcHRvcihvYmosIGtleU5hbWUpIHx8IHt9OwoKICAgICAgICBpZiAoZGVzYy5nZXQgfHwgZGVzYy5zZXQpIHsKICAgICAgICAgIC8vIGlmIGl0IGhhcyBhIGdldHRlciBvciBzZXR0ZXIsIHdlIGNhbid0IGluc3RhbGwgdGhlIG1hbmRhdG9yeSBzZXR0ZXIuCiAgICAgICAgICAvLyBuYXRpdmUgc2V0dGVycyBhcmUgYWxsb3dlZCwgd2UgaGF2ZSB0byBhc3N1bWUgdGhhdCB0aGV5IHdpbGwgcmVzb2x2ZQogICAgICAgICAgLy8gdG8gdHJhY2tlZCBwcm9wZXJ0aWVzLgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRlc2MgJiYgKCFkZXNjLmNvbmZpZ3VyYWJsZSB8fCAhZGVzYy53cml0YWJsZSkpIHsKICAgICAgICAgIC8vIGlmIGl0IGlzbid0IHdyaXRhYmxlIGFueXdheXMsIHNvIHdlIHNob3VsZG4ndCBwcm92aWRlIHRoZSBzZXR0ZXIuCiAgICAgICAgICAvLyBpZiBpdCBpc24ndCBjb25maWd1cmFibGUsIHdlIGNhbid0IG92ZXJ3cml0ZSBpdCBhbnl3YXlzLgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHNldHRlcnMgPSBNQU5EQVRPUllfU0VUVEVSUy5nZXQob2JqKTsKCiAgICAgICAgaWYgKHNldHRlcnMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgc2V0dGVycyA9IHt9OwogICAgICAgICAgTUFOREFUT1JZX1NFVFRFUlMuc2V0KG9iaiwgc2V0dGVycyk7CiAgICAgICAgfQoKICAgICAgICBkZXNjLmhhZE93blByb3BlcnR5ID0gT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXlOYW1lKTsKICAgICAgICBzZXR0ZXJzW2tleU5hbWVdID0gZGVzYzsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXlOYW1lLCB7CiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICBlbnVtZXJhYmxlOiBfcHJvcGVydHlJc0VudW1lcmFibGUob2JqLCBrZXlOYW1lKSwKICAgICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICBpZiAoZGVzYy5nZXQpIHsKICAgICAgICAgICAgICByZXR1cm4gZGVzYy5nZXQuY2FsbCh0aGlzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gZGVzYy52YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIHNldDogZnVuY3Rpb24gc2V0KHZhbHVlKSB7CiAgICAgICAgICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIllvdSBhdHRlbXB0ZWQgdG8gdXBkYXRlICIgKyB0aGlzICsgIi4iICsgU3RyaW5nKGtleU5hbWUpICsgIiB0byBcIiIgKyBTdHJpbmcodmFsdWUpICsgIlwiLCBidXQgaXQgaXMgYmVpbmcgdHJhY2tlZCBieSBhIHRyYWNraW5nIGNvbnRleHQsIHN1Y2ggYXMgYSB0ZW1wbGF0ZSwgY29tcHV0ZWQgcHJvcGVydHksIG9yIG9ic2VydmVyLiBJbiBvcmRlciB0byBtYWtlIHN1cmUgdGhlIGNvbnRleHQgdXBkYXRlcyBwcm9wZXJseSwgeW91IG11c3QgaW52YWxpZGF0ZSB0aGUgcHJvcGVydHkgd2hlbiB1cGRhdGluZyBpdC4gWW91IGNhbiBtYXJrIHRoZSBwcm9wZXJ0eSBhcyBgQHRyYWNrZWRgLCBvciB1c2UgYEBlbWJlci9vYmplY3Qjc2V0YCB0byBkbyB0aGlzLiIpKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfTsKCiAgICAgIF9leHBvcnRzLnRlYXJkb3duTWFuZGF0b3J5U2V0dGVyID0gdGVhcmRvd25NYW5kYXRvcnlTZXR0ZXIgPSBmdW5jdGlvbiB0ZWFyZG93bk1hbmRhdG9yeVNldHRlcihvYmosIGtleU5hbWUpIHsKICAgICAgICB2YXIgc2V0dGVycyA9IE1BTkRBVE9SWV9TRVRURVJTLmdldChvYmopOwoKICAgICAgICBpZiAoc2V0dGVycyAhPT0gdW5kZWZpbmVkICYmIHNldHRlcnNba2V5TmFtZV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgc2V0dGVyc1trZXlOYW1lXSk7CiAgICAgICAgICBzZXR0ZXJzW2tleU5hbWVdID0gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIF9leHBvcnRzLnNldFdpdGhNYW5kYXRvcnlTZXR0ZXIgPSBzZXRXaXRoTWFuZGF0b3J5U2V0dGVyID0gZnVuY3Rpb24gc2V0V2l0aE1hbmRhdG9yeVNldHRlcihvYmosIGtleU5hbWUsIHZhbHVlKSB7CiAgICAgICAgdmFyIHNldHRlcnMgPSBNQU5EQVRPUllfU0VUVEVSUy5nZXQob2JqKTsKCiAgICAgICAgaWYgKHNldHRlcnMgIT09IHVuZGVmaW5lZCAmJiBzZXR0ZXJzW2tleU5hbWVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciBzZXR0ZXIgPSBzZXR0ZXJzW2tleU5hbWVdOwoKICAgICAgICAgIGlmIChzZXR0ZXIuc2V0KSB7CiAgICAgICAgICAgIHNldHRlci5zZXQuY2FsbChvYmosIHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNldHRlci52YWx1ZSA9IHZhbHVlOyAvLyBJZiB0aGUgb2JqZWN0IGRpZG4ndCBoYXZlIG93biBwcm9wZXJ0eSBiZWZvcmUsIGl0IHdvdWxkIGhhdmUgY2hhbmdlZAogICAgICAgICAgICAvLyB0aGUgZW51bWVyYWJpbGl0eSBhZnRlciBzZXR0aW5nIHRoZSB2YWx1ZSB0aGUgZmlyc3QgdGltZS4KCiAgICAgICAgICAgIGlmICghc2V0dGVyLmhhZE93blByb3BlcnR5KSB7CiAgICAgICAgICAgICAgdmFyIGRlc2MgPSBsb29rdXBEZXNjcmlwdG9yKG9iaiwga2V5TmFtZSk7CiAgICAgICAgICAgICAgZGVzYy5lbnVtZXJhYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXlOYW1lLCBkZXNjKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvYmpba2V5TmFtZV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgLyoKICAgVGhpcyBwYWNrYWdlIHdpbGwgYmUgZWFnZXJseSBwYXJzZWQgYW5kIHNob3VsZCBoYXZlIG5vIGRlcGVuZGVuY2llcyBvbiBleHRlcm5hbAogICBwYWNrYWdlcy4KICAKICAgSXQgaXMgaW50ZW5kZWQgdG8gYmUgdXNlZCB0byBzaGFyZSB1dGlsaXR5IG1ldGhvZHMgdGhhdCB3aWxsIGJlIG5lZWRlZAogICBieSBldmVyeSBFbWJlciBhcHBsaWNhdGlvbiAoYW5kIGlzICoqbm90KiogYSBkdW1waW5nIGdyb3VuZCBvZiB1c2VmdWwgdXRpbGl0aWVzKS4KICAKICAgVXRpbGl0eSBtZXRob2RzIHRoYXQgYXJlIG5lZWRlZCBpbiA8IDgwJSBvZiBjYXNlcyBzaG91bGQgYmUgcGxhY2VkCiAgIGVsc2V3aGVyZSAoc28gdGhleSBjYW4gYmUgbGF6aWx5IGV2YWx1YXRlZCAvIHBhcnNlZCkuCiAgKi8KCn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2luZGV4IiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi9zeXN0ZW0vanF1ZXJ5IiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi9zeXN0ZW0vdXRpbHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvdmlld3MvbGliL3N5c3RlbS9ldmVudF9kaXNwYXRjaGVyIiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi9jb21wb25lbnRfbG9va3VwIiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi9taXhpbnMvdGV4dF9zdXBwb3J0IiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi92aWV3cy9jb3JlX3ZpZXciLCAiQGVtYmVyLy1pbnRlcm5hbHMvdmlld3MvbGliL21peGlucy9jbGFzc19uYW1lc19zdXBwb3J0IiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi9taXhpbnMvY2hpbGRfdmlld3Nfc3VwcG9ydCIsICJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvbWl4aW5zL3ZpZXdfc3RhdGVfc3VwcG9ydCIsICJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvbWl4aW5zL3ZpZXdfc3VwcG9ydCIsICJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvbWl4aW5zL2FjdGlvbl9zdXBwb3J0IiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi9jb21wYXQvYXR0cnMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvdmlld3MvbGliL3N5c3RlbS9sb29rdXBfcGFydGlhbCIsICJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvc3lzdGVtL2FjdGlvbl9tYW5hZ2VyIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2pxdWVyeSwgX3V0aWxzLCBfZXZlbnRfZGlzcGF0Y2hlciwgX2NvbXBvbmVudF9sb29rdXAsIF90ZXh0X3N1cHBvcnQsIF9jb3JlX3ZpZXcsIF9jbGFzc19uYW1lc19zdXBwb3J0LCBfY2hpbGRfdmlld3Nfc3VwcG9ydCwgX3ZpZXdfc3RhdGVfc3VwcG9ydCwgX3ZpZXdfc3VwcG9ydCwgX2FjdGlvbl9zdXBwb3J0LCBfYXR0cnMsIF9sb29rdXBfcGFydGlhbCwgX2FjdGlvbl9tYW5hZ2VyKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJqUXVlcnkiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfanF1ZXJ5LmpRdWVyeTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJqUXVlcnlEaXNhYmxlZCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9qcXVlcnkualF1ZXJ5RGlzYWJsZWQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiYWRkQ2hpbGRWaWV3IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3V0aWxzLmFkZENoaWxkVmlldzsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJpc1NpbXBsZUNsaWNrIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3V0aWxzLmlzU2ltcGxlQ2xpY2s7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiZ2V0Vmlld0JvdW5kcyIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF91dGlscy5nZXRWaWV3Qm91bmRzOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImdldFZpZXdDbGllbnRSZWN0cyIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF91dGlscy5nZXRWaWV3Q2xpZW50UmVjdHM7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiZ2V0Vmlld0JvdW5kaW5nQ2xpZW50UmVjdCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF91dGlscy5nZXRWaWV3Qm91bmRpbmdDbGllbnRSZWN0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImdldFJvb3RWaWV3cyIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF91dGlscy5nZXRSb290Vmlld3M7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiZ2V0Q2hpbGRWaWV3cyIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF91dGlscy5nZXRDaGlsZFZpZXdzOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImdldFZpZXdJZCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF91dGlscy5nZXRWaWV3SWQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiZ2V0RWxlbWVudFZpZXciLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfdXRpbHMuZ2V0RWxlbWVudFZpZXc7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiZ2V0Vmlld0VsZW1lbnQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfdXRpbHMuZ2V0Vmlld0VsZW1lbnQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAic2V0RWxlbWVudFZpZXciLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfdXRpbHMuc2V0RWxlbWVudFZpZXc7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAic2V0Vmlld0VsZW1lbnQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfdXRpbHMuc2V0Vmlld0VsZW1lbnQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiY2xlYXJFbGVtZW50VmlldyIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF91dGlscy5jbGVhckVsZW1lbnRWaWV3OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImNsZWFyVmlld0VsZW1lbnQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfdXRpbHMuY2xlYXJWaWV3RWxlbWVudDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJjb25zdHJ1Y3RTdHlsZURlcHJlY2F0aW9uTWVzc2FnZSIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF91dGlscy5jb25zdHJ1Y3RTdHlsZURlcHJlY2F0aW9uTWVzc2FnZTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJFdmVudERpc3BhdGNoZXIiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfZXZlbnRfZGlzcGF0Y2hlci5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIkNvbXBvbmVudExvb2t1cCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9jb21wb25lbnRfbG9va3VwLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiVGV4dFN1cHBvcnQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfdGV4dF9zdXBwb3J0LmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiQ29yZVZpZXciLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfY29yZV92aWV3LmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiQ2xhc3NOYW1lc1N1cHBvcnQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfY2xhc3NfbmFtZXNfc3VwcG9ydC5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIkNoaWxkVmlld3NTdXBwb3J0IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2NoaWxkX3ZpZXdzX3N1cHBvcnQuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJWaWV3U3RhdGVTdXBwb3J0IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3ZpZXdfc3RhdGVfc3VwcG9ydC5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIlZpZXdNaXhpbiIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF92aWV3X3N1cHBvcnQuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJBY3Rpb25TdXBwb3J0IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2FjdGlvbl9zdXBwb3J0LmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiTVVUQUJMRV9DRUxMIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2F0dHJzLk1VVEFCTEVfQ0VMTDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJsb29rdXBQYXJ0aWFsIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2xvb2t1cF9wYXJ0aWFsLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiaGFzUGFydGlhbCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9sb29rdXBfcGFydGlhbC5oYXNQYXJ0aWFsOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIkFjdGlvbk1hbmFnZXIiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfYWN0aW9uX21hbmFnZXIuZGVmYXVsdDsKICAgIH0KICB9KTsKfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvdmlld3MvbGliL2NvbXBhdC9hdHRycyIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy91dGlscyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF91dGlscykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuTVVUQUJMRV9DRUxMID0gdm9pZCAwOwogIHZhciBNVVRBQkxFX0NFTEwgPSAoMCwgX3V0aWxzLnN5bWJvbCkoJ01VVEFCTEVfQ0VMTCcpOwogIF9leHBvcnRzLk1VVEFCTEVfQ0VMTCA9IE1VVEFCTEVfQ0VMTDsKfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvdmlld3MvbGliL2NvbXBhdC9mYWxsYmFjay12aWV3LXJlZ2lzdHJ5IiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL3V0aWxzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX3V0aWxzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICB2YXIgX2RlZmF1bHQgPSAoMCwgX3V0aWxzLmRpY3Rpb25hcnkpKG51bGwpOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi9jb21wb25lbnRfbG9va3VwIiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfcnVudGltZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgdmFyIF9kZWZhdWx0ID0gX3J1bnRpbWUuT2JqZWN0LmV4dGVuZCh7CiAgICBjb21wb25lbnRGb3I6IGZ1bmN0aW9uIGNvbXBvbmVudEZvcihuYW1lLCBvd25lciwgb3B0aW9ucykgewogICAgICB2YXIgZnVsbE5hbWUgPSAiY29tcG9uZW50OiIgKyBuYW1lOwogICAgICByZXR1cm4gb3duZXIuZmFjdG9yeUZvcihmdWxsTmFtZSwgb3B0aW9ucyk7CiAgICB9LAogICAgbGF5b3V0Rm9yOiBmdW5jdGlvbiBsYXlvdXRGb3IobmFtZSwgb3duZXIsIG9wdGlvbnMpIHsKICAgICAgdmFyIHRlbXBsYXRlRnVsbE5hbWUgPSAidGVtcGxhdGU6Y29tcG9uZW50cy8iICsgbmFtZTsKICAgICAgcmV0dXJuIG93bmVyLmxvb2t1cCh0ZW1wbGF0ZUZ1bGxOYW1lLCBvcHRpb25zKTsKICAgIH0KICB9KTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvbWl4aW5zL2FjdGlvbl9zdXBwb3J0IiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL3V0aWxzIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGFsIiwgIkBlbWJlci9kZWJ1ZyIsICJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvY29tcGF0L2F0dHJzIiwgIkBlbWJlci9kZXByZWNhdGVkLWZlYXR1cmVzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX3V0aWxzLCBfbWV0YWwsIF9kZWJ1ZywgX2F0dHJzLCBfZGVwcmVjYXRlZEZlYXR1cmVzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICAgQG1vZHVsZSBlbWJlcgogICovCiAgdmFyIG1peGluT2JqID0gewogICAgc2VuZDogZnVuY3Rpb24gc2VuZChhY3Rpb25OYW1lKSB7CiAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXkgLSAxXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgfQoKICAgICAgKGZhbHNlICYmICEoIXRoaXMuaXNEZXN0cm95aW5nICYmICF0aGlzLmlzRGVzdHJveWVkKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkF0dGVtcHRlZCB0byBjYWxsIC5zZW5kKCkgd2l0aCB0aGUgYWN0aW9uICciICsgYWN0aW9uTmFtZSArICInIG9uIHRoZSBkZXN0cm95ZWQgb2JqZWN0ICciICsgdGhpcyArICInLiIsICF0aGlzLmlzRGVzdHJveWluZyAmJiAhdGhpcy5pc0Rlc3Ryb3llZCkpOwogICAgICB2YXIgYWN0aW9uID0gdGhpcy5hY3Rpb25zICYmIHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKCiAgICAgIGlmIChhY3Rpb24pIHsKICAgICAgICB2YXIgc2hvdWxkQnViYmxlID0gYWN0aW9uLmFwcGx5KHRoaXMsIGFyZ3MpID09PSB0cnVlOwoKICAgICAgICBpZiAoIXNob3VsZEJ1YmJsZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIHRhcmdldCA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAndGFyZ2V0Jyk7CgogICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgKGZhbHNlICYmICEodHlwZW9mIHRhcmdldC5zZW5kID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIlRoZSBgdGFyZ2V0YCBmb3IgIiArIHRoaXMgKyAiICgiICsgdGFyZ2V0ICsgIikgZG9lcyBub3QgaGF2ZSBhIGBzZW5kYCBtZXRob2QiLCB0eXBlb2YgdGFyZ2V0LnNlbmQgPT09ICdmdW5jdGlvbicpKTsKICAgICAgICB0YXJnZXQuc2VuZC5hcHBseSh0YXJnZXQsIGFyZ3VtZW50cyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGZhbHNlICYmICEoYWN0aW9uKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoKDAsIF91dGlscy5pbnNwZWN0KSh0aGlzKSArICIgaGFkIG5vIGFjdGlvbiBoYW5kbGVyIGZvcjogIiArIGFjdGlvbk5hbWUsIGFjdGlvbikpOwogICAgICB9CiAgICB9CiAgfTsKCiAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuU0VORF9BQ1RJT04pIHsKICAgIC8qKgogICAgICBDYWxscyBhbiBhY3Rpb24gcGFzc2VkIHRvIGEgY29tcG9uZW50LgogICAgICAgRm9yIGV4YW1wbGUgYSBjb21wb25lbnQgZm9yIHBsYXlpbmcgb3IgcGF1c2luZyBtdXNpYyBtYXkgdHJhbnNsYXRlIGNsaWNrIGV2ZW50cwogICAgICBpbnRvIGFjdGlvbiBub3RpZmljYXRpb25zIG9mICJwbGF5IiBvciAic3RvcCIgZGVwZW5kaW5nIG9uIHNvbWUgaW50ZXJuYWwgc3RhdGUKICAgICAgb2YgdGhlIGNvbXBvbmVudDoKICAgICAgIGBgYGFwcC9jb21wb25lbnRzL3BsYXktYnV0dG9uLmpzCiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBjbGljaygpIHsKICAgICAgICAgIGlmICh0aGlzLmdldCgnaXNQbGF5aW5nJykpIHsKICAgICAgICAgICAgdGhpcy5zZW5kQWN0aW9uKCdwbGF5Jyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnNlbmRBY3Rpb24oJ3N0b3AnKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFRoZSBhY3Rpb25zICJwbGF5IiBhbmQgInN0b3AiIG11c3QgYmUgcGFzc2VkIHRvIHRoaXMgYHBsYXktYnV0dG9uYCBjb21wb25lbnQ6CiAgICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7ISBhcHAvdGVtcGxhdGVzL2FwcGxpY2F0aW9uLmhicyB9fQogICAgICB7e3BsYXktYnV0dG9uIHBsYXk9KGFjdGlvbiAibXVzaWNTdGFydGVkIikgc3RvcD0oYWN0aW9uICJtdXNpY1N0b3BwZWQiKX19CiAgICAgIGBgYAogICAgICAgV2hlbiB0aGUgY29tcG9uZW50IHJlY2VpdmVzIGEgYnJvd3NlciBgY2xpY2tgIGV2ZW50IGl0IHRyYW5zbGF0ZSB0aGlzCiAgICAgIGludGVyYWN0aW9uIGludG8gYXBwbGljYXRpb24tc3BlY2lmaWMgc2VtYW50aWNzICgicGxheSIgb3IgInN0b3AiKSBhbmQKICAgICAgY2FsbHMgdGhlIHNwZWNpZmllZCBhY3Rpb24uCiAgICAgICBgYGBhcHAvY29udHJvbGxlci9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgQ29udHJvbGxlciBmcm9tICdAZW1iZXIvY29udHJvbGxlcic7CiAgICAgICBleHBvcnQgZGVmYXVsdCBDb250cm9sbGVyLmV4dGVuZCh7CiAgICAgICAgYWN0aW9uczogewogICAgICAgICAgbXVzaWNTdGFydGVkKCkgewogICAgICAgICAgICAvLyBjYWxsZWQgd2hlbiB0aGUgcGxheSBidXR0b24gaXMgY2xpY2tlZAogICAgICAgICAgICAvLyBhbmQgdGhlIG11c2ljIHN0YXJ0ZWQgcGxheWluZwogICAgICAgICAgfSwKICAgICAgICAgIG11c2ljU3RvcHBlZCgpIHsKICAgICAgICAgICAgLy8gY2FsbGVkIHdoZW4gdGhlIHBsYXkgYnV0dG9uIGlzIGNsaWNrZWQKICAgICAgICAgICAgLy8gYW5kIHRoZSBtdXNpYyBzdG9wcGVkIHBsYXlpbmcKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIElmIG5vIGFjdGlvbiBpcyBwYXNzZWQgdG8gYHNlbmRBY3Rpb25gIGEgZGVmYXVsdCBuYW1lIG9mICJhY3Rpb24iCiAgICAgIGlzIGFzc3VtZWQuCiAgICAgICBgYGBhcHAvY29tcG9uZW50cy9uZXh0LWJ1dHRvbi5qcwogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgY2xpY2soKSB7CiAgICAgICAgICB0aGlzLnNlbmRBY3Rpb24oKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3shIGFwcC90ZW1wbGF0ZXMvYXBwbGljYXRpb24uaGJzIH19CiAgICAgIHt7bmV4dC1idXR0b24gYWN0aW9uPShhY3Rpb24gInBsYXlOZXh0U29uZ0luQWxidW0iKX19CiAgICAgIGBgYAogICAgICAgYGBgYXBwL2NvbnRyb2xsZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBDb250cm9sbGVyIGZyb20gJ0BlbWJlci9jb250cm9sbGVyJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IENvbnRyb2xsZXIuZXh0ZW5kKHsKICAgICAgICBhY3Rpb25zOiB7CiAgICAgICAgICBwbGF5TmV4dFNvbmdJbkFsYnVtKCkgewogICAgICAgICAgICAuLi4KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2Qgc2VuZEFjdGlvbgogICAgICBAcGFyYW0gW2FjdGlvbl0ge1N0cmluZ30gdGhlIGFjdGlvbiB0byBjYWxsCiAgICAgIEBwYXJhbSBbcGFyYW1zXSB7Kn0gYXJndW1lbnRzIGZvciB0aGUgYWN0aW9uCiAgICAgIEBwdWJsaWMKICAgICAgQGRlcHJlY2F0ZWQKICAgICovCiAgICB2YXIgc2VuZEFjdGlvbiA9IGZ1bmN0aW9uIHNlbmRBY3Rpb24oYWN0aW9uKSB7CiAgICAgIChmYWxzZSAmJiAhKCF0aGlzLmlzRGVzdHJveWluZyAmJiAhdGhpcy5pc0Rlc3Ryb3llZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJBdHRlbXB0ZWQgdG8gY2FsbCAuc2VuZEFjdGlvbigpIHdpdGggdGhlIGFjdGlvbiAnIiArIGFjdGlvbiArICInIG9uIHRoZSBkZXN0cm95ZWQgb2JqZWN0ICciICsgdGhpcyArICInLiIsICF0aGlzLmlzRGVzdHJveWluZyAmJiAhdGhpcy5pc0Rlc3Ryb3llZCkpOwogICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCJZb3UgY2FsbGVkICIgKyAoMCwgX3V0aWxzLmluc3BlY3QpKHRoaXMpICsgIi5zZW5kQWN0aW9uKCIgKyAodHlwZW9mIGFjdGlvbiA9PT0gJ3N0cmluZycgPyAiXCIiICsgYWN0aW9uICsgIlwiIiA6ICcnKSArICIpIGJ1dCBDb21wb25lbnQjc2VuZEFjdGlvbiBpcyBkZXByZWNhdGVkLiBQbGVhc2UgdXNlIGNsb3N1cmUgYWN0aW9ucyBpbnN0ZWFkLiIsIGZhbHNlLCB7CiAgICAgICAgaWQ6ICdlbWJlci1jb21wb25lbnQuc2VuZC1hY3Rpb24nLAogICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgIHVybDogJ2h0dHBzOi8vZW1iZXJqcy5jb20vZGVwcmVjYXRpb25zL3YzLngjdG9jX2VtYmVyLWNvbXBvbmVudC1zZW5kLWFjdGlvbicKICAgICAgfSkpOwogICAgICB2YXIgYWN0aW9uTmFtZTsgLy8gU2VuZCB0aGUgZGVmYXVsdCBhY3Rpb24KCiAgICAgIGlmIChhY3Rpb24gPT09IHVuZGVmaW5lZCkgewogICAgICAgIGFjdGlvbiA9ICdhY3Rpb24nOwogICAgICB9CgogICAgICBhY3Rpb25OYW1lID0gKDAsIF9tZXRhbC5nZXQpKHRoaXMsICJhdHRycy4iICsgYWN0aW9uKSB8fCAoMCwgX21ldGFsLmdldCkodGhpcywgYWN0aW9uKTsKICAgICAgYWN0aW9uTmFtZSA9IHZhbGlkYXRlQWN0aW9uKHRoaXMsIGFjdGlvbk5hbWUpOyAvLyBJZiBubyBhY3Rpb24gbmFtZSBmb3IgdGhhdCBhY3Rpb24gY291bGQgYmUgZm91bmQsIGp1c3QgYWJvcnQuCgogICAgICBpZiAoYWN0aW9uTmFtZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGNvbnRleHRzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICBjb250ZXh0c1tfa2V5MiAtIDFdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgfQoKICAgICAgaWYgKHR5cGVvZiBhY3Rpb25OYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgYWN0aW9uTmFtZS5hcHBseSh2b2lkIDAsIGNvbnRleHRzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRyaWdnZXJBY3Rpb24oewogICAgICAgICAgYWN0aW9uOiBhY3Rpb25OYW1lLAogICAgICAgICAgYWN0aW9uQ29udGV4dDogY29udGV4dHMKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgdmFsaWRhdGVBY3Rpb24gPSBmdW5jdGlvbiB2YWxpZGF0ZUFjdGlvbihjb21wb25lbnQsIGFjdGlvbk5hbWUpIHsKICAgICAgaWYgKGFjdGlvbk5hbWUgJiYgYWN0aW9uTmFtZVtfYXR0cnMuTVVUQUJMRV9DRUxMXSkgewogICAgICAgIGFjdGlvbk5hbWUgPSBhY3Rpb25OYW1lLnZhbHVlOwogICAgICB9CgogICAgICAoZmFsc2UgJiYgIShhY3Rpb25OYW1lID09PSBudWxsIHx8IGFjdGlvbk5hbWUgPT09IHVuZGVmaW5lZCB8fCB0eXBlb2YgYWN0aW9uTmFtZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIGFjdGlvbk5hbWUgPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiVGhlIGRlZmF1bHQgYWN0aW9uIHdhcyB0cmlnZ2VyZWQgb24gdGhlIGNvbXBvbmVudCAiICsgY29tcG9uZW50LnRvU3RyaW5nKCkgKyAiLCBidXQgdGhlIGFjdGlvbiBuYW1lICgiICsgYWN0aW9uTmFtZSArICIpIHdhcyBub3QgYSBzdHJpbmcuIiwgYWN0aW9uTmFtZSA9PT0gbnVsbCB8fCBhY3Rpb25OYW1lID09PSB1bmRlZmluZWQgfHwgdHlwZW9mIGFjdGlvbk5hbWUgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiBhY3Rpb25OYW1lID09PSAnZnVuY3Rpb24nKSk7CiAgICAgIHJldHVybiBhY3Rpb25OYW1lOwogICAgfTsKCiAgICBtaXhpbk9iai5zZW5kQWN0aW9uID0gc2VuZEFjdGlvbjsKICB9CiAgLyoqCiAgIEBjbGFzcyBBY3Rpb25TdXBwb3J0CiAgIEBuYW1lc3BhY2UgRW1iZXIKICAgQHByaXZhdGUKICAqLwoKCiAgdmFyIF9kZWZhdWx0ID0gX21ldGFsLk1peGluLmNyZWF0ZShtaXhpbk9iaik7CgogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvdmlld3MvbGliL21peGlucy9jaGlsZF92aWV3c19zdXBwb3J0IiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGFsIiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi9zeXN0ZW0vdXRpbHMiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfbWV0YWwsIF91dGlscykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgQG1vZHVsZSBlbWJlcgogICovCiAgdmFyIF9kZWZhdWx0ID0gX21ldGFsLk1peGluLmNyZWF0ZSh7CiAgICAvKioKICAgICAgQXJyYXkgb2YgY2hpbGQgdmlld3MuIFlvdSBzaG91bGQgbmV2ZXIgZWRpdCB0aGlzIGFycmF5IGRpcmVjdGx5LgogICAgICAgQHByb3BlcnR5IGNoaWxkVmlld3MKICAgICAgQHR5cGUgQXJyYXkKICAgICAgQGRlZmF1bHQgW10KICAgICAgQHByaXZhdGUKICAgICovCiAgICBjaGlsZFZpZXdzOiAoMCwgX21ldGFsLm5hdGl2ZURlc2NEZWNvcmF0b3IpKHsKICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiAoMCwgX3V0aWxzLmdldENoaWxkVmlld3MpKHRoaXMpOwogICAgICB9CiAgICB9KSwKICAgIGFwcGVuZENoaWxkOiBmdW5jdGlvbiBhcHBlbmRDaGlsZCh2aWV3KSB7CiAgICAgICgwLCBfdXRpbHMuYWRkQ2hpbGRWaWV3KSh0aGlzLCB2aWV3KTsKICAgIH0KICB9KTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvbWl4aW5zL2NsYXNzX25hbWVzX3N1cHBvcnQiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiLCAiQGVtYmVyL2RlYnVnIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX21ldGFsLCBfZGVidWcpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwogIHZhciBFTVBUWV9BUlJBWSA9IE9iamVjdC5mcmVlemUoW10pOwogIC8qKgogICAgQGNsYXNzIENsYXNzTmFtZXNTdXBwb3J0CiAgICBAbmFtZXNwYWNlIEVtYmVyCiAgICBAcHJpdmF0ZQogICovCgogIHZhciBfZGVmYXVsdCA9IF9tZXRhbC5NaXhpbi5jcmVhdGUoewogICAgY29uY2F0ZW5hdGVkUHJvcGVydGllczogWydjbGFzc05hbWVzJywgJ2NsYXNzTmFtZUJpbmRpbmdzJ10sCiAgICBpbml0OiBmdW5jdGlvbiBpbml0KCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgKGZhbHNlICYmICEoKDAsIF9tZXRhbC5kZXNjcmlwdG9yRm9yUHJvcGVydHkpKHRoaXMsICdjbGFzc05hbWVCaW5kaW5ncycpID09PSB1bmRlZmluZWQgJiYgQXJyYXkuaXNBcnJheSh0aGlzLmNsYXNzTmFtZUJpbmRpbmdzKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJPbmx5IGFycmF5cyBhcmUgYWxsb3dlZCBmb3IgJ2NsYXNzTmFtZUJpbmRpbmdzJyIsICgwLCBfbWV0YWwuZGVzY3JpcHRvckZvclByb3BlcnR5KSh0aGlzLCAnY2xhc3NOYW1lQmluZGluZ3MnKSA9PT0gdW5kZWZpbmVkICYmIEFycmF5LmlzQXJyYXkodGhpcy5jbGFzc05hbWVCaW5kaW5ncykpKTsKICAgICAgKGZhbHNlICYmICEoKDAsIF9tZXRhbC5kZXNjcmlwdG9yRm9yUHJvcGVydHkpKHRoaXMsICdjbGFzc05hbWVzJykgPT09IHVuZGVmaW5lZCAmJiBBcnJheS5pc0FycmF5KHRoaXMuY2xhc3NOYW1lcykpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiT25seSBhcnJheXMgb2Ygc3RhdGljIGNsYXNzIHN0cmluZ3MgYXJlIGFsbG93ZWQgZm9yICdjbGFzc05hbWVzJy4gRm9yIGR5bmFtaWMgY2xhc3NlcywgdXNlICdjbGFzc05hbWVCaW5kaW5ncycuIiwgKDAsIF9tZXRhbC5kZXNjcmlwdG9yRm9yUHJvcGVydHkpKHRoaXMsICdjbGFzc05hbWVzJykgPT09IHVuZGVmaW5lZCAmJiBBcnJheS5pc0FycmF5KHRoaXMuY2xhc3NOYW1lcykpKTsKICAgIH0sCgogICAgLyoqCiAgICAgIFN0YW5kYXJkIENTUyBjbGFzcyBuYW1lcyB0byBhcHBseSB0byB0aGUgdmlldydzIG91dGVyIGVsZW1lbnQuIFRoaXMKICAgICAgcHJvcGVydHkgYXV0b21hdGljYWxseSBpbmhlcml0cyBhbnkgY2xhc3MgbmFtZXMgZGVmaW5lZCBieSB0aGUgdmlldydzCiAgICAgIHN1cGVyY2xhc3NlcyBhcyB3ZWxsLgogICAgICAgQHByb3BlcnR5IGNsYXNzTmFtZXMKICAgICAgQHR5cGUgQXJyYXkKICAgICAgQGRlZmF1bHQgWydlbWJlci12aWV3J10KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGNsYXNzTmFtZXM6IEVNUFRZX0FSUkFZLAoKICAgIC8qKgogICAgICBBIGxpc3Qgb2YgcHJvcGVydGllcyBvZiB0aGUgdmlldyB0byBhcHBseSBhcyBjbGFzcyBuYW1lcy4gSWYgdGhlIHByb3BlcnR5CiAgICAgIGlzIGEgc3RyaW5nIHZhbHVlLCB0aGUgdmFsdWUgb2YgdGhhdCBzdHJpbmcgd2lsbCBiZSBhcHBsaWVkIGFzIGEgY2xhc3MKICAgICAgbmFtZS4KICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgLy8gQXBwbGllcyB0aGUgJ2hpZ2gnIGNsYXNzIHRvIHRoZSB2aWV3IGVsZW1lbnQKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgICAgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgY2xhc3NOYW1lQmluZGluZ3M6IFsncHJpb3JpdHknXSwKICAgICAgICBwcmlvcml0eTogJ2hpZ2gnCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIElmIHRoZSB2YWx1ZSBvZiB0aGUgcHJvcGVydHkgaXMgYSBCb29sZWFuLCB0aGUgbmFtZSBvZiB0aGF0IHByb3BlcnR5IGlzCiAgICAgIGFkZGVkIGFzIGEgZGFzaGVyaXplZCBjbGFzcyBuYW1lLgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICAvLyBBcHBsaWVzIHRoZSAnaXMtdXJnZW50JyBjbGFzcyB0byB0aGUgdmlldyBlbGVtZW50CiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAgIENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGNsYXNzTmFtZUJpbmRpbmdzOiBbJ2lzVXJnZW50J10sCiAgICAgICAgaXNVcmdlbnQ6IHRydWUKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgSWYgeW91IHdvdWxkIHByZWZlciB0byB1c2UgYSBjdXN0b20gdmFsdWUgaW5zdGVhZCBvZiB0aGUgZGFzaGVyaXplZAogICAgICBwcm9wZXJ0eSBuYW1lLCB5b3UgY2FuIHBhc3MgYSBiaW5kaW5nIGxpa2UgdGhpczoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgLy8gQXBwbGllcyB0aGUgJ3VyZ2VudCcgY2xhc3MgdG8gdGhlIHZpZXcgZWxlbWVudAogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgICBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBjbGFzc05hbWVCaW5kaW5nczogWydpc1VyZ2VudDp1cmdlbnQnXSwKICAgICAgICBpc1VyZ2VudDogdHJ1ZQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBJZiB5b3Ugd291bGQgbGlrZSB0byBzcGVjaWZ5IGEgY2xhc3MgdGhhdCBzaG91bGQgb25seSBiZSBhZGRlZCB3aGVuIHRoZQogICAgICBwcm9wZXJ0eSBpcyBmYWxzZSwgeW91IGNhbiBkZWNsYXJlIGEgYmluZGluZyBsaWtlIHRoaXM6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIC8vIEFwcGxpZXMgdGhlICdkaXNhYmxlZCcgY2xhc3MgdG8gdGhlIHZpZXcgZWxlbWVudAogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgICBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBjbGFzc05hbWVCaW5kaW5nczogWydpc0VuYWJsZWQ6OmRpc2FibGVkJ10sCiAgICAgICAgaXNFbmFibGVkOiBmYWxzZQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBUaGlzIGxpc3Qgb2YgcHJvcGVydGllcyBpcyBpbmhlcml0ZWQgZnJvbSB0aGUgY29tcG9uZW50J3Mgc3VwZXJjbGFzc2VzIGFzIHdlbGwuCiAgICAgICBAcHJvcGVydHkgY2xhc3NOYW1lQmluZGluZ3MKICAgICAgQHR5cGUgQXJyYXkKICAgICAgQGRlZmF1bHQgW10KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGNsYXNzTmFtZUJpbmRpbmdzOiBFTVBUWV9BUlJBWQogIH0pOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi9taXhpbnMvdGV4dF9zdXBwb3J0IiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGFsIiwgIkBlbWJlci8taW50ZXJuYWxzL3J1bnRpbWUiLCAiQGVtYmVyL2RlYnVnIiwgIkBlbWJlci9kZXByZWNhdGVkLWZlYXR1cmVzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX21ldGFsLCBfcnVudGltZSwgX2RlYnVnLCBfZGVwcmVjYXRlZEZlYXR1cmVzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KICB2YXIgS0VZX0VWRU5UUyA9IHsKICAgIDEzOiAnaW5zZXJ0TmV3bGluZScsCiAgICAyNzogJ2NhbmNlbCcKICB9OwogIC8qKgogICAgYFRleHRTdXBwb3J0YCBpcyBhIHNoYXJlZCBtaXhpbiB1c2VkIGJ5IGJvdGggYFRleHRGaWVsZGAgYW5kCiAgICBgVGV4dEFyZWFgLiBgVGV4dFN1cHBvcnRgIGFkZHMgYSBudW1iZXIgb2YgbWV0aG9kcyB0aGF0IGFsbG93IHlvdSB0bwogICAgc3BlY2lmeSBhIGNvbnRyb2xsZXIgYWN0aW9uIHRvIGludm9rZSB3aGVuIGEgY2VydGFpbiBldmVudCBpcyBmaXJlZCBvbiB5b3VyCiAgICB0ZXh0IGZpZWxkIG9yIHRleHRhcmVhLiBUaGUgc3BlY2lmaWVkIGNvbnRyb2xsZXIgYWN0aW9uIHdvdWxkIGdldCB0aGUgY3VycmVudAogICAgdmFsdWUgb2YgdGhlIGZpZWxkIHBhc3NlZCBpbiBhcyB0aGUgb25seSBhcmd1bWVudCB1bmxlc3MgdGhlIHZhbHVlIG9mCiAgICB0aGUgZmllbGQgaXMgZW1wdHkuIEluIHRoYXQgY2FzZSwgdGhlIGluc3RhbmNlIG9mIHRoZSBmaWVsZCBpdHNlbGYgaXMgcGFzc2VkCiAgICBpbiBhcyB0aGUgb25seSBhcmd1bWVudC4KICAKICAgIExldCdzIHVzZSB0aGUgcHJlc3Npbmcgb2YgdGhlIGVzY2FwZSBrZXkgYXMgYW4gZXhhbXBsZS4gSWYgeW91IHdhbnRlZCB0bwogICAgaW52b2tlIGEgY29udHJvbGxlciBhY3Rpb24gd2hlbiBhIHVzZXIgcHJlc3NlcyB0aGUgZXNjYXBlIGtleSB3aGlsZSBvbiB5b3VyCiAgICBmaWVsZCwgeW91IHdvdWxkIHVzZSB0aGUgYGVzY2FwZS1wcmVzc2AgYXR0cmlidXRlIG9uIHlvdXIgZmllbGQgbGlrZSBzbzoKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3shIGFwcGxpY2F0aW9uLmhic319CiAgCiAgICAgIHt7aW5wdXQgZXNjYXBlLXByZXNzPSdhbGVydFVzZXInfX0KICAgIGBgYAogIAogICAgYGBgamF2YXNjcmlwdAogICAgICAgIGltcG9ydCBBcHBsaWNhdGlvbiBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogICAgICAgIGltcG9ydCBDb250cm9sbGVyIGZyb20gJ0BlbWJlci9jb250cm9sbGVyJzsKICAgICAgICBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoKTsKICAKICAgICAgICBBcHAuQXBwbGljYXRpb25Db250cm9sbGVyID0gQ29udHJvbGxlci5leHRlbmQoewogICAgICAgICAgYWN0aW9uczogewogICAgICAgICAgICBhbGVydFVzZXI6IGZ1bmN0aW9uICggY3VycmVudFZhbHVlICkgewogICAgICAgICAgICAgIGFsZXJ0KCAnZXNjYXBlIHByZXNzZWQsIGN1cnJlbnQgdmFsdWU6ICcgKyBjdXJyZW50VmFsdWUgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgYGBgCiAgCiAgICBUaGUgZm9sbG93aW5nIGNoYXJ0IGlzIGEgdmlzdWFsIHJlcHJlc2VudGF0aW9uIG9mIHdoYXQgdGFrZXMgcGxhY2Ugd2hlbiB0aGUKICAgIGVzY2FwZSBrZXkgaXMgcHJlc3NlZCBpbiB0aGlzIHNjZW5hcmlvOgogIAogICAgYGBgCiAgICBUaGUgVGVtcGxhdGUKICAgICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0rCiAgICB8ICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgfCBlc2NhcGUtcHJlc3M9J2FsZXJ0VXNlcicgIHwKICAgIHwgICAgICAgICAgICAgICAgICAgICAgICAgICB8ICAgICAgICAgIFRleHRTdXBwb3J0IE1peGluCiAgICArLS0tLSstLS0tLS0tLS0tLS0tLS0tLS0tLS0tKyAgICAgICAgICArLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSsKICAgICAgICAgfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2FuY2VsIG1ldGhvZCAgICAgICAgICAgICAgICAgfAogICAgICAgICB8ICAgICAgZXNjYXBlIGJ1dHRvbiBwcmVzc2VkICAgICAgfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tPiB8IGNoZWNrcyBmb3IgdGhlIGBlc2NhcGUtcHJlc3NgIHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgYXR0cmlidXRlIGFuZCBwdWxscyBvdXQgdGhlICAgfAogICAgICAgICArLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSsgfCBgYWxlcnRVc2VyYCB2YWx1ZSAgICAgICAgICAgICB8CiAgICAgICAgIHwgICAgIGFjdGlvbiBuYW1lICdhbGVydFVzZXInICAgICArLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSsKICAgICAgICAgfCAgICAgc2VudCB0byBjb250cm9sbGVyCiAgICAgICAgIHYKICAgIENvbnRyb2xsZXIKICAgICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKwogICAgfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICB8ICBhY3Rpb25zOiB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgIHwgICAgIGFsZXJ0VXNlcjogZnVuY3Rpb24oIGN1cnJlbnRWYWx1ZSApeyAgfAogICAgfCAgICAgICBhbGVydCggJ3RoZSBlc2Mga2V5IHdhcyBwcmVzc2VkIScgKSB8CiAgICB8ICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgIHwgIH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICArLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSsKICAgIGBgYAogIAogICAgSGVyZSBhcmUgdGhlIGV2ZW50cyB0aGF0IHdlIGN1cnJlbnRseSBzdXBwb3J0IGFsb25nIHdpdGggdGhlIG5hbWUgb2YgdGhlCiAgICBhdHRyaWJ1dGUgeW91IHdvdWxkIG5lZWQgdG8gdXNlIG9uIHlvdXIgZmllbGQuIFRvIHJlaXRlcmF0ZSwgeW91IHdvdWxkIHVzZSB0aGUKICAgIGF0dHJpYnV0ZSBuYW1lIGxpa2Ugc286CiAgCiAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7aW5wdXQgYXR0cmlidXRlLW5hbWU9J2NvbnRyb2xsZXJBY3Rpb24nfX0KICAgIGBgYAogIAogICAgYGBgCiAgICArLS0tLS0tLS0tLS0tLS0tLS0tLS0rLS0tLS0tLS0tLS0tLS0tLSsKICAgIHwgICAgICAgICAgICAgICAgICAgIHwgICAgICAgICAgICAgICAgfAogICAgfCBldmVudCAgICAgICAgICAgICAgfCBhdHRyaWJ1dGUgbmFtZSB8CiAgICArLS0tLS0tLS0tLS0tLS0tLS0tLS0rLS0tLS0tLS0tLS0tLS0tLSsKICAgIHwgbmV3IGxpbmUgaW5zZXJ0ZWQgIHwgaW5zZXJ0LW5ld2xpbmUgfAogICAgfCAgICAgICAgICAgICAgICAgICAgfCAgICAgICAgICAgICAgICB8CiAgICB8IGVudGVyIGtleSBwcmVzc2VkICB8IGVudGVyICAgICAgICAgIHwKICAgIHwgICAgICAgICAgICAgICAgICAgIHwgICAgICAgICAgICAgICAgfAogICAgfCBjYW5jZWwga2V5IHByZXNzZWQgfCBlc2NhcGUtcHJlc3MgICB8CiAgICB8ICAgICAgICAgICAgICAgICAgICB8ICAgICAgICAgICAgICAgIHwKICAgIHwgZm9jdXNpbiAgICAgICAgICAgIHwgZm9jdXMtaW4gICAgICAgfAogICAgfCAgICAgICAgICAgICAgICAgICAgfCAgICAgICAgICAgICAgICB8CiAgICB8IGZvY3Vzb3V0ICAgICAgICAgICB8IGZvY3VzLW91dCAgICAgIHwKICAgIHwgICAgICAgICAgICAgICAgICAgIHwgICAgICAgICAgICAgICAgfAogICAgfCBrZXlwcmVzcyAgICAgICAgICAgfCBrZXktcHJlc3MgICAgICB8CiAgICB8ICAgICAgICAgICAgICAgICAgICB8ICAgICAgICAgICAgICAgIHwKICAgIHwga2V5dXAgICAgICAgICAgICAgIHwga2V5LXVwICAgICAgICAgfAogICAgfCAgICAgICAgICAgICAgICAgICAgfCAgICAgICAgICAgICAgICB8CiAgICB8IGtleWRvd24gICAgICAgICAgICB8IGtleS1kb3duICAgICAgIHwKICAgICstLS0tLS0tLS0tLS0tLS0tLS0tLSstLS0tLS0tLS0tLS0tLS0tKwogICAgYGBgCiAgCiAgICBAY2xhc3MgVGV4dFN1cHBvcnQKICAgIEBuYW1lc3BhY2UgRW1iZXIKICAgIEB1c2VzIEVtYmVyLlRhcmdldEFjdGlvblN1cHBvcnQKICAgIEBleHRlbmRzIE1peGluCiAgICBAcHJpdmF0ZQogICovCgogIHZhciBfZGVmYXVsdCA9IF9tZXRhbC5NaXhpbi5jcmVhdGUoX3J1bnRpbWUuVGFyZ2V0QWN0aW9uU3VwcG9ydCwgewogICAgdmFsdWU6ICcnLAogICAgYXR0cmlidXRlQmluZGluZ3M6IFsnYXV0b2NhcGl0YWxpemUnLCAnYXV0b2NvcnJlY3QnLCAnYXV0b2ZvY3VzJywgJ2Rpc2FibGVkJywgJ2Zvcm0nLCAnbWF4bGVuZ3RoJywgJ21pbmxlbmd0aCcsICdwbGFjZWhvbGRlcicsICdyZWFkb25seScsICdyZXF1aXJlZCcsICdzZWxlY3Rpb25EaXJlY3Rpb24nLCAnc3BlbGxjaGVjaycsICd0YWJpbmRleCcsICd0aXRsZSddLAogICAgcGxhY2Vob2xkZXI6IG51bGwsCiAgICBkaXNhYmxlZDogZmFsc2UsCiAgICBtYXhsZW5ndGg6IG51bGwsCiAgICBpbml0OiBmdW5jdGlvbiBpbml0KCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgdGhpcy5vbigncGFzdGUnLCB0aGlzLCB0aGlzLl9lbGVtZW50VmFsdWVEaWRDaGFuZ2UpOwogICAgICB0aGlzLm9uKCdjdXQnLCB0aGlzLCB0aGlzLl9lbGVtZW50VmFsdWVEaWRDaGFuZ2UpOwogICAgICB0aGlzLm9uKCdpbnB1dCcsIHRoaXMsIHRoaXMuX2VsZW1lbnRWYWx1ZURpZENoYW5nZSk7CiAgICB9LAoKICAgIC8qKgogICAgICBXaGV0aGVyIHRoZSBga2V5VXBgIGV2ZW50IHRoYXQgdHJpZ2dlcnMgYW4gYGFjdGlvbmAgdG8gYmUgc2VudCBjb250aW51ZXMKICAgICAgcHJvcGFnYXRpbmcgdG8gb3RoZXIgdmlld3MuCiAgICAgICBCeSBkZWZhdWx0LCB3aGVuIHRoZSB1c2VyIHByZXNzZXMgdGhlIHJldHVybiBrZXkgb24gdGhlaXIga2V5Ym9hcmQgYW5kCiAgICAgIHRoZSB0ZXh0IGZpZWxkIGhhcyBhbiBgYWN0aW9uYCBzZXQsIHRoZSBhY3Rpb24gd2lsbCBiZSBzZW50IHRvIHRoZSB2aWV3J3MKICAgICAgY29udHJvbGxlciBhbmQgdGhlIGtleSBldmVudCB3aWxsIHN0b3AgcHJvcGFnYXRpbmcuCiAgICAgICBJZiB5b3Ugd291bGQgbGlrZSBwYXJlbnQgdmlld3MgdG8gcmVjZWl2ZSB0aGUgYGtleVVwYCBldmVudCBldmVuIGFmdGVyIGFuCiAgICAgIGFjdGlvbiBoYXMgYmVlbiBkaXNwYXRjaGVkLCBzZXQgYGJ1YmJsZXNgIHRvIHRydWUuCiAgICAgICBAcHJvcGVydHkgYnViYmxlcwogICAgICBAdHlwZSBCb29sZWFuCiAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgYnViYmxlczogZmFsc2UsCiAgICBpbnRlcnByZXRLZXlFdmVudHM6IGZ1bmN0aW9uIGludGVycHJldEtleUV2ZW50cyhldmVudCkgewogICAgICB2YXIgbWFwID0gS0VZX0VWRU5UUzsKICAgICAgdmFyIG1ldGhvZCA9IG1hcFtldmVudC5rZXlDb2RlXTsKCiAgICAgIHRoaXMuX2VsZW1lbnRWYWx1ZURpZENoYW5nZSgpOwoKICAgICAgaWYgKG1ldGhvZCkgewogICAgICAgIHJldHVybiB0aGlzW21ldGhvZF0oZXZlbnQpOwogICAgICB9CiAgICB9LAogICAgX2VsZW1lbnRWYWx1ZURpZENoYW5nZTogZnVuY3Rpb24gX2VsZW1lbnRWYWx1ZURpZENoYW5nZSgpIHsKICAgICAgKDAsIF9tZXRhbC5zZXQpKHRoaXMsICd2YWx1ZScsIHRoaXMuZWxlbWVudC52YWx1ZSk7CiAgICB9LAogICAgY2hhbmdlOiBmdW5jdGlvbiBjaGFuZ2UoZXZlbnQpIHsKICAgICAgdGhpcy5fZWxlbWVudFZhbHVlRGlkQ2hhbmdlKGV2ZW50KTsKICAgIH0sCgogICAgLyoqCiAgICAgIEFsbG93cyB5b3UgdG8gc3BlY2lmeSBhIGNvbnRyb2xsZXIgYWN0aW9uIHRvIGludm9rZSB3aGVuIGVpdGhlciB0aGUgYGVudGVyYAogICAgICBrZXkgaXMgcHJlc3NlZCBvciwgaW4gdGhlIGNhc2Ugb2YgdGhlIGZpZWxkIGJlaW5nIGEgdGV4dGFyZWEsIHdoZW4gYSBuZXdsaW5lCiAgICAgIGlzIGluc2VydGVkLiBUbyB1c2UgdGhpcyBtZXRob2QsIGdpdmUgeW91ciBmaWVsZCBhbiBgaW5zZXJ0LW5ld2xpbmVgCiAgICAgIGF0dHJpYnV0ZS4gVGhlIHZhbHVlIG9mIHRoYXQgYXR0cmlidXRlIHNob3VsZCBiZSB0aGUgbmFtZSBvZiB0aGUgYWN0aW9uCiAgICAgIGluIHlvdXIgY29udHJvbGxlciB0aGF0IHlvdSB3aXNoIHRvIGludm9rZS4KICAgICAgIEZvciBhbiBleGFtcGxlIG9uIGhvdyB0byB1c2UgdGhlIGBpbnNlcnQtbmV3bGluZWAgYXR0cmlidXRlLCBwbGVhc2UKICAgICAgcmVmZXJlbmNlIHRoZSBleGFtcGxlIG5lYXIgdGhlIHRvcCBvZiB0aGlzIGZpbGUuCiAgICAgICBAbWV0aG9kIGluc2VydE5ld2xpbmUKICAgICAgQHBhcmFtIHtFdmVudH0gZXZlbnQKICAgICAgQHByaXZhdGUKICAgICovCiAgICBpbnNlcnROZXdsaW5lOiBmdW5jdGlvbiBpbnNlcnROZXdsaW5lKGV2ZW50KSB7CiAgICAgIHNlbmRBY3Rpb24oJ2VudGVyJywgdGhpcywgZXZlbnQpOwogICAgICBzZW5kQWN0aW9uKCdpbnNlcnQtbmV3bGluZScsIHRoaXMsIGV2ZW50KTsKICAgIH0sCgogICAgLyoqCiAgICAgIEFsbG93cyB5b3UgdG8gc3BlY2lmeSBhIGNvbnRyb2xsZXIgYWN0aW9uIHRvIGludm9rZSB3aGVuIHRoZSBlc2NhcGUgYnV0dG9uCiAgICAgIGlzIHByZXNzZWQuIFRvIHVzZSB0aGlzIG1ldGhvZCwgZ2l2ZSB5b3VyIGZpZWxkIGFuIGBlc2NhcGUtcHJlc3NgCiAgICAgIGF0dHJpYnV0ZS4gVGhlIHZhbHVlIG9mIHRoYXQgYXR0cmlidXRlIHNob3VsZCBiZSB0aGUgbmFtZSBvZiB0aGUgYWN0aW9uCiAgICAgIGluIHlvdXIgY29udHJvbGxlciB0aGF0IHlvdSB3aXNoIHRvIGludm9rZS4KICAgICAgIEZvciBhbiBleGFtcGxlIG9uIGhvdyB0byB1c2UgdGhlIGBlc2NhcGUtcHJlc3NgIGF0dHJpYnV0ZSwgcGxlYXNlIHJlZmVyZW5jZQogICAgICB0aGUgZXhhbXBsZSBuZWFyIHRoZSB0b3Agb2YgdGhpcyBmaWxlLgogICAgICAgQG1ldGhvZCBjYW5jZWwKICAgICAgQHBhcmFtIHtFdmVudH0gZXZlbnQKICAgICAgQHByaXZhdGUKICAgICovCiAgICBjYW5jZWw6IGZ1bmN0aW9uIGNhbmNlbChldmVudCkgewogICAgICBzZW5kQWN0aW9uKCdlc2NhcGUtcHJlc3MnLCB0aGlzLCBldmVudCk7CiAgICB9LAoKICAgIC8qKgogICAgICBBbGxvd3MgeW91IHRvIHNwZWNpZnkgYSBjb250cm9sbGVyIGFjdGlvbiB0byBpbnZva2Ugd2hlbiBhIGZpZWxkIHJlY2VpdmVzCiAgICAgIGZvY3VzLiBUbyB1c2UgdGhpcyBtZXRob2QsIGdpdmUgeW91ciBmaWVsZCBhIGBmb2N1cy1pbmAgYXR0cmlidXRlLiBUaGUgdmFsdWUKICAgICAgb2YgdGhhdCBhdHRyaWJ1dGUgc2hvdWxkIGJlIHRoZSBuYW1lIG9mIHRoZSBhY3Rpb24gaW4geW91ciBjb250cm9sbGVyCiAgICAgIHRoYXQgeW91IHdpc2ggdG8gaW52b2tlLgogICAgICAgRm9yIGFuIGV4YW1wbGUgb24gaG93IHRvIHVzZSB0aGUgYGZvY3VzLWluYCBhdHRyaWJ1dGUsIHBsZWFzZSByZWZlcmVuY2UgdGhlCiAgICAgIGV4YW1wbGUgbmVhciB0aGUgdG9wIG9mIHRoaXMgZmlsZS4KICAgICAgIEBtZXRob2QgZm9jdXNJbgogICAgICBAcGFyYW0ge0V2ZW50fSBldmVudAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGZvY3VzSW46IGZ1bmN0aW9uIGZvY3VzSW4oZXZlbnQpIHsKICAgICAgc2VuZEFjdGlvbignZm9jdXMtaW4nLCB0aGlzLCBldmVudCk7CiAgICB9LAoKICAgIC8qKgogICAgICBBbGxvd3MgeW91IHRvIHNwZWNpZnkgYSBjb250cm9sbGVyIGFjdGlvbiB0byBpbnZva2Ugd2hlbiBhIGZpZWxkIGxvc2VzCiAgICAgIGZvY3VzLiBUbyB1c2UgdGhpcyBtZXRob2QsIGdpdmUgeW91ciBmaWVsZCBhIGBmb2N1cy1vdXRgIGF0dHJpYnV0ZS4gVGhlIHZhbHVlCiAgICAgIG9mIHRoYXQgYXR0cmlidXRlIHNob3VsZCBiZSB0aGUgbmFtZSBvZiB0aGUgYWN0aW9uIGluIHlvdXIgY29udHJvbGxlcgogICAgICB0aGF0IHlvdSB3aXNoIHRvIGludm9rZS4KICAgICAgIEZvciBhbiBleGFtcGxlIG9uIGhvdyB0byB1c2UgdGhlIGBmb2N1cy1vdXRgIGF0dHJpYnV0ZSwgcGxlYXNlIHJlZmVyZW5jZSB0aGUKICAgICAgZXhhbXBsZSBuZWFyIHRoZSB0b3Agb2YgdGhpcyBmaWxlLgogICAgICAgQG1ldGhvZCBmb2N1c091dAogICAgICBAcGFyYW0ge0V2ZW50fSBldmVudAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGZvY3VzT3V0OiBmdW5jdGlvbiBmb2N1c091dChldmVudCkgewogICAgICB0aGlzLl9lbGVtZW50VmFsdWVEaWRDaGFuZ2UoZXZlbnQpOwoKICAgICAgc2VuZEFjdGlvbignZm9jdXMtb3V0JywgdGhpcywgZXZlbnQpOwogICAgfSwKCiAgICAvKioKICAgICAgQWxsb3dzIHlvdSB0byBzcGVjaWZ5IGEgY29udHJvbGxlciBhY3Rpb24gdG8gaW52b2tlIHdoZW4gYSBrZXkgaXMgcHJlc3NlZC4KICAgICAgVG8gdXNlIHRoaXMgbWV0aG9kLCBnaXZlIHlvdXIgZmllbGQgYSBga2V5LXByZXNzYCBhdHRyaWJ1dGUuIFRoZSB2YWx1ZSBvZgogICAgICB0aGF0IGF0dHJpYnV0ZSBzaG91bGQgYmUgdGhlIG5hbWUgb2YgdGhlIGFjdGlvbiBpbiB5b3VyIGNvbnRyb2xsZXIgeW91CiAgICAgIHRoYXQgd2lzaCB0byBpbnZva2UuCiAgICAgICBGb3IgYW4gZXhhbXBsZSBvbiBob3cgdG8gdXNlIHRoZSBga2V5LXByZXNzYCBhdHRyaWJ1dGUsIHBsZWFzZSByZWZlcmVuY2UgdGhlCiAgICAgIGV4YW1wbGUgbmVhciB0aGUgdG9wIG9mIHRoaXMgZmlsZS4KICAgICAgIEBtZXRob2Qga2V5UHJlc3MKICAgICAgQHBhcmFtIHtFdmVudH0gZXZlbnQKICAgICAgQHByaXZhdGUKICAgICovCiAgICBrZXlQcmVzczogZnVuY3Rpb24ga2V5UHJlc3MoZXZlbnQpIHsKICAgICAgc2VuZEFjdGlvbigna2V5LXByZXNzJywgdGhpcywgZXZlbnQpOwogICAgfSwKCiAgICAvKioKICAgICAgQWxsb3dzIHlvdSB0byBzcGVjaWZ5IGEgY29udHJvbGxlciBhY3Rpb24gdG8gaW52b2tlIHdoZW4gYSBrZXktdXAgZXZlbnQgaXMKICAgICAgZmlyZWQuIFRvIHVzZSB0aGlzIG1ldGhvZCwgZ2l2ZSB5b3VyIGZpZWxkIGEgYGtleS11cGAgYXR0cmlidXRlLiBUaGUgdmFsdWUKICAgICAgb2YgdGhhdCBhdHRyaWJ1dGUgc2hvdWxkIGJlIHRoZSBuYW1lIG9mIHRoZSBhY3Rpb24gaW4geW91ciBjb250cm9sbGVyCiAgICAgIHRoYXQgeW91IHdpc2ggdG8gaW52b2tlLgogICAgICAgRm9yIGFuIGV4YW1wbGUgb24gaG93IHRvIHVzZSB0aGUgYGtleS11cGAgYXR0cmlidXRlLCBwbGVhc2UgcmVmZXJlbmNlIHRoZQogICAgICBleGFtcGxlIG5lYXIgdGhlIHRvcCBvZiB0aGlzIGZpbGUuCiAgICAgICBAbWV0aG9kIGtleVVwCiAgICAgIEBwYXJhbSB7RXZlbnR9IGV2ZW50CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAga2V5VXA6IGZ1bmN0aW9uIGtleVVwKGV2ZW50KSB7CiAgICAgIHRoaXMuaW50ZXJwcmV0S2V5RXZlbnRzKGV2ZW50KTsKICAgICAgc2VuZEFjdGlvbigna2V5LXVwJywgdGhpcywgZXZlbnQpOwogICAgfSwKCiAgICAvKioKICAgICAgQWxsb3dzIHlvdSB0byBzcGVjaWZ5IGEgY29udHJvbGxlciBhY3Rpb24gdG8gaW52b2tlIHdoZW4gYSBrZXktZG93biBldmVudCBpcwogICAgICBmaXJlZC4gVG8gdXNlIHRoaXMgbWV0aG9kLCBnaXZlIHlvdXIgZmllbGQgYSBga2V5LWRvd25gIGF0dHJpYnV0ZS4gVGhlIHZhbHVlCiAgICAgIG9mIHRoYXQgYXR0cmlidXRlIHNob3VsZCBiZSB0aGUgbmFtZSBvZiB0aGUgYWN0aW9uIGluIHlvdXIgY29udHJvbGxlciB0aGF0CiAgICAgIHlvdSB3aXNoIHRvIGludm9rZS4KICAgICAgIEZvciBhbiBleGFtcGxlIG9uIGhvdyB0byB1c2UgdGhlIGBrZXktZG93bmAgYXR0cmlidXRlLCBwbGVhc2UgcmVmZXJlbmNlIHRoZQogICAgICBleGFtcGxlIG5lYXIgdGhlIHRvcCBvZiB0aGlzIGZpbGUuCiAgICAgICBAbWV0aG9kIGtleURvd24KICAgICAgQHBhcmFtIHtFdmVudH0gZXZlbnQKICAgICAgQHByaXZhdGUKICAgICovCiAgICBrZXlEb3duOiBmdW5jdGlvbiBrZXlEb3duKGV2ZW50KSB7CiAgICAgIHNlbmRBY3Rpb24oJ2tleS1kb3duJywgdGhpcywgZXZlbnQpOwogICAgfQogIH0pOyAvLyBJbiBwcmluY2lwbGUsIHRoaXMgc2hvdWxkbid0IGJlIG5lY2Vzc2FyeSwgYnV0IHRoZSBsZWdhY3kKICAvLyBzZW5kQWN0aW9uIHNlbWFudGljcyBmb3IgVGV4dEZpZWxkIGFyZSBkaWZmZXJlbnQgZnJvbQogIC8vIHRoZSBjb21wb25lbnQgc2VtYW50aWNzIHNvIHRoaXMgbWV0aG9kIG5vcm1hbGl6ZXMgdGhlbS4KCgogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKCiAgZnVuY3Rpb24gc2VuZEFjdGlvbihldmVudE5hbWUsIHZpZXcsIGV2ZW50KSB7CiAgICB2YXIgYWN0aW9uTmFtZSA9ICgwLCBfbWV0YWwuZ2V0KSh2aWV3LCAiYXR0cnMuIiArIGV2ZW50TmFtZSkgfHwgKDAsIF9tZXRhbC5nZXQpKHZpZXcsIGV2ZW50TmFtZSk7CiAgICB2YXIgdmFsdWUgPSAoMCwgX21ldGFsLmdldCkodmlldywgJ3ZhbHVlJyk7CgogICAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuU0VORF9BQ1RJT04gJiYgdHlwZW9mIGFjdGlvbk5hbWUgPT09ICdzdHJpbmcnKSB7CiAgICAgIHZhciBtZXNzYWdlID0gIlBhc3NpbmcgYWN0aW9ucyB0byBjb21wb25lbnRzIGFzIHN0cmluZ3MgKGxpa2UgYDxJbnB1dCBAIiArIGV2ZW50TmFtZSArICI9XCIiICsgYWN0aW9uTmFtZSArICJcIiAvPmApIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSB1c2UgY2xvc3VyZSBhY3Rpb25zIGluc3RlYWQgKGA8SW5wdXQgQCIgKyBldmVudE5hbWUgKyAiPXt7YWN0aW9uIFwiIiArIGFjdGlvbk5hbWUgKyAiXCJ9fSAvPmApLiI7CiAgICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkobWVzc2FnZSwgZmFsc2UsIHsKICAgICAgICBpZDogJ2VtYmVyLWNvbXBvbmVudC5zZW5kLWFjdGlvbicsCiAgICAgICAgdW50aWw6ICc0LjAuMCcsCiAgICAgICAgdXJsOiAnaHR0cHM6Ly9lbWJlcmpzLmNvbS9kZXByZWNhdGlvbnMvdjMueCN0b2NfZW1iZXItY29tcG9uZW50LXNlbmQtYWN0aW9uJwogICAgICB9KSk7CiAgICAgIHZpZXcudHJpZ2dlckFjdGlvbih7CiAgICAgICAgYWN0aW9uOiBhY3Rpb25OYW1lLAogICAgICAgIGFjdGlvbkNvbnRleHQ6IFt2YWx1ZSwgZXZlbnRdCiAgICAgIH0pOwogICAgfSBlbHNlIGlmICh0eXBlb2YgYWN0aW9uTmFtZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBhY3Rpb25OYW1lKHZhbHVlLCBldmVudCk7CiAgICB9CgogICAgaWYgKGFjdGlvbk5hbWUgJiYgISgwLCBfbWV0YWwuZ2V0KSh2aWV3LCAnYnViYmxlcycpKSB7CiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgfQogIH0KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvdmlld3MvbGliL21peGlucy92aWV3X3N0YXRlX3N1cHBvcnQiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfbWV0YWwpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwogIHZhciBfZGVmYXVsdCA9IF9tZXRhbC5NaXhpbi5jcmVhdGUoewogICAgX3RyYW5zaXRpb25UbzogZnVuY3Rpb24gX3RyYW5zaXRpb25UbyhzdGF0ZSkgewogICAgICB2YXIgcHJpb3JTdGF0ZSA9IHRoaXMuX2N1cnJlbnRTdGF0ZTsKICAgICAgdmFyIGN1cnJlbnRTdGF0ZSA9IHRoaXMuX2N1cnJlbnRTdGF0ZSA9IHRoaXMuX3N0YXRlc1tzdGF0ZV07CiAgICAgIHRoaXMuX3N0YXRlID0gc3RhdGU7CgogICAgICBpZiAocHJpb3JTdGF0ZSAmJiBwcmlvclN0YXRlLmV4aXQpIHsKICAgICAgICBwcmlvclN0YXRlLmV4aXQodGhpcyk7CiAgICAgIH0KCiAgICAgIGlmIChjdXJyZW50U3RhdGUuZW50ZXIpIHsKICAgICAgICBjdXJyZW50U3RhdGUuZW50ZXIodGhpcyk7CiAgICAgIH0KICAgIH0KICB9KTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvbWl4aW5zL3ZpZXdfc3VwcG9ydCIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy91dGlscyIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCIsICJAZW1iZXIvZGVidWciLCAiQGVtYmVyLy1pbnRlcm5hbHMvYnJvd3Nlci1lbnZpcm9ubWVudCIsICJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvc3lzdGVtL3V0aWxzIiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi9zeXN0ZW0vanF1ZXJ5IiwgIkBlbWJlci9kZXByZWNhdGVkLWZlYXR1cmVzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX3V0aWxzLCBfbWV0YWwsIF9kZWJ1ZywgX2Jyb3dzZXJFbnZpcm9ubWVudCwgX3V0aWxzMiwgX2pxdWVyeSwgX2RlcHJlY2F0ZWRGZWF0dXJlcykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgZnVuY3Rpb24gSygpIHsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgdmFyIG1peGluID0gewogICAgLyoqCiAgICAgQSBsaXN0IG9mIHByb3BlcnRpZXMgb2YgdGhlIHZpZXcgdG8gYXBwbHkgYXMgYXR0cmlidXRlcy4gSWYgdGhlIHByb3BlcnR5CiAgICAgaXMgYSBzdHJpbmcgdmFsdWUsIHRoZSB2YWx1ZSBvZiB0aGF0IHN0cmluZyB3aWxsIGJlIGFwcGxpZWQgYXMgdGhlIHZhbHVlCiAgICAgZm9yIGFuIGF0dHJpYnV0ZSBvZiB0aGUgcHJvcGVydHkncyBuYW1lLgogICAgICBUaGUgZm9sbG93aW5nIGV4YW1wbGUgY3JlYXRlcyBhIHRhZyBsaWtlIGA8ZGl2IHByaW9yaXR5PSJoaWdoIiAvPmAuCiAgICAgIGBgYGFwcC9jb21wb25lbnRzL215LWNvbXBvbmVudC5qcwogICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ3ByaW9yaXR5J10sCiAgICAgICAgcHJpb3JpdHk6ICdoaWdoJwogICAgICB9KTsKICAgICBgYGAKICAgICAgSWYgdGhlIHZhbHVlIG9mIHRoZSBwcm9wZXJ0eSBpcyBhIEJvb2xlYW4sIHRoZSBhdHRyaWJ1dGUgaXMgdHJlYXRlZCBhcwogICAgIGFuIEhUTUwgQm9vbGVhbiBhdHRyaWJ1dGUuIEl0IHdpbGwgYmUgcHJlc2VudCBpZiB0aGUgcHJvcGVydHkgaXMgYHRydWVgCiAgICAgYW5kIG9taXR0ZWQgaWYgdGhlIHByb3BlcnR5IGlzIGBmYWxzZWAuCiAgICAgIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBjcmVhdGVzIG1hcmt1cCBsaWtlIGA8ZGl2IHZpc2libGUgLz5gLgogICAgICBgYGBhcHAvY29tcG9uZW50cy9teS1jb21wb25lbnQuanMKICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBhdHRyaWJ1dGVCaW5kaW5nczogWyd2aXNpYmxlJ10sCiAgICAgICAgdmlzaWJsZTogdHJ1ZQogICAgICB9KTsKICAgICBgYGAKICAgICAgSWYgeW91IHdvdWxkIHByZWZlciB0byB1c2UgYSBjdXN0b20gdmFsdWUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkgbmFtZSwKICAgICB5b3UgY2FuIGNyZWF0ZSB0aGUgc2FtZSBtYXJrdXAgYXMgdGhlIGxhc3QgZXhhbXBsZSB3aXRoIGEgYmluZGluZyBsaWtlCiAgICAgdGhpczoKICAgICAgYGBgYXBwL2NvbXBvbmVudHMvbXktY29tcG9uZW50LmpzCiAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgYXR0cmlidXRlQmluZGluZ3M6IFsnaXNWaXNpYmxlOnZpc2libGUnXSwKICAgICAgICBpc1Zpc2libGU6IHRydWUKICAgICAgfSk7CiAgICAgYGBgCiAgICAgIFRoaXMgbGlzdCBvZiBhdHRyaWJ1dGVzIGlzIGluaGVyaXRlZCBmcm9tIHRoZSBjb21wb25lbnQncyBzdXBlcmNsYXNzZXMsCiAgICAgYXMgd2VsbC4KICAgICAgQHByb3BlcnR5IGF0dHJpYnV0ZUJpbmRpbmdzCiAgICAgQHR5cGUgQXJyYXkKICAgICBAZGVmYXVsdCBbXQogICAgIEBwdWJsaWMKICAgICAqLwogICAgY29uY2F0ZW5hdGVkUHJvcGVydGllczogWydhdHRyaWJ1dGVCaW5kaW5ncyddLAogICAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogICAgLy8gVEVNUExBVEUgU1VQUE9SVAogICAgLy8KCiAgICAvKioKICAgICBSZXR1cm4gdGhlIG5lYXJlc3QgYW5jZXN0b3IgdGhhdCBpcyBhbiBpbnN0YW5jZSBvZiB0aGUgcHJvdmlkZWQKICAgICBjbGFzcyBvciBtaXhpbi4KICAgICAgQG1ldGhvZCBuZWFyZXN0T2ZUeXBlCiAgICAgQHBhcmFtIHtDbGFzcyxNaXhpbn0ga2xhc3MgU3ViY2xhc3Mgb2YgRW1iZXIuVmlldyAob3IgRW1iZXIuVmlldyBpdHNlbGYpLAogICAgIG9yIGFuIGluc3RhbmNlIG9mIE1peGluLgogICAgIEByZXR1cm4gRW1iZXIuVmlldwogICAgIEBkZXByZWNhdGVkIHVzZSBgeWllbGRgIGFuZCBjb250ZXh0dWFsIGNvbXBvbmVudHMgZm9yIGNvbXBvc2l0aW9uIGluc3RlYWQuCiAgICAgQHByaXZhdGUKICAgICAqLwogICAgbmVhcmVzdE9mVHlwZTogZnVuY3Rpb24gbmVhcmVzdE9mVHlwZShrbGFzcykgewogICAgICB2YXIgdmlldyA9IHRoaXMucGFyZW50VmlldzsKICAgICAgdmFyIGlzT2ZUeXBlID0ga2xhc3MgaW5zdGFuY2VvZiBfbWV0YWwuTWl4aW4gPyBmdW5jdGlvbiAodmlldykgewogICAgICAgIHJldHVybiBrbGFzcy5kZXRlY3Qodmlldyk7CiAgICAgIH0gOiBmdW5jdGlvbiAodmlldykgewogICAgICAgIHJldHVybiBrbGFzcy5kZXRlY3Qodmlldy5jb25zdHJ1Y3Rvcik7CiAgICAgIH07CgogICAgICB3aGlsZSAodmlldykgewogICAgICAgIGlmIChpc09mVHlwZSh2aWV3KSkgewogICAgICAgICAgcmV0dXJuIHZpZXc7CiAgICAgICAgfQoKICAgICAgICB2aWV3ID0gdmlldy5wYXJlbnRWaWV3OwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgIFJldHVybiB0aGUgbmVhcmVzdCBhbmNlc3RvciB0aGF0IGhhcyBhIGdpdmVuIHByb3BlcnR5LgogICAgICBAbWV0aG9kIG5lYXJlc3RXaXRoUHJvcGVydHkKICAgICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgQSBwcm9wZXJ0eSBuYW1lCiAgICAgQHJldHVybiBFbWJlci5WaWV3CiAgICAgQGRlcHJlY2F0ZWQgdXNlIGB5aWVsZGAgYW5kIGNvbnRleHR1YWwgY29tcG9uZW50cyBmb3IgY29tcG9zaXRpb24gaW5zdGVhZC4KICAgICBAcHJpdmF0ZQogICAgICovCiAgICBuZWFyZXN0V2l0aFByb3BlcnR5OiBmdW5jdGlvbiBuZWFyZXN0V2l0aFByb3BlcnR5KHByb3BlcnR5KSB7CiAgICAgIHZhciB2aWV3ID0gdGhpcy5wYXJlbnRWaWV3OwoKICAgICAgd2hpbGUgKHZpZXcpIHsKICAgICAgICBpZiAocHJvcGVydHkgaW4gdmlldykgewogICAgICAgICAgcmV0dXJuIHZpZXc7CiAgICAgICAgfQoKICAgICAgICB2aWV3ID0gdmlldy5wYXJlbnRWaWV3OwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgIFJlbmRlcnMgdGhlIHZpZXcgYWdhaW4uIFRoaXMgd2lsbCB3b3JrIHJlZ2FyZGxlc3Mgb2Ygd2hldGhlciB0aGUKICAgICB2aWV3IGlzIGFscmVhZHkgaW4gdGhlIERPTSBvciBub3QuIElmIHRoZSB2aWV3IGlzIGluIHRoZSBET00sIHRoZQogICAgIHJlbmRlcmluZyBwcm9jZXNzIHdpbGwgYmUgZGVmZXJyZWQgdG8gZ2l2ZSBiaW5kaW5ncyBhIGNoYW5jZQogICAgIHRvIHN5bmNocm9uaXplLgogICAgICBJZiBjaGlsZHJlbiB3ZXJlIGFkZGVkIGR1cmluZyB0aGUgcmVuZGVyaW5nIHByb2Nlc3MgdXNpbmcgYGFwcGVuZENoaWxkYCwKICAgICBgcmVyZW5kZXJgIHdpbGwgcmVtb3ZlIHRoZW0sIGJlY2F1c2UgdGhleSB3aWxsIGJlIGFkZGVkIGFnYWluCiAgICAgaWYgbmVlZGVkIGJ5IHRoZSBuZXh0IGByZW5kZXJgLgogICAgICBJbiBnZW5lcmFsLCBpZiB0aGUgZGlzcGxheSBvZiB5b3VyIHZpZXcgY2hhbmdlcywgeW91IHNob3VsZCBtb2RpZnkKICAgICB0aGUgRE9NIGVsZW1lbnQgZGlyZWN0bHkgaW5zdGVhZCBvZiBtYW51YWxseSBjYWxsaW5nIGByZXJlbmRlcmAsIHdoaWNoIGNhbgogICAgIGJlIHNsb3cuCiAgICAgIEBtZXRob2QgcmVyZW5kZXIKICAgICBAcHVibGljCiAgICAgKi8KICAgIHJlcmVuZGVyOiBmdW5jdGlvbiByZXJlbmRlcigpIHsKICAgICAgcmV0dXJuIHRoaXMuX2N1cnJlbnRTdGF0ZS5yZXJlbmRlcih0aGlzKTsKICAgIH0sCiAgICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgICAvLyBFTEVNRU5UIFNVUFBPUlQKICAgIC8vCgogICAgLyoqCiAgICAgUmV0dXJucyB0aGUgY3VycmVudCBET00gZWxlbWVudCBmb3IgdGhlIHZpZXcuCiAgICAgICBAcHJvcGVydHkgZWxlbWVudAogICAgICBAdHlwZSBET01FbGVtZW50CiAgICAgIEBwdWJsaWMKICAgICovCiAgICBlbGVtZW50OiAoMCwgX21ldGFsLm5hdGl2ZURlc2NEZWNvcmF0b3IpKHsKICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLnJlbmRlcmVyLmdldEVsZW1lbnQodGhpcyk7CiAgICAgIH0KICAgIH0pLAoKICAgIC8qKgogICAgIEFwcGVuZHMgdGhlIHZpZXcncyBlbGVtZW50IHRvIHRoZSBzcGVjaWZpZWQgcGFyZW50IGVsZW1lbnQuCiAgICAgIE5vdGUgdGhhdCB0aGlzIG1ldGhvZCBqdXN0IHNjaGVkdWxlcyB0aGUgdmlldyB0byBiZSBhcHBlbmRlZDsgdGhlIERPTQogICAgIGVsZW1lbnQgd2lsbCBub3QgYmUgYXBwZW5kZWQgdG8gdGhlIGdpdmVuIGVsZW1lbnQgdW50aWwgYWxsIGJpbmRpbmdzIGhhdmUKICAgICBmaW5pc2hlZCBzeW5jaHJvbml6aW5nLgogICAgICBUaGlzIGlzIG5vdCB0eXBpY2FsbHkgYSBmdW5jdGlvbiB0aGF0IHlvdSB3aWxsIG5lZWQgdG8gY2FsbCBkaXJlY3RseSB3aGVuCiAgICAgYnVpbGRpbmcgeW91ciBhcHBsaWNhdGlvbi4gSWYgeW91IGRvIG5lZWQgdG8gdXNlIGBhcHBlbmRUb2AsIGJlIHN1cmUgdGhhdAogICAgIHRoZSB0YXJnZXQgZWxlbWVudCB5b3UgYXJlIHByb3ZpZGluZyBpcyBhc3NvY2lhdGVkIHdpdGggYW4gYEFwcGxpY2F0aW9uYAogICAgIGFuZCBkb2VzIG5vdCBoYXZlIGFuIGFuY2VzdG9yIGVsZW1lbnQgdGhhdCBpcyBhc3NvY2lhdGVkIHdpdGggYW4gRW1iZXIgdmlldy4KICAgICAgQG1ldGhvZCBhcHBlbmRUbwogICAgIEBwYXJhbSB7U3RyaW5nfERPTUVsZW1lbnR8alF1ZXJ5fSBBIHNlbGVjdG9yLCBlbGVtZW50LCBIVE1MIHN0cmluZywgb3IgalF1ZXJ5IG9iamVjdAogICAgIEByZXR1cm4ge0VtYmVyLlZpZXd9IHJlY2VpdmVyCiAgICAgQHByaXZhdGUKICAgICAqLwogICAgYXBwZW5kVG86IGZ1bmN0aW9uIGFwcGVuZFRvKHNlbGVjdG9yKSB7CiAgICAgIHZhciB0YXJnZXQ7CgogICAgICBpZiAoX2Jyb3dzZXJFbnZpcm9ubWVudC5oYXNET00pIHsKICAgICAgICB0YXJnZXQgPSB0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnID8gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3RvcikgOiBzZWxlY3RvcjsKICAgICAgICAoZmFsc2UgJiYgISh0YXJnZXQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IHRyaWVkIHRvIGFwcGVuZCB0byAoIiArIHNlbGVjdG9yICsgIikgYnV0IHRoYXQgaXNuJ3QgaW4gdGhlIERPTSIsIHRhcmdldCkpOwogICAgICAgIChmYWxzZSAmJiAhKCEoMCwgX3V0aWxzMi5tYXRjaGVzKSh0YXJnZXQsICcuZW1iZXItdmlldycpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW5ub3QgYXBwZW5kIHRvIGFuIGV4aXN0aW5nIEVtYmVyLlZpZXcuJywgISgwLCBfdXRpbHMyLm1hdGNoZXMpKHRhcmdldCwgJy5lbWJlci12aWV3JykpKTsKICAgICAgICAoZmFsc2UgJiYgIShmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHRhcmdldC5wYXJlbnROb2RlOwoKICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlICE9PSA5ICYmICgwLCBfdXRpbHMyLm1hdGNoZXMpKG5vZGUsICcuZW1iZXItdmlldycpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0oKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgY2Fubm90IGFwcGVuZCB0byBhbiBleGlzdGluZyBFbWJlci5WaWV3LicsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBub2RlID0gdGFyZ2V0LnBhcmVudE5vZGU7CgogICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgIT09IDkgJiYgKDAsIF91dGlsczIubWF0Y2hlcykobm9kZSwgJy5lbWJlci12aWV3JykpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSgpKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGFyZ2V0ID0gc2VsZWN0b3I7CiAgICAgICAgKGZhbHNlICYmICEodHlwZW9mIHRhcmdldCAhPT0gJ3N0cmluZycpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IHRyaWVkIHRvIGFwcGVuZCB0byBhIHNlbGVjdG9yIHN0cmluZyAoIiArIHNlbGVjdG9yICsgIikgaW4gYW4gZW52aXJvbm1lbnQgd2l0aG91dCBqUXVlcnkiLCB0eXBlb2YgdGFyZ2V0ICE9PSAnc3RyaW5nJykpOwogICAgICAgIChmYWxzZSAmJiAhKHR5cGVvZiBzZWxlY3Rvci5hcHBlbmRDaGlsZCA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJZb3UgdHJpZWQgdG8gYXBwZW5kIHRvIGEgbm9uLUVsZW1lbnQgKCIgKyBzZWxlY3RvciArICIpIGluIGFuIGVudmlyb25tZW50IHdpdGhvdXQgalF1ZXJ5IiwgdHlwZW9mIHNlbGVjdG9yLmFwcGVuZENoaWxkID09PSAnZnVuY3Rpb24nKSk7CiAgICAgIH0KCiAgICAgIHRoaXMucmVuZGVyZXIuYXBwZW5kVG8odGhpcywgdGFyZ2V0KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8qKgogICAgIEFwcGVuZHMgdGhlIHZpZXcncyBlbGVtZW50IHRvIHRoZSBkb2N1bWVudCBib2R5LiBJZiB0aGUgdmlldyBkb2VzCiAgICAgbm90IGhhdmUgYW4gSFRNTCByZXByZXNlbnRhdGlvbiB5ZXQKICAgICB0aGUgZWxlbWVudCB3aWxsIGJlIGdlbmVyYXRlZCBhdXRvbWF0aWNhbGx5LgogICAgICBJZiB5b3VyIGFwcGxpY2F0aW9uIHVzZXMgdGhlIGByb290RWxlbWVudGAgcHJvcGVydHksIHlvdSBtdXN0IGFwcGVuZAogICAgIHRoZSB2aWV3IHdpdGhpbiB0aGF0IGVsZW1lbnQuIFJlbmRlcmluZyB2aWV3cyBvdXRzaWRlIG9mIHRoZSBgcm9vdEVsZW1lbnRgCiAgICAgaXMgbm90IHN1cHBvcnRlZC4KICAgICAgTm90ZSB0aGF0IHRoaXMgbWV0aG9kIGp1c3Qgc2NoZWR1bGVzIHRoZSB2aWV3IHRvIGJlIGFwcGVuZGVkOyB0aGUgRE9NCiAgICAgZWxlbWVudCB3aWxsIG5vdCBiZSBhcHBlbmRlZCB0byB0aGUgZG9jdW1lbnQgYm9keSB1bnRpbCBhbGwgYmluZGluZ3MgaGF2ZQogICAgIGZpbmlzaGVkIHN5bmNocm9uaXppbmcuCiAgICAgIEBtZXRob2QgYXBwZW5kCiAgICAgQHJldHVybiB7RW1iZXIuVmlld30gcmVjZWl2ZXIKICAgICBAcHJpdmF0ZQogICAgICovCiAgICBhcHBlbmQ6IGZ1bmN0aW9uIGFwcGVuZCgpIHsKICAgICAgcmV0dXJuIHRoaXMuYXBwZW5kVG8oZG9jdW1lbnQuYm9keSk7CiAgICB9LAoKICAgIC8qKgogICAgIFRoZSBIVE1MIGBpZGAgb2YgdGhlIHZpZXcncyBlbGVtZW50IGluIHRoZSBET00uIFlvdSBjYW4gcHJvdmlkZSB0aGlzCiAgICAgdmFsdWUgeW91cnNlbGYgYnV0IGl0IG11c3QgYmUgdW5pcXVlIChqdXN0IGFzIGluIEhUTUwpOgogICAgICBgYGBoYW5kbGViYXJzCiAgICAge3tteS1jb21wb25lbnQgZWxlbWVudElkPSJhLXJlYWxseS1jb29sLWlkIn19CiAgICAgYGBgCiAgICAgIElmIG5vdCBtYW51YWxseSBzZXQgYSBkZWZhdWx0IHZhbHVlIHdpbGwgYmUgcHJvdmlkZWQgYnkgdGhlIGZyYW1ld29yay4KICAgICAgT25jZSByZW5kZXJlZCBhbiBlbGVtZW50J3MgYGVsZW1lbnRJZGAgaXMgY29uc2lkZXJlZCBpbW11dGFibGUgYW5kIHlvdQogICAgIHNob3VsZCBuZXZlciBjaGFuZ2UgaXQuIElmIHlvdSBuZWVkIHRvIGNvbXB1dGUgYSBkeW5hbWljIHZhbHVlIGZvciB0aGUKICAgICBgZWxlbWVudElkYCwgeW91IHNob3VsZCBkbyB0aGlzIHdoZW4gdGhlIGNvbXBvbmVudCBvciBlbGVtZW50IGlzIGJlaW5nCiAgICAgaW5zdGFudGlhdGVkOgogICAgICBgYGBhcHAvY29tcG9uZW50cy9teS1jb21wb25lbnQuanMKICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBpbml0KCkgewogICAgICAgICAgdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgICAgICAgIGxldCBpbmRleCA9IHRoaXMuZ2V0KCdpbmRleCcpOwogICAgICAgICAgdGhpcy5zZXQoJ2VsZW1lbnRJZCcsICdjb21wb25lbnQtaWQnICsgaW5kZXgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgYGBgCiAgICAgIEBwcm9wZXJ0eSBlbGVtZW50SWQKICAgICBAdHlwZSBTdHJpbmcKICAgICBAcHVibGljCiAgICAgKi8KICAgIGVsZW1lbnRJZDogbnVsbCwKCiAgICAvKioKICAgICBDYWxsZWQgd2hlbiBhIHZpZXcgaXMgZ29pbmcgdG8gaW5zZXJ0IGFuIGVsZW1lbnQgaW50byB0aGUgRE9NLgogICAgICBAZXZlbnQgd2lsbEluc2VydEVsZW1lbnQKICAgICBAcHVibGljCiAgICAgKi8KICAgIHdpbGxJbnNlcnRFbGVtZW50OiBLLAoKICAgIC8qKgogICAgIENhbGxlZCB3aGVuIHRoZSBlbGVtZW50IG9mIHRoZSB2aWV3IGhhcyBiZWVuIGluc2VydGVkIGludG8gdGhlIERPTS4KICAgICBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGRvIGFueSBzZXQgdXAgdGhhdCByZXF1aXJlcyBhbiBlbGVtZW50CiAgICAgaW4gdGhlIGRvY3VtZW50IGJvZHkuCiAgICAgIFdoZW4gYSB2aWV3IGhhcyBjaGlsZHJlbiwgZGlkSW5zZXJ0RWxlbWVudCB3aWxsIGJlIGNhbGxlZCBvbiB0aGUKICAgICBjaGlsZCB2aWV3KHMpIGZpcnN0IGFuZCBvbiBpdHNlbGYgYWZ0ZXJ3YXJkcy4KICAgICAgQGV2ZW50IGRpZEluc2VydEVsZW1lbnQKICAgICBAcHVibGljCiAgICAgKi8KICAgIGRpZEluc2VydEVsZW1lbnQ6IEssCgogICAgLyoqCiAgICAgQ2FsbGVkIHdoZW4gdGhlIHZpZXcgaXMgYWJvdXQgdG8gcmVyZW5kZXIsIGJ1dCBiZWZvcmUgYW55dGhpbmcgaGFzCiAgICAgYmVlbiB0b3JuIGRvd24uIFRoaXMgaXMgYSBnb29kIG9wcG9ydHVuaXR5IHRvIHRlYXIgZG93biBhbnkgbWFudWFsCiAgICAgb2JzZXJ2ZXJzIHlvdSBoYXZlIGluc3RhbGxlZCBiYXNlZCBvbiB0aGUgRE9NIHN0YXRlCiAgICAgIEBldmVudCB3aWxsQ2xlYXJSZW5kZXIKICAgICBAcHVibGljCiAgICAgKi8KICAgIHdpbGxDbGVhclJlbmRlcjogSywKCiAgICAvKioKICAgICBZb3UgbXVzdCBjYWxsIGBkZXN0cm95YCBvbiBhIHZpZXcgdG8gZGVzdHJveSB0aGUgdmlldyAoYW5kIGFsbCBvZiBpdHMKICAgICBjaGlsZCB2aWV3cykuIFRoaXMgd2lsbCByZW1vdmUgdGhlIHZpZXcgZnJvbSBhbnkgcGFyZW50IG5vZGUsIHRoZW4gbWFrZQogICAgIHN1cmUgdGhhdCB0aGUgRE9NIGVsZW1lbnQgbWFuYWdlZCBieSB0aGUgdmlldyBjYW4gYmUgcmVsZWFzZWQgYnkgdGhlCiAgICAgbWVtb3J5IG1hbmFnZXIuCiAgICAgIEBtZXRob2QgZGVzdHJveQogICAgIEBwcml2YXRlCiAgICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICB0aGlzLl9jdXJyZW50U3RhdGUuZGVzdHJveSh0aGlzKTsKICAgIH0sCgogICAgLyoqCiAgICAgQ2FsbGVkIHdoZW4gdGhlIGVsZW1lbnQgb2YgdGhlIHZpZXcgaXMgZ29pbmcgdG8gYmUgZGVzdHJveWVkLiBPdmVycmlkZQogICAgIHRoaXMgZnVuY3Rpb24gdG8gZG8gYW55IHRlYXJkb3duIHRoYXQgcmVxdWlyZXMgYW4gZWxlbWVudCwgbGlrZSByZW1vdmluZwogICAgIGV2ZW50IGxpc3RlbmVycy4KICAgICAgUGxlYXNlIG5vdGU6IGFueSBwcm9wZXJ0eSBjaGFuZ2VzIG1hZGUgZHVyaW5nIHRoaXMgZXZlbnQgd2lsbCBoYXZlIG5vCiAgICAgZWZmZWN0IG9uIG9iamVjdCBvYnNlcnZlcnMuCiAgICAgIEBldmVudCB3aWxsRGVzdHJveUVsZW1lbnQKICAgICBAcHVibGljCiAgICAgKi8KICAgIHdpbGxEZXN0cm95RWxlbWVudDogSywKCiAgICAvKioKICAgICBDYWxsZWQgYWZ0ZXIgdGhlIGVsZW1lbnQgb2YgdGhlIHZpZXcgaXMgZGVzdHJveWVkLgogICAgICBAZXZlbnQgd2lsbERlc3Ryb3lFbGVtZW50CiAgICAgQHB1YmxpYwogICAgICovCiAgICBkaWREZXN0cm95RWxlbWVudDogSywKCiAgICAvKioKICAgICBDYWxsZWQgd2hlbiB0aGUgcGFyZW50VmlldyBwcm9wZXJ0eSBoYXMgY2hhbmdlZC4KICAgICAgQGV2ZW50IHBhcmVudFZpZXdEaWRDaGFuZ2UKICAgICBAcHJpdmF0ZQogICAgICovCiAgICBwYXJlbnRWaWV3RGlkQ2hhbmdlOiBLLAogICAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogICAgLy8gU1RBTkRBUkQgUkVOREVSIFBST1BFUlRJRVMKICAgIC8vCgogICAgLyoqCiAgICAgVGFnIG5hbWUgZm9yIHRoZSB2aWV3J3Mgb3V0ZXIgZWxlbWVudC4gVGhlIHRhZyBuYW1lIGlzIG9ubHkgdXNlZCB3aGVuIGFuCiAgICAgZWxlbWVudCBpcyBmaXJzdCBjcmVhdGVkLiBJZiB5b3UgY2hhbmdlIHRoZSBgdGFnTmFtZWAgZm9yIGFuIGVsZW1lbnQsIHlvdQogICAgIG11c3QgZGVzdHJveSBhbmQgcmVjcmVhdGUgdGhlIHZpZXcgZWxlbWVudC4KICAgICAgQnkgZGVmYXVsdCwgdGhlIHJlbmRlciBidWZmZXIgd2lsbCB1c2UgYSBgPGRpdj5gIHRhZyBmb3Igdmlld3MuCiAgICAgIElmIHRoZSB0YWdOYW1lIGlzIGAnJ2AsIHRoZSB2aWV3IHdpbGwgYmUgdGFnbGVzcywgd2l0aCBubyBvdXRlciBlbGVtZW50LgogICAgIENvbXBvbmVudCBwcm9wZXJ0aWVzIHRoYXQgZGVwZW5kIG9uIHRoZSBwcmVzZW5jZSBvZiBhbiBvdXRlciBlbGVtZW50LCBzdWNoCiAgICAgYXMgYGNsYXNzTmFtZUJpbmRpbmdzYCBhbmQgYGF0dHJpYnV0ZUJpbmRpbmdzYCwgZG8gbm90IHdvcmsgd2l0aCB0YWdsZXNzCiAgICAgY29tcG9uZW50cy4gVGFnbGVzcyBjb21wb25lbnRzIGNhbm5vdCBpbXBsZW1lbnQgbWV0aG9kcyB0byBoYW5kbGUgZXZlbnRzLAogICAgIGFuZCBoYXZlIG5vIGFzc29jaWF0ZWQgalF1ZXJ5IG9iamVjdCB0byByZXR1cm4gd2l0aCBgJCgpYC4KICAgICAgQHByb3BlcnR5IHRhZ05hbWUKICAgICBAdHlwZSBTdHJpbmcKICAgICBAZGVmYXVsdCBudWxsCiAgICAgQHB1YmxpYwogICAgICovCiAgICAvLyBXZSBsZWF2ZSB0aGlzIG51bGwgYnkgZGVmYXVsdCBzbyB3ZSBjYW4gdGVsbCB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuCiAgICAvLyB0aGUgZGVmYXVsdCBjYXNlIGFuZCBhIHVzZXItc3BlY2lmaWVkIHRhZy4KICAgIHRhZ05hbWU6IG51bGwsCiAgICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgICAvLyBDT1JFIERJU1BMQVkgTUVUSE9EUwogICAgLy8KCiAgICAvKioKICAgICBTZXR1cCBhIHZpZXcsIGJ1dCBkbyBub3QgZmluaXNoIHdha2luZyBpdCB1cC4KICAgICAgKiBjb25maWd1cmUgYGNoaWxkVmlld3NgCiAgICAgKiByZWdpc3RlciB0aGUgdmlldyB3aXRoIHRoZSBnbG9iYWwgdmlld3MgaGFzaCwgd2hpY2ggaXMgdXNlZCBmb3IgZXZlbnQKICAgICBkaXNwYXRjaAogICAgICBAbWV0aG9kIGluaXQKICAgICBAcHJpdmF0ZQogICAgICovCiAgICBpbml0OiBmdW5jdGlvbiBpbml0KCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoCgoKICAgICAgKGZhbHNlICYmICEoKDAsIF9tZXRhbC5kZXNjcmlwdG9yRm9yUHJvcGVydHkpKHRoaXMsICdlbGVtZW50SWQnKSA9PT0gdW5kZWZpbmVkKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIllvdSBjYW5ub3QgdXNlIGEgY29tcHV0ZWQgcHJvcGVydHkgZm9yIHRoZSBjb21wb25lbnQncyBgZWxlbWVudElkYCAoIiArIHRoaXMgKyAiKS4iLCAoMCwgX21ldGFsLmRlc2NyaXB0b3JGb3JQcm9wZXJ0eSkodGhpcywgJ2VsZW1lbnRJZCcpID09PSB1bmRlZmluZWQpKTsgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aAoKICAgICAgKGZhbHNlICYmICEoKDAsIF9tZXRhbC5kZXNjcmlwdG9yRm9yUHJvcGVydHkpKHRoaXMsICd0YWdOYW1lJykgPT09IHVuZGVmaW5lZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJZb3UgY2Fubm90IHVzZSBhIGNvbXB1dGVkIHByb3BlcnR5IGZvciB0aGUgY29tcG9uZW50J3MgYHRhZ05hbWVgICgiICsgdGhpcyArICIpLiIsICgwLCBfbWV0YWwuZGVzY3JpcHRvckZvclByb3BlcnR5KSh0aGlzLCAndGFnTmFtZScpID09PSB1bmRlZmluZWQpKTsKCiAgICAgIGlmICghdGhpcy5lbGVtZW50SWQgJiYgdGhpcy50YWdOYW1lICE9PSAnJykgewogICAgICAgIHRoaXMuZWxlbWVudElkID0gKDAsIF91dGlscy5ndWlkRm9yKSh0aGlzKTsKICAgICAgfQoKICAgICAgKGZhbHNlICYmICEoIXRoaXMucmVuZGVyKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1VzaW5nIGEgY3VzdG9tIGAucmVuZGVyYCBmdW5jdGlvbiBpcyBubyBsb25nZXIgc3VwcG9ydGVkLicsICF0aGlzLnJlbmRlcikpOwogICAgfSwKICAgIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KICAgIC8vIEVWRU5UIEhBTkRMSU5HCiAgICAvLwoKICAgIC8qKgogICAgIEhhbmRsZSBldmVudHMgZnJvbSBgRXZlbnREaXNwYXRjaGVyYAogICAgICBAbWV0aG9kIGhhbmRsZUV2ZW50CiAgICAgQHBhcmFtIGV2ZW50TmFtZSB7U3RyaW5nfQogICAgIEBwYXJhbSBldnQge0V2ZW50fQogICAgIEBwcml2YXRlCiAgICAgKi8KICAgIGhhbmRsZUV2ZW50OiBmdW5jdGlvbiBoYW5kbGVFdmVudChldmVudE5hbWUsIGV2dCkgewogICAgICByZXR1cm4gdGhpcy5fY3VycmVudFN0YXRlLmhhbmRsZUV2ZW50KHRoaXMsIGV2ZW50TmFtZSwgZXZ0KTsKICAgIH0KICB9OwoKICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5KUVVFUllfSU5URUdSQVRJT04pIHsKICAgIC8qKgogICAgIFJldHVybnMgYSBqUXVlcnkgb2JqZWN0IGZvciB0aGlzIHZpZXcncyBlbGVtZW50LiBJZiB5b3UgcGFzcyBpbiBhIHNlbGVjdG9yCiAgICAgc3RyaW5nLCB0aGlzIG1ldGhvZCB3aWxsIHJldHVybiBhIGpRdWVyeSBvYmplY3QsIHVzaW5nIHRoZSBjdXJyZW50IGVsZW1lbnQKICAgICBhcyBpdHMgYnVmZmVyLgogICAgICBGb3IgZXhhbXBsZSwgY2FsbGluZyBgdmlldy4kKCdsaScpYCB3aWxsIHJldHVybiBhIGpRdWVyeSBvYmplY3QgY29udGFpbmluZwogICAgIGFsbCBvZiB0aGUgYGxpYCBlbGVtZW50cyBpbnNpZGUgdGhlIERPTSBlbGVtZW50IG9mIHRoaXMgdmlldy4KICAgICAgQG1ldGhvZCAkCiAgICAgQHBhcmFtIHtTdHJpbmd9IFtzZWxlY3Rvcl0gYSBqUXVlcnktY29tcGF0aWJsZSBzZWxlY3RvciBzdHJpbmcKICAgICBAcmV0dXJuIHtqUXVlcnl9IHRoZSBqUXVlcnkgb2JqZWN0IGZvciB0aGUgRE9NIG5vZGUKICAgICBAcHVibGljCiAgICAgQGRlcHJlY2F0ZWQKICAgICAqLwogICAgbWl4aW4uJCA9IGZ1bmN0aW9uICQoc2VsKSB7CiAgICAgIChmYWxzZSAmJiAhKHRoaXMudGFnTmFtZSAhPT0gJycpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IGNhbm5vdCBhY2Nlc3MgdGhpcy4kKCkgb24gYSBjb21wb25lbnQgd2l0aCBgdGFnTmFtZTogJydgIHNwZWNpZmllZC4iLCB0aGlzLnRhZ05hbWUgIT09ICcnKSk7CiAgICAgIChmYWxzZSAmJiAhKCFfanF1ZXJ5LmpRdWVyeURpc2FibGVkKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW5ub3QgYWNjZXNzIHRoaXMuJCgpIHdpdGggYGpRdWVyeWAgZGlzYWJsZWQuJywgIV9qcXVlcnkualF1ZXJ5RGlzYWJsZWQpKTsKICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgnVXNpbmcgdGhpcy4kKCkgaW4gYSBjb21wb25lbnQgaGFzIGJlZW4gZGVwcmVjYXRlZCwgY29uc2lkZXIgdXNpbmcgdGhpcy5lbGVtZW50JywgZmFsc2UsIHsKICAgICAgICBpZDogJ2VtYmVyLXZpZXdzLmN1cmx5LWNvbXBvbmVudHMuanF1ZXJ5LWVsZW1lbnQnLAogICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgIHVybDogJ2h0dHBzOi8vZW1iZXJqcy5jb20vZGVwcmVjYXRpb25zL3YzLngjdG9jX2pxdWVyeS1hcGlzJwogICAgICB9KSk7CgogICAgICBpZiAodGhpcy5lbGVtZW50KSB7CiAgICAgICAgcmV0dXJuIHNlbCA/ICgwLCBfanF1ZXJ5LmpRdWVyeSkoc2VsLCB0aGlzLmVsZW1lbnQpIDogKDAsIF9qcXVlcnkualF1ZXJ5KSh0aGlzLmVsZW1lbnQpOwogICAgICB9CiAgICB9OwogIH0KICAvKioKICAgQGNsYXNzIFZpZXdNaXhpbgogICBAbmFtZXNwYWNlIEVtYmVyCiAgIEBwcml2YXRlCiAgKi8KCgogIHZhciBfZGVmYXVsdCA9IF9tZXRhbC5NaXhpbi5jcmVhdGUobWl4aW4pOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi9zeXN0ZW0vYWN0aW9uX21hbmFnZXIiLCBbImV4cG9ydHMiXSwgZnVuY3Rpb24gKF9leHBvcnRzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gQWN0aW9uTWFuYWdlcjsKCiAgLyoqCiAgQG1vZHVsZSBlbWJlcgogICovCiAgZnVuY3Rpb24gQWN0aW9uTWFuYWdlcigpIHt9CiAgLyoqCiAgICBHbG9iYWwgYWN0aW9uIGlkIGhhc2guCiAgCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlZ2lzdGVyZWRBY3Rpb25zCiAgICBAdHlwZSBPYmplY3QKICAqLwoKCiAgQWN0aW9uTWFuYWdlci5yZWdpc3RlcmVkQWN0aW9ucyA9IHt9Owp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvc3lzdGVtL2V2ZW50X2Rpc3BhdGNoZXIiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvb3duZXIiLCAiQGVtYmVyL3BvbHlmaWxscyIsICJAZW1iZXIvZGVidWciLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZSIsICJAZW1iZXIvLWludGVybmFscy92aWV3cyIsICJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvc3lzdGVtL2pxdWVyeSIsICJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvc3lzdGVtL2FjdGlvbl9tYW5hZ2VyIiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi9zeXN0ZW0vanF1ZXJ5X2V2ZW50X2RlcHJlY2F0aW9uIiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi9zeXN0ZW0vdXRpbHMiLCAiQGVtYmVyL2RlcHJlY2F0ZWQtZmVhdHVyZXMiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfb3duZXIsIF9wb2x5ZmlsbHMsIF9kZWJ1ZywgX21ldGFsLCBfcnVudGltZSwgX3ZpZXdzLCBfanF1ZXJ5LCBfYWN0aW9uX21hbmFnZXIsIF9qcXVlcnlfZXZlbnRfZGVwcmVjYXRpb24sIF91dGlscywgX2RlcHJlY2F0ZWRGZWF0dXJlcykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgQG1vZHVsZSBlbWJlcgogICovCiAgdmFyIFJPT1RfRUxFTUVOVF9DTEFTUyA9ICdlbWJlci1hcHBsaWNhdGlvbic7CiAgdmFyIFJPT1RfRUxFTUVOVF9TRUxFQ1RPUiA9ICIuIiArIFJPT1RfRUxFTUVOVF9DTEFTUzsKICB2YXIgRVZFTlRfTUFQID0gewogICAgbW91c2VlbnRlcjogJ21vdXNlb3ZlcicsCiAgICBtb3VzZWxlYXZlOiAnbW91c2VvdXQnCiAgfTsKICAvKioKICAgIGBFbWJlci5FdmVudERpc3BhdGNoZXJgIGhhbmRsZXMgZGVsZWdhdGluZyBicm93c2VyIGV2ZW50cyB0byB0aGVpcgogICAgY29ycmVzcG9uZGluZyBgRW1iZXIuVmlld3MuYCBGb3IgZXhhbXBsZSwgd2hlbiB5b3UgY2xpY2sgb24gYSB2aWV3LAogICAgYEVtYmVyLkV2ZW50RGlzcGF0Y2hlcmAgZW5zdXJlcyB0aGF0IHRoYXQgdmlldydzIGBtb3VzZURvd25gIG1ldGhvZCBnZXRzCiAgICBjYWxsZWQuCiAgCiAgICBAY2xhc3MgRXZlbnREaXNwYXRjaGVyCiAgICBAbmFtZXNwYWNlIEVtYmVyCiAgICBAcHJpdmF0ZQogICAgQGV4dGVuZHMgRW1iZXIuT2JqZWN0CiAgKi8KCiAgdmFyIF9kZWZhdWx0ID0gX3J1bnRpbWUuT2JqZWN0LmV4dGVuZCh7CiAgICAvKioKICAgICAgVGhlIHNldCBvZiBldmVudHMgbmFtZXMgKGFuZCBhc3NvY2lhdGVkIGhhbmRsZXIgZnVuY3Rpb24gbmFtZXMpIHRvIGJlIHNldHVwCiAgICAgIGFuZCBkaXNwYXRjaGVkIGJ5IHRoZSBgRXZlbnREaXNwYXRjaGVyYC4gTW9kaWZpY2F0aW9ucyB0byB0aGlzIGxpc3QgY2FuIGJlIGRvbmUKICAgICAgYXQgc2V0dXAgdGltZSwgZ2VuZXJhbGx5IHZpYSB0aGUgYEFwcGxpY2F0aW9uLmN1c3RvbUV2ZW50c2AgaGFzaC4KICAgICAgIFRvIGFkZCBuZXcgZXZlbnRzIHRvIGJlIGxpc3RlbmVkIHRvOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAgICAgIGxldCBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoewogICAgICAgIGN1c3RvbUV2ZW50czogewogICAgICAgICAgcGFzdGU6ICdwYXN0ZScKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFRvIHByZXZlbnQgZGVmYXVsdCBldmVudHMgZnJvbSBiZWluZyBsaXN0ZW5lZCB0bzoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgICAgICBsZXQgQXBwID0gQXBwbGljYXRpb24uY3JlYXRlKHsKICAgICAgICBjdXN0b21FdmVudHM6IHsKICAgICAgICAgIG1vdXNlZW50ZXI6IG51bGwsCiAgICAgICAgICBtb3VzZWxlYXZlOiBudWxsCiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgIEBwcm9wZXJ0eSBldmVudHMKICAgICAgQHR5cGUgT2JqZWN0CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgZXZlbnRzOiAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHsKICAgICAgdG91Y2hzdGFydDogJ3RvdWNoU3RhcnQnLAogICAgICB0b3VjaG1vdmU6ICd0b3VjaE1vdmUnLAogICAgICB0b3VjaGVuZDogJ3RvdWNoRW5kJywKICAgICAgdG91Y2hjYW5jZWw6ICd0b3VjaENhbmNlbCcsCiAgICAgIGtleWRvd246ICdrZXlEb3duJywKICAgICAga2V5dXA6ICdrZXlVcCcsCiAgICAgIGtleXByZXNzOiAna2V5UHJlc3MnLAogICAgICBtb3VzZWRvd246ICdtb3VzZURvd24nLAogICAgICBtb3VzZXVwOiAnbW91c2VVcCcsCiAgICAgIGNvbnRleHRtZW51OiAnY29udGV4dE1lbnUnLAogICAgICBjbGljazogJ2NsaWNrJywKICAgICAgZGJsY2xpY2s6ICdkb3VibGVDbGljaycsCiAgICAgIGZvY3VzaW46ICdmb2N1c0luJywKICAgICAgZm9jdXNvdXQ6ICdmb2N1c091dCcsCiAgICAgIHN1Ym1pdDogJ3N1Ym1pdCcsCiAgICAgIGlucHV0OiAnaW5wdXQnLAogICAgICBjaGFuZ2U6ICdjaGFuZ2UnLAogICAgICBkcmFnc3RhcnQ6ICdkcmFnU3RhcnQnLAogICAgICBkcmFnOiAnZHJhZycsCiAgICAgIGRyYWdlbnRlcjogJ2RyYWdFbnRlcicsCiAgICAgIGRyYWdsZWF2ZTogJ2RyYWdMZWF2ZScsCiAgICAgIGRyYWdvdmVyOiAnZHJhZ092ZXInLAogICAgICBkcm9wOiAnZHJvcCcsCiAgICAgIGRyYWdlbmQ6ICdkcmFnRW5kJwogICAgfSwgX2RlcHJlY2F0ZWRGZWF0dXJlcy5NT1VTRV9FTlRFUl9MRUFWRV9NT1ZFX0VWRU5UUyA/IHsKICAgICAgbW91c2VlbnRlcjogJ21vdXNlRW50ZXInLAogICAgICBtb3VzZWxlYXZlOiAnbW91c2VMZWF2ZScsCiAgICAgIG1vdXNlbW92ZTogJ21vdXNlTW92ZScKICAgIH0gOiB7fSksCgogICAgLyoqCiAgICAgIFRoZSByb290IERPTSBlbGVtZW50IHRvIHdoaWNoIGV2ZW50IGxpc3RlbmVycyBzaG91bGQgYmUgYXR0YWNoZWQuIEV2ZW50CiAgICAgIGxpc3RlbmVycyB3aWxsIGJlIGF0dGFjaGVkIHRvIHRoZSBkb2N1bWVudCB1bmxlc3MgdGhpcyBpcyBvdmVycmlkZGVuLgogICAgICAgQ2FuIGJlIHNwZWNpZmllZCBhcyBhIERPTUVsZW1lbnQgb3IgYSBzZWxlY3RvciBzdHJpbmcuCiAgICAgICBUaGUgZGVmYXVsdCBib2R5IGlzIGEgc3RyaW5nIHNpbmNlIHRoaXMgbWF5IGJlIGV2YWx1YXRlZCBiZWZvcmUgZG9jdW1lbnQuYm9keQogICAgICBleGlzdHMgaW4gdGhlIERPTS4KICAgICAgIEBwcml2YXRlCiAgICAgIEBwcm9wZXJ0eSByb290RWxlbWVudAogICAgICBAdHlwZSBET01FbGVtZW50CiAgICAgIEBkZWZhdWx0ICdib2R5JwogICAgKi8KICAgIHJvb3RFbGVtZW50OiAnYm9keScsCiAgICBpbml0OiBmdW5jdGlvbiBpbml0KCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdGhpcy5fc3VwZXIoKTsKCiAgICAgIChmYWxzZSAmJiAhKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgb3duZXIgPSAoMCwgX293bmVyLmdldE93bmVyKShfdGhpcyk7CiAgICAgICAgdmFyIGVudmlyb25tZW50ID0gb3duZXIubG9va3VwKCctZW52aXJvbm1lbnQ6bWFpbicpOwogICAgICAgIHJldHVybiBlbnZpcm9ubWVudC5pc0ludGVyYWN0aXZlOwogICAgICB9KCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnRXZlbnREaXNwYXRjaGVyIHNob3VsZCBuZXZlciBiZSBpbnN0YW50aWF0ZWQgaW4gZmFzdGJvb3QgbW9kZS4gUGxlYXNlIHJlcG9ydCB0aGlzIGFzIGFuIEVtYmVyIGJ1Zy4nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG93bmVyID0gKDAsIF9vd25lci5nZXRPd25lcikoX3RoaXMpOwogICAgICAgIHZhciBlbnZpcm9ubWVudCA9IG93bmVyLmxvb2t1cCgnLWVudmlyb25tZW50Om1haW4nKTsKICAgICAgICByZXR1cm4gZW52aXJvbm1lbnQuaXNJbnRlcmFjdGl2ZTsKICAgICAgfSgpKSk7CiAgICAgIHRoaXMuX2V2ZW50SGFuZGxlcnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgfSwKCiAgICAvKioKICAgICAgU2V0cyB1cCBldmVudCBsaXN0ZW5lcnMgZm9yIHN0YW5kYXJkIGJyb3dzZXIgZXZlbnRzLgogICAgICAgVGhpcyB3aWxsIGJlIGNhbGxlZCBhZnRlciB0aGUgYnJvd3NlciBzZW5kcyBhIGBET01Db250ZW50UmVhZHlgIGV2ZW50LiBCeQogICAgICBkZWZhdWx0LCBpdCB3aWxsIHNldCB1cCBhbGwgb2YgdGhlIGxpc3RlbmVycyBvbiB0aGUgZG9jdW1lbnQgYm9keS4gSWYgeW91CiAgICAgIHdvdWxkIGxpa2UgdG8gcmVnaXN0ZXIgdGhlIGxpc3RlbmVycyBvbiBhIGRpZmZlcmVudCBlbGVtZW50LCBzZXQgdGhlIGV2ZW50CiAgICAgIGRpc3BhdGNoZXIncyBgcm9vdGAgcHJvcGVydHkuCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIHNldHVwCiAgICAgIEBwYXJhbSBhZGRlZEV2ZW50cyB7T2JqZWN0fQogICAgKi8KICAgIHNldHVwOiBmdW5jdGlvbiBzZXR1cChhZGRlZEV2ZW50cywgX3Jvb3RFbGVtZW50KSB7CiAgICAgIHZhciBldmVudHMgPSB0aGlzLl9maW5hbEV2ZW50cyA9ICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAnZXZlbnRzJyksIGFkZGVkRXZlbnRzKTsKCiAgICAgIGlmIChfcm9vdEVsZW1lbnQgIT09IHVuZGVmaW5lZCAmJiBfcm9vdEVsZW1lbnQgIT09IG51bGwpIHsKICAgICAgICAoMCwgX21ldGFsLnNldCkodGhpcywgJ3Jvb3RFbGVtZW50JywgX3Jvb3RFbGVtZW50KTsKICAgICAgfQoKICAgICAgdmFyIHJvb3RFbGVtZW50U2VsZWN0b3IgPSAoMCwgX21ldGFsLmdldCkodGhpcywgJ3Jvb3RFbGVtZW50Jyk7CiAgICAgIHZhciByb290RWxlbWVudDsKCiAgICAgIGlmICghX2RlcHJlY2F0ZWRGZWF0dXJlcy5KUVVFUllfSU5URUdSQVRJT04gfHwgX2pxdWVyeS5qUXVlcnlEaXNhYmxlZCkgewogICAgICAgIGlmICh0eXBlb2Ygcm9vdEVsZW1lbnRTZWxlY3RvciAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgIHJvb3RFbGVtZW50ID0gcm9vdEVsZW1lbnRTZWxlY3RvcjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcm9vdEVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHJvb3RFbGVtZW50U2VsZWN0b3IpOwogICAgICAgIH0KCiAgICAgICAgKGZhbHNlICYmICEoIXJvb3RFbGVtZW50LmNsYXNzTGlzdC5jb250YWlucyhST09UX0VMRU1FTlRfQ0xBU1MpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIllvdSBjYW5ub3QgdXNlIHRoZSBzYW1lIHJvb3QgZWxlbWVudCAoIiArICgoMCwgX21ldGFsLmdldCkodGhpcywgJ3Jvb3RFbGVtZW50JykgfHwgcm9vdEVsZW1lbnQudGFnTmFtZSkgKyAiKSBtdWx0aXBsZSB0aW1lcyBpbiBhbiBFbWJlci5BcHBsaWNhdGlvbiIsICFyb290RWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoUk9PVF9FTEVNRU5UX0NMQVNTKSkpOwogICAgICAgIChmYWxzZSAmJiAhKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciB0YXJnZXQgPSByb290RWxlbWVudC5wYXJlbnROb2RlOwoKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgaWYgKHRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoUk9PVF9FTEVNRU5UX0NMQVNTKSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CiAgICAgICAgICB9IHdoaWxlICh0YXJnZXQgJiYgdGFyZ2V0Lm5vZGVUeXBlID09PSAxKTsKCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9KCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGNhbm5vdCBtYWtlIGEgbmV3IEVtYmVyLkFwcGxpY2F0aW9uIHVzaW5nIGEgcm9vdCBlbGVtZW50IHRoYXQgaXMgYSBkZXNjZW5kZW50IG9mIGFuIGV4aXN0aW5nIEVtYmVyLkFwcGxpY2F0aW9uJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIHRhcmdldCA9IHJvb3RFbGVtZW50LnBhcmVudE5vZGU7CgogICAgICAgICAgZG8gewogICAgICAgICAgICBpZiAodGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucyhST09UX0VMRU1FTlRfQ0xBU1MpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKICAgICAgICAgIH0gd2hpbGUgKHRhcmdldCAmJiB0YXJnZXQubm9kZVR5cGUgPT09IDEpOwoKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0oKSkpOwogICAgICAgIChmYWxzZSAmJiAhKCFyb290RWxlbWVudC5xdWVyeVNlbGVjdG9yKFJPT1RfRUxFTUVOVF9TRUxFQ1RPUikpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGNhbm5vdCBtYWtlIGEgbmV3IEVtYmVyLkFwcGxpY2F0aW9uIHVzaW5nIGEgcm9vdCBlbGVtZW50IHRoYXQgaXMgYW4gYW5jZXN0b3Igb2YgYW4gZXhpc3RpbmcgRW1iZXIuQXBwbGljYXRpb24nLCAhcm9vdEVsZW1lbnQucXVlcnlTZWxlY3RvcihST09UX0VMRU1FTlRfU0VMRUNUT1IpKSk7CiAgICAgICAgcm9vdEVsZW1lbnQuY2xhc3NMaXN0LmFkZChST09UX0VMRU1FTlRfQ0xBU1MpOwogICAgICAgIChmYWxzZSAmJiAhKHJvb3RFbGVtZW50LmNsYXNzTGlzdC5jb250YWlucyhST09UX0VMRU1FTlRfQ0xBU1MpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIlVuYWJsZSB0byBhZGQgJyIgKyBST09UX0VMRU1FTlRfQ0xBU1MgKyAiJyBjbGFzcyB0byByb290IGVsZW1lbnQgKCIgKyAoKDAsIF9tZXRhbC5nZXQpKHRoaXMsICdyb290RWxlbWVudCcpIHx8IHJvb3RFbGVtZW50LnRhZ05hbWUpICsgIikuIE1ha2Ugc3VyZSB5b3Ugc2V0IHJvb3RFbGVtZW50IHRvIHRoZSBib2R5IG9yIGFuIGVsZW1lbnQgaW4gdGhlIGJvZHkuIiwgcm9vdEVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKFJPT1RfRUxFTUVOVF9DTEFTUykpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByb290RWxlbWVudCA9ICgwLCBfanF1ZXJ5LmpRdWVyeSkocm9vdEVsZW1lbnRTZWxlY3Rvcik7CiAgICAgICAgKGZhbHNlICYmICEoIXJvb3RFbGVtZW50LmlzKFJPT1RfRUxFTUVOVF9TRUxFQ1RPUikpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IGNhbm5vdCB1c2UgdGhlIHNhbWUgcm9vdCBlbGVtZW50ICgiICsgKHJvb3RFbGVtZW50LnNlbGVjdG9yIHx8IHJvb3RFbGVtZW50WzBdLnRhZ05hbWUpICsgIikgbXVsdGlwbGUgdGltZXMgaW4gYW4gRW1iZXIuQXBwbGljYXRpb24iLCAhcm9vdEVsZW1lbnQuaXMoUk9PVF9FTEVNRU5UX1NFTEVDVE9SKSkpOwogICAgICAgIChmYWxzZSAmJiAhKCFyb290RWxlbWVudC5jbG9zZXN0KFJPT1RfRUxFTUVOVF9TRUxFQ1RPUikubGVuZ3RoKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW5ub3QgbWFrZSBhIG5ldyBFbWJlci5BcHBsaWNhdGlvbiB1c2luZyBhIHJvb3QgZWxlbWVudCB0aGF0IGlzIGEgZGVzY2VuZGVudCBvZiBhbiBleGlzdGluZyBFbWJlci5BcHBsaWNhdGlvbicsICFyb290RWxlbWVudC5jbG9zZXN0KFJPT1RfRUxFTUVOVF9TRUxFQ1RPUikubGVuZ3RoKSk7CiAgICAgICAgKGZhbHNlICYmICEoIXJvb3RFbGVtZW50LmZpbmQoUk9PVF9FTEVNRU5UX1NFTEVDVE9SKS5sZW5ndGgpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGNhbm5vdCBtYWtlIGEgbmV3IEVtYmVyLkFwcGxpY2F0aW9uIHVzaW5nIGEgcm9vdCBlbGVtZW50IHRoYXQgaXMgYW4gYW5jZXN0b3Igb2YgYW4gZXhpc3RpbmcgRW1iZXIuQXBwbGljYXRpb24nLCAhcm9vdEVsZW1lbnQuZmluZChST09UX0VMRU1FTlRfU0VMRUNUT1IpLmxlbmd0aCkpOwogICAgICAgIHJvb3RFbGVtZW50LmFkZENsYXNzKFJPT1RfRUxFTUVOVF9DTEFTUyk7CgogICAgICAgIGlmICghcm9vdEVsZW1lbnQuaXMoUk9PVF9FTEVNRU5UX1NFTEVDVE9SKSkgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVW5hYmxlIHRvIGFkZCAnIiArIFJPT1RfRUxFTUVOVF9DTEFTUyArICInIGNsYXNzIHRvIHJvb3QgZWxlbWVudCAoIiArIChyb290RWxlbWVudC5zZWxlY3RvciB8fCByb290RWxlbWVudFswXS50YWdOYW1lKSArICIpLiBNYWtlIHN1cmUgeW91IHNldCByb290RWxlbWVudCB0byB0aGUgYm9keSBvciBhbiBlbGVtZW50IGluIHRoZSBib2R5LiIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yICh2YXIgZXZlbnQgaW4gZXZlbnRzKSB7CiAgICAgICAgaWYgKGV2ZW50cy5oYXNPd25Qcm9wZXJ0eShldmVudCkpIHsKICAgICAgICAgIHRoaXMuc2V0dXBIYW5kbGVyKHJvb3RFbGVtZW50LCBldmVudCwgZXZlbnRzW2V2ZW50XSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBSZWdpc3RlcnMgYW4gZXZlbnQgbGlzdGVuZXIgb24gdGhlIHJvb3RFbGVtZW50LiBJZiB0aGUgZ2l2ZW4gZXZlbnQgaXMKICAgICAgdHJpZ2dlcmVkLCB0aGUgcHJvdmlkZWQgZXZlbnQgaGFuZGxlciB3aWxsIGJlIHRyaWdnZXJlZCBvbiB0aGUgdGFyZ2V0IHZpZXcuCiAgICAgICBJZiB0aGUgdGFyZ2V0IHZpZXcgZG9lcyBub3QgaW1wbGVtZW50IHRoZSBldmVudCBoYW5kbGVyLCBvciBpZiB0aGUgaGFuZGxlcgogICAgICByZXR1cm5zIGBmYWxzZWAsIHRoZSBwYXJlbnQgdmlldyB3aWxsIGJlIGNhbGxlZC4gVGhlIGV2ZW50IHdpbGwgY29udGludWUgdG8KICAgICAgYnViYmxlIHRvIGVhY2ggc3VjY2Vzc2l2ZSBwYXJlbnQgdmlldyB1bnRpbCBpdCByZWFjaGVzIHRoZSB0b3AuCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIHNldHVwSGFuZGxlcgogICAgICBAcGFyYW0ge0VsZW1lbnR9IHJvb3RFbGVtZW50CiAgICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudCB0aGUgYnJvd3Nlci1vcmlnaW5hdGVkIGV2ZW50IHRvIGxpc3RlbiB0bwogICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnROYW1lIHRoZSBuYW1lIG9mIHRoZSBtZXRob2QgdG8gY2FsbCBvbiB0aGUgdmlldwogICAgKi8KICAgIHNldHVwSGFuZGxlcjogZnVuY3Rpb24gc2V0dXBIYW5kbGVyKHJvb3RFbGVtZW50LCBldmVudCwgZXZlbnROYW1lKSB7CiAgICAgIGlmIChldmVudE5hbWUgPT09IG51bGwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICghX2RlcHJlY2F0ZWRGZWF0dXJlcy5KUVVFUllfSU5URUdSQVRJT04gfHwgX2pxdWVyeS5qUXVlcnlEaXNhYmxlZCkgewogICAgICAgIHZhciB2aWV3SGFuZGxlciA9IGZ1bmN0aW9uIHZpZXdIYW5kbGVyKHRhcmdldCwgZXZlbnQpIHsKICAgICAgICAgIHZhciB2aWV3ID0gKDAsIF92aWV3cy5nZXRFbGVtZW50VmlldykodGFyZ2V0KTsKICAgICAgICAgIHZhciByZXN1bHQgPSB0cnVlOwoKICAgICAgICAgIGlmICh2aWV3KSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHZpZXcuaGFuZGxlRXZlbnQoZXZlbnROYW1lLCBldmVudCk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9OwoKICAgICAgICB2YXIgYWN0aW9uSGFuZGxlciA9IGZ1bmN0aW9uIGFjdGlvbkhhbmRsZXIodGFyZ2V0LCBldmVudCkgewogICAgICAgICAgdmFyIGFjdGlvbklkID0gdGFyZ2V0LmdldEF0dHJpYnV0ZSgnZGF0YS1lbWJlci1hY3Rpb24nKTsKICAgICAgICAgIHZhciBhY3Rpb25zID0gX2FjdGlvbl9tYW5hZ2VyLmRlZmF1bHQucmVnaXN0ZXJlZEFjdGlvbnNbYWN0aW9uSWRdOyAvLyBJbiBHbGltbWVyMiB0aGlzIGF0dHJpYnV0ZSBpcyBzZXQgdG8gYW4gZW1wdHkgc3RyaW5nIGFuZCBhbiBhZGRpdGlvbmFsCiAgICAgICAgICAvLyBhdHRyaWJ1dGUgaXQgc2V0IGZvciBlYWNoIGFjdGlvbiBvbiBhIGdpdmVuIGVsZW1lbnQuIEluIHRoaXMgY2FzZSwgdGhlCiAgICAgICAgICAvLyBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUgcmVhZCBzbyB0aGF0IGEgcHJvcGVyIHNldCBvZiBhY3Rpb24gaGFuZGxlcnMgY2FuCiAgICAgICAgICAvLyBiZSBjb2FsZXNjZWQuCgogICAgICAgICAgaWYgKGFjdGlvbklkID09PSAnJykgewogICAgICAgICAgICB2YXIgYXR0cmlidXRlcyA9IHRhcmdldC5hdHRyaWJ1dGVzOwogICAgICAgICAgICB2YXIgYXR0cmlidXRlQ291bnQgPSBhdHRyaWJ1dGVzLmxlbmd0aDsKICAgICAgICAgICAgYWN0aW9ucyA9IFtdOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhdHRyaWJ1dGVDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGF0dHIgPSBhdHRyaWJ1dGVzLml0ZW0oaSk7CiAgICAgICAgICAgICAgdmFyIGF0dHJOYW1lID0gYXR0ci5uYW1lOwoKICAgICAgICAgICAgICBpZiAoYXR0ck5hbWUuaW5kZXhPZignZGF0YS1lbWJlci1hY3Rpb24tJykgPT09IDApIHsKICAgICAgICAgICAgICAgIGFjdGlvbnMgPSBhY3Rpb25zLmNvbmNhdChfYWN0aW9uX21hbmFnZXIuZGVmYXVsdC5yZWdpc3RlcmVkQWN0aW9uc1thdHRyLnZhbHVlXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IC8vIFdlIGhhdmUgdG8gY2hlY2sgZm9yIGFjdGlvbnMgaGVyZSBzaW5jZSBpbiBzb21lIGNhc2VzLCBqUXVlcnkgd2lsbCB0cmlnZ2VyCiAgICAgICAgICAvLyBhbiBldmVudCBvbiBgcmVtb3ZlQ2hpbGRgIChpLmUuIGZvY3Vzb3V0KSBhZnRlciB3ZSd2ZSBhbHJlYWR5IHRvcm4gZG93biB0aGUKICAgICAgICAgIC8vIGFjdGlvbiBoYW5kbGVycyBmb3IgdGhlIHZpZXcuCgoKICAgICAgICAgIGlmICghYWN0aW9ucykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHJlc3VsdCA9IHRydWU7CgogICAgICAgICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IGFjdGlvbnMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb24gPSBhY3Rpb25zW2luZGV4XTsKCiAgICAgICAgICAgIGlmIChhY3Rpb24gJiYgYWN0aW9uLmV2ZW50TmFtZSA9PT0gZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgLy8gcmV0dXJuIGZhbHNlIGlmIGFueSBvZiB0aGUgYWN0aW9uIGhhbmRsZXJzIHJldHVybnMgZmFsc2UKICAgICAgICAgICAgICByZXN1bHQgPSBhY3Rpb24uaGFuZGxlcihldmVudCkgJiYgcmVzdWx0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9OyAvLyBTcGVjaWFsIGhhbmRsaW5nIG9mIGV2ZW50cyB0aGF0IGRvbid0IGJ1YmJsZSAoZXZlbnQgZGVsZWdhdGlvbiBkb2VzIG5vdCB3b3JrKS4KICAgICAgICAvLyBNaW1pY3MgdGhlIHdheSB0aGlzIGlzIGhhbmRsZWQgaW4galF1ZXJ5LAogICAgICAgIC8vIHNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS9ibG9iLzg5OWM1NmY2YWRhMjY4MjFlOGFmMTJkOWYzNWZhMDM5MTAwZTgzOGUvc3JjL2V2ZW50LmpzI0w2NjYtTDcwMAoKCiAgICAgICAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuTU9VU0VfRU5URVJfTEVBVkVfTU9WRV9FVkVOVFMgJiYgRVZFTlRfTUFQW2V2ZW50XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB2YXIgbWFwcGVkRXZlbnRUeXBlID0gRVZFTlRfTUFQW2V2ZW50XTsKICAgICAgICAgIHZhciBvcmlnRXZlbnRUeXBlID0gZXZlbnQ7CgogICAgICAgICAgdmFyIGNyZWF0ZUZha2VFdmVudCA9IGZ1bmN0aW9uIGNyZWF0ZUZha2VFdmVudChldmVudFR5cGUsIGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBmYWtlRXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnTW91c2VFdmVudCcpOwogICAgICAgICAgICBmYWtlRXZlbnQuaW5pdE1vdXNlRXZlbnQoZXZlbnRUeXBlLCBmYWxzZSwgZmFsc2UsIGV2ZW50LnZpZXcsIGV2ZW50LmRldGFpbCwgZXZlbnQuc2NyZWVuWCwgZXZlbnQuc2NyZWVuWSwgZXZlbnQuY2xpZW50WCwgZXZlbnQuY2xpZW50WSwgZXZlbnQuY3RybEtleSwgZXZlbnQuYWx0S2V5LCBldmVudC5zaGlmdEtleSwgZXZlbnQubWV0YUtleSwgZXZlbnQuYnV0dG9uLCBldmVudC5yZWxhdGVkVGFyZ2V0KTsgLy8gZmFrZSBldmVudC50YXJnZXQgYXMgd2UgZG9uJ3QgZGlzcGF0Y2ggdGhlIGV2ZW50CgogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZmFrZUV2ZW50LCAndGFyZ2V0JywgewogICAgICAgICAgICAgIHZhbHVlOiBldmVudC50YXJnZXQsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGZha2VFdmVudDsKICAgICAgICAgIH07CgogICAgICAgICAgdmFyIGhhbmRsZU1hcHBlZEV2ZW50ID0gdGhpcy5fZXZlbnRIYW5kbGVyc1ttYXBwZWRFdmVudFR5cGVdID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBldmVudC50YXJnZXQ7CiAgICAgICAgICAgIHZhciByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldDsKCiAgICAgICAgICAgIHdoaWxlICh0YXJnZXQgJiYgdGFyZ2V0Lm5vZGVUeXBlID09PSAxICYmIChyZWxhdGVkID09PSBudWxsIHx8IHJlbGF0ZWQgIT09IHRhcmdldCAmJiAhKDAsIF91dGlscy5jb250YWlucykodGFyZ2V0LCByZWxhdGVkKSkpIHsKICAgICAgICAgICAgICAvLyBtb3VzZUVudGVyL0xlYXZlIGRvbid0IGJ1YmJsZSwgc28gdGhlcmUgaXMgbm8gbG9naWMgdG8gcHJldmVudCBpdCBhcyB3aXRoIG90aGVyIGV2ZW50cwogICAgICAgICAgICAgIGlmICgoMCwgX3ZpZXdzLmdldEVsZW1lbnRWaWV3KSh0YXJnZXQpKSB7CiAgICAgICAgICAgICAgICB2aWV3SGFuZGxlcih0YXJnZXQsIGNyZWF0ZUZha2VFdmVudChvcmlnRXZlbnRUeXBlLCBldmVudCkpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFyZ2V0Lmhhc0F0dHJpYnV0ZSgnZGF0YS1lbWJlci1hY3Rpb24nKSkgewogICAgICAgICAgICAgICAgYWN0aW9uSGFuZGxlcih0YXJnZXQsIGNyZWF0ZUZha2VFdmVudChvcmlnRXZlbnRUeXBlLCBldmVudCkpOwogICAgICAgICAgICAgIH0gLy8gc2VwYXJhdGUgbW91c2VFbnRlci9MZWF2ZSBldmVudHMgYXJlIGRpc3BhdGNoZWQgZm9yIGVhY2ggbGlzdGVuaW5nIGVsZW1lbnQKICAgICAgICAgICAgICAvLyB1bnRpbCB0aGUgZWxlbWVudCAocmVsYXRlZCkgaGFzIGJlZW4gcmVhY2hlZCB0aGF0IHRoZSBwb2ludGluZyBkZXZpY2UgZXhpdGVkIGZyb20vdG8KCgogICAgICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICAgIHJvb3RFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIobWFwcGVkRXZlbnRUeXBlLCBoYW5kbGVNYXBwZWRFdmVudCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBoYW5kbGVFdmVudCA9IHRoaXMuX2V2ZW50SGFuZGxlcnNbZXZlbnRdID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBldmVudC50YXJnZXQ7CgogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYgKCgwLCBfdmlld3MuZ2V0RWxlbWVudFZpZXcpKHRhcmdldCkpIHsKICAgICAgICAgICAgICAgIGlmICh2aWV3SGFuZGxlcih0YXJnZXQsIGV2ZW50KSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudC5jYW5jZWxCdWJibGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdGFyZ2V0Lmhhc0F0dHJpYnV0ZSA9PT0gJ2Z1bmN0aW9uJyAmJiB0YXJnZXQuaGFzQXR0cmlidXRlKCdkYXRhLWVtYmVyLWFjdGlvbicpKSB7CiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uSGFuZGxlcih0YXJnZXQsIGV2ZW50KSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKICAgICAgICAgICAgfSB3aGlsZSAodGFyZ2V0ICYmIHRhcmdldC5ub2RlVHlwZSA9PT0gMSk7CiAgICAgICAgICB9OwoKICAgICAgICAgIHJvb3RFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIGhhbmRsZUV2ZW50KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcm9vdEVsZW1lbnQub24oZXZlbnQgKyAiLmVtYmVyIiwgJy5lbWJlci12aWV3JywgZnVuY3Rpb24gKGV2dCkgewogICAgICAgICAgdmFyIHZpZXcgPSAoMCwgX3ZpZXdzLmdldEVsZW1lbnRWaWV3KSh0aGlzKTsKICAgICAgICAgIHZhciByZXN1bHQgPSB0cnVlOwoKICAgICAgICAgIGlmICh2aWV3KSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHZpZXcuaGFuZGxlRXZlbnQoZXZlbnROYW1lLCAoMCwgX2pxdWVyeV9ldmVudF9kZXByZWNhdGlvbi5kZWZhdWx0KShldnQpKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0pOwogICAgICAgIHJvb3RFbGVtZW50Lm9uKGV2ZW50ICsgIi5lbWJlciIsICdbZGF0YS1lbWJlci1hY3Rpb25dJywgZnVuY3Rpb24gKGV2dCkgewogICAgICAgICAgdmFyIGF0dHJpYnV0ZXMgPSBldnQuY3VycmVudFRhcmdldC5hdHRyaWJ1dGVzOwogICAgICAgICAgdmFyIGhhbmRsZWRBY3Rpb25zID0gW107CiAgICAgICAgICBldnQgPSAoMCwgX2pxdWVyeV9ldmVudF9kZXByZWNhdGlvbi5kZWZhdWx0KShldnQpOwoKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXR0cmlidXRlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgYXR0ciA9IGF0dHJpYnV0ZXMuaXRlbShpKTsKICAgICAgICAgICAgdmFyIGF0dHJOYW1lID0gYXR0ci5uYW1lOwoKICAgICAgICAgICAgaWYgKGF0dHJOYW1lLmxhc3RJbmRleE9mKCdkYXRhLWVtYmVyLWFjdGlvbi0nLCAwKSAhPT0gLTEpIHsKICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gX2FjdGlvbl9tYW5hZ2VyLmRlZmF1bHQucmVnaXN0ZXJlZEFjdGlvbnNbYXR0ci52YWx1ZV07IC8vIFdlIGhhdmUgdG8gY2hlY2sgZm9yIGFjdGlvbiBoZXJlIHNpbmNlIGluIHNvbWUgY2FzZXMsIGpRdWVyeSB3aWxsIHRyaWdnZXIKICAgICAgICAgICAgICAvLyBhbiBldmVudCBvbiBgcmVtb3ZlQ2hpbGRgIChpLmUuIGZvY3Vzb3V0KSBhZnRlciB3ZSd2ZSBhbHJlYWR5IHRvcm4gZG93biB0aGUKICAgICAgICAgICAgICAvLyBhY3Rpb24gaGFuZGxlcnMgZm9yIHRoZSB2aWV3LgoKICAgICAgICAgICAgICBpZiAoYWN0aW9uICYmIGFjdGlvbi5ldmVudE5hbWUgPT09IGV2ZW50TmFtZSAmJiBoYW5kbGVkQWN0aW9ucy5pbmRleE9mKGFjdGlvbikgPT09IC0xKSB7CiAgICAgICAgICAgICAgICBhY3Rpb24uaGFuZGxlcihldnQpOyAvLyBBY3Rpb24gaGFuZGxlcnMgY2FuIG11dGF0ZSBzdGF0ZSB3aGljaCBpbiB0dXJuIGNyZWF0ZXMgbmV3IGF0dHJpYnV0ZXMgb24gdGhlIGVsZW1lbnQuCiAgICAgICAgICAgICAgICAvLyBUaGlzIGVmZmVjdCBjb3VsZCBjYXVzZSB0aGUgYGRhdGEtZW1iZXItYWN0aW9uYCBhdHRyaWJ1dGUgdG8gc2hpZnQgZG93biBhbmQgYmUgaW52b2tlZCB0d2ljZS4KICAgICAgICAgICAgICAgIC8vIFRvIGF2b2lkIHRoaXMsIHdlIGtlZXAgdHJhY2sgb2Ygd2hpY2ggYWN0aW9ucyBoYXZlIGJlZW4gaGFuZGxlZC4KCiAgICAgICAgICAgICAgICBoYW5kbGVkQWN0aW9ucy5wdXNoKGFjdGlvbik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICB2YXIgcm9vdEVsZW1lbnRTZWxlY3RvciA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAncm9vdEVsZW1lbnQnKTsKICAgICAgdmFyIHJvb3RFbGVtZW50OwoKICAgICAgaWYgKHJvb3RFbGVtZW50U2VsZWN0b3Iubm9kZVR5cGUpIHsKICAgICAgICByb290RWxlbWVudCA9IHJvb3RFbGVtZW50U2VsZWN0b3I7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcm9vdEVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHJvb3RFbGVtZW50U2VsZWN0b3IpOwogICAgICB9CgogICAgICBpZiAoIXJvb3RFbGVtZW50KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIV9kZXByZWNhdGVkRmVhdHVyZXMuSlFVRVJZX0lOVEVHUkFUSU9OIHx8IF9qcXVlcnkualF1ZXJ5RGlzYWJsZWQpIHsKICAgICAgICBmb3IgKHZhciBldmVudCBpbiB0aGlzLl9ldmVudEhhbmRsZXJzKSB7CiAgICAgICAgICByb290RWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50LCB0aGlzLl9ldmVudEhhbmRsZXJzW2V2ZW50XSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgICgwLCBfanF1ZXJ5LmpRdWVyeSkocm9vdEVsZW1lbnRTZWxlY3Rvcikub2ZmKCcuZW1iZXInLCAnKionKTsKICAgICAgfQoKICAgICAgcm9vdEVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZShST09UX0VMRU1FTlRfQ0xBU1MpOwogICAgICByZXR1cm4gdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgICB0b1N0cmluZzogZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgIHJldHVybiAnKEV2ZW50RGlzcGF0Y2hlciknOwogICAgfQogIH0pOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi9zeXN0ZW0vanF1ZXJ5IiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL2Vudmlyb25tZW50IiwgIkBlbWJlci8taW50ZXJuYWxzL2Jyb3dzZXItZW52aXJvbm1lbnQiLCAiQGVtYmVyL2RlcHJlY2F0ZWQtZmVhdHVyZXMiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZW52aXJvbm1lbnQsIF9icm93c2VyRW52aXJvbm1lbnQsIF9kZXByZWNhdGVkRmVhdHVyZXMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmpRdWVyeURpc2FibGVkID0gX2V4cG9ydHMualF1ZXJ5ID0gdm9pZCAwOwogIHZhciBqUXVlcnk7CiAgX2V4cG9ydHMualF1ZXJ5ID0galF1ZXJ5OwogIHZhciBqUXVlcnlEaXNhYmxlZCA9ICFfZGVwcmVjYXRlZEZlYXR1cmVzLkpRVUVSWV9JTlRFR1JBVElPTiB8fCBfZW52aXJvbm1lbnQuRU5WLl9KUVVFUllfSU5URUdSQVRJT04gPT09IGZhbHNlOwogIF9leHBvcnRzLmpRdWVyeURpc2FibGVkID0galF1ZXJ5RGlzYWJsZWQ7CgogIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLkpRVUVSWV9JTlRFR1JBVElPTiAmJiBfYnJvd3NlckVudmlyb25tZW50Lmhhc0RPTSkgewogICAgX2V4cG9ydHMualF1ZXJ5ID0galF1ZXJ5ID0gX2Vudmlyb25tZW50LmNvbnRleHQuaW1wb3J0cy5qUXVlcnk7CgogICAgaWYgKCFqUXVlcnlEaXNhYmxlZCAmJiBqUXVlcnkpIHsKICAgICAgaWYgKGpRdWVyeS5ldmVudC5hZGRQcm9wKSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZFByb3AoJ2RhdGFUcmFuc2ZlcicpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGh0dHA6Ly93d3cud2hhdHdnLm9yZy9zcGVjcy93ZWItYXBwcy9jdXJyZW50LXdvcmsvbXVsdGlwYWdlL2RuZC5odG1sI2RuZGV2ZW50cwogICAgICAgIFsnZHJhZ3N0YXJ0JywgJ2RyYWcnLCAnZHJhZ2VudGVyJywgJ2RyYWdsZWF2ZScsICdkcmFnb3ZlcicsICdkcm9wJywgJ2RyYWdlbmQnXS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgICAgICAgIGpRdWVyeS5ldmVudC5maXhIb29rc1tldmVudE5hbWVdID0gewogICAgICAgICAgICBwcm9wczogWydkYXRhVHJhbnNmZXInXQogICAgICAgICAgfTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgX2V4cG9ydHMualF1ZXJ5ID0galF1ZXJ5ID0gdW5kZWZpbmVkOwogICAgICBfZXhwb3J0cy5qUXVlcnlEaXNhYmxlZCA9IGpRdWVyeURpc2FibGVkID0gdHJ1ZTsKICAgIH0KICB9Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi9zeXN0ZW0vanF1ZXJ5X2V2ZW50X2RlcHJlY2F0aW9uIiwgWyJleHBvcnRzIiwgIkBlbWJlci9kZWJ1ZyIsICJAZW1iZXIvLWludGVybmFscy9lbnZpcm9ubWVudCIsICJAZW1iZXIvLWludGVybmFscy91dGlscyIsICJAZW1iZXIvZGVwcmVjYXRlZC1mZWF0dXJlcyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9kZWJ1ZywgX2Vudmlyb25tZW50LCBfdXRpbHMsIF9kZXByZWNhdGVkRmVhdHVyZXMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSBhZGRKUXVlcnlFdmVudERlcHJlY2F0aW9uOwoKICAvKiBnbG9iYWwgUHJveHkgKi8KICBmdW5jdGlvbiBhZGRKUXVlcnlFdmVudERlcHJlY2F0aW9uKGpxRXZlbnQpIHsKICAgIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICYmIF9kZXByZWNhdGVkRmVhdHVyZXMuSlFVRVJZX0lOVEVHUkFUSU9OICYmIF91dGlscy5IQVNfTkFUSVZFX1BST1hZKSB7CiAgICAgIHZhciBib3VuZEZ1bmN0aW9ucyA9IG5ldyBNYXAoKTsgLy8gd3JhcCB0aGUgalF1ZXJ5IGV2ZW50IGluIGEgUHJveHkgdG8gYWRkIHRoZSBkZXByZWNhdGlvbiBtZXNzYWdlIGZvciBvcmlnaW5hbEV2ZW50LCBhY2NvcmRpbmcgdG8gUkZDIzI5NAogICAgICAvLyB3ZSBuZWVkIGEgbmF0aXZlIFByb3h5IGhlcmUsIHNvIHdlIGNhbiBtYWtlIHN1cmUgdGhhdCB0aGUgaW50ZXJuYWwgdXNlIG9mIG9yaWdpbmFsRXZlbnQgaW4galF1ZXJ5IGl0c2VsZiBkb2VzCiAgICAgIC8vIG5vdCB0cmlnZ2VyIGEgZGVwcmVjYXRpb24KCiAgICAgIHJldHVybiBuZXcgUHJveHkoanFFdmVudCwgewogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KHRhcmdldCwgbmFtZSkgewogICAgICAgICAgc3dpdGNoIChuYW1lKSB7CiAgICAgICAgICAgIGNhc2UgJ29yaWdpbmFsRXZlbnQnOgogICAgICAgICAgICAgIChmYWxzZSAmJiAhKGZ1bmN0aW9uIChFbWJlckVOVikgewogICAgICAgICAgICAgICAgLy8gdGhpcyBkZXByZWNhdGlvbiBpcyBpbnRlbnRpb25hbGx5IGNoZWNraW5nIGBnbG9iYWwuRW1iZXJFTlZgIC8KICAgICAgICAgICAgICAgIC8vIGBnbG9iYWwuRU5WYCBzbyB0aGF0IHdlIGNhbiBlbnN1cmUgd2UgX29ubHlfIGRlcHJlY2F0ZSBpbiB0aGUKICAgICAgICAgICAgICAgIC8vIGNhc2Ugd2hlcmUgalF1ZXJ5IGludGVncmF0aW9uIGlzIGVuYWJsZWQgaW1wbGljaXRseSAoZS5nLgogICAgICAgICAgICAgICAgLy8gImRlZmF1bHRlZCIgdG8gZW5hYmxlZCkgYXMgb3Bwb3NlZCB0byB3aGVuIHRoZSB1c2VyIGV4cGxpY2l0bHkKICAgICAgICAgICAgICAgIC8vIG9wdHMgaW4gdG8gdXNpbmcgalF1ZXJ5CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIEVtYmVyRU5WICE9PSAnb2JqZWN0JyB8fCBFbWJlckVOViA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuIEVtYmVyRU5WLl9KUVVFUllfSU5URUdSQVRJT04gPT09IHRydWU7CiAgICAgICAgICAgICAgfShfZW52aXJvbm1lbnQuZ2xvYmFsLkVtYmVyRU5WIHx8IF9lbnZpcm9ubWVudC5nbG9iYWwuRU5WKSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCdBY2Nlc3NpbmcgalF1ZXJ5LkV2ZW50IHNwZWNpZmljIHByb3BlcnRpZXMgaXMgZGVwcmVjYXRlZC4gRWl0aGVyIHVzZSB0aGUgZW1iZXItanF1ZXJ5LWxlZ2FjeSBhZGRvbiB0byBub3JtYWxpemUgZXZlbnRzIHRvIG5hdGl2ZSBldmVudHMsIG9yIGV4cGxpY2l0bHkgb3B0IGludG8galF1ZXJ5IGludGVncmF0aW9uIHVzaW5nIEBlbWJlci9vcHRpb25hbC1mZWF0dXJlcy4nLCBmdW5jdGlvbiAoRW1iZXJFTlYpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgRW1iZXJFTlYgIT09ICdvYmplY3QnIHx8IEVtYmVyRU5WID09PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICByZXR1cm4gRW1iZXJFTlYuX0pRVUVSWV9JTlRFR1JBVElPTiA9PT0gdHJ1ZTsKICAgICAgICAgICAgICB9KF9lbnZpcm9ubWVudC5nbG9iYWwuRW1iZXJFTlYgfHwgX2Vudmlyb25tZW50Lmdsb2JhbC5FTlYpLCB7CiAgICAgICAgICAgICAgICBpZDogJ2VtYmVyLXZpZXdzLmV2ZW50LWRpc3BhdGNoZXIuanF1ZXJ5LWV2ZW50JywKICAgICAgICAgICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9lbWJlcmpzLmNvbS9kZXByZWNhdGlvbnMvdjMueCN0b2NfanF1ZXJ5LWV2ZW50JwogICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0W25hbWVdOwogICAgICAgICAgICAvLyBwcm92aWRlIGFuIGVzY2FwZSBoYXRjaCBmb3IgZW1iZXItanF1ZXJ5LWxlZ2FjeSB0byBhY2Nlc3Mgb3JpZ2luYWxFdmVudCB3aXRob3V0IGEgZGVwcmVjYXRpb24KCiAgICAgICAgICAgIGNhc2UgJ19fb3JpZ2luYWxFdmVudCc6CiAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldC5vcmlnaW5hbEV2ZW50OwoKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBpZiAodHlwZW9mIHRhcmdldFtuYW1lXSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgLy8gY2FjaGUgZnVuY3Rpb25zIGZvciByZXVzZQogICAgICAgICAgICAgICAgaWYgKCFib3VuZEZ1bmN0aW9ucy5oYXMobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgLy8gZm9yIGpRdWVyeS5FdmVudCBtZXRob2RzIGNhbGwgdGhlbSB3aXRoIGB0YXJnZXRgIGFzIHRoZSBgdGhpc2AgY29udGV4dCwgc28gdGhleSB3aWxsIGFjY2VzcwogICAgICAgICAgICAgICAgICAvLyBgb3JpZ2luYWxFdmVudGAgZnJvbSB0aGUgb3JpZ2luYWwgalF1ZXJ5IGV2ZW50LCBub3Qgb3VyIHByb3h5LCB0aHVzIG5vdCB0cmlnZ2VyIHRoZSBkZXByZWNhdGlvbgogICAgICAgICAgICAgICAgICBib3VuZEZ1bmN0aW9ucy5zZXQobmFtZSwgdGFyZ2V0W25hbWVdLmJpbmQodGFyZ2V0KSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGJvdW5kRnVuY3Rpb25zLmdldChuYW1lKTsKICAgICAgICAgICAgICB9IC8vIHNhbWUgZm9yIGpRdWVyeSdzIGdldHRlciBmdW5jdGlvbnMgZm9yIHNpbXBsZSBwcm9wZXJ0aWVzCgoKICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0W25hbWVdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIGpxRXZlbnQ7CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvc3lzdGVtL2xvb2t1cF9wYXJ0aWFsIiwgWyJleHBvcnRzIiwgIkBlbWJlci9kZWJ1ZyIsICJAZW1iZXIvZXJyb3IiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZGVidWcsIF9lcnJvcikgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IGxvb2t1cFBhcnRpYWw7CiAgX2V4cG9ydHMuaGFzUGFydGlhbCA9IGhhc1BhcnRpYWw7CgogIGZ1bmN0aW9uIHBhcnNlVW5kZXJzY29yZWROYW1lKHRlbXBsYXRlTmFtZSkgewogICAgdmFyIG5hbWVQYXJ0cyA9IHRlbXBsYXRlTmFtZS5zcGxpdCgnLycpOwogICAgdmFyIGxhc3RQYXJ0ID0gbmFtZVBhcnRzW25hbWVQYXJ0cy5sZW5ndGggLSAxXTsKICAgIG5hbWVQYXJ0c1tuYW1lUGFydHMubGVuZ3RoIC0gMV0gPSAiXyIgKyBsYXN0UGFydDsKICAgIHJldHVybiBuYW1lUGFydHMuam9pbignLycpOwogIH0KCiAgZnVuY3Rpb24gbG9va3VwUGFydGlhbCh0ZW1wbGF0ZU5hbWUsIG93bmVyKSB7CiAgICBpZiAodGVtcGxhdGVOYW1lID09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciB0ZW1wbGF0ZSA9IHRlbXBsYXRlRm9yKG93bmVyLCBwYXJzZVVuZGVyc2NvcmVkTmFtZSh0ZW1wbGF0ZU5hbWUpLCB0ZW1wbGF0ZU5hbWUpOwogICAgKGZhbHNlICYmICEoQm9vbGVhbih0ZW1wbGF0ZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiVW5hYmxlIHRvIGZpbmQgcGFydGlhbCB3aXRoIG5hbWUgXCIiICsgdGVtcGxhdGVOYW1lICsgIlwiIiwgQm9vbGVhbih0ZW1wbGF0ZSkpKTsKICAgIHJldHVybiB0ZW1wbGF0ZTsKICB9CgogIGZ1bmN0aW9uIGhhc1BhcnRpYWwobmFtZSwgb3duZXIpIHsKICAgIGlmICghb3duZXIpIHsKICAgICAgdGhyb3cgbmV3IF9lcnJvci5kZWZhdWx0KCdDb250YWluZXIgd2FzIG5vdCBmb3VuZCB3aGVuIGxvb2tpbmcgdXAgYSB2aWV3cyB0ZW1wbGF0ZS4gJyArICdUaGlzIGlzIG1vc3QgbGlrZWx5IGR1ZSB0byBtYW51YWxseSBpbnN0YW50aWF0aW5nIGFuIEVtYmVyLlZpZXcuICcgKyAnU2VlOiBodHRwOi8vZ2l0LmlvL0VLUHBuQScpOwogICAgfQoKICAgIHJldHVybiBvd25lci5oYXNSZWdpc3RyYXRpb24oInRlbXBsYXRlOiIgKyBwYXJzZVVuZGVyc2NvcmVkTmFtZShuYW1lKSkgfHwgb3duZXIuaGFzUmVnaXN0cmF0aW9uKCJ0ZW1wbGF0ZToiICsgbmFtZSk7CiAgfQoKICBmdW5jdGlvbiB0ZW1wbGF0ZUZvcihvd25lciwgdW5kZXJzY29yZWQsIG5hbWUpIHsKICAgIGlmICghbmFtZSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgKGZhbHNlICYmICEobmFtZS5pbmRleE9mKCcuJykgPT09IC0xKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoInRlbXBsYXRlTmFtZXMgYXJlIG5vdCBhbGxvd2VkIHRvIGNvbnRhaW4gcGVyaW9kczogIiArIG5hbWUsIG5hbWUuaW5kZXhPZignLicpID09PSAtMSkpOwoKICAgIGlmICghb3duZXIpIHsKICAgICAgdGhyb3cgbmV3IF9lcnJvci5kZWZhdWx0KCdDb250YWluZXIgd2FzIG5vdCBmb3VuZCB3aGVuIGxvb2tpbmcgdXAgYSB2aWV3cyB0ZW1wbGF0ZS4gJyArICdUaGlzIGlzIG1vc3QgbGlrZWx5IGR1ZSB0byBtYW51YWxseSBpbnN0YW50aWF0aW5nIGFuIEVtYmVyLlZpZXcuICcgKyAnU2VlOiBodHRwOi8vZ2l0LmlvL0VLUHBuQScpOwogICAgfQoKICAgIHJldHVybiBvd25lci5sb29rdXAoInRlbXBsYXRlOiIgKyB1bmRlcnNjb3JlZCkgfHwgb3duZXIubG9va3VwKCJ0ZW1wbGF0ZToiICsgbmFtZSk7CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvc3lzdGVtL3V0aWxzIiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL293bmVyIiwgIkBlbWJlci8taW50ZXJuYWxzL3V0aWxzIiwgIkBlbWJlci9kZWJ1ZyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9vd25lciwgX3V0aWxzLCBfZGVidWcpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmlzU2ltcGxlQ2xpY2sgPSBpc1NpbXBsZUNsaWNrOwogIF9leHBvcnRzLmNvbnN0cnVjdFN0eWxlRGVwcmVjYXRpb25NZXNzYWdlID0gY29uc3RydWN0U3R5bGVEZXByZWNhdGlvbk1lc3NhZ2U7CiAgX2V4cG9ydHMuZ2V0Um9vdFZpZXdzID0gZ2V0Um9vdFZpZXdzOwogIF9leHBvcnRzLmdldFZpZXdJZCA9IGdldFZpZXdJZDsKICBfZXhwb3J0cy5nZXRFbGVtZW50VmlldyA9IGdldEVsZW1lbnRWaWV3OwogIF9leHBvcnRzLmdldFZpZXdFbGVtZW50ID0gZ2V0Vmlld0VsZW1lbnQ7CiAgX2V4cG9ydHMuc2V0RWxlbWVudFZpZXcgPSBzZXRFbGVtZW50VmlldzsKICBfZXhwb3J0cy5zZXRWaWV3RWxlbWVudCA9IHNldFZpZXdFbGVtZW50OwogIF9leHBvcnRzLmNsZWFyRWxlbWVudFZpZXcgPSBjbGVhckVsZW1lbnRWaWV3OwogIF9leHBvcnRzLmNsZWFyVmlld0VsZW1lbnQgPSBjbGVhclZpZXdFbGVtZW50OwogIF9leHBvcnRzLmdldENoaWxkVmlld3MgPSBnZXRDaGlsZFZpZXdzOwogIF9leHBvcnRzLmluaXRDaGlsZFZpZXdzID0gaW5pdENoaWxkVmlld3M7CiAgX2V4cG9ydHMuYWRkQ2hpbGRWaWV3ID0gYWRkQ2hpbGRWaWV3OwogIF9leHBvcnRzLmNvbGxlY3RDaGlsZFZpZXdzID0gY29sbGVjdENoaWxkVmlld3M7CiAgX2V4cG9ydHMuZ2V0Vmlld0JvdW5kcyA9IGdldFZpZXdCb3VuZHM7CiAgX2V4cG9ydHMuZ2V0Vmlld1JhbmdlID0gZ2V0Vmlld1JhbmdlOwogIF9leHBvcnRzLmdldFZpZXdDbGllbnRSZWN0cyA9IGdldFZpZXdDbGllbnRSZWN0czsKICBfZXhwb3J0cy5nZXRWaWV3Qm91bmRpbmdDbGllbnRSZWN0ID0gZ2V0Vmlld0JvdW5kaW5nQ2xpZW50UmVjdDsKICBfZXhwb3J0cy5tYXRjaGVzID0gbWF0Y2hlczsKICBfZXhwb3J0cy5jb250YWlucyA9IGNvbnRhaW5zOwogIF9leHBvcnRzLmVsTWF0Y2hlcyA9IHZvaWQgMDsKCiAgLyogZ2xvYmFscyBFbGVtZW50ICovCgogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwogIGZ1bmN0aW9uIGlzU2ltcGxlQ2xpY2soZXZlbnQpIHsKICAgIHZhciBtb2RpZmllciA9IGV2ZW50LnNoaWZ0S2V5IHx8IGV2ZW50Lm1ldGFLZXkgfHwgZXZlbnQuYWx0S2V5IHx8IGV2ZW50LmN0cmxLZXk7CiAgICB2YXIgc2Vjb25kYXJ5Q2xpY2sgPSBldmVudC53aGljaCA+IDE7IC8vIElFOSBtYXkgcmV0dXJuIHVuZGVmaW5lZAoKICAgIHJldHVybiAhbW9kaWZpZXIgJiYgIXNlY29uZGFyeUNsaWNrOwogIH0KCiAgZnVuY3Rpb24gY29uc3RydWN0U3R5bGVEZXByZWNhdGlvbk1lc3NhZ2UoYWZmZWN0ZWRTdHlsZSkgewogICAgcmV0dXJuICcnICsgJ0JpbmRpbmcgc3R5bGUgYXR0cmlidXRlcyBtYXkgaW50cm9kdWNlIGNyb3NzLXNpdGUgc2NyaXB0aW5nIHZ1bG5lcmFiaWxpdGllczsgJyArICdwbGVhc2UgZW5zdXJlIHRoYXQgdmFsdWVzIGJlaW5nIGJvdW5kIGFyZSBwcm9wZXJseSBlc2NhcGVkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgJyArICdpbmNsdWRpbmcgaG93IHRvIGRpc2FibGUgdGhpcyB3YXJuaW5nLCBzZWUgJyArICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92MS54LyN0b2NfYmluZGluZy1zdHlsZS1hdHRyaWJ1dGVzLiAnICsgJ1N0eWxlIGFmZmVjdGVkOiAiJyArIGFmZmVjdGVkU3R5bGUgKyAnIic7CiAgfQogIC8qKgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZ2V0Um9vdFZpZXdzCiAgICBAcGFyYW0ge09iamVjdH0gb3duZXIKICAqLwoKCiAgZnVuY3Rpb24gZ2V0Um9vdFZpZXdzKG93bmVyKSB7CiAgICB2YXIgcmVnaXN0cnkgPSBvd25lci5sb29rdXAoJy12aWV3LXJlZ2lzdHJ5Om1haW4nKTsKICAgIHZhciByb290Vmlld3MgPSBbXTsKICAgIE9iamVjdC5rZXlzKHJlZ2lzdHJ5KS5mb3JFYWNoKGZ1bmN0aW9uIChpZCkgewogICAgICB2YXIgdmlldyA9IHJlZ2lzdHJ5W2lkXTsKCiAgICAgIGlmICh2aWV3LnBhcmVudFZpZXcgPT09IG51bGwpIHsKICAgICAgICByb290Vmlld3MucHVzaCh2aWV3KTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcm9vdFZpZXdzOwogIH0KICAvKioKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGdldFZpZXdJZAogICAgQHBhcmFtIHtFbWJlci5WaWV3fSB2aWV3CiAgICovCgoKICBmdW5jdGlvbiBnZXRWaWV3SWQodmlldykgewogICAgaWYgKHZpZXcudGFnTmFtZSAhPT0gJycgJiYgdmlldy5lbGVtZW50SWQpIHsKICAgICAgcmV0dXJuIHZpZXcuZWxlbWVudElkOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICgwLCBfdXRpbHMuZ3VpZEZvcikodmlldyk7CiAgICB9CiAgfQoKICB2YXIgRUxFTUVOVF9WSUVXID0gbmV3IFdlYWtNYXAoKTsKICB2YXIgVklFV19FTEVNRU5UID0gbmV3IFdlYWtNYXAoKTsKCiAgZnVuY3Rpb24gZ2V0RWxlbWVudFZpZXcoZWxlbWVudCkgewogICAgcmV0dXJuIEVMRU1FTlRfVklFVy5nZXQoZWxlbWVudCkgfHwgbnVsbDsKICB9CiAgLyoqCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBnZXRWaWV3RWxlbWVudAogICAgQHBhcmFtIHtFbWJlci5WaWV3fSB2aWV3CiAgICovCgoKICBmdW5jdGlvbiBnZXRWaWV3RWxlbWVudCh2aWV3KSB7CiAgICByZXR1cm4gVklFV19FTEVNRU5ULmdldCh2aWV3KSB8fCBudWxsOwogIH0KCiAgZnVuY3Rpb24gc2V0RWxlbWVudFZpZXcoZWxlbWVudCwgdmlldykgewogICAgRUxFTUVOVF9WSUVXLnNldChlbGVtZW50LCB2aWV3KTsKICB9CgogIGZ1bmN0aW9uIHNldFZpZXdFbGVtZW50KHZpZXcsIGVsZW1lbnQpIHsKICAgIFZJRVdfRUxFTUVOVC5zZXQodmlldywgZWxlbWVudCk7CiAgfSAvLyBUaGVzZSBhcmUgbm90IG5lZWRlZCBmb3IgR0MsIGJ1dCBmb3IgY29ycmVjdG5lc3MuIFdlIHdhbnQgdG8gYmUgYWJsZSB0bwogIC8vIG51bGwtb3V0IHRoZXNlIGxpbmtzIHdoaWxlIHRoZSBvYmplY3RzIGFyZSBzdGlsbCBsaXZlLiBTcGVjaWZpY2FsbHksIGluCiAgLy8gdGhpcyBjYXNlLCB3ZSB3YW50IHRvIHByZXZlbnQgYWNjZXNzIHRvIHRoZSBlbGVtZW50IChhbmQgdmljZSB2ZXJzZSkgZHVyaW5nCiAgLy8gZGVzdHJ1Y3Rpb24uCgoKICBmdW5jdGlvbiBjbGVhckVsZW1lbnRWaWV3KGVsZW1lbnQpIHsKICAgIEVMRU1FTlRfVklFVy5kZWxldGUoZWxlbWVudCk7CiAgfQoKICBmdW5jdGlvbiBjbGVhclZpZXdFbGVtZW50KHZpZXcpIHsKICAgIFZJRVdfRUxFTUVOVC5kZWxldGUodmlldyk7CiAgfQoKICB2YXIgQ0hJTERfVklFV19JRFMgPSBuZXcgV2Vha01hcCgpOwogIC8qKgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZ2V0Q2hpbGRWaWV3cwogICAgQHBhcmFtIHtFbWJlci5WaWV3fSB2aWV3CiAgKi8KCiAgZnVuY3Rpb24gZ2V0Q2hpbGRWaWV3cyh2aWV3KSB7CiAgICB2YXIgb3duZXIgPSAoMCwgX293bmVyLmdldE93bmVyKSh2aWV3KTsKICAgIHZhciByZWdpc3RyeSA9IG93bmVyLmxvb2t1cCgnLXZpZXctcmVnaXN0cnk6bWFpbicpOwogICAgcmV0dXJuIGNvbGxlY3RDaGlsZFZpZXdzKHZpZXcsIHJlZ2lzdHJ5KTsKICB9CgogIGZ1bmN0aW9uIGluaXRDaGlsZFZpZXdzKHZpZXcpIHsKICAgIHZhciBjaGlsZFZpZXdzID0gbmV3IFNldCgpOwogICAgQ0hJTERfVklFV19JRFMuc2V0KHZpZXcsIGNoaWxkVmlld3MpOwogICAgcmV0dXJuIGNoaWxkVmlld3M7CiAgfQoKICBmdW5jdGlvbiBhZGRDaGlsZFZpZXcocGFyZW50LCBjaGlsZCkgewogICAgdmFyIGNoaWxkVmlld3MgPSBDSElMRF9WSUVXX0lEUy5nZXQocGFyZW50KTsKCiAgICBpZiAoY2hpbGRWaWV3cyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGNoaWxkVmlld3MgPSBpbml0Q2hpbGRWaWV3cyhwYXJlbnQpOwogICAgfQoKICAgIGNoaWxkVmlld3MuYWRkKGdldFZpZXdJZChjaGlsZCkpOwogIH0KCiAgZnVuY3Rpb24gY29sbGVjdENoaWxkVmlld3ModmlldywgcmVnaXN0cnkpIHsKICAgIHZhciB2aWV3cyA9IFtdOwogICAgdmFyIGNoaWxkVmlld3MgPSBDSElMRF9WSUVXX0lEUy5nZXQodmlldyk7CgogICAgaWYgKGNoaWxkVmlld3MgIT09IHVuZGVmaW5lZCkgewogICAgICBjaGlsZFZpZXdzLmZvckVhY2goZnVuY3Rpb24gKGlkKSB7CiAgICAgICAgdmFyIHZpZXcgPSByZWdpc3RyeVtpZF07CgogICAgICAgIGlmICh2aWV3ICYmICF2aWV3LmlzRGVzdHJveWluZyAmJiAhdmlldy5pc0Rlc3Ryb3llZCkgewogICAgICAgICAgdmlld3MucHVzaCh2aWV3KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIHJldHVybiB2aWV3czsKICB9CiAgLyoqCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBnZXRWaWV3Qm91bmRzCiAgICBAcGFyYW0ge0VtYmVyLlZpZXd9IHZpZXcKICAqLwoKCiAgZnVuY3Rpb24gZ2V0Vmlld0JvdW5kcyh2aWV3KSB7CiAgICByZXR1cm4gdmlldy5yZW5kZXJlci5nZXRCb3VuZHModmlldyk7CiAgfQogIC8qKgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZ2V0Vmlld1JhbmdlCiAgICBAcGFyYW0ge0VtYmVyLlZpZXd9IHZpZXcKICAqLwoKCiAgZnVuY3Rpb24gZ2V0Vmlld1JhbmdlKHZpZXcpIHsKICAgIHZhciBib3VuZHMgPSBnZXRWaWV3Qm91bmRzKHZpZXcpOwogICAgdmFyIHJhbmdlID0gZG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKICAgIHJhbmdlLnNldFN0YXJ0QmVmb3JlKGJvdW5kcy5maXJzdE5vZGUpOwogICAgcmFuZ2Uuc2V0RW5kQWZ0ZXIoYm91bmRzLmxhc3ROb2RlKTsKICAgIHJldHVybiByYW5nZTsKICB9CiAgLyoqCiAgICBgZ2V0Vmlld0NsaWVudFJlY3RzYCBwcm92aWRlcyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgcG9zaXRpb24gb2YgdGhlIGJvcmRlcgogICAgYm94IGVkZ2VzIG9mIGEgdmlldyByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnQuCiAgCiAgICBJdCBpcyBvbmx5IGludGVuZGVkIHRvIGJlIHVzZWQgYnkgZGV2ZWxvcG1lbnQgdG9vbHMgbGlrZSB0aGUgRW1iZXIgSW5zcGVjdG9yCiAgICBhbmQgbWF5IG5vdCB3b3JrIG9uIG9sZGVyIGJyb3dzZXJzLgogIAogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZ2V0Vmlld0NsaWVudFJlY3RzCiAgICBAcGFyYW0ge0VtYmVyLlZpZXd9IHZpZXcKICAqLwoKCiAgZnVuY3Rpb24gZ2V0Vmlld0NsaWVudFJlY3RzKHZpZXcpIHsKICAgIHZhciByYW5nZSA9IGdldFZpZXdSYW5nZSh2aWV3KTsKICAgIHJldHVybiByYW5nZS5nZXRDbGllbnRSZWN0cygpOwogIH0KICAvKioKICAgIGBnZXRWaWV3Qm91bmRpbmdDbGllbnRSZWN0YCBwcm92aWRlcyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgcG9zaXRpb24gb2YgdGhlCiAgICBib3VuZGluZyBib3JkZXIgYm94IGVkZ2VzIG9mIGEgdmlldyByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnQuCiAgCiAgICBJdCBpcyBvbmx5IGludGVuZGVkIHRvIGJlIHVzZWQgYnkgZGV2ZWxvcG1lbnQgdG9vbHMgbGlrZSB0aGUgRW1iZXIgSW5zcGVjdG9yCiAgICBhbmQgbWF5IG5vdCB3b3JrIG9uIG9sZGVyIGJyb3dzZXJzLgogIAogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZ2V0Vmlld0JvdW5kaW5nQ2xpZW50UmVjdAogICAgQHBhcmFtIHtFbWJlci5WaWV3fSB2aWV3CiAgKi8KCgogIGZ1bmN0aW9uIGdldFZpZXdCb3VuZGluZ0NsaWVudFJlY3QodmlldykgewogICAgdmFyIHJhbmdlID0gZ2V0Vmlld1JhbmdlKHZpZXcpOwogICAgcmV0dXJuIHJhbmdlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogIH0KICAvKioKICAgIERldGVybWluZXMgaWYgdGhlIGVsZW1lbnQgbWF0Y2hlcyB0aGUgc3BlY2lmaWVkIHNlbGVjdG9yLgogIAogICAgQHByaXZhdGUKICAgIEBtZXRob2QgbWF0Y2hlcwogICAgQHBhcmFtIHtET01FbGVtZW50fSBlbAogICAgQHBhcmFtIHtTdHJpbmd9IHNlbGVjdG9yCiAgKi8KCgogIHZhciBlbE1hdGNoZXMgPSB0eXBlb2YgRWxlbWVudCAhPT0gJ3VuZGVmaW5lZCcgPyBFbGVtZW50LnByb3RvdHlwZS5tYXRjaGVzIHx8IEVsZW1lbnQucHJvdG90eXBlWydtYXRjaGVzU2VsZWN0b3InXSB8fCBFbGVtZW50LnByb3RvdHlwZVsnbW96TWF0Y2hlc1NlbGVjdG9yJ10gfHwgRWxlbWVudC5wcm90b3R5cGVbJ21zTWF0Y2hlc1NlbGVjdG9yJ10gfHwgRWxlbWVudC5wcm90b3R5cGVbJ29NYXRjaGVzU2VsZWN0b3InXSB8fCBFbGVtZW50LnByb3RvdHlwZVsnd2Via2l0TWF0Y2hlc1NlbGVjdG9yJ10gOiB1bmRlZmluZWQ7CiAgX2V4cG9ydHMuZWxNYXRjaGVzID0gZWxNYXRjaGVzOwoKICBmdW5jdGlvbiBtYXRjaGVzKGVsLCBzZWxlY3RvcikgewogICAgKGZhbHNlICYmICEoZWxNYXRjaGVzICE9PSB1bmRlZmluZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnY2Fubm90IGNhbGwgYG1hdGNoZXNgIGluIGZhc3Rib290IG1vZGUnLCBlbE1hdGNoZXMgIT09IHVuZGVmaW5lZCkpOwogICAgcmV0dXJuIGVsTWF0Y2hlcy5jYWxsKGVsLCBzZWxlY3Rvcik7CiAgfQoKICBmdW5jdGlvbiBjb250YWlucyhhLCBiKSB7CiAgICBpZiAoYS5jb250YWlucyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiBhLmNvbnRhaW5zKGIpOwogICAgfQoKICAgIHZhciBjdXJyZW50ID0gYi5wYXJlbnROb2RlOwoKICAgIHdoaWxlIChjdXJyZW50ICYmIChjdXJyZW50ID0gY3VycmVudC5wYXJlbnROb2RlKSkgewogICAgICBpZiAoY3VycmVudCA9PT0gYSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH0KfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvdmlld3MvbGliL3ZpZXdzL2NvcmVfdmlldyIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lIiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi92aWV3cy9zdGF0ZXMiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfcnVudGltZSwgX3N0YXRlcykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgICBgRW1iZXIuQ29yZVZpZXdgIGlzIGFuIGFic3RyYWN0IGNsYXNzIHRoYXQgZXhpc3RzIHRvIGdpdmUgdmlldy1saWtlIGJlaGF2aW9yCiAgICB0byBib3RoIEVtYmVyJ3MgbWFpbiB2aWV3IGNsYXNzIGBDb21wb25lbnRgIGFuZCBvdGhlciBjbGFzc2VzIHRoYXQgZG9uJ3QgbmVlZAogICAgdGhlIGZ1bGwgZnVuY3Rpb25hbGl0eSBvZiBgQ29tcG9uZW50YC4KICAKICAgIFVubGVzcyB5b3UgaGF2ZSBzcGVjaWZpYyBuZWVkcyBmb3IgYENvcmVWaWV3YCwgeW91IHdpbGwgdXNlIGBDb21wb25lbnRgCiAgICBpbiB5b3VyIGFwcGxpY2F0aW9ucy4KICAKICAgIEBjbGFzcyBDb3JlVmlldwogICAgQG5hbWVzcGFjZSBFbWJlcgogICAgQGV4dGVuZHMgRW1iZXJPYmplY3QKICAgIEBkZXByZWNhdGVkIFVzZSBgQ29tcG9uZW50YCBpbnN0ZWFkLgogICAgQHVzZXMgRXZlbnRlZAogICAgQHVzZXMgRW1iZXIuQWN0aW9uSGFuZGxlcgogICAgQHByaXZhdGUKICAqLwogIHZhciBDb3JlVmlldyA9IF9ydW50aW1lLkZyYW1ld29ya09iamVjdC5leHRlbmQoX3J1bnRpbWUuRXZlbnRlZCwgX3J1bnRpbWUuQWN0aW9uSGFuZGxlciwgewogICAgaXNWaWV3OiB0cnVlLAogICAgX3N0YXRlczogX3N0YXRlcy5kZWZhdWx0LAogICAgaW5pdDogZnVuY3Rpb24gaW5pdCgpIHsKICAgICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgIHRoaXMuX3N0YXRlID0gJ3ByZVJlbmRlcic7CiAgICAgIHRoaXMuX2N1cnJlbnRTdGF0ZSA9IHRoaXMuX3N0YXRlcy5wcmVSZW5kZXI7CgogICAgICBpZiAoIXRoaXMucmVuZGVyZXIpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBpbnN0YW50aWF0ZSBhIGNvbXBvbmVudCB3aXRob3V0IGEgcmVuZGVyZXIuIFBsZWFzZSBlbnN1cmUgdGhhdCB5b3UgYXJlIGNyZWF0aW5nICIgKyB0aGlzICsgIiB3aXRoIGEgcHJvcGVyIGNvbnRhaW5lci9yZWdpc3RyeS4iKTsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAgSWYgdGhlIHZpZXcgaXMgY3VycmVudGx5IGluc2VydGVkIGludG8gdGhlIERPTSBvZiBhIHBhcmVudCB2aWV3LCB0aGlzCiAgICAgIHByb3BlcnR5IHdpbGwgcG9pbnQgdG8gdGhlIHBhcmVudCBvZiB0aGUgdmlldy4KICAgICAgIEBwcm9wZXJ0eSBwYXJlbnRWaWV3CiAgICAgIEB0eXBlIEVtYmVyLlZpZXcKICAgICAgQGRlZmF1bHQgbnVsbAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIHBhcmVudFZpZXc6IG51bGwsCiAgICBpbnN0cnVtZW50RGV0YWlsczogZnVuY3Rpb24gaW5zdHJ1bWVudERldGFpbHMoaGFzaCkgewogICAgICBoYXNoLm9iamVjdCA9IHRoaXMudG9TdHJpbmcoKTsKICAgICAgaGFzaC5jb250YWluZXJLZXkgPSB0aGlzLl9kZWJ1Z0NvbnRhaW5lcktleTsKICAgICAgaGFzaC52aWV3ID0gdGhpczsKICAgICAgcmV0dXJuIGhhc2g7CiAgICB9LAoKICAgIC8qKgogICAgICBPdmVycmlkZSB0aGUgZGVmYXVsdCBldmVudCBmaXJpbmcgZnJvbSBgRXZlbnRlZGAgdG8KICAgICAgYWxzbyBjYWxsIG1ldGhvZHMgd2l0aCB0aGUgZ2l2ZW4gbmFtZS4KICAgICAgIEBtZXRob2QgdHJpZ2dlcgogICAgICBAcGFyYW0gbmFtZSB7U3RyaW5nfQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIHRyaWdnZXI6IGZ1bmN0aW9uIHRyaWdnZXIobmFtZSkgewogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuID4gMSA/IF9sZW4gLSAxIDogMCksIF9rZXkgPSAxOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICB2YXIgbWV0aG9kID0gdGhpc1tuYW1lXTsKCiAgICAgIGlmICh0eXBlb2YgbWV0aG9kID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfQogICAgfSwKICAgIGhhczogZnVuY3Rpb24gaGFzKG5hbWUpIHsKICAgICAgcmV0dXJuIHR5cGVvZiB0aGlzW25hbWVdID09PSAnZnVuY3Rpb24nIHx8IHRoaXMuX3N1cGVyKG5hbWUpOwogICAgfQogIH0pOwoKICBDb3JlVmlldy5yZW9wZW5DbGFzcyh7CiAgICBpc1ZpZXdGYWN0b3J5OiB0cnVlCiAgfSk7CiAgdmFyIF9kZWZhdWx0ID0gQ29yZVZpZXc7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvdmlld3Mvc3RhdGVzIiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi92aWV3cy9zdGF0ZXMvcHJlX3JlbmRlciIsICJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvdmlld3Mvc3RhdGVzL2hhc19lbGVtZW50IiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi92aWV3cy9zdGF0ZXMvaW5fZG9tIiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi92aWV3cy9zdGF0ZXMvZGVzdHJveWluZyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9wcmVfcmVuZGVyLCBfaGFzX2VsZW1lbnQsIF9pbl9kb20sIF9kZXN0cm95aW5nKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKgogICAgRGVzY3JpYmUgaG93IHRoZSBzcGVjaWZpZWQgYWN0aW9ucyBzaG91bGQgYmVoYXZlIGluIHRoZSB2YXJpb3VzCiAgICBzdGF0ZXMgdGhhdCBhIHZpZXcgY2FuIGV4aXN0IGluLiBQb3NzaWJsZSBzdGF0ZXM6CiAgCiAgICAqIHByZVJlbmRlcjogd2hlbiBhIHZpZXcgaXMgZmlyc3QgaW5zdGFudGlhdGVkLCBhbmQgYWZ0ZXIgaXRzCiAgICAgIGVsZW1lbnQgd2FzIGRlc3Ryb3llZCwgaXQgaXMgaW4gdGhlIHByZVJlbmRlciBzdGF0ZQogICAgKiBoYXNFbGVtZW50OiB0aGUgRE9NIHJlcHJlc2VudGF0aW9uIG9mIHRoZSB2aWV3IGlzIGNyZWF0ZWQsCiAgICAgIGFuZCBpcyByZWFkeSB0byBiZSBpbnNlcnRlZAogICAgKiBpbkRPTTogb25jZSBhIHZpZXcgaGFzIGJlZW4gaW5zZXJ0ZWQgaW50byB0aGUgRE9NIGl0IGlzIGluCiAgICAgIHRoZSBpbkRPTSBzdGF0ZS4gQSB2aWV3IHNwZW5kcyB0aGUgdmFzdCBtYWpvcml0eSBvZiBpdHMKICAgICAgZXhpc3RlbmNlIGluIHRoaXMgc3RhdGUuCiAgICAqIGRlc3Ryb3llZDogb25jZSBhIHZpZXcgaGFzIGJlZW4gZGVzdHJveWVkICh1c2luZyB0aGUgZGVzdHJveQogICAgICBtZXRob2QpLCBpdCBpcyBpbiB0aGlzIHN0YXRlLiBObyBmdXJ0aGVyIGFjdGlvbnMgY2FuIGJlIGludm9rZWQKICAgICAgb24gYSBkZXN0cm95ZWQgdmlldy4KICAqLwogIHZhciBzdGF0ZXMgPSBPYmplY3QuZnJlZXplKHsKICAgIHByZVJlbmRlcjogX3ByZV9yZW5kZXIuZGVmYXVsdCwKICAgIGluRE9NOiBfaW5fZG9tLmRlZmF1bHQsCiAgICBoYXNFbGVtZW50OiBfaGFzX2VsZW1lbnQuZGVmYXVsdCwKICAgIGRlc3Ryb3lpbmc6IF9kZXN0cm95aW5nLmRlZmF1bHQKICB9KTsKICB2YXIgX2RlZmF1bHQgPSBzdGF0ZXM7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvdmlld3Mvc3RhdGVzL2RlZmF1bHQiLCBbImV4cG9ydHMiLCAiQGVtYmVyL2Vycm9yIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2Vycm9yKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwogIHZhciBfZGVmYXVsdCA9IHsKICAgIC8vIGFwcGVuZENoaWxkIGlzIG9ubHkgbGVnYWwgd2hpbGUgcmVuZGVyaW5nIHRoZSBidWZmZXIuCiAgICBhcHBlbmRDaGlsZDogZnVuY3Rpb24gYXBwZW5kQ2hpbGQoKSB7CiAgICAgIHRocm93IG5ldyBfZXJyb3IuZGVmYXVsdCgiWW91IGNhbid0IHVzZSBhcHBlbmRDaGlsZCBvdXRzaWRlIG9mIHRoZSByZW5kZXJpbmcgcHJvY2VzcyIpOwogICAgfSwKICAgIC8vIEhhbmRsZSBldmVudHMgZnJvbSBgRW1iZXIuRXZlbnREaXNwYXRjaGVyYAogICAgaGFuZGxlRXZlbnQ6IGZ1bmN0aW9uIGhhbmRsZUV2ZW50KCkgewogICAgICByZXR1cm4gdHJ1ZTsgLy8gY29udGludWUgZXZlbnQgcHJvcGFnYXRpb24KICAgIH0sCiAgICByZXJlbmRlcjogZnVuY3Rpb24gcmVyZW5kZXIoKSB7fSwKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7fQogIH07CgogIHZhciBfZGVmYXVsdDIgPSBPYmplY3QuZnJlZXplKF9kZWZhdWx0KTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0MjsKfSk7CmRlZmluZSgiQGVtYmVyLy1pbnRlcm5hbHMvdmlld3MvbGliL3ZpZXdzL3N0YXRlcy9kZXN0cm95aW5nIiwgWyJleHBvcnRzIiwgIkBlbWJlci9wb2x5ZmlsbHMiLCAiQGVtYmVyL2Vycm9yIiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi92aWV3cy9zdGF0ZXMvZGVmYXVsdCJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9wb2x5ZmlsbHMsIF9lcnJvciwgX2RlZmF1bHQzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwogIHZhciBkZXN0cm95aW5nID0gKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7fSwgX2RlZmF1bHQzLmRlZmF1bHQsIHsKICAgIGFwcGVuZENoaWxkOiBmdW5jdGlvbiBhcHBlbmRDaGlsZCgpIHsKICAgICAgdGhyb3cgbmV3IF9lcnJvci5kZWZhdWx0KCJZb3UgY2FuJ3QgY2FsbCBhcHBlbmRDaGlsZCBvbiBhIHZpZXcgYmVpbmcgZGVzdHJveWVkIik7CiAgICB9LAogICAgcmVyZW5kZXI6IGZ1bmN0aW9uIHJlcmVuZGVyKCkgewogICAgICB0aHJvdyBuZXcgX2Vycm9yLmRlZmF1bHQoIllvdSBjYW4ndCBjYWxsIHJlcmVuZGVyIG9uIGEgdmlldyBiZWluZyBkZXN0cm95ZWQiKTsKICAgIH0KICB9KTsKCiAgdmFyIF9kZWZhdWx0MiA9IE9iamVjdC5mcmVlemUoZGVzdHJveWluZyk7CgogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDI7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi92aWV3cy9zdGF0ZXMvaGFzX2VsZW1lbnQiLCBbImV4cG9ydHMiLCAiQGVtYmVyL3BvbHlmaWxscyIsICJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvdmlld3Mvc3RhdGVzL2RlZmF1bHQiLCAiQGVtYmVyL3J1bmxvb3AiLCAiQGVtYmVyL2luc3RydW1lbnRhdGlvbiJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9wb2x5ZmlsbHMsIF9kZWZhdWx0MywgX3J1bmxvb3AsIF9pbnN0cnVtZW50YXRpb24pIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CiAgdmFyIGhhc0VsZW1lbnQgPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCBfZGVmYXVsdDMuZGVmYXVsdCwgewogICAgcmVyZW5kZXI6IGZ1bmN0aW9uIHJlcmVuZGVyKHZpZXcpIHsKICAgICAgdmlldy5yZW5kZXJlci5yZXJlbmRlcih2aWV3KTsKICAgIH0sCiAgICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95KHZpZXcpIHsKICAgICAgdmlldy5yZW5kZXJlci5yZW1vdmUodmlldyk7CiAgICB9LAogICAgLy8gSGFuZGxlIGV2ZW50cyBmcm9tIGBFbWJlci5FdmVudERpc3BhdGNoZXJgCiAgICBoYW5kbGVFdmVudDogZnVuY3Rpb24gaGFuZGxlRXZlbnQodmlldywgZXZlbnROYW1lLCBldmVudCkgewogICAgICBpZiAodmlldy5oYXMoZXZlbnROYW1lKSkgewogICAgICAgIC8vIEhhbmRsZXIgc2hvdWxkIGJlIGFibGUgdG8gcmUtZGlzcGF0Y2ggZXZlbnRzLCBzbyB3ZSBkb24ndAogICAgICAgIC8vIHByZXZlbnREZWZhdWx0IG9yIHN0b3BQcm9wYWdhdGlvbi4KICAgICAgICByZXR1cm4gKDAsIF9pbnN0cnVtZW50YXRpb24uZmxhZ2dlZEluc3RydW1lbnQpKCJpbnRlcmFjdGlvbi4iICsgZXZlbnROYW1lLCB7CiAgICAgICAgICBldmVudDogZXZlbnQsCiAgICAgICAgICB2aWV3OiB2aWV3CiAgICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuICgwLCBfcnVubG9vcC5qb2luKSh2aWV3LCB2aWV3LnRyaWdnZXIsIGV2ZW50TmFtZSwgZXZlbnQpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0cnVlOyAvLyBjb250aW51ZSBldmVudCBwcm9wYWdhdGlvbgogICAgICB9CiAgICB9CiAgfSk7CgogIHZhciBfZGVmYXVsdDIgPSBPYmplY3QuZnJlZXplKGhhc0VsZW1lbnQpOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQyOwp9KTsKZGVmaW5lKCJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvdmlld3Mvc3RhdGVzL2luX2RvbSIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy91dGlscyIsICJAZW1iZXIvcG9seWZpbGxzIiwgIkBlbWJlci9lcnJvciIsICJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvdmlld3Mvc3RhdGVzL2hhc19lbGVtZW50Il0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX3V0aWxzLCBfcG9seWZpbGxzLCBfZXJyb3IsIF9oYXNfZWxlbWVudCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKICB2YXIgaW5ET00gPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCBfaGFzX2VsZW1lbnQuZGVmYXVsdCwgewogICAgZW50ZXI6IGZ1bmN0aW9uIGVudGVyKHZpZXcpIHsKICAgICAgLy8gUmVnaXN0ZXIgdGhlIHZpZXcgZm9yIGV2ZW50IGhhbmRsaW5nLiBUaGlzIGhhc2ggaXMgdXNlZCBieQogICAgICAvLyBFbWJlci5FdmVudERpc3BhdGNoZXIgdG8gZGlzcGF0Y2ggaW5jb21pbmcgZXZlbnRzLgogICAgICB2aWV3LnJlbmRlcmVyLnJlZ2lzdGVyKHZpZXcpOwoKICAgICAgaWYgKGZhbHNlCiAgICAgIC8qIERFQlVHICovCiAgICAgICkgewogICAgICAgIHZhciBlbGVtZW50SWQgPSB2aWV3LmVsZW1lbnRJZDsKCiAgICAgICAgaWYgKHRydWUKICAgICAgICAvKiBFTUJFUl9NRVRBTF9UUkFDS0VEX1BST1BFUlRJRVMgKi8KICAgICAgICApIHsKICAgICAgICAgICAgKDAsIF91dGlscy50ZWFyZG93bk1hbmRhdG9yeVNldHRlcikodmlldywgJ2VsZW1lbnRJZCcpOwogICAgICAgICAgfQoKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodmlldywgJ2VsZW1lbnRJZCcsIHsKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnRJZDsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldCgpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IF9lcnJvci5kZWZhdWx0KCJDaGFuZ2luZyBhIHZpZXcncyBlbGVtZW50SWQgYWZ0ZXIgY3JlYXRpb24gaXMgbm90IGFsbG93ZWQiKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIGV4aXQ6IGZ1bmN0aW9uIGV4aXQodmlldykgewogICAgICB2aWV3LnJlbmRlcmVyLnVucmVnaXN0ZXIodmlldyk7CiAgICB9CiAgfSk7CgogIHZhciBfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoaW5ET00pOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzL2xpYi92aWV3cy9zdGF0ZXMvcHJlX3JlbmRlciIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy92aWV3cy9saWIvdmlld3Mvc3RhdGVzL2RlZmF1bHQiLCAiQGVtYmVyL3BvbHlmaWxscyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9kZWZhdWx0MywgX3BvbHlmaWxscykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKICB2YXIgcHJlUmVuZGVyID0gKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7fSwgX2RlZmF1bHQzLmRlZmF1bHQpOwoKICB2YXIgX2RlZmF1bHQyID0gT2JqZWN0LmZyZWV6ZShwcmVSZW5kZXIpOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQyOwp9KTsKZGVmaW5lKCJAZW1iZXIvYXBwbGljYXRpb24vZ2xvYmFscy1yZXNvbHZlciIsIFsiZXhwb3J0cyIsICJlbWJlci1iYWJlbCIsICJAZW1iZXIvLWludGVybmFscy91dGlscyIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCIsICJAZW1iZXIvZGVidWciLCAiQGVtYmVyL3N0cmluZyIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lIiwgIkBlbWJlci9hcHBsaWNhdGlvbi9saWIvdmFsaWRhdGUtdHlwZSIsICJAZW1iZXIvLWludGVybmFscy9nbGltbWVyIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2VtYmVyQmFiZWwsIF91dGlscywgX21ldGFsLCBfZGVidWcsIF9zdHJpbmcsIF9ydW50aW1lLCBfdmFsaWRhdGVUeXBlLCBfZ2xpbW1lcikgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvYXBwbGljYXRpb24KICAqLwoKICAvKioKICAgIFRoZSBEZWZhdWx0UmVzb2x2ZXIgZGVmaW5lcyB0aGUgZGVmYXVsdCBsb29rdXAgcnVsZXMgdG8gcmVzb2x2ZQogICAgY29udGFpbmVyIGxvb2t1cHMgYmVmb3JlIGNvbnN1bHRpbmcgdGhlIGNvbnRhaW5lciBmb3IgcmVnaXN0ZXJlZAogICAgaXRlbXM6CiAgCiAgICAqIHRlbXBsYXRlcyBhcmUgbG9va2VkIHVwIG9uIGBFbWJlci5URU1QTEFURVNgCiAgICAqIG90aGVyIG5hbWVzIGFyZSBsb29rZWQgdXAgb24gdGhlIGFwcGxpY2F0aW9uIGFmdGVyIGNvbnZlcnRpbmcKICAgICAgdGhlIG5hbWUuIEZvciBleGFtcGxlLCBgY29udHJvbGxlcjpwb3N0YCBsb29rcyB1cAogICAgICBgQXBwLlBvc3RDb250cm9sbGVyYCBieSBkZWZhdWx0LgogICAgKiB0aGVyZSBhcmUgc29tZSBudWFuY2VzIChzZWUgZXhhbXBsZXMgYmVsb3cpCiAgCiAgICAjIyMgSG93IFJlc29sdmluZyBXb3JrcwogIAogICAgVGhlIGNvbnRhaW5lciBjYWxscyB0aGlzIG9iamVjdCdzIGByZXNvbHZlYCBtZXRob2Qgd2l0aCB0aGUKICAgIGBmdWxsTmFtZWAgYXJndW1lbnQuCiAgCiAgICBJdCBmaXJzdCBwYXJzZXMgdGhlIGZ1bGxOYW1lIGludG8gYW4gb2JqZWN0IHVzaW5nIGBwYXJzZU5hbWVgLgogIAogICAgVGhlbiBpdCBjaGVja3MgZm9yIHRoZSBwcmVzZW5jZSBvZiBhIHR5cGUtc3BlY2lmaWMgaW5zdGFuY2UKICAgIG1ldGhvZCBvZiB0aGUgZm9ybSBgcmVzb2x2ZVtUeXBlXWAgYW5kIGNhbGxzIGl0IGlmIGl0IGV4aXN0cy4KICAgIEZvciBleGFtcGxlIGlmIGl0IHdhcyByZXNvbHZpbmcgJ3RlbXBsYXRlOnBvc3QnLCBpdCB3b3VsZCBjYWxsCiAgICB0aGUgYHJlc29sdmVUZW1wbGF0ZWAgbWV0aG9kLgogIAogICAgSXRzIGxhc3QgcmVzb3J0IGlzIHRvIGNhbGwgdGhlIGByZXNvbHZlT3RoZXJgIG1ldGhvZC4KICAKICAgIFRoZSBtZXRob2RzIG9mIHRoaXMgb2JqZWN0IGFyZSBkZXNpZ25lZCB0byBiZSBlYXN5IHRvIG92ZXJyaWRlCiAgICBpbiBhIHN1YmNsYXNzLiBGb3IgZXhhbXBsZSwgeW91IGNvdWxkIGVuaGFuY2UgaG93IGEgdGVtcGxhdGUKICAgIGlzIHJlc29sdmVkIGxpa2Ugc286CiAgCiAgICBgYGBhcHAvYXBwLmpzCiAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAgIGltcG9ydCBHbG9iYWxzUmVzb2x2ZXIgZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uL2dsb2JhbHMtcmVzb2x2ZXInOwogIAogICAgQXBwID0gQXBwbGljYXRpb24uY3JlYXRlKHsKICAgICAgUmVzb2x2ZXI6IEdsb2JhbHNSZXNvbHZlci5leHRlbmQoewogICAgICAgIHJlc29sdmVUZW1wbGF0ZShwYXJzZWROYW1lKSB7CiAgICAgICAgICBsZXQgcmVzb2x2ZWRUZW1wbGF0ZSA9IHRoaXMuX3N1cGVyKHBhcnNlZE5hbWUpOwogICAgICAgICAgaWYgKHJlc29sdmVkVGVtcGxhdGUpIHsgcmV0dXJuIHJlc29sdmVkVGVtcGxhdGU7IH0KICAKICAgICAgICAgIHJldHVybiBFbWJlci5URU1QTEFURVNbJ25vdF9mb3VuZCddOwogICAgICAgIH0KICAgICAgfSkKICAgIH0pOwogICAgYGBgCiAgCiAgICBTb21lIGV4YW1wbGVzIG9mIGhvdyBuYW1lcyBhcmUgcmVzb2x2ZWQ6CiAgCiAgICBgYGB0ZXh0CiAgICAndGVtcGxhdGU6cG9zdCcgICAgICAgICAgIC8vPT4gRW1iZXIuVEVNUExBVEVTWydwb3N0J10KICAgICd0ZW1wbGF0ZTpwb3N0cy9ieWxpbmUnICAgLy89PiBFbWJlci5URU1QTEFURVNbJ3Bvc3RzL2J5bGluZSddCiAgICAndGVtcGxhdGU6cG9zdHMuYnlsaW5lJyAgIC8vPT4gRW1iZXIuVEVNUExBVEVTWydwb3N0cy9ieWxpbmUnXQogICAgJ3RlbXBsYXRlOmJsb2dQb3N0JyAgICAgICAvLz0+IEVtYmVyLlRFTVBMQVRFU1snYmxvZy1wb3N0J10KICAgICdjb250cm9sbGVyOnBvc3QnICAgICAgICAgLy89PiBBcHAuUG9zdENvbnRyb2xsZXIKICAgICdjb250cm9sbGVyOnBvc3RzLmluZGV4JyAgLy89PiBBcHAuUG9zdHNJbmRleENvbnRyb2xsZXIKICAgICdjb250cm9sbGVyOmJsb2cvcG9zdCcgICAgLy89PiBCbG9nLlBvc3RDb250cm9sbGVyCiAgICAnY29udHJvbGxlcjpiYXNpYycgICAgICAgIC8vPT4gQ29udHJvbGxlcgogICAgJ3JvdXRlOnBvc3QnICAgICAgICAgICAgICAvLz0+IEFwcC5Qb3N0Um91dGUKICAgICdyb3V0ZTpwb3N0cy5pbmRleCcgICAgICAgLy89PiBBcHAuUG9zdHNJbmRleFJvdXRlCiAgICAncm91dGU6YmxvZy9wb3N0JyAgICAgICAgIC8vPT4gQmxvZy5Qb3N0Um91dGUKICAgICdyb3V0ZTpiYXNpYycgICAgICAgICAgICAgLy89PiBSb3V0ZQogICAgJ2Zvbzpwb3N0JyAgICAgICAgICAgICAgICAvLz0+IEFwcC5Qb3N0Rm9vCiAgICAnbW9kZWw6cG9zdCcgICAgICAgICAgICAgIC8vPT4gQXBwLlBvc3QKICAgIGBgYAogIAogICAgQGNsYXNzIEdsb2JhbHNSZXNvbHZlcgogICAgQGV4dGVuZHMgRW1iZXJPYmplY3QKICAgIEBwdWJsaWMKICAqLwogIHZhciBEZWZhdWx0UmVzb2x2ZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0VtYmVyT2JqZWN0KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoRGVmYXVsdFJlc29sdmVyLCBfRW1iZXJPYmplY3QpOwoKICAgIGZ1bmN0aW9uIERlZmF1bHRSZXNvbHZlcigpIHsKICAgICAgcmV0dXJuIF9FbWJlck9iamVjdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICB9CgogICAgRGVmYXVsdFJlc29sdmVyLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShwcm9wcykgewogICAgICAvLyBETyBOT1QgUkVNT1ZFIGV2ZW4gdGhvdWdoIHRoaXMgZG9lc24ndCBkbyBhbnl0aGluZwogICAgICAvLyBUaGlzIGlzIHJlcXVpcmVkIGZvciBhIEZpcmVGb3ggNjArIEpJVCBidWcgd2l0aCBvdXIgdGVzdHMuCiAgICAgIC8vIHdpdGhvdXQgaXQsIGNyZWF0ZShwcm9wcykgaW4gb3VyIHRlc3RzIHdvdWxkIGxvc2UgcHJvcHMgb24gYSBkZW9wdC4KICAgICAgcmV0dXJuIF9FbWJlck9iamVjdC5jcmVhdGUuY2FsbCh0aGlzLCBwcm9wcyk7CiAgICB9CiAgICAvKioKICAgICAgVGhpcyB3aWxsIGJlIHNldCB0byB0aGUgQXBwbGljYXRpb24gaW5zdGFuY2Ugd2hlbiBpdCBpcwogICAgICBjcmVhdGVkLgogICAgICAgQHByb3BlcnR5IG5hbWVzcGFjZQogICAgICBAcHVibGljCiAgICAqLwogICAgOwoKICAgIHZhciBfcHJvdG8gPSBEZWZhdWx0UmVzb2x2ZXIucHJvdG90eXBlOwoKICAgIF9wcm90by5pbml0ID0gZnVuY3Rpb24gaW5pdCgpIHsKICAgICAgdGhpcy5fcGFyc2VOYW1lQ2FjaGUgPSAoMCwgX3V0aWxzLmRpY3Rpb25hcnkpKG51bGwpOwogICAgfTsKCiAgICBfcHJvdG8ubm9ybWFsaXplID0gZnVuY3Rpb24gbm9ybWFsaXplKGZ1bGxOYW1lKSB7CiAgICAgIHZhciBfZnVsbE5hbWUkc3BsaXQgPSBmdWxsTmFtZS5zcGxpdCgnOicpLAogICAgICAgICAgdHlwZSA9IF9mdWxsTmFtZSRzcGxpdFswXSwKICAgICAgICAgIG5hbWUgPSBfZnVsbE5hbWUkc3BsaXRbMV07CgogICAgICAoZmFsc2UgJiYgIShmdWxsTmFtZS5zcGxpdCgnOicpLmxlbmd0aCA9PT0gMikgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUcmllZCB0byBub3JtYWxpemUgYSBjb250YWluZXIgbmFtZSB3aXRob3V0IGEgY29sb24gKDopIGluIGl0LiAnICsgJ1lvdSBwcm9iYWJseSB0cmllZCB0byBsb29rdXAgYSBuYW1lIHRoYXQgZGlkIG5vdCBjb250YWluIGEgdHlwZSwgJyArICdhIGNvbG9uLCBhbmQgYSBuYW1lLiBBIHByb3BlciBsb29rdXAgbmFtZSB3b3VsZCBiZSBgdmlldzpwb3N0YC4nLCBmdWxsTmFtZS5zcGxpdCgnOicpLmxlbmd0aCA9PT0gMikpOwoKICAgICAgaWYgKHR5cGUgIT09ICd0ZW1wbGF0ZScpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gbmFtZS5yZXBsYWNlKC8oXC58X3wtKS4vZywgZnVuY3Rpb24gKG0pIHsKICAgICAgICAgIHJldHVybiBtLmNoYXJBdCgxKS50b1VwcGVyQ2FzZSgpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB0eXBlICsgIjoiICsgcmVzdWx0OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmdWxsTmFtZTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCB2aWEgdGhlIGNvbnRhaW5lcidzIHJlc29sdmVyIG1ldGhvZC4KICAgICAgSXQgcGFyc2VzIHRoZSBwcm92aWRlZCBgZnVsbE5hbWVgIGFuZCB0aGVuIGxvb2tzIHVwIGFuZAogICAgICByZXR1cm5zIHRoZSBhcHByb3ByaWF0ZSB0ZW1wbGF0ZSBvciBjbGFzcy4KICAgICAgIEBtZXRob2QgcmVzb2x2ZQogICAgICBAcGFyYW0ge1N0cmluZ30gZnVsbE5hbWUgdGhlIGxvb2t1cCBzdHJpbmcKICAgICAgQHJldHVybiB7T2JqZWN0fSB0aGUgcmVzb2x2ZWQgZmFjdG9yeQogICAgICBAcHVibGljCiAgICAqLwogICAgOwoKICAgIF9wcm90by5yZXNvbHZlID0gZnVuY3Rpb24gcmVzb2x2ZShmdWxsTmFtZSkgewogICAgICB2YXIgcGFyc2VkTmFtZSA9IHRoaXMucGFyc2VOYW1lKGZ1bGxOYW1lKTsKICAgICAgdmFyIHJlc29sdmVNZXRob2ROYW1lID0gcGFyc2VkTmFtZS5yZXNvbHZlTWV0aG9kTmFtZTsKICAgICAgdmFyIHJlc29sdmVkOwoKICAgICAgaWYgKHRoaXNbcmVzb2x2ZU1ldGhvZE5hbWVdKSB7CiAgICAgICAgcmVzb2x2ZWQgPSB0aGlzW3Jlc29sdmVNZXRob2ROYW1lXShwYXJzZWROYW1lKTsKICAgICAgfQoKICAgICAgcmVzb2x2ZWQgPSByZXNvbHZlZCB8fCB0aGlzLnJlc29sdmVPdGhlcihwYXJzZWROYW1lKTsKCiAgICAgIGlmIChmYWxzZQogICAgICAvKiBERUJVRyAqLwogICAgICApIHsKICAgICAgICBpZiAocGFyc2VkTmFtZS5yb290ICYmIHBhcnNlZE5hbWUucm9vdC5MT0dfUkVTT0xWRVIpIHsKICAgICAgICAgIHRoaXMuX2xvZ0xvb2t1cChyZXNvbHZlZCwgcGFyc2VkTmFtZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAocmVzb2x2ZWQpIHsKICAgICAgICAoMCwgX3ZhbGlkYXRlVHlwZS5kZWZhdWx0KShyZXNvbHZlZCwgcGFyc2VkTmFtZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXNvbHZlZDsKICAgIH0KICAgIC8qKgogICAgICBDb252ZXJ0IHRoZSBzdHJpbmcgbmFtZSBvZiB0aGUgZm9ybSAndHlwZTpuYW1lJyB0bwogICAgICBhIEphdmFzY3JpcHQgb2JqZWN0IHdpdGggdGhlIHBhcnNlZCBhc3BlY3RzIG9mIHRoZSBuYW1lCiAgICAgIGJyb2tlbiBvdXQuCiAgICAgICBAcGFyYW0ge1N0cmluZ30gZnVsbE5hbWUgdGhlIGxvb2t1cCBzdHJpbmcKICAgICAgQG1ldGhvZCBwYXJzZU5hbWUKICAgICAgQHByb3RlY3RlZAogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucGFyc2VOYW1lID0gZnVuY3Rpb24gcGFyc2VOYW1lKGZ1bGxOYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLl9wYXJzZU5hbWVDYWNoZVtmdWxsTmFtZV0gfHwgKHRoaXMuX3BhcnNlTmFtZUNhY2hlW2Z1bGxOYW1lXSA9IHRoaXMuX3BhcnNlTmFtZShmdWxsTmFtZSkpOwogICAgfTsKCiAgICBfcHJvdG8uX3BhcnNlTmFtZSA9IGZ1bmN0aW9uIF9wYXJzZU5hbWUoZnVsbE5hbWUpIHsKICAgICAgdmFyIF9mdWxsTmFtZSRzcGxpdDIgPSBmdWxsTmFtZS5zcGxpdCgnOicpLAogICAgICAgICAgdHlwZSA9IF9mdWxsTmFtZSRzcGxpdDJbMF0sCiAgICAgICAgICBmdWxsTmFtZVdpdGhvdXRUeXBlID0gX2Z1bGxOYW1lJHNwbGl0MlsxXTsKCiAgICAgIHZhciBuYW1lID0gZnVsbE5hbWVXaXRob3V0VHlwZTsKICAgICAgdmFyIG5hbWVzcGFjZSA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAnbmFtZXNwYWNlJyk7CiAgICAgIHZhciByb290ID0gbmFtZXNwYWNlOwogICAgICB2YXIgbGFzdFNsYXNoSW5kZXggPSBuYW1lLmxhc3RJbmRleE9mKCcvJyk7CiAgICAgIHZhciBkaXJuYW1lID0gbGFzdFNsYXNoSW5kZXggIT09IC0xID8gbmFtZS5zbGljZSgwLCBsYXN0U2xhc2hJbmRleCkgOiBudWxsOwoKICAgICAgaWYgKHR5cGUgIT09ICd0ZW1wbGF0ZScgJiYgbGFzdFNsYXNoSW5kZXggIT09IC0xKSB7CiAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnLycpOwogICAgICAgIG5hbWUgPSBwYXJ0c1twYXJ0cy5sZW5ndGggLSAxXTsKICAgICAgICB2YXIgbmFtZXNwYWNlTmFtZSA9ICgwLCBfc3RyaW5nLmNhcGl0YWxpemUpKHBhcnRzLnNsaWNlKDAsIC0xKS5qb2luKCcuJykpOwogICAgICAgIHJvb3QgPSAoMCwgX21ldGFsLmZpbmROYW1lc3BhY2UpKG5hbWVzcGFjZU5hbWUpOwogICAgICAgIChmYWxzZSAmJiAhKHJvb3QpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IGFyZSBsb29raW5nIGZvciBhICIgKyBuYW1lICsgIiAiICsgdHlwZSArICIgaW4gdGhlICIgKyBuYW1lc3BhY2VOYW1lICsgIiBuYW1lc3BhY2UsIGJ1dCB0aGUgbmFtZXNwYWNlIGNvdWxkIG5vdCBiZSBmb3VuZCIsIHJvb3QpKTsKICAgICAgfQoKICAgICAgdmFyIHJlc29sdmVNZXRob2ROYW1lID0gZnVsbE5hbWVXaXRob3V0VHlwZSA9PT0gJ21haW4nID8gJ01haW4nIDogKDAsIF9zdHJpbmcuY2xhc3NpZnkpKHR5cGUpOwoKICAgICAgaWYgKCEobmFtZSAmJiB0eXBlKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkludmFsaWQgZnVsbE5hbWU6IGAiICsgZnVsbE5hbWUgKyAiYCwgbXVzdCBiZSBvZiB0aGUgZm9ybSBgdHlwZTpuYW1lYCAiKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHsKICAgICAgICBmdWxsTmFtZTogZnVsbE5hbWUsCiAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICBmdWxsTmFtZVdpdGhvdXRUeXBlOiBmdWxsTmFtZVdpdGhvdXRUeXBlLAogICAgICAgIGRpcm5hbWU6IGRpcm5hbWUsCiAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICByb290OiByb290LAogICAgICAgIHJlc29sdmVNZXRob2ROYW1lOiAicmVzb2x2ZSIgKyByZXNvbHZlTWV0aG9kTmFtZQogICAgICB9OwogICAgfQogICAgLyoqCiAgICAgIFJldHVybnMgYSBodW1hbi1yZWFkYWJsZSBkZXNjcmlwdGlvbiBmb3IgYSBmdWxsTmFtZS4gVXNlZCBieSB0aGUKICAgICAgQXBwbGljYXRpb24gbmFtZXNwYWNlIGluIGFzc2VydGlvbnMgdG8gZGVzY3JpYmUgdGhlCiAgICAgIHByZWNpc2UgbmFtZSBvZiB0aGUgY2xhc3MgdGhhdCBFbWJlciBpcyBsb29raW5nIGZvciwgcmF0aGVyIHRoYW4KICAgICAgY29udGFpbmVyIGtleXMuCiAgICAgICBAcGFyYW0ge1N0cmluZ30gZnVsbE5hbWUgdGhlIGxvb2t1cCBzdHJpbmcKICAgICAgQG1ldGhvZCBsb29rdXBEZXNjcmlwdGlvbgogICAgICBAcHJvdGVjdGVkCiAgICAqLwogICAgOwoKICAgIF9wcm90by5sb29rdXBEZXNjcmlwdGlvbiA9IGZ1bmN0aW9uIGxvb2t1cERlc2NyaXB0aW9uKGZ1bGxOYW1lKSB7CiAgICAgIHZhciBwYXJzZWROYW1lID0gdGhpcy5wYXJzZU5hbWUoZnVsbE5hbWUpOwogICAgICB2YXIgZGVzY3JpcHRpb247CgogICAgICBpZiAocGFyc2VkTmFtZS50eXBlID09PSAndGVtcGxhdGUnKSB7CiAgICAgICAgcmV0dXJuICJ0ZW1wbGF0ZSBhdCAiICsgcGFyc2VkTmFtZS5mdWxsTmFtZVdpdGhvdXRUeXBlLnJlcGxhY2UoL1wuL2csICcvJyk7CiAgICAgIH0KCiAgICAgIGRlc2NyaXB0aW9uID0gcGFyc2VkTmFtZS5yb290ICsgIi4iICsgKDAsIF9zdHJpbmcuY2xhc3NpZnkpKHBhcnNlZE5hbWUubmFtZSkucmVwbGFjZSgvXC4vZywgJycpOwoKICAgICAgaWYgKHBhcnNlZE5hbWUudHlwZSAhPT0gJ21vZGVsJykgewogICAgICAgIGRlc2NyaXB0aW9uICs9ICgwLCBfc3RyaW5nLmNsYXNzaWZ5KShwYXJzZWROYW1lLnR5cGUpOwogICAgICB9CgogICAgICByZXR1cm4gZGVzY3JpcHRpb247CiAgICB9OwoKICAgIF9wcm90by5tYWtlVG9TdHJpbmcgPSBmdW5jdGlvbiBtYWtlVG9TdHJpbmcoZmFjdG9yeSkgewogICAgICByZXR1cm4gZmFjdG9yeS50b1N0cmluZygpOwogICAgfQogICAgLyoqCiAgICAgIEdpdmVuIGEgcGFyc2VOYW1lIG9iamVjdCAob3V0cHV0IGZyb20gYHBhcnNlTmFtZWApLCBhcHBseQogICAgICB0aGUgY29udmVudGlvbnMgZXhwZWN0ZWQgYnkgYFJvdXRlcmAKICAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXJzZWROYW1lIGEgcGFyc2VOYW1lIG9iamVjdCB3aXRoIHRoZSBwYXJzZWQKICAgICAgICBmdWxsTmFtZSBsb29rdXAgc3RyaW5nCiAgICAgIEBtZXRob2QgdXNlUm91dGVyTmFtaW5nCiAgICAgIEBwcm90ZWN0ZWQKICAgICovCiAgICA7CgogICAgX3Byb3RvLnVzZVJvdXRlck5hbWluZyA9IGZ1bmN0aW9uIHVzZVJvdXRlck5hbWluZyhwYXJzZWROYW1lKSB7CiAgICAgIGlmIChwYXJzZWROYW1lLm5hbWUgPT09ICdiYXNpYycpIHsKICAgICAgICBwYXJzZWROYW1lLm5hbWUgPSAnJzsKICAgICAgfSBlbHNlIHsKICAgICAgICBwYXJzZWROYW1lLm5hbWUgPSBwYXJzZWROYW1lLm5hbWUucmVwbGFjZSgvXC4vZywgJ18nKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgIExvb2sgdXAgdGhlIHRlbXBsYXRlIGluIEVtYmVyLlRFTVBMQVRFUwogICAgICAgQHBhcmFtIHtPYmplY3R9IHBhcnNlZE5hbWUgYSBwYXJzZU5hbWUgb2JqZWN0IHdpdGggdGhlIHBhcnNlZAogICAgICAgIGZ1bGxOYW1lIGxvb2t1cCBzdHJpbmcKICAgICAgQG1ldGhvZCByZXNvbHZlVGVtcGxhdGUKICAgICAgQHByb3RlY3RlZAogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucmVzb2x2ZVRlbXBsYXRlID0gZnVuY3Rpb24gcmVzb2x2ZVRlbXBsYXRlKHBhcnNlZE5hbWUpIHsKICAgICAgdmFyIHRlbXBsYXRlTmFtZSA9IHBhcnNlZE5hbWUuZnVsbE5hbWVXaXRob3V0VHlwZS5yZXBsYWNlKC9cLi9nLCAnLycpOwogICAgICByZXR1cm4gKDAsIF9nbGltbWVyLmdldFRlbXBsYXRlKSh0ZW1wbGF0ZU5hbWUpIHx8ICgwLCBfZ2xpbW1lci5nZXRUZW1wbGF0ZSkoKDAsIF9zdHJpbmcuZGVjYW1lbGl6ZSkodGVtcGxhdGVOYW1lKSk7CiAgICB9CiAgICAvKioKICAgICAgTG9va3VwIHRoZSB2aWV3IHVzaW5nIGByZXNvbHZlT3RoZXJgCiAgICAgICBAcGFyYW0ge09iamVjdH0gcGFyc2VkTmFtZSBhIHBhcnNlTmFtZSBvYmplY3Qgd2l0aCB0aGUgcGFyc2VkCiAgICAgICAgZnVsbE5hbWUgbG9va3VwIHN0cmluZwogICAgICBAbWV0aG9kIHJlc29sdmVWaWV3CiAgICAgIEBwcm90ZWN0ZWQKICAgICovCiAgICA7CgogICAgX3Byb3RvLnJlc29sdmVWaWV3ID0gZnVuY3Rpb24gcmVzb2x2ZVZpZXcocGFyc2VkTmFtZSkgewogICAgICB0aGlzLnVzZVJvdXRlck5hbWluZyhwYXJzZWROYW1lKTsKICAgICAgcmV0dXJuIHRoaXMucmVzb2x2ZU90aGVyKHBhcnNlZE5hbWUpOwogICAgfQogICAgLyoqCiAgICAgIExvb2t1cCB0aGUgY29udHJvbGxlciB1c2luZyBgcmVzb2x2ZU90aGVyYAogICAgICAgQHBhcmFtIHtPYmplY3R9IHBhcnNlZE5hbWUgYSBwYXJzZU5hbWUgb2JqZWN0IHdpdGggdGhlIHBhcnNlZAogICAgICAgIGZ1bGxOYW1lIGxvb2t1cCBzdHJpbmcKICAgICAgQG1ldGhvZCByZXNvbHZlQ29udHJvbGxlcgogICAgICBAcHJvdGVjdGVkCiAgICAqLwogICAgOwoKICAgIF9wcm90by5yZXNvbHZlQ29udHJvbGxlciA9IGZ1bmN0aW9uIHJlc29sdmVDb250cm9sbGVyKHBhcnNlZE5hbWUpIHsKICAgICAgdGhpcy51c2VSb3V0ZXJOYW1pbmcocGFyc2VkTmFtZSk7CiAgICAgIHJldHVybiB0aGlzLnJlc29sdmVPdGhlcihwYXJzZWROYW1lKTsKICAgIH0KICAgIC8qKgogICAgICBMb29rdXAgdGhlIHJvdXRlIHVzaW5nIGByZXNvbHZlT3RoZXJgCiAgICAgICBAcGFyYW0ge09iamVjdH0gcGFyc2VkTmFtZSBhIHBhcnNlTmFtZSBvYmplY3Qgd2l0aCB0aGUgcGFyc2VkCiAgICAgICAgZnVsbE5hbWUgbG9va3VwIHN0cmluZwogICAgICBAbWV0aG9kIHJlc29sdmVSb3V0ZQogICAgICBAcHJvdGVjdGVkCiAgICAqLwogICAgOwoKICAgIF9wcm90by5yZXNvbHZlUm91dGUgPSBmdW5jdGlvbiByZXNvbHZlUm91dGUocGFyc2VkTmFtZSkgewogICAgICB0aGlzLnVzZVJvdXRlck5hbWluZyhwYXJzZWROYW1lKTsKICAgICAgcmV0dXJuIHRoaXMucmVzb2x2ZU90aGVyKHBhcnNlZE5hbWUpOwogICAgfQogICAgLyoqCiAgICAgIExvb2t1cCB0aGUgbW9kZWwgb24gdGhlIEFwcGxpY2F0aW9uIG5hbWVzcGFjZQogICAgICAgQHBhcmFtIHtPYmplY3R9IHBhcnNlZE5hbWUgYSBwYXJzZU5hbWUgb2JqZWN0IHdpdGggdGhlIHBhcnNlZAogICAgICAgIGZ1bGxOYW1lIGxvb2t1cCBzdHJpbmcKICAgICAgQG1ldGhvZCByZXNvbHZlTW9kZWwKICAgICAgQHByb3RlY3RlZAogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucmVzb2x2ZU1vZGVsID0gZnVuY3Rpb24gcmVzb2x2ZU1vZGVsKHBhcnNlZE5hbWUpIHsKICAgICAgdmFyIGNsYXNzTmFtZSA9ICgwLCBfc3RyaW5nLmNsYXNzaWZ5KShwYXJzZWROYW1lLm5hbWUpOwogICAgICB2YXIgZmFjdG9yeSA9ICgwLCBfbWV0YWwuZ2V0KShwYXJzZWROYW1lLnJvb3QsIGNsYXNzTmFtZSk7CiAgICAgIHJldHVybiBmYWN0b3J5OwogICAgfQogICAgLyoqCiAgICAgIExvb2sgdXAgdGhlIHNwZWNpZmllZCBvYmplY3QgKGZyb20gcGFyc2VkTmFtZSkgb24gdGhlIGFwcHJvcHJpYXRlCiAgICAgIG5hbWVzcGFjZSAodXN1YWxseSBvbiB0aGUgQXBwbGljYXRpb24pCiAgICAgICBAcGFyYW0ge09iamVjdH0gcGFyc2VkTmFtZSBhIHBhcnNlTmFtZSBvYmplY3Qgd2l0aCB0aGUgcGFyc2VkCiAgICAgICAgZnVsbE5hbWUgbG9va3VwIHN0cmluZwogICAgICBAbWV0aG9kIHJlc29sdmVIZWxwZXIKICAgICAgQHByb3RlY3RlZAogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucmVzb2x2ZUhlbHBlciA9IGZ1bmN0aW9uIHJlc29sdmVIZWxwZXIocGFyc2VkTmFtZSkgewogICAgICByZXR1cm4gdGhpcy5yZXNvbHZlT3RoZXIocGFyc2VkTmFtZSk7CiAgICB9CiAgICAvKioKICAgICAgTG9vayB1cCB0aGUgc3BlY2lmaWVkIG9iamVjdCAoZnJvbSBwYXJzZWROYW1lKSBvbiB0aGUgYXBwcm9wcmlhdGUKICAgICAgbmFtZXNwYWNlICh1c3VhbGx5IG9uIHRoZSBBcHBsaWNhdGlvbikKICAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXJzZWROYW1lIGEgcGFyc2VOYW1lIG9iamVjdCB3aXRoIHRoZSBwYXJzZWQKICAgICAgICBmdWxsTmFtZSBsb29rdXAgc3RyaW5nCiAgICAgIEBtZXRob2QgcmVzb2x2ZU90aGVyCiAgICAgIEBwcm90ZWN0ZWQKICAgICovCiAgICA7CgogICAgX3Byb3RvLnJlc29sdmVPdGhlciA9IGZ1bmN0aW9uIHJlc29sdmVPdGhlcihwYXJzZWROYW1lKSB7CiAgICAgIHZhciBjbGFzc05hbWUgPSAoMCwgX3N0cmluZy5jbGFzc2lmeSkocGFyc2VkTmFtZS5uYW1lKSArICgwLCBfc3RyaW5nLmNsYXNzaWZ5KShwYXJzZWROYW1lLnR5cGUpOwogICAgICB2YXIgZmFjdG9yeSA9ICgwLCBfbWV0YWwuZ2V0KShwYXJzZWROYW1lLnJvb3QsIGNsYXNzTmFtZSk7CiAgICAgIHJldHVybiBmYWN0b3J5OwogICAgfTsKCiAgICBfcHJvdG8ucmVzb2x2ZU1haW4gPSBmdW5jdGlvbiByZXNvbHZlTWFpbihwYXJzZWROYW1lKSB7CiAgICAgIHZhciBjbGFzc05hbWUgPSAoMCwgX3N0cmluZy5jbGFzc2lmeSkocGFyc2VkTmFtZS50eXBlKTsKICAgICAgcmV0dXJuICgwLCBfbWV0YWwuZ2V0KShwYXJzZWROYW1lLnJvb3QsIGNsYXNzTmFtZSk7CiAgICB9CiAgICAvKioKICAgICAgVXNlZCB0byBpdGVyYXRlIGFsbCBpdGVtcyBvZiBhIGdpdmVuIHR5cGUuCiAgICAgICBAbWV0aG9kIGtub3duRm9yVHlwZQogICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSB0aGUgdHlwZSB0byBzZWFyY2ggZm9yCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgOwoKICAgIF9wcm90by5rbm93bkZvclR5cGUgPSBmdW5jdGlvbiBrbm93bkZvclR5cGUodHlwZSkgewogICAgICB2YXIgbmFtZXNwYWNlID0gKDAsIF9tZXRhbC5nZXQpKHRoaXMsICduYW1lc3BhY2UnKTsKICAgICAgdmFyIHN1ZmZpeCA9ICgwLCBfc3RyaW5nLmNsYXNzaWZ5KSh0eXBlKTsKICAgICAgdmFyIHR5cGVSZWdleHAgPSBuZXcgUmVnRXhwKHN1ZmZpeCArICIkIik7CiAgICAgIHZhciBrbm93biA9ICgwLCBfdXRpbHMuZGljdGlvbmFyeSkobnVsbCk7CiAgICAgIHZhciBrbm93bktleXMgPSBPYmplY3Qua2V5cyhuYW1lc3BhY2UpOwoKICAgICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IGtub3duS2V5cy5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICB2YXIgbmFtZSA9IGtub3duS2V5c1tpbmRleF07CgogICAgICAgIGlmICh0eXBlUmVnZXhwLnRlc3QobmFtZSkpIHsKICAgICAgICAgIHZhciBjb250YWluZXJOYW1lID0gdGhpcy50cmFuc2xhdGVUb0NvbnRhaW5lckZ1bGxuYW1lKHR5cGUsIG5hbWUpOwogICAgICAgICAga25vd25bY29udGFpbmVyTmFtZV0gPSB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGtub3duOwogICAgfQogICAgLyoqCiAgICAgIENvbnZlcnRzIHByb3ZpZGVkIG5hbWUgZnJvbSB0aGUgYmFja2luZyBuYW1lc3BhY2UgaW50byBhIGNvbnRhaW5lciBsb29rdXAgbmFtZS4KICAgICAgIEV4YW1wbGVzOgogICAgICAgKiBBcHAuRm9vQmFySGVscGVyIC0+IGhlbHBlcjpmb28tYmFyCiAgICAgICogQXBwLlRIZWxwZXIgLT4gaGVscGVyOnQKICAgICAgIEBtZXRob2QgdHJhbnNsYXRlVG9Db250YWluZXJGdWxsbmFtZQogICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8udHJhbnNsYXRlVG9Db250YWluZXJGdWxsbmFtZSA9IGZ1bmN0aW9uIHRyYW5zbGF0ZVRvQ29udGFpbmVyRnVsbG5hbWUodHlwZSwgbmFtZSkgewogICAgICB2YXIgc3VmZml4ID0gKDAsIF9zdHJpbmcuY2xhc3NpZnkpKHR5cGUpOwogICAgICB2YXIgbmFtZVByZWZpeCA9IG5hbWUuc2xpY2UoMCwgc3VmZml4Lmxlbmd0aCAqIC0xKTsKICAgICAgdmFyIGRhc2hlcml6ZWROYW1lID0gKDAsIF9zdHJpbmcuZGFzaGVyaXplKShuYW1lUHJlZml4KTsKICAgICAgcmV0dXJuIHR5cGUgKyAiOiIgKyBkYXNoZXJpemVkTmFtZTsKICAgIH07CgogICAgcmV0dXJuIERlZmF1bHRSZXNvbHZlcjsKICB9KF9ydW50aW1lLk9iamVjdCk7CgogIHZhciBfZGVmYXVsdCA9IERlZmF1bHRSZXNvbHZlcjsKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7CgogIGlmIChmYWxzZQogIC8qIERFQlVHICovCiAgKSB7CiAgICAvKioKICAgICAgICBAbWV0aG9kIF9sb2dMb29rdXAKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IGZvdW5kCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHBhcnNlZE5hbWUKICAgICAgICBAcHJpdmF0ZQogICAgICAqLwogICAgRGVmYXVsdFJlc29sdmVyLnByb3RvdHlwZS5fbG9nTG9va3VwID0gZnVuY3Rpb24gKGZvdW5kLCBwYXJzZWROYW1lKSB7CiAgICAgIHZhciBzeW1ib2wgPSBmb3VuZCA/ICdb4pyTXScgOiAnWyBdJzsKICAgICAgdmFyIHBhZGRpbmc7CgogICAgICBpZiAocGFyc2VkTmFtZS5mdWxsTmFtZS5sZW5ndGggPiA2MCkgewogICAgICAgIHBhZGRpbmcgPSAnLic7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFkZGluZyA9IG5ldyBBcnJheSg2MCAtIHBhcnNlZE5hbWUuZnVsbE5hbWUubGVuZ3RoKS5qb2luKCcuJyk7CiAgICAgIH0KCiAgICAgICgwLCBfZGVidWcuaW5mbykoc3ltYm9sLCBwYXJzZWROYW1lLmZ1bGxOYW1lLCBwYWRkaW5nLCB0aGlzLmxvb2t1cERlc2NyaXB0aW9uKHBhcnNlZE5hbWUuZnVsbE5hbWUpKTsKICAgIH07CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvYXBwbGljYXRpb24vaW5kZXgiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvb3duZXIiLCAiQGVtYmVyL2FwcGxpY2F0aW9uL2xpYi9sYXp5X2xvYWQiLCAiQGVtYmVyL2FwcGxpY2F0aW9uL2xpYi9hcHBsaWNhdGlvbiJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9vd25lciwgX2xhenlfbG9hZCwgX2FwcGxpY2F0aW9uKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJnZXRPd25lciIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9vd25lci5nZXRPd25lcjsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJzZXRPd25lciIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9vd25lci5zZXRPd25lcjsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJvbkxvYWQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfbGF6eV9sb2FkLm9uTG9hZDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJydW5Mb2FkSG9va3MiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfbGF6eV9sb2FkLnJ1bkxvYWRIb29rczsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfbG9hZGVkIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2xhenlfbG9hZC5fbG9hZGVkOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImRlZmF1bHQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfYXBwbGljYXRpb24uZGVmYXVsdDsKICAgIH0KICB9KTsKfSk7CmRlZmluZSgiQGVtYmVyL2FwcGxpY2F0aW9uL2luc3RhbmNlIiwgWyJleHBvcnRzIiwgIkBlbWJlci9wb2x5ZmlsbHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiLCAiQGVtYmVyLy1pbnRlcm5hbHMvYnJvd3Nlci1lbnZpcm9ubWVudCIsICJAZW1iZXIvLWludGVybmFscy92aWV3cyIsICJAZW1iZXIvZW5naW5lL2luc3RhbmNlIiwgIkBlbWJlci8taW50ZXJuYWxzL2dsaW1tZXIiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfcG9seWZpbGxzLCBfbWV0YWwsIGVudmlyb25tZW50LCBfdmlld3MsIF9pbnN0YW5jZSwgX2dsaW1tZXIpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIC8qKgogIEBtb2R1bGUgQGVtYmVyL2FwcGxpY2F0aW9uCiAgKi8KCiAgLyoqCiAgICBUaGUgYEFwcGxpY2F0aW9uSW5zdGFuY2VgIGVuY2Fwc3VsYXRlcyBhbGwgb2YgdGhlIHN0YXRlZnVsIGFzcGVjdHMgb2YgYQogICAgcnVubmluZyBgQXBwbGljYXRpb25gLgogIAogICAgQXQgYSBoaWdoLWxldmVsLCB3ZSBicmVhayBhcHBsaWNhdGlvbiBib290IGludG8gdHdvIGRpc3RpbmN0IHBoYXNlczoKICAKICAgICogRGVmaW5pdGlvbiB0aW1lLCB3aGVyZSBhbGwgb2YgdGhlIGNsYXNzZXMsIHRlbXBsYXRlcywgYW5kIG90aGVyCiAgICAgIGRlcGVuZGVuY2llcyBhcmUgbG9hZGVkICh0eXBpY2FsbHkgaW4gdGhlIGJyb3dzZXIpLgogICAgKiBSdW4gdGltZSwgd2hlcmUgd2UgYmVnaW4gZXhlY3V0aW5nIHRoZSBhcHBsaWNhdGlvbiBvbmNlIGV2ZXJ5dGhpbmcKICAgICAgaGFzIGxvYWRlZC4KICAKICAgIERlZmluaXRpb24gdGltZSBjYW4gYmUgZXhwZW5zaXZlIGFuZCBvbmx5IG5lZWRzIHRvIGhhcHBlbiBvbmNlIHNpbmNlIGl0IGlzCiAgICBhbiBpZGVtcG90ZW50IG9wZXJhdGlvbi4gRm9yIGV4YW1wbGUsIGJldHdlZW4gdGVzdCBydW5zIGFuZCBGYXN0Qm9vdAogICAgcmVxdWVzdHMsIHRoZSBhcHBsaWNhdGlvbiBzdGF5cyB0aGUgc2FtZS4gSXQgaXMgb25seSB0aGUgc3RhdGUgdGhhdCB3ZSB3YW50CiAgICB0byByZXNldC4KICAKICAgIFRoYXQgc3RhdGUgaXMgd2hhdCB0aGUgYEFwcGxpY2F0aW9uSW5zdGFuY2VgIG1hbmFnZXM6IGl0IGlzIHJlc3BvbnNpYmxlIGZvcgogICAgY3JlYXRpbmcgdGhlIGNvbnRhaW5lciB0aGF0IGNvbnRhaW5zIGFsbCBhcHBsaWNhdGlvbiBzdGF0ZSwgYW5kIGRpc3Bvc2luZyBvZgogICAgaXQgb25jZSB0aGUgcGFydGljdWxhciB0ZXN0IHJ1biBvciBGYXN0Qm9vdCByZXF1ZXN0IGhhcyBmaW5pc2hlZC4KICAKICAgIEBwdWJsaWMKICAgIEBjbGFzcyBBcHBsaWNhdGlvbkluc3RhbmNlCiAgICBAZXh0ZW5kcyBFbmdpbmVJbnN0YW5jZQogICovCiAgdmFyIEFwcGxpY2F0aW9uSW5zdGFuY2UgPSBfaW5zdGFuY2UuZGVmYXVsdC5leHRlbmQoewogICAgLyoqCiAgICAgIFRoZSBgQXBwbGljYXRpb25gIGZvciB3aGljaCB0aGlzIGlzIGFuIGluc3RhbmNlLgogICAgICAgQHByb3BlcnR5IHtBcHBsaWNhdGlvbn0gYXBwbGljYXRpb24KICAgICAgQHByaXZhdGUKICAgICovCiAgICBhcHBsaWNhdGlvbjogbnVsbCwKCiAgICAvKioKICAgICAgVGhlIERPTSBldmVudHMgZm9yIHdoaWNoIHRoZSBldmVudCBkaXNwYXRjaGVyIHNob3VsZCBsaXN0ZW4uCiAgICAgICBCeSBkZWZhdWx0LCB0aGUgYXBwbGljYXRpb24ncyBgRW1iZXIuRXZlbnREaXNwYXRjaGVyYCBsaXN0ZW5zCiAgICAgIGZvciBhIHNldCBvZiBzdGFuZGFyZCBET00gZXZlbnRzLCBzdWNoIGFzIGBtb3VzZWRvd25gIGFuZAogICAgICBga2V5dXBgLCBhbmQgZGVsZWdhdGVzIHRoZW0gdG8geW91ciBhcHBsaWNhdGlvbidzIGBFbWJlci5WaWV3YAogICAgICBpbnN0YW5jZXMuCiAgICAgICBAcHJpdmF0ZQogICAgICBAcHJvcGVydHkge09iamVjdH0gY3VzdG9tRXZlbnRzCiAgICAqLwogICAgY3VzdG9tRXZlbnRzOiBudWxsLAoKICAgIC8qKgogICAgICBUaGUgcm9vdCBET00gZWxlbWVudCBvZiB0aGUgQXBwbGljYXRpb24gYXMgYW4gZWxlbWVudCBvciBhCiAgICAgIFtqUXVlcnktY29tcGF0aWJsZSBzZWxlY3RvcgogICAgICBzdHJpbmddKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jYXRlZ29yeS9zZWxlY3RvcnMvKS4KICAgICAgIEBwcml2YXRlCiAgICAgIEBwcm9wZXJ0eSB7U3RyaW5nfERPTUVsZW1lbnR9IHJvb3RFbGVtZW50CiAgICAqLwogICAgcm9vdEVsZW1lbnQ6IG51bGwsCiAgICBpbml0OiBmdW5jdGlvbiBpbml0KCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgdGhpcy5hcHBsaWNhdGlvbi5fd2F0Y2hJbnN0YW5jZSh0aGlzKTsgLy8gUmVnaXN0ZXIgdGhpcyBpbnN0YW5jZSBpbiB0aGUgcGVyLWluc3RhbmNlIHJlZ2lzdHJ5LgogICAgICAvLwogICAgICAvLyBXaHkgZG8gd2UgbmVlZCB0byByZWdpc3RlciB0aGUgaW5zdGFuY2UgaW4gdGhlIGZpcnN0IHBsYWNlPwogICAgICAvLyBCZWNhdXNlIHdlIG5lZWQgYSBnb29kIHdheSBmb3IgdGhlIHJvb3Qgcm91dGUgKGEuay5hIEFwcGxpY2F0aW9uUm91dGUpCiAgICAgIC8vIHRvIG5vdGlmeSB1cyB3aGVuIGl0IGhhcyBjcmVhdGVkIHRoZSByb290LW1vc3Qgdmlldy4gVGhhdCB2aWV3IGlzIHRoZW4KICAgICAgLy8gYXBwZW5kZWQgdG8gdGhlIHJvb3RFbGVtZW50LCBpbiB0aGUgY2FzZSBvZiBhcHBzLCB0byB0aGUgZml4dHVyZSBoYXJuZXNzCiAgICAgIC8vIGluIHRlc3RzLCBvciByZW5kZXJlZCB0byBhIHN0cmluZyBpbiB0aGUgY2FzZSBvZiBGYXN0Qm9vdC4KCgogICAgICB0aGlzLnJlZ2lzdGVyKCctYXBwbGljYXRpb24taW5zdGFuY2U6bWFpbicsIHRoaXMsIHsKICAgICAgICBpbnN0YW50aWF0ZTogZmFsc2UKICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICBPdmVycmlkZXMgdGhlIGJhc2UgYEVuZ2luZUluc3RhbmNlLl9ib290U3luY2AgbWV0aG9kIHdpdGggY29uY2VybnMgcmVsZXZhbnQKICAgICAgdG8gYm9vdGluZyBhcHBsaWNhdGlvbiAoaW5zdGVhZCBvZiBlbmdpbmUpIGluc3RhbmNlcy4KICAgICAgIFRoaXMgbWV0aG9kIHNob3VsZCBvbmx5IGNvbnRhaW4gc3luY2hyb25vdXMgYm9vdCBjb25jZXJucy4gQXN5bmNocm9ub3VzCiAgICAgIGJvb3QgY29uY2VybnMgc2hvdWxkIGV2ZW50dWFsbHkgYmUgbW92ZWQgdG8gdGhlIGBib290YCBtZXRob2QsIHdoaWNoCiAgICAgIHJldHVybnMgYSBwcm9taXNlLgogICAgICAgVW50aWwgYWxsIGJvb3QgY29kZSBoYXMgYmVlbiBtYWRlIGFzeW5jaHJvbm91cywgd2UgbmVlZCB0byBjb250aW51ZSB0bwogICAgICBleHBvc2UgdGhpcyBtZXRob2QgZm9yIHVzZSAqaW50ZXJuYWxseSogaW4gcGxhY2VzIHdoZXJlIHdlIG5lZWQgdG8gYm9vdCBhbgogICAgICBpbnN0YW5jZSBzeW5jaHJvbm91c2x5LgogICAgICAgQHByaXZhdGUKICAgICovCiAgICBfYm9vdFN5bmM6IGZ1bmN0aW9uIF9ib290U3luYyhvcHRpb25zKSB7CiAgICAgIGlmICh0aGlzLl9ib290ZWQpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgb3B0aW9ucyA9IG5ldyBCb290T3B0aW9ucyhvcHRpb25zKTsKICAgICAgdGhpcy5zZXR1cFJlZ2lzdHJ5KG9wdGlvbnMpOwoKICAgICAgaWYgKG9wdGlvbnMucm9vdEVsZW1lbnQpIHsKICAgICAgICB0aGlzLnJvb3RFbGVtZW50ID0gb3B0aW9ucy5yb290RWxlbWVudDsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnJvb3RFbGVtZW50ID0gdGhpcy5hcHBsaWNhdGlvbi5yb290RWxlbWVudDsKICAgICAgfQoKICAgICAgaWYgKG9wdGlvbnMubG9jYXRpb24pIHsKICAgICAgICAoMCwgX21ldGFsLnNldCkodGhpcy5yb3V0ZXIsICdsb2NhdGlvbicsIG9wdGlvbnMubG9jYXRpb24pOwogICAgICB9CgogICAgICB0aGlzLmFwcGxpY2F0aW9uLnJ1bkluc3RhbmNlSW5pdGlhbGl6ZXJzKHRoaXMpOwoKICAgICAgaWYgKG9wdGlvbnMuaXNJbnRlcmFjdGl2ZSkgewogICAgICAgIHRoaXMuc2V0dXBFdmVudERpc3BhdGNoZXIoKTsKICAgICAgfQoKICAgICAgdGhpcy5fYm9vdGVkID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgc2V0dXBSZWdpc3RyeTogZnVuY3Rpb24gc2V0dXBSZWdpc3RyeShvcHRpb25zKSB7CiAgICAgIHRoaXMuY29uc3RydWN0b3Iuc2V0dXBSZWdpc3RyeSh0aGlzLl9fcmVnaXN0cnlfXywgb3B0aW9ucyk7CiAgICB9LAogICAgcm91dGVyOiAoMCwgX21ldGFsLmNvbXB1dGVkKShmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLmxvb2t1cCgncm91dGVyOm1haW4nKTsKICAgIH0pLnJlYWRPbmx5KCksCgogICAgLyoqCiAgICAgIFRoaXMgaG9vayBpcyBjYWxsZWQgYnkgdGhlIHJvb3QtbW9zdCBSb3V0ZSAoYS5rLmEuIHRoZSBBcHBsaWNhdGlvblJvdXRlKQogICAgICB3aGVuIGl0IGhhcyBmaW5pc2hlZCBjcmVhdGluZyB0aGUgcm9vdCBWaWV3LiBCeSBkZWZhdWx0LCB3ZSBzaW1wbHkgdGFrZSB0aGUKICAgICAgdmlldyBhbmQgYXBwZW5kIGl0IHRvIHRoZSBgcm9vdEVsZW1lbnRgIHNwZWNpZmllZCBvbiB0aGUgQXBwbGljYXRpb24uCiAgICAgICBJbiBjYXNlcyBsaWtlIEZhc3RCb290IGFuZCB0ZXN0aW5nLCB3ZSBjYW4gb3ZlcnJpZGUgdGhpcyBob29rIGFuZCBpbXBsZW1lbnQKICAgICAgY3VzdG9tIGJlaGF2aW9yLCBzdWNoIGFzIHNlcmlhbGl6aW5nIHRvIGEgc3RyaW5nIGFuZCBzZW5kaW5nIG92ZXIgYW4gSFRUUAogICAgICBzb2NrZXQgcmF0aGVyIHRoYW4gYXBwZW5kaW5nIHRvIERPTS4KICAgICAgIEBwYXJhbSB2aWV3IHtFbWJlci5WaWV3fSB0aGUgcm9vdC1tb3N0IHZpZXcKICAgICAgQGRlcHJlY2F0ZWQKICAgICAgQHByaXZhdGUKICAgICovCiAgICBkaWRDcmVhdGVSb290VmlldzogZnVuY3Rpb24gZGlkQ3JlYXRlUm9vdFZpZXcodmlldykgewogICAgICB2aWV3LmFwcGVuZFRvKHRoaXMucm9vdEVsZW1lbnQpOwogICAgfSwKCiAgICAvKioKICAgICAgVGVsbHMgdGhlIHJvdXRlciB0byBzdGFydCByb3V0aW5nLiBUaGUgcm91dGVyIHdpbGwgYXNrIHRoZSBsb2NhdGlvbiBmb3IgdGhlCiAgICAgIGN1cnJlbnQgVVJMIG9mIHRoZSBwYWdlIHRvIGRldGVybWluZSB0aGUgaW5pdGlhbCBVUkwgdG8gc3RhcnQgcm91dGluZyB0by4KICAgICAgVG8gc3RhcnQgdGhlIGFwcCBhdCBhIHNwZWNpZmljIFVSTCwgY2FsbCBgaGFuZGxlVVJMYCBpbnN0ZWFkLgogICAgICAgQHByaXZhdGUKICAgICovCiAgICBzdGFydFJvdXRpbmc6IGZ1bmN0aW9uIHN0YXJ0Um91dGluZygpIHsKICAgICAgdGhpcy5yb3V0ZXIuc3RhcnRSb3V0aW5nKCk7CiAgICAgIHRoaXMuX2RpZFNldHVwUm91dGVyID0gdHJ1ZTsKICAgIH0sCgogICAgLyoqCiAgICAgIFNldHMgdXAgdGhlIHJvdXRlciwgaW5pdGlhbGl6aW5nIHRoZSBjaGlsZCByb3V0ZXIgYW5kIGNvbmZpZ3VyaW5nIHRoZQogICAgICBsb2NhdGlvbiBiZWZvcmUgcm91dGluZyBiZWdpbnMuCiAgICAgICBCZWNhdXNlIHNldHVwIHNob3VsZCBvbmx5IG9jY3VyIG9uY2UsIG11bHRpcGxlIGNhbGxzIHRvIGBzZXR1cFJvdXRlcmAKICAgICAgYmV5b25kIHRoZSBmaXJzdCBjYWxsIGhhdmUgbm8gZWZmZWN0LgogICAgICAKICAgICAgVGhpcyBpcyBjb21tb25seSB1c2VkIGluIG9yZGVyIHRvIGNvbmZpcm0gdGhpbmdzIHRoYXQgcmVseSBvbiB0aGUgcm91dGVyCiAgICAgIGFyZSBmdW5jdGlvbmluZyBwcm9wZXJseSBmcm9tIHRlc3RzIHRoYXQgYXJlIHByaW1hcmlseSByZW5kZXJpbmcgcmVsYXRlZC4KICAgICAgCiAgICAgIEZvciBleGFtcGxlLCBmcm9tIHdpdGhpbiBbZW1iZXItcXVuaXRdKGh0dHBzOi8vZ2l0aHViLmNvbS9lbWJlcmpzL2VtYmVyLXF1bml0KSdzCiAgICAgIGBzZXR1cFJlbmRlcmluZ1Rlc3RgIGNhbGxpbmcgYHRoaXMub3duZXIuc2V0dXBSb3V0ZXIoKWAgd291bGQgYWxsb3cgdGhhdAogICAgICByZW5kZXJpbmcgdGVzdCB0byBjb25maXJtIHRoYXQgYW55IGA8TGlua1RvPjwvTGlua1RvPmAncyB0aGF0IGFyZSByZW5kZXJlZAogICAgICBoYXZlIHRoZSBjb3JyZWN0IFVSTC4KICAgICAgCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBzZXR1cFJvdXRlcjogZnVuY3Rpb24gc2V0dXBSb3V0ZXIoKSB7CiAgICAgIGlmICh0aGlzLl9kaWRTZXR1cFJvdXRlcikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5fZGlkU2V0dXBSb3V0ZXIgPSB0cnVlOwogICAgICB0aGlzLnJvdXRlci5zZXR1cFJvdXRlcigpOwogICAgfSwKCiAgICAvKioKICAgICAgRGlyZWN0cyB0aGUgcm91dGVyIHRvIHJvdXRlIHRvIGEgcGFydGljdWxhciBVUkwuIFRoaXMgaXMgdXNlZnVsIGluIHRlc3RzLAogICAgICBmb3IgZXhhbXBsZSwgdG8gdGVsbCB0aGUgYXBwIHRvIHN0YXJ0IGF0IGEgcGFydGljdWxhciBVUkwuCiAgICAgICBAcGFyYW0gdXJsIHtTdHJpbmd9IHRoZSBVUkwgdGhlIHJvdXRlciBzaG91bGQgcm91dGUgdG8KICAgICAgQHByaXZhdGUKICAgICovCiAgICBoYW5kbGVVUkw6IGZ1bmN0aW9uIGhhbmRsZVVSTCh1cmwpIHsKICAgICAgdGhpcy5zZXR1cFJvdXRlcigpOwogICAgICByZXR1cm4gdGhpcy5yb3V0ZXIuaGFuZGxlVVJMKHVybCk7CiAgICB9LAoKICAgIC8qKgogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIHNldHVwRXZlbnREaXNwYXRjaGVyOiBmdW5jdGlvbiBzZXR1cEV2ZW50RGlzcGF0Y2hlcigpIHsKICAgICAgdmFyIGRpc3BhdGNoZXIgPSB0aGlzLmxvb2t1cCgnZXZlbnRfZGlzcGF0Y2hlcjptYWluJyk7CiAgICAgIHZhciBhcHBsaWNhdGlvbkN1c3RvbUV2ZW50cyA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLmFwcGxpY2F0aW9uLCAnY3VzdG9tRXZlbnRzJyk7CiAgICAgIHZhciBpbnN0YW5jZUN1c3RvbUV2ZW50cyA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCAnY3VzdG9tRXZlbnRzJyk7CiAgICAgIHZhciBjdXN0b21FdmVudHMgPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCBhcHBsaWNhdGlvbkN1c3RvbUV2ZW50cywgaW5zdGFuY2VDdXN0b21FdmVudHMpOwogICAgICBkaXNwYXRjaGVyLnNldHVwKGN1c3RvbUV2ZW50cywgdGhpcy5yb290RWxlbWVudCk7CiAgICAgIHJldHVybiBkaXNwYXRjaGVyOwogICAgfSwKCiAgICAvKioKICAgICAgUmV0dXJucyB0aGUgY3VycmVudCBVUkwgb2YgdGhlIGFwcCBpbnN0YW5jZS4gVGhpcyBpcyB1c2VmdWwgd2hlbiB5b3VyCiAgICAgIGFwcCBkb2VzIG5vdCB1cGRhdGUgdGhlIGJyb3dzZXJzIFVSTCBiYXIgKGkuZS4gaXQgdXNlcyB0aGUgYCdub25lJ2AKICAgICAgbG9jYXRpb24gYWRhcHRlcikuCiAgICAgICBAcHVibGljCiAgICAgIEByZXR1cm4ge1N0cmluZ30gdGhlIGN1cnJlbnQgVVJMCiAgICAqLwogICAgZ2V0VVJMOiBmdW5jdGlvbiBnZXRVUkwoKSB7CiAgICAgIHJldHVybiB0aGlzLnJvdXRlci51cmw7CiAgICB9LAogICAgLy8gYGluc3RhbmNlLnZpc2l0KHVybClgIHNob3VsZCBldmVudHVhbGx5IHJlcGxhY2UgYGluc3RhbmNlLmhhbmRsZVVSTCgpYDsKICAgIC8vIHRoZSB0ZXN0IGhlbHBlcnMgY2FuIHByb2JhYmx5IGJlIHN3aXRjaGVkIHRvIHVzZSB0aGlzIGltcGxlbWVudGF0aW9uIHRvbwoKICAgIC8qKgogICAgICBOYXZpZ2F0ZSB0aGUgaW5zdGFuY2UgdG8gYSBwYXJ0aWN1bGFyIFVSTC4gVGhpcyBpcyB1c2VmdWwgaW4gdGVzdHMsIGZvcgogICAgICBleGFtcGxlLCBvciB0byB0ZWxsIHRoZSBhcHAgdG8gc3RhcnQgYXQgYSBwYXJ0aWN1bGFyIFVSTC4gVGhpcyBtZXRob2QKICAgICAgcmV0dXJucyBhIHByb21pc2UgdGhhdCByZXNvbHZlcyB3aXRoIHRoZSBhcHAgaW5zdGFuY2Ugd2hlbiB0aGUgdHJhbnNpdGlvbgogICAgICBpcyBjb21wbGV0ZSwgb3IgcmVqZWN0cyBpZiB0aGUgdHJhbnNpb24gd2FzIGFib3J0ZWQgZHVlIHRvIGFuIGVycm9yLgogICAgICAgQHB1YmxpYwogICAgICBAcGFyYW0gdXJsIHtTdHJpbmd9IHRoZSBkZXN0aW5hdGlvbiBVUkwKICAgICAgQHJldHVybiB7UHJvbWlzZTxBcHBsaWNhdGlvbkluc3RhbmNlPn0KICAgICovCiAgICB2aXNpdDogZnVuY3Rpb24gdmlzaXQodXJsKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB0aGlzLnNldHVwUm91dGVyKCk7CgogICAgICB2YXIgYm9vdE9wdGlvbnMgPSB0aGlzLl9fY29udGFpbmVyX18ubG9va3VwKCctZW52aXJvbm1lbnQ6bWFpbicpOwoKICAgICAgdmFyIHJvdXRlciA9IHRoaXMucm91dGVyOwoKICAgICAgdmFyIGhhbmRsZVRyYW5zaXRpb25SZXNvbHZlID0gZnVuY3Rpb24gaGFuZGxlVHJhbnNpdGlvblJlc29sdmUoKSB7CiAgICAgICAgaWYgKCFib290T3B0aW9ucy5vcHRpb25zLnNob3VsZFJlbmRlcikgewogICAgICAgICAgLy8gTm8gcmVuZGVyaW5nIGlzIG5lZWRlZCwgYW5kIHJvdXRpbmcgaGFzIGNvbXBsZXRlZCwgc2ltcGx5IHJldHVybi4KICAgICAgICAgIHJldHVybiBfdGhpczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gRW5zdXJlIHRoYXQgdGhlIHZpc2l0IHByb21pc2UgcmVzb2x2ZXMgd2hlbiBhbGwgcmVuZGVyaW5nIGhhcyBjb21wbGV0ZWQKICAgICAgICAgIHJldHVybiAoMCwgX2dsaW1tZXIucmVuZGVyU2V0dGxlZCkoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIF90aGlzOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIGhhbmRsZVRyYW5zaXRpb25SZWplY3QgPSBmdW5jdGlvbiBoYW5kbGVUcmFuc2l0aW9uUmVqZWN0KGVycm9yKSB7CiAgICAgICAgaWYgKGVycm9yLmVycm9yKSB7CiAgICAgICAgICB0aHJvdyBlcnJvci5lcnJvcjsKICAgICAgICB9IGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICdUcmFuc2l0aW9uQWJvcnRlZCcgJiYgcm91dGVyLl9yb3V0ZXJNaWNyb2xpYi5hY3RpdmVUcmFuc2l0aW9uKSB7CiAgICAgICAgICByZXR1cm4gcm91dGVyLl9yb3V0ZXJNaWNyb2xpYi5hY3RpdmVUcmFuc2l0aW9uLnRoZW4oaGFuZGxlVHJhbnNpdGlvblJlc29sdmUsIGhhbmRsZVRyYW5zaXRpb25SZWplY3QpOwogICAgICAgIH0gZWxzZSBpZiAoZXJyb3IubmFtZSA9PT0gJ1RyYW5zaXRpb25BYm9ydGVkJykgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yLm1lc3NhZ2UpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgbG9jYXRpb24gPSAoMCwgX21ldGFsLmdldCkocm91dGVyLCAnbG9jYXRpb24nKTsgLy8gS2VlcHMgdGhlIGxvY2F0aW9uIGFkYXB0ZXIncyBpbnRlcm5hbCBVUkwgaW4tc3luYwoKICAgICAgbG9jYXRpb24uc2V0VVJMKHVybCk7IC8vIGdldFVSTCByZXR1cm5zIHRoZSBzZXQgdXJsIHdpdGggdGhlIHJvb3RVUkwgc3RyaXBwZWQgb2ZmCgogICAgICByZXR1cm4gcm91dGVyLmhhbmRsZVVSTChsb2NhdGlvbi5nZXRVUkwoKSkudGhlbihoYW5kbGVUcmFuc2l0aW9uUmVzb2x2ZSwgaGFuZGxlVHJhbnNpdGlvblJlamVjdCk7CiAgICB9LAogICAgd2lsbERlc3Ryb3k6IGZ1bmN0aW9uIHdpbGxEZXN0cm95KCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgdGhpcy5hcHBsaWNhdGlvbi5fdW53YXRjaEluc3RhbmNlKHRoaXMpOwogICAgfQogIH0pOwoKICBBcHBsaWNhdGlvbkluc3RhbmNlLnJlb3BlbkNsYXNzKHsKICAgIC8qKgogICAgIEBwcml2YXRlCiAgICAgQG1ldGhvZCBzZXR1cFJlZ2lzdHJ5CiAgICAgQHBhcmFtIHtSZWdpc3RyeX0gcmVnaXN0cnkKICAgICBAcGFyYW0ge0Jvb3RPcHRpb25zfSBvcHRpb25zCiAgICAqLwogICAgc2V0dXBSZWdpc3RyeTogZnVuY3Rpb24gc2V0dXBSZWdpc3RyeShyZWdpc3RyeSwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBpZiAoIW9wdGlvbnMudG9FbnZpcm9ubWVudCkgewogICAgICAgIG9wdGlvbnMgPSBuZXcgQm9vdE9wdGlvbnMob3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCctZW52aXJvbm1lbnQ6bWFpbicsIG9wdGlvbnMudG9FbnZpcm9ubWVudCgpLCB7CiAgICAgICAgaW5zdGFudGlhdGU6IGZhbHNlCiAgICAgIH0pOwogICAgICByZWdpc3RyeS5yZWdpc3Rlcignc2VydmljZTotZG9jdW1lbnQnLCBvcHRpb25zLmRvY3VtZW50LCB7CiAgICAgICAgaW5zdGFudGlhdGU6IGZhbHNlCiAgICAgIH0pOwoKICAgICAgdGhpcy5fc3VwZXIocmVnaXN0cnksIG9wdGlvbnMpOwogICAgfQogIH0pOwogIC8qKgogICAgQSBsaXN0IG9mIGJvb3QtdGltZSBjb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIGN1c3RvbWl6aW5nIHRoZSBiZWhhdmlvciBvZgogICAgYW4gYEFwcGxpY2F0aW9uSW5zdGFuY2VgLgogIAogICAgVGhpcyBpcyBhbiBpbnRlcmZhY2UgY2xhc3MgdGhhdCBleGlzdHMgcHVyZWx5IHRvIGRvY3VtZW50IHRoZSBhdmFpbGFibGUKICAgIG9wdGlvbnM7IHlvdSBkbyBub3QgbmVlZCB0byBjb25zdHJ1Y3QgaXQgbWFudWFsbHkuIFNpbXBseSBwYXNzIGEgcmVndWxhcgogICAgSmF2YVNjcmlwdCBvYmplY3QgY29udGFpbmluZyB0aGUgZGVzaXJlZCBvcHRpb25zIGludG8gbWV0aG9kcyB0aGF0IHJlcXVpcmUKICAgIG9uZSBvZiB0aGVzZSBvcHRpb25zIG9iamVjdDoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIE15QXBwLnZpc2l0KCIvIiwgeyBsb2NhdGlvbjogIm5vbmUiLCByb290RWxlbWVudDogIiNjb250YWluZXIiIH0pOwogICAgYGBgCiAgCiAgICBOb3QgYWxsIGNvbWJpbmF0aW9ucyBvZiB0aGUgc3VwcG9ydGVkIG9wdGlvbnMgYXJlIHZhbGlkLiBTZWUgdGhlIGRvY3VtZW50YXRpb24KICAgIG9uIGBBcHBsaWNhdGlvbiN2aXNpdGAgZm9yIHRoZSBzdXBwb3J0ZWQgY29uZmlndXJhdGlvbnMuCiAgCiAgICBJbnRlcm5hbCwgZXhwZXJpbWVudGFsIG9yIG90aGVyd2lzZSB1bnN0YWJsZSBmbGFncyBhcmUgbWFya2VkIGFzIHByaXZhdGUuCiAgCiAgICBAY2xhc3MgQm9vdE9wdGlvbnMKICAgIEBuYW1lc3BhY2UgQXBwbGljYXRpb25JbnN0YW5jZQogICAgQHB1YmxpYwogICovCgogIHZhciBCb290T3B0aW9ucyA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEJvb3RPcHRpb25zKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgLyoqCiAgICAgICAgUHJvdmlkZSBhIHNwZWNpZmljIGluc3RhbmNlIG9mIGpRdWVyeS4gVGhpcyBpcyB1c2VmdWwgaW4gY29uanVuY3Rpb24gd2l0aAogICAgICAgIHRoZSBgZG9jdW1lbnRgIG9wdGlvbiwgYXMgaXQgYWxsb3dzIHlvdSB0byB1c2UgYSBjb3B5IG9mIGBqUXVlcnlgIHRoYXQgaXMKICAgICAgICBhcHByb3ByaWF0ZWx5IGJvdW5kIHRvIHRoZSBmb3JlaWduIGBkb2N1bWVudGAgKGUuZy4gYSBqc2RvbSkuCiAgICAgICAgIFRoaXMgaXMgaGlnaGx5IGV4cGVyaW1lbnRhbCBhbmQgc3VwcG9ydCB2ZXJ5IGluY29tcGxldGUgYXQgdGhlIG1vbWVudC4KICAgICAgICAgQHByb3BlcnR5IGpRdWVyeQogICAgICAgIEB0eXBlIE9iamVjdAogICAgICAgIEBkZWZhdWx0IGF1dG8tZGV0ZWN0ZWQKICAgICAgICBAcHJpdmF0ZQogICAgICAqLwogICAgICB0aGlzLmpRdWVyeSA9IF92aWV3cy5qUXVlcnk7IC8vIFRoaXMgZGVmYXVsdCBpcyBvdmVycmlkYWJsZSBiZWxvdwoKICAgICAgLyoqCiAgICAgICAgSW50ZXJhY3RpdmUgbW9kZTogd2hldGhlciB3ZSBuZWVkIHRvIHNldCB1cCBldmVudCBkZWxlZ2F0aW9uIGFuZCBpbnZva2UKICAgICAgICBsaWZlY3ljbGUgY2FsbGJhY2tzIG9uIENvbXBvbmVudHMuCiAgICAgICAgIEBwcm9wZXJ0eSBpc0ludGVyYWN0aXZlCiAgICAgICAgQHR5cGUgYm9vbGVhbgogICAgICAgIEBkZWZhdWx0IGF1dG8tZGV0ZWN0ZWQKICAgICAgICBAcHJpdmF0ZQogICAgICAqLwoKICAgICAgdGhpcy5pc0ludGVyYWN0aXZlID0gZW52aXJvbm1lbnQuaGFzRE9NOyAvLyBUaGlzIGRlZmF1bHQgaXMgb3ZlcnJpZGFibGUgYmVsb3cKCiAgICAgIC8qKgogICAgICAgIEBwcm9wZXJ0eSBfcmVuZGVyTW9kZQogICAgICAgIEB0eXBlIHN0cmluZwogICAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgICAgQHByaXZhdGUKICAgICAgKi8KCiAgICAgIHRoaXMuX3JlbmRlck1vZGUgPSBvcHRpb25zLl9yZW5kZXJNb2RlOwogICAgICAvKioKICAgICAgICBSdW4gaW4gYSBmdWxsIGJyb3dzZXIgZW52aXJvbm1lbnQuCiAgICAgICAgIFdoZW4gdGhpcyBmbGFnIGlzIHNldCB0byBgZmFsc2VgLCBpdCB3aWxsIGRpc2FibGUgbW9zdCBicm93c2VyLXNwZWNpZmljCiAgICAgICAgYW5kIGludGVyYWN0aXZlIGZlYXR1cmVzLiBTcGVjaWZpY2FsbHk6CiAgICAgICAgICogSXQgZG9lcyBub3QgdXNlIGBqUXVlcnlgIHRvIGFwcGVuZCB0aGUgcm9vdCB2aWV3OyB0aGUgYHJvb3RFbGVtZW50YAogICAgICAgICAgKGVpdGhlciBzcGVjaWZpZWQgYXMgYSBzdWJzZXF1ZW50IG9wdGlvbiBvciBvbiB0aGUgYXBwbGljYXRpb24gaXRzZWxmKQogICAgICAgICAgbXVzdCBhbHJlYWR5IGJlIGFuIGBFbGVtZW50YCBpbiB0aGUgZ2l2ZW4gYGRvY3VtZW50YCAoYXMgb3Bwb3NlZCB0byBhCiAgICAgICAgICBzdHJpbmcgc2VsZWN0b3IpLgogICAgICAgICAqIEl0IGRvZXMgbm90IHNldCB1cCBhbiBgRXZlbnREaXNwYXRjaGVyYC4KICAgICAgICAgKiBJdCBkb2VzIG5vdCBydW4gYW55IGBDb21wb25lbnRgIGxpZmVjeWNsZSBob29rcyAoc3VjaCBhcyBgZGlkSW5zZXJ0RWxlbWVudGApLgogICAgICAgICAqIEl0IHNldHMgdGhlIGBsb2NhdGlvbmAgb3B0aW9uIHRvIGAibm9uZSJgLiAoSWYgeW91IHdvdWxkIGxpa2UgdG8gdXNlCiAgICAgICAgICB0aGUgbG9jYXRpb24gYWRhcHRlciBzcGVjaWZpZWQgaW4gdGhlIGFwcCdzIHJvdXRlciBpbnN0ZWFkLCB5b3UgY2FuIGFsc28KICAgICAgICAgIHNwZWNpZnkgYHsgbG9jYXRpb246IG51bGwgfWAgdG8gc3BlY2lmaWNhbGx5IG9wdC1vdXQuKQogICAgICAgICBAcHJvcGVydHkgaXNCcm93c2VyCiAgICAgICAgQHR5cGUgYm9vbGVhbgogICAgICAgIEBkZWZhdWx0IGF1dG8tZGV0ZWN0ZWQKICAgICAgICBAcHVibGljCiAgICAgICovCgogICAgICBpZiAob3B0aW9ucy5pc0Jyb3dzZXIgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuaXNCcm93c2VyID0gQm9vbGVhbihvcHRpb25zLmlzQnJvd3Nlcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5pc0Jyb3dzZXIgPSBlbnZpcm9ubWVudC5oYXNET007CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5pc0Jyb3dzZXIpIHsKICAgICAgICB0aGlzLmpRdWVyeSA9IG51bGw7CiAgICAgICAgdGhpcy5pc0ludGVyYWN0aXZlID0gZmFsc2U7CiAgICAgICAgdGhpcy5sb2NhdGlvbiA9ICdub25lJzsKICAgICAgfQogICAgICAvKioKICAgICAgICBEaXNhYmxlIHJlbmRlcmluZyBjb21wbGV0ZWx5LgogICAgICAgICBXaGVuIHRoaXMgZmxhZyBpcyBzZXQgdG8gYGZhbHNlYCwgaXQgd2lsbCBkaXNhYmxlIHRoZSBlbnRpcmUgcmVuZGVyaW5nCiAgICAgICAgcGlwZWxpbmUuIEVzc2VudGlhbGx5LCB0aGlzIHB1dHMgdGhlIGFwcCBpbnRvICJyb3V0aW5nLW9ubHkiIG1vZGUuIE5vCiAgICAgICAgdGVtcGxhdGVzIHdpbGwgYmUgcmVuZGVyZWQsIGFuZCBubyBDb21wb25lbnRzIHdpbGwgYmUgY3JlYXRlZC4KICAgICAgICAgQHByb3BlcnR5IHNob3VsZFJlbmRlcgogICAgICAgIEB0eXBlIGJvb2xlYW4KICAgICAgICBAZGVmYXVsdCB0cnVlCiAgICAgICAgQHB1YmxpYwogICAgICAqLwoKCiAgICAgIGlmIChvcHRpb25zLnNob3VsZFJlbmRlciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5zaG91bGRSZW5kZXIgPSBCb29sZWFuKG9wdGlvbnMuc2hvdWxkUmVuZGVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnNob3VsZFJlbmRlciA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5zaG91bGRSZW5kZXIpIHsKICAgICAgICB0aGlzLmpRdWVyeSA9IG51bGw7CiAgICAgICAgdGhpcy5pc0ludGVyYWN0aXZlID0gZmFsc2U7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAgSWYgcHJlc2VudCwgcmVuZGVyIGludG8gdGhlIGdpdmVuIGBEb2N1bWVudGAgb2JqZWN0IGluc3RlYWQgb2YgdGhlCiAgICAgICAgZ2xvYmFsIGB3aW5kb3cuZG9jdW1lbnRgIG9iamVjdC4KICAgICAgICAgSW4gcHJhY3RpY2UsIHRoaXMgaXMgb25seSB1c2VmdWwgaW4gbm9uLWJyb3dzZXIgZW52aXJvbm1lbnQgb3IgaW4KICAgICAgICBub24taW50ZXJhY3RpdmUgbW9kZSwgYmVjYXVzZSBFbWJlcidzIGBqUXVlcnlgIGRlcGVuZGVuY3kgaXMKICAgICAgICBpbXBsaWNpdGx5IGJvdW5kIHRvIHRoZSBjdXJyZW50IGRvY3VtZW50LCBjYXVzaW5nIGV2ZW50IGRlbGVnYXRpb24KICAgICAgICB0byBub3Qgd29yayBwcm9wZXJseSB3aGVuIHRoZSBhcHAgaXMgcmVuZGVyZWQgaW50byBhIGZvcmVpZ24KICAgICAgICBkb2N1bWVudCBvYmplY3QgKHN1Y2ggYXMgYW4gaWZyYW1lJ3MgYGNvbnRlbnREb2N1bWVudGApLgogICAgICAgICBJbiBub24tYnJvd3NlciBtb2RlLCB0aGlzIGNvdWxkIGJlIGEgImBEb2N1bWVudGAtbGlrZSIgb2JqZWN0IGFzCiAgICAgICAgRW1iZXIgb25seSBpbnRlcmFjdCB3aXRoIGEgc21hbGwgc3Vic2V0IG9mIHRoZSBET00gQVBJIGluIG5vbi0KICAgICAgICBpbnRlcmFjdGl2ZSBtb2RlLiBXaGlsZSB0aGUgZXhhY3QgcmVxdWlyZW1lbnRzIGhhdmUgbm90IHlldCBiZWVuCiAgICAgICAgZm9ybWFsaXplZCwgdGhlIGBTaW1wbGVET01gIGxpYnJhcnkncyBpbXBsZW1lbnRhdGlvbiBpcyBrbm93biB0bwogICAgICAgIHdvcmsuCiAgICAgICAgIEBwcm9wZXJ0eSBkb2N1bWVudAogICAgICAgIEB0eXBlIERvY3VtZW50CiAgICAgICAgQGRlZmF1bHQgdGhlIGdsb2JhbCBgZG9jdW1lbnRgIG9iamVjdAogICAgICAgIEBwdWJsaWMKICAgICAgKi8KCgogICAgICBpZiAob3B0aW9ucy5kb2N1bWVudCkgewogICAgICAgIHRoaXMuZG9jdW1lbnQgPSBvcHRpb25zLmRvY3VtZW50OwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuZG9jdW1lbnQgPSB0eXBlb2YgZG9jdW1lbnQgIT09ICd1bmRlZmluZWQnID8gZG9jdW1lbnQgOiBudWxsOwogICAgICB9CiAgICAgIC8qKgogICAgICAgIElmIHByZXNlbnQsIG92ZXJyaWRlcyB0aGUgYXBwbGljYXRpb24ncyBgcm9vdEVsZW1lbnRgIHByb3BlcnR5IG9uCiAgICAgICAgdGhlIGluc3RhbmNlLiBUaGlzIGlzIHVzZWZ1bCBmb3IgdGVzdGluZyBlbnZpcm9ubWVudCwgd2hlcmUgeW91CiAgICAgICAgbWlnaHQgd2FudCB0byBhcHBlbmQgdGhlIHJvb3QgdmlldyB0byBhIGZpeHR1cmUgYXJlYS4KICAgICAgICAgSW4gbm9uLWJyb3dzZXIgbW9kZSwgYmVjYXVzZSBFbWJlciBkb2VzIG5vdCBoYXZlIGFjY2VzcyB0byBqUXVlcnksCiAgICAgICAgdGhpcyBvcHRpb25zIG11c3QgYmUgc3BlY2lmaWVkIGFzIGEgRE9NIGBFbGVtZW50YCBvYmplY3QgaW5zdGVhZCBvZgogICAgICAgIGEgc2VsZWN0b3Igc3RyaW5nLgogICAgICAgICBTZWUgdGhlIGRvY3VtZW50YXRpb24gb24gYEFwcGxpY2F0aW9uYCdzIGByb290RWxlbWVudGAgZm9yCiAgICAgICAgZGV0YWlscy4KICAgICAgICAgQHByb3BlcnR5IHJvb3RFbGVtZW50CiAgICAgICAgQHR5cGUgU3RyaW5nfEVsZW1lbnQKICAgICAgICBAZGVmYXVsdCBudWxsCiAgICAgICAgQHB1YmxpYwogICAgICAgKi8KCgogICAgICBpZiAob3B0aW9ucy5yb290RWxlbWVudCkgewogICAgICAgIHRoaXMucm9vdEVsZW1lbnQgPSBvcHRpb25zLnJvb3RFbGVtZW50OwogICAgICB9IC8vIFNldCB0aGVzZSBvcHRpb25zIGxhc3QgdG8gZ2l2ZSB0aGUgdXNlciBhIGNoYW5jZSB0byBvdmVycmlkZSB0aGUKICAgICAgLy8gZGVmYXVsdHMgZnJvbSB0aGUgImNvbWJvIiBvcHRpb25zIGxpa2UgYGlzQnJvd3NlcmAgKGFsdGhvdWdoIGluCiAgICAgIC8vIHByYWN0aWNlLCB0aGUgcmVzdWx0aW5nIGNvbWJpbmF0aW9uIGlzIHByb2JhYmx5IGludmFsaWQpCgogICAgICAvKioKICAgICAgICBJZiBwcmVzZW50LCBvdmVycmlkZXMgdGhlIHJvdXRlcidzIGBsb2NhdGlvbmAgcHJvcGVydHkgd2l0aCB0aGlzCiAgICAgICAgdmFsdWUuIFRoaXMgaXMgdXNlZnVsIGZvciBlbnZpcm9ubWVudHMgd2hlcmUgdHJ5aW5nIHRvIG1vZGlmeSB0aGUKICAgICAgICBVUkwgd291bGQgYmUgaW5hcHByb3ByaWF0ZS4KICAgICAgICAgQHByb3BlcnR5IGxvY2F0aW9uCiAgICAgICAgQHR5cGUgc3RyaW5nCiAgICAgICAgQGRlZmF1bHQgbnVsbAogICAgICAgIEBwdWJsaWMKICAgICAgKi8KCgogICAgICBpZiAob3B0aW9ucy5sb2NhdGlvbiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5sb2NhdGlvbiA9IG9wdGlvbnMubG9jYXRpb247CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLmpRdWVyeSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5qUXVlcnkgPSBvcHRpb25zLmpRdWVyeTsKICAgICAgfQoKICAgICAgaWYgKG9wdGlvbnMuaXNJbnRlcmFjdGl2ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5pc0ludGVyYWN0aXZlID0gQm9vbGVhbihvcHRpb25zLmlzSW50ZXJhY3RpdmUpOwogICAgICB9CiAgICB9CgogICAgdmFyIF9wcm90byA9IEJvb3RPcHRpb25zLnByb3RvdHlwZTsKCiAgICBfcHJvdG8udG9FbnZpcm9ubWVudCA9IGZ1bmN0aW9uIHRvRW52aXJvbm1lbnQoKSB7CiAgICAgIC8vIERvIHdlIHJlYWxseSB3YW50IHRvIGFzc2lnbiBhbGwgb2YgdGhpcyE/CiAgICAgIHZhciBlbnYgPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCBlbnZpcm9ubWVudCk7IC8vIEZvciBjb21wYXRpYmlsaXR5IHdpdGggZXhpc3RpbmcgY29kZQoKICAgICAgZW52Lmhhc0RPTSA9IHRoaXMuaXNCcm93c2VyOwogICAgICBlbnYuaXNJbnRlcmFjdGl2ZSA9IHRoaXMuaXNJbnRlcmFjdGl2ZTsKICAgICAgZW52Ll9yZW5kZXJNb2RlID0gdGhpcy5fcmVuZGVyTW9kZTsKICAgICAgZW52Lm9wdGlvbnMgPSB0aGlzOwogICAgICByZXR1cm4gZW52OwogICAgfTsKCiAgICByZXR1cm4gQm9vdE9wdGlvbnM7CiAgfSgpOwoKICB2YXIgX2RlZmF1bHQgPSBBcHBsaWNhdGlvbkluc3RhbmNlOwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CmRlZmluZSgiQGVtYmVyL2FwcGxpY2F0aW9uL2xpYi9hcHBsaWNhdGlvbiIsIFsiZXhwb3J0cyIsICJlbWJlci1iYWJlbCIsICJAZW1iZXIvLWludGVybmFscy91dGlscyIsICJAZW1iZXIvLWludGVybmFscy9lbnZpcm9ubWVudCIsICJAZW1iZXIvLWludGVybmFscy9icm93c2VyLWVudmlyb25tZW50IiwgIkBlbWJlci9kZWJ1ZyIsICJAZW1iZXIvcnVubG9vcCIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCIsICJAZW1iZXIvYXBwbGljYXRpb24vbGliL2xhenlfbG9hZCIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lIiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzIiwgIkBlbWJlci8taW50ZXJuYWxzL3JvdXRpbmciLCAiQGVtYmVyL2FwcGxpY2F0aW9uL2luc3RhbmNlIiwgIkBlbWJlci9lbmdpbmUiLCAiQGVtYmVyLy1pbnRlcm5hbHMvY29udGFpbmVyIiwgIkBlbWJlci8taW50ZXJuYWxzL2dsaW1tZXIiLCAiQGVtYmVyL2RlcHJlY2F0ZWQtZmVhdHVyZXMiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZW1iZXJCYWJlbCwgX3V0aWxzLCBfZW52aXJvbm1lbnQsIF9icm93c2VyRW52aXJvbm1lbnQsIF9kZWJ1ZywgX3J1bmxvb3AsIF9tZXRhbCwgX2xhenlfbG9hZCwgX3J1bnRpbWUsIF92aWV3cywgX3JvdXRpbmcsIF9pbnN0YW5jZSwgX2VuZ2luZSwgX2NvbnRhaW5lciwgX2dsaW1tZXIsIF9kZXByZWNhdGVkRmVhdHVyZXMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIGZ1bmN0aW9uIF90ZW1wbGF0ZU9iamVjdCgpIHsKICAgIHZhciBkYXRhID0gKDAsIF9lbWJlckJhYmVsLnRhZ2dlZFRlbXBsYXRlTGl0ZXJhbExvb3NlKShbIi1idWNrZXQtY2FjaGU6bWFpbiJdKTsKCiAgICBfdGVtcGxhdGVPYmplY3QgPSBmdW5jdGlvbiBfdGVtcGxhdGVPYmplY3QoKSB7CiAgICAgIHJldHVybiBkYXRhOwogICAgfTsKCiAgICByZXR1cm4gZGF0YTsKICB9CgogIHZhciBsaWJyYXJpZXNSZWdpc3RlcmVkID0gZmFsc2U7CiAgLyoqCiAgICBBbiBpbnN0YW5jZSBvZiBgQXBwbGljYXRpb25gIGlzIHRoZSBzdGFydGluZyBwb2ludCBmb3IgZXZlcnkgRW1iZXIKICAgIGFwcGxpY2F0aW9uLiBJdCBoZWxwcyB0byBpbnN0YW50aWF0ZSwgaW5pdGlhbGl6ZSBhbmQgY29vcmRpbmF0ZSB0aGUgbWFueQogICAgb2JqZWN0cyB0aGF0IG1ha2UgdXAgeW91ciBhcHAuCiAgCiAgICBFYWNoIEVtYmVyIGFwcCBoYXMgb25lIGFuZCBvbmx5IG9uZSBgQXBwbGljYXRpb25gIG9iamVjdC4gSW4gZmFjdCwgdGhlCiAgICB2ZXJ5IGZpcnN0IHRoaW5nIHlvdSBzaG91bGQgZG8gaW4geW91ciBhcHBsaWNhdGlvbiBpcyBjcmVhdGUgdGhlIGluc3RhbmNlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgCiAgICB3aW5kb3cuQXBwID0gQXBwbGljYXRpb24uY3JlYXRlKCk7CiAgICBgYGAKICAKICAgIFR5cGljYWxseSwgdGhlIGFwcGxpY2F0aW9uIG9iamVjdCBpcyB0aGUgb25seSBnbG9iYWwgdmFyaWFibGUuIEFsbCBvdGhlcgogICAgY2xhc3NlcyBpbiB5b3VyIGFwcCBzaG91bGQgYmUgcHJvcGVydGllcyBvbiB0aGUgYEFwcGxpY2F0aW9uYCBpbnN0YW5jZSwKICAgIHdoaWNoIGhpZ2hsaWdodHMgaXRzIGZpcnN0IHJvbGU6IGEgZ2xvYmFsIG5hbWVzcGFjZS4KICAKICAgIEZvciBleGFtcGxlLCBpZiB5b3UgZGVmaW5lIGEgdmlldyBjbGFzcywgaXQgbWlnaHQgbG9vayBsaWtlIHRoaXM6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAKICAgIEFwcC5NeVZpZXcgPSBFbWJlci5WaWV3LmV4dGVuZCgpOwogICAgYGBgCiAgCiAgICBCeSBkZWZhdWx0LCBjYWxsaW5nIGBBcHBsaWNhdGlvbi5jcmVhdGUoKWAgd2lsbCBhdXRvbWF0aWNhbGx5IGluaXRpYWxpemUKICAgIHlvdXIgYXBwbGljYXRpb24gYnkgY2FsbGluZyB0aGUgYEFwcGxpY2F0aW9uLmluaXRpYWxpemUoKWAgbWV0aG9kLiBJZgogICAgeW91IG5lZWQgdG8gZGVsYXkgaW5pdGlhbGl6YXRpb24sIHlvdSBjYW4gY2FsbCB5b3VyIGFwcCdzIGBkZWZlclJlYWRpbmVzcygpYAogICAgbWV0aG9kLiBXaGVuIHlvdSBhcmUgcmVhZHkgZm9yIHlvdXIgYXBwIHRvIGJlIGluaXRpYWxpemVkLCBjYWxsIGl0cwogICAgYGFkdmFuY2VSZWFkaW5lc3MoKWAgbWV0aG9kLgogIAogICAgWW91IGNhbiBkZWZpbmUgYSBgcmVhZHlgIG1ldGhvZCBvbiB0aGUgYEFwcGxpY2F0aW9uYCBpbnN0YW5jZSwgd2hpY2gKICAgIHdpbGwgYmUgcnVuIGJ5IEVtYmVyIHdoZW4gdGhlIGFwcGxpY2F0aW9uIGlzIGluaXRpYWxpemVkLgogIAogICAgQmVjYXVzZSBgQXBwbGljYXRpb25gIGluaGVyaXRzIGZyb20gYEVtYmVyLk5hbWVzcGFjZWAsIGFueSBjbGFzc2VzCiAgICB5b3UgY3JlYXRlIHdpbGwgaGF2ZSB1c2VmdWwgc3RyaW5nIHJlcHJlc2VudGF0aW9ucyB3aGVuIGNhbGxpbmcgYHRvU3RyaW5nKClgLgogICAgU2VlIHRoZSBgRW1iZXIuTmFtZXNwYWNlYCBkb2N1bWVudGF0aW9uIGZvciBtb3JlIGluZm9ybWF0aW9uLgogIAogICAgV2hpbGUgeW91IGNhbiB0aGluayBvZiB5b3VyIGBBcHBsaWNhdGlvbmAgYXMgYSBjb250YWluZXIgdGhhdCBob2xkcyB0aGUKICAgIG90aGVyIGNsYXNzZXMgaW4geW91ciBhcHBsaWNhdGlvbiwgdGhlcmUgYXJlIHNldmVyYWwgb3RoZXIgcmVzcG9uc2liaWxpdGllcwogICAgZ29pbmcgb24gdW5kZXItdGhlLWhvb2QgdGhhdCB5b3UgbWF5IHdhbnQgdG8gdW5kZXJzdGFuZC4KICAKICAgICMjIyBFdmVudCBEZWxlZ2F0aW9uCiAgCiAgICBFbWJlciB1c2VzIGEgdGVjaG5pcXVlIGNhbGxlZCBfZXZlbnQgZGVsZWdhdGlvbl8uIFRoaXMgYWxsb3dzIHRoZSBmcmFtZXdvcmsKICAgIHRvIHNldCB1cCBhIGdsb2JhbCwgc2hhcmVkIGV2ZW50IGxpc3RlbmVyIGluc3RlYWQgb2YgcmVxdWlyaW5nIGVhY2ggdmlldyB0bwogICAgZG8gaXQgbWFudWFsbHkuIEZvciBleGFtcGxlLCBpbnN0ZWFkIG9mIGVhY2ggdmlldyByZWdpc3RlcmluZyBpdHMgb3duCiAgICBgbW91c2Vkb3duYCBsaXN0ZW5lciBvbiBpdHMgYXNzb2NpYXRlZCBlbGVtZW50LCBFbWJlciBzZXRzIHVwIGEgYG1vdXNlZG93bmAKICAgIGxpc3RlbmVyIG9uIHRoZSBgYm9keWAuCiAgCiAgICBJZiBhIGBtb3VzZWRvd25gIGV2ZW50IG9jY3VycywgRW1iZXIgd2lsbCBsb29rIGF0IHRoZSB0YXJnZXQgb2YgdGhlIGV2ZW50IGFuZAogICAgc3RhcnQgd2Fsa2luZyB1cCB0aGUgRE9NIG5vZGUgdHJlZSwgZmluZGluZyBjb3JyZXNwb25kaW5nIHZpZXdzIGFuZCBpbnZva2luZwogICAgdGhlaXIgYG1vdXNlRG93bmAgbWV0aG9kIGFzIGl0IGdvZXMuCiAgCiAgICBgQXBwbGljYXRpb25gIGhhcyBhIG51bWJlciBvZiBkZWZhdWx0IGV2ZW50cyB0aGF0IGl0IGxpc3RlbnMgZm9yLCBhcwogICAgd2VsbCBhcyBhIG1hcHBpbmcgZnJvbSBsb3dlcmNhc2UgZXZlbnRzIHRvIGNhbWVsLWNhc2VkIHZpZXcgbWV0aG9kIG5hbWVzLiBGb3IKICAgIGV4YW1wbGUsIHRoZSBga2V5cHJlc3NgIGV2ZW50IGNhdXNlcyB0aGUgYGtleVByZXNzYCBtZXRob2Qgb24gdGhlIHZpZXcgdG8gYmUKICAgIGNhbGxlZCwgdGhlIGBkYmxjbGlja2AgZXZlbnQgY2F1c2VzIGBkb3VibGVDbGlja2AgdG8gYmUgY2FsbGVkLCBhbmQgc28gb24uCiAgCiAgICBJZiB0aGVyZSBpcyBhIGJ1YmJsaW5nIGJyb3dzZXIgZXZlbnQgdGhhdCBFbWJlciBkb2VzIG5vdCBsaXN0ZW4gZm9yIGJ5CiAgICBkZWZhdWx0LCB5b3UgY2FuIHNwZWNpZnkgY3VzdG9tIGV2ZW50cyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyB2aWV3IG1ldGhvZAogICAgbmFtZXMgYnkgc2V0dGluZyB0aGUgYXBwbGljYXRpb24ncyBgY3VzdG9tRXZlbnRzYCBwcm9wZXJ0eToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBBcHBsaWNhdGlvbiBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogIAogICAgbGV0IEFwcCA9IEFwcGxpY2F0aW9uLmNyZWF0ZSh7CiAgICAgIGN1c3RvbUV2ZW50czogewogICAgICAgIC8vIGFkZCBzdXBwb3J0IGZvciB0aGUgcGFzdGUgZXZlbnQKICAgICAgICBwYXN0ZTogJ3Bhc3RlJwogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgVG8gcHJldmVudCBFbWJlciBmcm9tIHNldHRpbmcgdXAgYSBsaXN0ZW5lciBmb3IgYSBkZWZhdWx0IGV2ZW50LAogICAgc3BlY2lmeSB0aGUgZXZlbnQgbmFtZSB3aXRoIGEgYG51bGxgIHZhbHVlIGluIHRoZSBgY3VzdG9tRXZlbnRzYAogICAgcHJvcGVydHk6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAKICAgIGxldCBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoewogICAgICBjdXN0b21FdmVudHM6IHsKICAgICAgICAvLyBwcmV2ZW50IGxpc3RlbmVycyBmb3IgbW91c2VlbnRlci9tb3VzZWxlYXZlIGV2ZW50cwogICAgICAgIG1vdXNlZW50ZXI6IG51bGwsCiAgICAgICAgbW91c2VsZWF2ZTogbnVsbAogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgQnkgZGVmYXVsdCwgdGhlIGFwcGxpY2F0aW9uIHNldHMgdXAgdGhlc2UgZXZlbnQgbGlzdGVuZXJzIG9uIHRoZSBkb2N1bWVudAogICAgYm9keS4gSG93ZXZlciwgaW4gY2FzZXMgd2hlcmUgeW91IGFyZSBlbWJlZGRpbmcgYW4gRW1iZXIgYXBwbGljYXRpb24gaW5zaWRlCiAgICBhbiBleGlzdGluZyBwYWdlLCB5b3UgbWF5IHdhbnQgaXQgdG8gc2V0IHVwIHRoZSBsaXN0ZW5lcnMgb24gYW4gZWxlbWVudAogICAgaW5zaWRlIHRoZSBib2R5LgogIAogICAgRm9yIGV4YW1wbGUsIGlmIG9ubHkgZXZlbnRzIGluc2lkZSBhIERPTSBlbGVtZW50IHdpdGggdGhlIElEIG9mIGBlbWJlci1hcHBgCiAgICBzaG91bGQgYmUgZGVsZWdhdGVkLCBzZXQgeW91ciBhcHBsaWNhdGlvbidzIGByb290RWxlbWVudGAgcHJvcGVydHk6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAKICAgIGxldCBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoewogICAgICByb290RWxlbWVudDogJyNlbWJlci1hcHAnCiAgICB9KTsKICAgIGBgYAogIAogICAgVGhlIGByb290RWxlbWVudGAgY2FuIGJlIGVpdGhlciBhIERPTSBlbGVtZW50IG9yIGEgalF1ZXJ5LWNvbXBhdGlibGUgc2VsZWN0b3IKICAgIHN0cmluZy4gTm90ZSB0aGF0ICp2aWV3cyBhcHBlbmRlZCB0byB0aGUgRE9NIG91dHNpZGUgdGhlIHJvb3QgZWxlbWVudCB3aWxsCiAgICBub3QgcmVjZWl2ZSBldmVudHMuKiBJZiB5b3Ugc3BlY2lmeSBhIGN1c3RvbSByb290IGVsZW1lbnQsIG1ha2Ugc3VyZSB5b3Ugb25seQogICAgYXBwZW5kIHZpZXdzIGluc2lkZSBpdCEKICAKICAgIFRvIGxlYXJuIG1vcmUgYWJvdXQgdGhlIGV2ZW50cyBFbWJlciBjb21wb25lbnRzIHVzZSwgc2VlCiAgCiAgICBbY29tcG9uZW50cy9oYW5kbGluZy1ldmVudHNdKGh0dHBzOi8vZ3VpZGVzLmVtYmVyanMuY29tL3JlbGVhc2UvY29tcG9uZW50cy9oYW5kbGluZy1ldmVudHMvI3RvY19ldmVudC1uYW1lcykuCiAgCiAgICAjIyMgSW5pdGlhbGl6ZXJzCiAgCiAgICBMaWJyYXJpZXMgb24gdG9wIG9mIEVtYmVyIGNhbiBhZGQgaW5pdGlhbGl6ZXJzLCBsaWtlIHNvOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgCiAgICBBcHBsaWNhdGlvbi5pbml0aWFsaXplcih7CiAgICAgIG5hbWU6ICdhcGktYWRhcHRlcicsCiAgCiAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGFwcGxpY2F0aW9uKSB7CiAgICAgICAgYXBwbGljYXRpb24ucmVnaXN0ZXIoJ2FwaS1hZGFwdGVyOm1haW4nLCBBcGlBZGFwdGVyKTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIEluaXRpYWxpemVycyBwcm92aWRlIGFuIG9wcG9ydHVuaXR5IHRvIGFjY2VzcyB0aGUgaW50ZXJuYWwgcmVnaXN0cnksIHdoaWNoCiAgICBvcmdhbml6ZXMgdGhlIGRpZmZlcmVudCBjb21wb25lbnRzIG9mIGFuIEVtYmVyIGFwcGxpY2F0aW9uLiBBZGRpdGlvbmFsbHkKICAgIHRoZXkgcHJvdmlkZSBhIGNoYW5jZSB0byBhY2Nlc3MgdGhlIGluc3RhbnRpYXRlZCBhcHBsaWNhdGlvbi4gQmV5b25kCiAgICBiZWluZyB1c2VkIGZvciBsaWJyYXJpZXMsIGluaXRpYWxpemVycyBhcmUgYWxzbyBhIGdyZWF0IHdheSB0byBvcmdhbml6ZQogICAgZGVwZW5kZW5jeSBpbmplY3Rpb24gb3Igc2V0dXAgaW4geW91ciBvd24gYXBwbGljYXRpb24uCiAgCiAgICAjIyMgUm91dGluZwogIAogICAgSW4gYWRkaXRpb24gdG8gY3JlYXRpbmcgeW91ciBhcHBsaWNhdGlvbidzIHJvdXRlciwgYEFwcGxpY2F0aW9uYCBpcwogICAgYWxzbyByZXNwb25zaWJsZSBmb3IgdGVsbGluZyB0aGUgcm91dGVyIHdoZW4gdG8gc3RhcnQgcm91dGluZy4gVHJhbnNpdGlvbnMKICAgIGJldHdlZW4gcm91dGVzIGNhbiBiZSBsb2dnZWQgd2l0aCB0aGUgYExPR19UUkFOU0lUSU9OU2AgZmxhZywgYW5kIG1vcmUKICAgIGRldGFpbGVkIGludHJhLXRyYW5zaXRpb24gbG9nZ2luZyBjYW4gYmUgbG9nZ2VkIHdpdGgKICAgIHRoZSBgTE9HX1RSQU5TSVRJT05TX0lOVEVSTkFMYCBmbGFnOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgCiAgICBsZXQgQXBwID0gQXBwbGljYXRpb24uY3JlYXRlKHsKICAgICAgTE9HX1RSQU5TSVRJT05TOiB0cnVlLCAvLyBiYXNpYyBsb2dnaW5nIG9mIHN1Y2Nlc3NmdWwgdHJhbnNpdGlvbnMKICAgICAgTE9HX1RSQU5TSVRJT05TX0lOVEVSTkFMOiB0cnVlIC8vIGRldGFpbGVkIGxvZ2dpbmcgb2YgYWxsIHJvdXRpbmcgc3RlcHMKICAgIH0pOwogICAgYGBgCiAgCiAgICBCeSBkZWZhdWx0LCB0aGUgcm91dGVyIHdpbGwgYmVnaW4gdHJ5aW5nIHRvIHRyYW5zbGF0ZSB0aGUgY3VycmVudCBVUkwgaW50bwogICAgYXBwbGljYXRpb24gc3RhdGUgb25jZSB0aGUgYnJvd3NlciBlbWl0cyB0aGUgYERPTUNvbnRlbnRSZWFkeWAgZXZlbnQuIElmIHlvdQogICAgbmVlZCB0byBkZWZlciByb3V0aW5nLCB5b3UgY2FuIGNhbGwgdGhlIGFwcGxpY2F0aW9uJ3MgYGRlZmVyUmVhZGluZXNzKClgCiAgICBtZXRob2QuIE9uY2Ugcm91dGluZyBjYW4gYmVnaW4sIGNhbGwgdGhlIGBhZHZhbmNlUmVhZGluZXNzKClgIG1ldGhvZC4KICAKICAgIElmIHRoZXJlIGlzIGFueSBzZXR1cCByZXF1aXJlZCBiZWZvcmUgcm91dGluZyBiZWdpbnMsIHlvdSBjYW4gaW1wbGVtZW50IGEKICAgIGByZWFkeSgpYCBtZXRob2Qgb24geW91ciBhcHAgdGhhdCB3aWxsIGJlIGludm9rZWQgaW1tZWRpYXRlbHkgYmVmb3JlIHJvdXRpbmcKICAgIGJlZ2lucy4KICAKICAgIEBjbGFzcyBBcHBsaWNhdGlvbgogICAgQGV4dGVuZHMgRW5naW5lCiAgICBAdXNlcyBSZWdpc3RyeVByb3h5TWl4aW4KICAgIEBwdWJsaWMKICAqLwoKICB2YXIgQXBwbGljYXRpb24gPSBfZW5naW5lLmRlZmF1bHQuZXh0ZW5kKHsKICAgIC8qKgogICAgICBUaGUgcm9vdCBET00gZWxlbWVudCBvZiB0aGUgQXBwbGljYXRpb24uIFRoaXMgY2FuIGJlIHNwZWNpZmllZCBhcyBhbgogICAgICBlbGVtZW50IG9yIGEKICAgICAgW2pRdWVyeS1jb21wYXRpYmxlIHNlbGVjdG9yIHN0cmluZ10oaHR0cDovL2FwaS5qcXVlcnkuY29tL2NhdGVnb3J5L3NlbGVjdG9ycy8pLgogICAgICAgVGhpcyBpcyB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBBcHBsaWNhdGlvbidzLAogICAgICBgZXZlbnREaXNwYXRjaGVyYCwgd2hpY2ggc2V0cyB1cCB0aGUgbGlzdGVuZXJzIGZvciBldmVudCBkZWxlZ2F0aW9uLiBFdmVyeQogICAgICB2aWV3IGluIHlvdXIgYXBwbGljYXRpb24gc2hvdWxkIGJlIGEgY2hpbGQgb2YgdGhlIGVsZW1lbnQgeW91IHNwZWNpZnkgaGVyZS4KICAgICAgIEBwcm9wZXJ0eSByb290RWxlbWVudAogICAgICBAdHlwZSBET01FbGVtZW50CiAgICAgIEBkZWZhdWx0ICdib2R5JwogICAgICBAcHVibGljCiAgICAqLwogICAgcm9vdEVsZW1lbnQ6ICdib2R5JywKCiAgICAvKioKICAgICAgVGhlIGBFbWJlci5FdmVudERpc3BhdGNoZXJgIHJlc3BvbnNpYmxlIGZvciBkZWxlZ2F0aW5nIGV2ZW50cyB0byB0aGlzCiAgICAgIGFwcGxpY2F0aW9uJ3Mgdmlld3MuCiAgICAgICBUaGUgZXZlbnQgZGlzcGF0Y2hlciBpcyBjcmVhdGVkIGJ5IHRoZSBhcHBsaWNhdGlvbiBhdCBpbml0aWFsaXphdGlvbiB0aW1lCiAgICAgIGFuZCBzZXRzIHVwIGV2ZW50IGxpc3RlbmVycyBvbiB0aGUgRE9NIGVsZW1lbnQgZGVzY3JpYmVkIGJ5IHRoZQogICAgICBhcHBsaWNhdGlvbidzIGByb290RWxlbWVudGAgcHJvcGVydHkuCiAgICAgICBTZWUgdGhlIGRvY3VtZW50YXRpb24gZm9yIGBFbWJlci5FdmVudERpc3BhdGNoZXJgIGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICAgQHByb3BlcnR5IGV2ZW50RGlzcGF0Y2hlcgogICAgICBAdHlwZSBFbWJlci5FdmVudERpc3BhdGNoZXIKICAgICAgQGRlZmF1bHQgbnVsbAogICAgICBAcHVibGljCiAgICAqLwogICAgZXZlbnREaXNwYXRjaGVyOiBudWxsLAoKICAgIC8qKgogICAgICBUaGUgRE9NIGV2ZW50cyBmb3Igd2hpY2ggdGhlIGV2ZW50IGRpc3BhdGNoZXIgc2hvdWxkIGxpc3Rlbi4KICAgICAgIEJ5IGRlZmF1bHQsIHRoZSBhcHBsaWNhdGlvbidzIGBFbWJlci5FdmVudERpc3BhdGNoZXJgIGxpc3RlbnMKICAgICAgZm9yIGEgc2V0IG9mIHN0YW5kYXJkIERPTSBldmVudHMsIHN1Y2ggYXMgYG1vdXNlZG93bmAgYW5kCiAgICAgIGBrZXl1cGAsIGFuZCBkZWxlZ2F0ZXMgdGhlbSB0byB5b3VyIGFwcGxpY2F0aW9uJ3MgYEVtYmVyLlZpZXdgCiAgICAgIGluc3RhbmNlcy4KICAgICAgIElmIHlvdSB3b3VsZCBsaWtlIGFkZGl0aW9uYWwgYnViYmxpbmcgZXZlbnRzIHRvIGJlIGRlbGVnYXRlZCB0byB5b3VyCiAgICAgIHZpZXdzLCBzZXQgeW91ciBgQXBwbGljYXRpb25gJ3MgYGN1c3RvbUV2ZW50c2AgcHJvcGVydHkKICAgICAgdG8gYSBoYXNoIGNvbnRhaW5pbmcgdGhlIERPTSBldmVudCBuYW1lIGFzIHRoZSBrZXkgYW5kIHRoZQogICAgICBjb3JyZXNwb25kaW5nIHZpZXcgbWV0aG9kIG5hbWUgYXMgdGhlIHZhbHVlLiBTZXR0aW5nIGFuIGV2ZW50IHRvCiAgICAgIGEgdmFsdWUgb2YgYG51bGxgIHdpbGwgcHJldmVudCBhIGRlZmF1bHQgZXZlbnQgbGlzdGVuZXIgZnJvbSBiZWluZwogICAgICBhZGRlZCBmb3IgdGhhdCBldmVudC4KICAgICAgIFRvIGFkZCBuZXcgZXZlbnRzIHRvIGJlIGxpc3RlbmVkIHRvOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAgICAgIGxldCBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoewogICAgICAgIGN1c3RvbUV2ZW50czogewogICAgICAgICAgLy8gYWRkIHN1cHBvcnQgZm9yIHRoZSBwYXN0ZSBldmVudAogICAgICAgICAgcGFzdGU6ICdwYXN0ZScKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFRvIHByZXZlbnQgZGVmYXVsdCBldmVudHMgZnJvbSBiZWluZyBsaXN0ZW5lZCB0bzoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgICAgICBsZXQgQXBwID0gQXBwbGljYXRpb24uY3JlYXRlKHsKICAgICAgICBjdXN0b21FdmVudHM6IHsKICAgICAgICAgIC8vIHJlbW92ZSBzdXBwb3J0IGZvciBtb3VzZWVudGVyIC8gbW91c2VsZWF2ZSBldmVudHMKICAgICAgICAgIG1vdXNlZW50ZXI6IG51bGwsCiAgICAgICAgICBtb3VzZWxlYXZlOiBudWxsCiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgIEBwcm9wZXJ0eSBjdXN0b21FdmVudHMKICAgICAgQHR5cGUgT2JqZWN0CiAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGN1c3RvbUV2ZW50czogbnVsbCwKCiAgICAvKioKICAgICAgV2hldGhlciB0aGUgYXBwbGljYXRpb24gc2hvdWxkIGF1dG9tYXRpY2FsbHkgc3RhcnQgcm91dGluZyBhbmQgcmVuZGVyCiAgICAgIHRlbXBsYXRlcyB0byB0aGUgYHJvb3RFbGVtZW50YCBvbiBET00gcmVhZHkuIFdoaWxlIGRlZmF1bHQgYnkgdHJ1ZSwKICAgICAgb3RoZXIgZW52aXJvbm1lbnRzIHN1Y2ggYXMgRmFzdEJvb3Qgb3IgYSB0ZXN0aW5nIGhhcm5lc3MgY2FuIHNldCB0aGlzCiAgICAgIHByb3BlcnR5IHRvIGBmYWxzZWAgYW5kIGNvbnRyb2wgdGhlIHByZWNpc2UgdGltaW5nIGFuZCBiZWhhdmlvciBvZiB0aGUgYm9vdAogICAgICBwcm9jZXNzLgogICAgICAgQHByb3BlcnR5IGF1dG9ib290CiAgICAgIEB0eXBlIEJvb2xlYW4KICAgICAgQGRlZmF1bHQgdHJ1ZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGF1dG9ib290OiB0cnVlLAoKICAgIC8qKgogICAgICBXaGV0aGVyIHRoZSBhcHBsaWNhdGlvbiBzaG91bGQgYmUgY29uZmlndXJlZCBmb3IgdGhlIGxlZ2FjeSAiZ2xvYmFscyBtb2RlIi4KICAgICAgVW5kZXIgdGhpcyBtb2RlLCB0aGUgQXBwbGljYXRpb24gb2JqZWN0IHNlcnZlcyBhcyBhIGdsb2JhbCBuYW1lc3BhY2UgZm9yIGFsbAogICAgICBjbGFzc2VzLgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgICAgIGxldCBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoewogICAgICAgIC4uLgogICAgICB9KTsKICAgICAgIEFwcC5Sb3V0ZXIucmVvcGVuKHsKICAgICAgICBsb2NhdGlvbjogJ25vbmUnCiAgICAgIH0pOwogICAgICAgQXBwLlJvdXRlci5tYXAoewogICAgICAgIC4uLgogICAgICB9KTsKICAgICAgIEFwcC5NeUNvbXBvbmVudCA9IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIC4uLgogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBUaGlzIGZsYWcgYWxzbyBleHBvc2VzIG90aGVyIGludGVybmFsIEFQSXMgdGhhdCBhc3N1bWVzIHRoZSBleGlzdGVuY2Ugb2YKICAgICAgYSBzcGVjaWFsICJkZWZhdWx0IGluc3RhbmNlIiwgbGlrZSBgQXBwLl9fY29udGFpbmVyX18ubG9va3VwKC4uLilgLgogICAgICAgVGhpcyBvcHRpb24gaXMgY3VycmVudGx5IG5vdCBjb25maWd1cmFibGUsIGl0cyB2YWx1ZSBpcyBkZXJpdmVkIGZyb20KICAgICAgdGhlIGBhdXRvYm9vdGAgZmxhZyDigJMgZGlzYWJsaW5nIGBhdXRvYm9vdGAgYWxzbyBpbXBsaWVzIG9wdGluZy1vdXQgb2YKICAgICAgZ2xvYmFscyBtb2RlIHN1cHBvcnQsIGFsdGhvdWdoIHRoZXkgYXJlIHVsdGltYXRlbHkgb3J0aG9nb25hbCBjb25jZXJucy4KICAgICAgIFNvbWUgb2YgdGhlIGdsb2JhbCBtb2RlcyBmZWF0dXJlcyBhcmUgYWxyZWFkeSBkZXByZWNhdGVkIGluIDEueC4gVGhlCiAgICAgIGV4aXN0ZW5jZSBvZiB0aGlzIGZsYWcgaXMgdG8gdW50YW5nbGUgdGhlIGdsb2JhbHMgbW9kZSBjb2RlIHBhdGhzIGZyb20KICAgICAgdGhlIGF1dG9ib290IGNvZGUgcGF0aHMsIHNvIHRoYXQgdGhlc2UgbGVnYWN5IGZlYXR1cmVzIGNhbiBiZSByZXZpZXdlZAogICAgICBmb3IgZGVwcmVjYXRpb24vcmVtb3ZhbCBzZXBhcmF0ZWx5LgogICAgICAgRm9yY2luZyB0aGUgKGF1dG9ib290PXRydWUsIF9nbG9iYWxzTW9kZT1mYWxzZSkgaGVyZSBhbmQgcnVubmluZyB0aGUgdGVzdHMKICAgICAgd291bGQgcmV2ZWFsIGFsbCB0aGUgcGxhY2VzIHdoZXJlIHdlIGFyZSBzdGlsbCByZWx5aW5nIG9uIHRoZXNlIGxlZ2FjeQogICAgICBiZWhhdmlvciBpbnRlcm5hbGx5IChtb3N0bHkganVzdCB0ZXN0cykuCiAgICAgICBAcHJvcGVydHkgX2dsb2JhbHNNb2RlCiAgICAgIEB0eXBlIEJvb2xlYW4KICAgICAgQGRlZmF1bHQgdHJ1ZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9nbG9iYWxzTW9kZTogdHJ1ZSwKCiAgICAvKioKICAgICAgQW4gYXJyYXkgb2YgYXBwbGljYXRpb24gaW5zdGFuY2VzIGNyZWF0ZWQgYnkgYGJ1aWxkSW5zdGFuY2UoKWAuIFVzZWQKICAgICAgaW50ZXJuYWxseSB0byBlbnN1cmUgdGhhdCBhbGwgaW5zdGFuY2VzIGdldCBkZXN0cm95ZWQuCiAgICAgICBAcHJvcGVydHkgX2FwcGxpY2F0aW9uSW5zdGFuY2VzCiAgICAgIEB0eXBlIEFycmF5CiAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgQHByaXZhdGUKICAgICovCiAgICBfYXBwbGljYXRpb25JbnN0YW5jZXM6IG51bGwsCiAgICBpbml0OiBmdW5jdGlvbiBpbml0KCkgewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVudXNlZC12YXJzCiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICBpZiAoIXRoaXMuJCkgewogICAgICAgIHRoaXMuJCA9IF92aWV3cy5qUXVlcnk7CiAgICAgIH0KCiAgICAgIHJlZ2lzdGVyTGlicmFyaWVzKCk7CgogICAgICBpZiAoZmFsc2UKICAgICAgLyogREVCVUcgKi8KICAgICAgKSB7CiAgICAgICAgaWYgKF9lbnZpcm9ubWVudC5FTlYuTE9HX1ZFUlNJT04pIHsKICAgICAgICAgIC8vIHdlIG9ubHkgbmVlZCB0byBzZWUgdGhpcyBvbmNlIHBlciBBcHBsaWNhdGlvbiNpbml0CiAgICAgICAgICBfZW52aXJvbm1lbnQuRU5WLkxPR19WRVJTSU9OID0gZmFsc2U7CgogICAgICAgICAgX21ldGFsLmxpYnJhcmllcy5sb2dWZXJzaW9ucygpOwogICAgICAgIH0KICAgICAgfSAvLyBTdGFydCBvZmYgdGhlIG51bWJlciBvZiBkZWZlcnJhbHMgYXQgMS4gVGhpcyB3aWxsIGJlIGRlY3JlbWVudGVkIGJ5CiAgICAgIC8vIHRoZSBBcHBsaWNhdGlvbidzIG93biBgYm9vdGAgbWV0aG9kLgoKCiAgICAgIHRoaXMuX3JlYWRpbmVzc0RlZmVycmFscyA9IDE7CiAgICAgIHRoaXMuX2Jvb3RlZCA9IGZhbHNlOwogICAgICB0aGlzLl9hcHBsaWNhdGlvbkluc3RhbmNlcyA9IG5ldyBTZXQoKTsKICAgICAgdGhpcy5hdXRvYm9vdCA9IHRoaXMuX2dsb2JhbHNNb2RlID0gQm9vbGVhbih0aGlzLmF1dG9ib290KTsKCiAgICAgIGlmICh0aGlzLl9nbG9iYWxzTW9kZSkgewogICAgICAgIHRoaXMuX3ByZXBhcmVGb3JHbG9iYWxzTW9kZSgpOwogICAgICB9CgogICAgICBpZiAodGhpcy5hdXRvYm9vdCkgewogICAgICAgIHRoaXMud2FpdEZvckRPTVJlYWR5KCk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgIENyZWF0ZSBhbiBBcHBsaWNhdGlvbkluc3RhbmNlIGZvciB0aGlzIGFwcGxpY2F0aW9uLgogICAgICAgQHB1YmxpYwogICAgICBAbWV0aG9kIGJ1aWxkSW5zdGFuY2UKICAgICAgQHJldHVybiB7QXBwbGljYXRpb25JbnN0YW5jZX0gdGhlIGFwcGxpY2F0aW9uIGluc3RhbmNlCiAgICAqLwogICAgYnVpbGRJbnN0YW5jZTogZnVuY3Rpb24gYnVpbGRJbnN0YW5jZShvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIG9wdGlvbnMuYmFzZSA9IHRoaXM7CiAgICAgIG9wdGlvbnMuYXBwbGljYXRpb24gPSB0aGlzOwogICAgICByZXR1cm4gX2luc3RhbmNlLmRlZmF1bHQuY3JlYXRlKG9wdGlvbnMpOwogICAgfSwKCiAgICAvKioKICAgICAgU3RhcnQgdHJhY2tpbmcgYW4gQXBwbGljYXRpb25JbnN0YW5jZSBmb3IgdGhpcyBhcHBsaWNhdGlvbi4KICAgICAgVXNlZCB3aGVuIHRoZSBBcHBsaWNhdGlvbkluc3RhbmNlIGlzIGNyZWF0ZWQuCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIF93YXRjaEluc3RhbmNlCiAgICAqLwogICAgX3dhdGNoSW5zdGFuY2U6IGZ1bmN0aW9uIF93YXRjaEluc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgIHRoaXMuX2FwcGxpY2F0aW9uSW5zdGFuY2VzLmFkZChpbnN0YW5jZSk7CiAgICB9LAoKICAgIC8qKgogICAgICBTdG9wIHRyYWNraW5nIGFuIEFwcGxpY2F0aW9uSW5zdGFuY2UgZm9yIHRoaXMgYXBwbGljYXRpb24uCiAgICAgIFVzZWQgd2hlbiB0aGUgQXBwbGljYXRpb25JbnN0YW5jZSBpcyBhYm91dCB0byBiZSBkZXN0cm95ZWQuCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIF91bndhdGNoSW5zdGFuY2UKICAgICovCiAgICBfdW53YXRjaEluc3RhbmNlOiBmdW5jdGlvbiBfdW53YXRjaEluc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgIHJldHVybiB0aGlzLl9hcHBsaWNhdGlvbkluc3RhbmNlcy5kZWxldGUoaW5zdGFuY2UpOwogICAgfSwKCiAgICAvKioKICAgICAgRW5hYmxlIHRoZSBsZWdhY3kgZ2xvYmFscyBtb2RlIGJ5IGFsbG93aW5nIHRoaXMgYXBwbGljYXRpb24gdG8gYWN0CiAgICAgIGFzIGEgZ2xvYmFsIG5hbWVzcGFjZS4gU2VlIHRoZSBkb2NzIG9uIHRoZSBgX2dsb2JhbHNNb2RlYCBwcm9wZXJ0eQogICAgICBmb3IgZGV0YWlscy4KICAgICAgIE1vc3Qgb2YgdGhlc2UgZmVhdHVyZXMgYXJlIGFscmVhZHkgZGVwcmVjYXRlZCBpbiAxLngsIHNvIHdlIGNhbgogICAgICBzdG9wIHVzaW5nIHRoZW0gaW50ZXJuYWxseSBhbmQgdHJ5IHRvIHJlbW92ZSB0aGVtLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBfcHJlcGFyZUZvckdsb2JhbHNNb2RlCiAgICAqLwogICAgX3ByZXBhcmVGb3JHbG9iYWxzTW9kZTogZnVuY3Rpb24gX3ByZXBhcmVGb3JHbG9iYWxzTW9kZSgpIHsKICAgICAgLy8gQ3JlYXRlIHN1YmNsYXNzIG9mIFJvdXRlciBmb3IgdGhpcyBBcHBsaWNhdGlvbiBpbnN0YW5jZS4KICAgICAgLy8gVGhpcyBpcyB0byBlbnN1cmUgdGhhdCBzb21lb25lIHJlb3BlbmluZyBgQXBwLlJvdXRlcmAgZG9lcyBub3QKICAgICAgLy8gdGFtcGVyIHdpdGggdGhlIGRlZmF1bHQgYFJvdXRlcmAuCiAgICAgIHRoaXMuUm91dGVyID0gKHRoaXMuUm91dGVyIHx8IF9yb3V0aW5nLlJvdXRlcikuZXh0ZW5kKCk7CgogICAgICB0aGlzLl9idWlsZERlcHJlY2F0ZWRJbnN0YW5jZSgpOwogICAgfSwKCiAgICAvKgogICAgICBCdWlsZCB0aGUgZGVwcmVjYXRlZCBpbnN0YW5jZSBmb3IgbGVnYWN5IGdsb2JhbHMgbW9kZSBzdXBwb3J0LgogICAgICBDYWxsZWQgd2hlbiBjcmVhdGluZyBhbmQgcmVzZXR0aW5nIHRoZSBhcHBsaWNhdGlvbi4KICAgICAgIFRoaXMgaXMgb3J0aG9nb25hbCB0byBhdXRvYm9vdDogdGhlIGRlcHJlY2F0ZWQgaW5zdGFuY2UgbmVlZHMgdG8KICAgICAgYmUgY3JlYXRlZCBhdCBBcHBsaWNhdGlvbiBjb25zdHJ1Y3Rpb24gKG5vdCBib290KSB0aW1lIHRvIGV4cG9zZQogICAgICBBcHAuX19jb250YWluZXJfXy4gSWYgYXV0b2Jvb3Qgc2VlcyB0aGF0IHRoaXMgaW5zdGFuY2UgZXhpc3RzLAogICAgICBpdCB3aWxsIGNvbnRpbnVlIGJvb3RpbmcgaXQgdG8gYXZvaWQgZG9pbmcgdW5uY2Vzc2FyeSB3b3JrIChhcwogICAgICBvcHBvc2VkIHRvIGJ1aWxkaW5nIGEgbmV3IGluc3RhbmNlIGF0IGJvb3QgdGltZSksIGJ1dCB0aGV5IGFyZQogICAgICBvdGhlcndpc2UgdW5yZWxhdGVkLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBfYnVpbGREZXByZWNhdGVkSW5zdGFuY2UKICAgICovCiAgICBfYnVpbGREZXByZWNhdGVkSW5zdGFuY2U6IGZ1bmN0aW9uIF9idWlsZERlcHJlY2F0ZWRJbnN0YW5jZSgpIHsKICAgICAgLy8gQnVpbGQgYSBkZWZhdWx0IGluc3RhbmNlCiAgICAgIHZhciBpbnN0YW5jZSA9IHRoaXMuYnVpbGRJbnN0YW5jZSgpOyAvLyBMZWdhY3kgc3VwcG9ydCBmb3IgQXBwLl9fY29udGFpbmVyX18gYW5kIG90aGVyIGdsb2JhbCBtZXRob2RzCiAgICAgIC8vIG9uIEFwcCB0aGF0IHJlbHkgb24gYSBzaW5nbGUsIGRlZmF1bHQgaW5zdGFuY2UuCgogICAgICB0aGlzLl9fZGVwcmVjYXRlZEluc3RhbmNlX18gPSBpbnN0YW5jZTsKICAgICAgdGhpcy5fX2NvbnRhaW5lcl9fID0gaW5zdGFuY2UuX19jb250YWluZXJfXzsKICAgIH0sCgogICAgLyoqCiAgICAgIEF1dG9tYXRpY2FsbHkga2ljay1vZmYgdGhlIGJvb3QgcHJvY2VzcyBmb3IgdGhlIGFwcGxpY2F0aW9uIG9uY2UgdGhlCiAgICAgIERPTSBoYXMgYmVjb21lIHJlYWR5LgogICAgICAgVGhlIGluaXRpYWxpemF0aW9uIGl0c2VsZiBpcyBzY2hlZHVsZWQgb24gdGhlIGFjdGlvbnMgcXVldWUgd2hpY2gKICAgICAgZW5zdXJlcyB0aGF0IGNvZGUtbG9hZGluZyBmaW5pc2hlcyBiZWZvcmUgYm9vdGluZy4KICAgICAgIElmIHlvdSBhcmUgYXN5bmNocm9ub3VzbHkgbG9hZGluZyBjb2RlLCB5b3Ugc2hvdWxkIGNhbGwgYGRlZmVyUmVhZGluZXNzKClgCiAgICAgIHRvIGRlZmVyIGJvb3RpbmcsIGFuZCB0aGVuIGNhbGwgYGFkdmFuY2VSZWFkaW5lc3MoKWAgb25jZSBhbGwgb2YgeW91ciBjb2RlCiAgICAgIGhhcyBmaW5pc2hlZCBsb2FkaW5nLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCB3YWl0Rm9yRE9NUmVhZHkKICAgICovCiAgICB3YWl0Rm9yRE9NUmVhZHk6IGZ1bmN0aW9uIHdhaXRGb3JET01SZWFkeSgpIHsKICAgICAgaWYgKCF0aGlzLiQgfHwgdGhpcy4kLmlzUmVhZHkpIHsKICAgICAgICAoMCwgX3J1bmxvb3Auc2NoZWR1bGUpKCdhY3Rpb25zJywgdGhpcywgJ2RvbVJlYWR5Jyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy4kKCkucmVhZHkoKDAsIF9ydW5sb29wLmJpbmQpKHRoaXMsICdkb21SZWFkeScpKTsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAgVGhpcyBpcyB0aGUgYXV0b2Jvb3QgZmxvdzoKICAgICAgIDEuIEJvb3QgdGhlIGFwcCBieSBjYWxsaW5nIGB0aGlzLmJvb3QoKWAKICAgICAgMi4gQ3JlYXRlIGFuIGluc3RhbmNlIChvciB1c2UgdGhlIGBfX2RlcHJlY2F0ZWRJbnN0YW5jZV9fYCBpbiBnbG9iYWxzIG1vZGUpCiAgICAgIDMuIEJvb3QgdGhlIGluc3RhbmNlIGJ5IGNhbGxpbmcgYGluc3RhbmNlLmJvb3QoKWAKICAgICAgNC4gSW52b2tlIHRoZSBgQXBwLnJlYWR5KClgIGNhbGxiYWNrCiAgICAgIDUuIEtpY2stb2ZmIHJvdXRpbmcgb24gdGhlIGluc3RhbmNlCiAgICAgICBJZGVhbGx5LCB0aGlzIGlzIGFsbCB3ZSB3b3VsZCBuZWVkIHRvIGRvOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBfYXV0b0Jvb3QoKSB7CiAgICAgICAgdGhpcy5ib290KCkudGhlbigoKSA9PiB7CiAgICAgICAgICBsZXQgaW5zdGFuY2UgPSAodGhpcy5fZ2xvYmFsc01vZGUpID8gdGhpcy5fX2RlcHJlY2F0ZWRJbnN0YW5jZV9fIDogdGhpcy5idWlsZEluc3RhbmNlKCk7CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2UuYm9vdCgpOwogICAgICAgIH0pLnRoZW4oKGluc3RhbmNlKSA9PiB7CiAgICAgICAgICBBcHAucmVhZHkoKTsKICAgICAgICAgIGluc3RhbmNlLnN0YXJ0Um91dGluZygpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGBgYAogICAgICAgVW5mb3J0dW5hdGVseSwgd2UgY2Fubm90IGFjdHVhbGx5IHdyaXRlIHRoaXMgYmVjYXVzZSB3ZSBuZWVkIHRvIHBhcnRpY2lwYXRlCiAgICAgIGluIHRoZSAic3luY2hyb25vdXMiIGJvb3QgcHJvY2Vzcy4gV2hpbGUgdGhlIGNvZGUgYWJvdmUgd291bGQgd29yayBmaW5lIG9uCiAgICAgIHRoZSBpbml0aWFsIGJvb3QgKGkuZS4gRE9NIHJlYWR5KSwgd2hlbiBgQXBwLnJlc2V0KClgIGlzIGNhbGxlZCwgd2UgbmVlZCB0bwogICAgICBib290IGEgbmV3IGluc3RhbmNlIHN5bmNocm9ub3VzbHkgKHNlZSB0aGUgZG9jdW1lbnRhdGlvbiBvbiBgX2Jvb3RTeW5jKClgCiAgICAgIGZvciBkZXRhaWxzKS4KICAgICAgIEJlY2F1c2Ugb2YgdGhpcyByZXN0cmljdGlvbiwgdGhlIGFjdHVhbCBsb2dpYyBvZiB0aGlzIG1ldGhvZCBpcyBsb2NhdGVkCiAgICAgIGluc2lkZSBgZGlkQmVjb21lUmVhZHkoKWAuCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIGRvbVJlYWR5CiAgICAqLwogICAgZG9tUmVhZHk6IGZ1bmN0aW9uIGRvbVJlYWR5KCkgewogICAgICBpZiAodGhpcy5pc0Rlc3Ryb3llZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5fYm9vdFN5bmMoKTsgLy8gQ29udGludWVzIHRvIGBkaWRCZWNvbWVSZWFkeWAKCiAgICB9LAoKICAgIC8qKgogICAgICBVc2UgdGhpcyB0byBkZWZlciByZWFkaW5lc3MgdW50aWwgc29tZSBjb25kaXRpb24gaXMgdHJ1ZS4KICAgICAgIEV4YW1wbGU6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBBcHBsaWNhdGlvbiBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogICAgICAgbGV0IEFwcCA9IEFwcGxpY2F0aW9uLmNyZWF0ZSgpOwogICAgICAgQXBwLmRlZmVyUmVhZGluZXNzKCk7CiAgICAgICAvLyAkIGlzIGEgcmVmZXJlbmNlIHRvIHRoZSBqUXVlcnkgb2JqZWN0L2Z1bmN0aW9uCiAgICAgIGltcG9ydCAkIGZyb20gJ2pxdWVyeTsKICAgICAgICQuZ2V0SlNPTignL2F1dGgtdG9rZW4nLCBmdW5jdGlvbih0b2tlbikgewogICAgICAgIEFwcC50b2tlbiA9IHRva2VuOwogICAgICAgIEFwcC5hZHZhbmNlUmVhZGluZXNzKCk7CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFRoaXMgYWxsb3dzIHlvdSB0byBwZXJmb3JtIGFzeW5jaHJvbm91cyBzZXR1cCBsb2dpYyBhbmQgZGVmZXIKICAgICAgYm9vdGluZyB5b3VyIGFwcGxpY2F0aW9uIHVudGlsIHRoZSBzZXR1cCBoYXMgZmluaXNoZWQuCiAgICAgICBIb3dldmVyLCBpZiB0aGUgc2V0dXAgcmVxdWlyZXMgYSBsb2FkaW5nIFVJLCBpdCBtaWdodCBiZSBiZXR0ZXIKICAgICAgdG8gdXNlIHRoZSByb3V0ZXIgZm9yIHRoaXMgcHVycG9zZS4KICAgICAgIEBtZXRob2QgZGVmZXJSZWFkaW5lc3MKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGRlZmVyUmVhZGluZXNzOiBmdW5jdGlvbiBkZWZlclJlYWRpbmVzcygpIHsKICAgICAgKGZhbHNlICYmICEodGhpcyBpbnN0YW5jZW9mIEFwcGxpY2F0aW9uKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBtdXN0IGNhbGwgZGVmZXJSZWFkaW5lc3Mgb24gYW4gaW5zdGFuY2Ugb2YgQXBwbGljYXRpb24nLCB0aGlzIGluc3RhbmNlb2YgQXBwbGljYXRpb24pKTsKICAgICAgKGZhbHNlICYmICEodGhpcy5fcmVhZGluZXNzRGVmZXJyYWxzID4gMCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgY2Fubm90IGRlZmVyIHJlYWRpbmVzcyBzaW5jZSB0aGUgYHJlYWR5KClgIGhvb2sgaGFzIGFscmVhZHkgYmVlbiBjYWxsZWQuJywgdGhpcy5fcmVhZGluZXNzRGVmZXJyYWxzID4gMCkpOwogICAgICB0aGlzLl9yZWFkaW5lc3NEZWZlcnJhbHMrKzsKICAgIH0sCgogICAgLyoqCiAgICAgIENhbGwgYGFkdmFuY2VSZWFkaW5lc3NgIGFmdGVyIGFueSBhc3luY2hyb25vdXMgc2V0dXAgbG9naWMgaGFzIGNvbXBsZXRlZC4KICAgICAgRWFjaCBjYWxsIHRvIGBkZWZlclJlYWRpbmVzc2AgbXVzdCBiZSBtYXRjaGVkIGJ5IGEgY2FsbCB0byBgYWR2YW5jZVJlYWRpbmVzc2AKICAgICAgb3IgdGhlIGFwcGxpY2F0aW9uIHdpbGwgbmV2ZXIgYmVjb21lIHJlYWR5IGFuZCByb3V0aW5nIHdpbGwgbm90IGJlZ2luLgogICAgICAgQG1ldGhvZCBhZHZhbmNlUmVhZGluZXNzCiAgICAgIEBzZWUge0FwcGxpY2F0aW9uI2RlZmVyUmVhZGluZXNzfQogICAgICBAcHVibGljCiAgICAqLwogICAgYWR2YW5jZVJlYWRpbmVzczogZnVuY3Rpb24gYWR2YW5jZVJlYWRpbmVzcygpIHsKICAgICAgKGZhbHNlICYmICEodGhpcyBpbnN0YW5jZW9mIEFwcGxpY2F0aW9uKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBtdXN0IGNhbGwgYWR2YW5jZVJlYWRpbmVzcyBvbiBhbiBpbnN0YW5jZSBvZiBBcHBsaWNhdGlvbicsIHRoaXMgaW5zdGFuY2VvZiBBcHBsaWNhdGlvbikpOwogICAgICB0aGlzLl9yZWFkaW5lc3NEZWZlcnJhbHMtLTsKCiAgICAgIGlmICh0aGlzLl9yZWFkaW5lc3NEZWZlcnJhbHMgPT09IDApIHsKICAgICAgICAoMCwgX3J1bmxvb3Aub25jZSkodGhpcywgdGhpcy5kaWRCZWNvbWVSZWFkeSk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgIEluaXRpYWxpemUgdGhlIGFwcGxpY2F0aW9uIGFuZCByZXR1cm4gYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgd2l0aCB0aGUgYEFwcGxpY2F0aW9uYAogICAgICBvYmplY3Qgd2hlbiB0aGUgYm9vdCBwcm9jZXNzIGlzIGNvbXBsZXRlLgogICAgICAgUnVuIGFueSBhcHBsaWNhdGlvbiBpbml0aWFsaXplcnMgYW5kIHJ1biB0aGUgYXBwbGljYXRpb24gbG9hZCBob29rLiBUaGVzZSBob29rcyBtYXkKICAgICAgY2hvb3NlIHRvIGRlZmVyIHJlYWRpbmVzcy4gRm9yIGV4YW1wbGUsIGFuIGF1dGhlbnRpY2F0aW9uIGhvb2sgbWlnaHQgd2FudCB0byBkZWZlcgogICAgICByZWFkaW5lc3MgdW50aWwgdGhlIGF1dGggdG9rZW4gaGFzIGJlZW4gcmV0cmlldmVkLgogICAgICAgQnkgZGVmYXVsdCwgdGhpcyBtZXRob2QgaXMgY2FsbGVkIGF1dG9tYXRpY2FsbHkgb24gIkRPTSByZWFkeSI7IGhvd2V2ZXIsIGlmIGF1dG9ib290CiAgICAgIGlzIGRpc2FibGVkLCB0aGlzIGlzIGF1dG9tYXRpY2FsbHkgY2FsbGVkIHdoZW4gdGhlIGZpcnN0IGFwcGxpY2F0aW9uIGluc3RhbmNlIGlzCiAgICAgIGNyZWF0ZWQgdmlhIGB2aXNpdGAuCiAgICAgICBAcHVibGljCiAgICAgIEBtZXRob2QgYm9vdAogICAgICBAcmV0dXJuIHtQcm9taXNlPEFwcGxpY2F0aW9uLEVycm9yPn0KICAgICovCiAgICBib290OiBmdW5jdGlvbiBib290KCkgewogICAgICBpZiAodGhpcy5fYm9vdFByb21pc2UpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYm9vdFByb21pc2U7CiAgICAgIH0KCiAgICAgIHRyeSB7CiAgICAgICAgdGhpcy5fYm9vdFN5bmMoKTsKICAgICAgfSBjYXRjaCAoXykgey8vIElnbm9yZSB0aGUgZXJyb3I6IGluIHRoZSBhc3luY2hyb25vdXMgYm9vdCBwYXRoLCB0aGUgZXJyb3IgaXMgYWxyZWFkeSByZWZsZWN0ZWQKICAgICAgICAvLyBpbiB0aGUgcHJvbWlzZSByZWplY3Rpb24KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuX2Jvb3RQcm9taXNlOwogICAgfSwKCiAgICAvKioKICAgICAgVW5mb3J0dW5hdGVseSwgYSBsb3Qgb2YgZXhpc3RpbmcgY29kZSBhc3N1bWVzIHRoZSBib290aW5nIHByb2Nlc3MgaXMKICAgICAgInN5bmNocm9ub3VzIi4gU3BlY2lmaWNhbGx5LCBhIGxvdCBvZiB0ZXN0cyBhc3N1bWVzIHRoZSBsYXN0IGNhbGwgdG8KICAgICAgYGFwcC5hZHZhbmNlUmVhZGluZXNzKClgIG9yIGBhcHAucmVzZXQoKWAgd2lsbCByZXN1bHQgaW4gdGhlIGFwcCBiZWluZwogICAgICBmdWxseS1ib290ZWQgd2hlbiB0aGUgY3VycmVudCBydW5sb29wIGNvbXBsZXRlcy4KICAgICAgIFdlIHdvdWxkIGxpa2UgbmV3IGNvZGUgKGxpa2UgdGhlIGB2aXNpdGAgQVBJKSB0byBzdG9wIG1ha2luZyB0aGlzIGFzc3VtcHRpb24sCiAgICAgIHNvIHdlIGNyZWF0ZWQgdGhlIGFzeW5jaHJvbm91cyB2ZXJzaW9uIGFib3ZlIHRoYXQgcmV0dXJucyBhIHByb21pc2UuIEJ1dCB1bnRpbAogICAgICB3ZSBoYXZlIG1pZ3JhdGVkIGFsbCB0aGUgY29kZSwgd2Ugd291bGQgaGF2ZSB0byBleHBvc2UgdGhpcyBtZXRob2QgZm9yIHVzZQogICAgICAqaW50ZXJuYWxseSogaW4gcGxhY2VzIHdoZXJlIHdlIG5lZWQgdG8gYm9vdCBhbiBhcHAgInN5bmNocm9ub3VzbHkiLgogICAgICAgQHByaXZhdGUKICAgICovCiAgICBfYm9vdFN5bmM6IGZ1bmN0aW9uIF9ib290U3luYygpIHsKICAgICAgaWYgKHRoaXMuX2Jvb3RlZCkgewogICAgICAgIHJldHVybjsKICAgICAgfSAvLyBFdmVuIHRob3VnaCB0aGlzIHJldHVybnMgc3luY2hyb25vdXNseSwgd2Ugc3RpbGwgbmVlZCB0byBtYWtlIHN1cmUgdGhlCiAgICAgIC8vIGJvb3QgcHJvbWlzZSBleGlzdHMgZm9yIGJvb2sta2VlcGluZyBwdXJwb3NlczogaWYgYW55dGhpbmcgd2VudCB3cm9uZyBpbgogICAgICAvLyB0aGUgYm9vdCBwcm9jZXNzLCB3ZSBuZWVkIHRvIHN0b3JlIHRoZSBlcnJvciBhcyBhIHJlamVjdGlvbiBvbiB0aGUgYm9vdAogICAgICAvLyBwcm9taXNlIHNvIHRoYXQgYSBmdXR1cmUgY2FsbGVyIG9mIGBib290KClgIGNhbiB0ZWxsIHdoYXQgZmFpbGVkLgoKCiAgICAgIHZhciBkZWZlciA9IHRoaXMuX2Jvb3RSZXNvbHZlciA9IF9ydW50aW1lLlJTVlAuZGVmZXIoKTsKCiAgICAgIHRoaXMuX2Jvb3RQcm9taXNlID0gZGVmZXIucHJvbWlzZTsKCiAgICAgIHRyeSB7CiAgICAgICAgdGhpcy5ydW5Jbml0aWFsaXplcnMoKTsKICAgICAgICAoMCwgX2xhenlfbG9hZC5ydW5Mb2FkSG9va3MpKCdhcHBsaWNhdGlvbicsIHRoaXMpOwogICAgICAgIHRoaXMuYWR2YW5jZVJlYWRpbmVzcygpOyAvLyBDb250aW51ZXMgdG8gYGRpZEJlY29tZVJlYWR5YAogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIC8vIEZvciB0aGUgYXN5bmNocm9ub3VzIGJvb3QgcGF0aAogICAgICAgIGRlZmVyLnJlamVjdChlcnJvcik7IC8vIEZvciB0aGUgc3luY2hyb25vdXMgYm9vdCBwYXRoCgogICAgICAgIHRocm93IGVycm9yOwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBSZXNldCB0aGUgYXBwbGljYXRpb24uIFRoaXMgaXMgdHlwaWNhbGx5IHVzZWQgb25seSBpbiB0ZXN0cy4gSXQgY2xlYW5zIHVwCiAgICAgIHRoZSBhcHBsaWNhdGlvbiBpbiB0aGUgZm9sbG93aW5nIG9yZGVyOgogICAgICAgMS4gRGVhY3RpdmF0ZSBleGlzdGluZyByb3V0ZXMKICAgICAgMi4gRGVzdHJveSBhbGwgb2JqZWN0cyBpbiB0aGUgY29udGFpbmVyCiAgICAgIDMuIENyZWF0ZSBhIG5ldyBhcHBsaWNhdGlvbiBjb250YWluZXIKICAgICAgNC4gUmUtcm91dGUgdG8gdGhlIGV4aXN0aW5nIHVybAogICAgICAgVHlwaWNhbCBFeGFtcGxlOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAgICAgbGV0IEFwcDsKICAgICAgIHJ1bihmdW5jdGlvbigpIHsKICAgICAgICBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoKTsKICAgICAgfSk7CiAgICAgICBtb2R1bGUoJ2FjY2VwdGFuY2UgdGVzdCcsIHsKICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgICAgICBBcHAucmVzZXQoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAgdGVzdCgnZmlyc3QgdGVzdCcsIGZ1bmN0aW9uKCkgewogICAgICAgIC8vIEFwcCBpcyBmcmVzaGx5IHJlc2V0CiAgICAgIH0pOwogICAgICAgdGVzdCgnc2Vjb25kIHRlc3QnLCBmdW5jdGlvbigpIHsKICAgICAgICAvLyBBcHAgaXMgYWdhaW4gZnJlc2hseSByZXNldAogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBBZHZhbmNlZCBFeGFtcGxlOgogICAgICAgT2NjYXNpb25hbGx5IHlvdSBtYXkgd2FudCB0byBwcmV2ZW50IHRoZSBhcHAgZnJvbSBpbml0aWFsaXppbmcgZHVyaW5nCiAgICAgIHNldHVwLiBUaGlzIGNvdWxkIGVuYWJsZSBleHRyYSBjb25maWd1cmF0aW9uLCBvciBlbmFibGUgYXNzZXJ0aW5nIHByaW9yCiAgICAgIHRvIHRoZSBhcHAgYmVjb21pbmcgcmVhZHkuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBBcHBsaWNhdGlvbiBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogICAgICBsZXQgQXBwOwogICAgICAgcnVuKGZ1bmN0aW9uKCkgewogICAgICAgIEFwcCA9IEFwcGxpY2F0aW9uLmNyZWF0ZSgpOwogICAgICB9KTsKICAgICAgIG1vZHVsZSgnYWNjZXB0YW5jZSB0ZXN0JywgewogICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJ1bihmdW5jdGlvbigpIHsKICAgICAgICAgICAgQXBwLnJlc2V0KCk7CiAgICAgICAgICAgIEFwcC5kZWZlclJlYWRpbmVzcygpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgIHRlc3QoJ2ZpcnN0IHRlc3QnLCBmdW5jdGlvbigpIHsKICAgICAgICBvayh0cnVlLCAnc29tZXRoaW5nIGJlZm9yZSBhcHAgaXMgaW5pdGlhbGl6ZWQnKTsKICAgICAgICAgcnVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgQXBwLmFkdmFuY2VSZWFkaW5lc3MoKTsKICAgICAgICB9KTsKICAgICAgICAgb2sodHJ1ZSwgJ3NvbWV0aGluZyBhZnRlciBhcHAgaXMgaW5pdGlhbGl6ZWQnKTsKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCByZXNldAogICAgICBAcHVibGljCiAgICAqLwogICAgcmVzZXQ6IGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICAoZmFsc2UgJiYgISh0aGlzLl9nbG9iYWxzTW9kZSAmJiB0aGlzLmF1dG9ib290KSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkNhbGxpbmcgcmVzZXQoKSBvbiBpbnN0YW5jZXMgb2YgYEFwcGxpY2F0aW9uYCBpcyBub3RcbiAgICAgICAgICAgIHN1cHBvcnRlZCB3aGVuIGdsb2JhbHMgbW9kZSBpcyBkaXNhYmxlZDsgY2FsbCBgdmlzaXQoKWAgdG9cbiAgICAgICAgICAgIGNyZWF0ZSBuZXcgYEFwcGxpY2F0aW9uSW5zdGFuY2VgcyBhbmQgZGlzcG9zZSB0aGVtXG4gICAgICAgICAgICB2aWEgdGhlaXIgYGRlc3Ryb3koKWAgbWV0aG9kIGluc3RlYWQuIiwgdGhpcy5fZ2xvYmFsc01vZGUgJiYgdGhpcy5hdXRvYm9vdCkpOwogICAgICB2YXIgaW5zdGFuY2UgPSB0aGlzLl9fZGVwcmVjYXRlZEluc3RhbmNlX187CiAgICAgIHRoaXMuX3JlYWRpbmVzc0RlZmVycmFscyA9IDE7CiAgICAgIHRoaXMuX2Jvb3RQcm9taXNlID0gbnVsbDsKICAgICAgdGhpcy5fYm9vdFJlc29sdmVyID0gbnVsbDsKICAgICAgdGhpcy5fYm9vdGVkID0gZmFsc2U7CgogICAgICBmdW5jdGlvbiBoYW5kbGVSZXNldCgpIHsKICAgICAgICAoMCwgX3J1bmxvb3AucnVuKShpbnN0YW5jZSwgJ2Rlc3Ryb3knKTsKCiAgICAgICAgdGhpcy5fYnVpbGREZXByZWNhdGVkSW5zdGFuY2UoKTsKCiAgICAgICAgKDAsIF9ydW5sb29wLnNjaGVkdWxlKSgnYWN0aW9ucycsIHRoaXMsICdfYm9vdFN5bmMnKTsKICAgICAgfQoKICAgICAgKDAsIF9ydW5sb29wLmpvaW4pKHRoaXMsIGhhbmRsZVJlc2V0KTsKICAgIH0sCgogICAgLyoqCiAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgZGlkQmVjb21lUmVhZHkKICAgICovCiAgICBkaWRCZWNvbWVSZWFkeTogZnVuY3Rpb24gZGlkQmVjb21lUmVhZHkoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgLy8gVE9ETzogSXMgdGhpcyBzdGlsbCBuZWVkZWQgZm9yIF9nbG9iYWxzTW9kZSA9IGZhbHNlPwogICAgICAgIGlmICghKDAsIF9kZWJ1Zy5pc1Rlc3RpbmcpKCkpIHsKICAgICAgICAgIC8vIEVhZ2VybHkgbmFtZSBhbGwgY2xhc3NlcyB0aGF0IGFyZSBhbHJlYWR5IGxvYWRlZAogICAgICAgICAgKDAsIF9tZXRhbC5wcm9jZXNzQWxsTmFtZXNwYWNlcykoKTsKICAgICAgICAgICgwLCBfbWV0YWwuc2V0TmFtZXNwYWNlU2VhcmNoRGlzYWJsZWQpKHRydWUpOwogICAgICAgIH0gLy8gU2VlIGRvY3VtZW50YXRpb24gb24gYF9hdXRvYm9vdCgpYCBmb3IgZGV0YWlscwoKCiAgICAgICAgaWYgKHRoaXMuYXV0b2Jvb3QpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZTsKCiAgICAgICAgICBpZiAodGhpcy5fZ2xvYmFsc01vZGUpIHsKICAgICAgICAgICAgLy8gSWYgd2UgYWxyZWFkeSBoYXZlIHRoZSBfX2RlcHJlY2F0ZWRJbnN0YW5jZV9fIGx5aW5nIGFyb3VuZCwgYm9vdCBpdCB0bwogICAgICAgICAgICAvLyBhdm9pZCB1bm5lY2Vzc2FyeSB3b3JrCiAgICAgICAgICAgIGluc3RhbmNlID0gdGhpcy5fX2RlcHJlY2F0ZWRJbnN0YW5jZV9fOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCBidWlsZCBhbiBpbnN0YW5jZSBhbmQgYm9vdCBpdC4gVGhpcyBpcyBjdXJyZW50bHkgdW5yZWFjaGFibGUsCiAgICAgICAgICAgIC8vIGJlY2F1c2Ugd2UgZm9yY2VkIF9nbG9iYWxzTW9kZSB0byA9PT0gYXV0b2Jvb3Q7IGJ1dCBoYXZpbmcgdGhpcyBicmFuY2gKICAgICAgICAgICAgLy8gYWxsb3dzIHVzIHRvIGxvY2FsbHkgdG9nZ2xlIHRoYXQgZmxhZyBmb3Igd2VlZGluZyBvdXQgbGVnYWN5IGdsb2JhbHMgbW9kZQogICAgICAgICAgICAvLyBkZXBlbmRlbmNpZXMgaW5kZXBlbmRlbnRseQogICAgICAgICAgICBpbnN0YW5jZSA9IHRoaXMuYnVpbGRJbnN0YW5jZSgpOwogICAgICAgICAgfQoKICAgICAgICAgIGluc3RhbmNlLl9ib290U3luYygpOyAvLyBUT0RPOiBBcHAucmVhZHkoKSBpcyBub3QgY2FsbGVkIHdoZW4gYXV0b2Jvb3QgaXMgZGlzYWJsZWQsIGlzIHRoaXMgY29ycmVjdD8KCgogICAgICAgICAgdGhpcy5yZWFkeSgpOwogICAgICAgICAgaW5zdGFuY2Uuc3RhcnRSb3V0aW5nKCk7CiAgICAgICAgfSAvLyBGb3IgdGhlIGFzeW5jaHJvbm91cyBib290IHBhdGgKCgogICAgICAgIHRoaXMuX2Jvb3RSZXNvbHZlci5yZXNvbHZlKHRoaXMpOyAvLyBGb3IgdGhlIHN5bmNocm9ub3VzIGJvb3QgcGF0aAoKCiAgICAgICAgdGhpcy5fYm9vdGVkID0gdHJ1ZTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAvLyBGb3IgdGhlIGFzeW5jaHJvbm91cyBib290IHBhdGgKICAgICAgICB0aGlzLl9ib290UmVzb2x2ZXIucmVqZWN0KGVycm9yKTsgLy8gRm9yIHRoZSBzeW5jaHJvbm91cyBib290IHBhdGgKCgogICAgICAgIHRocm93IGVycm9yOwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBDYWxsZWQgd2hlbiB0aGUgQXBwbGljYXRpb24gaGFzIGJlY29tZSByZWFkeSwgaW1tZWRpYXRlbHkgYmVmb3JlIHJvdXRpbmcKICAgICAgYmVnaW5zLiBUaGUgY2FsbCB3aWxsIGJlIGRlbGF5ZWQgdW50aWwgdGhlIERPTSBoYXMgYmVjb21lIHJlYWR5LgogICAgICAgQGV2ZW50IHJlYWR5CiAgICAgIEBwdWJsaWMKICAgICovCiAgICByZWFkeTogZnVuY3Rpb24gcmVhZHkoKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFRoaXMgbWV0aG9kIG11c3QgYmUgbW92ZWQgdG8gdGhlIGFwcGxpY2F0aW9uIGluc3RhbmNlIG9iamVjdAogICAgd2lsbERlc3Ryb3k6IGZ1bmN0aW9uIHdpbGxEZXN0cm95KCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgKDAsIF9tZXRhbC5zZXROYW1lc3BhY2VTZWFyY2hEaXNhYmxlZCkoZmFsc2UpOwogICAgICB0aGlzLl9ib290ZWQgPSBmYWxzZTsKICAgICAgdGhpcy5fYm9vdFByb21pc2UgPSBudWxsOwogICAgICB0aGlzLl9ib290UmVzb2x2ZXIgPSBudWxsOwoKICAgICAgaWYgKF9sYXp5X2xvYWQuX2xvYWRlZC5hcHBsaWNhdGlvbiA9PT0gdGhpcykgewogICAgICAgIF9sYXp5X2xvYWQuX2xvYWRlZC5hcHBsaWNhdGlvbiA9IHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX2FwcGxpY2F0aW9uSW5zdGFuY2VzLnNpemUpIHsKICAgICAgICB0aGlzLl9hcHBsaWNhdGlvbkluc3RhbmNlcy5mb3JFYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICByZXR1cm4gaS5kZXN0cm95KCk7CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuX2FwcGxpY2F0aW9uSW5zdGFuY2VzLmNsZWFyKCk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgIEJvb3QgYSBuZXcgaW5zdGFuY2Ugb2YgYEFwcGxpY2F0aW9uSW5zdGFuY2VgIGZvciB0aGUgY3VycmVudAogICAgICBhcHBsaWNhdGlvbiBhbmQgbmF2aWdhdGUgaXQgdG8gdGhlIGdpdmVuIGB1cmxgLiBSZXR1cm5zIGEgYFByb21pc2VgIHRoYXQKICAgICAgcmVzb2x2ZXMgd2l0aCB0aGUgaW5zdGFuY2Ugd2hlbiB0aGUgaW5pdGlhbCByb3V0aW5nIGFuZCByZW5kZXJpbmcgaXMKICAgICAgY29tcGxldGUsIG9yIHJlamVjdHMgd2l0aCBhbnkgZXJyb3IgdGhhdCBvY2N1cnJlZCBkdXJpbmcgdGhlIGJvb3QgcHJvY2Vzcy4KICAgICAgIFdoZW4gYGF1dG9ib290YCBpcyBkaXNhYmxlZCwgY2FsbGluZyBgdmlzaXRgIHdvdWxkIGZpcnN0IGNhdXNlIHRoZQogICAgICBhcHBsaWNhdGlvbiB0byBib290LCB3aGljaCBydW5zIHRoZSBhcHBsaWNhdGlvbiBpbml0aWFsaXplcnMuCiAgICAgICBUaGlzIG1ldGhvZCBhbHNvIHRha2VzIGEgaGFzaCBvZiBib290LXRpbWUgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvcgogICAgICBjdXN0b21pemluZyB0aGUgaW5zdGFuY2UncyBiZWhhdmlvci4gU2VlIHRoZSBkb2N1bWVudGF0aW9uIG9uCiAgICAgIGBBcHBsaWNhdGlvbkluc3RhbmNlLkJvb3RPcHRpb25zYCBmb3IgZGV0YWlscy4KICAgICAgIGBBcHBsaWNhdGlvbkluc3RhbmNlLkJvb3RPcHRpb25zYCBpcyBhbiBpbnRlcmZhY2UgY2xhc3MgdGhhdCBleGlzdHMKICAgICAgcHVyZWx5IHRvIGRvY3VtZW50IHRoZSBhdmFpbGFibGUgb3B0aW9uczsgeW91IGRvIG5vdCBuZWVkIHRvIGNvbnN0cnVjdCBpdAogICAgICBtYW51YWxseS4gU2ltcGx5IHBhc3MgYSByZWd1bGFyIEphdmFTY3JpcHQgb2JqZWN0IGNvbnRhaW5pbmcgb2YgdGhlCiAgICAgIGRlc2lyZWQgb3B0aW9uczoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgTXlBcHAudmlzaXQoIi8iLCB7IGxvY2F0aW9uOiAibm9uZSIsIHJvb3RFbGVtZW50OiAiI2NvbnRhaW5lciIgfSk7CiAgICAgIGBgYAogICAgICAgIyMjIFN1cHBvcnRlZCBTY2VuYXJpb3MKICAgICAgIFdoaWxlIHRoZSBgQm9vdE9wdGlvbnNgIGNsYXNzIGV4cG9zZXMgYSBsYXJnZSBudW1iZXIgb2Yga25vYnMsIG5vdCBhbGwKICAgICAgY29tYmluYXRpb25zIG9mIHRoZW0gYXJlIHZhbGlkOyBjZXJ0YWluIGluY29tcGF0aWJsZSBjb21iaW5hdGlvbnMgbWlnaHQKICAgICAgcmVzdWx0IGluIHVuZXhwZWN0ZWQgYmVoYXZpb3IuCiAgICAgICBGb3IgZXhhbXBsZSwgYm9vdGluZyB0aGUgaW5zdGFuY2UgaW4gdGhlIGZ1bGwgYnJvd3NlciBlbnZpcm9ubWVudAogICAgICB3aGlsZSBzcGVjaWZ5aW5nIGEgZm9yZWlnbiBgZG9jdW1lbnRgIG9iamVjdCAoZS5nLiBgeyBpc0Jyb3dzZXI6IHRydWUsCiAgICAgIGRvY3VtZW50OiBpZnJhbWUuY29udGVudERvY3VtZW50IH1gKSBkb2VzIG5vdCB3b3JrIGNvcnJlY3RseSB0b2RheSwKICAgICAgbGFyZ2VseSBkdWUgdG8gRW1iZXIncyBqUXVlcnkgZGVwZW5kZW5jeS4KICAgICAgIEN1cnJlbnRseSwgdGhlcmUgYXJlIHRocmVlIG9mZmljaWFsbHkgc3VwcG9ydGVkIHNjZW5hcmlvcy9jb25maWd1cmF0aW9ucy4KICAgICAgVXNhZ2VzIG91dHNpZGUgb2YgdGhlc2Ugc2NlbmFyaW9zIGFyZSBub3QgZ3VhcmFudGVlZCB0byB3b3JrLCBidXQgcGxlYXNlCiAgICAgIGZlZWwgZnJlZSB0byBmaWxlIGJ1ZyByZXBvcnRzIGRvY3VtZW50aW5nIHlvdXIgZXhwZXJpZW5jZSBhbmQgYW55IGlzc3VlcwogICAgICB5b3UgZW5jb3VudGVyZWQgdG8gaGVscCBleHBhbmQgc3VwcG9ydC4KICAgICAgICMjIyMgQnJvd3NlciBBcHBsaWNhdGlvbnMgKE1hbnVhbCBCb290KQogICAgICAgVGhlIHNldHVwIGlzIGxhcmdlbHkgc2ltaWxhciB0byBob3cgRW1iZXIgd29ya3Mgb3V0LW9mLXRoZS1ib3guIE5vcm1hbGx5LAogICAgICBFbWJlciB3aWxsIGJvb3QgYSBkZWZhdWx0IGluc3RhbmNlIGZvciB5b3VyIEFwcGxpY2F0aW9uIG9uICJET00gcmVhZHkiLgogICAgICBIb3dldmVyLCB5b3UgY2FuIGN1c3RvbWl6ZSB0aGlzIGJlaGF2aW9yIGJ5IGRpc2FibGluZyBgYXV0b2Jvb3RgLgogICAgICAgRm9yIGV4YW1wbGUsIHRoaXMgYWxsb3dzIHlvdSB0byByZW5kZXIgYSBtaW5pdHVyZSBkZW1vIG9mIHlvdXIgYXBwbGljYXRpb24KICAgICAgaW50byBhIHNwZWNpZmljIGFyZWEgb24geW91ciBtYXJrZXRpbmcgd2Vic2l0ZToKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IE15QXBwIGZyb20gJ215LWFwcCc7CiAgICAgICAkKGZ1bmN0aW9uKCkgewogICAgICAgIGxldCBBcHAgPSBNeUFwcC5jcmVhdGUoeyBhdXRvYm9vdDogZmFsc2UgfSk7CiAgICAgICAgIGxldCBvcHRpb25zID0gewogICAgICAgICAgLy8gT3ZlcnJpZGUgdGhlIHJvdXRlcidzIGxvY2F0aW9uIGFkYXB0ZXIgdG8gcHJldmVudCBpdCBmcm9tIHVwZGF0aW5nCiAgICAgICAgICAvLyB0aGUgVVJMIGluIHRoZSBhZGRyZXNzIGJhcgogICAgICAgICAgbG9jYXRpb246ICdub25lJywKICAgICAgICAgICAvLyBPdmVycmlkZSB0aGUgZGVmYXVsdCBgcm9vdEVsZW1lbnRgIG9uIHRoZSBhcHAgdG8gcmVuZGVyIGludG8gYQogICAgICAgICAgLy8gc3BlY2lmaWMgYGRpdmAgb24gdGhlIHBhZ2UKICAgICAgICAgIHJvb3RFbGVtZW50OiAnI2RlbW8nCiAgICAgICAgfTsKICAgICAgICAgLy8gU3RhcnQgdGhlIGFwcCBhdCB0aGUgc3BlY2lhbCBkZW1vIFVSTAogICAgICAgIEFwcC52aXNpdCgnL2RlbW8nLCBvcHRpb25zKTsKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgT3IgcGVyaGFwcyB5b3UgbWlnaHQgd2FudCB0byBib290IHR3byBpbnN0YW5jZXMgb2YgeW91ciBhcHAgb24gdGhlIHNhbWUKICAgICAgcGFnZSBmb3IgYSBzcGxpdC1zY3JlZW4gbXVsdGlwbGF5ZXIgZXhwZXJpZW5jZToKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IE15QXBwIGZyb20gJ215LWFwcCc7CiAgICAgICAkKGZ1bmN0aW9uKCkgewogICAgICAgIGxldCBBcHAgPSBNeUFwcC5jcmVhdGUoeyBhdXRvYm9vdDogZmFsc2UgfSk7CiAgICAgICAgIGxldCBzZXNzaW9uSWQgPSBNeUFwcC5nZW5lcmF0ZVNlc3Npb25JRCgpOwogICAgICAgICBsZXQgcGxheWVyMSA9IEFwcC52aXNpdChgL21hdGNoZXMvam9pbj9uYW1lPVBsYXllcisxJnNlc3Npb249JHtzZXNzaW9uSWR9YCwgeyByb290RWxlbWVudDogJyNsZWZ0JywgbG9jYXRpb246ICdub25lJyB9KTsKICAgICAgICBsZXQgcGxheWVyMiA9IEFwcC52aXNpdChgL21hdGNoZXMvam9pbj9uYW1lPVBsYXllcisyJnNlc3Npb249JHtzZXNzaW9uSWR9YCwgeyByb290RWxlbWVudDogJyNyaWdodCcsIGxvY2F0aW9uOiAnbm9uZScgfSk7CiAgICAgICAgIFByb21pc2UuYWxsKFtwbGF5ZXIxLCBwbGF5ZXIyXSkudGhlbigoKSA9PiB7CiAgICAgICAgICAvLyBCb3RoIGFwcHMgaGF2ZSBjb21wbGV0ZWQgdGhlIGluaXRpYWwgcmVuZGVyCiAgICAgICAgICAkKCcjbG9hZGluZycpLmZhZGVPdXQoKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgRG8gbm90ZSB0aGF0IGVhY2ggYXBwIGluc3RhbmNlIG1haW50YWlucyB0aGVpciBvd24gcmVnaXN0cnkvY29udGFpbmVyLCBzbwogICAgICB0aGV5IHdpbGwgcnVuIGluIGNvbXBsZXRlIGlzb2xhdGlvbiBieSBkZWZhdWx0LgogICAgICAgIyMjIyBTZXJ2ZXItU2lkZSBSZW5kZXJpbmcgKGFsc28ga25vd24gYXMgRmFzdEJvb3QpCiAgICAgICBUaGlzIHNldHVwIGFsbG93cyB5b3UgdG8gcnVuIHlvdXIgRW1iZXIgYXBwIGluIGEgc2VydmVyIGVudmlyb25tZW50IHVzaW5nCiAgICAgIE5vZGUuanMgYW5kIHJlbmRlciBpdHMgY29udGVudCBpbnRvIHN0YXRpYyBIVE1MIGZvciBTRU8gcHVycG9zZXMuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGNvbnN0IEhUTUxTZXJpYWxpemVyID0gbmV3IFNpbXBsZURPTS5IVE1MU2VyaWFsaXplcihTaW1wbGVET00udm9pZE1hcCk7CiAgICAgICBmdW5jdGlvbiByZW5kZXJVUkwodXJsKSB7CiAgICAgICAgbGV0IGRvbSA9IG5ldyBTaW1wbGVET00uRG9jdW1lbnQoKTsKICAgICAgICBsZXQgcm9vdEVsZW1lbnQgPSBkb20uYm9keTsKICAgICAgICBsZXQgb3B0aW9ucyA9IHsgaXNCcm93c2VyOiBmYWxzZSwgZG9jdW1lbnQ6IGRvbSwgcm9vdEVsZW1lbnQ6IHJvb3RFbGVtZW50IH07CiAgICAgICAgIHJldHVybiBNeUFwcC52aXNpdChvcHRpb25zKS50aGVuKGluc3RhbmNlID0+IHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBIVE1MU2VyaWFsaXplci5zZXJpYWxpemUocm9vdEVsZW1lbnQuZmlyc3RDaGlsZCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBpbnN0YW5jZS5kZXN0cm95KCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgYGBgCiAgICAgICBJbiB0aGlzIHNjZW5hcmlvLCBiZWNhdXNlIEVtYmVyIGRvZXMgbm90IGhhdmUgYWNjZXNzIHRvIGEgZ2xvYmFsIGBkb2N1bWVudGAKICAgICAgb2JqZWN0IGluIHRoZSBOb2RlLmpzIGVudmlyb25tZW50LCB5b3UgbXVzdCBwcm92aWRlIG9uZSBleHBsaWNpdGx5LiBJbiBwcmFjdGljZSwKICAgICAgaW4gdGhlIG5vbi1icm93c2VyIGVudmlyb25tZW50LCB0aGUgc3RhbmQtaW4gYGRvY3VtZW50YCBvYmplY3Qgb25seSBuZWVkcyB0bwogICAgICBpbXBsZW1lbnQgYSBsaW1pdGVkIHN1YnNldCBvZiB0aGUgZnVsbCBET00gQVBJLiBUaGUgYFNpbXBsZURPTWAgbGlicmFyeSBpcyBrbm93bgogICAgICB0byB3b3JrLgogICAgICAgU2luY2UgdGhlcmUgaXMgbm8gYWNjZXNzIHRvIGpRdWVyeSBpbiB0aGUgbm9uLWJyb3dzZXIgZW52aXJvbm1lbnQsIHlvdSBtdXN0IGFsc28KICAgICAgc3BlY2lmeSBhIERPTSBgRWxlbWVudGAgb2JqZWN0IGluIHRoZSBzYW1lIGBkb2N1bWVudGAgZm9yIHRoZSBgcm9vdEVsZW1lbnRgIG9wdGlvbgogICAgICAoYXMgb3Bwb3NlZCB0byBhIHNlbGVjdG9yIHN0cmluZyBsaWtlIGAiYm9keSJgKS4KICAgICAgIFNlZSB0aGUgZG9jdW1lbnRhdGlvbiBvbiB0aGUgYGlzQnJvd3NlcmAsIGBkb2N1bWVudGAgYW5kIGByb290RWxlbWVudGAgcHJvcGVydGllcwogICAgICBvbiBgQXBwbGljYXRpb25JbnN0YW5jZS5Cb290T3B0aW9uc2AgZm9yIGRldGFpbHMuCiAgICAgICAjIyMjIFNlcnZlci1TaWRlIFJlc291cmNlIERpc2NvdmVyeQogICAgICAgVGhpcyBzZXR1cCBhbGxvd3MgeW91IHRvIHJ1biB0aGUgcm91dGluZyBsYXllciBvZiB5b3VyIEVtYmVyIGFwcCBpbiBhIHNlcnZlcgogICAgICBlbnZpcm9ubWVudCB1c2luZyBOb2RlLmpzIGFuZCBjb21wbGV0ZWx5IGRpc2FibGUgcmVuZGVyaW5nLiBUaGlzIGFsbG93cyB5b3UKICAgICAgdG8gc2ltdWxhdGUgYW5kIGRpc2NvdmVyIHRoZSByZXNvdXJjZXMgKGkuZS4gQUpBWCByZXF1ZXN0cykgbmVlZGVkIHRvIGZ1bGZpbGwKICAgICAgYSBnaXZlbiByZXF1ZXN0IGFuZCBlYWdlcmx5ICJwdXNoIiB0aGVzZSByZXNvdXJjZXMgdG8gdGhlIGNsaWVudC4KICAgICAgIGBgYGFwcC9pbml0aWFsaXplcnMvbmV0d29yay1zZXJ2aWNlLmpzCiAgICAgIGltcG9ydCBCcm93c2VyTmV0d29ya1NlcnZpY2UgZnJvbSAnYXBwL3NlcnZpY2VzL25ldHdvcmsvYnJvd3Nlcic7CiAgICAgIGltcG9ydCBOb2RlTmV0d29ya1NlcnZpY2UgZnJvbSAnYXBwL3NlcnZpY2VzL25ldHdvcmsvbm9kZSc7CiAgICAgICAvLyBJbmplY3QgYSAoaHlwb3RoZXRpY2FsKSBzZXJ2aWNlIGZvciBhYnN0cmFjdGluZyBhbGwgQUpBWCBjYWxscyBhbmQgdXNlCiAgICAgIC8vIHRoZSBhcHByb3ByaWF0ZSBpbXBsZW1lbnRhdGlvbiBvbiB0aGUgY2xpZW50L3NlcnZlci4gVGhpcyBhbHNvIGFsbG93cyB0aGUKICAgICAgLy8gc2VydmVyIHRvIGxvZyBhbGwgdGhlIEFKQVggY2FsbHMgbWFkZSBkdXJpbmcgYSBwYXJ0aWN1bGFyIHJlcXVlc3QgYW5kIHVzZQogICAgICAvLyB0aGF0IGZvciByZXNvdXJjZS1kaXNjb3ZlcnkgcHVycG9zZS4KICAgICAgIGV4cG9ydCBmdW5jdGlvbiBpbml0aWFsaXplKGFwcGxpY2F0aW9uKSB7CiAgICAgICAgaWYgKHdpbmRvdykgeyAvLyBicm93c2VyCiAgICAgICAgICBhcHBsaWNhdGlvbi5yZWdpc3Rlcignc2VydmljZTpuZXR3b3JrJywgQnJvd3Nlck5ldHdvcmtTZXJ2aWNlKTsKICAgICAgICB9IGVsc2UgeyAvLyBub2RlCiAgICAgICAgICBhcHBsaWNhdGlvbi5yZWdpc3Rlcignc2VydmljZTpuZXR3b3JrJywgTm9kZU5ldHdvcmtTZXJ2aWNlKTsKICAgICAgICB9CiAgICAgICAgIGFwcGxpY2F0aW9uLmluamVjdCgncm91dGUnLCAnbmV0d29yaycsICdzZXJ2aWNlOm5ldHdvcmsnKTsKICAgICAgfTsKICAgICAgIGV4cG9ydCBkZWZhdWx0IHsKICAgICAgICBuYW1lOiAnbmV0d29yay1zZXJ2aWNlJywKICAgICAgICBpbml0aWFsaXplOiBpbml0aWFsaXplCiAgICAgIH07CiAgICAgIGBgYAogICAgICAgYGBgYXBwL3JvdXRlcy9wb3N0LmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgICAvLyBBbiBleGFtcGxlIG9mIGhvdyB0aGUgKGh5cG90aGV0aWNhbCkgc2VydmljZSBpcyB1c2VkIGluIHJvdXRlcy4KICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgICAgbW9kZWwocGFyYW1zKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5uZXR3b3JrLmZldGNoKGAvYXBpL3Bvc3RzLyR7cGFyYW1zLnBvc3RfaWR9Lmpzb25gKTsKICAgICAgICB9LAogICAgICAgICBhZnRlck1vZGVsKHBvc3QpIHsKICAgICAgICAgIGlmIChwb3N0LmlzRXh0ZXJuYWxDb250ZW50KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm5ldHdvcmsuZmV0Y2goYC9hcGkvZXh0ZXJuYWwvP3VybD0ke3Bvc3QuZXh0ZXJuYWxVUkx9YCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gcG9zdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgLy8gRmluYWxseSwgcHV0IGFsbCB0aGUgcGllY2VzIHRvZ2V0aGVyCiAgICAgICBmdW5jdGlvbiBkaXNjb3ZlclJlc291cmNlc0Zvcih1cmwpIHsKICAgICAgICByZXR1cm4gTXlBcHAudmlzaXQodXJsLCB7IGlzQnJvd3NlcjogZmFsc2UsIHNob3VsZFJlbmRlcjogZmFsc2UgfSkudGhlbihpbnN0YW5jZSA9PiB7CiAgICAgICAgICBsZXQgbmV0d29ya1NlcnZpY2UgPSBpbnN0YW5jZS5sb29rdXAoJ3NlcnZpY2U6bmV0d29yaycpOwogICAgICAgICAgcmV0dXJuIG5ldHdvcmtTZXJ2aWNlLnJlcXVlc3RzOyAvLyA9PiB7ICIvYXBpL3Bvc3RzLzEyMy5qc29uIjogIi4uLiIgfQogICAgICAgIH0pOwogICAgICB9CiAgICAgIGBgYAogICAgICAgQHB1YmxpYwogICAgICBAbWV0aG9kIHZpc2l0CiAgICAgIEBwYXJhbSB1cmwge1N0cmluZ30gVGhlIGluaXRpYWwgVVJMIHRvIG5hdmlnYXRlIHRvCiAgICAgIEBwYXJhbSBvcHRpb25zIHtBcHBsaWNhdGlvbkluc3RhbmNlLkJvb3RPcHRpb25zfQogICAgICBAcmV0dXJuIHtQcm9taXNlPEFwcGxpY2F0aW9uSW5zdGFuY2UsIEVycm9yPn0KICAgICovCiAgICB2aXNpdDogZnVuY3Rpb24gdmlzaXQodXJsLCBvcHRpb25zKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gdGhpcy5ib290KCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGluc3RhbmNlID0gX3RoaXMuYnVpbGRJbnN0YW5jZSgpOwoKICAgICAgICByZXR1cm4gaW5zdGFuY2UuYm9vdChvcHRpb25zKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZS52aXNpdCh1cmwpOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgKDAsIF9ydW5sb29wLnJ1bikoaW5zdGFuY2UsICdkZXN0cm95Jyk7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSk7CgogIEFwcGxpY2F0aW9uLnJlb3BlbkNsYXNzKHsKICAgIC8qKgogICAgICBUaGlzIGNyZWF0ZXMgYSByZWdpc3RyeSB3aXRoIHRoZSBkZWZhdWx0IEVtYmVyIG5hbWluZyBjb252ZW50aW9ucy4KICAgICAgIEl0IGFsc28gY29uZmlndXJlcyB0aGUgcmVnaXN0cnk6CiAgICAgICAqIHJlZ2lzdGVyZWQgdmlld3MgYXJlIGNyZWF0ZWQgZXZlcnkgdGltZSB0aGV5IGFyZSBsb29rZWQgdXAgKHRoZXkgYXJlCiAgICAgICAgbm90IHNpbmdsZXRvbnMpCiAgICAgICogcmVnaXN0ZXJlZCB0ZW1wbGF0ZXMgYXJlIG5vdCBmYWN0b3JpZXM7IHRoZSByZWdpc3RlcmVkIHZhbHVlIGlzCiAgICAgICAgcmV0dXJuZWQgZGlyZWN0bHkuCiAgICAgICogdGhlIHJvdXRlciByZWNlaXZlcyB0aGUgYXBwbGljYXRpb24gYXMgaXRzIGBuYW1lc3BhY2VgIHByb3BlcnR5CiAgICAgICogYWxsIGNvbnRyb2xsZXJzIHJlY2VpdmUgdGhlIHJvdXRlciBhcyB0aGVpciBgdGFyZ2V0YCBhbmQgYGNvbnRyb2xsZXJzYAogICAgICAgIHByb3BlcnRpZXMKICAgICAgKiBhbGwgY29udHJvbGxlcnMgcmVjZWl2ZSB0aGUgYXBwbGljYXRpb24gYXMgdGhlaXIgYG5hbWVzcGFjZWAgcHJvcGVydHkKICAgICAgKiB0aGUgYXBwbGljYXRpb24gdmlldyByZWNlaXZlcyB0aGUgYXBwbGljYXRpb24gY29udHJvbGxlciBhcyBpdHMKICAgICAgICBgY29udHJvbGxlcmAgcHJvcGVydHkKICAgICAgKiB0aGUgYXBwbGljYXRpb24gdmlldyByZWNlaXZlcyB0aGUgYXBwbGljYXRpb24gdGVtcGxhdGUgYXMgaXRzCiAgICAgICAgYGRlZmF1bHRUZW1wbGF0ZWAgcHJvcGVydHkKICAgICAgIEBtZXRob2QgYnVpbGRSZWdpc3RyeQogICAgICBAc3RhdGljCiAgICAgIEBwYXJhbSB7QXBwbGljYXRpb259IG5hbWVzcGFjZSB0aGUgYXBwbGljYXRpb24gZm9yIHdoaWNoIHRvCiAgICAgICAgYnVpbGQgdGhlIHJlZ2lzdHJ5CiAgICAgIEByZXR1cm4ge0VtYmVyLlJlZ2lzdHJ5fSB0aGUgYnVpbHQgcmVnaXN0cnkKICAgICAgQHByaXZhdGUKICAgICovCiAgICBidWlsZFJlZ2lzdHJ5OiBmdW5jdGlvbiBidWlsZFJlZ2lzdHJ5KCkgewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVudXNlZC12YXJzCiAgICAgIHZhciByZWdpc3RyeSA9IHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICBjb21tb25TZXR1cFJlZ2lzdHJ5KHJlZ2lzdHJ5KTsKICAgICAgKDAsIF9nbGltbWVyLnNldHVwQXBwbGljYXRpb25SZWdpc3RyeSkocmVnaXN0cnkpOwogICAgICByZXR1cm4gcmVnaXN0cnk7CiAgICB9CiAgfSk7CgogIGZ1bmN0aW9uIGNvbW1vblNldHVwUmVnaXN0cnkocmVnaXN0cnkpIHsKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdyb3V0ZXI6bWFpbicsIF9yb3V0aW5nLlJvdXRlci5leHRlbmQoKSk7CiAgICByZWdpc3RyeS5yZWdpc3RlcignLXZpZXctcmVnaXN0cnk6bWFpbicsIHsKICAgICAgY3JlYXRlOiBmdW5jdGlvbiBjcmVhdGUoKSB7CiAgICAgICAgcmV0dXJuICgwLCBfdXRpbHMuZGljdGlvbmFyeSkobnVsbCk7CiAgICAgIH0KICAgIH0pOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3JvdXRlOmJhc2ljJywgX3JvdXRpbmcuUm91dGUpOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2V2ZW50X2Rpc3BhdGNoZXI6bWFpbicsIF92aWV3cy5FdmVudERpc3BhdGNoZXIpOwogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdyb3V0ZXI6bWFpbicsICduYW1lc3BhY2UnLCAnYXBwbGljYXRpb246bWFpbicpOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2xvY2F0aW9uOmF1dG8nLCBfcm91dGluZy5BdXRvTG9jYXRpb24pOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2xvY2F0aW9uOmhhc2gnLCBfcm91dGluZy5IYXNoTG9jYXRpb24pOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2xvY2F0aW9uOmhpc3RvcnknLCBfcm91dGluZy5IaXN0b3J5TG9jYXRpb24pOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2xvY2F0aW9uOm5vbmUnLCBfcm91dGluZy5Ob25lTG9jYXRpb24pOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoKDAsIF9jb250YWluZXIucHJpdmF0aXplKShfdGVtcGxhdGVPYmplY3QoKSksIHsKICAgICAgY3JlYXRlOiBmdW5jdGlvbiBjcmVhdGUoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBfcm91dGluZy5CdWNrZXRDYWNoZSgpOwogICAgICB9CiAgICB9KTsKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdzZXJ2aWNlOnJvdXRlcicsIF9yb3V0aW5nLlJvdXRlclNlcnZpY2UpOwogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdzZXJ2aWNlOnJvdXRlcicsICdfcm91dGVyJywgJ3JvdXRlcjptYWluJyk7CiAgfQoKICBmdW5jdGlvbiByZWdpc3RlckxpYnJhcmllcygpIHsKICAgIGlmICghbGlicmFyaWVzUmVnaXN0ZXJlZCkgewogICAgICBsaWJyYXJpZXNSZWdpc3RlcmVkID0gdHJ1ZTsKCiAgICAgIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLkpRVUVSWV9JTlRFR1JBVElPTiAmJiBfYnJvd3NlckVudmlyb25tZW50Lmhhc0RPTSAmJiAhX3ZpZXdzLmpRdWVyeURpc2FibGVkKSB7CiAgICAgICAgX21ldGFsLmxpYnJhcmllcy5yZWdpc3RlckNvcmVMaWJyYXJ5KCdqUXVlcnknLCAoMCwgX3ZpZXdzLmpRdWVyeSkoKS5qcXVlcnkpOwogICAgICB9CiAgICB9CiAgfQoKICB2YXIgX2RlZmF1bHQgPSBBcHBsaWNhdGlvbjsKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci9hcHBsaWNhdGlvbi9saWIvbGF6eV9sb2FkIiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL2Vudmlyb25tZW50IiwgIkBlbWJlci8taW50ZXJuYWxzL2Jyb3dzZXItZW52aXJvbm1lbnQiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZW52aXJvbm1lbnQsIF9icm93c2VyRW52aXJvbm1lbnQpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLm9uTG9hZCA9IG9uTG9hZDsKICBfZXhwb3J0cy5ydW5Mb2FkSG9va3MgPSBydW5Mb2FkSG9va3M7CiAgX2V4cG9ydHMuX2xvYWRlZCA9IHZvaWQgMDsKCiAgLypnbG9iYWxzIEN1c3RvbUV2ZW50ICovCgogIC8qKgogICAgQG1vZHVsZSBAZW1iZXIvYXBwbGljYXRpb24KICAqLwogIHZhciBsb2FkSG9va3MgPSBfZW52aXJvbm1lbnQuRU5WLkVNQkVSX0xPQURfSE9PS1MgfHwge307CiAgdmFyIGxvYWRlZCA9IHt9OwogIHZhciBfbG9hZGVkID0gbG9hZGVkOwogIC8qKgogICAgRGV0ZWN0cyB3aGVuIGEgc3BlY2lmaWMgcGFja2FnZSBvZiBFbWJlciAoZS5nLiAnQXBwbGljYXRpb24nKQogICAgaGFzIGZ1bGx5IGxvYWRlZCBhbmQgaXMgYXZhaWxhYmxlIGZvciBleHRlbnNpb24uCiAgCiAgICBUaGUgcHJvdmlkZWQgYGNhbGxiYWNrYCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSBgbmFtZWAgcGFzc2VkCiAgICByZXNvbHZlZCBmcm9tIGEgc3RyaW5nIGludG8gdGhlIG9iamVjdDoKICAKICAgIGBgYCBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBvbkxvYWQgfSBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogIAogICAgb25Mb2FkKCdFbWJlci5BcHBsaWNhdGlvbicgZnVuY3Rpb24oaGJhcnMpIHsKICAgICAgaGJhcnMucmVnaXN0ZXJIZWxwZXIoLi4uKTsKICAgIH0pOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIG9uTG9hZAogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvYXBwbGljYXRpb24KICAgIEBwYXJhbSBuYW1lIHtTdHJpbmd9IG5hbWUgb2YgaG9vawogICAgQHBhcmFtIGNhbGxiYWNrIHtGdW5jdGlvbn0gY2FsbGJhY2sgdG8gYmUgY2FsbGVkCiAgICBAcHJpdmF0ZQogICovCgogIF9leHBvcnRzLl9sb2FkZWQgPSBfbG9hZGVkOwoKICBmdW5jdGlvbiBvbkxvYWQobmFtZSwgY2FsbGJhY2spIHsKICAgIHZhciBvYmplY3QgPSBsb2FkZWRbbmFtZV07CiAgICBsb2FkSG9va3NbbmFtZV0gPSBsb2FkSG9va3NbbmFtZV0gfHwgW107CiAgICBsb2FkSG9va3NbbmFtZV0ucHVzaChjYWxsYmFjayk7CgogICAgaWYgKG9iamVjdCkgewogICAgICBjYWxsYmFjayhvYmplY3QpOwogICAgfQogIH0KICAvKioKICAgIENhbGxlZCB3aGVuIGFuIEVtYmVyLmpzIHBhY2thZ2UgKGUuZyBBcHBsaWNhdGlvbikgaGFzIGZpbmlzaGVkCiAgICBsb2FkaW5nLiBUcmlnZ2VycyBhbnkgY2FsbGJhY2tzIHJlZ2lzdGVyZWQgZm9yIHRoaXMgZXZlbnQuCiAgCiAgICBAbWV0aG9kIHJ1bkxvYWRIb29rcwogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvYXBwbGljYXRpb24KICAgIEBwYXJhbSBuYW1lIHtTdHJpbmd9IG5hbWUgb2YgaG9vawogICAgQHBhcmFtIG9iamVjdCB7T2JqZWN0fSBvYmplY3QgdG8gcGFzcyB0byBjYWxsYmFja3MKICAgIEBwcml2YXRlCiAgKi8KCgogIGZ1bmN0aW9uIHJ1bkxvYWRIb29rcyhuYW1lLCBvYmplY3QpIHsKICAgIGxvYWRlZFtuYW1lXSA9IG9iamVjdDsKCiAgICBpZiAoX2Jyb3dzZXJFbnZpcm9ubWVudC53aW5kb3cgJiYgdHlwZW9mIEN1c3RvbUV2ZW50ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHZhciBldmVudCA9IG5ldyBDdXN0b21FdmVudChuYW1lLCB7CiAgICAgICAgZGV0YWlsOiBvYmplY3QsCiAgICAgICAgbmFtZTogbmFtZQogICAgICB9KTsKCiAgICAgIF9icm93c2VyRW52aXJvbm1lbnQud2luZG93LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgfQoKICAgIGlmIChsb2FkSG9va3NbbmFtZV0pIHsKICAgICAgbG9hZEhvb2tzW25hbWVdLmZvckVhY2goZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG9iamVjdCk7CiAgICAgIH0pOwogICAgfQogIH0KfSk7CmRlZmluZSgiQGVtYmVyL2FwcGxpY2F0aW9uL2xpYi92YWxpZGF0ZS10eXBlIiwgWyJleHBvcnRzIiwgIkBlbWJlci9kZWJ1ZyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9kZWJ1ZykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZhbGlkYXRlVHlwZTsKICB2YXIgVkFMSURBVEVEX1RZUEVTID0gewogICAgcm91dGU6IFsnYXNzZXJ0JywgJ2lzUm91dGVGYWN0b3J5JywgJ0VtYmVyLlJvdXRlJ10sCiAgICBjb21wb25lbnQ6IFsnZGVwcmVjYXRlJywgJ2lzQ29tcG9uZW50RmFjdG9yeScsICdFbWJlci5Db21wb25lbnQnXSwKICAgIHZpZXc6IFsnZGVwcmVjYXRlJywgJ2lzVmlld0ZhY3RvcnknLCAnRW1iZXIuVmlldyddLAogICAgc2VydmljZTogWydkZXByZWNhdGUnLCAnaXNTZXJ2aWNlRmFjdG9yeScsICdFbWJlci5TZXJ2aWNlJ10KICB9OwoKICBmdW5jdGlvbiB2YWxpZGF0ZVR5cGUocmVzb2x2ZWRUeXBlLCBwYXJzZWROYW1lKSB7CiAgICB2YXIgdmFsaWRhdGlvbkF0dHJpYnV0ZXMgPSBWQUxJREFURURfVFlQRVNbcGFyc2VkTmFtZS50eXBlXTsKCiAgICBpZiAoIXZhbGlkYXRpb25BdHRyaWJ1dGVzKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgZmFjdG9yeUZsYWcgPSB2YWxpZGF0aW9uQXR0cmlidXRlc1sxXSwKICAgICAgICBleHBlY3RlZFR5cGUgPSB2YWxpZGF0aW9uQXR0cmlidXRlc1syXTsKICAgIChmYWxzZSAmJiAhKEJvb2xlYW4ocmVzb2x2ZWRUeXBlW2ZhY3RvcnlGbGFnXSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiRXhwZWN0ZWQgIiArIHBhcnNlZE5hbWUuZnVsbE5hbWUgKyAiIHRvIHJlc29sdmUgdG8gYW4gIiArIGV4cGVjdGVkVHlwZSArICIgYnV0ICIgKyAoImluc3RlYWQgaXQgd2FzICIgKyByZXNvbHZlZFR5cGUgKyAiLiIpLCBCb29sZWFuKHJlc29sdmVkVHlwZVtmYWN0b3J5RmxhZ10pKSk7CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvY2FuYXJ5LWZlYXR1cmVzL2luZGV4IiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL2Vudmlyb25tZW50IiwgIkBlbWJlci9wb2x5ZmlsbHMiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZW52aXJvbm1lbnQsIF9wb2x5ZmlsbHMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmlzRW5hYmxlZCA9IGlzRW5hYmxlZDsKICBfZXhwb3J0cy5FTUJFUl9ST1VUSU5HX01PREVMX0FSRyA9IF9leHBvcnRzLkVNQkVSX0dMSU1NRVJfU0VUX0NPTVBPTkVOVF9URU1QTEFURSA9IF9leHBvcnRzLkVNQkVSX0NVU1RPTV9DT01QT05FTlRfQVJHX1BST1hZID0gX2V4cG9ydHMuRU1CRVJfTUVUQUxfVFJBQ0tFRF9QUk9QRVJUSUVTID0gX2V4cG9ydHMuRU1CRVJfTU9EVUxFX1VOSUZJQ0FUSU9OID0gX2V4cG9ydHMuRU1CRVJfSU1QUk9WRURfSU5TVFJVTUVOVEFUSU9OID0gX2V4cG9ydHMuRU1CRVJfTElCUkFSSUVTX0lTUkVHSVNURVJFRCA9IF9leHBvcnRzLkZFQVRVUkVTID0gX2V4cG9ydHMuREVGQVVMVF9GRUFUVVJFUyA9IHZvaWQgMDsKCiAgLyoqCiAgICBTZXQgYEVtYmVyRU5WLkZFQVRVUkVTYCBpbiB5b3VyIGFwcGxpY2F0aW9uJ3MgYGNvbmZpZy9lbnZpcm9ubWVudC5qc2AgZmlsZQogICAgdG8gZW5hYmxlIGNhbmFyeSBmZWF0dXJlcyBpbiB5b3VyIGFwcGxpY2F0aW9uLgogIAogICAgU2VlIHRoZSBbZmVhdHVyZSBmbGFnIGd1aWRlXShodHRwczovL2d1aWRlcy5lbWJlcmpzLmNvbS9yZWxlYXNlL2NvbmZpZ3VyaW5nLWVtYmVyL2ZlYXR1cmUtZmxhZ3MvKQogICAgZm9yIG1vcmUgZGV0YWlscy4KICAKICAgIEBtb2R1bGUgQGVtYmVyL2NhbmFyeS1mZWF0dXJlcwogICAgQHB1YmxpYwogICovCiAgdmFyIERFRkFVTFRfRkVBVFVSRVMgPSB7CiAgICBFTUJFUl9MSUJSQVJJRVNfSVNSRUdJU1RFUkVEOiBmYWxzZSwKICAgIEVNQkVSX0lNUFJPVkVEX0lOU1RSVU1FTlRBVElPTjogZmFsc2UsCiAgICBFTUJFUl9NT0RVTEVfVU5JRklDQVRJT046IGZhbHNlLAogICAgRU1CRVJfTUVUQUxfVFJBQ0tFRF9QUk9QRVJUSUVTOiB0cnVlLAogICAgRU1CRVJfQ1VTVE9NX0NPTVBPTkVOVF9BUkdfUFJPWFk6IHRydWUsCiAgICBFTUJFUl9HTElNTUVSX1NFVF9DT01QT05FTlRfVEVNUExBVEU6IHRydWUsCiAgICBFTUJFUl9ST1VUSU5HX01PREVMX0FSRzogdHJ1ZQogIH07CiAgLyoqCiAgICBUaGUgaGFzaCBvZiBlbmFibGVkIENhbmFyeSBmZWF0dXJlcy4gQWRkIHRvIHRoaXMsIGFueSBjYW5hcnkgZmVhdHVyZXMKICAgIGJlZm9yZSBjcmVhdGluZyB5b3VyIGFwcGxpY2F0aW9uLgogIAogICAgQGNsYXNzIEZFQVRVUkVTCiAgICBAc3RhdGljCiAgICBAc2luY2UgMS4xLjAKICAgIEBwdWJsaWMKICAqLwoKICBfZXhwb3J0cy5ERUZBVUxUX0ZFQVRVUkVTID0gREVGQVVMVF9GRUFUVVJFUzsKICB2YXIgRkVBVFVSRVMgPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKERFRkFVTFRfRkVBVFVSRVMsIF9lbnZpcm9ubWVudC5FTlYuRkVBVFVSRVMpOwogIC8qKgogICAgRGV0ZXJtaW5lIHdoZXRoZXIgdGhlIHNwZWNpZmllZCBgZmVhdHVyZWAgaXMgZW5hYmxlZC4gVXNlZCBieSBFbWJlcidzCiAgICBidWlsZCB0b29scyB0byBleGNsdWRlIGV4cGVyaW1lbnRhbCBmZWF0dXJlcyBmcm9tIGJldGEvc3RhYmxlIGJ1aWxkcy4KICAKICAgIFlvdSBjYW4gZGVmaW5lIHRoZSBmb2xsb3dpbmcgY29uZmlndXJhdGlvbiBvcHRpb25zOgogIAogICAgKiBgRW1iZXJFTlYuRU5BQkxFX09QVElPTkFMX0ZFQVRVUkVTYCAtIGVuYWJsZSBhbnkgZmVhdHVyZXMgdGhhdCBoYXZlIG5vdCBiZWVuIGV4cGxpY2l0bHkKICAgICAgZW5hYmxlZC9kaXNhYmxlZC4KICAKICAgIEBtZXRob2QgaXNFbmFibGVkCiAgICBAcGFyYW0ge1N0cmluZ30gZmVhdHVyZSBUaGUgZmVhdHVyZSB0byBjaGVjawogICAgQHJldHVybiB7Qm9vbGVhbn0KICAgIEBzaW5jZSAxLjEuMAogICAgQHB1YmxpYwogICovCgogIF9leHBvcnRzLkZFQVRVUkVTID0gRkVBVFVSRVM7CgogIGZ1bmN0aW9uIGlzRW5hYmxlZChmZWF0dXJlKSB7CiAgICB2YXIgZmVhdHVyZVZhbHVlID0gRkVBVFVSRVNbZmVhdHVyZV07CgogICAgaWYgKGZlYXR1cmVWYWx1ZSA9PT0gdHJ1ZSB8fCBmZWF0dXJlVmFsdWUgPT09IGZhbHNlKSB7CiAgICAgIHJldHVybiBmZWF0dXJlVmFsdWU7CiAgICB9IGVsc2UgaWYgKF9lbnZpcm9ubWVudC5FTlYuRU5BQkxFX09QVElPTkFMX0ZFQVRVUkVTKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZmVhdHVyZVZhbHVlKHZhbHVlKSB7CiAgICBpZiAoX2Vudmlyb25tZW50LkVOVi5FTkFCTEVfT1BUSU9OQUxfRkVBVFVSRVMgJiYgdmFsdWUgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgcmV0dXJuIHZhbHVlOwogIH0KCiAgdmFyIEVNQkVSX0xJQlJBUklFU19JU1JFR0lTVEVSRUQgPSBmZWF0dXJlVmFsdWUoRkVBVFVSRVMuRU1CRVJfTElCUkFSSUVTX0lTUkVHSVNURVJFRCk7CiAgX2V4cG9ydHMuRU1CRVJfTElCUkFSSUVTX0lTUkVHSVNURVJFRCA9IEVNQkVSX0xJQlJBUklFU19JU1JFR0lTVEVSRUQ7CiAgdmFyIEVNQkVSX0lNUFJPVkVEX0lOU1RSVU1FTlRBVElPTiA9IGZlYXR1cmVWYWx1ZShGRUFUVVJFUy5FTUJFUl9JTVBST1ZFRF9JTlNUUlVNRU5UQVRJT04pOwogIF9leHBvcnRzLkVNQkVSX0lNUFJPVkVEX0lOU1RSVU1FTlRBVElPTiA9IEVNQkVSX0lNUFJPVkVEX0lOU1RSVU1FTlRBVElPTjsKICB2YXIgRU1CRVJfTU9EVUxFX1VOSUZJQ0FUSU9OID0gZmVhdHVyZVZhbHVlKEZFQVRVUkVTLkVNQkVSX01PRFVMRV9VTklGSUNBVElPTik7CiAgX2V4cG9ydHMuRU1CRVJfTU9EVUxFX1VOSUZJQ0FUSU9OID0gRU1CRVJfTU9EVUxFX1VOSUZJQ0FUSU9OOwogIHZhciBFTUJFUl9NRVRBTF9UUkFDS0VEX1BST1BFUlRJRVMgPSBmZWF0dXJlVmFsdWUoRkVBVFVSRVMuRU1CRVJfTUVUQUxfVFJBQ0tFRF9QUk9QRVJUSUVTKTsKICBfZXhwb3J0cy5FTUJFUl9NRVRBTF9UUkFDS0VEX1BST1BFUlRJRVMgPSBFTUJFUl9NRVRBTF9UUkFDS0VEX1BST1BFUlRJRVM7CiAgdmFyIEVNQkVSX0NVU1RPTV9DT01QT05FTlRfQVJHX1BST1hZID0gZmVhdHVyZVZhbHVlKEZFQVRVUkVTLkVNQkVSX0NVU1RPTV9DT01QT05FTlRfQVJHX1BST1hZKTsKICBfZXhwb3J0cy5FTUJFUl9DVVNUT01fQ09NUE9ORU5UX0FSR19QUk9YWSA9IEVNQkVSX0NVU1RPTV9DT01QT05FTlRfQVJHX1BST1hZOwogIHZhciBFTUJFUl9HTElNTUVSX1NFVF9DT01QT05FTlRfVEVNUExBVEUgPSBmZWF0dXJlVmFsdWUoRkVBVFVSRVMuRU1CRVJfR0xJTU1FUl9TRVRfQ09NUE9ORU5UX1RFTVBMQVRFKTsKICBfZXhwb3J0cy5FTUJFUl9HTElNTUVSX1NFVF9DT01QT05FTlRfVEVNUExBVEUgPSBFTUJFUl9HTElNTUVSX1NFVF9DT01QT05FTlRfVEVNUExBVEU7CiAgdmFyIEVNQkVSX1JPVVRJTkdfTU9ERUxfQVJHID0gZmVhdHVyZVZhbHVlKEZFQVRVUkVTLkVNQkVSX1JPVVRJTkdfTU9ERUxfQVJHKTsKICBfZXhwb3J0cy5FTUJFUl9ST1VUSU5HX01PREVMX0FSRyA9IEVNQkVSX1JPVVRJTkdfTU9ERUxfQVJHOwp9KTsKZGVmaW5lKCJAZW1iZXIvY29tcG9uZW50L2luZGV4IiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL2dsaW1tZXIiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZ2xpbW1lcikgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiQ29tcG9uZW50IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2dsaW1tZXIuQ29tcG9uZW50OwogICAgfQogIH0pOwp9KTsKZGVmaW5lKCJAZW1iZXIvY29tcG9uZW50L3RlbXBsYXRlLW9ubHkiLCBbImV4cG9ydHMiXSwgZnVuY3Rpb24gKF9leHBvcnRzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdGVtcGxhdGVPbmx5Q29tcG9uZW50OwogIF9leHBvcnRzLmlzVGVtcGxhdGVPbmx5Q29tcG9uZW50ID0gaXNUZW1wbGF0ZU9ubHlDb21wb25lbnQ7CiAgX2V4cG9ydHMuVGVtcGxhdGVPbmx5Q29tcG9uZW50ID0gdm9pZCAwOwoKICAvLyBUaGlzIGlzIG9ubHkgZXhwb3J0ZWQgZm9yIHR5cGVzLCBkb24ndCB1c2UgdGhpcyBjbGFzcyBkaXJlY3RseQogIHZhciBUZW1wbGF0ZU9ubHlDb21wb25lbnQgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBUZW1wbGF0ZU9ubHlDb21wb25lbnQobW9kdWxlTmFtZSkgewogICAgICBpZiAobW9kdWxlTmFtZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgbW9kdWxlTmFtZSA9ICdAZW1iZXIvY29tcG9uZW50L3RlbXBsYXRlLW9ubHknOwogICAgICB9CgogICAgICB0aGlzLm1vZHVsZU5hbWUgPSBtb2R1bGVOYW1lOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBUZW1wbGF0ZU9ubHlDb21wb25lbnQucHJvdG90eXBlOwoKICAgIF9wcm90by50b1N0cmluZyA9IGZ1bmN0aW9uIHRvU3RyaW5nKCkgewogICAgICByZXR1cm4gdGhpcy5tb2R1bGVOYW1lOwogICAgfTsKCiAgICByZXR1cm4gVGVtcGxhdGVPbmx5Q29tcG9uZW50OwogIH0oKTsKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyL2NvbXBvbmVudC90ZW1wbGF0ZS1vbmx5CiAgICBAcHVibGljCiAgKi8KCiAgLyoqCiAgICBUaGlzIHV0aWxpdHkgZnVuY3Rpb24gaXMgdXNlZCB0byBkZWNsYXJlIGEgZ2l2ZW4gY29tcG9uZW50IGhhcyBubyBiYWNraW5nIGNsYXNzLiBXaGVuIHRoZSByZW5kZXJpbmcgZW5naW5lIGRldGVjdHMgdGhpcyBpdAogICAgaXMgYWJsZSB0byBwZXJmb3JtIGEgbnVtYmVyIG9mIG9wdGltaXphdGlvbnMuIFRlbXBsYXRlcyB0aGF0IGFyZSBhc3NvY2lhdGVkIHdpdGggYHRlbXBsYXRlT25seSgpYCB3aWxsIGJlIHJlbmRlcmVkIF9hcyBpc18KICAgIHdpdGhvdXQgYWRkaW5nIGEgd3JhcHBpbmcgYDxkaXY+YCAob3IgYW55IG9mIHRoZSBvdGhlciBlbGVtZW50IGN1c3RvbWl6YXRpb24gYmVoYXZpb3JzIG9mIFtAZW1iZXIvY29tcG9uZW50XSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0NvbXBvbmVudCkpLgogICAgU3BlY2lmaWNhbGx5LCB0aGlzIG1lYW5zIHRoYXQgdGhlIHRlbXBsYXRlIHdpbGwgYmUgcmVuZGVyZWQgYXMgIm91dGVyIEhUTUwiLgogIAogICAgSW4gZ2VuZXJhbCwgdGhpcyBtZXRob2Qgd2lsbCBiZSB1c2VkIGJ5IGJ1aWxkIHRpbWUgdG9vbGluZyBhbmQgd291bGQgbm90IGJlIGRpcmVjdGx5IHdyaXR0ZW4gaW4gYW4gYXBwbGljYXRpb24uIEhvd2V2ZXIsCiAgICBhdCB0aW1lcyBpdCBtYXkgYmUgdXNlZnVsIHRvIHVzZSBkaXJlY3RseSB0byBsZXZlcmFnZSB0aGUgIm91dGVyIEhUTUwiIHNlbWFudGljcyBtZW50aW9uZWQgYWJvdmUuIEZvciBleGFtcGxlLCBpZiBhbiBhZGRvbiB3b3VsZCBsaWtlCiAgICB0byB1c2UgdGhlc2Ugc2VtYW50aWNzIGZvciBpdHMgdGVtcGxhdGVzIGJ1dCBjYW5ub3QgYmUgY2VydGFpbiBpdCB3aWxsIG9ubHkgYmUgY29uc3VtZWQgYnkgYXBwbGljYXRpb25zIHRoYXQgaGF2ZSBlbmFibGVkIHRoZQogICAgYHRlbXBsYXRlLW9ubHktZ2xpbW1lci1jb21wb25lbnRzYCBvcHRpb25hbCBmZWF0dXJlLgogIAogICAgQGV4YW1wbGUKICAKICAgIGBgYGpzCiAgICBpbXBvcnQgdGVtcGxhdGVPbmx5IGZyb20gJ0BlbWJlci9jb21wb25lbnQvdGVtcGxhdGUtb25seSc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCB0ZW1wbGF0ZU9ubHkoKTsKICAgIGBgYAogIAogICAgQHB1YmxpYwogICAgQG1ldGhvZCB0ZW1wbGF0ZU9ubHkKICAgIEBwYXJhbSB7U3RyaW5nfSBtb2R1bGVOYW1lIHRoZSBtb2R1bGUgbmFtZSB0aGF0IHRoZSB0ZW1wbGF0ZSBvbmx5IGNvbXBvbmVudCByZXByZXNlbnRzLCB0aGlzIHdpbGwgYmUgdXNlZCBmb3IgZGVidWdnaW5nIHB1cnBvc2VzCiAgICBAY2F0ZWdvcnkgRU1CRVJfR0xJTU1FUl9TRVRfQ09NUE9ORU5UX1RFTVBMQVRFCiAgKi8KCgogIF9leHBvcnRzLlRlbXBsYXRlT25seUNvbXBvbmVudCA9IFRlbXBsYXRlT25seUNvbXBvbmVudDsKCiAgZnVuY3Rpb24gdGVtcGxhdGVPbmx5Q29tcG9uZW50KG1vZHVsZU5hbWUpIHsKICAgIHJldHVybiBuZXcgVGVtcGxhdGVPbmx5Q29tcG9uZW50KG1vZHVsZU5hbWUpOwogIH0KCiAgZnVuY3Rpb24gaXNUZW1wbGF0ZU9ubHlDb21wb25lbnQoY29tcG9uZW50KSB7CiAgICByZXR1cm4gY29tcG9uZW50IGluc3RhbmNlb2YgVGVtcGxhdGVPbmx5Q29tcG9uZW50OwogIH0KfSk7CmRlZmluZSgiQGVtYmVyL2NvbnRyb2xsZXIvaW5kZXgiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZSIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCIsICJAZW1iZXIvY29udHJvbGxlci9saWIvY29udHJvbGxlcl9taXhpbiJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9ydW50aW1lLCBfbWV0YWwsIF9jb250cm9sbGVyX21peGluKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5pbmplY3QgPSBpbmplY3Q7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvY29udHJvbGxlcgogICovCgogIC8qKgogICAgQGNsYXNzIENvbnRyb2xsZXIKICAgIEBleHRlbmRzIEVtYmVyT2JqZWN0CiAgICBAdXNlcyBFbWJlci5Db250cm9sbGVyTWl4aW4KICAgIEBwdWJsaWMKICAqLwogIHZhciBDb250cm9sbGVyID0gX3J1bnRpbWUuRnJhbWV3b3JrT2JqZWN0LmV4dGVuZChfY29udHJvbGxlcl9taXhpbi5kZWZhdWx0KTsKCiAgKDAsIF9ydW50aW1lLnNldEZyYW1ld29ya0NsYXNzKShDb250cm9sbGVyKTsKICAvKioKICAgIENyZWF0ZXMgYSBwcm9wZXJ0eSB0aGF0IGxhemlseSBsb29rcyB1cCBhbm90aGVyIGNvbnRyb2xsZXIgaW4gdGhlIGNvbnRhaW5lci4KICAgIENhbiBvbmx5IGJlIHVzZWQgd2hlbiBkZWZpbmluZyBhbm90aGVyIGNvbnRyb2xsZXIuCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgYXBwL2NvbnRyb2xsZXJzL3Bvc3QuanMKICAgIGltcG9ydCBDb250cm9sbGVyLCB7CiAgICAgIGluamVjdCBhcyBjb250cm9sbGVyCiAgICB9IGZyb20gJ0BlbWJlci9jb250cm9sbGVyJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIFBvc3RDb250cm9sbGVyIGV4dGVuZHMgQ29udHJvbGxlciB7CiAgICAgIEBjb250cm9sbGVyIHBvc3RzOwogICAgfQogICAgYGBgCiAgCiAgICBDbGFzc2ljIENsYXNzIEV4YW1wbGU6CiAgCiAgICBgYGBhcHAvY29udHJvbGxlcnMvcG9zdC5qcwogICAgaW1wb3J0IENvbnRyb2xsZXIsIHsKICAgICAgaW5qZWN0IGFzIGNvbnRyb2xsZXIKICAgIH0gZnJvbSAnQGVtYmVyL2NvbnRyb2xsZXInOwogIAogICAgZXhwb3J0IGRlZmF1bHQgQ29udHJvbGxlci5leHRlbmQoewogICAgICBwb3N0czogY29udHJvbGxlcigpCiAgICB9KTsKICAgIGBgYAogIAogICAgVGhpcyBleGFtcGxlIHdpbGwgY3JlYXRlIGEgYHBvc3RzYCBwcm9wZXJ0eSBvbiB0aGUgYHBvc3RgIGNvbnRyb2xsZXIgdGhhdAogICAgbG9va3MgdXAgdGhlIGBwb3N0c2AgY29udHJvbGxlciBpbiB0aGUgY29udGFpbmVyLCBtYWtpbmcgaXQgZWFzeSB0byByZWZlcmVuY2UKICAgIG90aGVyIGNvbnRyb2xsZXJzLgogIAogICAgQG1ldGhvZCBpbmplY3QKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL2NvbnRyb2xsZXIKICAgIEBzaW5jZSAxLjEwLjAKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIChvcHRpb25hbCkgbmFtZSBvZiB0aGUgY29udHJvbGxlciB0byBpbmplY3QsIGRlZmF1bHRzIHRvCiAgICAgICAgICAgdGhlIHByb3BlcnR5J3MgbmFtZQogICAgQHJldHVybiB7Q29tcHV0ZWREZWNvcmF0b3J9IGluamVjdGlvbiBkZWNvcmF0b3IgaW5zdGFuY2UKICAgIEBwdWJsaWMKICAqLwoKICBmdW5jdGlvbiBpbmplY3QoKSB7CiAgICByZXR1cm4gX21ldGFsLmluamVjdC5hcHBseSh2b2lkIDAsIFsnY29udHJvbGxlciddLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgfQoKICB2YXIgX2RlZmF1bHQgPSBDb250cm9sbGVyOwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CmRlZmluZSgiQGVtYmVyL2NvbnRyb2xsZXIvbGliL2NvbnRyb2xsZXJfbWl4aW4iLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZSIsICJAZW1iZXIvLWludGVybmFscy91dGlscyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9tZXRhbCwgX3J1bnRpbWUsIF91dGlscykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKICB2YXIgTU9ERUwgPSAoMCwgX3V0aWxzLnN5bWJvbCkoJ01PREVMJyk7CiAgLyoqCiAgQG1vZHVsZSBlbWJlcgogICovCgogIC8qKgogICAgQGNsYXNzIENvbnRyb2xsZXJNaXhpbgogICAgQG5hbWVzcGFjZSBFbWJlcgogICAgQHVzZXMgRW1iZXIuQWN0aW9uSGFuZGxlcgogICAgQHByaXZhdGUKICAqLwoKICB2YXIgX2RlZmF1bHQgPSBfbWV0YWwuTWl4aW4uY3JlYXRlKF9ydW50aW1lLkFjdGlvbkhhbmRsZXIsIHsKICAgIC8qIGR1Y2t0eXBlIGFzIGEgY29udHJvbGxlciAqLwogICAgaXNDb250cm9sbGVyOiB0cnVlLAoKICAgIC8qKgogICAgICBUaGUgb2JqZWN0IHRvIHdoaWNoIGFjdGlvbnMgZnJvbSB0aGUgdmlldyBzaG91bGQgYmUgc2VudC4KICAgICAgIEZvciBleGFtcGxlLCB3aGVuIGEgSGFuZGxlYmFycyB0ZW1wbGF0ZSB1c2VzIHRoZSBge3thY3Rpb259fWAgaGVscGVyLAogICAgICBpdCB3aWxsIGF0dGVtcHQgdG8gc2VuZCB0aGUgYWN0aW9uIHRvIHRoZSB2aWV3J3MgY29udHJvbGxlcidzIGB0YXJnZXRgLgogICAgICAgQnkgZGVmYXVsdCwgdGhlIHZhbHVlIG9mIHRoZSB0YXJnZXQgcHJvcGVydHkgaXMgc2V0IHRvIHRoZSByb3V0ZXIsIGFuZAogICAgICBpcyBpbmplY3RlZCB3aGVuIGEgY29udHJvbGxlciBpcyBpbnN0YW50aWF0ZWQuIFRoaXMgaW5qZWN0aW9uIGlzIGFwcGxpZWQKICAgICAgYXMgcGFydCBvZiB0aGUgYXBwbGljYXRpb24ncyBpbml0aWFsaXphdGlvbiBwcm9jZXNzLiBJbiBtb3N0IGNhc2VzIHRoZQogICAgICBgdGFyZ2V0YCBwcm9wZXJ0eSB3aWxsIGF1dG9tYXRpY2FsbHkgYmUgc2V0IHRvIHRoZSBsb2dpY2FsIGNvbnN1bWVyIG9mCiAgICAgIGFjdGlvbnMgZm9yIHRoZSBjb250cm9sbGVyLgogICAgICAgQHByb3BlcnR5IHRhcmdldAogICAgICBAZGVmYXVsdCBudWxsCiAgICAgIEBwdWJsaWMKICAgICovCiAgICB0YXJnZXQ6IG51bGwsCiAgICBzdG9yZTogbnVsbCwKCiAgICAvKioKICAgICAgVGhlIGNvbnRyb2xsZXIncyBjdXJyZW50IG1vZGVsLiBXaGVuIHJldHJpZXZpbmcgb3IgbW9kaWZ5aW5nIGEgY29udHJvbGxlcidzCiAgICAgIG1vZGVsLCB0aGlzIHByb3BlcnR5IHNob3VsZCBiZSB1c2VkIGluc3RlYWQgb2YgdGhlIGBjb250ZW50YCBwcm9wZXJ0eS4KICAgICAgIEBwcm9wZXJ0eSBtb2RlbAogICAgICBAcHVibGljCiAgICAqLwogICAgbW9kZWw6ICgwLCBfbWV0YWwuY29tcHV0ZWQpKHsKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXNbTU9ERUxdOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldChrZXksIHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRoaXNbTU9ERUxdID0gdmFsdWU7CiAgICAgIH0KICAgIH0pCiAgfSk7CgogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CmRlZmluZSgiQGVtYmVyL2RlYnVnL2luZGV4IiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL2Jyb3dzZXItZW52aXJvbm1lbnQiLCAiQGVtYmVyL2Vycm9yIiwgIkBlbWJlci9kZWJ1Zy9saWIvZGVwcmVjYXRlIiwgIkBlbWJlci9kZWJ1Zy9saWIvdGVzdGluZyIsICJAZW1iZXIvZGVidWcvbGliL3dhcm4iLCAiQGVtYmVyL2RlYnVnL2xpYi9jYXB0dXJlLXJlbmRlci10cmVlIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2Jyb3dzZXJFbnZpcm9ubWVudCwgX2Vycm9yLCBfZGVwcmVjYXRlMiwgX3Rlc3RpbmcsIF93YXJuMiwgX2NhcHR1cmVSZW5kZXJUcmVlKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJyZWdpc3RlckRlcHJlY2F0aW9uSGFuZGxlciIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9kZXByZWNhdGUyLnJlZ2lzdGVySGFuZGxlcjsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJpc1Rlc3RpbmciLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfdGVzdGluZy5pc1Rlc3Rpbmc7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAic2V0VGVzdGluZyIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF90ZXN0aW5nLnNldFRlc3Rpbmc7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAicmVnaXN0ZXJXYXJuSGFuZGxlciIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF93YXJuMi5yZWdpc3RlckhhbmRsZXI7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiY2FwdHVyZVJlbmRlclRyZWUiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfY2FwdHVyZVJlbmRlclRyZWUuZGVmYXVsdDsKICAgIH0KICB9KTsKICBfZXhwb3J0cy5fd2FybklmVXNpbmdTdHJpcHBlZEZlYXR1cmVGbGFncyA9IF9leHBvcnRzLmdldERlYnVnRnVuY3Rpb24gPSBfZXhwb3J0cy5zZXREZWJ1Z0Z1bmN0aW9uID0gX2V4cG9ydHMuZGVwcmVjYXRlRnVuYyA9IF9leHBvcnRzLnJ1bkluRGVidWcgPSBfZXhwb3J0cy5kZWJ1Z0ZyZWV6ZSA9IF9leHBvcnRzLmRlYnVnU2VhbCA9IF9leHBvcnRzLmRlcHJlY2F0ZSA9IF9leHBvcnRzLmRlYnVnID0gX2V4cG9ydHMud2FybiA9IF9leHBvcnRzLmluZm8gPSBfZXhwb3J0cy5hc3NlcnQgPSB2b2lkIDA7CgogIC8vIFRoZXNlIGFyZSB0aGUgZGVmYXVsdCBwcm9kdWN0aW9uIGJ1aWxkIHZlcnNpb25zOgogIHZhciBub29wID0gZnVuY3Rpb24gbm9vcCgpIHt9OwoKICB2YXIgYXNzZXJ0ID0gbm9vcDsKICBfZXhwb3J0cy5hc3NlcnQgPSBhc3NlcnQ7CiAgdmFyIGluZm8gPSBub29wOwogIF9leHBvcnRzLmluZm8gPSBpbmZvOwogIHZhciB3YXJuID0gbm9vcDsKICBfZXhwb3J0cy53YXJuID0gd2FybjsKICB2YXIgZGVidWcgPSBub29wOwogIF9leHBvcnRzLmRlYnVnID0gZGVidWc7CiAgdmFyIGRlcHJlY2F0ZSA9IG5vb3A7CiAgX2V4cG9ydHMuZGVwcmVjYXRlID0gZGVwcmVjYXRlOwogIHZhciBkZWJ1Z1NlYWwgPSBub29wOwogIF9leHBvcnRzLmRlYnVnU2VhbCA9IGRlYnVnU2VhbDsKICB2YXIgZGVidWdGcmVlemUgPSBub29wOwogIF9leHBvcnRzLmRlYnVnRnJlZXplID0gZGVidWdGcmVlemU7CiAgdmFyIHJ1bkluRGVidWcgPSBub29wOwogIF9leHBvcnRzLnJ1bkluRGVidWcgPSBydW5JbkRlYnVnOwogIHZhciBzZXREZWJ1Z0Z1bmN0aW9uID0gbm9vcDsKICBfZXhwb3J0cy5zZXREZWJ1Z0Z1bmN0aW9uID0gc2V0RGVidWdGdW5jdGlvbjsKICB2YXIgZ2V0RGVidWdGdW5jdGlvbiA9IG5vb3A7CiAgX2V4cG9ydHMuZ2V0RGVidWdGdW5jdGlvbiA9IGdldERlYnVnRnVuY3Rpb247CgogIHZhciBkZXByZWNhdGVGdW5jID0gZnVuY3Rpb24gZGVwcmVjYXRlRnVuYygpIHsKICAgIHJldHVybiBhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aCAtIDFdOwogIH07CgogIF9leHBvcnRzLmRlcHJlY2F0ZUZ1bmMgPSBkZXByZWNhdGVGdW5jOwoKICBpZiAoZmFsc2UKICAvKiBERUJVRyAqLwogICkgewogICAgX2V4cG9ydHMuc2V0RGVidWdGdW5jdGlvbiA9IHNldERlYnVnRnVuY3Rpb24gPSBmdW5jdGlvbiBzZXREZWJ1Z0Z1bmN0aW9uKHR5cGUsIGNhbGxiYWNrKSB7CiAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgIGNhc2UgJ2Fzc2VydCc6CiAgICAgICAgICByZXR1cm4gX2V4cG9ydHMuYXNzZXJ0ID0gYXNzZXJ0ID0gY2FsbGJhY2s7CgogICAgICAgIGNhc2UgJ2luZm8nOgogICAgICAgICAgcmV0dXJuIF9leHBvcnRzLmluZm8gPSBpbmZvID0gY2FsbGJhY2s7CgogICAgICAgIGNhc2UgJ3dhcm4nOgogICAgICAgICAgcmV0dXJuIF9leHBvcnRzLndhcm4gPSB3YXJuID0gY2FsbGJhY2s7CgogICAgICAgIGNhc2UgJ2RlYnVnJzoKICAgICAgICAgIHJldHVybiBfZXhwb3J0cy5kZWJ1ZyA9IGRlYnVnID0gY2FsbGJhY2s7CgogICAgICAgIGNhc2UgJ2RlcHJlY2F0ZSc6CiAgICAgICAgICByZXR1cm4gX2V4cG9ydHMuZGVwcmVjYXRlID0gZGVwcmVjYXRlID0gY2FsbGJhY2s7CgogICAgICAgIGNhc2UgJ2RlYnVnU2VhbCc6CiAgICAgICAgICByZXR1cm4gX2V4cG9ydHMuZGVidWdTZWFsID0gZGVidWdTZWFsID0gY2FsbGJhY2s7CgogICAgICAgIGNhc2UgJ2RlYnVnRnJlZXplJzoKICAgICAgICAgIHJldHVybiBfZXhwb3J0cy5kZWJ1Z0ZyZWV6ZSA9IGRlYnVnRnJlZXplID0gY2FsbGJhY2s7CgogICAgICAgIGNhc2UgJ3J1bkluRGVidWcnOgogICAgICAgICAgcmV0dXJuIF9leHBvcnRzLnJ1bkluRGVidWcgPSBydW5JbkRlYnVnID0gY2FsbGJhY2s7CgogICAgICAgIGNhc2UgJ2RlcHJlY2F0ZUZ1bmMnOgogICAgICAgICAgcmV0dXJuIF9leHBvcnRzLmRlcHJlY2F0ZUZ1bmMgPSBkZXByZWNhdGVGdW5jID0gY2FsbGJhY2s7CiAgICAgIH0KICAgIH07CgogICAgX2V4cG9ydHMuZ2V0RGVidWdGdW5jdGlvbiA9IGdldERlYnVnRnVuY3Rpb24gPSBmdW5jdGlvbiBnZXREZWJ1Z0Z1bmN0aW9uKHR5cGUpIHsKICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgY2FzZSAnYXNzZXJ0JzoKICAgICAgICAgIHJldHVybiBhc3NlcnQ7CgogICAgICAgIGNhc2UgJ2luZm8nOgogICAgICAgICAgcmV0dXJuIGluZm87CgogICAgICAgIGNhc2UgJ3dhcm4nOgogICAgICAgICAgcmV0dXJuIHdhcm47CgogICAgICAgIGNhc2UgJ2RlYnVnJzoKICAgICAgICAgIHJldHVybiBkZWJ1ZzsKCiAgICAgICAgY2FzZSAnZGVwcmVjYXRlJzoKICAgICAgICAgIHJldHVybiBkZXByZWNhdGU7CgogICAgICAgIGNhc2UgJ2RlYnVnU2VhbCc6CiAgICAgICAgICByZXR1cm4gZGVidWdTZWFsOwoKICAgICAgICBjYXNlICdkZWJ1Z0ZyZWV6ZSc6CiAgICAgICAgICByZXR1cm4gZGVidWdGcmVlemU7CgogICAgICAgIGNhc2UgJ3J1bkluRGVidWcnOgogICAgICAgICAgcmV0dXJuIHJ1bkluRGVidWc7CgogICAgICAgIGNhc2UgJ2RlcHJlY2F0ZUZ1bmMnOgogICAgICAgICAgcmV0dXJuIGRlcHJlY2F0ZUZ1bmM7CiAgICAgIH0KICAgIH07CiAgfQogIC8qKgogIEBtb2R1bGUgQGVtYmVyL2RlYnVnCiAgKi8KCgogIGlmIChmYWxzZQogIC8qIERFQlVHICovCiAgKSB7CiAgICAvKioKICAgICAgVmVyaWZ5IHRoYXQgYSBjZXJ0YWluIGV4cGVjdGF0aW9uIGlzIG1ldCwgb3IgdGhyb3cgYSBleGNlcHRpb24gb3RoZXJ3aXNlLgogICAgICAgICBUaGlzIGlzIHVzZWZ1bCBmb3IgY29tbXVuaWNhdGluZyBhc3N1bXB0aW9ucyBpbiB0aGUgY29kZSB0byBvdGhlciBodW1hbgogICAgICByZWFkZXJzIGFzIHdlbGwgYXMgY2F0Y2hpbmcgYnVncyB0aGF0IGFjY2lkZW50YWxseSB2aW9sYXRlcyB0aGVzZQogICAgICBleHBlY3RhdGlvbnMuCiAgICAgICAgIEFzc2VydGlvbnMgYXJlIHJlbW92ZWQgZnJvbSBwcm9kdWN0aW9uIGJ1aWxkcywgc28gdGhleSBjYW4gYmUgZnJlZWx5IGFkZGVkCiAgICAgIGZvciBkb2N1bWVudGF0aW9uIGFuZCBkZWJ1Z2dpbmcgcHVycG9zZXMgd2l0aG91dCB3b3JyaWVzIG9mIGluY3VyaW5nIGFueQogICAgICBwZXJmb3JtYW5jZSBwZW5hbHR5LiBIb3dldmVyLCBiZWNhdXNlIG9mIHRoYXQsIHRoZXkgc2hvdWxkIG5vdCBiZSB1c2VkIGZvcgogICAgICBjaGVja3MgdGhhdCBjb3VsZCByZWFzb25hYmx5IGZhaWwgZHVyaW5nIG5vcm1hbCB1c2FnZS4gRnVydGhlcm1vcmUsIGNhcmUKICAgICAgc2hvdWxkIGJlIHRha2VuIHRvIGF2b2lkIGFjY2lkZW50YWxseSByZWx5aW5nIG9uIHNpZGUtZWZmZWN0cyBwcm9kdWNlZCBmcm9tCiAgICAgIGV2YWx1YXRpbmcgdGhlIGNvbmRpdGlvbiBpdHNlbGYsIHNpbmNlIHRoZSBjb2RlIHdpbGwgbm90IHJ1biBpbiBwcm9kdWN0aW9uLgogICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCB7IGFzc2VydCB9IGZyb20gJ0BlbWJlci9kZWJ1Zyc7CiAgICAgICAgIC8vIFRlc3QgZm9yIHRydXRoaW5lc3MKICAgICAgYXNzZXJ0KCdNdXN0IHBhc3MgYSBzdHJpbmcnLCB0eXBlb2Ygc3RyID09PSAnc3RyaW5nJyk7CiAgICAgICAgIC8vIEZhaWwgdW5jb25kaXRpb25hbGx5CiAgICAgIGFzc2VydCgnVGhpcyBjb2RlIHBhdGggc2hvdWxkIG5ldmVyIGJlIHJ1bicpOwogICAgICBgYGAKICAgICAgICAgQG1ldGhvZCBhc3NlcnQKICAgICAgQHN0YXRpYwogICAgICBAZm9yIEBlbWJlci9kZWJ1ZwogICAgICBAcGFyYW0ge1N0cmluZ30gZGVzY3JpcHRpb24gRGVzY3JpYmVzIHRoZSBleHBlY3RhdGlvbi4gVGhpcyB3aWxsIGJlY29tZSB0aGUKICAgICAgICB0ZXh0IG9mIHRoZSBFcnJvciB0aHJvd24gaWYgdGhlIGFzc2VydGlvbiBmYWlscy4KICAgICAgQHBhcmFtIHtCb29sZWFufSBjb25kaXRpb24gTXVzdCBiZSB0cnV0aHkgZm9yIHRoZSBhc3NlcnRpb24gdG8gcGFzcy4gSWYKICAgICAgICBmYWxzeSwgYW4gZXhjZXB0aW9uIHdpbGwgYmUgdGhyb3duLgogICAgICBAcHVibGljCiAgICAgIEBzaW5jZSAxLjAuMAogICAgKi8KICAgIHNldERlYnVnRnVuY3Rpb24oJ2Fzc2VydCcsIGZ1bmN0aW9uIGFzc2VydChkZXNjLCB0ZXN0KSB7CiAgICAgIGlmICghdGVzdCkgewogICAgICAgIHRocm93IG5ldyBfZXJyb3IuZGVmYXVsdCgiQXNzZXJ0aW9uIEZhaWxlZDogIiArIGRlc2MpOwogICAgICB9CiAgICB9KTsKICAgIC8qKgogICAgICBEaXNwbGF5IGEgZGVidWcgbm90aWNlLgogICAgICAgICBDYWxscyB0byB0aGlzIGZ1bmN0aW9uIGFyZSByZW1vdmVkIGZyb20gcHJvZHVjdGlvbiBidWlsZHMsIHNvIHRoZXkgY2FuIGJlCiAgICAgIGZyZWVseSBhZGRlZCBmb3IgZG9jdW1lbnRhdGlvbiBhbmQgZGVidWdnaW5nIHB1cnBvc2VzIHdpdGhvdXQgd29ycmllcyBvZgogICAgICBpbmN1cmluZyBhbnkgcGVyZm9ybWFuY2UgcGVuYWx0eS4KICAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgeyBkZWJ1ZyB9IGZyb20gJ0BlbWJlci9kZWJ1Zyc7CiAgICAgICAgIGRlYnVnKCdJXCdtIGEgZGVidWcgbm90aWNlIScpOwogICAgICBgYGAKICAgICAgICAgQG1ldGhvZCBkZWJ1ZwogICAgICBAZm9yIEBlbWJlci9kZWJ1ZwogICAgICBAc3RhdGljCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlIEEgZGVidWcgbWVzc2FnZSB0byBkaXNwbGF5LgogICAgICBAcHVibGljCiAgICAqLwoKICAgIHNldERlYnVnRnVuY3Rpb24oJ2RlYnVnJywgZnVuY3Rpb24gZGVidWcobWVzc2FnZSkgewogICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1jb25zb2xlICovCiAgICAgIGlmIChjb25zb2xlLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5kZWJ1ZygiREVCVUc6ICIgKyBtZXNzYWdlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmxvZygiREVCVUc6ICIgKyBtZXNzYWdlKTsKICAgICAgfQogICAgICAvKiBlc2xpbnQtZW5zYWJsZSBuby1jb25zb2xlICovCgogICAgfSk7CiAgICAvKioKICAgICAgRGlzcGxheSBhbiBpbmZvIG5vdGljZS4KICAgICAgICAgQ2FsbHMgdG8gdGhpcyBmdW5jdGlvbiBhcmUgcmVtb3ZlZCBmcm9tIHByb2R1Y3Rpb24gYnVpbGRzLCBzbyB0aGV5IGNhbiBiZQogICAgICBmcmVlbHkgYWRkZWQgZm9yIGRvY3VtZW50YXRpb24gYW5kIGRlYnVnZ2luZyBwdXJwb3NlcyB3aXRob3V0IHdvcnJpZXMgb2YKICAgICAgaW5jdXJpbmcgYW55IHBlcmZvcm1hbmNlIHBlbmFsdHkuCiAgICAgICAgIEBtZXRob2QgaW5mbwogICAgICBAcHJpdmF0ZQogICAgKi8KCiAgICBzZXREZWJ1Z0Z1bmN0aW9uKCdpbmZvJywgZnVuY3Rpb24gaW5mbygpIHsKICAgICAgdmFyIF9jb25zb2xlOwoKICAgICAgKF9jb25zb2xlID0gY29uc29sZSkuaW5mby5hcHBseShfY29uc29sZSwgYXJndW1lbnRzKTsKICAgICAgLyogZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlICovCgogICAgfSk7CiAgICAvKioKICAgICBAbW9kdWxlIEBlbWJlci9kZWJ1ZwogICAgIEBwdWJsaWMKICAgICovCgogICAgLyoqCiAgICAgIEFsaWFzIGFuIG9sZCwgZGVwcmVjYXRlZCBtZXRob2Qgd2l0aCBpdHMgbmV3IGNvdW50ZXJwYXJ0LgogICAgICAgICBEaXNwbGF5IGEgZGVwcmVjYXRpb24gd2FybmluZyB3aXRoIHRoZSBwcm92aWRlZCBtZXNzYWdlIGFuZCBhIHN0YWNrIHRyYWNlCiAgICAgIChDaHJvbWUgYW5kIEZpcmVmb3ggb25seSkgd2hlbiB0aGUgYXNzaWduZWQgbWV0aG9kIGlzIGNhbGxlZC4KICAgICAgICAgQ2FsbHMgdG8gdGhpcyBmdW5jdGlvbiBhcmUgcmVtb3ZlZCBmcm9tIHByb2R1Y3Rpb24gYnVpbGRzLCBzbyB0aGV5IGNhbiBiZQogICAgICBmcmVlbHkgYWRkZWQgZm9yIGRvY3VtZW50YXRpb24gYW5kIGRlYnVnZ2luZyBwdXJwb3NlcyB3aXRob3V0IHdvcnJpZXMgb2YKICAgICAgaW5jdXJpbmcgYW55IHBlcmZvcm1hbmNlIHBlbmFsdHkuCiAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IHsgZGVwcmVjYXRlRnVuYyB9IGZyb20gJ0BlbWJlci9kZWJ1Zyc7CiAgICAgICAgIEVtYmVyLm9sZE1ldGhvZCA9IGRlcHJlY2F0ZUZ1bmMoJ1BsZWFzZSB1c2UgdGhlIG5ldywgdXBkYXRlZCBtZXRob2QnLCBvcHRpb25zLCBFbWJlci5uZXdNZXRob2QpOwogICAgICBgYGAKICAgICAgICAgQG1ldGhvZCBkZXByZWNhdGVGdW5jCiAgICAgIEBzdGF0aWMKICAgICAgQGZvciBAZW1iZXIvZGVidWcKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgQSBkZXNjcmlwdGlvbiBvZiB0aGUgZGVwcmVjYXRpb24uCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gVGhlIG9wdGlvbnMgb2JqZWN0IGZvciBgZGVwcmVjYXRlYC4KICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgbmV3IGZ1bmN0aW9uIGNhbGxlZCB0byByZXBsYWNlIGl0cyBkZXByZWNhdGVkIGNvdW50ZXJwYXJ0LgogICAgICBAcmV0dXJuIHtGdW5jdGlvbn0gQSBuZXcgZnVuY3Rpb24gdGhhdCB3cmFwcyB0aGUgb3JpZ2luYWwgZnVuY3Rpb24gd2l0aCBhIGRlcHJlY2F0aW9uIHdhcm5pbmcKICAgICAgQHByaXZhdGUKICAgICovCgogICAgc2V0RGVidWdGdW5jdGlvbignZGVwcmVjYXRlRnVuYycsIGZ1bmN0aW9uIGRlcHJlY2F0ZUZ1bmMoKSB7CiAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMykgewogICAgICAgIHZhciBtZXNzYWdlID0gYXJnc1swXSwKICAgICAgICAgICAgb3B0aW9ucyA9IGFyZ3NbMV0sCiAgICAgICAgICAgIGZ1bmMgPSBhcmdzWzJdOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkZXByZWNhdGUobWVzc2FnZSwgZmFsc2UsIG9wdGlvbnMpOwoKICAgICAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiksIF9rZXkyID0gMDsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgICAgICBhcmdzW19rZXkyXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgX21lc3NhZ2UgPSBhcmdzWzBdLAogICAgICAgICAgICBfZnVuYyA9IGFyZ3NbMV07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGRlcHJlY2F0ZShfbWVzc2FnZSk7CiAgICAgICAgICByZXR1cm4gX2Z1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICB9CiAgICB9KTsKICAgIC8qKgogICAgIEBtb2R1bGUgQGVtYmVyL2RlYnVnCiAgICAgQHB1YmxpYwogICAgKi8KCiAgICAvKioKICAgICAgUnVuIGEgZnVuY3Rpb24gbWVhbnQgZm9yIGRlYnVnZ2luZy4KICAgICAgICAgQ2FsbHMgdG8gdGhpcyBmdW5jdGlvbiBhcmUgcmVtb3ZlZCBmcm9tIHByb2R1Y3Rpb24gYnVpbGRzLCBzbyB0aGV5IGNhbiBiZQogICAgICBmcmVlbHkgYWRkZWQgZm9yIGRvY3VtZW50YXRpb24gYW5kIGRlYnVnZ2luZyBwdXJwb3NlcyB3aXRob3V0IHdvcnJpZXMgb2YKICAgICAgaW5jdXJpbmcgYW55IHBlcmZvcm1hbmNlIHBlbmFsdHkuCiAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgICAgaW1wb3J0IHsgcnVuSW5EZWJ1ZyB9IGZyb20gJ0BlbWJlci9kZWJ1Zyc7CiAgICAgICAgIHJ1bkluRGVidWcoKCkgPT4gewogICAgICAgIENvbXBvbmVudC5yZW9wZW4oewogICAgICAgICAgZGlkSW5zZXJ0RWxlbWVudCgpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coIkknbSBoYXBweSIpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgYGBgCiAgICAgICAgIEBtZXRob2QgcnVuSW5EZWJ1ZwogICAgICBAZm9yIEBlbWJlci9kZWJ1ZwogICAgICBAc3RhdGljCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGJlIGV4ZWN1dGVkLgogICAgICBAc2luY2UgMS41LjAKICAgICAgQHB1YmxpYwogICAgKi8KCiAgICBzZXREZWJ1Z0Z1bmN0aW9uKCdydW5JbkRlYnVnJywgZnVuY3Rpb24gcnVuSW5EZWJ1ZyhmdW5jKSB7CiAgICAgIGZ1bmMoKTsKICAgIH0pOwogICAgc2V0RGVidWdGdW5jdGlvbignZGVidWdTZWFsJywgZnVuY3Rpb24gZGVidWdTZWFsKG9iaikgewogICAgICBPYmplY3Quc2VhbChvYmopOwogICAgfSk7CiAgICBzZXREZWJ1Z0Z1bmN0aW9uKCdkZWJ1Z0ZyZWV6ZScsIGZ1bmN0aW9uIGRlYnVnRnJlZXplKG9iaikgewogICAgICAvLyByZS1mcmVlemluZyBhbiBhbHJlYWR5IGZyb3plbiBvYmplY3QgaW50cm9kdWNlcyBhIHNpZ25pZmljYW50CiAgICAgIC8vIHBlcmZvcm1hbmNlIHBlbmFsdHkgb24gQ2hyb21lICh0ZXN0ZWQgdGhyb3VnaCA1OSkuCiAgICAgIC8vCiAgICAgIC8vIFNlZTogaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL3Y4L2lzc3Vlcy9kZXRhaWw/aWQ9NjQ1MAogICAgICBpZiAoIU9iamVjdC5pc0Zyb3plbihvYmopKSB7CiAgICAgICAgT2JqZWN0LmZyZWV6ZShvYmopOwogICAgICB9CiAgICB9KTsKICAgIHNldERlYnVnRnVuY3Rpb24oJ2RlcHJlY2F0ZScsIF9kZXByZWNhdGUyLmRlZmF1bHQpOwogICAgc2V0RGVidWdGdW5jdGlvbignd2FybicsIF93YXJuMi5kZWZhdWx0KTsKICB9CgogIHZhciBfd2FybklmVXNpbmdTdHJpcHBlZEZlYXR1cmVGbGFnczsKCiAgX2V4cG9ydHMuX3dhcm5JZlVzaW5nU3RyaXBwZWRGZWF0dXJlRmxhZ3MgPSBfd2FybklmVXNpbmdTdHJpcHBlZEZlYXR1cmVGbGFnczsKCiAgaWYgKGZhbHNlCiAgLyogREVCVUcgKi8KICAmJiAhKDAsIF90ZXN0aW5nLmlzVGVzdGluZykoKSkgewogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIChfYnJvd3NlckVudmlyb25tZW50LmlzRmlyZWZveCB8fCBfYnJvd3NlckVudmlyb25tZW50LmlzQ2hyb21lKSAmJiB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kYXRhc2V0ICYmICFkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZGF0YXNldC5lbWJlckV4dGVuc2lvbikgewogICAgICAgICAgdmFyIGRvd25sb2FkVVJMOwoKICAgICAgICAgIGlmIChfYnJvd3NlckVudmlyb25tZW50LmlzQ2hyb21lKSB7CiAgICAgICAgICAgIGRvd25sb2FkVVJMID0gJ2h0dHBzOi8vY2hyb21lLmdvb2dsZS5jb20vd2Vic3RvcmUvZGV0YWlsL2VtYmVyLWluc3BlY3Rvci9ibWRibG5jZWdrZW5rYWNpZWloZmhwamZwcG9jb25oaSc7CiAgICAgICAgICB9IGVsc2UgaWYgKF9icm93c2VyRW52aXJvbm1lbnQuaXNGaXJlZm94KSB7CiAgICAgICAgICAgIGRvd25sb2FkVVJMID0gJ2h0dHBzOi8vYWRkb25zLm1vemlsbGEub3JnL2VuLVVTL2ZpcmVmb3gvYWRkb24vZW1iZXItaW5zcGVjdG9yLyc7CiAgICAgICAgICB9CgogICAgICAgICAgZGVidWcoIkZvciBtb3JlIGFkdmFuY2VkIGRlYnVnZ2luZywgaW5zdGFsbCB0aGUgRW1iZXIgSW5zcGVjdG9yIGZyb20gIiArIGRvd25sb2FkVVJMKTsKICAgICAgICB9CiAgICAgIH0sIGZhbHNlKTsKICAgIH0KICB9Cn0pOwpkZWZpbmUoIkBlbWJlci9kZWJ1Zy9saWIvY2FwdHVyZS1yZW5kZXItdHJlZSIsIFsiZXhwb3J0cyIsICJAZ2xpbW1lci91dGlsIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX3V0aWwpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSBjYXB0dXJlUmVuZGVyVHJlZTsKCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci9kZWJ1ZwogICovCgogIC8qKgogICAgRW1iZXIgSW5zcGVjdG9yIGNhbGxzIHRoaXMgZnVuY3Rpb24gdG8gY2FwdHVyZSB0aGUgY3VycmVudCByZW5kZXIgdHJlZS4KICAKICAgIEluIHByb2R1Y3Rpb24gbW9kZSwgdGhpcyByZXF1aXJlcyB0dXJuaW5nIG9uIGBFTlYuX0RFQlVHX1JFTkRFUl9UUkVFYAogICAgYmVmb3JlIGxvYWRpbmcgRW1iZXIuCiAgCiAgICBAcHJpdmF0ZQogICAgQHN0YXRpYwogICAgQG1ldGhvZCBjYXB0dXJlUmVuZGVyVHJlZQogICAgQGZvciBAZW1iZXIvZGVidWcKICAgIEBwYXJhbSBhcHAge0FwcGxpY2F0aW9uSW5zdGFuY2V9IEFuIGBBcHBsaWNhdGlvbkluc3RhbmNlYC4KICAgIEBzaW5jZSAzLjE0LjAKICAqLwogIGZ1bmN0aW9uIGNhcHR1cmVSZW5kZXJUcmVlKGFwcCkgewogICAgdmFyIGVudiA9ICgwLCBfdXRpbC5leHBlY3QpKGFwcC5sb29rdXAoJ3NlcnZpY2U6LWdsaW1tZXItZW52aXJvbm1lbnQnKSwgJ0JVRzogb3duZXIgaXMgbWlzc2luZyBzZXJ2aWNlOi1nbGltbWVyLWVudmlyb25tZW50Jyk7CiAgICByZXR1cm4gZW52LmRlYnVnUmVuZGVyVHJlZS5jYXB0dXJlKCk7CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvZGVidWcvbGliL2RlcHJlY2F0ZSIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy9lbnZpcm9ubWVudCIsICJAZW1iZXIvZGVidWcvaW5kZXgiLCAiQGVtYmVyL2RlYnVnL2xpYi9oYW5kbGVycyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9lbnZpcm9ubWVudCwgX2luZGV4LCBfaGFuZGxlcnMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLm1pc3NpbmdPcHRpb25zVW50aWxEZXByZWNhdGlvbiA9IF9leHBvcnRzLm1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbiA9IF9leHBvcnRzLm1pc3NpbmdPcHRpb25zRGVwcmVjYXRpb24gPSBfZXhwb3J0cy5yZWdpc3RlckhhbmRsZXIgPSBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICAgQG1vZHVsZSBAZW1iZXIvZGVidWcKICAgQHB1YmxpYwogICovCgogIC8qKgogICAgQWxsb3dzIGZvciBydW50aW1lIHJlZ2lzdHJhdGlvbiBvZiBoYW5kbGVyIGZ1bmN0aW9ucyB0aGF0IG92ZXJyaWRlIHRoZSBkZWZhdWx0IGRlcHJlY2F0aW9uIGJlaGF2aW9yLgogICAgRGVwcmVjYXRpb25zIGFyZSBpbnZva2VkIGJ5IGNhbGxzIHRvIFtAZW1iZXIvZGVidWcvZGVwcmVjYXRlXSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0BlbWJlciUyRmRlYnVnL21ldGhvZHMvZGVwcmVjYXRlP2FuY2hvcj1kZXByZWNhdGUpLgogICAgVGhlIGZvbGxvd2luZyBleGFtcGxlIGRlbW9uc3RyYXRlcyBpdHMgdXNhZ2UgYnkgcmVnaXN0ZXJpbmcgYSBoYW5kbGVyIHRoYXQgdGhyb3dzIGFuIGVycm9yIGlmIHRoZQogICAgbWVzc2FnZSBjb250YWlucyB0aGUgd29yZCAic2hvdWxkIiwgb3RoZXJ3aXNlIGRlZmVycyB0byB0aGUgZGVmYXVsdCBoYW5kbGVyLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgcmVnaXN0ZXJEZXByZWNhdGlvbkhhbmRsZXIgfSBmcm9tICdAZW1iZXIvZGVidWcnOwogIAogICAgcmVnaXN0ZXJEZXByZWNhdGlvbkhhbmRsZXIoKG1lc3NhZ2UsIG9wdGlvbnMsIG5leHQpID0+IHsKICAgICAgaWYgKG1lc3NhZ2UuaW5kZXhPZignc2hvdWxkJykgIT09IC0xKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEZXByZWNhdGlvbiBtZXNzYWdlIHdpdGggc2hvdWxkOiAke21lc3NhZ2V9YCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gZGVmZXIgdG8gd2hhdGV2ZXIgaGFuZGxlciB3YXMgcmVnaXN0ZXJlZCBiZWZvcmUgdGhpcyBvbmUKICAgICAgICBuZXh0KG1lc3NhZ2UsIG9wdGlvbnMpOwogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgVGhlIGhhbmRsZXIgZnVuY3Rpb24gdGFrZXMgdGhlIGZvbGxvd2luZyBhcmd1bWVudHM6CiAgCiAgICA8dWw+CiAgICAgIDxsaT4gPGNvZGU+bWVzc2FnZTwvY29kZT4gLSBUaGUgbWVzc2FnZSByZWNlaXZlZCBmcm9tIHRoZSBkZXByZWNhdGlvbiBjYWxsLjwvbGk+CiAgICAgIDxsaT4gPGNvZGU+b3B0aW9uczwvY29kZT4gLSBBbiBvYmplY3QgcGFzc2VkIGluIHdpdGggdGhlIGRlcHJlY2F0aW9uIGNhbGwgY29udGFpbmluZyBhZGRpdGlvbmFsIGluZm9ybWF0aW9uIGluY2x1ZGluZzo8L2xpPgogICAgICAgIDx1bD4KICAgICAgICAgIDxsaT4gPGNvZGU+aWQ8L2NvZGU+IC0gQW4gaWQgb2YgdGhlIGRlcHJlY2F0aW9uIGluIHRoZSBmb3JtIG9mIDxjb2RlPnBhY2thZ2UtbmFtZS5zcGVjaWZpYy1kZXByZWNhdGlvbjwvY29kZT4uPC9saT4KICAgICAgICAgIDxsaT4gPGNvZGU+dW50aWw8L2NvZGU+IC0gVGhlIEVtYmVyIHZlcnNpb24gbnVtYmVyIHRoZSBmZWF0dXJlIGFuZCBkZXByZWNhdGlvbiB3aWxsIGJlIHJlbW92ZWQgaW4uPC9saT4KICAgICAgICA8L3VsPgogICAgICA8bGk+IDxjb2RlPm5leHQ8L2NvZGU+IC0gQSBmdW5jdGlvbiB0aGF0IGNhbGxzIGludG8gdGhlIHByZXZpb3VzbHkgcmVnaXN0ZXJlZCBoYW5kbGVyLjwvbGk+CiAgICA8L3VsPgogIAogICAgQHB1YmxpYwogICAgQHN0YXRpYwogICAgQG1ldGhvZCByZWdpc3RlckRlcHJlY2F0aW9uSGFuZGxlcgogICAgQGZvciBAZW1iZXIvZGVidWcKICAgIEBwYXJhbSBoYW5kbGVyIHtGdW5jdGlvbn0gQSBmdW5jdGlvbiB0byBoYW5kbGUgZGVwcmVjYXRpb24gY2FsbHMuCiAgICBAc2luY2UgMi4xLjAKICAqLwogIHZhciByZWdpc3RlckhhbmRsZXIgPSBmdW5jdGlvbiByZWdpc3RlckhhbmRsZXIoKSB7fTsKCiAgX2V4cG9ydHMucmVnaXN0ZXJIYW5kbGVyID0gcmVnaXN0ZXJIYW5kbGVyOwogIHZhciBtaXNzaW5nT3B0aW9uc0RlcHJlY2F0aW9uOwogIF9leHBvcnRzLm1pc3NpbmdPcHRpb25zRGVwcmVjYXRpb24gPSBtaXNzaW5nT3B0aW9uc0RlcHJlY2F0aW9uOwogIHZhciBtaXNzaW5nT3B0aW9uc0lkRGVwcmVjYXRpb247CiAgX2V4cG9ydHMubWlzc2luZ09wdGlvbnNJZERlcHJlY2F0aW9uID0gbWlzc2luZ09wdGlvbnNJZERlcHJlY2F0aW9uOwogIHZhciBtaXNzaW5nT3B0aW9uc1VudGlsRGVwcmVjYXRpb247CiAgX2V4cG9ydHMubWlzc2luZ09wdGlvbnNVbnRpbERlcHJlY2F0aW9uID0gbWlzc2luZ09wdGlvbnNVbnRpbERlcHJlY2F0aW9uOwoKICB2YXIgZGVwcmVjYXRlID0gZnVuY3Rpb24gZGVwcmVjYXRlKCkge307CgogIGlmIChmYWxzZQogIC8qIERFQlVHICovCiAgKSB7CiAgICBfZXhwb3J0cy5yZWdpc3RlckhhbmRsZXIgPSByZWdpc3RlckhhbmRsZXIgPSBmdW5jdGlvbiByZWdpc3RlckhhbmRsZXIoaGFuZGxlcikgewogICAgICAoMCwgX2hhbmRsZXJzLnJlZ2lzdGVySGFuZGxlcikoJ2RlcHJlY2F0ZScsIGhhbmRsZXIpOwogICAgfTsKCiAgICB2YXIgZm9ybWF0TWVzc2FnZSA9IGZ1bmN0aW9uIGZvcm1hdE1lc3NhZ2UoX21lc3NhZ2UsIG9wdGlvbnMpIHsKICAgICAgdmFyIG1lc3NhZ2UgPSBfbWVzc2FnZTsKCiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuaWQpIHsKICAgICAgICBtZXNzYWdlID0gbWVzc2FnZSArICgiIFtkZXByZWNhdGlvbiBpZDogIiArIG9wdGlvbnMuaWQgKyAiXSIpOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnVybCkgewogICAgICAgIG1lc3NhZ2UgKz0gIiBTZWUgIiArIG9wdGlvbnMudXJsICsgIiBmb3IgbW9yZSBkZXRhaWxzLiI7CiAgICAgIH0KCiAgICAgIHJldHVybiBtZXNzYWdlOwogICAgfTsKCiAgICByZWdpc3RlckhhbmRsZXIoZnVuY3Rpb24gbG9nRGVwcmVjYXRpb25Ub0NvbnNvbGUobWVzc2FnZSwgb3B0aW9ucykgewogICAgICB2YXIgdXBkYXRlZE1lc3NhZ2UgPSBmb3JtYXRNZXNzYWdlKG1lc3NhZ2UsIG9wdGlvbnMpOwogICAgICBjb25zb2xlLndhcm4oIkRFUFJFQ0FUSU9OOiAiICsgdXBkYXRlZE1lc3NhZ2UpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGUKICAgIH0pOwogICAgdmFyIGNhcHR1cmVFcnJvckZvclN0YWNrOwoKICAgIGlmIChuZXcgRXJyb3IoKS5zdGFjaykgewogICAgICBjYXB0dXJlRXJyb3JGb3JTdGFjayA9IGZ1bmN0aW9uIGNhcHR1cmVFcnJvckZvclN0YWNrKCkgewogICAgICAgIHJldHVybiBuZXcgRXJyb3IoKTsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIGNhcHR1cmVFcnJvckZvclN0YWNrID0gZnVuY3Rpb24gY2FwdHVyZUVycm9yRm9yU3RhY2soKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIF9fZmFpbF9fLmZhaWwoKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICByZXR1cm4gZTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CgogICAgcmVnaXN0ZXJIYW5kbGVyKGZ1bmN0aW9uIGxvZ0RlcHJlY2F0aW9uU3RhY2tUcmFjZShtZXNzYWdlLCBvcHRpb25zLCBuZXh0KSB7CiAgICAgIGlmIChfZW52aXJvbm1lbnQuRU5WLkxPR19TVEFDS1RSQUNFX09OX0RFUFJFQ0FUSU9OKSB7CiAgICAgICAgdmFyIHN0YWNrU3RyID0gJyc7CiAgICAgICAgdmFyIGVycm9yID0gY2FwdHVyZUVycm9yRm9yU3RhY2soKTsKICAgICAgICB2YXIgc3RhY2s7CgogICAgICAgIGlmIChlcnJvci5zdGFjaykgewogICAgICAgICAgaWYgKGVycm9yWydhcmd1bWVudHMnXSkgewogICAgICAgICAgICAvLyBDaHJvbWUKICAgICAgICAgICAgc3RhY2sgPSBlcnJvci5zdGFjay5yZXBsYWNlKC9eXHMrYXRccysvZ20sICcnKS5yZXBsYWNlKC9eKFteXChdKz8pKFtcbiRdKS9nbSwgJ3thbm9ueW1vdXN9KCQxKSQyJykucmVwbGFjZSgvXk9iamVjdC48YW5vbnltb3VzPlxzKlwoKFteXCldKylcKS9nbSwgJ3thbm9ueW1vdXN9KCQxKScpLnNwbGl0KCdcbicpOwogICAgICAgICAgICBzdGFjay5zaGlmdCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gRmlyZWZveAogICAgICAgICAgICBzdGFjayA9IGVycm9yLnN0YWNrLnJlcGxhY2UoLyg/OlxuQDowKT9ccyskL20sICcnKS5yZXBsYWNlKC9eXCgvZ20sICd7YW5vbnltb3VzfSgnKS5zcGxpdCgnXG4nKTsKICAgICAgICAgIH0KCiAgICAgICAgICBzdGFja1N0ciA9ICJcbiAgICAiICsgc3RhY2suc2xpY2UoMikuam9pbignXG4gICAgJyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgdXBkYXRlZE1lc3NhZ2UgPSBmb3JtYXRNZXNzYWdlKG1lc3NhZ2UsIG9wdGlvbnMpOwogICAgICAgIGNvbnNvbGUud2FybigiREVQUkVDQVRJT046ICIgKyB1cGRhdGVkTWVzc2FnZSArIHN0YWNrU3RyKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlCiAgICAgIH0gZWxzZSB7CiAgICAgICAgbmV4dChtZXNzYWdlLCBvcHRpb25zKTsKICAgICAgfQogICAgfSk7CiAgICByZWdpc3RlckhhbmRsZXIoZnVuY3Rpb24gcmFpc2VPbkRlcHJlY2F0aW9uKG1lc3NhZ2UsIG9wdGlvbnMsIG5leHQpIHsKICAgICAgaWYgKF9lbnZpcm9ubWVudC5FTlYuUkFJU0VfT05fREVQUkVDQVRJT04pIHsKICAgICAgICB2YXIgdXBkYXRlZE1lc3NhZ2UgPSBmb3JtYXRNZXNzYWdlKG1lc3NhZ2UpOwogICAgICAgIHRocm93IG5ldyBFcnJvcih1cGRhdGVkTWVzc2FnZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbmV4dChtZXNzYWdlLCBvcHRpb25zKTsKICAgICAgfQogICAgfSk7CiAgICBfZXhwb3J0cy5taXNzaW5nT3B0aW9uc0RlcHJlY2F0aW9uID0gbWlzc2luZ09wdGlvbnNEZXByZWNhdGlvbiA9ICdXaGVuIGNhbGxpbmcgYGRlcHJlY2F0ZWAgeW91ICcgKyAnbXVzdCBwcm92aWRlIGFuIGBvcHRpb25zYCBoYXNoIGFzIHRoZSB0aGlyZCBwYXJhbWV0ZXIuICAnICsgJ2BvcHRpb25zYCBzaG91bGQgaW5jbHVkZSBgaWRgIGFuZCBgdW50aWxgIHByb3BlcnRpZXMuJzsKICAgIF9leHBvcnRzLm1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbiA9IG1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbiA9ICdXaGVuIGNhbGxpbmcgYGRlcHJlY2F0ZWAgeW91IG11c3QgcHJvdmlkZSBgaWRgIGluIG9wdGlvbnMuJzsKICAgIF9leHBvcnRzLm1pc3NpbmdPcHRpb25zVW50aWxEZXByZWNhdGlvbiA9IG1pc3NpbmdPcHRpb25zVW50aWxEZXByZWNhdGlvbiA9ICdXaGVuIGNhbGxpbmcgYGRlcHJlY2F0ZWAgeW91IG11c3QgcHJvdmlkZSBgdW50aWxgIGluIG9wdGlvbnMuJzsKICAgIC8qKgogICAgIEBtb2R1bGUgQGVtYmVyL2RlYnVnCiAgICAgQHB1YmxpYwogICAgICovCgogICAgLyoqCiAgICAgIERpc3BsYXkgYSBkZXByZWNhdGlvbiB3YXJuaW5nIHdpdGggdGhlIHByb3ZpZGVkIG1lc3NhZ2UgYW5kIGEgc3RhY2sgdHJhY2UKICAgICAgKENocm9tZSBhbmQgRmlyZWZveCBvbmx5KS4KICAgICAgICAgKiBJbiBhIHByb2R1Y3Rpb24gYnVpbGQsIHRoaXMgbWV0aG9kIGlzIGRlZmluZWQgYXMgYW4gZW1wdHkgZnVuY3Rpb24gKE5PUCkuCiAgICAgIFVzZXMgb2YgdGhpcyBtZXRob2QgaW4gRW1iZXIgaXRzZWxmIGFyZSBzdHJpcHBlZCBmcm9tIHRoZSBlbWJlci5wcm9kLmpzIGJ1aWxkLgogICAgICAgICBAbWV0aG9kIGRlcHJlY2F0ZQogICAgICBAZm9yIEBlbWJlci9kZWJ1ZwogICAgICBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBBIGRlc2NyaXB0aW9uIG9mIHRoZSBkZXByZWNhdGlvbi4KICAgICAgQHBhcmFtIHtCb29sZWFufSB0ZXN0IEEgYm9vbGVhbi4gSWYgZmFsc3ksIHRoZSBkZXByZWNhdGlvbiB3aWxsIGJlIGRpc3BsYXllZC4KICAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAgQHBhcmFtIHtTdHJpbmd9IG9wdGlvbnMuaWQgQSB1bmlxdWUgaWQgZm9yIHRoaXMgZGVwcmVjYXRpb24uIFRoZSBpZCBjYW4gYmUKICAgICAgICB1c2VkIGJ5IEVtYmVyIGRlYnVnZ2luZyB0b29scyB0byBjaGFuZ2UgdGhlIGJlaGF2aW9yIChyYWlzZSwgbG9nIG9yIHNpbGVuY2UpCiAgICAgICAgZm9yIHRoYXQgc3BlY2lmaWMgZGVwcmVjYXRpb24uIFRoZSBpZCBzaG91bGQgYmUgbmFtZXNwYWNlZCBieSBkb3RzLCBlLmcuCiAgICAgICAgInZpZXcuaGVscGVyLnNlbGVjdCIuCiAgICAgIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLnVudGlsIFRoZSB2ZXJzaW9uIG9mIEVtYmVyIHdoZW4gdGhpcyBkZXByZWNhdGlvbgogICAgICAgIHdhcm5pbmcgd2lsbCBiZSByZW1vdmVkLgogICAgICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMudXJsXSBBbiBvcHRpb25hbCB1cmwgdG8gdGhlIHRyYW5zaXRpb24gZ3VpZGUgb24gdGhlCiAgICAgICAgZW1iZXJqcy5jb20gd2Vic2l0ZS4KICAgICAgQHN0YXRpYwogICAgICBAcHVibGljCiAgICAgIEBzaW5jZSAxLjAuMAogICAgKi8KCiAgICBkZXByZWNhdGUgPSBmdW5jdGlvbiBkZXByZWNhdGUobWVzc2FnZSwgdGVzdCwgb3B0aW9ucykgewogICAgICAoMCwgX2luZGV4LmFzc2VydCkobWlzc2luZ09wdGlvbnNEZXByZWNhdGlvbiwgQm9vbGVhbihvcHRpb25zICYmIChvcHRpb25zLmlkIHx8IG9wdGlvbnMudW50aWwpKSk7CiAgICAgICgwLCBfaW5kZXguYXNzZXJ0KShtaXNzaW5nT3B0aW9uc0lkRGVwcmVjYXRpb24sIEJvb2xlYW4ob3B0aW9ucy5pZCkpOwogICAgICAoMCwgX2luZGV4LmFzc2VydCkobWlzc2luZ09wdGlvbnNVbnRpbERlcHJlY2F0aW9uLCBCb29sZWFuKG9wdGlvbnMudW50aWwpKTsKICAgICAgKDAsIF9oYW5kbGVycy5pbnZva2UpKCdkZXByZWNhdGUnLCBtZXNzYWdlLCB0ZXN0LCBvcHRpb25zKTsKICAgIH07CiAgfQoKICB2YXIgX2RlZmF1bHQgPSBkZXByZWNhdGU7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKZGVmaW5lKCJAZW1iZXIvZGVidWcvbGliL2hhbmRsZXJzIiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuaW52b2tlID0gX2V4cG9ydHMucmVnaXN0ZXJIYW5kbGVyID0gX2V4cG9ydHMuSEFORExFUlMgPSB2b2lkIDA7CiAgdmFyIEhBTkRMRVJTID0ge307CiAgX2V4cG9ydHMuSEFORExFUlMgPSBIQU5ETEVSUzsKCiAgdmFyIHJlZ2lzdGVySGFuZGxlciA9IGZ1bmN0aW9uIHJlZ2lzdGVySGFuZGxlcigpIHt9OwoKICBfZXhwb3J0cy5yZWdpc3RlckhhbmRsZXIgPSByZWdpc3RlckhhbmRsZXI7CgogIHZhciBpbnZva2UgPSBmdW5jdGlvbiBpbnZva2UoKSB7fTsKCiAgX2V4cG9ydHMuaW52b2tlID0gaW52b2tlOwoKICBpZiAoZmFsc2UKICAvKiBERUJVRyAqLwogICkgewogICAgX2V4cG9ydHMucmVnaXN0ZXJIYW5kbGVyID0gcmVnaXN0ZXJIYW5kbGVyID0gZnVuY3Rpb24gcmVnaXN0ZXJIYW5kbGVyKHR5cGUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBuZXh0SGFuZGxlciA9IEhBTkRMRVJTW3R5cGVdIHx8IGZ1bmN0aW9uICgpIHt9OwoKICAgICAgSEFORExFUlNbdHlwZV0gPSBmdW5jdGlvbiAobWVzc2FnZSwgb3B0aW9ucykgewogICAgICAgIGNhbGxiYWNrKG1lc3NhZ2UsIG9wdGlvbnMsIG5leHRIYW5kbGVyKTsKICAgICAgfTsKICAgIH07CgogICAgX2V4cG9ydHMuaW52b2tlID0gaW52b2tlID0gZnVuY3Rpb24gaW52b2tlKHR5cGUsIG1lc3NhZ2UsIHRlc3QsIG9wdGlvbnMpIHsKICAgICAgaWYgKHRlc3QpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBoYW5kbGVyRm9yVHlwZSA9IEhBTkRMRVJTW3R5cGVdOwoKICAgICAgaWYgKGhhbmRsZXJGb3JUeXBlKSB7CiAgICAgICAgaGFuZGxlckZvclR5cGUobWVzc2FnZSwgb3B0aW9ucyk7CiAgICAgIH0KICAgIH07CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvZGVidWcvbGliL3Rlc3RpbmciLCBbImV4cG9ydHMiXSwgZnVuY3Rpb24gKF9leHBvcnRzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5pc1Rlc3RpbmcgPSBpc1Rlc3Rpbmc7CiAgX2V4cG9ydHMuc2V0VGVzdGluZyA9IHNldFRlc3Rpbmc7CiAgdmFyIHRlc3RpbmcgPSBmYWxzZTsKCiAgZnVuY3Rpb24gaXNUZXN0aW5nKCkgewogICAgcmV0dXJuIHRlc3Rpbmc7CiAgfQoKICBmdW5jdGlvbiBzZXRUZXN0aW5nKHZhbHVlKSB7CiAgICB0ZXN0aW5nID0gQm9vbGVhbih2YWx1ZSk7CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvZGVidWcvbGliL3dhcm4iLCBbImV4cG9ydHMiLCAiQGVtYmVyL2RlYnVnL2luZGV4IiwgIkBlbWJlci9kZWJ1Zy9saWIvaGFuZGxlcnMiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfaW5kZXgsIF9oYW5kbGVycykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMubWlzc2luZ09wdGlvbnNEZXByZWNhdGlvbiA9IF9leHBvcnRzLm1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbiA9IF9leHBvcnRzLnJlZ2lzdGVySGFuZGxlciA9IF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIHZhciByZWdpc3RlckhhbmRsZXIgPSBmdW5jdGlvbiByZWdpc3RlckhhbmRsZXIoKSB7fTsKCiAgX2V4cG9ydHMucmVnaXN0ZXJIYW5kbGVyID0gcmVnaXN0ZXJIYW5kbGVyOwoKICB2YXIgd2FybiA9IGZ1bmN0aW9uIHdhcm4oKSB7fTsKCiAgdmFyIG1pc3NpbmdPcHRpb25zRGVwcmVjYXRpb247CiAgX2V4cG9ydHMubWlzc2luZ09wdGlvbnNEZXByZWNhdGlvbiA9IG1pc3NpbmdPcHRpb25zRGVwcmVjYXRpb247CiAgdmFyIG1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbjsKICAvKioKICBAbW9kdWxlIEBlbWJlci9kZWJ1ZwogICovCgogIF9leHBvcnRzLm1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbiA9IG1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbjsKCiAgaWYgKGZhbHNlCiAgLyogREVCVUcgKi8KICApIHsKICAgIC8qKgogICAgICBBbGxvd3MgZm9yIHJ1bnRpbWUgcmVnaXN0cmF0aW9uIG9mIGhhbmRsZXIgZnVuY3Rpb25zIHRoYXQgb3ZlcnJpZGUgdGhlIGRlZmF1bHQgd2FybmluZyBiZWhhdmlvci4KICAgICAgV2FybmluZ3MgYXJlIGludm9rZWQgYnkgY2FsbHMgbWFkZSB0byBbQGVtYmVyL2RlYnVnL3dhcm5dKC9lbWJlci9yZWxlYXNlL2NsYXNzZXMvQGVtYmVyJTJGZGVidWcvbWV0aG9kcy93YXJuP2FuY2hvcj13YXJuKS4KICAgICAgVGhlIGZvbGxvd2luZyBleGFtcGxlIGRlbW9uc3RyYXRlcyBpdHMgdXNhZ2UgYnkgcmVnaXN0ZXJpbmcgYSBoYW5kbGVyIHRoYXQgZG9lcyBub3RoaW5nIG92ZXJyaWRpbmcgRW1iZXIncwogICAgICBkZWZhdWx0IHdhcm5pbmcgYmVoYXZpb3IuCiAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IHsgcmVnaXN0ZXJXYXJuSGFuZGxlciB9IGZyb20gJ0BlbWJlci9kZWJ1Zyc7CiAgICAgICAgIC8vIG5leHQgaXMgbm90IGNhbGxlZCwgc28gbm8gd2FybmluZ3MgZ2V0IHRoZSBkZWZhdWx0IGJlaGF2aW9yCiAgICAgIHJlZ2lzdGVyV2FybkhhbmRsZXIoKCkgPT4ge30pOwogICAgICBgYGAKICAgICAgICAgVGhlIGhhbmRsZXIgZnVuY3Rpb24gdGFrZXMgdGhlIGZvbGxvd2luZyBhcmd1bWVudHM6CiAgICAgICAgIDx1bD4KICAgICAgICA8bGk+IDxjb2RlPm1lc3NhZ2U8L2NvZGU+IC0gVGhlIG1lc3NhZ2UgcmVjZWl2ZWQgZnJvbSB0aGUgd2FybiBjYWxsLiA8L2xpPgogICAgICAgIDxsaT4gPGNvZGU+b3B0aW9uczwvY29kZT4gLSBBbiBvYmplY3QgcGFzc2VkIGluIHdpdGggdGhlIHdhcm4gY2FsbCBjb250YWluaW5nIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gaW5jbHVkaW5nOjwvbGk+CiAgICAgICAgICA8dWw+CiAgICAgICAgICAgIDxsaT4gPGNvZGU+aWQ8L2NvZGU+IC0gQW4gaWQgb2YgdGhlIHdhcm5pbmcgaW4gdGhlIGZvcm0gb2YgPGNvZGU+cGFja2FnZS1uYW1lLnNwZWNpZmljLXdhcm5pbmc8L2NvZGU+LjwvbGk+CiAgICAgICAgICA8L3VsPgogICAgICAgIDxsaT4gPGNvZGU+bmV4dDwvY29kZT4gLSBBIGZ1bmN0aW9uIHRoYXQgY2FsbHMgaW50byB0aGUgcHJldmlvdXNseSByZWdpc3RlcmVkIGhhbmRsZXIuPC9saT4KICAgICAgPC91bD4KICAgICAgICAgQHB1YmxpYwogICAgICBAc3RhdGljCiAgICAgIEBtZXRob2QgcmVnaXN0ZXJXYXJuSGFuZGxlcgogICAgICBAZm9yIEBlbWJlci9kZWJ1ZwogICAgICBAcGFyYW0gaGFuZGxlciB7RnVuY3Rpb259IEEgZnVuY3Rpb24gdG8gaGFuZGxlIHdhcm5pbmdzLgogICAgICBAc2luY2UgMi4xLjAKICAgICovCiAgICBfZXhwb3J0cy5yZWdpc3RlckhhbmRsZXIgPSByZWdpc3RlckhhbmRsZXIgPSBmdW5jdGlvbiByZWdpc3RlckhhbmRsZXIoaGFuZGxlcikgewogICAgICAoMCwgX2hhbmRsZXJzLnJlZ2lzdGVySGFuZGxlcikoJ3dhcm4nLCBoYW5kbGVyKTsKICAgIH07CgogICAgcmVnaXN0ZXJIYW5kbGVyKGZ1bmN0aW9uIGxvZ1dhcm5pbmcobWVzc2FnZSkgewogICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1jb25zb2xlICovCiAgICAgIGNvbnNvbGUud2FybigiV0FSTklORzogIiArIG1lc3NhZ2UpOwogICAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLWNvbnNvbGUgKi8KICAgIH0pOwogICAgX2V4cG9ydHMubWlzc2luZ09wdGlvbnNEZXByZWNhdGlvbiA9IG1pc3NpbmdPcHRpb25zRGVwcmVjYXRpb24gPSAnV2hlbiBjYWxsaW5nIGB3YXJuYCB5b3UgJyArICdtdXN0IHByb3ZpZGUgYW4gYG9wdGlvbnNgIGhhc2ggYXMgdGhlIHRoaXJkIHBhcmFtZXRlci4gICcgKyAnYG9wdGlvbnNgIHNob3VsZCBpbmNsdWRlIGFuIGBpZGAgcHJvcGVydHkuJzsKICAgIF9leHBvcnRzLm1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbiA9IG1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbiA9ICdXaGVuIGNhbGxpbmcgYHdhcm5gIHlvdSBtdXN0IHByb3ZpZGUgYGlkYCBpbiBvcHRpb25zLic7CiAgICAvKioKICAgICAgRGlzcGxheSBhIHdhcm5pbmcgd2l0aCB0aGUgcHJvdmlkZWQgbWVzc2FnZS4KICAgICAgICAgKiBJbiBhIHByb2R1Y3Rpb24gYnVpbGQsIHRoaXMgbWV0aG9kIGlzIGRlZmluZWQgYXMgYW4gZW1wdHkgZnVuY3Rpb24gKE5PUCkuCiAgICAgIFVzZXMgb2YgdGhpcyBtZXRob2QgaW4gRW1iZXIgaXRzZWxmIGFyZSBzdHJpcHBlZCBmcm9tIHRoZSBlbWJlci5wcm9kLmpzIGJ1aWxkLgogICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCB7IHdhcm4gfSBmcm9tICdAZW1iZXIvZGVidWcnOwogICAgICBpbXBvcnQgdG9tc3RlckNvdW50IGZyb20gJy4vdG9tc3Rlci1jb3VudGVyJzsgLy8gYSBtb2R1bGUgaW4gbXkgcHJvamVjdAogICAgICAgICAvLyBMb2cgYSB3YXJuaW5nIGlmIHdlIGhhdmUgbW9yZSB0aGFuIDMgdG9tc3RlcnMKICAgICAgd2FybignVG9vIG1hbnkgdG9tc3RlcnMhJywgdG9tc3RlckNvdW50IDw9IDMsIHsKICAgICAgICBpZDogJ2VtYmVyLWRlYnVnLnRvby1tYW55LXRvbXN0ZXJzJwogICAgICB9KTsKICAgICAgYGBgCiAgICAgICAgIEBtZXRob2Qgd2FybgogICAgICBAZm9yIEBlbWJlci9kZWJ1ZwogICAgICBAc3RhdGljCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlIEEgd2FybmluZyB0byBkaXNwbGF5LgogICAgICBAcGFyYW0ge0Jvb2xlYW59IHRlc3QgQW4gb3B0aW9uYWwgYm9vbGVhbi4gSWYgZmFsc3ksIHRoZSB3YXJuaW5nCiAgICAgICAgd2lsbCBiZSBkaXNwbGF5ZWQuCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEFuIG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIHRvIHBhc3MgYSB1bmlxdWUKICAgICAgICBgaWRgIGZvciB0aGlzIHdhcm5pbmcuICBUaGUgYGlkYCBjYW4gYmUgdXNlZCBieSBFbWJlciBkZWJ1Z2dpbmcgdG9vbHMKICAgICAgICB0byBjaGFuZ2UgdGhlIGJlaGF2aW9yIChyYWlzZSwgbG9nLCBvciBzaWxlbmNlKSBmb3IgdGhhdCBzcGVjaWZpYyB3YXJuaW5nLgogICAgICAgIFRoZSBgaWRgIHNob3VsZCBiZSBuYW1lc3BhY2VkIGJ5IGRvdHMsIGUuZy4gImVtYmVyLWRlYnVnLmZlYXR1cmUtZmxhZy13aXRoLWZlYXR1cmVzLXN0cmlwcGVkIgogICAgICBAcHVibGljCiAgICAgIEBzaW5jZSAxLjAuMAogICAgKi8KCiAgICB3YXJuID0gZnVuY3Rpb24gd2FybihtZXNzYWdlLCB0ZXN0LCBvcHRpb25zKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyICYmIHR5cGVvZiB0ZXN0ID09PSAnb2JqZWN0JykgewogICAgICAgIG9wdGlvbnMgPSB0ZXN0OwogICAgICAgIHRlc3QgPSBmYWxzZTsKICAgICAgfQoKICAgICAgKDAsIF9pbmRleC5hc3NlcnQpKG1pc3NpbmdPcHRpb25zRGVwcmVjYXRpb24sIEJvb2xlYW4ob3B0aW9ucykpOwogICAgICAoMCwgX2luZGV4LmFzc2VydCkobWlzc2luZ09wdGlvbnNJZERlcHJlY2F0aW9uLCBCb29sZWFuKG9wdGlvbnMgJiYgb3B0aW9ucy5pZCkpOwogICAgICAoMCwgX2hhbmRsZXJzLmludm9rZSkoJ3dhcm4nLCBtZXNzYWdlLCB0ZXN0LCBvcHRpb25zKTsKICAgIH07CiAgfQoKICB2YXIgX2RlZmF1bHQgPSB3YXJuOwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CmRlZmluZSgiQGVtYmVyL2RlcHJlY2F0ZWQtZmVhdHVyZXMvaW5kZXgiLCBbImV4cG9ydHMiXSwgZnVuY3Rpb24gKF9leHBvcnRzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5NT1VTRV9FTlRFUl9MRUFWRV9NT1ZFX0VWRU5UUyA9IF9leHBvcnRzLkZVTkNUSU9OX1BST1RPVFlQRV9FWFRFTlNJT05TID0gX2V4cG9ydHMuQVBQX0NUUkxfUk9VVEVSX1BST1BTID0gX2V4cG9ydHMuQUxJQVNfTUVUSE9EID0gX2V4cG9ydHMuSlFVRVJZX0lOVEVHUkFUSU9OID0gX2V4cG9ydHMuQ09NUE9ORU5UX01BTkFHRVJfU1RSSU5HX0xPT0tVUCA9IF9leHBvcnRzLlJPVVRFUl9FVkVOVFMgPSBfZXhwb3J0cy5NRVJHRSA9IF9leHBvcnRzLkxPR0dFUiA9IF9leHBvcnRzLkVNQkVSX0VYVEVORF9QUk9UT1RZUEVTID0gX2V4cG9ydHMuU0VORF9BQ1RJT04gPSB2b2lkIDA7CgogIC8qIGVzbGludC1kaXNhYmxlIG5vLWltcGxpY2l0LWNvZXJjaW9uICovCiAgLy8gVGhlc2UgdmVyc2lvbnMgc2hvdWxkIGJlIHRoZSB2ZXJzaW9uIHRoYXQgdGhlIGRlcHJlY2F0aW9uIHdhcyBfaW50cm9kdWNlZF8sCiAgLy8gbm90IHRoZSB2ZXJzaW9uIHRoYXQgdGhlIGZlYXR1cmUgd2lsbCBiZSByZW1vdmVkLgogIHZhciBTRU5EX0FDVElPTiA9ICEhJzMuNC4wJzsKICBfZXhwb3J0cy5TRU5EX0FDVElPTiA9IFNFTkRfQUNUSU9OOwogIHZhciBFTUJFUl9FWFRFTkRfUFJPVE9UWVBFUyA9ICEhJzMuMi4wLWJldGEuNSc7CiAgX2V4cG9ydHMuRU1CRVJfRVhURU5EX1BST1RPVFlQRVMgPSBFTUJFUl9FWFRFTkRfUFJPVE9UWVBFUzsKICB2YXIgTE9HR0VSID0gISEnMy4yLjAtYmV0YS4xJzsKICBfZXhwb3J0cy5MT0dHRVIgPSBMT0dHRVI7CiAgdmFyIE1FUkdFID0gISEnMy42LjAtYmV0YS4xJzsKICBfZXhwb3J0cy5NRVJHRSA9IE1FUkdFOwogIHZhciBST1VURVJfRVZFTlRTID0gISEnNC4wLjAnOwogIF9leHBvcnRzLlJPVVRFUl9FVkVOVFMgPSBST1VURVJfRVZFTlRTOwogIHZhciBDT01QT05FTlRfTUFOQUdFUl9TVFJJTkdfTE9PS1VQID0gISEnMy44LjAnOwogIF9leHBvcnRzLkNPTVBPTkVOVF9NQU5BR0VSX1NUUklOR19MT09LVVAgPSBDT01QT05FTlRfTUFOQUdFUl9TVFJJTkdfTE9PS1VQOwogIHZhciBKUVVFUllfSU5URUdSQVRJT04gPSAhISczLjkuMCc7CiAgX2V4cG9ydHMuSlFVRVJZX0lOVEVHUkFUSU9OID0gSlFVRVJZX0lOVEVHUkFUSU9OOwogIHZhciBBTElBU19NRVRIT0QgPSAhISczLjkuMCc7CiAgX2V4cG9ydHMuQUxJQVNfTUVUSE9EID0gQUxJQVNfTUVUSE9EOwogIHZhciBBUFBfQ1RSTF9ST1VURVJfUFJPUFMgPSAhISczLjEwLjAtYmV0YS4xJzsKICBfZXhwb3J0cy5BUFBfQ1RSTF9ST1VURVJfUFJPUFMgPSBBUFBfQ1RSTF9ST1VURVJfUFJPUFM7CiAgdmFyIEZVTkNUSU9OX1BST1RPVFlQRV9FWFRFTlNJT05TID0gISEnMy4xMS4wLWJldGEuMSc7CiAgX2V4cG9ydHMuRlVOQ1RJT05fUFJPVE9UWVBFX0VYVEVOU0lPTlMgPSBGVU5DVElPTl9QUk9UT1RZUEVfRVhURU5TSU9OUzsKICB2YXIgTU9VU0VfRU5URVJfTEVBVkVfTU9WRV9FVkVOVFMgPSAhISczLjEzLjAtYmV0YS4xJzsKICBfZXhwb3J0cy5NT1VTRV9FTlRFUl9MRUFWRV9NT1ZFX0VWRU5UUyA9IE1PVVNFX0VOVEVSX0xFQVZFX01PVkVfRVZFTlRTOwp9KTsKZGVmaW5lKCJAZW1iZXIvZW5naW5lL2luZGV4IiwgWyJleHBvcnRzIiwgImVtYmVyLWJhYmVsIiwgIkBlbWJlci9lbmdpbmUvbGliL2VuZ2luZS1wYXJlbnQiLCAiQGVtYmVyLy1pbnRlcm5hbHMvdXRpbHMiLCAiQGVtYmVyL2NvbnRyb2xsZXIiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZSIsICJAZW1iZXIvLWludGVybmFscy9jb250YWluZXIiLCAiZGFnLW1hcCIsICJAZW1iZXIvZGVidWciLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiLCAiQGVtYmVyL2FwcGxpY2F0aW9uL2dsb2JhbHMtcmVzb2x2ZXIiLCAiQGVtYmVyL2VuZ2luZS9pbnN0YW5jZSIsICJAZW1iZXIvLWludGVybmFscy9yb3V0aW5nIiwgIkBlbWJlci8taW50ZXJuYWxzL2V4dGVuc2lvbi1zdXBwb3J0IiwgIkBlbWJlci8taW50ZXJuYWxzL3ZpZXdzIiwgIkBlbWJlci8taW50ZXJuYWxzL2dsaW1tZXIiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZW1iZXJCYWJlbCwgX2VuZ2luZVBhcmVudCwgX3V0aWxzLCBfY29udHJvbGxlciwgX3J1bnRpbWUsIF9jb250YWluZXIsIF9kYWdNYXAsIF9kZWJ1ZywgX21ldGFsLCBfZ2xvYmFsc1Jlc29sdmVyLCBfaW5zdGFuY2UsIF9yb3V0aW5nLCBfZXh0ZW5zaW9uU3VwcG9ydCwgX3ZpZXdzLCBfZ2xpbW1lcikgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiZ2V0RW5naW5lUGFyZW50IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2VuZ2luZVBhcmVudC5nZXRFbmdpbmVQYXJlbnQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAic2V0RW5naW5lUGFyZW50IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2VuZ2luZVBhcmVudC5zZXRFbmdpbmVQYXJlbnQ7CiAgICB9CiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgZnVuY3Rpb24gX3RlbXBsYXRlT2JqZWN0MigpIHsKICAgIHZhciBkYXRhID0gKDAsIF9lbWJlckJhYmVsLnRhZ2dlZFRlbXBsYXRlTGl0ZXJhbExvb3NlKShbIi1idWNrZXQtY2FjaGU6bWFpbiJdKTsKCiAgICBfdGVtcGxhdGVPYmplY3QyID0gZnVuY3Rpb24gX3RlbXBsYXRlT2JqZWN0MigpIHsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwoKICAgIHJldHVybiBkYXRhOwogIH0KCiAgZnVuY3Rpb24gX3RlbXBsYXRlT2JqZWN0KCkgewogICAgdmFyIGRhdGEgPSAoMCwgX2VtYmVyQmFiZWwudGFnZ2VkVGVtcGxhdGVMaXRlcmFsTG9vc2UpKFsiLWJ1Y2tldC1jYWNoZTptYWluIl0pOwoKICAgIF90ZW1wbGF0ZU9iamVjdCA9IGZ1bmN0aW9uIF90ZW1wbGF0ZU9iamVjdCgpIHsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwoKICAgIHJldHVybiBkYXRhOwogIH0KCiAgZnVuY3Rpb24gcHJvcHMob2JqKSB7CiAgICB2YXIgcHJvcGVydGllcyA9IFtdOwoKICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgcHJvcGVydGllcy5wdXNoKGtleSk7CiAgICB9CgogICAgcmV0dXJuIHByb3BlcnRpZXM7CiAgfQogIC8qKgogIEBtb2R1bGUgQGVtYmVyL2VuZ2luZQogICovCgogIC8qKgogICAgVGhlIGBFbmdpbmVgIGNsYXNzIGNvbnRhaW5zIGNvcmUgZnVuY3Rpb25hbGl0eSBmb3IgYm90aCBhcHBsaWNhdGlvbnMgYW5kCiAgICBlbmdpbmVzLgogIAogICAgRWFjaCBlbmdpbmUgbWFuYWdlcyBhIHJlZ2lzdHJ5IHRoYXQncyB1c2VkIGZvciBkZXBlbmRlbmN5IGluamVjdGlvbiBhbmQKICAgIGV4cG9zZWQgdGhyb3VnaCBgUmVnaXN0cnlQcm94eWAuCiAgCiAgICBFbmdpbmVzIGFsc28gbWFuYWdlIGluaXRpYWxpemVycyBhbmQgaW5zdGFuY2UgaW5pdGlhbGl6ZXJzLgogIAogICAgRW5naW5lcyBjYW4gc3Bhd24gYEVuZ2luZUluc3RhbmNlYCBpbnN0YW5jZXMgdmlhIGBidWlsZEluc3RhbmNlKClgLgogIAogICAgQGNsYXNzIEVuZ2luZQogICAgQGV4dGVuZHMgRW1iZXIuTmFtZXNwYWNlCiAgICBAdXNlcyBSZWdpc3RyeVByb3h5CiAgICBAcHVibGljCiAgKi8KCgogIHZhciBFbmdpbmUgPSBfcnVudGltZS5OYW1lc3BhY2UuZXh0ZW5kKF9ydW50aW1lLlJlZ2lzdHJ5UHJveHlNaXhpbiwgewogICAgaW5pdDogZnVuY3Rpb24gaW5pdCgpIHsKICAgICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgIHRoaXMuYnVpbGRSZWdpc3RyeSgpOwogICAgfSwKCiAgICAvKioKICAgICAgQSBwcml2YXRlIGZsYWcgaW5kaWNhdGluZyB3aGV0aGVyIGFuIGVuZ2luZSdzIGluaXRpYWxpemVycyBoYXZlIHJ1biB5ZXQuCiAgICAgICBAcHJpdmF0ZQogICAgICBAcHJvcGVydHkgX2luaXRpYWxpemVyc1JhbgogICAgKi8KICAgIF9pbml0aWFsaXplcnNSYW46IGZhbHNlLAoKICAgIC8qKgogICAgICBFbnN1cmUgdGhhdCBpbml0aWFsaXplcnMgYXJlIHJ1biBvbmNlLCBhbmQgb25seSBvbmNlLCBwZXIgZW5naW5lLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBlbnN1cmVJbml0aWFsaXplcnMKICAgICovCiAgICBlbnN1cmVJbml0aWFsaXplcnM6IGZ1bmN0aW9uIGVuc3VyZUluaXRpYWxpemVycygpIHsKICAgICAgaWYgKCF0aGlzLl9pbml0aWFsaXplcnNSYW4pIHsKICAgICAgICB0aGlzLnJ1bkluaXRpYWxpemVycygpOwogICAgICAgIHRoaXMuX2luaXRpYWxpemVyc1JhbiA9IHRydWU7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgIENyZWF0ZSBhbiBFbmdpbmVJbnN0YW5jZSBmb3IgdGhpcyBlbmdpbmUuCiAgICAgICBAcHVibGljCiAgICAgIEBtZXRob2QgYnVpbGRJbnN0YW5jZQogICAgICBAcmV0dXJuIHtFbmdpbmVJbnN0YW5jZX0gdGhlIGVuZ2luZSBpbnN0YW5jZQogICAgKi8KICAgIGJ1aWxkSW5zdGFuY2U6IGZ1bmN0aW9uIGJ1aWxkSW5zdGFuY2Uob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICB0aGlzLmVuc3VyZUluaXRpYWxpemVycygpOwogICAgICBvcHRpb25zLmJhc2UgPSB0aGlzOwogICAgICByZXR1cm4gX2luc3RhbmNlLmRlZmF1bHQuY3JlYXRlKG9wdGlvbnMpOwogICAgfSwKCiAgICAvKioKICAgICAgQnVpbGQgYW5kIGNvbmZpZ3VyZSB0aGUgcmVnaXN0cnkgZm9yIHRoZSBjdXJyZW50IGVuZ2luZS4KICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgYnVpbGRSZWdpc3RyeQogICAgICBAcmV0dXJuIHtFbWJlci5SZWdpc3RyeX0gdGhlIGNvbmZpZ3VyZWQgcmVnaXN0cnkKICAgICovCiAgICBidWlsZFJlZ2lzdHJ5OiBmdW5jdGlvbiBidWlsZFJlZ2lzdHJ5KCkgewogICAgICB2YXIgcmVnaXN0cnkgPSB0aGlzLl9fcmVnaXN0cnlfXyA9IHRoaXMuY29uc3RydWN0b3IuYnVpbGRSZWdpc3RyeSh0aGlzKTsKICAgICAgcmV0dXJuIHJlZ2lzdHJ5OwogICAgfSwKCiAgICAvKioKICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBpbml0aWFsaXplcgogICAgKi8KICAgIGluaXRpYWxpemVyOiBmdW5jdGlvbiBpbml0aWFsaXplcihvcHRpb25zKSB7CiAgICAgIHRoaXMuY29uc3RydWN0b3IuaW5pdGlhbGl6ZXIob3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKgogICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIGluc3RhbmNlSW5pdGlhbGl6ZXIKICAgICovCiAgICBpbnN0YW5jZUluaXRpYWxpemVyOiBmdW5jdGlvbiBpbnN0YW5jZUluaXRpYWxpemVyKG9wdGlvbnMpIHsKICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5pbnN0YW5jZUluaXRpYWxpemVyKG9wdGlvbnMpOwogICAgfSwKCiAgICAvKioKICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBydW5Jbml0aWFsaXplcnMKICAgICovCiAgICBydW5Jbml0aWFsaXplcnM6IGZ1bmN0aW9uIHJ1bkluaXRpYWxpemVycygpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHRoaXMuX3J1bkluaXRpYWxpemVyKCdpbml0aWFsaXplcnMnLCBmdW5jdGlvbiAobmFtZSwgaW5pdGlhbGl6ZXIpIHsKICAgICAgICAoZmFsc2UgJiYgIShCb29sZWFuKGluaXRpYWxpemVyKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJObyBhcHBsaWNhdGlvbiBpbml0aWFsaXplciBuYW1lZCAnIiArIG5hbWUgKyAiJyIsIEJvb2xlYW4oaW5pdGlhbGl6ZXIpKSk7CiAgICAgICAgaW5pdGlhbGl6ZXIuaW5pdGlhbGl6ZShfdGhpcyk7CiAgICAgIH0pOwogICAgfSwKCiAgICAvKioKICAgICAgQHByaXZhdGUKICAgICAgQHNpbmNlIDEuMTIuMAogICAgICBAbWV0aG9kIHJ1bkluc3RhbmNlSW5pdGlhbGl6ZXJzCiAgICAqLwogICAgcnVuSW5zdGFuY2VJbml0aWFsaXplcnM6IGZ1bmN0aW9uIHJ1bkluc3RhbmNlSW5pdGlhbGl6ZXJzKGluc3RhbmNlKSB7CiAgICAgIHRoaXMuX3J1bkluaXRpYWxpemVyKCdpbnN0YW5jZUluaXRpYWxpemVycycsIGZ1bmN0aW9uIChuYW1lLCBpbml0aWFsaXplcikgewogICAgICAgIChmYWxzZSAmJiAhKEJvb2xlYW4oaW5pdGlhbGl6ZXIpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIk5vIGluc3RhbmNlIGluaXRpYWxpemVyIG5hbWVkICciICsgbmFtZSArICInIiwgQm9vbGVhbihpbml0aWFsaXplcikpKTsKICAgICAgICBpbml0aWFsaXplci5pbml0aWFsaXplKGluc3RhbmNlKTsKICAgICAgfSk7CiAgICB9LAogICAgX3J1bkluaXRpYWxpemVyOiBmdW5jdGlvbiBfcnVuSW5pdGlhbGl6ZXIoYnVja2V0TmFtZSwgY2IpIHsKICAgICAgdmFyIGluaXRpYWxpemVyc0J5TmFtZSA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLmNvbnN0cnVjdG9yLCBidWNrZXROYW1lKTsKICAgICAgdmFyIGluaXRpYWxpemVycyA9IHByb3BzKGluaXRpYWxpemVyc0J5TmFtZSk7CiAgICAgIHZhciBncmFwaCA9IG5ldyBfZGFnTWFwLmRlZmF1bHQoKTsKICAgICAgdmFyIGluaXRpYWxpemVyOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbml0aWFsaXplcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpbml0aWFsaXplciA9IGluaXRpYWxpemVyc0J5TmFtZVtpbml0aWFsaXplcnNbaV1dOwogICAgICAgIGdyYXBoLmFkZChpbml0aWFsaXplci5uYW1lLCBpbml0aWFsaXplciwgaW5pdGlhbGl6ZXIuYmVmb3JlLCBpbml0aWFsaXplci5hZnRlcik7CiAgICAgIH0KCiAgICAgIGdyYXBoLnRvcHNvcnQoY2IpOwogICAgfQogIH0pOwoKICBFbmdpbmUucmVvcGVuQ2xhc3MoewogICAgaW5pdGlhbGl6ZXJzOiBPYmplY3QuY3JlYXRlKG51bGwpLAogICAgaW5zdGFuY2VJbml0aWFsaXplcnM6IE9iamVjdC5jcmVhdGUobnVsbCksCgogICAgLyoqCiAgICAgIFRoZSBnb2FsIG9mIGluaXRpYWxpemVycyBzaG91bGQgYmUgdG8gcmVnaXN0ZXIgZGVwZW5kZW5jaWVzIGFuZCBpbmplY3Rpb25zLgogICAgICBUaGlzIHBoYXNlIHJ1bnMgb25jZS4gQmVjYXVzZSB0aGVzZSBpbml0aWFsaXplcnMgbWF5IGxvYWQgY29kZSwgdGhleSBhcmUKICAgICAgYWxsb3dlZCB0byBkZWZlciBhcHBsaWNhdGlvbiByZWFkaW5lc3MgYW5kIGFkdmFuY2UgaXQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcwogICAgICB0aGUgY29udGFpbmVyIG9yIHN0b3JlIHlvdSBzaG91bGQgdXNlIGFuIEluc3RhbmNlSW5pdGlhbGl6ZXIgdGhhdCB3aWxsIGJlIHJ1bgogICAgICBhZnRlciBhbGwgaW5pdGlhbGl6ZXJzIGFuZCB0aGVyZWZvcmUgYWZ0ZXIgYWxsIGNvZGUgaXMgbG9hZGVkIGFuZCB0aGUgYXBwIGlzCiAgICAgIHJlYWR5LgogICAgICAgSW5pdGlhbGl6ZXIgcmVjZWl2ZXMgYW4gb2JqZWN0IHdoaWNoIGhhcyB0aGUgZm9sbG93aW5nIGF0dHJpYnV0ZXM6CiAgICAgIGBuYW1lYCwgYGJlZm9yZWAsIGBhZnRlcmAsIGBpbml0aWFsaXplYC4gVGhlIG9ubHkgcmVxdWlyZWQgYXR0cmlidXRlIGlzCiAgICAgIGBpbml0aWFsaXplYCwgYWxsIG90aGVycyBhcmUgb3B0aW9uYWwuCiAgICAgICAqIGBuYW1lYCBhbGxvd3MgeW91IHRvIHNwZWNpZnkgdW5kZXIgd2hpY2ggbmFtZSB0aGUgaW5pdGlhbGl6ZXIgaXMgcmVnaXN0ZXJlZC4KICAgICAgVGhpcyBtdXN0IGJlIGEgdW5pcXVlIG5hbWUsIGFzIHRyeWluZyB0byByZWdpc3RlciB0d28gaW5pdGlhbGl6ZXJzIHdpdGggdGhlCiAgICAgIHNhbWUgbmFtZSB3aWxsIHJlc3VsdCBpbiBhbiBlcnJvci4KICAgICAgIGBgYGFwcC9pbml0aWFsaXplci9uYW1lZC1pbml0aWFsaXplci5qcwogICAgICBpbXBvcnQgeyBkZWJ1ZyB9IGZyb20gJ0BlbWJlci9kZWJ1Zyc7CiAgICAgICBleHBvcnQgZnVuY3Rpb24gaW5pdGlhbGl6ZSgpIHsKICAgICAgICBkZWJ1ZygnUnVubmluZyBuYW1lZEluaXRpYWxpemVyIScpOwogICAgICB9CiAgICAgICBleHBvcnQgZGVmYXVsdCB7CiAgICAgICAgbmFtZTogJ25hbWVkLWluaXRpYWxpemVyJywKICAgICAgICBpbml0aWFsaXplCiAgICAgIH07CiAgICAgIGBgYAogICAgICAgKiBgYmVmb3JlYCBhbmQgYGFmdGVyYCBhcmUgdXNlZCB0byBlbnN1cmUgdGhhdCB0aGlzIGluaXRpYWxpemVyIGlzIHJhbiBwcmlvcgogICAgICBvciBhZnRlciB0aGUgb25lIGlkZW50aWZpZWQgYnkgdGhlIHZhbHVlLiBUaGlzIHZhbHVlIGNhbiBiZSBhIHNpbmdsZSBzdHJpbmcKICAgICAgb3IgYW4gYXJyYXkgb2Ygc3RyaW5ncywgcmVmZXJlbmNpbmcgdGhlIGBuYW1lYCBvZiBvdGhlciBpbml0aWFsaXplcnMuCiAgICAgICBBbiBleGFtcGxlIG9mIG9yZGVyaW5nIGluaXRpYWxpemVycywgd2UgY3JlYXRlIGFuIGluaXRpYWxpemVyIG5hbWVkIGBmaXJzdGA6CiAgICAgICBgYGBhcHAvaW5pdGlhbGl6ZXIvZmlyc3QuanMKICAgICAgaW1wb3J0IHsgZGVidWcgfSBmcm9tICdAZW1iZXIvZGVidWcnOwogICAgICAgZXhwb3J0IGZ1bmN0aW9uIGluaXRpYWxpemUoKSB7CiAgICAgICAgZGVidWcoJ0ZpcnN0IGluaXRpYWxpemVyIScpOwogICAgICB9CiAgICAgICBleHBvcnQgZGVmYXVsdCB7CiAgICAgICAgbmFtZTogJ2ZpcnN0JywKICAgICAgICBpbml0aWFsaXplCiAgICAgIH07CiAgICAgIGBgYAogICAgICAgYGBgYmFzaAogICAgICAvLyBERUJVRzogRmlyc3QgaW5pdGlhbGl6ZXIhCiAgICAgIGBgYAogICAgICAgV2UgYWRkIGFub3RoZXIgaW5pdGlhbGl6ZXIgbmFtZWQgYHNlY29uZGAsIHNwZWNpZnlpbmcgdGhhdCBpdCBzaG91bGQgcnVuCiAgICAgIGFmdGVyIHRoZSBpbml0aWFsaXplciBuYW1lZCBgZmlyc3RgOgogICAgICAgYGBgYXBwL2luaXRpYWxpemVyL3NlY29uZC5qcwogICAgICBpbXBvcnQgeyBkZWJ1ZyB9IGZyb20gJ0BlbWJlci9kZWJ1Zyc7CiAgICAgICBleHBvcnQgZnVuY3Rpb24gaW5pdGlhbGl6ZSgpIHsKICAgICAgICBkZWJ1ZygnU2Vjb25kIGluaXRpYWxpemVyIScpOwogICAgICB9CiAgICAgICBleHBvcnQgZGVmYXVsdCB7CiAgICAgICAgbmFtZTogJ3NlY29uZCcsCiAgICAgICAgYWZ0ZXI6ICdmaXJzdCcsCiAgICAgICAgaW5pdGlhbGl6ZQogICAgICB9OwogICAgICBgYGAKICAgICAgIGBgYAogICAgICAvLyBERUJVRzogRmlyc3QgaW5pdGlhbGl6ZXIhCiAgICAgIC8vIERFQlVHOiBTZWNvbmQgaW5pdGlhbGl6ZXIhCiAgICAgIGBgYAogICAgICAgQWZ0ZXJ3YXJkcyB3ZSBhZGQgYSBmdXJ0aGVyIGluaXRpYWxpemVyIG5hbWVkIGBwcmVgLCB0aGlzIHRpbWUgc3BlY2lmeWluZwogICAgICB0aGF0IGl0IHNob3VsZCBydW4gYmVmb3JlIHRoZSBpbml0aWFsaXplciBuYW1lZCBgZmlyc3RgOgogICAgICAgYGBgYXBwL2luaXRpYWxpemVyL3ByZS5qcwogICAgICBpbXBvcnQgeyBkZWJ1ZyB9IGZyb20gJ0BlbWJlci9kZWJ1Zyc7CiAgICAgICBleHBvcnQgZnVuY3Rpb24gaW5pdGlhbGl6ZSgpIHsKICAgICAgICBkZWJ1ZygnUHJlIGluaXRpYWxpemVyIScpOwogICAgICB9CiAgICAgICBleHBvcnQgZGVmYXVsdCB7CiAgICAgICAgbmFtZTogJ3ByZScsCiAgICAgICAgYmVmb3JlOiAnZmlyc3QnLAogICAgICAgIGluaXRpYWxpemUKICAgICAgfTsKICAgICAgYGBgCiAgICAgICBgYGBiYXNoCiAgICAgIC8vIERFQlVHOiBQcmUgaW5pdGlhbGl6ZXIhCiAgICAgIC8vIERFQlVHOiBGaXJzdCBpbml0aWFsaXplciEKICAgICAgLy8gREVCVUc6IFNlY29uZCBpbml0aWFsaXplciEKICAgICAgYGBgCiAgICAgICBGaW5hbGx5IHdlIGFkZCBhbiBpbml0aWFsaXplciBuYW1lZCBgcG9zdGAsIHNwZWNpZnlpbmcgaXQgc2hvdWxkIHJ1biBhZnRlcgogICAgICBib3RoIHRoZSBgZmlyc3RgIGFuZCB0aGUgYHNlY29uZGAgaW5pdGlhbGl6ZXJzOgogICAgICAgYGBgYXBwL2luaXRpYWxpemVyL3Bvc3QuanMKICAgICAgaW1wb3J0IHsgZGVidWcgfSBmcm9tICdAZW1iZXIvZGVidWcnOwogICAgICAgZXhwb3J0IGZ1bmN0aW9uIGluaXRpYWxpemUoKSB7CiAgICAgICAgZGVidWcoJ1Bvc3QgaW5pdGlhbGl6ZXIhJyk7CiAgICAgIH0KICAgICAgIGV4cG9ydCBkZWZhdWx0IHsKICAgICAgICBuYW1lOiAncG9zdCcsCiAgICAgICAgYWZ0ZXI6IFsnZmlyc3QnLCAnc2Vjb25kJ10sCiAgICAgICAgaW5pdGlhbGl6ZQogICAgICB9OwogICAgICBgYGAKICAgICAgIGBgYGJhc2gKICAgICAgLy8gREVCVUc6IFByZSBpbml0aWFsaXplciEKICAgICAgLy8gREVCVUc6IEZpcnN0IGluaXRpYWxpemVyIQogICAgICAvLyBERUJVRzogU2Vjb25kIGluaXRpYWxpemVyIQogICAgICAvLyBERUJVRzogUG9zdCBpbml0aWFsaXplciEKICAgICAgYGBgCiAgICAgICAqIGBpbml0aWFsaXplYCBpcyBhIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgcmVjZWl2ZXMgb25lIGFyZ3VtZW50LAogICAgICAgIGBhcHBsaWNhdGlvbmAsIG9uIHdoaWNoIHlvdSBjYW4gb3BlcmF0ZS4KICAgICAgIEV4YW1wbGUgb2YgdXNpbmcgYGFwcGxpY2F0aW9uYCB0byByZWdpc3RlciBhbiBhZGFwdGVyOgogICAgICAgYGBgYXBwL2luaXRpYWxpemVyL2FwaS1hZGFwdGVyLmpzCiAgICAgIGltcG9ydCBBcGlBZGFwdGVyIGZyb20gJy4uL3V0aWxzL2FwaS1hZGFwdGVyJzsKICAgICAgIGV4cG9ydCBmdW5jdGlvbiBpbml0aWFsaXplKGFwcGxpY2F0aW9uKSB7CiAgICAgICAgYXBwbGljYXRpb24ucmVnaXN0ZXIoJ2FwaS1hZGFwdGVyOm1haW4nLCBBcGlBZGFwdGVyKTsKICAgICAgfQogICAgICAgZXhwb3J0IGRlZmF1bHQgewogICAgICAgIG5hbWU6ICdwb3N0JywKICAgICAgICBhZnRlcjogWydmaXJzdCcsICdzZWNvbmQnXSwKICAgICAgICBpbml0aWFsaXplCiAgICAgIH07CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBpbml0aWFsaXplcgogICAgICBAcGFyYW0gaW5pdGlhbGl6ZXIge09iamVjdH0KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGluaXRpYWxpemVyOiBidWlsZEluaXRpYWxpemVyTWV0aG9kKCdpbml0aWFsaXplcnMnLCAnaW5pdGlhbGl6ZXInKSwKCiAgICAvKioKICAgICAgSW5zdGFuY2UgaW5pdGlhbGl6ZXJzIHJ1biBhZnRlciBhbGwgaW5pdGlhbGl6ZXJzIGhhdmUgcnVuLiBCZWNhdXNlCiAgICAgIGluc3RhbmNlIGluaXRpYWxpemVycyBydW4gYWZ0ZXIgdGhlIGFwcCBpcyBmdWxseSBzZXQgdXAuIFdlIGhhdmUgYWNjZXNzCiAgICAgIHRvIHRoZSBzdG9yZSwgY29udGFpbmVyLCBhbmQgb3RoZXIgaXRlbXMuIEhvd2V2ZXIsIHRoZXNlIGluaXRpYWxpemVycyBydW4KICAgICAgYWZ0ZXIgY29kZSBoYXMgbG9hZGVkIGFuZCBhcmUgbm90IGFsbG93ZWQgdG8gZGVmZXIgcmVhZGluZXNzLgogICAgICAgSW5zdGFuY2UgaW5pdGlhbGl6ZXIgcmVjZWl2ZXMgYW4gb2JqZWN0IHdoaWNoIGhhcyB0aGUgZm9sbG93aW5nIGF0dHJpYnV0ZXM6CiAgICAgIGBuYW1lYCwgYGJlZm9yZWAsIGBhZnRlcmAsIGBpbml0aWFsaXplYC4gVGhlIG9ubHkgcmVxdWlyZWQgYXR0cmlidXRlIGlzCiAgICAgIGBpbml0aWFsaXplYCwgYWxsIG90aGVycyBhcmUgb3B0aW9uYWwuCiAgICAgICAqIGBuYW1lYCBhbGxvd3MgeW91IHRvIHNwZWNpZnkgdW5kZXIgd2hpY2ggbmFtZSB0aGUgaW5zdGFuY2VJbml0aWFsaXplciBpcwogICAgICByZWdpc3RlcmVkLiBUaGlzIG11c3QgYmUgYSB1bmlxdWUgbmFtZSwgYXMgdHJ5aW5nIHRvIHJlZ2lzdGVyIHR3bwogICAgICBpbnN0YW5jZUluaXRpYWxpemVyIHdpdGggdGhlIHNhbWUgbmFtZSB3aWxsIHJlc3VsdCBpbiBhbiBlcnJvci4KICAgICAgIGBgYGFwcC9pbml0aWFsaXplci9uYW1lZC1pbnN0YW5jZS1pbml0aWFsaXplci5qcwogICAgICBpbXBvcnQgeyBkZWJ1ZyB9IGZyb20gJ0BlbWJlci9kZWJ1Zyc7CiAgICAgICBleHBvcnQgZnVuY3Rpb24gaW5pdGlhbGl6ZSgpIHsKICAgICAgICBkZWJ1ZygnUnVubmluZyBuYW1lZC1pbnN0YW5jZS1pbml0aWFsaXplciEnKTsKICAgICAgfQogICAgICAgZXhwb3J0IGRlZmF1bHQgewogICAgICAgIG5hbWU6ICduYW1lZC1pbnN0YW5jZS1pbml0aWFsaXplcicsCiAgICAgICAgaW5pdGlhbGl6ZQogICAgICB9OwogICAgICBgYGAKICAgICAgICogYGJlZm9yZWAgYW5kIGBhZnRlcmAgYXJlIHVzZWQgdG8gZW5zdXJlIHRoYXQgdGhpcyBpbml0aWFsaXplciBpcyByYW4gcHJpb3IKICAgICAgb3IgYWZ0ZXIgdGhlIG9uZSBpZGVudGlmaWVkIGJ5IHRoZSB2YWx1ZS4gVGhpcyB2YWx1ZSBjYW4gYmUgYSBzaW5nbGUgc3RyaW5nCiAgICAgIG9yIGFuIGFycmF5IG9mIHN0cmluZ3MsIHJlZmVyZW5jaW5nIHRoZSBgbmFtZWAgb2Ygb3RoZXIgaW5pdGlhbGl6ZXJzLgogICAgICAgKiBTZWUgQXBwbGljYXRpb24uaW5pdGlhbGl6ZXIgZm9yIGRpc2N1c3Npb24gb24gdGhlIHVzYWdlIG9mIGJlZm9yZQogICAgICBhbmQgYWZ0ZXIuCiAgICAgICBFeGFtcGxlIGluc3RhbmNlSW5pdGlhbGl6ZXIgdG8gcHJlbG9hZCBkYXRhIGludG8gdGhlIHN0b3JlLgogICAgICAgYGBgYXBwL2luaXRpYWxpemVyL3ByZWxvYWQtZGF0YS5qcwogICAgICBpbXBvcnQgJCBmcm9tICdqcXVlcnknOwogICAgICAgZXhwb3J0IGZ1bmN0aW9uIGluaXRpYWxpemUoYXBwbGljYXRpb24pIHsKICAgICAgICAgIHZhciB1c2VyQ29uZmlnLCB1c2VyQ29uZmlnRW5jb2RlZCwgc3RvcmU7CiAgICAgICAgICAvLyBXZSBoYXZlIGEgSFRNTCBlc2NhcGVkIEpTT04gcmVwcmVzZW50YXRpb24gb2YgdGhlIHVzZXIncyBiYXNpYwogICAgICAgICAgLy8gY29uZmlndXJhdGlvbiBnZW5lcmF0ZWQgc2VydmVyIHNpZGUgYW5kIHN0b3JlZCBpbiB0aGUgRE9NIG9mIHRoZSBtYWluCiAgICAgICAgICAvLyBpbmRleC5odG1sIGZpbGUuIFRoaXMgYWxsb3dzIHRoZSBhcHAgdG8gaGF2ZSBhY2Nlc3MgdG8gYSBzZXQgb2YgZGF0YQogICAgICAgICAgLy8gd2l0aG91dCBtYWtpbmcgYW55IGFkZGl0aW9uYWwgcmVtb3RlIGNhbGxzLiBHb29kIGZvciBiYXNpYyBkYXRhIHRoYXQgaXMKICAgICAgICAgIC8vIG5lZWRlZCBmb3IgaW1tZWRpYXRlIHJlbmRlcmluZyBvZiB0aGUgcGFnZS4gS2VlcCBpbiBtaW5kLCB0aGlzIGRhdGEsCiAgICAgICAgICAvLyBsaWtlIGFsbCBsb2NhbCBtb2RlbHMgYW5kIGRhdGEgY2FuIGJlIG1hbmlwdWxhdGVkIGJ5IHRoZSB1c2VyLCBzbyBpdAogICAgICAgICAgLy8gc2hvdWxkIG5vdCBiZSByZWxpZWQgdXBvbiBmb3Igc2VjdXJpdHkgb3IgYXV0aG9yaXphdGlvbi4KICAgICAgICAgICAvLyBHcmFiIHRoZSBlbmNvZGVkIGRhdGEgZnJvbSB0aGUgbWV0YSB0YWcKICAgICAgICAgIHVzZXJDb25maWdFbmNvZGVkID0gJCgnaGVhZCBtZXRhW25hbWU9YXBwLXVzZXItY29uZmlnXScpLmF0dHIoJ2NvbnRlbnQnKTsKICAgICAgICAgICAvLyBVbmVzY2FwZSB0aGUgdGV4dCwgdGhlbiBwYXJzZSB0aGUgcmVzdWx0aW5nIEpTT04gaW50byBhIHJlYWwgb2JqZWN0CiAgICAgICAgICB1c2VyQ29uZmlnID0gSlNPTi5wYXJzZSh1bmVzY2FwZSh1c2VyQ29uZmlnRW5jb2RlZCkpOwogICAgICAgICAgIC8vIExvb2t1cCB0aGUgc3RvcmUKICAgICAgICAgIHN0b3JlID0gYXBwbGljYXRpb24ubG9va3VwKCdzZXJ2aWNlOnN0b3JlJyk7CiAgICAgICAgICAgLy8gUHVzaCB0aGUgZW5jb2RlZCBKU09OIGludG8gdGhlIHN0b3JlCiAgICAgICAgICBzdG9yZS5wdXNoUGF5bG9hZCh1c2VyQ29uZmlnKTsKICAgICAgfQogICAgICAgZXhwb3J0IGRlZmF1bHQgewogICAgICAgIG5hbWU6ICduYW1lZC1pbnN0YW5jZS1pbml0aWFsaXplcicsCiAgICAgICAgaW5pdGlhbGl6ZQogICAgICB9OwogICAgICBgYGAKICAgICAgIEBtZXRob2QgaW5zdGFuY2VJbml0aWFsaXplcgogICAgICBAcGFyYW0gaW5zdGFuY2VJbml0aWFsaXplcgogICAgICBAcHVibGljCiAgICAqLwogICAgaW5zdGFuY2VJbml0aWFsaXplcjogYnVpbGRJbml0aWFsaXplck1ldGhvZCgnaW5zdGFuY2VJbml0aWFsaXplcnMnLCAnaW5zdGFuY2UgaW5pdGlhbGl6ZXInKSwKCiAgICAvKioKICAgICAgVGhpcyBjcmVhdGVzIGEgcmVnaXN0cnkgd2l0aCB0aGUgZGVmYXVsdCBFbWJlciBuYW1pbmcgY29udmVudGlvbnMuCiAgICAgICBJdCBhbHNvIGNvbmZpZ3VyZXMgdGhlIHJlZ2lzdHJ5OgogICAgICAgKiByZWdpc3RlcmVkIHZpZXdzIGFyZSBjcmVhdGVkIGV2ZXJ5IHRpbWUgdGhleSBhcmUgbG9va2VkIHVwICh0aGV5IGFyZQogICAgICAgIG5vdCBzaW5nbGV0b25zKQogICAgICAqIHJlZ2lzdGVyZWQgdGVtcGxhdGVzIGFyZSBub3QgZmFjdG9yaWVzOyB0aGUgcmVnaXN0ZXJlZCB2YWx1ZSBpcwogICAgICAgIHJldHVybmVkIGRpcmVjdGx5LgogICAgICAqIHRoZSByb3V0ZXIgcmVjZWl2ZXMgdGhlIGFwcGxpY2F0aW9uIGFzIGl0cyBgbmFtZXNwYWNlYCBwcm9wZXJ0eQogICAgICAqIGFsbCBjb250cm9sbGVycyByZWNlaXZlIHRoZSByb3V0ZXIgYXMgdGhlaXIgYHRhcmdldGAgYW5kIGBjb250cm9sbGVyc2AKICAgICAgICBwcm9wZXJ0aWVzCiAgICAgICogYWxsIGNvbnRyb2xsZXJzIHJlY2VpdmUgdGhlIGFwcGxpY2F0aW9uIGFzIHRoZWlyIGBuYW1lc3BhY2VgIHByb3BlcnR5CiAgICAgICogdGhlIGFwcGxpY2F0aW9uIHZpZXcgcmVjZWl2ZXMgdGhlIGFwcGxpY2F0aW9uIGNvbnRyb2xsZXIgYXMgaXRzCiAgICAgICAgYGNvbnRyb2xsZXJgIHByb3BlcnR5CiAgICAgICogdGhlIGFwcGxpY2F0aW9uIHZpZXcgcmVjZWl2ZXMgdGhlIGFwcGxpY2F0aW9uIHRlbXBsYXRlIGFzIGl0cwogICAgICAgIGBkZWZhdWx0VGVtcGxhdGVgIHByb3BlcnR5CiAgICAgICBAbWV0aG9kIGJ1aWxkUmVnaXN0cnkKICAgICAgQHN0YXRpYwogICAgICBAcGFyYW0ge0FwcGxpY2F0aW9ufSBuYW1lc3BhY2UgdGhlIGFwcGxpY2F0aW9uIGZvciB3aGljaCB0bwogICAgICAgIGJ1aWxkIHRoZSByZWdpc3RyeQogICAgICBAcmV0dXJuIHtFbWJlci5SZWdpc3RyeX0gdGhlIGJ1aWx0IHJlZ2lzdHJ5CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgYnVpbGRSZWdpc3RyeTogZnVuY3Rpb24gYnVpbGRSZWdpc3RyeShuYW1lc3BhY2UpIHsKICAgICAgdmFyIHJlZ2lzdHJ5ID0gbmV3IF9jb250YWluZXIuUmVnaXN0cnkoewogICAgICAgIHJlc29sdmVyOiByZXNvbHZlckZvcihuYW1lc3BhY2UpCiAgICAgIH0pOwogICAgICByZWdpc3RyeS5zZXQgPSBfbWV0YWwuc2V0OwogICAgICByZWdpc3RyeS5yZWdpc3RlcignYXBwbGljYXRpb246bWFpbicsIG5hbWVzcGFjZSwgewogICAgICAgIGluc3RhbnRpYXRlOiBmYWxzZQogICAgICB9KTsKICAgICAgY29tbW9uU2V0dXBSZWdpc3RyeShyZWdpc3RyeSk7CiAgICAgICgwLCBfZ2xpbW1lci5zZXR1cEVuZ2luZVJlZ2lzdHJ5KShyZWdpc3RyeSk7CiAgICAgIHJldHVybiByZWdpc3RyeTsKICAgIH0sCgogICAgLyoqCiAgICAgIFNldCB0aGlzIHRvIHByb3ZpZGUgYW4gYWx0ZXJuYXRlIGNsYXNzIHRvIGBEZWZhdWx0UmVzb2x2ZXJgCiAgICAgICBAZGVwcmVjYXRlZCBVc2UgJ1Jlc29sdmVyJyBpbnN0ZWFkCiAgICAgIEBwcm9wZXJ0eSByZXNvbHZlcgogICAgICBAcHVibGljCiAgICAqLwogICAgcmVzb2x2ZXI6IG51bGwsCgogICAgLyoqCiAgICAgIFNldCB0aGlzIHRvIHByb3ZpZGUgYW4gYWx0ZXJuYXRlIGNsYXNzIHRvIGBEZWZhdWx0UmVzb2x2ZXJgCiAgICAgICBAcHJvcGVydHkgcmVzb2x2ZXIKICAgICAgQHB1YmxpYwogICAgKi8KICAgIFJlc29sdmVyOiBudWxsCiAgfSk7CiAgLyoqCiAgICBUaGlzIGZ1bmN0aW9uIGRlZmluZXMgdGhlIGRlZmF1bHQgbG9va3VwIHJ1bGVzIGZvciBjb250YWluZXIgbG9va3VwczoKICAKICAgICogdGVtcGxhdGVzIGFyZSBsb29rZWQgdXAgb24gYEVtYmVyLlRFTVBMQVRFU2AKICAgICogb3RoZXIgbmFtZXMgYXJlIGxvb2tlZCB1cCBvbiB0aGUgYXBwbGljYXRpb24gYWZ0ZXIgY2xhc3NpZnlpbmcgdGhlIG5hbWUuCiAgICAgIEZvciBleGFtcGxlLCBgY29udHJvbGxlcjpwb3N0YCBsb29rcyB1cCBgQXBwLlBvc3RDb250cm9sbGVyYCBieSBkZWZhdWx0LgogICAgKiBpZiB0aGUgZGVmYXVsdCBsb29rdXAgZmFpbHMsIGxvb2sgZm9yIHJlZ2lzdGVyZWQgY2xhc3NlcyBvbiB0aGUgY29udGFpbmVyCiAgCiAgICBUaGlzIGFsbG93cyB0aGUgYXBwbGljYXRpb24gdG8gcmVnaXN0ZXIgZGVmYXVsdCBpbmplY3Rpb25zIGluIHRoZSBjb250YWluZXIKICAgIHRoYXQgY291bGQgYmUgb3ZlcnJpZGRlbiBieSB0aGUgbm9ybWFsIG5hbWluZyBjb252ZW50aW9uLgogIAogICAgQHByaXZhdGUKICAgIEBtZXRob2QgcmVzb2x2ZXJGb3IKICAgIEBwYXJhbSB7RW1iZXIuTmFtZXNwYWNlfSBuYW1lc3BhY2UgdGhlIG5hbWVzcGFjZSB0byBsb29rIGZvciBjbGFzc2VzCiAgICBAcmV0dXJuIHsqfSB0aGUgcmVzb2x2ZWQgdmFsdWUgZm9yIGEgZ2l2ZW4gbG9va3VwCiAgKi8KCiAgZnVuY3Rpb24gcmVzb2x2ZXJGb3IobmFtZXNwYWNlKSB7CiAgICB2YXIgUmVzb2x2ZXJDbGFzcyA9ICgwLCBfbWV0YWwuZ2V0KShuYW1lc3BhY2UsICdSZXNvbHZlcicpIHx8IF9nbG9iYWxzUmVzb2x2ZXIuZGVmYXVsdDsKCiAgICB2YXIgcHJvcHMgPSB7CiAgICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlCiAgICB9OwogICAgcmV0dXJuIFJlc29sdmVyQ2xhc3MuY3JlYXRlKHByb3BzKTsKICB9CgogIGZ1bmN0aW9uIGJ1aWxkSW5pdGlhbGl6ZXJNZXRob2QoYnVja2V0TmFtZSwgaHVtYW5OYW1lKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKGluaXRpYWxpemVyKSB7CiAgICAgIC8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IGluaXRpYWxpemVyIGJlaW5nIGFkZGVkIHRvIGEgc3ViY2xhc3MsIHdlIGFyZSBnb2luZyB0byByZW9wZW4gdGhlIGNsYXNzCiAgICAgIC8vIHRvIG1ha2Ugc3VyZSB3ZSBoYXZlIGEgbmV3IGBpbml0aWFsaXplcnNgIG9iamVjdCwgd2hpY2ggZXh0ZW5kcyBmcm9tIHRoZSBwYXJlbnQgY2xhc3MnIHVzaW5nCiAgICAgIC8vIHByb3RvdHlwYWwgaW5oZXJpdGFuY2UuIFdpdGhvdXQgdGhpcywgYXR0ZW1wdGluZyB0byBhZGQgaW5pdGlhbGl6ZXJzIHRvIHRoZSBzdWJjbGFzcyB3b3VsZAogICAgICAvLyBwb2xsdXRlIHRoZSBwYXJlbnQgY2xhc3MgYXMgd2VsbCBhcyBvdGhlciBzdWJjbGFzc2VzLgogICAgICBpZiAodGhpcy5zdXBlcmNsYXNzW2J1Y2tldE5hbWVdICE9PSB1bmRlZmluZWQgJiYgdGhpcy5zdXBlcmNsYXNzW2J1Y2tldE5hbWVdID09PSB0aGlzW2J1Y2tldE5hbWVdKSB7CiAgICAgICAgdmFyIGF0dHJzID0ge307CiAgICAgICAgYXR0cnNbYnVja2V0TmFtZV0gPSBPYmplY3QuY3JlYXRlKHRoaXNbYnVja2V0TmFtZV0pOwogICAgICAgIHRoaXMucmVvcGVuQ2xhc3MoYXR0cnMpOwogICAgICB9CgogICAgICAoZmFsc2UgJiYgISghdGhpc1tidWNrZXROYW1lXVtpbml0aWFsaXplci5uYW1lXSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJUaGUgIiArIGh1bWFuTmFtZSArICIgJyIgKyBpbml0aWFsaXplci5uYW1lICsgIicgaGFzIGFscmVhZHkgYmVlbiByZWdpc3RlcmVkIiwgIXRoaXNbYnVja2V0TmFtZV1baW5pdGlhbGl6ZXIubmFtZV0pKTsKICAgICAgKGZhbHNlICYmICEoKDAsIF91dGlscy5jYW5JbnZva2UpKGluaXRpYWxpemVyLCAnaW5pdGlhbGl6ZScpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkFuICIgKyBodW1hbk5hbWUgKyAiIGNhbm5vdCBiZSByZWdpc3RlcmVkIHdpdGhvdXQgYW4gaW5pdGlhbGl6ZSBmdW5jdGlvbiIsICgwLCBfdXRpbHMuY2FuSW52b2tlKShpbml0aWFsaXplciwgJ2luaXRpYWxpemUnKSkpOwogICAgICAoZmFsc2UgJiYgIShpbml0aWFsaXplci5uYW1lICE9PSB1bmRlZmluZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQW4gIiArIGh1bWFuTmFtZSArICIgY2Fubm90IGJlIHJlZ2lzdGVyZWQgd2l0aG91dCBhIG5hbWUgcHJvcGVydHkiLCBpbml0aWFsaXplci5uYW1lICE9PSB1bmRlZmluZWQpKTsKICAgICAgdGhpc1tidWNrZXROYW1lXVtpbml0aWFsaXplci5uYW1lXSA9IGluaXRpYWxpemVyOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIGNvbW1vblNldHVwUmVnaXN0cnkocmVnaXN0cnkpIHsKICAgIHJlZ2lzdHJ5Lm9wdGlvbnNGb3JUeXBlKCdjb21wb25lbnQnLCB7CiAgICAgIHNpbmdsZXRvbjogZmFsc2UKICAgIH0pOwogICAgcmVnaXN0cnkub3B0aW9uc0ZvclR5cGUoJ3ZpZXcnLCB7CiAgICAgIHNpbmdsZXRvbjogZmFsc2UKICAgIH0pOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2NvbnRyb2xsZXI6YmFzaWMnLCBfY29udHJvbGxlci5kZWZhdWx0LCB7CiAgICAgIGluc3RhbnRpYXRlOiBmYWxzZQogICAgfSk7CiAgICByZWdpc3RyeS5pbmplY3Rpb24oJ3ZpZXcnLCAnX3ZpZXdSZWdpc3RyeScsICctdmlldy1yZWdpc3RyeTptYWluJyk7CiAgICByZWdpc3RyeS5pbmplY3Rpb24oJ3JlbmRlcmVyJywgJ192aWV3UmVnaXN0cnknLCAnLXZpZXctcmVnaXN0cnk6bWFpbicpOwogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdyb3V0ZScsICdfdG9wTGV2ZWxWaWV3VGVtcGxhdGUnLCAndGVtcGxhdGU6LW91dGxldCcpOwogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCd2aWV3Oi1vdXRsZXQnLCAnbmFtZXNwYWNlJywgJ2FwcGxpY2F0aW9uOm1haW4nKTsKICAgIHJlZ2lzdHJ5LmluamVjdGlvbignY29udHJvbGxlcicsICd0YXJnZXQnLCAncm91dGVyOm1haW4nKTsKICAgIHJlZ2lzdHJ5LmluamVjdGlvbignY29udHJvbGxlcicsICduYW1lc3BhY2UnLCAnYXBwbGljYXRpb246bWFpbicpOwogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdyb3V0ZXInLCAnX2J1Y2tldENhY2hlJywgKDAsIF9jb250YWluZXIucHJpdmF0aXplKShfdGVtcGxhdGVPYmplY3QoKSkpOwogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdyb3V0ZScsICdfYnVja2V0Q2FjaGUnLCAoMCwgX2NvbnRhaW5lci5wcml2YXRpemUpKF90ZW1wbGF0ZU9iamVjdDIoKSkpOwogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdyb3V0ZScsICdfcm91dGVyJywgJ3JvdXRlcjptYWluJyk7IC8vIFJlZ2lzdGVyIHRoZSByb3V0aW5nIHNlcnZpY2UuLi4KCiAgICByZWdpc3RyeS5yZWdpc3Rlcignc2VydmljZTotcm91dGluZycsIF9yb3V0aW5nLlJvdXRpbmdTZXJ2aWNlKTsgLy8gVGhlbiBpbmplY3QgdGhlIGFwcCByb3V0ZXIgaW50byBpdAoKICAgIHJlZ2lzdHJ5LmluamVjdGlvbignc2VydmljZTotcm91dGluZycsICdyb3V0ZXInLCAncm91dGVyOm1haW4nKTsgLy8gREVCVUdHSU5HCgogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3Jlc29sdmVyLWZvci1kZWJ1Z2dpbmc6bWFpbicsIHJlZ2lzdHJ5LnJlc29sdmVyLCB7CiAgICAgIGluc3RhbnRpYXRlOiBmYWxzZQogICAgfSk7CiAgICByZWdpc3RyeS5pbmplY3Rpb24oJ2NvbnRhaW5lci1kZWJ1Zy1hZGFwdGVyOm1haW4nLCAncmVzb2x2ZXInLCAncmVzb2x2ZXItZm9yLWRlYnVnZ2luZzptYWluJyk7CiAgICByZWdpc3RyeS5pbmplY3Rpb24oJ2RhdGEtYWRhcHRlcjptYWluJywgJ2NvbnRhaW5lckRlYnVnQWRhcHRlcicsICdjb250YWluZXItZGVidWctYWRhcHRlcjptYWluJyk7IC8vIEN1c3RvbSByZXNvbHZlciBhdXRob3JzIG1heSB3YW50IHRvIHJlZ2lzdGVyIHRoZWlyIG93biBDb250YWluZXJEZWJ1Z0FkYXB0ZXIgd2l0aCB0aGlzIGtleQoKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdjb250YWluZXItZGVidWctYWRhcHRlcjptYWluJywgX2V4dGVuc2lvblN1cHBvcnQuQ29udGFpbmVyRGVidWdBZGFwdGVyKTsKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdjb21wb25lbnQtbG9va3VwOm1haW4nLCBfdmlld3MuQ29tcG9uZW50TG9va3VwKTsKICB9CgogIHZhciBfZGVmYXVsdCA9IEVuZ2luZTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci9lbmdpbmUvaW5zdGFuY2UiLCBbImV4cG9ydHMiLCAiZW1iZXItYmFiZWwiLCAiQGVtYmVyLy1pbnRlcm5hbHMvdXRpbHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZSIsICJAZW1iZXIvZGVidWciLCAiQGVtYmVyL2Vycm9yIiwgIkBlbWJlci8taW50ZXJuYWxzL2NvbnRhaW5lciIsICJAZW1iZXIvZW5naW5lL2xpYi9lbmdpbmUtcGFyZW50Il0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2VtYmVyQmFiZWwsIF91dGlscywgX3J1bnRpbWUsIF9kZWJ1ZywgX2Vycm9yLCBfY29udGFpbmVyLCBfZW5naW5lUGFyZW50KSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICBmdW5jdGlvbiBfdGVtcGxhdGVPYmplY3QyKCkgewogICAgdmFyIGRhdGEgPSAoMCwgX2VtYmVyQmFiZWwudGFnZ2VkVGVtcGxhdGVMaXRlcmFsTG9vc2UpKFsidGVtcGxhdGUtY29tcGlsZXI6bWFpbiJdKTsKCiAgICBfdGVtcGxhdGVPYmplY3QyID0gZnVuY3Rpb24gX3RlbXBsYXRlT2JqZWN0MigpIHsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwoKICAgIHJldHVybiBkYXRhOwogIH0KCiAgZnVuY3Rpb24gX3RlbXBsYXRlT2JqZWN0KCkgewogICAgdmFyIGRhdGEgPSAoMCwgX2VtYmVyQmFiZWwudGFnZ2VkVGVtcGxhdGVMaXRlcmFsTG9vc2UpKFsiLWJ1Y2tldC1jYWNoZTptYWluIl0pOwoKICAgIF90ZW1wbGF0ZU9iamVjdCA9IGZ1bmN0aW9uIF90ZW1wbGF0ZU9iamVjdCgpIHsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwoKICAgIHJldHVybiBkYXRhOwogIH0KCiAgLyoqCiAgICBUaGUgYEVuZ2luZUluc3RhbmNlYCBlbmNhcHN1bGF0ZXMgYWxsIG9mIHRoZSBzdGF0ZWZ1bCBhc3BlY3RzIG9mIGEKICAgIHJ1bm5pbmcgYEVuZ2luZWAuCiAgCiAgICBAcHVibGljCiAgICBAY2xhc3MgRW5naW5lSW5zdGFuY2UKICAgIEBleHRlbmRzIEVtYmVyT2JqZWN0CiAgICBAdXNlcyBSZWdpc3RyeVByb3h5TWl4aW4KICAgIEB1c2VzIENvbnRhaW5lclByb3h5TWl4aW4KICAqLwogIHZhciBFbmdpbmVJbnN0YW5jZSA9IF9ydW50aW1lLk9iamVjdC5leHRlbmQoX3J1bnRpbWUuUmVnaXN0cnlQcm94eU1peGluLCBfcnVudGltZS5Db250YWluZXJQcm94eU1peGluLCB7CiAgICAvKioKICAgICAgVGhlIGJhc2UgYEVuZ2luZWAgZm9yIHdoaWNoIHRoaXMgaXMgYW4gaW5zdGFuY2UuCiAgICAgICBAcHJvcGVydHkge0VuZ2luZX0gZW5naW5lCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgYmFzZTogbnVsbCwKICAgIGluaXQ6IGZ1bmN0aW9uIGluaXQoKSB7CiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAoMCwgX3V0aWxzLmd1aWRGb3IpKHRoaXMpOwogICAgICB2YXIgYmFzZSA9IHRoaXMuYmFzZTsKCiAgICAgIGlmICghYmFzZSkgewogICAgICAgIGJhc2UgPSB0aGlzLmFwcGxpY2F0aW9uOwogICAgICAgIHRoaXMuYmFzZSA9IGJhc2U7CiAgICAgIH0gLy8gQ3JlYXRlIGEgcGVyLWluc3RhbmNlIHJlZ2lzdHJ5IHRoYXQgd2lsbCB1c2UgdGhlIGFwcGxpY2F0aW9uJ3MgcmVnaXN0cnkKICAgICAgLy8gYXMgYSBmYWxsYmFjayBmb3IgcmVzb2x2aW5nIHJlZ2lzdHJhdGlvbnMuCgoKICAgICAgdmFyIHJlZ2lzdHJ5ID0gdGhpcy5fX3JlZ2lzdHJ5X18gPSBuZXcgX2NvbnRhaW5lci5SZWdpc3RyeSh7CiAgICAgICAgZmFsbGJhY2s6IGJhc2UuX19yZWdpc3RyeV9fCiAgICAgIH0pOyAvLyBDcmVhdGUgYSBwZXItaW5zdGFuY2UgY29udGFpbmVyIGZyb20gdGhlIGluc3RhbmNlJ3MgcmVnaXN0cnkKCiAgICAgIHRoaXMuX19jb250YWluZXJfXyA9IHJlZ2lzdHJ5LmNvbnRhaW5lcih7CiAgICAgICAgb3duZXI6IHRoaXMKICAgICAgfSk7CiAgICAgIHRoaXMuX2Jvb3RlZCA9IGZhbHNlOwogICAgfSwKCiAgICAvKioKICAgICAgSW5pdGlhbGl6ZSB0aGUgYEVuZ2luZUluc3RhbmNlYCBhbmQgcmV0dXJuIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzCiAgICAgIHdpdGggdGhlIGluc3RhbmNlIGl0c2VsZiB3aGVuIHRoZSBib290IHByb2Nlc3MgaXMgY29tcGxldGUuCiAgICAgICBUaGUgcHJpbWFyeSB0YXNrIGhlcmUgaXMgdG8gcnVuIGFueSByZWdpc3RlcmVkIGluc3RhbmNlIGluaXRpYWxpemVycy4KICAgICAgIFNlZSB0aGUgZG9jdW1lbnRhdGlvbiBvbiBgQm9vdE9wdGlvbnNgIGZvciB0aGUgb3B0aW9ucyBpdCB0YWtlcy4KICAgICAgIEBwdWJsaWMKICAgICAgQG1ldGhvZCBib290CiAgICAgIEBwYXJhbSBvcHRpb25zIHtPYmplY3R9CiAgICAgIEByZXR1cm4ge1Byb21pc2U8RW5naW5lSW5zdGFuY2UsRXJyb3I+fQogICAgKi8KICAgIGJvb3Q6IGZ1bmN0aW9uIGJvb3Qob3B0aW9ucykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgaWYgKHRoaXMuX2Jvb3RQcm9taXNlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2Jvb3RQcm9taXNlOwogICAgICB9CgogICAgICB0aGlzLl9ib290UHJvbWlzZSA9IG5ldyBfcnVudGltZS5SU1ZQLlByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgICAgICByZXR1cm4gcmVzb2x2ZShfdGhpcy5fYm9vdFN5bmMob3B0aW9ucykpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXMuX2Jvb3RQcm9taXNlOwogICAgfSwKCiAgICAvKioKICAgICAgVW5mb3J0dW5hdGVseSwgYSBsb3Qgb2YgZXhpc3RpbmcgY29kZSBhc3N1bWVzIGJvb3RpbmcgYW4gaW5zdGFuY2UgaXMKICAgICAgc3luY2hyb25vdXMg4oCTIHNwZWNpZmljYWxseSwgYSBsb3Qgb2YgdGVzdHMgYXNzdW1lIHRoZSBsYXN0IGNhbGwgdG8KICAgICAgYGFwcC5hZHZhbmNlUmVhZGluZXNzKClgIG9yIGBhcHAucmVzZXQoKWAgd2lsbCByZXN1bHQgaW4gYSBuZXcgaW5zdGFuY2UKICAgICAgYmVpbmcgZnVsbHktYm9vdGVkIHdoZW4gdGhlIGN1cnJlbnQgcnVubG9vcCBjb21wbGV0ZXMuCiAgICAgICBXZSB3b3VsZCBsaWtlIG5ldyBjb2RlIChsaWtlIHRoZSBgdmlzaXRgIEFQSSkgdG8gc3RvcCBtYWtpbmcgdGhpcwogICAgICBhc3N1bXB0aW9uLCBzbyB3ZSBjcmVhdGVkIHRoZSBhc3luY2hyb25vdXMgdmVyc2lvbiBhYm92ZSB0aGF0IHJldHVybnMgYQogICAgICBwcm9taXNlLiBCdXQgdW50aWwgd2UgaGF2ZSBtaWdyYXRlZCBhbGwgdGhlIGNvZGUsIHdlIHdvdWxkIGhhdmUgdG8gZXhwb3NlCiAgICAgIHRoaXMgbWV0aG9kIGZvciB1c2UgKmludGVybmFsbHkqIGluIHBsYWNlcyB3aGVyZSB3ZSBuZWVkIHRvIGJvb3QgYW4gaW5zdGFuY2UKICAgICAgc3luY2hyb25vdXNseS4KICAgICAgIEBwcml2YXRlCiAgICAqLwogICAgX2Jvb3RTeW5jOiBmdW5jdGlvbiBfYm9vdFN5bmMob3B0aW9ucykgewogICAgICBpZiAodGhpcy5fYm9vdGVkKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KCiAgICAgIChmYWxzZSAmJiAhKCgwLCBfZW5naW5lUGFyZW50LmdldEVuZ2luZVBhcmVudCkodGhpcykpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQW4gZW5naW5lIGluc3RhbmNlJ3MgcGFyZW50IG11c3QgYmUgc2V0IHZpYSBgc2V0RW5naW5lUGFyZW50KGVuZ2luZSwgcGFyZW50KWAgcHJpb3IgdG8gY2FsbGluZyBgZW5naW5lLmJvb3QoKWAuIiwgKDAsIF9lbmdpbmVQYXJlbnQuZ2V0RW5naW5lUGFyZW50KSh0aGlzKSkpOwogICAgICB0aGlzLmNsb25lUGFyZW50RGVwZW5kZW5jaWVzKCk7CiAgICAgIHRoaXMuc2V0dXBSZWdpc3RyeShvcHRpb25zKTsKICAgICAgdGhpcy5iYXNlLnJ1bkluc3RhbmNlSW5pdGlhbGl6ZXJzKHRoaXMpOwogICAgICB0aGlzLl9ib290ZWQgPSB0cnVlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBzZXR1cFJlZ2lzdHJ5OiBmdW5jdGlvbiBzZXR1cFJlZ2lzdHJ5KG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB0aGlzLl9fY29udGFpbmVyX18ubG9va3VwKCctZW52aXJvbm1lbnQ6bWFpbicpOwogICAgICB9CgogICAgICB0aGlzLmNvbnN0cnVjdG9yLnNldHVwUmVnaXN0cnkodGhpcy5fX3JlZ2lzdHJ5X18sIG9wdGlvbnMpOwogICAgfSwKCiAgICAvKioKICAgICBVbnJlZ2lzdGVyIGEgZmFjdG9yeS4KICAgICAgT3ZlcnJpZGVzIGBSZWdpc3RyeVByb3h5I3VucmVnaXN0ZXJgIGluIG9yZGVyIHRvIGNsZWFyIGFueSBjYWNoZWQgaW5zdGFuY2VzCiAgICAgb2YgdGhlIHVucmVnaXN0ZXJlZCBmYWN0b3J5LgogICAgICBAcHVibGljCiAgICAgQG1ldGhvZCB1bnJlZ2lzdGVyCiAgICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lCiAgICAgKi8KICAgIHVucmVnaXN0ZXI6IGZ1bmN0aW9uIHVucmVnaXN0ZXIoZnVsbE5hbWUpIHsKICAgICAgdGhpcy5fX2NvbnRhaW5lcl9fLnJlc2V0KGZ1bGxOYW1lKTsKCiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8qKgogICAgICBCdWlsZCBhIG5ldyBgRW5naW5lSW5zdGFuY2VgIHRoYXQncyBhIGNoaWxkIG9mIHRoaXMgaW5zdGFuY2UuCiAgICAgICBFbmdpbmVzIG11c3QgYmUgcmVnaXN0ZXJlZCBieSBuYW1lIHdpdGggdGhlaXIgcGFyZW50IGVuZ2luZQogICAgICAob3IgYXBwbGljYXRpb24pLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBidWlsZENoaWxkRW5naW5lSW5zdGFuY2UKICAgICAgQHBhcmFtIG5hbWUge1N0cmluZ30gdGhlIHJlZ2lzdGVyZWQgbmFtZSBvZiB0aGUgZW5naW5lLgogICAgICBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fSBvcHRpb25zIHByb3ZpZGVkIHRvIHRoZSBlbmdpbmUgaW5zdGFuY2UuCiAgICAgIEByZXR1cm4ge0VuZ2luZUluc3RhbmNlLEVycm9yfQogICAgKi8KICAgIGJ1aWxkQ2hpbGRFbmdpbmVJbnN0YW5jZTogZnVuY3Rpb24gYnVpbGRDaGlsZEVuZ2luZUluc3RhbmNlKG5hbWUsIG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgdmFyIEVuZ2luZSA9IHRoaXMubG9va3VwKCJlbmdpbmU6IiArIG5hbWUpOwoKICAgICAgaWYgKCFFbmdpbmUpIHsKICAgICAgICB0aHJvdyBuZXcgX2Vycm9yLmRlZmF1bHQoIllvdSBhdHRlbXB0ZWQgdG8gbW91bnQgdGhlIGVuZ2luZSAnIiArIG5hbWUgKyAiJywgYnV0IGl0IGlzIG5vdCByZWdpc3RlcmVkIHdpdGggaXRzIHBhcmVudC4iKTsKICAgICAgfQoKICAgICAgdmFyIGVuZ2luZUluc3RhbmNlID0gRW5naW5lLmJ1aWxkSW5zdGFuY2Uob3B0aW9ucyk7CiAgICAgICgwLCBfZW5naW5lUGFyZW50LnNldEVuZ2luZVBhcmVudCkoZW5naW5lSW5zdGFuY2UsIHRoaXMpOwogICAgICByZXR1cm4gZW5naW5lSW5zdGFuY2U7CiAgICB9LAoKICAgIC8qKgogICAgICBDbG9uZSBkZXBlbmRlbmNpZXMgc2hhcmVkIGJldHdlZW4gYW4gZW5naW5lIGluc3RhbmNlIGFuZCBpdHMgcGFyZW50LgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBjbG9uZVBhcmVudERlcGVuZGVuY2llcwogICAgKi8KICAgIGNsb25lUGFyZW50RGVwZW5kZW5jaWVzOiBmdW5jdGlvbiBjbG9uZVBhcmVudERlcGVuZGVuY2llcygpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB2YXIgcGFyZW50ID0gKDAsIF9lbmdpbmVQYXJlbnQuZ2V0RW5naW5lUGFyZW50KSh0aGlzKTsKICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSBbJ3JvdXRlOmJhc2ljJywgJ3NlcnZpY2U6LXJvdXRpbmcnLCAnc2VydmljZTotZ2xpbW1lci1lbnZpcm9ubWVudCddOwogICAgICByZWdpc3RyYXRpb25zLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIHJldHVybiBfdGhpczIucmVnaXN0ZXIoa2V5LCBwYXJlbnQucmVzb2x2ZVJlZ2lzdHJhdGlvbihrZXkpKTsKICAgICAgfSk7CiAgICAgIHZhciBlbnYgPSBwYXJlbnQubG9va3VwKCctZW52aXJvbm1lbnQ6bWFpbicpOwogICAgICB0aGlzLnJlZ2lzdGVyKCctZW52aXJvbm1lbnQ6bWFpbicsIGVudiwgewogICAgICAgIGluc3RhbnRpYXRlOiBmYWxzZQogICAgICB9KTsKICAgICAgdmFyIHNpbmdsZXRvbnMgPSBbJ3JvdXRlcjptYWluJywgKDAsIF9jb250YWluZXIucHJpdmF0aXplKShfdGVtcGxhdGVPYmplY3QoKSksICctdmlldy1yZWdpc3RyeTptYWluJywgInJlbmRlcmVyOi0iICsgKGVudi5pc0ludGVyYWN0aXZlID8gJ2RvbScgOiAnaW5lcnQnKSwgJ3NlcnZpY2U6LWRvY3VtZW50JywgKDAsIF9jb250YWluZXIucHJpdmF0aXplKShfdGVtcGxhdGVPYmplY3QyKCkpXTsKCiAgICAgIGlmIChlbnYuaXNJbnRlcmFjdGl2ZSkgewogICAgICAgIHNpbmdsZXRvbnMucHVzaCgnZXZlbnRfZGlzcGF0Y2hlcjptYWluJyk7CiAgICAgIH0KCiAgICAgIHNpbmdsZXRvbnMuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgcmV0dXJuIF90aGlzMi5yZWdpc3RlcihrZXksIHBhcmVudC5sb29rdXAoa2V5KSwgewogICAgICAgICAgaW5zdGFudGlhdGU6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICB0aGlzLmluamVjdCgndmlldycsICdfZW52aXJvbm1lbnQnLCAnLWVudmlyb25tZW50Om1haW4nKTsKICAgICAgdGhpcy5pbmplY3QoJ3JvdXRlJywgJ19lbnZpcm9ubWVudCcsICctZW52aXJvbm1lbnQ6bWFpbicpOwogICAgfQogIH0pOwoKICBFbmdpbmVJbnN0YW5jZS5yZW9wZW5DbGFzcyh7CiAgICAvKioKICAgICBAcHJpdmF0ZQogICAgIEBtZXRob2Qgc2V0dXBSZWdpc3RyeQogICAgIEBwYXJhbSB7UmVnaXN0cnl9IHJlZ2lzdHJ5CiAgICAgQHBhcmFtIHtCb290T3B0aW9uc30gb3B0aW9ucwogICAgICovCiAgICBzZXR1cFJlZ2lzdHJ5OiBmdW5jdGlvbiBzZXR1cFJlZ2lzdHJ5KHJlZ2lzdHJ5LCBvcHRpb25zKSB7CiAgICAgIC8vIHdoZW4gbm8gb3B0aW9ucy9lbnZpcm9ubWVudCBpcyBwcmVzZW50LCBkbyBub3RoaW5nCiAgICAgIGlmICghb3B0aW9ucykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgcmVnaXN0cnkuaW5qZWN0aW9uKCd2aWV3JywgJ19lbnZpcm9ubWVudCcsICctZW52aXJvbm1lbnQ6bWFpbicpOwogICAgICByZWdpc3RyeS5pbmplY3Rpb24oJ3JvdXRlJywgJ19lbnZpcm9ubWVudCcsICctZW52aXJvbm1lbnQ6bWFpbicpOwoKICAgICAgaWYgKG9wdGlvbnMuaXNJbnRlcmFjdGl2ZSkgewogICAgICAgIHJlZ2lzdHJ5LmluamVjdGlvbigndmlldycsICdyZW5kZXJlcicsICdyZW5kZXJlcjotZG9tJyk7CiAgICAgICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdjb21wb25lbnQnLCAncmVuZGVyZXInLCAncmVuZGVyZXI6LWRvbScpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlZ2lzdHJ5LmluamVjdGlvbigndmlldycsICdyZW5kZXJlcicsICdyZW5kZXJlcjotaW5lcnQnKTsKICAgICAgICByZWdpc3RyeS5pbmplY3Rpb24oJ2NvbXBvbmVudCcsICdyZW5kZXJlcicsICdyZW5kZXJlcjotaW5lcnQnKTsKICAgICAgfQogICAgfQogIH0pOwogIHZhciBfZGVmYXVsdCA9IEVuZ2luZUluc3RhbmNlOwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CmRlZmluZSgiQGVtYmVyL2VuZ2luZS9saWIvZW5naW5lLXBhcmVudCIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy91dGlscyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF91dGlscykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZ2V0RW5naW5lUGFyZW50ID0gZ2V0RW5naW5lUGFyZW50OwogIF9leHBvcnRzLnNldEVuZ2luZVBhcmVudCA9IHNldEVuZ2luZVBhcmVudDsKCiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvZW5naW5lCiAgKi8KICB2YXIgRU5HSU5FX1BBUkVOVCA9ICgwLCBfdXRpbHMuc3ltYm9sKSgnRU5HSU5FX1BBUkVOVCcpOwogIC8qKgogICAgYGdldEVuZ2luZVBhcmVudGAgcmV0cmlldmVzIGFuIGVuZ2luZSBpbnN0YW5jZSdzIHBhcmVudCBpbnN0YW5jZS4KICAKICAgIEBtZXRob2QgZ2V0RW5naW5lUGFyZW50CiAgICBAcGFyYW0ge0VuZ2luZUluc3RhbmNlfSBlbmdpbmUgQW4gZW5naW5lIGluc3RhbmNlLgogICAgQHJldHVybiB7RW5naW5lSW5zdGFuY2V9IFRoZSBwYXJlbnQgZW5naW5lIGluc3RhbmNlLgogICAgQGZvciBAZW1iZXIvZW5naW5lCiAgICBAc3RhdGljCiAgICBAcHJpdmF0ZQogICovCgogIGZ1bmN0aW9uIGdldEVuZ2luZVBhcmVudChlbmdpbmUpIHsKICAgIHJldHVybiBlbmdpbmVbRU5HSU5FX1BBUkVOVF07CiAgfQogIC8qKgogICAgYHNldEVuZ2luZVBhcmVudGAgc2V0cyBhbiBlbmdpbmUgaW5zdGFuY2UncyBwYXJlbnQgaW5zdGFuY2UuCiAgCiAgICBAbWV0aG9kIHNldEVuZ2luZVBhcmVudAogICAgQHBhcmFtIHtFbmdpbmVJbnN0YW5jZX0gZW5naW5lIEFuIGVuZ2luZSBpbnN0YW5jZS4KICAgIEBwYXJhbSB7RW5naW5lSW5zdGFuY2V9IHBhcmVudCBUaGUgcGFyZW50IGVuZ2luZSBpbnN0YW5jZS4KICAgIEBwcml2YXRlCiAgKi8KCgogIGZ1bmN0aW9uIHNldEVuZ2luZVBhcmVudChlbmdpbmUsIHBhcmVudCkgewogICAgZW5naW5lW0VOR0lORV9QQVJFTlRdID0gcGFyZW50OwogIH0KfSk7CmRlZmluZSgiQGVtYmVyL2Vycm9yL2luZGV4IiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgIEBtb2R1bGUgQGVtYmVyL2Vycm9yCiAgKi8KCiAgLyoqCiAgICBUaGUgSmF2YVNjcmlwdCBFcnJvciBvYmplY3QgdXNlZCBieSBFbWJlci5hc3NlcnQuCiAgCiAgICBAY2xhc3MgRXJyb3IKICAgIEBuYW1lc3BhY2UgRW1iZXIKICAgIEBleHRlbmRzIEVycm9yCiAgICBAY29uc3RydWN0b3IKICAgIEBwdWJsaWMKICAqLwogIHZhciBfZGVmYXVsdCA9IEVycm9yOwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CmRlZmluZSgiQGVtYmVyL2luc3RydW1lbnRhdGlvbi9pbmRleCIsIFsiZXhwb3J0cyIsICJAZW1iZXIvLWludGVybmFscy9lbnZpcm9ubWVudCJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9lbnZpcm9ubWVudCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuaW5zdHJ1bWVudCA9IGluc3RydW1lbnQ7CiAgX2V4cG9ydHMuX2luc3RydW1lbnRTdGFydCA9IF9pbnN0cnVtZW50U3RhcnQ7CiAgX2V4cG9ydHMuc3Vic2NyaWJlID0gc3Vic2NyaWJlOwogIF9leHBvcnRzLnVuc3Vic2NyaWJlID0gdW5zdWJzY3JpYmU7CiAgX2V4cG9ydHMucmVzZXQgPSByZXNldDsKICBfZXhwb3J0cy5mbGFnZ2VkSW5zdHJ1bWVudCA9IF9leHBvcnRzLnN1YnNjcmliZXJzID0gdm9pZCAwOwoKICAvKiBlc2xpbnQgbm8tY29uc29sZTpvZmYgKi8KCiAgLyogZ2xvYmFsIGNvbnNvbGUgKi8KCiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvaW5zdHJ1bWVudGF0aW9uCiAgQHByaXZhdGUKICAqLwoKICAvKioKICAgIFRoZSBwdXJwb3NlIG9mIHRoZSBFbWJlciBJbnN0cnVtZW50YXRpb24gbW9kdWxlIGlzCiAgICB0byBwcm92aWRlIGVmZmljaWVudCwgZ2VuZXJhbC1wdXJwb3NlIGluc3RydW1lbnRhdGlvbgogICAgZm9yIEVtYmVyLgogIAogICAgU3Vic2NyaWJlIHRvIGEgbGlzdGVuZXIgYnkgdXNpbmcgYHN1YnNjcmliZWA6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzdWJzY3JpYmUgfSBmcm9tICdAZW1iZXIvaW5zdHJ1bWVudGF0aW9uJzsKICAKICAgIHN1YnNjcmliZSgicmVuZGVyIiwgewogICAgICBiZWZvcmUobmFtZSwgdGltZXN0YW1wLCBwYXlsb2FkKSB7CiAgCiAgICAgIH0sCiAgCiAgICAgIGFmdGVyKG5hbWUsIHRpbWVzdGFtcCwgcGF5bG9hZCkgewogIAogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgSWYgeW91IHJldHVybiBhIHZhbHVlIGZyb20gdGhlIGBiZWZvcmVgIGNhbGxiYWNrLCB0aGF0IHNhbWUKICAgIHZhbHVlIHdpbGwgYmUgcGFzc2VkIGFzIGEgZm91cnRoIHBhcmFtZXRlciB0byB0aGUgYGFmdGVyYAogICAgY2FsbGJhY2suCiAgCiAgICBJbnN0cnVtZW50IGEgYmxvY2sgb2YgY29kZSBieSB1c2luZyBgaW5zdHJ1bWVudGA6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBpbnN0cnVtZW50IH0gZnJvbSAnQGVtYmVyL2luc3RydW1lbnRhdGlvbic7CiAgCiAgICBpbnN0cnVtZW50KCJyZW5kZXIuaGFuZGxlYmFycyIsIHBheWxvYWQsIGZ1bmN0aW9uKCkgewogICAgICAvLyByZW5kZXJpbmcgbG9naWMKICAgIH0sIGJpbmRpbmcpOwogICAgYGBgCiAgCiAgICBFdmVudCBuYW1lcyBwYXNzZWQgdG8gYGluc3RydW1lbnRgIGFyZSBuYW1lc3BhY2VkCiAgICBieSBwZXJpb2RzLCBmcm9tIG1vcmUgZ2VuZXJhbCB0byBtb3JlIHNwZWNpZmljLiBTdWJzY3JpYmVycwogICAgY2FuIGxpc3RlbiBmb3IgZXZlbnRzIGJ5IHdoYXRldmVyIGxldmVsIG9mIGdyYW51bGFyaXR5IHRoZXkKICAgIGFyZSBpbnRlcmVzdGVkIGluLgogIAogICAgSW4gdGhlIGFib3ZlIGV4YW1wbGUsIHRoZSBldmVudCBpcyBgcmVuZGVyLmhhbmRsZWJhcnNgLAogICAgYW5kIHRoZSBzdWJzY3JpYmVyIGxpc3RlbmVkIGZvciBhbGwgZXZlbnRzIGJlZ2lubmluZyB3aXRoCiAgICBgcmVuZGVyYC4gSXQgd291bGQgcmVjZWl2ZSBjYWxsYmFja3MgZm9yIGV2ZW50cyBuYW1lZAogICAgYHJlbmRlcmAsIGByZW5kZXIuaGFuZGxlYmFyc2AsIGByZW5kZXIuY29udGFpbmVyYCwgb3IKICAgIGV2ZW4gYHJlbmRlci5oYW5kbGViYXJzLmxheW91dGAuCiAgCiAgICBAY2xhc3MgSW5zdHJ1bWVudGF0aW9uCiAgICBAc3RhdGljCiAgICBAcHJpdmF0ZQogICovCiAgdmFyIHN1YnNjcmliZXJzID0gW107CiAgX2V4cG9ydHMuc3Vic2NyaWJlcnMgPSBzdWJzY3JpYmVyczsKICB2YXIgY2FjaGUgPSB7fTsKCiAgZnVuY3Rpb24gcG9wdWxhdGVMaXN0ZW5lcnMobmFtZSkgewogICAgdmFyIGxpc3RlbmVycyA9IFtdOwogICAgdmFyIHN1YnNjcmliZXI7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdWJzY3JpYmVycy5sZW5ndGg7IGkrKykgewogICAgICBzdWJzY3JpYmVyID0gc3Vic2NyaWJlcnNbaV07CgogICAgICBpZiAoc3Vic2NyaWJlci5yZWdleC50ZXN0KG5hbWUpKSB7CiAgICAgICAgbGlzdGVuZXJzLnB1c2goc3Vic2NyaWJlci5vYmplY3QpOwogICAgICB9CiAgICB9CgogICAgY2FjaGVbbmFtZV0gPSBsaXN0ZW5lcnM7CiAgICByZXR1cm4gbGlzdGVuZXJzOwogIH0KCiAgdmFyIHRpbWUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgcGVyZiA9ICd1bmRlZmluZWQnICE9PSB0eXBlb2Ygd2luZG93ID8gd2luZG93LnBlcmZvcm1hbmNlIHx8IHt9IDoge307CiAgICB2YXIgZm4gPSBwZXJmLm5vdyB8fCBwZXJmLm1vek5vdyB8fCBwZXJmLndlYmtpdE5vdyB8fCBwZXJmLm1zTm93IHx8IHBlcmYub05vdzsKICAgIHJldHVybiBmbiA/IGZuLmJpbmQocGVyZikgOiBEYXRlLm5vdzsKICB9KCk7CgogIGZ1bmN0aW9uIGlzQ2FsbGJhY2sodmFsdWUpIHsKICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbic7CiAgfQoKICBmdW5jdGlvbiBpbnN0cnVtZW50KG5hbWUsIHAxLCBwMiwgcDMpIHsKICAgIHZhciBfcGF5bG9hZDsKCiAgICB2YXIgY2FsbGJhY2s7CiAgICB2YXIgYmluZGluZzsKCiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8PSAzICYmIGlzQ2FsbGJhY2socDEpKSB7CiAgICAgIGNhbGxiYWNrID0gcDE7CiAgICAgIGJpbmRpbmcgPSBwMjsKICAgIH0gZWxzZSB7CiAgICAgIF9wYXlsb2FkID0gcDE7CiAgICAgIGNhbGxiYWNrID0gcDI7CiAgICAgIGJpbmRpbmcgPSBwMzsKICAgIH0gLy8gZmFzdCBwYXRoCgoKICAgIGlmIChzdWJzY3JpYmVycy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIGNhbGxiYWNrLmNhbGwoYmluZGluZyk7CiAgICB9IC8vIGF2b2lkIGFsbG9jYXRpbmcgdGhlIHBheWxvYWQgaW4gZmFzdCBwYXRoCgoKICAgIHZhciBwYXlsb2FkID0gX3BheWxvYWQgfHwge307CgogICAgdmFyIGZpbmFsaXplciA9IF9pbnN0cnVtZW50U3RhcnQobmFtZSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gcGF5bG9hZDsKICAgIH0pOwoKICAgIGlmIChmaW5hbGl6ZXIgPT09IE5PT1ApIHsKICAgICAgcmV0dXJuIGNhbGxiYWNrLmNhbGwoYmluZGluZyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gd2l0aEZpbmFsaXplcihjYWxsYmFjaywgZmluYWxpemVyLCBwYXlsb2FkLCBiaW5kaW5nKTsKICAgIH0KICB9CgogIHZhciBmbGFnZ2VkSW5zdHJ1bWVudDsKICBfZXhwb3J0cy5mbGFnZ2VkSW5zdHJ1bWVudCA9IGZsYWdnZWRJbnN0cnVtZW50OwoKICBpZiAoZmFsc2UKICAvKiBFTUJFUl9JTVBST1ZFRF9JTlNUUlVNRU5UQVRJT04gKi8KICApIHsKICAgICAgX2V4cG9ydHMuZmxhZ2dlZEluc3RydW1lbnQgPSBmbGFnZ2VkSW5zdHJ1bWVudCA9IGluc3RydW1lbnQ7CiAgICB9IGVsc2UgewogICAgX2V4cG9ydHMuZmxhZ2dlZEluc3RydW1lbnQgPSBmbGFnZ2VkSW5zdHJ1bWVudCA9IGZ1bmN0aW9uIGluc3RydW1lbnQoX25hbWUsIF9wYXlsb2FkLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gY2FsbGJhY2soKTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiB3aXRoRmluYWxpemVyKGNhbGxiYWNrLCBmaW5hbGl6ZXIsIHBheWxvYWQsIGJpbmRpbmcpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKGJpbmRpbmcpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBwYXlsb2FkLmV4Y2VwdGlvbiA9IGU7CiAgICAgIHRocm93IGU7CiAgICB9IGZpbmFsbHkgewogICAgICBmaW5hbGl6ZXIoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIE5PT1AoKSB7fQoKICBmdW5jdGlvbiBfaW5zdHJ1bWVudFN0YXJ0KG5hbWUsIHBheWxvYWRGdW5jLCBwYXlsb2FkQXJnKSB7CiAgICBpZiAoc3Vic2NyaWJlcnMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBOT09QOwogICAgfQoKICAgIHZhciBsaXN0ZW5lcnMgPSBjYWNoZVtuYW1lXTsKCiAgICBpZiAoIWxpc3RlbmVycykgewogICAgICBsaXN0ZW5lcnMgPSBwb3B1bGF0ZUxpc3RlbmVycyhuYW1lKTsKICAgIH0KCiAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gTk9PUDsKICAgIH0KCiAgICB2YXIgcGF5bG9hZCA9IHBheWxvYWRGdW5jKHBheWxvYWRBcmcpOwogICAgdmFyIFNUUlVDVFVSRURfUFJPRklMRSA9IF9lbnZpcm9ubWVudC5FTlYuU1RSVUNUVVJFRF9QUk9GSUxFOwogICAgdmFyIHRpbWVOYW1lOwoKICAgIGlmIChTVFJVQ1RVUkVEX1BST0ZJTEUpIHsKICAgICAgdGltZU5hbWUgPSBuYW1lICsgIjogIiArIHBheWxvYWQub2JqZWN0OwogICAgICBjb25zb2xlLnRpbWUodGltZU5hbWUpOwogICAgfQoKICAgIHZhciBiZWZvcmVWYWx1ZXMgPSBbXTsKICAgIHZhciB0aW1lc3RhbXAgPSB0aW1lKCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0ZW5lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGxpc3RlbmVyID0gbGlzdGVuZXJzW2ldOwogICAgICBiZWZvcmVWYWx1ZXMucHVzaChsaXN0ZW5lci5iZWZvcmUobmFtZSwgdGltZXN0YW1wLCBwYXlsb2FkKSk7CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uIF9pbnN0cnVtZW50RW5kKCkgewogICAgICB2YXIgdGltZXN0YW1wID0gdGltZSgpOwoKICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGxpc3RlbmVycy5sZW5ndGg7IF9pKyspIHsKICAgICAgICB2YXIgX2xpc3RlbmVyID0gbGlzdGVuZXJzW19pXTsKCiAgICAgICAgaWYgKHR5cGVvZiBfbGlzdGVuZXIuYWZ0ZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIF9saXN0ZW5lci5hZnRlcihuYW1lLCB0aW1lc3RhbXAsIHBheWxvYWQsIGJlZm9yZVZhbHVlc1tfaV0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKFNUUlVDVFVSRURfUFJPRklMRSkgewogICAgICAgIGNvbnNvbGUudGltZUVuZCh0aW1lTmFtZSk7CiAgICAgIH0KICAgIH07CiAgfQogIC8qKgogICAgU3Vic2NyaWJlcyB0byBhIHBhcnRpY3VsYXIgZXZlbnQgb3IgaW5zdHJ1bWVudGVkIGJsb2NrIG9mIGNvZGUuCiAgCiAgICBAbWV0aG9kIHN1YnNjcmliZQogICAgQGZvciBAZW1iZXIvaW5zdHJ1bWVudGF0aW9uCiAgICBAc3RhdGljCiAgCiAgICBAcGFyYW0ge1N0cmluZ30gW3BhdHRlcm5dIE5hbWVzcGFjZWQgZXZlbnQgbmFtZS4KICAgIEBwYXJhbSB7T2JqZWN0fSBbb2JqZWN0XSBCZWZvcmUgYW5kIEFmdGVyIGhvb2tzLgogIAogICAgQHJldHVybiB7U3Vic2NyaWJlcn0KICAgIEBwcml2YXRlCiAgKi8KCgogIGZ1bmN0aW9uIHN1YnNjcmliZShwYXR0ZXJuLCBvYmplY3QpIHsKICAgIHZhciBwYXRocyA9IHBhdHRlcm4uc3BsaXQoJy4nKTsKICAgIHZhciBwYXRoOwogICAgdmFyIHJlZ2V4ZXMgPSBbXTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGhzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHBhdGggPSBwYXRoc1tpXTsKCiAgICAgIGlmIChwYXRoID09PSAnKicpIHsKICAgICAgICByZWdleGVzLnB1c2goJ1teXFwuXSonKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZWdleGVzLnB1c2gocGF0aCk7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgcmVnZXggPSByZWdleGVzLmpvaW4oJ1xcLicpOwogICAgcmVnZXggPSByZWdleCArICIoXFwuLiopPyI7CiAgICB2YXIgc3Vic2NyaWJlciA9IHsKICAgICAgcGF0dGVybjogcGF0dGVybiwKICAgICAgcmVnZXg6IG5ldyBSZWdFeHAoIl4iICsgcmVnZXggKyAiJCIpLAogICAgICBvYmplY3Q6IG9iamVjdAogICAgfTsKICAgIHN1YnNjcmliZXJzLnB1c2goc3Vic2NyaWJlcik7CiAgICBjYWNoZSA9IHt9OwogICAgcmV0dXJuIHN1YnNjcmliZXI7CiAgfQogIC8qKgogICAgVW5zdWJzY3JpYmVzIGZyb20gYSBwYXJ0aWN1bGFyIGV2ZW50IG9yIGluc3RydW1lbnRlZCBibG9jayBvZiBjb2RlLgogIAogICAgQG1ldGhvZCB1bnN1YnNjcmliZQogICAgQGZvciBAZW1iZXIvaW5zdHJ1bWVudGF0aW9uCiAgICBAc3RhdGljCiAgCiAgICBAcGFyYW0ge09iamVjdH0gW3N1YnNjcmliZXJdCiAgICBAcHJpdmF0ZQogICovCgoKICBmdW5jdGlvbiB1bnN1YnNjcmliZShzdWJzY3JpYmVyKSB7CiAgICB2YXIgaW5kZXggPSAwOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3Vic2NyaWJlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHN1YnNjcmliZXJzW2ldID09PSBzdWJzY3JpYmVyKSB7CiAgICAgICAgaW5kZXggPSBpOwogICAgICB9CiAgICB9CgogICAgc3Vic2NyaWJlcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgIGNhY2hlID0ge307CiAgfQogIC8qKgogICAgUmVzZXRzIGBJbnN0cnVtZW50YXRpb25gIGJ5IGZsdXNoaW5nIGxpc3Qgb2Ygc3Vic2NyaWJlcnMuCiAgCiAgICBAbWV0aG9kIHJlc2V0CiAgICBAZm9yIEBlbWJlci9pbnN0cnVtZW50YXRpb24KICAgIEBzdGF0aWMKICAgIEBwcml2YXRlCiAgKi8KCgogIGZ1bmN0aW9uIHJlc2V0KCkgewogICAgc3Vic2NyaWJlcnMubGVuZ3RoID0gMDsKICAgIGNhY2hlID0ge307CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvbW9kaWZpZXIvaW5kZXgiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvZ2xpbW1lciJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9nbGltbWVyKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJzZXRNb2RpZmllck1hbmFnZXIiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfZ2xpbW1lci5zZXRNb2RpZmllck1hbmFnZXI7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiY2FwYWJpbHRpZXMiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfZ2xpbW1lci5tb2RpZmllckNhcGFiaWxpdGllczsKICAgIH0KICB9KTsKfSk7CmRlZmluZSgiQGVtYmVyL29iamVjdC9jb21wYXQiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiLCAiQGVtYmVyL2RlYnVnIiwgIkBnbGltbWVyL3JlZmVyZW5jZSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9tZXRhbCwgX2RlYnVnLCBfcmVmZXJlbmNlKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZXBlbmRlbnRLZXlDb21wYXQgPSBkZXBlbmRlbnRLZXlDb21wYXQ7CgogIHZhciB3cmFwR2V0dGVyU2V0dGVyID0gZnVuY3Rpb24gd3JhcEdldHRlclNldHRlcihfdGFyZ2V0LCBrZXksIGRlc2MpIHsKICAgIHZhciBvcmlnaW5hbEdldCA9IGRlc2MuZ2V0OwoKICAgIGlmIChvcmlnaW5hbEdldCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGRlc2MuZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIHZhciBwcm9wZXJ0eVRhZyA9ICgwLCBfbWV0YWwudGFnRm9yUHJvcGVydHkpKHRoaXMsIGtleSk7CiAgICAgICAgdmFyIHJldDsKICAgICAgICB2YXIgdGFnID0gKDAsIF9tZXRhbC50cmFjaykoZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0ID0gb3JpZ2luYWxHZXQuY2FsbChfdGhpcyk7CiAgICAgICAgfSk7CiAgICAgICAgKDAsIF9yZWZlcmVuY2UudXBkYXRlKShwcm9wZXJ0eVRhZywgdGFnKTsKICAgICAgICAoMCwgX21ldGFsLmNvbnN1bWUpKHRhZyk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gZGVzYzsKICB9OwoKICBmdW5jdGlvbiBkZXBlbmRlbnRLZXlDb21wYXQodGFyZ2V0LCBrZXksIGRlc2MpIHsKICAgIChmYWxzZSAmJiAhKEJvb2xlYW4odHJ1ZQogICAgLyogRU1CRVJfTUVUQUxfVFJBQ0tFRF9QUk9QRVJUSUVTICovCiAgICApKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1RoZSBkZXBlbmRlbnRLZXlDb21wYXQgZGVjb3JhdG9yIGNhbiBvbmx5IGJlIHVzZWQgaWYgdGhlIHRyYWNrZWQgcHJvcGVydGllcyBmZWF0dXJlIGlzIGVuYWJsZWQnLCBCb29sZWFuKHRydWUpKSk7CgogICAgaWYgKCEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKFt0YXJnZXQsIGtleSwgZGVzY10pKSB7CiAgICAgIGRlc2MgPSB0YXJnZXQ7CgogICAgICB2YXIgZGVjb3JhdG9yID0gZnVuY3Rpb24gZGVjb3JhdG9yKHRhcmdldCwga2V5LCBfZGVzYywgX21ldGEsIGlzQ2xhc3NpY0RlY29yYXRvcikgewogICAgICAgIChmYWxzZSAmJiAhKGlzQ2xhc3NpY0RlY29yYXRvcikgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUaGUgQGRlcGVuZGVudEtleUNvbXBhdCBkZWNvcmF0b3IgbWF5IG9ubHkgYmUgcGFzc2VkIGEgbWV0aG9kIHdoZW4gdXNlZCBpbiBjbGFzc2ljIGNsYXNzZXMuIFlvdSBzaG91bGQgZGVjb3JhdGUgZ2V0dGVycy9zZXR0ZXJzIGRpcmVjdGx5IGluIG5hdGl2ZSBjbGFzc2VzJywgaXNDbGFzc2ljRGVjb3JhdG9yKSk7CiAgICAgICAgKGZhbHNlICYmICEoZGVzYyAhPT0gbnVsbCAmJiB0eXBlb2YgZGVzYyA9PT0gJ29iamVjdCcgJiYgKHR5cGVvZiBkZXNjLmdldCA9PT0gJ2Z1bmN0aW9uJyB8fCB0eXBlb2YgZGVzYy5zZXQgPT09ICdmdW5jdGlvbicpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1RoZSBkZXBlbmRlbnRLZXlDb21wYXQoKSBkZWNvcmF0b3IgbXVzdCBiZSBwYXNzZWQgYSBnZXR0ZXIgb3Igc2V0dGVyIHdoZW4gdXNlZCBpbiBjbGFzc2ljIGNsYXNzZXMnLCBkZXNjICE9PSBudWxsICYmIHR5cGVvZiBkZXNjID09PSAnb2JqZWN0JyAmJiAodHlwZW9mIGRlc2MuZ2V0ID09PSAnZnVuY3Rpb24nIHx8IHR5cGVvZiBkZXNjLnNldCA9PT0gJ2Z1bmN0aW9uJykpKTsKICAgICAgICByZXR1cm4gd3JhcEdldHRlclNldHRlcih0YXJnZXQsIGtleSwgZGVzYyk7CiAgICAgIH07CgogICAgICAoMCwgX21ldGFsLnNldENsYXNzaWNEZWNvcmF0b3IpKGRlY29yYXRvcik7CiAgICAgIHJldHVybiBkZWNvcmF0b3I7CiAgICB9CgogICAgKGZhbHNlICYmICEoZGVzYyAhPT0gbnVsbCAmJiB0eXBlb2YgZGVzYy5nZXQgPT09ICdmdW5jdGlvbicgfHwgdHlwZW9mIGRlc2Muc2V0ID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1RoZSBAZGVwZW5kZW50S2V5Q29tcGF0IGRlY29yYXRvciBtdXN0IGJlIGFwcGxpZWQgdG8gZ2V0dGVycy9zZXR0ZXJzIHdoZW4gdXNlZCBpbiBuYXRpdmUgY2xhc3NlcycsIGRlc2MgIT09IG51bGwgJiYgdHlwZW9mIGRlc2MuZ2V0ID09PSAnZnVuY3Rpb24nIHx8IHR5cGVvZiBkZXNjLnNldCA9PT0gJ2Z1bmN0aW9uJykpOwogICAgcmV0dXJuIHdyYXBHZXR0ZXJTZXR0ZXIodGFyZ2V0LCBrZXksIGRlc2MpOwogIH0KCiAgKDAsIF9tZXRhbC5zZXRDbGFzc2ljRGVjb3JhdG9yKShkZXBlbmRlbnRLZXlDb21wYXQpOwp9KTsKZGVmaW5lKCJAZW1iZXIvb2JqZWN0L2NvbXB1dGVkIiwgWyJleHBvcnRzIiwgIkBlbWJlci9vYmplY3QvbGliL2NvbXB1dGVkL2NvbXB1dGVkX21hY3JvcyIsICJAZW1iZXIvb2JqZWN0L2xpYi9jb21wdXRlZC9yZWR1Y2VfY29tcHV0ZWRfbWFjcm9zIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2NvbXB1dGVkX21hY3JvcywgX3JlZHVjZV9jb21wdXRlZF9tYWNyb3MpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImVtcHR5IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2NvbXB1dGVkX21hY3Jvcy5lbXB0eTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJub3RFbXB0eSIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9jb21wdXRlZF9tYWNyb3Mubm90RW1wdHk7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAibm9uZSIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9jb21wdXRlZF9tYWNyb3Mubm9uZTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJub3QiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfY29tcHV0ZWRfbWFjcm9zLm5vdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJib29sIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2NvbXB1dGVkX21hY3Jvcy5ib29sOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIm1hdGNoIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2NvbXB1dGVkX21hY3Jvcy5tYXRjaDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJlcXVhbCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9jb21wdXRlZF9tYWNyb3MuZXF1YWw7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiZ3QiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfY29tcHV0ZWRfbWFjcm9zLmd0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImd0ZSIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9jb21wdXRlZF9tYWNyb3MuZ3RlOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImx0IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2NvbXB1dGVkX21hY3Jvcy5sdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJsdGUiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfY29tcHV0ZWRfbWFjcm9zLmx0ZTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJvbmVXYXkiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfY29tcHV0ZWRfbWFjcm9zLm9uZVdheTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJyZWFkT25seSIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9jb21wdXRlZF9tYWNyb3MucmVhZE9ubHk7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiZGVwcmVjYXRpbmdBbGlhcyIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9jb21wdXRlZF9tYWNyb3MuZGVwcmVjYXRpbmdBbGlhczsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJhbmQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfY29tcHV0ZWRfbWFjcm9zLmFuZDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJvciIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9jb21wdXRlZF9tYWNyb3Mub3I7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAic3VtIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3JlZHVjZV9jb21wdXRlZF9tYWNyb3Muc3VtOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIm1pbiIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9yZWR1Y2VfY29tcHV0ZWRfbWFjcm9zLm1pbjsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJtYXgiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcmVkdWNlX2NvbXB1dGVkX21hY3Jvcy5tYXg7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAibWFwIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3JlZHVjZV9jb21wdXRlZF9tYWNyb3MubWFwOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgInNvcnQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcmVkdWNlX2NvbXB1dGVkX21hY3Jvcy5zb3J0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgInNldERpZmYiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcmVkdWNlX2NvbXB1dGVkX21hY3Jvcy5zZXREaWZmOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIm1hcEJ5IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3JlZHVjZV9jb21wdXRlZF9tYWNyb3MubWFwQnk7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiZmlsdGVyIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3JlZHVjZV9jb21wdXRlZF9tYWNyb3MuZmlsdGVyOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImZpbHRlckJ5IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3JlZHVjZV9jb21wdXRlZF9tYWNyb3MuZmlsdGVyQnk7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAidW5pcSIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9yZWR1Y2VfY29tcHV0ZWRfbWFjcm9zLnVuaXE7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAidW5pcUJ5IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3JlZHVjZV9jb21wdXRlZF9tYWNyb3MudW5pcUJ5OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgInVuaW9uIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3JlZHVjZV9jb21wdXRlZF9tYWNyb3MudW5pb247CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiaW50ZXJzZWN0IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3JlZHVjZV9jb21wdXRlZF9tYWNyb3MuaW50ZXJzZWN0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImNvbGxlY3QiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcmVkdWNlX2NvbXB1dGVkX21hY3Jvcy5jb2xsZWN0OwogICAgfQogIH0pOwp9KTsKZGVmaW5lKCJAZW1iZXIvb2JqZWN0L2luZGV4IiwgWyJleHBvcnRzIiwgIkBlbWJlci9kZWJ1ZyIsICJAZW1iZXIvcG9seWZpbGxzIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGFsIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2RlYnVnLCBfcG9seWZpbGxzLCBfbWV0YWwpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmFjdGlvbiA9IGFjdGlvbjsKCiAgLyoqCiAgICBEZWNvcmF0b3IgdGhhdCB0dXJucyB0aGUgdGFyZ2V0IGZ1bmN0aW9uIGludG8gYW4gQWN0aW9uIHdoaWNoIGNhbiBiZSBhY2Nlc3NlZAogICAgZGlyZWN0bHkgYnkgcmVmZXJlbmNlLgogIAogICAgYGBganMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICBpbXBvcnQgeyBhY3Rpb24sIHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgVG9vbHRpcCBleHRlbmRzIENvbXBvbmVudCB7CiAgICAgIEBhY3Rpb24KICAgICAgdG9nZ2xlU2hvd2luZygpIHsKICAgICAgICBzZXQodGhpcywgJ2lzU2hvd2luZycsICF0aGlzLmlzU2hvd2luZyk7CiAgICAgIH0KICAgIH0KICAgIGBgYAogICAgYGBgaGJzCiAgICA8IS0tIHRlbXBsYXRlLmhicyAtLT4KICAgIDxidXR0b24ge3thY3Rpb24gdGhpcy50b2dnbGVTaG93aW5nfX0+U2hvdyB0b29sdGlwPC9idXR0b24+CiAgCiAgICB7eyNpZiBpc1Nob3dpbmd9fQogICAgICA8ZGl2IGNsYXNzPSJ0b29sdGlwIj4KICAgICAgICBJJ20gYSB0b29sdGlwIQogICAgICA8L2Rpdj4KICAgIHt7L2lmfX0KICAgIGBgYAogIAogICAgRGVjb3JhdGVkIGFjdGlvbnMgYWxzbyBpbnRlcm9wIHdpdGggdGhlIHN0cmluZyBzdHlsZSB0ZW1wbGF0ZSBhY3Rpb25zOgogIAogICAgYGBgaGJzCiAgICA8IS0tIHRlbXBsYXRlLmhicyAtLT4KICAgIDxidXR0b24ge3thY3Rpb24gInRvZ2dsZVNob3dpbmcifX0+U2hvdyB0b29sdGlwPC9idXR0b24+CiAgCiAgICB7eyNpZiBpc1Nob3dpbmd9fQogICAgICA8ZGl2IGNsYXNzPSJ0b29sdGlwIj4KICAgICAgICBJJ20gYSB0b29sdGlwIQogICAgICA8L2Rpdj4KICAgIHt7L2lmfX0KICAgIGBgYAogIAogICAgSXQgYWxzbyBiaW5kcyB0aGUgZnVuY3Rpb24gZGlyZWN0bHkgdG8gdGhlIGluc3RhbmNlLCBzbyBpdCBjYW4gYmUgdXNlZCBpbiBhbnkKICAgIGNvbnRleHQgYW5kIHdpbGwgY29ycmVjdGx5IHJlZmVyIHRvIHRoZSBjbGFzcyBpdCBjYW1lIGZyb206CiAgCiAgICBgYGBoYnMKICAgIDwhLS0gdGVtcGxhdGUuaGJzIC0tPgogICAgPGJ1dHRvbgogICAgICB7e2RpZC1pbnNlcnQgdGhpcy50b2dnbGVTaG93aW5nfX0KICAgICAge3tvbiAiY2xpY2siIHRoaXMudG9nZ2xlU2hvd2luZ319CiAgICA+CiAgICAgIFNob3cgdG9vbHRpcAogICAgPC9idXR0b24+CiAgCiAgICB7eyNpZiBpc1Nob3dpbmd9fQogICAgICA8ZGl2IGNsYXNzPSJ0b29sdGlwIj4KICAgICAgICBJJ20gYSB0b29sdGlwIQogICAgICA8L2Rpdj4KICAgIHt7L2lmfX0KICAgIGBgYAogIAogICAgVGhpcyBjYW4gYWxzbyBiZSB1c2VkIGluIEphdmFTY3JpcHQgY29kZSBkaXJlY3RseToKICAKICAgIGBgYGpzCiAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgaW1wb3J0IHsgYWN0aW9uLCBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIFRvb2x0aXAgZXh0ZW5kcyBDb21wb25lbnQgewogICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICBzdXBlciguLi5hcmd1bWVudHMpOwogIAogICAgICAgIC8vIHRoaXMudG9nZ2xlU2hvd2luZyBpcyBzdGlsbCBib3VuZCBjb3JyZWN0bHkgd2hlbiBhZGRlZCB0bwogICAgICAgIC8vIHRoZSBldmVudCBsaXN0ZW5lcgogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy50b2dnbGVTaG93aW5nKTsKICAgICAgfQogIAogICAgICBAYWN0aW9uCiAgICAgIHRvZ2dsZVNob3dpbmcoKSB7CiAgICAgICAgc2V0KHRoaXMsICdpc1Nob3dpbmcnLCAhdGhpcy5pc1Nob3dpbmcpOwogICAgICB9CiAgICB9CiAgICBgYGAKICAKICAgIFRoaXMgaXMgY29uc2lkZXJlZCBiZXN0IHByYWN0aWNlLCBzaW5jZSBpdCBtZWFucyB0aGF0IG1ldGhvZHMgd2lsbCBiZSBib3VuZAogICAgY29ycmVjdGx5IG5vIG1hdHRlciB3aGVyZSB0aGV5IGFyZSB1c2VkLiBCeSBjb250cmFzdCwgdGhlIGB7e2FjdGlvbn19YCBoZWxwZXIKICAgIGFuZCBtb2RpZmllciBjYW4gYWxzbyBiZSB1c2VkIHRvIGJpbmQgY29udGV4dCwgYnV0IGl0IHdpbGwgYmUgcmVxdWlyZWQgZm9yCiAgICBldmVyeSB1c2FnZSBvZiB0aGUgbWV0aG9kOgogIAogICAgYGBgaGJzCiAgICA8IS0tIHRlbXBsYXRlLmhicyAtLT4KICAgIDxidXR0b24KICAgICAge3tkaWQtaW5zZXJ0IChhY3Rpb24gdGhpcy50b2dnbGVTaG93aW5nKX19CiAgICAgIHt7b24gImNsaWNrIiAoYWN0aW9uIHRoaXMudG9nZ2xlU2hvd2luZyl9fQogICAgPgogICAgICBTaG93IHRvb2x0aXAKICAgIDwvYnV0dG9uPgogIAogICAge3sjaWYgaXNTaG93aW5nfX0KICAgICAgPGRpdiBjbGFzcz0idG9vbHRpcCI+CiAgICAgICAgSSdtIGEgdG9vbHRpcCEKICAgICAgPC9kaXY+CiAgICB7ey9pZn19CiAgICBgYGAKICAKICAgIFRoZXkgYWxzbyBkbyBub3QgaGF2ZSBlcXVpdmFsZW50cyBpbiBKYXZhU2NyaXB0IGRpcmVjdGx5LCBzbyB0aGV5IGNhbm5vdCBiZQogICAgdXNlZCBmb3Igb3RoZXIgc2l0dWF0aW9ucyB3aGVyZSBiaW5kaW5nIHdvdWxkIGJlIHVzZWZ1bC4KICAKICAgIEBwdWJsaWMKICAgIEBtZXRob2QgYWN0aW9uCiAgICBAZm9yIEBlbWJlci9vYmplY3QKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7RnVuY3Rpb258dW5kZWZpbmVkfSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gdHVybiBpbnRvIGFuIGFjdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGVuIHVzZWQgaW4gY2xhc3NpYyBjbGFzc2VzCiAgICBAcmV0dXJuIHtQcm9wZXJ0eURlY29yYXRvcn0gcHJvcGVydHkgZGVjb3JhdG9yIGluc3RhbmNlCiAgKi8KICB2YXIgQklORElOR1NfTUFQID0gbmV3IFdlYWtNYXAoKTsKCiAgZnVuY3Rpb24gc2V0dXBBY3Rpb24odGFyZ2V0LCBrZXksIGFjdGlvbkZuKSB7CiAgICBpZiAodGFyZ2V0LmNvbnN0cnVjdG9yICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHRhcmdldC5jb25zdHJ1Y3Rvci5wcm90byA9PT0gJ2Z1bmN0aW9uJykgewogICAgICB0YXJnZXQuY29uc3RydWN0b3IucHJvdG8oKTsKICAgIH0KCiAgICBpZiAoIXRhcmdldC5oYXNPd25Qcm9wZXJ0eSgnYWN0aW9ucycpKSB7CiAgICAgIHZhciBwYXJlbnRBY3Rpb25zID0gdGFyZ2V0LmFjdGlvbnM7IC8vIHdlIG5lZWQgdG8gYXNzaWduIGJlY2F1c2Ugb2YgdGhlIHdheSBtaXhpbnMgY29weSBhY3Rpb25zIGRvd24gd2hlbiBpbmhlcml0aW5nCgogICAgICB0YXJnZXQuYWN0aW9ucyA9IHBhcmVudEFjdGlvbnMgPyAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCBwYXJlbnRBY3Rpb25zKSA6IHt9OwogICAgfQoKICAgIHRhcmdldC5hY3Rpb25zW2tleV0gPSBhY3Rpb25GbjsKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHZhciBiaW5kaW5ncyA9IEJJTkRJTkdTX01BUC5nZXQodGhpcyk7CgogICAgICAgIGlmIChiaW5kaW5ncyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBiaW5kaW5ncyA9IG5ldyBNYXAoKTsKICAgICAgICAgIEJJTkRJTkdTX01BUC5zZXQodGhpcywgYmluZGluZ3MpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGZuID0gYmluZGluZ3MuZ2V0KGFjdGlvbkZuKTsKCiAgICAgICAgaWYgKGZuID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGZuID0gYWN0aW9uRm4uYmluZCh0aGlzKTsKICAgICAgICAgIGJpbmRpbmdzLnNldChhY3Rpb25GbiwgZm4pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZuOwogICAgICB9CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gYWN0aW9uKHRhcmdldCwga2V5LCBkZXNjKSB7CiAgICB2YXIgYWN0aW9uRm47CgogICAgaWYgKCEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKFt0YXJnZXQsIGtleSwgZGVzY10pKSB7CiAgICAgIGFjdGlvbkZuID0gdGFyZ2V0OwoKICAgICAgdmFyIGRlY29yYXRvciA9IGZ1bmN0aW9uIGRlY29yYXRvcih0YXJnZXQsIGtleSwgZGVzYywgbWV0YSwgaXNDbGFzc2ljRGVjb3JhdG9yKSB7CiAgICAgICAgKGZhbHNlICYmICEoaXNDbGFzc2ljRGVjb3JhdG9yKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1RoZSBAYWN0aW9uIGRlY29yYXRvciBtYXkgb25seSBiZSBwYXNzZWQgYSBtZXRob2Qgd2hlbiB1c2VkIGluIGNsYXNzaWMgY2xhc3Nlcy4gWW91IHNob3VsZCBkZWNvcmF0ZSBtZXRob2RzIGRpcmVjdGx5IGluIG5hdGl2ZSBjbGFzc2VzJywgaXNDbGFzc2ljRGVjb3JhdG9yKSk7CiAgICAgICAgKGZhbHNlICYmICEodHlwZW9mIGFjdGlvbkZuID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1RoZSBhY3Rpb24oKSBkZWNvcmF0b3IgbXVzdCBiZSBwYXNzZWQgYSBtZXRob2Qgd2hlbiB1c2VkIGluIGNsYXNzaWMgY2xhc3NlcycsIHR5cGVvZiBhY3Rpb25GbiA9PT0gJ2Z1bmN0aW9uJykpOwogICAgICAgIHJldHVybiBzZXR1cEFjdGlvbih0YXJnZXQsIGtleSwgYWN0aW9uRm4pOwogICAgICB9OwoKICAgICAgKDAsIF9tZXRhbC5zZXRDbGFzc2ljRGVjb3JhdG9yKShkZWNvcmF0b3IpOwogICAgICByZXR1cm4gZGVjb3JhdG9yOwogICAgfQoKICAgIGFjdGlvbkZuID0gZGVzYy52YWx1ZTsKICAgIChmYWxzZSAmJiAhKHR5cGVvZiBhY3Rpb25GbiA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUaGUgQGFjdGlvbiBkZWNvcmF0b3IgbXVzdCBiZSBhcHBsaWVkIHRvIG1ldGhvZHMgd2hlbiB1c2VkIGluIG5hdGl2ZSBjbGFzc2VzJywgdHlwZW9mIGFjdGlvbkZuID09PSAnZnVuY3Rpb24nKSk7CiAgICByZXR1cm4gc2V0dXBBY3Rpb24odGFyZ2V0LCBrZXksIGFjdGlvbkZuKTsKICB9CgogICgwLCBfbWV0YWwuc2V0Q2xhc3NpY0RlY29yYXRvcikoYWN0aW9uKTsKfSk7CmRlZmluZSgiQGVtYmVyL29iamVjdC9saWIvY29tcHV0ZWQvY29tcHV0ZWRfbWFjcm9zIiwgWyJleHBvcnRzIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGFsIiwgIkBlbWJlci9kZWJ1ZyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9tZXRhbCwgX2RlYnVnKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5lbXB0eSA9IGVtcHR5OwogIF9leHBvcnRzLm5vdEVtcHR5ID0gbm90RW1wdHk7CiAgX2V4cG9ydHMubm9uZSA9IG5vbmU7CiAgX2V4cG9ydHMubm90ID0gbm90OwogIF9leHBvcnRzLmJvb2wgPSBib29sOwogIF9leHBvcnRzLm1hdGNoID0gbWF0Y2g7CiAgX2V4cG9ydHMuZXF1YWwgPSBlcXVhbDsKICBfZXhwb3J0cy5ndCA9IGd0OwogIF9leHBvcnRzLmd0ZSA9IGd0ZTsKICBfZXhwb3J0cy5sdCA9IGx0OwogIF9leHBvcnRzLmx0ZSA9IGx0ZTsKICBfZXhwb3J0cy5vbmVXYXkgPSBvbmVXYXk7CiAgX2V4cG9ydHMucmVhZE9ubHkgPSByZWFkT25seTsKICBfZXhwb3J0cy5kZXByZWNhdGluZ0FsaWFzID0gZGVwcmVjYXRpbmdBbGlhczsKICBfZXhwb3J0cy5vciA9IF9leHBvcnRzLmFuZCA9IHZvaWQgMDsKCiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgKi8KICBmdW5jdGlvbiBleHBhbmRQcm9wZXJ0aWVzVG9BcnJheShwcmVkaWNhdGVOYW1lLCBwcm9wZXJ0aWVzKSB7CiAgICB2YXIgZXhwYW5kZWRQcm9wZXJ0aWVzID0gW107CgogICAgZnVuY3Rpb24gZXh0cmFjdFByb3BlcnR5KGVudHJ5KSB7CiAgICAgIGV4cGFuZGVkUHJvcGVydGllcy5wdXNoKGVudHJ5KTsKICAgIH0KCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BlcnRpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIHByb3BlcnR5ID0gcHJvcGVydGllc1tpXTsKICAgICAgKGZhbHNlICYmICEocHJvcGVydHkuaW5kZXhPZignICcpIDwgMCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJEZXBlbmRlbnQga2V5cyBwYXNzZWQgdG8gY29tcHV0ZWQuIiArIHByZWRpY2F0ZU5hbWUgKyAiKCkgY2FuJ3QgaGF2ZSBzcGFjZXMuIiwgcHJvcGVydHkuaW5kZXhPZignICcpIDwgMCkpOwogICAgICAoMCwgX21ldGFsLmV4cGFuZFByb3BlcnRpZXMpKHByb3BlcnR5LCBleHRyYWN0UHJvcGVydHkpOwogICAgfQoKICAgIHJldHVybiBleHBhbmRlZFByb3BlcnRpZXM7CiAgfQoKICBmdW5jdGlvbiBnZW5lcmF0ZUNvbXB1dGVkV2l0aFByZWRpY2F0ZShuYW1lLCBwcmVkaWNhdGUpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBwcm9wZXJ0aWVzID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIHByb3BlcnRpZXNbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIChmYWxzZSAmJiAhKCEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKHByb3BlcnRpZXMpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIllvdSBhdHRlbXB0ZWQgdG8gdXNlIEAiICsgbmFtZSArICIgYXMgYSBkZWNvcmF0b3IgZGlyZWN0bHksIGJ1dCBpdCByZXF1aXJlcyBhdCBsZWFzdCBvbmUgZGVwZW5kZW50IGtleSBwYXJhbWV0ZXIiLCAhKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShwcm9wZXJ0aWVzKSkpOwogICAgICB2YXIgZGVwZW5kZW50S2V5cyA9IGV4cGFuZFByb3BlcnRpZXNUb0FycmF5KG5hbWUsIHByb3BlcnRpZXMpOwoKICAgICAgdmFyIGNvbXB1dGVkRnVuYyA9IF9tZXRhbC5jb21wdXRlZC5hcHBseSh2b2lkIDAsIGRlcGVuZGVudEtleXMuY29uY2F0KFtmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGxhc3RJZHggPSBkZXBlbmRlbnRLZXlzLmxlbmd0aCAtIDE7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGFzdElkeDsgaSsrKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSAoMCwgX21ldGFsLmdldCkodGhpcywgZGVwZW5kZW50S2V5c1tpXSk7CgogICAgICAgICAgaWYgKCFwcmVkaWNhdGUodmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiAoMCwgX21ldGFsLmdldCkodGhpcywgZGVwZW5kZW50S2V5c1tsYXN0SWR4XSk7CiAgICAgIH1dKSk7CgogICAgICByZXR1cm4gY29tcHV0ZWRGdW5jOwogICAgfTsKICB9CiAgLyoqCiAgICBBIGNvbXB1dGVkIHByb3BlcnR5IG1hY3JvIHRoYXQgcmV0dXJucyB0cnVlIGlmIHRoZSB2YWx1ZSBvZiB0aGUgZGVwZW5kZW50CiAgICBwcm9wZXJ0eSBpcyBudWxsLCBhbiBlbXB0eSBzdHJpbmcsIGVtcHR5IGFycmF5LCBvciBlbXB0eSBmdW5jdGlvbi4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IGVtcHR5IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBjbGFzcyBUb0RvTGlzdCB7CiAgICAgIGNvbnN0cnVjdG9yKHRvZG9zKSB7CiAgICAgICAgc2V0KHRoaXMsICd0b2RvcycsIHRvZG9zKTsKICAgICAgfQogIAogICAgICBAZW1wdHkoJ3RvZG9zJykgaXNEb25lOwogICAgfQogIAogICAgbGV0IHRvZG9MaXN0ID0gbmV3IFRvRG9MaXN0KAogICAgICBbJ1VuaXQgVGVzdCcsICdEb2N1bWVudGF0aW9uJywgJ1JlbGVhc2UnXQogICAgKTsKICAKICAgIHRvZG9MaXN0LmlzRG9uZTsgLy8gZmFsc2UKICAgIHNldCh0b2RvTGlzdCwgJ3RvZG9zJywgW10pOwogICAgdG9kb0xpc3QuaXNEb25lOyAvLyB0cnVlCiAgICBgYGAKICAKICAgIENsYXNzaWMgQ2xhc3MgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBFbWJlck9iamVjdCwgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IGVtcHR5IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBsZXQgVG9Eb0xpc3QgPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICBpc0RvbmU6IGVtcHR5KCd0b2RvcycpCiAgICB9KTsKICAKICAgIGxldCB0b2RvTGlzdCA9IFRvRG9MaXN0LmNyZWF0ZSh7CiAgICAgIHRvZG9zOiBbJ1VuaXQgVGVzdCcsICdEb2N1bWVudGF0aW9uJywgJ1JlbGVhc2UnXQogICAgfSk7CiAgCiAgICB0b2RvTGlzdC5pc0RvbmU7IC8vIGZhbHNlCiAgICBzZXQodG9kb0xpc3QsICd0b2RvcycsIFtdKTsKICAgIHRvZG9MaXN0LmlzRG9uZTsgLy8gdHJ1ZQogICAgYGBgCiAgCiAgICBAc2luY2UgMS42LjAKICAgIEBtZXRob2QgZW1wdHkKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucyB0cnVlIGlmIHRoZSB2YWx1ZQogICAgb2YgdGhlIGRlcGVuZGVudCBwcm9wZXJ0eSBpcyBudWxsLCBhbiBlbXB0eSBzdHJpbmcsIGVtcHR5IGFycmF5LCBvciBlbXB0eQogICAgZnVuY3Rpb24gYW5kIGZhbHNlIGlmIHRoZSB1bmRlcmx5aW5nIHZhbHVlIGlzIG5vdCBlbXB0eS4KICAKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gZW1wdHkoZGVwZW5kZW50S2V5KSB7CiAgICAoZmFsc2UgJiYgISghKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgYXR0ZW1wdGVkIHRvIHVzZSBAZW1wdHkgYXMgYSBkZWNvcmF0b3IgZGlyZWN0bHksIGJ1dCBpdCByZXF1aXJlcyBhIGBkZXBlbmRlbnRLZXlgIHBhcmFtZXRlcicsICEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKSk7CiAgICByZXR1cm4gKDAsIF9tZXRhbC5jb21wdXRlZCkoZGVwZW5kZW50S2V5ICsgIi5sZW5ndGgiLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAoMCwgX21ldGFsLmlzRW1wdHkpKCgwLCBfbWV0YWwuZ2V0KSh0aGlzLCBkZXBlbmRlbnRLZXkpKTsKICAgIH0pOwogIH0KICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRydWUgaWYgdGhlIHZhbHVlIG9mIHRoZSBkZXBlbmRlbnQgcHJvcGVydHkKICAgIGlzIE5PVCBudWxsLCBhbiBlbXB0eSBzdHJpbmcsIGVtcHR5IGFycmF5LCBvciBlbXB0eSBmdW5jdGlvbi4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IG5vdEVtcHR5IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBjbGFzcyBIYW1zdGVyIHsKICAgICAgY29uc3RydWN0b3IoYmFja3BhY2spIHsKICAgICAgICBzZXQodGhpcywgJ2JhY2twYWNrJywgYmFja3BhY2spOwogICAgICB9CiAgCiAgICAgIEBub3RFbXB0eSgnYmFja3BhY2snKSBoYXNTdHVmZgogICAgfQogIAogICAgbGV0IGhhbXN0ZXIgPSBuZXcgSGFtc3RlcigKICAgICAgWydGb29kJywgJ1NsZWVwaW5nIEJhZycsICdUZW50J10KICAgICk7CiAgCiAgICBoYW1zdGVyLmhhc1N0dWZmOyAvLyB0cnVlCiAgICBzZXQoaGFtc3RlciwgJ2JhY2twYWNrJywgW10pOwogICAgaGFtc3Rlci5oYXNTdHVmZjsgLy8gZmFsc2UKICAgIGBgYAogIAogICAgQ2xhc3NpYyBDbGFzcyBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgbm90RW1wdHkgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgaGFzU3R1ZmY6IG5vdEVtcHR5KCdiYWNrcGFjaycpCiAgICB9KTsKICAKICAgIGxldCBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoewogICAgICBiYWNrcGFjazogWydGb29kJywgJ1NsZWVwaW5nIEJhZycsICdUZW50J10KICAgIH0pOwogIAogICAgaGFtc3Rlci5oYXNTdHVmZjsgLy8gdHJ1ZQogICAgc2V0KGhhbXN0ZXIsICdiYWNrcGFjaycsIFtdKTsKICAgIGhhbXN0ZXIuaGFzU3R1ZmY7IC8vIGZhbHNlCiAgICBgYGAKICAKICAgIEBtZXRob2Qgbm90RW1wdHkKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucyB0cnVlIGlmIG9yaWdpbmFsCiAgICB2YWx1ZSBmb3IgcHJvcGVydHkgaXMgbm90IGVtcHR5LgogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBub3RFbXB0eShkZXBlbmRlbnRLZXkpIHsKICAgIChmYWxzZSAmJiAhKCEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBhdHRlbXB0ZWQgdG8gdXNlIEBub3RFbXB0eSBhcyBhIGRlY29yYXRvciBkaXJlY3RseSwgYnV0IGl0IHJlcXVpcmVzIGEgYGRlcGVuZGVudEtleWAgcGFyYW1ldGVyJywgISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpKTsKICAgIHJldHVybiAoMCwgX21ldGFsLmNvbXB1dGVkKShkZXBlbmRlbnRLZXkgKyAiLmxlbmd0aCIsIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICEoMCwgX21ldGFsLmlzRW1wdHkpKCgwLCBfbWV0YWwuZ2V0KSh0aGlzLCBkZXBlbmRlbnRLZXkpKTsKICAgIH0pOwogIH0KICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRydWUgaWYgdGhlIHZhbHVlIG9mIHRoZSBkZXBlbmRlbnQgcHJvcGVydHkKICAgIGlzIG51bGwgb3IgdW5kZWZpbmVkLiBUaGlzIGF2b2lkcyBlcnJvcnMgZnJvbSBKU0xpbnQgY29tcGxhaW5pbmcgYWJvdXQgdXNlIG9mCiAgICA9PSwgd2hpY2ggY2FuIGJlIHRlY2huaWNhbGx5IGNvbmZ1c2luZy4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgbm9uZSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgSGFtc3RlciB7CiAgICAgIEBub25lKCdmb29kJykgaXNIdW5ncnk7CiAgICB9CiAgCiAgICBsZXQgaGFtc3RlciA9IG5ldyBIYW1zdGVyKCk7CiAgCiAgICBoYW1zdGVyLmlzSHVuZ3J5OyAvLyB0cnVlCiAgCiAgICBzZXQoaGFtc3RlciwgJ2Zvb2QnLCAnQmFuYW5hJyk7CiAgICBoYW1zdGVyLmlzSHVuZ3J5OyAvLyBmYWxzZQogIAogICAgc2V0KGhhbXN0ZXIsICdmb29kJywgbnVsbCk7CiAgICBoYW1zdGVyLmlzSHVuZ3J5OyAvLyB0cnVlCiAgICBgYGAKICAKICAgIENsYXNzaWMgQ2xhc3MgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBFbWJlck9iamVjdCwgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IG5vbmUgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgaXNIdW5ncnk6IG5vbmUoJ2Zvb2QnKQogICAgfSk7CiAgCiAgICBsZXQgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKCk7CiAgCiAgICBoYW1zdGVyLmlzSHVuZ3J5OyAvLyB0cnVlCiAgCiAgICBzZXQoaGFtc3RlciwgJ2Zvb2QnLCAnQmFuYW5hJyk7CiAgICBoYW1zdGVyLmlzSHVuZ3J5OyAvLyBmYWxzZQogIAogICAgc2V0KGhhbXN0ZXIsICdmb29kJywgbnVsbCk7CiAgICBoYW1zdGVyLmlzSHVuZ3J5OyAvLyB0cnVlCiAgICBgYGAKICAKICAgIEBtZXRob2Qgbm9uZQogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCByZXR1cm5zIHRydWUgaWYgb3JpZ2luYWwKICAgIHZhbHVlIGZvciBwcm9wZXJ0eSBpcyBudWxsIG9yIHVuZGVmaW5lZC4KICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gbm9uZShkZXBlbmRlbnRLZXkpIHsKICAgIChmYWxzZSAmJiAhKCEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBhdHRlbXB0ZWQgdG8gdXNlIEBub25lIGFzIGEgZGVjb3JhdG9yIGRpcmVjdGx5LCBidXQgaXQgcmVxdWlyZXMgYSBgZGVwZW5kZW50S2V5YCBwYXJhbWV0ZXInLCAhKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkpOwogICAgcmV0dXJuICgwLCBfbWV0YWwuY29tcHV0ZWQpKGRlcGVuZGVudEtleSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gKDAsIF9tZXRhbC5pc05vbmUpKCgwLCBfbWV0YWwuZ2V0KSh0aGlzLCBkZXBlbmRlbnRLZXkpKTsKICAgIH0pOwogIH0KICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRoZSBpbnZlcnNlIGJvb2xlYW4gdmFsdWUgb2YgdGhlIG9yaWdpbmFsCiAgICB2YWx1ZSBmb3IgdGhlIGRlcGVuZGVudCBwcm9wZXJ0eS4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IG5vdCB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgVXNlciB7CiAgICAgIGxvZ2dlZEluID0gZmFsc2U7CiAgCiAgICAgIEBub3QoJ2xvZ2dlZEluJykgaXNBbm9ueW1vdXM7CiAgICB9CiAgCiAgICBsZXQgdXNlciA9IG5ldyBVc2VyKCk7CiAgCiAgICB1c2VyLmlzQW5vbnltb3VzOyAvLyB0cnVlCiAgICBzZXQodXNlciwgJ2xvZ2dlZEluJywgdHJ1ZSk7CiAgICB1c2VyLmlzQW5vbnltb3VzOyAvLyBmYWxzZQogICAgYGBgCiAgCiAgICBDbGFzc2ljIENsYXNzIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgRW1iZXJPYmplY3QsIHsgc2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBub3QgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGxldCBVc2VyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgbG9nZ2VkSW46IGZhbHNlLAogIAogICAgICBpc0Fub255bW91czogbm90KCdsb2dnZWRJbicpCiAgICB9KTsKICAKICAgIGxldCB1c2VyID0gVXNlci5jcmVhdGUoKTsKICAKICAgIHVzZXIuaXNBbm9ueW1vdXM7IC8vIHRydWUKICAgIHNldCh1c2VyLCAnbG9nZ2VkSW4nLCB0cnVlKTsKICAgIHVzZXIuaXNBbm9ueW1vdXM7IC8vIGZhbHNlCiAgICBgYGAKICAKICAgIEBtZXRob2Qgbm90CiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIHJldHVybnMgaW52ZXJzZSBvZiB0aGUKICAgIG9yaWdpbmFsIHZhbHVlIGZvciBwcm9wZXJ0eQogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBub3QoZGVwZW5kZW50S2V5KSB7CiAgICAoZmFsc2UgJiYgISghKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgYXR0ZW1wdGVkIHRvIHVzZSBAbm90IGFzIGEgZGVjb3JhdG9yIGRpcmVjdGx5LCBidXQgaXQgcmVxdWlyZXMgYSBgZGVwZW5kZW50S2V5YCBwYXJhbWV0ZXInLCAhKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkpOwogICAgcmV0dXJuICgwLCBfbWV0YWwuY29tcHV0ZWQpKGRlcGVuZGVudEtleSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gISgwLCBfbWV0YWwuZ2V0KSh0aGlzLCBkZXBlbmRlbnRLZXkpOwogICAgfSk7CiAgfQogIC8qKgogICAgQSBjb21wdXRlZCBwcm9wZXJ0eSB0aGF0IGNvbnZlcnRzIHRoZSBwcm92aWRlZCBkZXBlbmRlbnQgcHJvcGVydHkgaW50byBhCiAgICBib29sZWFuIHZhbHVlLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgYm9vbCB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogIAogICAgY2xhc3MgSGFtc3RlciB7CiAgICAgIEBib29sKCdudW1CYW5hbmFzJykgaGFzQmFuYW5hcwogICAgfQogIAogICAgbGV0IGhhbXN0ZXIgPSBuZXcgSGFtc3RlcigpOwogIAogICAgaGFtc3Rlci5oYXNCYW5hbmFzOyAvLyBmYWxzZQogIAogICAgc2V0KGhhbXN0ZXIsICdudW1CYW5hbmFzJywgMCk7CiAgICBoYW1zdGVyLmhhc0JhbmFuYXM7IC8vIGZhbHNlCiAgCiAgICBzZXQoaGFtc3RlciwgJ251bUJhbmFuYXMnLCAxKTsKICAgIGhhbXN0ZXIuaGFzQmFuYW5hczsgLy8gdHJ1ZQogIAogICAgc2V0KGhhbXN0ZXIsICdudW1CYW5hbmFzJywgbnVsbCk7CiAgICBoYW1zdGVyLmhhc0JhbmFuYXM7IC8vIGZhbHNlCiAgICBgYGAKICAKICAgIENsYXNzaWMgQ2xhc3MgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBFbWJlck9iamVjdCwgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IGJvb2wgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgaGFzQmFuYW5hczogYm9vbCgnbnVtQmFuYW5hcycpCiAgICB9KTsKICAKICAgIGxldCBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoKTsKICAKICAgIGhhbXN0ZXIuaGFzQmFuYW5hczsgLy8gZmFsc2UKICAKICAgIHNldChoYW1zdGVyLCAnbnVtQmFuYW5hcycsIDApOwogICAgaGFtc3Rlci5oYXNCYW5hbmFzOyAvLyBmYWxzZQogIAogICAgc2V0KGhhbXN0ZXIsICdudW1CYW5hbmFzJywgMSk7CiAgICBoYW1zdGVyLmhhc0JhbmFuYXM7IC8vIHRydWUKICAKICAgIHNldChoYW1zdGVyLCAnbnVtQmFuYW5hcycsIG51bGwpOwogICAgaGFtc3Rlci5oYXNCYW5hbmFzOyAvLyBmYWxzZQogICAgYGBgCiAgCiAgICBAbWV0aG9kIGJvb2wKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggY29udmVydHMgdG8gYm9vbGVhbiB0aGUKICAgIG9yaWdpbmFsIHZhbHVlIGZvciBwcm9wZXJ0eQogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBib29sKGRlcGVuZGVudEtleSkgewogICAgKGZhbHNlICYmICEoISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGF0dGVtcHRlZCB0byB1c2UgQGJvb2wgYXMgYSBkZWNvcmF0b3IgZGlyZWN0bHksIGJ1dCBpdCByZXF1aXJlcyBhIGBkZXBlbmRlbnRLZXlgIHBhcmFtZXRlcicsICEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKSk7CiAgICByZXR1cm4gKDAsIF9tZXRhbC5jb21wdXRlZCkoZGVwZW5kZW50S2V5LCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBCb29sZWFuKCgwLCBfbWV0YWwuZ2V0KSh0aGlzLCBkZXBlbmRlbnRLZXkpKTsKICAgIH0pOwogIH0KICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggbWF0Y2hlcyB0aGUgb3JpZ2luYWwgdmFsdWUgZm9yIHRoZSBkZXBlbmRlbnQKICAgIHByb3BlcnR5IGFnYWluc3QgYSBnaXZlbiBSZWdFeHAsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIHZhbHVlIG1hdGNoZXMgdGhlCiAgICBSZWdFeHAgYW5kIGBmYWxzZWAgaWYgaXQgZG9lcyBub3QuCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgc2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBtYXRjaCB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgVXNlciB7CiAgICAgIEBtYXRjaCgnZW1haWwnLCAvXi4rQC4rXC4uKyQvKSBoYXNWYWxpZEVtYWlsOwogICAgfQogIAogICAgbGV0IHVzZXIgPSBuZXcgVXNlcigpOwogIAogICAgdXNlci5oYXNWYWxpZEVtYWlsOyAvLyBmYWxzZQogIAogICAgc2V0KHVzZXIsICdlbWFpbCcsICcnKTsKICAgIHVzZXIuaGFzVmFsaWRFbWFpbDsgLy8gZmFsc2UKICAKICAgIHNldCh1c2VyLCAnZW1haWwnLCAnZW1iZXJfaGFtc3RlckBleGFtcGxlLmNvbScpOwogICAgdXNlci5oYXNWYWxpZEVtYWlsOyAvLyB0cnVlCiAgICBgYGAKICAKICAgIENsYXNzaWMgQ2xhc3MgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBFbWJlck9iamVjdCwgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IG1hdGNoIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBsZXQgVXNlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGhhc1ZhbGlkRW1haWw6IG1hdGNoKCdlbWFpbCcsIC9eLitALitcLi4rJC8pCiAgICB9KTsKICAKICAgIGxldCB1c2VyID0gVXNlci5jcmVhdGUoKTsKICAKICAgIHVzZXIuaGFzVmFsaWRFbWFpbDsgLy8gZmFsc2UKICAKICAgIHNldCh1c2VyLCAnZW1haWwnLCAnJyk7CiAgICB1c2VyLmhhc1ZhbGlkRW1haWw7IC8vIGZhbHNlCiAgCiAgICBzZXQodXNlciwgJ2VtYWlsJywgJ2VtYmVyX2hhbXN0ZXJAZXhhbXBsZS5jb20nKTsKICAgIHVzZXIuaGFzVmFsaWRFbWFpbDsgLy8gdHJ1ZQogICAgYGBgCiAgCiAgICBAbWV0aG9kIG1hdGNoCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICAgIEBwYXJhbSB7UmVnRXhwfSByZWdleHAKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIG1hdGNoIHRoZSBvcmlnaW5hbCB2YWx1ZQogICAgZm9yIHByb3BlcnR5IGFnYWluc3QgYSBnaXZlbiBSZWdFeHAKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gbWF0Y2goZGVwZW5kZW50S2V5LCByZWdleHApIHsKICAgIChmYWxzZSAmJiAhKCEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBhdHRlbXB0ZWQgdG8gdXNlIEBtYXRjaCBhcyBhIGRlY29yYXRvciBkaXJlY3RseSwgYnV0IGl0IHJlcXVpcmVzIGBkZXBlbmRlbnRLZXlgIGFuZCBgcmVnZXhwYCBwYXJhbWV0ZXJzJywgISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpKTsKICAgIHJldHVybiAoMCwgX21ldGFsLmNvbXB1dGVkKShkZXBlbmRlbnRLZXksIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHZhbHVlID0gKDAsIF9tZXRhbC5nZXQpKHRoaXMsIGRlcGVuZGVudEtleSk7CiAgICAgIHJldHVybiByZWdleHAudGVzdCh2YWx1ZSk7CiAgICB9KTsKICB9CiAgLyoqCiAgICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgcmV0dXJucyB0cnVlIGlmIHRoZSBwcm92aWRlZCBkZXBlbmRlbnQgcHJvcGVydHkgaXMKICAgIGVxdWFsIHRvIHRoZSBnaXZlbiB2YWx1ZS4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IGVxdWFsIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBjbGFzcyBIYW1zdGVyIHsKICAgICAgQGVxdWFsKCdwZXJjZW50Q2Fycm90c0VhdGVuJywgMTAwKSBzYXRpc2ZpZWQ7CiAgICB9CiAgCiAgICBsZXQgaGFtc3RlciA9IG5ldyBIYW1zdGVyKCk7CiAgCiAgICBoYW1zdGVyLnNhdGlzZmllZDsgLy8gZmFsc2UKICAKICAgIHNldChoYW1zdGVyLCAncGVyY2VudENhcnJvdHNFYXRlbicsIDEwMCk7CiAgICBoYW1zdGVyLnNhdGlzZmllZDsgLy8gdHJ1ZQogIAogICAgc2V0KGhhbXN0ZXIsICdwZXJjZW50Q2Fycm90c0VhdGVuJywgNTApOwogICAgaGFtc3Rlci5zYXRpc2ZpZWQ7IC8vIGZhbHNlCiAgICBgYGAKICAKICAgIENsYXNzaWMgQ2xhc3MgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBFbWJlck9iamVjdCwgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IGVxdWFsIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBsZXQgSGFtc3RlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIHNhdGlzZmllZDogZXF1YWwoJ3BlcmNlbnRDYXJyb3RzRWF0ZW4nLCAxMDApCiAgICB9KTsKICAKICAgIGxldCBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoKTsKICAKICAgIGhhbXN0ZXIuc2F0aXNmaWVkOyAvLyBmYWxzZQogIAogICAgc2V0KGhhbXN0ZXIsICdwZXJjZW50Q2Fycm90c0VhdGVuJywgMTAwKTsKICAgIGhhbXN0ZXIuc2F0aXNmaWVkOyAvLyB0cnVlCiAgCiAgICBzZXQoaGFtc3RlciwgJ3BlcmNlbnRDYXJyb3RzRWF0ZW4nLCA1MCk7CiAgICBoYW1zdGVyLnNhdGlzZmllZDsgLy8gZmFsc2UKICAgIGBgYAogIAogICAgQG1ldGhvZCBlcXVhbAogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ8T2JqZWN0fSB2YWx1ZQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucyB0cnVlIGlmIHRoZQogICAgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5IGlzIGVxdWFsIHRvIHRoZSBnaXZlbiB2YWx1ZS4KICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gZXF1YWwoZGVwZW5kZW50S2V5LCB2YWx1ZSkgewogICAgKGZhbHNlICYmICEoISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGF0dGVtcHRlZCB0byB1c2UgQGVxdWFsIGFzIGEgZGVjb3JhdG9yIGRpcmVjdGx5LCBidXQgaXQgcmVxdWlyZXMgYGRlcGVuZGVudEtleWAgYW5kIGB2YWx1ZWAgcGFyYW1ldGVyJywgISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpKTsKICAgIHJldHVybiAoMCwgX21ldGFsLmNvbXB1dGVkKShkZXBlbmRlbnRLZXksIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCBkZXBlbmRlbnRLZXkpID09PSB2YWx1ZTsKICAgIH0pOwogIH0KICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRydWUgaWYgdGhlIHByb3ZpZGVkIGRlcGVuZGVudCBwcm9wZXJ0eSBpcwogICAgZ3JlYXRlciB0aGFuIHRoZSBwcm92aWRlZCB2YWx1ZS4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IGd0IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBjbGFzcyBIYW1zdGVyIHsKICAgICAgQGd0KCdudW1CYW5hbmFzJywgMTApIGhhc1Rvb01hbnlCYW5hbmFzOwogICAgfQogIAogICAgbGV0IGhhbXN0ZXIgPSBuZXcgSGFtc3RlcigpOwogIAogICAgaGFtc3Rlci5oYXNUb29NYW55QmFuYW5hczsgLy8gZmFsc2UKICAKICAgIHNldChoYW1zdGVyLCAnbnVtQmFuYW5hcycsIDMpOwogICAgaGFtc3Rlci5oYXNUb29NYW55QmFuYW5hczsgLy8gZmFsc2UKICAKICAgIHNldChoYW1zdGVyLCAnbnVtQmFuYW5hcycsIDExKTsKICAgIGhhbXN0ZXIuaGFzVG9vTWFueUJhbmFuYXM7IC8vIHRydWUKICAgIGBgYAogIAogICAgQ2xhc3NpYyBDbGFzcyBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgZ3QgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgaGFzVG9vTWFueUJhbmFuYXM6IGd0KCdudW1CYW5hbmFzJywgMTApCiAgICB9KTsKICAKICAgIGxldCBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoKTsKICAKICAgIGhhbXN0ZXIuaGFzVG9vTWFueUJhbmFuYXM7IC8vIGZhbHNlCiAgCiAgICBzZXQoaGFtc3RlciwgJ251bUJhbmFuYXMnLCAzKTsKICAgIGhhbXN0ZXIuaGFzVG9vTWFueUJhbmFuYXM7IC8vIGZhbHNlCiAgCiAgICBzZXQoaGFtc3RlciwgJ251bUJhbmFuYXMnLCAxMSk7CiAgICBoYW1zdGVyLmhhc1Rvb01hbnlCYW5hbmFzOyAvLyB0cnVlCiAgICBgYGAKICAKICAgIEBtZXRob2QgZ3QKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHBhcmFtIHtOdW1iZXJ9IHZhbHVlCiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCByZXR1cm5zIHRydWUgaWYgdGhlCiAgICBvcmlnaW5hbCB2YWx1ZSBmb3IgcHJvcGVydHkgaXMgZ3JlYXRlciB0aGFuIGdpdmVuIHZhbHVlLgogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBndChkZXBlbmRlbnRLZXksIHZhbHVlKSB7CiAgICAoZmFsc2UgJiYgISghKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgYXR0ZW1wdGVkIHRvIHVzZSBAZ3QgYXMgYSBkZWNvcmF0b3IgZGlyZWN0bHksIGJ1dCBpdCByZXF1aXJlcyBgZGVwZW5kZW50S2V5YCBhbmQgYHZhbHVlYCBwYXJhbWV0ZXJzJywgISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpKTsKICAgIHJldHVybiAoMCwgX21ldGFsLmNvbXB1dGVkKShkZXBlbmRlbnRLZXksIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCBkZXBlbmRlbnRLZXkpID4gdmFsdWU7CiAgICB9KTsKICB9CiAgLyoqCiAgICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgcmV0dXJucyB0cnVlIGlmIHRoZSBwcm92aWRlZCBkZXBlbmRlbnQgcHJvcGVydHkgaXMKICAgIGdyZWF0ZXIgdGhhbiBvciBlcXVhbCB0byB0aGUgcHJvdmlkZWQgdmFsdWUuCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgc2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBndGUgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGNsYXNzIEhhbXN0ZXIgewogICAgICBAZ3RlKCdudW1CYW5hbmFzJywgMTApIGhhc1Rvb01hbnlCYW5hbmFzOwogICAgfQogIAogICAgbGV0IGhhbXN0ZXIgPSBuZXcgSGFtc3RlcigpOwogIAogICAgaGFtc3Rlci5oYXNUb29NYW55QmFuYW5hczsgLy8gZmFsc2UKICAKICAgIHNldChoYW1zdGVyLCAnbnVtQmFuYW5hcycsIDMpOwogICAgaGFtc3Rlci5oYXNUb29NYW55QmFuYW5hczsgLy8gZmFsc2UKICAKICAgIHNldChoYW1zdGVyLCAnbnVtQmFuYW5hcycsIDEwKTsKICAgIGhhbXN0ZXIuaGFzVG9vTWFueUJhbmFuYXM7IC8vIHRydWUKICAgIGBgYAogIAogICAgQ2xhc3NpYyBDbGFzcyBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgZ3RlIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBsZXQgSGFtc3RlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGhhc1Rvb01hbnlCYW5hbmFzOiBndGUoJ251bUJhbmFuYXMnLCAxMCkKICAgIH0pOwogIAogICAgbGV0IGhhbXN0ZXIgPSBIYW1zdGVyLmNyZWF0ZSgpOwogIAogICAgaGFtc3Rlci5oYXNUb29NYW55QmFuYW5hczsgLy8gZmFsc2UKICAKICAgIHNldChoYW1zdGVyLCAnbnVtQmFuYW5hcycsIDMpOwogICAgaGFtc3Rlci5oYXNUb29NYW55QmFuYW5hczsgLy8gZmFsc2UKICAKICAgIHNldChoYW1zdGVyLCAnbnVtQmFuYW5hcycsIDEwKTsKICAgIGhhbXN0ZXIuaGFzVG9vTWFueUJhbmFuYXM7IC8vIHRydWUKICAgIGBgYAogIAogICAgQG1ldGhvZCBndGUKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHBhcmFtIHtOdW1iZXJ9IHZhbHVlCiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCByZXR1cm5zIHRydWUgaWYgdGhlCiAgICBvcmlnaW5hbCB2YWx1ZSBmb3IgcHJvcGVydHkgaXMgZ3JlYXRlciBvciBlcXVhbCB0aGVuIGdpdmVuIHZhbHVlLgogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBndGUoZGVwZW5kZW50S2V5LCB2YWx1ZSkgewogICAgKGZhbHNlICYmICEoISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGF0dGVtcHRlZCB0byB1c2UgQGd0ZSBhcyBhIGRlY29yYXRvciBkaXJlY3RseSwgYnV0IGl0IHJlcXVpcmVzIGBkZXBlbmRlbnRLZXlgIGFuZCBgdmFsdWVgIHBhcmFtZXRlcnMnLCAhKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkpOwogICAgcmV0dXJuICgwLCBfbWV0YWwuY29tcHV0ZWQpKGRlcGVuZGVudEtleSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gKDAsIF9tZXRhbC5nZXQpKHRoaXMsIGRlcGVuZGVudEtleSkgPj0gdmFsdWU7CiAgICB9KTsKICB9CiAgLyoqCiAgICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgcmV0dXJucyB0cnVlIGlmIHRoZSBwcm92aWRlZCBkZXBlbmRlbnQgcHJvcGVydHkgaXMKICAgIGxlc3MgdGhhbiB0aGUgcHJvdmlkZWQgdmFsdWUuCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgc2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBsdCB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgSGFtc3RlciB7CiAgICAgIEBsdCgnbnVtQmFuYW5hcycsIDMpIG5lZWRzTW9yZUJhbmFuYXM7CiAgICB9CiAgCiAgICBsZXQgaGFtc3RlciA9IG5ldyBIYW1zdGVyKCk7CiAgCiAgICBoYW1zdGVyLm5lZWRzTW9yZUJhbmFuYXM7IC8vIHRydWUKICAKICAgIHNldChoYW1zdGVyLCAnbnVtQmFuYW5hcycsIDMpOwogICAgaGFtc3Rlci5uZWVkc01vcmVCYW5hbmFzOyAvLyBmYWxzZQogIAogICAgc2V0KGhhbXN0ZXIsICdudW1CYW5hbmFzJywgMik7CiAgICBoYW1zdGVyLm5lZWRzTW9yZUJhbmFuYXM7IC8vIHRydWUKICAgIGBgYAogIAogICAgQ2xhc3NpYyBDbGFzcyBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgbHQgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgbmVlZHNNb3JlQmFuYW5hczogbHQoJ251bUJhbmFuYXMnLCAzKQogICAgfSk7CiAgCiAgICBsZXQgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKCk7CiAgCiAgICBoYW1zdGVyLm5lZWRzTW9yZUJhbmFuYXM7IC8vIHRydWUKICAKICAgIHNldChoYW1zdGVyLCAnbnVtQmFuYW5hcycsIDMpOwogICAgaGFtc3Rlci5uZWVkc01vcmVCYW5hbmFzOyAvLyBmYWxzZQogIAogICAgc2V0KGhhbXN0ZXIsICdudW1CYW5hbmFzJywgMik7CiAgICBoYW1zdGVyLm5lZWRzTW9yZUJhbmFuYXM7IC8vIHRydWUKICAgIGBgYAogIAogICAgQG1ldGhvZCBsdAogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgICBAcGFyYW0ge051bWJlcn0gdmFsdWUKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIHJldHVybnMgdHJ1ZSBpZiB0aGUKICAgIG9yaWdpbmFsIHZhbHVlIGZvciBwcm9wZXJ0eSBpcyBsZXNzIHRoZW4gZ2l2ZW4gdmFsdWUuCiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIGx0KGRlcGVuZGVudEtleSwgdmFsdWUpIHsKICAgIChmYWxzZSAmJiAhKCEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBhdHRlbXB0ZWQgdG8gdXNlIEBsdCBhcyBhIGRlY29yYXRvciBkaXJlY3RseSwgYnV0IGl0IHJlcXVpcmVzIGBkZXBlbmRlbnRLZXlgIGFuZCBgdmFsdWVgIHBhcmFtZXRlcnMnLCAhKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkpOwogICAgcmV0dXJuICgwLCBfbWV0YWwuY29tcHV0ZWQpKGRlcGVuZGVudEtleSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gKDAsIF9tZXRhbC5nZXQpKHRoaXMsIGRlcGVuZGVudEtleSkgPCB2YWx1ZTsKICAgIH0pOwogIH0KICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRydWUgaWYgdGhlIHByb3ZpZGVkIGRlcGVuZGVudCBwcm9wZXJ0eSBpcwogICAgbGVzcyB0aGFuIG9yIGVxdWFsIHRvIHRoZSBwcm92aWRlZCB2YWx1ZS4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IGx0ZSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgSGFtc3RlciB7CiAgICAgIEBsdGUoJ251bUJhbmFuYXMnLCAzKSBuZWVkc01vcmVCYW5hbmFzOwogICAgfQogIAogICAgbGV0IGhhbXN0ZXIgPSBuZXcgSGFtc3RlcigpOwogIAogICAgaGFtc3Rlci5uZWVkc01vcmVCYW5hbmFzOyAvLyB0cnVlCiAgCiAgICBzZXQoaGFtc3RlciwgJ251bUJhbmFuYXMnLCA1KTsKICAgIGhhbXN0ZXIubmVlZHNNb3JlQmFuYW5hczsgLy8gZmFsc2UKICAKICAgIHNldChoYW1zdGVyLCAnbnVtQmFuYW5hcycsIDMpOwogICAgaGFtc3Rlci5uZWVkc01vcmVCYW5hbmFzOyAvLyB0cnVlCiAgICBgYGAKICAKICAgIENsYXNzaWMgQ2xhc3MgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBFbWJlck9iamVjdCwgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IGx0ZSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgbGV0IEhhbXN0ZXIgPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICBuZWVkc01vcmVCYW5hbmFzOiBsdGUoJ251bUJhbmFuYXMnLCAzKQogICAgfSk7CiAgCiAgICBsZXQgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKCk7CiAgCiAgICBoYW1zdGVyLm5lZWRzTW9yZUJhbmFuYXM7IC8vIHRydWUKICAKICAgIHNldChoYW1zdGVyLCAnbnVtQmFuYW5hcycsIDUpOwogICAgaGFtc3Rlci5uZWVkc01vcmVCYW5hbmFzOyAvLyBmYWxzZQogIAogICAgc2V0KGhhbXN0ZXIsICdudW1CYW5hbmFzJywgMyk7CiAgICBoYW1zdGVyLm5lZWRzTW9yZUJhbmFuYXM7IC8vIHRydWUKICAgIGBgYAogIAogICAgQG1ldGhvZCBsdGUKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHBhcmFtIHtOdW1iZXJ9IHZhbHVlCiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCByZXR1cm5zIHRydWUgaWYgdGhlCiAgICBvcmlnaW5hbCB2YWx1ZSBmb3IgcHJvcGVydHkgaXMgbGVzcyBvciBlcXVhbCB0aGFuIGdpdmVuIHZhbHVlLgogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBsdGUoZGVwZW5kZW50S2V5LCB2YWx1ZSkgewogICAgKGZhbHNlICYmICEoISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGF0dGVtcHRlZCB0byB1c2UgQGx0ZSBhcyBhIGRlY29yYXRvciBkaXJlY3RseSwgYnV0IGl0IHJlcXVpcmVzIGBkZXBlbmRlbnRLZXlgIGFuZCBgdmFsdWVgIHBhcmFtZXRlcnMnLCAhKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkpOwogICAgcmV0dXJuICgwLCBfbWV0YWwuY29tcHV0ZWQpKGRlcGVuZGVudEtleSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gKDAsIF9tZXRhbC5nZXQpKHRoaXMsIGRlcGVuZGVudEtleSkgPD0gdmFsdWU7CiAgICB9KTsKICB9CiAgLyoqCiAgICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgcGVyZm9ybXMgYSBsb2dpY2FsIGBhbmRgIG9uIHRoZSBvcmlnaW5hbCB2YWx1ZXMgZm9yCiAgICB0aGUgcHJvdmlkZWQgZGVwZW5kZW50IHByb3BlcnRpZXMuCiAgCiAgICBZb3UgbWF5IHBhc3MgaW4gbW9yZSB0aGFuIHR3byBwcm9wZXJ0aWVzIGFuZCBldmVuIHVzZSBwcm9wZXJ0eSBicmFjZQogICAgZXhwYW5zaW9uLiAgVGhlIGNvbXB1dGVkIHByb3BlcnR5IHdpbGwgcmV0dXJuIHRoZSBmaXJzdCBmYWxzeSB2YWx1ZSBvciBsYXN0CiAgICB0cnV0aHkgdmFsdWUganVzdCBsaWtlIEphdmFTY3JpcHQncyBgJiZgIG9wZXJhdG9yLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgYW5kIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBjbGFzcyBIYW1zdGVyIHsKICAgICAgQGFuZCgnaGFzVGVudCcsICdoYXNCYWNrcGFjaycpIHJlYWR5Rm9yQ2FtcDsKICAgICAgQGFuZCgnaGFzV2Fsa2luZ1N0aWNrJywgJ2hhc0JhY2twYWNrJykgcmVhZHlGb3JIaWtlOwogICAgfQogIAogICAgbGV0IHRvbXN0ZXIgPSBuZXcgSGFtc3RlcigpOwogIAogICAgdG9tc3Rlci5yZWFkeUZvckNhbXA7IC8vIGZhbHNlCiAgCiAgICBzZXQodG9tc3RlciwgJ2hhc1RlbnQnLCB0cnVlKTsKICAgIHRvbXN0ZXIucmVhZHlGb3JDYW1wOyAvLyBmYWxzZQogIAogICAgc2V0KHRvbXN0ZXIsICdoYXNCYWNrcGFjaycsIHRydWUpOwogICAgdG9tc3Rlci5yZWFkeUZvckNhbXA7IC8vIHRydWUKICAKICAgIHNldCh0b21zdGVyLCAnaGFzQmFja3BhY2snLCAnWWVzJyk7CiAgICB0b21zdGVyLnJlYWR5Rm9yQ2FtcDsgLy8gJ1llcycKICAKICAgIHNldCh0b21zdGVyLCAnaGFzV2Fsa2luZ1N0aWNrJywgbnVsbCk7CiAgICB0b21zdGVyLnJlYWR5Rm9ySGlrZTsgLy8gbnVsbAogICAgYGBgCiAgCiAgICBDbGFzc2ljIENsYXNzIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgRW1iZXJPYmplY3QsIHsgc2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBhbmQgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgcmVhZHlGb3JDYW1wOiBhbmQoJ2hhc1RlbnQnLCAnaGFzQmFja3BhY2snKSwKICAgICAgcmVhZHlGb3JIaWtlOiBhbmQoJ2hhc1dhbGtpbmdTdGljaycsICdoYXNCYWNrcGFjaycpCiAgICB9KTsKICAKICAgIGxldCB0b21zdGVyID0gSGFtc3Rlci5jcmVhdGUoKTsKICAKICAgIHRvbXN0ZXIucmVhZHlGb3JDYW1wOyAvLyBmYWxzZQogIAogICAgc2V0KHRvbXN0ZXIsICdoYXNUZW50JywgdHJ1ZSk7CiAgICB0b21zdGVyLnJlYWR5Rm9yQ2FtcDsgLy8gZmFsc2UKICAKICAgIHNldCh0b21zdGVyLCAnaGFzQmFja3BhY2snLCB0cnVlKTsKICAgIHRvbXN0ZXIucmVhZHlGb3JDYW1wOyAvLyB0cnVlCiAgCiAgICBzZXQodG9tc3RlciwgJ2hhc0JhY2twYWNrJywgJ1llcycpOwogICAgdG9tc3Rlci5yZWFkeUZvckNhbXA7IC8vICdZZXMnCiAgCiAgICBzZXQodG9tc3RlciwgJ2hhc1dhbGtpbmdTdGljaycsIG51bGwpOwogICAgdG9tc3Rlci5yZWFkeUZvckhpa2U7IC8vIG51bGwKICAgIGBgYAogIAogICAgQG1ldGhvZCBhbmQKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleSoKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIHBlcmZvcm1zIGEgbG9naWNhbCBgYW5kYCBvbgogICAgdGhlIHZhbHVlcyBvZiBhbGwgdGhlIG9yaWdpbmFsIHZhbHVlcyBmb3IgcHJvcGVydGllcy4KICAgIEBwdWJsaWMKICAqLwoKCiAgdmFyIGFuZCA9IGdlbmVyYXRlQ29tcHV0ZWRXaXRoUHJlZGljYXRlKCdhbmQnLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9KTsKICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcGVyZm9ybXMgYSBsb2dpY2FsIGBvcmAgb24gdGhlIG9yaWdpbmFsIHZhbHVlcyBmb3IKICAgIHRoZSBwcm92aWRlZCBkZXBlbmRlbnQgcHJvcGVydGllcy4KICAKICAgIFlvdSBtYXkgcGFzcyBpbiBtb3JlIHRoYW4gdHdvIHByb3BlcnRpZXMgYW5kIGV2ZW4gdXNlIHByb3BlcnR5IGJyYWNlCiAgICBleHBhbnNpb24uICBUaGUgY29tcHV0ZWQgcHJvcGVydHkgd2lsbCByZXR1cm4gdGhlIGZpcnN0IHRydXRoeSB2YWx1ZSBvciBsYXN0CiAgICBmYWxzeSB2YWx1ZSBqdXN0IGxpa2UgSmF2YVNjcmlwdCdzIGB8fGAgb3BlcmF0b3IuCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgc2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBvciB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgSGFtc3RlciB7CiAgICAgIEBvcignaGFzSmFja2V0JywgJ2hhc1VtYnJlbGxhJykgcmVhZHlGb3JSYWluOwogICAgICBAb3IoJ2hhc1N1bnNjcmVlbicsICdoYXNVbWJyZWxsYScpIHJlYWR5Rm9yQmVhY2g7CiAgICB9CiAgCiAgICBsZXQgdG9tc3RlciA9IG5ldyBIYW1zdGVyKCk7CiAgCiAgICB0b21zdGVyLnJlYWR5Rm9yUmFpbjsgLy8gdW5kZWZpbmVkCiAgCiAgICBzZXQodG9tc3RlciwgJ2hhc1VtYnJlbGxhJywgdHJ1ZSk7CiAgICB0b21zdGVyLnJlYWR5Rm9yUmFpbjsgLy8gdHJ1ZQogIAogICAgc2V0KHRvbXN0ZXIsICdoYXNKYWNrZXQnLCAnWWVzJyk7CiAgICB0b21zdGVyLnJlYWR5Rm9yUmFpbjsgLy8gJ1llcycKICAKICAgIHNldCh0b21zdGVyLCAnaGFzU3Vuc2NyZWVuJywgJ0NoZWNrJyk7CiAgICB0b21zdGVyLnJlYWR5Rm9yQmVhY2g7IC8vICdDaGVjaycKICAgIGBgYAogIAogICAgQ2xhc3NpYyBDbGFzcyBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgb3IgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgcmVhZHlGb3JSYWluOiBvcignaGFzSmFja2V0JywgJ2hhc1VtYnJlbGxhJyksCiAgICAgIHJlYWR5Rm9yQmVhY2g6IG9yKCdoYXNTdW5zY3JlZW4nLCAnaGFzVW1icmVsbGEnKQogICAgfSk7CiAgCiAgICBsZXQgdG9tc3RlciA9IEhhbXN0ZXIuY3JlYXRlKCk7CiAgCiAgICB0b21zdGVyLnJlYWR5Rm9yUmFpbjsgLy8gdW5kZWZpbmVkCiAgCiAgICBzZXQodG9tc3RlciwgJ2hhc1VtYnJlbGxhJywgdHJ1ZSk7CiAgICB0b21zdGVyLnJlYWR5Rm9yUmFpbjsgLy8gdHJ1ZQogIAogICAgc2V0KHRvbXN0ZXIsICdoYXNKYWNrZXQnLCAnWWVzJyk7CiAgICB0b21zdGVyLnJlYWR5Rm9yUmFpbjsgLy8gJ1llcycKICAKICAgIHNldCh0b21zdGVyLCAnaGFzU3Vuc2NyZWVuJywgJ0NoZWNrJyk7CiAgICB0b21zdGVyLnJlYWR5Rm9yQmVhY2g7IC8vICdDaGVjaycKICAgIGBgYAogIAogICAgQG1ldGhvZCBvcgogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5KgogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcGVyZm9ybXMgYSBsb2dpY2FsIGBvcmAgb24KICAgIHRoZSB2YWx1ZXMgb2YgYWxsIHRoZSBvcmlnaW5hbCB2YWx1ZXMgZm9yIHByb3BlcnRpZXMuCiAgICBAcHVibGljCiAgKi8KCiAgX2V4cG9ydHMuYW5kID0gYW5kOwogIHZhciBvciA9IGdlbmVyYXRlQ29tcHV0ZWRXaXRoUHJlZGljYXRlKCdvcicsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgcmV0dXJuICF2YWx1ZTsKICB9KTsKICAvKioKICAgIENyZWF0ZXMgYSBuZXcgcHJvcGVydHkgdGhhdCBpcyBhbiBhbGlhcyBmb3IgYW5vdGhlciBwcm9wZXJ0eSBvbiBhbiBvYmplY3QuCiAgICBDYWxscyB0byBgZ2V0YCBvciBgc2V0YCB0aGlzIHByb3BlcnR5IGJlaGF2ZSBhcyB0aG91Z2ggdGhleSB3ZXJlIGNhbGxlZCBvbiB0aGUKICAgIG9yaWdpbmFsIHByb3BlcnR5LgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgYWxpYXMgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGNsYXNzIFBlcnNvbiB7CiAgICAgIG5hbWUgPSAnQWxleCBNYXRjaG5lZXInOwogIAogICAgICBAYWxpYXMoJ25hbWUnKSBub21lbjsKICAgIH0KICAKICAgIGxldCBhbGV4ID0gbmV3IFBlcnNvbigpOwogIAogICAgYWxleC5ub21lbjsgLy8gJ0FsZXggTWF0Y2huZWVyJwogICAgYWxleC5uYW1lOyAgLy8gJ0FsZXggTWF0Y2huZWVyJwogIAogICAgc2V0KGFsZXgsICdub21lbicsICdAbWFjaHR5Jyk7CiAgICBhbGV4Lm5hbWU7ICAvLyAnQG1hY2h0eScKICAgIGBgYAogIAogICAgQ2xhc3NpYyBDbGFzcyBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgYWxpYXMgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGxldCBQZXJzb24gPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICBuYW1lOiAnQWxleCBNYXRjaG5lZXInLAogIAogICAgICBub21lbjogYWxpYXMoJ25hbWUnKQogICAgfSk7CiAgCiAgICBsZXQgYWxleCA9IFBlcnNvbi5jcmVhdGUoKTsKICAKICAgIGFsZXgubm9tZW47IC8vICdBbGV4IE1hdGNobmVlcicKICAgIGFsZXgubmFtZTsgIC8vICdBbGV4IE1hdGNobmVlcicKICAKICAgIHNldChhbGV4LCAnbm9tZW4nLCAnQG1hY2h0eScpOwogICAgYWxleC5uYW1lOyAgLy8gJ0BtYWNodHknCiAgICBgYGAKICAKICAgIEBtZXRob2QgYWxpYXMKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggY3JlYXRlcyBhbiBhbGlhcyB0byB0aGUKICAgIG9yaWdpbmFsIHZhbHVlIGZvciBwcm9wZXJ0eS4KICAgIEBwdWJsaWMKICAqLwoKICAvKioKICAgIFdoZXJlIGBjb21wdXRlZC5hbGlhc2AgYWxpYXNlcyBgZ2V0YCBhbmQgYHNldGAsIGFuZCBhbGxvd3MgZm9yIGJpZGlyZWN0aW9uYWwKICAgIGRhdGEgZmxvdywgYGNvbXB1dGVkLm9uZVdheWAgb25seSBwcm92aWRlcyBhbiBhbGlhc2VkIGBnZXRgLiBUaGUgYHNldGAgd2lsbAogICAgbm90IG11dGF0ZSB0aGUgdXBzdHJlYW0gcHJvcGVydHksIHJhdGhlciBjYXVzZXMgdGhlIGN1cnJlbnQgcHJvcGVydHkgdG8gYmVjb21lCiAgICB0aGUgdmFsdWUgc2V0LiBUaGlzIGNhdXNlcyB0aGUgZG93bnN0cmVhbSBwcm9wZXJ0eSB0byBwZXJtYW5lbnRseSBkaXZlcmdlIGZyb20KICAgIHRoZSB1cHN0cmVhbSBwcm9wZXJ0eS4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IG9uZVdheSB9ZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBjbGFzcyBVc2VyIHsKICAgICAgY29uc3RydWN0b3IoZmlyc3ROYW1lLCBsYXN0TmFtZSkgewogICAgICAgIHNldCh0aGlzLCAnZmlyc3ROYW1lJywgZmlyc3ROYW1lKTsKICAgICAgICBzZXQodGhpcywgJ2xhc3ROYW1lJywgbGFzdE5hbWUpOwogICAgICB9CiAgCiAgICAgIEBvbmVXYXkoJ2ZpcnN0TmFtZScpIG5pY2tOYW1lOwogICAgfQogIAogICAgbGV0IHRlZGR5ID0gbmV3IFVzZXIoJ1RlZGR5JywgJ1plZW5ueScpOwogIAogICAgdGVkZHkubmlja05hbWU7IC8vICdUZWRkeScKICAKICAgIHNldCh0ZWRkeSwgJ25pY2tOYW1lJywgJ1RlZGR5QmVhcicpOwogICAgdGVkZHkuZmlyc3ROYW1lOyAvLyAnVGVkZHknCiAgICB0ZWRkeS5uaWNrTmFtZTsgLy8gJ1RlZGR5QmVhcicKICAgIGBgYAogIAogICAgQ2xhc3NpYyBDbGFzcyBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgb25lV2F5IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBsZXQgVXNlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGZpcnN0TmFtZTogbnVsbCwKICAgICAgbGFzdE5hbWU6IG51bGwsCiAgCiAgICAgIG5pY2tOYW1lOiBvbmVXYXkoJ2ZpcnN0TmFtZScpCiAgICB9KTsKICAKICAgIGxldCB0ZWRkeSA9IFVzZXIuY3JlYXRlKHsKICAgICAgZmlyc3ROYW1lOiAnVGVkZHknLAogICAgICBsYXN0TmFtZTogJ1plZW5ueScKICAgIH0pOwogIAogICAgdGVkZHkubmlja05hbWU7IC8vICdUZWRkeScKICAKICAgIHNldCh0ZWRkeSwgJ25pY2tOYW1lJywgJ1RlZGR5QmVhcicpOyAvLyAnVGVkZHlCZWFyJwogICAgdGVkZHkuZmlyc3ROYW1lOyAvLyAnVGVkZHknCiAgICB0ZWRkeS5uaWNrTmFtZTsgLy8gJ1RlZGR5QmVhcicKICAgIGBgYAogIAogICAgQG1ldGhvZCBvbmVXYXkKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggY3JlYXRlcyBhIG9uZSB3YXkgY29tcHV0ZWQKICAgIHByb3BlcnR5IHRvIHRoZSBvcmlnaW5hbCB2YWx1ZSBmb3IgcHJvcGVydHkuCiAgICBAcHVibGljCiAgKi8KCiAgX2V4cG9ydHMub3IgPSBvcjsKCiAgZnVuY3Rpb24gb25lV2F5KGRlcGVuZGVudEtleSkgewogICAgKGZhbHNlICYmICEoISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGF0dGVtcHRlZCB0byB1c2UgQG9uZVdheSBhcyBhIGRlY29yYXRvciBkaXJlY3RseSwgYnV0IGl0IHJlcXVpcmVzIGEgYGRlcGVuZGVudEtleWAgcGFyYW1ldGVyJywgISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpKTsKICAgIHJldHVybiAoMCwgX21ldGFsLmFsaWFzKShkZXBlbmRlbnRLZXkpLm9uZVdheSgpOwogIH0KICAvKioKICAgIFRoaXMgaXMgYSBtb3JlIHNlbWFudGljYWxseSBtZWFuaW5nZnVsIGFsaWFzIG9mIGBjb21wdXRlZC5vbmVXYXlgLCB3aG9zZSBuYW1lCiAgICBpcyBzb21ld2hhdCBhbWJpZ3VvdXMgYXMgdG8gd2hpY2ggZGlyZWN0aW9uIHRoZSBkYXRhIGZsb3dzLgogIAogICAgQG1ldGhvZCByZWFkcwogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCBjcmVhdGVzIGEgb25lIHdheSBjb21wdXRlZAogICAgICBwcm9wZXJ0eSB0byB0aGUgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5LgogICAgQHB1YmxpYwogICAqLwoKICAvKioKICAgIFdoZXJlIGBjb21wdXRlZC5vbmVXYXlgIHByb3ZpZGVzIG9uZVdheSBiaW5kaW5ncywgYGNvbXB1dGVkLnJlYWRPbmx5YCBwcm92aWRlcwogICAgYSByZWFkT25seSBvbmUgd2F5IGJpbmRpbmcuIFZlcnkgb2Z0ZW4gd2hlbiB1c2luZyBgY29tcHV0ZWQub25lV2F5YCBvbmUgZG9lcwogICAgbm90IGFsc28gd2FudCBjaGFuZ2VzIHRvIHByb3BhZ2F0ZSBiYWNrIHVwLCBhcyB0aGV5IHdpbGwgcmVwbGFjZSB0aGUgdmFsdWUuCiAgCiAgICBUaGlzIHByZXZlbnRzIHRoZSByZXZlcnNlIGZsb3csIGFuZCBhbHNvIHRocm93cyBhbiBleGNlcHRpb24gd2hlbiBpdCBvY2N1cnMuCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgc2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyByZWFkT25seSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgVXNlciB7CiAgICAgIGNvbnN0cnVjdG9yKGZpcnN0TmFtZSwgbGFzdE5hbWUpIHsKICAgICAgICBzZXQodGhpcywgJ2ZpcnN0TmFtZScsIGZpcnN0TmFtZSk7CiAgICAgICAgc2V0KHRoaXMsICdsYXN0TmFtZScsIGxhc3ROYW1lKTsKICAgICAgfQogIAogICAgICBAcmVhZE9ubHkoJ2ZpcnN0TmFtZScpIG5pY2tOYW1lOwogICAgfSk7CiAgCiAgICBsZXQgdGVkZHkgPSBuZXcgVXNlcignVGVkZHknLCAnWmVlbm55Jyk7CiAgCiAgICB0ZWRkeS5uaWNrTmFtZTsgLy8gJ1RlZGR5JwogIAogICAgc2V0KHRlZGR5LCAnbmlja05hbWUnLCAnVGVkZHlCZWFyJyk7IC8vIHRocm93cyBFeGNlcHRpb24KICAgIC8vIHRocm93IG5ldyBFbWJlckVycm9yKCdDYW5ub3QgU2V0OiBuaWNrTmFtZSBvbjogPFVzZXI6ZW1iZXIyNzI4OD4nICk7YAogIAogICAgdGVkZHkuZmlyc3ROYW1lOyAvLyAnVGVkZHknCiAgICBgYGAKICAKICAgIENsYXNzaWMgQ2xhc3MgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBFbWJlck9iamVjdCwgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IHJlYWRPbmx5IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBsZXQgVXNlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGZpcnN0TmFtZTogbnVsbCwKICAgICAgbGFzdE5hbWU6IG51bGwsCiAgCiAgICAgIG5pY2tOYW1lOiByZWFkT25seSgnZmlyc3ROYW1lJykKICAgIH0pOwogIAogICAgbGV0IHRlZGR5ID0gVXNlci5jcmVhdGUoewogICAgICBmaXJzdE5hbWU6ICdUZWRkeScsCiAgICAgIGxhc3ROYW1lOiAgJ1plZW5ueScKICAgIH0pOwogIAogICAgdGVkZHkubmlja05hbWU7IC8vICdUZWRkeScKICAKICAgIHNldCh0ZWRkeSwgJ25pY2tOYW1lJywgJ1RlZGR5QmVhcicpOyAvLyB0aHJvd3MgRXhjZXB0aW9uCiAgICAvLyB0aHJvdyBuZXcgRW1iZXJFcnJvcignQ2Fubm90IFNldDogbmlja05hbWUgb246IDxVc2VyOmVtYmVyMjcyODg+JyApO2AKICAKICAgIHRlZGR5LmZpcnN0TmFtZTsgLy8gJ1RlZGR5JwogICAgYGBgCiAgCiAgICBAbWV0aG9kIHJlYWRPbmx5CiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIGNyZWF0ZXMgYSBvbmUgd2F5IGNvbXB1dGVkCiAgICBwcm9wZXJ0eSB0byB0aGUgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5LgogICAgQHNpbmNlIDEuNS4wCiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIHJlYWRPbmx5KGRlcGVuZGVudEtleSkgewogICAgKGZhbHNlICYmICEoISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGF0dGVtcHRlZCB0byB1c2UgQHJlYWRPbmx5IGFzIGEgZGVjb3JhdG9yIGRpcmVjdGx5LCBidXQgaXQgcmVxdWlyZXMgYSBgZGVwZW5kZW50S2V5YCBwYXJhbWV0ZXInLCAhKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkpOwogICAgcmV0dXJuICgwLCBfbWV0YWwuYWxpYXMpKGRlcGVuZGVudEtleSkucmVhZE9ubHkoKTsKICB9CiAgLyoqCiAgICBDcmVhdGVzIGEgbmV3IHByb3BlcnR5IHRoYXQgaXMgYW4gYWxpYXMgZm9yIGFub3RoZXIgcHJvcGVydHkgb24gYW4gb2JqZWN0LgogICAgQ2FsbHMgdG8gYGdldGAgb3IgYHNldGAgdGhpcyBwcm9wZXJ0eSBiZWhhdmUgYXMgdGhvdWdoIHRoZXkgd2VyZSBjYWxsZWQgb24gdGhlCiAgICBvcmlnaW5hbCBwcm9wZXJ0eSwgYnV0IGFsc28gcHJpbnQgYSBkZXByZWNhdGlvbiB3YXJuaW5nLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgZGVwcmVjYXRpbmdBbGlhcyB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgSGFtc3RlciB7CiAgICAgIEBkZXByZWNhdGluZ0FsaWFzKCdjYXZlbmRpc2hDb3VudCcsIHsKICAgICAgICBpZDogJ2hhbXN0ZXIuZGVwcmVjYXRlLWJhbmFuYScsCiAgICAgICAgdW50aWw6ICczLjAuMCcKICAgICAgfSkKICAgICAgYmFuYW5hQ291bnQ7CiAgICB9CiAgCiAgICBsZXQgaGFtc3RlciA9IG5ldyBIYW1zdGVyKCk7CiAgCiAgICBzZXQoaGFtc3RlciwgJ2JhbmFuYUNvdW50JywgNSk7IC8vIFByaW50cyBhIGRlcHJlY2F0aW9uIHdhcm5pbmcuCiAgICBoYW1zdGVyLmNhdmVuZGlzaENvdW50OyAvLyA1CiAgICBgYGAKICAKICAgIENsYXNzaWMgQ2xhc3MgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBFbWJlck9iamVjdCwgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IGRlcHJlY2F0aW5nQWxpYXMgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgYmFuYW5hQ291bnQ6IGRlcHJlY2F0aW5nQWxpYXMoJ2NhdmVuZGlzaENvdW50JywgewogICAgICAgIGlkOiAnaGFtc3Rlci5kZXByZWNhdGUtYmFuYW5hJywKICAgICAgICB1bnRpbDogJzMuMC4wJwogICAgICB9KQogICAgfSk7CiAgCiAgICBsZXQgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKCk7CiAgCiAgICBzZXQoaGFtc3RlciwgJ2JhbmFuYUNvdW50JywgNSk7IC8vIFByaW50cyBhIGRlcHJlY2F0aW9uIHdhcm5pbmcuCiAgICBoYW1zdGVyLmNhdmVuZGlzaENvdW50OyAvLyA1CiAgICBgYGAKICAKICAgIEBtZXRob2QgZGVwcmVjYXRpbmdBbGlhcwogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBPcHRpb25zIGZvciBgZGVwcmVjYXRlYC4KICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIGNyZWF0ZXMgYW4gYWxpYXMgd2l0aCBhCiAgICBkZXByZWNhdGlvbiB0byB0aGUgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5LgogICAgQHNpbmNlIDEuNy4wCiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIGRlcHJlY2F0aW5nQWxpYXMoZGVwZW5kZW50S2V5LCBvcHRpb25zKSB7CiAgICAoZmFsc2UgJiYgISghKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgYXR0ZW1wdGVkIHRvIHVzZSBAZGVwcmVjYXRpbmdBbGlhcyBhcyBhIGRlY29yYXRvciBkaXJlY3RseSwgYnV0IGl0IHJlcXVpcmVzIGBkZXBlbmRlbnRLZXlgIGFuZCBgb3B0aW9uc2AgcGFyYW1ldGVycycsICEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKSk7CiAgICByZXR1cm4gKDAsIF9tZXRhbC5jb21wdXRlZCkoZGVwZW5kZW50S2V5LCB7CiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoIlVzYWdlIG9mIGAiICsga2V5ICsgImAgaXMgZGVwcmVjYXRlZCwgdXNlIGAiICsgZGVwZW5kZW50S2V5ICsgImAgaW5zdGVhZC4iLCBmYWxzZSwgb3B0aW9ucykpOwogICAgICAgIHJldHVybiAoMCwgX21ldGFsLmdldCkodGhpcywgZGVwZW5kZW50S2V5KTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoa2V5LCB2YWx1ZSkgewogICAgICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoIlVzYWdlIG9mIGAiICsga2V5ICsgImAgaXMgZGVwcmVjYXRlZCwgdXNlIGAiICsgZGVwZW5kZW50S2V5ICsgImAgaW5zdGVhZC4iLCBmYWxzZSwgb3B0aW9ucykpOwogICAgICAgICgwLCBfbWV0YWwuc2V0KSh0aGlzLCBkZXBlbmRlbnRLZXksIHZhbHVlKTsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgIH0pOwogIH0KfSk7CmRlZmluZSgiQGVtYmVyL29iamVjdC9saWIvY29tcHV0ZWQvcmVkdWNlX2NvbXB1dGVkX21hY3JvcyIsIFsiZXhwb3J0cyIsICJAZW1iZXIvZGVidWciLCAiQGVtYmVyLy1pbnRlcm5hbHMvbWV0YWwiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9kZWJ1ZywgX21ldGFsLCBfcnVudGltZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuc3VtID0gc3VtOwogIF9leHBvcnRzLm1heCA9IG1heDsKICBfZXhwb3J0cy5taW4gPSBtaW47CiAgX2V4cG9ydHMubWFwID0gbWFwOwogIF9leHBvcnRzLm1hcEJ5ID0gbWFwQnk7CiAgX2V4cG9ydHMuZmlsdGVyID0gZmlsdGVyOwogIF9leHBvcnRzLmZpbHRlckJ5ID0gZmlsdGVyQnk7CiAgX2V4cG9ydHMudW5pcSA9IHVuaXE7CiAgX2V4cG9ydHMudW5pcUJ5ID0gdW5pcUJ5OwogIF9leHBvcnRzLmludGVyc2VjdCA9IGludGVyc2VjdDsKICBfZXhwb3J0cy5zZXREaWZmID0gc2V0RGlmZjsKICBfZXhwb3J0cy5jb2xsZWN0ID0gY29sbGVjdDsKICBfZXhwb3J0cy5zb3J0ID0gc29ydDsKICBfZXhwb3J0cy51bmlvbiA9IHZvaWQgMDsKCiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgKi8KICBmdW5jdGlvbiByZWR1Y2VNYWNybyhkZXBlbmRlbnRLZXksIGNhbGxiYWNrLCBpbml0aWFsVmFsdWUsIG5hbWUpIHsKICAgIChmYWxzZSAmJiAhKCEvW1xbXF1ce1x9XS9nLnRlc3QoZGVwZW5kZW50S2V5KSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJEZXBlbmRlbnQga2V5IHBhc3NlZCB0byBgY29tcHV0ZWQuIiArIG5hbWUgKyAiYCBzaG91bGRuJ3QgY29udGFpbiBicmFjZSBleHBhbmRpbmcgcGF0dGVybi4iLCAhL1tcW1xdXHtcfV0vZy50ZXN0KGRlcGVuZGVudEtleSkpKTsKICAgIHJldHVybiAoMCwgX21ldGFsLmNvbXB1dGVkKShkZXBlbmRlbnRLZXkgKyAiLltdIiwgZnVuY3Rpb24gKCkgewogICAgICB2YXIgYXJyID0gKDAsIF9tZXRhbC5nZXQpKHRoaXMsIGRlcGVuZGVudEtleSk7CgogICAgICBpZiAoYXJyID09PSBudWxsIHx8IHR5cGVvZiBhcnIgIT09ICdvYmplY3QnKSB7CiAgICAgICAgcmV0dXJuIGluaXRpYWxWYWx1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGFyci5yZWR1Y2UoY2FsbGJhY2ssIGluaXRpYWxWYWx1ZSwgdGhpcyk7CiAgICB9KS5yZWFkT25seSgpOwogIH0KCiAgZnVuY3Rpb24gYXJyYXlNYWNybyhkZXBlbmRlbnRLZXksIGFkZGl0aW9uYWxEZXBlbmRlbnRLZXlzLCBjYWxsYmFjaykgewogICAgLy8gVGhpcyBpcyBhIGJpdCB1Z2x5CiAgICB2YXIgcHJvcGVydHlOYW1lOwoKICAgIGlmICgvQGVhY2gvLnRlc3QoZGVwZW5kZW50S2V5KSkgewogICAgICBwcm9wZXJ0eU5hbWUgPSBkZXBlbmRlbnRLZXkucmVwbGFjZSgvXC5AZWFjaC4qJC8sICcnKTsKICAgIH0gZWxzZSB7CiAgICAgIHByb3BlcnR5TmFtZSA9IGRlcGVuZGVudEtleTsKICAgICAgZGVwZW5kZW50S2V5ICs9ICcuW10nOwogICAgfQoKICAgIHJldHVybiBfbWV0YWwuY29tcHV0ZWQuYXBwbHkodm9pZCAwLCBbZGVwZW5kZW50S2V5XS5jb25jYXQoYWRkaXRpb25hbERlcGVuZGVudEtleXMsIFtmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB2YWx1ZSA9ICgwLCBfbWV0YWwuZ2V0KSh0aGlzLCBwcm9wZXJ0eU5hbWUpOwoKICAgICAgaWYgKCgwLCBfcnVudGltZS5pc0FycmF5KSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gKDAsIF9ydW50aW1lLkEpKGNhbGxiYWNrLmNhbGwodGhpcywgdmFsdWUpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gKDAsIF9ydW50aW1lLkEpKCk7CiAgICAgIH0KICAgIH1dKSkucmVhZE9ubHkoKTsKICB9CgogIGZ1bmN0aW9uIG11bHRpQXJyYXlNYWNybyhfZGVwZW5kZW50S2V5cywgY2FsbGJhY2ssIG5hbWUpIHsKICAgIChmYWxzZSAmJiAhKF9kZXBlbmRlbnRLZXlzLmV2ZXJ5KGZ1bmN0aW9uIChkZXBlbmRlbnRLZXkpIHsKICAgICAgcmV0dXJuICEvW1xbXF1ce1x9XS9nLnRlc3QoZGVwZW5kZW50S2V5KTsKICAgIH0pKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkRlcGVuZGVudCBrZXlzIHBhc3NlZCB0byBgY29tcHV0ZWQuIiArIG5hbWUgKyAiYCBzaG91bGRuJ3QgY29udGFpbiBicmFjZSBleHBhbmRpbmcgcGF0dGVybi4iLCBfZGVwZW5kZW50S2V5cy5ldmVyeShmdW5jdGlvbiAoZGVwZW5kZW50S2V5KSB7CiAgICAgIHJldHVybiAhL1tcW1xdXHtcfV0vZy50ZXN0KGRlcGVuZGVudEtleSk7CiAgICB9KSkpOwoKICAgIHZhciBkZXBlbmRlbnRLZXlzID0gX2RlcGVuZGVudEtleXMubWFwKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgcmV0dXJuIGtleSArICIuW10iOwogICAgfSk7CgogICAgcmV0dXJuIF9tZXRhbC5jb21wdXRlZC5hcHBseSh2b2lkIDAsIGRlcGVuZGVudEtleXMuY29uY2F0KFtmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAoMCwgX3J1bnRpbWUuQSkoY2FsbGJhY2suY2FsbCh0aGlzLCBfZGVwZW5kZW50S2V5cykpOwogICAgfV0pKS5yZWFkT25seSgpOwogIH0KICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRoZSBzdW0gb2YgdGhlIHZhbHVlcyBpbiB0aGUgZGVwZW5kZW50IGFycmF5LgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHN1bSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgSW52b2ljZSB7CiAgICAgIGxpbmVJdGVtcyA9IFsxLjAwLCAyLjUwLCA5Ljk5XTsKICAKICAgICAgQHN1bSgnbGluZUl0ZW1zJykgdG90YWw7CiAgICB9CiAgCiAgICBsZXQgaW52b2ljZSA9IG5ldyBJbnZvaWNlKCk7CiAgCiAgICBpbnZvaWNlLnRvdGFsOyAvLyAxMy40OQogICAgYGBgCiAgCiAgICBDbGFzc2ljIENsYXNzIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBzdW0gfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGxldCBJbnZvaWNlID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgbGluZUl0ZW1zOiBbMS4wMCwgMi41MCwgOS45OV0sCiAgCiAgICAgIHRvdGFsOiBzdW0oJ2xpbmVJdGVtcycpCiAgICB9KQogIAogICAgbGV0IGludm9pY2UgPSBJbnZvaWNlLmNyZWF0ZSgpOwogIAogICAgaW52b2ljZS50b3RhbDsgLy8gMTMuNDkKICAgIGBgYAogIAogICAgQG1ldGhvZCBzdW0KICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZXMgdGhlIHN1bSBvZiBhbGwgdmFsdWVzIGluIHRoZQogICAgZGVwZW5kZW50S2V5J3MgYXJyYXkKICAgIEBzaW5jZSAxLjQuMAogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBzdW0oZGVwZW5kZW50S2V5KSB7CiAgICAoZmFsc2UgJiYgISghKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgYXR0ZW1wdGVkIHRvIHVzZSBAc3VtIGFzIGEgZGVjb3JhdG9yIGRpcmVjdGx5LCBidXQgaXQgcmVxdWlyZXMgYSBgZGVwZW5kZW50S2V5YCBwYXJhbWV0ZXInLCAhKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkpOwogICAgcmV0dXJuIHJlZHVjZU1hY3JvKGRlcGVuZGVudEtleSwgZnVuY3Rpb24gKHN1bSwgaXRlbSkgewogICAgICByZXR1cm4gc3VtICsgaXRlbTsKICAgIH0sIDAsICdzdW0nKTsKICB9CiAgLyoqCiAgICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgY2FsY3VsYXRlcyB0aGUgbWF4aW11bSB2YWx1ZSBpbiB0aGUgZGVwZW5kZW50IGFycmF5LgogICAgVGhpcyB3aWxsIHJldHVybiBgLUluZmluaXR5YCB3aGVuIHRoZSBkZXBlbmRlbnQgYXJyYXkgaXMgZW1wdHkuCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgc2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBtYXBCeSwgbWF4IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBjbGFzcyBQZXJzb24gewogICAgICBjaGlsZHJlbiA9IFtdOwogIAogICAgICBAbWFwQnkoJ2NoaWxkcmVuJywgJ2FnZScpIGNoaWxkQWdlczsKICAgICAgQG1heCgnY2hpbGRBZ2VzJykgbWF4Q2hpbGRBZ2U7CiAgICB9CiAgCiAgICBsZXQgbG9yZEJ5cm9uID0gbmV3IFBlcnNvbigpOwogIAogICAgbG9yZEJ5cm9uLm1heENoaWxkQWdlOyAvLyAtSW5maW5pdHkKICAKICAgIHNldChsb3JkQnlyb24sICdjaGlsZHJlbicsIFsKICAgICAgewogICAgICAgIG5hbWU6ICdBdWd1c3RhIEFkYSBCeXJvbicsCiAgICAgICAgYWdlOiA3CiAgICAgIH0KICAgIF0pOwogICAgbG9yZEJ5cm9uLm1heENoaWxkQWdlOyAvLyA3CiAgCiAgICBzZXQobG9yZEJ5cm9uLCAnY2hpbGRyZW4nLCBbCiAgICAgIC4uLmxvcmRCeXJvbi5jaGlsZHJlbiwKICAgICAgewogICAgICAgIG5hbWU6ICdBbGxlZ3JhIEJ5cm9uJywKICAgICAgICBhZ2U6IDUKICAgICAgfSwgewogICAgICAgIG5hbWU6ICdFbGl6YWJldGggTWVkb3JhIExlaWdoJywKICAgICAgICBhZ2U6IDgKICAgICAgfQogICAgXSk7CiAgICBsb3JkQnlyb24ubWF4Q2hpbGRBZ2U7IC8vIDgKICAgIGBgYAogIAogICAgQ2xhc3NpYyBDbGFzcyBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgbWFwQnksIG1heCB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgbGV0IFBlcnNvbiA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGNoaWxkQWdlczogbWFwQnkoJ2NoaWxkcmVuJywgJ2FnZScpLAogICAgICBtYXhDaGlsZEFnZTogbWF4KCdjaGlsZEFnZXMnKQogICAgfSk7CiAgCiAgICBsZXQgbG9yZEJ5cm9uID0gUGVyc29uLmNyZWF0ZSh7IGNoaWxkcmVuOiBbXSB9KTsKICAKICAgIGxvcmRCeXJvbi5tYXhDaGlsZEFnZTsgLy8gLUluZmluaXR5CiAgCiAgICBzZXQobG9yZEJ5cm9uLCAnY2hpbGRyZW4nLCBbCiAgICAgIHsKICAgICAgICBuYW1lOiAnQXVndXN0YSBBZGEgQnlyb24nLAogICAgICAgIGFnZTogNwogICAgICB9CiAgICBdKTsKICAgIGxvcmRCeXJvbi5tYXhDaGlsZEFnZTsgLy8gNwogIAogICAgc2V0KGxvcmRCeXJvbiwgJ2NoaWxkcmVuJywgWwogICAgICAuLi5sb3JkQnlyb24uY2hpbGRyZW4sCiAgICAgIHsKICAgICAgICBuYW1lOiAnQWxsZWdyYSBCeXJvbicsCiAgICAgICAgYWdlOiA1CiAgICAgIH0sIHsKICAgICAgICBuYW1lOiAnRWxpemFiZXRoIE1lZG9yYSBMZWlnaCcsCiAgICAgICAgYWdlOiA4CiAgICAgIH0KICAgIF0pOwogICAgbG9yZEJ5cm9uLm1heENoaWxkQWdlOyAvLyA4CiAgICBgYGAKICAKICAgIElmIHRoZSB0eXBlcyBvZiB0aGUgYXJndW1lbnRzIGFyZSBub3QgbnVtYmVycywgdGhleSB3aWxsIGJlIGNvbnZlcnRlZCB0bwogICAgbnVtYmVycyBhbmQgdGhlIHR5cGUgb2YgdGhlIHJldHVybiB2YWx1ZSB3aWxsIGFsd2F5cyBiZSBgTnVtYmVyYC4gRm9yIGV4YW1wbGUsCiAgICB0aGUgbWF4IG9mIGEgbGlzdCBvZiBEYXRlIG9iamVjdHMgd2lsbCBiZSB0aGUgaGlnaGVzdCB0aW1lc3RhbXAgYXMgYSBgTnVtYmVyYC4KICAgIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoIGBNYXRoLm1heGAuCiAgCiAgICBAbWV0aG9kIG1heAogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlcyB0aGUgbGFyZ2VzdCB2YWx1ZSBpbiB0aGUgZGVwZW5kZW50S2V5J3MKICAgIGFycmF5CiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIG1heChkZXBlbmRlbnRLZXkpIHsKICAgIChmYWxzZSAmJiAhKCEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBhdHRlbXB0ZWQgdG8gdXNlIEBtYXggYXMgYSBkZWNvcmF0b3IgZGlyZWN0bHksIGJ1dCBpdCByZXF1aXJlcyBhIGBkZXBlbmRlbnRLZXlgIHBhcmFtZXRlcicsICEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKSk7CiAgICByZXR1cm4gcmVkdWNlTWFjcm8oZGVwZW5kZW50S2V5LCBmdW5jdGlvbiAobWF4LCBpdGVtKSB7CiAgICAgIHJldHVybiBNYXRoLm1heChtYXgsIGl0ZW0pOwogICAgfSwgLUluZmluaXR5LCAnbWF4Jyk7CiAgfQogIC8qKgogICAgQSBjb21wdXRlZCBwcm9wZXJ0eSB0aGF0IGNhbGN1bGF0ZXMgdGhlIG1pbmltdW0gdmFsdWUgaW4gdGhlIGRlcGVuZGVudCBhcnJheS4KICAgIFRoaXMgd2lsbCByZXR1cm4gYEluZmluaXR5YCB3aGVuIHRoZSBkZXBlbmRlbnQgYXJyYXkgaXMgZW1wdHkuCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgc2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBtYXBCeSwgbWluIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBjbGFzcyBQZXJzb24gewogICAgICBjaGlsZHJlbiA9IFtdOwogIAogICAgICBAbWFwQnkoJ2NoaWxkcmVuJywgJ2FnZScpIGNoaWxkQWdlczsKICAgICAgQG1pbignY2hpbGRBZ2VzJykgbWluQ2hpbGRBZ2U7CiAgICB9CiAgCiAgICBsZXQgbG9yZEJ5cm9uID0gUGVyc29uLmNyZWF0ZSh7IGNoaWxkcmVuOiBbXSB9KTsKICAKICAgIGxvcmRCeXJvbi5taW5DaGlsZEFnZTsgLy8gSW5maW5pdHkKICAKICAgIHNldChsb3JkQnlyb24sICdjaGlsZHJlbicsIFsKICAgICAgewogICAgICAgIG5hbWU6ICdBdWd1c3RhIEFkYSBCeXJvbicsCiAgICAgICAgYWdlOiA3CiAgICAgIH0KICAgIF0pOwogICAgbG9yZEJ5cm9uLm1pbkNoaWxkQWdlOyAvLyA3CiAgCiAgICBzZXQobG9yZEJ5cm9uLCAnY2hpbGRyZW4nLCBbCiAgICAgIC4uLmxvcmRCeXJvbi5jaGlsZHJlbiwKICAgICAgewogICAgICAgIG5hbWU6ICdBbGxlZ3JhIEJ5cm9uJywKICAgICAgICBhZ2U6IDUKICAgICAgfSwgewogICAgICAgIG5hbWU6ICdFbGl6YWJldGggTWVkb3JhIExlaWdoJywKICAgICAgICBhZ2U6IDgKICAgICAgfQogICAgXSk7CiAgICBsb3JkQnlyb24ubWluQ2hpbGRBZ2U7IC8vIDUKICAgIGBgYAogIAogICAgQ2xhc3NpYyBDbGFzcyBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgbWFwQnksIG1pbiB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgbGV0IFBlcnNvbiA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGNoaWxkQWdlczogbWFwQnkoJ2NoaWxkcmVuJywgJ2FnZScpLAogICAgICBtaW5DaGlsZEFnZTogbWluKCdjaGlsZEFnZXMnKQogICAgfSk7CiAgCiAgICBsZXQgbG9yZEJ5cm9uID0gUGVyc29uLmNyZWF0ZSh7IGNoaWxkcmVuOiBbXSB9KTsKICAKICAgIGxvcmRCeXJvbi5taW5DaGlsZEFnZTsgLy8gSW5maW5pdHkKICAKICAgIHNldChsb3JkQnlyb24sICdjaGlsZHJlbicsIFsKICAgICAgewogICAgICAgIG5hbWU6ICdBdWd1c3RhIEFkYSBCeXJvbicsCiAgICAgICAgYWdlOiA3CiAgICAgIH0KICAgIF0pOwogICAgbG9yZEJ5cm9uLm1pbkNoaWxkQWdlOyAvLyA3CiAgCiAgICBzZXQobG9yZEJ5cm9uLCAnY2hpbGRyZW4nLCBbCiAgICAgIC4uLmxvcmRCeXJvbi5jaGlsZHJlbiwKICAgICAgewogICAgICAgIG5hbWU6ICdBbGxlZ3JhIEJ5cm9uJywKICAgICAgICBhZ2U6IDUKICAgICAgfSwgewogICAgICAgIG5hbWU6ICdFbGl6YWJldGggTWVkb3JhIExlaWdoJywKICAgICAgICBhZ2U6IDgKICAgICAgfQogICAgXSk7CiAgICBsb3JkQnlyb24ubWluQ2hpbGRBZ2U7IC8vIDUKICAgIGBgYAogIAogICAgSWYgdGhlIHR5cGVzIG9mIHRoZSBhcmd1bWVudHMgYXJlIG5vdCBudW1iZXJzLCB0aGV5IHdpbGwgYmUgY29udmVydGVkIHRvCiAgICBudW1iZXJzIGFuZCB0aGUgdHlwZSBvZiB0aGUgcmV0dXJuIHZhbHVlIHdpbGwgYWx3YXlzIGJlIGBOdW1iZXJgLiBGb3IgZXhhbXBsZSwKICAgIHRoZSBtaW4gb2YgYSBsaXN0IG9mIERhdGUgb2JqZWN0cyB3aWxsIGJlIHRoZSBsb3dlc3QgdGltZXN0YW1wIGFzIGEgYE51bWJlcmAuCiAgICBUaGlzIGJlaGF2aW9yIGlzIGNvbnNpc3RlbnQgd2l0aCBgTWF0aC5taW5gLgogIAogICAgQG1ldGhvZCBtaW4KICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZXMgdGhlIHNtYWxsZXN0IHZhbHVlIGluIHRoZSBkZXBlbmRlbnRLZXkncyBhcnJheQogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBtaW4oZGVwZW5kZW50S2V5KSB7CiAgICAoZmFsc2UgJiYgISghKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgYXR0ZW1wdGVkIHRvIHVzZSBAbWluIGFzIGEgZGVjb3JhdG9yIGRpcmVjdGx5LCBidXQgaXQgcmVxdWlyZXMgYSBgZGVwZW5kZW50S2V5YCBwYXJhbWV0ZXInLCAhKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkpOwogICAgcmV0dXJuIHJlZHVjZU1hY3JvKGRlcGVuZGVudEtleSwgZnVuY3Rpb24gKG1pbiwgaXRlbSkgewogICAgICByZXR1cm4gTWF0aC5taW4obWluLCBpdGVtKTsKICAgIH0sIEluZmluaXR5LCAnbWluJyk7CiAgfQogIC8qKgogICAgUmV0dXJucyBhbiBhcnJheSBtYXBwZWQgdmlhIHRoZSBjYWxsYmFjawogIAogICAgVGhlIGNhbGxiYWNrIG1ldGhvZCB5b3UgcHJvdmlkZSBzaG91bGQgaGF2ZSB0aGUgZm9sbG93aW5nIHNpZ25hdHVyZToKICAgIC0gYGl0ZW1gIGlzIHRoZSBjdXJyZW50IGl0ZW0gaW4gdGhlIGl0ZXJhdGlvbi4KICAgIC0gYGluZGV4YCBpcyB0aGUgaW50ZWdlciBpbmRleCBvZiB0aGUgY3VycmVudCBpdGVtIGluIHRoZSBpdGVyYXRpb24uCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBmdW5jdGlvbiBtYXBDYWxsYmFjayhpdGVtLCBpbmRleCk7CiAgICBgYGAKICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IG1hcCB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgSGFtc3RlciB7CiAgICAgIGNvbnN0cnVjdG9yKGNob3JlcykgewogICAgICAgIHNldCh0aGlzLCAnY2hvcmVzJywgY2hvcmVzKTsKICAgICAgfQogIAogICAgICBAbWFwKCdjaG9yZXMnLCBmdW5jdGlvbihjaG9yZSwgaW5kZXgpIHsKICAgICAgICByZXR1cm4gYCR7Y2hvcmUudG9VcHBlckNhc2UoKX0hYDsKICAgICAgfSkKICAgICAgZXhjaXRpbmdDaG9yZXM7CiAgICB9KTsKICAKICAgIGxldCBoYW1zdGVyID0gbmV3IEhhbXN0ZXIoWydjbGVhbicsICd3cml0ZSBtb3JlIHVuaXQgdGVzdHMnXSk7CiAgCiAgICBoYW1zdGVyLmV4Y2l0aW5nQ2hvcmVzOyAvLyBbJ0NMRUFOIScsICdXUklURSBNT1JFIFVOSVQgVEVTVFMhJ10KICAgIGBgYAogIAogICAgQ2xhc3NpYyBDbGFzcyBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgbWFwIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBsZXQgSGFtc3RlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGV4Y2l0aW5nQ2hvcmVzOiBtYXAoJ2Nob3JlcycsIGZ1bmN0aW9uKGNob3JlLCBpbmRleCkgewogICAgICAgIHJldHVybiBgJHtjaG9yZS50b1VwcGVyQ2FzZSgpfSFgOwogICAgICB9KQogICAgfSk7CiAgCiAgICBsZXQgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKHsKICAgICAgY2hvcmVzOiBbJ2NsZWFuJywgJ3dyaXRlIG1vcmUgdW5pdCB0ZXN0cyddCiAgICB9KTsKICAKICAgIGhhbXN0ZXIuZXhjaXRpbmdDaG9yZXM7IC8vIFsnQ0xFQU4hJywgJ1dSSVRFIE1PUkUgVU5JVCBURVNUUyEnXQogICAgYGBgCiAgCiAgICBZb3UgY2FuIG9wdGlvbmFsbHkgcGFzcyBhbiBhcnJheSBvZiBhZGRpdGlvbmFsIGRlcGVuZGVudCBrZXlzIGFzIHRoZSBzZWNvbmQKICAgIHBhcmFtZXRlciB0byB0aGUgbWFjcm8sIGlmIHlvdXIgbWFwIGZ1bmN0aW9uIHJlbGllcyBvbiBhbnkgZXh0ZXJuYWwgdmFsdWVzOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgc2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBtYXAgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGNsYXNzIEhhbXN0ZXIgewogICAgICBzaG91bGRVcHBlckNhc2UgPSBmYWxzZTsKICAKICAgICAgY29uc3RydWN0b3IoY2hvcmVzKSB7CiAgICAgICAgc2V0KHRoaXMsICdjaG9yZXMnLCBjaG9yZXMpOwogICAgICB9CiAgCiAgICAgIEBtYXAoJ2Nob3JlcycsIFsnc2hvdWxkVXBwZXJDYXNlJ10sIGZ1bmN0aW9uKGNob3JlLCBpbmRleCkgewogICAgICAgIGlmICh0aGlzLnNob3VsZFVwcGVyQ2FzZSkgewogICAgICAgICAgcmV0dXJuIGAke2Nob3JlLnRvVXBwZXJDYXNlKCl9IWA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBgJHtjaG9yZX0hYDsKICAgICAgICB9CiAgICAgIH0pCiAgICAgIGV4Y2l0aW5nQ2hvcmVzOwogICAgfQogIAogICAgbGV0IGhhbXN0ZXIgPSBuZXcgSGFtc3RlcihbJ2NsZWFuJywgJ3dyaXRlIG1vcmUgdW5pdCB0ZXN0cyddKTsKICAKICAgIGhhbXN0ZXIuZXhjaXRpbmdDaG9yZXM7IC8vIFsnY2xlYW4hJywgJ3dyaXRlIG1vcmUgdW5pdCB0ZXN0cyEnXQogIAogICAgc2V0KGhhbXN0ZXIsICdzaG91bGRVcHBlckNhc2UnLCB0cnVlKTsKICAgIGhhbXN0ZXIuZXhjaXRpbmdDaG9yZXM7IC8vIFsnQ0xFQU4hJywgJ1dSSVRFIE1PUkUgVU5JVCBURVNUUyEnXQogICAgYGBgCiAgCiAgICBAbWV0aG9kIG1hcAogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgICBAcGFyYW0ge0FycmF5fSBbYWRkaXRpb25hbERlcGVuZGVudEtleXNdIG9wdGlvbmFsIGFycmF5IG9mIGFkZGl0aW9uYWwKICAgIGRlcGVuZGVudCBrZXlzCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjawogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gYW4gYXJyYXkgbWFwcGVkIHZpYSB0aGUgY2FsbGJhY2sKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gbWFwKGRlcGVuZGVudEtleSwgYWRkaXRpb25hbERlcGVuZGVudEtleXMsIGNhbGxiYWNrKSB7CiAgICAoZmFsc2UgJiYgISghKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgYXR0ZW1wdGVkIHRvIHVzZSBAbWFwIGFzIGEgZGVjb3JhdG9yIGRpcmVjdGx5LCBidXQgaXQgcmVxdWlyZXMgYXRsZWFzdCBgZGVwZW5kZW50S2V5YCBhbmQgYGNhbGxiYWNrYCBwYXJhbWV0ZXJzJywgISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpKTsKCiAgICBpZiAoY2FsbGJhY2sgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgYWRkaXRpb25hbERlcGVuZGVudEtleXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2FsbGJhY2sgPSBhZGRpdGlvbmFsRGVwZW5kZW50S2V5czsKICAgICAgYWRkaXRpb25hbERlcGVuZGVudEtleXMgPSBbXTsKICAgIH0KCiAgICAoZmFsc2UgJiYgISh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnVGhlIGZpbmFsIHBhcmFtZXRlciBwcm92aWRlZCB0byBtYXAgbXVzdCBiZSBhIGNhbGxiYWNrIGZ1bmN0aW9uJywgdHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSk7CiAgICAoZmFsc2UgJiYgIShBcnJheS5pc0FycmF5KGFkZGl0aW9uYWxEZXBlbmRlbnRLZXlzKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUaGUgc2Vjb25kIHBhcmFtZXRlciBwcm92aWRlZCB0byBtYXAgbXVzdCBlaXRoZXIgYmUgdGhlIGNhbGxiYWNrIG9yIGFuIGFycmF5IG9mIGFkZGl0aW9uYWwgZGVwZW5kZW50IGtleXMnLCBBcnJheS5pc0FycmF5KGFkZGl0aW9uYWxEZXBlbmRlbnRLZXlzKSkpOwogICAgcmV0dXJuIGFycmF5TWFjcm8oZGVwZW5kZW50S2V5LCBhZGRpdGlvbmFsRGVwZW5kZW50S2V5cywgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZS5tYXAoY2FsbGJhY2ssIHRoaXMpOwogICAgfSk7CiAgfQogIC8qKgogICAgUmV0dXJucyBhbiBhcnJheSBtYXBwZWQgdG8gdGhlIHNwZWNpZmllZCBrZXkuCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgc2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBtYXBCeSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgUGVyc29uIHsKICAgICAgY2hpbGRyZW4gPSBbXTsKICAKICAgICAgQG1hcEJ5KCdjaGlsZHJlbicsICdhZ2UnKSBjaGlsZEFnZXM7CiAgICB9CiAgCiAgICBsZXQgbG9yZEJ5cm9uID0gbmV3IFBlcnNvbigpOwogIAogICAgbG9yZEJ5cm9uLmNoaWxkQWdlczsgLy8gW10KICAKICAgIHNldChsb3JkQnlyb24sICdjaGlsZHJlbicsIFsKICAgICAgewogICAgICAgIG5hbWU6ICdBdWd1c3RhIEFkYSBCeXJvbicsCiAgICAgICAgYWdlOiA3CiAgICAgIH0KICAgIF0pOwogICAgbG9yZEJ5cm9uLmNoaWxkQWdlczsgLy8gWzddCiAgCiAgICBzZXQobG9yZEJ5cm9uLCAnY2hpbGRyZW4nLCBbCiAgICAgIC4uLmxvcmRCeXJvbi5jaGlsZHJlbiwKICAgICAgewogICAgICAgIG5hbWU6ICdBbGxlZ3JhIEJ5cm9uJywKICAgICAgICBhZ2U6IDUKICAgICAgfSwgewogICAgICAgIG5hbWU6ICdFbGl6YWJldGggTWVkb3JhIExlaWdoJywKICAgICAgICBhZ2U6IDgKICAgICAgfQogICAgXSk7CiAgICBsb3JkQnlyb24uY2hpbGRBZ2VzOyAvLyBbNywgNSwgOF0KICAgIGBgYAogIAogICAgQ2xhc3NpYyBDbGFzcyBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgbWFwQnkgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGxldCBQZXJzb24gPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICBjaGlsZEFnZXM6IG1hcEJ5KCdjaGlsZHJlbicsICdhZ2UnKQogICAgfSk7CiAgCiAgICBsZXQgbG9yZEJ5cm9uID0gUGVyc29uLmNyZWF0ZSh7IGNoaWxkcmVuOiBbXSB9KTsKICAKICAgIGxvcmRCeXJvbi5jaGlsZEFnZXM7IC8vIFtdCiAgCiAgICBzZXQobG9yZEJ5cm9uLCAnY2hpbGRyZW4nLCBbCiAgICAgIHsKICAgICAgICBuYW1lOiAnQXVndXN0YSBBZGEgQnlyb24nLAogICAgICAgIGFnZTogNwogICAgICB9CiAgICBdKTsKICAgIGxvcmRCeXJvbi5jaGlsZEFnZXM7IC8vIFs3XQogIAogICAgc2V0KGxvcmRCeXJvbiwgJ2NoaWxkcmVuJywgWwogICAgICAuLi5sb3JkQnlyb24uY2hpbGRyZW4sCiAgICAgIHsKICAgICAgICBuYW1lOiAnQWxsZWdyYSBCeXJvbicsCiAgICAgICAgYWdlOiA1CiAgICAgIH0sIHsKICAgICAgICBuYW1lOiAnRWxpemFiZXRoIE1lZG9yYSBMZWlnaCcsCiAgICAgICAgYWdlOiA4CiAgICAgIH0KICAgIF0pOwogICAgbG9yZEJ5cm9uLmNoaWxkQWdlczsgLy8gWzcsIDUsIDhdCiAgICBgYGAKICAKICAgIEBtZXRob2QgbWFwQnkKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5S2V5CiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBhbiBhcnJheSBtYXBwZWQgdG8gdGhlIHNwZWNpZmllZCBrZXkKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gbWFwQnkoZGVwZW5kZW50S2V5LCBwcm9wZXJ0eUtleSkgewogICAgKGZhbHNlICYmICEoISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGF0dGVtcHRlZCB0byB1c2UgQG1hcEJ5IGFzIGEgZGVjb3JhdG9yIGRpcmVjdGx5LCBidXQgaXQgcmVxdWlyZXMgYGRlcGVuZGVudEtleWAgYW5kIGBwcm9wZXJ0eUtleWAgcGFyYW1ldGVycycsICEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKSk7CiAgICAoZmFsc2UgJiYgISh0eXBlb2YgcHJvcGVydHlLZXkgPT09ICdzdHJpbmcnKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2Bjb21wdXRlZC5tYXBCeWAgZXhwZWN0cyBhIHByb3BlcnR5IHN0cmluZyBmb3IgaXRzIHNlY29uZCBhcmd1bWVudCwgJyArICdwZXJoYXBzIHlvdSBtZWFudCB0byB1c2UgIm1hcCInLCB0eXBlb2YgcHJvcGVydHlLZXkgPT09ICdzdHJpbmcnKSk7CiAgICAoZmFsc2UgJiYgISghL1tcW1xdXHtcfV0vZy50ZXN0KGRlcGVuZGVudEtleSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiRGVwZW5kZW50IGtleSBwYXNzZWQgdG8gYGNvbXB1dGVkLm1hcEJ5YCBzaG91bGRuJ3QgY29udGFpbiBicmFjZSBleHBhbmRpbmcgcGF0dGVybi4iLCAhL1tcW1xdXHtcfV0vZy50ZXN0KGRlcGVuZGVudEtleSkpKTsKICAgIHJldHVybiBtYXAoZGVwZW5kZW50S2V5ICsgIi5AZWFjaC4iICsgcHJvcGVydHlLZXksIGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHJldHVybiAoMCwgX21ldGFsLmdldCkoaXRlbSwgcHJvcGVydHlLZXkpOwogICAgfSk7CiAgfQogIC8qKgogICAgRmlsdGVycyB0aGUgYXJyYXkgYnkgdGhlIGNhbGxiYWNrLgogIAogICAgVGhlIGNhbGxiYWNrIG1ldGhvZCB5b3UgcHJvdmlkZSBzaG91bGQgaGF2ZSB0aGUgZm9sbG93aW5nIHNpZ25hdHVyZToKICAgIC0gYGl0ZW1gIGlzIHRoZSBjdXJyZW50IGl0ZW0gaW4gdGhlIGl0ZXJhdGlvbi4KICAgIC0gYGluZGV4YCBpcyB0aGUgaW50ZWdlciBpbmRleCBvZiB0aGUgY3VycmVudCBpdGVtIGluIHRoZSBpdGVyYXRpb24uCiAgICAtIGBhcnJheWAgaXMgdGhlIGRlcGVuZGFudCBhcnJheSBpdHNlbGYuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBmdW5jdGlvbiBmaWx0ZXJDYWxsYmFjayhpdGVtLCBpbmRleCwgYXJyYXkpOwogICAgYGBgCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgc2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBmaWx0ZXIgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGNsYXNzIEhhbXN0ZXIgewogICAgICBjb25zdHJ1Y3RvcihjaG9yZXMpIHsKICAgICAgICBzZXQodGhpcywgJ2Nob3JlcycsIGNob3Jlcyk7CiAgICAgIH0KICAKICAgICAgQGZpbHRlcignY2hvcmVzJywgZnVuY3Rpb24oY2hvcmUsIGluZGV4LCBhcnJheSkgewogICAgICAgIHJldHVybiAhY2hvcmUuZG9uZTsKICAgICAgfSkKICAgICAgcmVtYWluaW5nQ2hvcmVzOwogICAgfQogIAogICAgbGV0IGhhbXN0ZXIgPSBIYW1zdGVyLmNyZWF0ZShbCiAgICAgIHsgbmFtZTogJ2Nvb2snLCBkb25lOiB0cnVlIH0sCiAgICAgIHsgbmFtZTogJ2NsZWFuJywgZG9uZTogdHJ1ZSB9LAogICAgICB7IG5hbWU6ICd3cml0ZSBtb3JlIHVuaXQgdGVzdHMnLCBkb25lOiBmYWxzZSB9CiAgICBdKTsKICAKICAgIGhhbXN0ZXIucmVtYWluaW5nQ2hvcmVzOyAvLyBbe25hbWU6ICd3cml0ZSBtb3JlIHVuaXQgdGVzdHMnLCBkb25lOiBmYWxzZX1dCiAgICBgYGAKICAKICAgIENsYXNzaWMgQ2xhc3MgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IGZpbHRlciB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgbGV0IEhhbXN0ZXIgPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICByZW1haW5pbmdDaG9yZXM6IGZpbHRlcignY2hvcmVzJywgZnVuY3Rpb24oY2hvcmUsIGluZGV4LCBhcnJheSkgewogICAgICAgIHJldHVybiAhY2hvcmUuZG9uZTsKICAgICAgfSkKICAgIH0pOwogIAogICAgbGV0IGhhbXN0ZXIgPSBIYW1zdGVyLmNyZWF0ZSh7CiAgICAgIGNob3JlczogWwogICAgICAgIHsgbmFtZTogJ2Nvb2snLCBkb25lOiB0cnVlIH0sCiAgICAgICAgeyBuYW1lOiAnY2xlYW4nLCBkb25lOiB0cnVlIH0sCiAgICAgICAgeyBuYW1lOiAnd3JpdGUgbW9yZSB1bml0IHRlc3RzJywgZG9uZTogZmFsc2UgfQogICAgICBdCiAgICB9KTsKICAKICAgIGhhbXN0ZXIucmVtYWluaW5nQ2hvcmVzOyAvLyBbe25hbWU6ICd3cml0ZSBtb3JlIHVuaXQgdGVzdHMnLCBkb25lOiBmYWxzZX1dCiAgICBgYGAKICAKICAgIFlvdSBjYW4gYWxzbyB1c2UgYEBlYWNoLnByb3BlcnR5YCBpbiB5b3VyIGRlcGVuZGVudCBrZXksIHRoZSBjYWxsYmFjayB3aWxsCiAgICBzdGlsbCB1c2UgdGhlIHVuZGVybHlpbmcgYXJyYXk6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IGZpbHRlciB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgSGFtc3RlciB7CiAgICAgIGNvbnN0cnVjdG9yKGNob3JlcykgewogICAgICAgIHNldCh0aGlzLCAnY2hvcmVzJywgY2hvcmVzKTsKICAgICAgfQogIAogICAgICBAZmlsdGVyKCdjaG9yZXMuQGVhY2guZG9uZScsIGZ1bmN0aW9uKGNob3JlLCBpbmRleCwgYXJyYXkpIHsKICAgICAgICByZXR1cm4gIWNob3JlLmRvbmU7CiAgICAgIH0pCiAgICAgIHJlbWFpbmluZ0Nob3JlczsKICAgIH0KICAKICAgIGxldCBoYW1zdGVyID0gbmV3IEhhbXN0ZXIoWwogICAgICB7IG5hbWU6ICdjb29rJywgZG9uZTogdHJ1ZSB9LAogICAgICB7IG5hbWU6ICdjbGVhbicsIGRvbmU6IHRydWUgfSwKICAgICAgeyBuYW1lOiAnd3JpdGUgbW9yZSB1bml0IHRlc3RzJywgZG9uZTogZmFsc2UgfQogICAgXSk7CiAgICBoYW1zdGVyLnJlbWFpbmluZ0Nob3JlczsgLy8gW3tuYW1lOiAnd3JpdGUgbW9yZSB1bml0IHRlc3RzJywgZG9uZTogZmFsc2V9XQogIAogICAgc2V0KGhhbXN0ZXIuY2hvcmVzWzJdLCAnZG9uZScsIHRydWUpOwogICAgaGFtc3Rlci5yZW1haW5pbmdDaG9yZXM7IC8vIFtdCiAgICBgYGAKICAKICAgIEZpbmFsbHksIHlvdSBjYW4gb3B0aW9uYWxseSBwYXNzIGFuIGFycmF5IG9mIGFkZGl0aW9uYWwgZGVwZW5kZW50IGtleXMgYXMgdGhlCiAgICBzZWNvbmQgcGFyYW1ldGVyIHRvIHRoZSBtYWNybywgaWYgeW91ciBmaWx0ZXIgZnVuY3Rpb24gcmVsaWVzIG9uIGFueSBleHRlcm5hbAogICAgdmFsdWVzOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgZmlsdGVyIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBjbGFzcyBIYW1zdGVyIHsKICAgICAgY29uc3RydWN0b3IoY2hvcmVzKSB7CiAgICAgICAgc2V0KHRoaXMsICdjaG9yZXMnLCBjaG9yZXMpOwogICAgICB9CiAgCiAgICAgIGRvbmVLZXkgPSAnZmluaXNoZWQnOwogIAogICAgICBAZmlsdGVyKCdjaG9yZXMnLCBbJ2RvbmVLZXknXSwgZnVuY3Rpb24oY2hvcmUsIGluZGV4LCBhcnJheSkgewogICAgICAgIHJldHVybiAhY2hvcmVbdGhpcy5kb25lS2V5XTsKICAgICAgfSkKICAgICAgcmVtYWluaW5nQ2hvcmVzOwogICAgfQogIAogICAgbGV0IGhhbXN0ZXIgPSBuZXcgSGFtc3RlcihbCiAgICAgIHsgbmFtZTogJ2Nvb2snLCBmaW5pc2hlZDogdHJ1ZSB9LAogICAgICB7IG5hbWU6ICdjbGVhbicsIGZpbmlzaGVkOiB0cnVlIH0sCiAgICAgIHsgbmFtZTogJ3dyaXRlIG1vcmUgdW5pdCB0ZXN0cycsIGZpbmlzaGVkOiBmYWxzZSB9CiAgICBdKTsKICAKICAgIGhhbXN0ZXIucmVtYWluaW5nQ2hvcmVzOyAvLyBbe25hbWU6ICd3cml0ZSBtb3JlIHVuaXQgdGVzdHMnLCBmaW5pc2hlZDogZmFsc2V9XQogICAgYGBgCiAgCiAgICBAbWV0aG9kIGZpbHRlcgogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgICBAcGFyYW0ge0FycmF5fSBbYWRkaXRpb25hbERlcGVuZGVudEtleXNdIG9wdGlvbmFsIGFycmF5IG9mIGFkZGl0aW9uYWwgZGVwZW5kZW50IGtleXMKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSB0aGUgZmlsdGVyZWQgYXJyYXkKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gZmlsdGVyKGRlcGVuZGVudEtleSwgYWRkaXRpb25hbERlcGVuZGVudEtleXMsIGNhbGxiYWNrKSB7CiAgICAoZmFsc2UgJiYgISghKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgYXR0ZW1wdGVkIHRvIHVzZSBAZmlsdGVyIGFzIGEgZGVjb3JhdG9yIGRpcmVjdGx5LCBidXQgaXQgcmVxdWlyZXMgYXRsZWFzdCBgZGVwZW5kZW50S2V5YCBhbmQgYGNhbGxiYWNrYCBwYXJhbWV0ZXJzJywgISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpKTsKCiAgICBpZiAoY2FsbGJhY2sgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgYWRkaXRpb25hbERlcGVuZGVudEtleXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2FsbGJhY2sgPSBhZGRpdGlvbmFsRGVwZW5kZW50S2V5czsKICAgICAgYWRkaXRpb25hbERlcGVuZGVudEtleXMgPSBbXTsKICAgIH0KCiAgICAoZmFsc2UgJiYgISh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnVGhlIGZpbmFsIHBhcmFtZXRlciBwcm92aWRlZCB0byBmaWx0ZXIgbXVzdCBiZSBhIGNhbGxiYWNrIGZ1bmN0aW9uJywgdHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSk7CiAgICAoZmFsc2UgJiYgIShBcnJheS5pc0FycmF5KGFkZGl0aW9uYWxEZXBlbmRlbnRLZXlzKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUaGUgc2Vjb25kIHBhcmFtZXRlciBwcm92aWRlZCB0byBmaWx0ZXIgbXVzdCBlaXRoZXIgYmUgdGhlIGNhbGxiYWNrIG9yIGFuIGFycmF5IG9mIGFkZGl0aW9uYWwgZGVwZW5kZW50IGtleXMnLCBBcnJheS5pc0FycmF5KGFkZGl0aW9uYWxEZXBlbmRlbnRLZXlzKSkpOwogICAgcmV0dXJuIGFycmF5TWFjcm8oZGVwZW5kZW50S2V5LCBhZGRpdGlvbmFsRGVwZW5kZW50S2V5cywgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZS5maWx0ZXIoY2FsbGJhY2ssIHRoaXMpOwogICAgfSk7CiAgfQogIC8qKgogICAgRmlsdGVycyB0aGUgYXJyYXkgYnkgdGhlIHByb3BlcnR5IGFuZCB2YWx1ZS4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IGZpbHRlckJ5IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBjbGFzcyBIYW1zdGVyIHsKICAgICAgY29uc3RydWN0b3IoY2hvcmVzKSB7CiAgICAgICAgc2V0KHRoaXMsICdjaG9yZXMnLCBjaG9yZXMpOwogICAgICB9CiAgCiAgICAgIEBmaWx0ZXJCeSgnY2hvcmVzJywgJ2RvbmUnLCBmYWxzZSkgcmVtYWluaW5nQ2hvcmVzOwogICAgfQogIAogICAgbGV0IGhhbXN0ZXIgPSBuZXcgSGFtc3RlcihbCiAgICAgIHsgbmFtZTogJ2Nvb2snLCBkb25lOiB0cnVlIH0sCiAgICAgIHsgbmFtZTogJ2NsZWFuJywgZG9uZTogdHJ1ZSB9LAogICAgICB7IG5hbWU6ICd3cml0ZSBtb3JlIHVuaXQgdGVzdHMnLCBkb25lOiBmYWxzZSB9CiAgICBdKTsKICAKICAgIGhhbXN0ZXIucmVtYWluaW5nQ2hvcmVzOyAvLyBbeyBuYW1lOiAnd3JpdGUgbW9yZSB1bml0IHRlc3RzJywgZG9uZTogZmFsc2UgfV0KICAgIGBgYAogIAogICAgQ2xhc3NpYyBDbGFzcyBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgZmlsdGVyQnkgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgcmVtYWluaW5nQ2hvcmVzOiBmaWx0ZXJCeSgnY2hvcmVzJywgJ2RvbmUnLCBmYWxzZSkKICAgIH0pOwogIAogICAgbGV0IGhhbXN0ZXIgPSBIYW1zdGVyLmNyZWF0ZSh7CiAgICAgIGNob3JlczogWwogICAgICAgIHsgbmFtZTogJ2Nvb2snLCBkb25lOiB0cnVlIH0sCiAgICAgICAgeyBuYW1lOiAnY2xlYW4nLCBkb25lOiB0cnVlIH0sCiAgICAgICAgeyBuYW1lOiAnd3JpdGUgbW9yZSB1bml0IHRlc3RzJywgZG9uZTogZmFsc2UgfQogICAgICBdCiAgICB9KTsKICAKICAgIGhhbXN0ZXIucmVtYWluaW5nQ2hvcmVzOyAvLyBbeyBuYW1lOiAnd3JpdGUgbW9yZSB1bml0IHRlc3RzJywgZG9uZTogZmFsc2UgfV0KICAgIGBgYAogIAogICAgQG1ldGhvZCBmaWx0ZXJCeQogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHlLZXkKICAgIEBwYXJhbSB7Kn0gdmFsdWUKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IHRoZSBmaWx0ZXJlZCBhcnJheQogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBmaWx0ZXJCeShkZXBlbmRlbnRLZXksIHByb3BlcnR5S2V5LCB2YWx1ZSkgewogICAgKGZhbHNlICYmICEoISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGF0dGVtcHRlZCB0byB1c2UgQGZpbHRlckJ5IGFzIGEgZGVjb3JhdG9yIGRpcmVjdGx5LCBidXQgaXQgcmVxdWlyZXMgYXRsZWFzdCBgZGVwZW5kZW50S2V5YCBhbmQgYHByb3BlcnR5S2V5YCBwYXJhbWV0ZXJzJywgISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpKTsKICAgIChmYWxzZSAmJiAhKCEvW1xbXF1ce1x9XS9nLnRlc3QoZGVwZW5kZW50S2V5KSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCJEZXBlbmRlbnQga2V5IHBhc3NlZCB0byBgY29tcHV0ZWQuZmlsdGVyQnlgIHNob3VsZG4ndCBjb250YWluIGJyYWNlIGV4cGFuZGluZyBwYXR0ZXJuLiIsICEvW1xbXF1ce1x9XS9nLnRlc3QoZGVwZW5kZW50S2V5KSkpOwogICAgdmFyIGNhbGxiYWNrOwoKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24gY2FsbGJhY2soaXRlbSkgewogICAgICAgIHJldHVybiAoMCwgX21ldGFsLmdldCkoaXRlbSwgcHJvcGVydHlLZXkpOwogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbiBjYWxsYmFjayhpdGVtKSB7CiAgICAgICAgcmV0dXJuICgwLCBfbWV0YWwuZ2V0KShpdGVtLCBwcm9wZXJ0eUtleSkgPT09IHZhbHVlOwogICAgICB9OwogICAgfQoKICAgIHJldHVybiBmaWx0ZXIoZGVwZW5kZW50S2V5ICsgIi5AZWFjaC4iICsgcHJvcGVydHlLZXksIGNhbGxiYWNrKTsKICB9CiAgLyoqCiAgICBBIGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIHJldHVybnMgYSBuZXcgYXJyYXkgd2l0aCBhbGwgdGhlIHVuaXF1ZSBlbGVtZW50cwogICAgZnJvbSBvbmUgb3IgbW9yZSBkZXBlbmRlbnQgYXJyYXlzLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgdW5pcSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgSGFtc3RlciB7CiAgICAgIGNvbnN0cnVjdG9yKGZydWl0cykgewogICAgICAgIHNldCh0aGlzLCAnZnJ1aXRzJywgZnJ1aXRzKTsKICAgICAgfQogIAogICAgICBAdW5pcSgnZnJ1aXRzJykgdW5pcXVlRnJ1aXRzOwogICAgfQogIAogICAgbGV0IGhhbXN0ZXIgPSBuZXcgSGFtc3RlcihbCiAgICAgICdiYW5hbmEnLAogICAgICAnZ3JhcGUnLAogICAgICAna2FsZScsCiAgICAgICdiYW5hbmEnCiAgICBdKTsKICAKICAgIGhhbXN0ZXIudW5pcXVlRnJ1aXRzOyAvLyBbJ2JhbmFuYScsICdncmFwZScsICdrYWxlJ10KICAgIGBgYAogIAogICAgQ2xhc3NpYyBDbGFzcyBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgdW5pcSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgbGV0IEhhbXN0ZXIgPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICB1bmlxdWVGcnVpdHM6IHVuaXEoJ2ZydWl0cycpCiAgICB9KTsKICAKICAgIGxldCBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoewogICAgICBmcnVpdHM6IFsKICAgICAgICAnYmFuYW5hJywKICAgICAgICAnZ3JhcGUnLAogICAgICAgICdrYWxlJywKICAgICAgICAnYmFuYW5hJwogICAgICBdCiAgICB9KTsKICAKICAgIGhhbXN0ZXIudW5pcXVlRnJ1aXRzOyAvLyBbJ2JhbmFuYScsICdncmFwZScsICdrYWxlJ10KICAgIGBgYAogIAogICAgQG1ldGhvZCB1bmlxCiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eUtleSoKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVzIGEgbmV3IGFycmF5IHdpdGggYWxsIHRoZQogICAgdW5pcXVlIGVsZW1lbnRzIGZyb20gdGhlIGRlcGVuZGVudCBhcnJheQogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiB1bmlxKCkgewogICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICB9CgogICAgKGZhbHNlICYmICEoISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGF0dGVtcHRlZCB0byB1c2UgQHVuaXEvQHVuaW9uIGFzIGEgZGVjb3JhdG9yIGRpcmVjdGx5LCBidXQgaXQgcmVxdWlyZXMgYXRsZWFzdCBvbmUgZGVwZW5kZW50IGtleSBwYXJhbWV0ZXInLCAhKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkpOwogICAgcmV0dXJuIG11bHRpQXJyYXlNYWNybyhhcmdzLCBmdW5jdGlvbiAoZGVwZW5kZW50S2V5cykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIHVuaXEgPSAoMCwgX3J1bnRpbWUuQSkoKTsKICAgICAgdmFyIHNlZW4gPSBuZXcgU2V0KCk7CiAgICAgIGRlcGVuZGVudEtleXMuZm9yRWFjaChmdW5jdGlvbiAoZGVwZW5kZW50S2V5KSB7CiAgICAgICAgdmFyIHZhbHVlID0gKDAsIF9tZXRhbC5nZXQpKF90aGlzLCBkZXBlbmRlbnRLZXkpOwoKICAgICAgICBpZiAoKDAsIF9ydW50aW1lLmlzQXJyYXkpKHZhbHVlKSkgewogICAgICAgICAgdmFsdWUuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICBpZiAoIXNlZW4uaGFzKGl0ZW0pKSB7CiAgICAgICAgICAgICAgc2Vlbi5hZGQoaXRlbSk7CiAgICAgICAgICAgICAgdW5pcS5wdXNoKGl0ZW0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gdW5pcTsKICAgIH0sICd1bmlxJyk7CiAgfQogIC8qKgogICAgQSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCByZXR1cm5zIGEgbmV3IGFycmF5IHdpdGggYWxsIHRoZSB1bmlxdWUgZWxlbWVudHMKICAgIGZyb20gYW4gYXJyYXksIHdpdGggdW5pcXVlbmVzcyBkZXRlcm1pbmVkIGJ5IHNwZWNpZmljIGtleS4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IHVuaXFCeSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgSGFtc3RlciB7CiAgICAgIGNvbnN0cnVjdG9yKGZydWl0cykgewogICAgICAgIHNldCh0aGlzLCAnZnJ1aXRzJywgZnJ1aXRzKTsKICAgICAgfQogIAogICAgICBAdW5pcUJ5KCdmcnVpdHMnLCAnaWQnKSB1bmlxdWVGcnVpdHM7CiAgICB9CiAgCiAgICBsZXQgaGFtc3RlciA9IG5ldyBIYW1zdGVyKFsKICAgICAgeyBpZDogMSwgJ2JhbmFuYScgfSwKICAgICAgeyBpZDogMiwgJ2dyYXBlJyB9LAogICAgICB7IGlkOiAzLCAncGVhY2gnIH0sCiAgICAgIHsgaWQ6IDEsICdiYW5hbmEnIH0KICAgIF0pOwogIAogICAgaGFtc3Rlci51bmlxdWVGcnVpdHM7IC8vIFsgeyBpZDogMSwgJ2JhbmFuYScgfSwgeyBpZDogMiwgJ2dyYXBlJyB9LCB7IGlkOiAzLCAncGVhY2gnIH1dCiAgICBgYGAKICAKICAgIENsYXNzaWMgQ2xhc3MgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IHVuaXFCeSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgbGV0IEhhbXN0ZXIgPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICB1bmlxdWVGcnVpdHM6IHVuaXFCeSgnZnJ1aXRzJywgJ2lkJykKICAgIH0pOwogIAogICAgbGV0IGhhbXN0ZXIgPSBIYW1zdGVyLmNyZWF0ZSh7CiAgICAgIGZydWl0czogWwogICAgICAgIHsgaWQ6IDEsICdiYW5hbmEnIH0sCiAgICAgICAgeyBpZDogMiwgJ2dyYXBlJyB9LAogICAgICAgIHsgaWQ6IDMsICdwZWFjaCcgfSwKICAgICAgICB7IGlkOiAxLCAnYmFuYW5hJyB9CiAgICAgIF0KICAgIH0pOwogIAogICAgaGFtc3Rlci51bmlxdWVGcnVpdHM7IC8vIFsgeyBpZDogMSwgJ2JhbmFuYScgfSwgeyBpZDogMiwgJ2dyYXBlJyB9LCB7IGlkOiAzLCAncGVhY2gnIH1dCiAgICBgYGAKICAKICAgIEBtZXRob2QgdW5pcUJ5CiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICAgIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eUtleQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZXMgYSBuZXcgYXJyYXkgd2l0aCBhbGwgdGhlCiAgICB1bmlxdWUgZWxlbWVudHMgZnJvbSB0aGUgZGVwZW5kZW50IGFycmF5CiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIHVuaXFCeShkZXBlbmRlbnRLZXksIHByb3BlcnR5S2V5KSB7CiAgICAoZmFsc2UgJiYgISghKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgYXR0ZW1wdGVkIHRvIHVzZSBAdW5pcUJ5IGFzIGEgZGVjb3JhdG9yIGRpcmVjdGx5LCBidXQgaXQgcmVxdWlyZXMgYGRlcGVuZGVudEtleWAgYW5kIGBwcm9wZXJ0eUtleWAgcGFyYW1ldGVycycsICEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKSk7CiAgICAoZmFsc2UgJiYgISghL1tcW1xdXHtcfV0vZy50ZXN0KGRlcGVuZGVudEtleSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiRGVwZW5kZW50IGtleSBwYXNzZWQgdG8gYGNvbXB1dGVkLnVuaXFCeWAgc2hvdWxkbid0IGNvbnRhaW4gYnJhY2UgZXhwYW5kaW5nIHBhdHRlcm4uIiwgIS9bXFtcXVx7XH1dL2cudGVzdChkZXBlbmRlbnRLZXkpKSk7CiAgICByZXR1cm4gKDAsIF9tZXRhbC5jb21wdXRlZCkoZGVwZW5kZW50S2V5ICsgIi5bXSIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGxpc3QgPSAoMCwgX21ldGFsLmdldCkodGhpcywgZGVwZW5kZW50S2V5KTsKICAgICAgcmV0dXJuICgwLCBfcnVudGltZS5pc0FycmF5KShsaXN0KSA/ICgwLCBfcnVudGltZS51bmlxQnkpKGxpc3QsIHByb3BlcnR5S2V5KSA6ICgwLCBfcnVudGltZS5BKSgpOwogICAgfSkucmVhZE9ubHkoKTsKICB9CiAgLyoqCiAgICBBIGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIHJldHVybnMgYSBuZXcgYXJyYXkgd2l0aCBhbGwgdGhlIHVuaXF1ZSBlbGVtZW50cwogICAgZnJvbSBvbmUgb3IgbW9yZSBkZXBlbmRlbnQgYXJyYXlzLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgdW5pb24gfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAKICAgIGNsYXNzIEhhbXN0ZXIgewogICAgICBjb25zdHJ1Y3RvcihmcnVpdHMsIHZlZ2V0YWJsZXMpIHsKICAgICAgICBzZXQodGhpcywgJ2ZydWl0cycsIGZydWl0cyk7CiAgICAgICAgc2V0KHRoaXMsICd2ZWdldGFibGVzJywgdmVnZXRhYmxlcyk7CiAgICAgIH0KICAKICAgICAgQHVuaW9uKCdmcnVpdHMnLCAndmVnZXRhYmxlcycpIGVkaWJsZVBsYW50czsKICAgIH0pOwogIAogICAgbGV0IGhhbXN0ZXIgPSBuZXcsIEhhbXN0ZXIoCiAgICAgIFsKICAgICAgICAnYmFuYW5hJywKICAgICAgICAnZ3JhcGUnLAogICAgICAgICdrYWxlJywKICAgICAgICAnYmFuYW5hJywKICAgICAgICAndG9tYXRvJwogICAgICBdLAogICAgICBbCiAgICAgICAgJ3RvbWF0bycsCiAgICAgICAgJ2NhcnJvdCcsCiAgICAgICAgJ2xldHR1Y2UnCiAgICAgIF0KICAgICk7CiAgCiAgICBoYW1zdGVyLnVuaXF1ZUZydWl0czsgLy8gWydiYW5hbmEnLCAnZ3JhcGUnLCAna2FsZScsICd0b21hdG8nLCAnY2Fycm90JywgJ2xldHR1Y2UnXQogICAgYGBgCiAgCiAgICBDbGFzc2ljIENsYXNzIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyB1bmlvbiB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgbGV0IEhhbXN0ZXIgPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICB1bmlxdWVGcnVpdHM6IHVuaW9uKCdmcnVpdHMnLCAndmVnZXRhYmxlcycpCiAgICB9KTsKICAKICAgIGxldCBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoewogICAgICBmcnVpdHM6IFsKICAgICAgICAnYmFuYW5hJywKICAgICAgICAnZ3JhcGUnLAogICAgICAgICdrYWxlJywKICAgICAgICAnYmFuYW5hJywKICAgICAgICAndG9tYXRvJwogICAgICBdLAogICAgICB2ZWdldGFibGVzOiBbCiAgICAgICAgJ3RvbWF0bycsCiAgICAgICAgJ2NhcnJvdCcsCiAgICAgICAgJ2xldHR1Y2UnCiAgICAgIF0KICAgIH0pOwogIAogICAgaGFtc3Rlci51bmlxdWVGcnVpdHM7IC8vIFsnYmFuYW5hJywgJ2dyYXBlJywgJ2thbGUnLCAndG9tYXRvJywgJ2NhcnJvdCcsICdsZXR0dWNlJ10KICAgIGBgYAogIAogICAgQG1ldGhvZCB1bmlvbgogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHlLZXkqCiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlcyBhIG5ldyBhcnJheSB3aXRoIGFsbCB0aGUgdW5pcXVlIGVsZW1lbnRzCiAgICBmcm9tIG9uZSBvciBtb3JlIGRlcGVuZGVudCBhcnJheXMuCiAgICBAcHVibGljCiAgKi8KCgogIHZhciB1bmlvbiA9IHVuaXE7CiAgLyoqCiAgICBBIGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIHJldHVybnMgYSBuZXcgYXJyYXkgd2l0aCBhbGwgdGhlIGVsZW1lbnRzCiAgICB0d28gb3IgbW9yZSBkZXBlbmRlbnQgYXJyYXlzIGhhdmUgaW4gY29tbW9uLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgaW50ZXJzZWN0IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBjbGFzcyBGcmllbmRHcm91cHMgewogICAgICBjb25zdHJ1Y3RvcihhZGFGcmllbmRzLCBjaGFybGVzRnJpZW5kcykgewogICAgICAgIHNldCh0aGlzLCAnYWRhRnJpZW5kcycsIGFkYUZyaWVuZHMpOwogICAgICAgIHNldCh0aGlzLCAnY2hhcmxlc0ZyaWVuZHMnLCBjaGFybGVzRnJpZW5kcyk7CiAgICAgIH0KICAKICAgICAgQGludGVyc2VjdCgnYWRhRnJpZW5kcycsICdjaGFybGVzRnJpZW5kcycpIGZyaWVuZHNJbkNvbW1vbjsKICAgIH0KICAKICAgIGxldCBncm91cHMgPSBuZXcgRnJpZW5kR3JvdXBzKAogICAgICBbJ0NoYXJsZXMgQmFiYmFnZScsICdKb2huIEhvYmhvdXNlJywgJ1dpbGxpYW0gS2luZycsICdNYXJ5IFNvbWVydmlsbGUnXSwKICAgICAgWydXaWxsaWFtIEtpbmcnLCAnTWFyeSBTb21lcnZpbGxlJywgJ0FkYSBMb3ZlbGFjZScsICdHZW9yZ2UgUGVhY29jayddCiAgICApOwogIAogICAgZ3JvdXBzLmZyaWVuZHNJbkNvbW1vbjsgLy8gWydXaWxsaWFtIEtpbmcnLCAnTWFyeSBTb21lcnZpbGxlJ10KICAgIGBgYAogIAogICAgQ2xhc3NpYyBDbGFzcyBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgaW50ZXJzZWN0IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBsZXQgRnJpZW5kR3JvdXBzID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgZnJpZW5kc0luQ29tbW9uOiBpbnRlcnNlY3QoJ2FkYUZyaWVuZHMnLCAnY2hhcmxlc0ZyaWVuZHMnKQogICAgfSk7CiAgCiAgICBsZXQgZ3JvdXBzID0gRnJpZW5kR3JvdXBzLmNyZWF0ZSh7CiAgICAgIGFkYUZyaWVuZHM6IFsnQ2hhcmxlcyBCYWJiYWdlJywgJ0pvaG4gSG9iaG91c2UnLCAnV2lsbGlhbSBLaW5nJywgJ01hcnkgU29tZXJ2aWxsZSddLAogICAgICBjaGFybGVzRnJpZW5kczogWydXaWxsaWFtIEtpbmcnLCAnTWFyeSBTb21lcnZpbGxlJywgJ0FkYSBMb3ZlbGFjZScsICdHZW9yZ2UgUGVhY29jayddCiAgICB9KTsKICAKICAgIGdyb3Vwcy5mcmllbmRzSW5Db21tb247IC8vIFsnV2lsbGlhbSBLaW5nJywgJ01hcnkgU29tZXJ2aWxsZSddCiAgICBgYGAKICAKICAgIEBtZXRob2QgaW50ZXJzZWN0CiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eUtleSoKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVzIGEgbmV3IGFycmF5IHdpdGggYWxsIHRoZSBkdXBsaWNhdGVkCiAgICBlbGVtZW50cyBmcm9tIHRoZSBkZXBlbmRlbnQgYXJyYXlzCiAgICBAcHVibGljCiAgKi8KCiAgX2V4cG9ydHMudW5pb24gPSB1bmlvbjsKCiAgZnVuY3Rpb24gaW50ZXJzZWN0KCkgewogICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yKSwgX2tleTIgPSAwOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgIGFyZ3NbX2tleTJdID0gYXJndW1lbnRzW19rZXkyXTsKICAgIH0KCiAgICAoZmFsc2UgJiYgISghKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgYXR0ZW1wdGVkIHRvIHVzZSBAaW50ZXJzZWN0IGFzIGEgZGVjb3JhdG9yIGRpcmVjdGx5LCBidXQgaXQgcmVxdWlyZXMgYXRsZWFzdCBvbmUgZGVwZW5kZW50IGtleSBwYXJhbWV0ZXInLCAhKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkpOwogICAgcmV0dXJuIG11bHRpQXJyYXlNYWNybyhhcmdzLCBmdW5jdGlvbiAoZGVwZW5kZW50S2V5cykgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIHZhciBhcnJheXMgPSBkZXBlbmRlbnRLZXlzLm1hcChmdW5jdGlvbiAoZGVwZW5kZW50S2V5KSB7CiAgICAgICAgdmFyIGFycmF5ID0gKDAsIF9tZXRhbC5nZXQpKF90aGlzMiwgZGVwZW5kZW50S2V5KTsKICAgICAgICByZXR1cm4gKDAsIF9ydW50aW1lLmlzQXJyYXkpKGFycmF5KSA/IGFycmF5IDogW107CiAgICAgIH0pOwogICAgICB2YXIgcmVzdWx0cyA9IGFycmF5cy5wb3AoKS5maWx0ZXIoZnVuY3Rpb24gKGNhbmRpZGF0ZSkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgZm91bmQgPSBmYWxzZTsKICAgICAgICAgIHZhciBhcnJheSA9IGFycmF5c1tpXTsKCiAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGFycmF5Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIGlmIChhcnJheVtqXSA9PT0gY2FuZGlkYXRlKSB7CiAgICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGZvdW5kID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSk7CiAgICAgIHJldHVybiAoMCwgX3J1bnRpbWUuQSkocmVzdWx0cyk7CiAgICB9LCAnaW50ZXJzZWN0Jyk7CiAgfQogIC8qKgogICAgQSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCByZXR1cm5zIGEgbmV3IGFycmF5IHdpdGggYWxsIHRoZSBwcm9wZXJ0aWVzIGZyb20gdGhlCiAgICBmaXJzdCBkZXBlbmRlbnQgYXJyYXkgdGhhdCBhcmUgbm90IGluIHRoZSBzZWNvbmQgZGVwZW5kZW50IGFycmF5LgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgc2V0RGlmZiB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgSGFtc3RlciB7CiAgICAgIGNvbnN0cnVjdG9yKGxpa2VzLCBmcnVpdHMpIHsKICAgICAgICBzZXQodGhpcywgJ2xpa2VzJywgbGlrZXMpOwogICAgICAgIHNldCh0aGlzLCAnZnJ1aXRzJywgZnJ1aXRzKTsKICAgICAgfQogIAogICAgICBAc2V0RGlmZignbGlrZXMnLCAnZnJ1aXRzJykgd2FudHM7CiAgICB9CiAgCiAgICBsZXQgaGFtc3RlciA9IG5ldyBIYW1zdGVyKAogICAgICBbCiAgICAgICAgJ2JhbmFuYScsCiAgICAgICAgJ2dyYXBlJywKICAgICAgICAna2FsZScKICAgICAgXSwKICAgICAgWwogICAgICAgICdncmFwZScsCiAgICAgICAgJ2thbGUnLAogICAgICBdCiAgICApOwogIAogICAgaGFtc3Rlci53YW50czsgLy8gWydiYW5hbmEnXQogICAgYGBgCiAgCiAgICBDbGFzc2ljIENsYXNzIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBzZXREaWZmIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBsZXQgSGFtc3RlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIHdhbnRzOiBzZXREaWZmKCdsaWtlcycsICdmcnVpdHMnKQogICAgfSk7CiAgCiAgICBsZXQgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKHsKICAgICAgbGlrZXM6IFsKICAgICAgICAnYmFuYW5hJywKICAgICAgICAnZ3JhcGUnLAogICAgICAgICdrYWxlJwogICAgICBdLAogICAgICBmcnVpdHM6IFsKICAgICAgICAnZ3JhcGUnLAogICAgICAgICdrYWxlJywKICAgICAgXQogICAgfSk7CiAgCiAgICBoYW1zdGVyLndhbnRzOyAvLyBbJ2JhbmFuYSddCiAgICBgYGAKICAKICAgIEBtZXRob2Qgc2V0RGlmZgogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gc2V0QVByb3BlcnR5CiAgICBAcGFyYW0ge1N0cmluZ30gc2V0QlByb3BlcnR5CiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlcyBhIG5ldyBhcnJheSB3aXRoIGFsbCB0aGUgaXRlbXMgZnJvbSB0aGUKICAgIGZpcnN0IGRlcGVuZGVudCBhcnJheSB0aGF0IGFyZSBub3QgaW4gdGhlIHNlY29uZCBkZXBlbmRlbnQgYXJyYXkKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gc2V0RGlmZihzZXRBUHJvcGVydHksIHNldEJQcm9wZXJ0eSkgewogICAgKGZhbHNlICYmICEoISgwLCBfbWV0YWwuaXNFbGVtZW50RGVzY3JpcHRvcikoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGF0dGVtcHRlZCB0byB1c2UgQHNldERpZmYgYXMgYSBkZWNvcmF0b3IgZGlyZWN0bHksIGJ1dCBpdCByZXF1aXJlcyBhdGxlYXN0IG9uZSBkZXBlbmRlbnQga2V5IHBhcmFtZXRlcicsICEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKSk7CiAgICAoZmFsc2UgJiYgIShhcmd1bWVudHMubGVuZ3RoID09PSAyKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2Bjb21wdXRlZC5zZXREaWZmYCByZXF1aXJlcyBleGFjdGx5IHR3byBkZXBlbmRlbnQgYXJyYXlzLicsIGFyZ3VtZW50cy5sZW5ndGggPT09IDIpKTsKICAgIChmYWxzZSAmJiAhKCEvW1xbXF1ce1x9XS9nLnRlc3Qoc2V0QVByb3BlcnR5KSAmJiAhL1tcW1xdXHtcfV0vZy50ZXN0KHNldEJQcm9wZXJ0eSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiRGVwZW5kZW50IGtleXMgcGFzc2VkIHRvIGBjb21wdXRlZC5zZXREaWZmYCBzaG91bGRuJ3QgY29udGFpbiBicmFjZSBleHBhbmRpbmcgcGF0dGVybi4iLCAhL1tcW1xdXHtcfV0vZy50ZXN0KHNldEFQcm9wZXJ0eSkgJiYgIS9bXFtcXVx7XH1dL2cudGVzdChzZXRCUHJvcGVydHkpKSk7CiAgICByZXR1cm4gKDAsIF9tZXRhbC5jb21wdXRlZCkoc2V0QVByb3BlcnR5ICsgIi5bXSIsIHNldEJQcm9wZXJ0eSArICIuW10iLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBzZXRBID0gdGhpcy5nZXQoc2V0QVByb3BlcnR5KTsKICAgICAgdmFyIHNldEIgPSB0aGlzLmdldChzZXRCUHJvcGVydHkpOwoKICAgICAgaWYgKCEoMCwgX3J1bnRpbWUuaXNBcnJheSkoc2V0QSkpIHsKICAgICAgICByZXR1cm4gKDAsIF9ydW50aW1lLkEpKCk7CiAgICAgIH0KCiAgICAgIGlmICghKDAsIF9ydW50aW1lLmlzQXJyYXkpKHNldEIpKSB7CiAgICAgICAgcmV0dXJuICgwLCBfcnVudGltZS5BKShzZXRBKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHNldEEuZmlsdGVyKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgcmV0dXJuIHNldEIuaW5kZXhPZih4KSA9PT0gLTE7CiAgICAgIH0pOwogICAgfSkucmVhZE9ubHkoKTsKICB9CiAgLyoqCiAgICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgcmV0dXJucyB0aGUgYXJyYXkgb2YgdmFsdWVzIGZvciB0aGUgcHJvdmlkZWQKICAgIGRlcGVuZGVudCBwcm9wZXJ0aWVzLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgY29sbGVjdCB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgSGFtc3RlciB7CiAgICAgIEBjb2xsZWN0KCdoYXQnLCAnc2hpcnQnKSBjbG90aGVzOwogICAgfQogIAogICAgbGV0IGhhbXN0ZXIgPSBuZXcgSGFtc3RlcigpOwogIAogICAgaGFtc3Rlci5jbG90aGVzOyAvLyBbbnVsbCwgbnVsbF0KICAKICAgIHNldChoYW1zdGVyLCAnaGF0JywgJ0NhbXAgSGF0Jyk7CiAgICBzZXQoaGFtc3RlciwgJ3NoaXJ0JywgJ0NhbXAgU2hpcnQnKTsKICAgIGhhbXN0ZXIuY2xvdGhlczsgLy8gWydDYW1wIEhhdCcsICdDYW1wIFNoaXJ0J10KICAgIGBgYAogIAogICAgQ2xhc3NpYyBDbGFzcyBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgY29sbGVjdCB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgbGV0IEhhbXN0ZXIgPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICBjbG90aGVzOiBjb2xsZWN0KCdoYXQnLCAnc2hpcnQnKQogICAgfSk7CiAgCiAgICBsZXQgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKCk7CiAgCiAgICBoYW1zdGVyLmNsb3RoZXM7IC8vIFtudWxsLCBudWxsXQogIAogICAgc2V0KGhhbXN0ZXIsICdoYXQnLCAnQ2FtcCBIYXQnKTsKICAgIHNldChoYW1zdGVyLCAnc2hpcnQnLCAnQ2FtcCBTaGlydCcpOwogICAgaGFtc3Rlci5jbG90aGVzOyAvLyBbJ0NhbXAgSGF0JywgJ0NhbXAgU2hpcnQnXQogICAgYGBgCiAgCiAgICBAbWV0aG9kIGNvbGxlY3QKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleSoKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIG1hcHMgdmFsdWVzIG9mIGFsbCBwYXNzZWQKICAgIGluIHByb3BlcnRpZXMgdG8gYW4gYXJyYXkuCiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIGNvbGxlY3QoKSB7CiAgICBmb3IgKHZhciBfbGVuMyA9IGFyZ3VtZW50cy5sZW5ndGgsIGRlcGVuZGVudEtleXMgPSBuZXcgQXJyYXkoX2xlbjMpLCBfa2V5MyA9IDA7IF9rZXkzIDwgX2xlbjM7IF9rZXkzKyspIHsKICAgICAgZGVwZW5kZW50S2V5c1tfa2V5M10gPSBhcmd1bWVudHNbX2tleTNdOwogICAgfQoKICAgIChmYWxzZSAmJiAhKCEoMCwgX21ldGFsLmlzRWxlbWVudERlc2NyaXB0b3IpKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBhdHRlbXB0ZWQgdG8gdXNlIEBjb2xsZWN0IGFzIGEgZGVjb3JhdG9yIGRpcmVjdGx5LCBidXQgaXQgcmVxdWlyZXMgYXRsZWFzdCBvbmUgZGVwZW5kZW50IGtleSBwYXJhbWV0ZXInLCAhKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkpOwogICAgcmV0dXJuIG11bHRpQXJyYXlNYWNybyhkZXBlbmRlbnRLZXlzLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgdmFyIHJlcyA9IGRlcGVuZGVudEtleXMubWFwKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIgdmFsID0gKDAsIF9tZXRhbC5nZXQpKF90aGlzMywga2V5KTsKICAgICAgICByZXR1cm4gdmFsID09PSB1bmRlZmluZWQgPyBudWxsIDogdmFsOwogICAgICB9KTsKICAgICAgcmV0dXJuICgwLCBfcnVudGltZS5BKShyZXMpOwogICAgfSwgJ2NvbGxlY3QnKTsKICB9CiAgLyoqCiAgICBBIGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIHJldHVybnMgYSBuZXcgYXJyYXkgd2l0aCBhbGwgdGhlIHByb3BlcnRpZXMgZnJvbSB0aGUKICAgIGZpcnN0IGRlcGVuZGVudCBhcnJheSBzb3J0ZWQgYmFzZWQgb24gYSBwcm9wZXJ0eSBvciBzb3J0IGZ1bmN0aW9uLiBUaGUgc29ydAogICAgbWFjcm8gY2FuIGJlIHVzZWQgaW4gdHdvIGRpZmZlcmVudCB3YXlzOgogIAogICAgMS4gQnkgcHJvdmlkaW5nIGEgc29ydCBjYWxsYmFjayBmdW5jdGlvbgogICAgMi4gQnkgcHJvdmlkaW5nIGFuIGFycmF5IG9mIGtleXMgdG8gc29ydCB0aGUgYXJyYXkKICAKICAgIEluIHRoZSBmaXJzdCBmb3JtLCB0aGUgY2FsbGJhY2sgbWV0aG9kIHlvdSBwcm92aWRlIHNob3VsZCBoYXZlIHRoZSBmb2xsb3dpbmcKICAgIHNpZ25hdHVyZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGZ1bmN0aW9uIHNvcnRDYWxsYmFjayhpdGVtQSwgaXRlbUIpOwogICAgYGBgCiAgCiAgICAtIGBpdGVtQWAgdGhlIGZpcnN0IGl0ZW0gdG8gY29tcGFyZS4KICAgIC0gYGl0ZW1CYCB0aGUgc2Vjb25kIGl0ZW0gdG8gY29tcGFyZS4KICAKICAgIFRoaXMgZnVuY3Rpb24gc2hvdWxkIHJldHVybiBuZWdhdGl2ZSBudW1iZXIgKGUuZy4gYC0xYCkgd2hlbiBgaXRlbUFgIHNob3VsZAogICAgY29tZSBiZWZvcmUgYGl0ZW1CYC4gSXQgc2hvdWxkIHJldHVybiBwb3NpdGl2ZSBudW1iZXIgKGUuZy4gYDFgKSB3aGVuIGBpdGVtQWAKICAgIHNob3VsZCBjb21lIGFmdGVyIGBpdGVtQmAuIElmIHRoZSBgaXRlbUFgIGFuZCBgaXRlbUJgIGFyZSBlcXVhbCB0aGlzIGZ1bmN0aW9uCiAgICBzaG91bGQgcmV0dXJuIGAwYC4KICAKICAgIFRoZXJlZm9yZSwgaWYgdGhpcyBmdW5jdGlvbiBpcyBjb21wYXJpbmcgc29tZSBudW1lcmljIHZhbHVlcywgc2ltcGxlIGBpdGVtQSAtCiAgICBpdGVtQmAgb3IgYGl0ZW1BLmdldCggJ2ZvbycgKSAtIGl0ZW1CLmdldCggJ2ZvbycgKWAgY2FuIGJlIHVzZWQgaW5zdGVhZCBvZgogICAgc2VyaWVzIG9mIGBpZmAuCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgc2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBzb3J0IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBjbGFzcyBUb0RvTGlzdCB7CiAgICAgIGNvbnN0cnVjdG9yKHRvZG9zKSB7CiAgICAgICAgc2V0KHRoaXMsICd0b2RvcycsIHRvZG9zKTsKICAgICAgfQogIAogICAgICAvLyB1c2luZyBhIGN1c3RvbSBzb3J0IGZ1bmN0aW9uCiAgICAgIEBzb3J0KCd0b2RvcycsIGZ1bmN0aW9uKGEsIGIpewogICAgICAgIGlmIChhLnByaW9yaXR5ID4gYi5wcmlvcml0eSkgewogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfSBlbHNlIGlmIChhLnByaW9yaXR5IDwgYi5wcmlvcml0eSkgewogICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0KICAKICAgICAgICByZXR1cm4gMDsKICAgICAgfSkKICAgICAgcHJpb3JpdHlUb2RvczsKICAgIH0KICAKICAgIGxldCB0b2RvTGlzdCA9IG5ldyBUb0RvTGlzdChbCiAgICAgIHsgbmFtZTogJ1VuaXQgVGVzdCcsIHByaW9yaXR5OiAyIH0sCiAgICAgIHsgbmFtZTogJ0RvY3VtZW50YXRpb24nLCBwcmlvcml0eTogMyB9LAogICAgICB7IG5hbWU6ICdSZWxlYXNlJywgcHJpb3JpdHk6IDEgfQogICAgXSk7CiAgCiAgICB0b2RvTGlzdC5wcmlvcml0eVRvZG9zOyAvLyBbeyBuYW1lOidSZWxlYXNlJywgcHJpb3JpdHk6MSB9LCB7IG5hbWU6J1VuaXQgVGVzdCcsIHByaW9yaXR5OjIgfSwgeyBuYW1lOidEb2N1bWVudGF0aW9uJywgcHJpb3JpdHk6MyB9XQogICAgYGBgCiAgCiAgICBDbGFzc2ljIENsYXNzIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBzb3J0IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgCiAgICBsZXQgVG9Eb0xpc3QgPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICAvLyB1c2luZyBhIGN1c3RvbSBzb3J0IGZ1bmN0aW9uCiAgICAgIHByaW9yaXR5VG9kb3M6IHNvcnQoJ3RvZG9zJywgZnVuY3Rpb24oYSwgYil7CiAgICAgICAgaWYgKGEucHJpb3JpdHkgPiBiLnByaW9yaXR5KSB7CiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9IGVsc2UgaWYgKGEucHJpb3JpdHkgPCBiLnByaW9yaXR5KSB7CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogIAogICAgICAgIHJldHVybiAwOwogICAgICB9KQogICAgfSk7CiAgCiAgICBsZXQgdG9kb0xpc3QgPSBUb0RvTGlzdC5jcmVhdGUoewogICAgICB0b2RvczogWwogICAgICAgIHsgbmFtZTogJ1VuaXQgVGVzdCcsIHByaW9yaXR5OiAyIH0sCiAgICAgICAgeyBuYW1lOiAnRG9jdW1lbnRhdGlvbicsIHByaW9yaXR5OiAzIH0sCiAgICAgICAgeyBuYW1lOiAnUmVsZWFzZScsIHByaW9yaXR5OiAxIH0KICAgICAgXQogICAgfSk7CiAgCiAgICB0b2RvTGlzdC5wcmlvcml0eVRvZG9zOyAvLyBbeyBuYW1lOidSZWxlYXNlJywgcHJpb3JpdHk6MSB9LCB7IG5hbWU6J1VuaXQgVGVzdCcsIHByaW9yaXR5OjIgfSwgeyBuYW1lOidEb2N1bWVudGF0aW9uJywgcHJpb3JpdHk6MyB9XQogICAgYGBgCiAgCiAgICBZb3UgY2FuIGFsc28gb3B0aW9uYWxseSBwYXNzIGFuIGFycmF5IG9mIGFkZGl0aW9uYWwgZGVwZW5kZW50IGtleXMgYXMgdGhlCiAgICBzZWNvbmQgcGFyYW1ldGVyLCBpZiB5b3VyIHNvcnQgZnVuY3Rpb24gaXMgZGVwZW5kZW50IG9uIGFkZGl0aW9uYWwgdmFsdWVzIHRoYXQKICAgIGNvdWxkIGNoYW5nZXM6CiAgCiAgICBgYGBqcwogICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgc29ydCB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgVG9Eb0xpc3QgewogICAgICBzb3J0S2V5ID0gJ3ByaW9yaXR5JzsKICAKICAgICAgY29uc3RydWN0b3IodG9kb3MpIHsKICAgICAgICBzZXQodGhpcywgJ3RvZG9zJywgdG9kb3MpOwogICAgICB9CiAgCiAgICAgIC8vIHVzaW5nIGEgY3VzdG9tIHNvcnQgZnVuY3Rpb24KICAgICAgQHNvcnQoJ3RvZG9zJywgWydzb3J0S2V5J10sIGZ1bmN0aW9uKGEsIGIpewogICAgICAgIGlmIChhW3RoaXMuc29ydEtleV0gPiBiW3RoaXMuc29ydEtleV0pIHsKICAgICAgICAgIHJldHVybiAxOwogICAgICAgIH0gZWxzZSBpZiAoYVt0aGlzLnNvcnRLZXldIDwgYlt0aGlzLnNvcnRLZXldKSB7CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogIAogICAgICAgIHJldHVybiAwOwogICAgICB9KQogICAgICBzb3J0ZWRUb2RvczsKICAgIH0pOwogIAogICAgbGV0IHRvZG9MaXN0ID0gbmV3IFRvRG9MaXN0KFsKICAgICAgeyBuYW1lOiAnVW5pdCBUZXN0JywgcHJpb3JpdHk6IDIgfSwKICAgICAgeyBuYW1lOiAnRG9jdW1lbnRhdGlvbicsIHByaW9yaXR5OiAzIH0sCiAgICAgIHsgbmFtZTogJ1JlbGVhc2UnLCBwcmlvcml0eTogMSB9CiAgICBdKTsKICAKICAgIHRvZG9MaXN0LnByaW9yaXR5VG9kb3M7IC8vIFt7IG5hbWU6J1JlbGVhc2UnLCBwcmlvcml0eToxIH0sIHsgbmFtZTonVW5pdCBUZXN0JywgcHJpb3JpdHk6MiB9LCB7IG5hbWU6J0RvY3VtZW50YXRpb24nLCBwcmlvcml0eTozIH1dCiAgICBgYGAKICAKICAgIEluIHRoZSBzZWNvbmQgZm9ybSwgeW91IHNob3VsZCBwcm92aWRlIHRoZSBrZXkgb2YgdGhlIGFycmF5IG9mIHNvcnQgdmFsdWVzIGFzCiAgICB0aGUgc2Vjb25kIHBhcmFtZXRlcjoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHNldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgc29ydCB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogIAogICAgY2xhc3MgVG9Eb0xpc3QgewogICAgICBjb25zdHJ1Y3Rvcih0b2RvcykgewogICAgICAgIHNldCh0aGlzLCAndG9kb3MnLCB0b2Rvcyk7CiAgICAgIH0KICAKICAgICAgLy8gdXNpbmcgc3RhbmRhcmQgYXNjZW5kaW5nIHNvcnQKICAgICAgdG9kb3NTb3J0aW5nID0gWyduYW1lJ107CiAgICAgIEBzb3J0KCd0b2RvcycsICd0b2Rvc1NvcnRpbmcnKSBzb3J0ZWRUb2RvczsKICAKICAgICAgLy8gdXNpbmcgZGVzY2VuZGluZyBzb3J0CiAgICAgIHRvZG9zU29ydGluZ0Rlc2MgPSBbJ25hbWU6ZGVzYyddOwogICAgICBAc29ydCgndG9kb3MnLCAndG9kb3NTb3J0aW5nRGVzYycpIHNvcnRlZFRvZG9zRGVzYzsKICAgIH0KICAKICAgIGxldCB0b2RvTGlzdCA9IG5ldyBUb0RvTGlzdChbCiAgICAgIHsgbmFtZTogJ1VuaXQgVGVzdCcsIHByaW9yaXR5OiAyIH0sCiAgICAgIHsgbmFtZTogJ0RvY3VtZW50YXRpb24nLCBwcmlvcml0eTogMyB9LAogICAgICB7IG5hbWU6ICdSZWxlYXNlJywgcHJpb3JpdHk6IDEgfQogICAgXSk7CiAgCiAgICB0b2RvTGlzdC5zb3J0ZWRUb2RvczsgLy8gW3sgbmFtZTonRG9jdW1lbnRhdGlvbicsIHByaW9yaXR5OjMgfSwgeyBuYW1lOidSZWxlYXNlJywgcHJpb3JpdHk6MSB9LCB7IG5hbWU6J1VuaXQgVGVzdCcsIHByaW9yaXR5OjIgfV0KICAgIHRvZG9MaXN0LnNvcnRlZFRvZG9zRGVzYzsgLy8gW3sgbmFtZTonVW5pdCBUZXN0JywgcHJpb3JpdHk6MiB9LCB7IG5hbWU6J1JlbGVhc2UnLCBwcmlvcml0eToxIH0sIHsgbmFtZTonRG9jdW1lbnRhdGlvbicsIHByaW9yaXR5OjMgfV0KICAgIGBgYAogIAogICAgQG1ldGhvZCBzb3J0CiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBpdGVtc0tleQogICAgQHBhcmFtIHtBcnJheX0gW2FkZGl0aW9uYWxEZXBlbmRlbnRLZXlzXSBvcHRpb25hbCBhcnJheSBvZiBhZGRpdGlvbmFsCiAgICBkZXBlbmRlbnQga2V5cwogICAgQHBhcmFtIHtTdHJpbmcgb3IgRnVuY3Rpb259IHNvcnREZWZpbml0aW9uIGEgZGVwZW5kZW50IGtleSB0byBhbiBhcnJheSBvZiBzb3J0CiAgICBwcm9wZXJ0aWVzIChhZGQgYDpkZXNjYCB0byB0aGUgYXJyYXlzIHNvcnQgcHJvcGVydGllcyB0byBzb3J0IGRlc2NlbmRpbmcpIG9yIGEKICAgIGZ1bmN0aW9uIHRvIHVzZSB3aGVuIHNvcnRpbmcKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVzIGEgbmV3IHNvcnRlZCBhcnJheSBiYXNlZCBvbiB0aGUgc29ydAogICAgcHJvcGVydHkgYXJyYXkgb3IgY2FsbGJhY2sgZnVuY3Rpb24KICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gc29ydChpdGVtc0tleSwgYWRkaXRpb25hbERlcGVuZGVudEtleXMsIHNvcnREZWZpbml0aW9uKSB7CiAgICAoZmFsc2UgJiYgISghKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgYXR0ZW1wdGVkIHRvIHVzZSBAc29ydCBhcyBhIGRlY29yYXRvciBkaXJlY3RseSwgYnV0IGl0IHJlcXVpcmVzIGF0bGVhc3QgYW4gYGl0ZW1zS2V5YCBwYXJhbWV0ZXInLCAhKDAsIF9tZXRhbC5pc0VsZW1lbnREZXNjcmlwdG9yKShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSkpOwoKICAgIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICkgewogICAgICB2YXIgYXJndW1lbnRzVmFsaWQgPSBmYWxzZTsKCiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICAgICAgYXJndW1lbnRzVmFsaWQgPSB0eXBlb2YgaXRlbXNLZXkgPT09ICdzdHJpbmcnICYmICh0eXBlb2YgYWRkaXRpb25hbERlcGVuZGVudEtleXMgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiBhZGRpdGlvbmFsRGVwZW5kZW50S2V5cyA9PT0gJ2Z1bmN0aW9uJyk7CiAgICAgIH0KCiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAzKSB7CiAgICAgICAgYXJndW1lbnRzVmFsaWQgPSB0eXBlb2YgaXRlbXNLZXkgPT09ICdzdHJpbmcnICYmIEFycmF5LmlzQXJyYXkoYWRkaXRpb25hbERlcGVuZGVudEtleXMpICYmIHR5cGVvZiBzb3J0RGVmaW5pdGlvbiA9PT0gJ2Z1bmN0aW9uJzsKICAgICAgfQoKICAgICAgKGZhbHNlICYmICEoYXJndW1lbnRzVmFsaWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnYGNvbXB1dGVkLnNvcnRgIGNhbiBlaXRoZXIgYmUgdXNlZCB3aXRoIGFuIGFycmF5IG9mIHNvcnQgcHJvcGVydGllcyBvciB3aXRoIGEgc29ydCBmdW5jdGlvbi4gSWYgdXNlZCB3aXRoIGFuIGFycmF5IG9mIHNvcnQgcHJvcGVydGllcywgaXQgbXVzdCByZWNlaXZlIGV4YWN0bHkgdHdvIGFyZ3VtZW50czogdGhlIGtleSBvZiB0aGUgYXJyYXkgdG8gc29ydCwgYW5kIHRoZSBrZXkgb2YgdGhlIGFycmF5IG9mIHNvcnQgcHJvcGVydGllcy4gSWYgdXNlZCB3aXRoIGEgc29ydCBmdW5jdGlvbiwgaXQgbWF5IHJlY2lldmUgdXAgdG8gdGhyZWUgYXJndW1lbnRzOiB0aGUga2V5IG9mIHRoZSBhcnJheSB0byBzb3J0LCBhbiBvcHRpb25hbCBhZGRpdGlvbmFsIGFycmF5IG9mIGRlcGVuZGVudCBrZXlzIGZvciB0aGUgY29tcHV0ZWQgcHJvcGVydHksIGFuZCB0aGUgc29ydCBmdW5jdGlvbi4nLCBhcmd1bWVudHNWYWxpZCkpOwogICAgfQoKICAgIGlmIChzb3J0RGVmaW5pdGlvbiA9PT0gdW5kZWZpbmVkICYmICFBcnJheS5pc0FycmF5KGFkZGl0aW9uYWxEZXBlbmRlbnRLZXlzKSkgewogICAgICBzb3J0RGVmaW5pdGlvbiA9IGFkZGl0aW9uYWxEZXBlbmRlbnRLZXlzOwogICAgICBhZGRpdGlvbmFsRGVwZW5kZW50S2V5cyA9IFtdOwogICAgfQoKICAgIGlmICh0eXBlb2Ygc29ydERlZmluaXRpb24gPT09ICdmdW5jdGlvbicpIHsKICAgICAgcmV0dXJuIGN1c3RvbVNvcnQoaXRlbXNLZXksIGFkZGl0aW9uYWxEZXBlbmRlbnRLZXlzLCBzb3J0RGVmaW5pdGlvbik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gcHJvcGVydHlTb3J0KGl0ZW1zS2V5LCBzb3J0RGVmaW5pdGlvbik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjdXN0b21Tb3J0KGl0ZW1zS2V5LCBhZGRpdGlvbmFsRGVwZW5kZW50S2V5cywgY29tcGFyYXRvcikgewogICAgcmV0dXJuIGFycmF5TWFjcm8oaXRlbXNLZXksIGFkZGl0aW9uYWxEZXBlbmRlbnRLZXlzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgICByZXR1cm4gdmFsdWUuc2xpY2UoKS5zb3J0KGZ1bmN0aW9uICh4LCB5KSB7CiAgICAgICAgcmV0dXJuIGNvbXBhcmF0b3IuY2FsbChfdGhpczQsIHgsIHkpOwogICAgICB9KTsKICAgIH0pOwogIH0gLy8gVGhpcyBvbmUgbmVlZHMgdG8gZHluYW1pY2FsbHkgc2V0IHVwIGFuZCB0ZWFyIGRvd24gb2JzZXJ2ZXJzIG9uIHRoZSBpdGVtc0tleQogIC8vIGRlcGVuZGluZyBvbiB0aGUgc29ydFByb3BlcnRpZXMKCgogIGZ1bmN0aW9uIHByb3BlcnR5U29ydChpdGVtc0tleSwgc29ydFByb3BlcnRpZXNLZXkpIHsKICAgIHZhciBhY3RpdmVPYnNlcnZlcnNNYXAgPSBuZXcgV2Vha01hcCgpOwogICAgdmFyIHNvcnRQcm9wZXJ0eURpZENoYW5nZU1hcCA9IG5ldyBXZWFrTWFwKCk7CgogICAgaWYgKHRydWUKICAgIC8qIEVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyAqLwogICAgKSB7CiAgICAgICAgdmFyIGNwID0gKDAsIF9tZXRhbC5jb21wdXRlZCkoaXRlbXNLZXkgKyAiLltdIiwgc29ydFByb3BlcnRpZXNLZXkgKyAiLltdIiwgZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgdmFyIHNvcnRQcm9wZXJ0aWVzID0gKDAsIF9tZXRhbC5nZXQpKHRoaXMsIHNvcnRQcm9wZXJ0aWVzS2V5KTsKICAgICAgICAgIChmYWxzZSAmJiAhKCgwLCBfcnVudGltZS5pc0FycmF5KShzb3J0UHJvcGVydGllcykgJiYgc29ydFByb3BlcnRpZXMuZXZlcnkoZnVuY3Rpb24gKHMpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBzID09PSAnc3RyaW5nJzsKICAgICAgICAgIH0pKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIlRoZSBzb3J0IGRlZmluaXRpb24gZm9yICciICsga2V5ICsgIicgb24gIiArIHRoaXMgKyAiIG11c3QgYmUgYSBmdW5jdGlvbiBvciBhbiBhcnJheSBvZiBzdHJpbmdzIiwgKDAsIF9ydW50aW1lLmlzQXJyYXkpKHNvcnRQcm9wZXJ0aWVzKSAmJiBzb3J0UHJvcGVydGllcy5ldmVyeShmdW5jdGlvbiAocykgewogICAgICAgICAgICByZXR1cm4gdHlwZW9mIHMgPT09ICdzdHJpbmcnOwogICAgICAgICAgfSkpKTsKICAgICAgICAgIHZhciBpdGVtc0tleUlzQXRUaGlzID0gaXRlbXNLZXkgPT09ICdAdGhpcyc7CiAgICAgICAgICB2YXIgbm9ybWFsaXplZFNvcnRQcm9wZXJ0aWVzID0gbm9ybWFsaXplU29ydFByb3BlcnRpZXMoc29ydFByb3BlcnRpZXMpOwogICAgICAgICAgdmFyIGl0ZW1zID0gaXRlbXNLZXlJc0F0VGhpcyA/IHRoaXMgOiAoMCwgX21ldGFsLmdldCkodGhpcywgaXRlbXNLZXkpOwoKICAgICAgICAgIGlmICghKDAsIF9ydW50aW1lLmlzQXJyYXkpKGl0ZW1zKSkgewogICAgICAgICAgICByZXR1cm4gKDAsIF9ydW50aW1lLkEpKCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKG5vcm1hbGl6ZWRTb3J0UHJvcGVydGllcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuICgwLCBfcnVudGltZS5BKShpdGVtcy5zbGljZSgpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBzb3J0QnlOb3JtYWxpemVkU29ydFByb3BlcnRpZXMoaXRlbXMsIG5vcm1hbGl6ZWRTb3J0UHJvcGVydGllcyk7CiAgICAgICAgICB9CiAgICAgICAgfSkucmVhZE9ubHkoKTsKICAgICAgICAoMCwgX21ldGFsLmRlc2NyaXB0b3JGb3JEZWNvcmF0b3IpKGNwKS5hdXRvKCk7CiAgICAgICAgcmV0dXJuIGNwOwogICAgICB9IGVsc2UgewogICAgICByZXR1cm4gKDAsIF9tZXRhbC5jb21wdXRlZCkoc29ydFByb3BlcnRpZXNLZXkgKyAiLltdIiwgZnVuY3Rpb24gKGtleSkgewogICAgICAgIHZhciBfdGhpczUgPSB0aGlzOwoKICAgICAgICB2YXIgc29ydFByb3BlcnRpZXMgPSAoMCwgX21ldGFsLmdldCkodGhpcywgc29ydFByb3BlcnRpZXNLZXkpOwogICAgICAgIChmYWxzZSAmJiAhKCgwLCBfcnVudGltZS5pc0FycmF5KShzb3J0UHJvcGVydGllcykgJiYgc29ydFByb3BlcnRpZXMuZXZlcnkoZnVuY3Rpb24gKHMpIHsKICAgICAgICAgIHJldHVybiB0eXBlb2YgcyA9PT0gJ3N0cmluZyc7CiAgICAgICAgfSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiVGhlIHNvcnQgZGVmaW5pdGlvbiBmb3IgJyIgKyBrZXkgKyAiJyBvbiAiICsgdGhpcyArICIgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN0cmluZ3MiLCAoMCwgX3J1bnRpbWUuaXNBcnJheSkoc29ydFByb3BlcnRpZXMpICYmIHNvcnRQcm9wZXJ0aWVzLmV2ZXJ5KGZ1bmN0aW9uIChzKSB7CiAgICAgICAgICByZXR1cm4gdHlwZW9mIHMgPT09ICdzdHJpbmcnOwogICAgICAgIH0pKSk7IC8vIEFkZC9yZW1vdmUgcHJvcGVydHkgb2JzZXJ2ZXJzIGFzIHJlcXVpcmVkLgoKICAgICAgICB2YXIgYWN0aXZlT2JzZXJ2ZXJzID0gYWN0aXZlT2JzZXJ2ZXJzTWFwLmdldCh0aGlzKTsKCiAgICAgICAgaWYgKCFzb3J0UHJvcGVydHlEaWRDaGFuZ2VNYXAuaGFzKHRoaXMpKSB7CiAgICAgICAgICBzb3J0UHJvcGVydHlEaWRDaGFuZ2VNYXAuc2V0KHRoaXMsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgKDAsIF9tZXRhbC5ub3RpZnlQcm9wZXJ0eUNoYW5nZSkodGhpcywga2V5KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdmFyIHNvcnRQcm9wZXJ0eURpZENoYW5nZSA9IHNvcnRQcm9wZXJ0eURpZENoYW5nZU1hcC5nZXQodGhpcyk7CgogICAgICAgIGlmIChhY3RpdmVPYnNlcnZlcnMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgYWN0aXZlT2JzZXJ2ZXJzLmZvckVhY2goZnVuY3Rpb24gKHBhdGgpIHsKICAgICAgICAgICAgcmV0dXJuICgwLCBfbWV0YWwucmVtb3ZlT2JzZXJ2ZXIpKF90aGlzNSwgcGF0aCwgc29ydFByb3BlcnR5RGlkQ2hhbmdlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdmFyIGl0ZW1zS2V5SXNBdFRoaXMgPSBpdGVtc0tleSA9PT0gJ0B0aGlzJzsKICAgICAgICB2YXIgbm9ybWFsaXplZFNvcnRQcm9wZXJ0aWVzID0gbm9ybWFsaXplU29ydFByb3BlcnRpZXMoc29ydFByb3BlcnRpZXMpOwoKICAgICAgICBpZiAobm9ybWFsaXplZFNvcnRQcm9wZXJ0aWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgdmFyIHBhdGggPSBpdGVtc0tleUlzQXRUaGlzID8gIltdIiA6IGl0ZW1zS2V5ICsgIi5bXSI7CiAgICAgICAgICAoMCwgX21ldGFsLmFkZE9ic2VydmVyKSh0aGlzLCBwYXRoLCBzb3J0UHJvcGVydHlEaWRDaGFuZ2UpOwogICAgICAgICAgYWN0aXZlT2JzZXJ2ZXJzID0gW3BhdGhdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhY3RpdmVPYnNlcnZlcnMgPSBub3JtYWxpemVkU29ydFByb3BlcnRpZXMubWFwKGZ1bmN0aW9uIChfcmVmKSB7CiAgICAgICAgICAgIHZhciBwcm9wID0gX3JlZlswXTsKICAgICAgICAgICAgdmFyIHBhdGggPSBpdGVtc0tleUlzQXRUaGlzID8gIkBlYWNoLiIgKyBwcm9wIDogaXRlbXNLZXkgKyAiLkBlYWNoLiIgKyBwcm9wOwogICAgICAgICAgICAoMCwgX21ldGFsLmFkZE9ic2VydmVyKShfdGhpczUsIHBhdGgsIHNvcnRQcm9wZXJ0eURpZENoYW5nZSk7CiAgICAgICAgICAgIHJldHVybiBwYXRoOwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBhY3RpdmVPYnNlcnZlcnNNYXAuc2V0KHRoaXMsIGFjdGl2ZU9ic2VydmVycyk7CiAgICAgICAgdmFyIGl0ZW1zID0gaXRlbXNLZXlJc0F0VGhpcyA/IHRoaXMgOiAoMCwgX21ldGFsLmdldCkodGhpcywgaXRlbXNLZXkpOwoKICAgICAgICBpZiAoISgwLCBfcnVudGltZS5pc0FycmF5KShpdGVtcykpIHsKICAgICAgICAgIHJldHVybiAoMCwgX3J1bnRpbWUuQSkoKTsKICAgICAgICB9CgogICAgICAgIGlmIChub3JtYWxpemVkU29ydFByb3BlcnRpZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gKDAsIF9ydW50aW1lLkEpKGl0ZW1zLnNsaWNlKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gc29ydEJ5Tm9ybWFsaXplZFNvcnRQcm9wZXJ0aWVzKGl0ZW1zLCBub3JtYWxpemVkU29ydFByb3BlcnRpZXMpOwogICAgICAgIH0KICAgICAgfSkucmVhZE9ubHkoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG5vcm1hbGl6ZVNvcnRQcm9wZXJ0aWVzKHNvcnRQcm9wZXJ0aWVzKSB7CiAgICByZXR1cm4gc29ydFByb3BlcnRpZXMubWFwKGZ1bmN0aW9uIChwKSB7CiAgICAgIHZhciBfcCRzcGxpdCA9IHAuc3BsaXQoJzonKSwKICAgICAgICAgIHByb3AgPSBfcCRzcGxpdFswXSwKICAgICAgICAgIGRpcmVjdGlvbiA9IF9wJHNwbGl0WzFdOwoKICAgICAgZGlyZWN0aW9uID0gZGlyZWN0aW9uIHx8ICdhc2MnOwogICAgICByZXR1cm4gW3Byb3AsIGRpcmVjdGlvbl07CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHNvcnRCeU5vcm1hbGl6ZWRTb3J0UHJvcGVydGllcyhpdGVtcywgbm9ybWFsaXplZFNvcnRQcm9wZXJ0aWVzKSB7CiAgICByZXR1cm4gKDAsIF9ydW50aW1lLkEpKGl0ZW1zLnNsaWNlKCkuc29ydChmdW5jdGlvbiAoaXRlbUEsIGl0ZW1CKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9ybWFsaXplZFNvcnRQcm9wZXJ0aWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIF9ub3JtYWxpemVkU29ydFByb3BlciA9IG5vcm1hbGl6ZWRTb3J0UHJvcGVydGllc1tpXSwKICAgICAgICAgICAgcHJvcCA9IF9ub3JtYWxpemVkU29ydFByb3BlclswXSwKICAgICAgICAgICAgZGlyZWN0aW9uID0gX25vcm1hbGl6ZWRTb3J0UHJvcGVyWzFdOwogICAgICAgIHZhciByZXN1bHQgPSAoMCwgX3J1bnRpbWUuY29tcGFyZSkoKDAsIF9tZXRhbC5nZXQpKGl0ZW1BLCBwcm9wKSwgKDAsIF9tZXRhbC5nZXQpKGl0ZW1CLCBwcm9wKSk7CgogICAgICAgIGlmIChyZXN1bHQgIT09IDApIHsKICAgICAgICAgIHJldHVybiBkaXJlY3Rpb24gPT09ICdkZXNjJyA/IC0xICogcmVzdWx0IDogcmVzdWx0OwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIDA7CiAgICB9KSk7CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvcG9seWZpbGxzL2luZGV4IiwgWyJleHBvcnRzIiwgIkBlbWJlci9kZXByZWNhdGVkLWZlYXR1cmVzIiwgIkBlbWJlci9wb2x5ZmlsbHMvbGliL21lcmdlIiwgIkBlbWJlci9wb2x5ZmlsbHMvbGliL2Fzc2lnbiIsICJAZW1iZXIvcG9seWZpbGxzL2xpYi93ZWFrX3NldCJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9kZXByZWNhdGVkRmVhdHVyZXMsIF9tZXJnZSwgX2Fzc2lnbiwgX3dlYWtfc2V0KSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJhc3NpZ24iLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfYXNzaWduLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiYXNzaWduUG9seWZpbGwiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfYXNzaWduLmFzc2lnbjsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfV2Vha1NldCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF93ZWFrX3NldC5kZWZhdWx0OwogICAgfQogIH0pOwogIF9leHBvcnRzLm1lcmdlID0gdm9pZCAwOwogIHZhciBtZXJnZSA9IF9kZXByZWNhdGVkRmVhdHVyZXMuTUVSR0UgPyBfbWVyZ2UuZGVmYXVsdCA6IHVuZGVmaW5lZDsgLy8gRXhwb3J0IGBhc3NpZ25Qb2x5ZmlsbGAgZm9yIHRlc3RpbmcKCiAgX2V4cG9ydHMubWVyZ2UgPSBtZXJnZTsKfSk7CmRlZmluZSgiQGVtYmVyL3BvbHlmaWxscy9saWIvYXNzaWduIiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuYXNzaWduID0gYXNzaWduOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIC8qKgogICBAbW9kdWxlIEBlbWJlci9wb2x5ZmlsbHMKICAqLwoKICAvKioKICAgIENvcHkgcHJvcGVydGllcyBmcm9tIGEgc291cmNlIG9iamVjdCB0byBhIHRhcmdldCBvYmplY3QuIFNvdXJjZSBhcmd1bWVudHMgcmVtYWluIHVuY2hhbmdlZC4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGFzc2lnbiB9IGZyb20gJ0BlbWJlci9wb2x5ZmlsbHMnOwogIAogICAgdmFyIGEgPSB7IGZpcnN0OiAnWWVodWRhJyB9OwogICAgdmFyIGIgPSB7IGxhc3Q6ICdLYXR6JyB9OwogICAgdmFyIGMgPSB7IGNvbXBhbnk6ICdPdGhlciBDb21wYW55JyB9OwogICAgdmFyIGQgPSB7IGNvbXBhbnk6ICdUaWxkZSBJbmMuJyB9OwogICAgYXNzaWduKGEsIGIsIGMsIGQpOyAvLyBhID09PSB7IGZpcnN0OiAnWWVodWRhJywgbGFzdDogJ0thdHonLCBjb21wYW55OiAnVGlsZGUgSW5jLicgfTsKICAgIGBgYAogIAogICAgQG1ldGhvZCBhc3NpZ24KICAgIEBmb3IgQGVtYmVyL3BvbHlmaWxscwogICAgQHBhcmFtIHtPYmplY3R9IHRhcmdldCBUaGUgb2JqZWN0IHRvIGFzc2lnbiBpbnRvCiAgICBAcGFyYW0ge09iamVjdH0gLi4uYXJncyBUaGUgb2JqZWN0cyB0byBjb3B5IHByb3BlcnRpZXMgZnJvbQogICAgQHJldHVybiB7T2JqZWN0fQogICAgQHB1YmxpYwogICAgQHN0YXRpYwogICovCiAgZnVuY3Rpb24gYXNzaWduKHRhcmdldCkgewogICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGFyZyA9IGFyZ3VtZW50c1tpXTsKCiAgICAgIGlmICghYXJnKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIHZhciB1cGRhdGVzID0gT2JqZWN0LmtleXMoYXJnKTsKCiAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCB1cGRhdGVzLmxlbmd0aDsgX2krKykgewogICAgICAgIHZhciBwcm9wID0gdXBkYXRlc1tfaV07CiAgICAgICAgdGFyZ2V0W3Byb3BdID0gYXJnW3Byb3BdOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRhcmdldDsKICB9IC8vIE5vdGU6IFdlIHVzZSB0aGUgYnJhY2tldCBub3RhdGlvbiBzbwogIC8vICAgICAgIHRoYXQgdGhlIGJhYmVsIHBsdWdpbiBkb2VzIG5vdAogIC8vICAgICAgIHRyYW5zZm9ybSBpdC4KICAvLyBodHRwczovL3d3dy5ucG1qcy5jb20vcGFja2FnZS9iYWJlbC1wbHVnaW4tdHJhbnNmb3JtLW9iamVjdC1hc3NpZ24KCgogIHZhciBfYXNzaWduID0gT2JqZWN0LmFzc2lnbjsKCiAgdmFyIF9kZWZhdWx0ID0gX2Fzc2lnbiB8fCBhc3NpZ247CgogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CmRlZmluZSgiQGVtYmVyL3BvbHlmaWxscy9saWIvbWVyZ2UiLCBbImV4cG9ydHMiLCAiQGVtYmVyL2RlYnVnIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2RlYnVnKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gbWVyZ2U7CgogIC8qKgogICAgTWVyZ2UgdGhlIGNvbnRlbnRzIG9mIHR3byBvYmplY3RzIHRvZ2V0aGVyIGludG8gdGhlIGZpcnN0IG9iamVjdC4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IG1lcmdlIH0gZnJvbSAnQGVtYmVyL3BvbHlmaWxscyc7CiAgCiAgICBtZXJnZSh7IGZpcnN0OiAnVG9tJyB9LCB7IGxhc3Q6ICdEYWxlJyB9KTsgLy8geyBmaXJzdDogJ1RvbScsIGxhc3Q6ICdEYWxlJyB9CiAgICB2YXIgYSA9IHsgZmlyc3Q6ICdZZWh1ZGEnIH07CiAgICB2YXIgYiA9IHsgbGFzdDogJ0thdHonIH07CiAgICBtZXJnZShhLCBiKTsgLy8gYSA9PSB7IGZpcnN0OiAnWWVodWRhJywgbGFzdDogJ0thdHonIH0sIGIgPT0geyBsYXN0OiAnS2F0eicgfQogICAgYGBgCiAgCiAgICBAbWV0aG9kIG1lcmdlCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9wb2x5ZmlsbHMKICAgIEBwYXJhbSB7T2JqZWN0fSBvcmlnaW5hbCBUaGUgb2JqZWN0IHRvIG1lcmdlIGludG8KICAgIEBwYXJhbSB7T2JqZWN0fSB1cGRhdGVzIFRoZSBvYmplY3QgdG8gY29weSBwcm9wZXJ0aWVzIGZyb20KICAgIEByZXR1cm4ge09iamVjdH0KICAgIEBkZXByZWNhdGVkCiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBtZXJnZShvcmlnaW5hbCwgdXBkYXRlcykgewogICAgKGZhbHNlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgnVXNlIG9mIGBtZXJnZWAgaGFzIGJlZW4gZGVwcmVjYXRlZC4gUGxlYXNlIHVzZSBgYXNzaWduYCBpbnN0ZWFkLicsIGZhbHNlLCB7CiAgICAgIGlkOiAnZW1iZXItcG9seWZpbGxzLmRlcHJlY2F0ZS1tZXJnZScsCiAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICB1cmw6ICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92My54LyN0b2NfZW1iZXItcG9seWZpbGxzLWRlcHJlY2F0ZS1tZXJnZScKICAgIH0pKTsKCiAgICBpZiAodXBkYXRlcyA9PT0gbnVsbCB8fCB0eXBlb2YgdXBkYXRlcyAhPT0gJ29iamVjdCcpIHsKICAgICAgcmV0dXJuIG9yaWdpbmFsOwogICAgfQoKICAgIHZhciBwcm9wcyA9IE9iamVjdC5rZXlzKHVwZGF0ZXMpOwogICAgdmFyIHByb3A7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgewogICAgICBwcm9wID0gcHJvcHNbaV07CiAgICAgIG9yaWdpbmFsW3Byb3BdID0gdXBkYXRlc1twcm9wXTsKICAgIH0KCiAgICByZXR1cm4gb3JpZ2luYWw7CiAgfQp9KTsKZGVmaW5lKCJAZW1iZXIvcG9seWZpbGxzL2xpYi93ZWFrX3NldCIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIC8qIGdsb2JhbHMgV2Vha1NldCAqLwogIHZhciBfZGVmYXVsdCA9IHR5cGVvZiBXZWFrU2V0ID09PSAnZnVuY3Rpb24nID8gV2Vha1NldCA6CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFdlYWtTZXRQb2x5RmlsbCgpIHsKICAgICAgdGhpcy5fbWFwID0gbmV3IFdlYWtNYXAoKTsKICAgIH0KCiAgICB2YXIgX3Byb3RvID0gV2Vha1NldFBvbHlGaWxsLnByb3RvdHlwZTsKCiAgICBfcHJvdG8uYWRkID0gZnVuY3Rpb24gYWRkKHZhbCkgewogICAgICB0aGlzLl9tYXAuc2V0KHZhbCwgdHJ1ZSk7CgogICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgX3Byb3RvLmRlbGV0ZSA9IGZ1bmN0aW9uIF9kZWxldGUodmFsKSB7CiAgICAgIHJldHVybiB0aGlzLl9tYXAuZGVsZXRlKHZhbCk7CiAgICB9OwoKICAgIF9wcm90by5oYXMgPSBmdW5jdGlvbiBoYXModmFsKSB7CiAgICAgIHJldHVybiB0aGlzLl9tYXAuaGFzKHZhbCk7CiAgICB9OwoKICAgIHJldHVybiBXZWFrU2V0UG9seUZpbGw7CiAgfSgpOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci9ydW5sb29wL2luZGV4IiwgWyJleHBvcnRzIiwgIkBlbWJlci9kZWJ1ZyIsICJAZW1iZXIvLWludGVybmFscy9lcnJvci1oYW5kbGluZyIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCIsICJiYWNrYnVybmVyIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2RlYnVnLCBfZXJyb3JIYW5kbGluZywgX21ldGFsLCBfYmFja2J1cm5lcikgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZ2V0Q3VycmVudFJ1bkxvb3AgPSBnZXRDdXJyZW50UnVuTG9vcDsKICBfZXhwb3J0cy5ydW4gPSBydW47CiAgX2V4cG9ydHMuam9pbiA9IGpvaW47CiAgX2V4cG9ydHMuYmVnaW4gPSBiZWdpbjsKICBfZXhwb3J0cy5lbmQgPSBlbmQ7CiAgX2V4cG9ydHMuc2NoZWR1bGUgPSBzY2hlZHVsZTsKICBfZXhwb3J0cy5oYXNTY2hlZHVsZWRUaW1lcnMgPSBoYXNTY2hlZHVsZWRUaW1lcnM7CiAgX2V4cG9ydHMuY2FuY2VsVGltZXJzID0gY2FuY2VsVGltZXJzOwogIF9leHBvcnRzLmxhdGVyID0gbGF0ZXI7CiAgX2V4cG9ydHMub25jZSA9IG9uY2U7CiAgX2V4cG9ydHMuc2NoZWR1bGVPbmNlID0gc2NoZWR1bGVPbmNlOwogIF9leHBvcnRzLm5leHQgPSBuZXh0OwogIF9leHBvcnRzLmNhbmNlbCA9IGNhbmNlbDsKICBfZXhwb3J0cy5kZWJvdW5jZSA9IGRlYm91bmNlOwogIF9leHBvcnRzLnRocm90dGxlID0gdGhyb3R0bGU7CiAgX2V4cG9ydHMuYmluZCA9IF9leHBvcnRzLl9nbG9iYWxzUnVuID0gX2V4cG9ydHMuYmFja2J1cm5lciA9IF9leHBvcnRzLnF1ZXVlcyA9IF9leHBvcnRzLl9yc3ZwRXJyb3JRdWV1ZSA9IHZvaWQgMDsKICB2YXIgY3VycmVudFJ1bkxvb3AgPSBudWxsOwoKICBmdW5jdGlvbiBnZXRDdXJyZW50UnVuTG9vcCgpIHsKICAgIHJldHVybiBjdXJyZW50UnVuTG9vcDsKICB9CgogIGZ1bmN0aW9uIG9uQmVnaW4oY3VycmVudCkgewogICAgY3VycmVudFJ1bkxvb3AgPSBjdXJyZW50OwogIH0KCiAgZnVuY3Rpb24gb25FbmQoY3VycmVudCwgbmV4dCkgewogICAgY3VycmVudFJ1bkxvb3AgPSBuZXh0OwoKICAgIGlmICh0cnVlCiAgICAvKiBFTUJFUl9NRVRBTF9UUkFDS0VEX1BST1BFUlRJRVMgKi8KICAgICkgewogICAgICAgICgwLCBfbWV0YWwuZmx1c2hBc3luY09ic2VydmVycykoKTsKICAgICAgfQogIH0KCiAgdmFyIGZsdXNoOwoKICBpZiAodHJ1ZQogIC8qIEVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyAqLwogICkgewogICAgICBmbHVzaCA9IGZ1bmN0aW9uIGZsdXNoKHF1ZXVlTmFtZSwgbmV4dCkgewogICAgICAgIGlmIChxdWV1ZU5hbWUgPT09ICdyZW5kZXInIHx8IHF1ZXVlTmFtZSA9PT0gX3JzdnBFcnJvclF1ZXVlKSB7CiAgICAgICAgICAoMCwgX21ldGFsLmZsdXNoQXN5bmNPYnNlcnZlcnMpKCk7CiAgICAgICAgfQoKICAgICAgICBuZXh0KCk7CiAgICAgIH07CiAgICB9CgogIHZhciBfcnN2cEVycm9yUXVldWUgPSAoIiIgKyBNYXRoLnJhbmRvbSgpICsgRGF0ZS5ub3coKSkucmVwbGFjZSgnLicsICcnKTsKICAvKioKICAgIEFycmF5IG9mIG5hbWVkIHF1ZXVlcy4gVGhpcyBhcnJheSBkZXRlcm1pbmVzIHRoZSBvcmRlciBpbiB3aGljaCBxdWV1ZXMKICAgIGFyZSBmbHVzaGVkIGF0IHRoZSBlbmQgb2YgdGhlIFJ1bkxvb3AuIFlvdSBjYW4gZGVmaW5lIHlvdXIgb3duIHF1ZXVlcyBieQogICAgc2ltcGx5IGFkZGluZyB0aGUgcXVldWUgbmFtZSB0byB0aGlzIGFycmF5LiBOb3JtYWxseSB5b3Ugc2hvdWxkIG5vdCBuZWVkCiAgICB0byBpbnNwZWN0IG9yIG1vZGlmeSB0aGlzIHByb3BlcnR5LgogIAogICAgQHByb3BlcnR5IHF1ZXVlcwogICAgQHR5cGUgQXJyYXkKICAgIEBkZWZhdWx0IFsnYWN0aW9ucycsICdkZXN0cm95J10KICAgIEBwcml2YXRlCiAgKi8KCgogIF9leHBvcnRzLl9yc3ZwRXJyb3JRdWV1ZSA9IF9yc3ZwRXJyb3JRdWV1ZTsKICB2YXIgcXVldWVzID0gWydhY3Rpb25zJywgLy8gdXNlZCBpbiByb3V0ZXIgdHJhbnNpdGlvbnMgdG8gcHJldmVudCB1bm5lY2Vzc2FyeSBsb2FkaW5nIHN0YXRlIGVudHJ5CiAgLy8gaWYgYWxsIGNvbnRleHQgcHJvbWlzZXMgcmVzb2x2ZSBvbiB0aGUgJ2FjdGlvbnMnIHF1ZXVlIGZpcnN0CiAgJ3JvdXRlclRyYW5zaXRpb25zJywgJ3JlbmRlcicsICdhZnRlclJlbmRlcicsICdkZXN0cm95JywgLy8gdXNlZCB0byByZS10aHJvdyB1bmhhbmRsZWQgUlNWUCByZWplY3Rpb24gZXJyb3JzIHNwZWNpZmljYWxseSBpbiB0aGlzCiAgLy8gcG9zaXRpb24gdG8gYXZvaWQgYnJlYWtpbmcgYW55dGhpbmcgcmVuZGVyZWQgaW4gdGhlIG90aGVyIHNlY3Rpb25zCiAgX3JzdnBFcnJvclF1ZXVlXTsKICBfZXhwb3J0cy5xdWV1ZXMgPSBxdWV1ZXM7CiAgdmFyIGJhY2tidXJuZXIgPSBuZXcgX2JhY2tidXJuZXIuZGVmYXVsdChxdWV1ZXMsIHsKICAgIGRlZmF1bHRRdWV1ZTogJ2FjdGlvbnMnLAogICAgb25CZWdpbjogb25CZWdpbiwKICAgIG9uRW5kOiBvbkVuZCwKICAgIG9uRXJyb3JUYXJnZXQ6IF9lcnJvckhhbmRsaW5nLm9uRXJyb3JUYXJnZXQsCiAgICBvbkVycm9yTWV0aG9kOiAnb25lcnJvcicsCiAgICBmbHVzaDogZmx1c2gKICB9KTsKICAvKioKICAgQG1vZHVsZSBAZW1iZXIvcnVubG9vcAogICovCiAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogIC8vIHJ1biAtIHRoaXMgaXMgaWRlYWxseSB0aGUgb25seSBwdWJsaWMgQVBJIHRoZSBkZXYgc2VlcwogIC8vCgogIC8qKgogICAgUnVucyB0aGUgcGFzc2VkIHRhcmdldCBhbmQgbWV0aG9kIGluc2lkZSBvZiBhIFJ1bkxvb3AsIGVuc3VyaW5nIGFueQogICAgZGVmZXJyZWQgYWN0aW9ucyBpbmNsdWRpbmcgYmluZGluZ3MgYW5kIHZpZXdzIHVwZGF0ZXMgYXJlIGZsdXNoZWQgYXQgdGhlCiAgICBlbmQuCiAgCiAgICBOb3JtYWxseSB5b3Ugc2hvdWxkIG5vdCBuZWVkIHRvIGludm9rZSB0aGlzIG1ldGhvZCB5b3Vyc2VsZi4gSG93ZXZlciBpZgogICAgeW91IGFyZSBpbXBsZW1lbnRpbmcgcmF3IGV2ZW50IGhhbmRsZXJzIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBvdGhlcgogICAgbGlicmFyaWVzIG9yIHBsdWdpbnMsIHlvdSBzaG91bGQgcHJvYmFibHkgd3JhcCBhbGwgb2YgeW91ciBjb2RlIGluc2lkZSB0aGlzCiAgICBjYWxsLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgcnVuIH0gZnJvbSAnQGVtYmVyL3J1bmxvb3AnOwogIAogICAgcnVuKGZ1bmN0aW9uKCkgewogICAgICAvLyBjb2RlIHRvIGJlIGV4ZWN1dGVkIHdpdGhpbiBhIFJ1bkxvb3AKICAgIH0pOwogICAgYGBgCiAgICBAbWV0aG9kIHJ1bgogICAgQGZvciBAZW1iZXIvcnVubG9vcAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtPYmplY3R9IFt0YXJnZXRdIHRhcmdldCBvZiBtZXRob2QgdG8gY2FsbAogICAgQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IG1ldGhvZCBNZXRob2QgdG8gaW52b2tlLgogICAgICBNYXkgYmUgYSBmdW5jdGlvbiBvciBhIHN0cmluZy4gSWYgeW91IHBhc3MgYSBzdHJpbmcKICAgICAgdGhlbiBpdCB3aWxsIGJlIGxvb2tlZCB1cCBvbiB0aGUgcGFzc2VkIHRhcmdldC4KICAgIEBwYXJhbSB7T2JqZWN0fSBbYXJncypdIEFueSBhZGRpdGlvbmFsIGFyZ3VtZW50cyB5b3Ugd2lzaCB0byBwYXNzIHRvIHRoZSBtZXRob2QuCiAgICBAcmV0dXJuIHtPYmplY3R9IHJldHVybiB2YWx1ZSBmcm9tIGludm9raW5nIHRoZSBwYXNzZWQgZnVuY3Rpb24uCiAgICBAcHVibGljCiAgKi8KCiAgX2V4cG9ydHMuYmFja2J1cm5lciA9IGJhY2tidXJuZXI7CgogIGZ1bmN0aW9uIHJ1bigpIHsKICAgIHJldHVybiBiYWNrYnVybmVyLnJ1bi5hcHBseShiYWNrYnVybmVyLCBhcmd1bWVudHMpOwogIH0gLy8gdXNlZCBmb3IgdGhlIEVtYmVyLnJ1biBnbG9iYWwgb25seQoKCiAgdmFyIF9nbG9iYWxzUnVuID0gcnVuLmJpbmQobnVsbCk7CiAgLyoqCiAgICBJZiBubyBydW4tbG9vcCBpcyBwcmVzZW50LCBpdCBjcmVhdGVzIGEgbmV3IG9uZS4gSWYgYSBydW4gbG9vcCBpcwogICAgcHJlc2VudCBpdCB3aWxsIHF1ZXVlIGl0c2VsZiB0byBydW4gb24gdGhlIGV4aXN0aW5nIHJ1bi1sb29wcyBhY3Rpb24KICAgIHF1ZXVlLgogIAogICAgUGxlYXNlIG5vdGU6IFRoaXMgaXMgbm90IGZvciBub3JtYWwgdXNhZ2UsIGFuZCBzaG91bGQgYmUgdXNlZCBzcGFyaW5nbHkuCiAgCiAgICBJZiBpbnZva2VkIHdoZW4gbm90IHdpdGhpbiBhIHJ1biBsb29wOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgam9pbiB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAKICAgIGpvaW4oZnVuY3Rpb24oKSB7CiAgICAgIC8vIGNyZWF0ZXMgYSBuZXcgcnVuLWxvb3AKICAgIH0pOwogICAgYGBgCiAgCiAgICBBbHRlcm5hdGl2ZWx5LCBpZiBjYWxsZWQgd2l0aGluIGFuIGV4aXN0aW5nIHJ1biBsb29wOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgcnVuLCBqb2luIH0gZnJvbSAnQGVtYmVyL3J1bmxvb3AnOwogIAogICAgcnVuKGZ1bmN0aW9uKCkgewogICAgICAvLyBjcmVhdGVzIGEgbmV3IHJ1bi1sb29wCiAgCiAgICAgIGpvaW4oZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gam9pbnMgd2l0aCB0aGUgZXhpc3RpbmcgcnVuLWxvb3AsIGFuZCBxdWV1ZXMgZm9yIGludm9jYXRpb24gb24KICAgICAgICAvLyB0aGUgZXhpc3RpbmcgcnVuLWxvb3BzIGFjdGlvbiBxdWV1ZS4KICAgICAgfSk7CiAgICB9KTsKICAgIGBgYAogIAogICAgQG1ldGhvZCBqb2luCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9ydW5sb29wCiAgICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gdGFyZ2V0IG9mIG1ldGhvZCB0byBjYWxsCiAgICBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gbWV0aG9kIE1ldGhvZCB0byBpbnZva2UuCiAgICAgIE1heSBiZSBhIGZ1bmN0aW9uIG9yIGEgc3RyaW5nLiBJZiB5b3UgcGFzcyBhIHN0cmluZwogICAgICB0aGVuIGl0IHdpbGwgYmUgbG9va2VkIHVwIG9uIHRoZSBwYXNzZWQgdGFyZ2V0LgogICAgQHBhcmFtIHtPYmplY3R9IFthcmdzKl0gQW55IGFkZGl0aW9uYWwgYXJndW1lbnRzIHlvdSB3aXNoIHRvIHBhc3MgdG8gdGhlIG1ldGhvZC4KICAgIEByZXR1cm4ge09iamVjdH0gUmV0dXJuIHZhbHVlIGZyb20gaW52b2tpbmcgdGhlIHBhc3NlZCBmdW5jdGlvbi4gUGxlYXNlIG5vdGUsCiAgICB3aGVuIGNhbGxlZCB3aXRoaW4gYW4gZXhpc3RpbmcgbG9vcCwgbm8gcmV0dXJuIHZhbHVlIGlzIHBvc3NpYmxlLgogICAgQHB1YmxpYwogICovCgoKICBfZXhwb3J0cy5fZ2xvYmFsc1J1biA9IF9nbG9iYWxzUnVuOwoKICBmdW5jdGlvbiBqb2luKCkgewogICAgcmV0dXJuIGJhY2tidXJuZXIuam9pbi5hcHBseShiYWNrYnVybmVyLCBhcmd1bWVudHMpOwogIH0KICAvKioKICAgIEFsbG93cyB5b3UgdG8gc3BlY2lmeSB3aGljaCBjb250ZXh0IHRvIGNhbGwgdGhlIHNwZWNpZmllZCBmdW5jdGlvbiBpbiB3aGlsZQogICAgYWRkaW5nIHRoZSBleGVjdXRpb24gb2YgdGhhdCBmdW5jdGlvbiB0byB0aGUgRW1iZXIgcnVuIGxvb3AuIFRoaXMgYWJpbGl0eQogICAgbWFrZXMgdGhpcyBtZXRob2QgYSBncmVhdCB3YXkgdG8gYXN5bmNocm9ub3VzbHkgaW50ZWdyYXRlIHRoaXJkLXBhcnR5IGxpYnJhcmllcwogICAgaW50byB5b3VyIEVtYmVyIGFwcGxpY2F0aW9uLgogIAogICAgYGJpbmRgIHRha2VzIHR3byBtYWluIGFyZ3VtZW50cywgdGhlIGRlc2lyZWQgY29udGV4dCBhbmQgdGhlIGZ1bmN0aW9uIHRvCiAgICBpbnZva2UgaW4gdGhhdCBjb250ZXh0LiBBbnkgYWRkaXRpb25hbCBhcmd1bWVudHMgd2lsbCBiZSBzdXBwbGllZCBhcyBhcmd1bWVudHMKICAgIHRvIHRoZSBmdW5jdGlvbiB0aGF0IGlzIHBhc3NlZCBpbi4KICAKICAgIExldCdzIHVzZSB0aGUgY3JlYXRpb24gb2YgYSBUaW55TUNFIGNvbXBvbmVudCBhcyBhbiBleGFtcGxlLiBDdXJyZW50bHksCiAgICBUaW55TUNFIHByb3ZpZGVzIGEgc2V0dXAgY29uZmlndXJhdGlvbiBvcHRpb24gd2UgY2FuIHVzZSB0byBkbyBzb21lIHByb2Nlc3NpbmcKICAgIGFmdGVyIHRoZSBUaW55TUNFIGluc3RhbmNlIGlzIGluaXRpYWxpemVkIGJ1dCBiZWZvcmUgaXQgaXMgYWN0dWFsbHkgcmVuZGVyZWQuCiAgICBXZSBjYW4gdXNlIHRoYXQgc2V0dXAgb3B0aW9uIHRvIGRvIHNvbWUgYWRkaXRpb25hbCBzZXR1cCBmb3Igb3VyIGNvbXBvbmVudC4KICAgIFRoZSBjb21wb25lbnQgaXRzZWxmIGNvdWxkIGxvb2sgc29tZXRoaW5nIGxpa2UgdGhlIGZvbGxvd2luZzoKICAKICAgIGBgYGFwcC9jb21wb25lbnRzL3JpY2gtdGV4dC1lZGl0b3IuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICBpbXBvcnQgeyBvbiB9IGZyb20gJ0BlbWJlci9vYmplY3QvZXZlbnRlZCc7CiAgICBpbXBvcnQgeyBiaW5kIH0gZnJvbSAnQGVtYmVyL3J1bmxvb3AnOwogIAogICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgIGluaXRpYWxpemVUaW55TUNFOiBvbignZGlkSW5zZXJ0RWxlbWVudCcsIGZ1bmN0aW9uKCkgewogICAgICAgIHRpbnltY2UuaW5pdCh7CiAgICAgICAgICBzZWxlY3RvcjogJyMnICsgdGhpcy4kKCkucHJvcCgnaWQnKSwKICAgICAgICAgIHNldHVwOiBiaW5kKHRoaXMsIHRoaXMuc2V0dXBFZGl0b3IpCiAgICAgICAgfSk7CiAgICAgIH0pLAogIAogICAgICBkaWRJbnNlcnRFbGVtZW50KCkgewogICAgICAgIHRpbnltY2UuaW5pdCh7CiAgICAgICAgICBzZWxlY3RvcjogJyMnICsgdGhpcy4kKCkucHJvcCgnaWQnKSwKICAgICAgICAgIHNldHVwOiBiaW5kKHRoaXMsIHRoaXMuc2V0dXBFZGl0b3IpCiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgc2V0dXBFZGl0b3IoZWRpdG9yKSB7CiAgICAgICAgdGhpcy5zZXQoJ2VkaXRvcicsIGVkaXRvcik7CiAgCiAgICAgICAgZWRpdG9yLm9uKCdjaGFuZ2UnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdjb250ZW50IGNoYW5nZWQhJyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBJbiB0aGlzIGV4YW1wbGUsIHdlIHVzZSBgYmluZGAgdG8gYmluZCB0aGUgc2V0dXBFZGl0b3IgbWV0aG9kIHRvIHRoZQogICAgY29udGV4dCBvZiB0aGUgUmljaFRleHRFZGl0b3IgY29tcG9uZW50IGFuZCB0byBoYXZlIHRoZSBpbnZvY2F0aW9uIG9mIHRoYXQKICAgIG1ldGhvZCBiZSBzYWZlbHkgaGFuZGxlZCBhbmQgZXhlY3V0ZWQgYnkgdGhlIEVtYmVyIHJ1biBsb29wLgogIAogICAgQG1ldGhvZCBiaW5kCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9ydW5sb29wCiAgICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gdGFyZ2V0IG9mIG1ldGhvZCB0byBjYWxsCiAgICBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gbWV0aG9kIE1ldGhvZCB0byBpbnZva2UuCiAgICAgIE1heSBiZSBhIGZ1bmN0aW9uIG9yIGEgc3RyaW5nLiBJZiB5b3UgcGFzcyBhIHN0cmluZwogICAgICB0aGVuIGl0IHdpbGwgYmUgbG9va2VkIHVwIG9uIHRoZSBwYXNzZWQgdGFyZ2V0LgogICAgQHBhcmFtIHtPYmplY3R9IFthcmdzKl0gQW55IGFkZGl0aW9uYWwgYXJndW1lbnRzIHlvdSB3aXNoIHRvIHBhc3MgdG8gdGhlIG1ldGhvZC4KICAgIEByZXR1cm4ge0Z1bmN0aW9ufSByZXR1cm5zIGEgbmV3IGZ1bmN0aW9uIHRoYXQgd2lsbCBhbHdheXMgaGF2ZSBhIHBhcnRpY3VsYXIgY29udGV4dAogICAgQHNpbmNlIDEuNC4wCiAgICBAcHVibGljCiAgKi8KCgogIHZhciBiaW5kID0gZnVuY3Rpb24gYmluZCgpIHsKICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBjdXJyaWVkID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICBjdXJyaWVkW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgfQoKICAgIChmYWxzZSAmJiAhKGZ1bmN0aW9uIChtZXRob2RPclRhcmdldCwgbWV0aG9kT3JBcmcpIHsKICAgICAgLy8gQXBwbGllcyB0aGUgc2FtZSBsb2dpYyBhcyBiYWNrYnVybmVyIHBhcnNlQXJncyBmb3IgZGV0ZWN0aW5nIGlmIGEgbWV0aG9kCiAgICAgIC8vIGlzIGFjdHVhbGx5IGJlaW5nIHBhc3NlZC4KICAgICAgdmFyIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7CgogICAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IGVsc2UgaWYgKGxlbmd0aCA9PT0gMSkgewogICAgICAgIHJldHVybiB0eXBlb2YgbWV0aG9kT3JUYXJnZXQgPT09ICdmdW5jdGlvbic7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgbWV0aG9kT3JBcmc7CiAgICAgICAgcmV0dXJuIHR5cGUgPT09ICdmdW5jdGlvbicgfHwgLy8gc2Vjb25kIGFyZ3VtZW50IGlzIGEgZnVuY3Rpb24KICAgICAgICBtZXRob2RPclRhcmdldCAhPT0gbnVsbCAmJiB0eXBlID09PSAnc3RyaW5nJyAmJiBtZXRob2RPckFyZyBpbiBtZXRob2RPclRhcmdldCB8fCAvLyBzZWNvbmQgYXJndW1lbnQgaXMgdGhlIG5hbWUgb2YgYSBtZXRob2QgaW4gZmlyc3QgYXJndW1lbnQKICAgICAgICB0eXBlb2YgbWV0aG9kT3JUYXJnZXQgPT09ICdmdW5jdGlvbicgLy9maXJzdCBhcmd1bWVudCBpcyBhIGZ1bmN0aW9uCiAgICAgICAgOwogICAgICB9CiAgICB9LmFwcGx5KHZvaWQgMCwgY3VycmllZCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnY291bGQgbm90IGZpbmQgYSBzdWl0YWJsZSBtZXRob2QgdG8gYmluZCcsIGZ1bmN0aW9uIChtZXRob2RPclRhcmdldCwgbWV0aG9kT3JBcmcpIHsKICAgICAgdmFyIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7CgogICAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IGVsc2UgaWYgKGxlbmd0aCA9PT0gMSkgewogICAgICAgIHJldHVybiB0eXBlb2YgbWV0aG9kT3JUYXJnZXQgPT09ICdmdW5jdGlvbic7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgbWV0aG9kT3JBcmc7CiAgICAgICAgcmV0dXJuIHR5cGUgPT09ICdmdW5jdGlvbicgfHwgbWV0aG9kT3JUYXJnZXQgIT09IG51bGwgJiYgdHlwZSA9PT0gJ3N0cmluZycgJiYgbWV0aG9kT3JBcmcgaW4gbWV0aG9kT3JUYXJnZXQgfHwgdHlwZW9mIG1ldGhvZE9yVGFyZ2V0ID09PSAnZnVuY3Rpb24nOwogICAgICB9CiAgICB9LmFwcGx5KHZvaWQgMCwgY3VycmllZCkpKTsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiksIF9rZXkyID0gMDsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgIGFyZ3NbX2tleTJdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgfQoKICAgICAgcmV0dXJuIGpvaW4uYXBwbHkodm9pZCAwLCBjdXJyaWVkLmNvbmNhdChhcmdzKSk7CiAgICB9OwogIH07CiAgLyoqCiAgICBCZWdpbnMgYSBuZXcgUnVuTG9vcC4gQW55IGRlZmVycmVkIGFjdGlvbnMgaW52b2tlZCBhZnRlciB0aGUgYmVnaW4gd2lsbAogICAgYmUgYnVmZmVyZWQgdW50aWwgeW91IGludm9rZSBhIG1hdGNoaW5nIGNhbGwgdG8gYGVuZCgpYC4gVGhpcyBpcwogICAgYSBsb3dlci1sZXZlbCB3YXkgdG8gdXNlIGEgUnVuTG9vcCBpbnN0ZWFkIG9mIHVzaW5nIGBydW4oKWAuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBiZWdpbiwgZW5kIH0gZnJvbSAnQGVtYmVyL3J1bmxvb3AnOwogIAogICAgYmVnaW4oKTsKICAgIC8vIGNvZGUgdG8gYmUgZXhlY3V0ZWQgd2l0aGluIGEgUnVuTG9vcAogICAgZW5kKCk7CiAgICBgYGAKICAKICAgIEBtZXRob2QgYmVnaW4KICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL3J1bmxvb3AKICAgIEByZXR1cm4ge3ZvaWR9CiAgICBAcHVibGljCiAgKi8KCgogIF9leHBvcnRzLmJpbmQgPSBiaW5kOwoKICBmdW5jdGlvbiBiZWdpbigpIHsKICAgIGJhY2tidXJuZXIuYmVnaW4oKTsKICB9CiAgLyoqCiAgICBFbmRzIGEgUnVuTG9vcC4gVGhpcyBtdXN0IGJlIGNhbGxlZCBzb21ldGltZSBhZnRlciB5b3UgY2FsbAogICAgYGJlZ2luKClgIHRvIGZsdXNoIGFueSBkZWZlcnJlZCBhY3Rpb25zLiBUaGlzIGlzIGEgbG93ZXItbGV2ZWwgd2F5CiAgICB0byB1c2UgYSBSdW5Mb29wIGluc3RlYWQgb2YgdXNpbmcgYHJ1bigpYC4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGJlZ2luLCBlbmQgfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgCiAgICBiZWdpbigpOwogICAgLy8gY29kZSB0byBiZSBleGVjdXRlZCB3aXRoaW4gYSBSdW5Mb29wCiAgICBlbmQoKTsKICAgIGBgYAogIAogICAgQG1ldGhvZCBlbmQKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL3J1bmxvb3AKICAgIEByZXR1cm4ge3ZvaWR9CiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIGVuZCgpIHsKICAgIGJhY2tidXJuZXIuZW5kKCk7CiAgfQogIC8qKgogICAgQWRkcyB0aGUgcGFzc2VkIHRhcmdldC9tZXRob2QgYW5kIGFueSBvcHRpb25hbCBhcmd1bWVudHMgdG8gdGhlIG5hbWVkCiAgICBxdWV1ZSB0byBiZSBleGVjdXRlZCBhdCB0aGUgZW5kIG9mIHRoZSBSdW5Mb29wLiBJZiB5b3UgaGF2ZSBub3QgYWxyZWFkeQogICAgc3RhcnRlZCBhIFJ1bkxvb3Agd2hlbiBjYWxsaW5nIHRoaXMgbWV0aG9kIG9uZSB3aWxsIGJlIHN0YXJ0ZWQgZm9yIHlvdQogICAgYXV0b21hdGljYWxseS4KICAKICAgIEF0IHRoZSBlbmQgb2YgYSBSdW5Mb29wLCBhbnkgbWV0aG9kcyBzY2hlZHVsZWQgaW4gdGhpcyB3YXkgd2lsbCBiZSBpbnZva2VkLgogICAgTWV0aG9kcyB3aWxsIGJlIGludm9rZWQgaW4gYW4gb3JkZXIgbWF0Y2hpbmcgdGhlIG5hbWVkIHF1ZXVlcyBkZWZpbmVkIGluCiAgICB0aGUgYHF1ZXVlc2AgcHJvcGVydHkuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzY2hlZHVsZSB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAKICAgIHNjaGVkdWxlKCdhZnRlclJlbmRlcicsIHRoaXMsIGZ1bmN0aW9uKCkgewogICAgICAvLyB0aGlzIHdpbGwgYmUgZXhlY3V0ZWQgaW4gdGhlICdhZnRlclJlbmRlcicgcXVldWUKICAgICAgY29uc29sZS5sb2coJ3NjaGVkdWxlZCBvbiBhZnRlclJlbmRlciBxdWV1ZScpOwogICAgfSk7CiAgCiAgICBzY2hlZHVsZSgnYWN0aW9ucycsIHRoaXMsIGZ1bmN0aW9uKCkgewogICAgICAvLyB0aGlzIHdpbGwgYmUgZXhlY3V0ZWQgaW4gdGhlICdhY3Rpb25zJyBxdWV1ZQogICAgICBjb25zb2xlLmxvZygnc2NoZWR1bGVkIG9uIGFjdGlvbnMgcXVldWUnKTsKICAgIH0pOwogIAogICAgLy8gTm90ZSB0aGUgZnVuY3Rpb25zIHdpbGwgYmUgcnVuIGluIG9yZGVyIGJhc2VkIG9uIHRoZSBydW4gcXVldWVzIG9yZGVyLgogICAgLy8gT3V0cHV0IHdvdWxkIGJlOgogICAgLy8gICBzY2hlZHVsZWQgb24gYWN0aW9ucyBxdWV1ZQogICAgLy8gICBzY2hlZHVsZWQgb24gYWZ0ZXJSZW5kZXIgcXVldWUKICAgIGBgYAogIAogICAgQG1ldGhvZCBzY2hlZHVsZQogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvcnVubG9vcAogICAgQHBhcmFtIHtTdHJpbmd9IHF1ZXVlIFRoZSBuYW1lIG9mIHRoZSBxdWV1ZSB0byBzY2hlZHVsZSBhZ2FpbnN0LiBEZWZhdWx0IHF1ZXVlcyBpcyAnYWN0aW9ucycKICAgIEBwYXJhbSB7T2JqZWN0fSBbdGFyZ2V0XSB0YXJnZXQgb2JqZWN0IHRvIHVzZSBhcyB0aGUgY29udGV4dCB3aGVuIGludm9raW5nIGEgbWV0aG9kLgogICAgQHBhcmFtIHtTdHJpbmd8RnVuY3Rpb259IG1ldGhvZCBUaGUgbWV0aG9kIHRvIGludm9rZS4gSWYgeW91IHBhc3MgYSBzdHJpbmcgaXQKICAgICAgd2lsbCBiZSByZXNvbHZlZCBvbiB0aGUgdGFyZ2V0IG9iamVjdCBhdCB0aGUgdGltZSB0aGUgc2NoZWR1bGVkIGl0ZW0gaXMKICAgICAgaW52b2tlZCBhbGxvd2luZyB5b3UgdG8gY2hhbmdlIHRoZSB0YXJnZXQgZnVuY3Rpb24uCiAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3VtZW50cypdIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBiZSBwYXNzZWQgdG8gdGhlIHF1ZXVlZCBtZXRob2QuCiAgICBAcmV0dXJuIHsqfSBUaW1lciBpbmZvcm1hdGlvbiBmb3IgdXNlIGluIGNhbmNlbGluZywgc2VlIGBjYW5jZWxgLgogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBzY2hlZHVsZSgpCiAgLyogcXVldWUsIHRhcmdldCwgbWV0aG9kICovCiAgewogICAgcmV0dXJuIGJhY2tidXJuZXIuc2NoZWR1bGUuYXBwbHkoYmFja2J1cm5lciwgYXJndW1lbnRzKTsKICB9IC8vIFVzZWQgYnkgZ2xvYmFsIHRlc3QgdGVhcmRvd24KCgogIGZ1bmN0aW9uIGhhc1NjaGVkdWxlZFRpbWVycygpIHsKICAgIHJldHVybiBiYWNrYnVybmVyLmhhc1RpbWVycygpOwogIH0gLy8gVXNlZCBieSBnbG9iYWwgdGVzdCB0ZWFyZG93bgoKCiAgZnVuY3Rpb24gY2FuY2VsVGltZXJzKCkgewogICAgYmFja2J1cm5lci5jYW5jZWxUaW1lcnMoKTsKICB9CiAgLyoqCiAgICBJbnZva2VzIHRoZSBwYXNzZWQgdGFyZ2V0L21ldGhvZCBhbmQgb3B0aW9uYWwgYXJndW1lbnRzIGFmdGVyIGEgc3BlY2lmaWVkCiAgICBwZXJpb2Qgb2YgdGltZS4gVGhlIGxhc3QgcGFyYW1ldGVyIG9mIHRoaXMgbWV0aG9kIG11c3QgYWx3YXlzIGJlIGEgbnVtYmVyCiAgICBvZiBtaWxsaXNlY29uZHMuCiAgCiAgICBZb3Ugc2hvdWxkIHVzZSB0aGlzIG1ldGhvZCB3aGVuZXZlciB5b3UgbmVlZCB0byBydW4gc29tZSBhY3Rpb24gYWZ0ZXIgYQogICAgcGVyaW9kIG9mIHRpbWUgaW5zdGVhZCBvZiB1c2luZyBgc2V0VGltZW91dCgpYC4gVGhpcyBtZXRob2Qgd2lsbCBlbnN1cmUgdGhhdAogICAgaXRlbXMgdGhhdCBleHBpcmUgZHVyaW5nIHRoZSBzYW1lIHNjcmlwdCBleGVjdXRpb24gY3ljbGUgYWxsIGV4ZWN1dGUKICAgIHRvZ2V0aGVyLCB3aGljaCBpcyBvZnRlbiBtb3JlIGVmZmljaWVudCB0aGFuIHVzaW5nIGEgcmVhbCBzZXRUaW1lb3V0LgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgbGF0ZXIgfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgCiAgICBsYXRlcihteUNvbnRleHQsIGZ1bmN0aW9uKCkgewogICAgICAvLyBjb2RlIGhlcmUgd2lsbCBleGVjdXRlIHdpdGhpbiBhIFJ1bkxvb3AgaW4gYWJvdXQgNTAwbXMgd2l0aCB0aGlzID09IG15Q29udGV4dAogICAgfSwgNTAwKTsKICAgIGBgYAogIAogICAgQG1ldGhvZCBsYXRlcgogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvcnVubG9vcAogICAgQHBhcmFtIHtPYmplY3R9IFt0YXJnZXRdIHRhcmdldCBvZiBtZXRob2QgdG8gaW52b2tlCiAgICBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gbWV0aG9kIFRoZSBtZXRob2QgdG8gaW52b2tlLgogICAgICBJZiB5b3UgcGFzcyBhIHN0cmluZyBpdCB3aWxsIGJlIHJlc29sdmVkIG9uIHRoZQogICAgICB0YXJnZXQgYXQgdGhlIHRpbWUgdGhlIG1ldGhvZCBpcyBpbnZva2VkLgogICAgQHBhcmFtIHtPYmplY3R9IFthcmdzKl0gT3B0aW9uYWwgYXJndW1lbnRzIHRvIHBhc3MgdG8gdGhlIHRpbWVvdXQuCiAgICBAcGFyYW0ge051bWJlcn0gd2FpdCBOdW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQuCiAgICBAcmV0dXJuIHsqfSBUaW1lciBpbmZvcm1hdGlvbiBmb3IgdXNlIGluIGNhbmNlbGluZywgc2VlIGBjYW5jZWxgLgogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBsYXRlcigpCiAgLyp0YXJnZXQsIG1ldGhvZCovCiAgewogICAgcmV0dXJuIGJhY2tidXJuZXIubGF0ZXIuYXBwbHkoYmFja2J1cm5lciwgYXJndW1lbnRzKTsKICB9CiAgLyoqCiAgIFNjaGVkdWxlIGEgZnVuY3Rpb24gdG8gcnVuIG9uZSB0aW1lIGR1cmluZyB0aGUgY3VycmVudCBSdW5Mb29wLiBUaGlzIGlzIGVxdWl2YWxlbnQKICAgIHRvIGNhbGxpbmcgYHNjaGVkdWxlT25jZWAgd2l0aCB0aGUgImFjdGlvbnMiIHF1ZXVlLgogIAogICAgQG1ldGhvZCBvbmNlCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9ydW5sb29wCiAgICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gVGhlIHRhcmdldCBvZiB0aGUgbWV0aG9kIHRvIGludm9rZS4KICAgIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgVGhlIG1ldGhvZCB0byBpbnZva2UuCiAgICAgIElmIHlvdSBwYXNzIGEgc3RyaW5nIGl0IHdpbGwgYmUgcmVzb2x2ZWQgb24gdGhlCiAgICAgIHRhcmdldCBhdCB0aGUgdGltZSB0aGUgbWV0aG9kIGlzIGludm9rZWQuCiAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3MqXSBPcHRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUgdGltZW91dC4KICAgIEByZXR1cm4ge09iamVjdH0gVGltZXIgaW5mb3JtYXRpb24gZm9yIHVzZSBpbiBjYW5jZWxpbmcsIHNlZSBgY2FuY2VsYC4KICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gb25jZSgpIHsKICAgIGZvciAodmFyIF9sZW4zID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMyksIF9rZXkzID0gMDsgX2tleTMgPCBfbGVuMzsgX2tleTMrKykgewogICAgICBhcmdzW19rZXkzXSA9IGFyZ3VtZW50c1tfa2V5M107CiAgICB9CgogICAgYXJncy51bnNoaWZ0KCdhY3Rpb25zJyk7CiAgICByZXR1cm4gYmFja2J1cm5lci5zY2hlZHVsZU9uY2UuYXBwbHkoYmFja2J1cm5lciwgYXJncyk7CiAgfQogIC8qKgogICAgU2NoZWR1bGVzIGEgZnVuY3Rpb24gdG8gcnVuIG9uZSB0aW1lIGluIGEgZ2l2ZW4gcXVldWUgb2YgdGhlIGN1cnJlbnQgUnVuTG9vcC4KICAgIENhbGxpbmcgdGhpcyBtZXRob2Qgd2l0aCB0aGUgc2FtZSBxdWV1ZS90YXJnZXQvbWV0aG9kIGNvbWJpbmF0aW9uIHdpbGwgaGF2ZQogICAgbm8gZWZmZWN0IChwYXN0IHRoZSBpbml0aWFsIGNhbGwpLgogIAogICAgTm90ZSB0aGF0IGFsdGhvdWdoIHlvdSBjYW4gcGFzcyBvcHRpb25hbCBhcmd1bWVudHMgdGhlc2Ugd2lsbCBub3QgYmUKICAgIGNvbnNpZGVyZWQgd2hlbiBsb29raW5nIGZvciBkdXBsaWNhdGVzLiBOZXcgYXJndW1lbnRzIHdpbGwgcmVwbGFjZSBwcmV2aW91cwogICAgY2FsbHMuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBydW4sIHNjaGVkdWxlT25jZSB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAKICAgIGZ1bmN0aW9uIHNheUhpKCkgewogICAgICBjb25zb2xlLmxvZygnaGknKTsKICAgIH0KICAKICAgIHJ1bihmdW5jdGlvbigpIHsKICAgICAgc2NoZWR1bGVPbmNlKCdhZnRlclJlbmRlcicsIG15Q29udGV4dCwgc2F5SGkpOwogICAgICBzY2hlZHVsZU9uY2UoJ2FmdGVyUmVuZGVyJywgbXlDb250ZXh0LCBzYXlIaSk7CiAgICAgIC8vIHNheUhpIHdpbGwgb25seSBiZSBleGVjdXRlZCBvbmNlLCBpbiB0aGUgYWZ0ZXJSZW5kZXIgcXVldWUgb2YgdGhlIFJ1bkxvb3AKICAgIH0pOwogICAgYGBgCiAgCiAgICBBbHNvIG5vdGUgdGhhdCBmb3IgYHNjaGVkdWxlT25jZWAgdG8gcHJldmVudCBhZGRpdGlvbmFsIGNhbGxzLCB5b3UgbmVlZCB0bwogICAgcGFzcyB0aGUgc2FtZSBmdW5jdGlvbiBpbnN0YW5jZS4gVGhlIGZvbGxvd2luZyBjYXNlIHdvcmtzIGFzIGV4cGVjdGVkOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgZnVuY3Rpb24gbG9nKCkgewogICAgICBjb25zb2xlLmxvZygnTG9nZ2luZyBvbmx5IG9uY2UnKTsKICAgIH0KICAKICAgIGZ1bmN0aW9uIHNjaGVkdWxlSXQoKSB7CiAgICAgIHNjaGVkdWxlT25jZSgnYWN0aW9ucycsIG15Q29udGV4dCwgbG9nKTsKICAgIH0KICAKICAgIHNjaGVkdWxlSXQoKTsKICAgIHNjaGVkdWxlSXQoKTsKICAgIGBgYAogIAogICAgQnV0IHRoaXMgb3RoZXIgY2FzZSB3aWxsIHNjaGVkdWxlIHRoZSBmdW5jdGlvbiBtdWx0aXBsZSB0aW1lczoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHNjaGVkdWxlT25jZSB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAKICAgIGZ1bmN0aW9uIHNjaGVkdWxlSXQoKSB7CiAgICAgIHNjaGVkdWxlT25jZSgnYWN0aW9ucycsIG15Q29udGV4dCwgZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc29sZS5sb2coJ0Nsb3N1cmUnKTsKICAgICAgfSk7CiAgICB9CiAgCiAgICBzY2hlZHVsZUl0KCk7CiAgICBzY2hlZHVsZUl0KCk7CiAgCiAgICAvLyAiQ2xvc3VyZSIgd2lsbCBwcmludCB0d2ljZSwgZXZlbiB0aG91Z2ggd2UncmUgdXNpbmcgYHNjaGVkdWxlT25jZWAsCiAgICAvLyBiZWNhdXNlIHRoZSBmdW5jdGlvbiB3ZSBwYXNzIHRvIGl0IHdvbid0IG1hdGNoIHRoZQogICAgLy8gcHJldmlvdXNseSBzY2hlZHVsZWQgb3BlcmF0aW9uLgogICAgYGBgCiAgCiAgICBBdmFpbGFibGUgcXVldWVzLCBhbmQgdGhlaXIgb3JkZXIsIGNhbiBiZSBmb3VuZCBhdCBgcXVldWVzYAogIAogICAgQG1ldGhvZCBzY2hlZHVsZU9uY2UKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL3J1bmxvb3AKICAgIEBwYXJhbSB7U3RyaW5nfSBbcXVldWVdIFRoZSBuYW1lIG9mIHRoZSBxdWV1ZSB0byBzY2hlZHVsZSBhZ2FpbnN0LiBEZWZhdWx0IHF1ZXVlcyBpcyAnYWN0aW9ucycuCiAgICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gVGhlIHRhcmdldCBvZiB0aGUgbWV0aG9kIHRvIGludm9rZS4KICAgIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgVGhlIG1ldGhvZCB0byBpbnZva2UuCiAgICAgIElmIHlvdSBwYXNzIGEgc3RyaW5nIGl0IHdpbGwgYmUgcmVzb2x2ZWQgb24gdGhlCiAgICAgIHRhcmdldCBhdCB0aGUgdGltZSB0aGUgbWV0aG9kIGlzIGludm9rZWQuCiAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3MqXSBPcHRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUgdGltZW91dC4KICAgIEByZXR1cm4ge09iamVjdH0gVGltZXIgaW5mb3JtYXRpb24gZm9yIHVzZSBpbiBjYW5jZWxpbmcsIHNlZSBgY2FuY2VsYC4KICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gc2NoZWR1bGVPbmNlKCkKICAvKiBxdWV1ZSwgdGFyZ2V0LCBtZXRob2QqLwogIHsKICAgIHJldHVybiBiYWNrYnVybmVyLnNjaGVkdWxlT25jZS5hcHBseShiYWNrYnVybmVyLCBhcmd1bWVudHMpOwogIH0KICAvKioKICAgIFNjaGVkdWxlcyBhbiBpdGVtIHRvIHJ1biBmcm9tIHdpdGhpbiBhIHNlcGFyYXRlIHJ1biBsb29wLCBhZnRlcgogICAgY29udHJvbCBoYXMgYmVlbiByZXR1cm5lZCB0byB0aGUgc3lzdGVtLiBUaGlzIGlzIGVxdWl2YWxlbnQgdG8gY2FsbGluZwogICAgYGxhdGVyYCB3aXRoIGEgd2FpdCB0aW1lIG9mIDFtcy4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IG5leHQgfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgCiAgICBuZXh0KG15Q29udGV4dCwgZnVuY3Rpb24oKSB7CiAgICAgIC8vIGNvZGUgdG8gYmUgZXhlY3V0ZWQgaW4gdGhlIG5leHQgcnVuIGxvb3AsCiAgICAgIC8vIHdoaWNoIHdpbGwgYmUgc2NoZWR1bGVkIGFmdGVyIHRoZSBjdXJyZW50IG9uZQogICAgfSk7CiAgICBgYGAKICAKICAgIE11bHRpcGxlIG9wZXJhdGlvbnMgc2NoZWR1bGVkIHdpdGggYG5leHRgIHdpbGwgY29hbGVzY2UKICAgIGludG8gdGhlIHNhbWUgbGF0ZXIgcnVuIGxvb3AsIGFsb25nIHdpdGggYW55IG90aGVyIG9wZXJhdGlvbnMKICAgIHNjaGVkdWxlZCBieSBgbGF0ZXJgIHRoYXQgZXhwaXJlIHJpZ2h0IGFyb3VuZCB0aGUgc2FtZQogICAgdGltZSB0aGF0IGBuZXh0YCBvcGVyYXRpb25zIHdpbGwgZmlyZS4KICAKICAgIE5vdGUgdGhhdCB0aGVyZSBhcmUgb2Z0ZW4gYWx0ZXJuYXRpdmVzIHRvIHVzaW5nIGBuZXh0YC4KICAgIEZvciBpbnN0YW5jZSwgaWYgeW91J2QgbGlrZSB0byBzY2hlZHVsZSBhbiBvcGVyYXRpb24gdG8gaGFwcGVuCiAgICBhZnRlciBhbGwgRE9NIGVsZW1lbnQgb3BlcmF0aW9ucyBoYXZlIGNvbXBsZXRlZCB3aXRoaW4gdGhlIGN1cnJlbnQKICAgIHJ1biBsb29wLCB5b3UgY2FuIG1ha2UgdXNlIG9mIHRoZSBgYWZ0ZXJSZW5kZXJgIHJ1biBsb29wIHF1ZXVlIChhZGRlZAogICAgYnkgdGhlIGBlbWJlci12aWV3c2AgcGFja2FnZSwgYWxvbmcgd2l0aCB0aGUgcHJlY2VkaW5nIGByZW5kZXJgIHF1ZXVlCiAgICB3aGVyZSBhbGwgdGhlIERPTSBlbGVtZW50IG9wZXJhdGlvbnMgaGFwcGVuKS4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9teS1jb21wb25lbnQuanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICBpbXBvcnQgeyBzY2hlZHVsZU9uY2UgfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgCiAgICBleHBvcnQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgIGRpZEluc2VydEVsZW1lbnQoKSB7CiAgICAgICAgdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgICAgICBzY2hlZHVsZU9uY2UoJ2FmdGVyUmVuZGVyJywgdGhpcywgJ3Byb2Nlc3NDaGlsZEVsZW1lbnRzJyk7CiAgICAgIH0sCiAgCiAgICAgIHByb2Nlc3NDaGlsZEVsZW1lbnRzKCkgewogICAgICAgIC8vIC4uLiBkbyBzb21ldGhpbmcgd2l0aCBjb21wb25lbnQncyBjaGlsZCBjb21wb25lbnQKICAgICAgICAvLyBlbGVtZW50cyBhZnRlciB0aGV5J3ZlIGZpbmlzaGVkIHJlbmRlcmluZywgd2hpY2gKICAgICAgICAvLyBjYW4ndCBiZSBkb25lIHdpdGhpbiB0aGlzIGNvbXBvbmVudCdzCiAgICAgICAgLy8gYGRpZEluc2VydEVsZW1lbnRgIGhvb2sgYmVjYXVzZSB0aGF0IGdldHMgcnVuCiAgICAgICAgLy8gYmVmb3JlIHRoZSBjaGlsZCBlbGVtZW50cyBoYXZlIGJlZW4gYWRkZWQgdG8gdGhlIERPTS4KICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIE9uZSBiZW5lZml0IG9mIHRoZSBhYm92ZSBhcHByb2FjaCBjb21wYXJlZCB0byB1c2luZyBgbmV4dGAgaXMKICAgIHRoYXQgeW91IHdpbGwgYmUgYWJsZSB0byBwZXJmb3JtIERPTS9DU1Mgb3BlcmF0aW9ucyBiZWZvcmUgdW5wcm9jZXNzZWQKICAgIGVsZW1lbnRzIGFyZSByZW5kZXJlZCB0byB0aGUgc2NyZWVuLCB3aGljaCBtYXkgcHJldmVudCBmbGlja2VyaW5nIG9yCiAgICBvdGhlciBhcnRpZmFjdHMgY2F1c2VkIGJ5IGRlbGF5aW5nIHByb2Nlc3NpbmcgdW50aWwgYWZ0ZXIgcmVuZGVyaW5nLgogIAogICAgVGhlIG90aGVyIG1ham9yIGJlbmVmaXQgdG8gdGhlIGFib3ZlIGFwcHJvYWNoIGlzIHRoYXQgYG5leHRgCiAgICBpbnRyb2R1Y2VzIGFuIGVsZW1lbnQgb2Ygbm9uLWRldGVybWluaXNtLCB3aGljaCBjYW4gbWFrZSB0aGluZ3MgbXVjaAogICAgaGFyZGVyIHRvIHRlc3QsIGR1ZSB0byBpdHMgcmVsaWFuY2Ugb24gYHNldFRpbWVvdXRgOyBpdCdzIG11Y2ggaGFyZGVyCiAgICB0byBndWFyYW50ZWUgdGhlIG9yZGVyIG9mIHNjaGVkdWxlZCBvcGVyYXRpb25zIHdoZW4gdGhleSBhcmUgc2NoZWR1bGVkCiAgICBvdXRzaWRlIG9mIHRoZSBjdXJyZW50IHJ1biBsb29wLCBpLmUuIHdpdGggYG5leHRgLgogIAogICAgQG1ldGhvZCBuZXh0CiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9ydW5sb29wCiAgICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gdGFyZ2V0IG9mIG1ldGhvZCB0byBpbnZva2UKICAgIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgVGhlIG1ldGhvZCB0byBpbnZva2UuCiAgICAgIElmIHlvdSBwYXNzIGEgc3RyaW5nIGl0IHdpbGwgYmUgcmVzb2x2ZWQgb24gdGhlCiAgICAgIHRhcmdldCBhdCB0aGUgdGltZSB0aGUgbWV0aG9kIGlzIGludm9rZWQuCiAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3MqXSBPcHRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUgdGltZW91dC4KICAgIEByZXR1cm4ge09iamVjdH0gVGltZXIgaW5mb3JtYXRpb24gZm9yIHVzZSBpbiBjYW5jZWxpbmcsIHNlZSBgY2FuY2VsYC4KICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gbmV4dCgpIHsKICAgIGZvciAodmFyIF9sZW40ID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuNCksIF9rZXk0ID0gMDsgX2tleTQgPCBfbGVuNDsgX2tleTQrKykgewogICAgICBhcmdzW19rZXk0XSA9IGFyZ3VtZW50c1tfa2V5NF07CiAgICB9CgogICAgYXJncy5wdXNoKDEpOwogICAgcmV0dXJuIGJhY2tidXJuZXIubGF0ZXIuYXBwbHkoYmFja2J1cm5lciwgYXJncyk7CiAgfQogIC8qKgogICAgQ2FuY2VscyBhIHNjaGVkdWxlZCBpdGVtLiBNdXN0IGJlIGEgdmFsdWUgcmV0dXJuZWQgYnkgYGxhdGVyKClgLAogICAgYG9uY2UoKWAsIGBzY2hlZHVsZU9uY2UoKWAsIGBuZXh0KClgLCBgZGVib3VuY2UoKWAsIG9yCiAgICBgdGhyb3R0bGUoKWAuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgewogICAgICBuZXh0LAogICAgICBjYW5jZWwsCiAgICAgIGxhdGVyLAogICAgICBzY2hlZHVsZU9uY2UsCiAgICAgIG9uY2UsCiAgICAgIHRocm90dGxlLAogICAgICBkZWJvdW5jZQogICAgfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgCiAgICBsZXQgcnVuTmV4dCA9IG5leHQobXlDb250ZXh0LCBmdW5jdGlvbigpIHsKICAgICAgLy8gd2lsbCBub3QgYmUgZXhlY3V0ZWQKICAgIH0pOwogIAogICAgY2FuY2VsKHJ1bk5leHQpOwogIAogICAgbGV0IHJ1bkxhdGVyID0gbGF0ZXIobXlDb250ZXh0LCBmdW5jdGlvbigpIHsKICAgICAgLy8gd2lsbCBub3QgYmUgZXhlY3V0ZWQKICAgIH0sIDUwMCk7CiAgCiAgICBjYW5jZWwocnVuTGF0ZXIpOwogIAogICAgbGV0IHJ1blNjaGVkdWxlT25jZSA9IHNjaGVkdWxlT25jZSgnYWZ0ZXJSZW5kZXInLCBteUNvbnRleHQsIGZ1bmN0aW9uKCkgewogICAgICAvLyB3aWxsIG5vdCBiZSBleGVjdXRlZAogICAgfSk7CiAgCiAgICBjYW5jZWwocnVuU2NoZWR1bGVPbmNlKTsKICAKICAgIGxldCBydW5PbmNlID0gb25jZShteUNvbnRleHQsIGZ1bmN0aW9uKCkgewogICAgICAvLyB3aWxsIG5vdCBiZSBleGVjdXRlZAogICAgfSk7CiAgCiAgICBjYW5jZWwocnVuT25jZSk7CiAgCiAgICBsZXQgdGhyb3R0bGUgPSB0aHJvdHRsZShteUNvbnRleHQsIGZ1bmN0aW9uKCkgewogICAgICAvLyB3aWxsIG5vdCBiZSBleGVjdXRlZAogICAgfSwgMSwgZmFsc2UpOwogIAogICAgY2FuY2VsKHRocm90dGxlKTsKICAKICAgIGxldCBkZWJvdW5jZSA9IGRlYm91bmNlKG15Q29udGV4dCwgZnVuY3Rpb24oKSB7CiAgICAgIC8vIHdpbGwgbm90IGJlIGV4ZWN1dGVkCiAgICB9LCAxKTsKICAKICAgIGNhbmNlbChkZWJvdW5jZSk7CiAgCiAgICBsZXQgZGVib3VuY2VJbW1lZGlhdGUgPSBkZWJvdW5jZShteUNvbnRleHQsIGZ1bmN0aW9uKCkgewogICAgICAvLyB3aWxsIGJlIGV4ZWN1dGVkIHNpbmNlIHdlIHBhc3NlZCBpbiB0cnVlIChpbW1lZGlhdGUpCiAgICB9LCAxMDAsIHRydWUpOwogIAogICAgLy8gdGhlIDEwMG1zIGRlbGF5IHVudGlsIHRoaXMgbWV0aG9kIGNhbiBiZSBjYWxsZWQgYWdhaW4gd2lsbCBiZSBjYW5jZWxlZAogICAgY2FuY2VsKGRlYm91bmNlSW1tZWRpYXRlKTsKICAgIGBgYAogIAogICAgQG1ldGhvZCBjYW5jZWwKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL3J1bmxvb3AKICAgIEBwYXJhbSB7T2JqZWN0fSB0aW1lciBUaW1lciBvYmplY3QgdG8gY2FuY2VsCiAgICBAcmV0dXJuIHtCb29sZWFufSB0cnVlIGlmIGNhbmNlbGVkIG9yIGZhbHNlL3VuZGVmaW5lZCBpZiBpdCB3YXNuJ3QgZm91bmQKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gY2FuY2VsKHRpbWVyKSB7CiAgICByZXR1cm4gYmFja2J1cm5lci5jYW5jZWwodGltZXIpOwogIH0KICAvKioKICAgIERlbGF5IGNhbGxpbmcgdGhlIHRhcmdldCBtZXRob2QgdW50aWwgdGhlIGRlYm91bmNlIHBlcmlvZCBoYXMgZWxhcHNlZAogICAgd2l0aCBubyBhZGRpdGlvbmFsIGRlYm91bmNlIGNhbGxzLiBJZiBgZGVib3VuY2VgIGlzIGNhbGxlZCBhZ2FpbiBiZWZvcmUKICAgIHRoZSBzcGVjaWZpZWQgdGltZSBoYXMgZWxhcHNlZCwgdGhlIHRpbWVyIGlzIHJlc2V0IGFuZCB0aGUgZW50aXJlIHBlcmlvZAogICAgbXVzdCBwYXNzIGFnYWluIGJlZm9yZSB0aGUgdGFyZ2V0IG1ldGhvZCBpcyBjYWxsZWQuCiAgCiAgICBUaGlzIG1ldGhvZCBzaG91bGQgYmUgdXNlZCB3aGVuIGFuIGV2ZW50IG1heSBiZSBjYWxsZWQgbXVsdGlwbGUgdGltZXMKICAgIGJ1dCB0aGUgYWN0aW9uIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBvbmNlIHdoZW4gdGhlIGV2ZW50IGlzIGRvbmUgZmlyaW5nLgogICAgQSBjb21tb24gZXhhbXBsZSBpcyBmb3Igc2Nyb2xsIGV2ZW50cyB3aGVyZSB5b3Ugb25seSB3YW50IHVwZGF0ZXMgdG8KICAgIGhhcHBlbiBvbmNlIHNjcm9sbGluZyBoYXMgY2Vhc2VkLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgZGVib3VuY2UgfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgCiAgICBmdW5jdGlvbiB3aG9SYW4oKSB7CiAgICAgIGNvbnNvbGUubG9nKHRoaXMubmFtZSArICcgcmFuLicpOwogICAgfQogIAogICAgbGV0IG15Q29udGV4dCA9IHsgbmFtZTogJ2RlYm91bmNlJyB9OwogIAogICAgZGVib3VuY2UobXlDb250ZXh0LCB3aG9SYW4sIDE1MCk7CiAgCiAgICAvLyBsZXNzIHRoYW4gMTUwbXMgcGFzc2VzCiAgICBkZWJvdW5jZShteUNvbnRleHQsIHdob1JhbiwgMTUwKTsKICAKICAgIC8vIDE1MG1zIHBhc3NlcwogICAgLy8gd2hvUmFuIGlzIGludm9rZWQgd2l0aCBjb250ZXh0IG15Q29udGV4dAogICAgLy8gY29uc29sZSBsb2dzICdkZWJvdW5jZSByYW4uJyBvbmUgdGltZS4KICAgIGBgYAogIAogICAgSW1tZWRpYXRlIGFsbG93cyB5b3UgdG8gcnVuIHRoZSBmdW5jdGlvbiBpbW1lZGlhdGVseSwgYnV0IGRlYm91bmNlCiAgICBvdGhlciBjYWxscyBmb3IgdGhpcyBmdW5jdGlvbiB1bnRpbCB0aGUgd2FpdCB0aW1lIGhhcyBlbGFwc2VkLiBJZgogICAgYGRlYm91bmNlYCBpcyBjYWxsZWQgYWdhaW4gYmVmb3JlIHRoZSBzcGVjaWZpZWQgdGltZSBoYXMgZWxhcHNlZCwKICAgIHRoZSB0aW1lciBpcyByZXNldCBhbmQgdGhlIGVudGlyZSBwZXJpb2QgbXVzdCBwYXNzIGFnYWluIGJlZm9yZQogICAgdGhlIG1ldGhvZCBjYW4gYmUgY2FsbGVkIGFnYWluLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgZGVib3VuY2UgfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgCiAgICBmdW5jdGlvbiB3aG9SYW4oKSB7CiAgICAgIGNvbnNvbGUubG9nKHRoaXMubmFtZSArICcgcmFuLicpOwogICAgfQogIAogICAgbGV0IG15Q29udGV4dCA9IHsgbmFtZTogJ2RlYm91bmNlJyB9OwogIAogICAgZGVib3VuY2UobXlDb250ZXh0LCB3aG9SYW4sIDE1MCwgdHJ1ZSk7CiAgCiAgICAvLyBjb25zb2xlIGxvZ3MgJ2RlYm91bmNlIHJhbi4nIG9uZSB0aW1lIGltbWVkaWF0ZWx5LgogICAgLy8gMTAwbXMgcGFzc2VzCiAgICBkZWJvdW5jZShteUNvbnRleHQsIHdob1JhbiwgMTUwLCB0cnVlKTsKICAKICAgIC8vIDE1MG1zIHBhc3NlcyBhbmQgbm90aGluZyBlbHNlIGlzIGxvZ2dlZCB0byB0aGUgY29uc29sZSBhbmQKICAgIC8vIHRoZSBkZWJvdW5jZWUgaXMgbm8gbG9uZ2VyIGJlaW5nIHdhdGNoZWQKICAgIGRlYm91bmNlKG15Q29udGV4dCwgd2hvUmFuLCAxNTAsIHRydWUpOwogIAogICAgLy8gY29uc29sZSBsb2dzICdkZWJvdW5jZSByYW4uJyBvbmUgdGltZSBpbW1lZGlhdGVseS4KICAgIC8vIDE1MG1zIHBhc3NlcyBhbmQgbm90aGluZyBlbHNlIGlzIGxvZ2dlZCB0byB0aGUgY29uc29sZSBhbmQKICAgIC8vIHRoZSBkZWJvdW5jZWUgaXMgbm8gbG9uZ2VyIGJlaW5nIHdhdGNoZWQKICAgIGBgYAogIAogICAgQG1ldGhvZCBkZWJvdW5jZQogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvcnVubG9vcAogICAgQHBhcmFtIHtPYmplY3R9IFt0YXJnZXRdIHRhcmdldCBvZiBtZXRob2QgdG8gaW52b2tlCiAgICBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gbWV0aG9kIFRoZSBtZXRob2QgdG8gaW52b2tlLgogICAgICBNYXkgYmUgYSBmdW5jdGlvbiBvciBhIHN0cmluZy4gSWYgeW91IHBhc3MgYSBzdHJpbmcKICAgICAgdGhlbiBpdCB3aWxsIGJlIGxvb2tlZCB1cCBvbiB0aGUgcGFzc2VkIHRhcmdldC4KICAgIEBwYXJhbSB7T2JqZWN0fSBbYXJncypdIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBwYXNzIHRvIHRoZSB0aW1lb3V0LgogICAgQHBhcmFtIHtOdW1iZXJ9IHdhaXQgTnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0LgogICAgQHBhcmFtIHtCb29sZWFufSBpbW1lZGlhdGUgVHJpZ2dlciB0aGUgZnVuY3Rpb24gb24gdGhlIGxlYWRpbmcgaW5zdGVhZAogICAgICBvZiB0aGUgdHJhaWxpbmcgZWRnZSBvZiB0aGUgd2FpdCBpbnRlcnZhbC4gRGVmYXVsdHMgdG8gZmFsc2UuCiAgICBAcmV0dXJuIHtBcnJheX0gVGltZXIgaW5mb3JtYXRpb24gZm9yIHVzZSBpbiBjYW5jZWxpbmcsIHNlZSBgY2FuY2VsYC4KICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gZGVib3VuY2UoKSB7CiAgICByZXR1cm4gYmFja2J1cm5lci5kZWJvdW5jZS5hcHBseShiYWNrYnVybmVyLCBhcmd1bWVudHMpOwogIH0KICAvKioKICAgIEVuc3VyZSB0aGF0IHRoZSB0YXJnZXQgbWV0aG9kIGlzIG5ldmVyIGNhbGxlZCBtb3JlIGZyZXF1ZW50bHkgdGhhbgogICAgdGhlIHNwZWNpZmllZCBzcGFjaW5nIHBlcmlvZC4gVGhlIHRhcmdldCBtZXRob2QgaXMgY2FsbGVkIGltbWVkaWF0ZWx5LgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgdGhyb3R0bGUgfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgCiAgICBmdW5jdGlvbiB3aG9SYW4oKSB7CiAgICAgIGNvbnNvbGUubG9nKHRoaXMubmFtZSArICcgcmFuLicpOwogICAgfQogIAogICAgbGV0IG15Q29udGV4dCA9IHsgbmFtZTogJ3Rocm90dGxlJyB9OwogIAogICAgdGhyb3R0bGUobXlDb250ZXh0LCB3aG9SYW4sIDE1MCk7CiAgICAvLyB3aG9SYW4gaXMgaW52b2tlZCB3aXRoIGNvbnRleHQgbXlDb250ZXh0CiAgICAvLyBjb25zb2xlIGxvZ3MgJ3Rocm90dGxlIHJhbi4nCiAgCiAgICAvLyA1MG1zIHBhc3NlcwogICAgdGhyb3R0bGUobXlDb250ZXh0LCB3aG9SYW4sIDE1MCk7CiAgCiAgICAvLyA1MG1zIHBhc3NlcwogICAgdGhyb3R0bGUobXlDb250ZXh0LCB3aG9SYW4sIDE1MCk7CiAgCiAgICAvLyAxNTBtcyBwYXNzZXMKICAgIHRocm90dGxlKG15Q29udGV4dCwgd2hvUmFuLCAxNTApOwogICAgLy8gd2hvUmFuIGlzIGludm9rZWQgd2l0aCBjb250ZXh0IG15Q29udGV4dAogICAgLy8gY29uc29sZSBsb2dzICd0aHJvdHRsZSByYW4uJwogICAgYGBgCiAgCiAgICBAbWV0aG9kIHRocm90dGxlCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9ydW5sb29wCiAgICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gdGFyZ2V0IG9mIG1ldGhvZCB0byBpbnZva2UKICAgIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgVGhlIG1ldGhvZCB0byBpbnZva2UuCiAgICAgIE1heSBiZSBhIGZ1bmN0aW9uIG9yIGEgc3RyaW5nLiBJZiB5b3UgcGFzcyBhIHN0cmluZwogICAgICB0aGVuIGl0IHdpbGwgYmUgbG9va2VkIHVwIG9uIHRoZSBwYXNzZWQgdGFyZ2V0LgogICAgQHBhcmFtIHtPYmplY3R9IFthcmdzKl0gT3B0aW9uYWwgYXJndW1lbnRzIHRvIHBhc3MgdG8gdGhlIHRpbWVvdXQuCiAgICBAcGFyYW0ge051bWJlcn0gc3BhY2luZyBOdW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHNwYWNlIG91dCByZXF1ZXN0cy4KICAgIEBwYXJhbSB7Qm9vbGVhbn0gaW1tZWRpYXRlIFRyaWdnZXIgdGhlIGZ1bmN0aW9uIG9uIHRoZSBsZWFkaW5nIGluc3RlYWQKICAgICAgb2YgdGhlIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIHdhaXQgaW50ZXJ2YWwuIERlZmF1bHRzIHRvIHRydWUuCiAgICBAcmV0dXJuIHtBcnJheX0gVGltZXIgaW5mb3JtYXRpb24gZm9yIHVzZSBpbiBjYW5jZWxpbmcsIHNlZSBgY2FuY2VsYC4KICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gdGhyb3R0bGUoKSB7CiAgICByZXR1cm4gYmFja2J1cm5lci50aHJvdHRsZS5hcHBseShiYWNrYnVybmVyLCBhcmd1bWVudHMpOwogIH0KfSk7CmRlZmluZSgiQGVtYmVyL3NlcnZpY2UvaW5kZXgiLCBbImV4cG9ydHMiLCAiQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZSIsICJAZW1iZXIvLWludGVybmFscy9tZXRhbCJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9ydW50aW1lLCBfbWV0YWwpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmluamVjdCA9IGluamVjdDsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICAgQG1vZHVsZSBAZW1iZXIvc2VydmljZQogICBAcHVibGljCiAgICovCgogIC8qKgogICAgQ3JlYXRlcyBhIHByb3BlcnR5IHRoYXQgbGF6aWx5IGxvb2tzIHVwIGEgc2VydmljZSBpbiB0aGUgY29udGFpbmVyLiBUaGVyZSBhcmUKICAgIG5vIHJlc3RyaWN0aW9ucyBhcyB0byB3aGF0IG9iamVjdHMgYSBzZXJ2aWNlIGNhbiBiZSBpbmplY3RlZCBpbnRvLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGFwcC9yb3V0ZXMvYXBwbGljYXRpb24uanMKICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICBpbXBvcnQgeyBpbmplY3QgYXMgc2VydmljZSB9IGZyb20gJ0BlbWJlci9zZXJ2aWNlJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIEFwcGxpY2F0aW9uUm91dGUgZXh0ZW5kcyBSb3V0ZSB7CiAgICAgIEBzZXJ2aWNlKCdhdXRoJykgYXV0aE1hbmFnZXI7CiAgCiAgICAgIG1vZGVsKCkgewogICAgICAgIHJldHVybiB0aGlzLmF1dGhNYW5hZ2VyLmZpbmRDdXJyZW50VXNlcigpOwogICAgICB9CiAgICB9CiAgICBgYGAKICAKICAgIENsYXNzaWMgQ2xhc3MgRXhhbXBsZToKICAKICAgIGBgYGFwcC9yb3V0ZXMvYXBwbGljYXRpb24uanMKICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICBpbXBvcnQgeyBpbmplY3QgYXMgc2VydmljZSB9IGZyb20gJ0BlbWJlci9zZXJ2aWNlJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgIGF1dGhNYW5hZ2VyOiBzZXJ2aWNlKCdhdXRoJyksCiAgCiAgICAgIG1vZGVsKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldCgnYXV0aE1hbmFnZXInKS5maW5kQ3VycmVudFVzZXIoKTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIFRoaXMgZXhhbXBsZSB3aWxsIGNyZWF0ZSBhbiBgYXV0aE1hbmFnZXJgIHByb3BlcnR5IG9uIHRoZSBhcHBsaWNhdGlvbiByb3V0ZQogICAgdGhhdCBsb29rcyB1cCB0aGUgYGF1dGhgIHNlcnZpY2UgaW4gdGhlIGNvbnRhaW5lciwgbWFraW5nIGl0IGVhc2lseSBhY2Nlc3NpYmxlCiAgICBpbiB0aGUgYG1vZGVsYCBob29rLgogIAogICAgQG1ldGhvZCBpbmplY3QKICAgIEBzdGF0aWMKICAgIEBzaW5jZSAxLjEwLjAKICAgIEBmb3IgQGVtYmVyL3NlcnZpY2UKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIChvcHRpb25hbCkgbmFtZSBvZiB0aGUgc2VydmljZSB0byBpbmplY3QsIGRlZmF1bHRzIHRvCiAgICAgICAgICAgdGhlIHByb3BlcnR5J3MgbmFtZQogICAgQHJldHVybiB7Q29tcHV0ZWREZWNvcmF0b3J9IGluamVjdGlvbiBkZWNvcmF0b3IgaW5zdGFuY2UKICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGluamVjdCgpIHsKICAgIHJldHVybiBfbWV0YWwuaW5qZWN0LmFwcGx5KHZvaWQgMCwgWydzZXJ2aWNlJ10uY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICB9CiAgLyoqCiAgICBAY2xhc3MgU2VydmljZQogICAgQGV4dGVuZHMgRW1iZXJPYmplY3QKICAgIEBzaW5jZSAxLjEwLjAKICAgIEBwdWJsaWMKICAqLwoKCiAgdmFyIFNlcnZpY2UgPSBfcnVudGltZS5GcmFtZXdvcmtPYmplY3QuZXh0ZW5kKCk7CgogIFNlcnZpY2UucmVvcGVuQ2xhc3MoewogICAgaXNTZXJ2aWNlRmFjdG9yeTogdHJ1ZQogIH0pOwogICgwLCBfcnVudGltZS5zZXRGcmFtZXdvcmtDbGFzcykoU2VydmljZSk7CiAgdmFyIF9kZWZhdWx0ID0gU2VydmljZTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIkBlbWJlci9zdHJpbmcvaW5kZXgiLCBbImV4cG9ydHMiLCAiQGVtYmVyL3N0cmluZy9saWIvc3RyaW5nX3JlZ2lzdHJ5IiwgIkBlbWJlci8taW50ZXJuYWxzL2Vudmlyb25tZW50IiwgIkBlbWJlci8taW50ZXJuYWxzL3V0aWxzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX3N0cmluZ19yZWdpc3RyeSwgX2Vudmlyb25tZW50LCBfdXRpbHMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmxvYyA9IGxvYzsKICBfZXhwb3J0cy53ID0gdzsKICBfZXhwb3J0cy5kZWNhbWVsaXplID0gZGVjYW1lbGl6ZTsKICBfZXhwb3J0cy5kYXNoZXJpemUgPSBkYXNoZXJpemU7CiAgX2V4cG9ydHMuY2FtZWxpemUgPSBjYW1lbGl6ZTsKICBfZXhwb3J0cy5jbGFzc2lmeSA9IGNsYXNzaWZ5OwogIF9leHBvcnRzLnVuZGVyc2NvcmUgPSB1bmRlcnNjb3JlOwogIF9leHBvcnRzLmNhcGl0YWxpemUgPSBjYXBpdGFsaXplOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9nZXRTdHJpbmdzIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3N0cmluZ19yZWdpc3RyeS5nZXRTdHJpbmdzOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9zZXRTdHJpbmdzIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3N0cmluZ19yZWdpc3RyeS5zZXRTdHJpbmdzOwogICAgfQogIH0pOwoKICAvKioKICBAbW9kdWxlIEBlbWJlci9zdHJpbmcKICAqLwogIHZhciBTVFJJTkdfREFTSEVSSVpFX1JFR0VYUCA9IC9bIF9dL2c7CiAgdmFyIFNUUklOR19EQVNIRVJJWkVfQ0FDSEUgPSBuZXcgX3V0aWxzLkNhY2hlKDEwMDAsIGZ1bmN0aW9uIChrZXkpIHsKICAgIHJldHVybiBkZWNhbWVsaXplKGtleSkucmVwbGFjZShTVFJJTkdfREFTSEVSSVpFX1JFR0VYUCwgJy0nKTsKICB9KTsKICB2YXIgU1RSSU5HX0NBTUVMSVpFX1JFR0VYUF8xID0gLyhcLXxcX3xcLnxccykrKC4pPy9nOwogIHZhciBTVFJJTkdfQ0FNRUxJWkVfUkVHRVhQXzIgPSAvKF58XC8pKFtBLVpdKS9nOwogIHZhciBDQU1FTElaRV9DQUNIRSA9IG5ldyBfdXRpbHMuQ2FjaGUoMTAwMCwgZnVuY3Rpb24gKGtleSkgewogICAgcmV0dXJuIGtleS5yZXBsYWNlKFNUUklOR19DQU1FTElaRV9SRUdFWFBfMSwgZnVuY3Rpb24gKF9tYXRjaCwgX3NlcGFyYXRvciwgY2hyKSB7CiAgICAgIHJldHVybiBjaHIgPyBjaHIudG9VcHBlckNhc2UoKSA6ICcnOwogICAgfSkucmVwbGFjZShTVFJJTkdfQ0FNRUxJWkVfUkVHRVhQXzIsIGZ1bmN0aW9uIChtYXRjaAogICAgLyosIHNlcGFyYXRvciwgY2hyICovCiAgICApIHsKICAgICAgcmV0dXJuIG1hdGNoLnRvTG93ZXJDYXNlKCk7CiAgICB9KTsKICB9KTsKICB2YXIgU1RSSU5HX0NMQVNTSUZZX1JFR0VYUF8xID0gL14oXC18XykrKC4pPy87CiAgdmFyIFNUUklOR19DTEFTU0lGWV9SRUdFWFBfMiA9IC8oLikoXC18XF98XC58XHMpKyguKT8vZzsKICB2YXIgU1RSSU5HX0NMQVNTSUZZX1JFR0VYUF8zID0gLyhefFwvfFwuKShbYS16XSkvZzsKICB2YXIgQ0xBU1NJRllfQ0FDSEUgPSBuZXcgX3V0aWxzLkNhY2hlKDEwMDAsIGZ1bmN0aW9uIChzdHIpIHsKICAgIHZhciByZXBsYWNlMSA9IGZ1bmN0aW9uIHJlcGxhY2UxKF9tYXRjaCwgX3NlcGFyYXRvciwgY2hyKSB7CiAgICAgIHJldHVybiBjaHIgPyAiXyIgKyBjaHIudG9VcHBlckNhc2UoKSA6ICcnOwogICAgfTsKCiAgICB2YXIgcmVwbGFjZTIgPSBmdW5jdGlvbiByZXBsYWNlMihfbWF0Y2gsIGluaXRpYWxDaGFyLCBfc2VwYXJhdG9yLCBjaHIpIHsKICAgICAgcmV0dXJuIGluaXRpYWxDaGFyICsgKGNociA/IGNoci50b1VwcGVyQ2FzZSgpIDogJycpOwogICAgfTsKCiAgICB2YXIgcGFydHMgPSBzdHIuc3BsaXQoJy8nKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHBhcnRzW2ldID0gcGFydHNbaV0ucmVwbGFjZShTVFJJTkdfQ0xBU1NJRllfUkVHRVhQXzEsIHJlcGxhY2UxKS5yZXBsYWNlKFNUUklOR19DTEFTU0lGWV9SRUdFWFBfMiwgcmVwbGFjZTIpOwogICAgfQoKICAgIHJldHVybiBwYXJ0cy5qb2luKCcvJykucmVwbGFjZShTVFJJTkdfQ0xBU1NJRllfUkVHRVhQXzMsIGZ1bmN0aW9uIChtYXRjaAogICAgLyosIHNlcGFyYXRvciwgY2hyICovCiAgICApIHsKICAgICAgcmV0dXJuIG1hdGNoLnRvVXBwZXJDYXNlKCk7CiAgICB9KTsKICB9KTsKICB2YXIgU1RSSU5HX1VOREVSU0NPUkVfUkVHRVhQXzEgPSAvKFthLXpcZF0pKFtBLVpdKykvZzsKICB2YXIgU1RSSU5HX1VOREVSU0NPUkVfUkVHRVhQXzIgPSAvXC18XHMrL2c7CiAgdmFyIFVOREVSU0NPUkVfQ0FDSEUgPSBuZXcgX3V0aWxzLkNhY2hlKDEwMDAsIGZ1bmN0aW9uIChzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZShTVFJJTkdfVU5ERVJTQ09SRV9SRUdFWFBfMSwgJyQxXyQyJykucmVwbGFjZShTVFJJTkdfVU5ERVJTQ09SRV9SRUdFWFBfMiwgJ18nKS50b0xvd2VyQ2FzZSgpOwogIH0pOwogIHZhciBTVFJJTkdfQ0FQSVRBTElaRV9SRUdFWFAgPSAvKF58XC8pKFthLXpcdTAwQzAtXHUwMjRGXSkvZzsKICB2YXIgQ0FQSVRBTElaRV9DQUNIRSA9IG5ldyBfdXRpbHMuQ2FjaGUoMTAwMCwgZnVuY3Rpb24gKHN0cikgewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKFNUUklOR19DQVBJVEFMSVpFX1JFR0VYUCwgZnVuY3Rpb24gKG1hdGNoCiAgICAvKiwgc2VwYXJhdG9yLCBjaHIgKi8KICAgICkgewogICAgICByZXR1cm4gbWF0Y2gudG9VcHBlckNhc2UoKTsKICAgIH0pOwogIH0pOwogIHZhciBTVFJJTkdfREVDQU1FTElaRV9SRUdFWFAgPSAvKFthLXpcZF0pKFtBLVpdKS9nOwogIHZhciBERUNBTUVMSVpFX0NBQ0hFID0gbmV3IF91dGlscy5DYWNoZSgxMDAwLCBmdW5jdGlvbiAoc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoU1RSSU5HX0RFQ0FNRUxJWkVfUkVHRVhQLCAnJDFfJDInKS50b0xvd2VyQ2FzZSgpOwogIH0pOwogIC8qKgogICAgRGVmaW5lcyBzdHJpbmcgaGVscGVyIG1ldGhvZHMgaW5jbHVkaW5nIHN0cmluZyBmb3JtYXR0aW5nIGFuZCBsb2NhbGl6YXRpb24uCiAgICBVbmxlc3MgYEVtYmVyRU5WLkVYVEVORF9QUk9UT1RZUEVTLlN0cmluZ2AgaXMgYGZhbHNlYCB0aGVzZSBtZXRob2RzIHdpbGwgYWxzbyBiZQogICAgYWRkZWQgdG8gdGhlIGBTdHJpbmcucHJvdG90eXBlYCBhcyB3ZWxsLgogIAogICAgQGNsYXNzIFN0cmluZwogICAgQHB1YmxpYwogICovCgogIGZ1bmN0aW9uIF9mbXQoc3RyLCBmb3JtYXRzKSB7CiAgICAvLyBmaXJzdCwgcmVwbGFjZSBhbnkgT1JERVJFRCByZXBsYWNlbWVudHMuCiAgICB2YXIgaWR4ID0gMDsgLy8gdGhlIGN1cnJlbnQgaW5kZXggZm9yIG5vbi1udW1lcmljYWwgcmVwbGFjZW1lbnRzCgogICAgcmV0dXJuIHN0ci5yZXBsYWNlKC8lQChbMC05XSspPy9nLCBmdW5jdGlvbiAoX3MsIGFyZ0luZGV4KSB7CiAgICAgIHZhciBpID0gYXJnSW5kZXggPyBwYXJzZUludChhcmdJbmRleCwgMTApIC0gMSA6IGlkeCsrOwogICAgICB2YXIgciA9IGkgPCBmb3JtYXRzLmxlbmd0aCA/IGZvcm1hdHNbaV0gOiB1bmRlZmluZWQ7CiAgICAgIHJldHVybiB0eXBlb2YgciA9PT0gJ3N0cmluZycgPyByIDogciA9PT0gbnVsbCA/ICcobnVsbCknIDogciA9PT0gdW5kZWZpbmVkID8gJycgOiBTdHJpbmcocik7CiAgICB9KTsKICB9CiAgLyoqCiAgICBGb3JtYXRzIHRoZSBwYXNzZWQgc3RyaW5nLCBidXQgZmlyc3QgbG9va3MgdXAgdGhlIHN0cmluZyBpbiB0aGUgbG9jYWxpemVkCiAgICBzdHJpbmdzIGhhc2guIFRoaXMgaXMgYSBjb252ZW5pZW50IHdheSB0byBsb2NhbGl6ZSB0ZXh0LgogIAogICAgTm90ZSB0aGF0IGl0IGlzIHRyYWRpdGlvbmFsIGJ1dCBub3QgcmVxdWlyZWQgdG8gcHJlZml4IGxvY2FsaXplZCBzdHJpbmcKICAgIGtleXMgd2l0aCBhbiB1bmRlcnNjb3JlIG9yIG90aGVyIGNoYXJhY3RlciBzbyB5b3UgY2FuIGVhc2lseSBpZGVudGlmeQogICAgbG9jYWxpemVkIHN0cmluZ3MuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBsb2MgfSBmcm9tICdAZW1iZXIvc3RyaW5nJzsKICAKICAgIEVtYmVyLlNUUklOR1MgPSB7CiAgICAgICdfSGVsbG8gV29ybGQnOiAnQm9uam91ciBsZSBtb25kZScsCiAgICAgICdfSGVsbG8gJUAgJUAnOiAnQm9uam91ciAlQCAlQCcKICAgIH07CiAgCiAgICBsb2MoIl9IZWxsbyBXb3JsZCIpOyAgLy8gJ0JvbmpvdXIgbGUgbW9uZGUnOwogICAgbG9jKCJfSGVsbG8gJUAgJUAiLCBbIkpvaG4iLCAiU21pdGgiXSk7ICAvLyAiQm9uam91ciBKb2huIFNtaXRoIjsKICAgIGBgYAogIAogICAgQG1ldGhvZCBsb2MKICAgIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN0cmluZyB0byBmb3JtYXQKICAgIEBwYXJhbSB7QXJyYXl9IGZvcm1hdHMgT3B0aW9uYWwgYXJyYXkgb2YgcGFyYW1ldGVycyB0byBpbnRlcnBvbGF0ZSBpbnRvIHN0cmluZy4KICAgIEByZXR1cm4ge1N0cmluZ30gZm9ybWF0dGVkIHN0cmluZwogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiBsb2Moc3RyLCBmb3JtYXRzKSB7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZm9ybWF0cykgfHwgYXJndW1lbnRzLmxlbmd0aCA+IDIpIHsKICAgICAgZm9ybWF0cyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICB9CgogICAgc3RyID0gKDAsIF9zdHJpbmdfcmVnaXN0cnkuZ2V0U3RyaW5nKShzdHIpIHx8IHN0cjsKICAgIHJldHVybiBfZm10KHN0ciwgZm9ybWF0cyk7CiAgfQogIC8qKgogICAgU3BsaXRzIGEgc3RyaW5nIGludG8gc2VwYXJhdGUgdW5pdHMgc2VwYXJhdGVkIGJ5IHNwYWNlcywgZWxpbWluYXRpbmcgYW55CiAgICBlbXB0eSBzdHJpbmdzIGluIHRoZSBwcm9jZXNzLiBUaGlzIGlzIGEgY29udmVuaWVuY2UgbWV0aG9kIGZvciBzcGxpdCB0aGF0CiAgICBpcyBtb3N0bHkgdXNlZnVsIHdoZW4gYXBwbGllZCB0byB0aGUgYFN0cmluZy5wcm90b3R5cGVgLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgdyB9IGZyb20gJ0BlbWJlci9zdHJpbmcnOwogIAogICAgdygiYWxwaGEgYmV0YSBnYW1tYSIpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgIGNvbnNvbGUubG9nKGtleSk7CiAgICB9KTsKICAKICAgIC8vID4gYWxwaGEKICAgIC8vID4gYmV0YQogICAgLy8gPiBnYW1tYQogICAgYGBgCiAgCiAgICBAbWV0aG9kIHcKICAgIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN0cmluZyB0byBzcGxpdAogICAgQHJldHVybiB7QXJyYXl9IGFycmF5IGNvbnRhaW5pbmcgdGhlIHNwbGl0IHN0cmluZ3MKICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gdyhzdHIpIHsKICAgIHJldHVybiBzdHIuc3BsaXQoL1xzKy8pOwogIH0KICAvKioKICAgIENvbnZlcnRzIGEgY2FtZWxpemVkIHN0cmluZyBpbnRvIGFsbCBsb3dlciBjYXNlIHNlcGFyYXRlZCBieSB1bmRlcnNjb3Jlcy4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGRlY2FtZWxpemUgfSBmcm9tICdAZW1iZXIvc3RyaW5nJzsKICAKICAgIGRlY2FtZWxpemUoJ2lubmVySFRNTCcpOyAgICAgICAgICAvLyAnaW5uZXJfaHRtbCcKICAgIGRlY2FtZWxpemUoJ2FjdGlvbl9uYW1lJyk7ICAgICAgICAvLyAnYWN0aW9uX25hbWUnCiAgICBkZWNhbWVsaXplKCdjc3MtY2xhc3MtbmFtZScpOyAgICAgLy8gJ2Nzcy1jbGFzcy1uYW1lJwogICAgZGVjYW1lbGl6ZSgnbXkgZmF2b3JpdGUgaXRlbXMnKTsgIC8vICdteSBmYXZvcml0ZSBpdGVtcycKICAgIGBgYAogIAogICAgQG1ldGhvZCBkZWNhbWVsaXplCiAgICBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdHJpbmcgdG8gZGVjYW1lbGl6ZS4KICAgIEByZXR1cm4ge1N0cmluZ30gdGhlIGRlY2FtZWxpemVkIHN0cmluZy4KICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gZGVjYW1lbGl6ZShzdHIpIHsKICAgIHJldHVybiBERUNBTUVMSVpFX0NBQ0hFLmdldChzdHIpOwogIH0KICAvKioKICAgIFJlcGxhY2VzIHVuZGVyc2NvcmVzLCBzcGFjZXMsIG9yIGNhbWVsQ2FzZSB3aXRoIGRhc2hlcy4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGRhc2hlcml6ZSB9IGZyb20gJ0BlbWJlci9zdHJpbmcnOwogIAogICAgZGFzaGVyaXplKCdpbm5lckhUTUwnKTsgICAgICAgICAgICAgICAgLy8gJ2lubmVyLWh0bWwnCiAgICBkYXNoZXJpemUoJ2FjdGlvbl9uYW1lJyk7ICAgICAgICAgICAgICAvLyAnYWN0aW9uLW5hbWUnCiAgICBkYXNoZXJpemUoJ2Nzcy1jbGFzcy1uYW1lJyk7ICAgICAgICAgICAvLyAnY3NzLWNsYXNzLW5hbWUnCiAgICBkYXNoZXJpemUoJ215IGZhdm9yaXRlIGl0ZW1zJyk7ICAgICAgICAvLyAnbXktZmF2b3JpdGUtaXRlbXMnCiAgICBkYXNoZXJpemUoJ3ByaXZhdGVEb2NzL293bmVySW52b2ljZSc7ICAvLyAncHJpdmF0ZS1kb2NzL293bmVyLWludm9pY2UnCiAgICBgYGAKICAKICAgIEBtZXRob2QgZGFzaGVyaXplCiAgICBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdHJpbmcgdG8gZGFzaGVyaXplLgogICAgQHJldHVybiB7U3RyaW5nfSB0aGUgZGFzaGVyaXplZCBzdHJpbmcuCiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIGRhc2hlcml6ZShzdHIpIHsKICAgIHJldHVybiBTVFJJTkdfREFTSEVSSVpFX0NBQ0hFLmdldChzdHIpOwogIH0KICAvKioKICAgIFJldHVybnMgdGhlIGxvd2VyQ2FtZWxDYXNlIGZvcm0gb2YgYSBzdHJpbmcuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBjYW1lbGl6ZSB9IGZyb20gJ0BlbWJlci9zdHJpbmcnOwogIAogICAgY2FtZWxpemUoJ2lubmVySFRNTCcpOyAgICAgICAgICAgICAgICAgICAvLyAnaW5uZXJIVE1MJwogICAgY2FtZWxpemUoJ2FjdGlvbl9uYW1lJyk7ICAgICAgICAgICAgICAgICAvLyAnYWN0aW9uTmFtZScKICAgIGNhbWVsaXplKCdjc3MtY2xhc3MtbmFtZScpOyAgICAgICAgICAgICAgLy8gJ2Nzc0NsYXNzTmFtZScKICAgIGNhbWVsaXplKCdteSBmYXZvcml0ZSBpdGVtcycpOyAgICAgICAgICAgLy8gJ215RmF2b3JpdGVJdGVtcycKICAgIGNhbWVsaXplKCdNeSBGYXZvcml0ZSBJdGVtcycpOyAgICAgICAgICAgLy8gJ215RmF2b3JpdGVJdGVtcycKICAgIGNhbWVsaXplKCdwcml2YXRlLWRvY3Mvb3duZXItaW52b2ljZScpOyAgLy8gJ3ByaXZhdGVEb2NzL293bmVySW52b2ljZScKICAgIGBgYAogIAogICAgQG1ldGhvZCBjYW1lbGl6ZQogICAgQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3RyaW5nIHRvIGNhbWVsaXplLgogICAgQHJldHVybiB7U3RyaW5nfSB0aGUgY2FtZWxpemVkIHN0cmluZy4KICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gY2FtZWxpemUoc3RyKSB7CiAgICByZXR1cm4gQ0FNRUxJWkVfQ0FDSEUuZ2V0KHN0cik7CiAgfQogIC8qKgogICAgUmV0dXJucyB0aGUgVXBwZXJDYW1lbENhc2UgZm9ybSBvZiBhIHN0cmluZy4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGNsYXNzaWZ5IH0gZnJvbSAnQGVtYmVyL3N0cmluZyc7CiAgCiAgICBjbGFzc2lmeSgnaW5uZXJIVE1MJyk7ICAgICAgICAgICAgICAgICAgIC8vICdJbm5lckhUTUwnCiAgICBjbGFzc2lmeSgnYWN0aW9uX25hbWUnKTsgICAgICAgICAgICAgICAgIC8vICdBY3Rpb25OYW1lJwogICAgY2xhc3NpZnkoJ2Nzcy1jbGFzcy1uYW1lJyk7ICAgICAgICAgICAgICAvLyAnQ3NzQ2xhc3NOYW1lJwogICAgY2xhc3NpZnkoJ215IGZhdm9yaXRlIGl0ZW1zJyk7ICAgICAgICAgICAvLyAnTXlGYXZvcml0ZUl0ZW1zJwogICAgY2xhc3NpZnkoJ3ByaXZhdGUtZG9jcy9vd25lci1pbnZvaWNlJyk7ICAvLyAnUHJpdmF0ZURvY3MvT3duZXJJbnZvaWNlJwogICAgYGBgCiAgCiAgICBAbWV0aG9kIGNsYXNzaWZ5CiAgICBAcGFyYW0ge1N0cmluZ30gc3RyIHRoZSBzdHJpbmcgdG8gY2xhc3NpZnkKICAgIEByZXR1cm4ge1N0cmluZ30gdGhlIGNsYXNzaWZpZWQgc3RyaW5nCiAgICBAcHVibGljCiAgKi8KCgogIGZ1bmN0aW9uIGNsYXNzaWZ5KHN0cikgewogICAgcmV0dXJuIENMQVNTSUZZX0NBQ0hFLmdldChzdHIpOwogIH0KICAvKioKICAgIE1vcmUgZ2VuZXJhbCB0aGFuIGRlY2FtZWxpemUuIFJldHVybnMgdGhlIGxvd2VyXF9jYXNlXF9hbmRcX3VuZGVyc2NvcmVkCiAgICBmb3JtIG9mIGEgc3RyaW5nLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgdW5kZXJzY29yZSB9IGZyb20gJ0BlbWJlci9zdHJpbmcnOwogIAogICAgdW5kZXJzY29yZSgnaW5uZXJIVE1MJyk7ICAgICAgICAgICAgICAgICAvLyAnaW5uZXJfaHRtbCcKICAgIHVuZGVyc2NvcmUoJ2FjdGlvbl9uYW1lJyk7ICAgICAgICAgICAgICAgLy8gJ2FjdGlvbl9uYW1lJwogICAgdW5kZXJzY29yZSgnY3NzLWNsYXNzLW5hbWUnKTsgICAgICAgICAgICAvLyAnY3NzX2NsYXNzX25hbWUnCiAgICB1bmRlcnNjb3JlKCdteSBmYXZvcml0ZSBpdGVtcycpOyAgICAgICAgIC8vICdteV9mYXZvcml0ZV9pdGVtcycKICAgIHVuZGVyc2NvcmUoJ3ByaXZhdGVEb2NzL293bmVySW52b2ljZScpOyAgLy8gJ3ByaXZhdGVfZG9jcy9vd25lcl9pbnZvaWNlJwogICAgYGBgCiAgCiAgICBAbWV0aG9kIHVuZGVyc2NvcmUKICAgIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN0cmluZyB0byB1bmRlcnNjb3JlLgogICAgQHJldHVybiB7U3RyaW5nfSB0aGUgdW5kZXJzY29yZWQgc3RyaW5nLgogICAgQHB1YmxpYwogICovCgoKICBmdW5jdGlvbiB1bmRlcnNjb3JlKHN0cikgewogICAgcmV0dXJuIFVOREVSU0NPUkVfQ0FDSEUuZ2V0KHN0cik7CiAgfQogIC8qKgogICAgUmV0dXJucyB0aGUgQ2FwaXRhbGl6ZWQgZm9ybSBvZiBhIHN0cmluZwogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgY2FwaXRhbGl6ZSB9IGZyb20gJ0BlbWJlci9zdHJpbmcnOwogIAogICAgY2FwaXRhbGl6ZSgnaW5uZXJIVE1MJykgICAgICAgICAgICAgICAgIC8vICdJbm5lckhUTUwnCiAgICBjYXBpdGFsaXplKCdhY3Rpb25fbmFtZScpICAgICAgICAgICAgICAgLy8gJ0FjdGlvbl9uYW1lJwogICAgY2FwaXRhbGl6ZSgnY3NzLWNsYXNzLW5hbWUnKSAgICAgICAgICAgIC8vICdDc3MtY2xhc3MtbmFtZScKICAgIGNhcGl0YWxpemUoJ215IGZhdm9yaXRlIGl0ZW1zJykgICAgICAgICAvLyAnTXkgZmF2b3JpdGUgaXRlbXMnCiAgICBjYXBpdGFsaXplKCdwcml2YXRlRG9jcy9vd25lckludm9pY2UnKTsgLy8gJ1ByaXZhdGVEb2NzL293bmVySW52b2ljZScKICAgIGBgYAogIAogICAgQG1ldGhvZCBjYXBpdGFsaXplCiAgICBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdHJpbmcgdG8gY2FwaXRhbGl6ZS4KICAgIEByZXR1cm4ge1N0cmluZ30gVGhlIGNhcGl0YWxpemVkIHN0cmluZy4KICAgIEBwdWJsaWMKICAqLwoKCiAgZnVuY3Rpb24gY2FwaXRhbGl6ZShzdHIpIHsKICAgIHJldHVybiBDQVBJVEFMSVpFX0NBQ0hFLmdldChzdHIpOwogIH0KCiAgaWYgKF9lbnZpcm9ubWVudC5FTlYuRVhURU5EX1BST1RPVFlQRVMuU3RyaW5nKSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhTdHJpbmcucHJvdG90eXBlLCB7CiAgICAgIC8qKgogICAgICAgIFNlZSBbU3RyaW5nLnddKC9lbWJlci9yZWxlYXNlL2NsYXNzZXMvU3RyaW5nL21ldGhvZHMvdz9hbmNob3I9dykuCiAgICAgICAgICAgICBAbWV0aG9kIHcKICAgICAgICBAZm9yIEBlbWJlci9zdHJpbmcKICAgICAgICBAc3RhdGljCiAgICAgICAgQHByaXZhdGUKICAgICAgKi8KICAgICAgdzogewogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICB3cml0ZWFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgcmV0dXJuIHcodGhpcyk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgU2VlIFtTdHJpbmcubG9jXSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL1N0cmluZy9tZXRob2RzL2xvYz9hbmNob3I9bG9jKS4KICAgICAgICAgICAgIEBtZXRob2QgbG9jCiAgICAgICAgQGZvciBAZW1iZXIvc3RyaW5nCiAgICAgICAgQHN0YXRpYwogICAgICAgIEBwcml2YXRlCiAgICAgICovCiAgICAgIGxvYzogewogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICB3cml0ZWFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGxvYyh0aGlzLCBhcmdzKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICBTZWUgW1N0cmluZy5jYW1lbGl6ZV0oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9TdHJpbmcvbWV0aG9kcy9jYW1lbGl6ZT9hbmNob3I9Y2FtZWxpemUpLgogICAgICAgICAgICAgQG1ldGhvZCBjYW1lbGl6ZQogICAgICAgIEBmb3IgQGVtYmVyL3N0cmluZwogICAgICAgIEBzdGF0aWMKICAgICAgICBAcHJpdmF0ZQogICAgICAqLwogICAgICBjYW1lbGl6ZTogewogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICB3cml0ZWFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgcmV0dXJuIGNhbWVsaXplKHRoaXMpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIFNlZSBbU3RyaW5nLmRlY2FtZWxpemVdKC9lbWJlci9yZWxlYXNlL2NsYXNzZXMvU3RyaW5nL21ldGhvZHMvZGVjYW1lbGl6ZT9hbmNob3I9ZGVjYW1lbGl6ZSkuCiAgICAgICAgICAgICBAbWV0aG9kIGRlY2FtZWxpemUKICAgICAgICBAZm9yIEBlbWJlci9zdHJpbmcKICAgICAgICBAc3RhdGljCiAgICAgICAgQHByaXZhdGUKICAgICAgKi8KICAgICAgZGVjYW1lbGl6ZTogewogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICB3cml0ZWFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgcmV0dXJuIGRlY2FtZWxpemUodGhpcyk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgU2VlIFtTdHJpbmcuZGFzaGVyaXplXSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL1N0cmluZy9tZXRob2RzL2Rhc2hlcml6ZT9hbmNob3I9ZGFzaGVyaXplKS4KICAgICAgICAgICAgIEBtZXRob2QgZGFzaGVyaXplCiAgICAgICAgQGZvciBAZW1iZXIvc3RyaW5nCiAgICAgICAgQHN0YXRpYwogICAgICAgIEBwcml2YXRlCiAgICAgICovCiAgICAgIGRhc2hlcml6ZTogewogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICB3cml0ZWFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgcmV0dXJuIGRhc2hlcml6ZSh0aGlzKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICBTZWUgW1N0cmluZy51bmRlcnNjb3JlXSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL1N0cmluZy9tZXRob2RzL3VuZGVyc2NvcmU/YW5jaG9yPXVuZGVyc2NvcmUpLgogICAgICAgICAgICAgQG1ldGhvZCB1bmRlcnNjb3JlCiAgICAgICAgQGZvciBAZW1iZXIvc3RyaW5nCiAgICAgICAgQHN0YXRpYwogICAgICAgIEBwcml2YXRlCiAgICAgICovCiAgICAgIHVuZGVyc2NvcmU6IHsKICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgd3JpdGVhYmxlOiB0cnVlLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgIHJldHVybiB1bmRlcnNjb3JlKHRoaXMpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIFNlZSBbU3RyaW5nLmNsYXNzaWZ5XSgvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL1N0cmluZy9tZXRob2RzL2NsYXNzaWZ5P2FuY2hvcj1jbGFzc2lmeSkuCiAgICAgICAgICAgICBAbWV0aG9kIGNsYXNzaWZ5CiAgICAgICAgQGZvciBAZW1iZXIvc3RyaW5nCiAgICAgICAgQHN0YXRpYwogICAgICAgIEBwcml2YXRlCiAgICAgICovCiAgICAgIGNsYXNzaWZ5OiB7CiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgIHdyaXRlYWJsZTogdHJ1ZSwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICByZXR1cm4gY2xhc3NpZnkodGhpcyk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgU2VlIFtTdHJpbmcuY2FwaXRhbGl6ZV0oL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9TdHJpbmcvbWV0aG9kcy9jYXBpdGFsaXplP2FuY2hvcj1jYXBpdGFsaXplKS4KICAgICAgICAgICAgIEBtZXRob2QgY2FwaXRhbGl6ZQogICAgICAgIEBmb3IgQGVtYmVyL3N0cmluZwogICAgICAgIEBzdGF0aWMKICAgICAgICBAcHJpdmF0ZQogICAgICAqLwogICAgICBjYXBpdGFsaXplOiB7CiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgIHdyaXRlYWJsZTogdHJ1ZSwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICByZXR1cm4gY2FwaXRhbGl6ZSh0aGlzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KfSk7CmRlZmluZSgiQGVtYmVyL3N0cmluZy9saWIvc3RyaW5nX3JlZ2lzdHJ5IiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuc2V0U3RyaW5ncyA9IHNldFN0cmluZ3M7CiAgX2V4cG9ydHMuZ2V0U3RyaW5ncyA9IGdldFN0cmluZ3M7CiAgX2V4cG9ydHMuZ2V0U3RyaW5nID0gZ2V0U3RyaW5nOwogIC8vIFNUQVRFIHdpdGhpbiBhIG1vZHVsZSBpcyBmcm93bmVkIHVwb24sIHRoaXMgZXhpc3RzCiAgLy8gdG8gc3VwcG9ydCBFbWJlci5TVFJJTkdTIGJ1dCBzaGllbGQgZW1iZXIgaW50ZXJuYWxzIGZyb20gdGhpcyBsZWdhY3kgZ2xvYmFsCiAgLy8gQVBJLgogIHZhciBTVFJJTkdTID0ge307CgogIGZ1bmN0aW9uIHNldFN0cmluZ3Moc3RyaW5ncykgewogICAgU1RSSU5HUyA9IHN0cmluZ3M7CiAgfQoKICBmdW5jdGlvbiBnZXRTdHJpbmdzKCkgewogICAgcmV0dXJuIFNUUklOR1M7CiAgfQoKICBmdW5jdGlvbiBnZXRTdHJpbmcobmFtZSkgewogICAgcmV0dXJuIFNUUklOR1NbbmFtZV07CiAgfQp9KTsKZGVmaW5lKCJAZ2xpbW1lci9lbmNvZGVyIiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuSW5zdHJ1Y3Rpb25FbmNvZGVyID0gdm9pZCAwOwoKICB2YXIgSW5zdHJ1Y3Rpb25FbmNvZGVyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gSW5zdHJ1Y3Rpb25FbmNvZGVyKGJ1ZmZlcikgewogICAgICB0aGlzLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgdGhpcy50eXBlUG9zID0gMDsKICAgICAgdGhpcy5zaXplID0gMDsKICAgIH0KCiAgICB2YXIgX3Byb3RvID0gSW5zdHJ1Y3Rpb25FbmNvZGVyLnByb3RvdHlwZTsKCiAgICBfcHJvdG8uZW5jb2RlID0gZnVuY3Rpb24gZW5jb2RlKHR5cGUsIG1hY2hpbmUpIHsKICAgICAgaWYgKHR5cGUgPiAyNTUKICAgICAgLyogVFlQRV9TSVpFICovCiAgICAgICkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPcGNvZGUgdHlwZSBvdmVyIDgtYml0cy4gR290ICIgKyB0eXBlICsgIi4iKTsKICAgICAgICB9CgogICAgICB0aGlzLmJ1ZmZlci5wdXNoKHR5cGUgfCBtYWNoaW5lIHwgYXJndW1lbnRzLmxlbmd0aCAtIDIgPDwgOAogICAgICAvKiBBUkdfU0hJRlQgKi8KICAgICAgKTsKICAgICAgdGhpcy50eXBlUG9zID0gdGhpcy5idWZmZXIubGVuZ3RoIC0gMTsKCiAgICAgIGZvciAodmFyIGkgPSAyOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIG9wID0gYXJndW1lbnRzW2ldOwoKICAgICAgICBpZiAodHlwZW9mIG9wID09PSAnbnVtYmVyJyAmJiBvcCA+IDQyOTQ5NjcyOTUKICAgICAgICAvKiBNQVhfU0laRSAqLwogICAgICAgICkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9wZXJhbmQgb3ZlciAzMi1iaXRzLiBHb3QgIiArIG9wICsgIi4iKTsKICAgICAgICAgIH0KCiAgICAgICAgdGhpcy5idWZmZXIucHVzaChvcCk7CiAgICAgIH0KCiAgICAgIHRoaXMuc2l6ZSA9IHRoaXMuYnVmZmVyLmxlbmd0aDsKICAgIH07CgogICAgX3Byb3RvLnBhdGNoID0gZnVuY3Rpb24gcGF0Y2gocG9zaXRpb24sIHRhcmdldCkgewogICAgICBpZiAodGhpcy5idWZmZXJbcG9zaXRpb24gKyAxXSA9PT0gLTEpIHsKICAgICAgICB0aGlzLmJ1ZmZlcltwb3NpdGlvbiArIDFdID0gdGFyZ2V0OwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignVHJ5aW5nIHRvIHBhdGNoIG9wZXJhbmQgaW4gcG9wdWxhdGVkIHNsb3QgaW5zdGVhZCBvZiBhIHJlc2VydmVkIHNsb3QuJyk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLnBhdGNoV2l0aCA9IGZ1bmN0aW9uIHBhdGNoV2l0aChwb3NpdGlvbiwgdGFyZ2V0LCBvcGVyYW5kKSB7CiAgICAgIGlmICh0aGlzLmJ1ZmZlcltwb3NpdGlvbiArIDFdID09PSAtMSkgewogICAgICAgIHRoaXMuYnVmZmVyW3Bvc2l0aW9uICsgMV0gPSB0YXJnZXQ7CiAgICAgICAgdGhpcy5idWZmZXJbcG9zaXRpb24gKyAyXSA9IG9wZXJhbmQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcnlpbmcgdG8gcGF0Y2ggb3BlcmFuZCBpbiBwb3B1bGF0ZWQgc2xvdCBpbnN0ZWFkIG9mIGEgcmVzZXJ2ZWQgc2xvdC4nKTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gSW5zdHJ1Y3Rpb25FbmNvZGVyOwogIH0oKTsKCiAgX2V4cG9ydHMuSW5zdHJ1Y3Rpb25FbmNvZGVyID0gSW5zdHJ1Y3Rpb25FbmNvZGVyOwp9KTsKZGVmaW5lKCJAZ2xpbW1lci9sb3ctbGV2ZWwiLCBbImV4cG9ydHMiXSwgZnVuY3Rpb24gKF9leHBvcnRzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5TdGFjayA9IF9leHBvcnRzLlN0b3JhZ2UgPSB2b2lkIDA7CgogIHZhciBTdG9yYWdlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gU3RvcmFnZSgpIHsKICAgICAgdGhpcy5hcnJheSA9IFtdOwogICAgICB0aGlzLm5leHQgPSAwOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBTdG9yYWdlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8uYWRkID0gZnVuY3Rpb24gYWRkKGVsZW1lbnQpIHsKICAgICAgdmFyIHNsb3QgPSB0aGlzLm5leHQsCiAgICAgICAgICBhcnJheSA9IHRoaXMuYXJyYXk7CgogICAgICBpZiAoc2xvdCA9PT0gYXJyYXkubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5uZXh0Kys7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHByZXYgPSBhcnJheVtzbG90XTsKICAgICAgICB0aGlzLm5leHQgPSBwcmV2OwogICAgICB9CgogICAgICB0aGlzLmFycmF5W3Nsb3RdID0gZWxlbWVudDsKICAgICAgcmV0dXJuIHNsb3Q7CiAgICB9OwoKICAgIF9wcm90by5kZXJlZiA9IGZ1bmN0aW9uIGRlcmVmKHBvaW50ZXIpIHsKICAgICAgcmV0dXJuIHRoaXMuYXJyYXlbcG9pbnRlcl07CiAgICB9OwoKICAgIF9wcm90by5kcm9wID0gZnVuY3Rpb24gZHJvcChwb2ludGVyKSB7CiAgICAgIHRoaXMuYXJyYXlbcG9pbnRlcl0gPSB0aGlzLm5leHQ7CiAgICAgIHRoaXMubmV4dCA9IHBvaW50ZXI7CiAgICB9OwoKICAgIHJldHVybiBTdG9yYWdlOwogIH0oKTsKCiAgX2V4cG9ydHMuU3RvcmFnZSA9IFN0b3JhZ2U7CgogIHZhciBTdGFjayA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFN0YWNrKHZlYykgewogICAgICBpZiAodmVjID09PSB2b2lkIDApIHsKICAgICAgICB2ZWMgPSBbXTsKICAgICAgfQoKICAgICAgdGhpcy52ZWMgPSB2ZWM7CiAgICB9CgogICAgdmFyIF9wcm90bzIgPSBTdGFjay5wcm90b3R5cGU7CgogICAgX3Byb3RvMi5jbG9uZSA9IGZ1bmN0aW9uIGNsb25lKCkgewogICAgICByZXR1cm4gbmV3IFN0YWNrKHRoaXMudmVjLnNsaWNlKCkpOwogICAgfTsKCiAgICBfcHJvdG8yLnNsaWNlRnJvbSA9IGZ1bmN0aW9uIHNsaWNlRnJvbShzdGFydCkgewogICAgICByZXR1cm4gbmV3IFN0YWNrKHRoaXMudmVjLnNsaWNlKHN0YXJ0KSk7CiAgICB9OwoKICAgIF9wcm90bzIuc2xpY2UgPSBmdW5jdGlvbiBzbGljZShzdGFydCwgZW5kKSB7CiAgICAgIHJldHVybiBuZXcgU3RhY2sodGhpcy52ZWMuc2xpY2Uoc3RhcnQsIGVuZCkpOwogICAgfTsKCiAgICBfcHJvdG8yLmNvcHkgPSBmdW5jdGlvbiBjb3B5KGZyb20sIHRvKSB7CiAgICAgIHRoaXMudmVjW3RvXSA9IHRoaXMudmVjW2Zyb21dOwogICAgfSAvLyBUT0RPOiBob3cgdG8gbW9kZWwgdTY0IGFyZ3VtZW50PwogICAgOwoKICAgIF9wcm90bzIud3JpdGVSYXcgPSBmdW5jdGlvbiB3cml0ZVJhdyhwb3MsIHZhbHVlKSB7CiAgICAgIC8vIFRPRE86IEdyb3c/CiAgICAgIHRoaXMudmVjW3Bvc10gPSB2YWx1ZTsKICAgIH0gLy8gVE9ETzogcGFydGlhbGx5IGRlY29kZWQgZW51bT8KICAgIDsKCiAgICBfcHJvdG8yLmdldFJhdyA9IGZ1bmN0aW9uIGdldFJhdyhwb3MpIHsKICAgICAgcmV0dXJuIHRoaXMudmVjW3Bvc107CiAgICB9OwoKICAgIF9wcm90bzIucmVzZXQgPSBmdW5jdGlvbiByZXNldCgpIHsKICAgICAgdGhpcy52ZWMubGVuZ3RoID0gMDsKICAgIH07CgogICAgX3Byb3RvMi5sZW4gPSBmdW5jdGlvbiBsZW4oKSB7CiAgICAgIHJldHVybiB0aGlzLnZlYy5sZW5ndGg7CiAgICB9OwoKICAgIHJldHVybiBTdGFjazsKICB9KCk7CgogIF9leHBvcnRzLlN0YWNrID0gU3RhY2s7Cn0pOwpkZWZpbmUoIkBnbGltbWVyL25vZGUiLCBbImV4cG9ydHMiLCAiZW1iZXItYmFiZWwiLCAiQGdsaW1tZXIvcnVudGltZSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9lbWJlckJhYmVsLCBfcnVudGltZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuc2VyaWFsaXplQnVpbGRlciA9IHNlcmlhbGl6ZUJ1aWxkZXI7CiAgX2V4cG9ydHMuTm9kZURPTVRyZWVDb25zdHJ1Y3Rpb24gPSB2b2lkIDA7CgogIHZhciBOb2RlRE9NVHJlZUNvbnN0cnVjdGlvbiA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfRE9NVHJlZUNvbnN0cnVjdGlvbikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKE5vZGVET01UcmVlQ29uc3RydWN0aW9uLCBfRE9NVHJlZUNvbnN0cnVjdGlvbik7CgogICAgZnVuY3Rpb24gTm9kZURPTVRyZWVDb25zdHJ1Y3Rpb24oZG9jKSB7CiAgICAgIHJldHVybiBfRE9NVHJlZUNvbnN0cnVjdGlvbi5jYWxsKHRoaXMsIGRvYykgfHwgdGhpczsKICAgIH0gLy8gb3ZlcnJpZGUgdG8gcHJldmVudCB1c2FnZSBvZiBgdGhpcy5kb2N1bWVudGAgdW50aWwgYWZ0ZXIgdGhlIGNvbnN0cnVjdG9yCgoKICAgIHZhciBfcHJvdG8gPSBOb2RlRE9NVHJlZUNvbnN0cnVjdGlvbi5wcm90b3R5cGU7CgogICAgX3Byb3RvLnNldHVwVXNlbGVzc0VsZW1lbnQgPSBmdW5jdGlvbiBzZXR1cFVzZWxlc3NFbGVtZW50KCkge30gLy8gb3ZlcnJpZGUgdG8gYXZvaWQgU1ZHIGRldGVjdGlvbi93b3JrIHdoZW4gaW4gbm9kZSAodGhpcyBpcyBub3QgbmVlZGVkIGluIFNTUikKICAgIDsKCiAgICBfcHJvdG8uY3JlYXRlRWxlbWVudCA9IGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQodGFnKSB7CiAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnKTsKICAgIH0gLy8gb3ZlcnJpZGUgdG8gYXZvaWQgbmFtZXNwYWNlIHNoZW5hbmlnYW5zIHdoZW4gaW4gbm9kZSAodGhpcyBpcyBub3QgbmVlZGVkIGluIFNTUikKICAgIDsKCiAgICBfcHJvdG8uc2V0QXR0cmlidXRlID0gZnVuY3Rpb24gc2V0QXR0cmlidXRlKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7CiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICAgIH07CgogICAgcmV0dXJuIE5vZGVET01UcmVlQ29uc3RydWN0aW9uOwogIH0oX3J1bnRpbWUuRE9NVHJlZUNvbnN0cnVjdGlvbik7CgogIF9leHBvcnRzLk5vZGVET01UcmVlQ29uc3RydWN0aW9uID0gTm9kZURPTVRyZWVDb25zdHJ1Y3Rpb247CiAgdmFyIFRFWFRfTk9ERSA9IDM7CgogIGZ1bmN0aW9uIGN1cnJlbnROb2RlKGN1cnNvcikgewogICAgdmFyIGVsZW1lbnQgPSBjdXJzb3IuZWxlbWVudCwKICAgICAgICBuZXh0U2libGluZyA9IGN1cnNvci5uZXh0U2libGluZzsKCiAgICBpZiAobmV4dFNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQubGFzdENoaWxkOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5leHRTaWJsaW5nLnByZXZpb3VzU2libGluZzsKICAgIH0KICB9CgogIHZhciBTZXJpYWxpemVCdWlsZGVyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9OZXdFbGVtZW50QnVpbGRlcikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKFNlcmlhbGl6ZUJ1aWxkZXIsIF9OZXdFbGVtZW50QnVpbGRlcik7CgogICAgZnVuY3Rpb24gU2VyaWFsaXplQnVpbGRlcigpIHsKICAgICAgdmFyIF90aGlzOwoKICAgICAgX3RoaXMgPSBfTmV3RWxlbWVudEJ1aWxkZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgICBfdGhpcy5zZXJpYWxpemVCbG9ja0RlcHRoID0gMDsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG8yID0gU2VyaWFsaXplQnVpbGRlci5wcm90b3R5cGU7CgogICAgX3Byb3RvMi5fX29wZW5CbG9jayA9IGZ1bmN0aW9uIF9fb3BlbkJsb2NrKCkgewogICAgICB2YXIgdGFnTmFtZSA9IHRoaXMuZWxlbWVudC50YWdOYW1lOwoKICAgICAgaWYgKHRhZ05hbWUgIT09ICdUSVRMRScgJiYgdGFnTmFtZSAhPT0gJ1NDUklQVCcgJiYgdGFnTmFtZSAhPT0gJ1NUWUxFJykgewogICAgICAgIHZhciBkZXB0aCA9IHRoaXMuc2VyaWFsaXplQmxvY2tEZXB0aCsrOwoKICAgICAgICB0aGlzLl9fYXBwZW5kQ29tbWVudCgiJStiOiIgKyBkZXB0aCArICIlIik7CiAgICAgIH0KCiAgICAgIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19vcGVuQmxvY2suY2FsbCh0aGlzKTsKICAgIH07CgogICAgX3Byb3RvMi5fX2Nsb3NlQmxvY2sgPSBmdW5jdGlvbiBfX2Nsb3NlQmxvY2soKSB7CiAgICAgIHZhciB0YWdOYW1lID0gdGhpcy5lbGVtZW50LnRhZ05hbWU7CgogICAgICBfTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLl9fY2xvc2VCbG9jay5jYWxsKHRoaXMpOwoKICAgICAgaWYgKHRhZ05hbWUgIT09ICdUSVRMRScgJiYgdGFnTmFtZSAhPT0gJ1NDUklQVCcgJiYgdGFnTmFtZSAhPT0gJ1NUWUxFJykgewogICAgICAgIHZhciBkZXB0aCA9IC0tdGhpcy5zZXJpYWxpemVCbG9ja0RlcHRoOwoKICAgICAgICB0aGlzLl9fYXBwZW5kQ29tbWVudCgiJS1iOiIgKyBkZXB0aCArICIlIik7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMi5fX2FwcGVuZEhUTUwgPSBmdW5jdGlvbiBfX2FwcGVuZEhUTUwoaHRtbCkgewogICAgICB2YXIgdGFnTmFtZSA9IHRoaXMuZWxlbWVudC50YWdOYW1lOwoKICAgICAgaWYgKHRhZ05hbWUgPT09ICdUSVRMRScgfHwgdGFnTmFtZSA9PT0gJ1NDUklQVCcgfHwgdGFnTmFtZSA9PT0gJ1NUWUxFJykgewogICAgICAgIHJldHVybiBfTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLl9fYXBwZW5kSFRNTC5jYWxsKHRoaXMsIGh0bWwpOwogICAgICB9IC8vIERvIHdlIG5lZWQgdG8gcnVuIHRoZSBodG1sIHRva2VuaXplciBoZXJlPwoKCiAgICAgIHZhciBmaXJzdCA9IHRoaXMuX19hcHBlbmRDb21tZW50KCclZ2xtciUnKTsKCiAgICAgIGlmICh0YWdOYW1lID09PSAnVEFCTEUnKSB7CiAgICAgICAgdmFyIG9wZW5JbmRleCA9IGh0bWwuaW5kZXhPZignPCcpOwoKICAgICAgICBpZiAob3BlbkluZGV4ID4gLTEpIHsKICAgICAgICAgIHZhciB0ciA9IGh0bWwuc2xpY2Uob3BlbkluZGV4ICsgMSwgb3BlbkluZGV4ICsgMyk7CgogICAgICAgICAgaWYgKHRyID09PSAndHInKSB7CiAgICAgICAgICAgIGh0bWwgPSAiPHRib2R5PiIgKyBodG1sICsgIjwvdGJvZHk+IjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChodG1sID09PSAnJykgewogICAgICAgIHRoaXMuX19hcHBlbmRDb21tZW50KCclICUnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBfTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLl9fYXBwZW5kSFRNTC5jYWxsKHRoaXMsIGh0bWwpOwogICAgICB9CgogICAgICB2YXIgbGFzdCA9IHRoaXMuX19hcHBlbmRDb21tZW50KCclZ2xtciUnKTsKCiAgICAgIHJldHVybiBuZXcgX3J1bnRpbWUuQ29uY3JldGVCb3VuZHModGhpcy5lbGVtZW50LCBmaXJzdCwgbGFzdCk7CiAgICB9OwoKICAgIF9wcm90bzIuX19hcHBlbmRUZXh0ID0gZnVuY3Rpb24gX19hcHBlbmRUZXh0KHN0cmluZykgewogICAgICB2YXIgdGFnTmFtZSA9IHRoaXMuZWxlbWVudC50YWdOYW1lOwogICAgICB2YXIgY3VycmVudCA9IGN1cnJlbnROb2RlKHRoaXMpOwoKICAgICAgaWYgKHRhZ05hbWUgPT09ICdUSVRMRScgfHwgdGFnTmFtZSA9PT0gJ1NDUklQVCcgfHwgdGFnTmFtZSA9PT0gJ1NUWUxFJykgewogICAgICAgIHJldHVybiBfTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLl9fYXBwZW5kVGV4dC5jYWxsKHRoaXMsIHN0cmluZyk7CiAgICAgIH0gZWxzZSBpZiAoc3RyaW5nID09PSAnJykgewogICAgICAgIHJldHVybiB0aGlzLl9fYXBwZW5kQ29tbWVudCgnJSAlJyk7CiAgICAgIH0gZWxzZSBpZiAoY3VycmVudCAmJiBjdXJyZW50Lm5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICB0aGlzLl9fYXBwZW5kQ29tbWVudCgnJXwlJyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBfTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLl9fYXBwZW5kVGV4dC5jYWxsKHRoaXMsIHN0cmluZyk7CiAgICB9OwoKICAgIF9wcm90bzIuY2xvc2VFbGVtZW50ID0gZnVuY3Rpb24gY2xvc2VFbGVtZW50KCkgewogICAgICBpZiAodGhpcy5lbGVtZW50WyduZWVkc0V4dHJhQ2xvc2UnXSA9PT0gdHJ1ZSkgewogICAgICAgIHRoaXMuZWxlbWVudFsnbmVlZHNFeHRyYUNsb3NlJ10gPSBmYWxzZTsKCiAgICAgICAgX05ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5jbG9zZUVsZW1lbnQuY2FsbCh0aGlzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuY2xvc2VFbGVtZW50LmNhbGwodGhpcyk7CiAgICB9OwoKICAgIF9wcm90bzIub3BlbkVsZW1lbnQgPSBmdW5jdGlvbiBvcGVuRWxlbWVudCh0YWcpIHsKICAgICAgaWYgKHRhZyA9PT0gJ3RyJykgewogICAgICAgIGlmICh0aGlzLmVsZW1lbnQudGFnTmFtZSAhPT0gJ1RCT0RZJyAmJiB0aGlzLmVsZW1lbnQudGFnTmFtZSAhPT0gJ1RIRUFEJyAmJiB0aGlzLmVsZW1lbnQudGFnTmFtZSAhPT0gJ1RGT09UJykgewogICAgICAgICAgdGhpcy5vcGVuRWxlbWVudCgndGJvZHknKTsgLy8gVGhpcyBwcmV2ZW50cyB0aGUgY2xvc2VCbG9jayBjb21tZW50IGZyb20gYmVpbmcgcmUtcGFyZW50ZWQKICAgICAgICAgIC8vIHVuZGVyIHRoZSBhdXRvIGluc2VydGVkIHRib2R5LiBSZWh5ZHJhdGlvbiBidWlsZGVyIG5lZWRzIHRvCiAgICAgICAgICAvLyBhY2NvdW50IGZvciB0aGUgaW5zZXJ0aW9uIHNpbmNlIGl0IGlzIGluamVjdGVkIGhlcmUgYW5kIG5vdAogICAgICAgICAgLy8gcmVhbGx5IGluIHRoZSB0ZW1wbGF0ZS4KCiAgICAgICAgICB0aGlzLmNvbnN0cnVjdGluZ1snbmVlZHNFeHRyYUNsb3NlJ10gPSB0cnVlOwogICAgICAgICAgdGhpcy5mbHVzaEVsZW1lbnQobnVsbCk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gX05ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5vcGVuRWxlbWVudC5jYWxsKHRoaXMsIHRhZyk7CiAgICB9OwoKICAgIF9wcm90bzIucHVzaFJlbW90ZUVsZW1lbnQgPSBmdW5jdGlvbiBwdXNoUmVtb3RlRWxlbWVudChlbGVtZW50LCBjdXJzb3JJZCwgbmV4dFNpYmxpbmcpIHsKICAgICAgaWYgKG5leHRTaWJsaW5nID09PSB2b2lkIDApIHsKICAgICAgICBuZXh0U2libGluZyA9IG51bGw7CiAgICAgIH0KCiAgICAgIHZhciBkb20gPSB0aGlzLmRvbTsKICAgICAgdmFyIHNjcmlwdCA9IGRvbS5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgnZ2xtcicsIGN1cnNvcklkKTsKICAgICAgZG9tLmluc2VydEJlZm9yZShlbGVtZW50LCBzY3JpcHQsIG5leHRTaWJsaW5nKTsKCiAgICAgIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUucHVzaFJlbW90ZUVsZW1lbnQuY2FsbCh0aGlzLCBlbGVtZW50LCBjdXJzb3JJZCwgbmV4dFNpYmxpbmcpOwogICAgfTsKCiAgICByZXR1cm4gU2VyaWFsaXplQnVpbGRlcjsKICB9KF9ydW50aW1lLk5ld0VsZW1lbnRCdWlsZGVyKTsKCiAgZnVuY3Rpb24gc2VyaWFsaXplQnVpbGRlcihlbnYsIGN1cnNvcikgewogICAgcmV0dXJuIFNlcmlhbGl6ZUJ1aWxkZXIuZm9ySW5pdGlhbFJlbmRlcihlbnYsIGN1cnNvcik7CiAgfQp9KTsKZGVmaW5lKCJAZ2xpbW1lci9vcGNvZGUtY29tcGlsZXIiLCBbImV4cG9ydHMiLCAiQGVtYmVyL3BvbHlmaWxscyIsICJlbWJlci1iYWJlbCIsICJAZ2xpbW1lci91dGlsIiwgIkBnbGltbWVyL3ZtIiwgIkBnbGltbWVyL3dpcmUtZm9ybWF0IiwgIkBnbGltbWVyL2VuY29kZXIiLCAiQGdsaW1tZXIvcHJvZ3JhbSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9wb2x5ZmlsbHMsIF9lbWJlckJhYmVsLCBfdXRpbCwgX3ZtLCBfd2lyZUZvcm1hdCwgX2VuY29kZXIsIF9wcm9ncmFtKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5jb21waWxlID0gY29tcGlsZTsKICBfZXhwb3J0cy50ZW1wbGF0ZUZhY3RvcnkgPSB0ZW1wbGF0ZUZhY3Rvcnk7CiAgX2V4cG9ydHMuZGVidWcgPSBkZWJ1ZzsKICBfZXhwb3J0cy5kZWJ1Z1NsaWNlID0gZGVidWdTbGljZTsKICBfZXhwb3J0cy5sb2dPcGNvZGUgPSBsb2dPcGNvZGU7CiAgX2V4cG9ydHMuUExBQ0VIT0xERVJfSEFORExFID0gX2V4cG9ydHMuV3JhcHBlZEJ1aWxkZXIgPSBfZXhwb3J0cy5QYXJ0aWFsRGVmaW5pdGlvbiA9IF9leHBvcnRzLlN0ZE9wY29kZUJ1aWxkZXIgPSBfZXhwb3J0cy5PcGNvZGVCdWlsZGVyID0gX2V4cG9ydHMuRWFnZXJPcGNvZGVCdWlsZGVyID0gX2V4cG9ydHMuTGF6eU9wY29kZUJ1aWxkZXIgPSBfZXhwb3J0cy5Db21waWxhYmxlUHJvZ3JhbSA9IF9leHBvcnRzLkNvbXBpbGFibGVCbG9jayA9IF9leHBvcnRzLmRlYnVnQ29tcGlsZXIgPSBfZXhwb3J0cy5BYnN0cmFjdENvbXBpbGVyID0gX2V4cG9ydHMuTGF6eUNvbXBpbGVyID0gX2V4cG9ydHMuTWFjcm9zID0gX2V4cG9ydHMuQVRUUlNfQkxPQ0sgPSB2b2lkIDA7CiAgdmFyIFBMQUNFSE9MREVSX0hBTkRMRSA9IC0xOwogIF9leHBvcnRzLlBMQUNFSE9MREVSX0hBTkRMRSA9IFBMQUNFSE9MREVSX0hBTkRMRTsKICB2YXIgT3BzJDE7CgogIChmdW5jdGlvbiAoT3BzJCQxKSB7CiAgICBPcHMkJDFbT3BzJCQxWyJPcGVuQ29tcG9uZW50RWxlbWVudCJdID0gMF0gPSAiT3BlbkNvbXBvbmVudEVsZW1lbnQiOwogICAgT3BzJCQxW09wcyQkMVsiRGlkQ3JlYXRlRWxlbWVudCJdID0gMV0gPSAiRGlkQ3JlYXRlRWxlbWVudCI7CiAgICBPcHMkJDFbT3BzJCQxWyJEaWRSZW5kZXJMYXlvdXQiXSA9IDJdID0gIkRpZFJlbmRlckxheW91dCI7CiAgICBPcHMkJDFbT3BzJCQxWyJEZWJ1Z2dlciJdID0gM10gPSAiRGVidWdnZXIiOwogIH0pKE9wcyQxIHx8IChPcHMkMSA9IHt9KSk7CgogIHZhciBPcHMkMiA9IF93aXJlRm9ybWF0Lk9wczsKICB2YXIgQVRUUlNfQkxPQ0sgPSAnJmF0dHJzJzsKICBfZXhwb3J0cy5BVFRSU19CTE9DSyA9IEFUVFJTX0JMT0NLOwoKICB2YXIgQ29tcGlsZXJzID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQ29tcGlsZXJzKG9mZnNldCkgewogICAgICBpZiAob2Zmc2V0ID09PSB2b2lkIDApIHsKICAgICAgICBvZmZzZXQgPSAwOwogICAgICB9CgogICAgICB0aGlzLm9mZnNldCA9IG9mZnNldDsKICAgICAgdGhpcy5uYW1lcyA9ICgwLCBfdXRpbC5kaWN0KSgpOwogICAgICB0aGlzLmZ1bmNzID0gW107CiAgICB9CgogICAgdmFyIF9wcm90byA9IENvbXBpbGVycy5wcm90b3R5cGU7CgogICAgX3Byb3RvLmFkZCA9IGZ1bmN0aW9uIGFkZChuYW1lLCBmdW5jKSB7CiAgICAgIHRoaXMuZnVuY3MucHVzaChmdW5jKTsKICAgICAgdGhpcy5uYW1lc1tuYW1lXSA9IHRoaXMuZnVuY3MubGVuZ3RoIC0gMTsKICAgIH07CgogICAgX3Byb3RvLmNvbXBpbGUgPSBmdW5jdGlvbiBjb21waWxlKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgdmFyIG5hbWUgPSBzZXhwW3RoaXMub2Zmc2V0XTsKICAgICAgdmFyIGluZGV4ID0gdGhpcy5uYW1lc1tuYW1lXTsKICAgICAgdmFyIGZ1bmMgPSB0aGlzLmZ1bmNzW2luZGV4XTsKICAgICAgZnVuYyhzZXhwLCBidWlsZGVyKTsKICAgIH07CgogICAgcmV0dXJuIENvbXBpbGVyczsKICB9KCk7CgogIHZhciBfc3RhdGVtZW50Q29tcGlsZXI7CgogIGZ1bmN0aW9uIHN0YXRlbWVudENvbXBpbGVyKCkgewogICAgaWYgKF9zdGF0ZW1lbnRDb21waWxlcikgewogICAgICByZXR1cm4gX3N0YXRlbWVudENvbXBpbGVyOwogICAgfQoKICAgIHZhciBTVEFURU1FTlRTID0gX3N0YXRlbWVudENvbXBpbGVyID0gbmV3IENvbXBpbGVycygpOwogICAgU1RBVEVNRU5UUy5hZGQoT3BzJDIuVGV4dCwgZnVuY3Rpb24gKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgYnVpbGRlci50ZXh0KHNleHBbMV0pOwogICAgfSk7CiAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5Db21tZW50LCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICBidWlsZGVyLmNvbW1lbnQoc2V4cFsxXSk7CiAgICB9KTsKICAgIFNUQVRFTUVOVFMuYWRkKE9wcyQyLkNsb3NlRWxlbWVudCwgZnVuY3Rpb24gKF9zZXhwLCBidWlsZGVyKSB7CiAgICAgIGJ1aWxkZXIuY2xvc2VFbGVtZW50KCk7CiAgICB9KTsKICAgIFNUQVRFTUVOVFMuYWRkKE9wcyQyLkZsdXNoRWxlbWVudCwgZnVuY3Rpb24gKF9zZXhwLCBidWlsZGVyKSB7CiAgICAgIGJ1aWxkZXIuZmx1c2hFbGVtZW50KCk7CiAgICB9KTsKICAgIFNUQVRFTUVOVFMuYWRkKE9wcyQyLk1vZGlmaWVyLCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICB2YXIgcmVmZXJyZXIgPSBidWlsZGVyLnJlZmVycmVyOwogICAgICB2YXIgbmFtZSA9IHNleHBbMV0sCiAgICAgICAgICBwYXJhbXMgPSBzZXhwWzJdLAogICAgICAgICAgaGFzaCA9IHNleHBbM107CiAgICAgIHZhciBoYW5kbGUgPSBidWlsZGVyLmNvbXBpbGVyLnJlc29sdmVNb2RpZmllcihuYW1lLCByZWZlcnJlcik7CgogICAgICBpZiAoaGFuZGxlICE9PSBudWxsKSB7CiAgICAgICAgYnVpbGRlci5tb2RpZmllcihoYW5kbGUsIHBhcmFtcywgaGFzaCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDb21waWxlIEVycm9yICIgKyBuYW1lICsgIiBpcyBub3QgYSBtb2RpZmllcjogSGVscGVycyBtYXkgbm90IGJlIHVzZWQgaW4gdGhlIGVsZW1lbnQgZm9ybS4iKTsKICAgICAgfQogICAgfSk7CiAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5TdGF0aWNBdHRyLCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICB2YXIgbmFtZSA9IHNleHBbMV0sCiAgICAgICAgICB2YWx1ZSA9IHNleHBbMl0sCiAgICAgICAgICBuYW1lc3BhY2UgPSBzZXhwWzNdOwogICAgICBidWlsZGVyLnN0YXRpY0F0dHIobmFtZSwgbmFtZXNwYWNlLCB2YWx1ZSk7CiAgICB9KTsKICAgIFNUQVRFTUVOVFMuYWRkKE9wcyQyLkR5bmFtaWNBdHRyLCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICBkeW5hbWljQXR0cihzZXhwLCBmYWxzZSwgYnVpbGRlcik7CiAgICB9KTsKICAgIFNUQVRFTUVOVFMuYWRkKE9wcyQyLkNvbXBvbmVudEF0dHIsIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgIGNvbXBvbmVudEF0dHIoc2V4cCwgZmFsc2UsIGJ1aWxkZXIpOwogICAgfSk7CiAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5UcnVzdGluZ0F0dHIsIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgIGR5bmFtaWNBdHRyKHNleHAsIHRydWUsIGJ1aWxkZXIpOwogICAgfSk7CiAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5UcnVzdGluZ0NvbXBvbmVudEF0dHIsIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgIGNvbXBvbmVudEF0dHIoc2V4cCwgdHJ1ZSwgYnVpbGRlcik7CiAgICB9KTsKICAgIFNUQVRFTUVOVFMuYWRkKE9wcyQyLk9wZW5FbGVtZW50LCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICB2YXIgdGFnID0gc2V4cFsxXSwKICAgICAgICAgIHNpbXBsZSA9IHNleHBbMl07CgogICAgICBpZiAoIXNpbXBsZSkgewogICAgICAgIGJ1aWxkZXIucHV0Q29tcG9uZW50T3BlcmF0aW9ucygpOwogICAgICB9CgogICAgICBidWlsZGVyLm9wZW5QcmltaXRpdmVFbGVtZW50KHRhZyk7CiAgICB9KTsKICAgIFNUQVRFTUVOVFMuYWRkKE9wcyQyLkR5bmFtaWNDb21wb25lbnQsIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgIHZhciBkZWZpbml0aW9uID0gc2V4cFsxXSwKICAgICAgICAgIGF0dHJzID0gc2V4cFsyXSwKICAgICAgICAgIGFyZ3MgPSBzZXhwWzNdLAogICAgICAgICAgdGVtcGxhdGUgPSBzZXhwWzRdOwogICAgICB2YXIgYmxvY2sgPSBidWlsZGVyLnRlbXBsYXRlKHRlbXBsYXRlKTsKICAgICAgdmFyIGF0dHJzQmxvY2sgPSBudWxsOwoKICAgICAgaWYgKGF0dHJzLmxlbmd0aCA+IDApIHsKICAgICAgICBhdHRyc0Jsb2NrID0gYnVpbGRlci5pbmxpbmVCbG9jayh7CiAgICAgICAgICBzdGF0ZW1lbnRzOiBhdHRycywKICAgICAgICAgIHBhcmFtZXRlcnM6IF91dGlsLkVNUFRZX0FSUkFZCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGJ1aWxkZXIuZHluYW1pY0NvbXBvbmVudChkZWZpbml0aW9uLCBhdHRyc0Jsb2NrLCBudWxsLCBhcmdzLCBmYWxzZSwgYmxvY2ssIG51bGwpOwogICAgfSk7CiAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5Db21wb25lbnQsIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgIHZhciB0YWcgPSBzZXhwWzFdLAogICAgICAgICAgYXR0cnMgPSBzZXhwWzJdLAogICAgICAgICAgYXJncyA9IHNleHBbM10sCiAgICAgICAgICBibG9jayA9IHNleHBbNF07CiAgICAgIHZhciByZWZlcnJlciA9IGJ1aWxkZXIucmVmZXJyZXI7CgogICAgICB2YXIgX2J1aWxkZXIkY29tcGlsZXIkcmVzID0gYnVpbGRlci5jb21waWxlci5yZXNvbHZlTGF5b3V0Rm9yVGFnKHRhZywgcmVmZXJyZXIpLAogICAgICAgICAgaGFuZGxlID0gX2J1aWxkZXIkY29tcGlsZXIkcmVzLmhhbmRsZSwKICAgICAgICAgIGNhcGFiaWxpdGllcyA9IF9idWlsZGVyJGNvbXBpbGVyJHJlcy5jYXBhYmlsaXRpZXMsCiAgICAgICAgICBjb21waWxhYmxlID0gX2J1aWxkZXIkY29tcGlsZXIkcmVzLmNvbXBpbGFibGU7CgogICAgICBpZiAoaGFuZGxlICE9PSBudWxsICYmIGNhcGFiaWxpdGllcyAhPT0gbnVsbCkgewogICAgICAgIHZhciBhdHRyc0Jsb2NrID0gbnVsbDsKCiAgICAgICAgaWYgKGF0dHJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGF0dHJzQmxvY2sgPSBidWlsZGVyLmlubGluZUJsb2NrKHsKICAgICAgICAgICAgc3RhdGVtZW50czogYXR0cnMsCiAgICAgICAgICAgIHBhcmFtZXRlcnM6IF91dGlsLkVNUFRZX0FSUkFZCiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIHZhciBjaGlsZCA9IGJ1aWxkZXIudGVtcGxhdGUoYmxvY2spOwoKICAgICAgICBpZiAoY29tcGlsYWJsZSkgewogICAgICAgICAgYnVpbGRlci5wdXNoQ29tcG9uZW50RGVmaW5pdGlvbihoYW5kbGUpOwogICAgICAgICAgYnVpbGRlci5pbnZva2VTdGF0aWNDb21wb25lbnQoY2FwYWJpbGl0aWVzLCBjb21waWxhYmxlLCBhdHRyc0Jsb2NrLCBudWxsLCBhcmdzLCBmYWxzZSwgY2hpbGQgJiYgY2hpbGQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBidWlsZGVyLnB1c2hDb21wb25lbnREZWZpbml0aW9uKGhhbmRsZSk7CiAgICAgICAgICBidWlsZGVyLmludm9rZUNvbXBvbmVudChjYXBhYmlsaXRpZXMsIGF0dHJzQmxvY2ssIG51bGwsIGFyZ3MsIGZhbHNlLCBjaGlsZCAmJiBjaGlsZCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiQ29tcGlsZSBFcnJvcjogQ2Fubm90IGZpbmQgY29tcG9uZW50ICIgKyB0YWcpOwogICAgICB9CiAgICB9KTsKICAgIFNUQVRFTUVOVFMuYWRkKE9wcyQyLlBhcnRpYWwsIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgIHZhciBuYW1lID0gc2V4cFsxXSwKICAgICAgICAgIGV2YWxJbmZvID0gc2V4cFsyXTsKICAgICAgdmFyIHJlZmVycmVyID0gYnVpbGRlci5yZWZlcnJlcjsKICAgICAgYnVpbGRlci5yZXBsYXlhYmxlSWYoewogICAgICAgIGFyZ3M6IGZ1bmN0aW9uIGFyZ3MoKSB7CiAgICAgICAgICBidWlsZGVyLmV4cHIobmFtZSk7CiAgICAgICAgICBidWlsZGVyLmR1cCgpOwogICAgICAgICAgcmV0dXJuIDI7CiAgICAgICAgfSwKICAgICAgICBpZlRydWU6IGZ1bmN0aW9uIGlmVHJ1ZSgpIHsKICAgICAgICAgIGJ1aWxkZXIuaW52b2tlUGFydGlhbChyZWZlcnJlciwgYnVpbGRlci5ldmFsU3ltYm9scygpLCBldmFsSW5mbyk7CiAgICAgICAgICBidWlsZGVyLnBvcFNjb3BlKCk7CiAgICAgICAgICBidWlsZGVyLnBvcEZyYW1lKCk7IC8vIEZJWE1FOiBXQVQKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5ZaWVsZCwgZnVuY3Rpb24gKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgdmFyIHRvID0gc2V4cFsxXSwKICAgICAgICAgIHBhcmFtcyA9IHNleHBbMl07CiAgICAgIGJ1aWxkZXIueWllbGQodG8sIHBhcmFtcyk7CiAgICB9KTsKICAgIFNUQVRFTUVOVFMuYWRkKE9wcyQyLkF0dHJTcGxhdCwgZnVuY3Rpb24gKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgdmFyIHRvID0gc2V4cFsxXTsKICAgICAgYnVpbGRlci55aWVsZCh0bywgW10pOwogICAgfSk7CiAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5EZWJ1Z2dlciwgZnVuY3Rpb24gKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgdmFyIGV2YWxJbmZvID0gc2V4cFsxXTsKICAgICAgYnVpbGRlci5kZWJ1Z2dlcihidWlsZGVyLmV2YWxTeW1ib2xzKCksIGV2YWxJbmZvKTsKICAgIH0pOwogICAgU1RBVEVNRU5UUy5hZGQoT3BzJDIuQ2xpZW50U2lkZVN0YXRlbWVudCwgZnVuY3Rpb24gKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgQ0xJRU5UX1NJREUuY29tcGlsZShzZXhwLCBidWlsZGVyKTsKICAgIH0pOwogICAgU1RBVEVNRU5UUy5hZGQoT3BzJDIuQXBwZW5kLCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICB2YXIgdmFsdWUgPSBzZXhwWzFdLAogICAgICAgICAgdHJ1c3RpbmcgPSBzZXhwWzJdOwogICAgICB2YXIgcmV0dXJuZWQgPSBidWlsZGVyLmNvbXBpbGVJbmxpbmUoc2V4cCkgfHwgdmFsdWU7CiAgICAgIGlmIChyZXR1cm5lZCA9PT0gdHJ1ZSkgcmV0dXJuOwogICAgICBidWlsZGVyLmd1YXJkZWRBcHBlbmQodmFsdWUsIHRydXN0aW5nKTsKICAgIH0pOwogICAgU1RBVEVNRU5UUy5hZGQoT3BzJDIuQmxvY2ssIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgIHZhciBuYW1lID0gc2V4cFsxXSwKICAgICAgICAgIHBhcmFtcyA9IHNleHBbMl0sCiAgICAgICAgICBoYXNoID0gc2V4cFszXSwKICAgICAgICAgIF90ZW1wbGF0ZSA9IHNleHBbNF0sCiAgICAgICAgICBfaW52ZXJzZSA9IHNleHBbNV07CiAgICAgIHZhciB0ZW1wbGF0ZSA9IGJ1aWxkZXIudGVtcGxhdGUoX3RlbXBsYXRlKTsKICAgICAgdmFyIGludmVyc2UgPSBidWlsZGVyLnRlbXBsYXRlKF9pbnZlcnNlKTsKICAgICAgdmFyIHRlbXBsYXRlQmxvY2sgPSB0ZW1wbGF0ZSAmJiB0ZW1wbGF0ZTsKICAgICAgdmFyIGludmVyc2VCbG9jayA9IGludmVyc2UgJiYgaW52ZXJzZTsKICAgICAgYnVpbGRlci5jb21waWxlQmxvY2sobmFtZSwgcGFyYW1zLCBoYXNoLCB0ZW1wbGF0ZUJsb2NrLCBpbnZlcnNlQmxvY2spOwogICAgfSk7CiAgICB2YXIgQ0xJRU5UX1NJREUgPSBuZXcgQ29tcGlsZXJzKDEpOwogICAgQ0xJRU5UX1NJREUuYWRkKE9wcyQxLk9wZW5Db21wb25lbnRFbGVtZW50LCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICBidWlsZGVyLnB1dENvbXBvbmVudE9wZXJhdGlvbnMoKTsKICAgICAgYnVpbGRlci5vcGVuUHJpbWl0aXZlRWxlbWVudChzZXhwWzJdKTsKICAgIH0pOwogICAgQ0xJRU5UX1NJREUuYWRkKE9wcyQxLkRpZENyZWF0ZUVsZW1lbnQsIGZ1bmN0aW9uIChfc2V4cCwgYnVpbGRlcikgewogICAgICBidWlsZGVyLmRpZENyZWF0ZUVsZW1lbnQoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgIH0pOwogICAgQ0xJRU5UX1NJREUuYWRkKE9wcyQxLkRlYnVnZ2VyLCBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1kZWJ1Z2dlcgogICAgICBkZWJ1Z2dlcjsKICAgIH0pOwogICAgQ0xJRU5UX1NJREUuYWRkKE9wcyQxLkRpZFJlbmRlckxheW91dCwgZnVuY3Rpb24gKF9zZXhwLCBidWlsZGVyKSB7CiAgICAgIGJ1aWxkZXIuZGlkUmVuZGVyTGF5b3V0KF92bS5SZWdpc3Rlci5zMCk7CiAgICB9KTsKICAgIHJldHVybiBTVEFURU1FTlRTOwogIH0KCiAgZnVuY3Rpb24gY29tcG9uZW50QXR0cihzZXhwLCB0cnVzdGluZywgYnVpbGRlcikgewogICAgdmFyIG5hbWUgPSBzZXhwWzFdLAogICAgICAgIHZhbHVlID0gc2V4cFsyXSwKICAgICAgICBuYW1lc3BhY2UgPSBzZXhwWzNdOwogICAgYnVpbGRlci5leHByKHZhbHVlKTsKCiAgICBpZiAobmFtZXNwYWNlKSB7CiAgICAgIGJ1aWxkZXIuY29tcG9uZW50QXR0cihuYW1lLCBuYW1lc3BhY2UsIHRydXN0aW5nKTsKICAgIH0gZWxzZSB7CiAgICAgIGJ1aWxkZXIuY29tcG9uZW50QXR0cihuYW1lLCBudWxsLCB0cnVzdGluZyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkeW5hbWljQXR0cihzZXhwLCB0cnVzdGluZywgYnVpbGRlcikgewogICAgdmFyIG5hbWUgPSBzZXhwWzFdLAogICAgICAgIHZhbHVlID0gc2V4cFsyXSwKICAgICAgICBuYW1lc3BhY2UgPSBzZXhwWzNdOwogICAgYnVpbGRlci5leHByKHZhbHVlKTsKCiAgICBpZiAobmFtZXNwYWNlKSB7CiAgICAgIGJ1aWxkZXIuZHluYW1pY0F0dHIobmFtZSwgbmFtZXNwYWNlLCB0cnVzdGluZyk7CiAgICB9IGVsc2UgewogICAgICBidWlsZGVyLmR5bmFtaWNBdHRyKG5hbWUsIG51bGwsIHRydXN0aW5nKTsKICAgIH0KICB9CgogIHZhciBfZXhwcmVzc2lvbkNvbXBpbGVyOwoKICBmdW5jdGlvbiBleHByZXNzaW9uQ29tcGlsZXIoKSB7CiAgICBpZiAoX2V4cHJlc3Npb25Db21waWxlcikgewogICAgICByZXR1cm4gX2V4cHJlc3Npb25Db21waWxlcjsKICAgIH0KCiAgICB2YXIgRVhQUkVTU0lPTlMgPSBfZXhwcmVzc2lvbkNvbXBpbGVyID0gbmV3IENvbXBpbGVycygpOwogICAgRVhQUkVTU0lPTlMuYWRkKE9wcyQyLlVua25vd24sIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgIHZhciBjb21waWxlciA9IGJ1aWxkZXIuY29tcGlsZXIsCiAgICAgICAgICByZWZlcnJlciA9IGJ1aWxkZXIucmVmZXJyZXIsCiAgICAgICAgICBhc1BhcnRpYWwgPSBidWlsZGVyLmNvbnRhaW5pbmdMYXlvdXQuYXNQYXJ0aWFsOwogICAgICB2YXIgbmFtZSA9IHNleHBbMV07CiAgICAgIHZhciBoYW5kbGUgPSBjb21waWxlci5yZXNvbHZlSGVscGVyKG5hbWUsIHJlZmVycmVyKTsKCiAgICAgIGlmIChoYW5kbGUgIT09IG51bGwpIHsKICAgICAgICBidWlsZGVyLmhlbHBlcihoYW5kbGUsIG51bGwsIG51bGwpOwogICAgICB9IGVsc2UgaWYgKGFzUGFydGlhbCkgewogICAgICAgIGJ1aWxkZXIucmVzb2x2ZU1heWJlTG9jYWwobmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnVpbGRlci5nZXRWYXJpYWJsZSgwKTsKICAgICAgICBidWlsZGVyLmdldFByb3BlcnR5KG5hbWUpOwogICAgICB9CiAgICB9KTsKICAgIEVYUFJFU1NJT05TLmFkZChPcHMkMi5Db25jYXQsIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgIHZhciBwYXJ0cyA9IHNleHBbMV07CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgYnVpbGRlci5leHByKHBhcnRzW2ldKTsKICAgICAgfQoKICAgICAgYnVpbGRlci5jb25jYXQocGFydHMubGVuZ3RoKTsKICAgIH0pOwogICAgRVhQUkVTU0lPTlMuYWRkKE9wcyQyLkhlbHBlciwgZnVuY3Rpb24gKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgdmFyIGNvbXBpbGVyID0gYnVpbGRlci5jb21waWxlciwKICAgICAgICAgIHJlZmVycmVyID0gYnVpbGRlci5yZWZlcnJlcjsKICAgICAgdmFyIG5hbWUgPSBzZXhwWzFdLAogICAgICAgICAgcGFyYW1zID0gc2V4cFsyXSwKICAgICAgICAgIGhhc2ggPSBzZXhwWzNdOyAvLyBUT0RPOiB0cmlhZ2UgdGhpcyBpbiB0aGUgV0YgY29tcGlsZXIKCiAgICAgIGlmIChuYW1lID09PSAnY29tcG9uZW50JykgewogICAgICAgIHZhciBkZWZpbml0aW9uID0gcGFyYW1zWzBdLAogICAgICAgICAgICByZXN0QXJncyA9IHBhcmFtcy5zbGljZSgxKTsKICAgICAgICBidWlsZGVyLmN1cnJ5Q29tcG9uZW50KGRlZmluaXRpb24sIHJlc3RBcmdzLCBoYXNoLCB0cnVlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBoYW5kbGUgPSBjb21waWxlci5yZXNvbHZlSGVscGVyKG5hbWUsIHJlZmVycmVyKTsKCiAgICAgIGlmIChoYW5kbGUgIT09IG51bGwpIHsKICAgICAgICBidWlsZGVyLmhlbHBlcihoYW5kbGUsIHBhcmFtcywgaGFzaCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDb21waWxlIEVycm9yOiAiICsgbmFtZSArICIgaXMgbm90IGEgaGVscGVyIik7CiAgICAgIH0KICAgIH0pOwogICAgRVhQUkVTU0lPTlMuYWRkKE9wcyQyLkdldCwgZnVuY3Rpb24gKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgdmFyIGhlYWQgPSBzZXhwWzFdLAogICAgICAgICAgcGF0aCA9IHNleHBbMl07CiAgICAgIGJ1aWxkZXIuZ2V0VmFyaWFibGUoaGVhZCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGgubGVuZ3RoOyBpKyspIHsKICAgICAgICBidWlsZGVyLmdldFByb3BlcnR5KHBhdGhbaV0pOwogICAgICB9CiAgICB9KTsKICAgIEVYUFJFU1NJT05TLmFkZChPcHMkMi5NYXliZUxvY2FsLCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICB2YXIgcGF0aCA9IHNleHBbMV07CgogICAgICBpZiAoYnVpbGRlci5jb250YWluaW5nTGF5b3V0LmFzUGFydGlhbCkgewogICAgICAgIHZhciBoZWFkID0gcGF0aFswXTsKICAgICAgICBwYXRoID0gcGF0aC5zbGljZSgxKTsKICAgICAgICBidWlsZGVyLnJlc29sdmVNYXliZUxvY2FsKGhlYWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGJ1aWxkZXIuZ2V0VmFyaWFibGUoMCk7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGF0aC5sZW5ndGg7IGkrKykgewogICAgICAgIGJ1aWxkZXIuZ2V0UHJvcGVydHkocGF0aFtpXSk7CiAgICAgIH0KICAgIH0pOwogICAgRVhQUkVTU0lPTlMuYWRkKE9wcyQyLlVuZGVmaW5lZCwgZnVuY3Rpb24gKF9zZXhwLCBidWlsZGVyKSB7CiAgICAgIHJldHVybiBidWlsZGVyLnB1c2hQcmltaXRpdmVSZWZlcmVuY2UodW5kZWZpbmVkKTsKICAgIH0pOwogICAgRVhQUkVTU0lPTlMuYWRkKE9wcyQyLkhhc0Jsb2NrLCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICBidWlsZGVyLmhhc0Jsb2NrKHNleHBbMV0pOwogICAgfSk7CiAgICBFWFBSRVNTSU9OUy5hZGQoT3BzJDIuSGFzQmxvY2tQYXJhbXMsIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgIGJ1aWxkZXIuaGFzQmxvY2tQYXJhbXMoc2V4cFsxXSk7CiAgICB9KTsKICAgIHJldHVybiBFWFBSRVNTSU9OUzsKICB9CgogIHZhciBNYWNyb3MgPSBmdW5jdGlvbiBNYWNyb3MoKSB7CiAgICB2YXIgX3BvcHVsYXRlQnVpbHRpbnMgPSBwb3B1bGF0ZUJ1aWx0aW5zKCksCiAgICAgICAgYmxvY2tzID0gX3BvcHVsYXRlQnVpbHRpbnMuYmxvY2tzLAogICAgICAgIGlubGluZXMgPSBfcG9wdWxhdGVCdWlsdGlucy5pbmxpbmVzOwoKICAgIHRoaXMuYmxvY2tzID0gYmxvY2tzOwogICAgdGhpcy5pbmxpbmVzID0gaW5saW5lczsKICB9OwoKICBfZXhwb3J0cy5NYWNyb3MgPSBNYWNyb3M7CgogIHZhciBCbG9ja3MgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBCbG9ja3MoKSB7CiAgICAgIHRoaXMubmFtZXMgPSAoMCwgX3V0aWwuZGljdCkoKTsKICAgICAgdGhpcy5mdW5jcyA9IFtdOwogICAgfQoKICAgIHZhciBfcHJvdG8yID0gQmxvY2tzLnByb3RvdHlwZTsKCiAgICBfcHJvdG8yLmFkZCA9IGZ1bmN0aW9uIGFkZChuYW1lLCBmdW5jKSB7CiAgICAgIHRoaXMuZnVuY3MucHVzaChmdW5jKTsKICAgICAgdGhpcy5uYW1lc1tuYW1lXSA9IHRoaXMuZnVuY3MubGVuZ3RoIC0gMTsKICAgIH07CgogICAgX3Byb3RvMi5hZGRNaXNzaW5nID0gZnVuY3Rpb24gYWRkTWlzc2luZyhmdW5jKSB7CiAgICAgIHRoaXMubWlzc2luZyA9IGZ1bmM7CiAgICB9OwoKICAgIF9wcm90bzIuY29tcGlsZSA9IGZ1bmN0aW9uIGNvbXBpbGUobmFtZSwgcGFyYW1zLCBoYXNoLCB0ZW1wbGF0ZSwgaW52ZXJzZSwgYnVpbGRlcikgewogICAgICB2YXIgaW5kZXggPSB0aGlzLm5hbWVzW25hbWVdOwoKICAgICAgaWYgKGluZGV4ID09PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgZnVuYyA9IHRoaXMubWlzc2luZzsKICAgICAgICB2YXIgaGFuZGxlZCA9IGZ1bmMobmFtZSwgcGFyYW1zLCBoYXNoLCB0ZW1wbGF0ZSwgaW52ZXJzZSwgYnVpbGRlcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIF9mdW5jID0gdGhpcy5mdW5jc1tpbmRleF07CgogICAgICAgIF9mdW5jKHBhcmFtcywgaGFzaCwgdGVtcGxhdGUsIGludmVyc2UsIGJ1aWxkZXIpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBCbG9ja3M7CiAgfSgpOwoKICB2YXIgSW5saW5lcyA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIElubGluZXMoKSB7CiAgICAgIHRoaXMubmFtZXMgPSAoMCwgX3V0aWwuZGljdCkoKTsKICAgICAgdGhpcy5mdW5jcyA9IFtdOwogICAgfQoKICAgIHZhciBfcHJvdG8zID0gSW5saW5lcy5wcm90b3R5cGU7CgogICAgX3Byb3RvMy5hZGQgPSBmdW5jdGlvbiBhZGQobmFtZSwgZnVuYykgewogICAgICB0aGlzLmZ1bmNzLnB1c2goZnVuYyk7CiAgICAgIHRoaXMubmFtZXNbbmFtZV0gPSB0aGlzLmZ1bmNzLmxlbmd0aCAtIDE7CiAgICB9OwoKICAgIF9wcm90bzMuYWRkTWlzc2luZyA9IGZ1bmN0aW9uIGFkZE1pc3NpbmcoZnVuYykgewogICAgICB0aGlzLm1pc3NpbmcgPSBmdW5jOwogICAgfTsKCiAgICBfcHJvdG8zLmNvbXBpbGUgPSBmdW5jdGlvbiBjb21waWxlKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgdmFyIHZhbHVlID0gc2V4cFsxXTsgLy8gVE9ETzogRml4IHRoaXMgc28gdGhhdCBleHByZXNzaW9uIG1hY3JvcyBjYW4gcmV0dXJuCiAgICAgIC8vIHRoaW5ncyBsaWtlIGNvbXBvbmVudHMsIHNvIHRoYXQge3tjb21wb25lbnQgZm9vfX0KICAgICAgLy8gaXMgdGhlIHNhbWUgYXMge3soY29tcG9uZW50IGZvbyl9fQoKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHZhbHVlKSkgcmV0dXJuIFsnZXhwcicsIHZhbHVlXTsKICAgICAgdmFyIG5hbWU7CiAgICAgIHZhciBwYXJhbXM7CiAgICAgIHZhciBoYXNoOwoKICAgICAgaWYgKHZhbHVlWzBdID09PSBPcHMkMi5IZWxwZXIpIHsKICAgICAgICBuYW1lID0gdmFsdWVbMV07CiAgICAgICAgcGFyYW1zID0gdmFsdWVbMl07CiAgICAgICAgaGFzaCA9IHZhbHVlWzNdOwogICAgICB9IGVsc2UgaWYgKHZhbHVlWzBdID09PSBPcHMkMi5Vbmtub3duKSB7CiAgICAgICAgbmFtZSA9IHZhbHVlWzFdOwogICAgICAgIHBhcmFtcyA9IGhhc2ggPSBudWxsOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBbJ2V4cHInLCB2YWx1ZV07CiAgICAgIH0KCiAgICAgIHZhciBpbmRleCA9IHRoaXMubmFtZXNbbmFtZV07CgogICAgICBpZiAoaW5kZXggPT09IHVuZGVmaW5lZCAmJiB0aGlzLm1pc3NpbmcpIHsKICAgICAgICB2YXIgZnVuYyA9IHRoaXMubWlzc2luZzsKICAgICAgICB2YXIgcmV0dXJuZWQgPSBmdW5jKG5hbWUsIHBhcmFtcywgaGFzaCwgYnVpbGRlcik7CiAgICAgICAgcmV0dXJuIHJldHVybmVkID09PSBmYWxzZSA/IFsnZXhwcicsIHZhbHVlXSA6IHJldHVybmVkOwogICAgICB9IGVsc2UgaWYgKGluZGV4ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgX2Z1bmMyID0gdGhpcy5mdW5jc1tpbmRleF07CgogICAgICAgIHZhciBfcmV0dXJuZWQgPSBfZnVuYzIobmFtZSwgcGFyYW1zLCBoYXNoLCBidWlsZGVyKTsKCiAgICAgICAgcmV0dXJuIF9yZXR1cm5lZCA9PT0gZmFsc2UgPyBbJ2V4cHInLCB2YWx1ZV0gOiBfcmV0dXJuZWQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIFsnZXhwcicsIHZhbHVlXTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gSW5saW5lczsKICB9KCk7CgogIGZ1bmN0aW9uIHBvcHVsYXRlQnVpbHRpbnMoYmxvY2tzLCBpbmxpbmVzKSB7CiAgICBpZiAoYmxvY2tzID09PSB2b2lkIDApIHsKICAgICAgYmxvY2tzID0gbmV3IEJsb2NrcygpOwogICAgfQoKICAgIGlmIChpbmxpbmVzID09PSB2b2lkIDApIHsKICAgICAgaW5saW5lcyA9IG5ldyBJbmxpbmVzKCk7CiAgICB9CgogICAgYmxvY2tzLmFkZCgnaWYnLCBmdW5jdGlvbiAocGFyYW1zLCBfaGFzaCwgdGVtcGxhdGUsIGludmVyc2UsIGJ1aWxkZXIpIHsKICAgICAgLy8gICAgICAgIFB1dEFyZ3MKICAgICAgLy8gICAgICAgIFRlc3QoRW52aXJvbm1lbnQpCiAgICAgIC8vICAgICAgICBFbnRlcihCRUdJTiwgRU5EKQogICAgICAvLyBCRUdJTjogTm9vcAogICAgICAvLyAgICAgICAgSnVtcFVubGVzcyhFTFNFKQogICAgICAvLyAgICAgICAgRXZhbHVhdGUoZGVmYXVsdCkKICAgICAgLy8gICAgICAgIEp1bXAoRU5EKQogICAgICAvLyBFTFNFOiAgTm9vcAogICAgICAvLyAgICAgICAgRXZhbHVsYXRlKGludmVyc2UpCiAgICAgIC8vIEVORDogICBOb29wCiAgICAgIC8vICAgICAgICBFeGl0CiAgICAgIGlmICghcGFyYW1zIHx8IHBhcmFtcy5sZW5ndGggIT09IDEpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNZTlRBWCBFUlJPUjogI2lmIHJlcXVpcmVzIGEgc2luZ2xlIGFyZ3VtZW50Iik7CiAgICAgIH0KCiAgICAgIGJ1aWxkZXIucmVwbGF5YWJsZUlmKHsKICAgICAgICBhcmdzOiBmdW5jdGlvbiBhcmdzKCkgewogICAgICAgICAgYnVpbGRlci5leHByKHBhcmFtc1swXSk7CiAgICAgICAgICBidWlsZGVyLnRvQm9vbGVhbigpOwogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfSwKICAgICAgICBpZlRydWU6IGZ1bmN0aW9uIGlmVHJ1ZSgpIHsKICAgICAgICAgIGJ1aWxkZXIuaW52b2tlU3RhdGljQmxvY2sodGVtcGxhdGUpOwogICAgICAgIH0sCiAgICAgICAgaWZGYWxzZTogZnVuY3Rpb24gaWZGYWxzZSgpIHsKICAgICAgICAgIGlmIChpbnZlcnNlKSB7CiAgICAgICAgICAgIGJ1aWxkZXIuaW52b2tlU3RhdGljQmxvY2soaW52ZXJzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogICAgYmxvY2tzLmFkZCgndW5sZXNzJywgZnVuY3Rpb24gKHBhcmFtcywgX2hhc2gsIHRlbXBsYXRlLCBpbnZlcnNlLCBidWlsZGVyKSB7CiAgICAgIC8vICAgICAgICBQdXRBcmdzCiAgICAgIC8vICAgICAgICBUZXN0KEVudmlyb25tZW50KQogICAgICAvLyAgICAgICAgRW50ZXIoQkVHSU4sIEVORCkKICAgICAgLy8gQkVHSU46IE5vb3AKICAgICAgLy8gICAgICAgIEp1bXBVbmxlc3MoRUxTRSkKICAgICAgLy8gICAgICAgIEV2YWx1YXRlKGRlZmF1bHQpCiAgICAgIC8vICAgICAgICBKdW1wKEVORCkKICAgICAgLy8gRUxTRTogIE5vb3AKICAgICAgLy8gICAgICAgIEV2YWx1bGF0ZShpbnZlcnNlKQogICAgICAvLyBFTkQ6ICAgTm9vcAogICAgICAvLyAgICAgICAgRXhpdAogICAgICBpZiAoIXBhcmFtcyB8fCBwYXJhbXMubGVuZ3RoICE9PSAxKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTWU5UQVggRVJST1I6ICN1bmxlc3MgcmVxdWlyZXMgYSBzaW5nbGUgYXJndW1lbnQiKTsKICAgICAgfQoKICAgICAgYnVpbGRlci5yZXBsYXlhYmxlSWYoewogICAgICAgIGFyZ3M6IGZ1bmN0aW9uIGFyZ3MoKSB7CiAgICAgICAgICBidWlsZGVyLmV4cHIocGFyYW1zWzBdKTsKICAgICAgICAgIGJ1aWxkZXIudG9Cb29sZWFuKCk7CiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9LAogICAgICAgIGlmVHJ1ZTogZnVuY3Rpb24gaWZUcnVlKCkgewogICAgICAgICAgaWYgKGludmVyc2UpIHsKICAgICAgICAgICAgYnVpbGRlci5pbnZva2VTdGF0aWNCbG9jayhpbnZlcnNlKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGlmRmFsc2U6IGZ1bmN0aW9uIGlmRmFsc2UoKSB7CiAgICAgICAgICBidWlsZGVyLmludm9rZVN0YXRpY0Jsb2NrKHRlbXBsYXRlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgICBibG9ja3MuYWRkKCd3aXRoJywgZnVuY3Rpb24gKHBhcmFtcywgX2hhc2gsIHRlbXBsYXRlLCBpbnZlcnNlLCBidWlsZGVyKSB7CiAgICAgIC8vICAgICAgICBQdXRBcmdzCiAgICAgIC8vICAgICAgICBUZXN0KEVudmlyb25tZW50KQogICAgICAvLyAgICAgICAgRW50ZXIoQkVHSU4sIEVORCkKICAgICAgLy8gQkVHSU46IE5vb3AKICAgICAgLy8gICAgICAgIEp1bXBVbmxlc3MoRUxTRSkKICAgICAgLy8gICAgICAgIEV2YWx1YXRlKGRlZmF1bHQpCiAgICAgIC8vICAgICAgICBKdW1wKEVORCkKICAgICAgLy8gRUxTRTogIE5vb3AKICAgICAgLy8gICAgICAgIEV2YWx1bGF0ZShpbnZlcnNlKQogICAgICAvLyBFTkQ6ICAgTm9vcAogICAgICAvLyAgICAgICAgRXhpdAogICAgICBpZiAoIXBhcmFtcyB8fCBwYXJhbXMubGVuZ3RoICE9PSAxKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTWU5UQVggRVJST1I6ICN3aXRoIHJlcXVpcmVzIGEgc2luZ2xlIGFyZ3VtZW50Iik7CiAgICAgIH0KCiAgICAgIGJ1aWxkZXIucmVwbGF5YWJsZUlmKHsKICAgICAgICBhcmdzOiBmdW5jdGlvbiBhcmdzKCkgewogICAgICAgICAgYnVpbGRlci5leHByKHBhcmFtc1swXSk7CiAgICAgICAgICBidWlsZGVyLmR1cCgpOwogICAgICAgICAgYnVpbGRlci50b0Jvb2xlYW4oKTsKICAgICAgICAgIHJldHVybiAyOwogICAgICAgIH0sCiAgICAgICAgaWZUcnVlOiBmdW5jdGlvbiBpZlRydWUoKSB7CiAgICAgICAgICBidWlsZGVyLmludm9rZVN0YXRpY0Jsb2NrKHRlbXBsYXRlLCAxKTsKICAgICAgICB9LAogICAgICAgIGlmRmFsc2U6IGZ1bmN0aW9uIGlmRmFsc2UoKSB7CiAgICAgICAgICBpZiAoaW52ZXJzZSkgewogICAgICAgICAgICBidWlsZGVyLmludm9rZVN0YXRpY0Jsb2NrKGludmVyc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICAgIGJsb2Nrcy5hZGQoJ2VhY2gnLCBmdW5jdGlvbiAocGFyYW1zLCBoYXNoLCB0ZW1wbGF0ZSwgaW52ZXJzZSwgYnVpbGRlcikgewogICAgICAvLyAgICAgICAgIEVudGVyKEJFR0lOLCBFTkQpCiAgICAgIC8vIEJFR0lOOiAgTm9vcAogICAgICAvLyAgICAgICAgIFB1dEFyZ3MKICAgICAgLy8gICAgICAgICBQdXRJdGVyYWJsZQogICAgICAvLyAgICAgICAgIEp1bXBVbmxlc3MoRUxTRSkKICAgICAgLy8gICAgICAgICBFbnRlckxpc3QoQkVHSU4yLCBFTkQyKQogICAgICAvLyBJVEVSOiAgIE5vb3AKICAgICAgLy8gICAgICAgICBOZXh0SXRlcihCUkVBSykKICAgICAgLy8gQkVHSU4yOiBOb29wCiAgICAgIC8vICAgICAgICAgUHVzaENoaWxkU2NvcGUKICAgICAgLy8gICAgICAgICBFdmFsdWF0ZShkZWZhdWx0KQogICAgICAvLyAgICAgICAgIFBvcFNjb3BlCiAgICAgIC8vIEVORDI6ICAgTm9vcAogICAgICAvLyAgICAgICAgIEV4aXQKICAgICAgLy8gICAgICAgICBKdW1wKElURVIpCiAgICAgIC8vIEJSRUFLOiAgTm9vcAogICAgICAvLyAgICAgICAgIEV4aXRMaXN0CiAgICAgIC8vICAgICAgICAgSnVtcChFTkQpCiAgICAgIC8vIEVMU0U6ICAgTm9vcAogICAgICAvLyAgICAgICAgIEV2YWx1bGF0ZShpbnZlcnNlKQogICAgICAvLyBFTkQ6ICAgIE5vb3AKICAgICAgLy8gICAgICAgICBFeGl0CiAgICAgIGJ1aWxkZXIucmVwbGF5YWJsZSh7CiAgICAgICAgYXJnczogZnVuY3Rpb24gYXJncygpIHsKICAgICAgICAgIGlmIChoYXNoICYmIGhhc2hbMF1bMF0gPT09ICdrZXknKSB7CiAgICAgICAgICAgIGJ1aWxkZXIuZXhwcihoYXNoWzFdWzBdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJ1aWxkZXIucHVzaFByaW1pdGl2ZVJlZmVyZW5jZShudWxsKTsKICAgICAgICAgIH0KCiAgICAgICAgICBidWlsZGVyLmV4cHIocGFyYW1zWzBdKTsKICAgICAgICAgIHJldHVybiAyOwogICAgICAgIH0sCiAgICAgICAgYm9keTogZnVuY3Rpb24gYm9keSgpIHsKICAgICAgICAgIGJ1aWxkZXIucHV0SXRlcmF0b3IoKTsKICAgICAgICAgIGJ1aWxkZXIuanVtcFVubGVzcygnRUxTRScpOwogICAgICAgICAgYnVpbGRlci5wdXNoRnJhbWUoKTsKICAgICAgICAgIGJ1aWxkZXIuZHVwKF92bS5SZWdpc3Rlci5mcCwgMSk7CiAgICAgICAgICBidWlsZGVyLnJldHVyblRvKCdJVEVSJyk7CiAgICAgICAgICBidWlsZGVyLmVudGVyTGlzdCgnQk9EWScpOwogICAgICAgICAgYnVpbGRlci5sYWJlbCgnSVRFUicpOwogICAgICAgICAgYnVpbGRlci5pdGVyYXRlKCdCUkVBSycpOwogICAgICAgICAgYnVpbGRlci5sYWJlbCgnQk9EWScpOwogICAgICAgICAgYnVpbGRlci5pbnZva2VTdGF0aWNCbG9jayh0ZW1wbGF0ZSwgMik7CiAgICAgICAgICBidWlsZGVyLnBvcCgyKTsKICAgICAgICAgIGJ1aWxkZXIuanVtcCgnRklOQUxMWScpOwogICAgICAgICAgYnVpbGRlci5sYWJlbCgnQlJFQUsnKTsKICAgICAgICAgIGJ1aWxkZXIuZXhpdExpc3QoKTsKICAgICAgICAgIGJ1aWxkZXIucG9wRnJhbWUoKTsKICAgICAgICAgIGJ1aWxkZXIuanVtcCgnRklOQUxMWScpOwogICAgICAgICAgYnVpbGRlci5sYWJlbCgnRUxTRScpOwoKICAgICAgICAgIGlmIChpbnZlcnNlKSB7CiAgICAgICAgICAgIGJ1aWxkZXIuaW52b2tlU3RhdGljQmxvY2soaW52ZXJzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogICAgYmxvY2tzLmFkZCgnaW4tZWxlbWVudCcsIGZ1bmN0aW9uIChwYXJhbXMsIGhhc2gsIHRlbXBsYXRlLCBfaW52ZXJzZSwgYnVpbGRlcikgewogICAgICBpZiAoIXBhcmFtcyB8fCBwYXJhbXMubGVuZ3RoICE9PSAxKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTWU5UQVggRVJST1I6ICNpbi1lbGVtZW50IHJlcXVpcmVzIGEgc2luZ2xlIGFyZ3VtZW50Iik7CiAgICAgIH0KCiAgICAgIGJ1aWxkZXIucmVwbGF5YWJsZUlmKHsKICAgICAgICBhcmdzOiBmdW5jdGlvbiBhcmdzKCkgewogICAgICAgICAgdmFyIGtleXMgPSBoYXNoWzBdLAogICAgICAgICAgICAgIHZhbHVlcyA9IGhhc2hbMV07CgogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwoKICAgICAgICAgICAgaWYgKGtleSA9PT0gJ25leHRTaWJsaW5nJyB8fCBrZXkgPT09ICdndWlkJykgewogICAgICAgICAgICAgIGJ1aWxkZXIuZXhwcih2YWx1ZXNbaV0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU1lOVEFYIEVSUk9SOiAjaW4tZWxlbWVudCBkb2VzIG5vdCB0YWtlIGEgYCIgKyBrZXlzWzBdICsgImAgb3B0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBidWlsZGVyLmV4cHIocGFyYW1zWzBdKTsKICAgICAgICAgIGJ1aWxkZXIuZHVwKCk7CiAgICAgICAgICByZXR1cm4gNDsKICAgICAgICB9LAogICAgICAgIGlmVHJ1ZTogZnVuY3Rpb24gaWZUcnVlKCkgewogICAgICAgICAgYnVpbGRlci5wdXNoUmVtb3RlRWxlbWVudCgpOwogICAgICAgICAgYnVpbGRlci5pbnZva2VTdGF0aWNCbG9jayh0ZW1wbGF0ZSk7CiAgICAgICAgICBidWlsZGVyLnBvcFJlbW90ZUVsZW1lbnQoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgICBibG9ja3MuYWRkKCctd2l0aC1keW5hbWljLXZhcnMnLCBmdW5jdGlvbiAoX3BhcmFtcywgaGFzaCwgdGVtcGxhdGUsIF9pbnZlcnNlLCBidWlsZGVyKSB7CiAgICAgIGlmIChoYXNoKSB7CiAgICAgICAgdmFyIG5hbWVzID0gaGFzaFswXSwKICAgICAgICAgICAgZXhwcmVzc2lvbnMgPSBoYXNoWzFdOwogICAgICAgIGJ1aWxkZXIuY29tcGlsZVBhcmFtcyhleHByZXNzaW9ucyk7CiAgICAgICAgYnVpbGRlci5wdXNoRHluYW1pY1Njb3BlKCk7CiAgICAgICAgYnVpbGRlci5iaW5kRHluYW1pY1Njb3BlKG5hbWVzKTsKICAgICAgICBidWlsZGVyLmludm9rZVN0YXRpY0Jsb2NrKHRlbXBsYXRlKTsKICAgICAgICBidWlsZGVyLnBvcER5bmFtaWNTY29wZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIGJ1aWxkZXIuaW52b2tlU3RhdGljQmxvY2sodGVtcGxhdGUpOwogICAgICB9CiAgICB9KTsKICAgIGJsb2Nrcy5hZGQoJ2NvbXBvbmVudCcsIGZ1bmN0aW9uIChfcGFyYW1zLCBoYXNoLCB0ZW1wbGF0ZSwgaW52ZXJzZSwgYnVpbGRlcikgewogICAgICB2YXIgdGFnID0gX3BhcmFtc1swXTsKCiAgICAgIGlmICh0eXBlb2YgdGFnID09PSAnc3RyaW5nJykgewogICAgICAgIHZhciByZXR1cm5lZCA9IGJ1aWxkZXIuc3RhdGljQ29tcG9uZW50SGVscGVyKF9wYXJhbXNbMF0sIGhhc2gsIHRlbXBsYXRlKTsKICAgICAgICBpZiAocmV0dXJuZWQpIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGRlZmluaXRpb24gPSBfcGFyYW1zWzBdLAogICAgICAgICAgcGFyYW1zID0gX3BhcmFtcy5zbGljZSgxKTsKCiAgICAgIGJ1aWxkZXIuZHluYW1pY0NvbXBvbmVudChkZWZpbml0aW9uLCBudWxsLCBwYXJhbXMsIGhhc2gsIHRydWUsIHRlbXBsYXRlLCBpbnZlcnNlKTsKICAgIH0pOwogICAgaW5saW5lcy5hZGQoJ2NvbXBvbmVudCcsIGZ1bmN0aW9uIChfbmFtZSwgX3BhcmFtcywgaGFzaCwgYnVpbGRlcikgewogICAgICB2YXIgdGFnID0gX3BhcmFtcyAmJiBfcGFyYW1zWzBdOwoKICAgICAgaWYgKHR5cGVvZiB0YWcgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdmFyIHJldHVybmVkID0gYnVpbGRlci5zdGF0aWNDb21wb25lbnRIZWxwZXIodGFnLCBoYXNoLCBudWxsKTsKICAgICAgICBpZiAocmV0dXJuZWQpIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICB2YXIgZGVmaW5pdGlvbiA9IF9wYXJhbXNbMF0sCiAgICAgICAgICBwYXJhbXMgPSBfcGFyYW1zLnNsaWNlKDEpOwoKICAgICAgYnVpbGRlci5keW5hbWljQ29tcG9uZW50KGRlZmluaXRpb24sIG51bGwsIHBhcmFtcywgaGFzaCwgdHJ1ZSwgbnVsbCwgbnVsbCk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSk7CiAgICByZXR1cm4gewogICAgICBibG9ja3M6IGJsb2NrcywKICAgICAgaW5saW5lczogaW5saW5lcwogICAgfTsKICB9CgogIHZhciBQTEFDRUhPTERFUl9IQU5ETEUkMSA9IC0xOwoKICB2YXIgQ29tcGlsYWJsZVByb2dyYW0gPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBDb21waWxhYmxlUHJvZ3JhbShjb21waWxlciwgbGF5b3V0KSB7CiAgICAgIHRoaXMuY29tcGlsZXIgPSBjb21waWxlcjsKICAgICAgdGhpcy5sYXlvdXQgPSBsYXlvdXQ7CiAgICAgIHRoaXMuY29tcGlsZWQgPSBudWxsOwogICAgfQoKICAgIHZhciBfcHJvdG80ID0gQ29tcGlsYWJsZVByb2dyYW0ucHJvdG90eXBlOwoKICAgIF9wcm90bzQuY29tcGlsZSA9IGZ1bmN0aW9uIGNvbXBpbGUoKSB7CiAgICAgIGlmICh0aGlzLmNvbXBpbGVkICE9PSBudWxsKSByZXR1cm4gdGhpcy5jb21waWxlZDsKICAgICAgdGhpcy5jb21waWxlZCA9IFBMQUNFSE9MREVSX0hBTkRMRSQxOwogICAgICB2YXIgc3RhdGVtZW50cyA9IHRoaXMubGF5b3V0LmJsb2NrLnN0YXRlbWVudHM7CiAgICAgIHJldHVybiB0aGlzLmNvbXBpbGVkID0gdGhpcy5jb21waWxlci5hZGQoc3RhdGVtZW50cywgdGhpcy5sYXlvdXQpOwogICAgfTsKCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKENvbXBpbGFibGVQcm9ncmFtLCBbewogICAgICBrZXk6ICJzeW1ib2xUYWJsZSIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLmxheW91dC5ibG9jazsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIENvbXBpbGFibGVQcm9ncmFtOwogIH0oKTsKCiAgX2V4cG9ydHMuQ29tcGlsYWJsZVByb2dyYW0gPSBDb21waWxhYmxlUHJvZ3JhbTsKCiAgdmFyIENvbXBpbGFibGVCbG9jayA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIENvbXBpbGFibGVCbG9jayhjb21waWxlciwgcGFyc2VkKSB7CiAgICAgIHRoaXMuY29tcGlsZXIgPSBjb21waWxlcjsKICAgICAgdGhpcy5wYXJzZWQgPSBwYXJzZWQ7CiAgICAgIHRoaXMuY29tcGlsZWQgPSBudWxsOwogICAgfQoKICAgIHZhciBfcHJvdG81ID0gQ29tcGlsYWJsZUJsb2NrLnByb3RvdHlwZTsKCiAgICBfcHJvdG81LmNvbXBpbGUgPSBmdW5jdGlvbiBjb21waWxlKCkgewogICAgICBpZiAodGhpcy5jb21waWxlZCAhPT0gbnVsbCkgcmV0dXJuIHRoaXMuY29tcGlsZWQ7IC8vIFRyYWNrIHRoYXQgY29tcGlsYXRpb24gaGFzIHN0YXJ0ZWQgYnV0IG5vdCB5ZXQgZmluaXNoZWQgYnkgdGVtcG9yYXJpbHkKICAgICAgLy8gdXNpbmcgYSBwbGFjZWhvbGRlciBoYW5kbGUuIEluIGVhZ2VyIGNvbXBpbGF0aW9uIG1vZGUsIHdoZXJlIGNvbXBpbGUoKQogICAgICAvLyBtYXkgYmUgY2FsbGVkIHJlY3Vyc2l2ZWx5LCB3ZSB1c2UgdGhpcyBhcyBhIHNpZ25hbCB0aGF0IHRoZSBoYW5kbGUgY2Fubm90CiAgICAgIC8vIGJlIGtub3duIHN5bmNocm9ub3VzbHkgYW5kIG11c3QgYmUgbGlua2VkIGxhemlseS4KCiAgICAgIHRoaXMuY29tcGlsZWQgPSBQTEFDRUhPTERFUl9IQU5ETEUkMTsKICAgICAgdmFyIF90aGlzJHBhcnNlZCA9IHRoaXMucGFyc2VkLAogICAgICAgICAgc3RhdGVtZW50cyA9IF90aGlzJHBhcnNlZC5ibG9jay5zdGF0ZW1lbnRzLAogICAgICAgICAgY29udGFpbmluZ0xheW91dCA9IF90aGlzJHBhcnNlZC5jb250YWluaW5nTGF5b3V0OwogICAgICByZXR1cm4gdGhpcy5jb21waWxlZCA9IHRoaXMuY29tcGlsZXIuYWRkKHN0YXRlbWVudHMsIGNvbnRhaW5pbmdMYXlvdXQpOwogICAgfTsKCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKENvbXBpbGFibGVCbG9jaywgW3sKICAgICAga2V5OiAic3ltYm9sVGFibGUiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5wYXJzZWQuYmxvY2s7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBDb21waWxhYmxlQmxvY2s7CiAgfSgpOwoKICBfZXhwb3J0cy5Db21waWxhYmxlQmxvY2sgPSBDb21waWxhYmxlQmxvY2s7CgogIGZ1bmN0aW9uIGNvbXBpbGUoc3RhdGVtZW50cywgYnVpbGRlciwgY29tcGlsZXIpIHsKICAgIHZhciBzQ29tcGlsZXIgPSBzdGF0ZW1lbnRDb21waWxlcigpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RhdGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICBzQ29tcGlsZXIuY29tcGlsZShzdGF0ZW1lbnRzW2ldLCBidWlsZGVyKTsKICAgIH0KCiAgICB2YXIgaGFuZGxlID0gYnVpbGRlci5jb21taXQoKTsKICAgIHJldHVybiBoYW5kbGU7CiAgfQoKICBmdW5jdGlvbiBkZWJ1Z1NsaWNlKHByb2dyYW0sIHN0YXJ0LCBlbmQpIHt9CgogIGZ1bmN0aW9uIGxvZ09wY29kZSh0eXBlLCBwYXJhbXMpIHsKICAgIHZhciBvdXQgPSB0eXBlOwoKICAgIGlmIChwYXJhbXMpIHsKICAgICAgdmFyIGFyZ3MgPSBPYmplY3Qua2V5cyhwYXJhbXMpLm1hcChmdW5jdGlvbiAocCkgewogICAgICAgIHJldHVybiAiICIgKyBwICsgIj0iICsganNvbihwYXJhbXNbcF0pOwogICAgICB9KS5qb2luKCcnKTsKICAgICAgb3V0ICs9IGFyZ3M7CiAgICB9CgogICAgcmV0dXJuICIoIiArIG91dCArICIpIjsKICB9CgogIGZ1bmN0aW9uIGpzb24ocGFyYW0pIHt9CgogIGZ1bmN0aW9uIGRlYnVnKHBvcywgYywgb3ApIHsKICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBvcGVyYW5kcyA9IG5ldyBBcnJheShfbGVuID4gMyA/IF9sZW4gLSAzIDogMCksIF9rZXkgPSAzOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgIG9wZXJhbmRzW19rZXkgLSAzXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgIH0KCiAgICB2YXIgbWV0YWRhdGEgPSBudWxsOwoKICAgIGlmICghbWV0YWRhdGEpIHsKICAgICAgdGhyb3cgKDAsIF91dGlsLnVucmVhY2hhYmxlKSgiTWlzc2luZyBPcGNvZGUgTWV0YWRhdGEgZm9yICIgKyBvcCk7CiAgICB9CgogICAgdmFyIG91dCA9ICgwLCBfdXRpbC5kaWN0KSgpOwogICAgbWV0YWRhdGEub3BzLmZvckVhY2goZnVuY3Rpb24gKG9wZXJhbmQsIGluZGV4KSB7CiAgICAgIHZhciBvcCA9IG9wZXJhbmRzW2luZGV4XTsKCiAgICAgIHN3aXRjaCAob3BlcmFuZC50eXBlKSB7CiAgICAgICAgY2FzZSAndG8nOgogICAgICAgICAgb3V0W29wZXJhbmQubmFtZV0gPSBwb3MgKyBvcDsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdpMzInOgogICAgICAgIGNhc2UgJ3N5bWJvbCc6CiAgICAgICAgY2FzZSAnYmxvY2snOgogICAgICAgICAgb3V0W29wZXJhbmQubmFtZV0gPSBvcDsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdoYW5kbGUnOgogICAgICAgICAgb3V0W29wZXJhbmQubmFtZV0gPSBjLnJlc29sdmVIYW5kbGUob3ApOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3N0cic6CiAgICAgICAgICBvdXRbb3BlcmFuZC5uYW1lXSA9IGMuZ2V0U3RyaW5nKG9wKTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdvcHRpb24tc3RyJzoKICAgICAgICAgIG91dFtvcGVyYW5kLm5hbWVdID0gb3AgPyBjLmdldFN0cmluZyhvcCkgOiBudWxsOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3N0ci1hcnJheSc6CiAgICAgICAgICBvdXRbb3BlcmFuZC5uYW1lXSA9IGMuZ2V0U3RyaW5nQXJyYXkob3ApOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ2FycmF5JzoKICAgICAgICAgIG91dFtvcGVyYW5kLm5hbWVdID0gYy5nZXRBcnJheShvcCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnYm9vbCc6CiAgICAgICAgICBvdXRbb3BlcmFuZC5uYW1lXSA9ICEhb3A7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAncHJpbWl0aXZlJzoKICAgICAgICAgIG91dFtvcGVyYW5kLm5hbWVdID0gZGVjb2RlUHJpbWl0aXZlKG9wLCBjKTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdyZWdpc3Rlcic6CiAgICAgICAgICBvdXRbb3BlcmFuZC5uYW1lXSA9IF92bS5SZWdpc3RlcltvcF07CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnc2VyaWFsaXphYmxlJzoKICAgICAgICAgIG91dFtvcGVyYW5kLm5hbWVdID0gYy5nZXRTZXJpYWxpemFibGUob3ApOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ2xhenktY29uc3RhbnQnOgogICAgICAgICAgb3V0W29wZXJhbmQubmFtZV0gPSBjLmdldE90aGVyKG9wKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBbbWV0YWRhdGEubmFtZSwgb3V0XTsKICB9CgogIGZ1bmN0aW9uIGRlY29kZVByaW1pdGl2ZShwcmltaXRpdmUsIGNvbnN0YW50cykgewogICAgdmFyIGZsYWcgPSBwcmltaXRpdmUgJiA3OyAvLyAxMTEKCiAgICB2YXIgdmFsdWUgPSBwcmltaXRpdmUgPj4gMzsKCiAgICBzd2l0Y2ggKGZsYWcpIHsKICAgICAgY2FzZSAwCiAgICAgIC8qIE5VTUJFUiAqLwogICAgICA6CiAgICAgICAgcmV0dXJuIHZhbHVlOwoKICAgICAgY2FzZSAxCiAgICAgIC8qIEZMT0FUICovCiAgICAgIDoKICAgICAgICByZXR1cm4gY29uc3RhbnRzLmdldE51bWJlcih2YWx1ZSk7CgogICAgICBjYXNlIDIKICAgICAgLyogU1RSSU5HICovCiAgICAgIDoKICAgICAgICByZXR1cm4gY29uc3RhbnRzLmdldFN0cmluZyh2YWx1ZSk7CgogICAgICBjYXNlIDMKICAgICAgLyogQk9PTEVBTl9PUl9WT0lEICovCiAgICAgIDoKICAgICAgICBzd2l0Y2ggKHZhbHVlKSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgcmV0dXJuIG51bGw7CgogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIH0KCiAgICAgIGNhc2UgNAogICAgICAvKiBORUdBVElWRSAqLwogICAgICA6CiAgICAgIGNhc2UgNQogICAgICAvKiBCSUdfTlVNICovCiAgICAgIDoKICAgICAgICByZXR1cm4gY29uc3RhbnRzLmdldE51bWJlcih2YWx1ZSk7CgogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93ICgwLCBfdXRpbC51bnJlYWNoYWJsZSkoKTsKICAgIH0KICB9CgogIHZhciBTdGRMaWIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBTdGRMaWIobWFpbiwgdHJ1c3RpbmdHdWFyZGVkQXBwZW5kLCBjYXV0aW91c0d1YXJkZWRBcHBlbmQpIHsKICAgICAgdGhpcy5tYWluID0gbWFpbjsKICAgICAgdGhpcy50cnVzdGluZ0d1YXJkZWRBcHBlbmQgPSB0cnVzdGluZ0d1YXJkZWRBcHBlbmQ7CiAgICAgIHRoaXMuY2F1dGlvdXNHdWFyZGVkQXBwZW5kID0gY2F1dGlvdXNHdWFyZGVkQXBwZW5kOwogICAgfQoKICAgIFN0ZExpYi5jb21waWxlID0gZnVuY3Rpb24gY29tcGlsZShjb21waWxlcikgewogICAgICB2YXIgbWFpbiA9IHRoaXMuc3RkKGNvbXBpbGVyLCBmdW5jdGlvbiAoYikgewogICAgICAgIHJldHVybiBiLm1haW4oKTsKICAgICAgfSk7CiAgICAgIHZhciB0cnVzdGluZ0d1YXJkZWRBcHBlbmQgPSB0aGlzLnN0ZChjb21waWxlciwgZnVuY3Rpb24gKGIpIHsKICAgICAgICByZXR1cm4gYi5zdGRBcHBlbmQodHJ1ZSk7CiAgICAgIH0pOwogICAgICB2YXIgY2F1dGlvdXNHdWFyZGVkQXBwZW5kID0gdGhpcy5zdGQoY29tcGlsZXIsIGZ1bmN0aW9uIChiKSB7CiAgICAgICAgcmV0dXJuIGIuc3RkQXBwZW5kKGZhbHNlKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBuZXcgU3RkTGliKG1haW4sIHRydXN0aW5nR3VhcmRlZEFwcGVuZCwgY2F1dGlvdXNHdWFyZGVkQXBwZW5kKTsKICAgIH07CgogICAgU3RkTGliLnN0ZCA9IGZ1bmN0aW9uIHN0ZChjb21waWxlciwgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIFN0ZE9wY29kZUJ1aWxkZXIuYnVpbGQoY29tcGlsZXIsIGNhbGxiYWNrKTsKICAgIH07CgogICAgdmFyIF9wcm90bzYgPSBTdGRMaWIucHJvdG90eXBlOwoKICAgIF9wcm90bzYuZ2V0QXBwZW5kID0gZnVuY3Rpb24gZ2V0QXBwZW5kKHRydXN0aW5nKSB7CiAgICAgIHJldHVybiB0cnVzdGluZyA/IHRoaXMudHJ1c3RpbmdHdWFyZGVkQXBwZW5kIDogdGhpcy5jYXV0aW91c0d1YXJkZWRBcHBlbmQ7CiAgICB9OwoKICAgIHJldHVybiBTdGRMaWI7CiAgfSgpOwoKICB2YXIgQWJzdHJhY3RDb21waWxlciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEFic3RyYWN0Q29tcGlsZXIobWFjcm9zLCBwcm9ncmFtLCByZXNvbHZlcikgewogICAgICB0aGlzLm1hY3JvcyA9IG1hY3JvczsKICAgICAgdGhpcy5wcm9ncmFtID0gcHJvZ3JhbTsKICAgICAgdGhpcy5yZXNvbHZlciA9IHJlc29sdmVyOwogICAgICB0aGlzLmluaXRpYWxpemUoKTsKICAgIH0KCiAgICB2YXIgX3Byb3RvNyA9IEFic3RyYWN0Q29tcGlsZXIucHJvdG90eXBlOwoKICAgIF9wcm90bzcuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uIGluaXRpYWxpemUoKSB7CiAgICAgIHRoaXMuc3RkTGliID0gU3RkTGliLmNvbXBpbGUodGhpcyk7CiAgICB9OwoKICAgIF9wcm90bzcuY29tcGlsZUlubGluZSA9IGZ1bmN0aW9uIGNvbXBpbGVJbmxpbmUoc2V4cCwgYnVpbGRlcikgewogICAgICB2YXIgaW5saW5lcyA9IHRoaXMubWFjcm9zLmlubGluZXM7CiAgICAgIHJldHVybiBpbmxpbmVzLmNvbXBpbGUoc2V4cCwgYnVpbGRlcik7CiAgICB9OwoKICAgIF9wcm90bzcuY29tcGlsZUJsb2NrID0gZnVuY3Rpb24gY29tcGlsZUJsb2NrKG5hbWUsIHBhcmFtcywgaGFzaCwgdGVtcGxhdGUsIGludmVyc2UsIGJ1aWxkZXIpIHsKICAgICAgdmFyIGJsb2NrcyA9IHRoaXMubWFjcm9zLmJsb2NrczsKICAgICAgYmxvY2tzLmNvbXBpbGUobmFtZSwgcGFyYW1zLCBoYXNoLCB0ZW1wbGF0ZSwgaW52ZXJzZSwgYnVpbGRlcik7CiAgICB9OwoKICAgIF9wcm90bzcuYWRkID0gZnVuY3Rpb24gYWRkKHN0YXRlbWVudHMsIGNvbnRhaW5pbmdMYXlvdXQpIHsKICAgICAgcmV0dXJuIGNvbXBpbGUoc3RhdGVtZW50cywgdGhpcy5idWlsZGVyRm9yKGNvbnRhaW5pbmdMYXlvdXQpLCB0aGlzKTsKICAgIH07CgogICAgX3Byb3RvNy5jb21taXQgPSBmdW5jdGlvbiBjb21taXQoc2NvcGVTaXplLCBidWZmZXIpIHsKICAgICAgdmFyIGhlYXAgPSB0aGlzLnByb2dyYW0uaGVhcDsgLy8gVE9ETzogY2hhbmdlIHRoZSB3aG9sZSBtYWxsb2MgQVBJIGFuZCBkbyBzb21ldGhpbmcgbW9yZSBlZmZpY2llbnQKCiAgICAgIHZhciBoYW5kbGUgPSBoZWFwLm1hbGxvYygpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBidWZmZXIubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgdmFsdWUgPSBidWZmZXJbaV07CgogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGhlYXAucHVzaFBsYWNlaG9sZGVyKHZhbHVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaGVhcC5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGhlYXAuZmluaXNoTWFsbG9jKGhhbmRsZSwgc2NvcGVTaXplKTsKICAgICAgcmV0dXJuIGhhbmRsZTsKICAgIH07CgogICAgX3Byb3RvNy5yZXNvbHZlTGF5b3V0Rm9yVGFnID0gZnVuY3Rpb24gcmVzb2x2ZUxheW91dEZvclRhZyh0YWcsIHJlZmVycmVyKSB7CiAgICAgIHZhciByZXNvbHZlciA9IHRoaXMucmVzb2x2ZXI7CiAgICAgIHZhciBoYW5kbGUgPSByZXNvbHZlci5sb29rdXBDb21wb25lbnREZWZpbml0aW9uKHRhZywgcmVmZXJyZXIpOwogICAgICBpZiAoaGFuZGxlID09PSBudWxsKSByZXR1cm4gewogICAgICAgIGhhbmRsZTogbnVsbCwKICAgICAgICBjYXBhYmlsaXRpZXM6IG51bGwsCiAgICAgICAgY29tcGlsYWJsZTogbnVsbAogICAgICB9OwogICAgICByZXR1cm4gdGhpcy5yZXNvbHZlTGF5b3V0Rm9ySGFuZGxlKGhhbmRsZSk7CiAgICB9OwoKICAgIF9wcm90bzcucmVzb2x2ZUxheW91dEZvckhhbmRsZSA9IGZ1bmN0aW9uIHJlc29sdmVMYXlvdXRGb3JIYW5kbGUoaGFuZGxlKSB7CiAgICAgIHZhciByZXNvbHZlciA9IHRoaXMucmVzb2x2ZXI7CiAgICAgIHZhciBjYXBhYmlsaXRpZXMgPSByZXNvbHZlci5nZXRDYXBhYmlsaXRpZXMoaGFuZGxlKTsKICAgICAgdmFyIGNvbXBpbGFibGUgPSBudWxsOwoKICAgICAgaWYgKCFjYXBhYmlsaXRpZXMuZHluYW1pY0xheW91dCkgewogICAgICAgIGNvbXBpbGFibGUgPSByZXNvbHZlci5nZXRMYXlvdXQoaGFuZGxlKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHsKICAgICAgICBoYW5kbGU6IGhhbmRsZSwKICAgICAgICBjYXBhYmlsaXRpZXM6IGNhcGFiaWxpdGllcywKICAgICAgICBjb21waWxhYmxlOiBjb21waWxhYmxlCiAgICAgIH07CiAgICB9OwoKICAgIF9wcm90bzcucmVzb2x2ZU1vZGlmaWVyID0gZnVuY3Rpb24gcmVzb2x2ZU1vZGlmaWVyKG5hbWUsIHJlZmVycmVyKSB7CiAgICAgIHJldHVybiB0aGlzLnJlc29sdmVyLmxvb2t1cE1vZGlmaWVyKG5hbWUsIHJlZmVycmVyKTsKICAgIH07CgogICAgX3Byb3RvNy5yZXNvbHZlSGVscGVyID0gZnVuY3Rpb24gcmVzb2x2ZUhlbHBlcihuYW1lLCByZWZlcnJlcikgewogICAgICByZXR1cm4gdGhpcy5yZXNvbHZlci5sb29rdXBIZWxwZXIobmFtZSwgcmVmZXJyZXIpOwogICAgfTsKCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKEFic3RyYWN0Q29tcGlsZXIsIFt7CiAgICAgIGtleTogImNvbnN0YW50cyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLnByb2dyYW0uY29uc3RhbnRzOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQWJzdHJhY3RDb21waWxlcjsKICB9KCk7CgogIF9leHBvcnRzLkFic3RyYWN0Q29tcGlsZXIgPSBBYnN0cmFjdENvbXBpbGVyOwogIHZhciBkZWJ1Z0NvbXBpbGVyOwogIF9leHBvcnRzLmRlYnVnQ29tcGlsZXIgPSBkZWJ1Z0NvbXBpbGVyOwoKICB2YXIgV3JhcHBlZEJ1aWxkZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBXcmFwcGVkQnVpbGRlcihjb21waWxlciwgbGF5b3V0KSB7CiAgICAgIHRoaXMuY29tcGlsZXIgPSBjb21waWxlcjsKICAgICAgdGhpcy5sYXlvdXQgPSBsYXlvdXQ7CiAgICAgIHRoaXMuY29tcGlsZWQgPSBudWxsOwogICAgICB2YXIgYmxvY2sgPSBsYXlvdXQuYmxvY2s7CiAgICAgIHZhciBzeW1ib2xzID0gYmxvY2suc3ltYm9scy5zbGljZSgpOyAvLyBlbnN1cmUgQVRUUlNfQkxPQ0sgaXMgYWx3YXlzIGluY2x1ZGVkIChvbmx5IG9uY2UpIGluIHRoZSBsaXN0IG9mIHN5bWJvbHMKCiAgICAgIHZhciBhdHRyc0Jsb2NrSW5kZXggPSBzeW1ib2xzLmluZGV4T2YoQVRUUlNfQkxPQ0spOwoKICAgICAgaWYgKGF0dHJzQmxvY2tJbmRleCA9PT0gLTEpIHsKICAgICAgICB0aGlzLmF0dHJzQmxvY2tOdW1iZXIgPSBzeW1ib2xzLnB1c2goQVRUUlNfQkxPQ0spOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYXR0cnNCbG9ja051bWJlciA9IGF0dHJzQmxvY2tJbmRleCArIDE7CiAgICAgIH0KCiAgICAgIHRoaXMuc3ltYm9sVGFibGUgPSB7CiAgICAgICAgaGFzRXZhbDogYmxvY2suaGFzRXZhbCwKICAgICAgICBzeW1ib2xzOiBzeW1ib2xzCiAgICAgIH07CiAgICB9CgogICAgdmFyIF9wcm90bzggPSBXcmFwcGVkQnVpbGRlci5wcm90b3R5cGU7CgogICAgX3Byb3RvOC5jb21waWxlID0gZnVuY3Rpb24gY29tcGlsZSgpIHsKICAgICAgaWYgKHRoaXMuY29tcGlsZWQgIT09IG51bGwpIHJldHVybiB0aGlzLmNvbXBpbGVkOyAvLz09PT09PT09RFlOQU1JQwogICAgICAvLyAgICAgICAgUHV0VmFsdWUoVGFnRXhwcikKICAgICAgLy8gICAgICAgIFRlc3QKICAgICAgLy8gICAgICAgIEp1bXBVbmxlc3MoQk9EWSkKICAgICAgLy8gICAgICAgIFB1dENvbXBvbmVudE9wZXJhdGlvbnMKICAgICAgLy8gICAgICAgIE9wZW5EeW5hbWljUHJpbWl0aXZlRWxlbWVudAogICAgICAvLyAgICAgICAgRGlkQ3JlYXRlRWxlbWVudAogICAgICAvLyAgICAgICAgLi4uYXR0ciBzdGF0ZW1lbnRzLi4uCiAgICAgIC8vICAgICAgICBGbHVzaEVsZW1lbnQKICAgICAgLy8gQk9EWTogIE5vb3AKICAgICAgLy8gICAgICAgIC4uLmJvZHkgc3RhdGVtZW50cy4uLgogICAgICAvLyAgICAgICAgUHV0VmFsdWUoVGFnRXhwcikKICAgICAgLy8gICAgICAgIFRlc3QKICAgICAgLy8gICAgICAgIEp1bXBVbmxlc3MoRU5EKQogICAgICAvLyAgICAgICAgQ2xvc2VFbGVtZW50CiAgICAgIC8vIEVORDogICBOb29wCiAgICAgIC8vICAgICAgICBEaWRSZW5kZXJMYXlvdXQKICAgICAgLy8gICAgICAgIEV4aXQKICAgICAgLy8KICAgICAgLy89PT09PT09PVNUQVRJQwogICAgICAvLyAgICAgICAgT3BlblByaW1pdGl2ZUVsZW1lbnRPcGNvZGUKICAgICAgLy8gICAgICAgIERpZENyZWF0ZUVsZW1lbnQKICAgICAgLy8gICAgICAgIC4uLmF0dHIgc3RhdGVtZW50cy4uLgogICAgICAvLyAgICAgICAgRmx1c2hFbGVtZW50CiAgICAgIC8vICAgICAgICAuLi5ib2R5IHN0YXRlbWVudHMuLi4KICAgICAgLy8gICAgICAgIENsb3NlRWxlbWVudAogICAgICAvLyAgICAgICAgRGlkUmVuZGVyTGF5b3V0CiAgICAgIC8vICAgICAgICBFeGl0CgogICAgICB2YXIgY29tcGlsZXIgPSB0aGlzLmNvbXBpbGVyLAogICAgICAgICAgbGF5b3V0ID0gdGhpcy5sYXlvdXQ7CiAgICAgIHZhciBiID0gY29tcGlsZXIuYnVpbGRlckZvcihsYXlvdXQpOwogICAgICBiLnN0YXJ0TGFiZWxzKCk7CiAgICAgIGIuZmV0Y2goX3ZtLlJlZ2lzdGVyLnMxKTsKICAgICAgYi5nZXRDb21wb25lbnRUYWdOYW1lKF92bS5SZWdpc3Rlci5zMCk7CiAgICAgIGIucHJpbWl0aXZlUmVmZXJlbmNlKCk7CiAgICAgIGIuZHVwKCk7CiAgICAgIGIubG9hZChfdm0uUmVnaXN0ZXIuczEpOwogICAgICBiLmp1bXBVbmxlc3MoJ0JPRFknKTsKICAgICAgYi5mZXRjaChfdm0uUmVnaXN0ZXIuczEpOwogICAgICBiLnB1dENvbXBvbmVudE9wZXJhdGlvbnMoKTsKICAgICAgYi5vcGVuRHluYW1pY0VsZW1lbnQoKTsKICAgICAgYi5kaWRDcmVhdGVFbGVtZW50KF92bS5SZWdpc3Rlci5zMCk7CiAgICAgIGIueWllbGQodGhpcy5hdHRyc0Jsb2NrTnVtYmVyLCBbXSk7CiAgICAgIGIuZmx1c2hFbGVtZW50KCk7CiAgICAgIGIubGFiZWwoJ0JPRFknKTsKICAgICAgYi5pbnZva2VTdGF0aWNCbG9jayhibG9ja0ZvcihsYXlvdXQsIGNvbXBpbGVyKSk7CiAgICAgIGIuZmV0Y2goX3ZtLlJlZ2lzdGVyLnMxKTsKICAgICAgYi5qdW1wVW5sZXNzKCdFTkQnKTsKICAgICAgYi5jbG9zZUVsZW1lbnQoKTsKICAgICAgYi5sYWJlbCgnRU5EJyk7CiAgICAgIGIubG9hZChfdm0uUmVnaXN0ZXIuczEpOwogICAgICBiLnN0b3BMYWJlbHMoKTsKICAgICAgdmFyIGhhbmRsZSA9IGIuY29tbWl0KCk7CiAgICAgIHJldHVybiB0aGlzLmNvbXBpbGVkID0gaGFuZGxlOwogICAgfTsKCiAgICByZXR1cm4gV3JhcHBlZEJ1aWxkZXI7CiAgfSgpOwoKICBfZXhwb3J0cy5XcmFwcGVkQnVpbGRlciA9IFdyYXBwZWRCdWlsZGVyOwoKICBmdW5jdGlvbiBibG9ja0ZvcihsYXlvdXQsIGNvbXBpbGVyKSB7CiAgICByZXR1cm4gbmV3IENvbXBpbGFibGVCbG9jayhjb21waWxlciwgewogICAgICBibG9jazogewogICAgICAgIHN0YXRlbWVudHM6IGxheW91dC5ibG9jay5zdGF0ZW1lbnRzLAogICAgICAgIHBhcmFtZXRlcnM6IF91dGlsLkVNUFRZX0FSUkFZCiAgICAgIH0sCiAgICAgIGNvbnRhaW5pbmdMYXlvdXQ6IGxheW91dAogICAgfSk7CiAgfQoKICB2YXIgQ29tcG9uZW50QnVpbGRlciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIENvbXBvbmVudEJ1aWxkZXIoYnVpbGRlcikgewogICAgICB0aGlzLmJ1aWxkZXIgPSBidWlsZGVyOwogICAgfQoKICAgIHZhciBfcHJvdG85ID0gQ29tcG9uZW50QnVpbGRlci5wcm90b3R5cGU7CgogICAgX3Byb3RvOS5zdGF0aWMgPSBmdW5jdGlvbiBfc3RhdGljKGhhbmRsZSwgYXJncykgewogICAgICB2YXIgcGFyYW1zID0gYXJnc1swXSwKICAgICAgICAgIGhhc2ggPSBhcmdzWzFdLAogICAgICAgICAgX2RlZmF1bHQgPSBhcmdzWzJdLAogICAgICAgICAgaW52ZXJzZSA9IGFyZ3NbM107CiAgICAgIHZhciBidWlsZGVyID0gdGhpcy5idWlsZGVyOwoKICAgICAgaWYgKGhhbmRsZSAhPT0gbnVsbCkgewogICAgICAgIHZhciBfYnVpbGRlciRjb21waWxlciRyZXMyID0gYnVpbGRlci5jb21waWxlci5yZXNvbHZlTGF5b3V0Rm9ySGFuZGxlKGhhbmRsZSksCiAgICAgICAgICAgIGNhcGFiaWxpdGllcyA9IF9idWlsZGVyJGNvbXBpbGVyJHJlczIuY2FwYWJpbGl0aWVzLAogICAgICAgICAgICBjb21waWxhYmxlID0gX2J1aWxkZXIkY29tcGlsZXIkcmVzMi5jb21waWxhYmxlOwoKICAgICAgICBpZiAoY29tcGlsYWJsZSkgewogICAgICAgICAgYnVpbGRlci5wdXNoQ29tcG9uZW50RGVmaW5pdGlvbihoYW5kbGUpOwogICAgICAgICAgYnVpbGRlci5pbnZva2VTdGF0aWNDb21wb25lbnQoY2FwYWJpbGl0aWVzLCBjb21waWxhYmxlLCBudWxsLCBwYXJhbXMsIGhhc2gsIGZhbHNlLCBfZGVmYXVsdCwgaW52ZXJzZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJ1aWxkZXIucHVzaENvbXBvbmVudERlZmluaXRpb24oaGFuZGxlKTsKICAgICAgICAgIGJ1aWxkZXIuaW52b2tlQ29tcG9uZW50KGNhcGFiaWxpdGllcywgbnVsbCwgcGFyYW1zLCBoYXNoLCBmYWxzZSwgX2RlZmF1bHQsIGludmVyc2UpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gQ29tcG9uZW50QnVpbGRlcjsKICB9KCk7CgogIHZhciBMYWJlbHMgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBMYWJlbHMoKSB7CiAgICAgIHRoaXMubGFiZWxzID0gKDAsIF91dGlsLmRpY3QpKCk7CiAgICAgIHRoaXMudGFyZ2V0cyA9IFtdOwogICAgfQoKICAgIHZhciBfcHJvdG8xMCA9IExhYmVscy5wcm90b3R5cGU7CgogICAgX3Byb3RvMTAubGFiZWwgPSBmdW5jdGlvbiBsYWJlbChuYW1lLCBpbmRleCkgewogICAgICB0aGlzLmxhYmVsc1tuYW1lXSA9IGluZGV4OwogICAgfTsKCiAgICBfcHJvdG8xMC50YXJnZXQgPSBmdW5jdGlvbiB0YXJnZXQoYXQsIF90YXJnZXQpIHsKICAgICAgdGhpcy50YXJnZXRzLnB1c2goewogICAgICAgIGF0OiBhdCwKICAgICAgICB0YXJnZXQ6IF90YXJnZXQKICAgICAgfSk7CiAgICB9OwoKICAgIF9wcm90bzEwLnBhdGNoID0gZnVuY3Rpb24gcGF0Y2goZW5jb2RlcikgewogICAgICB2YXIgdGFyZ2V0cyA9IHRoaXMudGFyZ2V0cywKICAgICAgICAgIGxhYmVscyA9IHRoaXMubGFiZWxzOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0YXJnZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIF90YXJnZXRzJGkgPSB0YXJnZXRzW2ldLAogICAgICAgICAgICBhdCA9IF90YXJnZXRzJGkuYXQsCiAgICAgICAgICAgIHRhcmdldCA9IF90YXJnZXRzJGkudGFyZ2V0OwogICAgICAgIHZhciBhZGRyZXNzID0gbGFiZWxzW3RhcmdldF0gLSBhdDsKICAgICAgICBlbmNvZGVyLnBhdGNoKGF0LCBhZGRyZXNzKTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gTGFiZWxzOwogIH0oKTsKCiAgdmFyIFN0ZE9wY29kZUJ1aWxkZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBTdGRPcGNvZGVCdWlsZGVyKGNvbXBpbGVyLCBzaXplKSB7CiAgICAgIGlmIChzaXplID09PSB2b2lkIDApIHsKICAgICAgICBzaXplID0gMDsKICAgICAgfQoKICAgICAgdGhpcy5zaXplID0gc2l6ZTsKICAgICAgdGhpcy5lbmNvZGVyID0gbmV3IF9lbmNvZGVyLkluc3RydWN0aW9uRW5jb2RlcihbXSk7CiAgICAgIHRoaXMubGFiZWxzU3RhY2sgPSBuZXcgX3V0aWwuU3RhY2soKTsKICAgICAgdGhpcy5jb21waWxlciA9IGNvbXBpbGVyOwogICAgfQoKICAgIFN0ZE9wY29kZUJ1aWxkZXIuYnVpbGQgPSBmdW5jdGlvbiBidWlsZChjb21waWxlciwgY2FsbGJhY2spIHsKICAgICAgdmFyIGJ1aWxkZXIgPSBuZXcgU3RkT3Bjb2RlQnVpbGRlcihjb21waWxlcik7CiAgICAgIGNhbGxiYWNrKGJ1aWxkZXIpOwogICAgICByZXR1cm4gYnVpbGRlci5jb21taXQoKTsKICAgIH07CgogICAgdmFyIF9wcm90bzExID0gU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGU7CgogICAgX3Byb3RvMTEucHVzaCA9IGZ1bmN0aW9uIHB1c2gobmFtZSkgewogICAgICBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICBjYXNlIDE6CiAgICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGVyLmVuY29kZShuYW1lLCAwKTsKCiAgICAgICAgY2FzZSAyOgogICAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2Rlci5lbmNvZGUobmFtZSwgMCwgYXJndW1lbnRzWzFdKTsKCiAgICAgICAgY2FzZSAzOgogICAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2Rlci5lbmNvZGUobmFtZSwgMCwgYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0pOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2Rlci5lbmNvZGUobmFtZSwgMCwgYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0sIGFyZ3VtZW50c1szXSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMTEucHVzaE1hY2hpbmUgPSBmdW5jdGlvbiBwdXNoTWFjaGluZShuYW1lKSB7CiAgICAgIHN3aXRjaCAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIGNhc2UgMToKICAgICAgICAgIHJldHVybiB0aGlzLmVuY29kZXIuZW5jb2RlKG5hbWUsIDEwMjQKICAgICAgICAgIC8qIE1BQ0hJTkVfTUFTSyAqLwogICAgICAgICAgKTsKCiAgICAgICAgY2FzZSAyOgogICAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2Rlci5lbmNvZGUobmFtZSwgMTAyNAogICAgICAgICAgLyogTUFDSElORV9NQVNLICovCiAgICAgICAgICAsIGFyZ3VtZW50c1sxXSk7CgogICAgICAgIGNhc2UgMzoKICAgICAgICAgIHJldHVybiB0aGlzLmVuY29kZXIuZW5jb2RlKG5hbWUsIDEwMjQKICAgICAgICAgIC8qIE1BQ0hJTkVfTUFTSyAqLwogICAgICAgICAgLCBhcmd1bWVudHNbMV0sIGFyZ3VtZW50c1syXSk7CgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGVyLmVuY29kZShuYW1lLCAxMDI0CiAgICAgICAgICAvKiBNQUNISU5FX01BU0sgKi8KICAgICAgICAgICwgYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0sIGFyZ3VtZW50c1szXSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMTEuY29tbWl0ID0gZnVuY3Rpb24gY29tbWl0KCkgewogICAgICB0aGlzLnB1c2hNYWNoaW5lKDI0CiAgICAgIC8qIFJldHVybiAqLwogICAgICApOwogICAgICByZXR1cm4gdGhpcy5jb21waWxlci5jb21taXQodGhpcy5zaXplLCB0aGlzLmVuY29kZXIuYnVmZmVyKTsKICAgIH07CgogICAgX3Byb3RvMTEucmVzZXJ2ZSA9IGZ1bmN0aW9uIHJlc2VydmUobmFtZSkgewogICAgICB0aGlzLmVuY29kZXIuZW5jb2RlKG5hbWUsIDAsIC0xKTsKICAgIH07CgogICAgX3Byb3RvMTEucmVzZXJ2ZVdpdGhPcGVyYW5kID0gZnVuY3Rpb24gcmVzZXJ2ZVdpdGhPcGVyYW5kKG5hbWUsIG9wZXJhbmQpIHsKICAgICAgdGhpcy5lbmNvZGVyLmVuY29kZShuYW1lLCAwLCAtMSwgb3BlcmFuZCk7CiAgICB9OwoKICAgIF9wcm90bzExLnJlc2VydmVNYWNoaW5lID0gZnVuY3Rpb24gcmVzZXJ2ZU1hY2hpbmUobmFtZSkgewogICAgICB0aGlzLmVuY29kZXIuZW5jb2RlKG5hbWUsIDEwMjQKICAgICAgLyogTUFDSElORV9NQVNLICovCiAgICAgICwgLTEpOwogICAgfSAvLy8KICAgIDsKCiAgICBfcHJvdG8xMS5tYWluID0gZnVuY3Rpb24gbWFpbigpIHsKICAgICAgdGhpcy5wdXNoKDY4CiAgICAgIC8qIE1haW4gKi8KICAgICAgLCBfdm0uUmVnaXN0ZXIuczApOwogICAgICB0aGlzLmludm9rZVByZXBhcmVkQ29tcG9uZW50KGZhbHNlLCBmYWxzZSwgdHJ1ZSk7CiAgICB9OwoKICAgIF9wcm90bzExLmFwcGVuZEhUTUwgPSBmdW5jdGlvbiBhcHBlbmRIVE1MKCkgewogICAgICB0aGlzLnB1c2goMjgKICAgICAgLyogQXBwZW5kSFRNTCAqLwogICAgICApOwogICAgfTsKCiAgICBfcHJvdG8xMS5hcHBlbmRTYWZlSFRNTCA9IGZ1bmN0aW9uIGFwcGVuZFNhZmVIVE1MKCkgewogICAgICB0aGlzLnB1c2goMjkKICAgICAgLyogQXBwZW5kU2FmZUhUTUwgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvMTEuYXBwZW5kRG9jdW1lbnRGcmFnbWVudCA9IGZ1bmN0aW9uIGFwcGVuZERvY3VtZW50RnJhZ21lbnQoKSB7CiAgICAgIHRoaXMucHVzaCgzMAogICAgICAvKiBBcHBlbmREb2N1bWVudEZyYWdtZW50ICovCiAgICAgICk7CiAgICB9OwoKICAgIF9wcm90bzExLmFwcGVuZE5vZGUgPSBmdW5jdGlvbiBhcHBlbmROb2RlKCkgewogICAgICB0aGlzLnB1c2goMzEKICAgICAgLyogQXBwZW5kTm9kZSAqLwogICAgICApOwogICAgfTsKCiAgICBfcHJvdG8xMS5hcHBlbmRUZXh0ID0gZnVuY3Rpb24gYXBwZW5kVGV4dCgpIHsKICAgICAgdGhpcy5wdXNoKDMyCiAgICAgIC8qIEFwcGVuZFRleHQgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvMTEuYmVnaW5Db21wb25lbnRUcmFuc2FjdGlvbiA9IGZ1bmN0aW9uIGJlZ2luQ29tcG9uZW50VHJhbnNhY3Rpb24oKSB7CiAgICAgIHRoaXMucHVzaCg5MQogICAgICAvKiBCZWdpbkNvbXBvbmVudFRyYW5zYWN0aW9uICovCiAgICAgICk7CiAgICB9OwoKICAgIF9wcm90bzExLmNvbW1pdENvbXBvbmVudFRyYW5zYWN0aW9uID0gZnVuY3Rpb24gY29tbWl0Q29tcG9uZW50VHJhbnNhY3Rpb24oKSB7CiAgICAgIHRoaXMucHVzaCg5MgogICAgICAvKiBDb21taXRDb21wb25lbnRUcmFuc2FjdGlvbiAqLwogICAgICApOwogICAgfTsKCiAgICBfcHJvdG8xMS5wdXNoRHluYW1pY1Njb3BlID0gZnVuY3Rpb24gcHVzaER5bmFtaWNTY29wZSgpIHsKICAgICAgdGhpcy5wdXNoKDQ0CiAgICAgIC8qIFB1c2hEeW5hbWljU2NvcGUgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvMTEucG9wRHluYW1pY1Njb3BlID0gZnVuY3Rpb24gcG9wRHluYW1pY1Njb3BlKCkgewogICAgICB0aGlzLnB1c2goNDUKICAgICAgLyogUG9wRHluYW1pY1Njb3BlICovCiAgICAgICk7CiAgICB9OwoKICAgIF9wcm90bzExLnB1c2hSZW1vdGVFbGVtZW50ID0gZnVuY3Rpb24gcHVzaFJlbW90ZUVsZW1lbnQoKSB7CiAgICAgIHRoaXMucHVzaCg0MQogICAgICAvKiBQdXNoUmVtb3RlRWxlbWVudCAqLwogICAgICApOwogICAgfTsKCiAgICBfcHJvdG8xMS5wb3BSZW1vdGVFbGVtZW50ID0gZnVuY3Rpb24gcG9wUmVtb3RlRWxlbWVudCgpIHsKICAgICAgdGhpcy5wdXNoKDQyCiAgICAgIC8qIFBvcFJlbW90ZUVsZW1lbnQgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvMTEucHVzaFJvb3RTY29wZSA9IGZ1bmN0aW9uIHB1c2hSb290U2NvcGUoc3ltYm9scywgYmluZENhbGxlclNjb3BlKSB7CiAgICAgIHRoaXMucHVzaCgyMAogICAgICAvKiBSb290U2NvcGUgKi8KICAgICAgLCBzeW1ib2xzLCBiaW5kQ2FsbGVyU2NvcGUgPyAxIDogMCk7CiAgICB9OwoKICAgIF9wcm90bzExLnB1c2hWaXJ0dWFsUm9vdFNjb3BlID0gZnVuY3Rpb24gcHVzaFZpcnR1YWxSb290U2NvcGUocmVnaXN0ZXIpIHsKICAgICAgdGhpcy5wdXNoKDIxCiAgICAgIC8qIFZpcnR1YWxSb290U2NvcGUgKi8KICAgICAgLCByZWdpc3Rlcik7CiAgICB9OwoKICAgIF9wcm90bzExLnB1c2hDaGlsZFNjb3BlID0gZnVuY3Rpb24gcHVzaENoaWxkU2NvcGUoKSB7CiAgICAgIHRoaXMucHVzaCgyMgogICAgICAvKiBDaGlsZFNjb3BlICovCiAgICAgICk7CiAgICB9OwoKICAgIF9wcm90bzExLnBvcFNjb3BlID0gZnVuY3Rpb24gcG9wU2NvcGUoKSB7CiAgICAgIHRoaXMucHVzaCgyMwogICAgICAvKiBQb3BTY29wZSAqLwogICAgICApOwogICAgfTsKCiAgICBfcHJvdG8xMS5wcmVwYXJlQXJncyA9IGZ1bmN0aW9uIHByZXBhcmVBcmdzKHN0YXRlKSB7CiAgICAgIHRoaXMucHVzaCg3OQogICAgICAvKiBQcmVwYXJlQXJncyAqLwogICAgICAsIHN0YXRlKTsKICAgIH07CgogICAgX3Byb3RvMTEuY3JlYXRlQ29tcG9uZW50ID0gZnVuY3Rpb24gY3JlYXRlQ29tcG9uZW50KHN0YXRlLCBoYXNEZWZhdWx0KSB7CiAgICAgIHZhciBmbGFnID0gaGFzRGVmYXVsdCB8IDA7CiAgICAgIHRoaXMucHVzaCg4MQogICAgICAvKiBDcmVhdGVDb21wb25lbnQgKi8KICAgICAgLCBmbGFnLCBzdGF0ZSk7CiAgICB9OwoKICAgIF9wcm90bzExLnJlZ2lzdGVyQ29tcG9uZW50RGVzdHJ1Y3RvciA9IGZ1bmN0aW9uIHJlZ2lzdGVyQ29tcG9uZW50RGVzdHJ1Y3RvcihzdGF0ZSkgewogICAgICB0aGlzLnB1c2goODIKICAgICAgLyogUmVnaXN0ZXJDb21wb25lbnREZXN0cnVjdG9yICovCiAgICAgICwgc3RhdGUpOwogICAgfTsKCiAgICBfcHJvdG8xMS5wdXRDb21wb25lbnRPcGVyYXRpb25zID0gZnVuY3Rpb24gcHV0Q29tcG9uZW50T3BlcmF0aW9ucygpIHsKICAgICAgdGhpcy5wdXNoKDgzCiAgICAgIC8qIFB1dENvbXBvbmVudE9wZXJhdGlvbnMgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvMTEuZ2V0Q29tcG9uZW50U2VsZiA9IGZ1bmN0aW9uIGdldENvbXBvbmVudFNlbGYoc3RhdGUpIHsKICAgICAgdGhpcy5wdXNoKDg0CiAgICAgIC8qIEdldENvbXBvbmVudFNlbGYgKi8KICAgICAgLCBzdGF0ZSk7CiAgICB9OwoKICAgIF9wcm90bzExLmdldENvbXBvbmVudFRhZ05hbWUgPSBmdW5jdGlvbiBnZXRDb21wb25lbnRUYWdOYW1lKHN0YXRlKSB7CiAgICAgIHRoaXMucHVzaCg4NQogICAgICAvKiBHZXRDb21wb25lbnRUYWdOYW1lICovCiAgICAgICwgc3RhdGUpOwogICAgfTsKCiAgICBfcHJvdG8xMS5nZXRDb21wb25lbnRMYXlvdXQgPSBmdW5jdGlvbiBnZXRDb21wb25lbnRMYXlvdXQoc3RhdGUpIHsKICAgICAgdGhpcy5wdXNoKDg2CiAgICAgIC8qIEdldENvbXBvbmVudExheW91dCAqLwogICAgICAsIHN0YXRlKTsKICAgIH07CgogICAgX3Byb3RvMTEuc2V0dXBGb3JFdmFsID0gZnVuY3Rpb24gc2V0dXBGb3JFdmFsKHN0YXRlKSB7CiAgICAgIHRoaXMucHVzaCg4NwogICAgICAvKiBTZXR1cEZvckV2YWwgKi8KICAgICAgLCBzdGF0ZSk7CiAgICB9OwoKICAgIF9wcm90bzExLmludm9rZUNvbXBvbmVudExheW91dCA9IGZ1bmN0aW9uIGludm9rZUNvbXBvbmVudExheW91dChzdGF0ZSkgewogICAgICB0aGlzLnB1c2goOTAKICAgICAgLyogSW52b2tlQ29tcG9uZW50TGF5b3V0ICovCiAgICAgICwgc3RhdGUpOwogICAgfTsKCiAgICBfcHJvdG8xMS5kaWRDcmVhdGVFbGVtZW50ID0gZnVuY3Rpb24gZGlkQ3JlYXRlRWxlbWVudChzdGF0ZSkgewogICAgICB0aGlzLnB1c2goOTMKICAgICAgLyogRGlkQ3JlYXRlRWxlbWVudCAqLwogICAgICAsIHN0YXRlKTsKICAgIH07CgogICAgX3Byb3RvMTEuZGlkUmVuZGVyTGF5b3V0ID0gZnVuY3Rpb24gZGlkUmVuZGVyTGF5b3V0KHN0YXRlKSB7CiAgICAgIHRoaXMucHVzaCg5NAogICAgICAvKiBEaWRSZW5kZXJMYXlvdXQgKi8KICAgICAgLCBzdGF0ZSk7CiAgICB9OwoKICAgIF9wcm90bzExLnB1c2hGcmFtZSA9IGZ1bmN0aW9uIHB1c2hGcmFtZSgpIHsKICAgICAgdGhpcy5wdXNoTWFjaGluZSg1NwogICAgICAvKiBQdXNoRnJhbWUgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvMTEucG9wRnJhbWUgPSBmdW5jdGlvbiBwb3BGcmFtZSgpIHsKICAgICAgdGhpcy5wdXNoTWFjaGluZSg1OAogICAgICAvKiBQb3BGcmFtZSAqLwogICAgICApOwogICAgfTsKCiAgICBfcHJvdG8xMS5wdXNoU21hbGxGcmFtZSA9IGZ1bmN0aW9uIHB1c2hTbWFsbEZyYW1lKCkgewogICAgICB0aGlzLnB1c2hNYWNoaW5lKDU5CiAgICAgIC8qIFB1c2hTbWFsbEZyYW1lICovCiAgICAgICk7CiAgICB9OwoKICAgIF9wcm90bzExLnBvcFNtYWxsRnJhbWUgPSBmdW5jdGlvbiBwb3BTbWFsbEZyYW1lKCkgewogICAgICB0aGlzLnB1c2hNYWNoaW5lKDYwCiAgICAgIC8qIFBvcFNtYWxsRnJhbWUgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvMTEuaW52b2tlVmlydHVhbCA9IGZ1bmN0aW9uIGludm9rZVZpcnR1YWwoKSB7CiAgICAgIHRoaXMucHVzaE1hY2hpbmUoNDkKICAgICAgLyogSW52b2tlVmlydHVhbCAqLwogICAgICApOwogICAgfTsKCiAgICBfcHJvdG8xMS5pbnZva2VZaWVsZCA9IGZ1bmN0aW9uIGludm9rZVlpZWxkKCkgewogICAgICB0aGlzLnB1c2goNTEKICAgICAgLyogSW52b2tlWWllbGQgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvMTEudG9Cb29sZWFuID0gZnVuY3Rpb24gdG9Cb29sZWFuKCkgewogICAgICB0aGlzLnB1c2goNjMKICAgICAgLyogVG9Cb29sZWFuICovCiAgICAgICk7CiAgICB9OwoKICAgIF9wcm90bzExLmludm9rZVByZXBhcmVkQ29tcG9uZW50ID0gZnVuY3Rpb24gaW52b2tlUHJlcGFyZWRDb21wb25lbnQoaGFzQmxvY2ssIGJpbmRhYmxlQmxvY2tzLCBiaW5kYWJsZUF0TmFtZXMsIHBvcHVsYXRlTGF5b3V0KSB7CiAgICAgIGlmIChwb3B1bGF0ZUxheW91dCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcG9wdWxhdGVMYXlvdXQgPSBudWxsOwogICAgICB9CgogICAgICB0aGlzLmJlZ2luQ29tcG9uZW50VHJhbnNhY3Rpb24oKTsKICAgICAgdGhpcy5wdXNoRHluYW1pY1Njb3BlKCk7CiAgICAgIHRoaXMuY3JlYXRlQ29tcG9uZW50KF92bS5SZWdpc3Rlci5zMCwgaGFzQmxvY2spOyAvLyB0aGlzIGhhcyB0byBydW4gYWZ0ZXIgY3JlYXRlQ29tcG9uZW50IHRvIGFsbG93CiAgICAgIC8vIGZvciBsYXRlLWJvdW5kIGxheW91dHMsIGJ1dCBhIGNhbGxlciBpcyBmcmVlCiAgICAgIC8vIHRvIHBvcHVsYXRlIHRoZSBsYXlvdXQgZWFybGllciBpZiBpdCB3YW50cyB0bwogICAgICAvLyBhbmQgZG8gbm90aGluZyBoZXJlLgoKICAgICAgaWYgKHBvcHVsYXRlTGF5b3V0KSBwb3B1bGF0ZUxheW91dCgpOwogICAgICB0aGlzLnJlZ2lzdGVyQ29tcG9uZW50RGVzdHJ1Y3Rvcihfdm0uUmVnaXN0ZXIuczApOwogICAgICB0aGlzLmdldENvbXBvbmVudFNlbGYoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgdGhpcy5wdXNoVmlydHVhbFJvb3RTY29wZShfdm0uUmVnaXN0ZXIuczApOwogICAgICB0aGlzLnNldFZhcmlhYmxlKDApOwogICAgICB0aGlzLnNldHVwRm9yRXZhbChfdm0uUmVnaXN0ZXIuczApOwogICAgICBpZiAoYmluZGFibGVBdE5hbWVzKSB0aGlzLnNldE5hbWVkVmFyaWFibGVzKF92bS5SZWdpc3Rlci5zMCk7CiAgICAgIGlmIChiaW5kYWJsZUJsb2NrcykgdGhpcy5zZXRCbG9ja3MoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgdGhpcy5wb3AoKTsKICAgICAgdGhpcy5pbnZva2VDb21wb25lbnRMYXlvdXQoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgdGhpcy5kaWRSZW5kZXJMYXlvdXQoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgdGhpcy5wb3BGcmFtZSgpOwogICAgICB0aGlzLnBvcFNjb3BlKCk7CiAgICAgIHRoaXMucG9wRHluYW1pY1Njb3BlKCk7CiAgICAgIHRoaXMuY29tbWl0Q29tcG9uZW50VHJhbnNhY3Rpb24oKTsKICAgIH07CgogICAgLy8vCiAgICBfcHJvdG8xMS5jb21waWxlSW5saW5lID0gZnVuY3Rpb24gY29tcGlsZUlubGluZShzZXhwKSB7CiAgICAgIHJldHVybiB0aGlzLmNvbXBpbGVyLmNvbXBpbGVJbmxpbmUoc2V4cCwgdGhpcyk7CiAgICB9OwoKICAgIF9wcm90bzExLmNvbXBpbGVCbG9jayA9IGZ1bmN0aW9uIGNvbXBpbGVCbG9jayhuYW1lLCBwYXJhbXMsIGhhc2gsIHRlbXBsYXRlLCBpbnZlcnNlKSB7CiAgICAgIHRoaXMuY29tcGlsZXIuY29tcGlsZUJsb2NrKG5hbWUsIHBhcmFtcywgaGFzaCwgdGVtcGxhdGUsIGludmVyc2UsIHRoaXMpOwogICAgfTsKCiAgICBfcHJvdG8xMS5sYWJlbCA9IGZ1bmN0aW9uIGxhYmVsKG5hbWUpIHsKICAgICAgdGhpcy5sYWJlbHMubGFiZWwobmFtZSwgdGhpcy5uZXh0UG9zKTsKICAgIH0gLy8gaGVscGVycwogICAgOwoKICAgIF9wcm90bzExLnN0YXJ0TGFiZWxzID0gZnVuY3Rpb24gc3RhcnRMYWJlbHMoKSB7CiAgICAgIHRoaXMubGFiZWxzU3RhY2sucHVzaChuZXcgTGFiZWxzKCkpOwogICAgfTsKCiAgICBfcHJvdG8xMS5zdG9wTGFiZWxzID0gZnVuY3Rpb24gc3RvcExhYmVscygpIHsKICAgICAgdmFyIGxhYmVsID0gdGhpcy5sYWJlbHNTdGFjay5wb3AoKTsKICAgICAgbGFiZWwucGF0Y2godGhpcy5lbmNvZGVyKTsKICAgIH0gLy8gY29tcG9uZW50cwogICAgOwoKICAgIF9wcm90bzExLnB1c2hDdXJyaWVkQ29tcG9uZW50ID0gZnVuY3Rpb24gcHVzaEN1cnJpZWRDb21wb25lbnQoKSB7CiAgICAgIHRoaXMucHVzaCg3NAogICAgICAvKiBQdXNoQ3VycmllZENvbXBvbmVudCAqLwogICAgICApOwogICAgfTsKCiAgICBfcHJvdG8xMS5wdXNoRHluYW1pY0NvbXBvbmVudEluc3RhbmNlID0gZnVuY3Rpb24gcHVzaER5bmFtaWNDb21wb25lbnRJbnN0YW5jZSgpIHsKICAgICAgdGhpcy5wdXNoKDczCiAgICAgIC8qIFB1c2hEeW5hbWljQ29tcG9uZW50SW5zdGFuY2UgKi8KICAgICAgKTsKICAgIH0gLy8gZG9tCiAgICA7CgogICAgX3Byb3RvMTEub3BlbkR5bmFtaWNFbGVtZW50ID0gZnVuY3Rpb24gb3BlbkR5bmFtaWNFbGVtZW50KCkgewogICAgICB0aGlzLnB1c2goMzQKICAgICAgLyogT3BlbkR5bmFtaWNFbGVtZW50ICovCiAgICAgICk7CiAgICB9OwoKICAgIF9wcm90bzExLmZsdXNoRWxlbWVudCA9IGZ1bmN0aW9uIGZsdXNoRWxlbWVudCgpIHsKICAgICAgdGhpcy5wdXNoKDM4CiAgICAgIC8qIEZsdXNoRWxlbWVudCAqLwogICAgICApOwogICAgfTsKCiAgICBfcHJvdG8xMS5jbG9zZUVsZW1lbnQgPSBmdW5jdGlvbiBjbG9zZUVsZW1lbnQoKSB7CiAgICAgIHRoaXMucHVzaCgzOQogICAgICAvKiBDbG9zZUVsZW1lbnQgKi8KICAgICAgKTsKICAgIH0gLy8gbGlzdHMKICAgIDsKCiAgICBfcHJvdG8xMS5wdXRJdGVyYXRvciA9IGZ1bmN0aW9uIHB1dEl0ZXJhdG9yKCkgewogICAgICB0aGlzLnB1c2goNjYKICAgICAgLyogUHV0SXRlcmF0b3IgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvMTEuZW50ZXJMaXN0ID0gZnVuY3Rpb24gZW50ZXJMaXN0KHN0YXJ0KSB7CiAgICAgIHRoaXMucmVzZXJ2ZSg2NAogICAgICAvKiBFbnRlckxpc3QgKi8KICAgICAgKTsKICAgICAgdGhpcy5sYWJlbHMudGFyZ2V0KHRoaXMucG9zLCBzdGFydCk7CiAgICB9OwoKICAgIF9wcm90bzExLmV4aXRMaXN0ID0gZnVuY3Rpb24gZXhpdExpc3QoKSB7CiAgICAgIHRoaXMucHVzaCg2NQogICAgICAvKiBFeGl0TGlzdCAqLwogICAgICApOwogICAgfTsKCiAgICBfcHJvdG8xMS5pdGVyYXRlID0gZnVuY3Rpb24gaXRlcmF0ZShicmVha3MpIHsKICAgICAgdGhpcy5yZXNlcnZlKDY3CiAgICAgIC8qIEl0ZXJhdGUgKi8KICAgICAgKTsKICAgICAgdGhpcy5sYWJlbHMudGFyZ2V0KHRoaXMucG9zLCBicmVha3MpOwogICAgfSAvLyBleHByZXNzaW9ucwogICAgOwoKICAgIF9wcm90bzExLnNldE5hbWVkVmFyaWFibGVzID0gZnVuY3Rpb24gc2V0TmFtZWRWYXJpYWJsZXMoc3RhdGUpIHsKICAgICAgdGhpcy5wdXNoKDIKICAgICAgLyogU2V0TmFtZWRWYXJpYWJsZXMgKi8KICAgICAgLCBzdGF0ZSk7CiAgICB9OwoKICAgIF9wcm90bzExLnNldEJsb2NrcyA9IGZ1bmN0aW9uIHNldEJsb2NrcyhzdGF0ZSkgewogICAgICB0aGlzLnB1c2goMwogICAgICAvKiBTZXRCbG9ja3MgKi8KICAgICAgLCBzdGF0ZSk7CiAgICB9OwoKICAgIF9wcm90bzExLnNldFZhcmlhYmxlID0gZnVuY3Rpb24gc2V0VmFyaWFibGUoc3ltYm9sKSB7CiAgICAgIHRoaXMucHVzaCg0CiAgICAgIC8qIFNldFZhcmlhYmxlICovCiAgICAgICwgc3ltYm9sKTsKICAgIH07CgogICAgX3Byb3RvMTEuc2V0QmxvY2sgPSBmdW5jdGlvbiBzZXRCbG9jayhzeW1ib2wpIHsKICAgICAgdGhpcy5wdXNoKDUKICAgICAgLyogU2V0QmxvY2sgKi8KICAgICAgLCBzeW1ib2wpOwogICAgfTsKCiAgICBfcHJvdG8xMS5nZXRWYXJpYWJsZSA9IGZ1bmN0aW9uIGdldFZhcmlhYmxlKHN5bWJvbCkgewogICAgICB0aGlzLnB1c2goNgogICAgICAvKiBHZXRWYXJpYWJsZSAqLwogICAgICAsIHN5bWJvbCk7CiAgICB9OwoKICAgIF9wcm90bzExLmdldEJsb2NrID0gZnVuY3Rpb24gZ2V0QmxvY2soc3ltYm9sKSB7CiAgICAgIHRoaXMucHVzaCg4CiAgICAgIC8qIEdldEJsb2NrICovCiAgICAgICwgc3ltYm9sKTsKICAgIH07CgogICAgX3Byb3RvMTEuaGFzQmxvY2sgPSBmdW5jdGlvbiBoYXNCbG9jayhzeW1ib2wpIHsKICAgICAgdGhpcy5wdXNoKDkKICAgICAgLyogSGFzQmxvY2sgKi8KICAgICAgLCBzeW1ib2wpOwogICAgfTsKCiAgICBfcHJvdG8xMS5jb25jYXQgPSBmdW5jdGlvbiBjb25jYXQoc2l6ZSkgewogICAgICB0aGlzLnB1c2goMTEKICAgICAgLyogQ29uY2F0ICovCiAgICAgICwgc2l6ZSk7CiAgICB9OwoKICAgIF9wcm90bzExLmxvYWQgPSBmdW5jdGlvbiBsb2FkKHJlZ2lzdGVyKSB7CiAgICAgIHRoaXMucHVzaCgxOAogICAgICAvKiBMb2FkICovCiAgICAgICwgcmVnaXN0ZXIpOwogICAgfTsKCiAgICBfcHJvdG8xMS5mZXRjaCA9IGZ1bmN0aW9uIGZldGNoKHJlZ2lzdGVyKSB7CiAgICAgIHRoaXMucHVzaCgxOQogICAgICAvKiBGZXRjaCAqLwogICAgICAsIHJlZ2lzdGVyKTsKICAgIH07CgogICAgX3Byb3RvMTEuZHVwID0gZnVuY3Rpb24gZHVwKHJlZ2lzdGVyLCBvZmZzZXQpIHsKICAgICAgaWYgKHJlZ2lzdGVyID09PSB2b2lkIDApIHsKICAgICAgICByZWdpc3RlciA9IF92bS5SZWdpc3Rlci5zcDsKICAgICAgfQoKICAgICAgaWYgKG9mZnNldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgb2Zmc2V0ID0gMDsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMucHVzaCgxNgogICAgICAvKiBEdXAgKi8KICAgICAgLCByZWdpc3Rlciwgb2Zmc2V0KTsKICAgIH07CgogICAgX3Byb3RvMTEucG9wID0gZnVuY3Rpb24gcG9wKGNvdW50KSB7CiAgICAgIGlmIChjb3VudCA9PT0gdm9pZCAwKSB7CiAgICAgICAgY291bnQgPSAxOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5wdXNoKDE3CiAgICAgIC8qIFBvcCAqLwogICAgICAsIGNvdW50KTsKICAgIH0gLy8gdm0KICAgIDsKCiAgICBfcHJvdG8xMS5yZXR1cm5UbyA9IGZ1bmN0aW9uIHJldHVyblRvKGxhYmVsKSB7CiAgICAgIHRoaXMucmVzZXJ2ZU1hY2hpbmUoMjUKICAgICAgLyogUmV0dXJuVG8gKi8KICAgICAgKTsKICAgICAgdGhpcy5sYWJlbHMudGFyZ2V0KHRoaXMucG9zLCBsYWJlbCk7CiAgICB9OwoKICAgIF9wcm90bzExLnByaW1pdGl2ZVJlZmVyZW5jZSA9IGZ1bmN0aW9uIHByaW1pdGl2ZVJlZmVyZW5jZSgpIHsKICAgICAgdGhpcy5wdXNoKDE0CiAgICAgIC8qIFByaW1pdGl2ZVJlZmVyZW5jZSAqLwogICAgICApOwogICAgfTsKCiAgICBfcHJvdG8xMS5yZWlmeVUzMiA9IGZ1bmN0aW9uIHJlaWZ5VTMyKCkgewogICAgICB0aGlzLnB1c2goMTUKICAgICAgLyogUmVpZnlVMzIgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvMTEuZW50ZXIgPSBmdW5jdGlvbiBlbnRlcihhcmdzKSB7CiAgICAgIHRoaXMucHVzaCg2MQogICAgICAvKiBFbnRlciAqLwogICAgICAsIGFyZ3MpOwogICAgfTsKCiAgICBfcHJvdG8xMS5leGl0ID0gZnVuY3Rpb24gZXhpdCgpIHsKICAgICAgdGhpcy5wdXNoKDYyCiAgICAgIC8qIEV4aXQgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvMTEucmV0dXJuID0gZnVuY3Rpb24gX3JldHVybigpIHsKICAgICAgdGhpcy5wdXNoTWFjaGluZSgyNAogICAgICAvKiBSZXR1cm4gKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvMTEuanVtcCA9IGZ1bmN0aW9uIGp1bXAodGFyZ2V0KSB7CiAgICAgIHRoaXMucmVzZXJ2ZU1hY2hpbmUoNTIKICAgICAgLyogSnVtcCAqLwogICAgICApOwogICAgICB0aGlzLmxhYmVscy50YXJnZXQodGhpcy5wb3MsIHRhcmdldCk7CiAgICB9OwoKICAgIF9wcm90bzExLmp1bXBJZiA9IGZ1bmN0aW9uIGp1bXBJZih0YXJnZXQpIHsKICAgICAgdGhpcy5yZXNlcnZlKDUzCiAgICAgIC8qIEp1bXBJZiAqLwogICAgICApOwogICAgICB0aGlzLmxhYmVscy50YXJnZXQodGhpcy5wb3MsIHRhcmdldCk7CiAgICB9OwoKICAgIF9wcm90bzExLmp1bXBVbmxlc3MgPSBmdW5jdGlvbiBqdW1wVW5sZXNzKHRhcmdldCkgewogICAgICB0aGlzLnJlc2VydmUoNTQKICAgICAgLyogSnVtcFVubGVzcyAqLwogICAgICApOwogICAgICB0aGlzLmxhYmVscy50YXJnZXQodGhpcy5wb3MsIHRhcmdldCk7CiAgICB9OwoKICAgIF9wcm90bzExLmp1bXBFcSA9IGZ1bmN0aW9uIGp1bXBFcSh2YWx1ZSwgdGFyZ2V0KSB7CiAgICAgIHRoaXMucmVzZXJ2ZVdpdGhPcGVyYW5kKDU1CiAgICAgIC8qIEp1bXBFcSAqLwogICAgICAsIHZhbHVlKTsKICAgICAgdGhpcy5sYWJlbHMudGFyZ2V0KHRoaXMucG9zLCB0YXJnZXQpOwogICAgfTsKCiAgICBfcHJvdG8xMS5hc3NlcnRTYW1lID0gZnVuY3Rpb24gYXNzZXJ0U2FtZSgpIHsKICAgICAgdGhpcy5wdXNoKDU2CiAgICAgIC8qIEFzc2VydFNhbWUgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvMTEucHVzaEVtcHR5QXJncyA9IGZ1bmN0aW9uIHB1c2hFbXB0eUFyZ3MoKSB7CiAgICAgIHRoaXMucHVzaCg3NwogICAgICAvKiBQdXNoRW1wdHlBcmdzICovCiAgICAgICk7CiAgICB9OwoKICAgIF9wcm90bzExLnN3aXRjaCA9IGZ1bmN0aW9uIF9zd2l0Y2goX29wY29kZSwgY2FsbGJhY2spIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIC8vIFNldHVwIHRoZSBzd2l0Y2ggRFNMCiAgICAgIHZhciBjbGF1c2VzID0gW107CiAgICAgIHZhciBjb3VudCA9IDA7CgogICAgICBmdW5jdGlvbiB3aGVuKG1hdGNoLCBjYWxsYmFjaykgewogICAgICAgIGNsYXVzZXMucHVzaCh7CiAgICAgICAgICBtYXRjaDogbWF0Y2gsCiAgICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgICAgICBsYWJlbDogIkNMQVVTRSIgKyBjb3VudCsrCiAgICAgICAgfSk7CiAgICAgIH0gLy8gQ2FsbCB0aGUgY2FsbGJhY2sKCgogICAgICBjYWxsYmFjayh3aGVuKTsgLy8gRW1pdCB0aGUgb3Bjb2RlcyBmb3IgdGhlIHN3aXRjaAoKICAgICAgdGhpcy5lbnRlcigyKTsKICAgICAgdGhpcy5hc3NlcnRTYW1lKCk7CiAgICAgIHRoaXMucmVpZnlVMzIoKTsKICAgICAgdGhpcy5zdGFydExhYmVscygpOyAvLyBGaXJzdCwgZW1pdCB0aGUganVtcCBvcGNvZGVzLiBXZSBkb24ndCBuZWVkIGEganVtcCBmb3IgdGhlIGxhc3QKICAgICAgLy8gb3Bjb2RlLCBzaW5jZSBpdCBibGVlZHMgZGlyZWN0bHkgaW50byBpdHMgY2xhdXNlLgoKICAgICAgY2xhdXNlcy5zbGljZSgwLCAtMSkuZm9yRWFjaChmdW5jdGlvbiAoY2xhdXNlKSB7CiAgICAgICAgcmV0dXJuIF90aGlzLmp1bXBFcShjbGF1c2UubWF0Y2gsIGNsYXVzZS5sYWJlbCk7CiAgICAgIH0pOyAvLyBFbnVtZXJhdGUgdGhlIGNsYXVzZXMgaW4gcmV2ZXJzZSBvcmRlci4gRWFybGllciBtYXRjaGVzIHdpbGwKICAgICAgLy8gcmVxdWlyZSBmZXdlciBjaGVja3MuCgogICAgICBmb3IgKHZhciBpID0gY2xhdXNlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIHZhciBjbGF1c2UgPSBjbGF1c2VzW2ldOwogICAgICAgIHRoaXMubGFiZWwoY2xhdXNlLmxhYmVsKTsKICAgICAgICB0aGlzLnBvcCgyKTsKICAgICAgICBjbGF1c2UuY2FsbGJhY2soKTsgLy8gVGhlIGZpcnN0IG1hdGNoIGlzIHNwZWNpYWw6IGl0IGlzIHBsYWNlZCBkaXJlY3RseSBiZWZvcmUgdGhlIEVORAogICAgICAgIC8vIGxhYmVsLCBzbyBubyBhZGRpdGlvbmFsIGp1bXAgaXMgbmVlZGVkIGF0IHRoZSBlbmQgb2YgaXQuCgogICAgICAgIGlmIChpICE9PSAwKSB7CiAgICAgICAgICB0aGlzLmp1bXAoJ0VORCcpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5sYWJlbCgnRU5EJyk7CiAgICAgIHRoaXMuc3RvcExhYmVscygpOwogICAgICB0aGlzLmV4aXQoKTsKICAgIH07CgogICAgX3Byb3RvMTEuc3RkQXBwZW5kID0gZnVuY3Rpb24gc3RkQXBwZW5kKHRydXN0aW5nKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgdGhpcy5zd2l0Y2godGhpcy5jb250ZW50VHlwZSgpLCBmdW5jdGlvbiAod2hlbikgewogICAgICAgIHdoZW4oMQogICAgICAgIC8qIFN0cmluZyAqLwogICAgICAgICwgZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHRydXN0aW5nKSB7CiAgICAgICAgICAgIF90aGlzMi5hc3NlcnRTYW1lKCk7CgogICAgICAgICAgICBfdGhpczIuYXBwZW5kSFRNTCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX3RoaXMyLmFwcGVuZFRleHQoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB3aGVuKDAKICAgICAgICAvKiBDb21wb25lbnQgKi8KICAgICAgICAsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIF90aGlzMi5wdXNoQ3VycmllZENvbXBvbmVudCgpOwoKICAgICAgICAgIF90aGlzMi5wdXNoRHluYW1pY0NvbXBvbmVudEluc3RhbmNlKCk7CgogICAgICAgICAgX3RoaXMyLmludm9rZUJhcmVDb21wb25lbnQoKTsKICAgICAgICB9KTsKICAgICAgICB3aGVuKDMKICAgICAgICAvKiBTYWZlU3RyaW5nICovCiAgICAgICAgLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBfdGhpczIuYXNzZXJ0U2FtZSgpOwoKICAgICAgICAgIF90aGlzMi5hcHBlbmRTYWZlSFRNTCgpOwogICAgICAgIH0pOwogICAgICAgIHdoZW4oNAogICAgICAgIC8qIEZyYWdtZW50ICovCiAgICAgICAgLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBfdGhpczIuYXNzZXJ0U2FtZSgpOwoKICAgICAgICAgIF90aGlzMi5hcHBlbmREb2N1bWVudEZyYWdtZW50KCk7CiAgICAgICAgfSk7CiAgICAgICAgd2hlbig1CiAgICAgICAgLyogTm9kZSAqLwogICAgICAgICwgZnVuY3Rpb24gKCkgewogICAgICAgICAgX3RoaXMyLmFzc2VydFNhbWUoKTsKCiAgICAgICAgICBfdGhpczIuYXBwZW5kTm9kZSgpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH07CgogICAgX3Byb3RvMTEucG9wdWxhdGVMYXlvdXQgPSBmdW5jdGlvbiBwb3B1bGF0ZUxheW91dChzdGF0ZSkgewogICAgICB0aGlzLnB1c2goODkKICAgICAgLyogUG9wdWxhdGVMYXlvdXQgKi8KICAgICAgLCBzdGF0ZSk7CiAgICB9OwoKICAgIF9wcm90bzExLmludm9rZUJhcmVDb21wb25lbnQgPSBmdW5jdGlvbiBpbnZva2VCYXJlQ29tcG9uZW50KCkgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIHRoaXMuZmV0Y2goX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgdGhpcy5kdXAoX3ZtLlJlZ2lzdGVyLnNwLCAxKTsKICAgICAgdGhpcy5sb2FkKF92bS5SZWdpc3Rlci5zMCk7CiAgICAgIHRoaXMucHVzaEZyYW1lKCk7CiAgICAgIHRoaXMucHVzaEVtcHR5QXJncygpOwogICAgICB0aGlzLnByZXBhcmVBcmdzKF92bS5SZWdpc3Rlci5zMCk7CiAgICAgIHRoaXMuaW52b2tlUHJlcGFyZWRDb21wb25lbnQoZmFsc2UsIGZhbHNlLCB0cnVlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMzLmdldENvbXBvbmVudExheW91dChfdm0uUmVnaXN0ZXIuczApOwoKICAgICAgICBfdGhpczMucG9wdWxhdGVMYXlvdXQoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgfSk7CiAgICAgIHRoaXMubG9hZChfdm0uUmVnaXN0ZXIuczApOwogICAgfTsKCiAgICBfcHJvdG8xMS5pc0NvbXBvbmVudCA9IGZ1bmN0aW9uIGlzQ29tcG9uZW50KCkgewogICAgICB0aGlzLnB1c2goNjkKICAgICAgLyogSXNDb21wb25lbnQgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvMTEuY29udGVudFR5cGUgPSBmdW5jdGlvbiBjb250ZW50VHlwZSgpIHsKICAgICAgdGhpcy5wdXNoKDcwCiAgICAgIC8qIENvbnRlbnRUeXBlICovCiAgICAgICk7CiAgICB9OwoKICAgIF9wcm90bzExLnB1c2hCbG9ja1Njb3BlID0gZnVuY3Rpb24gcHVzaEJsb2NrU2NvcGUoKSB7CiAgICAgIHRoaXMucHVzaCg0NwogICAgICAvKiBQdXNoQmxvY2tTY29wZSAqLwogICAgICApOwogICAgfTsKCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKFN0ZE9wY29kZUJ1aWxkZXIsIFt7CiAgICAgIGtleTogInBvcyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLmVuY29kZXIudHlwZVBvczsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJuZXh0UG9zIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2Rlci5zaXplOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImxhYmVscyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLmxhYmVsc1N0YWNrLmN1cnJlbnQ7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBTdGRPcGNvZGVCdWlsZGVyOwogIH0oKTsKCiAgX2V4cG9ydHMuU3RkT3Bjb2RlQnVpbGRlciA9IFN0ZE9wY29kZUJ1aWxkZXI7CgogIHZhciBPcGNvZGVCdWlsZGVyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9TdGRPcGNvZGVCdWlsZGVyKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoT3Bjb2RlQnVpbGRlciwgX1N0ZE9wY29kZUJ1aWxkZXIpOwoKICAgIGZ1bmN0aW9uIE9wY29kZUJ1aWxkZXIoY29tcGlsZXIsIGNvbnRhaW5pbmdMYXlvdXQpIHsKICAgICAgdmFyIF90aGlzNDsKCiAgICAgIF90aGlzNCA9IF9TdGRPcGNvZGVCdWlsZGVyLmNhbGwodGhpcywgY29tcGlsZXIsIGNvbnRhaW5pbmdMYXlvdXQgPyBjb250YWluaW5nTGF5b3V0LmJsb2NrLnN5bWJvbHMubGVuZ3RoIDogMCkgfHwgdGhpczsKICAgICAgX3RoaXM0LmNvbnRhaW5pbmdMYXlvdXQgPSBjb250YWluaW5nTGF5b3V0OwogICAgICBfdGhpczQuY29tcG9uZW50ID0gbmV3IENvbXBvbmVudEJ1aWxkZXIoKDAsIF9lbWJlckJhYmVsLmFzc2VydFRoaXNJbml0aWFsaXplZCkoX3RoaXM0KSk7CiAgICAgIF90aGlzNC5leHByZXNzaW9uQ29tcGlsZXIgPSBleHByZXNzaW9uQ29tcGlsZXIoKTsKICAgICAgX3RoaXM0LmNvbnN0YW50cyA9IGNvbXBpbGVyLmNvbnN0YW50czsKICAgICAgX3RoaXM0LnN0ZExpYiA9IGNvbXBpbGVyLnN0ZExpYjsKICAgICAgcmV0dXJuIF90aGlzNDsKICAgIH0gLy8vIE1FQ0hBTklDUwoKCiAgICB2YXIgX3Byb3RvMTIgPSBPcGNvZGVCdWlsZGVyLnByb3RvdHlwZTsKCiAgICBfcHJvdG8xMi5leHByID0gZnVuY3Rpb24gZXhwcihleHByZXNzaW9uKSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGV4cHJlc3Npb24pKSB7CiAgICAgICAgdGhpcy5leHByZXNzaW9uQ29tcGlsZXIuY29tcGlsZShleHByZXNzaW9uLCB0aGlzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnB1c2hQcmltaXRpdmVSZWZlcmVuY2UoZXhwcmVzc2lvbik7CiAgICAgIH0KICAgIH0gLy8vCiAgICAvLyBhcmdzCiAgICA7CgogICAgX3Byb3RvMTIucHVzaEFyZ3MgPSBmdW5jdGlvbiBwdXNoQXJncyhuYW1lcywgZmxhZ3MpIHsKICAgICAgdmFyIHNlcmlhbGl6ZWQgPSB0aGlzLmNvbnN0YW50cy5zdHJpbmdBcnJheShuYW1lcyk7CiAgICAgIHRoaXMucHVzaCg3NgogICAgICAvKiBQdXNoQXJncyAqLwogICAgICAsIHNlcmlhbGl6ZWQsIGZsYWdzKTsKICAgIH07CgogICAgX3Byb3RvMTIucHVzaFlpZWxkYWJsZUJsb2NrID0gZnVuY3Rpb24gcHVzaFlpZWxkYWJsZUJsb2NrKGJsb2NrKSB7CiAgICAgIHRoaXMucHVzaFN5bWJvbFRhYmxlKGJsb2NrICYmIGJsb2NrLnN5bWJvbFRhYmxlKTsKICAgICAgdGhpcy5wdXNoQmxvY2tTY29wZSgpOwogICAgICB0aGlzLnB1c2hCbG9jayhibG9jayk7CiAgICB9OwoKICAgIF9wcm90bzEyLmN1cnJ5Q29tcG9uZW50ID0gZnVuY3Rpb24gY3VycnlDb21wb25lbnQoZGVmaW5pdGlvbiwKICAgIC8qIFRPRE86IGF0dHJzOiBPcHRpb248UmF3SW5saW5lQmxvY2s+LCAqLwogICAgcGFyYW1zLCBoYXNoLCBzeW50aGV0aWMpIHsKICAgICAgdmFyIHJlZmVycmVyID0gdGhpcy5jb250YWluaW5nTGF5b3V0LnJlZmVycmVyOwogICAgICB0aGlzLnB1c2hGcmFtZSgpOwogICAgICB0aGlzLmNvbXBpbGVBcmdzKHBhcmFtcywgaGFzaCwgbnVsbCwgc3ludGhldGljKTsKICAgICAgdGhpcy5wdXNoKDgwCiAgICAgIC8qIENhcHR1cmVBcmdzICovCiAgICAgICk7CiAgICAgIHRoaXMuZXhwcihkZWZpbml0aW9uKTsKICAgICAgdGhpcy5wdXNoKDcxCiAgICAgIC8qIEN1cnJ5Q29tcG9uZW50ICovCiAgICAgICwgdGhpcy5jb25zdGFudHMuc2VyaWFsaXphYmxlKHJlZmVycmVyKSk7CiAgICAgIHRoaXMucG9wRnJhbWUoKTsKICAgICAgdGhpcy5mZXRjaChfdm0uUmVnaXN0ZXIudjApOwogICAgfTsKCiAgICBfcHJvdG8xMi5wdXNoU3ltYm9sVGFibGUgPSBmdW5jdGlvbiBwdXNoU3ltYm9sVGFibGUodGFibGUpIHsKICAgICAgaWYgKHRhYmxlKSB7CiAgICAgICAgdmFyIGNvbnN0YW50ID0gdGhpcy5jb25zdGFudHMuc2VyaWFsaXphYmxlKHRhYmxlKTsKICAgICAgICB0aGlzLnB1c2goNDgKICAgICAgICAvKiBQdXNoU3ltYm9sVGFibGUgKi8KICAgICAgICAsIGNvbnN0YW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnByaW1pdGl2ZShudWxsKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8xMi5pbnZva2VDb21wb25lbnQgPSBmdW5jdGlvbiBpbnZva2VDb21wb25lbnQoY2FwYWJpbGl0aWVzLCBhdHRycywgcGFyYW1zLCBoYXNoLCBzeW50aGV0aWMsIGJsb2NrLCBpbnZlcnNlLCBsYXlvdXQpIHsKICAgICAgdmFyIF90aGlzNSA9IHRoaXM7CgogICAgICBpZiAoaW52ZXJzZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgaW52ZXJzZSA9IG51bGw7CiAgICAgIH0KCiAgICAgIHRoaXMuZmV0Y2goX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgdGhpcy5kdXAoX3ZtLlJlZ2lzdGVyLnNwLCAxKTsKICAgICAgdGhpcy5sb2FkKF92bS5SZWdpc3Rlci5zMCk7CiAgICAgIHRoaXMucHVzaEZyYW1lKCk7CiAgICAgIHZhciBiaW5kYWJsZUJsb2NrcyA9ICEhKGJsb2NrIHx8IGludmVyc2UgfHwgYXR0cnMpOwogICAgICB2YXIgYmluZGFibGVBdE5hbWVzID0gY2FwYWJpbGl0aWVzID09PSB0cnVlIHx8IGNhcGFiaWxpdGllcy5wcmVwYXJlQXJncyB8fCAhIShoYXNoICYmIGhhc2hbMF0ubGVuZ3RoICE9PSAwKTsKICAgICAgdmFyIGJsb2NrcyA9IHsKICAgICAgICBtYWluOiBibG9jaywKICAgICAgICBlbHNlOiBpbnZlcnNlLAogICAgICAgIGF0dHJzOiBhdHRycwogICAgICB9OwogICAgICB0aGlzLmNvbXBpbGVBcmdzKHBhcmFtcywgaGFzaCwgYmxvY2tzLCBzeW50aGV0aWMpOwogICAgICB0aGlzLnByZXBhcmVBcmdzKF92bS5SZWdpc3Rlci5zMCk7CiAgICAgIHRoaXMuaW52b2tlUHJlcGFyZWRDb21wb25lbnQoYmxvY2sgIT09IG51bGwsIGJpbmRhYmxlQmxvY2tzLCBiaW5kYWJsZUF0TmFtZXMsIGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAobGF5b3V0KSB7CiAgICAgICAgICBfdGhpczUucHVzaFN5bWJvbFRhYmxlKGxheW91dC5zeW1ib2xUYWJsZSk7CgogICAgICAgICAgX3RoaXM1LnB1c2hMYXlvdXQobGF5b3V0KTsKCiAgICAgICAgICBfdGhpczUucmVzb2x2ZUxheW91dCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBfdGhpczUuZ2V0Q29tcG9uZW50TGF5b3V0KF92bS5SZWdpc3Rlci5zMCk7CiAgICAgICAgfQoKICAgICAgICBfdGhpczUucG9wdWxhdGVMYXlvdXQoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgfSk7CiAgICAgIHRoaXMubG9hZChfdm0uUmVnaXN0ZXIuczApOwogICAgfTsKCiAgICBfcHJvdG8xMi5pbnZva2VTdGF0aWNDb21wb25lbnQgPSBmdW5jdGlvbiBpbnZva2VTdGF0aWNDb21wb25lbnQoY2FwYWJpbGl0aWVzLCBsYXlvdXQsIGF0dHJzLCBwYXJhbXMsIGhhc2gsIHN5bnRoZXRpYywgYmxvY2ssIGludmVyc2UpIHsKICAgICAgaWYgKGludmVyc2UgPT09IHZvaWQgMCkgewogICAgICAgIGludmVyc2UgPSBudWxsOwogICAgICB9CgogICAgICB2YXIgc3ltYm9sVGFibGUgPSBsYXlvdXQuc3ltYm9sVGFibGU7CiAgICAgIHZhciBiYWlsT3V0ID0gc3ltYm9sVGFibGUuaGFzRXZhbCB8fCBjYXBhYmlsaXRpZXMucHJlcGFyZUFyZ3M7CgogICAgICBpZiAoYmFpbE91dCkgewogICAgICAgIHRoaXMuaW52b2tlQ29tcG9uZW50KGNhcGFiaWxpdGllcywgYXR0cnMsIHBhcmFtcywgaGFzaCwgc3ludGhldGljLCBibG9jaywgaW52ZXJzZSwgbGF5b3V0KTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuZmV0Y2goX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgdGhpcy5kdXAoX3ZtLlJlZ2lzdGVyLnNwLCAxKTsKICAgICAgdGhpcy5sb2FkKF92bS5SZWdpc3Rlci5zMCk7CiAgICAgIHZhciBzeW1ib2xzID0gc3ltYm9sVGFibGUuc3ltYm9sczsKCiAgICAgIGlmIChjYXBhYmlsaXRpZXMuY3JlYXRlQXJncykgewogICAgICAgIHRoaXMucHVzaEZyYW1lKCk7CiAgICAgICAgdGhpcy5jb21waWxlQXJncyhwYXJhbXMsIGhhc2gsIG51bGwsIHN5bnRoZXRpYyk7CiAgICAgIH0KCiAgICAgIHRoaXMuYmVnaW5Db21wb25lbnRUcmFuc2FjdGlvbigpOwoKICAgICAgaWYgKGNhcGFiaWxpdGllcy5keW5hbWljU2NvcGUpIHsKICAgICAgICB0aGlzLnB1c2hEeW5hbWljU2NvcGUoKTsKICAgICAgfQoKICAgICAgaWYgKGNhcGFiaWxpdGllcy5jcmVhdGVJbnN0YW5jZSkgewogICAgICAgIHRoaXMuY3JlYXRlQ29tcG9uZW50KF92bS5SZWdpc3Rlci5zMCwgYmxvY2sgIT09IG51bGwpOwogICAgICB9CgogICAgICBpZiAoY2FwYWJpbGl0aWVzLmNyZWF0ZUFyZ3MpIHsKICAgICAgICB0aGlzLnBvcEZyYW1lKCk7CiAgICAgIH0KCiAgICAgIHRoaXMucHVzaEZyYW1lKCk7CiAgICAgIHRoaXMucmVnaXN0ZXJDb21wb25lbnREZXN0cnVjdG9yKF92bS5SZWdpc3Rlci5zMCk7CiAgICAgIHZhciBiaW5kaW5ncyA9IFtdOwogICAgICB0aGlzLmdldENvbXBvbmVudFNlbGYoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgYmluZGluZ3MucHVzaCh7CiAgICAgICAgc3ltYm9sOiAwLAogICAgICAgIGlzQmxvY2s6IGZhbHNlCiAgICAgIH0pOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzeW1ib2xzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIHN5bWJvbCA9IHN5bWJvbHNbaV07CgogICAgICAgIHN3aXRjaCAoc3ltYm9sLmNoYXJBdCgwKSkgewogICAgICAgICAgY2FzZSAnJic6CiAgICAgICAgICAgIHZhciBjYWxsZXJCbG9jayA9IG51bGw7CgogICAgICAgICAgICBpZiAoc3ltYm9sID09PSAnJmRlZmF1bHQnKSB7CiAgICAgICAgICAgICAgY2FsbGVyQmxvY2sgPSBibG9jazsKICAgICAgICAgICAgfSBlbHNlIGlmIChzeW1ib2wgPT09ICcmaW52ZXJzZScpIHsKICAgICAgICAgICAgICBjYWxsZXJCbG9jayA9IGludmVyc2U7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3ltYm9sID09PSBBVFRSU19CTE9DSykgewogICAgICAgICAgICAgIGNhbGxlckJsb2NrID0gYXR0cnM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhyb3cgKDAsIF91dGlsLnVucmVhY2hhYmxlKSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY2FsbGVyQmxvY2spIHsKICAgICAgICAgICAgICB0aGlzLnB1c2hZaWVsZGFibGVCbG9jayhjYWxsZXJCbG9jayk7CiAgICAgICAgICAgICAgYmluZGluZ3MucHVzaCh7CiAgICAgICAgICAgICAgICBzeW1ib2w6IGkgKyAxLAogICAgICAgICAgICAgICAgaXNCbG9jazogdHJ1ZQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMucHVzaFlpZWxkYWJsZUJsb2NrKG51bGwpOwogICAgICAgICAgICAgIGJpbmRpbmdzLnB1c2goewogICAgICAgICAgICAgICAgc3ltYm9sOiBpICsgMSwKICAgICAgICAgICAgICAgIGlzQmxvY2s6IHRydWUKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSAnQCc6CiAgICAgICAgICAgIGlmICghaGFzaCkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIga2V5cyA9IGhhc2hbMF0sCiAgICAgICAgICAgICAgICB2YWx1ZXMgPSBoYXNoWzFdOwogICAgICAgICAgICB2YXIgbG9va3VwTmFtZSA9IHN5bWJvbDsKCiAgICAgICAgICAgIGlmIChzeW50aGV0aWMpIHsKICAgICAgICAgICAgICBsb29rdXBOYW1lID0gc3ltYm9sLnNsaWNlKDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgaW5kZXggPSBrZXlzLmluZGV4T2YobG9va3VwTmFtZSk7CgogICAgICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgICAgICAgICAgdGhpcy5leHByKHZhbHVlc1tpbmRleF0pOwogICAgICAgICAgICAgIGJpbmRpbmdzLnB1c2goewogICAgICAgICAgICAgICAgc3ltYm9sOiBpICsgMSwKICAgICAgICAgICAgICAgIGlzQmxvY2s6IGZhbHNlCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5wdXNoUm9vdFNjb3BlKHN5bWJvbHMubGVuZ3RoICsgMSwgISEoYmxvY2sgfHwgaW52ZXJzZSB8fCBhdHRycykpOwoKICAgICAgZm9yICh2YXIgX2kgPSBiaW5kaW5ncy5sZW5ndGggLSAxOyBfaSA+PSAwOyBfaS0tKSB7CiAgICAgICAgdmFyIF9iaW5kaW5ncyRfaSA9IGJpbmRpbmdzW19pXSwKICAgICAgICAgICAgX3N5bWJvbCA9IF9iaW5kaW5ncyRfaS5zeW1ib2wsCiAgICAgICAgICAgIGlzQmxvY2sgPSBfYmluZGluZ3MkX2kuaXNCbG9jazsKCiAgICAgICAgaWYgKGlzQmxvY2spIHsKICAgICAgICAgIHRoaXMuc2V0QmxvY2soX3N5bWJvbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuc2V0VmFyaWFibGUoX3N5bWJvbCk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmludm9rZVN0YXRpYyhsYXlvdXQpOwoKICAgICAgaWYgKGNhcGFiaWxpdGllcy5jcmVhdGVJbnN0YW5jZSkgewogICAgICAgIHRoaXMuZGlkUmVuZGVyTGF5b3V0KF92bS5SZWdpc3Rlci5zMCk7CiAgICAgIH0KCiAgICAgIHRoaXMucG9wRnJhbWUoKTsKICAgICAgdGhpcy5wb3BTY29wZSgpOwoKICAgICAgaWYgKGNhcGFiaWxpdGllcy5keW5hbWljU2NvcGUpIHsKICAgICAgICB0aGlzLnBvcER5bmFtaWNTY29wZSgpOwogICAgICB9CgogICAgICB0aGlzLmNvbW1pdENvbXBvbmVudFRyYW5zYWN0aW9uKCk7CiAgICAgIHRoaXMubG9hZChfdm0uUmVnaXN0ZXIuczApOwogICAgfTsKCiAgICBfcHJvdG8xMi5keW5hbWljQ29tcG9uZW50ID0gZnVuY3Rpb24gZHluYW1pY0NvbXBvbmVudChkZWZpbml0aW9uLCBhdHRycywgcGFyYW1zLCBoYXNoLCBzeW50aGV0aWMsIGJsb2NrLCBpbnZlcnNlKSB7CiAgICAgIHZhciBfdGhpczYgPSB0aGlzOwoKICAgICAgaWYgKGludmVyc2UgPT09IHZvaWQgMCkgewogICAgICAgIGludmVyc2UgPSBudWxsOwogICAgICB9CgogICAgICB0aGlzLnJlcGxheWFibGUoewogICAgICAgIGFyZ3M6IGZ1bmN0aW9uIGFyZ3MoKSB7CiAgICAgICAgICBfdGhpczYuZXhwcihkZWZpbml0aW9uKTsKCiAgICAgICAgICBfdGhpczYuZHVwKCk7CgogICAgICAgICAgcmV0dXJuIDI7CiAgICAgICAgfSwKICAgICAgICBib2R5OiBmdW5jdGlvbiBib2R5KCkgewogICAgICAgICAgX3RoaXM2Lmp1bXBVbmxlc3MoJ0VMU0UnKTsKCiAgICAgICAgICBfdGhpczYucmVzb2x2ZUR5bmFtaWNDb21wb25lbnQoX3RoaXM2LmNvbnRhaW5pbmdMYXlvdXQucmVmZXJyZXIpOwoKICAgICAgICAgIF90aGlzNi5wdXNoRHluYW1pY0NvbXBvbmVudEluc3RhbmNlKCk7CgogICAgICAgICAgX3RoaXM2Lmludm9rZUNvbXBvbmVudCh0cnVlLCBhdHRycywgcGFyYW1zLCBoYXNoLCBzeW50aGV0aWMsIGJsb2NrLCBpbnZlcnNlKTsKCiAgICAgICAgICBfdGhpczYubGFiZWwoJ0VMU0UnKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKCiAgICBfcHJvdG8xMi55aWVsZCA9IGZ1bmN0aW9uIF95aWVsZCh0bywgcGFyYW1zKSB7CiAgICAgIHRoaXMuY29tcGlsZUFyZ3MocGFyYW1zLCBudWxsLCBudWxsLCBmYWxzZSk7CiAgICAgIHRoaXMuZ2V0QmxvY2sodG8pOwogICAgICB0aGlzLnJlc29sdmVCbG9jaygpOwogICAgICB0aGlzLmludm9rZVlpZWxkKCk7CiAgICAgIHRoaXMucG9wU2NvcGUoKTsKICAgICAgdGhpcy5wb3BGcmFtZSgpOwogICAgfTsKCiAgICBfcHJvdG8xMi5ndWFyZGVkQXBwZW5kID0gZnVuY3Rpb24gZ3VhcmRlZEFwcGVuZChleHByZXNzaW9uLCB0cnVzdGluZykgewogICAgICB0aGlzLnB1c2hGcmFtZSgpOwogICAgICB0aGlzLmV4cHIoZXhwcmVzc2lvbik7CiAgICAgIHRoaXMucHVzaE1hY2hpbmUoNTAKICAgICAgLyogSW52b2tlU3RhdGljICovCiAgICAgICwgdGhpcy5zdGRMaWIuZ2V0QXBwZW5kKHRydXN0aW5nKSk7CiAgICAgIHRoaXMucG9wRnJhbWUoKTsKICAgIH07CgogICAgX3Byb3RvMTIuaW52b2tlU3RhdGljQmxvY2sgPSBmdW5jdGlvbiBpbnZva2VTdGF0aWNCbG9jayhibG9jaywgY2FsbGVyQ291bnQpIHsKICAgICAgaWYgKGNhbGxlckNvdW50ID09PSB2b2lkIDApIHsKICAgICAgICBjYWxsZXJDb3VudCA9IDA7CiAgICAgIH0KCiAgICAgIHZhciBwYXJhbWV0ZXJzID0gYmxvY2suc3ltYm9sVGFibGUucGFyYW1ldGVyczsKICAgICAgdmFyIGNhbGxlZUNvdW50ID0gcGFyYW1ldGVycy5sZW5ndGg7CiAgICAgIHZhciBjb3VudCA9IE1hdGgubWluKGNhbGxlckNvdW50LCBjYWxsZWVDb3VudCk7CiAgICAgIHRoaXMucHVzaEZyYW1lKCk7CgogICAgICBpZiAoY291bnQpIHsKICAgICAgICB0aGlzLnB1c2hDaGlsZFNjb3BlKCk7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgICAgdGhpcy5kdXAoX3ZtLlJlZ2lzdGVyLmZwLCBjYWxsZXJDb3VudCAtIGkpOwogICAgICAgICAgdGhpcy5zZXRWYXJpYWJsZShwYXJhbWV0ZXJzW2ldKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMucHVzaEJsb2NrKGJsb2NrKTsKICAgICAgdGhpcy5yZXNvbHZlQmxvY2soKTsKICAgICAgdGhpcy5pbnZva2VWaXJ0dWFsKCk7CgogICAgICBpZiAoY291bnQpIHsKICAgICAgICB0aGlzLnBvcFNjb3BlKCk7CiAgICAgIH0KCiAgICAgIHRoaXMucG9wRnJhbWUoKTsKICAgIH0gLy8vIENPTlZFTklFTkNFCiAgICAvLyBpbnRlcm5hbCBoZWxwZXJzCiAgICA7CgogICAgX3Byb3RvMTIuc3RyaW5nID0gZnVuY3Rpb24gc3RyaW5nKF9zdHJpbmcpIHsKICAgICAgcmV0dXJuIHRoaXMuY29uc3RhbnRzLnN0cmluZyhfc3RyaW5nKTsKICAgIH07CgogICAgX3Byb3RvMTIubmFtZXMgPSBmdW5jdGlvbiBuYW1lcyhfbmFtZXMpIHsKICAgICAgdmFyIG5hbWVzID0gW107CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IF9uYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBuID0gX25hbWVzW2ldOwogICAgICAgIG5hbWVzW2ldID0gdGhpcy5jb25zdGFudHMuc3RyaW5nKG4pOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5jb25zdGFudHMuYXJyYXkobmFtZXMpOwogICAgfTsKCiAgICBfcHJvdG8xMi5zeW1ib2xzID0gZnVuY3Rpb24gc3ltYm9scyhfc3ltYm9sczIpIHsKICAgICAgcmV0dXJuIHRoaXMuY29uc3RhbnRzLmFycmF5KF9zeW1ib2xzMik7CiAgICB9IC8vIHZtCiAgICA7CgogICAgX3Byb3RvMTIucHJpbWl0aXZlID0gZnVuY3Rpb24gcHJpbWl0aXZlKF9wcmltaXRpdmUpIHsKICAgICAgdmFyIHR5cGUgPSAwCiAgICAgIC8qIE5VTUJFUiAqLwogICAgICA7CiAgICAgIHZhciBwcmltaXRpdmU7CgogICAgICBzd2l0Y2ggKHR5cGVvZiBfcHJpbWl0aXZlKSB7CiAgICAgICAgY2FzZSAnbnVtYmVyJzoKICAgICAgICAgIGlmIChfcHJpbWl0aXZlICUgMSA9PT0gMCkgewogICAgICAgICAgICBpZiAoX3ByaW1pdGl2ZSA+IC0xKSB7CiAgICAgICAgICAgICAgcHJpbWl0aXZlID0gX3ByaW1pdGl2ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwcmltaXRpdmUgPSB0aGlzLmNvbnN0YW50cy5udW1iZXIoX3ByaW1pdGl2ZSk7CiAgICAgICAgICAgICAgdHlwZSA9IDQKICAgICAgICAgICAgICAvKiBORUdBVElWRSAqLwogICAgICAgICAgICAgIDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJpbWl0aXZlID0gdGhpcy5jb25zdGFudHMubnVtYmVyKF9wcmltaXRpdmUpOwogICAgICAgICAgICB0eXBlID0gMQogICAgICAgICAgICAvKiBGTE9BVCAqLwogICAgICAgICAgICA7CiAgICAgICAgICB9CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgICBwcmltaXRpdmUgPSB0aGlzLnN0cmluZyhfcHJpbWl0aXZlKTsKICAgICAgICAgIHR5cGUgPSAyCiAgICAgICAgICAvKiBTVFJJTkcgKi8KICAgICAgICAgIDsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICAgIHByaW1pdGl2ZSA9IF9wcmltaXRpdmUgfCAwOwogICAgICAgICAgdHlwZSA9IDMKICAgICAgICAgIC8qIEJPT0xFQU5fT1JfVk9JRCAqLwogICAgICAgICAgOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ29iamVjdCc6CiAgICAgICAgICAvLyBhc3N1bWUgbnVsbAogICAgICAgICAgcHJpbWl0aXZlID0gMjsKICAgICAgICAgIHR5cGUgPSAzCiAgICAgICAgICAvKiBCT09MRUFOX09SX1ZPSUQgKi8KICAgICAgICAgIDsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICd1bmRlZmluZWQnOgogICAgICAgICAgcHJpbWl0aXZlID0gMzsKICAgICAgICAgIHR5cGUgPSAzCiAgICAgICAgICAvKiBCT09MRUFOX09SX1ZPSUQgKi8KICAgICAgICAgIDsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHByaW1pdGl2ZSBwYXNzZWQgdG8gcHVzaFByaW1pdGl2ZScpOwogICAgICB9CgogICAgICB2YXIgaW1tZWRpYXRlID0gdGhpcy5zaXplSW1tZWRpYXRlKHByaW1pdGl2ZSA8PCAzIHwgdHlwZSwgcHJpbWl0aXZlKTsKICAgICAgdGhpcy5wdXNoKDEzCiAgICAgIC8qIFByaW1pdGl2ZSAqLwogICAgICAsIGltbWVkaWF0ZSk7CiAgICB9OwoKICAgIF9wcm90bzEyLnNpemVJbW1lZGlhdGUgPSBmdW5jdGlvbiBzaXplSW1tZWRpYXRlKHNoaWZ0ZWQsIHByaW1pdGl2ZSkgewogICAgICBpZiAoc2hpZnRlZCA+PSA0Mjk0OTY3Mjk1CiAgICAgIC8qIE1BWF9TSVpFICovCiAgICAgIHx8IHNoaWZ0ZWQgPCAwKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RhbnRzLm51bWJlcihwcmltaXRpdmUpIDw8IDMgfCA1CiAgICAgICAgLyogQklHX05VTSAqLwogICAgICAgIDsKICAgICAgfQoKICAgICAgcmV0dXJuIHNoaWZ0ZWQ7CiAgICB9OwoKICAgIF9wcm90bzEyLnB1c2hQcmltaXRpdmVSZWZlcmVuY2UgPSBmdW5jdGlvbiBwdXNoUHJpbWl0aXZlUmVmZXJlbmNlKHByaW1pdGl2ZSkgewogICAgICB0aGlzLnByaW1pdGl2ZShwcmltaXRpdmUpOwogICAgICB0aGlzLnByaW1pdGl2ZVJlZmVyZW5jZSgpOwogICAgfSAvLyBjb21wb25lbnRzCiAgICA7CgogICAgX3Byb3RvMTIucHVzaENvbXBvbmVudERlZmluaXRpb24gPSBmdW5jdGlvbiBwdXNoQ29tcG9uZW50RGVmaW5pdGlvbihoYW5kbGUpIHsKICAgICAgdGhpcy5wdXNoKDcyCiAgICAgIC8qIFB1c2hDb21wb25lbnREZWZpbml0aW9uICovCiAgICAgICwgdGhpcy5jb25zdGFudHMuaGFuZGxlKGhhbmRsZSkpOwogICAgfTsKCiAgICBfcHJvdG8xMi5yZXNvbHZlRHluYW1pY0NvbXBvbmVudCA9IGZ1bmN0aW9uIHJlc29sdmVEeW5hbWljQ29tcG9uZW50KHJlZmVycmVyKSB7CiAgICAgIHRoaXMucHVzaCg3NQogICAgICAvKiBSZXNvbHZlRHluYW1pY0NvbXBvbmVudCAqLwogICAgICAsIHRoaXMuY29uc3RhbnRzLnNlcmlhbGl6YWJsZShyZWZlcnJlcikpOwogICAgfTsKCiAgICBfcHJvdG8xMi5zdGF0aWNDb21wb25lbnRIZWxwZXIgPSBmdW5jdGlvbiBzdGF0aWNDb21wb25lbnRIZWxwZXIodGFnLCBoYXNoLCB0ZW1wbGF0ZSkgewogICAgICB2YXIgX3RoaXMkY29tcGlsZXIkcmVzb2x2ID0gdGhpcy5jb21waWxlci5yZXNvbHZlTGF5b3V0Rm9yVGFnKHRhZywgdGhpcy5yZWZlcnJlciksCiAgICAgICAgICBoYW5kbGUgPSBfdGhpcyRjb21waWxlciRyZXNvbHYuaGFuZGxlLAogICAgICAgICAgY2FwYWJpbGl0aWVzID0gX3RoaXMkY29tcGlsZXIkcmVzb2x2LmNhcGFiaWxpdGllcywKICAgICAgICAgIGNvbXBpbGFibGUgPSBfdGhpcyRjb21waWxlciRyZXNvbHYuY29tcGlsYWJsZTsKCiAgICAgIGlmIChoYW5kbGUgIT09IG51bGwgJiYgY2FwYWJpbGl0aWVzICE9PSBudWxsKSB7CiAgICAgICAgaWYgKGNvbXBpbGFibGUpIHsKICAgICAgICAgIGlmIChoYXNoKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGFzaC5sZW5ndGg7IGkgPSBpICsgMikgewogICAgICAgICAgICAgIGhhc2hbaV1bMF0gPSAiQCIgKyBoYXNoW2ldWzBdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5wdXNoQ29tcG9uZW50RGVmaW5pdGlvbihoYW5kbGUpOwogICAgICAgICAgdGhpcy5pbnZva2VTdGF0aWNDb21wb25lbnQoY2FwYWJpbGl0aWVzLCBjb21waWxhYmxlLCBudWxsLCBudWxsLCBoYXNoLCBmYWxzZSwgdGVtcGxhdGUgJiYgdGVtcGxhdGUpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9IC8vIHBhcnRpYWwKICAgIDsKCiAgICBfcHJvdG8xMi5pbnZva2VQYXJ0aWFsID0gZnVuY3Rpb24gaW52b2tlUGFydGlhbChyZWZlcnJlciwgc3ltYm9scywgZXZhbEluZm8pIHsKICAgICAgdmFyIF9tZXRhID0gdGhpcy5jb25zdGFudHMuc2VyaWFsaXphYmxlKHJlZmVycmVyKTsKCiAgICAgIHZhciBfc3ltYm9scyA9IHRoaXMuY29uc3RhbnRzLnN0cmluZ0FycmF5KHN5bWJvbHMpOwoKICAgICAgdmFyIF9ldmFsSW5mbyA9IHRoaXMuY29uc3RhbnRzLmFycmF5KGV2YWxJbmZvKTsKCiAgICAgIHRoaXMucHVzaCg5NQogICAgICAvKiBJbnZva2VQYXJ0aWFsICovCiAgICAgICwgX21ldGEsIF9zeW1ib2xzLCBfZXZhbEluZm8pOwogICAgfTsKCiAgICBfcHJvdG8xMi5yZXNvbHZlTWF5YmVMb2NhbCA9IGZ1bmN0aW9uIHJlc29sdmVNYXliZUxvY2FsKG5hbWUpIHsKICAgICAgdGhpcy5wdXNoKDk2CiAgICAgIC8qIFJlc29sdmVNYXliZUxvY2FsICovCiAgICAgICwgdGhpcy5zdHJpbmcobmFtZSkpOwogICAgfSAvLyBkZWJ1Z2dlcgogICAgOwoKICAgIF9wcm90bzEyLmRlYnVnZ2VyID0gZnVuY3Rpb24gX2RlYnVnZ2VyKHN5bWJvbHMsIGV2YWxJbmZvKSB7CiAgICAgIHRoaXMucHVzaCg5NwogICAgICAvKiBEZWJ1Z2dlciAqLwogICAgICAsIHRoaXMuY29uc3RhbnRzLnN0cmluZ0FycmF5KHN5bWJvbHMpLCB0aGlzLmNvbnN0YW50cy5hcnJheShldmFsSW5mbykpOwogICAgfSAvLyBkb20KICAgIDsKCiAgICBfcHJvdG8xMi50ZXh0ID0gZnVuY3Rpb24gdGV4dChfdGV4dCkgewogICAgICB0aGlzLnB1c2goMjYKICAgICAgLyogVGV4dCAqLwogICAgICAsIHRoaXMuY29uc3RhbnRzLnN0cmluZyhfdGV4dCkpOwogICAgfTsKCiAgICBfcHJvdG8xMi5vcGVuUHJpbWl0aXZlRWxlbWVudCA9IGZ1bmN0aW9uIG9wZW5QcmltaXRpdmVFbGVtZW50KHRhZykgewogICAgICB0aGlzLnB1c2goMzMKICAgICAgLyogT3BlbkVsZW1lbnQgKi8KICAgICAgLCB0aGlzLmNvbnN0YW50cy5zdHJpbmcodGFnKSk7CiAgICB9OwoKICAgIF9wcm90bzEyLm1vZGlmaWVyID0gZnVuY3Rpb24gbW9kaWZpZXIobG9jYXRvciwgcGFyYW1zLCBoYXNoKSB7CiAgICAgIHRoaXMucHVzaEZyYW1lKCk7CiAgICAgIHRoaXMuY29tcGlsZUFyZ3MocGFyYW1zLCBoYXNoLCBudWxsLCB0cnVlKTsKICAgICAgdGhpcy5wdXNoKDQwCiAgICAgIC8qIE1vZGlmaWVyICovCiAgICAgICwgdGhpcy5jb25zdGFudHMuaGFuZGxlKGxvY2F0b3IpKTsKICAgICAgdGhpcy5wb3BGcmFtZSgpOwogICAgfTsKCiAgICBfcHJvdG8xMi5jb21tZW50ID0gZnVuY3Rpb24gY29tbWVudChfY29tbWVudCkgewogICAgICB2YXIgY29tbWVudCA9IHRoaXMuY29uc3RhbnRzLnN0cmluZyhfY29tbWVudCk7CiAgICAgIHRoaXMucHVzaCgyNwogICAgICAvKiBDb21tZW50ICovCiAgICAgICwgY29tbWVudCk7CiAgICB9OwoKICAgIF9wcm90bzEyLmR5bmFtaWNBdHRyID0gZnVuY3Rpb24gZHluYW1pY0F0dHIoX25hbWUsIF9uYW1lc3BhY2UsIHRydXN0aW5nKSB7CiAgICAgIHZhciBuYW1lID0gdGhpcy5jb25zdGFudHMuc3RyaW5nKF9uYW1lKTsKICAgICAgdmFyIG5hbWVzcGFjZSA9IF9uYW1lc3BhY2UgPyB0aGlzLmNvbnN0YW50cy5zdHJpbmcoX25hbWVzcGFjZSkgOiAwOwogICAgICB0aGlzLnB1c2goMzYKICAgICAgLyogRHluYW1pY0F0dHIgKi8KICAgICAgLCBuYW1lLCB0cnVzdGluZyA9PT0gdHJ1ZSA/IDEgOiAwLCBuYW1lc3BhY2UpOwogICAgfTsKCiAgICBfcHJvdG8xMi5jb21wb25lbnRBdHRyID0gZnVuY3Rpb24gY29tcG9uZW50QXR0cihfbmFtZSwgX25hbWVzcGFjZSwgdHJ1c3RpbmcpIHsKICAgICAgdmFyIG5hbWUgPSB0aGlzLmNvbnN0YW50cy5zdHJpbmcoX25hbWUpOwogICAgICB2YXIgbmFtZXNwYWNlID0gX25hbWVzcGFjZSA/IHRoaXMuY29uc3RhbnRzLnN0cmluZyhfbmFtZXNwYWNlKSA6IDA7CiAgICAgIHRoaXMucHVzaCgzNwogICAgICAvKiBDb21wb25lbnRBdHRyICovCiAgICAgICwgbmFtZSwgdHJ1c3RpbmcgPT09IHRydWUgPyAxIDogMCwgbmFtZXNwYWNlKTsKICAgIH07CgogICAgX3Byb3RvMTIuc3RhdGljQXR0ciA9IGZ1bmN0aW9uIHN0YXRpY0F0dHIoX25hbWUsIF9uYW1lc3BhY2UsIF92YWx1ZSkgewogICAgICB2YXIgbmFtZSA9IHRoaXMuY29uc3RhbnRzLnN0cmluZyhfbmFtZSk7CiAgICAgIHZhciBuYW1lc3BhY2UgPSBfbmFtZXNwYWNlID8gdGhpcy5jb25zdGFudHMuc3RyaW5nKF9uYW1lc3BhY2UpIDogMDsKICAgICAgdmFyIHZhbHVlID0gdGhpcy5jb25zdGFudHMuc3RyaW5nKF92YWx1ZSk7CiAgICAgIHRoaXMucHVzaCgzNQogICAgICAvKiBTdGF0aWNBdHRyICovCiAgICAgICwgbmFtZSwgdmFsdWUsIG5hbWVzcGFjZSk7CiAgICB9IC8vIGV4cHJlc3Npb25zCiAgICA7CgogICAgX3Byb3RvMTIuaGFzQmxvY2tQYXJhbXMgPSBmdW5jdGlvbiBoYXNCbG9ja1BhcmFtcyh0bykgewogICAgICB0aGlzLmdldEJsb2NrKHRvKTsKICAgICAgdGhpcy5yZXNvbHZlQmxvY2soKTsKICAgICAgdGhpcy5wdXNoKDEwCiAgICAgIC8qIEhhc0Jsb2NrUGFyYW1zICovCiAgICAgICk7CiAgICB9OwoKICAgIF9wcm90bzEyLmdldFByb3BlcnR5ID0gZnVuY3Rpb24gZ2V0UHJvcGVydHkoa2V5KSB7CiAgICAgIHRoaXMucHVzaCg3CiAgICAgIC8qIEdldFByb3BlcnR5ICovCiAgICAgICwgdGhpcy5zdHJpbmcoa2V5KSk7CiAgICB9OwoKICAgIF9wcm90bzEyLmhlbHBlciA9IGZ1bmN0aW9uIGhlbHBlcihfaGVscGVyLCBwYXJhbXMsIGhhc2gpIHsKICAgICAgdGhpcy5wdXNoRnJhbWUoKTsKICAgICAgdGhpcy5jb21waWxlQXJncyhwYXJhbXMsIGhhc2gsIG51bGwsIHRydWUpOwogICAgICB0aGlzLnB1c2goMQogICAgICAvKiBIZWxwZXIgKi8KICAgICAgLCB0aGlzLmNvbnN0YW50cy5oYW5kbGUoX2hlbHBlcikpOwogICAgICB0aGlzLnBvcEZyYW1lKCk7CiAgICAgIHRoaXMuZmV0Y2goX3ZtLlJlZ2lzdGVyLnYwKTsKICAgIH07CgogICAgX3Byb3RvMTIuYmluZER5bmFtaWNTY29wZSA9IGZ1bmN0aW9uIGJpbmREeW5hbWljU2NvcGUoX25hbWVzKSB7CiAgICAgIHRoaXMucHVzaCg0MwogICAgICAvKiBCaW5kRHluYW1pY1Njb3BlICovCiAgICAgICwgdGhpcy5uYW1lcyhfbmFtZXMpKTsKICAgIH0gLy8gY29udmVuaWVuY2UgbWV0aG9kcwoKICAgIC8qKgogICAgICogQSBjb252ZW5pZW5jZSBmb3IgcHVzaGluZyBzb21lIGFyZ3VtZW50cyBvbiB0aGUgc3RhY2sgYW5kCiAgICAgKiBydW5uaW5nIHNvbWUgY29kZSBpZiB0aGUgY29kZSBuZWVkcyB0byBiZSByZS1leGVjdXRlZCBkdXJpbmcKICAgICAqIHVwZGF0aW5nIGV4ZWN1dGlvbiBpZiBzb21lIG9mIHRoZSBhcmd1bWVudHMgaGF2ZSBjaGFuZ2VkLgogICAgICoKICAgICAqICMgSW5pdGlhbCBFeGVjdXRpb24KICAgICAqCiAgICAgKiBUaGUgYGFyZ3NgIGZ1bmN0aW9uIHNob3VsZCBwdXNoIHplcm8gb3IgbW9yZSBhcmd1bWVudHMgb250bwogICAgICogdGhlIHN0YWNrIGFuZCByZXR1cm4gdGhlIG51bWJlciBvZiBhcmd1bWVudHMgcHVzaGVkLgogICAgICoKICAgICAqIFRoZSBgYm9keWAgZnVuY3Rpb24gcHJvdmlkZXMgdGhlIGluc3RydWN0aW9ucyB0byBleGVjdXRlIGJvdGgKICAgICAqIGR1cmluZyBpbml0aWFsIGV4ZWN1dGlvbiBhbmQgZHVyaW5nIHVwZGF0aW5nIGV4ZWN1dGlvbi4KICAgICAqCiAgICAgKiBJbnRlcm5hbGx5LCB0aGlzIGZ1bmN0aW9uIHN0YXJ0cyBieSBwdXNoaW5nIGEgbmV3IGZyYW1lLCBzbwogICAgICogdGhhdCB0aGUgYm9keSBjYW4gcmV0dXJuIGFuZCBzZXRzIHRoZSByZXR1cm4gcG9pbnQgKCRyYSkgdG8KICAgICAqIHRoZSBFTkRJTklUSUFMIGxhYmVsLgogICAgICoKICAgICAqIEl0IHRoZW4gZXhlY3V0ZXMgdGhlIGBhcmdzYCBmdW5jdGlvbiwgd2hpY2ggYWRkcyBpbnN0cnVjdGlvbnMKICAgICAqIHJlc3BvbnNpYmxlIGZvciBwdXNoaW5nIHRoZSBhcmd1bWVudHMgZm9yIHRoZSBibG9jayB0byB0aGUKICAgICAqIHN0YWNrLiBUaGVzZSBhcmd1bWVudHMgd2lsbCBiZSByZXN0b3JlZCB0byB0aGUgc3RhY2sgYmVmb3JlCiAgICAgKiB1cGRhdGluZyBleGVjdXRpb24uCiAgICAgKgogICAgICogTmV4dCwgaXQgYWRkcyB0aGUgRW50ZXIgb3Bjb2RlLCB3aGljaCBtYXJrcyB0aGUgY3VycmVudCBwb3NpdGlvbgogICAgICogaW4gdGhlIERPTSwgYW5kIHJlbWVtYmVycyB0aGUgY3VycmVudCAkcGMgKHRoZSBuZXh0IGluc3RydWN0aW9uKQogICAgICogYXMgdGhlIGZpcnN0IGluc3RydWN0aW9uIHRvIGV4ZWN1dGUgZHVyaW5nIHVwZGF0aW5nIGV4ZWN1dGlvbi4KICAgICAqCiAgICAgKiBOZXh0LCBpdCBydW5zIGBib2R5YCwgd2hpY2ggYWRkcyB0aGUgb3Bjb2RlcyB0aGF0IHNob3VsZAogICAgICogZXhlY3V0ZSBib3RoIGR1cmluZyBpbml0aWFsIGV4ZWN1dGlvbiBhbmQgZHVyaW5nIHVwZGF0aW5nIGV4ZWN1dGlvbi4KICAgICAqIElmIHRoZSBgYm9keWAgd2lzaGVzIHRvIGZpbmlzaCBlYXJseSwgaXQgc2hvdWxkIEp1bXAgdG8gdGhlCiAgICAgKiBgRklOQUxMWWAgbGFiZWwuCiAgICAgKgogICAgICogTmV4dCwgaXQgYWRkcyB0aGUgRklOQUxMWSBsYWJlbCwgZm9sbG93ZWQgYnk6CiAgICAgKgogICAgICogLSB0aGUgRXhpdCBvcGNvZGUsIHdoaWNoIGZpbmFsaXplcyB0aGUgbWFya2VkIERPTSBzdGFydGVkIGJ5IHRoZQogICAgICogICBFbnRlciBvcGNvZGUuCiAgICAgKiAtIHRoZSBSZXR1cm4gb3Bjb2RlLCB3aGljaCByZXR1cm5zIHRvIHRoZSBjdXJyZW50IHJldHVybiBwb2ludAogICAgICogICAoJHJhKS4KICAgICAqCiAgICAgKiBGaW5hbGx5LCBpdCBhZGRzIHRoZSBFTkRJTklUSUFMIGxhYmVsIGZvbGxvd2VkIGJ5IHRoZSBQb3BGcmFtZQogICAgICogaW5zdHJ1Y3Rpb24sIHdoaWNoIHJlc3RvcmVzICRmcCwgJHNwIGFuZCAkcmEuCiAgICAgKgogICAgICogIyBVcGRhdGluZyBFeGVjdXRpb24KICAgICAqCiAgICAgKiBVcGRhdGluZyBleGVjdXRpb24gZm9yIHRoaXMgYHJlcGxheWFibGVgIG9jY3VycyBpZiB0aGUgYGJvZHlgIGFkZGVkIGFuCiAgICAgKiBhc3NlcnRpb24sIHZpYSBvbmUgb2YgdGhlIGBKdW1wSWZgLCBgSnVtcFVubGVzc2Agb3IgYEFzc2VydFNhbWVgIG9wY29kZXMuCiAgICAgKgogICAgICogSWYsIGR1cmluZyB1cGRhdGluZyBleGVjdXRvbiwgdGhlIGFzc2VydGlvbiBmYWlscywgdGhlIGluaXRpYWwgVk0gaXMKICAgICAqIHJlc3RvcmVkLCBhbmQgdGhlIHN0b3JlZCBhcmd1bWVudHMgYXJlIHB1c2hlZCBvbnRvIHRoZSBzdGFjay4gVGhlIERPTQogICAgICogYmV0d2VlbiB0aGUgc3RhcnRpbmcgYW5kIGVuZGluZyBtYXJrZXJzIGlzIGNsZWFyZWQsIGFuZCB0aGUgVk0ncyBjdXJzb3IKICAgICAqIGlzIHNldCB0byB0aGUgYXJlYSBqdXN0IGNsZWFyZWQuCiAgICAgKgogICAgICogVGhlIHJldHVybiBwb2ludCAoJHJhKSBpcyBzZXQgdG8gLTEsIHRoZSBleGl0IGluc3RydWN0aW9uLgogICAgICoKICAgICAqIEZpbmFsbHksIHRoZSAkcGMgaXMgc2V0IHRvIHRvIHRoZSBpbnN0cnVjdGlvbiBzYXZlZCBvZmYgYnkgdGhlCiAgICAgKiBFbnRlciBvcGNvZGUgZHVyaW5nIGluaXRpYWwgZXhlY3V0aW9uLCBhbmQgZXhlY3V0aW9uIHByb2NlZWRzIGFzCiAgICAgKiB1c3VhbC4KICAgICAqCiAgICAgKiBUaGUgb25seSBkaWZmZXJlbmNlIGlzIHRoYXQgd2hlbiBhIGBSZXR1cm5gIGluc3RydWN0aW9uIGlzCiAgICAgKiBlbmNvdW50ZXJlZCwgdGhlIHByb2dyYW0ganVtcHMgdG8gLTEgcmF0aGVyIHRoYW4gdGhlIEVORCBsYWJlbCwKICAgICAqIGFuZCB0aGUgUG9wRnJhbWUgb3Bjb2RlIGlzIG5vdCBuZWVkZWQuCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8xMi5yZXBsYXlhYmxlID0gZnVuY3Rpb24gcmVwbGF5YWJsZShfcmVmKSB7CiAgICAgIHZhciBhcmdzID0gX3JlZi5hcmdzLAogICAgICAgICAgYm9keSA9IF9yZWYuYm9keTsKICAgICAgLy8gU3RhcnQgYSBuZXcgbGFiZWwgZnJhbWUsIHRvIGdpdmUgRU5EIGFuZCBSRVRVUk4KICAgICAgLy8gYSB1bmlxdWUgbWVhbmluZy4KICAgICAgdGhpcy5zdGFydExhYmVscygpOwogICAgICB0aGlzLnB1c2hGcmFtZSgpOyAvLyBJZiB0aGUgYm9keSBpbnZva2VzIGEgYmxvY2ssIGl0cyByZXR1cm4gd2lsbCByZXR1cm4gdG8KICAgICAgLy8gRU5ELiBPdGhlcndpc2UsIHRoZSByZXR1cm4gaW4gUkVUVVJOIHdpbGwgcmV0dXJuIHRvIEVORC4KCiAgICAgIHRoaXMucmV0dXJuVG8oJ0VORElOSVRJQUwnKTsgLy8gUHVzaCB0aGUgYXJndW1lbnRzIG9udG8gdGhlIHN0YWNrLiBUaGUgYXJncygpIGZ1bmN0aW9uCiAgICAgIC8vIHRlbGxzIHVzIGhvdyBtYW55IHN0YWNrIGVsZW1lbnRzIHRvIHJldGFpbiBmb3IgcmUtZXhlY3V0aW9uCiAgICAgIC8vIHdoZW4gdXBkYXRpbmcuCgogICAgICB2YXIgY291bnQgPSBhcmdzKCk7IC8vIFN0YXJ0IGEgbmV3IHVwZGF0aW5nIGNsb3N1cmUsIHJlbWVtYmVyaW5nIGBjb3VudGAgZWxlbWVudHMKICAgICAgLy8gZnJvbSB0aGUgc3RhY2suIEV2ZXJ5dGhpbmcgYWZ0ZXIgdGhpcyBwb2ludCwgYW5kIGJlZm9yZSBFTkQsCiAgICAgIC8vIHdpbGwgZXhlY3V0ZSBib3RoIGluaXRpYWxseSBhbmQgdG8gdXBkYXRlIHRoZSBibG9jay4KICAgICAgLy8KICAgICAgLy8gVGhlIGVudGVyIGFuZCBleGl0IG9wY29kZXMgYWxzbyB0cmFjayB0aGUgYXJlYSBvZiB0aGUgRE9NCiAgICAgIC8vIGFzc29jaWF0ZWQgd2l0aCB0aGlzIGJsb2NrLiBJZiBhbiBhc3NlcnRpb24gaW5zaWRlIHRoZSBibG9jawogICAgICAvLyBmYWlscyAoZm9yIGV4YW1wbGUsIHRoZSB0ZXN0IHZhbHVlIGNoYW5nZXMgZnJvbSB0cnVlIHRvIGZhbHNlCiAgICAgIC8vIGluIGFuICNpZiksIHRoZSBET00gaXMgY2xlYXJlZCBhbmQgdGhlIHByb2dyYW0gaXMgcmUtZXhlY3V0ZWQsCiAgICAgIC8vIHJlc3RvcmluZyBgY291bnRgIGVsZW1lbnRzIHRvIHRoZSBzdGFjayBhbmQgZXhlY3V0aW5nIHRoZQogICAgICAvLyBpbnN0cnVjdGlvbnMgYmV0d2VlbiB0aGUgZW50ZXIgYW5kIGV4aXQuCgogICAgICB0aGlzLmVudGVyKGNvdW50KTsgLy8gRXZhbHVhdGUgdGhlIGJvZHkgb2YgdGhlIGJsb2NrLiBUaGUgYm9keSBvZiB0aGUgYmxvY2sgbWF5CiAgICAgIC8vIHJldHVybiwgd2hpY2ggd2lsbCBqdW1wIGV4ZWN1dGlvbiB0byBFTkQgZHVyaW5nIGluaXRpYWwKICAgICAgLy8gZXhlY3V0aW9uLCBhbmQgZXhpdCB0aGUgdXBkYXRpbmcgcm91dGluZS4KCiAgICAgIGJvZHkoKTsgLy8gQWxsIGV4ZWN1dGlvbiBwYXRocyBpbiB0aGUgYm9keSBzaG91bGQgcnVuIHRoZSBGSU5BTExZIG9uY2UKICAgICAgLy8gdGhleSBhcmUgZG9uZS4gSXQgaXMgZXhlY3V0ZWQgYm90aCBkdXJpbmcgaW5pdGlhbCBleGVjdXRpb24KICAgICAgLy8gYW5kIGR1cmluZyB1cGRhdGluZyBleGVjdXRpb24uCgogICAgICB0aGlzLmxhYmVsKCdGSU5BTExZJyk7IC8vIEZpbmFsaXplIHRoZSBET00uCgogICAgICB0aGlzLmV4aXQoKTsgLy8gSW4gaW5pdGlhbCBleGVjdXRpb24sIHRoaXMgaXMgYSBub29wOiBpdCByZXR1cm5zIHRvIHRoZQogICAgICAvLyBpbW1lZGlhdGVseSBmb2xsb3dpbmcgb3Bjb2RlLiBJbiB1cGRhdGluZyBleGVjdXRpb24sIHRoaXMKICAgICAgLy8gZXhpdHMgdGhlIHVwZGF0aW5nIHJvdXRpbmUuCgogICAgICB0aGlzLnJldHVybigpOyAvLyBDbGVhbnVwIGNvZGUgZm9yIHRoZSBibG9jay4gUnVucyBvbiBpbml0aWFsIGV4ZWN1dGlvbgogICAgICAvLyBidXQgbm90IG9uIHVwZGF0aW5nLgoKICAgICAgdGhpcy5sYWJlbCgnRU5ESU5JVElBTCcpOwogICAgICB0aGlzLnBvcEZyYW1lKCk7CiAgICAgIHRoaXMuc3RvcExhYmVscygpOwogICAgfQogICAgLyoqCiAgICAgKiBBIHNwZWNpYWxpemVkIHZlcnNpb24gb2YgdGhlIGByZXBsYXlhYmxlYCBjb252ZW5pZW5jZSB0aGF0IGFsbG93cyB0aGUKICAgICAqIGNhbGxlciB0byBwcm92aWRlIGRpZmZlcmVudCBjb2RlIGJhc2VkIHVwb24gd2hldGhlciB0aGUgaXRlbSBhdAogICAgICogdGhlIHRvcCBvZiB0aGUgc3RhY2sgaXMgdHJ1ZSBvciBmYWxzZS4KICAgICAqCiAgICAgKiBBcyBpbiBgcmVwbGF5YWJsZWAsIHRoZSBgaWZUcnVlYCBhbmQgYGlmRmFsc2VgIGNvZGUgY2FuIGludm9rZSBgcmV0dXJuYC4KICAgICAqCiAgICAgKiBEdXJpbmcgdGhlIGluaXRpYWwgZXhlY3V0aW9uLCBhIGByZXR1cm5gIHdpbGwgY29udGludWUgZXhlY3V0aW9uCiAgICAgKiBpbiB0aGUgY2xlYW51cCBjb2RlLCB3aGljaCBmaW5hbGl6ZXMgdGhlIGN1cnJlbnQgRE9NIGJsb2NrIGFuZCBwb3BzCiAgICAgKiB0aGUgY3VycmVudCBmcmFtZS4KICAgICAqCiAgICAgKiBEdXJpbmcgdGhlIHVwZGF0aW5nIGV4ZWN1dGlvbiwgYSBgcmV0dXJuYCB3aWxsIGV4aXQgdGhlIHVwZGF0aW5nCiAgICAgKiByb3V0aW5lLCBhcyBpdCBjYW4gcmV1c2UgdGhlIERPTSBibG9jayBhbmQgaXMgYWx3YXlzIG9ubHkgYSBzaW5nbGUKICAgICAqIGZyYW1lIGRlZXAuCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8xMi5yZXBsYXlhYmxlSWYgPSBmdW5jdGlvbiByZXBsYXlhYmxlSWYoX3JlZjIpIHsKICAgICAgdmFyIF90aGlzNyA9IHRoaXM7CgogICAgICB2YXIgYXJncyA9IF9yZWYyLmFyZ3MsCiAgICAgICAgICBpZlRydWUgPSBfcmVmMi5pZlRydWUsCiAgICAgICAgICBpZkZhbHNlID0gX3JlZjIuaWZGYWxzZTsKICAgICAgdGhpcy5yZXBsYXlhYmxlKHsKICAgICAgICBhcmdzOiBhcmdzLAogICAgICAgIGJvZHk6IGZ1bmN0aW9uIGJvZHkoKSB7CiAgICAgICAgICAvLyBJZiB0aGUgY29uZGl0aW9uYWwgaXMgZmFsc2UsIGp1bXAgdG8gdGhlIEVMU0UgbGFiZWwuCiAgICAgICAgICBfdGhpczcuanVtcFVubGVzcygnRUxTRScpOyAvLyBPdGhlcndpc2UsIGV4ZWN1dGUgdGhlIGNvZGUgYXNzb2NpYXRlZCB3aXRoIHRoZSB0cnVlIGJyYW5jaC4KCgogICAgICAgICAgaWZUcnVlKCk7IC8vIFdlJ3JlIGRvbmUsIHNvIHJldHVybi4gSW4gdGhlIGluaXRpYWwgZXhlY3V0aW9uLCB0aGlzIHJ1bnMKICAgICAgICAgIC8vIHRoZSBjbGVhbnVwIGNvZGUuIEluIHRoZSB1cGRhdGluZyBWTSwgaXQgZXhpdHMgdGhlIHVwZGF0aW5nCiAgICAgICAgICAvLyByb3V0aW5lLgoKICAgICAgICAgIF90aGlzNy5qdW1wKCdGSU5BTExZJyk7CgogICAgICAgICAgX3RoaXM3LmxhYmVsKCdFTFNFJyk7IC8vIElmIHRoZSBjb25kaXRpb25hbCBpcyBmYWxzZSwgYW5kIGNvZGUgYXNzb2NpYXRpZWQgaXRoIHRoZQogICAgICAgICAgLy8gZmFsc2UgYnJhbmNoIHdhcyBwcm92aWRlZCwgZXhlY3V0ZSBpdC4gSWYgdGhlcmUgd2FzIG5vIGNvZGUKICAgICAgICAgIC8vIGFzc29jaWF0ZWQgd2l0aCB0aGUgZmFsc2UgYnJhbmNoLCBqdW1waW5nIHRvIHRoZSBlbHNlIHN0YXRlbWVudAogICAgICAgICAgLy8gaGFzIG5vIG90aGVyIGJlaGF2aW9yLgoKCiAgICAgICAgICBpZiAoaWZGYWxzZSkgewogICAgICAgICAgICBpZkZhbHNlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CgogICAgX3Byb3RvMTIuaW5saW5lQmxvY2sgPSBmdW5jdGlvbiBpbmxpbmVCbG9jayhibG9jaykgewogICAgICByZXR1cm4gbmV3IENvbXBpbGFibGVCbG9jayh0aGlzLmNvbXBpbGVyLCB7CiAgICAgICAgYmxvY2s6IGJsb2NrLAogICAgICAgIGNvbnRhaW5pbmdMYXlvdXQ6IHRoaXMuY29udGFpbmluZ0xheW91dAogICAgICB9KTsKICAgIH07CgogICAgX3Byb3RvMTIuZXZhbFN5bWJvbHMgPSBmdW5jdGlvbiBldmFsU3ltYm9scygpIHsKICAgICAgdmFyIGJsb2NrID0gdGhpcy5jb250YWluaW5nTGF5b3V0LmJsb2NrOwogICAgICByZXR1cm4gYmxvY2suaGFzRXZhbCA/IGJsb2NrLnN5bWJvbHMgOiBudWxsOwogICAgfTsKCiAgICBfcHJvdG8xMi5jb21waWxlUGFyYW1zID0gZnVuY3Rpb24gY29tcGlsZVBhcmFtcyhwYXJhbXMpIHsKICAgICAgaWYgKCFwYXJhbXMpIHJldHVybiAwOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJhbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLmV4cHIocGFyYW1zW2ldKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBhcmFtcy5sZW5ndGg7CiAgICB9OwoKICAgIF9wcm90bzEyLmNvbXBpbGVBcmdzID0gZnVuY3Rpb24gY29tcGlsZUFyZ3MocGFyYW1zLCBoYXNoLCBibG9ja3MsIHN5bnRoZXRpYykgewogICAgICBpZiAoYmxvY2tzKSB7CiAgICAgICAgdGhpcy5wdXNoWWllbGRhYmxlQmxvY2soYmxvY2tzLm1haW4pOwogICAgICAgIHRoaXMucHVzaFlpZWxkYWJsZUJsb2NrKGJsb2Nrcy5lbHNlKTsKICAgICAgICB0aGlzLnB1c2hZaWVsZGFibGVCbG9jayhibG9ja3MuYXR0cnMpOwogICAgICB9CgogICAgICB2YXIgY291bnQgPSB0aGlzLmNvbXBpbGVQYXJhbXMocGFyYW1zKTsKICAgICAgdmFyIGZsYWdzID0gY291bnQgPDwgNDsKICAgICAgaWYgKHN5bnRoZXRpYykgZmxhZ3MgfD0gODsKCiAgICAgIGlmIChibG9ja3MpIHsKICAgICAgICBmbGFncyB8PSA3OwogICAgICB9CgogICAgICB2YXIgbmFtZXMgPSBfdXRpbC5FTVBUWV9BUlJBWTsKCiAgICAgIGlmIChoYXNoKSB7CiAgICAgICAgbmFtZXMgPSBoYXNoWzBdOwogICAgICAgIHZhciB2YWwgPSBoYXNoWzFdOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbC5sZW5ndGg7IGkrKykgewogICAgICAgICAgdGhpcy5leHByKHZhbFtpXSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLnB1c2hBcmdzKG5hbWVzLCBmbGFncyk7CiAgICB9OwoKICAgIF9wcm90bzEyLnRlbXBsYXRlID0gZnVuY3Rpb24gdGVtcGxhdGUoYmxvY2spIHsKICAgICAgaWYgKCFibG9jaykgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiB0aGlzLmlubGluZUJsb2NrKGJsb2NrKTsKICAgIH07CgogICAgKDAsIF9lbWJlckJhYmVsLmNyZWF0ZUNsYXNzKShPcGNvZGVCdWlsZGVyLCBbewogICAgICBrZXk6ICJyZWZlcnJlciIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbnRhaW5pbmdMYXlvdXQgJiYgdGhpcy5jb250YWluaW5nTGF5b3V0LnJlZmVycmVyOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gT3Bjb2RlQnVpbGRlcjsKICB9KFN0ZE9wY29kZUJ1aWxkZXIpOwoKICBfZXhwb3J0cy5PcGNvZGVCdWlsZGVyID0gT3Bjb2RlQnVpbGRlcjsKCiAgdmFyIExhenlPcGNvZGVCdWlsZGVyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9PcGNvZGVCdWlsZGVyKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoTGF6eU9wY29kZUJ1aWxkZXIsIF9PcGNvZGVCdWlsZGVyKTsKCiAgICBmdW5jdGlvbiBMYXp5T3Bjb2RlQnVpbGRlcigpIHsKICAgICAgcmV0dXJuIF9PcGNvZGVCdWlsZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgIH0KCiAgICB2YXIgX3Byb3RvMTMgPSBMYXp5T3Bjb2RlQnVpbGRlci5wcm90b3R5cGU7CgogICAgX3Byb3RvMTMucHVzaEJsb2NrID0gZnVuY3Rpb24gcHVzaEJsb2NrKGJsb2NrKSB7CiAgICAgIGlmIChibG9jaykgewogICAgICAgIHRoaXMucHVzaE90aGVyKGJsb2NrKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnByaW1pdGl2ZShudWxsKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8xMy5yZXNvbHZlQmxvY2sgPSBmdW5jdGlvbiByZXNvbHZlQmxvY2soKSB7CiAgICAgIHRoaXMucHVzaCg0NgogICAgICAvKiBDb21waWxlQmxvY2sgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvMTMucHVzaExheW91dCA9IGZ1bmN0aW9uIHB1c2hMYXlvdXQobGF5b3V0KSB7CiAgICAgIGlmIChsYXlvdXQpIHsKICAgICAgICB0aGlzLnB1c2hPdGhlcihsYXlvdXQpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucHJpbWl0aXZlKG51bGwpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzEzLnJlc29sdmVMYXlvdXQgPSBmdW5jdGlvbiByZXNvbHZlTGF5b3V0KCkgewogICAgICB0aGlzLnB1c2goNDYKICAgICAgLyogQ29tcGlsZUJsb2NrICovCiAgICAgICk7CiAgICB9OwoKICAgIF9wcm90bzEzLmludm9rZVN0YXRpYyA9IGZ1bmN0aW9uIGludm9rZVN0YXRpYyhjb21waWxhYmxlKSB7CiAgICAgIHRoaXMucHVzaE90aGVyKGNvbXBpbGFibGUpOwogICAgICB0aGlzLnB1c2goNDYKICAgICAgLyogQ29tcGlsZUJsb2NrICovCiAgICAgICk7CiAgICAgIHRoaXMucHVzaE1hY2hpbmUoNDkKICAgICAgLyogSW52b2tlVmlydHVhbCAqLwogICAgICApOwogICAgfTsKCiAgICBfcHJvdG8xMy5wdXNoT3RoZXIgPSBmdW5jdGlvbiBwdXNoT3RoZXIodmFsdWUpIHsKICAgICAgdGhpcy5wdXNoKDEyCiAgICAgIC8qIENvbnN0YW50ICovCiAgICAgICwgdGhpcy5vdGhlcih2YWx1ZSkpOwogICAgfTsKCiAgICBfcHJvdG8xMy5vdGhlciA9IGZ1bmN0aW9uIG90aGVyKHZhbHVlKSB7CiAgICAgIHJldHVybiB0aGlzLmNvbnN0YW50cy5vdGhlcih2YWx1ZSk7CiAgICB9OwoKICAgIHJldHVybiBMYXp5T3Bjb2RlQnVpbGRlcjsKICB9KE9wY29kZUJ1aWxkZXIpOwoKICBfZXhwb3J0cy5MYXp5T3Bjb2RlQnVpbGRlciA9IExhenlPcGNvZGVCdWlsZGVyOwoKICB2YXIgRWFnZXJPcGNvZGVCdWlsZGVyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9PcGNvZGVCdWlsZGVyMikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKEVhZ2VyT3Bjb2RlQnVpbGRlciwgX09wY29kZUJ1aWxkZXIyKTsKCiAgICBmdW5jdGlvbiBFYWdlck9wY29kZUJ1aWxkZXIoKSB7CiAgICAgIHJldHVybiBfT3Bjb2RlQnVpbGRlcjIuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG8xNCA9IEVhZ2VyT3Bjb2RlQnVpbGRlci5wcm90b3R5cGU7CgogICAgX3Byb3RvMTQucHVzaEJsb2NrID0gZnVuY3Rpb24gcHVzaEJsb2NrKGJsb2NrKSB7CiAgICAgIHZhciBoYW5kbGUgPSBibG9jayA/IGJsb2NrLmNvbXBpbGUoKSA6IG51bGw7CiAgICAgIHRoaXMucHJpbWl0aXZlKGhhbmRsZSk7CiAgICB9OwoKICAgIF9wcm90bzE0LnJlc29sdmVCbG9jayA9IGZ1bmN0aW9uIHJlc29sdmVCbG9jaygpIHsKICAgICAgcmV0dXJuOwogICAgfTsKCiAgICBfcHJvdG8xNC5wdXNoTGF5b3V0ID0gZnVuY3Rpb24gcHVzaExheW91dChsYXlvdXQpIHsKICAgICAgaWYgKGxheW91dCkgewogICAgICAgIHRoaXMucHJpbWl0aXZlKGxheW91dC5jb21waWxlKCkpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucHJpbWl0aXZlKG51bGwpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzE0LnJlc29sdmVMYXlvdXQgPSBmdW5jdGlvbiByZXNvbHZlTGF5b3V0KCkge307CgogICAgX3Byb3RvMTQuaW52b2tlU3RhdGljID0gZnVuY3Rpb24gaW52b2tlU3RhdGljKGNvbXBpbGFibGUpIHsKICAgICAgdmFyIGhhbmRsZSA9IGNvbXBpbGFibGUuY29tcGlsZSgpOyAvLyBJZiB0aGUgaGFuZGxlIGZvciB0aGUgaW52b2tlZCBjb21wb25lbnQgaXMgbm90IHlldCBrbm93biAoZm9yIGV4YW1wbGUsCiAgICAgIC8vIGJlY2F1c2UgdGhpcyBpcyBhIHJlY3Vyc2l2ZSBpbnZvY2F0aW9uIGFuZCB3ZSdyZSBzdGlsbCBjb21waWxpbmcpLCBwdXNoIGEKICAgICAgLy8gZnVuY3Rpb24gdGhhdCB3aWxsIHByb2R1Y2UgdGhlIGNvcnJlY3QgaGFuZGxlIHdoZW4gdGhlIGhlYXAgaXMKICAgICAgLy8gc2VyaWFsaXplZC4KCiAgICAgIGlmIChoYW5kbGUgPT09IFBMQUNFSE9MREVSX0hBTkRMRSQxKSB7CiAgICAgICAgdGhpcy5wdXNoTWFjaGluZSg1MAogICAgICAgIC8qIEludm9rZVN0YXRpYyAqLwogICAgICAgICwgZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIGNvbXBpbGFibGUuY29tcGlsZSgpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucHVzaE1hY2hpbmUoNTAKICAgICAgICAvKiBJbnZva2VTdGF0aWMgKi8KICAgICAgICAsIGhhbmRsZSk7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIEVhZ2VyT3Bjb2RlQnVpbGRlcjsKICB9KE9wY29kZUJ1aWxkZXIpOwoKICBfZXhwb3J0cy5FYWdlck9wY29kZUJ1aWxkZXIgPSBFYWdlck9wY29kZUJ1aWxkZXI7CgogIHZhciBMYXp5Q29tcGlsZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0Fic3RyYWN0Q29tcGlsZXIpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShMYXp5Q29tcGlsZXIsIF9BYnN0cmFjdENvbXBpbGVyKTsKCiAgICAvLyBGSVhNRTogdHVybiB0byBzdGF0aWMgbWV0aG9kCiAgICBmdW5jdGlvbiBMYXp5Q29tcGlsZXIobG9va3VwLCByZXNvbHZlciwgbWFjcm9zKSB7CiAgICAgIHZhciBjb25zdGFudHMgPSBuZXcgX3Byb2dyYW0uTGF6eUNvbnN0YW50cyhyZXNvbHZlcik7CiAgICAgIHZhciBwcm9ncmFtID0gbmV3IF9wcm9ncmFtLlByb2dyYW0oY29uc3RhbnRzKTsKICAgICAgcmV0dXJuIF9BYnN0cmFjdENvbXBpbGVyLmNhbGwodGhpcywgbWFjcm9zLCBwcm9ncmFtLCBsb29rdXApIHx8IHRoaXM7CiAgICB9CgogICAgdmFyIF9wcm90bzE1ID0gTGF6eUNvbXBpbGVyLnByb3RvdHlwZTsKCiAgICBfcHJvdG8xNS5idWlsZGVyRm9yID0gZnVuY3Rpb24gYnVpbGRlckZvcihjb250YWluaW5nTGF5b3V0KSB7CiAgICAgIHJldHVybiBuZXcgTGF6eU9wY29kZUJ1aWxkZXIodGhpcywgY29udGFpbmluZ0xheW91dCk7CiAgICB9OwoKICAgIHJldHVybiBMYXp5Q29tcGlsZXI7CiAgfShBYnN0cmFjdENvbXBpbGVyKTsKCiAgX2V4cG9ydHMuTGF6eUNvbXBpbGVyID0gTGF6eUNvbXBpbGVyOwoKICB2YXIgUGFydGlhbERlZmluaXRpb24gPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBQYXJ0aWFsRGVmaW5pdGlvbihuYW1lLCAvLyBmb3IgZGVidWdnaW5nCiAgICB0ZW1wbGF0ZSkgewogICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICB0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CiAgICB9CgogICAgdmFyIF9wcm90bzE2ID0gUGFydGlhbERlZmluaXRpb24ucHJvdG90eXBlOwoKICAgIF9wcm90bzE2LmdldFBhcnRpYWwgPSBmdW5jdGlvbiBnZXRQYXJ0aWFsKCkgewogICAgICB2YXIgcGFydGlhbCA9IHRoaXMudGVtcGxhdGUuYXNQYXJ0aWFsKCk7CiAgICAgIHZhciBoYW5kbGUgPSBwYXJ0aWFsLmNvbXBpbGUoKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBzeW1ib2xUYWJsZTogcGFydGlhbC5zeW1ib2xUYWJsZSwKICAgICAgICBoYW5kbGU6IGhhbmRsZQogICAgICB9OwogICAgfTsKCiAgICByZXR1cm4gUGFydGlhbERlZmluaXRpb247CiAgfSgpOwoKICBfZXhwb3J0cy5QYXJ0aWFsRGVmaW5pdGlvbiA9IFBhcnRpYWxEZWZpbml0aW9uOwogIHZhciBjbGllbnRJZCA9IDA7CgogIGZ1bmN0aW9uIHRlbXBsYXRlRmFjdG9yeShfcmVmMykgewogICAgdmFyIHRlbXBsYXRlSWQgPSBfcmVmMy5pZCwKICAgICAgICBtZXRhID0gX3JlZjMubWV0YSwKICAgICAgICBibG9jayA9IF9yZWYzLmJsb2NrOwogICAgdmFyIHBhcnNlZEJsb2NrOwogICAgdmFyIGlkID0gdGVtcGxhdGVJZCB8fCAiY2xpZW50LSIgKyBjbGllbnRJZCsrOwoKICAgIHZhciBjcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUoY29tcGlsZXIsIGVudk1ldGEpIHsKICAgICAgdmFyIG5ld01ldGEgPSBlbnZNZXRhID8gKDAsIF91dGlsLmFzc2lnbikoe30sIGVudk1ldGEsIG1ldGEpIDogbWV0YTsKCiAgICAgIGlmICghcGFyc2VkQmxvY2spIHsKICAgICAgICBwYXJzZWRCbG9jayA9IEpTT04ucGFyc2UoYmxvY2spOwogICAgICB9CgogICAgICByZXR1cm4gbmV3IFRlbXBsYXRlSW1wbChjb21waWxlciwgewogICAgICAgIGlkOiBpZCwKICAgICAgICBibG9jazogcGFyc2VkQmxvY2ssCiAgICAgICAgcmVmZXJyZXI6IG5ld01ldGEKICAgICAgfSk7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIGlkOiBpZCwKICAgICAgbWV0YTogbWV0YSwKICAgICAgY3JlYXRlOiBjcmVhdGUKICAgIH07CiAgfQoKICB2YXIgVGVtcGxhdGVJbXBsID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gVGVtcGxhdGVJbXBsKGNvbXBpbGVyLCBwYXJzZWRMYXlvdXQpIHsKICAgICAgdGhpcy5jb21waWxlciA9IGNvbXBpbGVyOwogICAgICB0aGlzLnBhcnNlZExheW91dCA9IHBhcnNlZExheW91dDsKICAgICAgdGhpcy5sYXlvdXQgPSBudWxsOwogICAgICB0aGlzLnBhcnRpYWwgPSBudWxsOwogICAgICB0aGlzLndyYXBwZWRMYXlvdXQgPSBudWxsOwogICAgICB2YXIgYmxvY2sgPSBwYXJzZWRMYXlvdXQuYmxvY2s7CiAgICAgIHRoaXMuc3ltYm9scyA9IGJsb2NrLnN5bWJvbHM7CiAgICAgIHRoaXMuaGFzRXZhbCA9IGJsb2NrLmhhc0V2YWw7CiAgICAgIHRoaXMucmVmZXJyZXIgPSBwYXJzZWRMYXlvdXQucmVmZXJyZXI7CiAgICAgIHRoaXMuaWQgPSBwYXJzZWRMYXlvdXQuaWQgfHwgImNsaWVudC0iICsgY2xpZW50SWQrKzsKICAgIH0KCiAgICB2YXIgX3Byb3RvMTcgPSBUZW1wbGF0ZUltcGwucHJvdG90eXBlOwoKICAgIF9wcm90bzE3LmFzTGF5b3V0ID0gZnVuY3Rpb24gYXNMYXlvdXQoKSB7CiAgICAgIGlmICh0aGlzLmxheW91dCkgcmV0dXJuIHRoaXMubGF5b3V0OwogICAgICByZXR1cm4gdGhpcy5sYXlvdXQgPSBuZXcgQ29tcGlsYWJsZVByb2dyYW0odGhpcy5jb21waWxlciwgKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7fSwgdGhpcy5wYXJzZWRMYXlvdXQsIHsKICAgICAgICBhc1BhcnRpYWw6IGZhbHNlCiAgICAgIH0pKTsKICAgIH07CgogICAgX3Byb3RvMTcuYXNQYXJ0aWFsID0gZnVuY3Rpb24gYXNQYXJ0aWFsKCkgewogICAgICBpZiAodGhpcy5wYXJ0aWFsKSByZXR1cm4gdGhpcy5wYXJ0aWFsOwogICAgICByZXR1cm4gdGhpcy5sYXlvdXQgPSBuZXcgQ29tcGlsYWJsZVByb2dyYW0odGhpcy5jb21waWxlciwgKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7fSwgdGhpcy5wYXJzZWRMYXlvdXQsIHsKICAgICAgICBhc1BhcnRpYWw6IHRydWUKICAgICAgfSkpOwogICAgfTsKCiAgICBfcHJvdG8xNy5hc1dyYXBwZWRMYXlvdXQgPSBmdW5jdGlvbiBhc1dyYXBwZWRMYXlvdXQoKSB7CiAgICAgIGlmICh0aGlzLndyYXBwZWRMYXlvdXQpIHJldHVybiB0aGlzLndyYXBwZWRMYXlvdXQ7CiAgICAgIHJldHVybiB0aGlzLndyYXBwZWRMYXlvdXQgPSBuZXcgV3JhcHBlZEJ1aWxkZXIodGhpcy5jb21waWxlciwgKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7fSwgdGhpcy5wYXJzZWRMYXlvdXQsIHsKICAgICAgICBhc1BhcnRpYWw6IGZhbHNlCiAgICAgIH0pKTsKICAgIH07CgogICAgcmV0dXJuIFRlbXBsYXRlSW1wbDsKICB9KCk7Cn0pOwpkZWZpbmUoIkBnbGltbWVyL3Byb2dyYW0iLCBbImV4cG9ydHMiLCAiZW1iZXItYmFiZWwiLCAiQGdsaW1tZXIvdXRpbCJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9lbWJlckJhYmVsLCBfdXRpbCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuT3Bjb2RlID0gX2V4cG9ydHMuUHJvZ3JhbSA9IF9leHBvcnRzLlJ1bnRpbWVQcm9ncmFtID0gX2V4cG9ydHMuV3JpdGVPbmx5UHJvZ3JhbSA9IF9leHBvcnRzLkhlYXAgPSBfZXhwb3J0cy5MYXp5Q29uc3RhbnRzID0gX2V4cG9ydHMuQ29uc3RhbnRzID0gX2V4cG9ydHMuUnVudGltZUNvbnN0YW50cyA9IF9leHBvcnRzLldyaXRlT25seUNvbnN0YW50cyA9IF9leHBvcnRzLldFTExfS05PV05fRU1QVFlfQVJSQVlfUE9TSVRJT04gPSB2b2lkIDA7CiAgdmFyIFVOUkVTT0xWRUQgPSB7fTsKICB2YXIgV0VMTF9LTk9XTl9FTVBUWV9BUlJBWV9QT1NJVElPTiA9IDA7CiAgX2V4cG9ydHMuV0VMTF9LTk9XTl9FTVBUWV9BUlJBWV9QT1NJVElPTiA9IFdFTExfS05PV05fRU1QVFlfQVJSQVlfUE9TSVRJT047CiAgdmFyIFdFTExfS05PV19FTVBUWV9BUlJBWSA9IE9iamVjdC5mcmVlemUoW10pOwoKICB2YXIgV3JpdGVPbmx5Q29uc3RhbnRzID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gV3JpdGVPbmx5Q29uc3RhbnRzKCkgewogICAgICAvLyBgMGAgbWVhbnMgTlVMTAogICAgICB0aGlzLnN0cmluZ3MgPSBbXTsKICAgICAgdGhpcy5hcnJheXMgPSBbV0VMTF9LTk9XX0VNUFRZX0FSUkFZXTsKICAgICAgdGhpcy50YWJsZXMgPSBbXTsKICAgICAgdGhpcy5oYW5kbGVzID0gW107CiAgICAgIHRoaXMucmVzb2x2ZWQgPSBbXTsKICAgICAgdGhpcy5udW1iZXJzID0gW107CiAgICB9CgogICAgdmFyIF9wcm90byA9IFdyaXRlT25seUNvbnN0YW50cy5wcm90b3R5cGU7CgogICAgX3Byb3RvLnN0cmluZyA9IGZ1bmN0aW9uIHN0cmluZyh2YWx1ZSkgewogICAgICB2YXIgaW5kZXggPSB0aGlzLnN0cmluZ3MuaW5kZXhPZih2YWx1ZSk7CgogICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgIHJldHVybiBpbmRleDsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuc3RyaW5ncy5wdXNoKHZhbHVlKSAtIDE7CiAgICB9OwoKICAgIF9wcm90by5zdHJpbmdBcnJheSA9IGZ1bmN0aW9uIHN0cmluZ0FycmF5KHN0cmluZ3MpIHsKICAgICAgdmFyIF9zdHJpbmdzID0gbmV3IEFycmF5KHN0cmluZ3MubGVuZ3RoKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyaW5ncy5sZW5ndGg7IGkrKykgewogICAgICAgIF9zdHJpbmdzW2ldID0gdGhpcy5zdHJpbmcoc3RyaW5nc1tpXSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLmFycmF5KF9zdHJpbmdzKTsKICAgIH07CgogICAgX3Byb3RvLmFycmF5ID0gZnVuY3Rpb24gYXJyYXkodmFsdWVzKSB7CiAgICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIFdFTExfS05PV05fRU1QVFlfQVJSQVlfUE9TSVRJT047CiAgICAgIH0KCiAgICAgIHZhciBpbmRleCA9IHRoaXMuYXJyYXlzLmluZGV4T2YodmFsdWVzKTsKCiAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5hcnJheXMucHVzaCh2YWx1ZXMpIC0gMTsKICAgIH07CgogICAgX3Byb3RvLmhhbmRsZSA9IGZ1bmN0aW9uIGhhbmRsZShfaGFuZGxlKSB7CiAgICAgIHZhciBpbmRleCA9IHRoaXMuaGFuZGxlcy5pbmRleE9mKF9oYW5kbGUpOwoKICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgIH0KCiAgICAgIHRoaXMucmVzb2x2ZWQucHVzaChVTlJFU09MVkVEKTsKICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlcy5wdXNoKF9oYW5kbGUpIC0gMTsKICAgIH07CgogICAgX3Byb3RvLnNlcmlhbGl6YWJsZSA9IGZ1bmN0aW9uIHNlcmlhbGl6YWJsZSh2YWx1ZSkgewogICAgICB2YXIgc3RyID0gSlNPTi5zdHJpbmdpZnkodmFsdWUpOwogICAgICB2YXIgaW5kZXggPSB0aGlzLnN0cmluZ3MuaW5kZXhPZihzdHIpOwoKICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MucHVzaChzdHIpIC0gMTsKICAgIH07CgogICAgX3Byb3RvLm51bWJlciA9IGZ1bmN0aW9uIG51bWJlcihfbnVtYmVyKSB7CiAgICAgIHZhciBpbmRleCA9IHRoaXMubnVtYmVycy5pbmRleE9mKF9udW1iZXIpOwoKICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLm51bWJlcnMucHVzaChfbnVtYmVyKSAtIDE7CiAgICB9OwoKICAgIF9wcm90by50b1Bvb2wgPSBmdW5jdGlvbiB0b1Bvb2woKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgc3RyaW5nczogdGhpcy5zdHJpbmdzLAogICAgICAgIGFycmF5czogdGhpcy5hcnJheXMsCiAgICAgICAgaGFuZGxlczogdGhpcy5oYW5kbGVzLAogICAgICAgIG51bWJlcnM6IHRoaXMubnVtYmVycwogICAgICB9OwogICAgfTsKCiAgICByZXR1cm4gV3JpdGVPbmx5Q29uc3RhbnRzOwogIH0oKTsKCiAgX2V4cG9ydHMuV3JpdGVPbmx5Q29uc3RhbnRzID0gV3JpdGVPbmx5Q29uc3RhbnRzOwoKICB2YXIgUnVudGltZUNvbnN0YW50cyA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFJ1bnRpbWVDb25zdGFudHMocmVzb2x2ZXIsIHBvb2wpIHsKICAgICAgdGhpcy5yZXNvbHZlciA9IHJlc29sdmVyOwogICAgICB0aGlzLnN0cmluZ3MgPSBwb29sLnN0cmluZ3M7CiAgICAgIHRoaXMuYXJyYXlzID0gcG9vbC5hcnJheXM7CiAgICAgIHRoaXMuaGFuZGxlcyA9IHBvb2wuaGFuZGxlczsKICAgICAgdGhpcy5yZXNvbHZlZCA9IHRoaXMuaGFuZGxlcy5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBVTlJFU09MVkVEOwogICAgICB9KTsKICAgICAgdGhpcy5udW1iZXJzID0gcG9vbC5udW1iZXJzOwogICAgfQoKICAgIHZhciBfcHJvdG8yID0gUnVudGltZUNvbnN0YW50cy5wcm90b3R5cGU7CgogICAgX3Byb3RvMi5nZXRTdHJpbmcgPSBmdW5jdGlvbiBnZXRTdHJpbmcodmFsdWUpIHsKICAgICAgcmV0dXJuIHRoaXMuc3RyaW5nc1t2YWx1ZV07CiAgICB9OwoKICAgIF9wcm90bzIuZ2V0TnVtYmVyID0gZnVuY3Rpb24gZ2V0TnVtYmVyKHZhbHVlKSB7CiAgICAgIHJldHVybiB0aGlzLm51bWJlcnNbdmFsdWVdOwogICAgfTsKCiAgICBfcHJvdG8yLmdldFN0cmluZ0FycmF5ID0gZnVuY3Rpb24gZ2V0U3RyaW5nQXJyYXkodmFsdWUpIHsKICAgICAgdmFyIG5hbWVzID0gdGhpcy5nZXRBcnJheSh2YWx1ZSk7CgogICAgICB2YXIgX25hbWVzID0gbmV3IEFycmF5KG5hbWVzLmxlbmd0aCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIG4gPSBuYW1lc1tpXTsKICAgICAgICBfbmFtZXNbaV0gPSB0aGlzLmdldFN0cmluZyhuKTsKICAgICAgfQoKICAgICAgcmV0dXJuIF9uYW1lczsKICAgIH07CgogICAgX3Byb3RvMi5nZXRBcnJheSA9IGZ1bmN0aW9uIGdldEFycmF5KHZhbHVlKSB7CiAgICAgIHJldHVybiB0aGlzLmFycmF5c1t2YWx1ZV07CiAgICB9OwoKICAgIF9wcm90bzIucmVzb2x2ZUhhbmRsZSA9IGZ1bmN0aW9uIHJlc29sdmVIYW5kbGUoaW5kZXgpIHsKICAgICAgdmFyIHJlc29sdmVkID0gdGhpcy5yZXNvbHZlZFtpbmRleF07CgogICAgICBpZiAocmVzb2x2ZWQgPT09IFVOUkVTT0xWRUQpIHsKICAgICAgICB2YXIgaGFuZGxlID0gdGhpcy5oYW5kbGVzW2luZGV4XTsKICAgICAgICByZXNvbHZlZCA9IHRoaXMucmVzb2x2ZWRbaW5kZXhdID0gdGhpcy5yZXNvbHZlci5yZXNvbHZlKGhhbmRsZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXNvbHZlZDsKICAgIH07CgogICAgX3Byb3RvMi5nZXRTZXJpYWxpemFibGUgPSBmdW5jdGlvbiBnZXRTZXJpYWxpemFibGUocykgewogICAgICByZXR1cm4gSlNPTi5wYXJzZSh0aGlzLnN0cmluZ3Nbc10pOwogICAgfTsKCiAgICByZXR1cm4gUnVudGltZUNvbnN0YW50czsKICB9KCk7CgogIF9leHBvcnRzLlJ1bnRpbWVDb25zdGFudHMgPSBSdW50aW1lQ29uc3RhbnRzOwoKICB2YXIgQ29uc3RhbnRzID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9Xcml0ZU9ubHlDb25zdGFudHMpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShDb25zdGFudHMsIF9Xcml0ZU9ubHlDb25zdGFudHMpOwoKICAgIGZ1bmN0aW9uIENvbnN0YW50cyhyZXNvbHZlciwgcG9vbCkgewogICAgICB2YXIgX3RoaXM7CgogICAgICBfdGhpcyA9IF9Xcml0ZU9ubHlDb25zdGFudHMuY2FsbCh0aGlzKSB8fCB0aGlzOwogICAgICBfdGhpcy5yZXNvbHZlciA9IHJlc29sdmVyOwoKICAgICAgaWYgKHBvb2wpIHsKICAgICAgICBfdGhpcy5zdHJpbmdzID0gcG9vbC5zdHJpbmdzOwogICAgICAgIF90aGlzLmFycmF5cyA9IHBvb2wuYXJyYXlzOwogICAgICAgIF90aGlzLmhhbmRsZXMgPSBwb29sLmhhbmRsZXM7CiAgICAgICAgX3RoaXMucmVzb2x2ZWQgPSBfdGhpcy5oYW5kbGVzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gVU5SRVNPTFZFRDsKICAgICAgICB9KTsKICAgICAgICBfdGhpcy5udW1iZXJzID0gcG9vbC5udW1iZXJzOwogICAgICB9CgogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgdmFyIF9wcm90bzMgPSBDb25zdGFudHMucHJvdG90eXBlOwoKICAgIF9wcm90bzMuZ2V0TnVtYmVyID0gZnVuY3Rpb24gZ2V0TnVtYmVyKHZhbHVlKSB7CiAgICAgIHJldHVybiB0aGlzLm51bWJlcnNbdmFsdWVdOwogICAgfTsKCiAgICBfcHJvdG8zLmdldFN0cmluZyA9IGZ1bmN0aW9uIGdldFN0cmluZyh2YWx1ZSkgewogICAgICByZXR1cm4gdGhpcy5zdHJpbmdzW3ZhbHVlXTsKICAgIH07CgogICAgX3Byb3RvMy5nZXRTdHJpbmdBcnJheSA9IGZ1bmN0aW9uIGdldFN0cmluZ0FycmF5KHZhbHVlKSB7CiAgICAgIHZhciBuYW1lcyA9IHRoaXMuZ2V0QXJyYXkodmFsdWUpOwoKICAgICAgdmFyIF9uYW1lcyA9IG5ldyBBcnJheShuYW1lcy5sZW5ndGgpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBuID0gbmFtZXNbaV07CiAgICAgICAgX25hbWVzW2ldID0gdGhpcy5nZXRTdHJpbmcobik7CiAgICAgIH0KCiAgICAgIHJldHVybiBfbmFtZXM7CiAgICB9OwoKICAgIF9wcm90bzMuZ2V0QXJyYXkgPSBmdW5jdGlvbiBnZXRBcnJheSh2YWx1ZSkgewogICAgICByZXR1cm4gdGhpcy5hcnJheXNbdmFsdWVdOwogICAgfTsKCiAgICBfcHJvdG8zLnJlc29sdmVIYW5kbGUgPSBmdW5jdGlvbiByZXNvbHZlSGFuZGxlKGluZGV4KSB7CiAgICAgIHZhciByZXNvbHZlZCA9IHRoaXMucmVzb2x2ZWRbaW5kZXhdOwoKICAgICAgaWYgKHJlc29sdmVkID09PSBVTlJFU09MVkVEKSB7CiAgICAgICAgdmFyIGhhbmRsZSA9IHRoaXMuaGFuZGxlc1tpbmRleF07CiAgICAgICAgcmVzb2x2ZWQgPSB0aGlzLnJlc29sdmVkW2luZGV4XSA9IHRoaXMucmVzb2x2ZXIucmVzb2x2ZShoYW5kbGUpOwogICAgICB9CgogICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgICB9OwoKICAgIF9wcm90bzMuZ2V0U2VyaWFsaXphYmxlID0gZnVuY3Rpb24gZ2V0U2VyaWFsaXphYmxlKHMpIHsKICAgICAgcmV0dXJuIEpTT04ucGFyc2UodGhpcy5zdHJpbmdzW3NdKTsKICAgIH07CgogICAgcmV0dXJuIENvbnN0YW50czsKICB9KFdyaXRlT25seUNvbnN0YW50cyk7CgogIF9leHBvcnRzLkNvbnN0YW50cyA9IENvbnN0YW50czsKCiAgdmFyIExhenlDb25zdGFudHMgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0NvbnN0YW50cykgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKExhenlDb25zdGFudHMsIF9Db25zdGFudHMpOwoKICAgIGZ1bmN0aW9uIExhenlDb25zdGFudHMoKSB7CiAgICAgIHZhciBfdGhpczI7CgogICAgICBfdGhpczIgPSBfQ29uc3RhbnRzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgICAgX3RoaXMyLm90aGVycyA9IFtdOwogICAgICBfdGhpczIuc2VyaWFsaXphYmxlcyA9IFtdOwogICAgICByZXR1cm4gX3RoaXMyOwogICAgfQoKICAgIHZhciBfcHJvdG80ID0gTGF6eUNvbnN0YW50cy5wcm90b3R5cGU7CgogICAgX3Byb3RvNC5zZXJpYWxpemFibGUgPSBmdW5jdGlvbiBzZXJpYWxpemFibGUodmFsdWUpIHsKICAgICAgdmFyIGluZGV4ID0gdGhpcy5zZXJpYWxpemFibGVzLmluZGV4T2YodmFsdWUpOwoKICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLnNlcmlhbGl6YWJsZXMucHVzaCh2YWx1ZSkgLSAxOwogICAgfTsKCiAgICBfcHJvdG80LmdldFNlcmlhbGl6YWJsZSA9IGZ1bmN0aW9uIGdldFNlcmlhbGl6YWJsZShzKSB7CiAgICAgIHJldHVybiB0aGlzLnNlcmlhbGl6YWJsZXNbc107CiAgICB9OwoKICAgIF9wcm90bzQuZ2V0T3RoZXIgPSBmdW5jdGlvbiBnZXRPdGhlcih2YWx1ZSkgewogICAgICByZXR1cm4gdGhpcy5vdGhlcnNbdmFsdWUgLSAxXTsKICAgIH07CgogICAgX3Byb3RvNC5vdGhlciA9IGZ1bmN0aW9uIG90aGVyKF9vdGhlcikgewogICAgICByZXR1cm4gdGhpcy5vdGhlcnMucHVzaChfb3RoZXIpOwogICAgfTsKCiAgICByZXR1cm4gTGF6eUNvbnN0YW50czsKICB9KENvbnN0YW50cyk7CgogIF9leHBvcnRzLkxhenlDb25zdGFudHMgPSBMYXp5Q29uc3RhbnRzOwoKICB2YXIgT3Bjb2RlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gT3Bjb2RlKGhlYXApIHsKICAgICAgdGhpcy5oZWFwID0gaGVhcDsKICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgfQoKICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoT3Bjb2RlLCBbewogICAgICBrZXk6ICJzaXplIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgdmFyIHJhd1R5cGUgPSB0aGlzLmhlYXAuZ2V0YnlhZGRyKHRoaXMub2Zmc2V0KTsKICAgICAgICByZXR1cm4gKChyYXdUeXBlICYgNzY4CiAgICAgICAgLyogT1BFUkFORF9MRU5fTUFTSyAqLwogICAgICAgICkgPj4gOAogICAgICAgIC8qIEFSR19TSElGVCAqLwogICAgICAgICkgKyAxOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImlzTWFjaGluZSIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHZhciByYXdUeXBlID0gdGhpcy5oZWFwLmdldGJ5YWRkcih0aGlzLm9mZnNldCk7CiAgICAgICAgcmV0dXJuIHJhd1R5cGUgJiAxMDI0CiAgICAgICAgLyogTUFDSElORV9NQVNLICovCiAgICAgICAgOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInR5cGUiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5oZWFwLmdldGJ5YWRkcih0aGlzLm9mZnNldCkgJiAyNTUKICAgICAgICAvKiBUWVBFX01BU0sgKi8KICAgICAgICA7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAib3AxIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaGVhcC5nZXRieWFkZHIodGhpcy5vZmZzZXQgKyAxKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJvcDIiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5oZWFwLmdldGJ5YWRkcih0aGlzLm9mZnNldCArIDIpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIm9wMyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLmhlYXAuZ2V0YnlhZGRyKHRoaXMub2Zmc2V0ICsgMyk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBPcGNvZGU7CiAgfSgpOwoKICBfZXhwb3J0cy5PcGNvZGUgPSBPcGNvZGU7CgogIGZ1bmN0aW9uIGVuY29kZVRhYmxlSW5mbyhzY29wZVNpemUsIHN0YXRlKSB7CiAgICByZXR1cm4gc3RhdGUgfCBzY29wZVNpemUgPDwgMjsKICB9CgogIGZ1bmN0aW9uIGNoYW5nZVN0YXRlKGluZm8sIG5ld1N0YXRlKSB7CiAgICByZXR1cm4gaW5mbyB8IG5ld1N0YXRlIDw8IDMwOwogIH0KCiAgdmFyIFBBR0VfU0laRSA9IDB4MTAwMDAwOwogIC8qKgogICAqIFRoZSBIZWFwIGlzIHJlc3BvbnNpYmxlIGZvciBkeW5hbWljYWxseSBhbGxvY2F0aW5nCiAgICogbWVtb3J5IGluIHdoaWNoIHdlIHJlYWQvd3JpdGUgdGhlIFZNJ3MgaW5zdHJ1Y3Rpb25zCiAgICogZnJvbS90by4gV2hlbiB3ZSBtYWxsb2Mgd2UgcGFzcyBvdXQgYSBWTUhhbmRsZSwgd2hpY2gKICAgKiBpcyB1c2VkIGFzIGFuIGluZGlyZWN0IHdheSBvZiBhY2Nlc3NpbmcgdGhlIG1lbW9yeSBkdXJpbmcKICAgKiBleGVjdXRpb24gb2YgdGhlIFZNLiBJbnRlcm5hbGx5IHdlIHRyYWNrIHRoZSBkaWZmZXJlbnQKICAgKiByZWdpb25zIG9mIHRoZSBtZW1vcnkgaW4gYW4gaW50IGFycmF5IGtub3duIGFzIHRoZSB0YWJsZS4KICAgKgogICAqIFRoZSB0YWJsZSAzMi1iaXQgYWxpZ25lZCBhbmQgaGFzIHRoZSBmb2xsb3dpbmcgbGF5b3V0OgogICAqCiAgICogfCAuLi4gfCBocCAodTMyKSB8ICAgICAgIGluZm8gKHUzMikgICB8IHNpemUgKHUzMikgfAogICAqIHwgLi4uIHwgIEhhbmRsZSAgfCBTY29wZSBTaXplIHwgU3RhdGUgfCBTaXplICAgICAgIHwKICAgKiB8IC4uLiB8IDMyYml0cyAgIHwgMzBiaXRzICAgICB8IDJiaXRzIHwgMzJiaXQgICAgICB8CiAgICoKICAgKiBXaXRoIHRoaXMgaW5mb3JtYXRpb24gd2UgZWZmZWN0aXZlbHkgaGF2ZSB0aGUgYWJpbGl0eSB0bwogICAqIGNvbnRyb2wgd2hlbiB3ZSB3YW50IHRvIGZyZWUgbWVtb3J5LiBUaGF0IGJlaW5nIHNhaWQgeW91CiAgICogY2FuIG5vdCBmcmVlIGR1cmluZyBleGVjdXRpb24gYXMgcmF3IGFkZHJlc3MgYXJlIG9ubHkKICAgKiB2YWxpZCBkdXJpbmcgdGhlIGV4ZWN1dGlvbi4gVGhpcyBtZWFucyB5b3UgY2Fubm90IGNsb3NlCiAgICogb3ZlciB0aGVtIGFzIHlvdSB3aWxsIGhhdmUgYSBiYWQgbWVtb3J5IGFjY2VzcyBleGNlcHRpb24uCiAgICovCgogIHZhciBIZWFwID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gSGVhcChzZXJpYWxpemVkSGVhcCkgewogICAgICB0aGlzLnBsYWNlaG9sZGVycyA9IFtdOwogICAgICB0aGlzLm9mZnNldCA9IDA7CiAgICAgIHRoaXMuaGFuZGxlID0gMDsKICAgICAgdGhpcy5jYXBhY2l0eSA9IFBBR0VfU0laRTsKCiAgICAgIGlmIChzZXJpYWxpemVkSGVhcCkgewogICAgICAgIHZhciBidWZmZXIgPSBzZXJpYWxpemVkSGVhcC5idWZmZXIsCiAgICAgICAgICAgIHRhYmxlID0gc2VyaWFsaXplZEhlYXAudGFibGUsCiAgICAgICAgICAgIGhhbmRsZSA9IHNlcmlhbGl6ZWRIZWFwLmhhbmRsZTsKICAgICAgICB0aGlzLmhlYXAgPSBuZXcgVWludDMyQXJyYXkoYnVmZmVyKTsKICAgICAgICB0aGlzLnRhYmxlID0gdGFibGU7CiAgICAgICAgdGhpcy5vZmZzZXQgPSB0aGlzLmhlYXAubGVuZ3RoOwogICAgICAgIHRoaXMuaGFuZGxlID0gaGFuZGxlOwogICAgICAgIHRoaXMuY2FwYWNpdHkgPSAwOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuaGVhcCA9IG5ldyBVaW50MzJBcnJheShQQUdFX1NJWkUpOwogICAgICAgIHRoaXMudGFibGUgPSBbXTsKICAgICAgfQogICAgfQoKICAgIHZhciBfcHJvdG81ID0gSGVhcC5wcm90b3R5cGU7CgogICAgX3Byb3RvNS5wdXNoID0gZnVuY3Rpb24gcHVzaChpdGVtKSB7CiAgICAgIHRoaXMuc2l6ZUNoZWNrKCk7CiAgICAgIHRoaXMuaGVhcFt0aGlzLm9mZnNldCsrXSA9IGl0ZW07CiAgICB9OwoKICAgIF9wcm90bzUuc2l6ZUNoZWNrID0gZnVuY3Rpb24gc2l6ZUNoZWNrKCkgewogICAgICBpZiAodGhpcy5jYXBhY2l0eSA9PT0gMCkgewogICAgICAgIHZhciBoZWFwID0gc2xpY2UodGhpcy5oZWFwLCAwLCB0aGlzLm9mZnNldCk7CiAgICAgICAgdGhpcy5oZWFwID0gbmV3IFVpbnQzMkFycmF5KGhlYXAubGVuZ3RoICsgUEFHRV9TSVpFKTsKICAgICAgICB0aGlzLmhlYXAuc2V0KGhlYXAsIDApOwogICAgICAgIHRoaXMuY2FwYWNpdHkgPSBQQUdFX1NJWkU7CiAgICAgIH0KCiAgICAgIHRoaXMuY2FwYWNpdHktLTsKICAgIH07CgogICAgX3Byb3RvNS5nZXRieWFkZHIgPSBmdW5jdGlvbiBnZXRieWFkZHIoYWRkcmVzcykgewogICAgICByZXR1cm4gdGhpcy5oZWFwW2FkZHJlc3NdOwogICAgfTsKCiAgICBfcHJvdG81LnNldGJ5YWRkciA9IGZ1bmN0aW9uIHNldGJ5YWRkcihhZGRyZXNzLCB2YWx1ZSkgewogICAgICB0aGlzLmhlYXBbYWRkcmVzc10gPSB2YWx1ZTsKICAgIH07CgogICAgX3Byb3RvNS5tYWxsb2MgPSBmdW5jdGlvbiBtYWxsb2MoKSB7CiAgICAgIC8vIHB1c2ggb2Zmc2V0LCBpbmZvLCBzaXplCiAgICAgIHRoaXMudGFibGUucHVzaCh0aGlzLm9mZnNldCwgMCwgMCk7CiAgICAgIHZhciBoYW5kbGUgPSB0aGlzLmhhbmRsZTsKICAgICAgdGhpcy5oYW5kbGUgKz0gMwogICAgICAvKiBFTlRSWV9TSVpFICovCiAgICAgIDsKICAgICAgcmV0dXJuIGhhbmRsZTsKICAgIH07CgogICAgX3Byb3RvNS5maW5pc2hNYWxsb2MgPSBmdW5jdGlvbiBmaW5pc2hNYWxsb2MoaGFuZGxlLCBzY29wZVNpemUpIHsKICAgICAgdGhpcy50YWJsZVtoYW5kbGUgKyAxCiAgICAgIC8qIElORk9fT0ZGU0VUICovCiAgICAgIF0gPSBlbmNvZGVUYWJsZUluZm8oc2NvcGVTaXplLCAwCiAgICAgIC8qIEFsbG9jYXRlZCAqLwogICAgICApOwogICAgfTsKCiAgICBfcHJvdG81LnNpemUgPSBmdW5jdGlvbiBzaXplKCkgewogICAgICByZXR1cm4gdGhpcy5vZmZzZXQ7CiAgICB9IC8vIEl0IGlzIGlsbGVnYWwgdG8gY2xvc2Ugb3ZlciB0aGlzIGFkZHJlc3MsIGFzIGNvbXBhY3Rpb24KICAgIC8vIG1heSBtb3ZlIGl0LiBIb3dldmVyLCBpdCBpcyBsZWdhbCB0byB1c2UgdGhpcyBhZGRyZXNzCiAgICAvLyBtdWx0aXBsZSB0aW1lcyBiZXR3ZWVuIGNvbXBhY3Rpb25zLgogICAgOwoKICAgIF9wcm90bzUuZ2V0YWRkciA9IGZ1bmN0aW9uIGdldGFkZHIoaGFuZGxlKSB7CiAgICAgIHJldHVybiB0aGlzLnRhYmxlW2hhbmRsZV07CiAgICB9OwoKICAgIF9wcm90bzUuZ2V0aGFuZGxlID0gZnVuY3Rpb24gZ2V0aGFuZGxlKGFkZHJlc3MpIHsKICAgICAgdGhpcy50YWJsZS5wdXNoKGFkZHJlc3MsIGVuY29kZVRhYmxlSW5mbygwLCAzCiAgICAgIC8qIFBvaW50ZXIgKi8KICAgICAgKSwgMCk7CiAgICAgIHZhciBoYW5kbGUgPSB0aGlzLmhhbmRsZTsKICAgICAgdGhpcy5oYW5kbGUgKz0gMwogICAgICAvKiBFTlRSWV9TSVpFICovCiAgICAgIDsKICAgICAgcmV0dXJuIGhhbmRsZTsKICAgIH07CgogICAgX3Byb3RvNS5zaXplb2YgPSBmdW5jdGlvbiBzaXplb2YoaGFuZGxlKSB7CiAgICAgIHJldHVybiAtMTsKICAgIH07CgogICAgX3Byb3RvNS5zY29wZXNpemVvZiA9IGZ1bmN0aW9uIHNjb3Blc2l6ZW9mKGhhbmRsZSkgewogICAgICB2YXIgaW5mbyA9IHRoaXMudGFibGVbaGFuZGxlICsgMQogICAgICAvKiBJTkZPX09GRlNFVCAqLwogICAgICBdOwogICAgICByZXR1cm4gaW5mbyA+PiAyOwogICAgfTsKCiAgICBfcHJvdG81LmZyZWUgPSBmdW5jdGlvbiBmcmVlKGhhbmRsZSkgewogICAgICB2YXIgaW5mbyA9IHRoaXMudGFibGVbaGFuZGxlICsgMQogICAgICAvKiBJTkZPX09GRlNFVCAqLwogICAgICBdOwogICAgICB0aGlzLnRhYmxlW2hhbmRsZSArIDEKICAgICAgLyogSU5GT19PRkZTRVQgKi8KICAgICAgXSA9IGNoYW5nZVN0YXRlKGluZm8sIDEKICAgICAgLyogRnJlZWQgKi8KICAgICAgKTsKICAgIH07CgogICAgX3Byb3RvNS5wdXNoUGxhY2Vob2xkZXIgPSBmdW5jdGlvbiBwdXNoUGxhY2Vob2xkZXIodmFsdWVGdW5jKSB7CiAgICAgIHRoaXMuc2l6ZUNoZWNrKCk7CiAgICAgIHZhciBhZGRyZXNzID0gdGhpcy5vZmZzZXQrKzsKICAgICAgdGhpcy5oZWFwW2FkZHJlc3NdID0gMjE0NzQ4MzY0NwogICAgICAvKiBNQVhfU0laRSAqLwogICAgICA7CiAgICAgIHRoaXMucGxhY2Vob2xkZXJzLnB1c2goW2FkZHJlc3MsIHZhbHVlRnVuY10pOwogICAgfTsKCiAgICBfcHJvdG81LnBhdGNoUGxhY2Vob2xkZXJzID0gZnVuY3Rpb24gcGF0Y2hQbGFjZWhvbGRlcnMoKSB7CiAgICAgIHZhciBwbGFjZWhvbGRlcnMgPSB0aGlzLnBsYWNlaG9sZGVyczsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGxhY2Vob2xkZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIF9wbGFjZWhvbGRlcnMkaSA9IHBsYWNlaG9sZGVyc1tpXSwKICAgICAgICAgICAgYWRkcmVzcyA9IF9wbGFjZWhvbGRlcnMkaVswXSwKICAgICAgICAgICAgZ2V0VmFsdWUgPSBfcGxhY2Vob2xkZXJzJGlbMV07CiAgICAgICAgdGhpcy5zZXRieWFkZHIoYWRkcmVzcywgZ2V0VmFsdWUoKSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNS5jYXB0dXJlID0gZnVuY3Rpb24gY2FwdHVyZShvZmZzZXQpIHsKICAgICAgaWYgKG9mZnNldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgb2Zmc2V0ID0gdGhpcy5vZmZzZXQ7CiAgICAgIH0KCiAgICAgIHRoaXMucGF0Y2hQbGFjZWhvbGRlcnMoKTsgLy8gT25seSBjYWxsZWQgaW4gZWFnZXIgbW9kZQoKICAgICAgdmFyIGJ1ZmZlciA9IHNsaWNlKHRoaXMuaGVhcCwgMCwgb2Zmc2V0KS5idWZmZXI7CiAgICAgIHJldHVybiB7CiAgICAgICAgaGFuZGxlOiB0aGlzLmhhbmRsZSwKICAgICAgICB0YWJsZTogdGhpcy50YWJsZSwKICAgICAgICBidWZmZXI6IGJ1ZmZlcgogICAgICB9OwogICAgfTsKCiAgICByZXR1cm4gSGVhcDsKICB9KCk7CgogIF9leHBvcnRzLkhlYXAgPSBIZWFwOwoKICB2YXIgV3JpdGVPbmx5UHJvZ3JhbSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFdyaXRlT25seVByb2dyYW0oY29uc3RhbnRzLCBoZWFwKSB7CiAgICAgIGlmIChjb25zdGFudHMgPT09IHZvaWQgMCkgewogICAgICAgIGNvbnN0YW50cyA9IG5ldyBXcml0ZU9ubHlDb25zdGFudHMoKTsKICAgICAgfQoKICAgICAgaWYgKGhlYXAgPT09IHZvaWQgMCkgewogICAgICAgIGhlYXAgPSBuZXcgSGVhcCgpOwogICAgICB9CgogICAgICB0aGlzLmNvbnN0YW50cyA9IGNvbnN0YW50czsKICAgICAgdGhpcy5oZWFwID0gaGVhcDsKICAgICAgdGhpcy5fb3Bjb2RlID0gbmV3IE9wY29kZSh0aGlzLmhlYXApOwogICAgfQoKICAgIHZhciBfcHJvdG82ID0gV3JpdGVPbmx5UHJvZ3JhbS5wcm90b3R5cGU7CgogICAgX3Byb3RvNi5vcGNvZGUgPSBmdW5jdGlvbiBvcGNvZGUob2Zmc2V0KSB7CiAgICAgIHRoaXMuX29wY29kZS5vZmZzZXQgPSBvZmZzZXQ7CiAgICAgIHJldHVybiB0aGlzLl9vcGNvZGU7CiAgICB9OwoKICAgIHJldHVybiBXcml0ZU9ubHlQcm9ncmFtOwogIH0oKTsKCiAgX2V4cG9ydHMuV3JpdGVPbmx5UHJvZ3JhbSA9IFdyaXRlT25seVByb2dyYW07CgogIHZhciBSdW50aW1lUHJvZ3JhbSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFJ1bnRpbWVQcm9ncmFtKGNvbnN0YW50cywgaGVhcCkgewogICAgICB0aGlzLmNvbnN0YW50cyA9IGNvbnN0YW50czsKICAgICAgdGhpcy5oZWFwID0gaGVhcDsKICAgICAgdGhpcy5fb3Bjb2RlID0gbmV3IE9wY29kZSh0aGlzLmhlYXApOwogICAgfQoKICAgIFJ1bnRpbWVQcm9ncmFtLmh5ZHJhdGUgPSBmdW5jdGlvbiBoeWRyYXRlKHJhd0hlYXAsIHBvb2wsIHJlc29sdmVyKSB7CiAgICAgIHZhciBoZWFwID0gbmV3IEhlYXAocmF3SGVhcCk7CiAgICAgIHZhciBjb25zdGFudHMgPSBuZXcgUnVudGltZUNvbnN0YW50cyhyZXNvbHZlciwgcG9vbCk7CiAgICAgIHJldHVybiBuZXcgUnVudGltZVByb2dyYW0oY29uc3RhbnRzLCBoZWFwKTsKICAgIH07CgogICAgdmFyIF9wcm90bzcgPSBSdW50aW1lUHJvZ3JhbS5wcm90b3R5cGU7CgogICAgX3Byb3RvNy5vcGNvZGUgPSBmdW5jdGlvbiBvcGNvZGUob2Zmc2V0KSB7CiAgICAgIHRoaXMuX29wY29kZS5vZmZzZXQgPSBvZmZzZXQ7CiAgICAgIHJldHVybiB0aGlzLl9vcGNvZGU7CiAgICB9OwoKICAgIHJldHVybiBSdW50aW1lUHJvZ3JhbTsKICB9KCk7CgogIF9leHBvcnRzLlJ1bnRpbWVQcm9ncmFtID0gUnVudGltZVByb2dyYW07CgogIHZhciBQcm9ncmFtID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9Xcml0ZU9ubHlQcm9ncmFtKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoUHJvZ3JhbSwgX1dyaXRlT25seVByb2dyYW0pOwoKICAgIGZ1bmN0aW9uIFByb2dyYW0oKSB7CiAgICAgIHJldHVybiBfV3JpdGVPbmx5UHJvZ3JhbS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICB9CgogICAgcmV0dXJuIFByb2dyYW07CiAgfShXcml0ZU9ubHlQcm9ncmFtKTsKCiAgX2V4cG9ydHMuUHJvZ3JhbSA9IFByb2dyYW07CgogIGZ1bmN0aW9uIHNsaWNlKGFyciwgc3RhcnQsIGVuZCkgewogICAgaWYgKGFyci5zbGljZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiBhcnIuc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICB9CgogICAgdmFyIHJldCA9IG5ldyBVaW50MzJBcnJheShlbmQpOwoKICAgIGZvciAoOyBzdGFydCA8IGVuZDsgc3RhcnQrKykgewogICAgICByZXRbc3RhcnRdID0gYXJyW3N0YXJ0XTsKICAgIH0KCiAgICByZXR1cm4gcmV0OwogIH0KfSk7CmRlZmluZSgiQGdsaW1tZXIvcmVmZXJlbmNlIiwgWyJleHBvcnRzIiwgImVtYmVyLWJhYmVsIiwgIkBnbGltbWVyL3V0aWwiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZW1iZXJCYWJlbCwgX3V0aWwpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLm1hcCA9IG1hcDsKICBfZXhwb3J0cy5pc01vZGlmaWVkID0gaXNNb2RpZmllZDsKICBfZXhwb3J0cy5idW1wID0gYnVtcDsKICBfZXhwb3J0cy52YWx1ZSA9IF92YWx1ZTI7CiAgX2V4cG9ydHMudmFsaWRhdGUgPSB2YWxpZGF0ZTsKICBfZXhwb3J0cy5jcmVhdGVUYWcgPSBjcmVhdGVUYWc7CiAgX2V4cG9ydHMuY3JlYXRlVXBkYXRhYmxlVGFnID0gY3JlYXRlVXBkYXRhYmxlVGFnOwogIF9leHBvcnRzLmlzQ29uc3QgPSBpc0NvbnN0OwogIF9leHBvcnRzLmlzQ29uc3RUYWcgPSBpc0NvbnN0VGFnOwogIF9leHBvcnRzLmNvbWJpbmVUYWdnZWQgPSBjb21iaW5lVGFnZ2VkOwogIF9leHBvcnRzLmNvbWJpbmVTbGljZSA9IGNvbWJpbmVTbGljZTsKICBfZXhwb3J0cy5jb21iaW5lID0gY29tYmluZTsKICBfZXhwb3J0cy5DVVJSRU5UX1RBRyA9IF9leHBvcnRzLlZPTEFUSUxFX1RBRyA9IF9leHBvcnRzLkNPTlNUQU5UX1RBRyA9IF9leHBvcnRzLnVwZGF0ZSA9IF9leHBvcnRzLmRpcnR5ID0gX2V4cG9ydHMuTW9ub21vcnBoaWNUYWdJbXBsID0gX2V4cG9ydHMuQUxMT1dfQ1lDTEVTID0gX2V4cG9ydHMuQ09NUFVURSA9IF9leHBvcnRzLlZPTEFUSUxFID0gX2V4cG9ydHMuSU5JVElBTCA9IF9leHBvcnRzLkNPTlNUQU5UID0gX2V4cG9ydHMuSXRlcmF0b3JTeW5jaHJvbml6ZXIgPSBfZXhwb3J0cy5SZWZlcmVuY2VJdGVyYXRvciA9IF9leHBvcnRzLkl0ZXJhdGlvbkFydGlmYWN0cyA9IF9leHBvcnRzLkxpc3RJdGVtID0gX2V4cG9ydHMuQ29uc3RSZWZlcmVuY2UgPSBfZXhwb3J0cy5SZWZlcmVuY2VDYWNoZSA9IF9leHBvcnRzLkNhY2hlZFJlZmVyZW5jZSA9IHZvaWQgMDsKICB2YXIgc3ltYm9sID0gdHlwZW9mIFN5bWJvbCAhPT0gJ3VuZGVmaW5lZCcgPyBTeW1ib2wgOiBmdW5jdGlvbiAoa2V5KSB7CiAgICByZXR1cm4gIl9fIiArIGtleSArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIERhdGUubm93KCkpICsgIl9fIjsKICB9OwogIHZhciBDT05TVEFOVCA9IDA7CiAgX2V4cG9ydHMuQ09OU1RBTlQgPSBDT05TVEFOVDsKICB2YXIgSU5JVElBTCA9IDE7CiAgX2V4cG9ydHMuSU5JVElBTCA9IElOSVRJQUw7CiAgdmFyIFZPTEFUSUxFID0gOTAwNzE5OTI1NDc0MDk5MTsgLy8gTUFYX0lOVAoKICBfZXhwb3J0cy5WT0xBVElMRSA9IFZPTEFUSUxFOwogIHZhciAkUkVWSVNJT04gPSBJTklUSUFMOwoKICBmdW5jdGlvbiBidW1wKCkgewogICAgJFJFVklTSU9OKys7CiAgfSAvLy8vLy8vLy8vCgoKICB2YXIgQ09NUFVURSA9IHN5bWJvbCgnVEFHX0NPTVBVVEUnKTsgLy8vLy8vLy8vLwoKICAvKioKICAgKiBgdmFsdWVgIHJlY2VpdmVzIGEgdGFnIGFuZCByZXR1cm5zIGFuIG9wYXF1ZSBSZXZpc2lvbiBiYXNlZCBvbiB0aGF0IHRhZy4gVGhpcwogICAqIHNuYXBzaG90IGNhbiB0aGVuIGxhdGVyIGJlIHBhc3NlZCB0byBgdmFsaWRhdGVgIHdpdGggdGhlIHNhbWUgdGFnIHRvCiAgICogZGV0ZXJtaW5lIGlmIHRoZSB0YWcgaGFzIGNoYW5nZWQgYXQgYWxsIHNpbmNlIHRoZSB0aW1lIHRoYXQgYHZhbHVlYCB3YXMKICAgKiBjYWxsZWQuCiAgICoKICAgKiBUaGUgY3VycmVudCBpbXBsZW1lbnRhdGlvbiByZXR1cm5zIHRoZSBnbG9iYWwgcmV2aXNpb24gY291bnQgZGlyZWN0bHkgZm9yCiAgICogcGVyZm9ybWFuY2UgcmVhc29ucy4gVGhpcyBpcyBhbiBpbXBsZW1lbnRhdGlvbiBkZXRhaWwsIGFuZCBzaG91bGQgbm90IGJlCiAgICogcmVsaWVkIG9uIGRpcmVjdGx5IGJ5IHVzZXJzIG9mIHRoZXNlIEFQSXMuIEluc3RlYWQsIFJldmlzaW9ucyBzaG91bGQgYmUKICAgKiB0cmVhdGVkIGFzIGlmIHRoZXkgYXJlIG9wYXF1ZS91bmtub3duLCBhbmQgc2hvdWxkIG9ubHkgYmUgaW50ZXJhY3RlZCB3aXRoIHZpYQogICAqIHRoZSBgdmFsdWVgL2B2YWxpZGF0ZWAgQVBJLgogICAqCiAgICogQHBhcmFtIHRhZwogICAqLwoKICBfZXhwb3J0cy5DT01QVVRFID0gQ09NUFVURTsKCiAgZnVuY3Rpb24gX3ZhbHVlMihfdGFnKSB7CiAgICByZXR1cm4gJFJFVklTSU9OOwogIH0KICAvKioKICAgKiBgdmFsaWRhdGVgIHJlY2VpdmVzIGEgdGFnIGFuZCBhIHNuYXBzaG90IGZyb20gYSBwcmV2aW91cyBjYWxsIHRvIGB2YWx1ZWAgd2l0aAogICAqIHRoZSBzYW1lIHRhZywgYW5kIGRldGVybWluZXMgaWYgdGhlIHRhZyBpcyBzdGlsbCB2YWxpZCBjb21wYXJlZCB0byB0aGUKICAgKiBzbmFwc2hvdC4gSWYgdGhlIHRhZydzIHN0YXRlIGhhcyBjaGFuZ2VkIGF0IGFsbCBzaW5jZSB0aGVuLCBgdmFsaWRhdGVgIHdpbGwKICAgKiByZXR1cm4gZmFsc2UsIG90aGVyd2lzZSBpdCB3aWxsIHJldHVybiB0cnVlLiBUaGlzIGlzIHVzZWQgdG8gZGV0ZXJtaW5lIGlmIGEKICAgKiBjYWxjdWxhdGlvbiByZWxhdGVkIHRvIHRoZSB0YWdzIHNob3VsZCBiZSByZXJ1bi4KICAgKgogICAqIEBwYXJhbSB0YWcKICAgKiBAcGFyYW0gc25hcHNob3QKICAgKi8KCgogIGZ1bmN0aW9uIHZhbGlkYXRlKHRhZywgc25hcHNob3QpIHsKICAgIHJldHVybiBzbmFwc2hvdCA+PSB0YWdbQ09NUFVURV0oKTsKICB9CgogIHZhciBUWVBFID0gc3ltYm9sKCdUQUdfVFlQRScpOwogIHZhciBBTExPV19DWUNMRVM7CiAgX2V4cG9ydHMuQUxMT1dfQ1lDTEVTID0gQUxMT1dfQ1lDTEVTOwoKICB2YXIgTW9ub21vcnBoaWNUYWdJbXBsID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gTW9ub21vcnBoaWNUYWdJbXBsKHR5cGUpIHsKICAgICAgdGhpcy5yZXZpc2lvbiA9IElOSVRJQUw7CiAgICAgIHRoaXMubGFzdENoZWNrZWQgPSBJTklUSUFMOwogICAgICB0aGlzLmxhc3RWYWx1ZSA9IElOSVRJQUw7CiAgICAgIHRoaXMuaXNVcGRhdGluZyA9IGZhbHNlOwogICAgICB0aGlzLnN1YnRhZyA9IG51bGw7CiAgICAgIHRoaXMuc3VidGFncyA9IG51bGw7CiAgICAgIHRoaXNbVFlQRV0gPSB0eXBlOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBNb25vbW9ycGhpY1RhZ0ltcGwucHJvdG90eXBlOwoKICAgIF9wcm90b1tDT01QVVRFXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGxhc3RDaGVja2VkID0gdGhpcy5sYXN0Q2hlY2tlZDsKCiAgICAgIGlmIChsYXN0Q2hlY2tlZCAhPT0gJFJFVklTSU9OKSB7CiAgICAgICAgdGhpcy5pc1VwZGF0aW5nID0gdHJ1ZTsKICAgICAgICB0aGlzLmxhc3RDaGVja2VkID0gJFJFVklTSU9OOwoKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIHN1YnRhZ3MgPSB0aGlzLnN1YnRhZ3MsCiAgICAgICAgICAgICAgc3VidGFnID0gdGhpcy5zdWJ0YWcsCiAgICAgICAgICAgICAgcmV2aXNpb24gPSB0aGlzLnJldmlzaW9uOwoKICAgICAgICAgIGlmIChzdWJ0YWcgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV2aXNpb24gPSBNYXRoLm1heChyZXZpc2lvbiwgc3VidGFnW0NPTVBVVEVdKCkpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChzdWJ0YWdzICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3VidGFncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBfdmFsdWUgPSBzdWJ0YWdzW2ldW0NPTVBVVEVdKCk7CgogICAgICAgICAgICAgIHJldmlzaW9uID0gTWF0aC5tYXgoX3ZhbHVlLCByZXZpc2lvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLmxhc3RWYWx1ZSA9IHJldmlzaW9uOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICB0aGlzLmlzVXBkYXRpbmcgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmlzVXBkYXRpbmcgPT09IHRydWUpIHsKICAgICAgICB0aGlzLmxhc3RDaGVja2VkID0gKyskUkVWSVNJT047CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLmxhc3RWYWx1ZTsKICAgIH07CgogICAgTW9ub21vcnBoaWNUYWdJbXBsLnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZShfdGFnLCBzdWJ0YWcpIHsKICAgICAgLy8gVE9ETzogVFMgMy43IHNob3VsZCBhbGxvdyB1cyB0byBkbyB0aGlzIHZpYSBhc3NlcnRpb24KICAgICAgdmFyIHRhZyA9IF90YWc7CgogICAgICBpZiAoc3VidGFnID09PSBDT05TVEFOVF9UQUcpIHsKICAgICAgICB0YWcuc3VidGFnID0gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICB0YWcuc3VidGFnID0gc3VidGFnOyAvLyBzdWJ0YWcgY291bGQgYmUgYW5vdGhlciB0eXBlIG9mIHRhZywgZS5nLiBDVVJSRU5UX1RBRyBvciBWT0xBVElMRV9UQUcuCiAgICAgICAgLy8gSWYgc28sIGxhc3RDaGVja2VkL2xhc3RWYWx1ZSB3aWxsIGJlIHVuZGVmaW5lZCwgcmVzdWx0IGluIHRoZXNlIGJlaW5nCiAgICAgICAgLy8gTmFOLiBUaGlzIGlzIGZpbmUsIGl0IHdpbGwgZm9yY2UgdGhlIHN5c3RlbSB0byByZWNvbXB1dGUuCgogICAgICAgIHRhZy5sYXN0Q2hlY2tlZCA9IE1hdGgubWluKHRhZy5sYXN0Q2hlY2tlZCwgc3VidGFnLmxhc3RDaGVja2VkKTsKICAgICAgICB0YWcubGFzdFZhbHVlID0gTWF0aC5tYXgodGFnLmxhc3RWYWx1ZSwgc3VidGFnLmxhc3RWYWx1ZSk7CiAgICAgIH0KICAgIH07CgogICAgTW9ub21vcnBoaWNUYWdJbXBsLmRpcnR5ID0gZnVuY3Rpb24gZGlydHkodGFnKSB7CiAgICAgIHRhZy5yZXZpc2lvbiA9ICsrJFJFVklTSU9OOwogICAgfTsKCiAgICByZXR1cm4gTW9ub21vcnBoaWNUYWdJbXBsOwogIH0oKTsKCiAgX2V4cG9ydHMuTW9ub21vcnBoaWNUYWdJbXBsID0gTW9ub21vcnBoaWNUYWdJbXBsOwogIHZhciBkaXJ0eSA9IE1vbm9tb3JwaGljVGFnSW1wbC5kaXJ0eTsKICBfZXhwb3J0cy5kaXJ0eSA9IGRpcnR5OwogIHZhciB1cGRhdGUgPSBNb25vbW9ycGhpY1RhZ0ltcGwudXBkYXRlOyAvLy8vLy8vLy8vCgogIF9leHBvcnRzLnVwZGF0ZSA9IHVwZGF0ZTsKCiAgZnVuY3Rpb24gY3JlYXRlVGFnKCkgewogICAgcmV0dXJuIG5ldyBNb25vbW9ycGhpY1RhZ0ltcGwoMAogICAgLyogRGlydHlhYmxlICovCiAgICApOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlVXBkYXRhYmxlVGFnKCkgewogICAgcmV0dXJuIG5ldyBNb25vbW9ycGhpY1RhZ0ltcGwoMQogICAgLyogVXBkYXRhYmxlICovCiAgICApOwogIH0gLy8vLy8vLy8vLwoKCiAgdmFyIENPTlNUQU5UX1RBRyA9IG5ldyBNb25vbW9ycGhpY1RhZ0ltcGwoMwogIC8qIENvbnN0YW50ICovCiAgKTsKICBfZXhwb3J0cy5DT05TVEFOVF9UQUcgPSBDT05TVEFOVF9UQUc7CgogIGZ1bmN0aW9uIGlzQ29uc3QoX3JlZikgewogICAgdmFyIHRhZyA9IF9yZWYudGFnOwogICAgcmV0dXJuIHRhZyA9PT0gQ09OU1RBTlRfVEFHOwogIH0KCiAgZnVuY3Rpb24gaXNDb25zdFRhZyh0YWcpIHsKICAgIHJldHVybiB0YWcgPT09IENPTlNUQU5UX1RBRzsKICB9IC8vLy8vLy8vLy8KCgogIHZhciBWb2xhdGlsZVRhZyA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFZvbGF0aWxlVGFnKCkge30KCiAgICB2YXIgX3Byb3RvMiA9IFZvbGF0aWxlVGFnLnByb3RvdHlwZTsKCiAgICBfcHJvdG8yW0NPTVBVVEVdID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gVk9MQVRJTEU7CiAgICB9OwoKICAgIHJldHVybiBWb2xhdGlsZVRhZzsKICB9KCk7CgogIHZhciBWT0xBVElMRV9UQUcgPSBuZXcgVm9sYXRpbGVUYWcoKTsgLy8vLy8vLy8vLwoKICBfZXhwb3J0cy5WT0xBVElMRV9UQUcgPSBWT0xBVElMRV9UQUc7CgogIHZhciBDdXJyZW50VGFnID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQ3VycmVudFRhZygpIHt9CgogICAgdmFyIF9wcm90bzMgPSBDdXJyZW50VGFnLnByb3RvdHlwZTsKCiAgICBfcHJvdG8zW0NPTVBVVEVdID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gJFJFVklTSU9OOwogICAgfTsKCiAgICByZXR1cm4gQ3VycmVudFRhZzsKICB9KCk7CgogIHZhciBDVVJSRU5UX1RBRyA9IG5ldyBDdXJyZW50VGFnKCk7IC8vLy8vLy8vLy8KCiAgX2V4cG9ydHMuQ1VSUkVOVF9UQUcgPSBDVVJSRU5UX1RBRzsKCiAgZnVuY3Rpb24gY29tYmluZVRhZ2dlZCh0YWdnZWQpIHsKICAgIHZhciBvcHRpbWl6ZWQgPSBbXTsKCiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRhZ2dlZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgdmFyIHRhZyA9IHRhZ2dlZFtpXS50YWc7CiAgICAgIGlmICh0YWcgPT09IENPTlNUQU5UX1RBRykgY29udGludWU7CiAgICAgIG9wdGltaXplZC5wdXNoKHRhZyk7CiAgICB9CgogICAgcmV0dXJuIF9jb21iaW5lKG9wdGltaXplZCk7CiAgfQoKICBmdW5jdGlvbiBjb21iaW5lU2xpY2Uoc2xpY2UpIHsKICAgIHZhciBvcHRpbWl6ZWQgPSBbXTsKICAgIHZhciBub2RlID0gc2xpY2UuaGVhZCgpOwoKICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgIHZhciB0YWcgPSBub2RlLnRhZzsKICAgICAgaWYgKHRhZyAhPT0gQ09OU1RBTlRfVEFHKSBvcHRpbWl6ZWQucHVzaCh0YWcpOwogICAgICBub2RlID0gc2xpY2UubmV4dE5vZGUobm9kZSk7CiAgICB9CgogICAgcmV0dXJuIF9jb21iaW5lKG9wdGltaXplZCk7CiAgfQoKICBmdW5jdGlvbiBjb21iaW5lKHRhZ3MpIHsKICAgIHZhciBvcHRpbWl6ZWQgPSBbXTsKCiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRhZ3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHZhciB0YWcgPSB0YWdzW2ldOwogICAgICBpZiAodGFnID09PSBDT05TVEFOVF9UQUcpIGNvbnRpbnVlOwogICAgICBvcHRpbWl6ZWQucHVzaCh0YWcpOwogICAgfQoKICAgIHJldHVybiBfY29tYmluZShvcHRpbWl6ZWQpOwogIH0KCiAgZnVuY3Rpb24gX2NvbWJpbmUodGFncykgewogICAgc3dpdGNoICh0YWdzLmxlbmd0aCkgewogICAgICBjYXNlIDA6CiAgICAgICAgcmV0dXJuIENPTlNUQU5UX1RBRzsKCiAgICAgIGNhc2UgMToKICAgICAgICByZXR1cm4gdGFnc1swXTsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdmFyIHRhZyA9IG5ldyBNb25vbW9ycGhpY1RhZ0ltcGwoMgogICAgICAgIC8qIENvbWJpbmF0b3IgKi8KICAgICAgICApOwogICAgICAgIHRhZy5zdWJ0YWdzID0gdGFnczsKICAgICAgICByZXR1cm4gdGFnOwogICAgfQogIH0KCiAgdmFyIENhY2hlZFJlZmVyZW5jZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIENhY2hlZFJlZmVyZW5jZSgpIHsKICAgICAgdGhpcy5sYXN0UmV2aXNpb24gPSBudWxsOwogICAgICB0aGlzLmxhc3RWYWx1ZSA9IG51bGw7CiAgICB9CgogICAgdmFyIF9wcm90bzQgPSBDYWNoZWRSZWZlcmVuY2UucHJvdG90eXBlOwoKICAgIF9wcm90bzQudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdmFyIHRhZyA9IHRoaXMudGFnLAogICAgICAgICAgbGFzdFJldmlzaW9uID0gdGhpcy5sYXN0UmV2aXNpb24sCiAgICAgICAgICBsYXN0VmFsdWUgPSB0aGlzLmxhc3RWYWx1ZTsKCiAgICAgIGlmIChsYXN0UmV2aXNpb24gPT09IG51bGwgfHwgIXZhbGlkYXRlKHRhZywgbGFzdFJldmlzaW9uKSkgewogICAgICAgIGxhc3RWYWx1ZSA9IHRoaXMubGFzdFZhbHVlID0gdGhpcy5jb21wdXRlKCk7CiAgICAgICAgdGhpcy5sYXN0UmV2aXNpb24gPSBfdmFsdWUyKHRhZyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBsYXN0VmFsdWU7CiAgICB9OwoKICAgIF9wcm90bzQuaW52YWxpZGF0ZSA9IGZ1bmN0aW9uIGludmFsaWRhdGUoKSB7CiAgICAgIHRoaXMubGFzdFJldmlzaW9uID0gbnVsbDsKICAgIH07CgogICAgcmV0dXJuIENhY2hlZFJlZmVyZW5jZTsKICB9KCk7CgogIF9leHBvcnRzLkNhY2hlZFJlZmVyZW5jZSA9IENhY2hlZFJlZmVyZW5jZTsKCiAgdmFyIE1hcHBlclJlZmVyZW5jZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfQ2FjaGVkUmVmZXJlbmNlKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoTWFwcGVyUmVmZXJlbmNlLCBfQ2FjaGVkUmVmZXJlbmNlKTsKCiAgICBmdW5jdGlvbiBNYXBwZXJSZWZlcmVuY2UocmVmZXJlbmNlLCBtYXBwZXIpIHsKICAgICAgdmFyIF90aGlzOwoKICAgICAgX3RoaXMgPSBfQ2FjaGVkUmVmZXJlbmNlLmNhbGwodGhpcykgfHwgdGhpczsKICAgICAgX3RoaXMudGFnID0gcmVmZXJlbmNlLnRhZzsKICAgICAgX3RoaXMucmVmZXJlbmNlID0gcmVmZXJlbmNlOwogICAgICBfdGhpcy5tYXBwZXIgPSBtYXBwZXI7CiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICB2YXIgX3Byb3RvNSA9IE1hcHBlclJlZmVyZW5jZS5wcm90b3R5cGU7CgogICAgX3Byb3RvNS5jb21wdXRlID0gZnVuY3Rpb24gY29tcHV0ZSgpIHsKICAgICAgdmFyIHJlZmVyZW5jZSA9IHRoaXMucmVmZXJlbmNlLAogICAgICAgICAgbWFwcGVyID0gdGhpcy5tYXBwZXI7CiAgICAgIHJldHVybiBtYXBwZXIocmVmZXJlbmNlLnZhbHVlKCkpOwogICAgfTsKCiAgICByZXR1cm4gTWFwcGVyUmVmZXJlbmNlOwogIH0oQ2FjaGVkUmVmZXJlbmNlKTsKCiAgZnVuY3Rpb24gbWFwKHJlZmVyZW5jZSwgbWFwcGVyKSB7CiAgICByZXR1cm4gbmV3IE1hcHBlclJlZmVyZW5jZShyZWZlcmVuY2UsIG1hcHBlcik7CiAgfSAvLy8vLy8vLy8vCgoKICB2YXIgUmVmZXJlbmNlQ2FjaGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBSZWZlcmVuY2VDYWNoZShyZWZlcmVuY2UpIHsKICAgICAgdGhpcy5sYXN0VmFsdWUgPSBudWxsOwogICAgICB0aGlzLmxhc3RSZXZpc2lvbiA9IG51bGw7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSBmYWxzZTsKICAgICAgdGhpcy50YWcgPSByZWZlcmVuY2UudGFnOwogICAgICB0aGlzLnJlZmVyZW5jZSA9IHJlZmVyZW5jZTsKICAgIH0KCiAgICB2YXIgX3Byb3RvNiA9IFJlZmVyZW5jZUNhY2hlLnByb3RvdHlwZTsKCiAgICBfcHJvdG82LnBlZWsgPSBmdW5jdGlvbiBwZWVrKCkgewogICAgICBpZiAoIXRoaXMuaW5pdGlhbGl6ZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5pbml0aWFsaXplKCk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLmxhc3RWYWx1ZTsKICAgIH07CgogICAgX3Byb3RvNi5yZXZhbGlkYXRlID0gZnVuY3Rpb24gcmV2YWxpZGF0ZSgpIHsKICAgICAgaWYgKCF0aGlzLmluaXRpYWxpemVkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5pdGlhbGl6ZSgpOwogICAgICB9CgogICAgICB2YXIgcmVmZXJlbmNlID0gdGhpcy5yZWZlcmVuY2UsCiAgICAgICAgICBsYXN0UmV2aXNpb24gPSB0aGlzLmxhc3RSZXZpc2lvbjsKICAgICAgdmFyIHRhZyA9IHJlZmVyZW5jZS50YWc7CiAgICAgIGlmICh2YWxpZGF0ZSh0YWcsIGxhc3RSZXZpc2lvbikpIHJldHVybiBOT1RfTU9ESUZJRUQ7CiAgICAgIHRoaXMubGFzdFJldmlzaW9uID0gX3ZhbHVlMih0YWcpOwogICAgICB2YXIgbGFzdFZhbHVlID0gdGhpcy5sYXN0VmFsdWU7CiAgICAgIHZhciBjdXJyZW50VmFsdWUgPSByZWZlcmVuY2UudmFsdWUoKTsKICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA9PT0gbGFzdFZhbHVlKSByZXR1cm4gTk9UX01PRElGSUVEOwogICAgICB0aGlzLmxhc3RWYWx1ZSA9IGN1cnJlbnRWYWx1ZTsKICAgICAgcmV0dXJuIGN1cnJlbnRWYWx1ZTsKICAgIH07CgogICAgX3Byb3RvNi5pbml0aWFsaXplID0gZnVuY3Rpb24gaW5pdGlhbGl6ZSgpIHsKICAgICAgdmFyIHJlZmVyZW5jZSA9IHRoaXMucmVmZXJlbmNlOwogICAgICB2YXIgY3VycmVudFZhbHVlID0gdGhpcy5sYXN0VmFsdWUgPSByZWZlcmVuY2UudmFsdWUoKTsKICAgICAgdGhpcy5sYXN0UmV2aXNpb24gPSBfdmFsdWUyKHJlZmVyZW5jZS50YWcpOwogICAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgcmV0dXJuIGN1cnJlbnRWYWx1ZTsKICAgIH07CgogICAgcmV0dXJuIFJlZmVyZW5jZUNhY2hlOwogIH0oKTsKCiAgX2V4cG9ydHMuUmVmZXJlbmNlQ2FjaGUgPSBSZWZlcmVuY2VDYWNoZTsKICB2YXIgTk9UX01PRElGSUVEID0gJ2FkYjNiNzhlLTNkMjItNGU0Yi04NzdhLTYzMTdjMmM1YzE0NSc7CgogIGZ1bmN0aW9uIGlzTW9kaWZpZWQodmFsdWUkJDEpIHsKICAgIHJldHVybiB2YWx1ZSQkMSAhPT0gTk9UX01PRElGSUVEOwogIH0KCiAgdmFyIENvbnN0UmVmZXJlbmNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQ29uc3RSZWZlcmVuY2UoaW5uZXIpIHsKICAgICAgdGhpcy5pbm5lciA9IGlubmVyOwogICAgICB0aGlzLnRhZyA9IENPTlNUQU5UX1RBRzsKICAgIH0KCiAgICB2YXIgX3Byb3RvNyA9IENvbnN0UmVmZXJlbmNlLnByb3RvdHlwZTsKCiAgICBfcHJvdG83LnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHJldHVybiB0aGlzLmlubmVyOwogICAgfTsKCiAgICByZXR1cm4gQ29uc3RSZWZlcmVuY2U7CiAgfSgpOwoKICBfZXhwb3J0cy5Db25zdFJlZmVyZW5jZSA9IENvbnN0UmVmZXJlbmNlOwoKICB2YXIgTGlzdEl0ZW0gPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0xpc3ROb2RlKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoTGlzdEl0ZW0sIF9MaXN0Tm9kZSk7CgogICAgZnVuY3Rpb24gTGlzdEl0ZW0oaXRlcmFibGUsIHJlc3VsdCkgewogICAgICB2YXIgX3RoaXMyOwoKICAgICAgX3RoaXMyID0gX0xpc3ROb2RlLmNhbGwodGhpcywgaXRlcmFibGUudmFsdWVSZWZlcmVuY2VGb3IocmVzdWx0KSkgfHwgdGhpczsKICAgICAgX3RoaXMyLnJldGFpbmVkID0gZmFsc2U7CiAgICAgIF90aGlzMi5zZWVuID0gZmFsc2U7CiAgICAgIF90aGlzMi5rZXkgPSByZXN1bHQua2V5OwogICAgICBfdGhpczIuaXRlcmFibGUgPSBpdGVyYWJsZTsKICAgICAgX3RoaXMyLm1lbW8gPSBpdGVyYWJsZS5tZW1vUmVmZXJlbmNlRm9yKHJlc3VsdCk7CiAgICAgIHJldHVybiBfdGhpczI7CiAgICB9CgogICAgdmFyIF9wcm90bzggPSBMaXN0SXRlbS5wcm90b3R5cGU7CgogICAgX3Byb3RvOC51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUoaXRlbSkgewogICAgICB0aGlzLnJldGFpbmVkID0gdHJ1ZTsKICAgICAgdGhpcy5pdGVyYWJsZS51cGRhdGVWYWx1ZVJlZmVyZW5jZSh0aGlzLnZhbHVlLCBpdGVtKTsKICAgICAgdGhpcy5pdGVyYWJsZS51cGRhdGVNZW1vUmVmZXJlbmNlKHRoaXMubWVtbywgaXRlbSk7CiAgICB9OwoKICAgIF9wcm90bzguc2hvdWxkUmVtb3ZlID0gZnVuY3Rpb24gc2hvdWxkUmVtb3ZlKCkgewogICAgICByZXR1cm4gIXRoaXMucmV0YWluZWQ7CiAgICB9OwoKICAgIF9wcm90bzgucmVzZXQgPSBmdW5jdGlvbiByZXNldCgpIHsKICAgICAgdGhpcy5yZXRhaW5lZCA9IGZhbHNlOwogICAgICB0aGlzLnNlZW4gPSBmYWxzZTsKICAgIH07CgogICAgcmV0dXJuIExpc3RJdGVtOwogIH0oX3V0aWwuTGlzdE5vZGUpOwoKICBfZXhwb3J0cy5MaXN0SXRlbSA9IExpc3RJdGVtOwoKICB2YXIgSXRlcmF0aW9uQXJ0aWZhY3RzID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gSXRlcmF0aW9uQXJ0aWZhY3RzKGl0ZXJhYmxlKSB7CiAgICAgIHRoaXMuaXRlcmF0b3IgPSBudWxsOwogICAgICB0aGlzLm1hcCA9ICgwLCBfdXRpbC5kaWN0KSgpOwogICAgICB0aGlzLmxpc3QgPSBuZXcgX3V0aWwuTGlua2VkTGlzdCgpOwogICAgICB0aGlzLnRhZyA9IGl0ZXJhYmxlLnRhZzsKICAgICAgdGhpcy5pdGVyYWJsZSA9IGl0ZXJhYmxlOwogICAgfQoKICAgIHZhciBfcHJvdG85ID0gSXRlcmF0aW9uQXJ0aWZhY3RzLnByb3RvdHlwZTsKCiAgICBfcHJvdG85LmlzRW1wdHkgPSBmdW5jdGlvbiBpc0VtcHR5KCkgewogICAgICB2YXIgaXRlcmF0b3IgPSB0aGlzLml0ZXJhdG9yID0gdGhpcy5pdGVyYWJsZS5pdGVyYXRlKCk7CiAgICAgIHJldHVybiBpdGVyYXRvci5pc0VtcHR5KCk7CiAgICB9OwoKICAgIF9wcm90bzkuaXRlcmF0ZSA9IGZ1bmN0aW9uIGl0ZXJhdGUoKSB7CiAgICAgIHZhciBpdGVyYXRvcjsKCiAgICAgIGlmICh0aGlzLml0ZXJhdG9yID09PSBudWxsKSB7CiAgICAgICAgaXRlcmF0b3IgPSB0aGlzLml0ZXJhYmxlLml0ZXJhdGUoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpdGVyYXRvciA9IHRoaXMuaXRlcmF0b3I7CiAgICAgIH0KCiAgICAgIHRoaXMuaXRlcmF0b3IgPSBudWxsOwogICAgICByZXR1cm4gaXRlcmF0b3I7CiAgICB9OwoKICAgIF9wcm90bzkuaGFzID0gZnVuY3Rpb24gaGFzKGtleSkgewogICAgICByZXR1cm4gISF0aGlzLm1hcFtrZXldOwogICAgfTsKCiAgICBfcHJvdG85LmdldCA9IGZ1bmN0aW9uIGdldChrZXkpIHsKICAgICAgcmV0dXJuIHRoaXMubWFwW2tleV07CiAgICB9OwoKICAgIF9wcm90bzkud2FzU2VlbiA9IGZ1bmN0aW9uIHdhc1NlZW4oa2V5KSB7CiAgICAgIHZhciBub2RlID0gdGhpcy5tYXBba2V5XTsKICAgICAgcmV0dXJuIG5vZGUgIT09IHVuZGVmaW5lZCAmJiBub2RlLnNlZW47CiAgICB9OwoKICAgIF9wcm90bzkuYXBwZW5kID0gZnVuY3Rpb24gYXBwZW5kKGl0ZW0pIHsKICAgICAgdmFyIG1hcCA9IHRoaXMubWFwLAogICAgICAgICAgbGlzdCA9IHRoaXMubGlzdCwKICAgICAgICAgIGl0ZXJhYmxlID0gdGhpcy5pdGVyYWJsZTsKICAgICAgdmFyIG5vZGUgPSBtYXBbaXRlbS5rZXldID0gbmV3IExpc3RJdGVtKGl0ZXJhYmxlLCBpdGVtKTsKICAgICAgbGlzdC5hcHBlbmQobm9kZSk7CiAgICAgIHJldHVybiBub2RlOwogICAgfTsKCiAgICBfcHJvdG85Lmluc2VydEJlZm9yZSA9IGZ1bmN0aW9uIGluc2VydEJlZm9yZShpdGVtLCByZWZlcmVuY2UpIHsKICAgICAgdmFyIG1hcCA9IHRoaXMubWFwLAogICAgICAgICAgbGlzdCA9IHRoaXMubGlzdCwKICAgICAgICAgIGl0ZXJhYmxlID0gdGhpcy5pdGVyYWJsZTsKICAgICAgdmFyIG5vZGUgPSBtYXBbaXRlbS5rZXldID0gbmV3IExpc3RJdGVtKGl0ZXJhYmxlLCBpdGVtKTsKICAgICAgbm9kZS5yZXRhaW5lZCA9IHRydWU7CiAgICAgIGxpc3QuaW5zZXJ0QmVmb3JlKG5vZGUsIHJlZmVyZW5jZSk7CiAgICAgIHJldHVybiBub2RlOwogICAgfTsKCiAgICBfcHJvdG85Lm1vdmUgPSBmdW5jdGlvbiBtb3ZlKGl0ZW0sIHJlZmVyZW5jZSkgewogICAgICB2YXIgbGlzdCA9IHRoaXMubGlzdDsKICAgICAgaXRlbS5yZXRhaW5lZCA9IHRydWU7CiAgICAgIGxpc3QucmVtb3ZlKGl0ZW0pOwogICAgICBsaXN0Lmluc2VydEJlZm9yZShpdGVtLCByZWZlcmVuY2UpOwogICAgfTsKCiAgICBfcHJvdG85LnJlbW92ZSA9IGZ1bmN0aW9uIHJlbW92ZShpdGVtKSB7CiAgICAgIHZhciBsaXN0ID0gdGhpcy5saXN0OwogICAgICBsaXN0LnJlbW92ZShpdGVtKTsKICAgICAgZGVsZXRlIHRoaXMubWFwW2l0ZW0ua2V5XTsKICAgIH07CgogICAgX3Byb3RvOS5uZXh0Tm9kZSA9IGZ1bmN0aW9uIG5leHROb2RlKGl0ZW0pIHsKICAgICAgcmV0dXJuIHRoaXMubGlzdC5uZXh0Tm9kZShpdGVtKTsKICAgIH07CgogICAgX3Byb3RvOS5oZWFkID0gZnVuY3Rpb24gaGVhZCgpIHsKICAgICAgcmV0dXJuIHRoaXMubGlzdC5oZWFkKCk7CiAgICB9OwoKICAgIHJldHVybiBJdGVyYXRpb25BcnRpZmFjdHM7CiAgfSgpOwoKICBfZXhwb3J0cy5JdGVyYXRpb25BcnRpZmFjdHMgPSBJdGVyYXRpb25BcnRpZmFjdHM7CgogIHZhciBSZWZlcmVuY2VJdGVyYXRvciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIC8vIGlmIGFueW9uZSBuZWVkcyB0byBjb25zdHJ1Y3QgdGhpcyBvYmplY3Qgd2l0aCBzb21ldGhpbmcgb3RoZXIgdGhhbgogICAgLy8gYW4gaXRlcmFibGUsIGxldCBAd3ljYXRzIGtub3cuCiAgICBmdW5jdGlvbiBSZWZlcmVuY2VJdGVyYXRvcihpdGVyYWJsZSkgewogICAgICB0aGlzLml0ZXJhdG9yID0gbnVsbDsKICAgICAgdmFyIGFydGlmYWN0cyA9IG5ldyBJdGVyYXRpb25BcnRpZmFjdHMoaXRlcmFibGUpOwogICAgICB0aGlzLmFydGlmYWN0cyA9IGFydGlmYWN0czsKICAgIH0KCiAgICB2YXIgX3Byb3RvMTAgPSBSZWZlcmVuY2VJdGVyYXRvci5wcm90b3R5cGU7CgogICAgX3Byb3RvMTAubmV4dCA9IGZ1bmN0aW9uIG5leHQoKSB7CiAgICAgIHZhciBhcnRpZmFjdHMgPSB0aGlzLmFydGlmYWN0czsKICAgICAgdmFyIGl0ZXJhdG9yID0gdGhpcy5pdGVyYXRvciA9IHRoaXMuaXRlcmF0b3IgfHwgYXJ0aWZhY3RzLml0ZXJhdGUoKTsKICAgICAgdmFyIGl0ZW0gPSBpdGVyYXRvci5uZXh0KCk7CiAgICAgIGlmIChpdGVtID09PSBudWxsKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIGFydGlmYWN0cy5hcHBlbmQoaXRlbSk7CiAgICB9OwoKICAgIHJldHVybiBSZWZlcmVuY2VJdGVyYXRvcjsKICB9KCk7CgogIF9leHBvcnRzLlJlZmVyZW5jZUl0ZXJhdG9yID0gUmVmZXJlbmNlSXRlcmF0b3I7CiAgdmFyIFBoYXNlOwoKICAoZnVuY3Rpb24gKFBoYXNlKSB7CiAgICBQaGFzZVtQaGFzZVsiQXBwZW5kIl0gPSAwXSA9ICJBcHBlbmQiOwogICAgUGhhc2VbUGhhc2VbIlBydW5lIl0gPSAxXSA9ICJQcnVuZSI7CiAgICBQaGFzZVtQaGFzZVsiRG9uZSJdID0gMl0gPSAiRG9uZSI7CiAgfSkoUGhhc2UgfHwgKFBoYXNlID0ge30pKTsKCiAgdmFyIEl0ZXJhdG9yU3luY2hyb25pemVyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gSXRlcmF0b3JTeW5jaHJvbml6ZXIoX3JlZjIpIHsKICAgICAgdmFyIHRhcmdldCA9IF9yZWYyLnRhcmdldCwKICAgICAgICAgIGFydGlmYWN0cyA9IF9yZWYyLmFydGlmYWN0czsKICAgICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7CiAgICAgIHRoaXMuYXJ0aWZhY3RzID0gYXJ0aWZhY3RzOwogICAgICB0aGlzLml0ZXJhdG9yID0gYXJ0aWZhY3RzLml0ZXJhdGUoKTsKICAgICAgdGhpcy5jdXJyZW50ID0gYXJ0aWZhY3RzLmhlYWQoKTsKICAgIH0KCiAgICB2YXIgX3Byb3RvMTEgPSBJdGVyYXRvclN5bmNocm9uaXplci5wcm90b3R5cGU7CgogICAgX3Byb3RvMTEuc3luYyA9IGZ1bmN0aW9uIHN5bmMoKSB7CiAgICAgIHZhciBwaGFzZSA9IFBoYXNlLkFwcGVuZDsKCiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgc3dpdGNoIChwaGFzZSkgewogICAgICAgICAgY2FzZSBQaGFzZS5BcHBlbmQ6CiAgICAgICAgICAgIHBoYXNlID0gdGhpcy5uZXh0QXBwZW5kKCk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgUGhhc2UuUHJ1bmU6CiAgICAgICAgICAgIHBoYXNlID0gdGhpcy5uZXh0UHJ1bmUoKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSBQaGFzZS5Eb25lOgogICAgICAgICAgICB0aGlzLm5leHREb25lKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMTEuYWR2YW5jZVRvS2V5ID0gZnVuY3Rpb24gYWR2YW5jZVRvS2V5KGtleSkgewogICAgICB2YXIgY3VycmVudCA9IHRoaXMuY3VycmVudCwKICAgICAgICAgIGFydGlmYWN0cyA9IHRoaXMuYXJ0aWZhY3RzOwogICAgICB2YXIgc2VlayA9IGN1cnJlbnQ7CgogICAgICB3aGlsZSAoc2VlayAhPT0gbnVsbCAmJiBzZWVrLmtleSAhPT0ga2V5KSB7CiAgICAgICAgc2Vlay5zZWVuID0gdHJ1ZTsKICAgICAgICBzZWVrID0gYXJ0aWZhY3RzLm5leHROb2RlKHNlZWspOwogICAgICB9CgogICAgICBpZiAoc2VlayAhPT0gbnVsbCkgewogICAgICAgIHRoaXMuY3VycmVudCA9IGFydGlmYWN0cy5uZXh0Tm9kZShzZWVrKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8xMS5uZXh0QXBwZW5kID0gZnVuY3Rpb24gbmV4dEFwcGVuZCgpIHsKICAgICAgdmFyIGl0ZXJhdG9yID0gdGhpcy5pdGVyYXRvciwKICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLmN1cnJlbnQsCiAgICAgICAgICBhcnRpZmFjdHMgPSB0aGlzLmFydGlmYWN0czsKICAgICAgdmFyIGl0ZW0gPSBpdGVyYXRvci5uZXh0KCk7CgogICAgICBpZiAoaXRlbSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiB0aGlzLnN0YXJ0UHJ1bmUoKTsKICAgICAgfQoKICAgICAgdmFyIGtleSA9IGl0ZW0ua2V5OwoKICAgICAgaWYgKGN1cnJlbnQgIT09IG51bGwgJiYgY3VycmVudC5rZXkgPT09IGtleSkgewogICAgICAgIHRoaXMubmV4dFJldGFpbihpdGVtKTsKICAgICAgfSBlbHNlIGlmIChhcnRpZmFjdHMuaGFzKGtleSkpIHsKICAgICAgICB0aGlzLm5leHRNb3ZlKGl0ZW0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubmV4dEluc2VydChpdGVtKTsKICAgICAgfQoKICAgICAgcmV0dXJuIFBoYXNlLkFwcGVuZDsKICAgIH07CgogICAgX3Byb3RvMTEubmV4dFJldGFpbiA9IGZ1bmN0aW9uIG5leHRSZXRhaW4oaXRlbSkgewogICAgICB2YXIgYXJ0aWZhY3RzID0gdGhpcy5hcnRpZmFjdHMsCiAgICAgICAgICBjdXJyZW50ID0gdGhpcy5jdXJyZW50OwogICAgICBjdXJyZW50ID0gY3VycmVudDsKICAgICAgY3VycmVudC51cGRhdGUoaXRlbSk7CiAgICAgIHRoaXMuY3VycmVudCA9IGFydGlmYWN0cy5uZXh0Tm9kZShjdXJyZW50KTsKICAgICAgdGhpcy50YXJnZXQucmV0YWluKGl0ZW0ua2V5LCBjdXJyZW50LnZhbHVlLCBjdXJyZW50Lm1lbW8pOwogICAgfTsKCiAgICBfcHJvdG8xMS5uZXh0TW92ZSA9IGZ1bmN0aW9uIG5leHRNb3ZlKGl0ZW0pIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmN1cnJlbnQsCiAgICAgICAgICBhcnRpZmFjdHMgPSB0aGlzLmFydGlmYWN0cywKICAgICAgICAgIHRhcmdldCA9IHRoaXMudGFyZ2V0OwogICAgICB2YXIga2V5ID0gaXRlbS5rZXk7CiAgICAgIHZhciBmb3VuZCA9IGFydGlmYWN0cy5nZXQoaXRlbS5rZXkpOwogICAgICBmb3VuZC51cGRhdGUoaXRlbSk7CgogICAgICBpZiAoYXJ0aWZhY3RzLndhc1NlZW4oaXRlbS5rZXkpKSB7CiAgICAgICAgYXJ0aWZhY3RzLm1vdmUoZm91bmQsIGN1cnJlbnQpOwogICAgICAgIHRhcmdldC5tb3ZlKGZvdW5kLmtleSwgZm91bmQudmFsdWUsIGZvdW5kLm1lbW8sIGN1cnJlbnQgPyBjdXJyZW50LmtleSA6IG51bGwpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYWR2YW5jZVRvS2V5KGtleSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMTEubmV4dEluc2VydCA9IGZ1bmN0aW9uIG5leHRJbnNlcnQoaXRlbSkgewogICAgICB2YXIgYXJ0aWZhY3RzID0gdGhpcy5hcnRpZmFjdHMsCiAgICAgICAgICB0YXJnZXQgPSB0aGlzLnRhcmdldCwKICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLmN1cnJlbnQ7CiAgICAgIHZhciBub2RlID0gYXJ0aWZhY3RzLmluc2VydEJlZm9yZShpdGVtLCBjdXJyZW50KTsKICAgICAgdGFyZ2V0Lmluc2VydChub2RlLmtleSwgbm9kZS52YWx1ZSwgbm9kZS5tZW1vLCBjdXJyZW50ID8gY3VycmVudC5rZXkgOiBudWxsKTsKICAgIH07CgogICAgX3Byb3RvMTEuc3RhcnRQcnVuZSA9IGZ1bmN0aW9uIHN0YXJ0UHJ1bmUoKSB7CiAgICAgIHRoaXMuY3VycmVudCA9IHRoaXMuYXJ0aWZhY3RzLmhlYWQoKTsKICAgICAgcmV0dXJuIFBoYXNlLlBydW5lOwogICAgfTsKCiAgICBfcHJvdG8xMS5uZXh0UHJ1bmUgPSBmdW5jdGlvbiBuZXh0UHJ1bmUoKSB7CiAgICAgIHZhciBhcnRpZmFjdHMgPSB0aGlzLmFydGlmYWN0cywKICAgICAgICAgIHRhcmdldCA9IHRoaXMudGFyZ2V0LAogICAgICAgICAgY3VycmVudCA9IHRoaXMuY3VycmVudDsKCiAgICAgIGlmIChjdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlLkRvbmU7CiAgICAgIH0KCiAgICAgIHZhciBub2RlID0gY3VycmVudDsKICAgICAgdGhpcy5jdXJyZW50ID0gYXJ0aWZhY3RzLm5leHROb2RlKG5vZGUpOwoKICAgICAgaWYgKG5vZGUuc2hvdWxkUmVtb3ZlKCkpIHsKICAgICAgICBhcnRpZmFjdHMucmVtb3ZlKG5vZGUpOwogICAgICAgIHRhcmdldC5kZWxldGUobm9kZS5rZXkpOwogICAgICB9IGVsc2UgewogICAgICAgIG5vZGUucmVzZXQoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIFBoYXNlLlBydW5lOwogICAgfTsKCiAgICBfcHJvdG8xMS5uZXh0RG9uZSA9IGZ1bmN0aW9uIG5leHREb25lKCkgewogICAgICB0aGlzLnRhcmdldC5kb25lKCk7CiAgICB9OwoKICAgIHJldHVybiBJdGVyYXRvclN5bmNocm9uaXplcjsKICB9KCk7CgogIF9leHBvcnRzLkl0ZXJhdG9yU3luY2hyb25pemVyID0gSXRlcmF0b3JTeW5jaHJvbml6ZXI7Cn0pOwpkZWZpbmUoIkBnbGltbWVyL3J1bnRpbWUiLCBbImV4cG9ydHMiLCAiZW1iZXItYmFiZWwiLCAiQGdsaW1tZXIvdXRpbCIsICJAZ2xpbW1lci9yZWZlcmVuY2UiLCAiQGdsaW1tZXIvdm0iLCAiQGdsaW1tZXIvbG93LWxldmVsIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2VtYmVyQmFiZWwsIF91dGlsLCBfcmVmZXJlbmNlMiwgX3ZtMiwgX2xvd0xldmVsKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5yZW5kZXJNYWluID0gcmVuZGVyTWFpbjsKICBfZXhwb3J0cy5yZW5kZXJDb21wb25lbnQgPSByZW5kZXJDb21wb25lbnQ7CiAgX2V4cG9ydHMuc2V0RGVidWdnZXJDYWxsYmFjayA9IHNldERlYnVnZ2VyQ2FsbGJhY2s7CiAgX2V4cG9ydHMucmVzZXREZWJ1Z2dlckNhbGxiYWNrID0gcmVzZXREZWJ1Z2dlckNhbGxiYWNrOwogIF9leHBvcnRzLmdldER5bmFtaWNWYXIgPSBnZXREeW5hbWljVmFyOwogIF9leHBvcnRzLmlzQ3VycmllZENvbXBvbmVudERlZmluaXRpb24gPSBpc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uOwogIF9leHBvcnRzLmN1cnJ5ID0gY3Vycnk7CiAgX2V4cG9ydHMuaXNXaGl0ZXNwYWNlID0gaXNXaGl0ZXNwYWNlOwogIF9leHBvcnRzLm5vcm1hbGl6ZVByb3BlcnR5ID0gbm9ybWFsaXplUHJvcGVydHk7CiAgX2V4cG9ydHMuY2xpZW50QnVpbGRlciA9IGNsaWVudEJ1aWxkZXI7CiAgX2V4cG9ydHMucmVoeWRyYXRpb25CdWlsZGVyID0gcmVoeWRyYXRpb25CdWlsZGVyOwogIF9leHBvcnRzLmlzU2VyaWFsaXphdGlvbkZpcnN0Tm9kZSA9IGlzU2VyaWFsaXphdGlvbkZpcnN0Tm9kZTsKICBfZXhwb3J0cy5jYXBhYmlsaXR5RmxhZ3NGcm9tID0gY2FwYWJpbGl0eUZsYWdzRnJvbTsKICBfZXhwb3J0cy5oYXNDYXBhYmlsaXR5ID0gaGFzQ2FwYWJpbGl0eTsKICBfZXhwb3J0cy5DdXJzb3IgPSBfZXhwb3J0cy5Db25jcmV0ZUJvdW5kcyA9IF9leHBvcnRzLlNFUklBTElaQVRJT05fRklSU1RfTk9ERV9TVFJJTkcgPSBfZXhwb3J0cy5SZWh5ZHJhdGVCdWlsZGVyID0gX2V4cG9ydHMuTmV3RWxlbWVudEJ1aWxkZXIgPSBfZXhwb3J0cy5ET01UcmVlQ29uc3RydWN0aW9uID0gX2V4cG9ydHMuSURPTUNoYW5nZXMgPSBfZXhwb3J0cy5TVkdfTkFNRVNQQUNFID0gX2V4cG9ydHMuRE9NQ2hhbmdlcyA9IF9leHBvcnRzLkN1cnJpZWRDb21wb25lbnREZWZpbml0aW9uID0gX2V4cG9ydHMuTUlOSU1BTF9DQVBBQklMSVRJRVMgPSBfZXhwb3J0cy5ERUZBVUxUX0NBUEFCSUxJVElFUyA9IF9leHBvcnRzLkRlZmF1bHRFbnZpcm9ubWVudCA9IF9leHBvcnRzLkVudmlyb25tZW50ID0gX2V4cG9ydHMuU2NvcGUgPSBfZXhwb3J0cy5FTVBUWV9BUkdTID0gX2V4cG9ydHMuRHluYW1pY0F0dHJpYnV0ZSA9IF9leHBvcnRzLlNpbXBsZUR5bmFtaWNBdHRyaWJ1dGUgPSBfZXhwb3J0cy5SZW5kZXJSZXN1bHQgPSBfZXhwb3J0cy5VcGRhdGluZ1ZNID0gX2V4cG9ydHMuTG93TGV2ZWxWTSA9IF9leHBvcnRzLkNvbmRpdGlvbmFsUmVmZXJlbmNlID0gX2V4cG9ydHMuUHJpbWl0aXZlUmVmZXJlbmNlID0gX2V4cG9ydHMuVU5ERUZJTkVEX1JFRkVSRU5DRSA9IF9leHBvcnRzLk5VTExfUkVGRVJFTkNFID0gdm9pZCAwOwoKICAvLyB0aGVzZSBpbXBvcnQgYmluZGluZ3Mgd2lsbCBiZSBzdHJpcHBlZCBmcm9tIGJ1aWxkCiAgdmFyIEFwcGVuZE9wY29kZXMgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBBcHBlbmRPcGNvZGVzKCkgewogICAgICB0aGlzLmV2YWx1YXRlT3Bjb2RlID0gKDAsIF91dGlsLmZpbGxOdWxscykoOTgKICAgICAgLyogU2l6ZSAqLwogICAgICApLnNsaWNlKCk7CiAgICB9CgogICAgdmFyIF9wcm90byA9IEFwcGVuZE9wY29kZXMucHJvdG90eXBlOwoKICAgIF9wcm90by5hZGQgPSBmdW5jdGlvbiBhZGQobmFtZSwgZXZhbHVhdGUsIGtpbmQpIHsKICAgICAgaWYgKGtpbmQgPT09IHZvaWQgMCkgewogICAgICAgIGtpbmQgPSAnc3lzY2FsbCc7CiAgICAgIH0KCiAgICAgIHRoaXMuZXZhbHVhdGVPcGNvZGVbbmFtZV0gPSB7CiAgICAgICAgc3lzY2FsbDoga2luZCA9PT0gJ3N5c2NhbGwnLAogICAgICAgIGV2YWx1YXRlOiBldmFsdWF0ZQogICAgICB9OwogICAgfTsKCiAgICBfcHJvdG8uZGVidWdCZWZvcmUgPSBmdW5jdGlvbiBkZWJ1Z0JlZm9yZSh2bSwgb3Bjb2RlLCB0eXBlKSB7CiAgICAgIHZhciBzcDsKICAgICAgdmFyIHN0YXRlOwogICAgICByZXR1cm4gewogICAgICAgIHNwOiBzcCwKICAgICAgICBzdGF0ZTogc3RhdGUKICAgICAgfTsKICAgIH07CgogICAgX3Byb3RvLmRlYnVnQWZ0ZXIgPSBmdW5jdGlvbiBkZWJ1Z0FmdGVyKHZtLCBvcGNvZGUsIHR5cGUsIHByZSkgewogICAgICB2YXIgZXhwZWN0ZWRDaGFuZ2U7CiAgICAgIHZhciBzcCA9IHByZS5zcCwKICAgICAgICAgIHN0YXRlID0gcHJlLnN0YXRlOwogICAgICB2YXIgbWV0YWRhdGEgPSBudWxsOwoKICAgICAgaWYgKG1ldGFkYXRhICE9PSBudWxsKSB7CiAgICAgICAgaWYgKHR5cGVvZiBtZXRhZGF0YS5zdGFja0NoYW5nZSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIGV4cGVjdGVkQ2hhbmdlID0gbWV0YWRhdGEuc3RhY2tDaGFuZ2U7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGV4cGVjdGVkQ2hhbmdlID0gbWV0YWRhdGEuc3RhY2tDaGFuZ2UoewogICAgICAgICAgICBvcGNvZGU6IG9wY29kZSwKICAgICAgICAgICAgY29uc3RhbnRzOiB2bS5jb25zdGFudHMsCiAgICAgICAgICAgIHN0YXRlOiBzdGF0ZQogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoaXNOYU4oZXhwZWN0ZWRDaGFuZ2UpKSB0aHJvdyAoMCwgX3V0aWwudW5yZWFjaGFibGUpKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5ldmFsdWF0ZSA9IGZ1bmN0aW9uIGV2YWx1YXRlKHZtLCBvcGNvZGUsIHR5cGUpIHsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHRoaXMuZXZhbHVhdGVPcGNvZGVbdHlwZV07CgogICAgICBpZiAob3BlcmF0aW9uLnN5c2NhbGwpIHsKICAgICAgICBvcGVyYXRpb24uZXZhbHVhdGUodm0sIG9wY29kZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3BlcmF0aW9uLmV2YWx1YXRlKHZtLmlubmVyLCBvcGNvZGUpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBBcHBlbmRPcGNvZGVzOwogIH0oKTsKCiAgdmFyIEFQUEVORF9PUENPREVTID0gbmV3IEFwcGVuZE9wY29kZXMoKTsKCiAgdmFyIEFic3RyYWN0T3Bjb2RlID0gZnVuY3Rpb24gQWJzdHJhY3RPcGNvZGUoKSB7CiAgICAoMCwgX3V0aWwuaW5pdGlhbGl6ZUd1aWQpKHRoaXMpOwogIH07CgogIHZhciBVcGRhdGluZ09wY29kZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfQWJzdHJhY3RPcGNvZGUpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShVcGRhdGluZ09wY29kZSwgX0Fic3RyYWN0T3Bjb2RlKTsKCiAgICBmdW5jdGlvbiBVcGRhdGluZ09wY29kZSgpIHsKICAgICAgdmFyIF90aGlzOwoKICAgICAgX3RoaXMgPSBfQWJzdHJhY3RPcGNvZGUuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgICBfdGhpcy5uZXh0ID0gbnVsbDsKICAgICAgX3RoaXMucHJldiA9IG51bGw7CiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICByZXR1cm4gVXBkYXRpbmdPcGNvZGU7CiAgfShBYnN0cmFjdE9wY29kZSk7CgogIHZhciBQcmltaXRpdmVSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0NvbnN0UmVmZXJlbmNlKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoUHJpbWl0aXZlUmVmZXJlbmNlLCBfQ29uc3RSZWZlcmVuY2UpOwoKICAgIGZ1bmN0aW9uIFByaW1pdGl2ZVJlZmVyZW5jZSh2YWx1ZSQkMSkgewogICAgICByZXR1cm4gX0NvbnN0UmVmZXJlbmNlLmNhbGwodGhpcywgdmFsdWUkJDEpIHx8IHRoaXM7CiAgICB9CgogICAgUHJpbWl0aXZlUmVmZXJlbmNlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZSh2YWx1ZSQkMSkgewogICAgICBpZiAodmFsdWUkJDEgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBVTkRFRklORURfUkVGRVJFTkNFOwogICAgICB9IGVsc2UgaWYgKHZhbHVlJCQxID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIE5VTExfUkVGRVJFTkNFOwogICAgICB9IGVsc2UgaWYgKHZhbHVlJCQxID09PSB0cnVlKSB7CiAgICAgICAgcmV0dXJuIFRSVUVfUkVGRVJFTkNFOwogICAgICB9IGVsc2UgaWYgKHZhbHVlJCQxID09PSBmYWxzZSkgewogICAgICAgIHJldHVybiBGQUxTRV9SRUZFUkVOQ0U7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlJCQxID09PSAnbnVtYmVyJykgewogICAgICAgIHJldHVybiBuZXcgVmFsdWVSZWZlcmVuY2UodmFsdWUkJDEpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuZXcgU3RyaW5nUmVmZXJlbmNlKHZhbHVlJCQxKTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgX3Byb3RvMiA9IFByaW1pdGl2ZVJlZmVyZW5jZS5wcm90b3R5cGU7CgogICAgX3Byb3RvMi5nZXQgPSBmdW5jdGlvbiBnZXQoX2tleSkgewogICAgICByZXR1cm4gVU5ERUZJTkVEX1JFRkVSRU5DRTsKICAgIH07CgogICAgcmV0dXJuIFByaW1pdGl2ZVJlZmVyZW5jZTsKICB9KF9yZWZlcmVuY2UyLkNvbnN0UmVmZXJlbmNlKTsKCiAgX2V4cG9ydHMuUHJpbWl0aXZlUmVmZXJlbmNlID0gUHJpbWl0aXZlUmVmZXJlbmNlOwoKICB2YXIgU3RyaW5nUmVmZXJlbmNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9QcmltaXRpdmVSZWZlcmVuY2UpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShTdHJpbmdSZWZlcmVuY2UsIF9QcmltaXRpdmVSZWZlcmVuY2UpOwoKICAgIGZ1bmN0aW9uIFN0cmluZ1JlZmVyZW5jZSgpIHsKICAgICAgdmFyIF90aGlzMjsKCiAgICAgIF90aGlzMiA9IF9QcmltaXRpdmVSZWZlcmVuY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgICBfdGhpczIubGVuZ3RoUmVmZXJlbmNlID0gbnVsbDsKICAgICAgcmV0dXJuIF90aGlzMjsKICAgIH0KCiAgICB2YXIgX3Byb3RvMyA9IFN0cmluZ1JlZmVyZW5jZS5wcm90b3R5cGU7CgogICAgX3Byb3RvMy5nZXQgPSBmdW5jdGlvbiBnZXQoa2V5KSB7CiAgICAgIGlmIChrZXkgPT09ICdsZW5ndGgnKSB7CiAgICAgICAgdmFyIGxlbmd0aFJlZmVyZW5jZSA9IHRoaXMubGVuZ3RoUmVmZXJlbmNlOwoKICAgICAgICBpZiAobGVuZ3RoUmVmZXJlbmNlID09PSBudWxsKSB7CiAgICAgICAgICBsZW5ndGhSZWZlcmVuY2UgPSB0aGlzLmxlbmd0aFJlZmVyZW5jZSA9IG5ldyBWYWx1ZVJlZmVyZW5jZSh0aGlzLmlubmVyLmxlbmd0aCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbGVuZ3RoUmVmZXJlbmNlOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBfUHJpbWl0aXZlUmVmZXJlbmNlLnByb3RvdHlwZS5nZXQuY2FsbCh0aGlzLCBrZXkpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBTdHJpbmdSZWZlcmVuY2U7CiAgfShQcmltaXRpdmVSZWZlcmVuY2UpOwoKICB2YXIgVmFsdWVSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX1ByaW1pdGl2ZVJlZmVyZW5jZTIpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShWYWx1ZVJlZmVyZW5jZSwgX1ByaW1pdGl2ZVJlZmVyZW5jZTIpOwoKICAgIGZ1bmN0aW9uIFZhbHVlUmVmZXJlbmNlKHZhbHVlJCQxKSB7CiAgICAgIHJldHVybiBfUHJpbWl0aXZlUmVmZXJlbmNlMi5jYWxsKHRoaXMsIHZhbHVlJCQxKSB8fCB0aGlzOwogICAgfQoKICAgIHJldHVybiBWYWx1ZVJlZmVyZW5jZTsKICB9KFByaW1pdGl2ZVJlZmVyZW5jZSk7CgogIHZhciBVTkRFRklORURfUkVGRVJFTkNFID0gbmV3IFZhbHVlUmVmZXJlbmNlKHVuZGVmaW5lZCk7CiAgX2V4cG9ydHMuVU5ERUZJTkVEX1JFRkVSRU5DRSA9IFVOREVGSU5FRF9SRUZFUkVOQ0U7CiAgdmFyIE5VTExfUkVGRVJFTkNFID0gbmV3IFZhbHVlUmVmZXJlbmNlKG51bGwpOwogIF9leHBvcnRzLk5VTExfUkVGRVJFTkNFID0gTlVMTF9SRUZFUkVOQ0U7CiAgdmFyIFRSVUVfUkVGRVJFTkNFID0gbmV3IFZhbHVlUmVmZXJlbmNlKHRydWUpOwogIHZhciBGQUxTRV9SRUZFUkVOQ0UgPSBuZXcgVmFsdWVSZWZlcmVuY2UoZmFsc2UpOwoKICB2YXIgQ29uZGl0aW9uYWxSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBDb25kaXRpb25hbFJlZmVyZW5jZShpbm5lcikgewogICAgICB0aGlzLmlubmVyID0gaW5uZXI7CiAgICAgIHRoaXMudGFnID0gaW5uZXIudGFnOwogICAgfQoKICAgIHZhciBfcHJvdG80ID0gQ29uZGl0aW9uYWxSZWZlcmVuY2UucHJvdG90eXBlOwoKICAgIF9wcm90bzQudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgcmV0dXJuIHRoaXMudG9Cb29sKHRoaXMuaW5uZXIudmFsdWUoKSk7CiAgICB9OwoKICAgIF9wcm90bzQudG9Cb29sID0gZnVuY3Rpb24gdG9Cb29sKHZhbHVlJCQxKSB7CiAgICAgIHJldHVybiAhIXZhbHVlJCQxOwogICAgfTsKCiAgICByZXR1cm4gQ29uZGl0aW9uYWxSZWZlcmVuY2U7CiAgfSgpOwoKICBfZXhwb3J0cy5Db25kaXRpb25hbFJlZmVyZW5jZSA9IENvbmRpdGlvbmFsUmVmZXJlbmNlOwoKICB2YXIgQ29uY2F0UmVmZXJlbmNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9DYWNoZWRSZWZlcmVuY2UpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShDb25jYXRSZWZlcmVuY2UsIF9DYWNoZWRSZWZlcmVuY2UpOwoKICAgIGZ1bmN0aW9uIENvbmNhdFJlZmVyZW5jZShwYXJ0cykgewogICAgICB2YXIgX3RoaXMzOwoKICAgICAgX3RoaXMzID0gX0NhY2hlZFJlZmVyZW5jZS5jYWxsKHRoaXMpIHx8IHRoaXM7CiAgICAgIF90aGlzMy5wYXJ0cyA9IHBhcnRzOwogICAgICBfdGhpczMudGFnID0gKDAsIF9yZWZlcmVuY2UyLmNvbWJpbmVUYWdnZWQpKHBhcnRzKTsKICAgICAgcmV0dXJuIF90aGlzMzsKICAgIH0KCiAgICB2YXIgX3Byb3RvNSA9IENvbmNhdFJlZmVyZW5jZS5wcm90b3R5cGU7CgogICAgX3Byb3RvNS5jb21wdXRlID0gZnVuY3Rpb24gY29tcHV0ZSgpIHsKICAgICAgdmFyIHBhcnRzID0gbmV3IEFycmF5KCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMucGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgdmFsdWUkJDEgPSB0aGlzLnBhcnRzW2ldLnZhbHVlKCk7CgogICAgICAgIGlmICh2YWx1ZSQkMSAhPT0gbnVsbCAmJiB2YWx1ZSQkMSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBwYXJ0c1tpXSA9IGNhc3RUb1N0cmluZyh2YWx1ZSQkMSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAocGFydHMubGVuZ3RoID4gMCkgewogICAgICAgIHJldHVybiBwYXJ0cy5qb2luKCcnKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9OwoKICAgIHJldHVybiBDb25jYXRSZWZlcmVuY2U7CiAgfShfcmVmZXJlbmNlMi5DYWNoZWRSZWZlcmVuY2UpOwoKICBmdW5jdGlvbiBjYXN0VG9TdHJpbmcodmFsdWUkJDEpIHsKICAgIGlmICh0eXBlb2YgdmFsdWUkJDEudG9TdHJpbmcgIT09ICdmdW5jdGlvbicpIHsKICAgICAgcmV0dXJuICcnOwogICAgfQoKICAgIHJldHVybiBTdHJpbmcodmFsdWUkJDEpOwogIH0KCiAgQVBQRU5EX09QQ09ERVMuYWRkKDEKICAvKiBIZWxwZXIgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZikgewogICAgdmFyIGhhbmRsZSA9IF9yZWYub3AxOwogICAgdmFyIHN0YWNrID0gdm0uc3RhY2s7CiAgICB2YXIgaGVscGVyID0gdm0uY29uc3RhbnRzLnJlc29sdmVIYW5kbGUoaGFuZGxlKTsKICAgIHZhciBhcmdzID0gc3RhY2sucG9wKCk7CiAgICB2YXIgdmFsdWUkJDEgPSBoZWxwZXIodm0sIGFyZ3MpOwogICAgdm0ubG9hZFZhbHVlKF92bTIuUmVnaXN0ZXIudjAsIHZhbHVlJCQxKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoNgogIC8qIEdldFZhcmlhYmxlICovCiAgLCBmdW5jdGlvbiAodm0sIF9yZWYyKSB7CiAgICB2YXIgc3ltYm9sID0gX3JlZjIub3AxOwogICAgdmFyIGV4cHIgPSB2bS5yZWZlcmVuY2VGb3JTeW1ib2woc3ltYm9sKTsKICAgIHZtLnN0YWNrLnB1c2goZXhwcik7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDQKICAvKiBTZXRWYXJpYWJsZSAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmMykgewogICAgdmFyIHN5bWJvbCA9IF9yZWYzLm9wMTsKICAgIHZhciBleHByID0gdm0uc3RhY2sucG9wKCk7CiAgICB2bS5zY29wZSgpLmJpbmRTeW1ib2woc3ltYm9sLCBleHByKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoNQogIC8qIFNldEJsb2NrICovCiAgLCBmdW5jdGlvbiAodm0sIF9yZWY0KSB7CiAgICB2YXIgc3ltYm9sID0gX3JlZjQub3AxOwogICAgdmFyIGhhbmRsZSA9IHZtLnN0YWNrLnBvcCgpOwogICAgdmFyIHNjb3BlID0gdm0uc3RhY2sucG9wKCk7IC8vIEZJWE1FKG1tdW4pOiBzaG91bGRuJ3QgbmVlZCB0byBjYXN0IHRoaXMKCiAgICB2YXIgdGFibGUgPSB2bS5zdGFjay5wb3AoKTsKICAgIHZhciBibG9jayA9IHRhYmxlID8gW2hhbmRsZSwgc2NvcGUsIHRhYmxlXSA6IG51bGw7CiAgICB2bS5zY29wZSgpLmJpbmRCbG9jayhzeW1ib2wsIGJsb2NrKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoOTYKICAvKiBSZXNvbHZlTWF5YmVMb2NhbCAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmNSkgewogICAgdmFyIF9uYW1lID0gX3JlZjUub3AxOwogICAgdmFyIG5hbWUgPSB2bS5jb25zdGFudHMuZ2V0U3RyaW5nKF9uYW1lKTsKICAgIHZhciBsb2NhbHMgPSB2bS5zY29wZSgpLmdldFBhcnRpYWxNYXAoKTsKICAgIHZhciByZWYgPSBsb2NhbHNbbmFtZV07CgogICAgaWYgKHJlZiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHJlZiA9IHZtLmdldFNlbGYoKS5nZXQobmFtZSk7CiAgICB9CgogICAgdm0uc3RhY2sucHVzaChyZWYpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCgyMAogIC8qIFJvb3RTY29wZSAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmNikgewogICAgdmFyIHN5bWJvbHMgPSBfcmVmNi5vcDEsCiAgICAgICAgYmluZENhbGxlclNjb3BlID0gX3JlZjYub3AyOwogICAgdm0ucHVzaFJvb3RTY29wZShzeW1ib2xzLCAhIWJpbmRDYWxsZXJTY29wZSk7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDcKICAvKiBHZXRQcm9wZXJ0eSAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmNykgewogICAgdmFyIF9rZXkgPSBfcmVmNy5vcDE7CiAgICB2YXIga2V5ID0gdm0uY29uc3RhbnRzLmdldFN0cmluZyhfa2V5KTsKICAgIHZhciBleHByID0gdm0uc3RhY2sucG9wKCk7CiAgICB2bS5zdGFjay5wdXNoKGV4cHIuZ2V0KGtleSkpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg4CiAgLyogR2V0QmxvY2sgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjgpIHsKICAgIHZhciBfYmxvY2sgPSBfcmVmOC5vcDE7CiAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKICAgIHZhciBibG9jayA9IHZtLnNjb3BlKCkuZ2V0QmxvY2soX2Jsb2NrKTsKCiAgICBpZiAoYmxvY2spIHsKICAgICAgc3RhY2sucHVzaChibG9ja1syXSk7CiAgICAgIHN0YWNrLnB1c2goYmxvY2tbMV0pOwogICAgICBzdGFjay5wdXNoKGJsb2NrWzBdKTsKICAgIH0gZWxzZSB7CiAgICAgIHN0YWNrLnB1c2gobnVsbCk7CiAgICAgIHN0YWNrLnB1c2gobnVsbCk7CiAgICAgIHN0YWNrLnB1c2gobnVsbCk7CiAgICB9CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDkKICAvKiBIYXNCbG9jayAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmOSkgewogICAgdmFyIF9ibG9jayA9IF9yZWY5Lm9wMTsKICAgIHZhciBoYXNCbG9jayA9ICEhdm0uc2NvcGUoKS5nZXRCbG9jayhfYmxvY2spOwogICAgdm0uc3RhY2sucHVzaChoYXNCbG9jayA/IFRSVUVfUkVGRVJFTkNFIDogRkFMU0VfUkVGRVJFTkNFKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoMTAKICAvKiBIYXNCbG9ja1BhcmFtcyAqLwogICwgZnVuY3Rpb24gKHZtKSB7CiAgICAvLyBGSVhNRShtbXVuKTogc2hvdWxkIG9ubHkgbmVlZCB0byBwdXNoIHRoZSBzeW1ib2wgdGFibGUKICAgIHZhciBibG9jayA9IHZtLnN0YWNrLnBvcCgpOwogICAgdmFyIHNjb3BlID0gdm0uc3RhY2sucG9wKCk7CiAgICB2YXIgdGFibGUgPSB2bS5zdGFjay5wb3AoKTsKICAgIHZhciBoYXNCbG9ja1BhcmFtcyA9IHRhYmxlICYmIHRhYmxlLnBhcmFtZXRlcnMubGVuZ3RoOwogICAgdm0uc3RhY2sucHVzaChoYXNCbG9ja1BhcmFtcyA/IFRSVUVfUkVGRVJFTkNFIDogRkFMU0VfUkVGRVJFTkNFKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoMTEKICAvKiBDb25jYXQgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjEwKSB7CiAgICB2YXIgY291bnQgPSBfcmVmMTAub3AxOwogICAgdmFyIG91dCA9IG5ldyBBcnJheShjb3VudCk7CgogICAgZm9yICh2YXIgaSA9IGNvdW50OyBpID4gMDsgaS0tKSB7CiAgICAgIHZhciBvZmZzZXQgPSBpIC0gMTsKICAgICAgb3V0W29mZnNldF0gPSB2bS5zdGFjay5wb3AoKTsKICAgIH0KCiAgICB2bS5zdGFjay5wdXNoKG5ldyBDb25jYXRSZWZlcmVuY2Uob3V0KSk7CiAgfSk7CiAgdmFyIENVUlJJRURfQ09NUE9ORU5UX0RFRklOSVRJT05fQlJBTkQgPSAnQ1VSUklFRCBDT01QT05FTlQgREVGSU5JVElPTiBbaWQ9NmYwMGZlYjktYTBlZi00NTQ3LTk5ZWEtYWMzMjhmODBhY2VhXSc7CgogIGZ1bmN0aW9uIGlzQ3VycmllZENvbXBvbmVudERlZmluaXRpb24oZGVmaW5pdGlvbikgewogICAgcmV0dXJuICEhKGRlZmluaXRpb24gJiYgZGVmaW5pdGlvbltDVVJSSUVEX0NPTVBPTkVOVF9ERUZJTklUSU9OX0JSQU5EXSk7CiAgfQoKICBmdW5jdGlvbiBpc0NvbXBvbmVudERlZmluaXRpb24oZGVmaW5pdGlvbikgewogICAgcmV0dXJuIGRlZmluaXRpb24gJiYgZGVmaW5pdGlvbltDVVJSSUVEX0NPTVBPTkVOVF9ERUZJTklUSU9OX0JSQU5EXTsKICB9CgogIHZhciBDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbiA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIC8qKiBAaW50ZXJuYWwgKi8KICAgIGZ1bmN0aW9uIEN1cnJpZWRDb21wb25lbnREZWZpbml0aW9uKGlubmVyLCBhcmdzKSB7CiAgICAgIHRoaXMuaW5uZXIgPSBpbm5lcjsKICAgICAgdGhpcy5hcmdzID0gYXJnczsKICAgICAgdGhpc1tDVVJSSUVEX0NPTVBPTkVOVF9ERUZJTklUSU9OX0JSQU5EXSA9IHRydWU7CiAgICB9CgogICAgdmFyIF9wcm90bzYgPSBDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbi5wcm90b3R5cGU7CgogICAgX3Byb3RvNi51bndyYXAgPSBmdW5jdGlvbiB1bndyYXAoYXJncykgewogICAgICBhcmdzLnJlYWxsb2ModGhpcy5vZmZzZXQpOwogICAgICB2YXIgZGVmaW5pdGlvbiA9IHRoaXM7CgogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIHZhciBfZGVmaW5pdGlvbiA9IGRlZmluaXRpb24sCiAgICAgICAgICAgIGN1cnJpZWRBcmdzID0gX2RlZmluaXRpb24uYXJncywKICAgICAgICAgICAgaW5uZXIgPSBfZGVmaW5pdGlvbi5pbm5lcjsKCiAgICAgICAgaWYgKGN1cnJpZWRBcmdzKSB7CiAgICAgICAgICBhcmdzLnBvc2l0aW9uYWwucHJlcGVuZChjdXJyaWVkQXJncy5wb3NpdGlvbmFsKTsKICAgICAgICAgIGFyZ3MubmFtZWQubWVyZ2UoY3VycmllZEFyZ3MubmFtZWQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFpc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uKGlubmVyKSkgewogICAgICAgICAgcmV0dXJuIGlubmVyOwogICAgICAgIH0KCiAgICAgICAgZGVmaW5pdGlvbiA9IGlubmVyOwogICAgICB9CiAgICB9CiAgICAvKiogQGludGVybmFsICovCiAgICA7CgogICAgKDAsIF9lbWJlckJhYmVsLmNyZWF0ZUNsYXNzKShDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbiwgW3sKICAgICAga2V5OiAib2Zmc2V0IiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgdmFyIGlubmVyID0gdGhpcy5pbm5lciwKICAgICAgICAgICAgYXJncyA9IHRoaXMuYXJnczsKICAgICAgICB2YXIgbGVuZ3RoID0gYXJncyA/IGFyZ3MucG9zaXRpb25hbC5sZW5ndGggOiAwOwogICAgICAgIHJldHVybiBpc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uKGlubmVyKSA/IGxlbmd0aCArIGlubmVyLm9mZnNldCA6IGxlbmd0aDsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEN1cnJpZWRDb21wb25lbnREZWZpbml0aW9uOwogIH0oKTsKCiAgX2V4cG9ydHMuQ3VycmllZENvbXBvbmVudERlZmluaXRpb24gPSBDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbjsKCiAgZnVuY3Rpb24gY3Vycnkoc3BlYywgYXJncykgewogICAgaWYgKGFyZ3MgPT09IHZvaWQgMCkgewogICAgICBhcmdzID0gbnVsbDsKICAgIH0KCiAgICByZXR1cm4gbmV3IEN1cnJpZWRDb21wb25lbnREZWZpbml0aW9uKHNwZWMsIGFyZ3MpOwogIH0KCiAgZnVuY3Rpb24gbm9ybWFsaXplU3RyaW5nVmFsdWUodmFsdWUkJDEpIHsKICAgIGlmIChpc0VtcHR5KHZhbHVlJCQxKSkgewogICAgICByZXR1cm4gJyc7CiAgICB9CgogICAgcmV0dXJuIFN0cmluZyh2YWx1ZSQkMSk7CiAgfQoKICBmdW5jdGlvbiBzaG91bGRDb2VyY2UodmFsdWUkJDEpIHsKICAgIHJldHVybiBpc1N0cmluZyh2YWx1ZSQkMSkgfHwgaXNFbXB0eSh2YWx1ZSQkMSkgfHwgdHlwZW9mIHZhbHVlJCQxID09PSAnYm9vbGVhbicgfHwgdHlwZW9mIHZhbHVlJCQxID09PSAnbnVtYmVyJzsKICB9CgogIGZ1bmN0aW9uIGlzRW1wdHkodmFsdWUkJDEpIHsKICAgIHJldHVybiB2YWx1ZSQkMSA9PT0gbnVsbCB8fCB2YWx1ZSQkMSA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiB2YWx1ZSQkMS50b1N0cmluZyAhPT0gJ2Z1bmN0aW9uJzsKICB9CgogIGZ1bmN0aW9uIGlzU2FmZVN0cmluZyh2YWx1ZSQkMSkgewogICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSQkMSA9PT0gJ29iamVjdCcgJiYgdmFsdWUkJDEgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlJCQxLnRvSFRNTCA9PT0gJ2Z1bmN0aW9uJzsKICB9CgogIGZ1bmN0aW9uIGlzTm9kZSh2YWx1ZSQkMSkgewogICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSQkMSA9PT0gJ29iamVjdCcgJiYgdmFsdWUkJDEgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlJCQxLm5vZGVUeXBlID09PSAnbnVtYmVyJzsKICB9CgogIGZ1bmN0aW9uIGlzRnJhZ21lbnQodmFsdWUkJDEpIHsKICAgIHJldHVybiBpc05vZGUodmFsdWUkJDEpICYmIHZhbHVlJCQxLm5vZGVUeXBlID09PSAxMTsKICB9CgogIGZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlJCQxKSB7CiAgICByZXR1cm4gdHlwZW9mIHZhbHVlJCQxID09PSAnc3RyaW5nJzsKICB9CgogIHZhciBEeW5hbWljVGV4dENvbnRlbnQgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX1VwZGF0aW5nT3Bjb2RlKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoRHluYW1pY1RleHRDb250ZW50LCBfVXBkYXRpbmdPcGNvZGUpOwoKICAgIGZ1bmN0aW9uIER5bmFtaWNUZXh0Q29udGVudChub2RlLCByZWZlcmVuY2UsIGxhc3RWYWx1ZSkgewogICAgICB2YXIgX3RoaXM0OwoKICAgICAgX3RoaXM0ID0gX1VwZGF0aW5nT3Bjb2RlLmNhbGwodGhpcykgfHwgdGhpczsKICAgICAgX3RoaXM0Lm5vZGUgPSBub2RlOwogICAgICBfdGhpczQucmVmZXJlbmNlID0gcmVmZXJlbmNlOwogICAgICBfdGhpczQubGFzdFZhbHVlID0gbGFzdFZhbHVlOwogICAgICBfdGhpczQudHlwZSA9ICdkeW5hbWljLXRleHQnOwogICAgICBfdGhpczQudGFnID0gcmVmZXJlbmNlLnRhZzsKICAgICAgX3RoaXM0Lmxhc3RSZXZpc2lvbiA9ICgwLCBfcmVmZXJlbmNlMi52YWx1ZSkoX3RoaXM0LnRhZyk7CiAgICAgIHJldHVybiBfdGhpczQ7CiAgICB9CgogICAgdmFyIF9wcm90bzcgPSBEeW5hbWljVGV4dENvbnRlbnQucHJvdG90eXBlOwoKICAgIF9wcm90bzcuZXZhbHVhdGUgPSBmdW5jdGlvbiBldmFsdWF0ZSgpIHsKICAgICAgdmFyIHJlZmVyZW5jZSA9IHRoaXMucmVmZXJlbmNlLAogICAgICAgICAgdGFnID0gdGhpcy50YWc7CgogICAgICBpZiAoISgwLCBfcmVmZXJlbmNlMi52YWxpZGF0ZSkodGFnLCB0aGlzLmxhc3RSZXZpc2lvbikpIHsKICAgICAgICB0aGlzLmxhc3RSZXZpc2lvbiA9ICgwLCBfcmVmZXJlbmNlMi52YWx1ZSkodGFnKTsKICAgICAgICB0aGlzLnVwZGF0ZShyZWZlcmVuY2UudmFsdWUoKSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNy51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUodmFsdWUkJDEpIHsKICAgICAgdmFyIGxhc3RWYWx1ZSA9IHRoaXMubGFzdFZhbHVlOwogICAgICBpZiAodmFsdWUkJDEgPT09IGxhc3RWYWx1ZSkgcmV0dXJuOwogICAgICB2YXIgbm9ybWFsaXplZDsKCiAgICAgIGlmIChpc0VtcHR5KHZhbHVlJCQxKSkgewogICAgICAgIG5vcm1hbGl6ZWQgPSAnJzsKICAgICAgfSBlbHNlIGlmIChpc1N0cmluZyh2YWx1ZSQkMSkpIHsKICAgICAgICBub3JtYWxpemVkID0gdmFsdWUkJDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbm9ybWFsaXplZCA9IFN0cmluZyh2YWx1ZSQkMSk7CiAgICAgIH0KCiAgICAgIGlmIChub3JtYWxpemVkICE9PSBsYXN0VmFsdWUpIHsKICAgICAgICB2YXIgdGV4dE5vZGUgPSB0aGlzLm5vZGU7CiAgICAgICAgdGV4dE5vZGUubm9kZVZhbHVlID0gdGhpcy5sYXN0VmFsdWUgPSBub3JtYWxpemVkOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBEeW5hbWljVGV4dENvbnRlbnQ7CiAgfShVcGRhdGluZ09wY29kZSk7CgogIHZhciBJc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uUmVmZXJlbmNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9Db25kaXRpb25hbFJlZmVyZW5jZSkgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKElzQ3VycmllZENvbXBvbmVudERlZmluaXRpb25SZWZlcmVuY2UsIF9Db25kaXRpb25hbFJlZmVyZW5jZSk7CgogICAgZnVuY3Rpb24gSXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvblJlZmVyZW5jZSgpIHsKICAgICAgcmV0dXJuIF9Db25kaXRpb25hbFJlZmVyZW5jZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICB9CgogICAgSXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvblJlZmVyZW5jZS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUoaW5uZXIpIHsKICAgICAgcmV0dXJuIG5ldyBJc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uUmVmZXJlbmNlKGlubmVyKTsKICAgIH07CgogICAgdmFyIF9wcm90bzggPSBJc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uUmVmZXJlbmNlLnByb3RvdHlwZTsKCiAgICBfcHJvdG84LnRvQm9vbCA9IGZ1bmN0aW9uIHRvQm9vbCh2YWx1ZSQkMSkgewogICAgICByZXR1cm4gaXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbih2YWx1ZSQkMSk7CiAgICB9OwoKICAgIHJldHVybiBJc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uUmVmZXJlbmNlOwogIH0oQ29uZGl0aW9uYWxSZWZlcmVuY2UpOwoKICB2YXIgQ29udGVudFR5cGVSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBDb250ZW50VHlwZVJlZmVyZW5jZShpbm5lcikgewogICAgICB0aGlzLmlubmVyID0gaW5uZXI7CiAgICAgIHRoaXMudGFnID0gaW5uZXIudGFnOwogICAgfQoKICAgIHZhciBfcHJvdG85ID0gQ29udGVudFR5cGVSZWZlcmVuY2UucHJvdG90eXBlOwoKICAgIF9wcm90bzkudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdmFyIHZhbHVlJCQxID0gdGhpcy5pbm5lci52YWx1ZSgpOwoKICAgICAgaWYgKHNob3VsZENvZXJjZSh2YWx1ZSQkMSkpIHsKICAgICAgICByZXR1cm4gMQogICAgICAgIC8qIFN0cmluZyAqLwogICAgICAgIDsKICAgICAgfSBlbHNlIGlmIChpc0NvbXBvbmVudERlZmluaXRpb24odmFsdWUkJDEpKSB7CiAgICAgICAgcmV0dXJuIDAKICAgICAgICAvKiBDb21wb25lbnQgKi8KICAgICAgICA7CiAgICAgIH0gZWxzZSBpZiAoaXNTYWZlU3RyaW5nKHZhbHVlJCQxKSkgewogICAgICAgIHJldHVybiAzCiAgICAgICAgLyogU2FmZVN0cmluZyAqLwogICAgICAgIDsKICAgICAgfSBlbHNlIGlmIChpc0ZyYWdtZW50KHZhbHVlJCQxKSkgewogICAgICAgIHJldHVybiA0CiAgICAgICAgLyogRnJhZ21lbnQgKi8KICAgICAgICA7CiAgICAgIH0gZWxzZSBpZiAoaXNOb2RlKHZhbHVlJCQxKSkgewogICAgICAgIHJldHVybiA1CiAgICAgICAgLyogTm9kZSAqLwogICAgICAgIDsKICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiAxCiAgICAgICAgICAvKiBTdHJpbmcgKi8KICAgICAgICAgIDsKICAgICAgICB9CiAgICB9OwoKICAgIHJldHVybiBDb250ZW50VHlwZVJlZmVyZW5jZTsKICB9KCk7CgogIEFQUEVORF9PUENPREVTLmFkZCgyOAogIC8qIEFwcGVuZEhUTUwgKi8KICAsIGZ1bmN0aW9uICh2bSkgewogICAgdmFyIHJlZmVyZW5jZSA9IHZtLnN0YWNrLnBvcCgpOwogICAgdmFyIHJhd1ZhbHVlID0gcmVmZXJlbmNlLnZhbHVlKCk7CiAgICB2YXIgdmFsdWUkJDEgPSBpc0VtcHR5KHJhd1ZhbHVlKSA/ICcnIDogU3RyaW5nKHJhd1ZhbHVlKTsKICAgIHZtLmVsZW1lbnRzKCkuYXBwZW5kRHluYW1pY0hUTUwodmFsdWUkJDEpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCgyOQogIC8qIEFwcGVuZFNhZmVIVE1MICovCiAgLCBmdW5jdGlvbiAodm0pIHsKICAgIHZhciByZWZlcmVuY2UgPSB2bS5zdGFjay5wb3AoKTsKICAgIHZhciByYXdWYWx1ZSA9IHJlZmVyZW5jZS52YWx1ZSgpLnRvSFRNTCgpOwogICAgdmFyIHZhbHVlJCQxID0gaXNFbXB0eShyYXdWYWx1ZSkgPyAnJyA6IHJhd1ZhbHVlOwogICAgdm0uZWxlbWVudHMoKS5hcHBlbmREeW5hbWljSFRNTCh2YWx1ZSQkMSk7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDMyCiAgLyogQXBwZW5kVGV4dCAqLwogICwgZnVuY3Rpb24gKHZtKSB7CiAgICB2YXIgcmVmZXJlbmNlID0gdm0uc3RhY2sucG9wKCk7CiAgICB2YXIgcmF3VmFsdWUgPSByZWZlcmVuY2UudmFsdWUoKTsKICAgIHZhciB2YWx1ZSQkMSA9IGlzRW1wdHkocmF3VmFsdWUpID8gJycgOiBTdHJpbmcocmF3VmFsdWUpOwogICAgdmFyIG5vZGUgPSB2bS5lbGVtZW50cygpLmFwcGVuZER5bmFtaWNUZXh0KHZhbHVlJCQxKTsKCiAgICBpZiAoISgwLCBfcmVmZXJlbmNlMi5pc0NvbnN0KShyZWZlcmVuY2UpKSB7CiAgICAgIHZtLnVwZGF0ZVdpdGgobmV3IER5bmFtaWNUZXh0Q29udGVudChub2RlLCByZWZlcmVuY2UsIHZhbHVlJCQxKSk7CiAgICB9CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDMwCiAgLyogQXBwZW5kRG9jdW1lbnRGcmFnbWVudCAqLwogICwgZnVuY3Rpb24gKHZtKSB7CiAgICB2YXIgcmVmZXJlbmNlID0gdm0uc3RhY2sucG9wKCk7CiAgICB2YXIgdmFsdWUkJDEgPSByZWZlcmVuY2UudmFsdWUoKTsKICAgIHZtLmVsZW1lbnRzKCkuYXBwZW5kRHluYW1pY0ZyYWdtZW50KHZhbHVlJCQxKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoMzEKICAvKiBBcHBlbmROb2RlICovCiAgLCBmdW5jdGlvbiAodm0pIHsKICAgIHZhciByZWZlcmVuY2UgPSB2bS5zdGFjay5wb3AoKTsKICAgIHZhciB2YWx1ZSQkMSA9IHJlZmVyZW5jZS52YWx1ZSgpOwogICAgdm0uZWxlbWVudHMoKS5hcHBlbmREeW5hbWljTm9kZSh2YWx1ZSQkMSk7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDIyCiAgLyogQ2hpbGRTY29wZSAqLwogICwgZnVuY3Rpb24gKHZtKSB7CiAgICByZXR1cm4gdm0ucHVzaENoaWxkU2NvcGUoKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoMjMKICAvKiBQb3BTY29wZSAqLwogICwgZnVuY3Rpb24gKHZtKSB7CiAgICByZXR1cm4gdm0ucG9wU2NvcGUoKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoNDQKICAvKiBQdXNoRHluYW1pY1Njb3BlICovCiAgLCBmdW5jdGlvbiAodm0pIHsKICAgIHJldHVybiB2bS5wdXNoRHluYW1pY1Njb3BlKCk7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDQ1CiAgLyogUG9wRHluYW1pY1Njb3BlICovCiAgLCBmdW5jdGlvbiAodm0pIHsKICAgIHJldHVybiB2bS5wb3BEeW5hbWljU2NvcGUoKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoMTIKICAvKiBDb25zdGFudCAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmMTEpIHsKICAgIHZhciBvdGhlciA9IF9yZWYxMS5vcDE7CiAgICB2bS5zdGFjay5wdXNoKHZtLmNvbnN0YW50cy5nZXRPdGhlcihvdGhlcikpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCgxMwogIC8qIFByaW1pdGl2ZSAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmMTIpIHsKICAgIHZhciBwcmltaXRpdmUgPSBfcmVmMTIub3AxOwogICAgdmFyIHN0YWNrID0gdm0uc3RhY2s7CiAgICB2YXIgZmxhZyA9IHByaW1pdGl2ZSAmIDc7IC8vIDExMQoKICAgIHZhciB2YWx1ZSQkMSA9IHByaW1pdGl2ZSA+PiAzOwoKICAgIHN3aXRjaCAoZmxhZykgewogICAgICBjYXNlIDAKICAgICAgLyogTlVNQkVSICovCiAgICAgIDoKICAgICAgICBzdGFjay5wdXNoKHZhbHVlJCQxKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMQogICAgICAvKiBGTE9BVCAqLwogICAgICA6CiAgICAgICAgc3RhY2sucHVzaCh2bS5jb25zdGFudHMuZ2V0TnVtYmVyKHZhbHVlJCQxKSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDIKICAgICAgLyogU1RSSU5HICovCiAgICAgIDoKICAgICAgICBzdGFjay5wdXNoKHZtLmNvbnN0YW50cy5nZXRTdHJpbmcodmFsdWUkJDEpKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMwogICAgICAvKiBCT09MRUFOX09SX1ZPSUQgKi8KICAgICAgOgogICAgICAgIHN0YWNrLnB1c2hFbmNvZGVkSW1tZWRpYXRlKHByaW1pdGl2ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQKICAgICAgLyogTkVHQVRJVkUgKi8KICAgICAgOgogICAgICAgIHN0YWNrLnB1c2godm0uY29uc3RhbnRzLmdldE51bWJlcih2YWx1ZSQkMSkpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1CiAgICAgIC8qIEJJR19OVU0gKi8KICAgICAgOgogICAgICAgIHN0YWNrLnB1c2godm0uY29uc3RhbnRzLmdldE51bWJlcih2YWx1ZSQkMSkpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCgxNAogIC8qIFByaW1pdGl2ZVJlZmVyZW5jZSAqLwogICwgZnVuY3Rpb24gKHZtKSB7CiAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKICAgIHN0YWNrLnB1c2goUHJpbWl0aXZlUmVmZXJlbmNlLmNyZWF0ZShzdGFjay5wb3AoKSkpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCgxNQogIC8qIFJlaWZ5VTMyICovCiAgLCBmdW5jdGlvbiAodm0pIHsKICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgc3RhY2sucHVzaChzdGFjay5wZWVrKCkudmFsdWUoKSk7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDE2CiAgLyogRHVwICovCiAgLCBmdW5jdGlvbiAodm0sIF9yZWYxMykgewogICAgdmFyIHJlZ2lzdGVyID0gX3JlZjEzLm9wMSwKICAgICAgICBvZmZzZXQgPSBfcmVmMTMub3AyOwogICAgdmFyIHBvc2l0aW9uID0gdm0uZmV0Y2hWYWx1ZShyZWdpc3RlcikgLSBvZmZzZXQ7CiAgICB2bS5zdGFjay5kdXAocG9zaXRpb24pOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCgxNwogIC8qIFBvcCAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmMTQpIHsKICAgIHZhciBjb3VudCA9IF9yZWYxNC5vcDE7CiAgICB2bS5zdGFjay5wb3AoY291bnQpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCgxOAogIC8qIExvYWQgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjE1KSB7CiAgICB2YXIgcmVnaXN0ZXIgPSBfcmVmMTUub3AxOwogICAgdm0ubG9hZChyZWdpc3Rlcik7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDE5CiAgLyogRmV0Y2ggKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjE2KSB7CiAgICB2YXIgcmVnaXN0ZXIgPSBfcmVmMTYub3AxOwogICAgdm0uZmV0Y2gocmVnaXN0ZXIpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg0MwogIC8qIEJpbmREeW5hbWljU2NvcGUgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjE3KSB7CiAgICB2YXIgX25hbWVzID0gX3JlZjE3Lm9wMTsKICAgIHZhciBuYW1lcyA9IHZtLmNvbnN0YW50cy5nZXRBcnJheShfbmFtZXMpOwogICAgdm0uYmluZER5bmFtaWNTY29wZShuYW1lcyk7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDYxCiAgLyogRW50ZXIgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjE4KSB7CiAgICB2YXIgYXJncyA9IF9yZWYxOC5vcDE7CiAgICB2bS5lbnRlcihhcmdzKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoNjIKICAvKiBFeGl0ICovCiAgLCBmdW5jdGlvbiAodm0pIHsKICAgIHZtLmV4aXQoKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoNDgKICAvKiBQdXNoU3ltYm9sVGFibGUgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjE5KSB7CiAgICB2YXIgX3RhYmxlID0gX3JlZjE5Lm9wMTsKICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgc3RhY2sucHVzaCh2bS5jb25zdGFudHMuZ2V0U2VyaWFsaXphYmxlKF90YWJsZSkpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg0NwogIC8qIFB1c2hCbG9ja1Njb3BlICovCiAgLCBmdW5jdGlvbiAodm0pIHsKICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgc3RhY2sucHVzaCh2bS5zY29wZSgpKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoNDYKICAvKiBDb21waWxlQmxvY2sgKi8KICAsIGZ1bmN0aW9uICh2bSkgewogICAgdmFyIHN0YWNrID0gdm0uc3RhY2s7CiAgICB2YXIgYmxvY2sgPSBzdGFjay5wb3AoKTsKCiAgICBpZiAoYmxvY2spIHsKICAgICAgc3RhY2sucHVzaChibG9jay5jb21waWxlKCkpOwogICAgfSBlbHNlIHsKICAgICAgc3RhY2sucHVzaE51bGwoKTsKICAgIH0KICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoNTEKICAvKiBJbnZva2VZaWVsZCAqLwogICwgZnVuY3Rpb24gKHZtKSB7CiAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKICAgIHZhciBoYW5kbGUgPSBzdGFjay5wb3AoKTsKICAgIHZhciBzY29wZSA9IHN0YWNrLnBvcCgpOyAvLyBGSVhNRShtbXVuKTogc2hvdWxkbid0IG5lZWQgdG8gY2FzdCB0aGlzCgogICAgdmFyIHRhYmxlID0gc3RhY2sucG9wKCk7CiAgICB2YXIgYXJncyA9IHN0YWNrLnBvcCgpOwoKICAgIGlmICh0YWJsZSA9PT0gbnVsbCkgewogICAgICAvLyBUbyBiYWxhbmNlIHRoZSBwb3B7RnJhbWUsU2NvcGV9CiAgICAgIHZtLnB1c2hGcmFtZSgpOwogICAgICB2bS5wdXNoU2NvcGUoc2NvcGUpOyAvLyBDb3VsZCBiZSBudWxsIGJ1dCBpdCBkb2VzbnQgbWF0dGVyIGFzIGl0IGlzIGltbWVkaWF0ZWxseSBwb3BwZWQuCgogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGludm9raW5nU2NvcGUgPSBzY29wZTsgLy8gSWYgbmVjZXNzYXJ5LCBjcmVhdGUgYSBjaGlsZCBzY29wZQoKICAgIHsKICAgICAgdmFyIGxvY2FscyA9IHRhYmxlLnBhcmFtZXRlcnM7CiAgICAgIHZhciBsb2NhbHNDb3VudCA9IGxvY2Fscy5sZW5ndGg7CgogICAgICBpZiAobG9jYWxzQ291bnQgPiAwKSB7CiAgICAgICAgaW52b2tpbmdTY29wZSA9IGludm9raW5nU2NvcGUuY2hpbGQoKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsb2NhbHNDb3VudDsgaSsrKSB7CiAgICAgICAgICBpbnZva2luZ1Njb3BlLmJpbmRTeW1ib2wobG9jYWxzW2ldLCBhcmdzLmF0KGkpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHZtLnB1c2hGcmFtZSgpOwogICAgdm0ucHVzaFNjb3BlKGludm9raW5nU2NvcGUpOwogICAgdm0uY2FsbChoYW5kbGUpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg1MwogIC8qIEp1bXBJZiAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmMjApIHsKICAgIHZhciB0YXJnZXQgPSBfcmVmMjAub3AxOwogICAgdmFyIHJlZmVyZW5jZSA9IHZtLnN0YWNrLnBvcCgpOwoKICAgIGlmICgoMCwgX3JlZmVyZW5jZTIuaXNDb25zdCkocmVmZXJlbmNlKSkgewogICAgICBpZiAocmVmZXJlbmNlLnZhbHVlKCkpIHsKICAgICAgICB2bS5nb3RvKHRhcmdldCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBjYWNoZSA9IG5ldyBfcmVmZXJlbmNlMi5SZWZlcmVuY2VDYWNoZShyZWZlcmVuY2UpOwoKICAgICAgaWYgKGNhY2hlLnBlZWsoKSkgewogICAgICAgIHZtLmdvdG8odGFyZ2V0KTsKICAgICAgfQoKICAgICAgdm0udXBkYXRlV2l0aChuZXcgQXNzZXJ0KGNhY2hlKSk7CiAgICB9CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDU0CiAgLyogSnVtcFVubGVzcyAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmMjEpIHsKICAgIHZhciB0YXJnZXQgPSBfcmVmMjEub3AxOwogICAgdmFyIHJlZmVyZW5jZSA9IHZtLnN0YWNrLnBvcCgpOwoKICAgIGlmICgoMCwgX3JlZmVyZW5jZTIuaXNDb25zdCkocmVmZXJlbmNlKSkgewogICAgICBpZiAoIXJlZmVyZW5jZS52YWx1ZSgpKSB7CiAgICAgICAgdm0uZ290byh0YXJnZXQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgY2FjaGUgPSBuZXcgX3JlZmVyZW5jZTIuUmVmZXJlbmNlQ2FjaGUocmVmZXJlbmNlKTsKCiAgICAgIGlmICghY2FjaGUucGVlaygpKSB7CiAgICAgICAgdm0uZ290byh0YXJnZXQpOwogICAgICB9CgogICAgICB2bS51cGRhdGVXaXRoKG5ldyBBc3NlcnQoY2FjaGUpKTsKICAgIH0KICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoNTUKICAvKiBKdW1wRXEgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjIyKSB7CiAgICB2YXIgdGFyZ2V0ID0gX3JlZjIyLm9wMSwKICAgICAgICBjb21wYXJpc29uID0gX3JlZjIyLm9wMjsKICAgIHZhciBvdGhlciA9IHZtLnN0YWNrLnBlZWsoKTsKCiAgICBpZiAob3RoZXIgPT09IGNvbXBhcmlzb24pIHsKICAgICAgdm0uZ290byh0YXJnZXQpOwogICAgfQogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg1NgogIC8qIEFzc2VydFNhbWUgKi8KICAsIGZ1bmN0aW9uICh2bSkgewogICAgdmFyIHJlZmVyZW5jZSA9IHZtLnN0YWNrLnBlZWsoKTsKCiAgICBpZiAoISgwLCBfcmVmZXJlbmNlMi5pc0NvbnN0KShyZWZlcmVuY2UpKSB7CiAgICAgIHZtLnVwZGF0ZVdpdGgoQXNzZXJ0LmluaXRpYWxpemUobmV3IF9yZWZlcmVuY2UyLlJlZmVyZW5jZUNhY2hlKHJlZmVyZW5jZSkpKTsKICAgIH0KICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoNjMKICAvKiBUb0Jvb2xlYW4gKi8KICAsIGZ1bmN0aW9uICh2bSkgewogICAgdmFyIGVudiA9IHZtLmVudiwKICAgICAgICBzdGFjayA9IHZtLnN0YWNrOwogICAgc3RhY2sucHVzaChlbnYudG9Db25kaXRpb25hbFJlZmVyZW5jZShzdGFjay5wb3AoKSkpOwogIH0pOwoKICB2YXIgQXNzZXJ0ID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9VcGRhdGluZ09wY29kZTIpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShBc3NlcnQsIF9VcGRhdGluZ09wY29kZTIpOwoKICAgIGZ1bmN0aW9uIEFzc2VydChjYWNoZSkgewogICAgICB2YXIgX3RoaXM1OwoKICAgICAgX3RoaXM1ID0gX1VwZGF0aW5nT3Bjb2RlMi5jYWxsKHRoaXMpIHx8IHRoaXM7CiAgICAgIF90aGlzNS50eXBlID0gJ2Fzc2VydCc7CiAgICAgIF90aGlzNS50YWcgPSBjYWNoZS50YWc7CiAgICAgIF90aGlzNS5jYWNoZSA9IGNhY2hlOwogICAgICByZXR1cm4gX3RoaXM1OwogICAgfQoKICAgIEFzc2VydC5pbml0aWFsaXplID0gZnVuY3Rpb24gaW5pdGlhbGl6ZShjYWNoZSkgewogICAgICB2YXIgYXNzZXJ0ID0gbmV3IEFzc2VydChjYWNoZSk7CiAgICAgIGNhY2hlLnBlZWsoKTsKICAgICAgcmV0dXJuIGFzc2VydDsKICAgIH07CgogICAgdmFyIF9wcm90bzEwID0gQXNzZXJ0LnByb3RvdHlwZTsKCiAgICBfcHJvdG8xMC5ldmFsdWF0ZSA9IGZ1bmN0aW9uIGV2YWx1YXRlKHZtKSB7CiAgICAgIHZhciBjYWNoZSA9IHRoaXMuY2FjaGU7CgogICAgICBpZiAoKDAsIF9yZWZlcmVuY2UyLmlzTW9kaWZpZWQpKGNhY2hlLnJldmFsaWRhdGUoKSkpIHsKICAgICAgICB2bS50aHJvdygpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBBc3NlcnQ7CiAgfShVcGRhdGluZ09wY29kZSk7CgogIHZhciBKdW1wSWZOb3RNb2RpZmllZE9wY29kZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfVXBkYXRpbmdPcGNvZGUzKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoSnVtcElmTm90TW9kaWZpZWRPcGNvZGUsIF9VcGRhdGluZ09wY29kZTMpOwoKICAgIGZ1bmN0aW9uIEp1bXBJZk5vdE1vZGlmaWVkT3Bjb2RlKHRhZywgdGFyZ2V0KSB7CiAgICAgIHZhciBfdGhpczY7CgogICAgICBfdGhpczYgPSBfVXBkYXRpbmdPcGNvZGUzLmNhbGwodGhpcykgfHwgdGhpczsKICAgICAgX3RoaXM2LnRhcmdldCA9IHRhcmdldDsKICAgICAgX3RoaXM2LnR5cGUgPSAnanVtcC1pZi1ub3QtbW9kaWZpZWQnOwogICAgICBfdGhpczYudGFnID0gdGFnOwogICAgICBfdGhpczYubGFzdFJldmlzaW9uID0gKDAsIF9yZWZlcmVuY2UyLnZhbHVlKSh0YWcpOwogICAgICByZXR1cm4gX3RoaXM2OwogICAgfQoKICAgIHZhciBfcHJvdG8xMSA9IEp1bXBJZk5vdE1vZGlmaWVkT3Bjb2RlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8xMS5ldmFsdWF0ZSA9IGZ1bmN0aW9uIGV2YWx1YXRlKHZtKSB7CiAgICAgIHZhciB0YWcgPSB0aGlzLnRhZywKICAgICAgICAgIHRhcmdldCA9IHRoaXMudGFyZ2V0LAogICAgICAgICAgbGFzdFJldmlzaW9uID0gdGhpcy5sYXN0UmV2aXNpb247CgogICAgICBpZiAoIXZtLmFsd2F5c1JldmFsaWRhdGUgJiYgKDAsIF9yZWZlcmVuY2UyLnZhbGlkYXRlKSh0YWcsIGxhc3RSZXZpc2lvbikpIHsKICAgICAgICB2bS5nb3RvKHRhcmdldCk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMTEuZGlkTW9kaWZ5ID0gZnVuY3Rpb24gZGlkTW9kaWZ5KCkgewogICAgICB0aGlzLmxhc3RSZXZpc2lvbiA9ICgwLCBfcmVmZXJlbmNlMi52YWx1ZSkodGhpcy50YWcpOwogICAgfTsKCiAgICByZXR1cm4gSnVtcElmTm90TW9kaWZpZWRPcGNvZGU7CiAgfShVcGRhdGluZ09wY29kZSk7CgogIHZhciBEaWRNb2RpZnlPcGNvZGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX1VwZGF0aW5nT3Bjb2RlNCkgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKERpZE1vZGlmeU9wY29kZSwgX1VwZGF0aW5nT3Bjb2RlNCk7CgogICAgZnVuY3Rpb24gRGlkTW9kaWZ5T3Bjb2RlKHRhcmdldCkgewogICAgICB2YXIgX3RoaXM3OwoKICAgICAgX3RoaXM3ID0gX1VwZGF0aW5nT3Bjb2RlNC5jYWxsKHRoaXMpIHx8IHRoaXM7CiAgICAgIF90aGlzNy50YXJnZXQgPSB0YXJnZXQ7CiAgICAgIF90aGlzNy50eXBlID0gJ2RpZC1tb2RpZnknOwogICAgICBfdGhpczcudGFnID0gX3JlZmVyZW5jZTIuQ09OU1RBTlRfVEFHOwogICAgICByZXR1cm4gX3RoaXM3OwogICAgfQoKICAgIHZhciBfcHJvdG8xMiA9IERpZE1vZGlmeU9wY29kZS5wcm90b3R5cGU7CgogICAgX3Byb3RvMTIuZXZhbHVhdGUgPSBmdW5jdGlvbiBldmFsdWF0ZSgpIHsKICAgICAgdGhpcy50YXJnZXQuZGlkTW9kaWZ5KCk7CiAgICB9OwoKICAgIHJldHVybiBEaWRNb2RpZnlPcGNvZGU7CiAgfShVcGRhdGluZ09wY29kZSk7CgogIHZhciBMYWJlbE9wY29kZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIExhYmVsT3Bjb2RlKGxhYmVsKSB7CiAgICAgIHRoaXMudGFnID0gX3JlZmVyZW5jZTIuQ09OU1RBTlRfVEFHOwogICAgICB0aGlzLnR5cGUgPSAnbGFiZWwnOwogICAgICB0aGlzLmxhYmVsID0gbnVsbDsKICAgICAgdGhpcy5wcmV2ID0gbnVsbDsKICAgICAgdGhpcy5uZXh0ID0gbnVsbDsKICAgICAgKDAsIF91dGlsLmluaXRpYWxpemVHdWlkKSh0aGlzKTsKICAgICAgdGhpcy5sYWJlbCA9IGxhYmVsOwogICAgfQoKICAgIHZhciBfcHJvdG8xMyA9IExhYmVsT3Bjb2RlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8xMy5ldmFsdWF0ZSA9IGZ1bmN0aW9uIGV2YWx1YXRlKCkge307CgogICAgX3Byb3RvMTMuaW5zcGVjdCA9IGZ1bmN0aW9uIGluc3BlY3QoKSB7CiAgICAgIHJldHVybiB0aGlzLmxhYmVsICsgIiBbIiArIHRoaXMuX2d1aWQgKyAiXSI7CiAgICB9OwoKICAgIHJldHVybiBMYWJlbE9wY29kZTsKICB9KCk7CgogIEFQUEVORF9PUENPREVTLmFkZCgyNgogIC8qIFRleHQgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjIzKSB7CiAgICB2YXIgdGV4dCA9IF9yZWYyMy5vcDE7CiAgICB2bS5lbGVtZW50cygpLmFwcGVuZFRleHQodm0uY29uc3RhbnRzLmdldFN0cmluZyh0ZXh0KSk7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDI3CiAgLyogQ29tbWVudCAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmMjQpIHsKICAgIHZhciB0ZXh0ID0gX3JlZjI0Lm9wMTsKICAgIHZtLmVsZW1lbnRzKCkuYXBwZW5kQ29tbWVudCh2bS5jb25zdGFudHMuZ2V0U3RyaW5nKHRleHQpKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoMzMKICAvKiBPcGVuRWxlbWVudCAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmMjUpIHsKICAgIHZhciB0YWcgPSBfcmVmMjUub3AxOwogICAgdm0uZWxlbWVudHMoKS5vcGVuRWxlbWVudCh2bS5jb25zdGFudHMuZ2V0U3RyaW5nKHRhZykpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCgzNAogIC8qIE9wZW5EeW5hbWljRWxlbWVudCAqLwogICwgZnVuY3Rpb24gKHZtKSB7CiAgICB2YXIgdGFnTmFtZSA9IHZtLnN0YWNrLnBvcCgpLnZhbHVlKCk7CiAgICB2bS5lbGVtZW50cygpLm9wZW5FbGVtZW50KHRhZ05hbWUpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg0MQogIC8qIFB1c2hSZW1vdGVFbGVtZW50ICovCiAgLCBmdW5jdGlvbiAodm0pIHsKICAgIHZhciBlbGVtZW50UmVmID0gdm0uc3RhY2sucG9wKCk7CiAgICB2YXIgbmV4dFNpYmxpbmdSZWYgPSB2bS5zdGFjay5wb3AoKTsKICAgIHZhciBndWlkUmVmID0gdm0uc3RhY2sucG9wKCk7CiAgICB2YXIgZWxlbWVudDsKICAgIHZhciBuZXh0U2libGluZzsKICAgIHZhciBndWlkID0gZ3VpZFJlZi52YWx1ZSgpOwoKICAgIGlmICgoMCwgX3JlZmVyZW5jZTIuaXNDb25zdCkoZWxlbWVudFJlZikpIHsKICAgICAgZWxlbWVudCA9IGVsZW1lbnRSZWYudmFsdWUoKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBjYWNoZSA9IG5ldyBfcmVmZXJlbmNlMi5SZWZlcmVuY2VDYWNoZShlbGVtZW50UmVmKTsKICAgICAgZWxlbWVudCA9IGNhY2hlLnBlZWsoKTsKICAgICAgdm0udXBkYXRlV2l0aChuZXcgQXNzZXJ0KGNhY2hlKSk7CiAgICB9CgogICAgaWYgKCgwLCBfcmVmZXJlbmNlMi5pc0NvbnN0KShuZXh0U2libGluZ1JlZikpIHsKICAgICAgbmV4dFNpYmxpbmcgPSBuZXh0U2libGluZ1JlZi52YWx1ZSgpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIF9jYWNoZSA9IG5ldyBfcmVmZXJlbmNlMi5SZWZlcmVuY2VDYWNoZShuZXh0U2libGluZ1JlZik7CgogICAgICBuZXh0U2libGluZyA9IF9jYWNoZS5wZWVrKCk7CiAgICAgIHZtLnVwZGF0ZVdpdGgobmV3IEFzc2VydChfY2FjaGUpKTsKICAgIH0KCiAgICB2bS5lbGVtZW50cygpLnB1c2hSZW1vdGVFbGVtZW50KGVsZW1lbnQsIGd1aWQsIG5leHRTaWJsaW5nKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoNDIKICAvKiBQb3BSZW1vdGVFbGVtZW50ICovCiAgLCBmdW5jdGlvbiAodm0pIHsKICAgIHZtLmVsZW1lbnRzKCkucG9wUmVtb3RlRWxlbWVudCgpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCgzOAogIC8qIEZsdXNoRWxlbWVudCAqLwogICwgZnVuY3Rpb24gKHZtKSB7CiAgICB2YXIgb3BlcmF0aW9ucyA9IHZtLmZldGNoVmFsdWUoX3ZtMi5SZWdpc3Rlci50MCk7CiAgICB2YXIgbW9kaWZpZXJzID0gbnVsbDsKCiAgICBpZiAob3BlcmF0aW9ucykgewogICAgICBtb2RpZmllcnMgPSBvcGVyYXRpb25zLmZsdXNoKHZtKTsKICAgICAgdm0ubG9hZFZhbHVlKF92bTIuUmVnaXN0ZXIudDAsIG51bGwpOwogICAgfQoKICAgIHZtLmVsZW1lbnRzKCkuZmx1c2hFbGVtZW50KG1vZGlmaWVycyk7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDM5CiAgLyogQ2xvc2VFbGVtZW50ICovCiAgLCBmdW5jdGlvbiAodm0pIHsKICAgIHZhciBtb2RpZmllcnMgPSB2bS5lbGVtZW50cygpLmNsb3NlRWxlbWVudCgpOwoKICAgIGlmIChtb2RpZmllcnMpIHsKICAgICAgbW9kaWZpZXJzLmZvckVhY2goZnVuY3Rpb24gKF9yZWYyNikgewogICAgICAgIHZhciBtYW5hZ2VyID0gX3JlZjI2WzBdLAogICAgICAgICAgICBtb2RpZmllciA9IF9yZWYyNlsxXTsKICAgICAgICB2bS5lbnYuc2NoZWR1bGVJbnN0YWxsTW9kaWZpZXIobW9kaWZpZXIsIG1hbmFnZXIpOwogICAgICAgIHZhciBkZXN0cnVjdG9yID0gbWFuYWdlci5nZXREZXN0cnVjdG9yKG1vZGlmaWVyKTsKCiAgICAgICAgaWYgKGRlc3RydWN0b3IpIHsKICAgICAgICAgIHZtLm5ld0Rlc3Ryb3lhYmxlKGRlc3RydWN0b3IpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDQwCiAgLyogTW9kaWZpZXIgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjI3KSB7CiAgICB2YXIgaGFuZGxlID0gX3JlZjI3Lm9wMTsKCiAgICB2YXIgX3ZtJGNvbnN0YW50cyRyZXNvbHZlID0gdm0uY29uc3RhbnRzLnJlc29sdmVIYW5kbGUoaGFuZGxlKSwKICAgICAgICBtYW5hZ2VyID0gX3ZtJGNvbnN0YW50cyRyZXNvbHZlLm1hbmFnZXIsCiAgICAgICAgc3RhdGUgPSBfdm0kY29uc3RhbnRzJHJlc29sdmUuc3RhdGU7CgogICAgdmFyIHN0YWNrID0gdm0uc3RhY2s7CiAgICB2YXIgYXJncyA9IHN0YWNrLnBvcCgpOwoKICAgIHZhciBfdm0kZWxlbWVudHMgPSB2bS5lbGVtZW50cygpLAogICAgICAgIGNvbnN0cnVjdGluZyA9IF92bSRlbGVtZW50cy5jb25zdHJ1Y3RpbmcsCiAgICAgICAgdXBkYXRlT3BlcmF0aW9ucyA9IF92bSRlbGVtZW50cy51cGRhdGVPcGVyYXRpb25zOwoKICAgIHZhciBkeW5hbWljU2NvcGUgPSB2bS5keW5hbWljU2NvcGUoKTsKICAgIHZhciBtb2RpZmllciA9IG1hbmFnZXIuY3JlYXRlKGNvbnN0cnVjdGluZywgc3RhdGUsIGFyZ3MsIGR5bmFtaWNTY29wZSwgdXBkYXRlT3BlcmF0aW9ucyk7CiAgICB2YXIgb3BlcmF0aW9ucyA9IHZtLmZldGNoVmFsdWUoX3ZtMi5SZWdpc3Rlci50MCk7CiAgICBvcGVyYXRpb25zLmFkZE1vZGlmaWVyKG1hbmFnZXIsIG1vZGlmaWVyKTsKICAgIHZhciB0YWcgPSBtYW5hZ2VyLmdldFRhZyhtb2RpZmllcik7CgogICAgaWYgKCEoMCwgX3JlZmVyZW5jZTIuaXNDb25zdFRhZykodGFnKSkgewogICAgICB2bS51cGRhdGVXaXRoKG5ldyBVcGRhdGVNb2RpZmllck9wY29kZSh0YWcsIG1hbmFnZXIsIG1vZGlmaWVyKSk7CiAgICB9CiAgfSk7CgogIHZhciBVcGRhdGVNb2RpZmllck9wY29kZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfVXBkYXRpbmdPcGNvZGU1KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoVXBkYXRlTW9kaWZpZXJPcGNvZGUsIF9VcGRhdGluZ09wY29kZTUpOwoKICAgIGZ1bmN0aW9uIFVwZGF0ZU1vZGlmaWVyT3Bjb2RlKHRhZywgbWFuYWdlciwgbW9kaWZpZXIpIHsKICAgICAgdmFyIF90aGlzODsKCiAgICAgIF90aGlzOCA9IF9VcGRhdGluZ09wY29kZTUuY2FsbCh0aGlzKSB8fCB0aGlzOwogICAgICBfdGhpczgudGFnID0gdGFnOwogICAgICBfdGhpczgubWFuYWdlciA9IG1hbmFnZXI7CiAgICAgIF90aGlzOC5tb2RpZmllciA9IG1vZGlmaWVyOwogICAgICBfdGhpczgudHlwZSA9ICd1cGRhdGUtbW9kaWZpZXInOwogICAgICBfdGhpczgubGFzdFVwZGF0ZWQgPSAoMCwgX3JlZmVyZW5jZTIudmFsdWUpKHRhZyk7CiAgICAgIHJldHVybiBfdGhpczg7CiAgICB9CgogICAgdmFyIF9wcm90bzE0ID0gVXBkYXRlTW9kaWZpZXJPcGNvZGUucHJvdG90eXBlOwoKICAgIF9wcm90bzE0LmV2YWx1YXRlID0gZnVuY3Rpb24gZXZhbHVhdGUodm0pIHsKICAgICAgdmFyIG1hbmFnZXIgPSB0aGlzLm1hbmFnZXIsCiAgICAgICAgICBtb2RpZmllciA9IHRoaXMubW9kaWZpZXIsCiAgICAgICAgICB0YWcgPSB0aGlzLnRhZywKICAgICAgICAgIGxhc3RVcGRhdGVkID0gdGhpcy5sYXN0VXBkYXRlZDsKCiAgICAgIGlmICghKDAsIF9yZWZlcmVuY2UyLnZhbGlkYXRlKSh0YWcsIGxhc3RVcGRhdGVkKSkgewogICAgICAgIHZtLmVudi5zY2hlZHVsZVVwZGF0ZU1vZGlmaWVyKG1vZGlmaWVyLCBtYW5hZ2VyKTsKICAgICAgICB0aGlzLmxhc3RVcGRhdGVkID0gKDAsIF9yZWZlcmVuY2UyLnZhbHVlKSh0YWcpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBVcGRhdGVNb2RpZmllck9wY29kZTsKICB9KFVwZGF0aW5nT3Bjb2RlKTsKCiAgQVBQRU5EX09QQ09ERVMuYWRkKDM1CiAgLyogU3RhdGljQXR0ciAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmMjgpIHsKICAgIHZhciBfbmFtZSA9IF9yZWYyOC5vcDEsCiAgICAgICAgX3ZhbHVlID0gX3JlZjI4Lm9wMiwKICAgICAgICBfbmFtZXNwYWNlID0gX3JlZjI4Lm9wMzsKICAgIHZhciBuYW1lID0gdm0uY29uc3RhbnRzLmdldFN0cmluZyhfbmFtZSk7CiAgICB2YXIgdmFsdWUkJDEgPSB2bS5jb25zdGFudHMuZ2V0U3RyaW5nKF92YWx1ZSk7CiAgICB2YXIgbmFtZXNwYWNlID0gX25hbWVzcGFjZSA/IHZtLmNvbnN0YW50cy5nZXRTdHJpbmcoX25hbWVzcGFjZSkgOiBudWxsOwogICAgdm0uZWxlbWVudHMoKS5zZXRTdGF0aWNBdHRyaWJ1dGUobmFtZSwgdmFsdWUkJDEsIG5hbWVzcGFjZSk7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDM2CiAgLyogRHluYW1pY0F0dHIgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjI5KSB7CiAgICB2YXIgX25hbWUgPSBfcmVmMjkub3AxLAogICAgICAgIHRydXN0aW5nID0gX3JlZjI5Lm9wMiwKICAgICAgICBfbmFtZXNwYWNlID0gX3JlZjI5Lm9wMzsKICAgIHZhciBuYW1lID0gdm0uY29uc3RhbnRzLmdldFN0cmluZyhfbmFtZSk7CiAgICB2YXIgcmVmZXJlbmNlID0gdm0uc3RhY2sucG9wKCk7CiAgICB2YXIgdmFsdWUkJDEgPSByZWZlcmVuY2UudmFsdWUoKTsKICAgIHZhciBuYW1lc3BhY2UgPSBfbmFtZXNwYWNlID8gdm0uY29uc3RhbnRzLmdldFN0cmluZyhfbmFtZXNwYWNlKSA6IG51bGw7CiAgICB2YXIgYXR0cmlidXRlID0gdm0uZWxlbWVudHMoKS5zZXREeW5hbWljQXR0cmlidXRlKG5hbWUsIHZhbHVlJCQxLCAhIXRydXN0aW5nLCBuYW1lc3BhY2UpOwoKICAgIGlmICghKDAsIF9yZWZlcmVuY2UyLmlzQ29uc3QpKHJlZmVyZW5jZSkpIHsKICAgICAgdm0udXBkYXRlV2l0aChuZXcgVXBkYXRlRHluYW1pY0F0dHJpYnV0ZU9wY29kZShyZWZlcmVuY2UsIGF0dHJpYnV0ZSkpOwogICAgfQogIH0pOwoKICB2YXIgVXBkYXRlRHluYW1pY0F0dHJpYnV0ZU9wY29kZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfVXBkYXRpbmdPcGNvZGU2KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoVXBkYXRlRHluYW1pY0F0dHJpYnV0ZU9wY29kZSwgX1VwZGF0aW5nT3Bjb2RlNik7CgogICAgZnVuY3Rpb24gVXBkYXRlRHluYW1pY0F0dHJpYnV0ZU9wY29kZShyZWZlcmVuY2UsIGF0dHJpYnV0ZSkgewogICAgICB2YXIgX3RoaXM5OwoKICAgICAgX3RoaXM5ID0gX1VwZGF0aW5nT3Bjb2RlNi5jYWxsKHRoaXMpIHx8IHRoaXM7CiAgICAgIF90aGlzOS5yZWZlcmVuY2UgPSByZWZlcmVuY2U7CiAgICAgIF90aGlzOS5hdHRyaWJ1dGUgPSBhdHRyaWJ1dGU7CiAgICAgIF90aGlzOS50eXBlID0gJ3BhdGNoLWVsZW1lbnQnOwogICAgICB2YXIgdGFnID0gcmVmZXJlbmNlLnRhZzsKICAgICAgX3RoaXM5LnRhZyA9IHRhZzsKICAgICAgX3RoaXM5Lmxhc3RSZXZpc2lvbiA9ICgwLCBfcmVmZXJlbmNlMi52YWx1ZSkodGFnKTsKICAgICAgcmV0dXJuIF90aGlzOTsKICAgIH0KCiAgICB2YXIgX3Byb3RvMTUgPSBVcGRhdGVEeW5hbWljQXR0cmlidXRlT3Bjb2RlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8xNS5ldmFsdWF0ZSA9IGZ1bmN0aW9uIGV2YWx1YXRlKHZtKSB7CiAgICAgIHZhciBhdHRyaWJ1dGUgPSB0aGlzLmF0dHJpYnV0ZSwKICAgICAgICAgIHJlZmVyZW5jZSA9IHRoaXMucmVmZXJlbmNlLAogICAgICAgICAgdGFnID0gdGhpcy50YWc7CgogICAgICBpZiAoISgwLCBfcmVmZXJlbmNlMi52YWxpZGF0ZSkodGFnLCB0aGlzLmxhc3RSZXZpc2lvbikpIHsKICAgICAgICB0aGlzLmxhc3RSZXZpc2lvbiA9ICgwLCBfcmVmZXJlbmNlMi52YWx1ZSkodGFnKTsKICAgICAgICBhdHRyaWJ1dGUudXBkYXRlKHJlZmVyZW5jZS52YWx1ZSgpLCB2bS5lbnYpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBVcGRhdGVEeW5hbWljQXR0cmlidXRlT3Bjb2RlOwogIH0oVXBkYXRpbmdPcGNvZGUpOwoKICBmdW5jdGlvbiByZXNvbHZlQ29tcG9uZW50KHJlc29sdmVyLCBuYW1lLCBtZXRhKSB7CiAgICB2YXIgZGVmaW5pdGlvbiA9IHJlc29sdmVyLmxvb2t1cENvbXBvbmVudERlZmluaXRpb24obmFtZSwgbWV0YSk7CiAgICByZXR1cm4gZGVmaW5pdGlvbjsKICB9CgogIHZhciBDdXJyeUNvbXBvbmVudFJlZmVyZW5jZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEN1cnJ5Q29tcG9uZW50UmVmZXJlbmNlKGlubmVyLCByZXNvbHZlciwgbWV0YSwgYXJncykgewogICAgICB0aGlzLmlubmVyID0gaW5uZXI7CiAgICAgIHRoaXMucmVzb2x2ZXIgPSByZXNvbHZlcjsKICAgICAgdGhpcy5tZXRhID0gbWV0YTsKICAgICAgdGhpcy5hcmdzID0gYXJnczsKICAgICAgdGhpcy50YWcgPSBpbm5lci50YWc7CiAgICAgIHRoaXMubGFzdFZhbHVlID0gbnVsbDsKICAgICAgdGhpcy5sYXN0RGVmaW5pdGlvbiA9IG51bGw7CiAgICB9CgogICAgdmFyIF9wcm90bzE2ID0gQ3VycnlDb21wb25lbnRSZWZlcmVuY2UucHJvdG90eXBlOwoKICAgIF9wcm90bzE2LnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHZhciBpbm5lciA9IHRoaXMuaW5uZXIsCiAgICAgICAgICBsYXN0VmFsdWUgPSB0aGlzLmxhc3RWYWx1ZTsKICAgICAgdmFyIHZhbHVlJCQxID0gaW5uZXIudmFsdWUoKTsKCiAgICAgIGlmICh2YWx1ZSQkMSA9PT0gbGFzdFZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubGFzdERlZmluaXRpb247CiAgICAgIH0KCiAgICAgIHZhciBkZWZpbml0aW9uID0gbnVsbDsKCiAgICAgIGlmIChpc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uKHZhbHVlJCQxKSkgewogICAgICAgIGRlZmluaXRpb24gPSB2YWx1ZSQkMTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUkJDEgPT09ICdzdHJpbmcnICYmIHZhbHVlJCQxKSB7CiAgICAgICAgdmFyIHJlc29sdmVyID0gdGhpcy5yZXNvbHZlciwKICAgICAgICAgICAgbWV0YSA9IHRoaXMubWV0YTsKICAgICAgICBkZWZpbml0aW9uID0gcmVzb2x2ZUNvbXBvbmVudChyZXNvbHZlciwgdmFsdWUkJDEsIG1ldGEpOwogICAgICB9CgogICAgICBkZWZpbml0aW9uID0gdGhpcy5jdXJyeShkZWZpbml0aW9uKTsKICAgICAgdGhpcy5sYXN0VmFsdWUgPSB2YWx1ZSQkMTsKICAgICAgdGhpcy5sYXN0RGVmaW5pdGlvbiA9IGRlZmluaXRpb247CiAgICAgIHJldHVybiBkZWZpbml0aW9uOwogICAgfTsKCiAgICBfcHJvdG8xNi5nZXQgPSBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBVTkRFRklORURfUkVGRVJFTkNFOwogICAgfTsKCiAgICBfcHJvdG8xNi5jdXJyeSA9IGZ1bmN0aW9uIGN1cnJ5KGRlZmluaXRpb24pIHsKICAgICAgdmFyIGFyZ3MgPSB0aGlzLmFyZ3M7CgogICAgICBpZiAoIWFyZ3MgJiYgaXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbihkZWZpbml0aW9uKSkgewogICAgICAgIHJldHVybiBkZWZpbml0aW9uOwogICAgICB9IGVsc2UgaWYgKCFkZWZpbml0aW9uKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG5ldyBDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbihkZWZpbml0aW9uLCBhcmdzKTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gQ3VycnlDb21wb25lbnRSZWZlcmVuY2U7CiAgfSgpOwoKICB2YXIgQ2xhc3NMaXN0UmVmZXJlbmNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQ2xhc3NMaXN0UmVmZXJlbmNlKGxpc3QpIHsKICAgICAgdGhpcy5saXN0ID0gbGlzdDsKICAgICAgdGhpcy50YWcgPSAoMCwgX3JlZmVyZW5jZTIuY29tYmluZVRhZ2dlZCkobGlzdCk7CiAgICAgIHRoaXMubGlzdCA9IGxpc3Q7CiAgICB9CgogICAgdmFyIF9wcm90bzE3ID0gQ2xhc3NMaXN0UmVmZXJlbmNlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8xNy52YWx1ZSA9IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICB2YXIgcmV0ID0gW107CiAgICAgIHZhciBsaXN0ID0gdGhpcy5saXN0OwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIHZhbHVlJCQxID0gbm9ybWFsaXplU3RyaW5nVmFsdWUobGlzdFtpXS52YWx1ZSgpKTsKICAgICAgICBpZiAodmFsdWUkJDEpIHJldC5wdXNoKHZhbHVlJCQxKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJldC5sZW5ndGggPT09IDAgPyBudWxsIDogcmV0LmpvaW4oJyAnKTsKICAgIH07CgogICAgcmV0dXJuIENsYXNzTGlzdFJlZmVyZW5jZTsKICB9KCk7CiAgLyoqCiAgICogQ29udmVydHMgYSBDb21wb25lbnRDYXBhYmlsaXRpZXMgb2JqZWN0IGludG8gYSAzMi1iaXQgaW50ZWdlciByZXByZXNlbnRhdGlvbi4KICAgKi8KCgogIGZ1bmN0aW9uIGNhcGFiaWxpdHlGbGFnc0Zyb20oY2FwYWJpbGl0aWVzKSB7CiAgICByZXR1cm4gMCB8IChjYXBhYmlsaXRpZXMuZHluYW1pY0xheW91dCA/IDEKICAgIC8qIER5bmFtaWNMYXlvdXQgKi8KICAgIDogMCkgfCAoY2FwYWJpbGl0aWVzLmR5bmFtaWNUYWcgPyAyCiAgICAvKiBEeW5hbWljVGFnICovCiAgICA6IDApIHwgKGNhcGFiaWxpdGllcy5wcmVwYXJlQXJncyA/IDQKICAgIC8qIFByZXBhcmVBcmdzICovCiAgICA6IDApIHwgKGNhcGFiaWxpdGllcy5jcmVhdGVBcmdzID8gOAogICAgLyogQ3JlYXRlQXJncyAqLwogICAgOiAwKSB8IChjYXBhYmlsaXRpZXMuYXR0cmlidXRlSG9vayA/IDE2CiAgICAvKiBBdHRyaWJ1dGVIb29rICovCiAgICA6IDApIHwgKGNhcGFiaWxpdGllcy5lbGVtZW50SG9vayA/IDMyCiAgICAvKiBFbGVtZW50SG9vayAqLwogICAgOiAwKSB8IChjYXBhYmlsaXRpZXMuZHluYW1pY1Njb3BlID8gNjQKICAgIC8qIER5bmFtaWNTY29wZSAqLwogICAgOiAwKSB8IChjYXBhYmlsaXRpZXMuY3JlYXRlQ2FsbGVyID8gMTI4CiAgICAvKiBDcmVhdGVDYWxsZXIgKi8KICAgIDogMCkgfCAoY2FwYWJpbGl0aWVzLnVwZGF0ZUhvb2sgPyAyNTYKICAgIC8qIFVwZGF0ZUhvb2sgKi8KICAgIDogMCkgfCAoY2FwYWJpbGl0aWVzLmNyZWF0ZUluc3RhbmNlID8gNTEyCiAgICAvKiBDcmVhdGVJbnN0YW5jZSAqLwogICAgOiAwKTsKICB9CgogIGZ1bmN0aW9uIGhhc0NhcGFiaWxpdHkoY2FwYWJpbGl0aWVzLCBjYXBhYmlsaXR5KSB7CiAgICByZXR1cm4gISEoY2FwYWJpbGl0aWVzICYgY2FwYWJpbGl0eSk7CiAgfQoKICBBUFBFTkRfT1BDT0RFUy5hZGQoNjkKICAvKiBJc0NvbXBvbmVudCAqLwogICwgZnVuY3Rpb24gKHZtKSB7CiAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKICAgIHZhciByZWYgPSBzdGFjay5wb3AoKTsKICAgIHN0YWNrLnB1c2goSXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvblJlZmVyZW5jZS5jcmVhdGUocmVmKSk7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDcwCiAgLyogQ29udGVudFR5cGUgKi8KICAsIGZ1bmN0aW9uICh2bSkgewogICAgdmFyIHN0YWNrID0gdm0uc3RhY2s7CiAgICB2YXIgcmVmID0gc3RhY2sucGVlaygpOwogICAgc3RhY2sucHVzaChuZXcgQ29udGVudFR5cGVSZWZlcmVuY2UocmVmKSk7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDcxCiAgLyogQ3VycnlDb21wb25lbnQgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjMwKSB7CiAgICB2YXIgX21ldGEgPSBfcmVmMzAub3AxOwogICAgdmFyIHN0YWNrID0gdm0uc3RhY2s7CiAgICB2YXIgZGVmaW5pdGlvbiA9IHN0YWNrLnBvcCgpOwogICAgdmFyIGNhcHR1cmVkQXJncyA9IHN0YWNrLnBvcCgpOwogICAgdmFyIG1ldGEgPSB2bS5jb25zdGFudHMuZ2V0U2VyaWFsaXphYmxlKF9tZXRhKTsKICAgIHZhciByZXNvbHZlciA9IHZtLmNvbnN0YW50cy5yZXNvbHZlcjsKICAgIHZtLmxvYWRWYWx1ZShfdm0yLlJlZ2lzdGVyLnYwLCBuZXcgQ3VycnlDb21wb25lbnRSZWZlcmVuY2UoZGVmaW5pdGlvbiwgcmVzb2x2ZXIsIG1ldGEsIGNhcHR1cmVkQXJncykpOyAvLyBleHBlY3RTdGFja0NoYW5nZSh2bS5zdGFjaywgLWFyZ3MubGVuZ3RoIC0gMSwgJ0N1cnJ5Q29tcG9uZW50Jyk7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDcyCiAgLyogUHVzaENvbXBvbmVudERlZmluaXRpb24gKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjMxKSB7CiAgICB2YXIgaGFuZGxlID0gX3JlZjMxLm9wMTsKICAgIHZhciBkZWZpbml0aW9uID0gdm0uY29uc3RhbnRzLnJlc29sdmVIYW5kbGUoaGFuZGxlKTsKICAgIHZhciBtYW5hZ2VyID0gZGVmaW5pdGlvbi5tYW5hZ2VyOwogICAgdmFyIGNhcGFiaWxpdGllcyA9IGNhcGFiaWxpdHlGbGFnc0Zyb20obWFuYWdlci5nZXRDYXBhYmlsaXRpZXMoZGVmaW5pdGlvbi5zdGF0ZSkpOwogICAgdmFyIGluc3RhbmNlID0gewogICAgICBkZWZpbml0aW9uOiBkZWZpbml0aW9uLAogICAgICBtYW5hZ2VyOiBtYW5hZ2VyLAogICAgICBjYXBhYmlsaXRpZXM6IGNhcGFiaWxpdGllcywKICAgICAgc3RhdGU6IG51bGwsCiAgICAgIGhhbmRsZTogbnVsbCwKICAgICAgdGFibGU6IG51bGwsCiAgICAgIGxvb2t1cDogbnVsbAogICAgfTsKICAgIHZtLnN0YWNrLnB1c2goaW5zdGFuY2UpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg3NQogIC8qIFJlc29sdmVEeW5hbWljQ29tcG9uZW50ICovCiAgLCBmdW5jdGlvbiAodm0sIF9yZWYzMikgewogICAgdmFyIF9tZXRhID0gX3JlZjMyLm9wMTsKICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgdmFyIGNvbXBvbmVudCA9IHN0YWNrLnBvcCgpLnZhbHVlKCk7CiAgICB2YXIgbWV0YSA9IHZtLmNvbnN0YW50cy5nZXRTZXJpYWxpemFibGUoX21ldGEpOwogICAgdm0ubG9hZFZhbHVlKF92bTIuUmVnaXN0ZXIudDEsIG51bGwpOyAvLyBDbGVhciB0aGUgdGVtcCByZWdpc3RlcgoKICAgIHZhciBkZWZpbml0aW9uOwoKICAgIGlmICh0eXBlb2YgY29tcG9uZW50ID09PSAnc3RyaW5nJykgewogICAgICB2YXIgcmVzb2x2ZXIgPSB2bS5jb25zdGFudHMucmVzb2x2ZXI7CiAgICAgIHZhciByZXNvbHZlZERlZmluaXRpb24gPSByZXNvbHZlQ29tcG9uZW50KHJlc29sdmVyLCBjb21wb25lbnQsIG1ldGEpOwogICAgICBkZWZpbml0aW9uID0gcmVzb2x2ZWREZWZpbml0aW9uOwogICAgfSBlbHNlIGlmIChpc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uKGNvbXBvbmVudCkpIHsKICAgICAgZGVmaW5pdGlvbiA9IGNvbXBvbmVudDsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93ICgwLCBfdXRpbC51bnJlYWNoYWJsZSkoKTsKICAgIH0KCiAgICBzdGFjay5wdXNoKGRlZmluaXRpb24pOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg3MwogIC8qIFB1c2hEeW5hbWljQ29tcG9uZW50SW5zdGFuY2UgKi8KICAsIGZ1bmN0aW9uICh2bSkgewogICAgdmFyIHN0YWNrID0gdm0uc3RhY2s7CiAgICB2YXIgZGVmaW5pdGlvbiA9IHN0YWNrLnBvcCgpOwogICAgdmFyIGNhcGFiaWxpdGllcywgbWFuYWdlcjsKCiAgICBpZiAoaXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbihkZWZpbml0aW9uKSkgewogICAgICBtYW5hZ2VyID0gY2FwYWJpbGl0aWVzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1hbmFnZXIgPSBkZWZpbml0aW9uLm1hbmFnZXI7CiAgICAgIGNhcGFiaWxpdGllcyA9IGNhcGFiaWxpdHlGbGFnc0Zyb20obWFuYWdlci5nZXRDYXBhYmlsaXRpZXMoZGVmaW5pdGlvbi5zdGF0ZSkpOwogICAgfQoKICAgIHN0YWNrLnB1c2goewogICAgICBkZWZpbml0aW9uOiBkZWZpbml0aW9uLAogICAgICBjYXBhYmlsaXRpZXM6IGNhcGFiaWxpdGllcywKICAgICAgbWFuYWdlcjogbWFuYWdlciwKICAgICAgc3RhdGU6IG51bGwsCiAgICAgIGhhbmRsZTogbnVsbCwKICAgICAgdGFibGU6IG51bGwKICAgIH0pOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg3NAogIC8qIFB1c2hDdXJyaWVkQ29tcG9uZW50ICovCiAgLCBmdW5jdGlvbiAodm0sIF9yZWYzMykgewogICAgKDAsIF9lbWJlckJhYmVsLm9iamVjdERlc3RydWN0dXJpbmdFbXB0eSkoX3JlZjMzKTsKICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgdmFyIGNvbXBvbmVudCA9IHN0YWNrLnBvcCgpLnZhbHVlKCk7CiAgICB2YXIgZGVmaW5pdGlvbjsKCiAgICBpZiAoaXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbihjb21wb25lbnQpKSB7CiAgICAgIGRlZmluaXRpb24gPSBjb21wb25lbnQ7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyAoMCwgX3V0aWwudW5yZWFjaGFibGUpKCk7CiAgICB9CgogICAgc3RhY2sucHVzaChkZWZpbml0aW9uKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoNzYKICAvKiBQdXNoQXJncyAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmMzQpIHsKICAgIHZhciBfbmFtZXMgPSBfcmVmMzQub3AxLAogICAgICAgIGZsYWdzID0gX3JlZjM0Lm9wMjsKICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgdmFyIG5hbWVzID0gdm0uY29uc3RhbnRzLmdldFN0cmluZ0FycmF5KF9uYW1lcyk7CiAgICB2YXIgcG9zaXRpb25hbENvdW50ID0gZmxhZ3MgPj4gNDsKICAgIHZhciBzeW50aGV0aWMgPSBmbGFncyAmIDg7CiAgICB2YXIgYmxvY2tOYW1lcyA9IFtdOwogICAgaWYgKGZsYWdzICYgNCkgYmxvY2tOYW1lcy5wdXNoKCdtYWluJyk7CiAgICBpZiAoZmxhZ3MgJiAyKSBibG9ja05hbWVzLnB1c2goJ2Vsc2UnKTsKICAgIGlmIChmbGFncyAmIDEpIGJsb2NrTmFtZXMucHVzaCgnYXR0cnMnKTsKICAgIHZtLmFyZ3Muc2V0dXAoc3RhY2ssIG5hbWVzLCBibG9ja05hbWVzLCBwb3NpdGlvbmFsQ291bnQsICEhc3ludGhldGljKTsKICAgIHN0YWNrLnB1c2godm0uYXJncyk7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDc3CiAgLyogUHVzaEVtcHR5QXJncyAqLwogICwgZnVuY3Rpb24gKHZtKSB7CiAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKICAgIHN0YWNrLnB1c2godm0uYXJncy5lbXB0eShzdGFjaykpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg4MAogIC8qIENhcHR1cmVBcmdzICovCiAgLCBmdW5jdGlvbiAodm0pIHsKICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgdmFyIGFyZ3MgPSBzdGFjay5wb3AoKTsKICAgIHZhciBjYXB0dXJlZEFyZ3MgPSBhcmdzLmNhcHR1cmUoKTsKICAgIHN0YWNrLnB1c2goY2FwdHVyZWRBcmdzKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoNzkKICAvKiBQcmVwYXJlQXJncyAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmMzUpIHsKICAgIHZhciBfc3RhdGUgPSBfcmVmMzUub3AxOwogICAgdmFyIHN0YWNrID0gdm0uc3RhY2s7CiAgICB2YXIgaW5zdGFuY2UgPSB2bS5mZXRjaFZhbHVlKF9zdGF0ZSk7CiAgICB2YXIgYXJncyA9IHN0YWNrLnBvcCgpOwogICAgdmFyIGRlZmluaXRpb24gPSBpbnN0YW5jZS5kZWZpbml0aW9uOwoKICAgIGlmIChpc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uKGRlZmluaXRpb24pKSB7CiAgICAgIGRlZmluaXRpb24gPSByZXNvbHZlQ3VycmllZENvbXBvbmVudERlZmluaXRpb24oaW5zdGFuY2UsIGRlZmluaXRpb24sIGFyZ3MpOwogICAgfQoKICAgIHZhciBfZGVmaW5pdGlvbjIgPSBkZWZpbml0aW9uLAogICAgICAgIG1hbmFnZXIgPSBfZGVmaW5pdGlvbjIubWFuYWdlciwKICAgICAgICBzdGF0ZSA9IF9kZWZpbml0aW9uMi5zdGF0ZTsKICAgIHZhciBjYXBhYmlsaXRpZXMgPSBpbnN0YW5jZS5jYXBhYmlsaXRpZXM7CgogICAgaWYgKGhhc0NhcGFiaWxpdHkoY2FwYWJpbGl0aWVzLCA0CiAgICAvKiBQcmVwYXJlQXJncyAqLwogICAgKSAhPT0gdHJ1ZSkgewogICAgICBzdGFjay5wdXNoKGFyZ3MpOwogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGJsb2NrcyA9IGFyZ3MuYmxvY2tzLnZhbHVlczsKICAgIHZhciBibG9ja05hbWVzID0gYXJncy5ibG9ja3MubmFtZXM7CiAgICB2YXIgcHJlcGFyZWRBcmdzID0gbWFuYWdlci5wcmVwYXJlQXJncyhzdGF0ZSwgYXJncyk7CgogICAgaWYgKHByZXBhcmVkQXJncykgewogICAgICBhcmdzLmNsZWFyKCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJsb2Nrcy5sZW5ndGg7IGkrKykgewogICAgICAgIHN0YWNrLnB1c2goYmxvY2tzW2ldKTsKICAgICAgfQoKICAgICAgdmFyIHBvc2l0aW9uYWwgPSBwcmVwYXJlZEFyZ3MucG9zaXRpb25hbCwKICAgICAgICAgIG5hbWVkID0gcHJlcGFyZWRBcmdzLm5hbWVkOwogICAgICB2YXIgcG9zaXRpb25hbENvdW50ID0gcG9zaXRpb25hbC5sZW5ndGg7CgogICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgcG9zaXRpb25hbENvdW50OyBfaSsrKSB7CiAgICAgICAgc3RhY2sucHVzaChwb3NpdGlvbmFsW19pXSk7CiAgICAgIH0KCiAgICAgIHZhciBuYW1lcyA9IE9iamVjdC5rZXlzKG5hbWVkKTsKCiAgICAgIGZvciAodmFyIF9pMiA9IDA7IF9pMiA8IG5hbWVzLmxlbmd0aDsgX2kyKyspIHsKICAgICAgICBzdGFjay5wdXNoKG5hbWVkW25hbWVzW19pMl1dKTsKICAgICAgfQoKICAgICAgYXJncy5zZXR1cChzdGFjaywgbmFtZXMsIGJsb2NrTmFtZXMsIHBvc2l0aW9uYWxDb3VudCwgdHJ1ZSk7CiAgICB9CgogICAgc3RhY2sucHVzaChhcmdzKTsKICB9KTsKCiAgZnVuY3Rpb24gcmVzb2x2ZUN1cnJpZWRDb21wb25lbnREZWZpbml0aW9uKGluc3RhbmNlLCBkZWZpbml0aW9uLCBhcmdzKSB7CiAgICB2YXIgdW53cmFwcGVkRGVmaW5pdGlvbiA9IGluc3RhbmNlLmRlZmluaXRpb24gPSBkZWZpbml0aW9uLnVud3JhcChhcmdzKTsKICAgIHZhciBtYW5hZ2VyID0gdW53cmFwcGVkRGVmaW5pdGlvbi5tYW5hZ2VyLAogICAgICAgIHN0YXRlID0gdW53cmFwcGVkRGVmaW5pdGlvbi5zdGF0ZTsKICAgIGluc3RhbmNlLm1hbmFnZXIgPSBtYW5hZ2VyOwogICAgaW5zdGFuY2UuY2FwYWJpbGl0aWVzID0gY2FwYWJpbGl0eUZsYWdzRnJvbShtYW5hZ2VyLmdldENhcGFiaWxpdGllcyhzdGF0ZSkpOwogICAgcmV0dXJuIHVud3JhcHBlZERlZmluaXRpb247CiAgfQoKICBBUFBFTkRfT1BDT0RFUy5hZGQoODEKICAvKiBDcmVhdGVDb21wb25lbnQgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjM2KSB7CiAgICB2YXIgZmxhZ3MgPSBfcmVmMzYub3AxLAogICAgICAgIF9zdGF0ZSA9IF9yZWYzNi5vcDI7CiAgICB2YXIgaW5zdGFuY2UgPSB2bS5mZXRjaFZhbHVlKF9zdGF0ZSk7CiAgICB2YXIgZGVmaW5pdGlvbiA9IGluc3RhbmNlLmRlZmluaXRpb24sCiAgICAgICAgbWFuYWdlciA9IGluc3RhbmNlLm1hbmFnZXI7CiAgICB2YXIgY2FwYWJpbGl0aWVzID0gaW5zdGFuY2UuY2FwYWJpbGl0aWVzID0gY2FwYWJpbGl0eUZsYWdzRnJvbShtYW5hZ2VyLmdldENhcGFiaWxpdGllcyhkZWZpbml0aW9uLnN0YXRlKSk7CiAgICB2YXIgZHluYW1pY1Njb3BlID0gbnVsbDsKCiAgICBpZiAoaGFzQ2FwYWJpbGl0eShjYXBhYmlsaXRpZXMsIDY0CiAgICAvKiBEeW5hbWljU2NvcGUgKi8KICAgICkpIHsKICAgICAgZHluYW1pY1Njb3BlID0gdm0uZHluYW1pY1Njb3BlKCk7CiAgICB9CgogICAgdmFyIGhhc0RlZmF1bHRCbG9jayA9IGZsYWdzICYgMTsKICAgIHZhciBhcmdzID0gbnVsbDsKCiAgICBpZiAoaGFzQ2FwYWJpbGl0eShjYXBhYmlsaXRpZXMsIDgKICAgIC8qIENyZWF0ZUFyZ3MgKi8KICAgICkpIHsKICAgICAgYXJncyA9IHZtLnN0YWNrLnBlZWsoKTsKICAgIH0KCiAgICB2YXIgc2VsZiA9IG51bGw7CgogICAgaWYgKGhhc0NhcGFiaWxpdHkoY2FwYWJpbGl0aWVzLCAxMjgKICAgIC8qIENyZWF0ZUNhbGxlciAqLwogICAgKSkgewogICAgICBzZWxmID0gdm0uZ2V0U2VsZigpOwogICAgfQoKICAgIHZhciBzdGF0ZSA9IG1hbmFnZXIuY3JlYXRlKHZtLmVudiwgZGVmaW5pdGlvbi5zdGF0ZSwgYXJncywgZHluYW1pY1Njb3BlLCBzZWxmLCAhIWhhc0RlZmF1bHRCbG9jayk7IC8vIFdlIHdhbnQgdG8gcmV1c2UgdGhlIGBzdGF0ZWAgUE9KTyBoZXJlLCBiZWNhdXNlIHdlIGtub3cgdGhhdCB0aGUgb3Bjb2RlcwogICAgLy8gb25seSB0cmFuc2l0aW9uIGF0IGV4YWN0bHkgb25lIHBsYWNlLgoKICAgIGluc3RhbmNlLnN0YXRlID0gc3RhdGU7CiAgICB2YXIgdGFnID0gbWFuYWdlci5nZXRUYWcoc3RhdGUpOwoKICAgIGlmIChoYXNDYXBhYmlsaXR5KGNhcGFiaWxpdGllcywgMjU2CiAgICAvKiBVcGRhdGVIb29rICovCiAgICApICYmICEoMCwgX3JlZmVyZW5jZTIuaXNDb25zdFRhZykodGFnKSkgewogICAgICB2bS51cGRhdGVXaXRoKG5ldyBVcGRhdGVDb21wb25lbnRPcGNvZGUodGFnLCBzdGF0ZSwgbWFuYWdlciwgZHluYW1pY1Njb3BlKSk7CiAgICB9CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDgyCiAgLyogUmVnaXN0ZXJDb21wb25lbnREZXN0cnVjdG9yICovCiAgLCBmdW5jdGlvbiAodm0sIF9yZWYzNykgewogICAgdmFyIF9zdGF0ZSA9IF9yZWYzNy5vcDE7CgogICAgdmFyIF92bSRmZXRjaFZhbHVlID0gdm0uZmV0Y2hWYWx1ZShfc3RhdGUpLAogICAgICAgIG1hbmFnZXIgPSBfdm0kZmV0Y2hWYWx1ZS5tYW5hZ2VyLAogICAgICAgIHN0YXRlID0gX3ZtJGZldGNoVmFsdWUuc3RhdGU7CgogICAgdmFyIGRlc3RydWN0b3IgPSBtYW5hZ2VyLmdldERlc3RydWN0b3Ioc3RhdGUpOwogICAgaWYgKGRlc3RydWN0b3IpIHZtLm5ld0Rlc3Ryb3lhYmxlKGRlc3RydWN0b3IpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg5MQogIC8qIEJlZ2luQ29tcG9uZW50VHJhbnNhY3Rpb24gKi8KICAsIGZ1bmN0aW9uICh2bSkgewogICAgdm0uYmVnaW5DYWNoZUdyb3VwKCk7CiAgICB2bS5lbGVtZW50cygpLnB1c2hTaW1wbGVCbG9jaygpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg4MwogIC8qIFB1dENvbXBvbmVudE9wZXJhdGlvbnMgKi8KICAsIGZ1bmN0aW9uICh2bSkgewogICAgdm0ubG9hZFZhbHVlKF92bTIuUmVnaXN0ZXIudDAsIG5ldyBDb21wb25lbnRFbGVtZW50T3BlcmF0aW9ucygpKTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoMzcKICAvKiBDb21wb25lbnRBdHRyICovCiAgLCBmdW5jdGlvbiAodm0sIF9yZWYzOCkgewogICAgdmFyIF9uYW1lID0gX3JlZjM4Lm9wMSwKICAgICAgICB0cnVzdGluZyA9IF9yZWYzOC5vcDIsCiAgICAgICAgX25hbWVzcGFjZSA9IF9yZWYzOC5vcDM7CiAgICB2YXIgbmFtZSA9IHZtLmNvbnN0YW50cy5nZXRTdHJpbmcoX25hbWUpOwogICAgdmFyIHJlZmVyZW5jZSA9IHZtLnN0YWNrLnBvcCgpOwogICAgdmFyIG5hbWVzcGFjZSA9IF9uYW1lc3BhY2UgPyB2bS5jb25zdGFudHMuZ2V0U3RyaW5nKF9uYW1lc3BhY2UpIDogbnVsbDsKICAgIHZtLmZldGNoVmFsdWUoX3ZtMi5SZWdpc3Rlci50MCkuc2V0QXR0cmlidXRlKG5hbWUsIHJlZmVyZW5jZSwgISF0cnVzdGluZywgbmFtZXNwYWNlKTsKICB9KTsKCiAgdmFyIENvbXBvbmVudEVsZW1lbnRPcGVyYXRpb25zID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQ29tcG9uZW50RWxlbWVudE9wZXJhdGlvbnMoKSB7CiAgICAgIHRoaXMuYXR0cmlidXRlcyA9ICgwLCBfdXRpbC5kaWN0KSgpOwogICAgICB0aGlzLmNsYXNzZXMgPSBbXTsKICAgICAgdGhpcy5tb2RpZmllcnMgPSBbXTsKICAgIH0KCiAgICB2YXIgX3Byb3RvMTggPSBDb21wb25lbnRFbGVtZW50T3BlcmF0aW9ucy5wcm90b3R5cGU7CgogICAgX3Byb3RvMTguc2V0QXR0cmlidXRlID0gZnVuY3Rpb24gc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlJCQxLCB0cnVzdGluZywgbmFtZXNwYWNlKSB7CiAgICAgIHZhciBkZWZlcnJlZCA9IHsKICAgICAgICB2YWx1ZTogdmFsdWUkJDEsCiAgICAgICAgbmFtZXNwYWNlOiBuYW1lc3BhY2UsCiAgICAgICAgdHJ1c3Rpbmc6IHRydXN0aW5nCiAgICAgIH07CgogICAgICBpZiAobmFtZSA9PT0gJ2NsYXNzJykgewogICAgICAgIHRoaXMuY2xhc3Nlcy5wdXNoKHZhbHVlJCQxKTsKICAgICAgfQoKICAgICAgdGhpcy5hdHRyaWJ1dGVzW25hbWVdID0gZGVmZXJyZWQ7CiAgICB9OwoKICAgIF9wcm90bzE4LmFkZE1vZGlmaWVyID0gZnVuY3Rpb24gYWRkTW9kaWZpZXIobWFuYWdlciwgbW9kaWZpZXIpIHsKICAgICAgdGhpcy5tb2RpZmllcnMucHVzaChbbWFuYWdlciwgbW9kaWZpZXJdKTsKICAgIH07CgogICAgX3Byb3RvMTguZmx1c2ggPSBmdW5jdGlvbiBmbHVzaCh2bSkgewogICAgICBmb3IgKHZhciBuYW1lIGluIHRoaXMuYXR0cmlidXRlcykgewogICAgICAgIHZhciBhdHRyID0gdGhpcy5hdHRyaWJ1dGVzW25hbWVdOwogICAgICAgIHZhciByZWZlcmVuY2UgPSBhdHRyLnZhbHVlLAogICAgICAgICAgICBuYW1lc3BhY2UgPSBhdHRyLm5hbWVzcGFjZSwKICAgICAgICAgICAgdHJ1c3RpbmcgPSBhdHRyLnRydXN0aW5nOwoKICAgICAgICBpZiAobmFtZSA9PT0gJ2NsYXNzJykgewogICAgICAgICAgcmVmZXJlbmNlID0gbmV3IENsYXNzTGlzdFJlZmVyZW5jZSh0aGlzLmNsYXNzZXMpOwogICAgICAgIH0KCiAgICAgICAgaWYgKG5hbWUgPT09ICd0eXBlJykgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgYXR0cmlidXRlID0gdm0uZWxlbWVudHMoKS5zZXREeW5hbWljQXR0cmlidXRlKG5hbWUsIHJlZmVyZW5jZS52YWx1ZSgpLCB0cnVzdGluZywgbmFtZXNwYWNlKTsKCiAgICAgICAgaWYgKCEoMCwgX3JlZmVyZW5jZTIuaXNDb25zdCkocmVmZXJlbmNlKSkgewogICAgICAgICAgdm0udXBkYXRlV2l0aChuZXcgVXBkYXRlRHluYW1pY0F0dHJpYnV0ZU9wY29kZShyZWZlcmVuY2UsIGF0dHJpYnV0ZSkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCd0eXBlJyBpbiB0aGlzLmF0dHJpYnV0ZXMpIHsKICAgICAgICB2YXIgdHlwZSA9IHRoaXMuYXR0cmlidXRlcy50eXBlOwogICAgICAgIHZhciBfcmVmZXJlbmNlID0gdHlwZS52YWx1ZSwKICAgICAgICAgICAgX25hbWVzcGFjZTIgPSB0eXBlLm5hbWVzcGFjZSwKICAgICAgICAgICAgX3RydXN0aW5nID0gdHlwZS50cnVzdGluZzsKCiAgICAgICAgdmFyIF9hdHRyaWJ1dGUgPSB2bS5lbGVtZW50cygpLnNldER5bmFtaWNBdHRyaWJ1dGUoJ3R5cGUnLCBfcmVmZXJlbmNlLnZhbHVlKCksIF90cnVzdGluZywgX25hbWVzcGFjZTIpOwoKICAgICAgICBpZiAoISgwLCBfcmVmZXJlbmNlMi5pc0NvbnN0KShfcmVmZXJlbmNlKSkgewogICAgICAgICAgdm0udXBkYXRlV2l0aChuZXcgVXBkYXRlRHluYW1pY0F0dHJpYnV0ZU9wY29kZShfcmVmZXJlbmNlLCBfYXR0cmlidXRlKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5tb2RpZmllcnM7CiAgICB9OwoKICAgIHJldHVybiBDb21wb25lbnRFbGVtZW50T3BlcmF0aW9uczsKICB9KCk7CgogIEFQUEVORF9PUENPREVTLmFkZCg5MwogIC8qIERpZENyZWF0ZUVsZW1lbnQgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjM5KSB7CiAgICB2YXIgX3N0YXRlID0gX3JlZjM5Lm9wMTsKCiAgICB2YXIgX3ZtJGZldGNoVmFsdWUyID0gdm0uZmV0Y2hWYWx1ZShfc3RhdGUpLAogICAgICAgIGRlZmluaXRpb24gPSBfdm0kZmV0Y2hWYWx1ZTIuZGVmaW5pdGlvbiwKICAgICAgICBzdGF0ZSA9IF92bSRmZXRjaFZhbHVlMi5zdGF0ZTsKCiAgICB2YXIgbWFuYWdlciA9IGRlZmluaXRpb24ubWFuYWdlcjsKICAgIHZhciBvcGVyYXRpb25zID0gdm0uZmV0Y2hWYWx1ZShfdm0yLlJlZ2lzdGVyLnQwKTsKICAgIHZhciBhY3Rpb24gPSAnRGlkQ3JlYXRlRWxlbWVudE9wY29kZSNldmFsdWF0ZSc7CiAgICBtYW5hZ2VyLmRpZENyZWF0ZUVsZW1lbnQoc3RhdGUsIHZtLmVsZW1lbnRzKCkuZXhwZWN0Q29uc3RydWN0aW5nKGFjdGlvbiksIG9wZXJhdGlvbnMpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg4NAogIC8qIEdldENvbXBvbmVudFNlbGYgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjQwKSB7CiAgICB2YXIgX3N0YXRlID0gX3JlZjQwLm9wMTsKCiAgICB2YXIgX3ZtJGZldGNoVmFsdWUzID0gdm0uZmV0Y2hWYWx1ZShfc3RhdGUpLAogICAgICAgIGRlZmluaXRpb24gPSBfdm0kZmV0Y2hWYWx1ZTMuZGVmaW5pdGlvbiwKICAgICAgICBzdGF0ZSA9IF92bSRmZXRjaFZhbHVlMy5zdGF0ZTsKCiAgICB2YXIgbWFuYWdlciA9IGRlZmluaXRpb24ubWFuYWdlcjsKICAgIHZtLnN0YWNrLnB1c2gobWFuYWdlci5nZXRTZWxmKHN0YXRlKSk7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDg1CiAgLyogR2V0Q29tcG9uZW50VGFnTmFtZSAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmNDEpIHsKICAgIHZhciBfc3RhdGUgPSBfcmVmNDEub3AxOwoKICAgIHZhciBfdm0kZmV0Y2hWYWx1ZTQgPSB2bS5mZXRjaFZhbHVlKF9zdGF0ZSksCiAgICAgICAgZGVmaW5pdGlvbiA9IF92bSRmZXRjaFZhbHVlNC5kZWZpbml0aW9uLAogICAgICAgIHN0YXRlID0gX3ZtJGZldGNoVmFsdWU0LnN0YXRlOwoKICAgIHZhciBtYW5hZ2VyID0gZGVmaW5pdGlvbi5tYW5hZ2VyOwogICAgdm0uc3RhY2sucHVzaChtYW5hZ2VyLmdldFRhZ05hbWUoc3RhdGUpKTsKICB9KTsgLy8gRHluYW1pYyBJbnZvY2F0aW9uIE9ubHkKCiAgQVBQRU5EX09QQ09ERVMuYWRkKDg2CiAgLyogR2V0Q29tcG9uZW50TGF5b3V0ICovCiAgLCBmdW5jdGlvbiAodm0sIF9yZWY0MikgewogICAgdmFyIF9zdGF0ZSA9IF9yZWY0Mi5vcDE7CiAgICB2YXIgaW5zdGFuY2UgPSB2bS5mZXRjaFZhbHVlKF9zdGF0ZSk7CiAgICB2YXIgbWFuYWdlciA9IGluc3RhbmNlLm1hbmFnZXIsCiAgICAgICAgZGVmaW5pdGlvbiA9IGluc3RhbmNlLmRlZmluaXRpb247CiAgICB2YXIgcmVzb2x2ZXIgPSB2bS5jb25zdGFudHMucmVzb2x2ZXIsCiAgICAgICAgc3RhY2sgPSB2bS5zdGFjazsKICAgIHZhciBpbnN0YW5jZVN0YXRlID0gaW5zdGFuY2Uuc3RhdGUsCiAgICAgICAgY2FwYWJpbGl0aWVzID0gaW5zdGFuY2UuY2FwYWJpbGl0aWVzOwogICAgdmFyIGRlZmluaXRpb25TdGF0ZSA9IGRlZmluaXRpb24uc3RhdGU7CiAgICB2YXIgaW52b2tlOwoKICAgIGlmIChoYXNTdGF0aWNMYXlvdXRDYXBhYmlsaXR5KGNhcGFiaWxpdGllcywgbWFuYWdlcikpIHsKICAgICAgaW52b2tlID0gbWFuYWdlci5nZXRMYXlvdXQoZGVmaW5pdGlvblN0YXRlLCByZXNvbHZlcik7CiAgICB9IGVsc2UgaWYgKGhhc0R5bmFtaWNMYXlvdXRDYXBhYmlsaXR5KGNhcGFiaWxpdGllcywgbWFuYWdlcikpIHsKICAgICAgaW52b2tlID0gbWFuYWdlci5nZXREeW5hbWljTGF5b3V0KGluc3RhbmNlU3RhdGUsIHJlc29sdmVyKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93ICgwLCBfdXRpbC51bnJlYWNoYWJsZSkoKTsKICAgIH0KCiAgICBzdGFjay5wdXNoKGludm9rZS5zeW1ib2xUYWJsZSk7CiAgICBzdGFjay5wdXNoKGludm9rZS5oYW5kbGUpOwogIH0pOwoKICBmdW5jdGlvbiBoYXNTdGF0aWNMYXlvdXRDYXBhYmlsaXR5KGNhcGFiaWxpdGllcywgX21hbmFnZXIpIHsKICAgIHJldHVybiBoYXNDYXBhYmlsaXR5KGNhcGFiaWxpdGllcywgMQogICAgLyogRHluYW1pY0xheW91dCAqLwogICAgKSA9PT0gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBoYXNEeW5hbWljTGF5b3V0Q2FwYWJpbGl0eShjYXBhYmlsaXRpZXMsIF9tYW5hZ2VyKSB7CiAgICByZXR1cm4gaGFzQ2FwYWJpbGl0eShjYXBhYmlsaXRpZXMsIDEKICAgIC8qIER5bmFtaWNMYXlvdXQgKi8KICAgICkgPT09IHRydWU7CiAgfQoKICBBUFBFTkRfT1BDT0RFUy5hZGQoNjgKICAvKiBNYWluICovCiAgLCBmdW5jdGlvbiAodm0sIF9yZWY0MykgewogICAgdmFyIHJlZ2lzdGVyID0gX3JlZjQzLm9wMTsKICAgIHZhciBkZWZpbml0aW9uID0gdm0uc3RhY2sucG9wKCk7CiAgICB2YXIgaW52b2NhdGlvbiA9IHZtLnN0YWNrLnBvcCgpOwogICAgdmFyIG1hbmFnZXIgPSBkZWZpbml0aW9uLm1hbmFnZXI7CiAgICB2YXIgY2FwYWJpbGl0aWVzID0gY2FwYWJpbGl0eUZsYWdzRnJvbShtYW5hZ2VyLmdldENhcGFiaWxpdGllcyhkZWZpbml0aW9uLnN0YXRlKSk7CiAgICB2YXIgc3RhdGUgPSB7CiAgICAgIGRlZmluaXRpb246IGRlZmluaXRpb24sCiAgICAgIG1hbmFnZXI6IG1hbmFnZXIsCiAgICAgIGNhcGFiaWxpdGllczogY2FwYWJpbGl0aWVzLAogICAgICBzdGF0ZTogbnVsbCwKICAgICAgaGFuZGxlOiBpbnZvY2F0aW9uLmhhbmRsZSwKICAgICAgdGFibGU6IGludm9jYXRpb24uc3ltYm9sVGFibGUsCiAgICAgIGxvb2t1cDogbnVsbAogICAgfTsKICAgIHZtLmxvYWRWYWx1ZShyZWdpc3Rlciwgc3RhdGUpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg4OQogIC8qIFBvcHVsYXRlTGF5b3V0ICovCiAgLCBmdW5jdGlvbiAodm0sIF9yZWY0NCkgewogICAgdmFyIF9zdGF0ZSA9IF9yZWY0NC5vcDE7CiAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKICAgIHZhciBoYW5kbGUgPSBzdGFjay5wb3AoKTsKICAgIHZhciB0YWJsZSA9IHN0YWNrLnBvcCgpOwogICAgdmFyIHN0YXRlID0gdm0uZmV0Y2hWYWx1ZShfc3RhdGUpOwogICAgc3RhdGUuaGFuZGxlID0gaGFuZGxlOwogICAgc3RhdGUudGFibGUgPSB0YWJsZTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoMjEKICAvKiBWaXJ0dWFsUm9vdFNjb3BlICovCiAgLCBmdW5jdGlvbiAodm0sIF9yZWY0NSkgewogICAgdmFyIF9zdGF0ZSA9IF9yZWY0NS5vcDE7CiAgICB2YXIgc3ltYm9scyA9IHZtLmZldGNoVmFsdWUoX3N0YXRlKS50YWJsZS5zeW1ib2xzOwogICAgdm0ucHVzaFJvb3RTY29wZShzeW1ib2xzLmxlbmd0aCArIDEsIHRydWUpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg4NwogIC8qIFNldHVwRm9yRXZhbCAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmNDYpIHsKICAgIHZhciBfc3RhdGUgPSBfcmVmNDYub3AxOwogICAgdmFyIHN0YXRlID0gdm0uZmV0Y2hWYWx1ZShfc3RhdGUpOwoKICAgIGlmIChzdGF0ZS50YWJsZS5oYXNFdmFsKSB7CiAgICAgIHZhciBsb29rdXAgPSBzdGF0ZS5sb29rdXAgPSAoMCwgX3V0aWwuZGljdCkoKTsKICAgICAgdm0uc2NvcGUoKS5iaW5kRXZhbFNjb3BlKGxvb2t1cCk7CiAgICB9CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDIKICAvKiBTZXROYW1lZFZhcmlhYmxlcyAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmNDcpIHsKICAgIHZhciBfc3RhdGUgPSBfcmVmNDcub3AxOwogICAgdmFyIHN0YXRlID0gdm0uZmV0Y2hWYWx1ZShfc3RhdGUpOwogICAgdmFyIHNjb3BlID0gdm0uc2NvcGUoKTsKICAgIHZhciBhcmdzID0gdm0uc3RhY2sucGVlaygpOwogICAgdmFyIGNhbGxlck5hbWVzID0gYXJncy5uYW1lZC5hdE5hbWVzOwoKICAgIGZvciAodmFyIGkgPSBjYWxsZXJOYW1lcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICB2YXIgYXROYW1lID0gY2FsbGVyTmFtZXNbaV07CiAgICAgIHZhciBzeW1ib2wgPSBzdGF0ZS50YWJsZS5zeW1ib2xzLmluZGV4T2YoY2FsbGVyTmFtZXNbaV0pOwogICAgICB2YXIgdmFsdWUkJDEgPSBhcmdzLm5hbWVkLmdldChhdE5hbWUsIGZhbHNlKTsKICAgICAgaWYgKHN5bWJvbCAhPT0gLTEpIHNjb3BlLmJpbmRTeW1ib2woc3ltYm9sICsgMSwgdmFsdWUkJDEpOwogICAgICBpZiAoc3RhdGUubG9va3VwKSBzdGF0ZS5sb29rdXBbYXROYW1lXSA9IHZhbHVlJCQxOwogICAgfQogIH0pOwoKICBmdW5jdGlvbiBiaW5kQmxvY2soc3ltYm9sTmFtZSwgYmxvY2tOYW1lLCBzdGF0ZSwgYmxvY2tzLCB2bSkgewogICAgdmFyIHN5bWJvbCA9IHN0YXRlLnRhYmxlLnN5bWJvbHMuaW5kZXhPZihzeW1ib2xOYW1lKTsKICAgIHZhciBibG9jayA9IGJsb2Nrcy5nZXQoYmxvY2tOYW1lKTsKCiAgICBpZiAoc3ltYm9sICE9PSAtMSkgewogICAgICB2bS5zY29wZSgpLmJpbmRCbG9jayhzeW1ib2wgKyAxLCBibG9jayk7CiAgICB9CgogICAgaWYgKHN0YXRlLmxvb2t1cCkgc3RhdGUubG9va3VwW3N5bWJvbE5hbWVdID0gYmxvY2s7CiAgfQoKICBBUFBFTkRfT1BDT0RFUy5hZGQoMwogIC8qIFNldEJsb2NrcyAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmNDgpIHsKICAgIHZhciBfc3RhdGUgPSBfcmVmNDgub3AxOwogICAgdmFyIHN0YXRlID0gdm0uZmV0Y2hWYWx1ZShfc3RhdGUpOwoKICAgIHZhciBfdm0kc3RhY2skcGVlayA9IHZtLnN0YWNrLnBlZWsoKSwKICAgICAgICBibG9ja3MgPSBfdm0kc3RhY2skcGVlay5ibG9ja3M7CgogICAgYmluZEJsb2NrKCcmYXR0cnMnLCAnYXR0cnMnLCBzdGF0ZSwgYmxvY2tzLCB2bSk7CiAgICBiaW5kQmxvY2soJyZpbnZlcnNlJywgJ2Vsc2UnLCBzdGF0ZSwgYmxvY2tzLCB2bSk7CiAgICBiaW5kQmxvY2soJyZkZWZhdWx0JywgJ21haW4nLCBzdGF0ZSwgYmxvY2tzLCB2bSk7CiAgfSk7IC8vIER5bmFtaWMgSW52b2NhdGlvbiBPbmx5CgogIEFQUEVORF9PUENPREVTLmFkZCg5MAogIC8qIEludm9rZUNvbXBvbmVudExheW91dCAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmNDkpIHsKICAgIHZhciBfc3RhdGUgPSBfcmVmNDkub3AxOwogICAgdmFyIHN0YXRlID0gdm0uZmV0Y2hWYWx1ZShfc3RhdGUpOwogICAgdm0uY2FsbChzdGF0ZS5oYW5kbGUpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg5NAogIC8qIERpZFJlbmRlckxheW91dCAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmNTApIHsKICAgIHZhciBfc3RhdGUgPSBfcmVmNTAub3AxOwoKICAgIHZhciBfdm0kZmV0Y2hWYWx1ZTUgPSB2bS5mZXRjaFZhbHVlKF9zdGF0ZSksCiAgICAgICAgbWFuYWdlciA9IF92bSRmZXRjaFZhbHVlNS5tYW5hZ2VyLAogICAgICAgIHN0YXRlID0gX3ZtJGZldGNoVmFsdWU1LnN0YXRlOwoKICAgIHZhciBib3VuZHMgPSB2bS5lbGVtZW50cygpLnBvcEJsb2NrKCk7CiAgICB2YXIgbWdyID0gbWFuYWdlcjsKICAgIG1nci5kaWRSZW5kZXJMYXlvdXQoc3RhdGUsIGJvdW5kcyk7CiAgICB2bS5lbnYuZGlkQ3JlYXRlKHN0YXRlLCBtYW5hZ2VyKTsKICAgIHZtLnVwZGF0ZVdpdGgobmV3IERpZFVwZGF0ZUxheW91dE9wY29kZShtYW5hZ2VyLCBzdGF0ZSwgYm91bmRzKSk7CiAgfSk7CiAgQVBQRU5EX09QQ09ERVMuYWRkKDkyCiAgLyogQ29tbWl0Q29tcG9uZW50VHJhbnNhY3Rpb24gKi8KICAsIGZ1bmN0aW9uICh2bSkgewogICAgdm0uY29tbWl0Q2FjaGVHcm91cCgpOwogIH0pOwoKICB2YXIgVXBkYXRlQ29tcG9uZW50T3Bjb2RlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9VcGRhdGluZ09wY29kZTcpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShVcGRhdGVDb21wb25lbnRPcGNvZGUsIF9VcGRhdGluZ09wY29kZTcpOwoKICAgIGZ1bmN0aW9uIFVwZGF0ZUNvbXBvbmVudE9wY29kZSh0YWcsIGNvbXBvbmVudCwgbWFuYWdlciwgZHluYW1pY1Njb3BlKSB7CiAgICAgIHZhciBfdGhpczEwOwoKICAgICAgX3RoaXMxMCA9IF9VcGRhdGluZ09wY29kZTcuY2FsbCh0aGlzKSB8fCB0aGlzOwogICAgICBfdGhpczEwLnRhZyA9IHRhZzsKICAgICAgX3RoaXMxMC5jb21wb25lbnQgPSBjb21wb25lbnQ7CiAgICAgIF90aGlzMTAubWFuYWdlciA9IG1hbmFnZXI7CiAgICAgIF90aGlzMTAuZHluYW1pY1Njb3BlID0gZHluYW1pY1Njb3BlOwogICAgICBfdGhpczEwLnR5cGUgPSAndXBkYXRlLWNvbXBvbmVudCc7CiAgICAgIHJldHVybiBfdGhpczEwOwogICAgfQoKICAgIHZhciBfcHJvdG8xOSA9IFVwZGF0ZUNvbXBvbmVudE9wY29kZS5wcm90b3R5cGU7CgogICAgX3Byb3RvMTkuZXZhbHVhdGUgPSBmdW5jdGlvbiBldmFsdWF0ZShfdm0pIHsKICAgICAgdmFyIGNvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50LAogICAgICAgICAgbWFuYWdlciA9IHRoaXMubWFuYWdlciwKICAgICAgICAgIGR5bmFtaWNTY29wZSA9IHRoaXMuZHluYW1pY1Njb3BlOwogICAgICBtYW5hZ2VyLnVwZGF0ZShjb21wb25lbnQsIGR5bmFtaWNTY29wZSk7CiAgICB9OwoKICAgIHJldHVybiBVcGRhdGVDb21wb25lbnRPcGNvZGU7CiAgfShVcGRhdGluZ09wY29kZSk7CgogIHZhciBEaWRVcGRhdGVMYXlvdXRPcGNvZGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX1VwZGF0aW5nT3Bjb2RlOCkgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKERpZFVwZGF0ZUxheW91dE9wY29kZSwgX1VwZGF0aW5nT3Bjb2RlOCk7CgogICAgZnVuY3Rpb24gRGlkVXBkYXRlTGF5b3V0T3Bjb2RlKG1hbmFnZXIsIGNvbXBvbmVudCwgYm91bmRzKSB7CiAgICAgIHZhciBfdGhpczExOwoKICAgICAgX3RoaXMxMSA9IF9VcGRhdGluZ09wY29kZTguY2FsbCh0aGlzKSB8fCB0aGlzOwogICAgICBfdGhpczExLm1hbmFnZXIgPSBtYW5hZ2VyOwogICAgICBfdGhpczExLmNvbXBvbmVudCA9IGNvbXBvbmVudDsKICAgICAgX3RoaXMxMS5ib3VuZHMgPSBib3VuZHM7CiAgICAgIF90aGlzMTEudHlwZSA9ICdkaWQtdXBkYXRlLWxheW91dCc7CiAgICAgIF90aGlzMTEudGFnID0gX3JlZmVyZW5jZTIuQ09OU1RBTlRfVEFHOwogICAgICByZXR1cm4gX3RoaXMxMTsKICAgIH0KCiAgICB2YXIgX3Byb3RvMjAgPSBEaWRVcGRhdGVMYXlvdXRPcGNvZGUucHJvdG90eXBlOwoKICAgIF9wcm90bzIwLmV2YWx1YXRlID0gZnVuY3Rpb24gZXZhbHVhdGUodm0pIHsKICAgICAgdmFyIG1hbmFnZXIgPSB0aGlzLm1hbmFnZXIsCiAgICAgICAgICBjb21wb25lbnQgPSB0aGlzLmNvbXBvbmVudCwKICAgICAgICAgIGJvdW5kcyA9IHRoaXMuYm91bmRzOwogICAgICBtYW5hZ2VyLmRpZFVwZGF0ZUxheW91dChjb21wb25lbnQsIGJvdW5kcyk7CiAgICAgIHZtLmVudi5kaWRVcGRhdGUoY29tcG9uZW50LCBtYW5hZ2VyKTsKICAgIH07CgogICAgcmV0dXJuIERpZFVwZGF0ZUxheW91dE9wY29kZTsKICB9KFVwZGF0aW5nT3Bjb2RlKTsKICAvKiB0c2xpbnQ6ZGlzYWJsZSAqLwoKCiAgZnVuY3Rpb24gZGVidWdDYWxsYmFjayhjb250ZXh0LCBnZXQpIHsKICAgIGNvbnNvbGUuaW5mbygnVXNlIGBjb250ZXh0YCwgYW5kIGBnZXQoPHBhdGg+KWAgdG8gZGVidWcgdGhpcyB0ZW1wbGF0ZS4nKTsgLy8gZm9yIGV4YW1wbGUuLi4KCiAgICBjb250ZXh0ID09PSBnZXQoJ3RoaXMnKTsKICAgIGRlYnVnZ2VyOwogIH0KICAvKiB0c2xpbnQ6ZW5hYmxlICovCgoKICB2YXIgY2FsbGJhY2sgPSBkZWJ1Z0NhbGxiYWNrOyAvLyBGb3IgdGVzdGluZyBwdXJwb3NlcwoKICBmdW5jdGlvbiBzZXREZWJ1Z2dlckNhbGxiYWNrKGNiKSB7CiAgICBjYWxsYmFjayA9IGNiOwogIH0KCiAgZnVuY3Rpb24gcmVzZXREZWJ1Z2dlckNhbGxiYWNrKCkgewogICAgY2FsbGJhY2sgPSBkZWJ1Z0NhbGxiYWNrOwogIH0KCiAgdmFyIFNjb3BlSW5zcGVjdG9yID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gU2NvcGVJbnNwZWN0b3Ioc2NvcGUsIHN5bWJvbHMsIGV2YWxJbmZvKSB7CiAgICAgIHRoaXMuc2NvcGUgPSBzY29wZTsKICAgICAgdGhpcy5sb2NhbHMgPSAoMCwgX3V0aWwuZGljdCkoKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZhbEluZm8ubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgc2xvdCA9IGV2YWxJbmZvW2ldOwogICAgICAgIHZhciBuYW1lID0gc3ltYm9sc1tzbG90IC0gMV07CiAgICAgICAgdmFyIHJlZiA9IHNjb3BlLmdldFN5bWJvbChzbG90KTsKICAgICAgICB0aGlzLmxvY2Fsc1tuYW1lXSA9IHJlZjsKICAgICAgfQogICAgfQoKICAgIHZhciBfcHJvdG8yMSA9IFNjb3BlSW5zcGVjdG9yLnByb3RvdHlwZTsKCiAgICBfcHJvdG8yMS5nZXQgPSBmdW5jdGlvbiBnZXQocGF0aCkgewogICAgICB2YXIgc2NvcGUgPSB0aGlzLnNjb3BlLAogICAgICAgICAgbG9jYWxzID0gdGhpcy5sb2NhbHM7CiAgICAgIHZhciBwYXJ0cyA9IHBhdGguc3BsaXQoJy4nKTsKCiAgICAgIHZhciBfcGF0aCRzcGxpdCA9IHBhdGguc3BsaXQoJy4nKSwKICAgICAgICAgIGhlYWQgPSBfcGF0aCRzcGxpdFswXSwKICAgICAgICAgIHRhaWwgPSBfcGF0aCRzcGxpdC5zbGljZSgxKTsKCiAgICAgIHZhciBldmFsU2NvcGUgPSBzY29wZS5nZXRFdmFsU2NvcGUoKTsKICAgICAgdmFyIHJlZjsKCiAgICAgIGlmIChoZWFkID09PSAndGhpcycpIHsKICAgICAgICByZWYgPSBzY29wZS5nZXRTZWxmKCk7CiAgICAgIH0gZWxzZSBpZiAobG9jYWxzW2hlYWRdKSB7CiAgICAgICAgcmVmID0gbG9jYWxzW2hlYWRdOwogICAgICB9IGVsc2UgaWYgKGhlYWQuaW5kZXhPZignQCcpID09PSAwICYmIGV2YWxTY29wZVtoZWFkXSkgewogICAgICAgIHJlZiA9IGV2YWxTY29wZVtoZWFkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZWYgPSB0aGlzLnNjb3BlLmdldFNlbGYoKTsKICAgICAgICB0YWlsID0gcGFydHM7CiAgICAgIH0KCiAgICAgIHJldHVybiB0YWlsLnJlZHVjZShmdW5jdGlvbiAociwgcGFydCkgewogICAgICAgIHJldHVybiByLmdldChwYXJ0KTsKICAgICAgfSwgcmVmKTsKICAgIH07CgogICAgcmV0dXJuIFNjb3BlSW5zcGVjdG9yOwogIH0oKTsKCiAgQVBQRU5EX09QQ09ERVMuYWRkKDk3CiAgLyogRGVidWdnZXIgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjUxKSB7CiAgICB2YXIgX3N5bWJvbHMgPSBfcmVmNTEub3AxLAogICAgICAgIF9ldmFsSW5mbyA9IF9yZWY1MS5vcDI7CiAgICB2YXIgc3ltYm9scyA9IHZtLmNvbnN0YW50cy5nZXRTdHJpbmdBcnJheShfc3ltYm9scyk7CiAgICB2YXIgZXZhbEluZm8gPSB2bS5jb25zdGFudHMuZ2V0QXJyYXkoX2V2YWxJbmZvKTsKICAgIHZhciBpbnNwZWN0b3IgPSBuZXcgU2NvcGVJbnNwZWN0b3Iodm0uc2NvcGUoKSwgc3ltYm9scywgZXZhbEluZm8pOwogICAgY2FsbGJhY2sodm0uZ2V0U2VsZigpLnZhbHVlKCksIGZ1bmN0aW9uIChwYXRoKSB7CiAgICAgIHJldHVybiBpbnNwZWN0b3IuZ2V0KHBhdGgpLnZhbHVlKCk7CiAgICB9KTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoOTUKICAvKiBJbnZva2VQYXJ0aWFsICovCiAgLCBmdW5jdGlvbiAodm0sIF9yZWY1MikgewogICAgdmFyIF9tZXRhID0gX3JlZjUyLm9wMSwKICAgICAgICBfc3ltYm9scyA9IF9yZWY1Mi5vcDIsCiAgICAgICAgX2V2YWxJbmZvID0gX3JlZjUyLm9wMzsKICAgIHZhciBjb25zdGFudHMgPSB2bS5jb25zdGFudHMsCiAgICAgICAgcmVzb2x2ZXIgPSB2bS5jb25zdGFudHMucmVzb2x2ZXIsCiAgICAgICAgc3RhY2sgPSB2bS5zdGFjazsKICAgIHZhciBuYW1lID0gc3RhY2sucG9wKCkudmFsdWUoKTsKICAgIHZhciBtZXRhID0gY29uc3RhbnRzLmdldFNlcmlhbGl6YWJsZShfbWV0YSk7CiAgICB2YXIgb3V0ZXJTeW1ib2xzID0gY29uc3RhbnRzLmdldFN0cmluZ0FycmF5KF9zeW1ib2xzKTsKICAgIHZhciBldmFsSW5mbyA9IGNvbnN0YW50cy5nZXRBcnJheShfZXZhbEluZm8pOwogICAgdmFyIGhhbmRsZSA9IHJlc29sdmVyLmxvb2t1cFBhcnRpYWwobmFtZSwgbWV0YSk7CiAgICB2YXIgZGVmaW5pdGlvbiA9IHJlc29sdmVyLnJlc29sdmUoaGFuZGxlKTsKCiAgICB2YXIgX2RlZmluaXRpb24kZ2V0UGFydGlhID0gZGVmaW5pdGlvbi5nZXRQYXJ0aWFsKCksCiAgICAgICAgc3ltYm9sVGFibGUgPSBfZGVmaW5pdGlvbiRnZXRQYXJ0aWEuc3ltYm9sVGFibGUsCiAgICAgICAgdm1IYW5kbGUgPSBfZGVmaW5pdGlvbiRnZXRQYXJ0aWEuaGFuZGxlOwoKICAgIHsKICAgICAgdmFyIHBhcnRpYWxTeW1ib2xzID0gc3ltYm9sVGFibGUuc3ltYm9sczsKICAgICAgdmFyIG91dGVyU2NvcGUgPSB2bS5zY29wZSgpOwogICAgICB2YXIgcGFydGlhbFNjb3BlID0gdm0ucHVzaFJvb3RTY29wZShwYXJ0aWFsU3ltYm9scy5sZW5ndGgsIGZhbHNlKTsKICAgICAgdmFyIGV2YWxTY29wZSA9IG91dGVyU2NvcGUuZ2V0RXZhbFNjb3BlKCk7CiAgICAgIHBhcnRpYWxTY29wZS5iaW5kQ2FsbGVyU2NvcGUob3V0ZXJTY29wZS5nZXRDYWxsZXJTY29wZSgpKTsKICAgICAgcGFydGlhbFNjb3BlLmJpbmRFdmFsU2NvcGUoZXZhbFNjb3BlKTsKICAgICAgcGFydGlhbFNjb3BlLmJpbmRTZWxmKG91dGVyU2NvcGUuZ2V0U2VsZigpKTsKICAgICAgdmFyIGxvY2FscyA9IE9iamVjdC5jcmVhdGUob3V0ZXJTY29wZS5nZXRQYXJ0aWFsTWFwKCkpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmFsSW5mby5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBzbG90ID0gZXZhbEluZm9baV07CiAgICAgICAgdmFyIF9uYW1lMiA9IG91dGVyU3ltYm9sc1tzbG90IC0gMV07CiAgICAgICAgdmFyIHJlZiA9IG91dGVyU2NvcGUuZ2V0U3ltYm9sKHNsb3QpOwogICAgICAgIGxvY2Fsc1tfbmFtZTJdID0gcmVmOwogICAgICB9CgogICAgICBpZiAoZXZhbFNjb3BlKSB7CiAgICAgICAgZm9yICh2YXIgX2kzID0gMDsgX2kzIDwgcGFydGlhbFN5bWJvbHMubGVuZ3RoOyBfaTMrKykgewogICAgICAgICAgdmFyIF9uYW1lMyA9IHBhcnRpYWxTeW1ib2xzW19pM107CiAgICAgICAgICB2YXIgc3ltYm9sID0gX2kzICsgMTsKICAgICAgICAgIHZhciB2YWx1ZSQkMSA9IGV2YWxTY29wZVtfbmFtZTNdOwogICAgICAgICAgaWYgKHZhbHVlJCQxICE9PSB1bmRlZmluZWQpIHBhcnRpYWxTY29wZS5iaW5kKHN5bWJvbCwgdmFsdWUkJDEpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcGFydGlhbFNjb3BlLmJpbmRQYXJ0aWFsTWFwKGxvY2Fscyk7CiAgICAgIHZtLnB1c2hGcmFtZSgpOyAvLyBzcCArPSAyCgogICAgICB2bS5jYWxsKHZtSGFuZGxlKTsKICAgIH0KICB9KTsKCiAgdmFyIEl0ZXJhYmxlUHJlc2VuY2VSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBJdGVyYWJsZVByZXNlbmNlUmVmZXJlbmNlKGFydGlmYWN0cykgewogICAgICB0aGlzLnRhZyA9IGFydGlmYWN0cy50YWc7CiAgICAgIHRoaXMuYXJ0aWZhY3RzID0gYXJ0aWZhY3RzOwogICAgfQoKICAgIHZhciBfcHJvdG8yMiA9IEl0ZXJhYmxlUHJlc2VuY2VSZWZlcmVuY2UucHJvdG90eXBlOwoKICAgIF9wcm90bzIyLnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHJldHVybiAhdGhpcy5hcnRpZmFjdHMuaXNFbXB0eSgpOwogICAgfTsKCiAgICByZXR1cm4gSXRlcmFibGVQcmVzZW5jZVJlZmVyZW5jZTsKICB9KCk7CgogIEFQUEVORF9PUENPREVTLmFkZCg2NgogIC8qIFB1dEl0ZXJhdG9yICovCiAgLCBmdW5jdGlvbiAodm0pIHsKICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgdmFyIGxpc3RSZWYgPSBzdGFjay5wb3AoKTsKICAgIHZhciBrZXkgPSBzdGFjay5wb3AoKTsKICAgIHZhciBpdGVyYWJsZSA9IHZtLmVudi5pdGVyYWJsZUZvcihsaXN0UmVmLCBrZXkudmFsdWUoKSk7CiAgICB2YXIgaXRlcmF0b3IgPSBuZXcgX3JlZmVyZW5jZTIuUmVmZXJlbmNlSXRlcmF0b3IoaXRlcmFibGUpOwogICAgc3RhY2sucHVzaChpdGVyYXRvcik7CiAgICBzdGFjay5wdXNoKG5ldyBJdGVyYWJsZVByZXNlbmNlUmVmZXJlbmNlKGl0ZXJhdG9yLmFydGlmYWN0cykpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg2NAogIC8qIEVudGVyTGlzdCAqLwogICwgZnVuY3Rpb24gKHZtLCBfcmVmNTMpIHsKICAgIHZhciByZWxhdGl2ZVN0YXJ0ID0gX3JlZjUzLm9wMTsKICAgIHZtLmVudGVyTGlzdChyZWxhdGl2ZVN0YXJ0KTsKICB9KTsKICBBUFBFTkRfT1BDT0RFUy5hZGQoNjUKICAvKiBFeGl0TGlzdCAqLwogICwgZnVuY3Rpb24gKHZtKSB7CiAgICB2bS5leGl0TGlzdCgpOwogIH0pOwogIEFQUEVORF9PUENPREVTLmFkZCg2NwogIC8qIEl0ZXJhdGUgKi8KICAsIGZ1bmN0aW9uICh2bSwgX3JlZjU0KSB7CiAgICB2YXIgYnJlYWtzID0gX3JlZjU0Lm9wMTsKICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgdmFyIGl0ZW0gPSBzdGFjay5wZWVrKCkubmV4dCgpOwoKICAgIGlmIChpdGVtKSB7CiAgICAgIHZhciB0cnlPcGNvZGUgPSB2bS5pdGVyYXRlKGl0ZW0ubWVtbywgaXRlbS52YWx1ZSk7CiAgICAgIHZtLmVudGVySXRlbShpdGVtLmtleSwgdHJ5T3Bjb2RlKTsKICAgIH0gZWxzZSB7CiAgICAgIHZtLmdvdG8oYnJlYWtzKTsKICAgIH0KICB9KTsKCiAgdmFyIEN1cnNvciA9IGZ1bmN0aW9uIEN1cnNvcihlbGVtZW50LCBuZXh0U2libGluZykgewogICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKICAgIHRoaXMubmV4dFNpYmxpbmcgPSBuZXh0U2libGluZzsKICB9OwoKICBfZXhwb3J0cy5DdXJzb3IgPSBDdXJzb3I7CgogIHZhciBDb25jcmV0ZUJvdW5kcyA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIENvbmNyZXRlQm91bmRzKHBhcmVudE5vZGUsIGZpcnN0LCBsYXN0KSB7CiAgICAgIHRoaXMucGFyZW50Tm9kZSA9IHBhcmVudE5vZGU7CiAgICAgIHRoaXMuZmlyc3QgPSBmaXJzdDsKICAgICAgdGhpcy5sYXN0ID0gbGFzdDsKICAgIH0KCiAgICB2YXIgX3Byb3RvMjMgPSBDb25jcmV0ZUJvdW5kcy5wcm90b3R5cGU7CgogICAgX3Byb3RvMjMucGFyZW50RWxlbWVudCA9IGZ1bmN0aW9uIHBhcmVudEVsZW1lbnQoKSB7CiAgICAgIHJldHVybiB0aGlzLnBhcmVudE5vZGU7CiAgICB9OwoKICAgIF9wcm90bzIzLmZpcnN0Tm9kZSA9IGZ1bmN0aW9uIGZpcnN0Tm9kZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuZmlyc3Q7CiAgICB9OwoKICAgIF9wcm90bzIzLmxhc3ROb2RlID0gZnVuY3Rpb24gbGFzdE5vZGUoKSB7CiAgICAgIHJldHVybiB0aGlzLmxhc3Q7CiAgICB9OwoKICAgIHJldHVybiBDb25jcmV0ZUJvdW5kczsKICB9KCk7CgogIF9leHBvcnRzLkNvbmNyZXRlQm91bmRzID0gQ29uY3JldGVCb3VuZHM7CgogIHZhciBTaW5nbGVOb2RlQm91bmRzID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gU2luZ2xlTm9kZUJvdW5kcyhwYXJlbnROb2RlLCBub2RlKSB7CiAgICAgIHRoaXMucGFyZW50Tm9kZSA9IHBhcmVudE5vZGU7CiAgICAgIHRoaXMubm9kZSA9IG5vZGU7CiAgICB9CgogICAgdmFyIF9wcm90bzI0ID0gU2luZ2xlTm9kZUJvdW5kcy5wcm90b3R5cGU7CgogICAgX3Byb3RvMjQucGFyZW50RWxlbWVudCA9IGZ1bmN0aW9uIHBhcmVudEVsZW1lbnQoKSB7CiAgICAgIHJldHVybiB0aGlzLnBhcmVudE5vZGU7CiAgICB9OwoKICAgIF9wcm90bzI0LmZpcnN0Tm9kZSA9IGZ1bmN0aW9uIGZpcnN0Tm9kZSgpIHsKICAgICAgcmV0dXJuIHRoaXMubm9kZTsKICAgIH07CgogICAgX3Byb3RvMjQubGFzdE5vZGUgPSBmdW5jdGlvbiBsYXN0Tm9kZSgpIHsKICAgICAgcmV0dXJuIHRoaXMubm9kZTsKICAgIH07CgogICAgcmV0dXJuIFNpbmdsZU5vZGVCb3VuZHM7CiAgfSgpOwoKICBmdW5jdGlvbiBfbW92ZShib3VuZHMsIHJlZmVyZW5jZSkgewogICAgdmFyIHBhcmVudCA9IGJvdW5kcy5wYXJlbnRFbGVtZW50KCk7CiAgICB2YXIgZmlyc3QgPSBib3VuZHMuZmlyc3ROb2RlKCk7CiAgICB2YXIgbGFzdCA9IGJvdW5kcy5sYXN0Tm9kZSgpOwogICAgdmFyIGN1cnJlbnQgPSBmaXJzdDsKCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICB2YXIgbmV4dCA9IGN1cnJlbnQubmV4dFNpYmxpbmc7CiAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUoY3VycmVudCwgcmVmZXJlbmNlKTsKCiAgICAgIGlmIChjdXJyZW50ID09PSBsYXN0KSB7CiAgICAgICAgcmV0dXJuIG5leHQ7CiAgICAgIH0KCiAgICAgIGN1cnJlbnQgPSBuZXh0OwogICAgfQogIH0KCiAgZnVuY3Rpb24gY2xlYXIoYm91bmRzKSB7CiAgICB2YXIgcGFyZW50ID0gYm91bmRzLnBhcmVudEVsZW1lbnQoKTsKICAgIHZhciBmaXJzdCA9IGJvdW5kcy5maXJzdE5vZGUoKTsKICAgIHZhciBsYXN0ID0gYm91bmRzLmxhc3ROb2RlKCk7CiAgICB2YXIgY3VycmVudCA9IGZpcnN0OwoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIHZhciBuZXh0ID0gY3VycmVudC5uZXh0U2libGluZzsKICAgICAgcGFyZW50LnJlbW92ZUNoaWxkKGN1cnJlbnQpOwoKICAgICAgaWYgKGN1cnJlbnQgPT09IGxhc3QpIHsKICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgfQoKICAgICAgY3VycmVudCA9IG5leHQ7CiAgICB9CiAgfSAvLyBQYXRjaDogICAgaW5zZXJ0QWRqYWNlbnRIVE1MIG9uIFNWRyBGaXgKICAvLyBCcm93c2VyczogU2FmYXJpLCBJRSwgRWRnZSwgRmlyZWZveCB+MzMtMzQKICAvLyBSZWFzb246ICAgaW5zZXJ0QWRqYWNlbnRIVE1MIGRvZXMgbm90IGV4aXN0IG9uIFNWRyBlbGVtZW50cyBpbiBTYWZhcmkuIEl0IGlzCiAgLy8gICAgICAgICAgIHByZXNlbnQgYnV0IHRocm93cyBhbiBleGNlcHRpb24gb24gSUUgYW5kIEVkZ2UuIE9sZCB2ZXJzaW9ucyBvZgogIC8vICAgICAgICAgICBGaXJlZm94IGNyZWF0ZSBub2RlcyBpbiB0aGUgaW5jb3JyZWN0IG5hbWVzcGFjZS4KICAvLyBGaXg6ICAgICAgU2luY2UgSUUgYW5kIEVkZ2Ugc2lsZW50bHkgZmFpbCB0byBjcmVhdGUgU1ZHIG5vZGVzIHVzaW5nCiAgLy8gICAgICAgICAgIGlubmVySFRNTCwgYW5kIGJlY2F1c2UgRmlyZWZveCBtYXkgY3JlYXRlIG5vZGVzIGluIHRoZSBpbmNvcnJlY3QKICAvLyAgICAgICAgICAgbmFtZXNwYWNlIHVzaW5nIGlubmVySFRNTCBvbiBTVkcgZWxlbWVudHMsIGFuIEhUTUwtc3RyaW5nIHdyYXBwaW5nCiAgLy8gICAgICAgICAgIGFwcHJvYWNoIGlzIHVzZWQuIEEgcHJlL3Bvc3QgU1ZHIHRhZyBpcyBhZGRlZCB0byB0aGUgc3RyaW5nLCB0aGVuCiAgLy8gICAgICAgICAgIHRoYXQgd2hvbGUgc3RyaW5nIGlzIGFkZGVkIHRvIGEgZGl2LiBUaGUgY3JlYXRlZCBub2RlcyBhcmUgcGx1Y2tlZAogIC8vICAgICAgICAgICBvdXQgYW5kIGFwcGxpZWQgdG8gdGhlIHRhcmdldCBsb2NhdGlvbiBvbiBET00uCgoKICBmdW5jdGlvbiBhcHBseVNWR0lubmVySFRNTEZpeChkb2N1bWVudCwgRE9NQ2xhc3MsIHN2Z05hbWVzcGFjZSkgewogICAgaWYgKCFkb2N1bWVudCkgcmV0dXJuIERPTUNsYXNzOwoKICAgIGlmICghc2hvdWxkQXBwbHlGaXgoZG9jdW1lbnQsIHN2Z05hbWVzcGFjZSkpIHsKICAgICAgcmV0dXJuIERPTUNsYXNzOwogICAgfQoKICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIHJldHVybiAoCiAgICAgIC8qI19fUFVSRV9fKi8KICAgICAgZnVuY3Rpb24gKF9ET01DbGFzcykgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShET01DaGFuZ2VzV2l0aFNWR0lubmVySFRNTEZpeCwgX0RPTUNsYXNzKTsKCiAgICAgICAgZnVuY3Rpb24gRE9NQ2hhbmdlc1dpdGhTVkdJbm5lckhUTUxGaXgoKSB7CiAgICAgICAgICByZXR1cm4gX0RPTUNsYXNzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgICAgICB9CgogICAgICAgIHZhciBfcHJvdG8yNSA9IERPTUNoYW5nZXNXaXRoU1ZHSW5uZXJIVE1MRml4LnByb3RvdHlwZTsKCiAgICAgICAgX3Byb3RvMjUuaW5zZXJ0SFRNTEJlZm9yZSA9IGZ1bmN0aW9uIGluc2VydEhUTUxCZWZvcmUocGFyZW50LCBuZXh0U2libGluZywgaHRtbCkgewogICAgICAgICAgaWYgKGh0bWwgPT09ICcnKSB7CiAgICAgICAgICAgIHJldHVybiBfRE9NQ2xhc3MucHJvdG90eXBlLmluc2VydEhUTUxCZWZvcmUuY2FsbCh0aGlzLCBwYXJlbnQsIG5leHRTaWJsaW5nLCBodG1sKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAocGFyZW50Lm5hbWVzcGFjZVVSSSAhPT0gc3ZnTmFtZXNwYWNlKSB7CiAgICAgICAgICAgIHJldHVybiBfRE9NQ2xhc3MucHJvdG90eXBlLmluc2VydEhUTUxCZWZvcmUuY2FsbCh0aGlzLCBwYXJlbnQsIG5leHRTaWJsaW5nLCBodG1sKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gZml4U1ZHKHBhcmVudCwgZGl2LCBodG1sLCBuZXh0U2libGluZyk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIERPTUNoYW5nZXNXaXRoU1ZHSW5uZXJIVE1MRml4OwogICAgICB9KERPTUNsYXNzKQogICAgKTsKICB9CgogIGZ1bmN0aW9uIGZpeFNWRyhwYXJlbnQsIGRpdiwgaHRtbCwgcmVmZXJlbmNlKSB7CiAgICB2YXIgc291cmNlOyAvLyBUaGlzIGlzIGltcG9ydGFudCwgYmVjYXVzZSBkZWNlbmRhbnRzIG9mIHRoZSA8Zm9yZWlnbk9iamVjdD4gaW50ZWdyYXRpb24KICAgIC8vIHBvaW50IGFyZSBwYXJzZWQgaW4gdGhlIEhUTUwgbmFtZXNwYWNlCgogICAgaWYgKHBhcmVudC50YWdOYW1lLnRvVXBwZXJDYXNlKCkgPT09ICdGT1JFSUdOT0JKRUNUJykgewogICAgICAvLyBJRSwgRWRnZTogYWxzbyBkbyBub3QgY29ycmVjdGx5IHN1cHBvcnQgdXNpbmcgYGlubmVySFRNTGAgb24gU1ZHCiAgICAgIC8vIG5hbWVzcGFjZWQgZWxlbWVudHMuIFNvIGhlcmUgYSB3cmFwcGVyIGlzIHVzZWQuCiAgICAgIHZhciB3cmFwcGVkSHRtbCA9ICc8c3ZnPjxmb3JlaWduT2JqZWN0PicgKyBodG1sICsgJzwvZm9yZWlnbk9iamVjdD48L3N2Zz4nOwogICAgICBkaXYuaW5uZXJIVE1MID0gd3JhcHBlZEh0bWw7CiAgICAgIHNvdXJjZSA9IGRpdi5maXJzdENoaWxkLmZpcnN0Q2hpbGQ7CiAgICB9IGVsc2UgewogICAgICAvLyBJRSwgRWRnZTogYWxzbyBkbyBub3QgY29ycmVjdGx5IHN1cHBvcnQgdXNpbmcgYGlubmVySFRNTGAgb24gU1ZHCiAgICAgIC8vIG5hbWVzcGFjZWQgZWxlbWVudHMuIFNvIGhlcmUgYSB3cmFwcGVyIGlzIHVzZWQuCiAgICAgIHZhciBfd3JhcHBlZEh0bWwgPSAnPHN2Zz4nICsgaHRtbCArICc8L3N2Zz4nOwoKICAgICAgZGl2LmlubmVySFRNTCA9IF93cmFwcGVkSHRtbDsKICAgICAgc291cmNlID0gZGl2LmZpcnN0Q2hpbGQ7CiAgICB9CgogICAgcmV0dXJuIG1vdmVOb2Rlc0JlZm9yZShzb3VyY2UsIHBhcmVudCwgcmVmZXJlbmNlKTsKICB9CgogIGZ1bmN0aW9uIHNob3VsZEFwcGx5Rml4KGRvY3VtZW50LCBzdmdOYW1lc3BhY2UpIHsKICAgIHZhciBzdmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoc3ZnTmFtZXNwYWNlLCAnc3ZnJyk7CgogICAgdHJ5IHsKICAgICAgc3ZnWydpbnNlcnRBZGphY2VudEhUTUwnXSgnYmVmb3JlZW5kJywgJzxjaXJjbGU+PC9jaXJjbGU+Jyk7CiAgICB9IGNhdGNoIChlKSB7Ly8gSUUsIEVkZ2U6IFdpbGwgdGhyb3csIGluc2VydEFkamFjZW50SFRNTCBpcyB1bnN1cHBvcnRlZCBvbiBTVkcKICAgICAgLy8gU2FmYXJpOiBXaWxsIHRocm93LCBpbnNlcnRBZGphY2VudEhUTUwgaXMgbm90IHByZXNlbnQgb24gU1ZHCiAgICB9IGZpbmFsbHkgewogICAgICAvLyBGRjogT2xkIHZlcnNpb25zIHdpbGwgY3JlYXRlIGEgbm9kZSBpbiB0aGUgd3JvbmcgbmFtZXNwYWNlCiAgICAgIGlmIChzdmcuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEgJiYgc3ZnLmZpcnN0Q2hpbGQubmFtZXNwYWNlVVJJID09PSBTVkdfTkFNRVNQQUNFKSB7CiAgICAgICAgLy8gVGhlIHRlc3Qgd29ya2VkIGFzIGV4cGVjdGVkLCBubyBmaXggcmVxdWlyZWQKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0gLy8gUGF0Y2g6ICAgIEFkamFjZW50IHRleHQgbm9kZSBtZXJnaW5nIGZpeAogIC8vIEJyb3dzZXJzOiBJRSwgRWRnZSwgRmlyZWZveCB3L28gaW5zcGVjdG9yIG9wZW4KICAvLyBSZWFzb246ICAgVGhlc2UgYnJvd3NlcnMgd2lsbCBtZXJnZSBhZGphY2VudCB0ZXh0IG5vZGVzLiBGb3IgZXhtYXBsZSBnaXZlbgogIC8vICAgICAgICAgICA8ZGl2PkhlbGxvPC9kaXY+IHdpdGggZGl2Lmluc2VydEFkamFjZW50SFRNTCgnIHdvcmxkJykgYnJvd3NlcnMKICAvLyAgICAgICAgICAgd2l0aCBwcm9wZXIgYmVoYXZpb3Igd2lsbCBwb3B1bGF0ZSBkaXYuY2hpbGROb2RlcyB3aXRoIHR3byBpdGVtcy4KICAvLyAgICAgICAgICAgVGhlc2UgYnJvd3NlcnMgd2lsbCBwb3B1bGF0ZSBpdCB3aXRoIG9uZSBtZXJnZWQgbm9kZSBpbnN0ZWFkLgogIC8vIEZpeDogICAgICBBZGQgdGhlc2Ugbm9kZXMgdG8gYSB3cmFwcGVyIGVsZW1lbnQsIHRoZW4gaXRlcmF0ZSB0aGUgY2hpbGROb2RlcwogIC8vICAgICAgICAgICBvZiB0aGF0IHdyYXBwZXIgYW5kIG1vdmUgdGhlIG5vZGVzIHRvIHRoZWlyIHRhcmdldCBsb2NhdGlvbi4gTm90ZQogIC8vICAgICAgICAgICB0aGF0IHBvdGVudGlhbCBTVkcgYnVncyB3aWxsIGhhdmUgYmVlbiBoYW5kbGVkIGJlZm9yZSB0aGlzIGZpeC4KICAvLyAgICAgICAgICAgTm90ZSB0aGF0IHRoaXMgZml4IG11c3Qgb25seSBhcHBseSB0byB0aGUgcHJldmlvdXMgdGV4dCBub2RlLCBhcwogIC8vICAgICAgICAgICB0aGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgaW5zZXJ0SFRNTEJlZm9yZWAgYWxyZWFkeSBoYW5kbGVzCiAgLy8gICAgICAgICAgIGZvbGxvd2luZyB0ZXh0IG5vZGVzIGNvcnJlY3RseS4KCgogIGZ1bmN0aW9uIGFwcGx5VGV4dE5vZGVNZXJnaW5nRml4KGRvY3VtZW50LCBET01DbGFzcykgewogICAgaWYgKCFkb2N1bWVudCkgcmV0dXJuIERPTUNsYXNzOwoKICAgIGlmICghc2hvdWxkQXBwbHlGaXgkMShkb2N1bWVudCkpIHsKICAgICAgcmV0dXJuIERPTUNsYXNzOwogICAgfQoKICAgIHJldHVybiAoCiAgICAgIC8qI19fUFVSRV9fKi8KICAgICAgZnVuY3Rpb24gKF9ET01DbGFzczIpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoRE9NQ2hhbmdlc1dpdGhUZXh0Tm9kZU1lcmdpbmdGaXgsIF9ET01DbGFzczIpOwoKICAgICAgICBmdW5jdGlvbiBET01DaGFuZ2VzV2l0aFRleHROb2RlTWVyZ2luZ0ZpeChkb2N1bWVudCkgewogICAgICAgICAgdmFyIF90aGlzMTI7CgogICAgICAgICAgX3RoaXMxMiA9IF9ET01DbGFzczIuY2FsbCh0aGlzLCBkb2N1bWVudCkgfHwgdGhpczsKICAgICAgICAgIF90aGlzMTIudXNlbGVzc0NvbW1lbnQgPSBkb2N1bWVudC5jcmVhdGVDb21tZW50KCcnKTsKICAgICAgICAgIHJldHVybiBfdGhpczEyOwogICAgICAgIH0KCiAgICAgICAgdmFyIF9wcm90bzI2ID0gRE9NQ2hhbmdlc1dpdGhUZXh0Tm9kZU1lcmdpbmdGaXgucHJvdG90eXBlOwoKICAgICAgICBfcHJvdG8yNi5pbnNlcnRIVE1MQmVmb3JlID0gZnVuY3Rpb24gaW5zZXJ0SFRNTEJlZm9yZShwYXJlbnQsIG5leHRTaWJsaW5nLCBodG1sKSB7CiAgICAgICAgICBpZiAoaHRtbCA9PT0gJycpIHsKICAgICAgICAgICAgcmV0dXJuIF9ET01DbGFzczIucHJvdG90eXBlLmluc2VydEhUTUxCZWZvcmUuY2FsbCh0aGlzLCBwYXJlbnQsIG5leHRTaWJsaW5nLCBodG1sKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgZGlkU2V0VXNlbGVzc0NvbW1lbnQgPSBmYWxzZTsKICAgICAgICAgIHZhciBuZXh0UHJldmlvdXMgPSBuZXh0U2libGluZyA/IG5leHRTaWJsaW5nLnByZXZpb3VzU2libGluZyA6IHBhcmVudC5sYXN0Q2hpbGQ7CgogICAgICAgICAgaWYgKG5leHRQcmV2aW91cyAmJiBuZXh0UHJldmlvdXMgaW5zdGFuY2VvZiBUZXh0KSB7CiAgICAgICAgICAgIGRpZFNldFVzZWxlc3NDb21tZW50ID0gdHJ1ZTsKICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZSh0aGlzLnVzZWxlc3NDb21tZW50LCBuZXh0U2libGluZyk7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGJvdW5kcyA9IF9ET01DbGFzczIucHJvdG90eXBlLmluc2VydEhUTUxCZWZvcmUuY2FsbCh0aGlzLCBwYXJlbnQsIG5leHRTaWJsaW5nLCBodG1sKTsKCiAgICAgICAgICBpZiAoZGlkU2V0VXNlbGVzc0NvbW1lbnQpIHsKICAgICAgICAgICAgcGFyZW50LnJlbW92ZUNoaWxkKHRoaXMudXNlbGVzc0NvbW1lbnQpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBib3VuZHM7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIERPTUNoYW5nZXNXaXRoVGV4dE5vZGVNZXJnaW5nRml4OwogICAgICB9KERPTUNsYXNzKQogICAgKTsKICB9CgogIGZ1bmN0aW9uIHNob3VsZEFwcGx5Rml4JDEoZG9jdW1lbnQpIHsKICAgIHZhciBtZXJnaW5nVGV4dERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgbWVyZ2luZ1RleHREaXYuaW5uZXJIVE1MID0gJ2ZpcnN0JzsKICAgIG1lcmdpbmdUZXh0RGl2Lmluc2VydEFkamFjZW50SFRNTCgnYmVmb3JlZW5kJywgJ3NlY29uZCcpOwoKICAgIGlmIChtZXJnaW5nVGV4dERpdi5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMikgewogICAgICAvLyBJdCB3b3JrZWQgYXMgZXhwZWN0ZWQsIG5vIGZpeCByZXF1aXJlZAogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfQoKICB2YXIgU1ZHX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKICAvKiBTVkcgKi8KICA7IC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2h0bWwvc3ludGF4Lmh0bWwjaHRtbC1pbnRlZ3JhdGlvbi1wb2ludAoKICBfZXhwb3J0cy5TVkdfTkFNRVNQQUNFID0gU1ZHX05BTUVTUEFDRTsKICB2YXIgU1ZHX0lOVEVHUkFUSU9OX1BPSU5UUyA9IHsKICAgIGZvcmVpZ25PYmplY3Q6IDEsCiAgICBkZXNjOiAxLAogICAgdGl0bGU6IDEKICB9OyAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9odG1sL3N5bnRheC5odG1sI2FkanVzdC1zdmctYXR0cmlidXRlcwogIC8vIFRPRE86IEFkanVzdCBTVkcgYXR0cmlidXRlcwogIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2h0bWwvc3ludGF4Lmh0bWwjcGFyc2luZy1tYWluLWluZm9yZWlnbgogIC8vIFRPRE86IEFkanVzdCBTVkcgZWxlbWVudHMKICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9odG1sL3N5bnRheC5odG1sI3BhcnNpbmctbWFpbi1pbmZvcmVpZ24KCiAgdmFyIEJMQUNLTElTVF9UQUJMRSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgWydiJywgJ2JpZycsICdibG9ja3F1b3RlJywgJ2JvZHknLCAnYnInLCAnY2VudGVyJywgJ2NvZGUnLCAnZGQnLCAnZGl2JywgJ2RsJywgJ2R0JywgJ2VtJywgJ2VtYmVkJywgJ2gxJywgJ2gyJywgJ2gzJywgJ2g0JywgJ2g1JywgJ2g2JywgJ2hlYWQnLCAnaHInLCAnaScsICdpbWcnLCAnbGknLCAnbGlzdGluZycsICdtYWluJywgJ21ldGEnLCAnbm9icicsICdvbCcsICdwJywgJ3ByZScsICdydWJ5JywgJ3MnLCAnc21hbGwnLCAnc3BhbicsICdzdHJvbmcnLCAnc3RyaWtlJywgJ3N1YicsICdzdXAnLCAndGFibGUnLCAndHQnLCAndScsICd1bCcsICd2YXInXS5mb3JFYWNoKGZ1bmN0aW9uICh0YWcpIHsKICAgIHJldHVybiBCTEFDS0xJU1RfVEFCTEVbdGFnXSA9IDE7CiAgfSk7CiAgdmFyIFdISVRFU1BBQ0UgPSAvW1x0LVxyIFx4QTBcdTE2ODBcdTE4MEVcdTIwMDAtXHUyMDBBXHUyMDI4XHUyMDI5XHUyMDJGXHUyMDVGXHUzMDAwXHVGRUZGXS87CiAgdmFyIGRvYyA9IHR5cGVvZiBkb2N1bWVudCA9PT0gJ3VuZGVmaW5lZCcgPyBudWxsIDogZG9jdW1lbnQ7CgogIGZ1bmN0aW9uIGlzV2hpdGVzcGFjZShzdHJpbmcpIHsKICAgIHJldHVybiBXSElURVNQQUNFLnRlc3Qoc3RyaW5nKTsKICB9CgogIGZ1bmN0aW9uIG1vdmVOb2Rlc0JlZm9yZShzb3VyY2UsIHRhcmdldCwgbmV4dFNpYmxpbmcpIHsKICAgIHZhciBmaXJzdCA9IHNvdXJjZS5maXJzdENoaWxkOwogICAgdmFyIGxhc3QgPSBmaXJzdDsKICAgIHZhciBjdXJyZW50ID0gZmlyc3Q7CgogICAgd2hpbGUgKGN1cnJlbnQpIHsKICAgICAgdmFyIG5leHQgPSBjdXJyZW50Lm5leHRTaWJsaW5nOwogICAgICB0YXJnZXQuaW5zZXJ0QmVmb3JlKGN1cnJlbnQsIG5leHRTaWJsaW5nKTsKICAgICAgbGFzdCA9IGN1cnJlbnQ7CiAgICAgIGN1cnJlbnQgPSBuZXh0OwogICAgfQoKICAgIHJldHVybiBuZXcgQ29uY3JldGVCb3VuZHModGFyZ2V0LCBmaXJzdCwgbGFzdCk7CiAgfQoKICB2YXIgRE9NT3BlcmF0aW9ucyA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIERPTU9wZXJhdGlvbnMoZG9jdW1lbnQpIHsKICAgICAgdGhpcy5kb2N1bWVudCA9IGRvY3VtZW50OwogICAgICB0aGlzLnNldHVwVXNlbGVzc0VsZW1lbnQoKTsKICAgIH0gLy8gc3BsaXQgaW50byBzZXBlcmF0ZSBtZXRob2Qgc28gdGhhdCBOb2RlRE9NVHJlZUNvbnN0cnVjdGlvbgogICAgLy8gY2FuIG92ZXJyaWRlIGl0LgoKCiAgICB2YXIgX3Byb3RvMjcgPSBET01PcGVyYXRpb25zLnByb3RvdHlwZTsKCiAgICBfcHJvdG8yNy5zZXR1cFVzZWxlc3NFbGVtZW50ID0gZnVuY3Rpb24gc2V0dXBVc2VsZXNzRWxlbWVudCgpIHsKICAgICAgdGhpcy51c2VsZXNzRWxlbWVudCA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICB9OwoKICAgIF9wcm90bzI3LmNyZWF0ZUVsZW1lbnQgPSBmdW5jdGlvbiBjcmVhdGVFbGVtZW50KHRhZywgY29udGV4dCkgewogICAgICB2YXIgaXNFbGVtZW50SW5TVkdOYW1lc3BhY2UsIGlzSFRNTEludGVncmF0aW9uUG9pbnQ7CgogICAgICBpZiAoY29udGV4dCkgewogICAgICAgIGlzRWxlbWVudEluU1ZHTmFtZXNwYWNlID0gY29udGV4dC5uYW1lc3BhY2VVUkkgPT09IFNWR19OQU1FU1BBQ0UgfHwgdGFnID09PSAnc3ZnJzsKICAgICAgICBpc0hUTUxJbnRlZ3JhdGlvblBvaW50ID0gU1ZHX0lOVEVHUkFUSU9OX1BPSU5UU1tjb250ZXh0LnRhZ05hbWVdOwogICAgICB9IGVsc2UgewogICAgICAgIGlzRWxlbWVudEluU1ZHTmFtZXNwYWNlID0gdGFnID09PSAnc3ZnJzsKICAgICAgICBpc0hUTUxJbnRlZ3JhdGlvblBvaW50ID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmIChpc0VsZW1lbnRJblNWR05hbWVzcGFjZSAmJiAhaXNIVE1MSW50ZWdyYXRpb25Qb2ludCkgewogICAgICAgIC8vIEZJWE1FOiBUaGlzIGRvZXMgbm90IHByb3Blcmx5IGhhbmRsZSA8Zm9udD4gd2l0aCBjb2xvciwgZmFjZSwgb3IKICAgICAgICAvLyBzaXplIGF0dHJpYnV0ZXMsIHdoaWNoIGlzIGFsc28gZGlzYWxsb3dlZCBieSB0aGUgc3BlYy4gV2Ugc2hvdWxkIGZpeAogICAgICAgIC8vIHRoaXMuCiAgICAgICAgaWYgKEJMQUNLTElTVF9UQUJMRVt0YWddKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBjcmVhdGUgYSAiICsgdGFnICsgIiBpbnNpZGUgYW4gU1ZHIGNvbnRleHQiKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhTVkdfTkFNRVNQQUNFLCB0YWcpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8yNy5pbnNlcnRCZWZvcmUgPSBmdW5jdGlvbiBpbnNlcnRCZWZvcmUocGFyZW50LCBub2RlLCByZWZlcmVuY2UpIHsKICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCByZWZlcmVuY2UpOwogICAgfTsKCiAgICBfcHJvdG8yNy5pbnNlcnRIVE1MQmVmb3JlID0gZnVuY3Rpb24gaW5zZXJ0SFRNTEJlZm9yZShwYXJlbnQsIG5leHRTaWJsaW5nLCBodG1sKSB7CiAgICAgIGlmIChodG1sID09PSAnJykgewogICAgICAgIHZhciBjb21tZW50ID0gdGhpcy5jcmVhdGVDb21tZW50KCcnKTsKICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNvbW1lbnQsIG5leHRTaWJsaW5nKTsKICAgICAgICByZXR1cm4gbmV3IENvbmNyZXRlQm91bmRzKHBhcmVudCwgY29tbWVudCwgY29tbWVudCk7CiAgICAgIH0KCiAgICAgIHZhciBwcmV2ID0gbmV4dFNpYmxpbmcgPyBuZXh0U2libGluZy5wcmV2aW91c1NpYmxpbmcgOiBwYXJlbnQubGFzdENoaWxkOwogICAgICB2YXIgbGFzdDsKCiAgICAgIGlmIChuZXh0U2libGluZyA9PT0gbnVsbCkgewogICAgICAgIHBhcmVudC5pbnNlcnRBZGphY2VudEhUTUwoImJlZm9yZWVuZCIKICAgICAgICAvKiBiZWZvcmVlbmQgKi8KICAgICAgICAsIGh0bWwpOwogICAgICAgIGxhc3QgPSBwYXJlbnQubGFzdENoaWxkOwogICAgICB9IGVsc2UgaWYgKG5leHRTaWJsaW5nIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHsKICAgICAgICBuZXh0U2libGluZy5pbnNlcnRBZGphY2VudEhUTUwoImJlZm9yZWJlZ2luIgogICAgICAgIC8qIGJlZm9yZWJlZ2luICovCiAgICAgICAgLCBodG1sKTsKICAgICAgICBsYXN0ID0gbmV4dFNpYmxpbmcucHJldmlvdXNTaWJsaW5nOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIE5vbi1lbGVtZW50IG5vZGVzIGRvIG5vdCBzdXBwb3J0IGluc2VydEFkamFjZW50SFRNTCwgc28gYWRkIGFuCiAgICAgICAgLy8gZWxlbWVudCBhbmQgY2FsbCBpdCBvbiB0aGF0IGVsZW1lbnQuIFRoZW4gcmVtb3ZlIHRoZSBlbGVtZW50LgogICAgICAgIC8vCiAgICAgICAgLy8gVGhpcyBhbHNvIHByb3RlY3RzIEVkZ2UsIElFIGFuZCBGaXJlZm94IHcvbyB0aGUgaW5zcGVjdG9yIG9wZW4KICAgICAgICAvLyBmcm9tIG1lcmdpbmcgYWRqYWNlbnQgdGV4dCBub2Rlcy4gU2VlIC4vY29tcGF0L3RleHQtbm9kZS1tZXJnaW5nLWZpeC50cwogICAgICAgIHZhciB1c2VsZXNzRWxlbWVudCA9IHRoaXMudXNlbGVzc0VsZW1lbnQ7CiAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZSh1c2VsZXNzRWxlbWVudCwgbmV4dFNpYmxpbmcpOwogICAgICAgIHVzZWxlc3NFbGVtZW50Lmluc2VydEFkamFjZW50SFRNTCgiYmVmb3JlYmVnaW4iCiAgICAgICAgLyogYmVmb3JlYmVnaW4gKi8KICAgICAgICAsIGh0bWwpOwogICAgICAgIGxhc3QgPSB1c2VsZXNzRWxlbWVudC5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgcGFyZW50LnJlbW92ZUNoaWxkKHVzZWxlc3NFbGVtZW50KTsKICAgICAgfQoKICAgICAgdmFyIGZpcnN0ID0gcHJldiA/IHByZXYubmV4dFNpYmxpbmcgOiBwYXJlbnQuZmlyc3RDaGlsZDsKICAgICAgcmV0dXJuIG5ldyBDb25jcmV0ZUJvdW5kcyhwYXJlbnQsIGZpcnN0LCBsYXN0KTsKICAgIH07CgogICAgX3Byb3RvMjcuY3JlYXRlVGV4dE5vZGUgPSBmdW5jdGlvbiBjcmVhdGVUZXh0Tm9kZSh0ZXh0KSB7CiAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpOwogICAgfTsKCiAgICBfcHJvdG8yNy5jcmVhdGVDb21tZW50ID0gZnVuY3Rpb24gY3JlYXRlQ29tbWVudChkYXRhKSB7CiAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoZGF0YSk7CiAgICB9OwoKICAgIHJldHVybiBET01PcGVyYXRpb25zOwogIH0oKTsKCiAgdmFyIERPTTsKCiAgKGZ1bmN0aW9uIChET00pIHsKICAgIHZhciBUcmVlQ29uc3RydWN0aW9uID0KICAgIC8qI19fUFVSRV9fKi8KICAgIGZ1bmN0aW9uIChfRE9NT3BlcmF0aW9ucykgewogICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoVHJlZUNvbnN0cnVjdGlvbiwgX0RPTU9wZXJhdGlvbnMpOwoKICAgICAgZnVuY3Rpb24gVHJlZUNvbnN0cnVjdGlvbigpIHsKICAgICAgICByZXR1cm4gX0RPTU9wZXJhdGlvbnMuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgICB9CgogICAgICB2YXIgX3Byb3RvMjggPSBUcmVlQ29uc3RydWN0aW9uLnByb3RvdHlwZTsKCiAgICAgIF9wcm90bzI4LmNyZWF0ZUVsZW1lbnROUyA9IGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2UsIHRhZykgewogICAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2UsIHRhZyk7CiAgICAgIH07CgogICAgICBfcHJvdG8yOC5zZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbiBzZXRBdHRyaWJ1dGUoZWxlbWVudCwgbmFtZSwgdmFsdWUkJDEsIG5hbWVzcGFjZSkgewogICAgICAgIGlmIChuYW1lc3BhY2UgPT09IHZvaWQgMCkgewogICAgICAgICAgbmFtZXNwYWNlID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChuYW1lc3BhY2UpIHsKICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlTlMobmFtZXNwYWNlLCBuYW1lLCB2YWx1ZSQkMSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlJCQxKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICByZXR1cm4gVHJlZUNvbnN0cnVjdGlvbjsKICAgIH0oRE9NT3BlcmF0aW9ucyk7CgogICAgRE9NLlRyZWVDb25zdHJ1Y3Rpb24gPSBUcmVlQ29uc3RydWN0aW9uOwogICAgdmFyIGFwcGxpZWRUcmVlQ29udHJ1Y3Rpb24gPSBUcmVlQ29uc3RydWN0aW9uOwogICAgYXBwbGllZFRyZWVDb250cnVjdGlvbiA9IGFwcGx5VGV4dE5vZGVNZXJnaW5nRml4KGRvYywgYXBwbGllZFRyZWVDb250cnVjdGlvbik7CiAgICBhcHBsaWVkVHJlZUNvbnRydWN0aW9uID0gYXBwbHlTVkdJbm5lckhUTUxGaXgoZG9jLCBhcHBsaWVkVHJlZUNvbnRydWN0aW9uLCBTVkdfTkFNRVNQQUNFKTsKICAgIERPTS5ET01UcmVlQ29uc3RydWN0aW9uID0gYXBwbGllZFRyZWVDb250cnVjdGlvbjsKICB9KShET00gfHwgKERPTSA9IHt9KSk7CgogIHZhciBET01DaGFuZ2VzID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9ET01PcGVyYXRpb25zMikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKERPTUNoYW5nZXMsIF9ET01PcGVyYXRpb25zMik7CgogICAgZnVuY3Rpb24gRE9NQ2hhbmdlcyhkb2N1bWVudCkgewogICAgICB2YXIgX3RoaXMxMzsKCiAgICAgIF90aGlzMTMgPSBfRE9NT3BlcmF0aW9uczIuY2FsbCh0aGlzLCBkb2N1bWVudCkgfHwgdGhpczsKICAgICAgX3RoaXMxMy5kb2N1bWVudCA9IGRvY3VtZW50OwogICAgICBfdGhpczEzLm5hbWVzcGFjZSA9IG51bGw7CiAgICAgIHJldHVybiBfdGhpczEzOwogICAgfQoKICAgIHZhciBfcHJvdG8yOSA9IERPTUNoYW5nZXMucHJvdG90eXBlOwoKICAgIF9wcm90bzI5LnNldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uIHNldEF0dHJpYnV0ZShlbGVtZW50LCBuYW1lLCB2YWx1ZSQkMSkgewogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSQkMSk7CiAgICB9OwoKICAgIF9wcm90bzI5LnJlbW92ZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uIHJlbW92ZUF0dHJpYnV0ZShlbGVtZW50LCBuYW1lKSB7CiAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwogICAgfTsKCiAgICBfcHJvdG8yOS5pbnNlcnRBZnRlciA9IGZ1bmN0aW9uIGluc2VydEFmdGVyKGVsZW1lbnQsIG5vZGUsIHJlZmVyZW5jZSkgewogICAgICB0aGlzLmluc2VydEJlZm9yZShlbGVtZW50LCBub2RlLCByZWZlcmVuY2UubmV4dFNpYmxpbmcpOwogICAgfTsKCiAgICByZXR1cm4gRE9NQ2hhbmdlczsKICB9KERPTU9wZXJhdGlvbnMpOwoKICBfZXhwb3J0cy5JRE9NQ2hhbmdlcyA9IERPTUNoYW5nZXM7CiAgdmFyIGhlbHBlciA9IERPTUNoYW5nZXM7CiAgaGVscGVyID0gYXBwbHlUZXh0Tm9kZU1lcmdpbmdGaXgoZG9jLCBoZWxwZXIpOwogIGhlbHBlciA9IGFwcGx5U1ZHSW5uZXJIVE1MRml4KGRvYywgaGVscGVyLCBTVkdfTkFNRVNQQUNFKTsKICB2YXIgaGVscGVyJDEgPSBoZWxwZXI7CiAgX2V4cG9ydHMuRE9NQ2hhbmdlcyA9IGhlbHBlciQxOwogIHZhciBET01UcmVlQ29uc3RydWN0aW9uID0gRE9NLkRPTVRyZWVDb25zdHJ1Y3Rpb247CiAgX2V4cG9ydHMuRE9NVHJlZUNvbnN0cnVjdGlvbiA9IERPTVRyZWVDb25zdHJ1Y3Rpb247CiAgdmFyIGJhZFByb3RvY29scyA9IFsnamF2YXNjcmlwdDonLCAndmJzY3JpcHQ6J107CiAgdmFyIGJhZFRhZ3MgPSBbJ0EnLCAnQk9EWScsICdMSU5LJywgJ0lNRycsICdJRlJBTUUnLCAnQkFTRScsICdGT1JNJ107CiAgdmFyIGJhZFRhZ3NGb3JEYXRhVVJJID0gWydFTUJFRCddOwogIHZhciBiYWRBdHRyaWJ1dGVzID0gWydocmVmJywgJ3NyYycsICdiYWNrZ3JvdW5kJywgJ2FjdGlvbiddOwogIHZhciBiYWRBdHRyaWJ1dGVzRm9yRGF0YVVSSSA9IFsnc3JjJ107CgogIGZ1bmN0aW9uIGhhcyhhcnJheSwgaXRlbSkgewogICAgcmV0dXJuIGFycmF5LmluZGV4T2YoaXRlbSkgIT09IC0xOwogIH0KCiAgZnVuY3Rpb24gY2hlY2tVUkkodGFnTmFtZSwgYXR0cmlidXRlKSB7CiAgICByZXR1cm4gKHRhZ05hbWUgPT09IG51bGwgfHwgaGFzKGJhZFRhZ3MsIHRhZ05hbWUpKSAmJiBoYXMoYmFkQXR0cmlidXRlcywgYXR0cmlidXRlKTsKICB9CgogIGZ1bmN0aW9uIGNoZWNrRGF0YVVSSSh0YWdOYW1lLCBhdHRyaWJ1dGUpIHsKICAgIGlmICh0YWdOYW1lID09PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICByZXR1cm4gaGFzKGJhZFRhZ3NGb3JEYXRhVVJJLCB0YWdOYW1lKSAmJiBoYXMoYmFkQXR0cmlidXRlc0ZvckRhdGFVUkksIGF0dHJpYnV0ZSk7CiAgfQoKICBmdW5jdGlvbiByZXF1aXJlc1Nhbml0aXphdGlvbih0YWdOYW1lLCBhdHRyaWJ1dGUpIHsKICAgIHJldHVybiBjaGVja1VSSSh0YWdOYW1lLCBhdHRyaWJ1dGUpIHx8IGNoZWNrRGF0YVVSSSh0YWdOYW1lLCBhdHRyaWJ1dGUpOwogIH0KCiAgZnVuY3Rpb24gc2FuaXRpemVBdHRyaWJ1dGVWYWx1ZShlbnYsIGVsZW1lbnQsIGF0dHJpYnV0ZSwgdmFsdWUkJDEpIHsKICAgIHZhciB0YWdOYW1lID0gbnVsbDsKCiAgICBpZiAodmFsdWUkJDEgPT09IG51bGwgfHwgdmFsdWUkJDEgPT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gdmFsdWUkJDE7CiAgICB9CgogICAgaWYgKGlzU2FmZVN0cmluZyh2YWx1ZSQkMSkpIHsKICAgICAgcmV0dXJuIHZhbHVlJCQxLnRvSFRNTCgpOwogICAgfQoKICAgIGlmICghZWxlbWVudCkgewogICAgICB0YWdOYW1lID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHRhZ05hbWUgPSBlbGVtZW50LnRhZ05hbWUudG9VcHBlckNhc2UoKTsKICAgIH0KCiAgICB2YXIgc3RyID0gbm9ybWFsaXplU3RyaW5nVmFsdWUodmFsdWUkJDEpOwoKICAgIGlmIChjaGVja1VSSSh0YWdOYW1lLCBhdHRyaWJ1dGUpKSB7CiAgICAgIHZhciBwcm90b2NvbCA9IGVudi5wcm90b2NvbEZvclVSTChzdHIpOwoKICAgICAgaWYgKGhhcyhiYWRQcm90b2NvbHMsIHByb3RvY29sKSkgewogICAgICAgIHJldHVybiAidW5zYWZlOiIgKyBzdHI7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoY2hlY2tEYXRhVVJJKHRhZ05hbWUsIGF0dHJpYnV0ZSkpIHsKICAgICAgcmV0dXJuICJ1bnNhZmU6IiArIHN0cjsKICAgIH0KCiAgICByZXR1cm4gc3RyOwogIH0KICAvKgogICAqIEBtZXRob2Qgbm9ybWFsaXplUHJvcGVydHkKICAgKiBAcGFyYW0gZWxlbWVudCB7SFRNTEVsZW1lbnR9CiAgICogQHBhcmFtIHNsb3ROYW1lIHtTdHJpbmd9CiAgICogQHJldHVybnMge09iamVjdH0geyBuYW1lLCB0eXBlIH0KICAgKi8KCgogIGZ1bmN0aW9uIG5vcm1hbGl6ZVByb3BlcnR5KGVsZW1lbnQsIHNsb3ROYW1lKSB7CiAgICB2YXIgdHlwZSwgbm9ybWFsaXplZDsKCiAgICBpZiAoc2xvdE5hbWUgaW4gZWxlbWVudCkgewogICAgICBub3JtYWxpemVkID0gc2xvdE5hbWU7CiAgICAgIHR5cGUgPSAncHJvcCc7CiAgICB9IGVsc2UgewogICAgICB2YXIgbG93ZXIgPSBzbG90TmFtZS50b0xvd2VyQ2FzZSgpOwoKICAgICAgaWYgKGxvd2VyIGluIGVsZW1lbnQpIHsKICAgICAgICB0eXBlID0gJ3Byb3AnOwogICAgICAgIG5vcm1hbGl6ZWQgPSBsb3dlcjsKICAgICAgfSBlbHNlIHsKICAgICAgICB0eXBlID0gJ2F0dHInOwogICAgICAgIG5vcm1hbGl6ZWQgPSBzbG90TmFtZTsKICAgICAgfQogICAgfQoKICAgIGlmICh0eXBlID09PSAncHJvcCcgJiYgKG5vcm1hbGl6ZWQudG9Mb3dlckNhc2UoKSA9PT0gJ3N0eWxlJyB8fCBwcmVmZXJBdHRyKGVsZW1lbnQudGFnTmFtZSwgbm9ybWFsaXplZCkpKSB7CiAgICAgIHR5cGUgPSAnYXR0cic7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgbm9ybWFsaXplZDogbm9ybWFsaXplZCwKICAgICAgdHlwZTogdHlwZQogICAgfTsKICB9IC8vIHByb3BlcnRpZXMgdGhhdCBNVVNUIGJlIHNldCBhcyBhdHRyaWJ1dGVzLCBkdWUgdG86CiAgLy8gKiBicm93c2VyIGJ1ZwogIC8vICogc3RyYW5nZSBzcGVjIG91dGxpZXIKCgogIHZhciBBVFRSX09WRVJSSURFUyA9IHsKICAgIElOUFVUOiB7CiAgICAgIGZvcm06IHRydWUsCiAgICAgIC8vIENocm9tZSA0Ni4wLjI0NjQuMDogJ2F1dG9jb3JyZWN0JyBpbiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpID09PSBmYWxzZQogICAgICAvLyBTYWZhcmkgOC4wLjc6ICdhdXRvY29ycmVjdCcgaW4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKSA9PT0gZmFsc2UKICAgICAgLy8gTW9iaWxlIFNhZmFyaSAoaU9TIDguNCBzaW11bGF0b3IpOiAnYXV0b2NvcnJlY3QnIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0JykgPT09IHRydWUKICAgICAgYXV0b2NvcnJlY3Q6IHRydWUsCiAgICAgIC8vIENocm9tZSA1NC4wLjI4NDAuOTg6ICdsaXN0JyBpbiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpID09PSB0cnVlCiAgICAgIC8vIFNhZmFyaSA5LjEuMzogJ2xpc3QnIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0JykgPT09IGZhbHNlCiAgICAgIGxpc3Q6IHRydWUKICAgIH0sCiAgICAvLyBlbGVtZW50LmZvcm0gaXMgYWN0dWFsbHkgYSBsZWdpdGltYXRlIHJlYWRPbmx5IHByb3BlcnR5LCB0aGF0IGlzIHRvIGJlCiAgICAvLyBtdXRhdGVkLCBidXQgbXVzdCBiZSBtdXRhdGVkIGJ5IHNldEF0dHJpYnV0ZS4uLgogICAgU0VMRUNUOiB7CiAgICAgIGZvcm06IHRydWUKICAgIH0sCiAgICBPUFRJT046IHsKICAgICAgZm9ybTogdHJ1ZQogICAgfSwKICAgIFRFWFRBUkVBOiB7CiAgICAgIGZvcm06IHRydWUKICAgIH0sCiAgICBMQUJFTDogewogICAgICBmb3JtOiB0cnVlCiAgICB9LAogICAgRklFTERTRVQ6IHsKICAgICAgZm9ybTogdHJ1ZQogICAgfSwKICAgIExFR0VORDogewogICAgICBmb3JtOiB0cnVlCiAgICB9LAogICAgT0JKRUNUOiB7CiAgICAgIGZvcm06IHRydWUKICAgIH0sCiAgICBCVVRUT046IHsKICAgICAgZm9ybTogdHJ1ZQogICAgfQogIH07CgogIGZ1bmN0aW9uIHByZWZlckF0dHIodGFnTmFtZSwgcHJvcE5hbWUpIHsKICAgIHZhciB0YWcgPSBBVFRSX09WRVJSSURFU1t0YWdOYW1lLnRvVXBwZXJDYXNlKCldOwogICAgcmV0dXJuIHRhZyAmJiB0YWdbcHJvcE5hbWUudG9Mb3dlckNhc2UoKV0gfHwgZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBkeW5hbWljQXR0cmlidXRlKGVsZW1lbnQsIGF0dHIsIG5hbWVzcGFjZSkgewogICAgdmFyIHRhZ05hbWUgPSBlbGVtZW50LnRhZ05hbWUsCiAgICAgICAgbmFtZXNwYWNlVVJJID0gZWxlbWVudC5uYW1lc3BhY2VVUkk7CiAgICB2YXIgYXR0cmlidXRlID0gewogICAgICBlbGVtZW50OiBlbGVtZW50LAogICAgICBuYW1lOiBhdHRyLAogICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZQogICAgfTsKCiAgICBpZiAobmFtZXNwYWNlVVJJID09PSBTVkdfTkFNRVNQQUNFKSB7CiAgICAgIHJldHVybiBidWlsZER5bmFtaWNBdHRyaWJ1dGUodGFnTmFtZSwgYXR0ciwgYXR0cmlidXRlKTsKICAgIH0KCiAgICB2YXIgX25vcm1hbGl6ZVByb3BlcnR5ID0gbm9ybWFsaXplUHJvcGVydHkoZWxlbWVudCwgYXR0ciksCiAgICAgICAgdHlwZSA9IF9ub3JtYWxpemVQcm9wZXJ0eS50eXBlLAogICAgICAgIG5vcm1hbGl6ZWQgPSBfbm9ybWFsaXplUHJvcGVydHkubm9ybWFsaXplZDsKCiAgICBpZiAodHlwZSA9PT0gJ2F0dHInKSB7CiAgICAgIHJldHVybiBidWlsZER5bmFtaWNBdHRyaWJ1dGUodGFnTmFtZSwgbm9ybWFsaXplZCwgYXR0cmlidXRlKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBidWlsZER5bmFtaWNQcm9wZXJ0eSh0YWdOYW1lLCBub3JtYWxpemVkLCBhdHRyaWJ1dGUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gYnVpbGREeW5hbWljQXR0cmlidXRlKHRhZ05hbWUsIG5hbWUsIGF0dHJpYnV0ZSkgewogICAgaWYgKHJlcXVpcmVzU2FuaXRpemF0aW9uKHRhZ05hbWUsIG5hbWUpKSB7CiAgICAgIHJldHVybiBuZXcgU2FmZUR5bmFtaWNBdHRyaWJ1dGUoYXR0cmlidXRlKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgU2ltcGxlRHluYW1pY0F0dHJpYnV0ZShhdHRyaWJ1dGUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gYnVpbGREeW5hbWljUHJvcGVydHkodGFnTmFtZSwgbmFtZSwgYXR0cmlidXRlKSB7CiAgICBpZiAocmVxdWlyZXNTYW5pdGl6YXRpb24odGFnTmFtZSwgbmFtZSkpIHsKICAgICAgcmV0dXJuIG5ldyBTYWZlRHluYW1pY1Byb3BlcnR5KG5hbWUsIGF0dHJpYnV0ZSk7CiAgICB9CgogICAgaWYgKGlzVXNlcklucHV0VmFsdWUodGFnTmFtZSwgbmFtZSkpIHsKICAgICAgcmV0dXJuIG5ldyBJbnB1dFZhbHVlRHluYW1pY0F0dHJpYnV0ZShuYW1lLCBhdHRyaWJ1dGUpOwogICAgfQoKICAgIGlmIChpc09wdGlvblNlbGVjdGVkKHRhZ05hbWUsIG5hbWUpKSB7CiAgICAgIHJldHVybiBuZXcgT3B0aW9uU2VsZWN0ZWREeW5hbWljQXR0cmlidXRlKG5hbWUsIGF0dHJpYnV0ZSk7CiAgICB9CgogICAgcmV0dXJuIG5ldyBEZWZhdWx0RHluYW1pY1Byb3BlcnR5KG5hbWUsIGF0dHJpYnV0ZSk7CiAgfQoKICB2YXIgRHluYW1pY0F0dHJpYnV0ZSA9IGZ1bmN0aW9uIER5bmFtaWNBdHRyaWJ1dGUoYXR0cmlidXRlKSB7CiAgICB0aGlzLmF0dHJpYnV0ZSA9IGF0dHJpYnV0ZTsKICB9OwoKICBfZXhwb3J0cy5EeW5hbWljQXR0cmlidXRlID0gRHluYW1pY0F0dHJpYnV0ZTsKCiAgdmFyIFNpbXBsZUR5bmFtaWNBdHRyaWJ1dGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0R5bmFtaWNBdHRyaWJ1dGUpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShTaW1wbGVEeW5hbWljQXR0cmlidXRlLCBfRHluYW1pY0F0dHJpYnV0ZSk7CgogICAgZnVuY3Rpb24gU2ltcGxlRHluYW1pY0F0dHJpYnV0ZSgpIHsKICAgICAgcmV0dXJuIF9EeW5hbWljQXR0cmlidXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgIH0KCiAgICB2YXIgX3Byb3RvMzAgPSBTaW1wbGVEeW5hbWljQXR0cmlidXRlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8zMC5zZXQgPSBmdW5jdGlvbiBzZXQoZG9tLCB2YWx1ZSQkMSwgX2VudikgewogICAgICB2YXIgbm9ybWFsaXplZFZhbHVlID0gbm9ybWFsaXplVmFsdWUodmFsdWUkJDEpOwoKICAgICAgaWYgKG5vcm1hbGl6ZWRWYWx1ZSAhPT0gbnVsbCkgewogICAgICAgIHZhciBfdGhpcyRhdHRyaWJ1dGUgPSB0aGlzLmF0dHJpYnV0ZSwKICAgICAgICAgICAgbmFtZSA9IF90aGlzJGF0dHJpYnV0ZS5uYW1lLAogICAgICAgICAgICBuYW1lc3BhY2UgPSBfdGhpcyRhdHRyaWJ1dGUubmFtZXNwYWNlOwoKICAgICAgICBkb20uX19zZXRBdHRyaWJ1dGUobmFtZSwgbm9ybWFsaXplZFZhbHVlLCBuYW1lc3BhY2UpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzMwLnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZSh2YWx1ZSQkMSwgX2VudikgewogICAgICB2YXIgbm9ybWFsaXplZFZhbHVlID0gbm9ybWFsaXplVmFsdWUodmFsdWUkJDEpOwogICAgICB2YXIgX3RoaXMkYXR0cmlidXRlMiA9IHRoaXMuYXR0cmlidXRlLAogICAgICAgICAgZWxlbWVudCA9IF90aGlzJGF0dHJpYnV0ZTIuZWxlbWVudCwKICAgICAgICAgIG5hbWUgPSBfdGhpcyRhdHRyaWJ1dGUyLm5hbWU7CgogICAgICBpZiAobm9ybWFsaXplZFZhbHVlID09PSBudWxsKSB7CiAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUobmFtZSwgbm9ybWFsaXplZFZhbHVlKTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gU2ltcGxlRHluYW1pY0F0dHJpYnV0ZTsKICB9KER5bmFtaWNBdHRyaWJ1dGUpOwoKICBfZXhwb3J0cy5TaW1wbGVEeW5hbWljQXR0cmlidXRlID0gU2ltcGxlRHluYW1pY0F0dHJpYnV0ZTsKCiAgdmFyIERlZmF1bHREeW5hbWljUHJvcGVydHkgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0R5bmFtaWNBdHRyaWJ1dGUyKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoRGVmYXVsdER5bmFtaWNQcm9wZXJ0eSwgX0R5bmFtaWNBdHRyaWJ1dGUyKTsKCiAgICBmdW5jdGlvbiBEZWZhdWx0RHluYW1pY1Byb3BlcnR5KG5vcm1hbGl6ZWROYW1lLCBhdHRyaWJ1dGUpIHsKICAgICAgdmFyIF90aGlzMTQ7CgogICAgICBfdGhpczE0ID0gX0R5bmFtaWNBdHRyaWJ1dGUyLmNhbGwodGhpcywgYXR0cmlidXRlKSB8fCB0aGlzOwogICAgICBfdGhpczE0Lm5vcm1hbGl6ZWROYW1lID0gbm9ybWFsaXplZE5hbWU7CiAgICAgIHJldHVybiBfdGhpczE0OwogICAgfQoKICAgIHZhciBfcHJvdG8zMSA9IERlZmF1bHREeW5hbWljUHJvcGVydHkucHJvdG90eXBlOwoKICAgIF9wcm90bzMxLnNldCA9IGZ1bmN0aW9uIHNldChkb20sIHZhbHVlJCQxLCBfZW52KSB7CiAgICAgIGlmICh2YWx1ZSQkMSAhPT0gbnVsbCAmJiB2YWx1ZSQkMSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlJCQxOwoKICAgICAgICBkb20uX19zZXRQcm9wZXJ0eSh0aGlzLm5vcm1hbGl6ZWROYW1lLCB2YWx1ZSQkMSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMzEudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlKHZhbHVlJCQxLCBfZW52KSB7CiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5hdHRyaWJ1dGUuZWxlbWVudDsKCiAgICAgIGlmICh0aGlzLnZhbHVlICE9PSB2YWx1ZSQkMSkgewogICAgICAgIGVsZW1lbnRbdGhpcy5ub3JtYWxpemVkTmFtZV0gPSB0aGlzLnZhbHVlID0gdmFsdWUkJDE7CgogICAgICAgIGlmICh2YWx1ZSQkMSA9PT0gbnVsbCB8fCB2YWx1ZSQkMSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0aGlzLnJlbW92ZUF0dHJpYnV0ZSgpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8zMS5yZW1vdmVBdHRyaWJ1dGUgPSBmdW5jdGlvbiByZW1vdmVBdHRyaWJ1dGUoKSB7CiAgICAgIC8vIFRPRE8gdGhpcyBzdWNrcyBidXQgdG8gcHJlc2VydmUgcHJvcGVydGllcyBmaXJzdCBhbmQgdG8gbWVldCBjdXJyZW50CiAgICAgIC8vIHNlbWFudGljcyB3ZSBtdXN0IGRvIHRoaXMuCiAgICAgIHZhciBfdGhpcyRhdHRyaWJ1dGUzID0gdGhpcy5hdHRyaWJ1dGUsCiAgICAgICAgICBlbGVtZW50ID0gX3RoaXMkYXR0cmlidXRlMy5lbGVtZW50LAogICAgICAgICAgbmFtZXNwYWNlID0gX3RoaXMkYXR0cmlidXRlMy5uYW1lc3BhY2U7CgogICAgICBpZiAobmFtZXNwYWNlKSB7CiAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGVOUyhuYW1lc3BhY2UsIHRoaXMubm9ybWFsaXplZE5hbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKHRoaXMubm9ybWFsaXplZE5hbWUpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBEZWZhdWx0RHluYW1pY1Byb3BlcnR5OwogIH0oRHluYW1pY0F0dHJpYnV0ZSk7CgogIHZhciBTYWZlRHluYW1pY1Byb3BlcnR5ID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9EZWZhdWx0RHluYW1pY1Byb3BlcikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKFNhZmVEeW5hbWljUHJvcGVydHksIF9EZWZhdWx0RHluYW1pY1Byb3Blcik7CgogICAgZnVuY3Rpb24gU2FmZUR5bmFtaWNQcm9wZXJ0eSgpIHsKICAgICAgcmV0dXJuIF9EZWZhdWx0RHluYW1pY1Byb3Blci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICB9CgogICAgdmFyIF9wcm90bzMyID0gU2FmZUR5bmFtaWNQcm9wZXJ0eS5wcm90b3R5cGU7CgogICAgX3Byb3RvMzIuc2V0ID0gZnVuY3Rpb24gc2V0KGRvbSwgdmFsdWUkJDEsIGVudikgewogICAgICB2YXIgX3RoaXMkYXR0cmlidXRlNCA9IHRoaXMuYXR0cmlidXRlLAogICAgICAgICAgZWxlbWVudCA9IF90aGlzJGF0dHJpYnV0ZTQuZWxlbWVudCwKICAgICAgICAgIG5hbWUgPSBfdGhpcyRhdHRyaWJ1dGU0Lm5hbWU7CiAgICAgIHZhciBzYW5pdGl6ZWQgPSBzYW5pdGl6ZUF0dHJpYnV0ZVZhbHVlKGVudiwgZWxlbWVudCwgbmFtZSwgdmFsdWUkJDEpOwoKICAgICAgX0RlZmF1bHREeW5hbWljUHJvcGVyLnByb3RvdHlwZS5zZXQuY2FsbCh0aGlzLCBkb20sIHNhbml0aXplZCwgZW52KTsKICAgIH07CgogICAgX3Byb3RvMzIudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlKHZhbHVlJCQxLCBlbnYpIHsKICAgICAgdmFyIF90aGlzJGF0dHJpYnV0ZTUgPSB0aGlzLmF0dHJpYnV0ZSwKICAgICAgICAgIGVsZW1lbnQgPSBfdGhpcyRhdHRyaWJ1dGU1LmVsZW1lbnQsCiAgICAgICAgICBuYW1lID0gX3RoaXMkYXR0cmlidXRlNS5uYW1lOwogICAgICB2YXIgc2FuaXRpemVkID0gc2FuaXRpemVBdHRyaWJ1dGVWYWx1ZShlbnYsIGVsZW1lbnQsIG5hbWUsIHZhbHVlJCQxKTsKCiAgICAgIF9EZWZhdWx0RHluYW1pY1Byb3Blci5wcm90b3R5cGUudXBkYXRlLmNhbGwodGhpcywgc2FuaXRpemVkLCBlbnYpOwogICAgfTsKCiAgICByZXR1cm4gU2FmZUR5bmFtaWNQcm9wZXJ0eTsKICB9KERlZmF1bHREeW5hbWljUHJvcGVydHkpOwoKICB2YXIgU2FmZUR5bmFtaWNBdHRyaWJ1dGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX1NpbXBsZUR5bmFtaWNBdHRyaWJ1KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoU2FmZUR5bmFtaWNBdHRyaWJ1dGUsIF9TaW1wbGVEeW5hbWljQXR0cmlidSk7CgogICAgZnVuY3Rpb24gU2FmZUR5bmFtaWNBdHRyaWJ1dGUoKSB7CiAgICAgIHJldHVybiBfU2ltcGxlRHluYW1pY0F0dHJpYnUuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG8zMyA9IFNhZmVEeW5hbWljQXR0cmlidXRlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8zMy5zZXQgPSBmdW5jdGlvbiBzZXQoZG9tLCB2YWx1ZSQkMSwgZW52KSB7CiAgICAgIHZhciBfdGhpcyRhdHRyaWJ1dGU2ID0gdGhpcy5hdHRyaWJ1dGUsCiAgICAgICAgICBlbGVtZW50ID0gX3RoaXMkYXR0cmlidXRlNi5lbGVtZW50LAogICAgICAgICAgbmFtZSA9IF90aGlzJGF0dHJpYnV0ZTYubmFtZTsKICAgICAgdmFyIHNhbml0aXplZCA9IHNhbml0aXplQXR0cmlidXRlVmFsdWUoZW52LCBlbGVtZW50LCBuYW1lLCB2YWx1ZSQkMSk7CgogICAgICBfU2ltcGxlRHluYW1pY0F0dHJpYnUucHJvdG90eXBlLnNldC5jYWxsKHRoaXMsIGRvbSwgc2FuaXRpemVkLCBlbnYpOwogICAgfTsKCiAgICBfcHJvdG8zMy51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUodmFsdWUkJDEsIGVudikgewogICAgICB2YXIgX3RoaXMkYXR0cmlidXRlNyA9IHRoaXMuYXR0cmlidXRlLAogICAgICAgICAgZWxlbWVudCA9IF90aGlzJGF0dHJpYnV0ZTcuZWxlbWVudCwKICAgICAgICAgIG5hbWUgPSBfdGhpcyRhdHRyaWJ1dGU3Lm5hbWU7CiAgICAgIHZhciBzYW5pdGl6ZWQgPSBzYW5pdGl6ZUF0dHJpYnV0ZVZhbHVlKGVudiwgZWxlbWVudCwgbmFtZSwgdmFsdWUkJDEpOwoKICAgICAgX1NpbXBsZUR5bmFtaWNBdHRyaWJ1LnByb3RvdHlwZS51cGRhdGUuY2FsbCh0aGlzLCBzYW5pdGl6ZWQsIGVudik7CiAgICB9OwoKICAgIHJldHVybiBTYWZlRHluYW1pY0F0dHJpYnV0ZTsKICB9KFNpbXBsZUR5bmFtaWNBdHRyaWJ1dGUpOwoKICB2YXIgSW5wdXRWYWx1ZUR5bmFtaWNBdHRyaWJ1dGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0RlZmF1bHREeW5hbWljUHJvcGVyMikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKElucHV0VmFsdWVEeW5hbWljQXR0cmlidXRlLCBfRGVmYXVsdER5bmFtaWNQcm9wZXIyKTsKCiAgICBmdW5jdGlvbiBJbnB1dFZhbHVlRHluYW1pY0F0dHJpYnV0ZSgpIHsKICAgICAgcmV0dXJuIF9EZWZhdWx0RHluYW1pY1Byb3BlcjIuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG8zNCA9IElucHV0VmFsdWVEeW5hbWljQXR0cmlidXRlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8zNC5zZXQgPSBmdW5jdGlvbiBzZXQoZG9tLCB2YWx1ZSQkMSkgewogICAgICBkb20uX19zZXRQcm9wZXJ0eSgndmFsdWUnLCBub3JtYWxpemVTdHJpbmdWYWx1ZSh2YWx1ZSQkMSkpOwogICAgfTsKCiAgICBfcHJvdG8zNC51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUodmFsdWUkJDEpIHsKICAgICAgdmFyIGlucHV0ID0gdGhpcy5hdHRyaWJ1dGUuZWxlbWVudDsKICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9IGlucHV0LnZhbHVlOwogICAgICB2YXIgbm9ybWFsaXplZFZhbHVlID0gbm9ybWFsaXplU3RyaW5nVmFsdWUodmFsdWUkJDEpOwoKICAgICAgaWYgKGN1cnJlbnRWYWx1ZSAhPT0gbm9ybWFsaXplZFZhbHVlKSB7CiAgICAgICAgaW5wdXQudmFsdWUgPSBub3JtYWxpemVkVmFsdWU7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIElucHV0VmFsdWVEeW5hbWljQXR0cmlidXRlOwogIH0oRGVmYXVsdER5bmFtaWNQcm9wZXJ0eSk7CgogIHZhciBPcHRpb25TZWxlY3RlZER5bmFtaWNBdHRyaWJ1dGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0RlZmF1bHREeW5hbWljUHJvcGVyMykgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKE9wdGlvblNlbGVjdGVkRHluYW1pY0F0dHJpYnV0ZSwgX0RlZmF1bHREeW5hbWljUHJvcGVyMyk7CgogICAgZnVuY3Rpb24gT3B0aW9uU2VsZWN0ZWREeW5hbWljQXR0cmlidXRlKCkgewogICAgICByZXR1cm4gX0RlZmF1bHREeW5hbWljUHJvcGVyMy5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICB9CgogICAgdmFyIF9wcm90bzM1ID0gT3B0aW9uU2VsZWN0ZWREeW5hbWljQXR0cmlidXRlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8zNS5zZXQgPSBmdW5jdGlvbiBzZXQoZG9tLCB2YWx1ZSQkMSkgewogICAgICBpZiAodmFsdWUkJDEgIT09IG51bGwgJiYgdmFsdWUkJDEgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSQkMSAhPT0gZmFsc2UpIHsKICAgICAgICBkb20uX19zZXRQcm9wZXJ0eSgnc2VsZWN0ZWQnLCB0cnVlKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8zNS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUodmFsdWUkJDEpIHsKICAgICAgdmFyIG9wdGlvbiA9IHRoaXMuYXR0cmlidXRlLmVsZW1lbnQ7CgogICAgICBpZiAodmFsdWUkJDEpIHsKICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IGZhbHNlOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBPcHRpb25TZWxlY3RlZER5bmFtaWNBdHRyaWJ1dGU7CiAgfShEZWZhdWx0RHluYW1pY1Byb3BlcnR5KTsKCiAgZnVuY3Rpb24gaXNPcHRpb25TZWxlY3RlZCh0YWdOYW1lLCBhdHRyaWJ1dGUpIHsKICAgIHJldHVybiB0YWdOYW1lID09PSAnT1BUSU9OJyAmJiBhdHRyaWJ1dGUgPT09ICdzZWxlY3RlZCc7CiAgfQoKICBmdW5jdGlvbiBpc1VzZXJJbnB1dFZhbHVlKHRhZ05hbWUsIGF0dHJpYnV0ZSkgewogICAgcmV0dXJuICh0YWdOYW1lID09PSAnSU5QVVQnIHx8IHRhZ05hbWUgPT09ICdURVhUQVJFQScpICYmIGF0dHJpYnV0ZSA9PT0gJ3ZhbHVlJzsKICB9CgogIGZ1bmN0aW9uIG5vcm1hbGl6ZVZhbHVlKHZhbHVlJCQxKSB7CiAgICBpZiAodmFsdWUkJDEgPT09IGZhbHNlIHx8IHZhbHVlJCQxID09PSB1bmRlZmluZWQgfHwgdmFsdWUkJDEgPT09IG51bGwgfHwgdHlwZW9mIHZhbHVlJCQxLnRvU3RyaW5nID09PSAndW5kZWZpbmVkJykgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBpZiAodmFsdWUkJDEgPT09IHRydWUpIHsKICAgICAgcmV0dXJuICcnOwogICAgfSAvLyBvbmNsaWNrIGZ1bmN0aW9uIGV0YyBpbiBTU1IKCgogICAgaWYgKHR5cGVvZiB2YWx1ZSQkMSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICByZXR1cm4gU3RyaW5nKHZhbHVlJCQxKTsKICB9CgogIHZhciBTY29wZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFNjb3BlKCAvLyB0aGUgMHRoIHNsb3QgaXMgYHNlbGZgCiAgICBzbG90cywgY2FsbGVyU2NvcGUsIC8vIG5hbWVkIGFyZ3VtZW50cyBhbmQgYmxvY2tzIHBhc3NlZCB0byBhIGxheW91dCB0aGF0IHVzZXMgZXZhbAogICAgZXZhbFNjb3BlLCAvLyBsb2NhbHMgaW4gc2NvcGUgd2hlbiB0aGUgcGFydGlhbCB3YXMgaW52b2tlZAogICAgcGFydGlhbE1hcCkgewogICAgICB0aGlzLnNsb3RzID0gc2xvdHM7CiAgICAgIHRoaXMuY2FsbGVyU2NvcGUgPSBjYWxsZXJTY29wZTsKICAgICAgdGhpcy5ldmFsU2NvcGUgPSBldmFsU2NvcGU7CiAgICAgIHRoaXMucGFydGlhbE1hcCA9IHBhcnRpYWxNYXA7CiAgICB9CgogICAgU2NvcGUucm9vdCA9IGZ1bmN0aW9uIHJvb3Qoc2VsZiwgc2l6ZSkgewogICAgICBpZiAoc2l6ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgc2l6ZSA9IDA7CiAgICAgIH0KCiAgICAgIHZhciByZWZzID0gbmV3IEFycmF5KHNpemUgKyAxKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IHNpemU7IGkrKykgewogICAgICAgIHJlZnNbaV0gPSBVTkRFRklORURfUkVGRVJFTkNFOwogICAgICB9CgogICAgICByZXR1cm4gbmV3IFNjb3BlKHJlZnMsIG51bGwsIG51bGwsIG51bGwpLmluaXQoewogICAgICAgIHNlbGY6IHNlbGYKICAgICAgfSk7CiAgICB9OwoKICAgIFNjb3BlLnNpemVkID0gZnVuY3Rpb24gc2l6ZWQoc2l6ZSkgewogICAgICBpZiAoc2l6ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgc2l6ZSA9IDA7CiAgICAgIH0KCiAgICAgIHZhciByZWZzID0gbmV3IEFycmF5KHNpemUgKyAxKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IHNpemU7IGkrKykgewogICAgICAgIHJlZnNbaV0gPSBVTkRFRklORURfUkVGRVJFTkNFOwogICAgICB9CgogICAgICByZXR1cm4gbmV3IFNjb3BlKHJlZnMsIG51bGwsIG51bGwsIG51bGwpOwogICAgfTsKCiAgICB2YXIgX3Byb3RvMzYgPSBTY29wZS5wcm90b3R5cGU7CgogICAgX3Byb3RvMzYuaW5pdCA9IGZ1bmN0aW9uIGluaXQoX3JlZjU1KSB7CiAgICAgIHZhciBzZWxmID0gX3JlZjU1LnNlbGY7CiAgICAgIHRoaXMuc2xvdHNbMF0gPSBzZWxmOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgX3Byb3RvMzYuZ2V0U2VsZiA9IGZ1bmN0aW9uIGdldFNlbGYoKSB7CiAgICAgIHJldHVybiB0aGlzLmdldCgwKTsKICAgIH07CgogICAgX3Byb3RvMzYuZ2V0U3ltYm9sID0gZnVuY3Rpb24gZ2V0U3ltYm9sKHN5bWJvbCkgewogICAgICByZXR1cm4gdGhpcy5nZXQoc3ltYm9sKTsKICAgIH07CgogICAgX3Byb3RvMzYuZ2V0QmxvY2sgPSBmdW5jdGlvbiBnZXRCbG9jayhzeW1ib2wpIHsKICAgICAgdmFyIGJsb2NrID0gdGhpcy5nZXQoc3ltYm9sKTsKICAgICAgcmV0dXJuIGJsb2NrID09PSBVTkRFRklORURfUkVGRVJFTkNFID8gbnVsbCA6IGJsb2NrOwogICAgfTsKCiAgICBfcHJvdG8zNi5nZXRFdmFsU2NvcGUgPSBmdW5jdGlvbiBnZXRFdmFsU2NvcGUoKSB7CiAgICAgIHJldHVybiB0aGlzLmV2YWxTY29wZTsKICAgIH07CgogICAgX3Byb3RvMzYuZ2V0UGFydGlhbE1hcCA9IGZ1bmN0aW9uIGdldFBhcnRpYWxNYXAoKSB7CiAgICAgIHJldHVybiB0aGlzLnBhcnRpYWxNYXA7CiAgICB9OwoKICAgIF9wcm90bzM2LmJpbmQgPSBmdW5jdGlvbiBiaW5kKHN5bWJvbCwgdmFsdWUkJDEpIHsKICAgICAgdGhpcy5zZXQoc3ltYm9sLCB2YWx1ZSQkMSk7CiAgICB9OwoKICAgIF9wcm90bzM2LmJpbmRTZWxmID0gZnVuY3Rpb24gYmluZFNlbGYoc2VsZikgewogICAgICB0aGlzLnNldCgwLCBzZWxmKTsKICAgIH07CgogICAgX3Byb3RvMzYuYmluZFN5bWJvbCA9IGZ1bmN0aW9uIGJpbmRTeW1ib2woc3ltYm9sLCB2YWx1ZSQkMSkgewogICAgICB0aGlzLnNldChzeW1ib2wsIHZhbHVlJCQxKTsKICAgIH07CgogICAgX3Byb3RvMzYuYmluZEJsb2NrID0gZnVuY3Rpb24gYmluZEJsb2NrKHN5bWJvbCwgdmFsdWUkJDEpIHsKICAgICAgdGhpcy5zZXQoc3ltYm9sLCB2YWx1ZSQkMSk7CiAgICB9OwoKICAgIF9wcm90bzM2LmJpbmRFdmFsU2NvcGUgPSBmdW5jdGlvbiBiaW5kRXZhbFNjb3BlKG1hcCkgewogICAgICB0aGlzLmV2YWxTY29wZSA9IG1hcDsKICAgIH07CgogICAgX3Byb3RvMzYuYmluZFBhcnRpYWxNYXAgPSBmdW5jdGlvbiBiaW5kUGFydGlhbE1hcChtYXApIHsKICAgICAgdGhpcy5wYXJ0aWFsTWFwID0gbWFwOwogICAgfTsKCiAgICBfcHJvdG8zNi5iaW5kQ2FsbGVyU2NvcGUgPSBmdW5jdGlvbiBiaW5kQ2FsbGVyU2NvcGUoc2NvcGUpIHsKICAgICAgdGhpcy5jYWxsZXJTY29wZSA9IHNjb3BlOwogICAgfTsKCiAgICBfcHJvdG8zNi5nZXRDYWxsZXJTY29wZSA9IGZ1bmN0aW9uIGdldENhbGxlclNjb3BlKCkgewogICAgICByZXR1cm4gdGhpcy5jYWxsZXJTY29wZTsKICAgIH07CgogICAgX3Byb3RvMzYuY2hpbGQgPSBmdW5jdGlvbiBjaGlsZCgpIHsKICAgICAgcmV0dXJuIG5ldyBTY29wZSh0aGlzLnNsb3RzLnNsaWNlKCksIHRoaXMuY2FsbGVyU2NvcGUsIHRoaXMuZXZhbFNjb3BlLCB0aGlzLnBhcnRpYWxNYXApOwogICAgfTsKCiAgICBfcHJvdG8zNi5nZXQgPSBmdW5jdGlvbiBnZXQoaW5kZXgpIHsKICAgICAgaWYgKGluZGV4ID49IHRoaXMuc2xvdHMubGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkJVRzogY2Fubm90IGdldCAkIiArIGluZGV4ICsgIiBmcm9tIHNjb3BlOyBsZW5ndGg9IiArIHRoaXMuc2xvdHMubGVuZ3RoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuc2xvdHNbaW5kZXhdOwogICAgfTsKCiAgICBfcHJvdG8zNi5zZXQgPSBmdW5jdGlvbiBzZXQoaW5kZXgsIHZhbHVlJCQxKSB7CiAgICAgIGlmIChpbmRleCA+PSB0aGlzLnNsb3RzLmxlbmd0aCkgewogICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJCVUc6IGNhbm5vdCBnZXQgJCIgKyBpbmRleCArICIgZnJvbSBzY29wZTsgbGVuZ3RoPSIgKyB0aGlzLnNsb3RzLmxlbmd0aCk7CiAgICAgIH0KCiAgICAgIHRoaXMuc2xvdHNbaW5kZXhdID0gdmFsdWUkJDE7CiAgICB9OwoKICAgIHJldHVybiBTY29wZTsKICB9KCk7CgogIF9leHBvcnRzLlNjb3BlID0gU2NvcGU7CgogIHZhciBUcmFuc2FjdGlvbiA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFRyYW5zYWN0aW9uKCkgewogICAgICB0aGlzLnNjaGVkdWxlZEluc3RhbGxNYW5hZ2VycyA9IFtdOwogICAgICB0aGlzLnNjaGVkdWxlZEluc3RhbGxNb2RpZmllcnMgPSBbXTsKICAgICAgdGhpcy5zY2hlZHVsZWRVcGRhdGVNb2RpZmllck1hbmFnZXJzID0gW107CiAgICAgIHRoaXMuc2NoZWR1bGVkVXBkYXRlTW9kaWZpZXJzID0gW107CiAgICAgIHRoaXMuY3JlYXRlZENvbXBvbmVudHMgPSBbXTsKICAgICAgdGhpcy5jcmVhdGVkTWFuYWdlcnMgPSBbXTsKICAgICAgdGhpcy51cGRhdGVkQ29tcG9uZW50cyA9IFtdOwogICAgICB0aGlzLnVwZGF0ZWRNYW5hZ2VycyA9IFtdOwogICAgICB0aGlzLmRlc3RydWN0b3JzID0gW107CiAgICB9CgogICAgdmFyIF9wcm90bzM3ID0gVHJhbnNhY3Rpb24ucHJvdG90eXBlOwoKICAgIF9wcm90bzM3LmRpZENyZWF0ZSA9IGZ1bmN0aW9uIGRpZENyZWF0ZShjb21wb25lbnQsIG1hbmFnZXIpIHsKICAgICAgdGhpcy5jcmVhdGVkQ29tcG9uZW50cy5wdXNoKGNvbXBvbmVudCk7CiAgICAgIHRoaXMuY3JlYXRlZE1hbmFnZXJzLnB1c2gobWFuYWdlcik7CiAgICB9OwoKICAgIF9wcm90bzM3LmRpZFVwZGF0ZSA9IGZ1bmN0aW9uIGRpZFVwZGF0ZShjb21wb25lbnQsIG1hbmFnZXIpIHsKICAgICAgdGhpcy51cGRhdGVkQ29tcG9uZW50cy5wdXNoKGNvbXBvbmVudCk7CiAgICAgIHRoaXMudXBkYXRlZE1hbmFnZXJzLnB1c2gobWFuYWdlcik7CiAgICB9OwoKICAgIF9wcm90bzM3LnNjaGVkdWxlSW5zdGFsbE1vZGlmaWVyID0gZnVuY3Rpb24gc2NoZWR1bGVJbnN0YWxsTW9kaWZpZXIobW9kaWZpZXIsIG1hbmFnZXIpIHsKICAgICAgdGhpcy5zY2hlZHVsZWRJbnN0YWxsTW9kaWZpZXJzLnB1c2gobW9kaWZpZXIpOwogICAgICB0aGlzLnNjaGVkdWxlZEluc3RhbGxNYW5hZ2Vycy5wdXNoKG1hbmFnZXIpOwogICAgfTsKCiAgICBfcHJvdG8zNy5zY2hlZHVsZVVwZGF0ZU1vZGlmaWVyID0gZnVuY3Rpb24gc2NoZWR1bGVVcGRhdGVNb2RpZmllcihtb2RpZmllciwgbWFuYWdlcikgewogICAgICB0aGlzLnNjaGVkdWxlZFVwZGF0ZU1vZGlmaWVycy5wdXNoKG1vZGlmaWVyKTsKICAgICAgdGhpcy5zY2hlZHVsZWRVcGRhdGVNb2RpZmllck1hbmFnZXJzLnB1c2gobWFuYWdlcik7CiAgICB9OwoKICAgIF9wcm90bzM3LmRpZERlc3Ryb3kgPSBmdW5jdGlvbiBkaWREZXN0cm95KGQpIHsKICAgICAgdGhpcy5kZXN0cnVjdG9ycy5wdXNoKGQpOwogICAgfTsKCiAgICBfcHJvdG8zNy5jb21taXQgPSBmdW5jdGlvbiBjb21taXQoKSB7CiAgICAgIHZhciBjcmVhdGVkQ29tcG9uZW50cyA9IHRoaXMuY3JlYXRlZENvbXBvbmVudHMsCiAgICAgICAgICBjcmVhdGVkTWFuYWdlcnMgPSB0aGlzLmNyZWF0ZWRNYW5hZ2VyczsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY3JlYXRlZENvbXBvbmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgY29tcG9uZW50ID0gY3JlYXRlZENvbXBvbmVudHNbaV07CiAgICAgICAgdmFyIG1hbmFnZXIgPSBjcmVhdGVkTWFuYWdlcnNbaV07CiAgICAgICAgbWFuYWdlci5kaWRDcmVhdGUoY29tcG9uZW50KTsKICAgICAgfQoKICAgICAgdmFyIHVwZGF0ZWRDb21wb25lbnRzID0gdGhpcy51cGRhdGVkQ29tcG9uZW50cywKICAgICAgICAgIHVwZGF0ZWRNYW5hZ2VycyA9IHRoaXMudXBkYXRlZE1hbmFnZXJzOwoKICAgICAgZm9yICh2YXIgX2k0ID0gMDsgX2k0IDwgdXBkYXRlZENvbXBvbmVudHMubGVuZ3RoOyBfaTQrKykgewogICAgICAgIHZhciBfY29tcG9uZW50ID0gdXBkYXRlZENvbXBvbmVudHNbX2k0XTsKICAgICAgICB2YXIgX21hbmFnZXIyID0gdXBkYXRlZE1hbmFnZXJzW19pNF07CgogICAgICAgIF9tYW5hZ2VyMi5kaWRVcGRhdGUoX2NvbXBvbmVudCk7CiAgICAgIH0KCiAgICAgIHZhciBkZXN0cnVjdG9ycyA9IHRoaXMuZGVzdHJ1Y3RvcnM7CgogICAgICBmb3IgKHZhciBfaTUgPSAwOyBfaTUgPCBkZXN0cnVjdG9ycy5sZW5ndGg7IF9pNSsrKSB7CiAgICAgICAgZGVzdHJ1Y3RvcnNbX2k1XS5kZXN0cm95KCk7CiAgICAgIH0KCiAgICAgIHZhciBzY2hlZHVsZWRJbnN0YWxsTWFuYWdlcnMgPSB0aGlzLnNjaGVkdWxlZEluc3RhbGxNYW5hZ2VycywKICAgICAgICAgIHNjaGVkdWxlZEluc3RhbGxNb2RpZmllcnMgPSB0aGlzLnNjaGVkdWxlZEluc3RhbGxNb2RpZmllcnM7CgogICAgICBmb3IgKHZhciBfaTYgPSAwOyBfaTYgPCBzY2hlZHVsZWRJbnN0YWxsTWFuYWdlcnMubGVuZ3RoOyBfaTYrKykgewogICAgICAgIHZhciBtb2RpZmllciA9IHNjaGVkdWxlZEluc3RhbGxNb2RpZmllcnNbX2k2XTsKICAgICAgICB2YXIgX21hbmFnZXIzID0gc2NoZWR1bGVkSW5zdGFsbE1hbmFnZXJzW19pNl07CgogICAgICAgIF9tYW5hZ2VyMy5pbnN0YWxsKG1vZGlmaWVyKTsKICAgICAgfQoKICAgICAgdmFyIHNjaGVkdWxlZFVwZGF0ZU1vZGlmaWVyTWFuYWdlcnMgPSB0aGlzLnNjaGVkdWxlZFVwZGF0ZU1vZGlmaWVyTWFuYWdlcnMsCiAgICAgICAgICBzY2hlZHVsZWRVcGRhdGVNb2RpZmllcnMgPSB0aGlzLnNjaGVkdWxlZFVwZGF0ZU1vZGlmaWVyczsKCiAgICAgIGZvciAodmFyIF9pNyA9IDA7IF9pNyA8IHNjaGVkdWxlZFVwZGF0ZU1vZGlmaWVyTWFuYWdlcnMubGVuZ3RoOyBfaTcrKykgewogICAgICAgIHZhciBfbW9kaWZpZXIgPSBzY2hlZHVsZWRVcGRhdGVNb2RpZmllcnNbX2k3XTsKICAgICAgICB2YXIgX21hbmFnZXI0ID0gc2NoZWR1bGVkVXBkYXRlTW9kaWZpZXJNYW5hZ2Vyc1tfaTddOwoKICAgICAgICBfbWFuYWdlcjQudXBkYXRlKF9tb2RpZmllcik7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIFRyYW5zYWN0aW9uOwogIH0oKTsKCiAgdmFyIEVudmlyb25tZW50ID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRW52aXJvbm1lbnQoX3JlZjU2KSB7CiAgICAgIHZhciBhcHBlbmRPcGVyYXRpb25zID0gX3JlZjU2LmFwcGVuZE9wZXJhdGlvbnMsCiAgICAgICAgICB1cGRhdGVPcGVyYXRpb25zID0gX3JlZjU2LnVwZGF0ZU9wZXJhdGlvbnM7CiAgICAgIHRoaXMuX3RyYW5zYWN0aW9uID0gbnVsbDsKICAgICAgdGhpcy5hcHBlbmRPcGVyYXRpb25zID0gYXBwZW5kT3BlcmF0aW9uczsKICAgICAgdGhpcy51cGRhdGVPcGVyYXRpb25zID0gdXBkYXRlT3BlcmF0aW9uczsKICAgIH0KCiAgICB2YXIgX3Byb3RvMzggPSBFbnZpcm9ubWVudC5wcm90b3R5cGU7CgogICAgX3Byb3RvMzgudG9Db25kaXRpb25hbFJlZmVyZW5jZSA9IGZ1bmN0aW9uIHRvQ29uZGl0aW9uYWxSZWZlcmVuY2UocmVmZXJlbmNlKSB7CiAgICAgIHJldHVybiBuZXcgQ29uZGl0aW9uYWxSZWZlcmVuY2UocmVmZXJlbmNlKTsKICAgIH07CgogICAgX3Byb3RvMzguZ2V0QXBwZW5kT3BlcmF0aW9ucyA9IGZ1bmN0aW9uIGdldEFwcGVuZE9wZXJhdGlvbnMoKSB7CiAgICAgIHJldHVybiB0aGlzLmFwcGVuZE9wZXJhdGlvbnM7CiAgICB9OwoKICAgIF9wcm90bzM4LmdldERPTSA9IGZ1bmN0aW9uIGdldERPTSgpIHsKICAgICAgcmV0dXJuIHRoaXMudXBkYXRlT3BlcmF0aW9uczsKICAgIH07CgogICAgX3Byb3RvMzguYmVnaW4gPSBmdW5jdGlvbiBiZWdpbigpIHsKICAgICAgdGhpcy5fdHJhbnNhY3Rpb24gPSBuZXcgVHJhbnNhY3Rpb24oKTsKICAgIH07CgogICAgX3Byb3RvMzguZGlkQ3JlYXRlID0gZnVuY3Rpb24gZGlkQ3JlYXRlKGNvbXBvbmVudCwgbWFuYWdlcikgewogICAgICB0aGlzLnRyYW5zYWN0aW9uLmRpZENyZWF0ZShjb21wb25lbnQsIG1hbmFnZXIpOwogICAgfTsKCiAgICBfcHJvdG8zOC5kaWRVcGRhdGUgPSBmdW5jdGlvbiBkaWRVcGRhdGUoY29tcG9uZW50LCBtYW5hZ2VyKSB7CiAgICAgIHRoaXMudHJhbnNhY3Rpb24uZGlkVXBkYXRlKGNvbXBvbmVudCwgbWFuYWdlcik7CiAgICB9OwoKICAgIF9wcm90bzM4LnNjaGVkdWxlSW5zdGFsbE1vZGlmaWVyID0gZnVuY3Rpb24gc2NoZWR1bGVJbnN0YWxsTW9kaWZpZXIobW9kaWZpZXIsIG1hbmFnZXIpIHsKICAgICAgdGhpcy50cmFuc2FjdGlvbi5zY2hlZHVsZUluc3RhbGxNb2RpZmllcihtb2RpZmllciwgbWFuYWdlcik7CiAgICB9OwoKICAgIF9wcm90bzM4LnNjaGVkdWxlVXBkYXRlTW9kaWZpZXIgPSBmdW5jdGlvbiBzY2hlZHVsZVVwZGF0ZU1vZGlmaWVyKG1vZGlmaWVyLCBtYW5hZ2VyKSB7CiAgICAgIHRoaXMudHJhbnNhY3Rpb24uc2NoZWR1bGVVcGRhdGVNb2RpZmllcihtb2RpZmllciwgbWFuYWdlcik7CiAgICB9OwoKICAgIF9wcm90bzM4LmRpZERlc3Ryb3kgPSBmdW5jdGlvbiBkaWREZXN0cm95KGQpIHsKICAgICAgdGhpcy50cmFuc2FjdGlvbi5kaWREZXN0cm95KGQpOwogICAgfTsKCiAgICBfcHJvdG8zOC5jb21taXQgPSBmdW5jdGlvbiBjb21taXQoKSB7CiAgICAgIHZhciB0cmFuc2FjdGlvbiA9IHRoaXMudHJhbnNhY3Rpb247CiAgICAgIHRoaXMuX3RyYW5zYWN0aW9uID0gbnVsbDsKICAgICAgdHJhbnNhY3Rpb24uY29tbWl0KCk7CiAgICB9OwoKICAgIF9wcm90bzM4LmF0dHJpYnV0ZUZvciA9IGZ1bmN0aW9uIGF0dHJpYnV0ZUZvcihlbGVtZW50LCBhdHRyLCBfaXNUcnVzdGluZywgbmFtZXNwYWNlKSB7CiAgICAgIGlmIChuYW1lc3BhY2UgPT09IHZvaWQgMCkgewogICAgICAgIG5hbWVzcGFjZSA9IG51bGw7CiAgICAgIH0KCiAgICAgIHJldHVybiBkeW5hbWljQXR0cmlidXRlKGVsZW1lbnQsIGF0dHIsIG5hbWVzcGFjZSk7CiAgICB9OwoKICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoRW52aXJvbm1lbnQsIFt7CiAgICAgIGtleTogInRyYW5zYWN0aW9uIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3RyYW5zYWN0aW9uOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gRW52aXJvbm1lbnQ7CiAgfSgpOwoKICBfZXhwb3J0cy5FbnZpcm9ubWVudCA9IEVudmlyb25tZW50OwoKICB2YXIgRGVmYXVsdEVudmlyb25tZW50ID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9FbnZpcm9ubWVudCkgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKERlZmF1bHRFbnZpcm9ubWVudCwgX0Vudmlyb25tZW50KTsKCiAgICBmdW5jdGlvbiBEZWZhdWx0RW52aXJvbm1lbnQob3B0aW9ucykgewogICAgICBpZiAoIW9wdGlvbnMpIHsKICAgICAgICB2YXIgX2RvY3VtZW50ID0gd2luZG93LmRvY3VtZW50OwogICAgICAgIHZhciBhcHBlbmRPcGVyYXRpb25zID0gbmV3IERPTVRyZWVDb25zdHJ1Y3Rpb24oX2RvY3VtZW50KTsKICAgICAgICB2YXIgdXBkYXRlT3BlcmF0aW9ucyA9IG5ldyBET01DaGFuZ2VzKF9kb2N1bWVudCk7CiAgICAgICAgb3B0aW9ucyA9IHsKICAgICAgICAgIGFwcGVuZE9wZXJhdGlvbnM6IGFwcGVuZE9wZXJhdGlvbnMsCiAgICAgICAgICB1cGRhdGVPcGVyYXRpb25zOiB1cGRhdGVPcGVyYXRpb25zCiAgICAgICAgfTsKICAgICAgfQoKICAgICAgcmV0dXJuIF9FbnZpcm9ubWVudC5jYWxsKHRoaXMsIG9wdGlvbnMpIHx8IHRoaXM7CiAgICB9CgogICAgcmV0dXJuIERlZmF1bHRFbnZpcm9ubWVudDsKICB9KEVudmlyb25tZW50KTsKCiAgX2V4cG9ydHMuRGVmYXVsdEVudmlyb25tZW50ID0gRGVmYXVsdEVudmlyb25tZW50OwoKICB2YXIgTG93TGV2ZWxWTSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIExvd0xldmVsVk0oc3RhY2ssIGhlYXAsIHByb2dyYW0sIGV4dGVybnMsIHBjLCByYSkgewogICAgICBpZiAocGMgPT09IHZvaWQgMCkgewogICAgICAgIHBjID0gLTE7CiAgICAgIH0KCiAgICAgIGlmIChyYSA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmEgPSAtMTsKICAgICAgfQoKICAgICAgdGhpcy5zdGFjayA9IHN0YWNrOwogICAgICB0aGlzLmhlYXAgPSBoZWFwOwogICAgICB0aGlzLnByb2dyYW0gPSBwcm9ncmFtOwogICAgICB0aGlzLmV4dGVybnMgPSBleHRlcm5zOwogICAgICB0aGlzLnBjID0gcGM7CiAgICAgIHRoaXMucmEgPSByYTsKICAgICAgdGhpcy5jdXJyZW50T3BTaXplID0gMDsKICAgIH0gLy8gU3RhcnQgYSBuZXcgZnJhbWUgYW5kIHNhdmUgJHJhIGFuZCAkZnAgb24gdGhlIHN0YWNrCgoKICAgIHZhciBfcHJvdG8zOSA9IExvd0xldmVsVk0ucHJvdG90eXBlOwoKICAgIF9wcm90bzM5LnB1c2hGcmFtZSA9IGZ1bmN0aW9uIHB1c2hGcmFtZSgpIHsKICAgICAgdGhpcy5zdGFjay5wdXNoKHRoaXMucmEpOwogICAgICB0aGlzLnN0YWNrLnB1c2godGhpcy5zdGFjay5mcCk7CiAgICAgIHRoaXMuc3RhY2suZnAgPSB0aGlzLnN0YWNrLnNwIC0gMTsKICAgIH0gLy8gUmVzdG9yZSAkcmEsICRzcCBhbmQgJGZwCiAgICA7CgogICAgX3Byb3RvMzkucG9wRnJhbWUgPSBmdW5jdGlvbiBwb3BGcmFtZSgpIHsKICAgICAgdGhpcy5zdGFjay5zcCA9IHRoaXMuc3RhY2suZnAgLSAxOwogICAgICB0aGlzLnJhID0gdGhpcy5zdGFjay5nZXQoMCk7CiAgICAgIHRoaXMuc3RhY2suZnAgPSB0aGlzLnN0YWNrLmdldCgxKTsKICAgIH07CgogICAgX3Byb3RvMzkucHVzaFNtYWxsRnJhbWUgPSBmdW5jdGlvbiBwdXNoU21hbGxGcmFtZSgpIHsKICAgICAgdGhpcy5zdGFjay5wdXNoKHRoaXMucmEpOwogICAgfTsKCiAgICBfcHJvdG8zOS5wb3BTbWFsbEZyYW1lID0gZnVuY3Rpb24gcG9wU21hbGxGcmFtZSgpIHsKICAgICAgdGhpcy5yYSA9IHRoaXMuc3RhY2sucG9wU21pKCk7CiAgICB9IC8vIEp1bXAgdG8gYW4gYWRkcmVzcyBpbiBgcHJvZ3JhbWAKICAgIDsKCiAgICBfcHJvdG8zOS5nb3RvID0gZnVuY3Rpb24gZ290byhvZmZzZXQpIHsKICAgICAgdmFyIGFkZHIgPSB0aGlzLnBjICsgb2Zmc2V0IC0gdGhpcy5jdXJyZW50T3BTaXplOwogICAgICB0aGlzLnBjID0gYWRkcjsKICAgIH0gLy8gU2F2ZSAkcGMgaW50byAkcmEsIHRoZW4ganVtcCB0byBhIG5ldyBhZGRyZXNzIGluIGBwcm9ncmFtYCAoamFsIGluIE1JUFMpCiAgICA7CgogICAgX3Byb3RvMzkuY2FsbCA9IGZ1bmN0aW9uIGNhbGwoaGFuZGxlKSB7CiAgICAgIHRoaXMucmEgPSB0aGlzLnBjOwogICAgICB0aGlzLnBjID0gdGhpcy5oZWFwLmdldGFkZHIoaGFuZGxlKTsKICAgIH0gLy8gUHV0IGEgc3BlY2lmaWMgYHByb2dyYW1gIGFkZHJlc3MgaW4gJHJhCiAgICA7CgogICAgX3Byb3RvMzkucmV0dXJuVG8gPSBmdW5jdGlvbiByZXR1cm5UbyhvZmZzZXQpIHsKICAgICAgdmFyIGFkZHIgPSB0aGlzLnBjICsgb2Zmc2V0IC0gdGhpcy5jdXJyZW50T3BTaXplOwogICAgICB0aGlzLnJhID0gYWRkcjsKICAgIH0gLy8gUmV0dXJuIHRvIHRoZSBgcHJvZ3JhbWAgYWRkcmVzcyBzdG9yZWQgaW4gJHJhCiAgICA7CgogICAgX3Byb3RvMzkucmV0dXJuID0gZnVuY3Rpb24gX3JldHVybigpIHsKICAgICAgdGhpcy5wYyA9IHRoaXMucmE7CiAgICB9OwoKICAgIF9wcm90bzM5Lm5leHRTdGF0ZW1lbnQgPSBmdW5jdGlvbiBuZXh0U3RhdGVtZW50KCkgewogICAgICB2YXIgcGMgPSB0aGlzLnBjLAogICAgICAgICAgcHJvZ3JhbSA9IHRoaXMucHJvZ3JhbTsKCiAgICAgIGlmIChwYyA9PT0gLTEpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSAvLyBXZSBoYXZlIHRvIHNhdmUgb2ZmIHRoZSBjdXJyZW50IG9wZXJhdGlvbnMgc2l6ZSBzbyB0aGF0CiAgICAgIC8vIHdoZW4gd2UgZG8gYSBqdW1wIHdlIGNhbiBjYWxjdWxhdGUgdGhlIGNvcnJlY3Qgb2Zmc2V0CiAgICAgIC8vIHRvIHdoZXJlIHdlIGFyZSBnb2luZy4gV2UgY2FuJ3Qgc2ltcGx5IGFzayBmb3IgdGhlIHNpemUKICAgICAgLy8gaW4gYSBqdW1wIGJlY2F1c2Ugd2UgaGF2ZSBoYXZlIGFscmVhZHkgaW5jcmVtZW50ZWQgdGhlCiAgICAgIC8vIHByb2dyYW0gY291bnRlciB0byB0aGUgbmV4dCBpbnN0cnVjdGlvbiBwcmlvciB0byBleGVjdXRpbmcuCgoKICAgICAgdmFyIF90aGlzJHByb2dyYW0kb3Bjb2RlID0gdGhpcy5wcm9ncmFtLm9wY29kZShwYyksCiAgICAgICAgICBzaXplID0gX3RoaXMkcHJvZ3JhbSRvcGNvZGUuc2l6ZTsKCiAgICAgIHZhciBvcGVyYXRpb25TaXplID0gdGhpcy5jdXJyZW50T3BTaXplID0gc2l6ZTsKICAgICAgdGhpcy5wYyArPSBvcGVyYXRpb25TaXplOwogICAgICByZXR1cm4gcHJvZ3JhbS5vcGNvZGUocGMpOwogICAgfTsKCiAgICBfcHJvdG8zOS5ldmFsdWF0ZU91dGVyID0gZnVuY3Rpb24gZXZhbHVhdGVPdXRlcihvcGNvZGUsIHZtKSB7CiAgICAgIHsKICAgICAgICB0aGlzLmV2YWx1YXRlSW5uZXIob3Bjb2RlLCB2bSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMzkuZXZhbHVhdGVJbm5lciA9IGZ1bmN0aW9uIGV2YWx1YXRlSW5uZXIob3Bjb2RlLCB2bSkgewogICAgICBpZiAob3Bjb2RlLmlzTWFjaGluZSkgewogICAgICAgIHRoaXMuZXZhbHVhdGVNYWNoaW5lKG9wY29kZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5ldmFsdWF0ZVN5c2NhbGwob3Bjb2RlLCB2bSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMzkuZXZhbHVhdGVNYWNoaW5lID0gZnVuY3Rpb24gZXZhbHVhdGVNYWNoaW5lKG9wY29kZSkgewogICAgICBzd2l0Y2ggKG9wY29kZS50eXBlKSB7CiAgICAgICAgY2FzZSA1NwogICAgICAgIC8qIFB1c2hGcmFtZSAqLwogICAgICAgIDoKICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hGcmFtZSgpOwoKICAgICAgICBjYXNlIDU4CiAgICAgICAgLyogUG9wRnJhbWUgKi8KICAgICAgICA6CiAgICAgICAgICByZXR1cm4gdGhpcy5wb3BGcmFtZSgpOwoKICAgICAgICBjYXNlIDU5CiAgICAgICAgLyogUHVzaFNtYWxsRnJhbWUgKi8KICAgICAgICA6CiAgICAgICAgICByZXR1cm4gdGhpcy5wdXNoU21hbGxGcmFtZSgpOwoKICAgICAgICBjYXNlIDYwCiAgICAgICAgLyogUG9wU21hbGxGcmFtZSAqLwogICAgICAgIDoKICAgICAgICAgIHJldHVybiB0aGlzLnBvcFNtYWxsRnJhbWUoKTsKCiAgICAgICAgY2FzZSA1MAogICAgICAgIC8qIEludm9rZVN0YXRpYyAqLwogICAgICAgIDoKICAgICAgICAgIHJldHVybiB0aGlzLmNhbGwob3Bjb2RlLm9wMSk7CgogICAgICAgIGNhc2UgNDkKICAgICAgICAvKiBJbnZva2VWaXJ0dWFsICovCiAgICAgICAgOgogICAgICAgICAgcmV0dXJuIHRoaXMuY2FsbCh0aGlzLnN0YWNrLnBvcFNtaSgpKTsKCiAgICAgICAgY2FzZSA1MgogICAgICAgIC8qIEp1bXAgKi8KICAgICAgICA6CiAgICAgICAgICByZXR1cm4gdGhpcy5nb3RvKG9wY29kZS5vcDEpOwoKICAgICAgICBjYXNlIDI0CiAgICAgICAgLyogUmV0dXJuICovCiAgICAgICAgOgogICAgICAgICAgcmV0dXJuIHRoaXMucmV0dXJuKCk7CgogICAgICAgIGNhc2UgMjUKICAgICAgICAvKiBSZXR1cm5UbyAqLwogICAgICAgIDoKICAgICAgICAgIHJldHVybiB0aGlzLnJldHVyblRvKG9wY29kZS5vcDEpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzM5LmV2YWx1YXRlU3lzY2FsbCA9IGZ1bmN0aW9uIGV2YWx1YXRlU3lzY2FsbChvcGNvZGUsIHZtKSB7CiAgICAgIEFQUEVORF9PUENPREVTLmV2YWx1YXRlKHZtLCBvcGNvZGUsIG9wY29kZS50eXBlKTsKICAgIH07CgogICAgcmV0dXJuIExvd0xldmVsVk07CiAgfSgpOwoKICB2YXIgRmlyc3QgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBGaXJzdChub2RlKSB7CiAgICAgIHRoaXMubm9kZSA9IG5vZGU7CiAgICB9CgogICAgdmFyIF9wcm90bzQwID0gRmlyc3QucHJvdG90eXBlOwoKICAgIF9wcm90bzQwLmZpcnN0Tm9kZSA9IGZ1bmN0aW9uIGZpcnN0Tm9kZSgpIHsKICAgICAgcmV0dXJuIHRoaXMubm9kZTsKICAgIH07CgogICAgcmV0dXJuIEZpcnN0OwogIH0oKTsKCiAgdmFyIExhc3QgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBMYXN0KG5vZGUpIHsKICAgICAgdGhpcy5ub2RlID0gbm9kZTsKICAgIH0KCiAgICB2YXIgX3Byb3RvNDEgPSBMYXN0LnByb3RvdHlwZTsKCiAgICBfcHJvdG80MS5sYXN0Tm9kZSA9IGZ1bmN0aW9uIGxhc3ROb2RlKCkgewogICAgICByZXR1cm4gdGhpcy5ub2RlOwogICAgfTsKCiAgICByZXR1cm4gTGFzdDsKICB9KCk7CgogIHZhciBOZXdFbGVtZW50QnVpbGRlciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIE5ld0VsZW1lbnRCdWlsZGVyKGVudiwgcGFyZW50Tm9kZSwgbmV4dFNpYmxpbmcpIHsKICAgICAgdGhpcy5jb25zdHJ1Y3RpbmcgPSBudWxsOwogICAgICB0aGlzLm9wZXJhdGlvbnMgPSBudWxsOwogICAgICB0aGlzLmN1cnNvclN0YWNrID0gbmV3IF91dGlsLlN0YWNrKCk7CiAgICAgIHRoaXMubW9kaWZpZXJTdGFjayA9IG5ldyBfdXRpbC5TdGFjaygpOwogICAgICB0aGlzLmJsb2NrU3RhY2sgPSBuZXcgX3V0aWwuU3RhY2soKTsKICAgICAgdGhpcy5wdXNoRWxlbWVudChwYXJlbnROb2RlLCBuZXh0U2libGluZyk7CiAgICAgIHRoaXMuZW52ID0gZW52OwogICAgICB0aGlzLmRvbSA9IGVudi5nZXRBcHBlbmRPcGVyYXRpb25zKCk7CiAgICAgIHRoaXMudXBkYXRlT3BlcmF0aW9ucyA9IGVudi5nZXRET00oKTsKICAgIH0KCiAgICBOZXdFbGVtZW50QnVpbGRlci5mb3JJbml0aWFsUmVuZGVyID0gZnVuY3Rpb24gZm9ySW5pdGlhbFJlbmRlcihlbnYsIGN1cnNvcikgewogICAgICB2YXIgYnVpbGRlciA9IG5ldyB0aGlzKGVudiwgY3Vyc29yLmVsZW1lbnQsIGN1cnNvci5uZXh0U2libGluZyk7CiAgICAgIGJ1aWxkZXIucHVzaFNpbXBsZUJsb2NrKCk7CiAgICAgIHJldHVybiBidWlsZGVyOwogICAgfTsKCiAgICBOZXdFbGVtZW50QnVpbGRlci5yZXN1bWUgPSBmdW5jdGlvbiByZXN1bWUoZW52LCB0cmFja2VyLCBuZXh0U2libGluZykgewogICAgICB2YXIgcGFyZW50Tm9kZSA9IHRyYWNrZXIucGFyZW50RWxlbWVudCgpOwogICAgICB2YXIgc3RhY2sgPSBuZXcgdGhpcyhlbnYsIHBhcmVudE5vZGUsIG5leHRTaWJsaW5nKTsKICAgICAgc3RhY2sucHVzaFNpbXBsZUJsb2NrKCk7CiAgICAgIHN0YWNrLnB1c2hCbG9ja1RyYWNrZXIodHJhY2tlcik7CiAgICAgIHJldHVybiBzdGFjazsKICAgIH07CgogICAgdmFyIF9wcm90bzQyID0gTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlOwoKICAgIF9wcm90bzQyLmV4cGVjdENvbnN0cnVjdGluZyA9IGZ1bmN0aW9uIGV4cGVjdENvbnN0cnVjdGluZyhtZXRob2QpIHsKICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0aW5nOwogICAgfTsKCiAgICBfcHJvdG80Mi5ibG9jayA9IGZ1bmN0aW9uIGJsb2NrKCkgewogICAgICByZXR1cm4gdGhpcy5ibG9ja1N0YWNrLmN1cnJlbnQ7CiAgICB9OwoKICAgIF9wcm90bzQyLnBvcEVsZW1lbnQgPSBmdW5jdGlvbiBwb3BFbGVtZW50KCkgewogICAgICB0aGlzLmN1cnNvclN0YWNrLnBvcCgpOwogICAgICB0aGlzLmN1cnNvclN0YWNrLmN1cnJlbnQ7CiAgICB9OwoKICAgIF9wcm90bzQyLnB1c2hTaW1wbGVCbG9jayA9IGZ1bmN0aW9uIHB1c2hTaW1wbGVCbG9jaygpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaEJsb2NrVHJhY2tlcihuZXcgU2ltcGxlQmxvY2tUcmFja2VyKHRoaXMuZWxlbWVudCkpOwogICAgfTsKCiAgICBfcHJvdG80Mi5wdXNoVXBkYXRhYmxlQmxvY2sgPSBmdW5jdGlvbiBwdXNoVXBkYXRhYmxlQmxvY2soKSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hCbG9ja1RyYWNrZXIobmV3IFVwZGF0YWJsZUJsb2NrVHJhY2tlcih0aGlzLmVsZW1lbnQpKTsKICAgIH07CgogICAgX3Byb3RvNDIucHVzaEJsb2NrTGlzdCA9IGZ1bmN0aW9uIHB1c2hCbG9ja0xpc3QobGlzdCkgewogICAgICByZXR1cm4gdGhpcy5wdXNoQmxvY2tUcmFja2VyKG5ldyBCbG9ja0xpc3RUcmFja2VyKHRoaXMuZWxlbWVudCwgbGlzdCkpOwogICAgfTsKCiAgICBfcHJvdG80Mi5wdXNoQmxvY2tUcmFja2VyID0gZnVuY3Rpb24gcHVzaEJsb2NrVHJhY2tlcih0cmFja2VyLCBpc1JlbW90ZSkgewogICAgICBpZiAoaXNSZW1vdGUgPT09IHZvaWQgMCkgewogICAgICAgIGlzUmVtb3RlID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5ibG9ja1N0YWNrLmN1cnJlbnQ7CgogICAgICBpZiAoY3VycmVudCAhPT0gbnVsbCkgewogICAgICAgIGN1cnJlbnQubmV3RGVzdHJveWFibGUodHJhY2tlcik7CgogICAgICAgIGlmICghaXNSZW1vdGUpIHsKICAgICAgICAgIGN1cnJlbnQuZGlkQXBwZW5kQm91bmRzKHRyYWNrZXIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5fX29wZW5CbG9jaygpOwoKICAgICAgdGhpcy5ibG9ja1N0YWNrLnB1c2godHJhY2tlcik7CiAgICAgIHJldHVybiB0cmFja2VyOwogICAgfTsKCiAgICBfcHJvdG80Mi5wb3BCbG9jayA9IGZ1bmN0aW9uIHBvcEJsb2NrKCkgewogICAgICB0aGlzLmJsb2NrKCkuZmluYWxpemUodGhpcyk7CgogICAgICB0aGlzLl9fY2xvc2VCbG9jaygpOwoKICAgICAgcmV0dXJuIHRoaXMuYmxvY2tTdGFjay5wb3AoKTsKICAgIH07CgogICAgX3Byb3RvNDIuX19vcGVuQmxvY2sgPSBmdW5jdGlvbiBfX29wZW5CbG9jaygpIHt9OwoKICAgIF9wcm90bzQyLl9fY2xvc2VCbG9jayA9IGZ1bmN0aW9uIF9fY2xvc2VCbG9jaygpIHt9IC8vIHRvZG8gcmV0dXJuIHNlZW1zIHVudXNlZAogICAgOwoKICAgIF9wcm90bzQyLm9wZW5FbGVtZW50ID0gZnVuY3Rpb24gb3BlbkVsZW1lbnQodGFnKSB7CiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5fX29wZW5FbGVtZW50KHRhZyk7CgogICAgICB0aGlzLmNvbnN0cnVjdGluZyA9IGVsZW1lbnQ7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfTsKCiAgICBfcHJvdG80Mi5fX29wZW5FbGVtZW50ID0gZnVuY3Rpb24gX19vcGVuRWxlbWVudCh0YWcpIHsKICAgICAgcmV0dXJuIHRoaXMuZG9tLmNyZWF0ZUVsZW1lbnQodGFnLCB0aGlzLmVsZW1lbnQpOwogICAgfTsKCiAgICBfcHJvdG80Mi5mbHVzaEVsZW1lbnQgPSBmdW5jdGlvbiBmbHVzaEVsZW1lbnQobW9kaWZpZXJzKSB7CiAgICAgIHZhciBwYXJlbnQgPSB0aGlzLmVsZW1lbnQ7CiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5jb25zdHJ1Y3Rpbmc7CgogICAgICB0aGlzLl9fZmx1c2hFbGVtZW50KHBhcmVudCwgZWxlbWVudCk7CgogICAgICB0aGlzLmNvbnN0cnVjdGluZyA9IG51bGw7CiAgICAgIHRoaXMub3BlcmF0aW9ucyA9IG51bGw7CiAgICAgIHRoaXMucHVzaE1vZGlmaWVycyhtb2RpZmllcnMpOwogICAgICB0aGlzLnB1c2hFbGVtZW50KGVsZW1lbnQsIG51bGwpOwogICAgICB0aGlzLmRpZE9wZW5FbGVtZW50KGVsZW1lbnQpOwogICAgfTsKCiAgICBfcHJvdG80Mi5fX2ZsdXNoRWxlbWVudCA9IGZ1bmN0aW9uIF9fZmx1c2hFbGVtZW50KHBhcmVudCwgY29uc3RydWN0aW5nKSB7CiAgICAgIHRoaXMuZG9tLmluc2VydEJlZm9yZShwYXJlbnQsIGNvbnN0cnVjdGluZywgdGhpcy5uZXh0U2libGluZyk7CiAgICB9OwoKICAgIF9wcm90bzQyLmNsb3NlRWxlbWVudCA9IGZ1bmN0aW9uIGNsb3NlRWxlbWVudCgpIHsKICAgICAgdGhpcy53aWxsQ2xvc2VFbGVtZW50KCk7CiAgICAgIHRoaXMucG9wRWxlbWVudCgpOwogICAgICByZXR1cm4gdGhpcy5wb3BNb2RpZmllcnMoKTsKICAgIH07CgogICAgX3Byb3RvNDIucHVzaFJlbW90ZUVsZW1lbnQgPSBmdW5jdGlvbiBwdXNoUmVtb3RlRWxlbWVudChlbGVtZW50LCBndWlkLCBuZXh0U2libGluZykgewogICAgICBpZiAobmV4dFNpYmxpbmcgPT09IHZvaWQgMCkgewogICAgICAgIG5leHRTaWJsaW5nID0gbnVsbDsKICAgICAgfQoKICAgICAgdGhpcy5fX3B1c2hSZW1vdGVFbGVtZW50KGVsZW1lbnQsIGd1aWQsIG5leHRTaWJsaW5nKTsKICAgIH07CgogICAgX3Byb3RvNDIuX19wdXNoUmVtb3RlRWxlbWVudCA9IGZ1bmN0aW9uIF9fcHVzaFJlbW90ZUVsZW1lbnQoZWxlbWVudCwgX2d1aWQsIG5leHRTaWJsaW5nKSB7CiAgICAgIHRoaXMucHVzaEVsZW1lbnQoZWxlbWVudCwgbmV4dFNpYmxpbmcpOwogICAgICB2YXIgdHJhY2tlciA9IG5ldyBSZW1vdGVCbG9ja1RyYWNrZXIoZWxlbWVudCk7CiAgICAgIHRoaXMucHVzaEJsb2NrVHJhY2tlcih0cmFja2VyLCB0cnVlKTsKICAgIH07CgogICAgX3Byb3RvNDIucG9wUmVtb3RlRWxlbWVudCA9IGZ1bmN0aW9uIHBvcFJlbW90ZUVsZW1lbnQoKSB7CiAgICAgIHRoaXMucG9wQmxvY2soKTsKICAgICAgdGhpcy5wb3BFbGVtZW50KCk7CiAgICB9OwoKICAgIF9wcm90bzQyLnB1c2hFbGVtZW50ID0gZnVuY3Rpb24gcHVzaEVsZW1lbnQoZWxlbWVudCwgbmV4dFNpYmxpbmcpIHsKICAgICAgdGhpcy5jdXJzb3JTdGFjay5wdXNoKG5ldyBDdXJzb3IoZWxlbWVudCwgbmV4dFNpYmxpbmcpKTsKICAgIH07CgogICAgX3Byb3RvNDIucHVzaE1vZGlmaWVycyA9IGZ1bmN0aW9uIHB1c2hNb2RpZmllcnMobW9kaWZpZXJzKSB7CiAgICAgIHRoaXMubW9kaWZpZXJTdGFjay5wdXNoKG1vZGlmaWVycyk7CiAgICB9OwoKICAgIF9wcm90bzQyLnBvcE1vZGlmaWVycyA9IGZ1bmN0aW9uIHBvcE1vZGlmaWVycygpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kaWZpZXJTdGFjay5wb3AoKTsKICAgIH07CgogICAgX3Byb3RvNDIuZGlkQWRkRGVzdHJveWFibGUgPSBmdW5jdGlvbiBkaWRBZGREZXN0cm95YWJsZShkKSB7CiAgICAgIHRoaXMuYmxvY2soKS5uZXdEZXN0cm95YWJsZShkKTsKICAgIH07CgogICAgX3Byb3RvNDIuZGlkQXBwZW5kQm91bmRzID0gZnVuY3Rpb24gZGlkQXBwZW5kQm91bmRzKGJvdW5kcykgewogICAgICB0aGlzLmJsb2NrKCkuZGlkQXBwZW5kQm91bmRzKGJvdW5kcyk7CiAgICAgIHJldHVybiBib3VuZHM7CiAgICB9OwoKICAgIF9wcm90bzQyLmRpZEFwcGVuZE5vZGUgPSBmdW5jdGlvbiBkaWRBcHBlbmROb2RlKG5vZGUpIHsKICAgICAgdGhpcy5ibG9jaygpLmRpZEFwcGVuZE5vZGUobm9kZSk7CiAgICAgIHJldHVybiBub2RlOwogICAgfTsKCiAgICBfcHJvdG80Mi5kaWRPcGVuRWxlbWVudCA9IGZ1bmN0aW9uIGRpZE9wZW5FbGVtZW50KGVsZW1lbnQpIHsKICAgICAgdGhpcy5ibG9jaygpLm9wZW5FbGVtZW50KGVsZW1lbnQpOwogICAgICByZXR1cm4gZWxlbWVudDsKICAgIH07CgogICAgX3Byb3RvNDIud2lsbENsb3NlRWxlbWVudCA9IGZ1bmN0aW9uIHdpbGxDbG9zZUVsZW1lbnQoKSB7CiAgICAgIHRoaXMuYmxvY2soKS5jbG9zZUVsZW1lbnQoKTsKICAgIH07CgogICAgX3Byb3RvNDIuYXBwZW5kVGV4dCA9IGZ1bmN0aW9uIGFwcGVuZFRleHQoc3RyaW5nKSB7CiAgICAgIHJldHVybiB0aGlzLmRpZEFwcGVuZE5vZGUodGhpcy5fX2FwcGVuZFRleHQoc3RyaW5nKSk7CiAgICB9OwoKICAgIF9wcm90bzQyLl9fYXBwZW5kVGV4dCA9IGZ1bmN0aW9uIF9fYXBwZW5kVGV4dCh0ZXh0KSB7CiAgICAgIHZhciBkb20gPSB0aGlzLmRvbSwKICAgICAgICAgIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCiAgICAgICAgICBuZXh0U2libGluZyA9IHRoaXMubmV4dFNpYmxpbmc7CiAgICAgIHZhciBub2RlID0gZG9tLmNyZWF0ZVRleHROb2RlKHRleHQpOwogICAgICBkb20uaW5zZXJ0QmVmb3JlKGVsZW1lbnQsIG5vZGUsIG5leHRTaWJsaW5nKTsKICAgICAgcmV0dXJuIG5vZGU7CiAgICB9OwoKICAgIF9wcm90bzQyLl9fYXBwZW5kTm9kZSA9IGZ1bmN0aW9uIF9fYXBwZW5kTm9kZShub2RlKSB7CiAgICAgIHRoaXMuZG9tLmluc2VydEJlZm9yZSh0aGlzLmVsZW1lbnQsIG5vZGUsIHRoaXMubmV4dFNpYmxpbmcpOwogICAgICByZXR1cm4gbm9kZTsKICAgIH07CgogICAgX3Byb3RvNDIuX19hcHBlbmRGcmFnbWVudCA9IGZ1bmN0aW9uIF9fYXBwZW5kRnJhZ21lbnQoZnJhZ21lbnQpIHsKICAgICAgdmFyIGZpcnN0ID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKCiAgICAgIGlmIChmaXJzdCkgewogICAgICAgIHZhciByZXQgPSBuZXcgQ29uY3JldGVCb3VuZHModGhpcy5lbGVtZW50LCBmaXJzdCwgZnJhZ21lbnQubGFzdENoaWxkKTsKICAgICAgICB0aGlzLmRvbS5pbnNlcnRCZWZvcmUodGhpcy5lbGVtZW50LCBmcmFnbWVudCwgdGhpcy5uZXh0U2libGluZyk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IFNpbmdsZU5vZGVCb3VuZHModGhpcy5lbGVtZW50LCB0aGlzLl9fYXBwZW5kQ29tbWVudCgnJykpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzQyLl9fYXBwZW5kSFRNTCA9IGZ1bmN0aW9uIF9fYXBwZW5kSFRNTChodG1sKSB7CiAgICAgIHJldHVybiB0aGlzLmRvbS5pbnNlcnRIVE1MQmVmb3JlKHRoaXMuZWxlbWVudCwgdGhpcy5uZXh0U2libGluZywgaHRtbCk7CiAgICB9OwoKICAgIF9wcm90bzQyLmFwcGVuZER5bmFtaWNIVE1MID0gZnVuY3Rpb24gYXBwZW5kRHluYW1pY0hUTUwodmFsdWUkJDEpIHsKICAgICAgdmFyIGJvdW5kcyA9IHRoaXMudHJ1c3RlZENvbnRlbnQodmFsdWUkJDEpOwogICAgICB0aGlzLmRpZEFwcGVuZEJvdW5kcyhib3VuZHMpOwogICAgfTsKCiAgICBfcHJvdG80Mi5hcHBlbmREeW5hbWljVGV4dCA9IGZ1bmN0aW9uIGFwcGVuZER5bmFtaWNUZXh0KHZhbHVlJCQxKSB7CiAgICAgIHZhciBub2RlID0gdGhpcy51bnRydXN0ZWRDb250ZW50KHZhbHVlJCQxKTsKICAgICAgdGhpcy5kaWRBcHBlbmROb2RlKG5vZGUpOwogICAgICByZXR1cm4gbm9kZTsKICAgIH07CgogICAgX3Byb3RvNDIuYXBwZW5kRHluYW1pY0ZyYWdtZW50ID0gZnVuY3Rpb24gYXBwZW5kRHluYW1pY0ZyYWdtZW50KHZhbHVlJCQxKSB7CiAgICAgIHZhciBib3VuZHMgPSB0aGlzLl9fYXBwZW5kRnJhZ21lbnQodmFsdWUkJDEpOwoKICAgICAgdGhpcy5kaWRBcHBlbmRCb3VuZHMoYm91bmRzKTsKICAgIH07CgogICAgX3Byb3RvNDIuYXBwZW5kRHluYW1pY05vZGUgPSBmdW5jdGlvbiBhcHBlbmREeW5hbWljTm9kZSh2YWx1ZSQkMSkgewogICAgICB2YXIgbm9kZSA9IHRoaXMuX19hcHBlbmROb2RlKHZhbHVlJCQxKTsKCiAgICAgIHZhciBib3VuZHMgPSBuZXcgU2luZ2xlTm9kZUJvdW5kcyh0aGlzLmVsZW1lbnQsIG5vZGUpOwogICAgICB0aGlzLmRpZEFwcGVuZEJvdW5kcyhib3VuZHMpOwogICAgfTsKCiAgICBfcHJvdG80Mi50cnVzdGVkQ29udGVudCA9IGZ1bmN0aW9uIHRydXN0ZWRDb250ZW50KHZhbHVlJCQxKSB7CiAgICAgIHJldHVybiB0aGlzLl9fYXBwZW5kSFRNTCh2YWx1ZSQkMSk7CiAgICB9OwoKICAgIF9wcm90bzQyLnVudHJ1c3RlZENvbnRlbnQgPSBmdW5jdGlvbiB1bnRydXN0ZWRDb250ZW50KHZhbHVlJCQxKSB7CiAgICAgIHJldHVybiB0aGlzLl9fYXBwZW5kVGV4dCh2YWx1ZSQkMSk7CiAgICB9OwoKICAgIF9wcm90bzQyLmFwcGVuZENvbW1lbnQgPSBmdW5jdGlvbiBhcHBlbmRDb21tZW50KHN0cmluZykgewogICAgICByZXR1cm4gdGhpcy5kaWRBcHBlbmROb2RlKHRoaXMuX19hcHBlbmRDb21tZW50KHN0cmluZykpOwogICAgfTsKCiAgICBfcHJvdG80Mi5fX2FwcGVuZENvbW1lbnQgPSBmdW5jdGlvbiBfX2FwcGVuZENvbW1lbnQoc3RyaW5nKSB7CiAgICAgIHZhciBkb20gPSB0aGlzLmRvbSwKICAgICAgICAgIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCiAgICAgICAgICBuZXh0U2libGluZyA9IHRoaXMubmV4dFNpYmxpbmc7CiAgICAgIHZhciBub2RlID0gZG9tLmNyZWF0ZUNvbW1lbnQoc3RyaW5nKTsKICAgICAgZG9tLmluc2VydEJlZm9yZShlbGVtZW50LCBub2RlLCBuZXh0U2libGluZyk7CiAgICAgIHJldHVybiBub2RlOwogICAgfTsKCiAgICBfcHJvdG80Mi5fX3NldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uIF9fc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlJCQxLCBuYW1lc3BhY2UpIHsKICAgICAgdGhpcy5kb20uc2V0QXR0cmlidXRlKHRoaXMuY29uc3RydWN0aW5nLCBuYW1lLCB2YWx1ZSQkMSwgbmFtZXNwYWNlKTsKICAgIH07CgogICAgX3Byb3RvNDIuX19zZXRQcm9wZXJ0eSA9IGZ1bmN0aW9uIF9fc2V0UHJvcGVydHkobmFtZSwgdmFsdWUkJDEpIHsKICAgICAgdGhpcy5jb25zdHJ1Y3RpbmdbbmFtZV0gPSB2YWx1ZSQkMTsKICAgIH07CgogICAgX3Byb3RvNDIuc2V0U3RhdGljQXR0cmlidXRlID0gZnVuY3Rpb24gc2V0U3RhdGljQXR0cmlidXRlKG5hbWUsIHZhbHVlJCQxLCBuYW1lc3BhY2UpIHsKICAgICAgdGhpcy5fX3NldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSQkMSwgbmFtZXNwYWNlKTsKICAgIH07CgogICAgX3Byb3RvNDIuc2V0RHluYW1pY0F0dHJpYnV0ZSA9IGZ1bmN0aW9uIHNldER5bmFtaWNBdHRyaWJ1dGUobmFtZSwgdmFsdWUkJDEsIHRydXN0aW5nLCBuYW1lc3BhY2UpIHsKICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmNvbnN0cnVjdGluZzsKICAgICAgdmFyIGF0dHJpYnV0ZSA9IHRoaXMuZW52LmF0dHJpYnV0ZUZvcihlbGVtZW50LCBuYW1lLCB0cnVzdGluZywgbmFtZXNwYWNlKTsKICAgICAgYXR0cmlidXRlLnNldCh0aGlzLCB2YWx1ZSQkMSwgdGhpcy5lbnYpOwogICAgICByZXR1cm4gYXR0cmlidXRlOwogICAgfTsKCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKE5ld0VsZW1lbnRCdWlsZGVyLCBbewogICAgICBrZXk6ICJlbGVtZW50IiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3Vyc29yU3RhY2suY3VycmVudC5lbGVtZW50OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIm5leHRTaWJsaW5nIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3Vyc29yU3RhY2suY3VycmVudC5uZXh0U2libGluZzsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIE5ld0VsZW1lbnRCdWlsZGVyOwogIH0oKTsKCiAgX2V4cG9ydHMuTmV3RWxlbWVudEJ1aWxkZXIgPSBOZXdFbGVtZW50QnVpbGRlcjsKCiAgdmFyIFNpbXBsZUJsb2NrVHJhY2tlciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFNpbXBsZUJsb2NrVHJhY2tlcihwYXJlbnQpIHsKICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAgIHRoaXMuZmlyc3QgPSBudWxsOwogICAgICB0aGlzLmxhc3QgPSBudWxsOwogICAgICB0aGlzLmRlc3Ryb3lhYmxlcyA9IG51bGw7CiAgICAgIHRoaXMubmVzdGluZyA9IDA7CiAgICB9CgogICAgdmFyIF9wcm90bzQzID0gU2ltcGxlQmxvY2tUcmFja2VyLnByb3RvdHlwZTsKCiAgICBfcHJvdG80My5kZXN0cm95ID0gZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgdmFyIGRlc3Ryb3lhYmxlcyA9IHRoaXMuZGVzdHJveWFibGVzOwoKICAgICAgaWYgKGRlc3Ryb3lhYmxlcyAmJiBkZXN0cm95YWJsZXMubGVuZ3RoKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZXN0cm95YWJsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGRlc3Ryb3lhYmxlc1tpXS5kZXN0cm95KCk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzQzLnBhcmVudEVsZW1lbnQgPSBmdW5jdGlvbiBwYXJlbnRFbGVtZW50KCkgewogICAgICByZXR1cm4gdGhpcy5wYXJlbnQ7CiAgICB9OwoKICAgIF9wcm90bzQzLmZpcnN0Tm9kZSA9IGZ1bmN0aW9uIGZpcnN0Tm9kZSgpIHsKICAgICAgdmFyIGZpcnN0ID0gdGhpcy5maXJzdDsKICAgICAgcmV0dXJuIGZpcnN0LmZpcnN0Tm9kZSgpOwogICAgfTsKCiAgICBfcHJvdG80My5sYXN0Tm9kZSA9IGZ1bmN0aW9uIGxhc3ROb2RlKCkgewogICAgICB2YXIgbGFzdCA9IHRoaXMubGFzdDsKICAgICAgcmV0dXJuIGxhc3QubGFzdE5vZGUoKTsKICAgIH07CgogICAgX3Byb3RvNDMub3BlbkVsZW1lbnQgPSBmdW5jdGlvbiBvcGVuRWxlbWVudChlbGVtZW50KSB7CiAgICAgIHRoaXMuZGlkQXBwZW5kTm9kZShlbGVtZW50KTsKICAgICAgdGhpcy5uZXN0aW5nKys7CiAgICB9OwoKICAgIF9wcm90bzQzLmNsb3NlRWxlbWVudCA9IGZ1bmN0aW9uIGNsb3NlRWxlbWVudCgpIHsKICAgICAgdGhpcy5uZXN0aW5nLS07CiAgICB9OwoKICAgIF9wcm90bzQzLmRpZEFwcGVuZE5vZGUgPSBmdW5jdGlvbiBkaWRBcHBlbmROb2RlKG5vZGUpIHsKICAgICAgaWYgKHRoaXMubmVzdGluZyAhPT0gMCkgcmV0dXJuOwoKICAgICAgaWYgKCF0aGlzLmZpcnN0KSB7CiAgICAgICAgdGhpcy5maXJzdCA9IG5ldyBGaXJzdChub2RlKTsKICAgICAgfQoKICAgICAgdGhpcy5sYXN0ID0gbmV3IExhc3Qobm9kZSk7CiAgICB9OwoKICAgIF9wcm90bzQzLmRpZEFwcGVuZEJvdW5kcyA9IGZ1bmN0aW9uIGRpZEFwcGVuZEJvdW5kcyhib3VuZHMpIHsKICAgICAgaWYgKHRoaXMubmVzdGluZyAhPT0gMCkgcmV0dXJuOwoKICAgICAgaWYgKCF0aGlzLmZpcnN0KSB7CiAgICAgICAgdGhpcy5maXJzdCA9IGJvdW5kczsKICAgICAgfQoKICAgICAgdGhpcy5sYXN0ID0gYm91bmRzOwogICAgfTsKCiAgICBfcHJvdG80My5uZXdEZXN0cm95YWJsZSA9IGZ1bmN0aW9uIG5ld0Rlc3Ryb3lhYmxlKGQpIHsKICAgICAgdGhpcy5kZXN0cm95YWJsZXMgPSB0aGlzLmRlc3Ryb3lhYmxlcyB8fCBbXTsKICAgICAgdGhpcy5kZXN0cm95YWJsZXMucHVzaChkKTsKICAgIH07CgogICAgX3Byb3RvNDMuZmluYWxpemUgPSBmdW5jdGlvbiBmaW5hbGl6ZShzdGFjaykgewogICAgICBpZiAodGhpcy5maXJzdCA9PT0gbnVsbCkgewogICAgICAgIHN0YWNrLmFwcGVuZENvbW1lbnQoJycpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBTaW1wbGVCbG9ja1RyYWNrZXI7CiAgfSgpOwoKICB2YXIgUmVtb3RlQmxvY2tUcmFja2VyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9TaW1wbGVCbG9ja1RyYWNrZXIpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShSZW1vdGVCbG9ja1RyYWNrZXIsIF9TaW1wbGVCbG9ja1RyYWNrZXIpOwoKICAgIGZ1bmN0aW9uIFJlbW90ZUJsb2NrVHJhY2tlcigpIHsKICAgICAgcmV0dXJuIF9TaW1wbGVCbG9ja1RyYWNrZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG80NCA9IFJlbW90ZUJsb2NrVHJhY2tlci5wcm90b3R5cGU7CgogICAgX3Byb3RvNDQuZGVzdHJveSA9IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgIF9TaW1wbGVCbG9ja1RyYWNrZXIucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKCiAgICAgIGNsZWFyKHRoaXMpOwogICAgfTsKCiAgICByZXR1cm4gUmVtb3RlQmxvY2tUcmFja2VyOwogIH0oU2ltcGxlQmxvY2tUcmFja2VyKTsKCiAgdmFyIFVwZGF0YWJsZUJsb2NrVHJhY2tlciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfU2ltcGxlQmxvY2tUcmFja2VyMikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKFVwZGF0YWJsZUJsb2NrVHJhY2tlciwgX1NpbXBsZUJsb2NrVHJhY2tlcjIpOwoKICAgIGZ1bmN0aW9uIFVwZGF0YWJsZUJsb2NrVHJhY2tlcigpIHsKICAgICAgcmV0dXJuIF9TaW1wbGVCbG9ja1RyYWNrZXIyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgIH0KCiAgICB2YXIgX3Byb3RvNDUgPSBVcGRhdGFibGVCbG9ja1RyYWNrZXIucHJvdG90eXBlOwoKICAgIF9wcm90bzQ1LnJlc2V0ID0gZnVuY3Rpb24gcmVzZXQoZW52KSB7CiAgICAgIHZhciBkZXN0cm95YWJsZXMgPSB0aGlzLmRlc3Ryb3lhYmxlczsKCiAgICAgIGlmIChkZXN0cm95YWJsZXMgJiYgZGVzdHJveWFibGVzLmxlbmd0aCkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVzdHJveWFibGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBlbnYuZGlkRGVzdHJveShkZXN0cm95YWJsZXNbaV0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIG5leHRTaWJsaW5nID0gY2xlYXIodGhpcyk7CiAgICAgIHRoaXMuZmlyc3QgPSBudWxsOwogICAgICB0aGlzLmxhc3QgPSBudWxsOwogICAgICB0aGlzLmRlc3Ryb3lhYmxlcyA9IG51bGw7CiAgICAgIHRoaXMubmVzdGluZyA9IDA7CiAgICAgIHJldHVybiBuZXh0U2libGluZzsKICAgIH07CgogICAgcmV0dXJuIFVwZGF0YWJsZUJsb2NrVHJhY2tlcjsKICB9KFNpbXBsZUJsb2NrVHJhY2tlcik7CgogIHZhciBCbG9ja0xpc3RUcmFja2VyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQmxvY2tMaXN0VHJhY2tlcihwYXJlbnQsIGJvdW5kTGlzdCkgewogICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgdGhpcy5ib3VuZExpc3QgPSBib3VuZExpc3Q7CiAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICB0aGlzLmJvdW5kTGlzdCA9IGJvdW5kTGlzdDsKICAgIH0KCiAgICB2YXIgX3Byb3RvNDYgPSBCbG9ja0xpc3RUcmFja2VyLnByb3RvdHlwZTsKCiAgICBfcHJvdG80Ni5kZXN0cm95ID0gZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgdGhpcy5ib3VuZExpc3QuZm9yRWFjaE5vZGUoZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICByZXR1cm4gbm9kZS5kZXN0cm95KCk7CiAgICAgIH0pOwogICAgfTsKCiAgICBfcHJvdG80Ni5wYXJlbnRFbGVtZW50ID0gZnVuY3Rpb24gcGFyZW50RWxlbWVudCgpIHsKICAgICAgcmV0dXJuIHRoaXMucGFyZW50OwogICAgfTsKCiAgICBfcHJvdG80Ni5maXJzdE5vZGUgPSBmdW5jdGlvbiBmaXJzdE5vZGUoKSB7CiAgICAgIHZhciBoZWFkID0gdGhpcy5ib3VuZExpc3QuaGVhZCgpOwogICAgICByZXR1cm4gaGVhZC5maXJzdE5vZGUoKTsKICAgIH07CgogICAgX3Byb3RvNDYubGFzdE5vZGUgPSBmdW5jdGlvbiBsYXN0Tm9kZSgpIHsKICAgICAgdmFyIHRhaWwgPSB0aGlzLmJvdW5kTGlzdC50YWlsKCk7CiAgICAgIHJldHVybiB0YWlsLmxhc3ROb2RlKCk7CiAgICB9OwoKICAgIF9wcm90bzQ2Lm9wZW5FbGVtZW50ID0gZnVuY3Rpb24gb3BlbkVsZW1lbnQoX2VsZW1lbnQpIHt9OwoKICAgIF9wcm90bzQ2LmNsb3NlRWxlbWVudCA9IGZ1bmN0aW9uIGNsb3NlRWxlbWVudCgpIHt9OwoKICAgIF9wcm90bzQ2LmRpZEFwcGVuZE5vZGUgPSBmdW5jdGlvbiBkaWRBcHBlbmROb2RlKF9ub2RlKSB7fTsKCiAgICBfcHJvdG80Ni5kaWRBcHBlbmRCb3VuZHMgPSBmdW5jdGlvbiBkaWRBcHBlbmRCb3VuZHMoX2JvdW5kcykge307CgogICAgX3Byb3RvNDYubmV3RGVzdHJveWFibGUgPSBmdW5jdGlvbiBuZXdEZXN0cm95YWJsZShfZCkge307CgogICAgX3Byb3RvNDYuZmluYWxpemUgPSBmdW5jdGlvbiBmaW5hbGl6ZShfc3RhY2spIHt9OwoKICAgIHJldHVybiBCbG9ja0xpc3RUcmFja2VyOwogIH0oKTsKCiAgZnVuY3Rpb24gY2xpZW50QnVpbGRlcihlbnYsIGN1cnNvcikgewogICAgcmV0dXJuIE5ld0VsZW1lbnRCdWlsZGVyLmZvckluaXRpYWxSZW5kZXIoZW52LCBjdXJzb3IpOwogIH0KCiAgdmFyIE1BWF9TTUkgPSAweGZmZmZmZmY7CgogIHZhciBJbm5lclN0YWNrID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gSW5uZXJTdGFjayhpbm5lciwganMpIHsKICAgICAgaWYgKGlubmVyID09PSB2b2lkIDApIHsKICAgICAgICBpbm5lciA9IG5ldyBfbG93TGV2ZWwuU3RhY2soKTsKICAgICAgfQoKICAgICAgaWYgKGpzID09PSB2b2lkIDApIHsKICAgICAgICBqcyA9IFtdOwogICAgICB9CgogICAgICB0aGlzLmlubmVyID0gaW5uZXI7CiAgICAgIHRoaXMuanMgPSBqczsKICAgIH0KCiAgICB2YXIgX3Byb3RvNDcgPSBJbm5lclN0YWNrLnByb3RvdHlwZTsKCiAgICBfcHJvdG80Ny5zbGljZSA9IGZ1bmN0aW9uIHNsaWNlKHN0YXJ0LCBlbmQpIHsKICAgICAgdmFyIGlubmVyOwoKICAgICAgaWYgKHR5cGVvZiBzdGFydCA9PT0gJ251bWJlcicgJiYgdHlwZW9mIGVuZCA9PT0gJ251bWJlcicpIHsKICAgICAgICBpbm5lciA9IHRoaXMuaW5uZXIuc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0YXJ0ID09PSAnbnVtYmVyJyAmJiBlbmQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGlubmVyID0gdGhpcy5pbm5lci5zbGljZUZyb20oc3RhcnQpOwogICAgICB9IGVsc2UgewogICAgICAgIGlubmVyID0gdGhpcy5pbm5lci5jbG9uZSgpOwogICAgICB9CgogICAgICByZXR1cm4gbmV3IElubmVyU3RhY2soaW5uZXIsIHRoaXMuanMuc2xpY2Uoc3RhcnQsIGVuZCkpOwogICAgfTsKCiAgICBfcHJvdG80Ny5zbGljZUlubmVyID0gZnVuY3Rpb24gc2xpY2VJbm5lcihzdGFydCwgZW5kKSB7CiAgICAgIHZhciBvdXQgPSBbXTsKCiAgICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgaSsrKSB7CiAgICAgICAgb3V0LnB1c2godGhpcy5nZXQoaSkpOwogICAgICB9CgogICAgICByZXR1cm4gb3V0OwogICAgfTsKCiAgICBfcHJvdG80Ny5jb3B5ID0gZnVuY3Rpb24gY29weShmcm9tLCB0bykgewogICAgICB0aGlzLmlubmVyLmNvcHkoZnJvbSwgdG8pOwogICAgfTsKCiAgICBfcHJvdG80Ny53cml0ZSA9IGZ1bmN0aW9uIHdyaXRlKHBvcywgdmFsdWUkJDEpIHsKICAgICAgaWYgKGlzSW1tZWRpYXRlKHZhbHVlJCQxKSkgewogICAgICAgIHRoaXMuaW5uZXIud3JpdGVSYXcocG9zLCBlbmNvZGVJbW1lZGlhdGUodmFsdWUkJDEpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgaWR4ID0gdGhpcy5qcy5sZW5ndGg7CiAgICAgICAgdGhpcy5qcy5wdXNoKHZhbHVlJCQxKTsKICAgICAgICB0aGlzLmlubmVyLndyaXRlUmF3KHBvcywgfmlkeCk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNDcud3JpdGVSYXcgPSBmdW5jdGlvbiB3cml0ZVJhdyhwb3MsIHZhbHVlJCQxKSB7CiAgICAgIHRoaXMuaW5uZXIud3JpdGVSYXcocG9zLCB2YWx1ZSQkMSk7CiAgICB9OwoKICAgIF9wcm90bzQ3LmdldCA9IGZ1bmN0aW9uIGdldChwb3MpIHsKICAgICAgdmFyIHZhbHVlJCQxID0gdGhpcy5pbm5lci5nZXRSYXcocG9zKTsKCiAgICAgIGlmICh2YWx1ZSQkMSA8IDApIHsKICAgICAgICByZXR1cm4gdGhpcy5qc1t+dmFsdWUkJDFdOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBkZWNvZGVJbW1lZGlhdGUodmFsdWUkJDEpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzQ3LnJlc2V0ID0gZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgIHRoaXMuaW5uZXIucmVzZXQoKTsKICAgICAgdGhpcy5qcy5sZW5ndGggPSAwOwogICAgfTsKCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKElubmVyU3RhY2ssIFt7CiAgICAgIGtleTogImxlbmd0aCIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLmlubmVyLmxlbigpOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gSW5uZXJTdGFjazsKICB9KCk7CgogIHZhciBFdmFsdWF0aW9uU3RhY2sgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBFdmFsdWF0aW9uU3RhY2soc3RhY2ssIGZwLCBzcCkgewogICAgICB0aGlzLnN0YWNrID0gc3RhY2s7CiAgICAgIHRoaXMuZnAgPSBmcDsKICAgICAgdGhpcy5zcCA9IHNwOwogICAgfQoKICAgIEV2YWx1YXRpb25TdGFjay5lbXB0eSA9IGZ1bmN0aW9uIGVtcHR5KCkgewogICAgICByZXR1cm4gbmV3IHRoaXMobmV3IElubmVyU3RhY2soKSwgMCwgLTEpOwogICAgfTsKCiAgICBFdmFsdWF0aW9uU3RhY2sucmVzdG9yZSA9IGZ1bmN0aW9uIHJlc3RvcmUoc25hcHNob3QpIHsKICAgICAgdmFyIHN0YWNrID0gbmV3IElubmVyU3RhY2soKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc25hcHNob3QubGVuZ3RoOyBpKyspIHsKICAgICAgICBzdGFjay53cml0ZShpLCBzbmFwc2hvdFtpXSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBuZXcgdGhpcyhzdGFjaywgMCwgc25hcHNob3QubGVuZ3RoIC0gMSk7CiAgICB9OwoKICAgIHZhciBfcHJvdG80OCA9IEV2YWx1YXRpb25TdGFjay5wcm90b3R5cGU7CgogICAgX3Byb3RvNDgucHVzaCA9IGZ1bmN0aW9uIHB1c2godmFsdWUkJDEpIHsKICAgICAgdGhpcy5zdGFjay53cml0ZSgrK3RoaXMuc3AsIHZhbHVlJCQxKTsKICAgIH07CgogICAgX3Byb3RvNDgucHVzaEVuY29kZWRJbW1lZGlhdGUgPSBmdW5jdGlvbiBwdXNoRW5jb2RlZEltbWVkaWF0ZSh2YWx1ZSQkMSkgewogICAgICB0aGlzLnN0YWNrLndyaXRlUmF3KCsrdGhpcy5zcCwgdmFsdWUkJDEpOwogICAgfTsKCiAgICBfcHJvdG80OC5wdXNoTnVsbCA9IGZ1bmN0aW9uIHB1c2hOdWxsKCkgewogICAgICB0aGlzLnN0YWNrLndyaXRlKCsrdGhpcy5zcCwgbnVsbCk7CiAgICB9OwoKICAgIF9wcm90bzQ4LmR1cCA9IGZ1bmN0aW9uIGR1cChwb3NpdGlvbikgewogICAgICBpZiAocG9zaXRpb24gPT09IHZvaWQgMCkgewogICAgICAgIHBvc2l0aW9uID0gdGhpcy5zcDsKICAgICAgfQoKICAgICAgdGhpcy5zdGFjay5jb3B5KHBvc2l0aW9uLCArK3RoaXMuc3ApOwogICAgfTsKCiAgICBfcHJvdG80OC5jb3B5ID0gZnVuY3Rpb24gY29weShmcm9tLCB0bykgewogICAgICB0aGlzLnN0YWNrLmNvcHkoZnJvbSwgdG8pOwogICAgfTsKCiAgICBfcHJvdG80OC5wb3AgPSBmdW5jdGlvbiBwb3AobikgewogICAgICBpZiAobiA9PT0gdm9pZCAwKSB7CiAgICAgICAgbiA9IDE7CiAgICAgIH0KCiAgICAgIHZhciB0b3AgPSB0aGlzLnN0YWNrLmdldCh0aGlzLnNwKTsKICAgICAgdGhpcy5zcCAtPSBuOwogICAgICByZXR1cm4gdG9wOwogICAgfTsKCiAgICBfcHJvdG80OC5wb3BTbWkgPSBmdW5jdGlvbiBwb3BTbWkoKSB7CiAgICAgIHJldHVybiB0aGlzLnN0YWNrLmdldCh0aGlzLnNwLS0pOwogICAgfTsKCiAgICBfcHJvdG80OC5wZWVrID0gZnVuY3Rpb24gcGVlayhvZmZzZXQpIHsKICAgICAgaWYgKG9mZnNldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgb2Zmc2V0ID0gMDsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuc3RhY2suZ2V0KHRoaXMuc3AgLSBvZmZzZXQpOwogICAgfTsKCiAgICBfcHJvdG80OC5nZXQgPSBmdW5jdGlvbiBnZXQob2Zmc2V0LCBiYXNlKSB7CiAgICAgIGlmIChiYXNlID09PSB2b2lkIDApIHsKICAgICAgICBiYXNlID0gdGhpcy5mcDsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuc3RhY2suZ2V0KGJhc2UgKyBvZmZzZXQpOwogICAgfTsKCiAgICBfcHJvdG80OC5zZXQgPSBmdW5jdGlvbiBzZXQodmFsdWUkJDEsIG9mZnNldCwgYmFzZSkgewogICAgICBpZiAoYmFzZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgYmFzZSA9IHRoaXMuZnA7CiAgICAgIH0KCiAgICAgIHRoaXMuc3RhY2sud3JpdGUoYmFzZSArIG9mZnNldCwgdmFsdWUkJDEpOwogICAgfTsKCiAgICBfcHJvdG80OC5zbGljZSA9IGZ1bmN0aW9uIHNsaWNlKHN0YXJ0LCBlbmQpIHsKICAgICAgcmV0dXJuIHRoaXMuc3RhY2suc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICB9OwoKICAgIF9wcm90bzQ4LnNsaWNlQXJyYXkgPSBmdW5jdGlvbiBzbGljZUFycmF5KHN0YXJ0LCBlbmQpIHsKICAgICAgcmV0dXJuIHRoaXMuc3RhY2suc2xpY2VJbm5lcihzdGFydCwgZW5kKTsKICAgIH07CgogICAgX3Byb3RvNDguY2FwdHVyZSA9IGZ1bmN0aW9uIGNhcHR1cmUoaXRlbXMpIHsKICAgICAgdmFyIGVuZCA9IHRoaXMuc3AgKyAxOwogICAgICB2YXIgc3RhcnQgPSBlbmQgLSBpdGVtczsKICAgICAgcmV0dXJuIHRoaXMuc3RhY2suc2xpY2VJbm5lcihzdGFydCwgZW5kKTsKICAgIH07CgogICAgX3Byb3RvNDgucmVzZXQgPSBmdW5jdGlvbiByZXNldCgpIHsKICAgICAgdGhpcy5zdGFjay5yZXNldCgpOwogICAgfTsKCiAgICBfcHJvdG80OC50b0FycmF5ID0gZnVuY3Rpb24gdG9BcnJheSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc3RhY2suc2xpY2VJbm5lcih0aGlzLmZwLCB0aGlzLnNwICsgMSk7CiAgICB9OwoKICAgIHJldHVybiBFdmFsdWF0aW9uU3RhY2s7CiAgfSgpOwoKICBmdW5jdGlvbiBpc0ltbWVkaWF0ZSh2YWx1ZSQkMSkgewogICAgdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWUkJDE7CiAgICBpZiAodmFsdWUkJDEgPT09IG51bGwgfHwgdmFsdWUkJDEgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHRydWU7CgogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICBjYXNlICd1bmRlZmluZWQnOgogICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgY2FzZSAnbnVtYmVyJzoKICAgICAgICAvLyBub3QgYW4gaW50ZWdlcgogICAgICAgIGlmICh2YWx1ZSQkMSAlIDEgIT09IDApIHJldHVybiBmYWxzZTsKICAgICAgICB2YXIgYWJzID0gTWF0aC5hYnModmFsdWUkJDEpOwogICAgICAgIGlmIChhYnMgPiBNQVhfU01JKSByZXR1cm4gZmFsc2U7CiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGVuY29kZVNtaShwcmltaXRpdmUpIHsKICAgIGlmIChwcmltaXRpdmUgPCAwKSB7CiAgICAgIHZhciBhYnMgPSBNYXRoLmFicyhwcmltaXRpdmUpOwogICAgICBpZiAoYWJzID4gTUFYX1NNSSkgdGhyb3cgbmV3IEVycm9yKCdub3Qgc21pJyk7CiAgICAgIHJldHVybiBNYXRoLmFicyhwcmltaXRpdmUpIDw8IDMgfCA0CiAgICAgIC8qIE5FR0FUSVZFICovCiAgICAgIDsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChwcmltaXRpdmUgPiBNQVhfU01JKSB0aHJvdyBuZXcgRXJyb3IoJ25vdCBzbWknKTsKICAgICAgcmV0dXJuIHByaW1pdGl2ZSA8PCAzIHwgMAogICAgICAvKiBOVU1CRVIgKi8KICAgICAgOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZW5jb2RlSW1tZWRpYXRlKHByaW1pdGl2ZSkgewogICAgc3dpdGNoICh0eXBlb2YgcHJpbWl0aXZlKSB7CiAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgcmV0dXJuIGVuY29kZVNtaShwcmltaXRpdmUpOwoKICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgcmV0dXJuIHByaW1pdGl2ZSA/IDExCiAgICAgICAgLyogVHJ1ZSAqLwogICAgICAgIDogMwogICAgICAgIC8qIEZhbHNlICovCiAgICAgICAgOwoKICAgICAgY2FzZSAnb2JqZWN0JzoKICAgICAgICAvLyBhc3N1bWUgbnVsbAogICAgICAgIHJldHVybiAxOQogICAgICAgIC8qIE51bGwgKi8KICAgICAgICA7CgogICAgICBjYXNlICd1bmRlZmluZWQnOgogICAgICAgIHJldHVybiAyNwogICAgICAgIC8qIFVuZGVmICovCiAgICAgICAgOwoKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyAoMCwgX3V0aWwudW5yZWFjaGFibGUpKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkZWNvZGVTbWkoc21pKSB7CiAgICBzd2l0Y2ggKHNtaSAmIDcpIHsKICAgICAgY2FzZSAwCiAgICAgIC8qIE5VTUJFUiAqLwogICAgICA6CiAgICAgICAgcmV0dXJuIHNtaSA+PiAzOwoKICAgICAgY2FzZSA0CiAgICAgIC8qIE5FR0FUSVZFICovCiAgICAgIDoKICAgICAgICByZXR1cm4gLShzbWkgPj4gMyk7CgogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93ICgwLCBfdXRpbC51bnJlYWNoYWJsZSkoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGRlY29kZUltbWVkaWF0ZShpbW1lZGlhdGUpIHsKICAgIHN3aXRjaCAoaW1tZWRpYXRlKSB7CiAgICAgIGNhc2UgMwogICAgICAvKiBGYWxzZSAqLwogICAgICA6CiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgICAgY2FzZSAxMQogICAgICAvKiBUcnVlICovCiAgICAgIDoKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgIGNhc2UgMTkKICAgICAgLyogTnVsbCAqLwogICAgICA6CiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgICBjYXNlIDI3CiAgICAgIC8qIFVuZGVmICovCiAgICAgIDoKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gZGVjb2RlU21pKGltbWVkaWF0ZSk7CiAgICB9CiAgfQoKICB2YXIgVXBkYXRpbmdWTSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFVwZGF0aW5nVk0oZW52LCBwcm9ncmFtLCBfcmVmNTcpIHsKICAgICAgdmFyIF9yZWY1NyRhbHdheXNSZXZhbGlkYSA9IF9yZWY1Ny5hbHdheXNSZXZhbGlkYXRlLAogICAgICAgICAgYWx3YXlzUmV2YWxpZGF0ZSA9IF9yZWY1NyRhbHdheXNSZXZhbGlkYSA9PT0gdm9pZCAwID8gZmFsc2UgOiBfcmVmNTckYWx3YXlzUmV2YWxpZGE7CiAgICAgIHRoaXMuZnJhbWVTdGFjayA9IG5ldyBfdXRpbC5TdGFjaygpOwogICAgICB0aGlzLmVudiA9IGVudjsKICAgICAgdGhpcy5jb25zdGFudHMgPSBwcm9ncmFtLmNvbnN0YW50czsKICAgICAgdGhpcy5kb20gPSBlbnYuZ2V0RE9NKCk7CiAgICAgIHRoaXMuYWx3YXlzUmV2YWxpZGF0ZSA9IGFsd2F5c1JldmFsaWRhdGU7CiAgICB9CgogICAgdmFyIF9wcm90bzQ5ID0gVXBkYXRpbmdWTS5wcm90b3R5cGU7CgogICAgX3Byb3RvNDkuZXhlY3V0ZSA9IGZ1bmN0aW9uIGV4ZWN1dGUob3Bjb2RlcywgaGFuZGxlcikgewogICAgICB2YXIgZnJhbWVTdGFjayA9IHRoaXMuZnJhbWVTdGFjazsKICAgICAgdGhpcy50cnkob3Bjb2RlcywgaGFuZGxlcik7CgogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGlmIChmcmFtZVN0YWNrLmlzRW1wdHkoKSkgYnJlYWs7CiAgICAgICAgdmFyIG9wY29kZSA9IHRoaXMuZnJhbWUubmV4dFN0YXRlbWVudCgpOwoKICAgICAgICBpZiAob3Bjb2RlID09PSBudWxsKSB7CiAgICAgICAgICB0aGlzLmZyYW1lU3RhY2sucG9wKCk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIG9wY29kZS5ldmFsdWF0ZSh0aGlzKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG80OS5nb3RvID0gZnVuY3Rpb24gZ290byhvcCkgewogICAgICB0aGlzLmZyYW1lLmdvdG8ob3ApOwogICAgfTsKCiAgICBfcHJvdG80OS50cnkgPSBmdW5jdGlvbiBfdHJ5KG9wcywgaGFuZGxlcikgewogICAgICB0aGlzLmZyYW1lU3RhY2sucHVzaChuZXcgVXBkYXRpbmdWTUZyYW1lKG9wcywgaGFuZGxlcikpOwogICAgfTsKCiAgICBfcHJvdG80OS50aHJvdyA9IGZ1bmN0aW9uIF90aHJvdygpIHsKICAgICAgdGhpcy5mcmFtZS5oYW5kbGVFeGNlcHRpb24oKTsKICAgICAgdGhpcy5mcmFtZVN0YWNrLnBvcCgpOwogICAgfTsKCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKFVwZGF0aW5nVk0sIFt7CiAgICAgIGtleTogImZyYW1lIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZnJhbWVTdGFjay5jdXJyZW50OwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gVXBkYXRpbmdWTTsKICB9KCk7CgogIF9leHBvcnRzLlVwZGF0aW5nVk0gPSBVcGRhdGluZ1ZNOwoKICB2YXIgQmxvY2tPcGNvZGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX1VwZGF0aW5nT3Bjb2RlOSkgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKEJsb2NrT3Bjb2RlLCBfVXBkYXRpbmdPcGNvZGU5KTsKCiAgICBmdW5jdGlvbiBCbG9ja09wY29kZShzdGFydCwgc3RhdGUsIHJ1bnRpbWUsIGJvdW5kcywgY2hpbGRyZW4pIHsKICAgICAgdmFyIF90aGlzMTU7CgogICAgICBfdGhpczE1ID0gX1VwZGF0aW5nT3Bjb2RlOS5jYWxsKHRoaXMpIHx8IHRoaXM7CiAgICAgIF90aGlzMTUuc3RhcnQgPSBzdGFydDsKICAgICAgX3RoaXMxNS5zdGF0ZSA9IHN0YXRlOwogICAgICBfdGhpczE1LnJ1bnRpbWUgPSBydW50aW1lOwogICAgICBfdGhpczE1LnR5cGUgPSAnYmxvY2snOwogICAgICBfdGhpczE1Lm5leHQgPSBudWxsOwogICAgICBfdGhpczE1LnByZXYgPSBudWxsOwogICAgICBfdGhpczE1LmNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgIF90aGlzMTUuYm91bmRzID0gYm91bmRzOwogICAgICByZXR1cm4gX3RoaXMxNTsKICAgIH0KCiAgICB2YXIgX3Byb3RvNTAgPSBCbG9ja09wY29kZS5wcm90b3R5cGU7CgogICAgX3Byb3RvNTAucGFyZW50RWxlbWVudCA9IGZ1bmN0aW9uIHBhcmVudEVsZW1lbnQoKSB7CiAgICAgIHJldHVybiB0aGlzLmJvdW5kcy5wYXJlbnRFbGVtZW50KCk7CiAgICB9OwoKICAgIF9wcm90bzUwLmZpcnN0Tm9kZSA9IGZ1bmN0aW9uIGZpcnN0Tm9kZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuYm91bmRzLmZpcnN0Tm9kZSgpOwogICAgfTsKCiAgICBfcHJvdG81MC5sYXN0Tm9kZSA9IGZ1bmN0aW9uIGxhc3ROb2RlKCkgewogICAgICByZXR1cm4gdGhpcy5ib3VuZHMubGFzdE5vZGUoKTsKICAgIH07CgogICAgX3Byb3RvNTAuZXZhbHVhdGUgPSBmdW5jdGlvbiBldmFsdWF0ZSh2bSkgewogICAgICB2bS50cnkodGhpcy5jaGlsZHJlbiwgbnVsbCk7CiAgICB9OwoKICAgIF9wcm90bzUwLmRlc3Ryb3kgPSBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICB0aGlzLmJvdW5kcy5kZXN0cm95KCk7CiAgICB9OwoKICAgIF9wcm90bzUwLmRpZERlc3Ryb3kgPSBmdW5jdGlvbiBkaWREZXN0cm95KCkgewogICAgICB0aGlzLnJ1bnRpbWUuZW52LmRpZERlc3Ryb3kodGhpcy5ib3VuZHMpOwogICAgfTsKCiAgICByZXR1cm4gQmxvY2tPcGNvZGU7CiAgfShVcGRhdGluZ09wY29kZSk7CgogIHZhciBUcnlPcGNvZGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0Jsb2NrT3Bjb2RlKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoVHJ5T3Bjb2RlLCBfQmxvY2tPcGNvZGUpOwoKICAgIGZ1bmN0aW9uIFRyeU9wY29kZShzdGFydCwgc3RhdGUsIHJ1bnRpbWUsIGJvdW5kcywgY2hpbGRyZW4pIHsKICAgICAgdmFyIF90aGlzMTY7CgogICAgICBfdGhpczE2ID0gX0Jsb2NrT3Bjb2RlLmNhbGwodGhpcywgc3RhcnQsIHN0YXRlLCBydW50aW1lLCBib3VuZHMsIGNoaWxkcmVuKSB8fCB0aGlzOwogICAgICBfdGhpczE2LnR5cGUgPSAndHJ5JzsKICAgICAgX3RoaXMxNi50YWcgPSBfdGhpczE2Ll90YWcgPSAoMCwgX3JlZmVyZW5jZTIuY3JlYXRlVXBkYXRhYmxlVGFnKSgpOwogICAgICByZXR1cm4gX3RoaXMxNjsKICAgIH0KCiAgICB2YXIgX3Byb3RvNTEgPSBUcnlPcGNvZGUucHJvdG90eXBlOwoKICAgIF9wcm90bzUxLmRpZEluaXRpYWxpemVDaGlsZHJlbiA9IGZ1bmN0aW9uIGRpZEluaXRpYWxpemVDaGlsZHJlbigpIHsKICAgICAgKDAsIF9yZWZlcmVuY2UyLnVwZGF0ZSkodGhpcy5fdGFnLCAoMCwgX3JlZmVyZW5jZTIuY29tYmluZVNsaWNlKSh0aGlzLmNoaWxkcmVuKSk7CiAgICB9OwoKICAgIF9wcm90bzUxLmV2YWx1YXRlID0gZnVuY3Rpb24gZXZhbHVhdGUodm0pIHsKICAgICAgdm0udHJ5KHRoaXMuY2hpbGRyZW4sIHRoaXMpOwogICAgfTsKCiAgICBfcHJvdG81MS5oYW5kbGVFeGNlcHRpb24gPSBmdW5jdGlvbiBoYW5kbGVFeGNlcHRpb24oKSB7CiAgICAgIHZhciBfdGhpczE3ID0gdGhpczsKCiAgICAgIHZhciBzdGF0ZSA9IHRoaXMuc3RhdGUsCiAgICAgICAgICBib3VuZHMgPSB0aGlzLmJvdW5kcywKICAgICAgICAgIGNoaWxkcmVuID0gdGhpcy5jaGlsZHJlbiwKICAgICAgICAgIHN0YXJ0ID0gdGhpcy5zdGFydCwKICAgICAgICAgIHByZXYgPSB0aGlzLnByZXYsCiAgICAgICAgICBuZXh0ID0gdGhpcy5uZXh0LAogICAgICAgICAgcnVudGltZSA9IHRoaXMucnVudGltZTsKICAgICAgY2hpbGRyZW4uY2xlYXIoKTsKICAgICAgdmFyIGVsZW1lbnRTdGFjayA9IE5ld0VsZW1lbnRCdWlsZGVyLnJlc3VtZShydW50aW1lLmVudiwgYm91bmRzLCBib3VuZHMucmVzZXQocnVudGltZS5lbnYpKTsKICAgICAgdmFyIHZtID0gVk0ucmVzdW1lKHN0YXRlLCBydW50aW1lLCBlbGVtZW50U3RhY2spOwogICAgICB2YXIgdXBkYXRpbmcgPSBuZXcgX3V0aWwuTGlua2VkTGlzdCgpOwogICAgICB2bS5leGVjdXRlKHN0YXJ0LCBmdW5jdGlvbiAodm0pIHsKICAgICAgICB2bS5zdGFjayA9IEV2YWx1YXRpb25TdGFjay5yZXN0b3JlKHN0YXRlLnN0YWNrKTsKICAgICAgICB2bS51cGRhdGluZ09wY29kZVN0YWNrLnB1c2godXBkYXRpbmcpOwogICAgICAgIHZtLnVwZGF0ZVdpdGgoX3RoaXMxNyk7CiAgICAgICAgdm0udXBkYXRpbmdPcGNvZGVTdGFjay5wdXNoKGNoaWxkcmVuKTsKICAgICAgfSk7CiAgICAgIHRoaXMucHJldiA9IHByZXY7CiAgICAgIHRoaXMubmV4dCA9IG5leHQ7CiAgICB9OwoKICAgIHJldHVybiBUcnlPcGNvZGU7CiAgfShCbG9ja09wY29kZSk7CgogIHZhciBMaXN0UmV2YWxpZGF0aW9uRGVsZWdhdGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBMaXN0UmV2YWxpZGF0aW9uRGVsZWdhdGUob3Bjb2RlLCBtYXJrZXIpIHsKICAgICAgdGhpcy5vcGNvZGUgPSBvcGNvZGU7CiAgICAgIHRoaXMubWFya2VyID0gbWFya2VyOwogICAgICB0aGlzLmRpZEluc2VydCA9IGZhbHNlOwogICAgICB0aGlzLmRpZERlbGV0ZSA9IGZhbHNlOwogICAgICB0aGlzLm1hcCA9IG9wY29kZS5tYXA7CiAgICAgIHRoaXMudXBkYXRpbmcgPSBvcGNvZGVbJ2NoaWxkcmVuJ107CiAgICB9CgogICAgdmFyIF9wcm90bzUyID0gTGlzdFJldmFsaWRhdGlvbkRlbGVnYXRlLnByb3RvdHlwZTsKCiAgICBfcHJvdG81Mi5pbnNlcnQgPSBmdW5jdGlvbiBpbnNlcnQoa2V5LCBpdGVtLCBtZW1vLCBiZWZvcmUpIHsKICAgICAgdmFyIG1hcCA9IHRoaXMubWFwLAogICAgICAgICAgb3Bjb2RlID0gdGhpcy5vcGNvZGUsCiAgICAgICAgICB1cGRhdGluZyA9IHRoaXMudXBkYXRpbmc7CiAgICAgIHZhciBuZXh0U2libGluZyA9IG51bGw7CiAgICAgIHZhciByZWZlcmVuY2UgPSBudWxsOwoKICAgICAgaWYgKHR5cGVvZiBiZWZvcmUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmVmZXJlbmNlID0gbWFwW2JlZm9yZV07CiAgICAgICAgbmV4dFNpYmxpbmcgPSByZWZlcmVuY2VbJ2JvdW5kcyddLmZpcnN0Tm9kZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIG5leHRTaWJsaW5nID0gdGhpcy5tYXJrZXI7CiAgICAgIH0KCiAgICAgIHZhciB2bSA9IG9wY29kZS52bUZvckluc2VydGlvbihuZXh0U2libGluZyk7CiAgICAgIHZhciB0cnlPcGNvZGUgPSBudWxsOwogICAgICB2YXIgc3RhcnQgPSBvcGNvZGUuc3RhcnQ7CiAgICAgIHZtLmV4ZWN1dGUoc3RhcnQsIGZ1bmN0aW9uICh2bSkgewogICAgICAgIG1hcFtrZXldID0gdHJ5T3Bjb2RlID0gdm0uaXRlcmF0ZShtZW1vLCBpdGVtKTsKICAgICAgICB2bS51cGRhdGluZ09wY29kZVN0YWNrLnB1c2gobmV3IF91dGlsLkxpbmtlZExpc3QoKSk7CiAgICAgICAgdm0udXBkYXRlV2l0aCh0cnlPcGNvZGUpOwogICAgICAgIHZtLnVwZGF0aW5nT3Bjb2RlU3RhY2sucHVzaCh0cnlPcGNvZGUuY2hpbGRyZW4pOwogICAgICB9KTsKICAgICAgdXBkYXRpbmcuaW5zZXJ0QmVmb3JlKHRyeU9wY29kZSwgcmVmZXJlbmNlKTsKICAgICAgdGhpcy5kaWRJbnNlcnQgPSB0cnVlOwogICAgfTsKCiAgICBfcHJvdG81Mi5yZXRhaW4gPSBmdW5jdGlvbiByZXRhaW4oX2tleSwgX2l0ZW0sIF9tZW1vKSB7fTsKCiAgICBfcHJvdG81Mi5tb3ZlID0gZnVuY3Rpb24gbW92ZShrZXksIF9pdGVtLCBfbWVtbywgYmVmb3JlKSB7CiAgICAgIHZhciBtYXAgPSB0aGlzLm1hcCwKICAgICAgICAgIHVwZGF0aW5nID0gdGhpcy51cGRhdGluZzsKICAgICAgdmFyIGVudHJ5ID0gbWFwW2tleV07CiAgICAgIHZhciByZWZlcmVuY2UgPSBtYXBbYmVmb3JlXSB8fCBudWxsOwoKICAgICAgaWYgKHR5cGVvZiBiZWZvcmUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgX21vdmUoZW50cnksIHJlZmVyZW5jZS5maXJzdE5vZGUoKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgX21vdmUoZW50cnksIHRoaXMubWFya2VyKTsKICAgICAgfQoKICAgICAgdXBkYXRpbmcucmVtb3ZlKGVudHJ5KTsKICAgICAgdXBkYXRpbmcuaW5zZXJ0QmVmb3JlKGVudHJ5LCByZWZlcmVuY2UpOwogICAgfTsKCiAgICBfcHJvdG81Mi5kZWxldGUgPSBmdW5jdGlvbiBfZGVsZXRlKGtleSkgewogICAgICB2YXIgbWFwID0gdGhpcy5tYXA7CiAgICAgIHZhciBvcGNvZGUgPSBtYXBba2V5XTsKICAgICAgb3Bjb2RlLmRpZERlc3Ryb3koKTsKICAgICAgY2xlYXIob3Bjb2RlKTsKICAgICAgdGhpcy51cGRhdGluZy5yZW1vdmUob3Bjb2RlKTsKICAgICAgZGVsZXRlIG1hcFtrZXldOwogICAgICB0aGlzLmRpZERlbGV0ZSA9IHRydWU7CiAgICB9OwoKICAgIF9wcm90bzUyLmRvbmUgPSBmdW5jdGlvbiBkb25lKCkgewogICAgICB0aGlzLm9wY29kZS5kaWRJbml0aWFsaXplQ2hpbGRyZW4odGhpcy5kaWRJbnNlcnQgfHwgdGhpcy5kaWREZWxldGUpOwogICAgfTsKCiAgICByZXR1cm4gTGlzdFJldmFsaWRhdGlvbkRlbGVnYXRlOwogIH0oKTsKCiAgdmFyIExpc3RCbG9ja09wY29kZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfQmxvY2tPcGNvZGUyKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoTGlzdEJsb2NrT3Bjb2RlLCBfQmxvY2tPcGNvZGUyKTsKCiAgICBmdW5jdGlvbiBMaXN0QmxvY2tPcGNvZGUoc3RhcnQsIHN0YXRlLCBydW50aW1lLCBib3VuZHMsIGNoaWxkcmVuLCBhcnRpZmFjdHMpIHsKICAgICAgdmFyIF90aGlzMTg7CgogICAgICBfdGhpczE4ID0gX0Jsb2NrT3Bjb2RlMi5jYWxsKHRoaXMsIHN0YXJ0LCBzdGF0ZSwgcnVudGltZSwgYm91bmRzLCBjaGlsZHJlbikgfHwgdGhpczsKICAgICAgX3RoaXMxOC50eXBlID0gJ2xpc3QtYmxvY2snOwogICAgICBfdGhpczE4Lm1hcCA9ICgwLCBfdXRpbC5kaWN0KSgpOwogICAgICBfdGhpczE4Lmxhc3RJdGVyYXRlZCA9IF9yZWZlcmVuY2UyLklOSVRJQUw7CiAgICAgIF90aGlzMTguYXJ0aWZhY3RzID0gYXJ0aWZhY3RzOwoKICAgICAgdmFyIF90YWcgPSBfdGhpczE4Ll90YWcgPSAoMCwgX3JlZmVyZW5jZTIuY3JlYXRlVXBkYXRhYmxlVGFnKSgpOwoKICAgICAgX3RoaXMxOC50YWcgPSAoMCwgX3JlZmVyZW5jZTIuY29tYmluZSkoW2FydGlmYWN0cy50YWcsIF90YWddKTsKICAgICAgcmV0dXJuIF90aGlzMTg7CiAgICB9CgogICAgdmFyIF9wcm90bzUzID0gTGlzdEJsb2NrT3Bjb2RlLnByb3RvdHlwZTsKCiAgICBfcHJvdG81My5kaWRJbml0aWFsaXplQ2hpbGRyZW4gPSBmdW5jdGlvbiBkaWRJbml0aWFsaXplQ2hpbGRyZW4obGlzdERpZENoYW5nZSkgewogICAgICBpZiAobGlzdERpZENoYW5nZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgbGlzdERpZENoYW5nZSA9IHRydWU7CiAgICAgIH0KCiAgICAgIHRoaXMubGFzdEl0ZXJhdGVkID0gKDAsIF9yZWZlcmVuY2UyLnZhbHVlKSh0aGlzLmFydGlmYWN0cy50YWcpOwoKICAgICAgaWYgKGxpc3REaWRDaGFuZ2UpIHsKICAgICAgICAoMCwgX3JlZmVyZW5jZTIudXBkYXRlKSh0aGlzLl90YWcsICgwLCBfcmVmZXJlbmNlMi5jb21iaW5lU2xpY2UpKHRoaXMuY2hpbGRyZW4pKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG81My5ldmFsdWF0ZSA9IGZ1bmN0aW9uIGV2YWx1YXRlKHZtKSB7CiAgICAgIHZhciBhcnRpZmFjdHMgPSB0aGlzLmFydGlmYWN0cywKICAgICAgICAgIGxhc3RJdGVyYXRlZCA9IHRoaXMubGFzdEl0ZXJhdGVkOwoKICAgICAgaWYgKCEoMCwgX3JlZmVyZW5jZTIudmFsaWRhdGUpKGFydGlmYWN0cy50YWcsIGxhc3RJdGVyYXRlZCkpIHsKICAgICAgICB2YXIgYm91bmRzID0gdGhpcy5ib3VuZHM7CiAgICAgICAgdmFyIGRvbSA9IHZtLmRvbTsKICAgICAgICB2YXIgbWFya2VyID0gZG9tLmNyZWF0ZUNvbW1lbnQoJycpOwogICAgICAgIGRvbS5pbnNlcnRBZnRlcihib3VuZHMucGFyZW50RWxlbWVudCgpLCBtYXJrZXIsIGJvdW5kcy5sYXN0Tm9kZSgpKTsKICAgICAgICB2YXIgdGFyZ2V0ID0gbmV3IExpc3RSZXZhbGlkYXRpb25EZWxlZ2F0ZSh0aGlzLCBtYXJrZXIpOwogICAgICAgIHZhciBzeW5jaHJvbml6ZXIgPSBuZXcgX3JlZmVyZW5jZTIuSXRlcmF0b3JTeW5jaHJvbml6ZXIoewogICAgICAgICAgdGFyZ2V0OiB0YXJnZXQsCiAgICAgICAgICBhcnRpZmFjdHM6IGFydGlmYWN0cwogICAgICAgIH0pOwogICAgICAgIHN5bmNocm9uaXplci5zeW5jKCk7CiAgICAgICAgdGhpcy5wYXJlbnRFbGVtZW50KCkucmVtb3ZlQ2hpbGQobWFya2VyKTsKICAgICAgfSAvLyBSdW4gbm93LXVwZGF0ZWQgdXBkYXRpbmcgb3Bjb2RlcwoKCiAgICAgIF9CbG9ja09wY29kZTIucHJvdG90eXBlLmV2YWx1YXRlLmNhbGwodGhpcywgdm0pOwogICAgfTsKCiAgICBfcHJvdG81My52bUZvckluc2VydGlvbiA9IGZ1bmN0aW9uIHZtRm9ySW5zZXJ0aW9uKG5leHRTaWJsaW5nKSB7CiAgICAgIHZhciBib3VuZHMgPSB0aGlzLmJvdW5kcywKICAgICAgICAgIHN0YXRlID0gdGhpcy5zdGF0ZSwKICAgICAgICAgIHJ1bnRpbWUgPSB0aGlzLnJ1bnRpbWU7CiAgICAgIHZhciBlbGVtZW50U3RhY2sgPSBOZXdFbGVtZW50QnVpbGRlci5mb3JJbml0aWFsUmVuZGVyKHJ1bnRpbWUuZW52LCB7CiAgICAgICAgZWxlbWVudDogYm91bmRzLnBhcmVudEVsZW1lbnQoKSwKICAgICAgICBuZXh0U2libGluZzogbmV4dFNpYmxpbmcKICAgICAgfSk7CiAgICAgIHJldHVybiBWTS5yZXN1bWUoc3RhdGUsIHJ1bnRpbWUsIGVsZW1lbnRTdGFjayk7CiAgICB9OwoKICAgIHJldHVybiBMaXN0QmxvY2tPcGNvZGU7CiAgfShCbG9ja09wY29kZSk7CgogIHZhciBVcGRhdGluZ1ZNRnJhbWUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBVcGRhdGluZ1ZNRnJhbWUob3BzLCBleGNlcHRpb25IYW5kbGVyKSB7CiAgICAgIHRoaXMub3BzID0gb3BzOwogICAgICB0aGlzLmV4Y2VwdGlvbkhhbmRsZXIgPSBleGNlcHRpb25IYW5kbGVyOwogICAgICB0aGlzLmN1cnJlbnQgPSBvcHMuaGVhZCgpOwogICAgfQoKICAgIHZhciBfcHJvdG81NCA9IFVwZGF0aW5nVk1GcmFtZS5wcm90b3R5cGU7CgogICAgX3Byb3RvNTQuZ290byA9IGZ1bmN0aW9uIGdvdG8ob3ApIHsKICAgICAgdGhpcy5jdXJyZW50ID0gb3A7CiAgICB9OwoKICAgIF9wcm90bzU0Lm5leHRTdGF0ZW1lbnQgPSBmdW5jdGlvbiBuZXh0U3RhdGVtZW50KCkgewogICAgICB2YXIgY3VycmVudCA9IHRoaXMuY3VycmVudCwKICAgICAgICAgIG9wcyA9IHRoaXMub3BzOwogICAgICBpZiAoY3VycmVudCkgdGhpcy5jdXJyZW50ID0gb3BzLm5leHROb2RlKGN1cnJlbnQpOwogICAgICByZXR1cm4gY3VycmVudDsKICAgIH07CgogICAgX3Byb3RvNTQuaGFuZGxlRXhjZXB0aW9uID0gZnVuY3Rpb24gaGFuZGxlRXhjZXB0aW9uKCkgewogICAgICBpZiAodGhpcy5leGNlcHRpb25IYW5kbGVyKSB7CiAgICAgICAgdGhpcy5leGNlcHRpb25IYW5kbGVyLmhhbmRsZUV4Y2VwdGlvbigpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBVcGRhdGluZ1ZNRnJhbWU7CiAgfSgpOwoKICB2YXIgUmVuZGVyUmVzdWx0ID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gUmVuZGVyUmVzdWx0KGVudiwgcHJvZ3JhbSwgdXBkYXRpbmcsIGJvdW5kcykgewogICAgICB0aGlzLmVudiA9IGVudjsKICAgICAgdGhpcy5wcm9ncmFtID0gcHJvZ3JhbTsKICAgICAgdGhpcy51cGRhdGluZyA9IHVwZGF0aW5nOwogICAgICB0aGlzLmJvdW5kcyA9IGJvdW5kczsKICAgIH0KCiAgICB2YXIgX3Byb3RvNTUgPSBSZW5kZXJSZXN1bHQucHJvdG90eXBlOwoKICAgIF9wcm90bzU1LnJlcmVuZGVyID0gZnVuY3Rpb24gcmVyZW5kZXIoX3RlbXApIHsKICAgICAgdmFyIF9yZWY1OCA9IF90ZW1wID09PSB2b2lkIDAgPyB7CiAgICAgICAgYWx3YXlzUmV2YWxpZGF0ZTogZmFsc2UKICAgICAgfSA6IF90ZW1wLAogICAgICAgICAgX3JlZjU4JGFsd2F5c1JldmFsaWRhID0gX3JlZjU4LmFsd2F5c1JldmFsaWRhdGUsCiAgICAgICAgICBhbHdheXNSZXZhbGlkYXRlID0gX3JlZjU4JGFsd2F5c1JldmFsaWRhID09PSB2b2lkIDAgPyBmYWxzZSA6IF9yZWY1OCRhbHdheXNSZXZhbGlkYTsKCiAgICAgIHZhciBlbnYgPSB0aGlzLmVudiwKICAgICAgICAgIHByb2dyYW0gPSB0aGlzLnByb2dyYW0sCiAgICAgICAgICB1cGRhdGluZyA9IHRoaXMudXBkYXRpbmc7CiAgICAgIHZhciB2bSA9IG5ldyBVcGRhdGluZ1ZNKGVudiwgcHJvZ3JhbSwgewogICAgICAgIGFsd2F5c1JldmFsaWRhdGU6IGFsd2F5c1JldmFsaWRhdGUKICAgICAgfSk7CiAgICAgIHZtLmV4ZWN1dGUodXBkYXRpbmcsIHRoaXMpOwogICAgfTsKCiAgICBfcHJvdG81NS5wYXJlbnRFbGVtZW50ID0gZnVuY3Rpb24gcGFyZW50RWxlbWVudCgpIHsKICAgICAgcmV0dXJuIHRoaXMuYm91bmRzLnBhcmVudEVsZW1lbnQoKTsKICAgIH07CgogICAgX3Byb3RvNTUuZmlyc3ROb2RlID0gZnVuY3Rpb24gZmlyc3ROb2RlKCkgewogICAgICByZXR1cm4gdGhpcy5ib3VuZHMuZmlyc3ROb2RlKCk7CiAgICB9OwoKICAgIF9wcm90bzU1Lmxhc3ROb2RlID0gZnVuY3Rpb24gbGFzdE5vZGUoKSB7CiAgICAgIHJldHVybiB0aGlzLmJvdW5kcy5sYXN0Tm9kZSgpOwogICAgfTsKCiAgICBfcHJvdG81NS5oYW5kbGVFeGNlcHRpb24gPSBmdW5jdGlvbiBoYW5kbGVFeGNlcHRpb24oKSB7CiAgICAgIHRocm93ICd0aGlzIHNob3VsZCBuZXZlciBoYXBwZW4nOwogICAgfTsKCiAgICBfcHJvdG81NS5kZXN0cm95ID0gZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgdGhpcy5ib3VuZHMuZGVzdHJveSgpOwogICAgICBjbGVhcih0aGlzLmJvdW5kcyk7CiAgICB9OwoKICAgIHJldHVybiBSZW5kZXJSZXN1bHQ7CiAgfSgpOwoKICBfZXhwb3J0cy5SZW5kZXJSZXN1bHQgPSBSZW5kZXJSZXN1bHQ7CgogIHZhciBBcmd1bWVudHMgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBBcmd1bWVudHMoKSB7CiAgICAgIHRoaXMuc3RhY2sgPSBudWxsOwogICAgICB0aGlzLnBvc2l0aW9uYWwgPSBuZXcgUG9zaXRpb25hbEFyZ3VtZW50cygpOwogICAgICB0aGlzLm5hbWVkID0gbmV3IE5hbWVkQXJndW1lbnRzKCk7CiAgICAgIHRoaXMuYmxvY2tzID0gbmV3IEJsb2NrQXJndW1lbnRzKCk7CiAgICB9CgogICAgdmFyIF9wcm90bzU2ID0gQXJndW1lbnRzLnByb3RvdHlwZTsKCiAgICBfcHJvdG81Ni5lbXB0eSA9IGZ1bmN0aW9uIGVtcHR5KHN0YWNrKSB7CiAgICAgIHZhciBiYXNlID0gc3RhY2suc3AgKyAxOwogICAgICB0aGlzLm5hbWVkLmVtcHR5KHN0YWNrLCBiYXNlKTsKICAgICAgdGhpcy5wb3NpdGlvbmFsLmVtcHR5KHN0YWNrLCBiYXNlKTsKICAgICAgdGhpcy5ibG9ja3MuZW1wdHkoc3RhY2ssIGJhc2UpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgX3Byb3RvNTYuc2V0dXAgPSBmdW5jdGlvbiBzZXR1cChzdGFjaywgbmFtZXMsIGJsb2NrTmFtZXMsIHBvc2l0aW9uYWxDb3VudCwgc3ludGhldGljKSB7CiAgICAgIHRoaXMuc3RhY2sgPSBzdGFjazsKICAgICAgLyoKICAgICAgICAgICAgIHwgLi4uIHwgYmxvY2tzICAgICAgfCBwb3NpdGlvbmFsICB8IG5hbWVkIHwKICAgICAgICAgICAgIHwgLi4uIHwgYjAgICAgYjEgICAgfCBwMCBwMSBwMiBwMyB8IG4wIG4xIHwKICAgICAgIGluZGV4IHwgLi4uIHwgNC81LzYgNy84LzkgfCAxMCAxMSAxMiAxMyB8IDE0IDE1IHwKICAgICAgICAgICAgICAgICAgICAgXiAgICAgICAgICAgICBeICAgICAgICAgICAgIF4gIF4KICAgICAgICAgICAgICAgICAgIGJiYXNlICAgICAgICAgcGJhc2UgICAgICAgbmJhc2UgIHNwCiAgICAgICovCgogICAgICB2YXIgbmFtZWQgPSB0aGlzLm5hbWVkOwogICAgICB2YXIgbmFtZWRDb3VudCA9IG5hbWVzLmxlbmd0aDsKICAgICAgdmFyIG5hbWVkQmFzZSA9IHN0YWNrLnNwIC0gbmFtZWRDb3VudCArIDE7CiAgICAgIG5hbWVkLnNldHVwKHN0YWNrLCBuYW1lZEJhc2UsIG5hbWVkQ291bnQsIG5hbWVzLCBzeW50aGV0aWMpOwogICAgICB2YXIgcG9zaXRpb25hbCA9IHRoaXMucG9zaXRpb25hbDsKICAgICAgdmFyIHBvc2l0aW9uYWxCYXNlID0gbmFtZWRCYXNlIC0gcG9zaXRpb25hbENvdW50OwogICAgICBwb3NpdGlvbmFsLnNldHVwKHN0YWNrLCBwb3NpdGlvbmFsQmFzZSwgcG9zaXRpb25hbENvdW50KTsKICAgICAgdmFyIGJsb2NrcyA9IHRoaXMuYmxvY2tzOwogICAgICB2YXIgYmxvY2tzQ291bnQgPSBibG9ja05hbWVzLmxlbmd0aDsKICAgICAgdmFyIGJsb2Nrc0Jhc2UgPSBwb3NpdGlvbmFsQmFzZSAtIGJsb2Nrc0NvdW50ICogMzsKICAgICAgYmxvY2tzLnNldHVwKHN0YWNrLCBibG9ja3NCYXNlLCBibG9ja3NDb3VudCwgYmxvY2tOYW1lcyk7CiAgICB9OwoKICAgIF9wcm90bzU2LmF0ID0gZnVuY3Rpb24gYXQocG9zKSB7CiAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uYWwuYXQocG9zKTsKICAgIH07CgogICAgX3Byb3RvNTYucmVhbGxvYyA9IGZ1bmN0aW9uIHJlYWxsb2Mob2Zmc2V0KSB7CiAgICAgIHZhciBzdGFjayA9IHRoaXMuc3RhY2s7CgogICAgICBpZiAob2Zmc2V0ID4gMCAmJiBzdGFjayAhPT0gbnVsbCkgewogICAgICAgIHZhciBwb3NpdGlvbmFsID0gdGhpcy5wb3NpdGlvbmFsLAogICAgICAgICAgICBuYW1lZCA9IHRoaXMubmFtZWQ7CiAgICAgICAgdmFyIG5ld0Jhc2UgPSBwb3NpdGlvbmFsLmJhc2UgKyBvZmZzZXQ7CiAgICAgICAgdmFyIGxlbmd0aCA9IHBvc2l0aW9uYWwubGVuZ3RoICsgbmFtZWQubGVuZ3RoOwoKICAgICAgICBmb3IgKHZhciBpID0gbGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgIHN0YWNrLmNvcHkoaSArIHBvc2l0aW9uYWwuYmFzZSwgaSArIG5ld0Jhc2UpOwogICAgICAgIH0KCiAgICAgICAgcG9zaXRpb25hbC5iYXNlICs9IG9mZnNldDsKICAgICAgICBuYW1lZC5iYXNlICs9IG9mZnNldDsKICAgICAgICBzdGFjay5zcCArPSBvZmZzZXQ7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNTYuY2FwdHVyZSA9IGZ1bmN0aW9uIGNhcHR1cmUoKSB7CiAgICAgIHZhciBwb3NpdGlvbmFsID0gdGhpcy5wb3NpdGlvbmFsLmxlbmd0aCA9PT0gMCA/IEVNUFRZX1BPU0lUSU9OQUwgOiB0aGlzLnBvc2l0aW9uYWwuY2FwdHVyZSgpOwogICAgICB2YXIgbmFtZWQgPSB0aGlzLm5hbWVkLmxlbmd0aCA9PT0gMCA/IEVNUFRZX05BTUVEIDogdGhpcy5uYW1lZC5jYXB0dXJlKCk7CiAgICAgIHJldHVybiBuZXcgQ2FwdHVyZWRBcmd1bWVudHModGhpcy50YWcsIHBvc2l0aW9uYWwsIG5hbWVkLCB0aGlzLmxlbmd0aCk7CiAgICB9OwoKICAgIF9wcm90bzU2LmNsZWFyID0gZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAgIHZhciBzdGFjayA9IHRoaXMuc3RhY2ssCiAgICAgICAgICBsZW5ndGggPSB0aGlzLmxlbmd0aDsKICAgICAgaWYgKGxlbmd0aCA+IDAgJiYgc3RhY2sgIT09IG51bGwpIHN0YWNrLnBvcChsZW5ndGgpOwogICAgfTsKCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKEFyZ3VtZW50cywgW3sKICAgICAga2V5OiAidGFnIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuICgwLCBfcmVmZXJlbmNlMi5jb21iaW5lVGFnZ2VkKShbdGhpcy5wb3NpdGlvbmFsLCB0aGlzLm5hbWVkXSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiYmFzZSIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLmJsb2Nrcy5iYXNlOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImxlbmd0aCIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uYWwubGVuZ3RoICsgdGhpcy5uYW1lZC5sZW5ndGggKyB0aGlzLmJsb2Nrcy5sZW5ndGggKiAzOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQXJndW1lbnRzOwogIH0oKTsKCiAgdmFyIENhcHR1cmVkQXJndW1lbnRzID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQ2FwdHVyZWRBcmd1bWVudHModGFnLCBwb3NpdGlvbmFsLCBuYW1lZCwgbGVuZ3RoKSB7CiAgICAgIHRoaXMudGFnID0gdGFnOwogICAgICB0aGlzLnBvc2l0aW9uYWwgPSBwb3NpdGlvbmFsOwogICAgICB0aGlzLm5hbWVkID0gbmFtZWQ7CiAgICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoOwogICAgfQoKICAgIHZhciBfcHJvdG81NyA9IENhcHR1cmVkQXJndW1lbnRzLnByb3RvdHlwZTsKCiAgICBfcHJvdG81Ny52YWx1ZSA9IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICByZXR1cm4gewogICAgICAgIG5hbWVkOiB0aGlzLm5hbWVkLnZhbHVlKCksCiAgICAgICAgcG9zaXRpb25hbDogdGhpcy5wb3NpdGlvbmFsLnZhbHVlKCkKICAgICAgfTsKICAgIH07CgogICAgcmV0dXJuIENhcHR1cmVkQXJndW1lbnRzOwogIH0oKTsKCiAgdmFyIFBvc2l0aW9uYWxBcmd1bWVudHMgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBQb3NpdGlvbmFsQXJndW1lbnRzKCkgewogICAgICB0aGlzLmJhc2UgPSAwOwogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMuc3RhY2sgPSBudWxsOwogICAgICB0aGlzLl90YWcgPSBudWxsOwogICAgICB0aGlzLl9yZWZlcmVuY2VzID0gbnVsbDsKICAgIH0KCiAgICB2YXIgX3Byb3RvNTggPSBQb3NpdGlvbmFsQXJndW1lbnRzLnByb3RvdHlwZTsKCiAgICBfcHJvdG81OC5lbXB0eSA9IGZ1bmN0aW9uIGVtcHR5KHN0YWNrLCBiYXNlKSB7CiAgICAgIHRoaXMuc3RhY2sgPSBzdGFjazsKICAgICAgdGhpcy5iYXNlID0gYmFzZTsKICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICB0aGlzLl90YWcgPSBfcmVmZXJlbmNlMi5DT05TVEFOVF9UQUc7CiAgICAgIHRoaXMuX3JlZmVyZW5jZXMgPSBfdXRpbC5FTVBUWV9BUlJBWTsKICAgIH07CgogICAgX3Byb3RvNTguc2V0dXAgPSBmdW5jdGlvbiBzZXR1cChzdGFjaywgYmFzZSwgbGVuZ3RoKSB7CiAgICAgIHRoaXMuc3RhY2sgPSBzdGFjazsKICAgICAgdGhpcy5iYXNlID0gYmFzZTsKICAgICAgdGhpcy5sZW5ndGggPSBsZW5ndGg7CgogICAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhpcy5fdGFnID0gX3JlZmVyZW5jZTIuQ09OU1RBTlRfVEFHOwogICAgICAgIHRoaXMuX3JlZmVyZW5jZXMgPSBfdXRpbC5FTVBUWV9BUlJBWTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl90YWcgPSBudWxsOwogICAgICAgIHRoaXMuX3JlZmVyZW5jZXMgPSBudWxsOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzU4LmF0ID0gZnVuY3Rpb24gYXQocG9zaXRpb24pIHsKICAgICAgdmFyIGJhc2UgPSB0aGlzLmJhc2UsCiAgICAgICAgICBsZW5ndGggPSB0aGlzLmxlbmd0aCwKICAgICAgICAgIHN0YWNrID0gdGhpcy5zdGFjazsKCiAgICAgIGlmIChwb3NpdGlvbiA8IDAgfHwgcG9zaXRpb24gPj0gbGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIFVOREVGSU5FRF9SRUZFUkVOQ0U7CiAgICAgIH0KCiAgICAgIHJldHVybiBzdGFjay5nZXQocG9zaXRpb24sIGJhc2UpOwogICAgfTsKCiAgICBfcHJvdG81OC5jYXB0dXJlID0gZnVuY3Rpb24gY2FwdHVyZSgpIHsKICAgICAgcmV0dXJuIG5ldyBDYXB0dXJlZFBvc2l0aW9uYWxBcmd1bWVudHModGhpcy50YWcsIHRoaXMucmVmZXJlbmNlcyk7CiAgICB9OwoKICAgIF9wcm90bzU4LnByZXBlbmQgPSBmdW5jdGlvbiBwcmVwZW5kKG90aGVyKSB7CiAgICAgIHZhciBhZGRpdGlvbnMgPSBvdGhlci5sZW5ndGg7CgogICAgICBpZiAoYWRkaXRpb25zID4gMCkgewogICAgICAgIHZhciBiYXNlID0gdGhpcy5iYXNlLAogICAgICAgICAgICBsZW5ndGggPSB0aGlzLmxlbmd0aCwKICAgICAgICAgICAgc3RhY2sgPSB0aGlzLnN0YWNrOwogICAgICAgIHRoaXMuYmFzZSA9IGJhc2UgPSBiYXNlIC0gYWRkaXRpb25zOwogICAgICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoICsgYWRkaXRpb25zOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFkZGl0aW9uczsgaSsrKSB7CiAgICAgICAgICBzdGFjay5zZXQob3RoZXIuYXQoaSksIGksIGJhc2UpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fdGFnID0gbnVsbDsKICAgICAgICB0aGlzLl9yZWZlcmVuY2VzID0gbnVsbDsKICAgICAgfQogICAgfTsKCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKFBvc2l0aW9uYWxBcmd1bWVudHMsIFt7CiAgICAgIGtleTogInRhZyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHZhciB0YWcgPSB0aGlzLl90YWc7CgogICAgICAgIGlmICghdGFnKSB7CiAgICAgICAgICB0YWcgPSB0aGlzLl90YWcgPSAoMCwgX3JlZmVyZW5jZTIuY29tYmluZVRhZ2dlZCkodGhpcy5yZWZlcmVuY2VzKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0YWc7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVmZXJlbmNlcyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHZhciByZWZlcmVuY2VzID0gdGhpcy5fcmVmZXJlbmNlczsKCiAgICAgICAgaWYgKCFyZWZlcmVuY2VzKSB7CiAgICAgICAgICB2YXIgc3RhY2sgPSB0aGlzLnN0YWNrLAogICAgICAgICAgICAgIGJhc2UgPSB0aGlzLmJhc2UsCiAgICAgICAgICAgICAgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CiAgICAgICAgICByZWZlcmVuY2VzID0gdGhpcy5fcmVmZXJlbmNlcyA9IHN0YWNrLnNsaWNlQXJyYXkoYmFzZSwgYmFzZSArIGxlbmd0aCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVmZXJlbmNlczsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFBvc2l0aW9uYWxBcmd1bWVudHM7CiAgfSgpOwoKICB2YXIgQ2FwdHVyZWRQb3NpdGlvbmFsQXJndW1lbnRzID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQ2FwdHVyZWRQb3NpdGlvbmFsQXJndW1lbnRzKHRhZywgcmVmZXJlbmNlcywgbGVuZ3RoKSB7CiAgICAgIGlmIChsZW5ndGggPT09IHZvaWQgMCkgewogICAgICAgIGxlbmd0aCA9IHJlZmVyZW5jZXMubGVuZ3RoOwogICAgICB9CgogICAgICB0aGlzLnRhZyA9IHRhZzsKICAgICAgdGhpcy5yZWZlcmVuY2VzID0gcmVmZXJlbmNlczsKICAgICAgdGhpcy5sZW5ndGggPSBsZW5ndGg7CiAgICB9CgogICAgQ2FwdHVyZWRQb3NpdGlvbmFsQXJndW1lbnRzLmVtcHR5ID0gZnVuY3Rpb24gZW1wdHkoKSB7CiAgICAgIHJldHVybiBuZXcgQ2FwdHVyZWRQb3NpdGlvbmFsQXJndW1lbnRzKF9yZWZlcmVuY2UyLkNPTlNUQU5UX1RBRywgX3V0aWwuRU1QVFlfQVJSQVksIDApOwogICAgfTsKCiAgICB2YXIgX3Byb3RvNTkgPSBDYXB0dXJlZFBvc2l0aW9uYWxBcmd1bWVudHMucHJvdG90eXBlOwoKICAgIF9wcm90bzU5LmF0ID0gZnVuY3Rpb24gYXQocG9zaXRpb24pIHsKICAgICAgcmV0dXJuIHRoaXMucmVmZXJlbmNlc1twb3NpdGlvbl07CiAgICB9OwoKICAgIF9wcm90bzU5LnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHJldHVybiB0aGlzLnJlZmVyZW5jZXMubWFwKHRoaXMudmFsdWVPZik7CiAgICB9OwoKICAgIF9wcm90bzU5LmdldCA9IGZ1bmN0aW9uIGdldChuYW1lKSB7CiAgICAgIHZhciByZWZlcmVuY2VzID0gdGhpcy5yZWZlcmVuY2VzLAogICAgICAgICAgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CgogICAgICBpZiAobmFtZSA9PT0gJ2xlbmd0aCcpIHsKICAgICAgICByZXR1cm4gUHJpbWl0aXZlUmVmZXJlbmNlLmNyZWF0ZShsZW5ndGgpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBpZHggPSBwYXJzZUludChuYW1lLCAxMCk7CgogICAgICAgIGlmIChpZHggPCAwIHx8IGlkeCA+PSBsZW5ndGgpIHsKICAgICAgICAgIHJldHVybiBVTkRFRklORURfUkVGRVJFTkNFOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gcmVmZXJlbmNlc1tpZHhdOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG81OS52YWx1ZU9mID0gZnVuY3Rpb24gdmFsdWVPZihyZWZlcmVuY2UpIHsKICAgICAgcmV0dXJuIHJlZmVyZW5jZS52YWx1ZSgpOwogICAgfTsKCiAgICByZXR1cm4gQ2FwdHVyZWRQb3NpdGlvbmFsQXJndW1lbnRzOwogIH0oKTsKCiAgdmFyIE5hbWVkQXJndW1lbnRzID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gTmFtZWRBcmd1bWVudHMoKSB7CiAgICAgIHRoaXMuYmFzZSA9IDA7CiAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgdGhpcy5fcmVmZXJlbmNlcyA9IG51bGw7CiAgICAgIHRoaXMuX25hbWVzID0gX3V0aWwuRU1QVFlfQVJSQVk7CiAgICAgIHRoaXMuX2F0TmFtZXMgPSBfdXRpbC5FTVBUWV9BUlJBWTsKICAgIH0KCiAgICB2YXIgX3Byb3RvNjAgPSBOYW1lZEFyZ3VtZW50cy5wcm90b3R5cGU7CgogICAgX3Byb3RvNjAuZW1wdHkgPSBmdW5jdGlvbiBlbXB0eShzdGFjaywgYmFzZSkgewogICAgICB0aGlzLnN0YWNrID0gc3RhY2s7CiAgICAgIHRoaXMuYmFzZSA9IGJhc2U7CiAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgdGhpcy5fcmVmZXJlbmNlcyA9IF91dGlsLkVNUFRZX0FSUkFZOwogICAgICB0aGlzLl9uYW1lcyA9IF91dGlsLkVNUFRZX0FSUkFZOwogICAgICB0aGlzLl9hdE5hbWVzID0gX3V0aWwuRU1QVFlfQVJSQVk7CiAgICB9OwoKICAgIF9wcm90bzYwLnNldHVwID0gZnVuY3Rpb24gc2V0dXAoc3RhY2ssIGJhc2UsIGxlbmd0aCwgbmFtZXMsIHN5bnRoZXRpYykgewogICAgICB0aGlzLnN0YWNrID0gc3RhY2s7CiAgICAgIHRoaXMuYmFzZSA9IGJhc2U7CiAgICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoOwoKICAgICAgaWYgKGxlbmd0aCA9PT0gMCkgewogICAgICAgIHRoaXMuX3JlZmVyZW5jZXMgPSBfdXRpbC5FTVBUWV9BUlJBWTsKICAgICAgICB0aGlzLl9uYW1lcyA9IF91dGlsLkVNUFRZX0FSUkFZOwogICAgICAgIHRoaXMuX2F0TmFtZXMgPSBfdXRpbC5FTVBUWV9BUlJBWTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9yZWZlcmVuY2VzID0gbnVsbDsKCiAgICAgICAgaWYgKHN5bnRoZXRpYykgewogICAgICAgICAgdGhpcy5fbmFtZXMgPSBuYW1lczsKICAgICAgICAgIHRoaXMuX2F0TmFtZXMgPSBudWxsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl9uYW1lcyA9IG51bGw7CiAgICAgICAgICB0aGlzLl9hdE5hbWVzID0gbmFtZXM7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzYwLmhhcyA9IGZ1bmN0aW9uIGhhcyhuYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLm5hbWVzLmluZGV4T2YobmFtZSkgIT09IC0xOwogICAgfTsKCiAgICBfcHJvdG82MC5nZXQgPSBmdW5jdGlvbiBnZXQobmFtZSwgc3ludGhldGljKSB7CiAgICAgIGlmIChzeW50aGV0aWMgPT09IHZvaWQgMCkgewogICAgICAgIHN5bnRoZXRpYyA9IHRydWU7CiAgICAgIH0KCiAgICAgIHZhciBiYXNlID0gdGhpcy5iYXNlLAogICAgICAgICAgc3RhY2sgPSB0aGlzLnN0YWNrOwogICAgICB2YXIgbmFtZXMgPSBzeW50aGV0aWMgPyB0aGlzLm5hbWVzIDogdGhpcy5hdE5hbWVzOwogICAgICB2YXIgaWR4ID0gbmFtZXMuaW5kZXhPZihuYW1lKTsKCiAgICAgIGlmIChpZHggPT09IC0xKSB7CiAgICAgICAgcmV0dXJuIFVOREVGSU5FRF9SRUZFUkVOQ0U7CiAgICAgIH0KCiAgICAgIHJldHVybiBzdGFjay5nZXQoaWR4LCBiYXNlKTsKICAgIH07CgogICAgX3Byb3RvNjAuY2FwdHVyZSA9IGZ1bmN0aW9uIGNhcHR1cmUoKSB7CiAgICAgIHJldHVybiBuZXcgQ2FwdHVyZWROYW1lZEFyZ3VtZW50cyh0aGlzLnRhZywgdGhpcy5uYW1lcywgdGhpcy5yZWZlcmVuY2VzKTsKICAgIH07CgogICAgX3Byb3RvNjAubWVyZ2UgPSBmdW5jdGlvbiBtZXJnZShvdGhlcikgewogICAgICB2YXIgZXh0cmFzID0gb3RoZXIubGVuZ3RoOwoKICAgICAgaWYgKGV4dHJhcyA+IDApIHsKICAgICAgICB2YXIgbmFtZXMgPSB0aGlzLm5hbWVzLAogICAgICAgICAgICBsZW5ndGggPSB0aGlzLmxlbmd0aCwKICAgICAgICAgICAgc3RhY2sgPSB0aGlzLnN0YWNrOwogICAgICAgIHZhciBleHRyYU5hbWVzID0gb3RoZXIubmFtZXM7CgogICAgICAgIGlmIChPYmplY3QuaXNGcm96ZW4obmFtZXMpICYmIG5hbWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgbmFtZXMgPSBbXTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXh0cmFzOyBpKyspIHsKICAgICAgICAgIHZhciBuYW1lID0gZXh0cmFOYW1lc1tpXTsKICAgICAgICAgIHZhciBpZHggPSBuYW1lcy5pbmRleE9mKG5hbWUpOwoKICAgICAgICAgIGlmIChpZHggPT09IC0xKSB7CiAgICAgICAgICAgIGxlbmd0aCA9IG5hbWVzLnB1c2gobmFtZSk7CiAgICAgICAgICAgIHN0YWNrLnB1c2gob3RoZXIucmVmZXJlbmNlc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICB0aGlzLl9yZWZlcmVuY2VzID0gbnVsbDsKICAgICAgICB0aGlzLl9uYW1lcyA9IG5hbWVzOwogICAgICAgIHRoaXMuX2F0TmFtZXMgPSBudWxsOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzYwLnRvU3ludGhldGljTmFtZSA9IGZ1bmN0aW9uIHRvU3ludGhldGljTmFtZShuYW1lKSB7CiAgICAgIHJldHVybiBuYW1lLnNsaWNlKDEpOwogICAgfTsKCiAgICBfcHJvdG82MC50b0F0TmFtZSA9IGZ1bmN0aW9uIHRvQXROYW1lKG5hbWUpIHsKICAgICAgcmV0dXJuICJAIiArIG5hbWU7CiAgICB9OwoKICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoTmFtZWRBcmd1bWVudHMsIFt7CiAgICAgIGtleTogInRhZyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiAoMCwgX3JlZmVyZW5jZTIuY29tYmluZVRhZ2dlZCkodGhpcy5yZWZlcmVuY2VzKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJuYW1lcyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHZhciBuYW1lcyA9IHRoaXMuX25hbWVzOwoKICAgICAgICBpZiAoIW5hbWVzKSB7CiAgICAgICAgICBuYW1lcyA9IHRoaXMuX25hbWVzID0gdGhpcy5fYXROYW1lcy5tYXAodGhpcy50b1N5bnRoZXRpY05hbWUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG5hbWVzOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImF0TmFtZXMiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICB2YXIgYXROYW1lcyA9IHRoaXMuX2F0TmFtZXM7CgogICAgICAgIGlmICghYXROYW1lcykgewogICAgICAgICAgYXROYW1lcyA9IHRoaXMuX2F0TmFtZXMgPSB0aGlzLl9uYW1lcy5tYXAodGhpcy50b0F0TmFtZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYXROYW1lczsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZWZlcmVuY2VzIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgdmFyIHJlZmVyZW5jZXMgPSB0aGlzLl9yZWZlcmVuY2VzOwoKICAgICAgICBpZiAoIXJlZmVyZW5jZXMpIHsKICAgICAgICAgIHZhciBiYXNlID0gdGhpcy5iYXNlLAogICAgICAgICAgICAgIGxlbmd0aCA9IHRoaXMubGVuZ3RoLAogICAgICAgICAgICAgIHN0YWNrID0gdGhpcy5zdGFjazsKICAgICAgICAgIHJlZmVyZW5jZXMgPSB0aGlzLl9yZWZlcmVuY2VzID0gc3RhY2suc2xpY2VBcnJheShiYXNlLCBiYXNlICsgbGVuZ3RoKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZWZlcmVuY2VzOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gTmFtZWRBcmd1bWVudHM7CiAgfSgpOwoKICB2YXIgQ2FwdHVyZWROYW1lZEFyZ3VtZW50cyA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIENhcHR1cmVkTmFtZWRBcmd1bWVudHModGFnLCBuYW1lcywgcmVmZXJlbmNlcykgewogICAgICB0aGlzLnRhZyA9IHRhZzsKICAgICAgdGhpcy5uYW1lcyA9IG5hbWVzOwogICAgICB0aGlzLnJlZmVyZW5jZXMgPSByZWZlcmVuY2VzOwogICAgICB0aGlzLmxlbmd0aCA9IG5hbWVzLmxlbmd0aDsKICAgICAgdGhpcy5fbWFwID0gbnVsbDsKICAgIH0KCiAgICB2YXIgX3Byb3RvNjEgPSBDYXB0dXJlZE5hbWVkQXJndW1lbnRzLnByb3RvdHlwZTsKCiAgICBfcHJvdG82MS5oYXMgPSBmdW5jdGlvbiBoYXMobmFtZSkgewogICAgICByZXR1cm4gdGhpcy5uYW1lcy5pbmRleE9mKG5hbWUpICE9PSAtMTsKICAgIH07CgogICAgX3Byb3RvNjEuZ2V0ID0gZnVuY3Rpb24gZ2V0KG5hbWUpIHsKICAgICAgdmFyIG5hbWVzID0gdGhpcy5uYW1lcywKICAgICAgICAgIHJlZmVyZW5jZXMgPSB0aGlzLnJlZmVyZW5jZXM7CiAgICAgIHZhciBpZHggPSBuYW1lcy5pbmRleE9mKG5hbWUpOwoKICAgICAgaWYgKGlkeCA9PT0gLTEpIHsKICAgICAgICByZXR1cm4gVU5ERUZJTkVEX1JFRkVSRU5DRTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gcmVmZXJlbmNlc1tpZHhdOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzYxLnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHZhciBuYW1lcyA9IHRoaXMubmFtZXMsCiAgICAgICAgICByZWZlcmVuY2VzID0gdGhpcy5yZWZlcmVuY2VzOwogICAgICB2YXIgb3V0ID0gKDAsIF91dGlsLmRpY3QpKCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICBvdXRbbmFtZV0gPSByZWZlcmVuY2VzW2ldLnZhbHVlKCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBvdXQ7CiAgICB9OwoKICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoQ2FwdHVyZWROYW1lZEFyZ3VtZW50cywgW3sKICAgICAga2V5OiAibWFwIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgdmFyIG1hcCA9IHRoaXMuX21hcDsKCiAgICAgICAgaWYgKCFtYXApIHsKICAgICAgICAgIHZhciBuYW1lcyA9IHRoaXMubmFtZXMsCiAgICAgICAgICAgICAgcmVmZXJlbmNlcyA9IHRoaXMucmVmZXJlbmNlczsKICAgICAgICAgIG1hcCA9IHRoaXMuX21hcCA9ICgwLCBfdXRpbC5kaWN0KSgpOwoKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICAgICAgbWFwW25hbWVdID0gcmVmZXJlbmNlc1tpXTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBtYXA7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBDYXB0dXJlZE5hbWVkQXJndW1lbnRzOwogIH0oKTsKCiAgdmFyIEJsb2NrQXJndW1lbnRzID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQmxvY2tBcmd1bWVudHMoKSB7CiAgICAgIHRoaXMuaW50ZXJuYWxWYWx1ZXMgPSBudWxsOwogICAgICB0aGlzLmludGVybmFsVGFnID0gbnVsbDsKICAgICAgdGhpcy5uYW1lcyA9IF91dGlsLkVNUFRZX0FSUkFZOwogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMuYmFzZSA9IDA7CiAgICB9CgogICAgdmFyIF9wcm90bzYyID0gQmxvY2tBcmd1bWVudHMucHJvdG90eXBlOwoKICAgIF9wcm90bzYyLmVtcHR5ID0gZnVuY3Rpb24gZW1wdHkoc3RhY2ssIGJhc2UpIHsKICAgICAgdGhpcy5zdGFjayA9IHN0YWNrOwogICAgICB0aGlzLm5hbWVzID0gX3V0aWwuRU1QVFlfQVJSQVk7CiAgICAgIHRoaXMuYmFzZSA9IGJhc2U7CiAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgdGhpcy5pbnRlcm5hbFRhZyA9IF9yZWZlcmVuY2UyLkNPTlNUQU5UX1RBRzsKICAgICAgdGhpcy5pbnRlcm5hbFZhbHVlcyA9IF91dGlsLkVNUFRZX0FSUkFZOwogICAgfTsKCiAgICBfcHJvdG82Mi5zZXR1cCA9IGZ1bmN0aW9uIHNldHVwKHN0YWNrLCBiYXNlLCBsZW5ndGgsIG5hbWVzKSB7CiAgICAgIHRoaXMuc3RhY2sgPSBzdGFjazsKICAgICAgdGhpcy5uYW1lcyA9IG5hbWVzOwogICAgICB0aGlzLmJhc2UgPSBiYXNlOwogICAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aDsKCiAgICAgIGlmIChsZW5ndGggPT09IDApIHsKICAgICAgICB0aGlzLmludGVybmFsVGFnID0gX3JlZmVyZW5jZTIuQ09OU1RBTlRfVEFHOwogICAgICAgIHRoaXMuaW50ZXJuYWxWYWx1ZXMgPSBfdXRpbC5FTVBUWV9BUlJBWTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmludGVybmFsVGFnID0gbnVsbDsKICAgICAgICB0aGlzLmludGVybmFsVmFsdWVzID0gbnVsbDsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG82Mi5oYXMgPSBmdW5jdGlvbiBoYXMobmFtZSkgewogICAgICByZXR1cm4gdGhpcy5uYW1lcy5pbmRleE9mKG5hbWUpICE9PSAtMTsKICAgIH07CgogICAgX3Byb3RvNjIuZ2V0ID0gZnVuY3Rpb24gZ2V0KG5hbWUpIHsKICAgICAgdmFyIGJhc2UgPSB0aGlzLmJhc2UsCiAgICAgICAgICBzdGFjayA9IHRoaXMuc3RhY2ssCiAgICAgICAgICBuYW1lcyA9IHRoaXMubmFtZXM7CiAgICAgIHZhciBpZHggPSBuYW1lcy5pbmRleE9mKG5hbWUpOwoKICAgICAgaWYgKG5hbWVzLmluZGV4T2YobmFtZSkgPT09IC0xKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIHZhciB0YWJsZSA9IHN0YWNrLmdldChpZHggKiAzLCBiYXNlKTsKICAgICAgdmFyIHNjb3BlID0gc3RhY2suZ2V0KGlkeCAqIDMgKyAxLCBiYXNlKTsgLy8gRklYTUUobW11bik6IHNob3VsZG4ndCBuZWVkIHRvIGNhc3QgdGhpcwoKICAgICAgdmFyIGhhbmRsZSA9IHN0YWNrLmdldChpZHggKiAzICsgMiwgYmFzZSk7CiAgICAgIHJldHVybiBoYW5kbGUgPT09IG51bGwgPyBudWxsIDogW2hhbmRsZSwgc2NvcGUsIHRhYmxlXTsKICAgIH07CgogICAgX3Byb3RvNjIuY2FwdHVyZSA9IGZ1bmN0aW9uIGNhcHR1cmUoKSB7CiAgICAgIHJldHVybiBuZXcgQ2FwdHVyZWRCbG9ja0FyZ3VtZW50cyh0aGlzLm5hbWVzLCB0aGlzLnZhbHVlcyk7CiAgICB9OwoKICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoQmxvY2tBcmd1bWVudHMsIFt7CiAgICAgIGtleTogInZhbHVlcyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHZhciB2YWx1ZXMgPSB0aGlzLmludGVybmFsVmFsdWVzOwoKICAgICAgICBpZiAoIXZhbHVlcykgewogICAgICAgICAgdmFyIGJhc2UgPSB0aGlzLmJhc2UsCiAgICAgICAgICAgICAgbGVuZ3RoID0gdGhpcy5sZW5ndGgsCiAgICAgICAgICAgICAgc3RhY2sgPSB0aGlzLnN0YWNrOwogICAgICAgICAgdmFsdWVzID0gdGhpcy5pbnRlcm5hbFZhbHVlcyA9IHN0YWNrLnNsaWNlQXJyYXkoYmFzZSwgYmFzZSArIGxlbmd0aCAqIDMpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEJsb2NrQXJndW1lbnRzOwogIH0oKTsKCiAgdmFyIENhcHR1cmVkQmxvY2tBcmd1bWVudHMgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBDYXB0dXJlZEJsb2NrQXJndW1lbnRzKG5hbWVzLCB2YWx1ZXMpIHsKICAgICAgdGhpcy5uYW1lcyA9IG5hbWVzOwogICAgICB0aGlzLnZhbHVlcyA9IHZhbHVlczsKICAgICAgdGhpcy5sZW5ndGggPSBuYW1lcy5sZW5ndGg7CiAgICB9CgogICAgdmFyIF9wcm90bzYzID0gQ2FwdHVyZWRCbG9ja0FyZ3VtZW50cy5wcm90b3R5cGU7CgogICAgX3Byb3RvNjMuaGFzID0gZnVuY3Rpb24gaGFzKG5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMubmFtZXMuaW5kZXhPZihuYW1lKSAhPT0gLTE7CiAgICB9OwoKICAgIF9wcm90bzYzLmdldCA9IGZ1bmN0aW9uIGdldChuYW1lKSB7CiAgICAgIHZhciBpZHggPSB0aGlzLm5hbWVzLmluZGV4T2YobmFtZSk7CiAgICAgIGlmIChpZHggPT09IC0xKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIFt0aGlzLnZhbHVlc1tpZHggKiAzICsgMl0sIHRoaXMudmFsdWVzW2lkeCAqIDMgKyAxXSwgdGhpcy52YWx1ZXNbaWR4ICogM11dOwogICAgfTsKCiAgICByZXR1cm4gQ2FwdHVyZWRCbG9ja0FyZ3VtZW50czsKICB9KCk7CgogIHZhciBFTVBUWV9OQU1FRCA9IG5ldyBDYXB0dXJlZE5hbWVkQXJndW1lbnRzKF9yZWZlcmVuY2UyLkNPTlNUQU5UX1RBRywgX3V0aWwuRU1QVFlfQVJSQVksIF91dGlsLkVNUFRZX0FSUkFZKTsKICB2YXIgRU1QVFlfUE9TSVRJT05BTCA9IG5ldyBDYXB0dXJlZFBvc2l0aW9uYWxBcmd1bWVudHMoX3JlZmVyZW5jZTIuQ09OU1RBTlRfVEFHLCBfdXRpbC5FTVBUWV9BUlJBWSk7CiAgdmFyIEVNUFRZX0FSR1MgPSBuZXcgQ2FwdHVyZWRBcmd1bWVudHMoX3JlZmVyZW5jZTIuQ09OU1RBTlRfVEFHLCBFTVBUWV9QT1NJVElPTkFMLCBFTVBUWV9OQU1FRCwgMCk7CiAgX2V4cG9ydHMuRU1QVFlfQVJHUyA9IEVNUFRZX0FSR1M7CgogIHZhciBWTSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFZNKHJ1bnRpbWUsIHNjb3BlLCBkeW5hbWljU2NvcGUsIGVsZW1lbnRTdGFjaykgewogICAgICB2YXIgX3RoaXMxOSA9IHRoaXM7CgogICAgICB0aGlzLnJ1bnRpbWUgPSBydW50aW1lOwogICAgICB0aGlzLmVsZW1lbnRTdGFjayA9IGVsZW1lbnRTdGFjazsKICAgICAgdGhpcy5keW5hbWljU2NvcGVTdGFjayA9IG5ldyBfdXRpbC5TdGFjaygpOwogICAgICB0aGlzLnNjb3BlU3RhY2sgPSBuZXcgX3V0aWwuU3RhY2soKTsKICAgICAgdGhpcy51cGRhdGluZ09wY29kZVN0YWNrID0gbmV3IF91dGlsLlN0YWNrKCk7CiAgICAgIHRoaXMuY2FjaGVHcm91cHMgPSBuZXcgX3V0aWwuU3RhY2soKTsKICAgICAgdGhpcy5saXN0QmxvY2tTdGFjayA9IG5ldyBfdXRpbC5TdGFjaygpOwogICAgICB0aGlzLnMwID0gbnVsbDsKICAgICAgdGhpcy5zMSA9IG51bGw7CiAgICAgIHRoaXMudDAgPSBudWxsOwogICAgICB0aGlzLnQxID0gbnVsbDsKICAgICAgdGhpcy52MCA9IG51bGw7CiAgICAgIHRoaXMuaGVhcCA9IHRoaXMucHJvZ3JhbS5oZWFwOwogICAgICB0aGlzLmNvbnN0YW50cyA9IHRoaXMucHJvZ3JhbS5jb25zdGFudHM7CiAgICAgIHRoaXMuZWxlbWVudFN0YWNrID0gZWxlbWVudFN0YWNrOwogICAgICB0aGlzLnNjb3BlU3RhY2sucHVzaChzY29wZSk7CiAgICAgIHRoaXMuZHluYW1pY1Njb3BlU3RhY2sucHVzaChkeW5hbWljU2NvcGUpOwogICAgICB0aGlzLmFyZ3MgPSBuZXcgQXJndW1lbnRzKCk7CiAgICAgIHRoaXMuaW5uZXIgPSBuZXcgTG93TGV2ZWxWTShFdmFsdWF0aW9uU3RhY2suZW1wdHkoKSwgdGhpcy5oZWFwLCBydW50aW1lLnByb2dyYW0sIHsKICAgICAgICBkZWJ1Z0JlZm9yZTogZnVuY3Rpb24gZGVidWdCZWZvcmUob3Bjb2RlKSB7CiAgICAgICAgICByZXR1cm4gQVBQRU5EX09QQ09ERVMuZGVidWdCZWZvcmUoX3RoaXMxOSwgb3Bjb2RlLCBvcGNvZGUudHlwZSk7CiAgICAgICAgfSwKICAgICAgICBkZWJ1Z0FmdGVyOiBmdW5jdGlvbiBkZWJ1Z0FmdGVyKG9wY29kZSwgc3RhdGUpIHsKICAgICAgICAgIEFQUEVORF9PUENPREVTLmRlYnVnQWZ0ZXIoX3RoaXMxOSwgb3Bjb2RlLCBvcGNvZGUudHlwZSwgc3RhdGUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgdmFyIF9wcm90bzY0ID0gVk0ucHJvdG90eXBlOwoKICAgIC8vIEZldGNoIGEgdmFsdWUgZnJvbSBhIHJlZ2lzdGVyIG9udG8gdGhlIHN0YWNrCiAgICBfcHJvdG82NC5mZXRjaCA9IGZ1bmN0aW9uIGZldGNoKHJlZ2lzdGVyKSB7CiAgICAgIHRoaXMuc3RhY2sucHVzaCh0aGlzW192bTIuUmVnaXN0ZXJbcmVnaXN0ZXJdXSk7CiAgICB9IC8vIExvYWQgYSB2YWx1ZSBmcm9tIHRoZSBzdGFjayBpbnRvIGEgcmVnaXN0ZXIKICAgIDsKCiAgICBfcHJvdG82NC5sb2FkID0gZnVuY3Rpb24gbG9hZChyZWdpc3RlcikgewogICAgICB0aGlzW192bTIuUmVnaXN0ZXJbcmVnaXN0ZXJdXSA9IHRoaXMuc3RhY2sucG9wKCk7CiAgICB9IC8vIEZldGNoIGEgdmFsdWUgZnJvbSBhIHJlZ2lzdGVyCiAgICA7CgogICAgX3Byb3RvNjQuZmV0Y2hWYWx1ZSA9IGZ1bmN0aW9uIGZldGNoVmFsdWUocmVnaXN0ZXIpIHsKICAgICAgcmV0dXJuIHRoaXNbX3ZtMi5SZWdpc3RlcltyZWdpc3Rlcl1dOwogICAgfSAvLyBMb2FkIGEgdmFsdWUgaW50byBhIHJlZ2lzdGVyCiAgICA7CgogICAgX3Byb3RvNjQubG9hZFZhbHVlID0gZnVuY3Rpb24gbG9hZFZhbHVlKHJlZ2lzdGVyLCB2YWx1ZSQkMSkgewogICAgICB0aGlzW192bTIuUmVnaXN0ZXJbcmVnaXN0ZXJdXSA9IHZhbHVlJCQxOwogICAgfQogICAgLyoqCiAgICAgKiBNaWdyYXRlZCB0byBJbm5lcgogICAgICovCiAgICAvLyBTdGFydCBhIG5ldyBmcmFtZSBhbmQgc2F2ZSAkcmEgYW5kICRmcCBvbiB0aGUgc3RhY2sKICAgIDsKCiAgICBfcHJvdG82NC5wdXNoRnJhbWUgPSBmdW5jdGlvbiBwdXNoRnJhbWUoKSB7CiAgICAgIHRoaXMuaW5uZXIucHVzaEZyYW1lKCk7CiAgICB9IC8vIFJlc3RvcmUgJHJhLCAkc3AgYW5kICRmcAogICAgOwoKICAgIF9wcm90bzY0LnBvcEZyYW1lID0gZnVuY3Rpb24gcG9wRnJhbWUoKSB7CiAgICAgIHRoaXMuaW5uZXIucG9wRnJhbWUoKTsKICAgIH0gLy8gSnVtcCB0byBhbiBhZGRyZXNzIGluIGBwcm9ncmFtYAogICAgOwoKICAgIF9wcm90bzY0LmdvdG8gPSBmdW5jdGlvbiBnb3RvKG9mZnNldCkgewogICAgICB0aGlzLmlubmVyLmdvdG8ob2Zmc2V0KTsKICAgIH0gLy8gU2F2ZSAkcGMgaW50byAkcmEsIHRoZW4ganVtcCB0byBhIG5ldyBhZGRyZXNzIGluIGBwcm9ncmFtYCAoamFsIGluIE1JUFMpCiAgICA7CgogICAgX3Byb3RvNjQuY2FsbCA9IGZ1bmN0aW9uIGNhbGwoaGFuZGxlKSB7CiAgICAgIHRoaXMuaW5uZXIuY2FsbChoYW5kbGUpOwogICAgfSAvLyBQdXQgYSBzcGVjaWZpYyBgcHJvZ3JhbWAgYWRkcmVzcyBpbiAkcmEKICAgIDsKCiAgICBfcHJvdG82NC5yZXR1cm5UbyA9IGZ1bmN0aW9uIHJldHVyblRvKG9mZnNldCkgewogICAgICB0aGlzLmlubmVyLnJldHVyblRvKG9mZnNldCk7CiAgICB9IC8vIFJldHVybiB0byB0aGUgYHByb2dyYW1gIGFkZHJlc3Mgc3RvcmVkIGluICRyYQogICAgOwoKICAgIF9wcm90bzY0LnJldHVybiA9IGZ1bmN0aW9uIF9yZXR1cm4oKSB7CiAgICAgIHRoaXMuaW5uZXIucmV0dXJuKCk7CiAgICB9CiAgICAvKioKICAgICAqIEVuZCBvZiBtaWdyYXRlZC4KICAgICAqLwogICAgOwoKICAgIFZNLmluaXRpYWwgPSBmdW5jdGlvbiBpbml0aWFsKHByb2dyYW0sIGVudiwgc2VsZiwgZHluYW1pY1Njb3BlLCBlbGVtZW50U3RhY2ssIGhhbmRsZSkgewogICAgICB2YXIgc2NvcGVTaXplID0gcHJvZ3JhbS5oZWFwLnNjb3Blc2l6ZW9mKGhhbmRsZSk7CiAgICAgIHZhciBzY29wZSA9IFNjb3BlLnJvb3Qoc2VsZiwgc2NvcGVTaXplKTsKICAgICAgdmFyIHZtID0gbmV3IFZNKHsKICAgICAgICBwcm9ncmFtOiBwcm9ncmFtLAogICAgICAgIGVudjogZW52CiAgICAgIH0sIHNjb3BlLCBkeW5hbWljU2NvcGUsIGVsZW1lbnRTdGFjayk7CiAgICAgIHZtLnBjID0gdm0uaGVhcC5nZXRhZGRyKGhhbmRsZSk7CiAgICAgIHZtLnVwZGF0aW5nT3Bjb2RlU3RhY2sucHVzaChuZXcgX3V0aWwuTGlua2VkTGlzdCgpKTsKICAgICAgcmV0dXJuIHZtOwogICAgfTsKCiAgICBWTS5lbXB0eSA9IGZ1bmN0aW9uIGVtcHR5KHByb2dyYW0sIGVudiwgZWxlbWVudFN0YWNrLCBoYW5kbGUpIHsKICAgICAgdmFyIGR5bmFtaWNTY29wZSA9IHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHJldHVybiBVTkRFRklORURfUkVGRVJFTkNFOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoKSB7CiAgICAgICAgICByZXR1cm4gVU5ERUZJTkVEX1JFRkVSRU5DRTsKICAgICAgICB9LAogICAgICAgIGNoaWxkOiBmdW5jdGlvbiBjaGlsZCgpIHsKICAgICAgICAgIHJldHVybiBkeW5hbWljU2NvcGU7CiAgICAgICAgfQogICAgICB9OwogICAgICB2YXIgdm0gPSBuZXcgVk0oewogICAgICAgIHByb2dyYW06IHByb2dyYW0sCiAgICAgICAgZW52OiBlbnYKICAgICAgfSwgU2NvcGUucm9vdChVTkRFRklORURfUkVGRVJFTkNFLCAwKSwgZHluYW1pY1Njb3BlLCBlbGVtZW50U3RhY2spOwogICAgICB2bS51cGRhdGluZ09wY29kZVN0YWNrLnB1c2gobmV3IF91dGlsLkxpbmtlZExpc3QoKSk7CiAgICAgIHZtLnBjID0gdm0uaGVhcC5nZXRhZGRyKGhhbmRsZSk7CiAgICAgIHJldHVybiB2bTsKICAgIH07CgogICAgVk0ucmVzdW1lID0gZnVuY3Rpb24gcmVzdW1lKF9yZWY1OSwgcnVudGltZSwgc3RhY2spIHsKICAgICAgdmFyIHNjb3BlID0gX3JlZjU5LnNjb3BlLAogICAgICAgICAgZHluYW1pY1Njb3BlID0gX3JlZjU5LmR5bmFtaWNTY29wZTsKICAgICAgcmV0dXJuIG5ldyBWTShydW50aW1lLCBzY29wZSwgZHluYW1pY1Njb3BlLCBzdGFjayk7CiAgICB9OwoKICAgIF9wcm90bzY0LmNhcHR1cmUgPSBmdW5jdGlvbiBjYXB0dXJlKGFyZ3MpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBkeW5hbWljU2NvcGU6IHRoaXMuZHluYW1pY1Njb3BlKCksCiAgICAgICAgc2NvcGU6IHRoaXMuc2NvcGUoKSwKICAgICAgICBzdGFjazogdGhpcy5zdGFjay5jYXB0dXJlKGFyZ3MpCiAgICAgIH07CiAgICB9OwoKICAgIF9wcm90bzY0LmJlZ2luQ2FjaGVHcm91cCA9IGZ1bmN0aW9uIGJlZ2luQ2FjaGVHcm91cCgpIHsKICAgICAgdGhpcy5jYWNoZUdyb3Vwcy5wdXNoKHRoaXMudXBkYXRpbmcoKS50YWlsKCkpOwogICAgfTsKCiAgICBfcHJvdG82NC5jb21taXRDYWNoZUdyb3VwID0gZnVuY3Rpb24gY29tbWl0Q2FjaGVHcm91cCgpIHsKICAgICAgLy8gICAgICAgIEp1bXBJZk5vdE1vZGlmaWVkKEVORCkKICAgICAgLy8gICAgICAgIChoZWFkKQogICAgICAvLyAgICAgICAgKC4uLi4pCiAgICAgIC8vICAgICAgICAodGFpbCkKICAgICAgLy8gICAgICAgIERpZE1vZGlmeQogICAgICAvLyBFTkQ6ICAgTm9vcAogICAgICB2YXIgRU5EID0gbmV3IExhYmVsT3Bjb2RlKCdFTkQnKTsKICAgICAgdmFyIG9wY29kZXMgPSB0aGlzLnVwZGF0aW5nKCk7CiAgICAgIHZhciBtYXJrZXIgPSB0aGlzLmNhY2hlR3JvdXBzLnBvcCgpOwogICAgICB2YXIgaGVhZCA9IG1hcmtlciA/IG9wY29kZXMubmV4dE5vZGUobWFya2VyKSA6IG9wY29kZXMuaGVhZCgpOwogICAgICB2YXIgdGFpbCA9IG9wY29kZXMudGFpbCgpOwogICAgICB2YXIgdGFnID0gKDAsIF9yZWZlcmVuY2UyLmNvbWJpbmVTbGljZSkobmV3IF91dGlsLkxpc3RTbGljZShoZWFkLCB0YWlsKSk7CiAgICAgIHZhciBndWFyZCA9IG5ldyBKdW1wSWZOb3RNb2RpZmllZE9wY29kZSh0YWcsIEVORCk7CiAgICAgIG9wY29kZXMuaW5zZXJ0QmVmb3JlKGd1YXJkLCBoZWFkKTsKICAgICAgb3Bjb2Rlcy5hcHBlbmQobmV3IERpZE1vZGlmeU9wY29kZShndWFyZCkpOwogICAgICBvcGNvZGVzLmFwcGVuZChFTkQpOwogICAgfTsKCiAgICBfcHJvdG82NC5lbnRlciA9IGZ1bmN0aW9uIGVudGVyKGFyZ3MpIHsKICAgICAgdmFyIHVwZGF0aW5nID0gbmV3IF91dGlsLkxpbmtlZExpc3QoKTsKICAgICAgdmFyIHN0YXRlID0gdGhpcy5jYXB0dXJlKGFyZ3MpOwogICAgICB2YXIgdHJhY2tlciA9IHRoaXMuZWxlbWVudHMoKS5wdXNoVXBkYXRhYmxlQmxvY2soKTsKICAgICAgdmFyIHRyeU9wY29kZSA9IG5ldyBUcnlPcGNvZGUodGhpcy5oZWFwLmdldGhhbmRsZSh0aGlzLnBjKSwgc3RhdGUsIHRoaXMucnVudGltZSwgdHJhY2tlciwgdXBkYXRpbmcpOwogICAgICB0aGlzLmRpZEVudGVyKHRyeU9wY29kZSk7CiAgICB9OwoKICAgIF9wcm90bzY0Lml0ZXJhdGUgPSBmdW5jdGlvbiBpdGVyYXRlKG1lbW8sIHZhbHVlJCQxKSB7CiAgICAgIHZhciBzdGFjayA9IHRoaXMuc3RhY2s7CiAgICAgIHN0YWNrLnB1c2godmFsdWUkJDEpOwogICAgICBzdGFjay5wdXNoKG1lbW8pOwogICAgICB2YXIgc3RhdGUgPSB0aGlzLmNhcHR1cmUoMik7CiAgICAgIHZhciB0cmFja2VyID0gdGhpcy5lbGVtZW50cygpLnB1c2hVcGRhdGFibGVCbG9jaygpOyAvLyBsZXQgaXAgPSB0aGlzLmlwOwogICAgICAvLyB0aGlzLmlwID0gZW5kICsgNDsKICAgICAgLy8gdGhpcy5mcmFtZXMucHVzaChpcCk7CgogICAgICByZXR1cm4gbmV3IFRyeU9wY29kZSh0aGlzLmhlYXAuZ2V0aGFuZGxlKHRoaXMucGMpLCBzdGF0ZSwgdGhpcy5ydW50aW1lLCB0cmFja2VyLCBuZXcgX3V0aWwuTGlua2VkTGlzdCgpKTsKICAgIH07CgogICAgX3Byb3RvNjQuZW50ZXJJdGVtID0gZnVuY3Rpb24gZW50ZXJJdGVtKGtleSwgb3Bjb2RlKSB7CiAgICAgIHRoaXMubGlzdEJsb2NrKCkubWFwW2tleV0gPSBvcGNvZGU7CiAgICAgIHRoaXMuZGlkRW50ZXIob3Bjb2RlKTsKICAgIH07CgogICAgX3Byb3RvNjQuZW50ZXJMaXN0ID0gZnVuY3Rpb24gZW50ZXJMaXN0KHJlbGF0aXZlU3RhcnQpIHsKICAgICAgdmFyIHVwZGF0aW5nID0gbmV3IF91dGlsLkxpbmtlZExpc3QoKTsKICAgICAgdmFyIHN0YXRlID0gdGhpcy5jYXB0dXJlKDApOwogICAgICB2YXIgdHJhY2tlciA9IHRoaXMuZWxlbWVudHMoKS5wdXNoQmxvY2tMaXN0KHVwZGF0aW5nKTsKICAgICAgdmFyIGFydGlmYWN0cyA9IHRoaXMuc3RhY2sucGVlaygpLmFydGlmYWN0czsKICAgICAgdmFyIGFkZHIgPSB0aGlzLnBjICsgcmVsYXRpdmVTdGFydCAtIHRoaXMuY3VycmVudE9wU2l6ZTsKICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5oZWFwLmdldGhhbmRsZShhZGRyKTsKICAgICAgdmFyIG9wY29kZSA9IG5ldyBMaXN0QmxvY2tPcGNvZGUoc3RhcnQsIHN0YXRlLCB0aGlzLnJ1bnRpbWUsIHRyYWNrZXIsIHVwZGF0aW5nLCBhcnRpZmFjdHMpOwogICAgICB0aGlzLmxpc3RCbG9ja1N0YWNrLnB1c2gob3Bjb2RlKTsKICAgICAgdGhpcy5kaWRFbnRlcihvcGNvZGUpOwogICAgfTsKCiAgICBfcHJvdG82NC5kaWRFbnRlciA9IGZ1bmN0aW9uIGRpZEVudGVyKG9wY29kZSkgewogICAgICB0aGlzLnVwZGF0ZVdpdGgob3Bjb2RlKTsKICAgICAgdGhpcy51cGRhdGluZ09wY29kZVN0YWNrLnB1c2gob3Bjb2RlLmNoaWxkcmVuKTsKICAgIH07CgogICAgX3Byb3RvNjQuZXhpdCA9IGZ1bmN0aW9uIGV4aXQoKSB7CiAgICAgIHRoaXMuZWxlbWVudHMoKS5wb3BCbG9jaygpOwogICAgICB0aGlzLnVwZGF0aW5nT3Bjb2RlU3RhY2sucG9wKCk7CiAgICAgIHZhciBwYXJlbnQgPSB0aGlzLnVwZGF0aW5nKCkudGFpbCgpOwogICAgICBwYXJlbnQuZGlkSW5pdGlhbGl6ZUNoaWxkcmVuKCk7CiAgICB9OwoKICAgIF9wcm90bzY0LmV4aXRMaXN0ID0gZnVuY3Rpb24gZXhpdExpc3QoKSB7CiAgICAgIHRoaXMuZXhpdCgpOwogICAgICB0aGlzLmxpc3RCbG9ja1N0YWNrLnBvcCgpOwogICAgfTsKCiAgICBfcHJvdG82NC51cGRhdGVXaXRoID0gZnVuY3Rpb24gdXBkYXRlV2l0aChvcGNvZGUpIHsKICAgICAgdGhpcy51cGRhdGluZygpLmFwcGVuZChvcGNvZGUpOwogICAgfTsKCiAgICBfcHJvdG82NC5saXN0QmxvY2sgPSBmdW5jdGlvbiBsaXN0QmxvY2soKSB7CiAgICAgIHJldHVybiB0aGlzLmxpc3RCbG9ja1N0YWNrLmN1cnJlbnQ7CiAgICB9OwoKICAgIF9wcm90bzY0LnVwZGF0aW5nID0gZnVuY3Rpb24gdXBkYXRpbmcoKSB7CiAgICAgIHJldHVybiB0aGlzLnVwZGF0aW5nT3Bjb2RlU3RhY2suY3VycmVudDsKICAgIH07CgogICAgX3Byb3RvNjQuZWxlbWVudHMgPSBmdW5jdGlvbiBlbGVtZW50cygpIHsKICAgICAgcmV0dXJuIHRoaXMuZWxlbWVudFN0YWNrOwogICAgfTsKCiAgICBfcHJvdG82NC5zY29wZSA9IGZ1bmN0aW9uIHNjb3BlKCkgewogICAgICByZXR1cm4gdGhpcy5zY29wZVN0YWNrLmN1cnJlbnQ7CiAgICB9OwoKICAgIF9wcm90bzY0LmR5bmFtaWNTY29wZSA9IGZ1bmN0aW9uIGR5bmFtaWNTY29wZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuZHluYW1pY1Njb3BlU3RhY2suY3VycmVudDsKICAgIH07CgogICAgX3Byb3RvNjQucHVzaENoaWxkU2NvcGUgPSBmdW5jdGlvbiBwdXNoQ2hpbGRTY29wZSgpIHsKICAgICAgdGhpcy5zY29wZVN0YWNrLnB1c2godGhpcy5zY29wZSgpLmNoaWxkKCkpOwogICAgfTsKCiAgICBfcHJvdG82NC5wdXNoRHluYW1pY1Njb3BlID0gZnVuY3Rpb24gcHVzaER5bmFtaWNTY29wZSgpIHsKICAgICAgdmFyIGNoaWxkID0gdGhpcy5keW5hbWljU2NvcGUoKS5jaGlsZCgpOwogICAgICB0aGlzLmR5bmFtaWNTY29wZVN0YWNrLnB1c2goY2hpbGQpOwogICAgICByZXR1cm4gY2hpbGQ7CiAgICB9OwoKICAgIF9wcm90bzY0LnB1c2hSb290U2NvcGUgPSBmdW5jdGlvbiBwdXNoUm9vdFNjb3BlKHNpemUsIGJpbmRDYWxsZXIpIHsKICAgICAgdmFyIHNjb3BlID0gU2NvcGUuc2l6ZWQoc2l6ZSk7CiAgICAgIGlmIChiaW5kQ2FsbGVyKSBzY29wZS5iaW5kQ2FsbGVyU2NvcGUodGhpcy5zY29wZSgpKTsKICAgICAgdGhpcy5zY29wZVN0YWNrLnB1c2goc2NvcGUpOwogICAgICByZXR1cm4gc2NvcGU7CiAgICB9OwoKICAgIF9wcm90bzY0LnB1c2hTY29wZSA9IGZ1bmN0aW9uIHB1c2hTY29wZShzY29wZSkgewogICAgICB0aGlzLnNjb3BlU3RhY2sucHVzaChzY29wZSk7CiAgICB9OwoKICAgIF9wcm90bzY0LnBvcFNjb3BlID0gZnVuY3Rpb24gcG9wU2NvcGUoKSB7CiAgICAgIHRoaXMuc2NvcGVTdGFjay5wb3AoKTsKICAgIH07CgogICAgX3Byb3RvNjQucG9wRHluYW1pY1Njb3BlID0gZnVuY3Rpb24gcG9wRHluYW1pY1Njb3BlKCkgewogICAgICB0aGlzLmR5bmFtaWNTY29wZVN0YWNrLnBvcCgpOwogICAgfTsKCiAgICBfcHJvdG82NC5uZXdEZXN0cm95YWJsZSA9IGZ1bmN0aW9uIG5ld0Rlc3Ryb3lhYmxlKGQpIHsKICAgICAgdGhpcy5lbGVtZW50cygpLmRpZEFkZERlc3Ryb3lhYmxlKGQpOwogICAgfSAvLy8gU0NPUEUgSEVMUEVSUwogICAgOwoKICAgIF9wcm90bzY0LmdldFNlbGYgPSBmdW5jdGlvbiBnZXRTZWxmKCkgewogICAgICByZXR1cm4gdGhpcy5zY29wZSgpLmdldFNlbGYoKTsKICAgIH07CgogICAgX3Byb3RvNjQucmVmZXJlbmNlRm9yU3ltYm9sID0gZnVuY3Rpb24gcmVmZXJlbmNlRm9yU3ltYm9sKHN5bWJvbCkgewogICAgICByZXR1cm4gdGhpcy5zY29wZSgpLmdldFN5bWJvbChzeW1ib2wpOwogICAgfSAvLy8gRVhFQ1VUSU9OCiAgICA7CgogICAgX3Byb3RvNjQuZXhlY3V0ZSA9IGZ1bmN0aW9uIGV4ZWN1dGUoc3RhcnQsIGluaXRpYWxpemUpIHsKICAgICAgdGhpcy5wYyA9IHRoaXMuaGVhcC5nZXRhZGRyKHN0YXJ0KTsKICAgICAgaWYgKGluaXRpYWxpemUpIGluaXRpYWxpemUodGhpcyk7CiAgICAgIHZhciByZXN1bHQ7CgogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIHJlc3VsdCA9IHRoaXMubmV4dCgpOwogICAgICAgIGlmIChyZXN1bHQuZG9uZSkgYnJlYWs7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQudmFsdWU7CiAgICB9OwoKICAgIF9wcm90bzY0Lm5leHQgPSBmdW5jdGlvbiBuZXh0KCkgewogICAgICB2YXIgZW52ID0gdGhpcy5lbnYsCiAgICAgICAgICBwcm9ncmFtID0gdGhpcy5wcm9ncmFtLAogICAgICAgICAgdXBkYXRpbmdPcGNvZGVTdGFjayA9IHRoaXMudXBkYXRpbmdPcGNvZGVTdGFjaywKICAgICAgICAgIGVsZW1lbnRTdGFjayA9IHRoaXMuZWxlbWVudFN0YWNrOwogICAgICB2YXIgb3Bjb2RlID0gdGhpcy5pbm5lci5uZXh0U3RhdGVtZW50KCk7CiAgICAgIHZhciByZXN1bHQ7CgogICAgICBpZiAob3Bjb2RlICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy5pbm5lci5ldmFsdWF0ZU91dGVyKG9wY29kZSwgdGhpcyk7CiAgICAgICAgcmVzdWx0ID0gewogICAgICAgICAgZG9uZTogZmFsc2UsCiAgICAgICAgICB2YWx1ZTogbnVsbAogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gVW5sb2FkIHRoZSBzdGFjawogICAgICAgIHRoaXMuc3RhY2sucmVzZXQoKTsKICAgICAgICByZXN1bHQgPSB7CiAgICAgICAgICBkb25lOiB0cnVlLAogICAgICAgICAgdmFsdWU6IG5ldyBSZW5kZXJSZXN1bHQoZW52LCBwcm9ncmFtLCB1cGRhdGluZ09wY29kZVN0YWNrLnBvcCgpLCBlbGVtZW50U3RhY2sucG9wQmxvY2soKSkKICAgICAgICB9OwogICAgICB9CgogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKCiAgICBfcHJvdG82NC5iaW5kRHluYW1pY1Njb3BlID0gZnVuY3Rpb24gYmluZER5bmFtaWNTY29wZShuYW1lcykgewogICAgICB2YXIgc2NvcGUgPSB0aGlzLmR5bmFtaWNTY29wZSgpOwoKICAgICAgZm9yICh2YXIgaSA9IG5hbWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgdmFyIG5hbWUgPSB0aGlzLmNvbnN0YW50cy5nZXRTdHJpbmcobmFtZXNbaV0pOwogICAgICAgIHNjb3BlLnNldChuYW1lLCB0aGlzLnN0YWNrLnBvcCgpKTsKICAgICAgfQogICAgfTsKCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKFZNLCBbewogICAgICBrZXk6ICJzdGFjayIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLmlubmVyLnN0YWNrOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldCh2YWx1ZSQkMSkgewogICAgICAgIHRoaXMuaW5uZXIuc3RhY2sgPSB2YWx1ZSQkMTsKICAgICAgfQogICAgICAvKiBSZWdpc3RlcnMgKi8KCiAgICB9LCB7CiAgICAgIGtleTogImN1cnJlbnRPcFNpemUiLAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldCh2YWx1ZSQkMSkgewogICAgICAgIHRoaXMuaW5uZXIuY3VycmVudE9wU2l6ZSA9IHZhbHVlJCQxOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5pbm5lci5jdXJyZW50T3BTaXplOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInBjIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5uZXIucGM7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gc2V0KHZhbHVlJCQxKSB7CiAgICAgICAgdGhpcy5pbm5lci5wYyA9IHZhbHVlJCQxOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJhIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5uZXIucmE7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gc2V0KHZhbHVlJCQxKSB7CiAgICAgICAgdGhpcy5pbm5lci5yYSA9IHZhbHVlJCQxOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImZwIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RhY2suZnA7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gc2V0KGZwKSB7CiAgICAgICAgdGhpcy5zdGFjay5mcCA9IGZwOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNwIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RhY2suc3A7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gc2V0KHNwKSB7CiAgICAgICAgdGhpcy5zdGFjay5zcCA9IHNwOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInByb2dyYW0iLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5ydW50aW1lLnByb2dyYW07CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZW52IiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucnVudGltZS5lbnY7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBWTTsKICB9KCk7CgogIF9leHBvcnRzLkxvd0xldmVsVk0gPSBWTTsKCiAgdmFyIFRlbXBsYXRlSXRlcmF0b3JJbXBsID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gVGVtcGxhdGVJdGVyYXRvckltcGwodm0pIHsKICAgICAgdGhpcy52bSA9IHZtOwogICAgfQoKICAgIHZhciBfcHJvdG82NSA9IFRlbXBsYXRlSXRlcmF0b3JJbXBsLnByb3RvdHlwZTsKCiAgICBfcHJvdG82NS5uZXh0ID0gZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgcmV0dXJuIHRoaXMudm0ubmV4dCgpOwogICAgfTsKCiAgICByZXR1cm4gVGVtcGxhdGVJdGVyYXRvckltcGw7CiAgfSgpOwoKICBmdW5jdGlvbiByZW5kZXJNYWluKHByb2dyYW0sIGVudiwgc2VsZiwgZHluYW1pY1Njb3BlLCBidWlsZGVyLCBoYW5kbGUpIHsKICAgIHZhciB2bSA9IFZNLmluaXRpYWwocHJvZ3JhbSwgZW52LCBzZWxmLCBkeW5hbWljU2NvcGUsIGJ1aWxkZXIsIGhhbmRsZSk7CiAgICByZXR1cm4gbmV3IFRlbXBsYXRlSXRlcmF0b3JJbXBsKHZtKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIFRlbXBsYXRlSXRlcmF0b3IgY29uZmlndXJlZCB0byByZW5kZXIgYSByb290IGNvbXBvbmVudC4KICAgKi8KCgogIGZ1bmN0aW9uIHJlbmRlckNvbXBvbmVudChwcm9ncmFtLCBlbnYsIGJ1aWxkZXIsIG1haW4sIG5hbWUsIGFyZ3MpIHsKICAgIGlmIChhcmdzID09PSB2b2lkIDApIHsKICAgICAgYXJncyA9IHt9OwogICAgfQoKICAgIHZhciB2bSA9IFZNLmVtcHR5KHByb2dyYW0sIGVudiwgYnVpbGRlciwgbWFpbik7CiAgICB2YXIgcmVzb2x2ZXIgPSB2bS5jb25zdGFudHMucmVzb2x2ZXI7CiAgICB2YXIgZGVmaW5pdGlvbiA9IHJlc29sdmVDb21wb25lbnQocmVzb2x2ZXIsIG5hbWUsIG51bGwpOwogICAgdmFyIG1hbmFnZXIgPSBkZWZpbml0aW9uLm1hbmFnZXIsCiAgICAgICAgc3RhdGUgPSBkZWZpbml0aW9uLnN0YXRlOwogICAgdmFyIGNhcGFiaWxpdGllcyA9IGNhcGFiaWxpdHlGbGFnc0Zyb20obWFuYWdlci5nZXRDYXBhYmlsaXRpZXMoc3RhdGUpKTsKICAgIHZhciBpbnZvY2F0aW9uOwoKICAgIGlmIChoYXNTdGF0aWNMYXlvdXRDYXBhYmlsaXR5KGNhcGFiaWxpdGllcywgbWFuYWdlcikpIHsKICAgICAgaW52b2NhdGlvbiA9IG1hbmFnZXIuZ2V0TGF5b3V0KHN0YXRlLCByZXNvbHZlcik7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBpbnZva2UgY29tcG9uZW50cyB3aXRoIGR5bmFtaWMgbGF5b3V0cyBhcyBhIHJvb3QgY29tcG9uZW50LicpOwogICAgfSAvLyBHZXQgYSBsaXN0IG9mIHR1cGxlcyBvZiBhcmd1bWVudCBuYW1lcyBhbmQgcmVmZXJlbmNlcywgbGlrZQogICAgLy8gW1sndGl0bGUnLCByZWZlcmVuY2VdLCBbJ25hbWUnLCByZWZlcmVuY2VdXQoKCiAgICB2YXIgYXJnTGlzdCA9IE9iamVjdC5rZXlzKGFyZ3MpLm1hcChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHJldHVybiBba2V5LCBhcmdzW2tleV1dOwogICAgfSk7CiAgICB2YXIgYmxvY2tOYW1lcyA9IFsnbWFpbicsICdlbHNlJywgJ2F0dHJzJ107IC8vIFByZWZpeCBhcmd1bWVudCBuYW1lcyB3aXRoIGBAYCBzeW1ib2wKCiAgICB2YXIgYXJnTmFtZXMgPSBhcmdMaXN0Lm1hcChmdW5jdGlvbiAoX3JlZjYwKSB7CiAgICAgIHZhciBuYW1lID0gX3JlZjYwWzBdOwogICAgICByZXR1cm4gIkAiICsgbmFtZTsKICAgIH0pOwogICAgdm0ucHVzaEZyYW1lKCk7IC8vIFB1c2ggYmxvY2tzIG9uIHRvIHRoZSBzdGFjaywgdGhyZWUgc3RhY2sgdmFsdWVzIHBlciBibG9jawoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMyAqIGJsb2NrTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgdm0uc3RhY2sucHVzaChudWxsKTsKICAgIH0KCiAgICB2bS5zdGFjay5wdXNoKG51bGwpOyAvLyBGb3IgZWFjaCBhcmd1bWVudCwgcHVzaCBpdHMgYmFja2luZyByZWZlcmVuY2Ugb24gdG8gdGhlIHN0YWNrCgogICAgYXJnTGlzdC5mb3JFYWNoKGZ1bmN0aW9uIChfcmVmNjEpIHsKICAgICAgdmFyIHJlZmVyZW5jZSA9IF9yZWY2MVsxXTsKICAgICAgdm0uc3RhY2sucHVzaChyZWZlcmVuY2UpOwogICAgfSk7IC8vIENvbmZpZ3VyZSBWTSBiYXNlZCBvbiBibG9ja3MgYW5kIGFyZ3MganVzdCBwdXNoZWQgb24gdG8gdGhlIHN0YWNrLgoKICAgIHZtLmFyZ3Muc2V0dXAodm0uc3RhY2ssIGFyZ05hbWVzLCBibG9ja05hbWVzLCAwLCBmYWxzZSk7IC8vIE5lZWRlZCBmb3IgdGhlIE9wLk1haW4gb3Bjb2RlOiBhcmd1bWVudHMsIGNvbXBvbmVudCBpbnZvY2F0aW9uIG9iamVjdCwgYW5kCiAgICAvLyBjb21wb25lbnQgZGVmaW5pdGlvbi4KCiAgICB2bS5zdGFjay5wdXNoKHZtLmFyZ3MpOwogICAgdm0uc3RhY2sucHVzaChpbnZvY2F0aW9uKTsKICAgIHZtLnN0YWNrLnB1c2goZGVmaW5pdGlvbik7CiAgICByZXR1cm4gbmV3IFRlbXBsYXRlSXRlcmF0b3JJbXBsKHZtKTsKICB9CgogIHZhciBEeW5hbWljVmFyUmVmZXJlbmNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRHluYW1pY1ZhclJlZmVyZW5jZShzY29wZSwgbmFtZVJlZikgewogICAgICB0aGlzLnNjb3BlID0gc2NvcGU7CiAgICAgIHRoaXMubmFtZVJlZiA9IG5hbWVSZWY7CiAgICAgIHZhciB2YXJUYWcgPSB0aGlzLnZhclRhZyA9ICgwLCBfcmVmZXJlbmNlMi5jcmVhdGVVcGRhdGFibGVUYWcpKCk7CiAgICAgIHRoaXMudGFnID0gKDAsIF9yZWZlcmVuY2UyLmNvbWJpbmUpKFtuYW1lUmVmLnRhZywgdmFyVGFnXSk7CiAgICB9CgogICAgdmFyIF9wcm90bzY2ID0gRHluYW1pY1ZhclJlZmVyZW5jZS5wcm90b3R5cGU7CgogICAgX3Byb3RvNjYudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0VmFyKCkudmFsdWUoKTsKICAgIH07CgogICAgX3Byb3RvNjYuZ2V0ID0gZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICByZXR1cm4gdGhpcy5nZXRWYXIoKS5nZXQoa2V5KTsKICAgIH07CgogICAgX3Byb3RvNjYuZ2V0VmFyID0gZnVuY3Rpb24gZ2V0VmFyKCkgewogICAgICB2YXIgbmFtZSA9IFN0cmluZyh0aGlzLm5hbWVSZWYudmFsdWUoKSk7CiAgICAgIHZhciByZWYgPSB0aGlzLnNjb3BlLmdldChuYW1lKTsKICAgICAgKDAsIF9yZWZlcmVuY2UyLnVwZGF0ZSkodGhpcy52YXJUYWcsIHJlZi50YWcpOwogICAgICByZXR1cm4gcmVmOwogICAgfTsKCiAgICByZXR1cm4gRHluYW1pY1ZhclJlZmVyZW5jZTsKICB9KCk7CgogIGZ1bmN0aW9uIGdldER5bmFtaWNWYXIodm0sIGFyZ3MpIHsKICAgIHZhciBzY29wZSA9IHZtLmR5bmFtaWNTY29wZSgpOwogICAgdmFyIG5hbWVSZWYgPSBhcmdzLnBvc2l0aW9uYWwuYXQoMCk7CiAgICByZXR1cm4gbmV3IER5bmFtaWNWYXJSZWZlcmVuY2Uoc2NvcGUsIG5hbWVSZWYpOwogIH0KICAvKiogQGludGVybmFsICovCgoKICB2YXIgREVGQVVMVF9DQVBBQklMSVRJRVMgPSB7CiAgICBkeW5hbWljTGF5b3V0OiB0cnVlLAogICAgZHluYW1pY1RhZzogdHJ1ZSwKICAgIHByZXBhcmVBcmdzOiB0cnVlLAogICAgY3JlYXRlQXJnczogdHJ1ZSwKICAgIGF0dHJpYnV0ZUhvb2s6IGZhbHNlLAogICAgZWxlbWVudEhvb2s6IGZhbHNlLAogICAgZHluYW1pY1Njb3BlOiB0cnVlLAogICAgY3JlYXRlQ2FsbGVyOiBmYWxzZSwKICAgIHVwZGF0ZUhvb2s6IHRydWUsCiAgICBjcmVhdGVJbnN0YW5jZTogdHJ1ZQogIH07CiAgX2V4cG9ydHMuREVGQVVMVF9DQVBBQklMSVRJRVMgPSBERUZBVUxUX0NBUEFCSUxJVElFUzsKICB2YXIgTUlOSU1BTF9DQVBBQklMSVRJRVMgPSB7CiAgICBkeW5hbWljTGF5b3V0OiBmYWxzZSwKICAgIGR5bmFtaWNUYWc6IGZhbHNlLAogICAgcHJlcGFyZUFyZ3M6IGZhbHNlLAogICAgY3JlYXRlQXJnczogZmFsc2UsCiAgICBhdHRyaWJ1dGVIb29rOiBmYWxzZSwKICAgIGVsZW1lbnRIb29rOiBmYWxzZSwKICAgIGR5bmFtaWNTY29wZTogZmFsc2UsCiAgICBjcmVhdGVDYWxsZXI6IGZhbHNlLAogICAgdXBkYXRlSG9vazogZmFsc2UsCiAgICBjcmVhdGVJbnN0YW5jZTogZmFsc2UKICB9OwogIF9leHBvcnRzLk1JTklNQUxfQ0FQQUJJTElUSUVTID0gTUlOSU1BTF9DQVBBQklMSVRJRVM7CiAgdmFyIFNFUklBTElaQVRJT05fRklSU1RfTk9ERV9TVFJJTkcgPSAnJStiOjAlJzsKICBfZXhwb3J0cy5TRVJJQUxJWkFUSU9OX0ZJUlNUX05PREVfU1RSSU5HID0gU0VSSUFMSVpBVElPTl9GSVJTVF9OT0RFX1NUUklORzsKCiAgZnVuY3Rpb24gaXNTZXJpYWxpemF0aW9uRmlyc3ROb2RlKG5vZGUpIHsKICAgIHJldHVybiBub2RlLm5vZGVWYWx1ZSA9PT0gU0VSSUFMSVpBVElPTl9GSVJTVF9OT0RFX1NUUklORzsKICB9CgogIHZhciBSZWh5ZHJhdGluZ0N1cnNvciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfQ3Vyc29yKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoUmVoeWRyYXRpbmdDdXJzb3IsIF9DdXJzb3IpOwoKICAgIGZ1bmN0aW9uIFJlaHlkcmF0aW5nQ3Vyc29yKGVsZW1lbnQsIG5leHRTaWJsaW5nLCBzdGFydGluZ0Jsb2NrRGVwdGgpIHsKICAgICAgdmFyIF90aGlzMjA7CgogICAgICBfdGhpczIwID0gX0N1cnNvci5jYWxsKHRoaXMsIGVsZW1lbnQsIG5leHRTaWJsaW5nKSB8fCB0aGlzOwogICAgICBfdGhpczIwLnN0YXJ0aW5nQmxvY2tEZXB0aCA9IHN0YXJ0aW5nQmxvY2tEZXB0aDsKICAgICAgX3RoaXMyMC5jYW5kaWRhdGUgPSBudWxsOwogICAgICBfdGhpczIwLmluamVjdGVkT21pdHRlZE5vZGUgPSBmYWxzZTsKICAgICAgX3RoaXMyMC5vcGVuQmxvY2tEZXB0aCA9IHN0YXJ0aW5nQmxvY2tEZXB0aCAtIDE7CiAgICAgIHJldHVybiBfdGhpczIwOwogICAgfQoKICAgIHJldHVybiBSZWh5ZHJhdGluZ0N1cnNvcjsKICB9KEN1cnNvcik7CgogIHZhciBSZWh5ZHJhdGVCdWlsZGVyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9OZXdFbGVtZW50QnVpbGRlcikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKFJlaHlkcmF0ZUJ1aWxkZXIsIF9OZXdFbGVtZW50QnVpbGRlcik7CgogICAgLy8gcHJpdmF0ZSBjYW5kaWRhdGU6IE9wdGlvbjxTaW1wbGUuTm9kZT4gPSBudWxsOwogICAgZnVuY3Rpb24gUmVoeWRyYXRlQnVpbGRlcihlbnYsIHBhcmVudE5vZGUsIG5leHRTaWJsaW5nKSB7CiAgICAgIHZhciBfdGhpczIxOwoKICAgICAgX3RoaXMyMSA9IF9OZXdFbGVtZW50QnVpbGRlci5jYWxsKHRoaXMsIGVudiwgcGFyZW50Tm9kZSwgbmV4dFNpYmxpbmcpIHx8IHRoaXM7CiAgICAgIF90aGlzMjEudW5tYXRjaGVkQXR0cmlidXRlcyA9IG51bGw7CiAgICAgIF90aGlzMjEuYmxvY2tEZXB0aCA9IDA7CiAgICAgIGlmIChuZXh0U2libGluZykgdGhyb3cgbmV3IEVycm9yKCdSZWh5ZHJhdGlvbiB3aXRoIG5leHRTaWJsaW5nIG5vdCBzdXBwb3J0ZWQnKTsKICAgICAgdmFyIG5vZGUgPSBfdGhpczIxLmN1cnJlbnRDdXJzb3IuZWxlbWVudC5maXJzdENoaWxkOwoKICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICBpZiAoaXNDb21tZW50KG5vZGUpICYmIGlzU2VyaWFsaXphdGlvbkZpcnN0Tm9kZShub2RlKSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgfQoKICAgICAgX3RoaXMyMS5jYW5kaWRhdGUgPSBub2RlOwogICAgICByZXR1cm4gX3RoaXMyMTsKICAgIH0KCiAgICB2YXIgX3Byb3RvNjcgPSBSZWh5ZHJhdGVCdWlsZGVyLnByb3RvdHlwZTsKCiAgICBfcHJvdG82Ny5wdXNoRWxlbWVudCA9IGZ1bmN0aW9uIHB1c2hFbGVtZW50KGVsZW1lbnQsIG5leHRTaWJsaW5nKSB7CiAgICAgIHZhciBfdGhpcyRibG9ja0RlcHRoID0gdGhpcy5ibG9ja0RlcHRoLAogICAgICAgICAgYmxvY2tEZXB0aCA9IF90aGlzJGJsb2NrRGVwdGggPT09IHZvaWQgMCA/IDAgOiBfdGhpcyRibG9ja0RlcHRoOwogICAgICB2YXIgY3Vyc29yID0gbmV3IFJlaHlkcmF0aW5nQ3Vyc29yKGVsZW1lbnQsIG5leHRTaWJsaW5nLCBibG9ja0RlcHRoKTsKICAgICAgdmFyIGN1cnJlbnRDdXJzb3IgPSB0aGlzLmN1cnJlbnRDdXJzb3I7CgogICAgICBpZiAoY3VycmVudEN1cnNvcikgewogICAgICAgIGlmIChjdXJyZW50Q3Vyc29yLmNhbmRpZGF0ZSkgewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiA8ZGl2PiAgIDwtLS0tLS0tLS0tLS0tLS0gIGN1cnJlbnRDdXJzb3IuZWxlbWVudAogICAgICAgICAgICogICA8IS0tJStiOjElLS0+CiAgICAgICAgICAgKiAgIDxkaXY+IDwtLS0tLS0tLS0tLS0tLS0gIGN1cnJlbnRDdXJzb3IuY2FuZGlkYXRlIC0+IGN1cnNvci5lbGVtZW50CiAgICAgICAgICAgKiAgICAgPCEtLSUrYjoyJS0tPiA8LSAgY3VycmVudEN1cnNvci5jYW5kaWRhdGUuZmlyc3RDaGlsZCAtPiBjdXJzb3IuY2FuZGlkYXRlCiAgICAgICAgICAgKiAgICAgRm9vCiAgICAgICAgICAgKiAgICAgPCEtLSUtYjoyJS0tPgogICAgICAgICAgICogICA8L2Rpdj4KICAgICAgICAgICAqICAgPCEtLSUtYjoxJS0tPiAgPC0tICBiZWNvbWVzIGN1cnJlbnRDdXJzb3IuY2FuZGlkYXRlCiAgICAgICAgICAgKi8KICAgICAgICAgIC8vIHdoZXJlIHRvIHJlaHlkcmF0ZSBmcm9tIGlmIHdlIGFyZSBpbiByZWh5ZHJhdGlvbiBtb2RlCiAgICAgICAgICBjdXJzb3IuY2FuZGlkYXRlID0gZWxlbWVudC5maXJzdENoaWxkOyAvLyB3aGVyZSB0byBjb250aW51ZSB3aGVuIHdlIHBvcAoKICAgICAgICAgIGN1cnJlbnRDdXJzb3IuY2FuZGlkYXRlID0gZWxlbWVudC5uZXh0U2libGluZzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuY3Vyc29yU3RhY2sucHVzaChjdXJzb3IpOwogICAgfTsKCiAgICBfcHJvdG82Ny5jbGVhck1pc21hdGNoID0gZnVuY3Rpb24gY2xlYXJNaXNtYXRjaChjYW5kaWRhdGUpIHsKICAgICAgdmFyIGN1cnJlbnQgPSBjYW5kaWRhdGU7CiAgICAgIHZhciBjdXJyZW50Q3Vyc29yID0gdGhpcy5jdXJyZW50Q3Vyc29yOwoKICAgICAgaWYgKGN1cnJlbnRDdXJzb3IgIT09IG51bGwpIHsKICAgICAgICB2YXIgb3BlbkJsb2NrRGVwdGggPSBjdXJyZW50Q3Vyc29yLm9wZW5CbG9ja0RlcHRoOwoKICAgICAgICBpZiAob3BlbkJsb2NrRGVwdGggPj0gY3VycmVudEN1cnNvci5zdGFydGluZ0Jsb2NrRGVwdGgpIHsKICAgICAgICAgIHdoaWxlIChjdXJyZW50ICYmICEoaXNDb21tZW50KGN1cnJlbnQpICYmIGdldENsb3NlQmxvY2tEZXB0aChjdXJyZW50KSA9PT0gb3BlbkJsb2NrRGVwdGgpKSB7CiAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLnJlbW92ZShjdXJyZW50KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgd2hpbGUgKGN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgY3VycmVudCA9IHRoaXMucmVtb3ZlKGN1cnJlbnQpOwogICAgICAgICAgfQogICAgICAgIH0gLy8gY3VycmVudCBjdXJzb3IgcGFyZW50Tm9kZSBzaG91bGQgYmUgb3BlbkNhbmRpZGF0ZSBpZiBlbGVtZW50CiAgICAgICAgLy8gb3Igb3BlbkNhbmRpZGF0ZS5wYXJlbnROb2RlIGlmIGNvbW1lbnQKCgogICAgICAgIGN1cnJlbnRDdXJzb3IubmV4dFNpYmxpbmcgPSBjdXJyZW50OyAvLyBkaXNhYmxlIHJlaHlkcmF0aW9uIHVudGlsIHdlIHBvcEVsZW1lbnQgb3IgY2xvc2VCbG9jayBmb3Igb3BlbkJsb2NrRGVwdGgKCiAgICAgICAgY3VycmVudEN1cnNvci5jYW5kaWRhdGUgPSBudWxsOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzY3Ll9fb3BlbkJsb2NrID0gZnVuY3Rpb24gX19vcGVuQmxvY2soKSB7CiAgICAgIHZhciBjdXJyZW50Q3Vyc29yID0gdGhpcy5jdXJyZW50Q3Vyc29yOwogICAgICBpZiAoY3VycmVudEN1cnNvciA9PT0gbnVsbCkgcmV0dXJuOwogICAgICB2YXIgYmxvY2tEZXB0aCA9IHRoaXMuYmxvY2tEZXB0aDsKICAgICAgdGhpcy5ibG9ja0RlcHRoKys7CiAgICAgIHZhciBjYW5kaWRhdGUgPSBjdXJyZW50Q3Vyc29yLmNhbmRpZGF0ZTsKICAgICAgaWYgKGNhbmRpZGF0ZSA9PT0gbnVsbCkgcmV0dXJuOwogICAgICB2YXIgdGFnTmFtZSA9IGN1cnJlbnRDdXJzb3IuZWxlbWVudC50YWdOYW1lOwoKICAgICAgaWYgKGlzQ29tbWVudChjYW5kaWRhdGUpICYmIGdldE9wZW5CbG9ja0RlcHRoKGNhbmRpZGF0ZSkgPT09IGJsb2NrRGVwdGgpIHsKICAgICAgICBjdXJyZW50Q3Vyc29yLmNhbmRpZGF0ZSA9IHRoaXMucmVtb3ZlKGNhbmRpZGF0ZSk7CiAgICAgICAgY3VycmVudEN1cnNvci5vcGVuQmxvY2tEZXB0aCA9IGJsb2NrRGVwdGg7CiAgICAgIH0gZWxzZSBpZiAodGFnTmFtZSAhPT0gJ1RJVExFJyAmJiB0YWdOYW1lICE9PSAnU0NSSVBUJyAmJiB0YWdOYW1lICE9PSAnU1RZTEUnKSB7CiAgICAgICAgdGhpcy5jbGVhck1pc21hdGNoKGNhbmRpZGF0ZSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNjcuX19jbG9zZUJsb2NrID0gZnVuY3Rpb24gX19jbG9zZUJsb2NrKCkgewogICAgICB2YXIgY3VycmVudEN1cnNvciA9IHRoaXMuY3VycmVudEN1cnNvcjsKICAgICAgaWYgKGN1cnJlbnRDdXJzb3IgPT09IG51bGwpIHJldHVybjsgLy8gb3BlbkJsb2NrIGlzIHRoZSBsYXN0IHJlaHlkcmF0ZWQgb3BlbiBibG9jawoKICAgICAgdmFyIG9wZW5CbG9ja0RlcHRoID0gY3VycmVudEN1cnNvci5vcGVuQmxvY2tEZXB0aDsgLy8gdGhpcyBjdXJyZW50bHkgaXMgdGhlIGV4cGVjdGVkIG5leHQgb3BlbiBibG9jayBkZXB0aAoKICAgICAgdGhpcy5ibG9ja0RlcHRoLS07CiAgICAgIHZhciBjYW5kaWRhdGUgPSBjdXJyZW50Q3Vyc29yLmNhbmRpZGF0ZTsgLy8gcmVoeWRyYXRpbmcKCiAgICAgIGlmIChjYW5kaWRhdGUgIT09IG51bGwpIHsKICAgICAgICBpZiAoaXNDb21tZW50KGNhbmRpZGF0ZSkgJiYgZ2V0Q2xvc2VCbG9ja0RlcHRoKGNhbmRpZGF0ZSkgPT09IG9wZW5CbG9ja0RlcHRoKSB7CiAgICAgICAgICBjdXJyZW50Q3Vyc29yLmNhbmRpZGF0ZSA9IHRoaXMucmVtb3ZlKGNhbmRpZGF0ZSk7CiAgICAgICAgICBjdXJyZW50Q3Vyc29yLm9wZW5CbG9ja0RlcHRoLS07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuY2xlYXJNaXNtYXRjaChjYW5kaWRhdGUpOwogICAgICAgIH0gLy8gaWYgdGhlIG9wZW5CbG9ja0RlcHRoIG1hdGNoZXMgdGhlIGJsb2NrRGVwdGggd2UganVzdCBjbG9zZWQgdG8KICAgICAgICAvLyB0aGVuIHJlc3RvcmUgcmVoeWRyYXRpb24KCiAgICAgIH0KCiAgICAgIGlmIChjdXJyZW50Q3Vyc29yLm9wZW5CbG9ja0RlcHRoID09PSB0aGlzLmJsb2NrRGVwdGgpIHsKICAgICAgICBjdXJyZW50Q3Vyc29yLmNhbmRpZGF0ZSA9IHRoaXMucmVtb3ZlKGN1cnJlbnRDdXJzb3IubmV4dFNpYmxpbmcpOwogICAgICAgIGN1cnJlbnRDdXJzb3Iub3BlbkJsb2NrRGVwdGgtLTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG82Ny5fX2FwcGVuZE5vZGUgPSBmdW5jdGlvbiBfX2FwcGVuZE5vZGUobm9kZSkgewogICAgICB2YXIgY2FuZGlkYXRlID0gdGhpcy5jYW5kaWRhdGU7IC8vIFRoaXMgY29kZSBwYXRoIGlzIG9ubHkgdXNlZCB3aGVuIGluc2VydGluZyBwcmVjaXNlbHkgb25lIG5vZGUuIEl0IG5lZWRzIG1vcmUKICAgICAgLy8gY29tcGFyaXNvbiBsb2dpYywgYnV0IHdlIGNhbiBwcm9iYWJseSBsZWFuIG9uIHRoZSBjYXNlcyB3aGVyZSB0aGlzIGNvZGUgcGF0aAogICAgICAvLyBpcyBhY3R1YWxseSB1c2VkLgoKICAgICAgaWYgKGNhbmRpZGF0ZSkgewogICAgICAgIHJldHVybiBjYW5kaWRhdGU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19hcHBlbmROb2RlLmNhbGwodGhpcywgbm9kZSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNjcuX19hcHBlbmRIVE1MID0gZnVuY3Rpb24gX19hcHBlbmRIVE1MKGh0bWwpIHsKICAgICAgdmFyIGNhbmRpZGF0ZUJvdW5kcyA9IHRoaXMubWFya2VyQm91bmRzKCk7CgogICAgICBpZiAoY2FuZGlkYXRlQm91bmRzKSB7CiAgICAgICAgdmFyIGZpcnN0ID0gY2FuZGlkYXRlQm91bmRzLmZpcnN0Tm9kZSgpOwogICAgICAgIHZhciBsYXN0ID0gY2FuZGlkYXRlQm91bmRzLmxhc3ROb2RlKCk7CiAgICAgICAgdmFyIG5ld0JvdW5kcyA9IG5ldyBDb25jcmV0ZUJvdW5kcyh0aGlzLmVsZW1lbnQsIGZpcnN0Lm5leHRTaWJsaW5nLCBsYXN0LnByZXZpb3VzU2libGluZyk7CiAgICAgICAgdmFyIHBvc3NpYmxlRW1wdHlNYXJrZXIgPSB0aGlzLnJlbW92ZShmaXJzdCk7CiAgICAgICAgdGhpcy5yZW1vdmUobGFzdCk7CgogICAgICAgIGlmIChwb3NzaWJsZUVtcHR5TWFya2VyICE9PSBudWxsICYmIGlzRW1wdHkkMShwb3NzaWJsZUVtcHR5TWFya2VyKSkgewogICAgICAgICAgdGhpcy5jYW5kaWRhdGUgPSB0aGlzLnJlbW92ZShwb3NzaWJsZUVtcHR5TWFya2VyKTsKCiAgICAgICAgICBpZiAodGhpcy5jYW5kaWRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgdGhpcy5jbGVhck1pc21hdGNoKHRoaXMuY2FuZGlkYXRlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBuZXdCb3VuZHM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19hcHBlbmRIVE1MLmNhbGwodGhpcywgaHRtbCk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNjcucmVtb3ZlID0gZnVuY3Rpb24gcmVtb3ZlKG5vZGUpIHsKICAgICAgdmFyIGVsZW1lbnQgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgIHZhciBuZXh0ID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgZWxlbWVudC5yZW1vdmVDaGlsZChub2RlKTsKICAgICAgcmV0dXJuIG5leHQ7CiAgICB9OwoKICAgIF9wcm90bzY3Lm1hcmtlckJvdW5kcyA9IGZ1bmN0aW9uIG1hcmtlckJvdW5kcygpIHsKICAgICAgdmFyIF9jYW5kaWRhdGUgPSB0aGlzLmNhbmRpZGF0ZTsKCiAgICAgIGlmIChfY2FuZGlkYXRlICYmIGlzTWFya2VyKF9jYW5kaWRhdGUpKSB7CiAgICAgICAgdmFyIGZpcnN0ID0gX2NhbmRpZGF0ZTsKICAgICAgICB2YXIgbGFzdCA9IGZpcnN0Lm5leHRTaWJsaW5nOwoKICAgICAgICB3aGlsZSAobGFzdCAmJiAhaXNNYXJrZXIobGFzdCkpIHsKICAgICAgICAgIGxhc3QgPSBsYXN0Lm5leHRTaWJsaW5nOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG5ldyBDb25jcmV0ZUJvdW5kcyh0aGlzLmVsZW1lbnQsIGZpcnN0LCBsYXN0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG82Ny5fX2FwcGVuZFRleHQgPSBmdW5jdGlvbiBfX2FwcGVuZFRleHQoc3RyaW5nKSB7CiAgICAgIHZhciBjYW5kaWRhdGUgPSB0aGlzLmNhbmRpZGF0ZTsKCiAgICAgIGlmIChjYW5kaWRhdGUpIHsKICAgICAgICBpZiAoaXNUZXh0Tm9kZShjYW5kaWRhdGUpKSB7CiAgICAgICAgICBpZiAoY2FuZGlkYXRlLm5vZGVWYWx1ZSAhPT0gc3RyaW5nKSB7CiAgICAgICAgICAgIGNhbmRpZGF0ZS5ub2RlVmFsdWUgPSBzdHJpbmc7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5jYW5kaWRhdGUgPSBjYW5kaWRhdGUubmV4dFNpYmxpbmc7CiAgICAgICAgICByZXR1cm4gY2FuZGlkYXRlOwogICAgICAgIH0gZWxzZSBpZiAoY2FuZGlkYXRlICYmIChpc1NlcGFyYXRvcihjYW5kaWRhdGUpIHx8IGlzRW1wdHkkMShjYW5kaWRhdGUpKSkgewogICAgICAgICAgdGhpcy5jYW5kaWRhdGUgPSBjYW5kaWRhdGUubmV4dFNpYmxpbmc7CiAgICAgICAgICB0aGlzLnJlbW92ZShjYW5kaWRhdGUpOwogICAgICAgICAgcmV0dXJuIHRoaXMuX19hcHBlbmRUZXh0KHN0cmluZyk7CiAgICAgICAgfSBlbHNlIGlmIChpc0VtcHR5JDEoY2FuZGlkYXRlKSkgewogICAgICAgICAgdmFyIG5leHQgPSB0aGlzLnJlbW92ZShjYW5kaWRhdGUpOwogICAgICAgICAgdGhpcy5jYW5kaWRhdGUgPSBuZXh0OwogICAgICAgICAgdmFyIHRleHQgPSB0aGlzLmRvbS5jcmVhdGVUZXh0Tm9kZShzdHJpbmcpOwogICAgICAgICAgdGhpcy5kb20uaW5zZXJ0QmVmb3JlKHRoaXMuZWxlbWVudCwgdGV4dCwgbmV4dCk7CiAgICAgICAgICByZXR1cm4gdGV4dDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5jbGVhck1pc21hdGNoKGNhbmRpZGF0ZSk7CiAgICAgICAgICByZXR1cm4gX05ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5fX2FwcGVuZFRleHQuY2FsbCh0aGlzLCBzdHJpbmcpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gX05ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5fX2FwcGVuZFRleHQuY2FsbCh0aGlzLCBzdHJpbmcpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzY3Ll9fYXBwZW5kQ29tbWVudCA9IGZ1bmN0aW9uIF9fYXBwZW5kQ29tbWVudChzdHJpbmcpIHsKICAgICAgdmFyIF9jYW5kaWRhdGUgPSB0aGlzLmNhbmRpZGF0ZTsKCiAgICAgIGlmIChfY2FuZGlkYXRlICYmIGlzQ29tbWVudChfY2FuZGlkYXRlKSkgewogICAgICAgIGlmIChfY2FuZGlkYXRlLm5vZGVWYWx1ZSAhPT0gc3RyaW5nKSB7CiAgICAgICAgICBfY2FuZGlkYXRlLm5vZGVWYWx1ZSA9IHN0cmluZzsKICAgICAgICB9CgogICAgICAgIHRoaXMuY2FuZGlkYXRlID0gX2NhbmRpZGF0ZS5uZXh0U2libGluZzsKICAgICAgICByZXR1cm4gX2NhbmRpZGF0ZTsKICAgICAgfSBlbHNlIGlmIChfY2FuZGlkYXRlKSB7CiAgICAgICAgdGhpcy5jbGVhck1pc21hdGNoKF9jYW5kaWRhdGUpOwogICAgICB9CgogICAgICByZXR1cm4gX05ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5fX2FwcGVuZENvbW1lbnQuY2FsbCh0aGlzLCBzdHJpbmcpOwogICAgfTsKCiAgICBfcHJvdG82Ny5fX29wZW5FbGVtZW50ID0gZnVuY3Rpb24gX19vcGVuRWxlbWVudCh0YWcpIHsKICAgICAgdmFyIF9jYW5kaWRhdGUgPSB0aGlzLmNhbmRpZGF0ZTsKCiAgICAgIGlmIChfY2FuZGlkYXRlICYmIGlzRWxlbWVudChfY2FuZGlkYXRlKSAmJiBpc1NhbWVOb2RlVHlwZShfY2FuZGlkYXRlLCB0YWcpKSB7CiAgICAgICAgdGhpcy51bm1hdGNoZWRBdHRyaWJ1dGVzID0gW10uc2xpY2UuY2FsbChfY2FuZGlkYXRlLmF0dHJpYnV0ZXMpOwogICAgICAgIHJldHVybiBfY2FuZGlkYXRlOwogICAgICB9IGVsc2UgaWYgKF9jYW5kaWRhdGUpIHsKICAgICAgICBpZiAoaXNFbGVtZW50KF9jYW5kaWRhdGUpICYmIF9jYW5kaWRhdGUudGFnTmFtZSA9PT0gJ1RCT0RZJykgewogICAgICAgICAgdGhpcy5wdXNoRWxlbWVudChfY2FuZGlkYXRlLCBudWxsKTsKICAgICAgICAgIHRoaXMuY3VycmVudEN1cnNvci5pbmplY3RlZE9taXR0ZWROb2RlID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiB0aGlzLl9fb3BlbkVsZW1lbnQodGFnKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY2xlYXJNaXNtYXRjaChfY2FuZGlkYXRlKTsKICAgICAgfQoKICAgICAgcmV0dXJuIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19vcGVuRWxlbWVudC5jYWxsKHRoaXMsIHRhZyk7CiAgICB9OwoKICAgIF9wcm90bzY3Ll9fc2V0QXR0cmlidXRlID0gZnVuY3Rpb24gX19zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUkJDEsIG5hbWVzcGFjZSkgewogICAgICB2YXIgdW5tYXRjaGVkID0gdGhpcy51bm1hdGNoZWRBdHRyaWJ1dGVzOwoKICAgICAgaWYgKHVubWF0Y2hlZCkgewogICAgICAgIHZhciBhdHRyID0gZmluZEJ5TmFtZSh1bm1hdGNoZWQsIG5hbWUpOwoKICAgICAgICBpZiAoYXR0cikgewogICAgICAgICAgaWYgKGF0dHIudmFsdWUgIT09IHZhbHVlJCQxKSB7CiAgICAgICAgICAgIGF0dHIudmFsdWUgPSB2YWx1ZSQkMTsKICAgICAgICAgIH0KCiAgICAgICAgICB1bm1hdGNoZWQuc3BsaWNlKHVubWF0Y2hlZC5pbmRleE9mKGF0dHIpLCAxKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBfTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLl9fc2V0QXR0cmlidXRlLmNhbGwodGhpcywgbmFtZSwgdmFsdWUkJDEsIG5hbWVzcGFjZSk7CiAgICB9OwoKICAgIF9wcm90bzY3Ll9fc2V0UHJvcGVydHkgPSBmdW5jdGlvbiBfX3NldFByb3BlcnR5KG5hbWUsIHZhbHVlJCQxKSB7CiAgICAgIHZhciB1bm1hdGNoZWQgPSB0aGlzLnVubWF0Y2hlZEF0dHJpYnV0ZXM7CgogICAgICBpZiAodW5tYXRjaGVkKSB7CiAgICAgICAgdmFyIGF0dHIgPSBmaW5kQnlOYW1lKHVubWF0Y2hlZCwgbmFtZSk7CgogICAgICAgIGlmIChhdHRyKSB7CiAgICAgICAgICBpZiAoYXR0ci52YWx1ZSAhPT0gdmFsdWUkJDEpIHsKICAgICAgICAgICAgYXR0ci52YWx1ZSA9IHZhbHVlJCQxOwogICAgICAgICAgfQoKICAgICAgICAgIHVubWF0Y2hlZC5zcGxpY2UodW5tYXRjaGVkLmluZGV4T2YoYXR0ciksIDEpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19zZXRQcm9wZXJ0eS5jYWxsKHRoaXMsIG5hbWUsIHZhbHVlJCQxKTsKICAgIH07CgogICAgX3Byb3RvNjcuX19mbHVzaEVsZW1lbnQgPSBmdW5jdGlvbiBfX2ZsdXNoRWxlbWVudChwYXJlbnQsIGNvbnN0cnVjdGluZykgewogICAgICB2YXIgdW5tYXRjaGVkID0gdGhpcy51bm1hdGNoZWRBdHRyaWJ1dGVzOwoKICAgICAgaWYgKHVubWF0Y2hlZCkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdW5tYXRjaGVkLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB0aGlzLmNvbnN0cnVjdGluZy5yZW1vdmVBdHRyaWJ1dGUodW5tYXRjaGVkW2ldLm5hbWUpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy51bm1hdGNoZWRBdHRyaWJ1dGVzID0gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICBfTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLl9fZmx1c2hFbGVtZW50LmNhbGwodGhpcywgcGFyZW50LCBjb25zdHJ1Y3RpbmcpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzY3LndpbGxDbG9zZUVsZW1lbnQgPSBmdW5jdGlvbiB3aWxsQ2xvc2VFbGVtZW50KCkgewogICAgICB2YXIgY2FuZGlkYXRlID0gdGhpcy5jYW5kaWRhdGUsCiAgICAgICAgICBjdXJyZW50Q3Vyc29yID0gdGhpcy5jdXJyZW50Q3Vyc29yOwoKICAgICAgaWYgKGNhbmRpZGF0ZSAhPT0gbnVsbCkgewogICAgICAgIHRoaXMuY2xlYXJNaXNtYXRjaChjYW5kaWRhdGUpOwogICAgICB9CgogICAgICBpZiAoY3VycmVudEN1cnNvciAmJiBjdXJyZW50Q3Vyc29yLmluamVjdGVkT21pdHRlZE5vZGUpIHsKICAgICAgICB0aGlzLnBvcEVsZW1lbnQoKTsKICAgICAgfQoKICAgICAgX05ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS53aWxsQ2xvc2VFbGVtZW50LmNhbGwodGhpcyk7CiAgICB9OwoKICAgIF9wcm90bzY3LmdldE1hcmtlciA9IGZ1bmN0aW9uIGdldE1hcmtlcihlbGVtZW50LCBndWlkKSB7CiAgICAgIHZhciBtYXJrZXIgPSBlbGVtZW50LnF1ZXJ5U2VsZWN0b3IoInNjcmlwdFtnbG1yPVwiIiArIGd1aWQgKyAiXCJdIik7CgogICAgICBpZiAobWFya2VyKSB7CiAgICAgICAgcmV0dXJuIG1hcmtlcjsKICAgICAgfQoKICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZmluZCBzZXJpYWxpemVkIGN1cnNvciBmb3IgYGluLWVsZW1lbnRgJyk7CiAgICB9OwoKICAgIF9wcm90bzY3Ll9fcHVzaFJlbW90ZUVsZW1lbnQgPSBmdW5jdGlvbiBfX3B1c2hSZW1vdGVFbGVtZW50KGVsZW1lbnQsIGN1cnNvcklkLCBuZXh0U2libGluZykgewogICAgICBpZiAobmV4dFNpYmxpbmcgPT09IHZvaWQgMCkgewogICAgICAgIG5leHRTaWJsaW5nID0gbnVsbDsKICAgICAgfQoKICAgICAgdmFyIG1hcmtlciA9IHRoaXMuZ2V0TWFya2VyKGVsZW1lbnQsIGN1cnNvcklkKTsKCiAgICAgIGlmIChtYXJrZXIucGFyZW50Tm9kZSA9PT0gZWxlbWVudCkgewogICAgICAgIHZhciBjdXJyZW50Q3Vyc29yID0gdGhpcy5jdXJyZW50Q3Vyc29yOwogICAgICAgIHZhciBjYW5kaWRhdGUgPSBjdXJyZW50Q3Vyc29yLmNhbmRpZGF0ZTsKICAgICAgICB0aGlzLnB1c2hFbGVtZW50KGVsZW1lbnQsIG5leHRTaWJsaW5nKTsKICAgICAgICBjdXJyZW50Q3Vyc29yLmNhbmRpZGF0ZSA9IGNhbmRpZGF0ZTsKICAgICAgICB0aGlzLmNhbmRpZGF0ZSA9IHRoaXMucmVtb3ZlKG1hcmtlcik7CiAgICAgICAgdmFyIHRyYWNrZXIgPSBuZXcgUmVtb3RlQmxvY2tUcmFja2VyKGVsZW1lbnQpOwogICAgICAgIHRoaXMucHVzaEJsb2NrVHJhY2tlcih0cmFja2VyLCB0cnVlKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG82Ny5kaWRBcHBlbmRCb3VuZHMgPSBmdW5jdGlvbiBkaWRBcHBlbmRCb3VuZHMoYm91bmRzKSB7CiAgICAgIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuZGlkQXBwZW5kQm91bmRzLmNhbGwodGhpcywgYm91bmRzKTsKCiAgICAgIGlmICh0aGlzLmNhbmRpZGF0ZSkgewogICAgICAgIHZhciBsYXN0ID0gYm91bmRzLmxhc3ROb2RlKCk7CiAgICAgICAgdGhpcy5jYW5kaWRhdGUgPSBsYXN0ICYmIGxhc3QubmV4dFNpYmxpbmc7CiAgICAgIH0KCiAgICAgIHJldHVybiBib3VuZHM7CiAgICB9OwoKICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoUmVoeWRyYXRlQnVpbGRlciwgW3sKICAgICAga2V5OiAiY3VycmVudEN1cnNvciIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLmN1cnNvclN0YWNrLmN1cnJlbnQ7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiY2FuZGlkYXRlIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgaWYgKHRoaXMuY3VycmVudEN1cnNvcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEN1cnNvci5jYW5kaWRhdGU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQobm9kZSkgewogICAgICAgIHRoaXMuY3VycmVudEN1cnNvci5jYW5kaWRhdGUgPSBub2RlOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gUmVoeWRyYXRlQnVpbGRlcjsKICB9KE5ld0VsZW1lbnRCdWlsZGVyKTsKCiAgX2V4cG9ydHMuUmVoeWRyYXRlQnVpbGRlciA9IFJlaHlkcmF0ZUJ1aWxkZXI7CgogIGZ1bmN0aW9uIGlzVGV4dE5vZGUobm9kZSkgewogICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT09IDM7CiAgfQoKICBmdW5jdGlvbiBpc0NvbW1lbnQobm9kZSkgewogICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT09IDg7CiAgfQoKICBmdW5jdGlvbiBnZXRPcGVuQmxvY2tEZXB0aChub2RlKSB7CiAgICB2YXIgYm91bmRzRGVwdGggPSBub2RlLm5vZGVWYWx1ZS5tYXRjaCgvXiVcK2I6KFxkKyklJC8pOwoKICAgIGlmIChib3VuZHNEZXB0aCAmJiBib3VuZHNEZXB0aFsxXSkgewogICAgICByZXR1cm4gTnVtYmVyKGJvdW5kc0RlcHRoWzFdKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2V0Q2xvc2VCbG9ja0RlcHRoKG5vZGUpIHsKICAgIHZhciBib3VuZHNEZXB0aCA9IG5vZGUubm9kZVZhbHVlLm1hdGNoKC9eJVwtYjooXGQrKSUkLyk7CgogICAgaWYgKGJvdW5kc0RlcHRoICYmIGJvdW5kc0RlcHRoWzFdKSB7CiAgICAgIHJldHVybiBOdW1iZXIoYm91bmRzRGVwdGhbMV0pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc0VsZW1lbnQobm9kZSkgewogICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT09IDE7CiAgfQoKICBmdW5jdGlvbiBpc01hcmtlcihub2RlKSB7CiAgICByZXR1cm4gbm9kZS5ub2RlVHlwZSA9PT0gOCAmJiBub2RlLm5vZGVWYWx1ZSA9PT0gJyVnbG1yJSc7CiAgfQoKICBmdW5jdGlvbiBpc1NlcGFyYXRvcihub2RlKSB7CiAgICByZXR1cm4gbm9kZS5ub2RlVHlwZSA9PT0gOCAmJiBub2RlLm5vZGVWYWx1ZSA9PT0gJyV8JSc7CiAgfQoKICBmdW5jdGlvbiBpc0VtcHR5JDEobm9kZSkgewogICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT09IDggJiYgbm9kZS5ub2RlVmFsdWUgPT09ICclICUnOwogIH0KCiAgZnVuY3Rpb24gaXNTYW1lTm9kZVR5cGUoY2FuZGlkYXRlLCB0YWcpIHsKICAgIGlmIChjYW5kaWRhdGUubmFtZXNwYWNlVVJJID09PSBTVkdfTkFNRVNQQUNFKSB7CiAgICAgIHJldHVybiBjYW5kaWRhdGUudGFnTmFtZSA9PT0gdGFnOwogICAgfQoKICAgIHJldHVybiBjYW5kaWRhdGUudGFnTmFtZSA9PT0gdGFnLnRvVXBwZXJDYXNlKCk7CiAgfQoKICBmdW5jdGlvbiBmaW5kQnlOYW1lKGFycmF5LCBuYW1lKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBhdHRyID0gYXJyYXlbaV07CiAgICAgIGlmIChhdHRyLm5hbWUgPT09IG5hbWUpIHJldHVybiBhdHRyOwogICAgfQoKICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfQoKICBmdW5jdGlvbiByZWh5ZHJhdGlvbkJ1aWxkZXIoZW52LCBjdXJzb3IpIHsKICAgIHJldHVybiBSZWh5ZHJhdGVCdWlsZGVyLmZvckluaXRpYWxSZW5kZXIoZW52LCBjdXJzb3IpOwogIH0KfSk7CmRlZmluZSgiQGdsaW1tZXIvdXRpbCIsIFsiZXhwb3J0cyIsICJlbWJlci1iYWJlbCJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9lbWJlckJhYmVsKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5hc3NlcnQgPSBkZWJ1Z0Fzc2VydDsKICBfZXhwb3J0cy5hc3NpZ24gPSBhc3NpZ247CiAgX2V4cG9ydHMuZmlsbE51bGxzID0gZmlsbE51bGxzOwogIF9leHBvcnRzLmVuc3VyZUd1aWQgPSBlbnN1cmVHdWlkOwogIF9leHBvcnRzLmluaXRpYWxpemVHdWlkID0gaW5pdGlhbGl6ZUd1aWQ7CiAgX2V4cG9ydHMuZGljdCA9IGRpY3Q7CiAgX2V4cG9ydHMudW53cmFwID0gdW53cmFwOwogIF9leHBvcnRzLmV4cGVjdCA9IGV4cGVjdDsKICBfZXhwb3J0cy51bnJlYWNoYWJsZSA9IHVucmVhY2hhYmxlOwogIF9leHBvcnRzLkVNUFRZX0FSUkFZID0gX2V4cG9ydHMuTGlzdFNsaWNlID0gX2V4cG9ydHMuTGlzdE5vZGUgPSBfZXhwb3J0cy5MaW5rZWRMaXN0ID0gX2V4cG9ydHMuRU1QVFlfU0xJQ0UgPSBfZXhwb3J0cy5EaWN0U2V0ID0gX2V4cG9ydHMuU3RhY2sgPSB2b2lkIDA7CgogIGZ1bmN0aW9uIHVud3JhcCh2YWwpIHsKICAgIGlmICh2YWwgPT09IG51bGwgfHwgdmFsID09PSB1bmRlZmluZWQpIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdmFsdWUgdG8gYmUgcHJlc2VudCIpOwogICAgcmV0dXJuIHZhbDsKICB9CgogIGZ1bmN0aW9uIGV4cGVjdCh2YWwsIG1lc3NhZ2UpIHsKICAgIGlmICh2YWwgPT09IG51bGwgfHwgdmFsID09PSB1bmRlZmluZWQpIHRocm93IG5ldyBFcnJvcihtZXNzYWdlKTsKICAgIHJldHVybiB2YWw7CiAgfQoKICBmdW5jdGlvbiB1bnJlYWNoYWJsZShtZXNzYWdlKSB7CiAgICBpZiAobWVzc2FnZSA9PT0gdm9pZCAwKSB7CiAgICAgIG1lc3NhZ2UgPSAndW5yZWFjaGFibGUnOwogICAgfQoKICAgIHJldHVybiBuZXcgRXJyb3IobWVzc2FnZSk7CiAgfSAvLyBpbXBvcnQgTG9nZ2VyIGZyb20gJy4vbG9nZ2VyJzsKICAvLyBsZXQgYWxyZWFkeVdhcm5lZCA9IGZhbHNlOwoKCiAgZnVuY3Rpb24gZGVidWdBc3NlcnQodGVzdCwgbXNnKSB7CiAgICAvLyBpZiAoIWFscmVhZHlXYXJuZWQpIHsKICAgIC8vICAgYWxyZWFkeVdhcm5lZCA9IHRydWU7CiAgICAvLyAgIExvZ2dlci53YXJuKCJEb24ndCBsZWF2ZSBkZWJ1ZyBhc3NlcnRpb25zIG9uIGluIHB1YmxpYyBidWlsZHMiKTsKICAgIC8vIH0KICAgIGlmICghdGVzdCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IobXNnIHx8ICdhc3NlcnRpb24gZmFpbHVyZScpOwogICAgfQogIH0KCiAgdmFyIG9iaktleXMgPSBPYmplY3Qua2V5czsKCiAgZnVuY3Rpb24gYXNzaWduKG9iaikgewogICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGFzc2lnbm1lbnQgPSBhcmd1bWVudHNbaV07CiAgICAgIGlmIChhc3NpZ25tZW50ID09PSBudWxsIHx8IHR5cGVvZiBhc3NpZ25tZW50ICE9PSAnb2JqZWN0JykgY29udGludWU7CiAgICAgIHZhciBrZXlzID0gb2JqS2V5cyhhc3NpZ25tZW50KTsKCiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwga2V5cy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBrZXkgPSBrZXlzW2pdOwogICAgICAgIG9ialtrZXldID0gYXNzaWdubWVudFtrZXldOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9CgogIGZ1bmN0aW9uIGZpbGxOdWxscyhjb3VudCkgewogICAgdmFyIGFyciA9IG5ldyBBcnJheShjb3VudCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgIGFycltpXSA9IG51bGw7CiAgICB9CgogICAgcmV0dXJuIGFycjsKICB9CgogIHZhciBHVUlEID0gMDsKCiAgZnVuY3Rpb24gaW5pdGlhbGl6ZUd1aWQob2JqZWN0KSB7CiAgICByZXR1cm4gb2JqZWN0Ll9ndWlkID0gKytHVUlEOwogIH0KCiAgZnVuY3Rpb24gZW5zdXJlR3VpZChvYmplY3QpIHsKICAgIHJldHVybiBvYmplY3QuX2d1aWQgfHwgaW5pdGlhbGl6ZUd1aWQob2JqZWN0KTsKICB9CgogIGZ1bmN0aW9uIGRpY3QoKSB7CiAgICByZXR1cm4gT2JqZWN0LmNyZWF0ZShudWxsKTsKICB9CgogIHZhciBEaWN0U2V0ID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRGljdFNldCgpIHsKICAgICAgdGhpcy5kaWN0ID0gZGljdCgpOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBEaWN0U2V0LnByb3RvdHlwZTsKCiAgICBfcHJvdG8uYWRkID0gZnVuY3Rpb24gYWRkKG9iaikgewogICAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ3N0cmluZycpIHRoaXMuZGljdFtvYmpdID0gb2JqO2Vsc2UgdGhpcy5kaWN0W2Vuc3VyZUd1aWQob2JqKV0gPSBvYmo7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICBfcHJvdG8uZGVsZXRlID0gZnVuY3Rpb24gX2RlbGV0ZShvYmopIHsKICAgICAgaWYgKHR5cGVvZiBvYmogPT09ICdzdHJpbmcnKSBkZWxldGUgdGhpcy5kaWN0W29ial07ZWxzZSBpZiAob2JqLl9ndWlkKSBkZWxldGUgdGhpcy5kaWN0W29iai5fZ3VpZF07CiAgICB9OwoKICAgIHJldHVybiBEaWN0U2V0OwogIH0oKTsKCiAgX2V4cG9ydHMuRGljdFNldCA9IERpY3RTZXQ7CgogIHZhciBTdGFjayA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFN0YWNrKCkgewogICAgICB0aGlzLnN0YWNrID0gW107CiAgICAgIHRoaXMuY3VycmVudCA9IG51bGw7CiAgICB9CgogICAgdmFyIF9wcm90bzIgPSBTdGFjay5wcm90b3R5cGU7CgogICAgX3Byb3RvMi5wdXNoID0gZnVuY3Rpb24gcHVzaChpdGVtKSB7CiAgICAgIHRoaXMuY3VycmVudCA9IGl0ZW07CiAgICAgIHRoaXMuc3RhY2sucHVzaChpdGVtKTsKICAgIH07CgogICAgX3Byb3RvMi5wb3AgPSBmdW5jdGlvbiBwb3AoKSB7CiAgICAgIHZhciBpdGVtID0gdGhpcy5zdGFjay5wb3AoKTsKICAgICAgdmFyIGxlbiA9IHRoaXMuc3RhY2subGVuZ3RoOwogICAgICB0aGlzLmN1cnJlbnQgPSBsZW4gPT09IDAgPyBudWxsIDogdGhpcy5zdGFja1tsZW4gLSAxXTsKICAgICAgcmV0dXJuIGl0ZW0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiBpdGVtOwogICAgfTsKCiAgICBfcHJvdG8yLmlzRW1wdHkgPSBmdW5jdGlvbiBpc0VtcHR5KCkgewogICAgICByZXR1cm4gdGhpcy5zdGFjay5sZW5ndGggPT09IDA7CiAgICB9OwoKICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoU3RhY2ssIFt7CiAgICAgIGtleTogInNpemUiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5zdGFjay5sZW5ndGg7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBTdGFjazsKICB9KCk7CgogIF9leHBvcnRzLlN0YWNrID0gU3RhY2s7CgogIHZhciBMaXN0Tm9kZSA9IGZ1bmN0aW9uIExpc3ROb2RlKHZhbHVlKSB7CiAgICB0aGlzLm5leHQgPSBudWxsOwogICAgdGhpcy5wcmV2ID0gbnVsbDsKICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICB9OwoKICBfZXhwb3J0cy5MaXN0Tm9kZSA9IExpc3ROb2RlOwoKICB2YXIgTGlua2VkTGlzdCA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIExpbmtlZExpc3QoKSB7CiAgICAgIHRoaXMuY2xlYXIoKTsKICAgIH0KCiAgICB2YXIgX3Byb3RvMyA9IExpbmtlZExpc3QucHJvdG90eXBlOwoKICAgIF9wcm90bzMuaGVhZCA9IGZ1bmN0aW9uIGhlYWQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9oZWFkOwogICAgfTsKCiAgICBfcHJvdG8zLnRhaWwgPSBmdW5jdGlvbiB0YWlsKCkgewogICAgICByZXR1cm4gdGhpcy5fdGFpbDsKICAgIH07CgogICAgX3Byb3RvMy5jbGVhciA9IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICB0aGlzLl9oZWFkID0gdGhpcy5fdGFpbCA9IG51bGw7CiAgICB9OwoKICAgIF9wcm90bzMudG9BcnJheSA9IGZ1bmN0aW9uIHRvQXJyYXkoKSB7CiAgICAgIHZhciBvdXQgPSBbXTsKICAgICAgdGhpcy5mb3JFYWNoTm9kZShmdW5jdGlvbiAobikgewogICAgICAgIHJldHVybiBvdXQucHVzaChuKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBvdXQ7CiAgICB9OwoKICAgIF9wcm90bzMubmV4dE5vZGUgPSBmdW5jdGlvbiBuZXh0Tm9kZShub2RlKSB7CiAgICAgIHJldHVybiBub2RlLm5leHQ7CiAgICB9OwoKICAgIF9wcm90bzMuZm9yRWFjaE5vZGUgPSBmdW5jdGlvbiBmb3JFYWNoTm9kZShjYWxsYmFjaykgewogICAgICB2YXIgbm9kZSA9IHRoaXMuX2hlYWQ7CgogICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgIGNhbGxiYWNrKG5vZGUpOwogICAgICAgIG5vZGUgPSBub2RlLm5leHQ7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMy5pbnNlcnRCZWZvcmUgPSBmdW5jdGlvbiBpbnNlcnRCZWZvcmUobm9kZSwgcmVmZXJlbmNlKSB7CiAgICAgIGlmIChyZWZlcmVuY2UgPT09IHZvaWQgMCkgewogICAgICAgIHJlZmVyZW5jZSA9IG51bGw7CiAgICAgIH0KCiAgICAgIGlmIChyZWZlcmVuY2UgPT09IG51bGwpIHJldHVybiB0aGlzLmFwcGVuZChub2RlKTsKICAgICAgaWYgKHJlZmVyZW5jZS5wcmV2KSByZWZlcmVuY2UucHJldi5uZXh0ID0gbm9kZTtlbHNlIHRoaXMuX2hlYWQgPSBub2RlOwogICAgICBub2RlLnByZXYgPSByZWZlcmVuY2UucHJldjsKICAgICAgbm9kZS5uZXh0ID0gcmVmZXJlbmNlOwogICAgICByZWZlcmVuY2UucHJldiA9IG5vZGU7CiAgICAgIHJldHVybiBub2RlOwogICAgfTsKCiAgICBfcHJvdG8zLmFwcGVuZCA9IGZ1bmN0aW9uIGFwcGVuZChub2RlKSB7CiAgICAgIHZhciB0YWlsID0gdGhpcy5fdGFpbDsKCiAgICAgIGlmICh0YWlsKSB7CiAgICAgICAgdGFpbC5uZXh0ID0gbm9kZTsKICAgICAgICBub2RlLnByZXYgPSB0YWlsOwogICAgICAgIG5vZGUubmV4dCA9IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5faGVhZCA9IG5vZGU7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLl90YWlsID0gbm9kZTsKICAgIH07CgogICAgX3Byb3RvMy5yZW1vdmUgPSBmdW5jdGlvbiByZW1vdmUobm9kZSkgewogICAgICBpZiAobm9kZS5wcmV2KSBub2RlLnByZXYubmV4dCA9IG5vZGUubmV4dDtlbHNlIHRoaXMuX2hlYWQgPSBub2RlLm5leHQ7CiAgICAgIGlmIChub2RlLm5leHQpIG5vZGUubmV4dC5wcmV2ID0gbm9kZS5wcmV2O2Vsc2UgdGhpcy5fdGFpbCA9IG5vZGUucHJldjsKICAgICAgcmV0dXJuIG5vZGU7CiAgICB9OwoKICAgIHJldHVybiBMaW5rZWRMaXN0OwogIH0oKTsKCiAgX2V4cG9ydHMuTGlua2VkTGlzdCA9IExpbmtlZExpc3Q7CgogIHZhciBMaXN0U2xpY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBMaXN0U2xpY2UoaGVhZCwgdGFpbCkgewogICAgICB0aGlzLl9oZWFkID0gaGVhZDsKICAgICAgdGhpcy5fdGFpbCA9IHRhaWw7CiAgICB9CgogICAgdmFyIF9wcm90bzQgPSBMaXN0U2xpY2UucHJvdG90eXBlOwoKICAgIF9wcm90bzQuZm9yRWFjaE5vZGUgPSBmdW5jdGlvbiBmb3JFYWNoTm9kZShjYWxsYmFjaykgewogICAgICB2YXIgbm9kZSA9IHRoaXMuX2hlYWQ7CgogICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgIGNhbGxiYWNrKG5vZGUpOwogICAgICAgIG5vZGUgPSB0aGlzLm5leHROb2RlKG5vZGUpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzQuaGVhZCA9IGZ1bmN0aW9uIGhlYWQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9oZWFkOwogICAgfTsKCiAgICBfcHJvdG80LnRhaWwgPSBmdW5jdGlvbiB0YWlsKCkgewogICAgICByZXR1cm4gdGhpcy5fdGFpbDsKICAgIH07CgogICAgX3Byb3RvNC50b0FycmF5ID0gZnVuY3Rpb24gdG9BcnJheSgpIHsKICAgICAgdmFyIG91dCA9IFtdOwogICAgICB0aGlzLmZvckVhY2hOb2RlKGZ1bmN0aW9uIChuKSB7CiAgICAgICAgcmV0dXJuIG91dC5wdXNoKG4pOwogICAgICB9KTsKICAgICAgcmV0dXJuIG91dDsKICAgIH07CgogICAgX3Byb3RvNC5uZXh0Tm9kZSA9IGZ1bmN0aW9uIG5leHROb2RlKG5vZGUpIHsKICAgICAgaWYgKG5vZGUgPT09IHRoaXMuX3RhaWwpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gbm9kZS5uZXh0OwogICAgfTsKCiAgICByZXR1cm4gTGlzdFNsaWNlOwogIH0oKTsKCiAgX2V4cG9ydHMuTGlzdFNsaWNlID0gTGlzdFNsaWNlOwogIHZhciBFTVBUWV9TTElDRSA9IG5ldyBMaXN0U2xpY2UobnVsbCwgbnVsbCk7CiAgX2V4cG9ydHMuRU1QVFlfU0xJQ0UgPSBFTVBUWV9TTElDRTsKICB2YXIgRU1QVFlfQVJSQVkgPSBPYmplY3QuZnJlZXplKFtdKTsKICBfZXhwb3J0cy5FTVBUWV9BUlJBWSA9IEVNUFRZX0FSUkFZOwp9KTsKZGVmaW5lKCJAZ2xpbW1lci92bSIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLlJlZ2lzdGVyID0gdm9pZCAwOwoKICAvKioKICAgKiBSZWdpc3RlcnMKICAgKgogICAqIEZvciB0aGUgbW9zdCBwYXJ0LCB0aGVzZSBmb2xsb3dzIE1JUFMgbmFtaW5nIGNvbnZlbnRpb25zLCBob3dldmVyIHRoZQogICAqIHJlZ2lzdGVyIG51bWJlcnMgYXJlIGRpZmZlcmVudC4KICAgKi8KICB2YXIgUmVnaXN0ZXI7CiAgX2V4cG9ydHMuUmVnaXN0ZXIgPSBSZWdpc3RlcjsKCiAgKGZ1bmN0aW9uIChSZWdpc3RlcikgewogICAgLy8gJDAgb3IgJHBjIChwcm9ncmFtIGNvdW50ZXIpOiBwb2ludGVyIGludG8gYHByb2dyYW1gIGZvciB0aGUgbmV4dCBpbnN0dXJjdGlvbjsgLTEgbWVhbnMgZXhpdAogICAgUmVnaXN0ZXJbUmVnaXN0ZXJbInBjIl0gPSAwXSA9ICJwYyI7IC8vICQxIG9yICRyYSAocmV0dXJuIGFkZHJlc3MpOiBwb2ludGVyIGludG8gYHByb2dyYW1gIGZvciB0aGUgcmV0dXJuCgogICAgUmVnaXN0ZXJbUmVnaXN0ZXJbInJhIl0gPSAxXSA9ICJyYSI7IC8vICQyIG9yICRmcCAoZnJhbWUgcG9pbnRlcik6IHBvaW50ZXIgaW50byB0aGUgYGV2YWxTdGFja2AgZm9yIHRoZSBiYXNlIG9mIHRoZSBzdGFjawoKICAgIFJlZ2lzdGVyW1JlZ2lzdGVyWyJmcCJdID0gMl0gPSAiZnAiOyAvLyAkMyBvciAkc3AgKHN0YWNrIHBvaW50ZXIpOiBwb2ludGVyIGludG8gdGhlIGBldmFsU3RhY2tgIGZvciB0aGUgdG9wIG9mIHRoZSBzdGFjawoKICAgIFJlZ2lzdGVyW1JlZ2lzdGVyWyJzcCJdID0gM10gPSAic3AiOyAvLyAkNC0kNSBvciAkczAtJHMxIChzYXZlZCk6IGNhbGxlZSBzYXZlZCBnZW5lcmFsLXB1cnBvc2UgcmVnaXN0ZXJzCgogICAgUmVnaXN0ZXJbUmVnaXN0ZXJbInMwIl0gPSA0XSA9ICJzMCI7CiAgICBSZWdpc3RlcltSZWdpc3RlclsiczEiXSA9IDVdID0gInMxIjsgLy8gJDYtJDcgb3IgJHQwLSR0MSAodGVtcG9yYXJpZXMpOiBjYWxsZXIgc2F2ZWQgZ2VuZXJhbC1wdXJwb3NlIHJlZ2lzdGVycwoKICAgIFJlZ2lzdGVyW1JlZ2lzdGVyWyJ0MCJdID0gNl0gPSAidDAiOwogICAgUmVnaXN0ZXJbUmVnaXN0ZXJbInQxIl0gPSA3XSA9ICJ0MSI7IC8vICQ4IG9yICR2MCAocmV0dXJuIHZhbHVlKQoKICAgIFJlZ2lzdGVyW1JlZ2lzdGVyWyJ2MCJdID0gOF0gPSAidjAiOwogIH0pKFJlZ2lzdGVyIHx8IChfZXhwb3J0cy5SZWdpc3RlciA9IFJlZ2lzdGVyID0ge30pKTsKfSk7CmRlZmluZSgiQGdsaW1tZXIvd2lyZS1mb3JtYXQiLCBbImV4cG9ydHMiXSwgZnVuY3Rpb24gKF9leHBvcnRzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5pcyA9IGlzOwogIF9leHBvcnRzLmlzQXR0cmlidXRlID0gaXNBdHRyaWJ1dGU7CiAgX2V4cG9ydHMuaXNBcmd1bWVudCA9IGlzQXJndW1lbnQ7CiAgX2V4cG9ydHMuaXNNYXliZUxvY2FsID0gX2V4cG9ydHMuaXNHZXQgPSBfZXhwb3J0cy5pc0ZsdXNoRWxlbWVudCA9IF9leHBvcnRzLk9wcyA9IHZvaWQgMDsKICB2YXIgT3Bjb2RlczsKICBfZXhwb3J0cy5PcHMgPSBPcGNvZGVzOwoKICAoZnVuY3Rpb24gKE9wY29kZXMpIHsKICAgIC8vIFN0YXRlbWVudHMKICAgIE9wY29kZXNbT3Bjb2Rlc1siVGV4dCJdID0gMF0gPSAiVGV4dCI7CiAgICBPcGNvZGVzW09wY29kZXNbIkFwcGVuZCJdID0gMV0gPSAiQXBwZW5kIjsKICAgIE9wY29kZXNbT3Bjb2Rlc1siQ29tbWVudCJdID0gMl0gPSAiQ29tbWVudCI7CiAgICBPcGNvZGVzW09wY29kZXNbIk1vZGlmaWVyIl0gPSAzXSA9ICJNb2RpZmllciI7CiAgICBPcGNvZGVzW09wY29kZXNbIkJsb2NrIl0gPSA0XSA9ICJCbG9jayI7CiAgICBPcGNvZGVzW09wY29kZXNbIkNvbXBvbmVudCJdID0gNV0gPSAiQ29tcG9uZW50IjsKICAgIE9wY29kZXNbT3Bjb2Rlc1siRHluYW1pY0NvbXBvbmVudCJdID0gNl0gPSAiRHluYW1pY0NvbXBvbmVudCI7CiAgICBPcGNvZGVzW09wY29kZXNbIk9wZW5FbGVtZW50Il0gPSA3XSA9ICJPcGVuRWxlbWVudCI7CiAgICBPcGNvZGVzW09wY29kZXNbIkZsdXNoRWxlbWVudCJdID0gOF0gPSAiRmx1c2hFbGVtZW50IjsKICAgIE9wY29kZXNbT3Bjb2Rlc1siQ2xvc2VFbGVtZW50Il0gPSA5XSA9ICJDbG9zZUVsZW1lbnQiOwogICAgT3Bjb2Rlc1tPcGNvZGVzWyJTdGF0aWNBdHRyIl0gPSAxMF0gPSAiU3RhdGljQXR0ciI7CiAgICBPcGNvZGVzW09wY29kZXNbIkR5bmFtaWNBdHRyIl0gPSAxMV0gPSAiRHluYW1pY0F0dHIiOwogICAgT3Bjb2Rlc1tPcGNvZGVzWyJDb21wb25lbnRBdHRyIl0gPSAxMl0gPSAiQ29tcG9uZW50QXR0ciI7CiAgICBPcGNvZGVzW09wY29kZXNbIkF0dHJTcGxhdCJdID0gMTNdID0gIkF0dHJTcGxhdCI7CiAgICBPcGNvZGVzW09wY29kZXNbIllpZWxkIl0gPSAxNF0gPSAiWWllbGQiOwogICAgT3Bjb2Rlc1tPcGNvZGVzWyJQYXJ0aWFsIl0gPSAxNV0gPSAiUGFydGlhbCI7CiAgICBPcGNvZGVzW09wY29kZXNbIkR5bmFtaWNBcmciXSA9IDE2XSA9ICJEeW5hbWljQXJnIjsKICAgIE9wY29kZXNbT3Bjb2Rlc1siU3RhdGljQXJnIl0gPSAxN10gPSAiU3RhdGljQXJnIjsKICAgIE9wY29kZXNbT3Bjb2Rlc1siVHJ1c3RpbmdBdHRyIl0gPSAxOF0gPSAiVHJ1c3RpbmdBdHRyIjsKICAgIE9wY29kZXNbT3Bjb2Rlc1siVHJ1c3RpbmdDb21wb25lbnRBdHRyIl0gPSAxOV0gPSAiVHJ1c3RpbmdDb21wb25lbnRBdHRyIjsKICAgIE9wY29kZXNbT3Bjb2Rlc1siRGVidWdnZXIiXSA9IDIwXSA9ICJEZWJ1Z2dlciI7CiAgICBPcGNvZGVzW09wY29kZXNbIkNsaWVudFNpZGVTdGF0ZW1lbnQiXSA9IDIxXSA9ICJDbGllbnRTaWRlU3RhdGVtZW50IjsgLy8gRXhwcmVzc2lvbnMKCiAgICBPcGNvZGVzW09wY29kZXNbIlVua25vd24iXSA9IDIyXSA9ICJVbmtub3duIjsKICAgIE9wY29kZXNbT3Bjb2Rlc1siR2V0Il0gPSAyM10gPSAiR2V0IjsKICAgIE9wY29kZXNbT3Bjb2Rlc1siTWF5YmVMb2NhbCJdID0gMjRdID0gIk1heWJlTG9jYWwiOwogICAgT3Bjb2Rlc1tPcGNvZGVzWyJIYXNCbG9jayJdID0gMjVdID0gIkhhc0Jsb2NrIjsKICAgIE9wY29kZXNbT3Bjb2Rlc1siSGFzQmxvY2tQYXJhbXMiXSA9IDI2XSA9ICJIYXNCbG9ja1BhcmFtcyI7CiAgICBPcGNvZGVzW09wY29kZXNbIlVuZGVmaW5lZCJdID0gMjddID0gIlVuZGVmaW5lZCI7CiAgICBPcGNvZGVzW09wY29kZXNbIkhlbHBlciJdID0gMjhdID0gIkhlbHBlciI7CiAgICBPcGNvZGVzW09wY29kZXNbIkNvbmNhdCJdID0gMjldID0gIkNvbmNhdCI7CiAgICBPcGNvZGVzW09wY29kZXNbIkNsaWVudFNpZGVFeHByZXNzaW9uIl0gPSAzMF0gPSAiQ2xpZW50U2lkZUV4cHJlc3Npb24iOwogIH0pKE9wY29kZXMgfHwgKF9leHBvcnRzLk9wcyA9IE9wY29kZXMgPSB7fSkpOwoKICBmdW5jdGlvbiBpcyh2YXJpYW50KSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSAmJiB2YWx1ZVswXSA9PT0gdmFyaWFudDsKICAgIH07CiAgfSAvLyBTdGF0ZW1lbnRzCgoKICB2YXIgaXNGbHVzaEVsZW1lbnQgPSBpcyhPcGNvZGVzLkZsdXNoRWxlbWVudCk7CiAgX2V4cG9ydHMuaXNGbHVzaEVsZW1lbnQgPSBpc0ZsdXNoRWxlbWVudDsKCiAgZnVuY3Rpb24gaXNBdHRyaWJ1dGUodmFsKSB7CiAgICByZXR1cm4gdmFsWzBdID09PSBPcGNvZGVzLlN0YXRpY0F0dHIgfHwgdmFsWzBdID09PSBPcGNvZGVzLkR5bmFtaWNBdHRyIHx8IHZhbFswXSA9PT0gT3Bjb2Rlcy5Db21wb25lbnRBdHRyIHx8IHZhbFswXSA9PT0gT3Bjb2Rlcy5UcnVzdGluZ0F0dHIgfHwgdmFsWzBdID09PSBPcGNvZGVzLlRydXN0aW5nQ29tcG9uZW50QXR0ciB8fCB2YWxbMF0gPT09IE9wY29kZXMuQXR0clNwbGF0IHx8IHZhbFswXSA9PT0gT3Bjb2Rlcy5Nb2RpZmllcjsKICB9CgogIGZ1bmN0aW9uIGlzQXJndW1lbnQodmFsKSB7CiAgICByZXR1cm4gdmFsWzBdID09PSBPcGNvZGVzLlN0YXRpY0FyZyB8fCB2YWxbMF0gPT09IE9wY29kZXMuRHluYW1pY0FyZzsKICB9IC8vIEV4cHJlc3Npb25zCgoKICB2YXIgaXNHZXQgPSBpcyhPcGNvZGVzLkdldCk7CiAgX2V4cG9ydHMuaXNHZXQgPSBpc0dldDsKICB2YXIgaXNNYXliZUxvY2FsID0gaXMoT3Bjb2Rlcy5NYXliZUxvY2FsKTsKICBfZXhwb3J0cy5pc01heWJlTG9jYWwgPSBpc01heWJlTG9jYWw7Cn0pOwpkZWZpbmUoImJhY2tidXJuZXIiLCBbImV4cG9ydHMiLCAiZW1iZXItYmFiZWwiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZW1iZXJCYWJlbCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuYnVpbGRQbGF0Zm9ybSA9IGJ1aWxkUGxhdGZvcm07CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKICB2YXIgU0VUX1RJTUVPVVQgPSBzZXRUaW1lb3V0OwoKICB2YXIgTk9PUCA9IGZ1bmN0aW9uIE5PT1AoKSB7fTsKCiAgZnVuY3Rpb24gYnVpbGROZXh0KGZsdXNoKSB7CiAgICAvLyBVc2luZyAicHJvbWlzZXMgZmlyc3QiIGhlcmUgdG86CiAgICAvLwogICAgLy8gMSkgRW5zdXJlIG1vcmUgY29uc2lzdGVudCBleHBlcmllbmNlIG9uIGJyb3dzZXJzIHRoYXQKICAgIC8vICAgIGhhdmUgZGlmZmVyZW50bHkgcXVldWVkIG1pY3JvdGFza3MgKHNlcGFyYXRlIHF1ZXVlcyBmb3IKICAgIC8vICAgIE11dGF0aW9uT2JzZXJ2ZXIgdnMgUHJvbWlzZXMpLgogICAgLy8gMikgRW5zdXJlIGJldHRlciBkZWJ1Z2dpbmcgZXhwZXJpZW5jZXMgKGl0IHNob3dzIHVwIGluIENocm9tZQogICAgLy8gICAgY2FsbCBzdGFjayBhcyAiUHJvbWlzZS50aGVuIChhc3luYykiKSB3aGljaCBpcyBtb3JlIGNvbnNpc3RlbnQKICAgIC8vICAgIHdpdGggdXNlciBleHBlY3RhdGlvbnMKICAgIC8vCiAgICAvLyBXaGVuIFByb21pc2UgaXMgdW5hdmFpbGFibGUgdXNlIE11dGF0aW9uT2JzZXJ2ZXIgKG1vc3RseSBzbyB0aGF0IHdlCiAgICAvLyBzdGlsbCBnZXQgbWljcm90YXNrcyBvbiBJRTExKSwgYW5kIHdoZW4gbmVpdGhlciBNdXRhdGlvbk9ic2VydmVyIGFuZAogICAgLy8gUHJvbWlzZSBhcmUgcHJlc2VudCB1c2UgYSBwbGFpbiBvbGQgc2V0VGltZW91dC4KICAgIGlmICh0eXBlb2YgUHJvbWlzZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICB2YXIgYXV0b3J1blByb21pc2UgPSBQcm9taXNlLnJlc29sdmUoKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gYXV0b3J1blByb21pc2UudGhlbihmbHVzaCk7CiAgICAgIH07CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBNdXRhdGlvbk9ic2VydmVyID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHZhciBpdGVyYXRpb25zID0gMDsKICAgICAgdmFyIG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZmx1c2gpOwogICAgICB2YXIgbm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCcnKTsKICAgICAgb2JzZXJ2ZXIub2JzZXJ2ZShub2RlLCB7CiAgICAgICAgY2hhcmFjdGVyRGF0YTogdHJ1ZQogICAgICB9KTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICBpdGVyYXRpb25zID0gKytpdGVyYXRpb25zICUgMjsKICAgICAgICBub2RlLmRhdGEgPSAnJyArIGl0ZXJhdGlvbnM7CiAgICAgICAgcmV0dXJuIGl0ZXJhdGlvbnM7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBTRVRfVElNRU9VVChmbHVzaCwgMCk7CiAgICAgIH07CiAgICB9CiAgfQoKICBmdW5jdGlvbiBidWlsZFBsYXRmb3JtKGZsdXNoKSB7CiAgICB2YXIgY2xlYXJOZXh0ID0gTk9PUDsKICAgIHJldHVybiB7CiAgICAgIHNldFRpbWVvdXQ6IGZ1bmN0aW9uIChfc2V0VGltZW91dCkgewogICAgICAgIGZ1bmN0aW9uIHNldFRpbWVvdXQoX3gsIF94MikgewogICAgICAgICAgcmV0dXJuIF9zZXRUaW1lb3V0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQoKICAgICAgICBzZXRUaW1lb3V0LnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIF9zZXRUaW1lb3V0LnRvU3RyaW5nKCk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQ7CiAgICAgIH0oZnVuY3Rpb24gKGZuLCBtcykgewogICAgICAgIHJldHVybiBzZXRUaW1lb3V0KGZuLCBtcyk7CiAgICAgIH0pLAogICAgICBjbGVhclRpbWVvdXQ6IGZ1bmN0aW9uIChfY2xlYXJUaW1lb3V0KSB7CiAgICAgICAgZnVuY3Rpb24gY2xlYXJUaW1lb3V0KF94MykgewogICAgICAgICAgcmV0dXJuIF9jbGVhclRpbWVvdXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CgogICAgICAgIGNsZWFyVGltZW91dC50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBfY2xlYXJUaW1lb3V0LnRvU3RyaW5nKCk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIGNsZWFyVGltZW91dDsKICAgICAgfShmdW5jdGlvbiAodGltZXJJZCkgewogICAgICAgIHJldHVybiBjbGVhclRpbWVvdXQodGltZXJJZCk7CiAgICAgIH0pLAogICAgICBub3c6IGZ1bmN0aW9uIG5vdygpIHsKICAgICAgICByZXR1cm4gRGF0ZS5ub3coKTsKICAgICAgfSwKICAgICAgbmV4dDogYnVpbGROZXh0KGZsdXNoKSwKICAgICAgY2xlYXJOZXh0OiBjbGVhck5leHQKICAgIH07CiAgfQoKICB2YXIgTlVNQkVSID0gL1xkKy87CiAgdmFyIFRJTUVSU19PRkZTRVQgPSA2OwoKICBmdW5jdGlvbiBpc0NvZXJjYWJsZU51bWJlcihzdXNwZWN0KSB7CiAgICB2YXIgdHlwZSA9IHR5cGVvZiBzdXNwZWN0OwogICAgcmV0dXJuIHR5cGUgPT09ICdudW1iZXInICYmIHN1c3BlY3QgPT09IHN1c3BlY3QgfHwgdHlwZSA9PT0gJ3N0cmluZycgJiYgTlVNQkVSLnRlc3Qoc3VzcGVjdCk7CiAgfQoKICBmdW5jdGlvbiBnZXRPbkVycm9yKG9wdGlvbnMpIHsKICAgIHJldHVybiBvcHRpb25zLm9uRXJyb3IgfHwgb3B0aW9ucy5vbkVycm9yVGFyZ2V0ICYmIG9wdGlvbnMub25FcnJvclRhcmdldFtvcHRpb25zLm9uRXJyb3JNZXRob2RdOwogIH0KCiAgZnVuY3Rpb24gZmluZEl0ZW0odGFyZ2V0LCBtZXRob2QsIGNvbGxlY3Rpb24pIHsKICAgIHZhciBpbmRleCA9IC0xOwoKICAgIGZvciAodmFyIGkgPSAwLCBsID0gY29sbGVjdGlvbi5sZW5ndGg7IGkgPCBsOyBpICs9IDQpIHsKICAgICAgaWYgKGNvbGxlY3Rpb25baV0gPT09IHRhcmdldCAmJiBjb2xsZWN0aW9uW2kgKyAxXSA9PT0gbWV0aG9kKSB7CiAgICAgICAgaW5kZXggPSBpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGluZGV4OwogIH0KCiAgZnVuY3Rpb24gZmluZFRpbWVySXRlbSh0YXJnZXQsIG1ldGhvZCwgY29sbGVjdGlvbikgewogICAgdmFyIGluZGV4ID0gLTE7CgogICAgZm9yICh2YXIgaSA9IDIsIGwgPSBjb2xsZWN0aW9uLmxlbmd0aDsgaSA8IGw7IGkgKz0gNikgewogICAgICBpZiAoY29sbGVjdGlvbltpXSA9PT0gdGFyZ2V0ICYmIGNvbGxlY3Rpb25baSArIDFdID09PSBtZXRob2QpIHsKICAgICAgICBpbmRleCA9IGkgLSAyOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGluZGV4OwogIH0KCiAgZnVuY3Rpb24gZ2V0UXVldWVJdGVtcyhpdGVtcywgcXVldWVJdGVtTGVuZ3RoLCBxdWV1ZUl0ZW1Qb3NpdGlvbk9mZnNldCkgewogICAgaWYgKHF1ZXVlSXRlbVBvc2l0aW9uT2Zmc2V0ID09PSB2b2lkIDApIHsKICAgICAgcXVldWVJdGVtUG9zaXRpb25PZmZzZXQgPSAwOwogICAgfQoKICAgIHZhciBxdWV1ZUl0ZW1zID0gW107CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkgKz0gcXVldWVJdGVtTGVuZ3RoKSB7CiAgICAgIHZhciBtYXliZUVycm9yID0gaXRlbXNbaSArIDMKICAgICAgLyogc3RhY2sgKi8KICAgICAgKyBxdWV1ZUl0ZW1Qb3NpdGlvbk9mZnNldF07CiAgICAgIHZhciBxdWV1ZUl0ZW0gPSB7CiAgICAgICAgdGFyZ2V0OiBpdGVtc1tpICsgMAogICAgICAgIC8qIHRhcmdldCAqLwogICAgICAgICsgcXVldWVJdGVtUG9zaXRpb25PZmZzZXRdLAogICAgICAgIG1ldGhvZDogaXRlbXNbaSArIDEKICAgICAgICAvKiBtZXRob2QgKi8KICAgICAgICArIHF1ZXVlSXRlbVBvc2l0aW9uT2Zmc2V0XSwKICAgICAgICBhcmdzOiBpdGVtc1tpICsgMgogICAgICAgIC8qIGFyZ3MgKi8KICAgICAgICArIHF1ZXVlSXRlbVBvc2l0aW9uT2Zmc2V0XSwKICAgICAgICBzdGFjazogbWF5YmVFcnJvciAhPT0gdW5kZWZpbmVkICYmICdzdGFjaycgaW4gbWF5YmVFcnJvciA/IG1heWJlRXJyb3Iuc3RhY2sgOiAnJwogICAgICB9OwogICAgICBxdWV1ZUl0ZW1zLnB1c2gocXVldWVJdGVtKTsKICAgIH0KCiAgICByZXR1cm4gcXVldWVJdGVtczsKICB9CgogIGZ1bmN0aW9uIGJpbmFyeVNlYXJjaCh0aW1lLCB0aW1lcnMpIHsKICAgIHZhciBzdGFydCA9IDA7CiAgICB2YXIgZW5kID0gdGltZXJzLmxlbmd0aCAtIFRJTUVSU19PRkZTRVQ7CiAgICB2YXIgbWlkZGxlOwogICAgdmFyIGw7CgogICAgd2hpbGUgKHN0YXJ0IDwgZW5kKSB7CiAgICAgIC8vIHNpbmNlIHRpbWVycyBpcyBhbiBhcnJheSBvZiBwYWlycyAnbCcgd2lsbCBhbHdheXMKICAgICAgLy8gYmUgYW4gaW50ZWdlcgogICAgICBsID0gKGVuZCAtIHN0YXJ0KSAvIFRJTUVSU19PRkZTRVQ7IC8vIGNvbXBlbnNhdGUgZm9yIHRoZSBpbmRleCBpbiBjYXNlIGV2ZW4gbnVtYmVyCiAgICAgIC8vIG9mIHBhaXJzIGluc2lkZSB0aW1lcnMKCiAgICAgIG1pZGRsZSA9IHN0YXJ0ICsgbCAtIGwgJSBUSU1FUlNfT0ZGU0VUOwoKICAgICAgaWYgKHRpbWUgPj0gdGltZXJzW21pZGRsZV0pIHsKICAgICAgICBzdGFydCA9IG1pZGRsZSArIFRJTUVSU19PRkZTRVQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZW5kID0gbWlkZGxlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRpbWUgPj0gdGltZXJzW3N0YXJ0XSA/IHN0YXJ0ICsgVElNRVJTX09GRlNFVCA6IHN0YXJ0OwogIH0KCiAgdmFyIFFVRVVFX0lURU1fTEVOR1RIID0gNDsKCiAgdmFyIFF1ZXVlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gUXVldWUobmFtZSwgb3B0aW9ucywgZ2xvYmFsT3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBpZiAoZ2xvYmFsT3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgZ2xvYmFsT3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICB0aGlzLl9xdWV1ZUJlaW5nRmx1c2hlZCA9IFtdOwogICAgICB0aGlzLnRhcmdldFF1ZXVlcyA9IG5ldyBNYXAoKTsKICAgICAgdGhpcy5pbmRleCA9IDA7CiAgICAgIHRoaXMuX3F1ZXVlID0gW107CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgIHRoaXMuZ2xvYmFsT3B0aW9ucyA9IGdsb2JhbE9wdGlvbnM7CiAgICB9CgogICAgdmFyIF9wcm90byA9IFF1ZXVlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8uc3RhY2tGb3IgPSBmdW5jdGlvbiBzdGFja0ZvcihpbmRleCkgewogICAgICBpZiAoaW5kZXggPCB0aGlzLl9xdWV1ZS5sZW5ndGgpIHsKICAgICAgICB2YXIgZW50cnkgPSB0aGlzLl9xdWV1ZVtpbmRleCAqIDMgKyBRVUVVRV9JVEVNX0xFTkdUSF07CgogICAgICAgIGlmIChlbnRyeSkgewogICAgICAgICAgcmV0dXJuIGVudHJ5LnN0YWNrOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLmZsdXNoID0gZnVuY3Rpb24gZmx1c2goc3luYykgewogICAgICB2YXIgX3RoaXMkb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKICAgICAgICAgIGJlZm9yZSA9IF90aGlzJG9wdGlvbnMuYmVmb3JlLAogICAgICAgICAgYWZ0ZXIgPSBfdGhpcyRvcHRpb25zLmFmdGVyOwogICAgICB2YXIgdGFyZ2V0OwogICAgICB2YXIgbWV0aG9kOwogICAgICB2YXIgYXJnczsKICAgICAgdmFyIGVycm9yUmVjb3JkZWRGb3JTdGFjazsKICAgICAgdGhpcy50YXJnZXRRdWV1ZXMuY2xlYXIoKTsKCiAgICAgIGlmICh0aGlzLl9xdWV1ZUJlaW5nRmx1c2hlZC5sZW5ndGggPT09IDApIHsKICAgICAgICB0aGlzLl9xdWV1ZUJlaW5nRmx1c2hlZCA9IHRoaXMuX3F1ZXVlOwogICAgICAgIHRoaXMuX3F1ZXVlID0gW107CiAgICAgIH0KCiAgICAgIGlmIChiZWZvcmUgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGJlZm9yZSgpOwogICAgICB9CgogICAgICB2YXIgaW52b2tlOwogICAgICB2YXIgcXVldWVJdGVtcyA9IHRoaXMuX3F1ZXVlQmVpbmdGbHVzaGVkOwoKICAgICAgaWYgKHF1ZXVlSXRlbXMubGVuZ3RoID4gMCkgewogICAgICAgIHZhciBvbkVycm9yID0gZ2V0T25FcnJvcih0aGlzLmdsb2JhbE9wdGlvbnMpOwogICAgICAgIGludm9rZSA9IG9uRXJyb3IgPyB0aGlzLmludm9rZVdpdGhPbkVycm9yIDogdGhpcy5pbnZva2U7CgogICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmluZGV4OyBpIDwgcXVldWVJdGVtcy5sZW5ndGg7IGkgKz0gUVVFVUVfSVRFTV9MRU5HVEgpIHsKICAgICAgICAgIHRoaXMuaW5kZXggKz0gUVVFVUVfSVRFTV9MRU5HVEg7CiAgICAgICAgICBtZXRob2QgPSBxdWV1ZUl0ZW1zW2kgKyAxXTsgLy8gbWV0aG9kIGNvdWxkIGhhdmUgYmVlbiBudWxsaWZpZWQgLyBjYW5jZWxlZCBkdXJpbmcgZmx1c2gKCiAgICAgICAgICBpZiAobWV0aG9kICE9PSBudWxsKSB7CiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vICAgICoqIEF0dGVudGlvbiBpbnRyZXBpZCBkZXZlbG9wZXIgKioKICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8gICAgVG8gZmluZCBvdXQgdGhlIHN0YWNrIG9mIHRoaXMgdGFzayB3aGVuIGl0IHdhcyBzY2hlZHVsZWQgb250bwogICAgICAgICAgICAvLyAgICB0aGUgcnVuIGxvb3AsIGFkZCB0aGUgZm9sbG93aW5nIHRvIHlvdXIgYXBwLmpzOgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyAgICBFbWJlci5ydW4uYmFja2J1cm5lci5ERUJVRyA9IHRydWU7IC8vIE5PVEU6IFRoaXMgc2xvd3MgeW91ciBhcHAsIGRvbid0IGxlYXZlIGl0IG9uIGluIHByb2R1Y3Rpb24uCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vICAgIE9uY2UgdGhhdCBpcyBpbiBwbGFjZSwgd2hlbiB5b3UgYXJlIGF0IGEgYnJlYWtwb2ludCBhbmQgbmF2aWdhdGUKICAgICAgICAgICAgLy8gICAgaGVyZSBpbiB0aGUgc3RhY2sgZXhwbG9yZXIsIHlvdSBjYW4gbG9vayBhdCBgZXJyb3JSZWNvcmRlZEZvclN0YWNrLnN0YWNrYCwKICAgICAgICAgICAgLy8gICAgd2hpY2ggd2lsbCBiZSB0aGUgY2FwdHVyZWQgc3RhY2sgd2hlbiB0aGlzIGpvYiB3YXMgc2NoZWR1bGVkLgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyAgICBPbmUgcG9zc2libGUgbG9uZy10ZXJtIHNvbHV0aW9uIGlzIHRoZSBmb2xsb3dpbmcgQ2hyb21lIGlzc3VlOgogICAgICAgICAgICAvLyAgICAgICBodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD0zMzI2MjQKICAgICAgICAgICAgLy8KICAgICAgICAgICAgdGFyZ2V0ID0gcXVldWVJdGVtc1tpXTsKICAgICAgICAgICAgYXJncyA9IHF1ZXVlSXRlbXNbaSArIDJdOwogICAgICAgICAgICBlcnJvclJlY29yZGVkRm9yU3RhY2sgPSBxdWV1ZUl0ZW1zW2kgKyAzXTsgLy8gRGVidWdnaW5nIGFzc2lzdGFuY2UKCiAgICAgICAgICAgIGludm9rZSh0YXJnZXQsIG1ldGhvZCwgYXJncywgb25FcnJvciwgZXJyb3JSZWNvcmRlZEZvclN0YWNrKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodGhpcy5pbmRleCAhPT0gdGhpcy5fcXVldWVCZWluZ0ZsdXNoZWQubGVuZ3RoICYmIHRoaXMuZ2xvYmFsT3B0aW9ucy5tdXN0WWllbGQgJiYgdGhpcy5nbG9iYWxPcHRpb25zLm11c3RZaWVsZCgpKSB7CiAgICAgICAgICAgIHJldHVybiAxCiAgICAgICAgICAgIC8qIFBhdXNlICovCiAgICAgICAgICAgIDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChhZnRlciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgYWZ0ZXIoKTsKICAgICAgfQoKICAgICAgdGhpcy5fcXVldWVCZWluZ0ZsdXNoZWQubGVuZ3RoID0gMDsKICAgICAgdGhpcy5pbmRleCA9IDA7CgogICAgICBpZiAoc3luYyAhPT0gZmFsc2UgJiYgdGhpcy5fcXVldWUubGVuZ3RoID4gMCkgewogICAgICAgIC8vIGNoZWNrIGlmIG5ldyBpdGVtcyBoYXZlIGJlZW4gYWRkZWQKICAgICAgICB0aGlzLmZsdXNoKHRydWUpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5oYXNXb3JrID0gZnVuY3Rpb24gaGFzV29yaygpIHsKICAgICAgcmV0dXJuIHRoaXMuX3F1ZXVlQmVpbmdGbHVzaGVkLmxlbmd0aCA+IDAgfHwgdGhpcy5fcXVldWUubGVuZ3RoID4gMDsKICAgIH07CgogICAgX3Byb3RvLmNhbmNlbCA9IGZ1bmN0aW9uIGNhbmNlbChfcmVmKSB7CiAgICAgIHZhciB0YXJnZXQgPSBfcmVmLnRhcmdldCwKICAgICAgICAgIG1ldGhvZCA9IF9yZWYubWV0aG9kOwogICAgICB2YXIgcXVldWUgPSB0aGlzLl9xdWV1ZTsKICAgICAgdmFyIHRhcmdldFF1ZXVlTWFwID0gdGhpcy50YXJnZXRRdWV1ZXMuZ2V0KHRhcmdldCk7CgogICAgICBpZiAodGFyZ2V0UXVldWVNYXAgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHRhcmdldFF1ZXVlTWFwLmRlbGV0ZShtZXRob2QpOwogICAgICB9CgogICAgICB2YXIgaW5kZXggPSBmaW5kSXRlbSh0YXJnZXQsIG1ldGhvZCwgcXVldWUpOwoKICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICBxdWV1ZS5zcGxpY2UoaW5kZXgsIFFVRVVFX0lURU1fTEVOR1RIKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSAvLyBpZiBub3QgZm91bmQgaW4gY3VycmVudCBxdWV1ZQogICAgICAvLyBjb3VsZCBiZSBpbiB0aGUgcXVldWUgdGhhdCBpcyBiZWluZyBmbHVzaGVkCgoKICAgICAgcXVldWUgPSB0aGlzLl9xdWV1ZUJlaW5nRmx1c2hlZDsKICAgICAgaW5kZXggPSBmaW5kSXRlbSh0YXJnZXQsIG1ldGhvZCwgcXVldWUpOwoKICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICBxdWV1ZVtpbmRleCArIDFdID0gbnVsbDsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICBfcHJvdG8ucHVzaCA9IGZ1bmN0aW9uIHB1c2godGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHN0YWNrKSB7CiAgICAgIHRoaXMuX3F1ZXVlLnB1c2godGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHN0YWNrKTsKCiAgICAgIHJldHVybiB7CiAgICAgICAgcXVldWU6IHRoaXMsCiAgICAgICAgdGFyZ2V0OiB0YXJnZXQsCiAgICAgICAgbWV0aG9kOiBtZXRob2QKICAgICAgfTsKICAgIH07CgogICAgX3Byb3RvLnB1c2hVbmlxdWUgPSBmdW5jdGlvbiBwdXNoVW5pcXVlKHRhcmdldCwgbWV0aG9kLCBhcmdzLCBzdGFjaykgewogICAgICB2YXIgbG9jYWxRdWV1ZU1hcCA9IHRoaXMudGFyZ2V0UXVldWVzLmdldCh0YXJnZXQpOwoKICAgICAgaWYgKGxvY2FsUXVldWVNYXAgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGxvY2FsUXVldWVNYXAgPSBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy50YXJnZXRRdWV1ZXMuc2V0KHRhcmdldCwgbG9jYWxRdWV1ZU1hcCk7CiAgICAgIH0KCiAgICAgIHZhciBpbmRleCA9IGxvY2FsUXVldWVNYXAuZ2V0KG1ldGhvZCk7CgogICAgICBpZiAoaW5kZXggPT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhciBxdWV1ZUluZGV4ID0gdGhpcy5fcXVldWUucHVzaCh0YXJnZXQsIG1ldGhvZCwgYXJncywgc3RhY2spIC0gUVVFVUVfSVRFTV9MRU5HVEg7CiAgICAgICAgbG9jYWxRdWV1ZU1hcC5zZXQobWV0aG9kLCBxdWV1ZUluZGV4KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcXVldWUgPSB0aGlzLl9xdWV1ZTsKICAgICAgICBxdWV1ZVtpbmRleCArIDJdID0gYXJnczsgLy8gcmVwbGFjZSBhcmdzCgogICAgICAgIHF1ZXVlW2luZGV4ICsgM10gPSBzdGFjazsgLy8gcmVwbGFjZSBzdGFjawogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIHF1ZXVlOiB0aGlzLAogICAgICAgIHRhcmdldDogdGFyZ2V0LAogICAgICAgIG1ldGhvZDogbWV0aG9kCiAgICAgIH07CiAgICB9OwoKICAgIF9wcm90by5fZ2V0RGVidWdJbmZvID0gZnVuY3Rpb24gX2dldERlYnVnSW5mbyhkZWJ1Z0VuYWJsZWQpIHsKICAgICAgaWYgKGRlYnVnRW5hYmxlZCkgewogICAgICAgIHZhciBkZWJ1Z0luZm8gPSBnZXRRdWV1ZUl0ZW1zKHRoaXMuX3F1ZXVlLCBRVUVVRV9JVEVNX0xFTkdUSCk7CiAgICAgICAgcmV0dXJuIGRlYnVnSW5mbzsKICAgICAgfQoKICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH07CgogICAgX3Byb3RvLmludm9rZSA9IGZ1bmN0aW9uIGludm9rZSh0YXJnZXQsIG1ldGhvZCwgYXJncwogICAgLyosIG9uRXJyb3IsIGVycm9yUmVjb3JkZWRGb3JTdGFjayAqLwogICAgKSB7CiAgICAgIGlmIChhcmdzID09PSB1bmRlZmluZWQpIHsKICAgICAgICBtZXRob2QuY2FsbCh0YXJnZXQpOwogICAgICB9IGVsc2UgewogICAgICAgIG1ldGhvZC5hcHBseSh0YXJnZXQsIGFyZ3MpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5pbnZva2VXaXRoT25FcnJvciA9IGZ1bmN0aW9uIGludm9rZVdpdGhPbkVycm9yKHRhcmdldCwgbWV0aG9kLCBhcmdzLCBvbkVycm9yLCBlcnJvclJlY29yZGVkRm9yU3RhY2spIHsKICAgICAgdHJ5IHsKICAgICAgICBpZiAoYXJncyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBtZXRob2QuY2FsbCh0YXJnZXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtZXRob2QuYXBwbHkodGFyZ2V0LCBhcmdzKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgb25FcnJvcihlcnJvciwgZXJyb3JSZWNvcmRlZEZvclN0YWNrKTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gUXVldWU7CiAgfSgpOwoKICB2YXIgRGVmZXJyZWRBY3Rpb25RdWV1ZXMgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBEZWZlcnJlZEFjdGlvblF1ZXVlcyhxdWV1ZU5hbWVzLCBvcHRpb25zKSB7CiAgICAgIGlmIChxdWV1ZU5hbWVzID09PSB2b2lkIDApIHsKICAgICAgICBxdWV1ZU5hbWVzID0gW107CiAgICAgIH0KCiAgICAgIHRoaXMucXVldWVzID0ge307CiAgICAgIHRoaXMucXVldWVOYW1lSW5kZXggPSAwOwogICAgICB0aGlzLnF1ZXVlTmFtZXMgPSBxdWV1ZU5hbWVzOwogICAgICBxdWV1ZU5hbWVzLnJlZHVjZShmdW5jdGlvbiAocXVldWVzLCBxdWV1ZU5hbWUpIHsKICAgICAgICBxdWV1ZXNbcXVldWVOYW1lXSA9IG5ldyBRdWV1ZShxdWV1ZU5hbWUsIG9wdGlvbnNbcXVldWVOYW1lXSwgb3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHF1ZXVlczsKICAgICAgfSwgdGhpcy5xdWV1ZXMpOwogICAgfQogICAgLyoqCiAgICAgKiBAbWV0aG9kIHNjaGVkdWxlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gcXVldWVOYW1lCiAgICAgKiBAcGFyYW0ge0FueX0gdGFyZ2V0CiAgICAgKiBAcGFyYW0ge0FueX0gbWV0aG9kCiAgICAgKiBAcGFyYW0ge0FueX0gYXJncwogICAgICogQHBhcmFtIHtCb29sZWFufSBvbmNlRmxhZwogICAgICogQHBhcmFtIHtBbnl9IHN0YWNrCiAgICAgKiBAcmV0dXJuIHF1ZXVlCiAgICAgKi8KCgogICAgdmFyIF9wcm90bzIgPSBEZWZlcnJlZEFjdGlvblF1ZXVlcy5wcm90b3R5cGU7CgogICAgX3Byb3RvMi5zY2hlZHVsZSA9IGZ1bmN0aW9uIHNjaGVkdWxlKHF1ZXVlTmFtZSwgdGFyZ2V0LCBtZXRob2QsIGFyZ3MsIG9uY2VGbGFnLCBzdGFjaykgewogICAgICB2YXIgcXVldWVzID0gdGhpcy5xdWV1ZXM7CiAgICAgIHZhciBxdWV1ZSA9IHF1ZXVlc1txdWV1ZU5hbWVdOwoKICAgICAgaWYgKHF1ZXVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIllvdSBhdHRlbXB0ZWQgdG8gc2NoZWR1bGUgYW4gYWN0aW9uIGluIGEgcXVldWUgKCIgKyBxdWV1ZU5hbWUgKyAiKSB0aGF0IGRvZXNuJ3QgZXhpc3QiKTsKICAgICAgfQoKICAgICAgaWYgKG1ldGhvZCA9PT0gdW5kZWZpbmVkIHx8IG1ldGhvZCA9PT0gbnVsbCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiWW91IGF0dGVtcHRlZCB0byBzY2hlZHVsZSBhbiBhY3Rpb24gaW4gYSBxdWV1ZSAoIiArIHF1ZXVlTmFtZSArICIpIGZvciBhIG1ldGhvZCB0aGF0IGRvZXNuJ3QgZXhpc3QiKTsKICAgICAgfQoKICAgICAgdGhpcy5xdWV1ZU5hbWVJbmRleCA9IDA7CgogICAgICBpZiAob25jZUZsYWcpIHsKICAgICAgICByZXR1cm4gcXVldWUucHVzaFVuaXF1ZSh0YXJnZXQsIG1ldGhvZCwgYXJncywgc3RhY2spOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBxdWV1ZS5wdXNoKHRhcmdldCwgbWV0aG9kLCBhcmdzLCBzdGFjayk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogRGVmZXJyZWRBY3Rpb25RdWV1ZXMuZmx1c2goKSBjYWxscyBRdWV1ZS5mbHVzaCgpCiAgICAgKgogICAgICogQG1ldGhvZCBmbHVzaAogICAgICogQHBhcmFtIHtCb29sZWFufSBmcm9tQXV0b3J1bgogICAgICovCiAgICA7CgogICAgX3Byb3RvMi5mbHVzaCA9IGZ1bmN0aW9uIGZsdXNoKGZyb21BdXRvcnVuKSB7CiAgICAgIGlmIChmcm9tQXV0b3J1biA9PT0gdm9pZCAwKSB7CiAgICAgICAgZnJvbUF1dG9ydW4gPSBmYWxzZTsKICAgICAgfQoKICAgICAgdmFyIHF1ZXVlOwogICAgICB2YXIgcXVldWVOYW1lOwogICAgICB2YXIgbnVtYmVyT2ZRdWV1ZXMgPSB0aGlzLnF1ZXVlTmFtZXMubGVuZ3RoOwoKICAgICAgd2hpbGUgKHRoaXMucXVldWVOYW1lSW5kZXggPCBudW1iZXJPZlF1ZXVlcykgewogICAgICAgIHF1ZXVlTmFtZSA9IHRoaXMucXVldWVOYW1lc1t0aGlzLnF1ZXVlTmFtZUluZGV4XTsKICAgICAgICBxdWV1ZSA9IHRoaXMucXVldWVzW3F1ZXVlTmFtZV07CgogICAgICAgIGlmIChxdWV1ZS5oYXNXb3JrKCkgPT09IGZhbHNlKSB7CiAgICAgICAgICB0aGlzLnF1ZXVlTmFtZUluZGV4Kys7CgogICAgICAgICAgaWYgKGZyb21BdXRvcnVuICYmIHRoaXMucXVldWVOYW1lSW5kZXggPCBudW1iZXJPZlF1ZXVlcykgewogICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICAvKiBQYXVzZSAqLwogICAgICAgICAgICA7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChxdWV1ZS5mbHVzaChmYWxzZQogICAgICAgICAgLyogYXN5bmMgKi8KICAgICAgICAgICkgPT09IDEKICAgICAgICAgIC8qIFBhdXNlICovCiAgICAgICAgICApIHsKICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICAgIC8qIFBhdXNlICovCiAgICAgICAgICAgICAgOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgZGVidWcgaW5mb3JtYXRpb24gZm9yIHRoZSBjdXJyZW50IHF1ZXVlcy4KICAgICAqCiAgICAgKiBAbWV0aG9kIF9nZXREZWJ1Z0luZm8KICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gZGVidWdFbmFibGVkCiAgICAgKiBAcmV0dXJucyB7SURlYnVnSW5mbyB8IHVuZGVmaW5lZH0KICAgICAqLwogICAgOwoKICAgIF9wcm90bzIuX2dldERlYnVnSW5mbyA9IGZ1bmN0aW9uIF9nZXREZWJ1Z0luZm8oZGVidWdFbmFibGVkKSB7CiAgICAgIGlmIChkZWJ1Z0VuYWJsZWQpIHsKICAgICAgICB2YXIgZGVidWdJbmZvID0ge307CiAgICAgICAgdmFyIHF1ZXVlOwogICAgICAgIHZhciBxdWV1ZU5hbWU7CiAgICAgICAgdmFyIG51bWJlck9mUXVldWVzID0gdGhpcy5xdWV1ZU5hbWVzLmxlbmd0aDsKICAgICAgICB2YXIgaSA9IDA7CgogICAgICAgIHdoaWxlIChpIDwgbnVtYmVyT2ZRdWV1ZXMpIHsKICAgICAgICAgIHF1ZXVlTmFtZSA9IHRoaXMucXVldWVOYW1lc1tpXTsKICAgICAgICAgIHF1ZXVlID0gdGhpcy5xdWV1ZXNbcXVldWVOYW1lXTsKICAgICAgICAgIGRlYnVnSW5mb1txdWV1ZU5hbWVdID0gcXVldWUuX2dldERlYnVnSW5mbyhkZWJ1Z0VuYWJsZWQpOwogICAgICAgICAgaSsrOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRlYnVnSW5mbzsKICAgICAgfQoKICAgICAgcmV0dXJuOwogICAgfTsKCiAgICByZXR1cm4gRGVmZXJyZWRBY3Rpb25RdWV1ZXM7CiAgfSgpOwoKICBmdW5jdGlvbiBpdGVyYXRvckRyYWluKGZuKSB7CiAgICB2YXIgaXRlcmF0b3IgPSBmbigpOwogICAgdmFyIHJlc3VsdCA9IGl0ZXJhdG9yLm5leHQoKTsKCiAgICB3aGlsZSAocmVzdWx0LmRvbmUgPT09IGZhbHNlKSB7CiAgICAgIHJlc3VsdC52YWx1ZSgpOwogICAgICByZXN1bHQgPSBpdGVyYXRvci5uZXh0KCk7CiAgICB9CiAgfQoKICB2YXIgbm9vcCA9IGZ1bmN0aW9uIG5vb3AoKSB7fTsKCiAgdmFyIERJU0FCTEVfU0NIRURVTEUgPSBPYmplY3QuZnJlZXplKFtdKTsKCiAgZnVuY3Rpb24gcGFyc2VBcmdzKCkgewogICAgdmFyIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICB2YXIgYXJnczsKICAgIHZhciBtZXRob2Q7CiAgICB2YXIgdGFyZ2V0OwoKICAgIGlmIChsZW5ndGggPT09IDApIHt9IGVsc2UgaWYgKGxlbmd0aCA9PT0gMSkgewogICAgICB0YXJnZXQgPSBudWxsOwogICAgICBtZXRob2QgPSBhcmd1bWVudHNbMF07CiAgICB9IGVsc2UgewogICAgICB2YXIgYXJnc0luZGV4ID0gMjsKICAgICAgdmFyIG1ldGhvZE9yVGFyZ2V0ID0gYXJndW1lbnRzWzBdOwogICAgICB2YXIgbWV0aG9kT3JBcmdzID0gYXJndW1lbnRzWzFdOwogICAgICB2YXIgdHlwZSA9IHR5cGVvZiBtZXRob2RPckFyZ3M7CgogICAgICBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRhcmdldCA9IG1ldGhvZE9yVGFyZ2V0OwogICAgICAgIG1ldGhvZCA9IG1ldGhvZE9yQXJnczsKICAgICAgfSBlbHNlIGlmIChtZXRob2RPclRhcmdldCAhPT0gbnVsbCAmJiB0eXBlID09PSAnc3RyaW5nJyAmJiBtZXRob2RPckFyZ3MgaW4gbWV0aG9kT3JUYXJnZXQpIHsKICAgICAgICB0YXJnZXQgPSBtZXRob2RPclRhcmdldDsKICAgICAgICBtZXRob2QgPSB0YXJnZXRbbWV0aG9kT3JBcmdzXTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbWV0aG9kT3JUYXJnZXQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBhcmdzSW5kZXggPSAxOwogICAgICAgIHRhcmdldCA9IG51bGw7CiAgICAgICAgbWV0aG9kID0gbWV0aG9kT3JUYXJnZXQ7CiAgICAgIH0KCiAgICAgIGlmIChsZW5ndGggPiBhcmdzSW5kZXgpIHsKICAgICAgICB2YXIgbGVuID0gbGVuZ3RoIC0gYXJnc0luZGV4OwogICAgICAgIGFyZ3MgPSBuZXcgQXJyYXkobGVuKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgYXJnc1tpXSA9IGFyZ3VtZW50c1tpICsgYXJnc0luZGV4XTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gW3RhcmdldCwgbWV0aG9kLCBhcmdzXTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlVGltZXJBcmdzKCkgewogICAgdmFyIF9wYXJzZUFyZ3MgPSBwYXJzZUFyZ3MuYXBwbHkodm9pZCAwLCBhcmd1bWVudHMpLAogICAgICAgIHRhcmdldCA9IF9wYXJzZUFyZ3NbMF0sCiAgICAgICAgbWV0aG9kID0gX3BhcnNlQXJnc1sxXSwKICAgICAgICBhcmdzID0gX3BhcnNlQXJnc1syXTsKCiAgICB2YXIgd2FpdCA9IDA7CiAgICB2YXIgbGVuZ3RoID0gYXJncyAhPT0gdW5kZWZpbmVkID8gYXJncy5sZW5ndGggOiAwOwoKICAgIGlmIChsZW5ndGggPiAwKSB7CiAgICAgIHZhciBsYXN0ID0gYXJnc1tsZW5ndGggLSAxXTsKCiAgICAgIGlmIChpc0NvZXJjYWJsZU51bWJlcihsYXN0KSkgewogICAgICAgIHdhaXQgPSBwYXJzZUludChhcmdzLnBvcCgpLCAxMCk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gW3RhcmdldCwgbWV0aG9kLCBhcmdzLCB3YWl0XTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlRGVib3VuY2VBcmdzKCkgewogICAgdmFyIHRhcmdldDsKICAgIHZhciBtZXRob2Q7CiAgICB2YXIgaXNJbW1lZGlhdGU7CiAgICB2YXIgYXJnczsKICAgIHZhciB3YWl0OwoKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICAgIG1ldGhvZCA9IGFyZ3VtZW50c1swXTsKICAgICAgd2FpdCA9IGFyZ3VtZW50c1sxXTsKICAgICAgdGFyZ2V0ID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBfcGFyc2VBcmdzMiA9IHBhcnNlQXJncy5hcHBseSh2b2lkIDAsIGFyZ3VtZW50cyk7CgogICAgICB0YXJnZXQgPSBfcGFyc2VBcmdzMlswXTsKICAgICAgbWV0aG9kID0gX3BhcnNlQXJnczJbMV07CiAgICAgIGFyZ3MgPSBfcGFyc2VBcmdzMlsyXTsKCiAgICAgIGlmIChhcmdzID09PSB1bmRlZmluZWQpIHsKICAgICAgICB3YWl0ID0gMDsKICAgICAgfSBlbHNlIHsKICAgICAgICB3YWl0ID0gYXJncy5wb3AoKTsKCiAgICAgICAgaWYgKCFpc0NvZXJjYWJsZU51bWJlcih3YWl0KSkgewogICAgICAgICAgaXNJbW1lZGlhdGUgPSB3YWl0ID09PSB0cnVlOwogICAgICAgICAgd2FpdCA9IGFyZ3MucG9wKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgd2FpdCA9IHBhcnNlSW50KHdhaXQsIDEwKTsKICAgIHJldHVybiBbdGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHdhaXQsIGlzSW1tZWRpYXRlXTsKICB9CgogIHZhciBVVUlEID0gMDsKICB2YXIgYmVnaW5Db3VudCA9IDA7CiAgdmFyIGVuZENvdW50ID0gMDsKICB2YXIgYmVnaW5FdmVudENvdW50ID0gMDsKICB2YXIgZW5kRXZlbnRDb3VudCA9IDA7CiAgdmFyIHJ1bkNvdW50ID0gMDsKICB2YXIgam9pbkNvdW50ID0gMDsKICB2YXIgZGVmZXJDb3VudCA9IDA7CiAgdmFyIHNjaGVkdWxlQ291bnQgPSAwOwogIHZhciBzY2hlZHVsZUl0ZXJhYmxlQ291bnQgPSAwOwogIHZhciBkZWZlck9uY2VDb3VudCA9IDA7CiAgdmFyIHNjaGVkdWxlT25jZUNvdW50ID0gMDsKICB2YXIgc2V0VGltZW91dENvdW50ID0gMDsKICB2YXIgbGF0ZXJDb3VudCA9IDA7CiAgdmFyIHRocm90dGxlQ291bnQgPSAwOwogIHZhciBkZWJvdW5jZUNvdW50ID0gMDsKICB2YXIgY2FuY2VsVGltZXJzQ291bnQgPSAwOwogIHZhciBjYW5jZWxDb3VudCA9IDA7CiAgdmFyIGF1dG9ydW5zQ3JlYXRlZENvdW50ID0gMDsKICB2YXIgYXV0b3J1bnNDb21wbGV0ZWRDb3VudCA9IDA7CiAgdmFyIGRlZmVycmVkQWN0aW9uUXVldWVzQ3JlYXRlZENvdW50ID0gMDsKICB2YXIgbmVzdGVkRGVmZXJyZWRBY3Rpb25RdWV1ZXNDcmVhdGVkID0gMDsKCiAgdmFyIEJhY2tidXJuZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBCYWNrYnVybmVyKHF1ZXVlTmFtZXMsIG9wdGlvbnMpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHRoaXMuREVCVUcgPSBmYWxzZTsKICAgICAgdGhpcy5jdXJyZW50SW5zdGFuY2UgPSBudWxsOwogICAgICB0aGlzLmluc3RhbmNlU3RhY2sgPSBbXTsKICAgICAgdGhpcy5fZXZlbnRDYWxsYmFja3MgPSB7CiAgICAgICAgZW5kOiBbXSwKICAgICAgICBiZWdpbjogW10KICAgICAgfTsKICAgICAgdGhpcy5fdGltZXJUaW1lb3V0SWQgPSBudWxsOwogICAgICB0aGlzLl90aW1lcnMgPSBbXTsKICAgICAgdGhpcy5fYXV0b3J1biA9IGZhbHNlOwogICAgICB0aGlzLl9hdXRvcnVuU3RhY2sgPSBudWxsOwogICAgICB0aGlzLnF1ZXVlTmFtZXMgPSBxdWV1ZU5hbWVzOwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgaWYgKHR5cGVvZiB0aGlzLm9wdGlvbnMuZGVmYXVsdFF1ZXVlID09PSAnc3RyaW5nJykgewogICAgICAgIHRoaXMuX2RlZmF1bHRRdWV1ZSA9IHRoaXMub3B0aW9ucy5kZWZhdWx0UXVldWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZGVmYXVsdFF1ZXVlID0gdGhpcy5xdWV1ZU5hbWVzWzBdOwogICAgICB9CgogICAgICB0aGlzLl9vbkJlZ2luID0gdGhpcy5vcHRpb25zLm9uQmVnaW4gfHwgbm9vcDsKICAgICAgdGhpcy5fb25FbmQgPSB0aGlzLm9wdGlvbnMub25FbmQgfHwgbm9vcDsKICAgICAgdGhpcy5fYm91bmRSdW5FeHBpcmVkVGltZXJzID0gdGhpcy5fcnVuRXhwaXJlZFRpbWVycy5iaW5kKHRoaXMpOwoKICAgICAgdGhpcy5fYm91bmRBdXRvcnVuRW5kID0gZnVuY3Rpb24gKCkgewogICAgICAgIGF1dG9ydW5zQ29tcGxldGVkQ291bnQrKzsgLy8gaWYgdGhlIGF1dG9ydW4gd2FzIGFscmVhZHkgZmx1c2hlZCwgZG8gbm90aGluZwoKICAgICAgICBpZiAoX3RoaXMuX2F1dG9ydW4gPT09IGZhbHNlKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBfdGhpcy5fYXV0b3J1biA9IGZhbHNlOwogICAgICAgIF90aGlzLl9hdXRvcnVuU3RhY2sgPSBudWxsOwoKICAgICAgICBfdGhpcy5fZW5kKHRydWUKICAgICAgICAvKiBmcm9tQXV0b3J1biAqLwogICAgICAgICk7CiAgICAgIH07CgogICAgICB2YXIgYnVpbGRlciA9IHRoaXMub3B0aW9ucy5fYnVpbGRQbGF0Zm9ybSB8fCBidWlsZFBsYXRmb3JtOwogICAgICB0aGlzLl9wbGF0Zm9ybSA9IGJ1aWxkZXIodGhpcy5fYm91bmRBdXRvcnVuRW5kKTsKICAgIH0KCiAgICB2YXIgX3Byb3RvMyA9IEJhY2tidXJuZXIucHJvdG90eXBlOwoKICAgIC8qCiAgICAgIEBtZXRob2QgYmVnaW4KICAgICAgQHJldHVybiBpbnN0YW50aWF0ZWQgY2xhc3MgRGVmZXJyZWRBY3Rpb25RdWV1ZXMKICAgICovCiAgICBfcHJvdG8zLmJlZ2luID0gZnVuY3Rpb24gYmVnaW4oKSB7CiAgICAgIGJlZ2luQ291bnQrKzsKICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgIHZhciBwcmV2aW91c0luc3RhbmNlID0gdGhpcy5jdXJyZW50SW5zdGFuY2U7CiAgICAgIHZhciBjdXJyZW50OwoKICAgICAgaWYgKHRoaXMuX2F1dG9ydW4gIT09IGZhbHNlKSB7CiAgICAgICAgY3VycmVudCA9IHByZXZpb3VzSW5zdGFuY2U7CgogICAgICAgIHRoaXMuX2NhbmNlbEF1dG9ydW4oKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAocHJldmlvdXNJbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgbmVzdGVkRGVmZXJyZWRBY3Rpb25RdWV1ZXNDcmVhdGVkKys7CiAgICAgICAgICB0aGlzLmluc3RhbmNlU3RhY2sucHVzaChwcmV2aW91c0luc3RhbmNlKTsKICAgICAgICB9CgogICAgICAgIGRlZmVycmVkQWN0aW9uUXVldWVzQ3JlYXRlZENvdW50Kys7CiAgICAgICAgY3VycmVudCA9IHRoaXMuY3VycmVudEluc3RhbmNlID0gbmV3IERlZmVycmVkQWN0aW9uUXVldWVzKHRoaXMucXVldWVOYW1lcywgb3B0aW9ucyk7CiAgICAgICAgYmVnaW5FdmVudENvdW50Kys7CgogICAgICAgIHRoaXMuX3RyaWdnZXIoJ2JlZ2luJywgY3VycmVudCwgcHJldmlvdXNJbnN0YW5jZSk7CiAgICAgIH0KCiAgICAgIHRoaXMuX29uQmVnaW4oY3VycmVudCwgcHJldmlvdXNJbnN0YW5jZSk7CgogICAgICByZXR1cm4gY3VycmVudDsKICAgIH07CgogICAgX3Byb3RvMy5lbmQgPSBmdW5jdGlvbiBlbmQoKSB7CiAgICAgIGVuZENvdW50Kys7CgogICAgICB0aGlzLl9lbmQoZmFsc2UpOwogICAgfTsKCiAgICBfcHJvdG8zLm9uID0gZnVuY3Rpb24gb24oZXZlbnROYW1lLCBjYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2FsbGJhY2sgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICAgIH0KCiAgICAgIHZhciBjYWxsYmFja3MgPSB0aGlzLl9ldmVudENhbGxiYWNrc1tldmVudE5hbWVdOwoKICAgICAgaWYgKGNhbGxiYWNrcyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgY2FsbGJhY2tzLnB1c2goY2FsbGJhY2spOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBvbigpIGV2ZW50ICIgKyBldmVudE5hbWUgKyAiIGJlY2F1c2UgaXQgZG9lcyBub3QgZXhpc3QiKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8zLm9mZiA9IGZ1bmN0aW9uIG9mZihldmVudE5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBjYWxsYmFja3MgPSB0aGlzLl9ldmVudENhbGxiYWNrc1tldmVudE5hbWVdOwoKICAgICAgaWYgKCFldmVudE5hbWUgfHwgY2FsbGJhY2tzID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3Qgb2ZmKCkgZXZlbnQgIiArIGV2ZW50TmFtZSArICIgYmVjYXVzZSBpdCBkb2VzIG5vdCBleGlzdCIpOwogICAgICB9CgogICAgICB2YXIgY2FsbGJhY2tGb3VuZCA9IGZhbHNlOwoKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjYWxsYmFja3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChjYWxsYmFja3NbaV0gPT09IGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNhbGxiYWNrRm91bmQgPSB0cnVlOwogICAgICAgICAgICBjYWxsYmFja3Muc3BsaWNlKGksIDEpOwogICAgICAgICAgICBpLS07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIWNhbGxiYWNrRm91bmQpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3Qgb2ZmKCkgY2FsbGJhY2sgdGhhdCBkb2VzIG5vdCBleGlzdCIpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzMucnVuID0gZnVuY3Rpb24gcnVuKCkgewogICAgICBydW5Db3VudCsrOwoKICAgICAgdmFyIF9wYXJzZUFyZ3MzID0gcGFyc2VBcmdzLmFwcGx5KHZvaWQgMCwgYXJndW1lbnRzKSwKICAgICAgICAgIHRhcmdldCA9IF9wYXJzZUFyZ3MzWzBdLAogICAgICAgICAgbWV0aG9kID0gX3BhcnNlQXJnczNbMV0sCiAgICAgICAgICBhcmdzID0gX3BhcnNlQXJnczNbMl07CgogICAgICByZXR1cm4gdGhpcy5fcnVuKHRhcmdldCwgbWV0aG9kLCBhcmdzKTsKICAgIH07CgogICAgX3Byb3RvMy5qb2luID0gZnVuY3Rpb24gam9pbigpIHsKICAgICAgam9pbkNvdW50Kys7CgogICAgICB2YXIgX3BhcnNlQXJnczQgPSBwYXJzZUFyZ3MuYXBwbHkodm9pZCAwLCBhcmd1bWVudHMpLAogICAgICAgICAgdGFyZ2V0ID0gX3BhcnNlQXJnczRbMF0sCiAgICAgICAgICBtZXRob2QgPSBfcGFyc2VBcmdzNFsxXSwKICAgICAgICAgIGFyZ3MgPSBfcGFyc2VBcmdzNFsyXTsKCiAgICAgIHJldHVybiB0aGlzLl9qb2luKHRhcmdldCwgbWV0aG9kLCBhcmdzKTsKICAgIH0KICAgIC8qKgogICAgICogQGRlcHJlY2F0ZWQgcGxlYXNlIHVzZSBzY2hlZHVsZSBpbnN0ZWFkLgogICAgICovCiAgICA7CgogICAgX3Byb3RvMy5kZWZlciA9IGZ1bmN0aW9uIGRlZmVyKHF1ZXVlTmFtZSwgdGFyZ2V0LCBtZXRob2QpIHsKICAgICAgZGVmZXJDb3VudCsrOwoKICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiA+IDMgPyBfbGVuIC0gMyA6IDApLCBfa2V5ID0gMzsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleSAtIDNdID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5zY2hlZHVsZS5hcHBseSh0aGlzLCBbcXVldWVOYW1lLCB0YXJnZXQsIG1ldGhvZF0uY29uY2F0KGFyZ3MpKTsKICAgIH07CgogICAgX3Byb3RvMy5zY2hlZHVsZSA9IGZ1bmN0aW9uIHNjaGVkdWxlKHF1ZXVlTmFtZSkgewogICAgICBzY2hlZHVsZUNvdW50Kys7CgogICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIF9hcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICBfYXJnc1tfa2V5MiAtIDFdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgfQoKICAgICAgdmFyIF9wYXJzZUFyZ3M1ID0gcGFyc2VBcmdzLmFwcGx5KHZvaWQgMCwgX2FyZ3MpLAogICAgICAgICAgdGFyZ2V0ID0gX3BhcnNlQXJnczVbMF0sCiAgICAgICAgICBtZXRob2QgPSBfcGFyc2VBcmdzNVsxXSwKICAgICAgICAgIGFyZ3MgPSBfcGFyc2VBcmdzNVsyXTsKCiAgICAgIHZhciBzdGFjayA9IHRoaXMuREVCVUcgPyBuZXcgRXJyb3IoKSA6IHVuZGVmaW5lZDsKICAgICAgcmV0dXJuIHRoaXMuX2Vuc3VyZUluc3RhbmNlKCkuc2NoZWR1bGUocXVldWVOYW1lLCB0YXJnZXQsIG1ldGhvZCwgYXJncywgZmFsc2UsIHN0YWNrKTsKICAgIH0KICAgIC8qCiAgICAgIERlZmVyIHRoZSBwYXNzZWQgaXRlcmFibGUgb2YgZnVuY3Rpb25zIHRvIHJ1biBpbnNpZGUgdGhlIHNwZWNpZmllZCBxdWV1ZS4KICAgICAgICAgQG1ldGhvZCBzY2hlZHVsZUl0ZXJhYmxlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBxdWV1ZU5hbWUKICAgICAgQHBhcmFtIHtJdGVyYWJsZX0gYW4gaXRlcmFibGUgb2YgZnVuY3Rpb25zIHRvIGV4ZWN1dGUKICAgICAgQHJldHVybiBtZXRob2QgcmVzdWx0CiAgICAqLwogICAgOwoKICAgIF9wcm90bzMuc2NoZWR1bGVJdGVyYWJsZSA9IGZ1bmN0aW9uIHNjaGVkdWxlSXRlcmFibGUocXVldWVOYW1lLCBpdGVyYWJsZSkgewogICAgICBzY2hlZHVsZUl0ZXJhYmxlQ291bnQrKzsKICAgICAgdmFyIHN0YWNrID0gdGhpcy5ERUJVRyA/IG5ldyBFcnJvcigpIDogdW5kZWZpbmVkOwogICAgICByZXR1cm4gdGhpcy5fZW5zdXJlSW5zdGFuY2UoKS5zY2hlZHVsZShxdWV1ZU5hbWUsIG51bGwsIGl0ZXJhdG9yRHJhaW4sIFtpdGVyYWJsZV0sIGZhbHNlLCBzdGFjayk7CiAgICB9CiAgICAvKioKICAgICAqIEBkZXByZWNhdGVkIHBsZWFzZSB1c2Ugc2NoZWR1bGVPbmNlIGluc3RlYWQuCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8zLmRlZmVyT25jZSA9IGZ1bmN0aW9uIGRlZmVyT25jZShxdWV1ZU5hbWUsIHRhcmdldCwgbWV0aG9kKSB7CiAgICAgIGRlZmVyT25jZUNvdW50Kys7CgogICAgICBmb3IgKHZhciBfbGVuMyA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjMgPiAzID8gX2xlbjMgLSAzIDogMCksIF9rZXkzID0gMzsgX2tleTMgPCBfbGVuMzsgX2tleTMrKykgewogICAgICAgIGFyZ3NbX2tleTMgLSAzXSA9IGFyZ3VtZW50c1tfa2V5M107CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLnNjaGVkdWxlT25jZS5hcHBseSh0aGlzLCBbcXVldWVOYW1lLCB0YXJnZXQsIG1ldGhvZF0uY29uY2F0KGFyZ3MpKTsKICAgIH07CgogICAgX3Byb3RvMy5zY2hlZHVsZU9uY2UgPSBmdW5jdGlvbiBzY2hlZHVsZU9uY2UocXVldWVOYW1lKSB7CiAgICAgIHNjaGVkdWxlT25jZUNvdW50Kys7CgogICAgICBmb3IgKHZhciBfbGVuNCA9IGFyZ3VtZW50cy5sZW5ndGgsIF9hcmdzID0gbmV3IEFycmF5KF9sZW40ID4gMSA/IF9sZW40IC0gMSA6IDApLCBfa2V5NCA9IDE7IF9rZXk0IDwgX2xlbjQ7IF9rZXk0KyspIHsKICAgICAgICBfYXJnc1tfa2V5NCAtIDFdID0gYXJndW1lbnRzW19rZXk0XTsKICAgICAgfQoKICAgICAgdmFyIF9wYXJzZUFyZ3M2ID0gcGFyc2VBcmdzLmFwcGx5KHZvaWQgMCwgX2FyZ3MpLAogICAgICAgICAgdGFyZ2V0ID0gX3BhcnNlQXJnczZbMF0sCiAgICAgICAgICBtZXRob2QgPSBfcGFyc2VBcmdzNlsxXSwKICAgICAgICAgIGFyZ3MgPSBfcGFyc2VBcmdzNlsyXTsKCiAgICAgIHZhciBzdGFjayA9IHRoaXMuREVCVUcgPyBuZXcgRXJyb3IoKSA6IHVuZGVmaW5lZDsKICAgICAgcmV0dXJuIHRoaXMuX2Vuc3VyZUluc3RhbmNlKCkuc2NoZWR1bGUocXVldWVOYW1lLCB0YXJnZXQsIG1ldGhvZCwgYXJncywgdHJ1ZSwgc3RhY2spOwogICAgfTsKCiAgICBfcHJvdG8zLnNldFRpbWVvdXQgPSBmdW5jdGlvbiBzZXRUaW1lb3V0KCkgewogICAgICBzZXRUaW1lb3V0Q291bnQrKzsKICAgICAgcmV0dXJuIHRoaXMubGF0ZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH07CgogICAgX3Byb3RvMy5sYXRlciA9IGZ1bmN0aW9uIGxhdGVyKCkgewogICAgICBsYXRlckNvdW50Kys7CgogICAgICB2YXIgX3BhcnNlVGltZXJBcmdzID0gcGFyc2VUaW1lckFyZ3MuYXBwbHkodm9pZCAwLCBhcmd1bWVudHMpLAogICAgICAgICAgdGFyZ2V0ID0gX3BhcnNlVGltZXJBcmdzWzBdLAogICAgICAgICAgbWV0aG9kID0gX3BhcnNlVGltZXJBcmdzWzFdLAogICAgICAgICAgYXJncyA9IF9wYXJzZVRpbWVyQXJnc1syXSwKICAgICAgICAgIHdhaXQgPSBfcGFyc2VUaW1lckFyZ3NbM107CgogICAgICByZXR1cm4gdGhpcy5fbGF0ZXIodGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHdhaXQpOwogICAgfTsKCiAgICBfcHJvdG8zLnRocm90dGxlID0gZnVuY3Rpb24gdGhyb3R0bGUoKSB7CiAgICAgIHRocm90dGxlQ291bnQrKzsKCiAgICAgIHZhciBfcGFyc2VEZWJvdW5jZUFyZ3MgPSBwYXJzZURlYm91bmNlQXJncy5hcHBseSh2b2lkIDAsIGFyZ3VtZW50cyksCiAgICAgICAgICB0YXJnZXQgPSBfcGFyc2VEZWJvdW5jZUFyZ3NbMF0sCiAgICAgICAgICBtZXRob2QgPSBfcGFyc2VEZWJvdW5jZUFyZ3NbMV0sCiAgICAgICAgICBhcmdzID0gX3BhcnNlRGVib3VuY2VBcmdzWzJdLAogICAgICAgICAgd2FpdCA9IF9wYXJzZURlYm91bmNlQXJnc1szXSwKICAgICAgICAgIF9wYXJzZURlYm91bmNlQXJncyQgPSBfcGFyc2VEZWJvdW5jZUFyZ3NbNF0sCiAgICAgICAgICBpc0ltbWVkaWF0ZSA9IF9wYXJzZURlYm91bmNlQXJncyQgPT09IHZvaWQgMCA/IHRydWUgOiBfcGFyc2VEZWJvdW5jZUFyZ3MkOwoKICAgICAgdmFyIGluZGV4ID0gZmluZFRpbWVySXRlbSh0YXJnZXQsIG1ldGhvZCwgdGhpcy5fdGltZXJzKTsKICAgICAgdmFyIHRpbWVySWQ7CgogICAgICBpZiAoaW5kZXggPT09IC0xKSB7CiAgICAgICAgdGltZXJJZCA9IHRoaXMuX2xhdGVyKHRhcmdldCwgbWV0aG9kLCBpc0ltbWVkaWF0ZSA/IERJU0FCTEVfU0NIRURVTEUgOiBhcmdzLCB3YWl0KTsKCiAgICAgICAgaWYgKGlzSW1tZWRpYXRlKSB7CiAgICAgICAgICB0aGlzLl9qb2luKHRhcmdldCwgbWV0aG9kLCBhcmdzKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGltZXJJZCA9IHRoaXMuX3RpbWVyc1tpbmRleCArIDFdOwogICAgICAgIHZhciBhcmdJbmRleCA9IGluZGV4ICsgNDsKCiAgICAgICAgaWYgKHRoaXMuX3RpbWVyc1thcmdJbmRleF0gIT09IERJU0FCTEVfU0NIRURVTEUpIHsKICAgICAgICAgIHRoaXMuX3RpbWVyc1thcmdJbmRleF0gPSBhcmdzOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRpbWVySWQ7CiAgICB9OwoKICAgIF9wcm90bzMuZGVib3VuY2UgPSBmdW5jdGlvbiBkZWJvdW5jZSgpIHsKICAgICAgZGVib3VuY2VDb3VudCsrOwoKICAgICAgdmFyIF9wYXJzZURlYm91bmNlQXJnczIgPSBwYXJzZURlYm91bmNlQXJncy5hcHBseSh2b2lkIDAsIGFyZ3VtZW50cyksCiAgICAgICAgICB0YXJnZXQgPSBfcGFyc2VEZWJvdW5jZUFyZ3MyWzBdLAogICAgICAgICAgbWV0aG9kID0gX3BhcnNlRGVib3VuY2VBcmdzMlsxXSwKICAgICAgICAgIGFyZ3MgPSBfcGFyc2VEZWJvdW5jZUFyZ3MyWzJdLAogICAgICAgICAgd2FpdCA9IF9wYXJzZURlYm91bmNlQXJnczJbM10sCiAgICAgICAgICBfcGFyc2VEZWJvdW5jZUFyZ3MyJCA9IF9wYXJzZURlYm91bmNlQXJnczJbNF0sCiAgICAgICAgICBpc0ltbWVkaWF0ZSA9IF9wYXJzZURlYm91bmNlQXJnczIkID09PSB2b2lkIDAgPyBmYWxzZSA6IF9wYXJzZURlYm91bmNlQXJnczIkOwoKICAgICAgdmFyIF90aW1lcnMgPSB0aGlzLl90aW1lcnM7CiAgICAgIHZhciBpbmRleCA9IGZpbmRUaW1lckl0ZW0odGFyZ2V0LCBtZXRob2QsIF90aW1lcnMpOwogICAgICB2YXIgdGltZXJJZDsKCiAgICAgIGlmIChpbmRleCA9PT0gLTEpIHsKICAgICAgICB0aW1lcklkID0gdGhpcy5fbGF0ZXIodGFyZ2V0LCBtZXRob2QsIGlzSW1tZWRpYXRlID8gRElTQUJMRV9TQ0hFRFVMRSA6IGFyZ3MsIHdhaXQpOwoKICAgICAgICBpZiAoaXNJbW1lZGlhdGUpIHsKICAgICAgICAgIHRoaXMuX2pvaW4odGFyZ2V0LCBtZXRob2QsIGFyZ3MpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgZXhlY3V0ZUF0ID0gdGhpcy5fcGxhdGZvcm0ubm93KCkgKyB3YWl0OwogICAgICAgIHZhciBhcmdJbmRleCA9IGluZGV4ICsgNDsKCiAgICAgICAgaWYgKF90aW1lcnNbYXJnSW5kZXhdID09PSBESVNBQkxFX1NDSEVEVUxFKSB7CiAgICAgICAgICBhcmdzID0gRElTQUJMRV9TQ0hFRFVMRTsKICAgICAgICB9CgogICAgICAgIHRpbWVySWQgPSBfdGltZXJzW2luZGV4ICsgMV07CiAgICAgICAgdmFyIGkgPSBiaW5hcnlTZWFyY2goZXhlY3V0ZUF0LCBfdGltZXJzKTsKCiAgICAgICAgaWYgKGluZGV4ICsgVElNRVJTX09GRlNFVCA9PT0gaSkgewogICAgICAgICAgX3RpbWVyc1tpbmRleF0gPSBleGVjdXRlQXQ7CiAgICAgICAgICBfdGltZXJzW2FyZ0luZGV4XSA9IGFyZ3M7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBzdGFjayA9IHRoaXMuX3RpbWVyc1tpbmRleCArIDVdOwoKICAgICAgICAgIHRoaXMuX3RpbWVycy5zcGxpY2UoaSwgMCwgZXhlY3V0ZUF0LCB0aW1lcklkLCB0YXJnZXQsIG1ldGhvZCwgYXJncywgc3RhY2spOwoKICAgICAgICAgIHRoaXMuX3RpbWVycy5zcGxpY2UoaW5kZXgsIFRJTUVSU19PRkZTRVQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7CiAgICAgICAgICB0aGlzLl9yZWluc3RhbGxUaW1lclRpbWVvdXQoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aW1lcklkOwogICAgfTsKCiAgICBfcHJvdG8zLmNhbmNlbFRpbWVycyA9IGZ1bmN0aW9uIGNhbmNlbFRpbWVycygpIHsKICAgICAgY2FuY2VsVGltZXJzQ291bnQrKzsKCiAgICAgIHRoaXMuX2NsZWFyVGltZXJUaW1lb3V0KCk7CgogICAgICB0aGlzLl90aW1lcnMgPSBbXTsKCiAgICAgIHRoaXMuX2NhbmNlbEF1dG9ydW4oKTsKICAgIH07CgogICAgX3Byb3RvMy5oYXNUaW1lcnMgPSBmdW5jdGlvbiBoYXNUaW1lcnMoKSB7CiAgICAgIHJldHVybiB0aGlzLl90aW1lcnMubGVuZ3RoID4gMCB8fCB0aGlzLl9hdXRvcnVuOwogICAgfTsKCiAgICBfcHJvdG8zLmNhbmNlbCA9IGZ1bmN0aW9uIGNhbmNlbCh0aW1lcikgewogICAgICBjYW5jZWxDb3VudCsrOwoKICAgICAgaWYgKHRpbWVyID09PSBudWxsIHx8IHRpbWVyID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHZhciB0aW1lclR5cGUgPSB0eXBlb2YgdGltZXI7CgogICAgICBpZiAodGltZXJUeXBlID09PSAnbnVtYmVyJykgewogICAgICAgIC8vIHdlJ3JlIGNhbmNlbGxpbmcgYSBzZXRUaW1lb3V0IG9yIHRocm90dGxlIG9yIGRlYm91bmNlCiAgICAgICAgcmV0dXJuIHRoaXMuX2NhbmNlbExhdGVyVGltZXIodGltZXIpOwogICAgICB9IGVsc2UgaWYgKHRpbWVyVHlwZSA9PT0gJ29iamVjdCcgJiYgdGltZXIucXVldWUgJiYgdGltZXIubWV0aG9kKSB7CiAgICAgICAgLy8gd2UncmUgY2FuY2VsbGluZyBhIGRlZmVyT25jZQogICAgICAgIHJldHVybiB0aW1lci5xdWV1ZS5jYW5jZWwodGltZXIpOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIF9wcm90bzMuZW5zdXJlSW5zdGFuY2UgPSBmdW5jdGlvbiBlbnN1cmVJbnN0YW5jZSgpIHsKICAgICAgdGhpcy5fZW5zdXJlSW5zdGFuY2UoKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBkZWJ1ZyBpbmZvcm1hdGlvbiByZWxhdGVkIHRvIHRoZSBjdXJyZW50IGluc3RhbmNlIG9mIEJhY2tidXJuZXIKICAgICAqCiAgICAgKiBAbWV0aG9kIGdldERlYnVnSW5mbwogICAgICogQHJldHVybnMge09iamVjdCB8IHVuZGVmaW5lZH0gV2lsbCByZXR1cm4gYW5kIE9iamVjdCBjb250YWluaW5nIGRlYnVnIGluZm9ybWF0aW9uIGlmCiAgICAgKiB0aGUgREVCVUcgZmxhZyBpcyBzZXQgdG8gdHJ1ZSBvbiB0aGUgY3VycmVudCBpbnN0YW5jZSBvZiBCYWNrYnVybmVyLCBlbHNlIHVuZGVmaW5lZC4KICAgICAqLwogICAgOwoKICAgIF9wcm90bzMuZ2V0RGVidWdJbmZvID0gZnVuY3Rpb24gZ2V0RGVidWdJbmZvKCkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIGlmICh0aGlzLkRFQlVHKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGF1dG9ydW46IHRoaXMuX2F1dG9ydW5TdGFjaywKICAgICAgICAgIGNvdW50ZXJzOiB0aGlzLmNvdW50ZXJzLAogICAgICAgICAgdGltZXJzOiBnZXRRdWV1ZUl0ZW1zKHRoaXMuX3RpbWVycywgVElNRVJTX09GRlNFVCwgMiksCiAgICAgICAgICBpbnN0YW5jZVN0YWNrOiBbdGhpcy5jdXJyZW50SW5zdGFuY2VdLmNvbmNhdCh0aGlzLmluc3RhbmNlU3RhY2spLm1hcChmdW5jdGlvbiAoZGVmZXJyZWRBY3Rpb25RdWV1ZSkgewogICAgICAgICAgICByZXR1cm4gZGVmZXJyZWRBY3Rpb25RdWV1ZSAmJiBkZWZlcnJlZEFjdGlvblF1ZXVlLl9nZXREZWJ1Z0luZm8oX3RoaXMyLkRFQlVHKTsKICAgICAgICAgIH0pCiAgICAgICAgfTsKICAgICAgfQoKICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH07CgogICAgX3Byb3RvMy5fZW5kID0gZnVuY3Rpb24gX2VuZChmcm9tQXV0b3J1bikgewogICAgICB2YXIgY3VycmVudEluc3RhbmNlID0gdGhpcy5jdXJyZW50SW5zdGFuY2U7CiAgICAgIHZhciBuZXh0SW5zdGFuY2UgPSBudWxsOwoKICAgICAgaWYgKGN1cnJlbnRJbnN0YW5jZSA9PT0gbnVsbCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiZW5kIGNhbGxlZCB3aXRob3V0IGJlZ2luIik7CiAgICAgIH0gLy8gUHJldmVudCBkb3VibGUtZmluYWxseSBidWcgaW4gU2FmYXJpIDYuMC4yIGFuZCBpT1MgNgogICAgICAvLyBUaGlzIGJ1ZyBhcHBlYXJzIHRvIGJlIHJlc29sdmVkIGluIFNhZmFyaSA2LjAuNSBhbmQgaU9TIDcKCgogICAgICB2YXIgZmluYWxseUFscmVhZHlDYWxsZWQgPSBmYWxzZTsKICAgICAgdmFyIHJlc3VsdDsKCiAgICAgIHRyeSB7CiAgICAgICAgcmVzdWx0ID0gY3VycmVudEluc3RhbmNlLmZsdXNoKGZyb21BdXRvcnVuKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBpZiAoIWZpbmFsbHlBbHJlYWR5Q2FsbGVkKSB7CiAgICAgICAgICBmaW5hbGx5QWxyZWFkeUNhbGxlZCA9IHRydWU7CgogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gMQogICAgICAgICAgLyogUGF1c2UgKi8KICAgICAgICAgICkgewogICAgICAgICAgICAgIHZhciBwbGFubmVkTmV4dFF1ZXVlID0gdGhpcy5xdWV1ZU5hbWVzW2N1cnJlbnRJbnN0YW5jZS5xdWV1ZU5hbWVJbmRleF07CgogICAgICAgICAgICAgIHRoaXMuX3NjaGVkdWxlQXV0b3J1bihwbGFubmVkTmV4dFF1ZXVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50SW5zdGFuY2UgPSBudWxsOwoKICAgICAgICAgICAgaWYgKHRoaXMuaW5zdGFuY2VTdGFjay5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgbmV4dEluc3RhbmNlID0gdGhpcy5pbnN0YW5jZVN0YWNrLnBvcCgpOwogICAgICAgICAgICAgIHRoaXMuY3VycmVudEluc3RhbmNlID0gbmV4dEluc3RhbmNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl90cmlnZ2VyKCdlbmQnLCBjdXJyZW50SW5zdGFuY2UsIG5leHRJbnN0YW5jZSk7CgogICAgICAgICAgICB0aGlzLl9vbkVuZChjdXJyZW50SW5zdGFuY2UsIG5leHRJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzMuX2pvaW4gPSBmdW5jdGlvbiBfam9pbih0YXJnZXQsIG1ldGhvZCwgYXJncykgewogICAgICBpZiAodGhpcy5jdXJyZW50SW5zdGFuY2UgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcnVuKHRhcmdldCwgbWV0aG9kLCBhcmdzKTsKICAgICAgfQoKICAgICAgaWYgKHRhcmdldCA9PT0gdW5kZWZpbmVkICYmIGFyZ3MgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBtZXRob2QoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KHRhcmdldCwgYXJncyk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMy5fcnVuID0gZnVuY3Rpb24gX3J1bih0YXJnZXQsIG1ldGhvZCwgYXJncykgewogICAgICB2YXIgb25FcnJvciA9IGdldE9uRXJyb3IodGhpcy5vcHRpb25zKTsKICAgICAgdGhpcy5iZWdpbigpOwoKICAgICAgaWYgKG9uRXJyb3IpIHsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseSh0YXJnZXQsIGFyZ3MpOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICBvbkVycm9yKGVycm9yKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgdGhpcy5lbmQoKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkodGFyZ2V0LCBhcmdzKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgdGhpcy5lbmQoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMy5fY2FuY2VsQXV0b3J1biA9IGZ1bmN0aW9uIF9jYW5jZWxBdXRvcnVuKCkgewogICAgICBpZiAodGhpcy5fYXV0b3J1bikgewogICAgICAgIHRoaXMuX3BsYXRmb3JtLmNsZWFyTmV4dCgpOwoKICAgICAgICB0aGlzLl9hdXRvcnVuID0gZmFsc2U7CiAgICAgICAgdGhpcy5fYXV0b3J1blN0YWNrID0gbnVsbDsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8zLl9sYXRlciA9IGZ1bmN0aW9uIF9sYXRlcih0YXJnZXQsIG1ldGhvZCwgYXJncywgd2FpdCkgewogICAgICB2YXIgc3RhY2sgPSB0aGlzLkRFQlVHID8gbmV3IEVycm9yKCkgOiB1bmRlZmluZWQ7CiAgICAgIHZhciBleGVjdXRlQXQgPSB0aGlzLl9wbGF0Zm9ybS5ub3coKSArIHdhaXQ7CiAgICAgIHZhciBpZCA9IFVVSUQrKzsKCiAgICAgIGlmICh0aGlzLl90aW1lcnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhpcy5fdGltZXJzLnB1c2goZXhlY3V0ZUF0LCBpZCwgdGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHN0YWNrKTsKCiAgICAgICAgdGhpcy5faW5zdGFsbFRpbWVyVGltZW91dCgpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGZpbmQgcG9zaXRpb24gdG8gaW5zZXJ0CiAgICAgICAgdmFyIGkgPSBiaW5hcnlTZWFyY2goZXhlY3V0ZUF0LCB0aGlzLl90aW1lcnMpOwoKICAgICAgICB0aGlzLl90aW1lcnMuc3BsaWNlKGksIDAsIGV4ZWN1dGVBdCwgaWQsIHRhcmdldCwgbWV0aG9kLCBhcmdzLCBzdGFjayk7IC8vIGFsd2F5cyByZWluc3RhbGwgc2luY2UgaXQgY291bGQgYmUgb3V0IG9mIHN5bmMKCgogICAgICAgIHRoaXMuX3JlaW5zdGFsbFRpbWVyVGltZW91dCgpOwogICAgICB9CgogICAgICByZXR1cm4gaWQ7CiAgICB9OwoKICAgIF9wcm90bzMuX2NhbmNlbExhdGVyVGltZXIgPSBmdW5jdGlvbiBfY2FuY2VsTGF0ZXJUaW1lcih0aW1lcikgewogICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHRoaXMuX3RpbWVycy5sZW5ndGg7IGkgKz0gVElNRVJTX09GRlNFVCkgewogICAgICAgIGlmICh0aGlzLl90aW1lcnNbaV0gPT09IHRpbWVyKSB7CiAgICAgICAgICB0aGlzLl90aW1lcnMuc3BsaWNlKGkgLSAxLCBUSU1FUlNfT0ZGU0VUKTsKCiAgICAgICAgICBpZiAoaSA9PT0gMSkgewogICAgICAgICAgICB0aGlzLl9yZWluc3RhbGxUaW1lclRpbWVvdXQoKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIC8qKgogICAgIFRyaWdnZXIgYW4gZXZlbnQuIFN1cHBvcnRzIHVwIHRvIHR3byBhcmd1bWVudHMuIERlc2lnbmVkIGFyb3VuZAogICAgIHRyaWdnZXJpbmcgdHJhbnNpdGlvbiBldmVudHMgZnJvbSBvbmUgcnVuIGxvb3AgaW5zdGFuY2UgdG8gdGhlCiAgICAgbmV4dCwgd2hpY2ggcmVxdWlyZXMgYW4gYXJndW1lbnQgZm9yIHRoZSAgaW5zdGFuY2UgYW5kIHRoZW4KICAgICBhbiBhcmd1bWVudCBmb3IgdGhlIG5leHQgaW5zdGFuY2UuCiAgICAgICAgQHByaXZhdGUKICAgICBAbWV0aG9kIF90cmlnZ2VyCiAgICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50TmFtZQogICAgIEBwYXJhbSB7YW55fSBhcmcxCiAgICAgQHBhcmFtIHthbnl9IGFyZzIKICAgICAqLwogICAgOwoKICAgIF9wcm90bzMuX3RyaWdnZXIgPSBmdW5jdGlvbiBfdHJpZ2dlcihldmVudE5hbWUsIGFyZzEsIGFyZzIpIHsKICAgICAgdmFyIGNhbGxiYWNrcyA9IHRoaXMuX2V2ZW50Q2FsbGJhY2tzW2V2ZW50TmFtZV07CgogICAgICBpZiAoY2FsbGJhY2tzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNhbGxiYWNrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY2FsbGJhY2tzW2ldKGFyZzEsIGFyZzIpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8zLl9ydW5FeHBpcmVkVGltZXJzID0gZnVuY3Rpb24gX3J1bkV4cGlyZWRUaW1lcnMoKSB7CiAgICAgIHRoaXMuX3RpbWVyVGltZW91dElkID0gbnVsbDsKCiAgICAgIGlmICh0aGlzLl90aW1lcnMubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuYmVnaW4oKTsKCiAgICAgICAgdGhpcy5fc2NoZWR1bGVFeHBpcmVkVGltZXJzKCk7CgogICAgICAgIHRoaXMuZW5kKCk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvMy5fc2NoZWR1bGVFeHBpcmVkVGltZXJzID0gZnVuY3Rpb24gX3NjaGVkdWxlRXhwaXJlZFRpbWVycygpIHsKICAgICAgdmFyIHRpbWVycyA9IHRoaXMuX3RpbWVyczsKICAgICAgdmFyIGkgPSAwOwogICAgICB2YXIgbCA9IHRpbWVycy5sZW5ndGg7CiAgICAgIHZhciBkZWZhdWx0UXVldWUgPSB0aGlzLl9kZWZhdWx0UXVldWU7CgogICAgICB2YXIgbiA9IHRoaXMuX3BsYXRmb3JtLm5vdygpOwoKICAgICAgZm9yICg7IGkgPCBsOyBpICs9IFRJTUVSU19PRkZTRVQpIHsKICAgICAgICB2YXIgZXhlY3V0ZUF0ID0gdGltZXJzW2ldOwoKICAgICAgICBpZiAoZXhlY3V0ZUF0ID4gbikgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICB2YXIgYXJncyA9IHRpbWVyc1tpICsgNF07CgogICAgICAgIGlmIChhcmdzICE9PSBESVNBQkxFX1NDSEVEVUxFKSB7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gdGltZXJzW2kgKyAyXTsKICAgICAgICAgIHZhciBtZXRob2QgPSB0aW1lcnNbaSArIDNdOwogICAgICAgICAgdmFyIHN0YWNrID0gdGltZXJzW2kgKyA1XTsKICAgICAgICAgIHRoaXMuY3VycmVudEluc3RhbmNlLnNjaGVkdWxlKGRlZmF1bHRRdWV1ZSwgdGFyZ2V0LCBtZXRob2QsIGFyZ3MsIGZhbHNlLCBzdGFjayk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aW1lcnMuc3BsaWNlKDAsIGkpOwoKICAgICAgdGhpcy5faW5zdGFsbFRpbWVyVGltZW91dCgpOwogICAgfTsKCiAgICBfcHJvdG8zLl9yZWluc3RhbGxUaW1lclRpbWVvdXQgPSBmdW5jdGlvbiBfcmVpbnN0YWxsVGltZXJUaW1lb3V0KCkgewogICAgICB0aGlzLl9jbGVhclRpbWVyVGltZW91dCgpOwoKICAgICAgdGhpcy5faW5zdGFsbFRpbWVyVGltZW91dCgpOwogICAgfTsKCiAgICBfcHJvdG8zLl9jbGVhclRpbWVyVGltZW91dCA9IGZ1bmN0aW9uIF9jbGVhclRpbWVyVGltZW91dCgpIHsKICAgICAgaWYgKHRoaXMuX3RpbWVyVGltZW91dElkID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl9wbGF0Zm9ybS5jbGVhclRpbWVvdXQodGhpcy5fdGltZXJUaW1lb3V0SWQpOwoKICAgICAgdGhpcy5fdGltZXJUaW1lb3V0SWQgPSBudWxsOwogICAgfTsKCiAgICBfcHJvdG8zLl9pbnN0YWxsVGltZXJUaW1lb3V0ID0gZnVuY3Rpb24gX2luc3RhbGxUaW1lclRpbWVvdXQoKSB7CiAgICAgIGlmICh0aGlzLl90aW1lcnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgbWluRXhwaXJlc0F0ID0gdGhpcy5fdGltZXJzWzBdOwoKICAgICAgdmFyIG4gPSB0aGlzLl9wbGF0Zm9ybS5ub3coKTsKCiAgICAgIHZhciB3YWl0ID0gTWF0aC5tYXgoMCwgbWluRXhwaXJlc0F0IC0gbik7CiAgICAgIHRoaXMuX3RpbWVyVGltZW91dElkID0gdGhpcy5fcGxhdGZvcm0uc2V0VGltZW91dCh0aGlzLl9ib3VuZFJ1bkV4cGlyZWRUaW1lcnMsIHdhaXQpOwogICAgfTsKCiAgICBfcHJvdG8zLl9lbnN1cmVJbnN0YW5jZSA9IGZ1bmN0aW9uIF9lbnN1cmVJbnN0YW5jZSgpIHsKICAgICAgdmFyIGN1cnJlbnRJbnN0YW5jZSA9IHRoaXMuY3VycmVudEluc3RhbmNlOwoKICAgICAgaWYgKGN1cnJlbnRJbnN0YW5jZSA9PT0gbnVsbCkgewogICAgICAgIHRoaXMuX2F1dG9ydW5TdGFjayA9IHRoaXMuREVCVUcgPyBuZXcgRXJyb3IoKSA6IHVuZGVmaW5lZDsKICAgICAgICBjdXJyZW50SW5zdGFuY2UgPSB0aGlzLmJlZ2luKCk7CgogICAgICAgIHRoaXMuX3NjaGVkdWxlQXV0b3J1bih0aGlzLnF1ZXVlTmFtZXNbMF0pOwogICAgICB9CgogICAgICByZXR1cm4gY3VycmVudEluc3RhbmNlOwogICAgfTsKCiAgICBfcHJvdG8zLl9zY2hlZHVsZUF1dG9ydW4gPSBmdW5jdGlvbiBfc2NoZWR1bGVBdXRvcnVuKHBsYW5uZWROZXh0UXVldWUpIHsKICAgICAgYXV0b3J1bnNDcmVhdGVkQ291bnQrKzsKICAgICAgdmFyIG5leHQgPSB0aGlzLl9wbGF0Zm9ybS5uZXh0OwogICAgICB2YXIgZmx1c2ggPSB0aGlzLm9wdGlvbnMuZmx1c2g7CgogICAgICBpZiAoZmx1c2gpIHsKICAgICAgICBmbHVzaChwbGFubmVkTmV4dFF1ZXVlLCBuZXh0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBuZXh0KCk7CiAgICAgIH0KCiAgICAgIHRoaXMuX2F1dG9ydW4gPSB0cnVlOwogICAgfTsKCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKEJhY2tidXJuZXIsIFt7CiAgICAgIGtleTogImNvdW50ZXJzIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGJlZ2luOiBiZWdpbkNvdW50LAogICAgICAgICAgZW5kOiBlbmRDb3VudCwKICAgICAgICAgIGV2ZW50czogewogICAgICAgICAgICBiZWdpbjogYmVnaW5FdmVudENvdW50LAogICAgICAgICAgICBlbmQ6IGVuZEV2ZW50Q291bnQKICAgICAgICAgIH0sCiAgICAgICAgICBhdXRvcnVuczogewogICAgICAgICAgICBjcmVhdGVkOiBhdXRvcnVuc0NyZWF0ZWRDb3VudCwKICAgICAgICAgICAgY29tcGxldGVkOiBhdXRvcnVuc0NvbXBsZXRlZENvdW50CiAgICAgICAgICB9LAogICAgICAgICAgcnVuOiBydW5Db3VudCwKICAgICAgICAgIGpvaW46IGpvaW5Db3VudCwKICAgICAgICAgIGRlZmVyOiBkZWZlckNvdW50LAogICAgICAgICAgc2NoZWR1bGU6IHNjaGVkdWxlQ291bnQsCiAgICAgICAgICBzY2hlZHVsZUl0ZXJhYmxlOiBzY2hlZHVsZUl0ZXJhYmxlQ291bnQsCiAgICAgICAgICBkZWZlck9uY2U6IGRlZmVyT25jZUNvdW50LAogICAgICAgICAgc2NoZWR1bGVPbmNlOiBzY2hlZHVsZU9uY2VDb3VudCwKICAgICAgICAgIHNldFRpbWVvdXQ6IHNldFRpbWVvdXRDb3VudCwKICAgICAgICAgIGxhdGVyOiBsYXRlckNvdW50LAogICAgICAgICAgdGhyb3R0bGU6IHRocm90dGxlQ291bnQsCiAgICAgICAgICBkZWJvdW5jZTogZGVib3VuY2VDb3VudCwKICAgICAgICAgIGNhbmNlbFRpbWVyczogY2FuY2VsVGltZXJzQ291bnQsCiAgICAgICAgICBjYW5jZWw6IGNhbmNlbENvdW50LAogICAgICAgICAgbG9vcHM6IHsKICAgICAgICAgICAgdG90YWw6IGRlZmVycmVkQWN0aW9uUXVldWVzQ3JlYXRlZENvdW50LAogICAgICAgICAgICBuZXN0ZWQ6IG5lc3RlZERlZmVycmVkQWN0aW9uUXVldWVzQ3JlYXRlZAogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZGVmYXVsdFF1ZXVlIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2RlZmF1bHRRdWV1ZTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEJhY2tidXJuZXI7CiAgfSgpOwoKICBCYWNrYnVybmVyLlF1ZXVlID0gUXVldWU7CiAgQmFja2J1cm5lci5idWlsZFBsYXRmb3JtID0gYnVpbGRQbGF0Zm9ybTsKICBCYWNrYnVybmVyLmJ1aWxkTmV4dCA9IGJ1aWxkTmV4dDsKICB2YXIgX2RlZmF1bHQgPSBCYWNrYnVybmVyOwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CmRlZmluZSgiZGFnLW1hcCIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIC8qKgogICAqIEEgdG9wb2xvZ2ljYWxseSBvcmRlcmVkIG1hcCBvZiBrZXkvdmFsdWUgcGFpcnMgd2l0aCBhIHNpbXBsZSBBUEkgZm9yIGFkZGluZyBjb25zdHJhaW50cy4KICAgKgogICAqIEVkZ2VzIGNhbiBmb3J3YXJkIHJlZmVyZW5jZSBrZXlzIHRoYXQgaGF2ZSBub3QgYmVlbiBhZGRlZCB5ZXQgKHRoZSBmb3J3YXJkIHJlZmVyZW5jZSB3aWxsCiAgICogbWFwIHRoZSBrZXkgdG8gdW5kZWZpbmVkKS4KICAgKi8KICB2YXIgREFHID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gREFHKCkgewogICAgICB0aGlzLl92ZXJ0aWNlcyA9IG5ldyBWZXJ0aWNlcygpOwogICAgfQogICAgLyoqCiAgICAgKiBBZGRzIGEga2V5L3ZhbHVlIHBhaXIgd2l0aCBkZXBlbmRlbmNpZXMgb24gb3RoZXIga2V5L3ZhbHVlIHBhaXJzLgogICAgICoKICAgICAqIEBwdWJsaWMKICAgICAqIEBwYXJhbSBrZXkgICAgVGhlIGtleSBvZiB0aGUgdmVydGV4IHRvIGJlIGFkZGVkLgogICAgICogQHBhcmFtIHZhbHVlICBUaGUgdmFsdWUgb2YgdGhhdCB2ZXJ0ZXguCiAgICAgKiBAcGFyYW0gYmVmb3JlIEEga2V5IG9yIGFycmF5IG9mIGtleXMgb2YgdGhlIHZlcnRpY2VzIHRoYXQgbXVzdAogICAgICogICAgICAgICAgICAgICBiZSB2aXNpdGVkIGJlZm9yZSB0aGlzIHZlcnRleC4KICAgICAqIEBwYXJhbSBhZnRlciAgQW4gc3RyaW5nIG9yIGFycmF5IG9mIHN0cmluZ3Mgd2l0aCB0aGUga2V5cyBvZiB0aGUKICAgICAqICAgICAgICAgICAgICAgdmVydGljZXMgdGhhdCBtdXN0IGJlIGFmdGVyIHRoaXMgdmVydGV4IGlzIHZpc2l0ZWQuCiAgICAgKi8KCgogICAgREFHLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSwgYmVmb3JlLCBhZnRlcikgewogICAgICBpZiAoIWtleSkgdGhyb3cgbmV3IEVycm9yKCdhcmd1bWVudCBga2V5YCBpcyByZXF1aXJlZCcpOwogICAgICB2YXIgdmVydGljZXMgPSB0aGlzLl92ZXJ0aWNlczsKICAgICAgdmFyIHYgPSB2ZXJ0aWNlcy5hZGQoa2V5KTsKICAgICAgdi52YWwgPSB2YWx1ZTsKCiAgICAgIGlmIChiZWZvcmUpIHsKICAgICAgICBpZiAodHlwZW9mIGJlZm9yZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgIHZlcnRpY2VzLmFkZEVkZ2UodiwgdmVydGljZXMuYWRkKGJlZm9yZSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJlZm9yZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2ZXJ0aWNlcy5hZGRFZGdlKHYsIHZlcnRpY2VzLmFkZChiZWZvcmVbaV0pKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChhZnRlcikgewogICAgICAgIGlmICh0eXBlb2YgYWZ0ZXIgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICB2ZXJ0aWNlcy5hZGRFZGdlKHZlcnRpY2VzLmFkZChhZnRlciksIHYpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFmdGVyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZlcnRpY2VzLmFkZEVkZ2UodmVydGljZXMuYWRkKGFmdGVyW2ldKSwgdik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgLyoqCiAgICAgKiBAZGVwcmVjYXRlZCBwbGVhc2UgdXNlIGFkZC4KICAgICAqLwoKCiAgICBEQUcucHJvdG90eXBlLmFkZEVkZ2VzID0gZnVuY3Rpb24gKGtleSwgdmFsdWUsIGJlZm9yZSwgYWZ0ZXIpIHsKICAgICAgdGhpcy5hZGQoa2V5LCB2YWx1ZSwgYmVmb3JlLCBhZnRlcik7CiAgICB9OwogICAgLyoqCiAgICAgKiBWaXNpdHMga2V5L3ZhbHVlIHBhaXJzIGluIHRvcG9sb2dpY2FsIG9yZGVyLgogICAgICoKICAgICAqIEBwdWJsaWMKICAgICAqIEBwYXJhbSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gYmUgaW52b2tlZCB3aXRoIGVhY2gga2V5L3ZhbHVlLgogICAgICovCgoKICAgIERBRy5wcm90b3R5cGUuZWFjaCA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICB0aGlzLl92ZXJ0aWNlcy53YWxrKGNhbGxiYWNrKTsKICAgIH07CiAgICAvKioKICAgICAqIEBkZXByZWNhdGVkIHBsZWFzZSB1c2UgZWFjaC4KICAgICAqLwoKCiAgICBEQUcucHJvdG90eXBlLnRvcHNvcnQgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgdGhpcy5lYWNoKGNhbGxiYWNrKTsKICAgIH07CgogICAgcmV0dXJuIERBRzsKICB9KCk7CgogIHZhciBfZGVmYXVsdCA9IERBRzsKICAvKiogQHByaXZhdGUgKi8KCiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0OwoKICB2YXIgVmVydGljZXMgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBWZXJ0aWNlcygpIHsKICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICB0aGlzLnN0YWNrID0gbmV3IEludFN0YWNrKCk7CiAgICAgIHRoaXMucGF0aCA9IG5ldyBJbnRTdGFjaygpOwogICAgICB0aGlzLnJlc3VsdCA9IG5ldyBJbnRTdGFjaygpOwogICAgfQoKICAgIFZlcnRpY2VzLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGlmICgha2V5KSB0aHJvdyBuZXcgRXJyb3IoIm1pc3Npbmcga2V5Iik7CiAgICAgIHZhciBsID0gdGhpcy5sZW5ndGggfCAwOwogICAgICB2YXIgdmVydGV4OwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsOyBpKyspIHsKICAgICAgICB2ZXJ0ZXggPSB0aGlzW2ldOwogICAgICAgIGlmICh2ZXJ0ZXgua2V5ID09PSBrZXkpIHJldHVybiB2ZXJ0ZXg7CiAgICAgIH0KCiAgICAgIHRoaXMubGVuZ3RoID0gbCArIDE7CiAgICAgIHJldHVybiB0aGlzW2xdID0gewogICAgICAgIGlkeDogbCwKICAgICAgICBrZXk6IGtleSwKICAgICAgICB2YWw6IHVuZGVmaW5lZCwKICAgICAgICBvdXQ6IGZhbHNlLAogICAgICAgIGZsYWc6IGZhbHNlLAogICAgICAgIGxlbmd0aDogMAogICAgICB9OwogICAgfTsKCiAgICBWZXJ0aWNlcy5wcm90b3R5cGUuYWRkRWRnZSA9IGZ1bmN0aW9uICh2LCB3KSB7CiAgICAgIHRoaXMuY2hlY2sodiwgdy5rZXkpOwogICAgICB2YXIgbCA9IHcubGVuZ3RoIHwgMDsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgaWYgKHdbaV0gPT09IHYuaWR4KSByZXR1cm47CiAgICAgIH0KCiAgICAgIHcubGVuZ3RoID0gbCArIDE7CiAgICAgIHdbbF0gPSB2LmlkeDsKICAgICAgdi5vdXQgPSB0cnVlOwogICAgfTsKCiAgICBWZXJ0aWNlcy5wcm90b3R5cGUud2FsayA9IGZ1bmN0aW9uIChjYikgewogICAgICB0aGlzLnJlc2V0KCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgdmVydGV4ID0gdGhpc1tpXTsKICAgICAgICBpZiAodmVydGV4Lm91dCkgY29udGludWU7CiAgICAgICAgdGhpcy52aXNpdCh2ZXJ0ZXgsICIiKTsKICAgICAgfQoKICAgICAgdGhpcy5lYWNoKHRoaXMucmVzdWx0LCBjYik7CiAgICB9OwoKICAgIFZlcnRpY2VzLnByb3RvdHlwZS5jaGVjayA9IGZ1bmN0aW9uICh2LCB3KSB7CiAgICAgIGlmICh2LmtleSA9PT0gdykgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiY3ljbGUgZGV0ZWN0ZWQ6ICIgKyB3ICsgIiA8LSAiICsgdyk7CiAgICAgIH0gLy8gcXVpY2sgY2hlY2sKCgogICAgICBpZiAodi5sZW5ndGggPT09IDApIHJldHVybjsgLy8gc2hhbGxvdyBjaGVjawoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGtleSA9IHRoaXNbdltpXV0ua2V5OwoKICAgICAgICBpZiAoa2V5ID09PSB3KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImN5Y2xlIGRldGVjdGVkOiAiICsgdyArICIgPC0gIiArIHYua2V5ICsgIiA8LSAiICsgdyk7CiAgICAgICAgfQogICAgICB9IC8vIGRlZXAgY2hlY2sKCgogICAgICB0aGlzLnJlc2V0KCk7CiAgICAgIHRoaXMudmlzaXQodiwgdyk7CgogICAgICBpZiAodGhpcy5wYXRoLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgbXNnXzEgPSAiY3ljbGUgZGV0ZWN0ZWQ6ICIgKyB3OwogICAgICAgIHRoaXMuZWFjaCh0aGlzLnBhdGgsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIG1zZ18xICs9ICIgPC0gIiArIGtleTsKICAgICAgICB9KTsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnXzEpOwogICAgICB9CiAgICB9OwoKICAgIFZlcnRpY2VzLnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5zdGFjay5sZW5ndGggPSAwOwogICAgICB0aGlzLnBhdGgubGVuZ3RoID0gMDsKICAgICAgdGhpcy5yZXN1bHQubGVuZ3RoID0gMDsKCiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB0aGlzW2ldLmZsYWcgPSBmYWxzZTsKICAgICAgfQogICAgfTsKCiAgICBWZXJ0aWNlcy5wcm90b3R5cGUudmlzaXQgPSBmdW5jdGlvbiAoc3RhcnQsIHNlYXJjaCkgewogICAgICB2YXIgX2EgPSB0aGlzLAogICAgICAgICAgc3RhY2sgPSBfYS5zdGFjaywKICAgICAgICAgIHBhdGggPSBfYS5wYXRoLAogICAgICAgICAgcmVzdWx0ID0gX2EucmVzdWx0OwoKICAgICAgc3RhY2sucHVzaChzdGFydC5pZHgpOwoKICAgICAgd2hpbGUgKHN0YWNrLmxlbmd0aCkgewogICAgICAgIHZhciBpbmRleCA9IHN0YWNrLnBvcCgpIHwgMDsKCiAgICAgICAgaWYgKGluZGV4ID49IDApIHsKICAgICAgICAgIC8vIGVudGVyCiAgICAgICAgICB2YXIgdmVydGV4ID0gdGhpc1tpbmRleF07CiAgICAgICAgICBpZiAodmVydGV4LmZsYWcpIGNvbnRpbnVlOwogICAgICAgICAgdmVydGV4LmZsYWcgPSB0cnVlOwogICAgICAgICAgcGF0aC5wdXNoKGluZGV4KTsKICAgICAgICAgIGlmIChzZWFyY2ggPT09IHZlcnRleC5rZXkpIGJyZWFrOyAvLyBwdXNoIGV4aXQKCiAgICAgICAgICBzdGFjay5wdXNoKH5pbmRleCk7CiAgICAgICAgICB0aGlzLnB1c2hJbmNvbWluZyh2ZXJ0ZXgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBleGl0CiAgICAgICAgICBwYXRoLnBvcCgpOwogICAgICAgICAgcmVzdWx0LnB1c2gofmluZGV4KTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgVmVydGljZXMucHJvdG90eXBlLnB1c2hJbmNvbWluZyA9IGZ1bmN0aW9uIChpbmNvbW1pbmcpIHsKICAgICAgdmFyIHN0YWNrID0gdGhpcy5zdGFjazsKCiAgICAgIGZvciAodmFyIGkgPSBpbmNvbW1pbmcubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICB2YXIgaW5kZXggPSBpbmNvbW1pbmdbaV07CgogICAgICAgIGlmICghdGhpc1tpbmRleF0uZmxhZykgewogICAgICAgICAgc3RhY2sucHVzaChpbmRleCk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIFZlcnRpY2VzLnByb3RvdHlwZS5lYWNoID0gZnVuY3Rpb24gKGluZGljZXMsIGNiKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gaW5kaWNlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB2YXIgdmVydGV4ID0gdGhpc1tpbmRpY2VzW2ldXTsKICAgICAgICBjYih2ZXJ0ZXgua2V5LCB2ZXJ0ZXgudmFsKTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gVmVydGljZXM7CiAgfSgpOwogIC8qKiBAcHJpdmF0ZSAqLwoKCiAgdmFyIEludFN0YWNrID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gSW50U3RhY2soKSB7CiAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgIH0KCiAgICBJbnRTdGFjay5wcm90b3R5cGUucHVzaCA9IGZ1bmN0aW9uIChuKSB7CiAgICAgIHRoaXNbdGhpcy5sZW5ndGgrK10gPSBuIHwgMDsKICAgIH07CgogICAgSW50U3RhY2sucHJvdG90eXBlLnBvcCA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXNbLS10aGlzLmxlbmd0aF0gfCAwOwogICAgfTsKCiAgICByZXR1cm4gSW50U3RhY2s7CiAgfSgpOwp9KTsKZGVmaW5lKCJlbWJlci1iYWJlbCIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLndyYXBOYXRpdmVTdXBlciA9IHdyYXBOYXRpdmVTdXBlcjsKICBfZXhwb3J0cy5jbGFzc0NhbGxDaGVjayA9IGNsYXNzQ2FsbENoZWNrOwogIF9leHBvcnRzLmluaGVyaXRzTG9vc2UgPSBpbmhlcml0c0xvb3NlOwogIF9leHBvcnRzLnRhZ2dlZFRlbXBsYXRlTGl0ZXJhbExvb3NlID0gdGFnZ2VkVGVtcGxhdGVMaXRlcmFsTG9vc2U7CiAgX2V4cG9ydHMuY3JlYXRlQ2xhc3MgPSBjcmVhdGVDbGFzczsKICBfZXhwb3J0cy5hc3NlcnRUaGlzSW5pdGlhbGl6ZWQgPSBhc3NlcnRUaGlzSW5pdGlhbGl6ZWQ7CiAgX2V4cG9ydHMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybiA9IHBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm47CiAgX2V4cG9ydHMub2JqZWN0RGVzdHJ1Y3R1cmluZ0VtcHR5ID0gb2JqZWN0RGVzdHJ1Y3R1cmluZ0VtcHR5OwogIHZhciBzZXRQcm90b3R5cGVPZiA9IE9iamVjdC5zZXRQcm90b3R5cGVPZjsKICB2YXIgbmF0aXZlV3JhcHBlckNhY2hlID0gbmV3IE1hcCgpOyAvLyBTdXBlciBtaW5pbWFsIHZlcnNpb24gb2YgQmFiZWwncyB3cmFwTmF0aXZlU3VwZXIuIFdlIG9ubHkgdXNlIHRoaXMgZm9yCiAgLy8gZXh0ZW5kaW5nIEZ1bmN0aW9uLCBmb3IgQ29tcHV0ZWREZWNvcmF0b3JJbXBsIGFuZCBBbGlhc0RlY29yYXRvckltcGwuIFdlIGtub3cKICAvLyB3ZSB3aWxsIG5ldmVyIGRpcmVjdGx5IGNyZWF0ZSBhbiBpbnN0YW5jZSBvZiB0aGVzZSBjbGFzc2VzIHNvIG5vIG5lZWQgdG8KICAvLyBpbmNsdWRlIGBjb25zdHJ1Y3RgIGNvZGUgb3Igb3RoZXIgaGVscGVycy4KCiAgZnVuY3Rpb24gd3JhcE5hdGl2ZVN1cGVyKENsYXNzKSB7CiAgICBpZiAobmF0aXZlV3JhcHBlckNhY2hlLmhhcyhDbGFzcykpIHsKICAgICAgcmV0dXJuIG5hdGl2ZVdyYXBwZXJDYWNoZS5nZXQoQ2xhc3MpOwogICAgfQoKICAgIGZ1bmN0aW9uIFdyYXBwZXIoKSB7fQoKICAgIFdyYXBwZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGFzcy5wcm90b3R5cGUsIHsKICAgICAgY29uc3RydWN0b3I6IHsKICAgICAgICB2YWx1ZTogV3JhcHBlciwKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgfQogICAgfSk7CiAgICBuYXRpdmVXcmFwcGVyQ2FjaGUuc2V0KENsYXNzLCBXcmFwcGVyKTsKICAgIHJldHVybiBzZXRQcm90b3R5cGVPZihXcmFwcGVyLCBDbGFzcyk7CiAgfQoKICBmdW5jdGlvbiBjbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsKICAgIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICkgewogICAgICBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOwogICAgICB9CiAgICB9CiAgfQogIC8qCiAgICBPdmVycmlkZXMgZGVmYXVsdCBgaW5oZXJpdHNMb29zZWAgdG8gX2Fsc29fIGNhbGwgYE9iamVjdC5zZXRQcm90b3R5cGVPZmAuCiAgICBUaGlzIGlzIG5lZWRlZCBzbyB0aGF0IHdlIGNhbiB1c2UgYGxvb3NlYCBvcHRpb24gd2l0aCB0aGUKICAgIGBAYmFiZWwvcGx1Z2luLXRyYW5zZm9ybS1jbGFzc2VzYCAoYmVjYXVzZSB3ZSB3YW50IHNpbXBsZSBhc3NpZ25tZW50IHRvIHRoZQogICAgcHJvdG90eXBlIHdoZXJlZXZlciBwb3NzaWJsZSkgYnV0IGFsc28ga2VlcCBvdXIgY29uc3RydWN0b3IgYmFzZWQgcHJvdG90eXBhbAogICAgaW5oZXJpdGFuY2Ugd29ya2luZyBwcm9wZXJseQogICovCgoKICBmdW5jdGlvbiBpbmhlcml0c0xvb3NlKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7CiAgICBpZiAoZmFsc2UKICAgIC8qIERFQlVHICovCiAgICApIHsKICAgICAgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbicpOwogICAgICB9CiAgICB9CgogICAgc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzID09PSBudWxsID8gbnVsbCA6IHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7CiAgICAgIGNvbnN0cnVjdG9yOiB7CiAgICAgICAgdmFsdWU6IHN1YkNsYXNzLAogICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICB9CiAgICB9KTsKCiAgICBpZiAoc3VwZXJDbGFzcyAhPT0gbnVsbCkgewogICAgICBzZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB0YWdnZWRUZW1wbGF0ZUxpdGVyYWxMb29zZShzdHJpbmdzLCByYXcpIHsKICAgIGlmICghcmF3KSB7CiAgICAgIHJhdyA9IHN0cmluZ3Muc2xpY2UoMCk7CiAgICB9CgogICAgc3RyaW5ncy5yYXcgPSByYXc7CiAgICByZXR1cm4gc3RyaW5nczsKICB9CgogIGZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsKICAgICAgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOwogICAgICBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7CiAgICAgIGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7CiAgICB9CiAgfQogIC8qCiAgICBEaWZmZXJzIGZyb20gZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBieSBhdm9pZGluZyBib29sZWFuIGNvZXJjaW9uIG9mCiAgICBgcHJvdG9Qcm9wc2AgYW5kIGBzdGF0aWNQcm9wc2AuCiAgKi8KCgogIGZ1bmN0aW9uIGNyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewogICAgaWYgKHByb3RvUHJvcHMgIT09IG51bGwgJiYgcHJvdG9Qcm9wcyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CiAgICB9CgogICAgaWYgKHN0YXRpY1Byb3BzICE9PSBudWxsICYmIHN0YXRpY1Byb3BzICE9PSB1bmRlZmluZWQpIHsKICAgICAgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsKICAgIH0KCiAgICByZXR1cm4gQ29uc3RydWN0b3I7CiAgfQoKICBmdW5jdGlvbiBhc3NlcnRUaGlzSW5pdGlhbGl6ZWQoc2VsZikgewogICAgaWYgKGZhbHNlCiAgICAvKiBERUJVRyAqLwogICAgJiYgc2VsZiA9PT0gdm9pZCAwKSB7CiAgICAgIHRocm93IG5ldyBSZWZlcmVuY2VFcnJvcigidGhpcyBoYXNuJ3QgYmVlbiBpbml0aWFsaXNlZCAtIHN1cGVyKCkgaGFzbid0IGJlZW4gY2FsbGVkIik7CiAgICB9CgogICAgcmV0dXJuIHNlbGY7CiAgfQogIC8qCiAgICBBZGRzIGBERUJVR2AgZ3VhcmQgdG8gZXJyb3IgYmVpbmcgdGhyb3duLCBhbmQgYXZvaWRzIGJvb2xlYW4gY29lcmNpb24gb2YgYGNhbGxgLgogICovCgoKICBmdW5jdGlvbiBwb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHNlbGYsIGNhbGwpIHsKICAgIGlmICh0eXBlb2YgY2FsbCA9PT0gJ29iamVjdCcgJiYgY2FsbCAhPT0gbnVsbCB8fCB0eXBlb2YgY2FsbCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm4gY2FsbDsKICAgIH0KCiAgICByZXR1cm4gYXNzZXJ0VGhpc0luaXRpYWxpemVkKHNlbGYpOwogIH0KCiAgZnVuY3Rpb24gb2JqZWN0RGVzdHJ1Y3R1cmluZ0VtcHR5KG9iaikgewogICAgaWYgKGZhbHNlCiAgICAvKiBERUJVRyAqLwogICAgJiYgKG9iaiA9PT0gbnVsbCB8fCBvYmogPT09IHVuZGVmaW5lZCkpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGRlc3RydWN0dXJlIHVuZGVmaW5lZCcpOwogICAgfQogIH0KfSk7CmRlZmluZSgiZW1iZXIvaW5kZXgiLCBbImV4cG9ydHMiLCAicmVxdWlyZSIsICJAZW1iZXIvLWludGVybmFscy9lbnZpcm9ubWVudCIsICJub2RlLW1vZHVsZSIsICJAZW1iZXIvLWludGVybmFscy91dGlscyIsICJAZW1iZXIvLWludGVybmFscy9jb250YWluZXIiLCAiQGVtYmVyL2luc3RydW1lbnRhdGlvbiIsICJAZW1iZXIvLWludGVybmFscy9tZXRhIiwgIkBlbWJlci8taW50ZXJuYWxzL21ldGFsIiwgIkBlbWJlci9jYW5hcnktZmVhdHVyZXMiLCAiQGVtYmVyL2RlYnVnIiwgImJhY2tidXJuZXIiLCAiQGVtYmVyLy1pbnRlcm5hbHMvY29uc29sZSIsICJAZW1iZXIvY29udHJvbGxlciIsICJAZW1iZXIvY29udHJvbGxlci9saWIvY29udHJvbGxlcl9taXhpbiIsICJAZW1iZXIvc3RyaW5nIiwgIkBlbWJlci9zZXJ2aWNlIiwgIkBlbWJlci9vYmplY3QiLCAiQGVtYmVyL29iamVjdC9jb21wYXQiLCAiQGVtYmVyL29iamVjdC9jb21wdXRlZCIsICJAZW1iZXIvLWludGVybmFscy9ydW50aW1lIiwgIkBlbWJlci8taW50ZXJuYWxzL2dsaW1tZXIiLCAiZW1iZXIvdmVyc2lvbiIsICJAZW1iZXIvLWludGVybmFscy92aWV3cyIsICJAZW1iZXIvLWludGVybmFscy9yb3V0aW5nIiwgIkBlbWJlci8taW50ZXJuYWxzL2V4dGVuc2lvbi1zdXBwb3J0IiwgIkBlbWJlci9lcnJvciIsICJAZW1iZXIvcnVubG9vcCIsICJAZW1iZXIvLWludGVybmFscy9lcnJvci1oYW5kbGluZyIsICJAZW1iZXIvLWludGVybmFscy9vd25lciIsICJAZW1iZXIvYXBwbGljYXRpb24iLCAiQGVtYmVyL2FwcGxpY2F0aW9uL2dsb2JhbHMtcmVzb2x2ZXIiLCAiQGVtYmVyL2FwcGxpY2F0aW9uL2luc3RhbmNlIiwgIkBlbWJlci9lbmdpbmUiLCAiQGVtYmVyL2VuZ2luZS9pbnN0YW5jZSIsICJAZW1iZXIvcG9seWZpbGxzIiwgIkBlbWJlci9kZXByZWNhdGVkLWZlYXR1cmVzIiwgIkBlbWJlci9jb21wb25lbnQvdGVtcGxhdGUtb25seSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9yZXF1aXJlLCBfZW52aXJvbm1lbnQsIF9ub2RlTW9kdWxlLCB1dGlscywgX2NvbnRhaW5lciwgaW5zdHJ1bWVudGF0aW9uLCBfbWV0YSwgbWV0YWwsIF9jYW5hcnlGZWF0dXJlcywgRW1iZXJEZWJ1ZywgX2JhY2tidXJuZXIsIF9jb25zb2xlLCBfY29udHJvbGxlciwgX2NvbnRyb2xsZXJfbWl4aW4sIF9zdHJpbmcsIF9zZXJ2aWNlLCBfb2JqZWN0LCBfY29tcGF0LCBfY29tcHV0ZWQsIF9ydW50aW1lLCBfZ2xpbW1lciwgX3ZlcnNpb24sIHZpZXdzLCByb3V0aW5nLCBleHRlbnNpb25TdXBwb3J0LCBfZXJyb3IsIHJ1bmxvb3AsIF9lcnJvckhhbmRsaW5nLCBfb3duZXIsIF9hcHBsaWNhdGlvbiwgX2dsb2JhbHNSZXNvbHZlciwgX2luc3RhbmNlLCBfZW5naW5lLCBfaW5zdGFuY2UyLCBfcG9seWZpbGxzLCBfZGVwcmVjYXRlZEZlYXR1cmVzLCBfdGVtcGxhdGVPbmx5KSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwogIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBpbXBvcnQvbm8tdW5yZXNvbHZlZAogIC8vICoqKipAZW1iZXIvLWludGVybmFscy9lbnZpcm9ubWVudCoqKioKICB2YXIgRW1iZXIgPSB0eXBlb2YgX2Vudmlyb25tZW50LmNvbnRleHQuaW1wb3J0cy5FbWJlciA9PT0gJ29iamVjdCcgJiYgX2Vudmlyb25tZW50LmNvbnRleHQuaW1wb3J0cy5FbWJlciB8fCB7fTsKICBFbWJlci5pc05hbWVzcGFjZSA9IHRydWU7CgogIEVtYmVyLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuICdFbWJlcic7CiAgfTsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVtYmVyLCAnRU5WJywgewogICAgZ2V0OiBfZW52aXJvbm1lbnQuZ2V0RU5WLAogICAgZW51bWVyYWJsZTogZmFsc2UKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRW1iZXIsICdsb29rdXAnLCB7CiAgICBnZXQ6IF9lbnZpcm9ubWVudC5nZXRMb29rdXAsCiAgICBzZXQ6IF9lbnZpcm9ubWVudC5zZXRMb29rdXAsCiAgICBlbnVtZXJhYmxlOiBmYWxzZQogIH0pOwoKICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5FTUJFUl9FWFRFTkRfUFJPVE9UWVBFUykgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVtYmVyLCAnRVhURU5EX1BST1RPVFlQRVMnLCB7CiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAoZmFsc2UgJiYgIShmYWxzZSkgJiYgKDAsIEVtYmVyRGVidWcuZGVwcmVjYXRlKSgnQWNjZXNzaW5nIEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTIGlzIGRlcHJlY2F0ZWQsIHBsZWFzZSBtaWdyYXRlIHRvIEVtYmVyLkVOVi5FWFRFTkRfUFJPVE9UWVBFUycsIGZhbHNlLCB7CiAgICAgICAgICBpZDogJ2VtYmVyLWVudi5vbGQtZXh0ZW5kLXByb3RvdHlwZXMnLAogICAgICAgICAgdW50aWw6ICc0LjAuMCcKICAgICAgICB9KSk7CiAgICAgICAgcmV0dXJuIF9lbnZpcm9ubWVudC5FTlYuRVhURU5EX1BST1RPVFlQRVM7CiAgICAgIH0KICAgIH0pOwogIH0gLy8gKioqKkBlbWJlci9hcHBsaWNhdGlvbioqKioKCgogIEVtYmVyLmdldE93bmVyID0gX293bmVyLmdldE93bmVyOwogIEVtYmVyLnNldE93bmVyID0gX293bmVyLnNldE93bmVyOwogIEVtYmVyLkFwcGxpY2F0aW9uID0gX2FwcGxpY2F0aW9uLmRlZmF1bHQ7CiAgRW1iZXIuRGVmYXVsdFJlc29sdmVyID0gRW1iZXIuUmVzb2x2ZXIgPSBfZ2xvYmFsc1Jlc29sdmVyLmRlZmF1bHQ7CiAgRW1iZXIuQXBwbGljYXRpb25JbnN0YW5jZSA9IF9pbnN0YW5jZS5kZWZhdWx0OyAvLyAqKioqQGVtYmVyL2VuZ2luZSoqKioKCiAgRW1iZXIuRW5naW5lID0gX2VuZ2luZS5kZWZhdWx0OwogIEVtYmVyLkVuZ2luZUluc3RhbmNlID0gX2luc3RhbmNlMi5kZWZhdWx0OyAvLyAqKioqQGVtYmVyL3BvbHlmaWxscyoqKioKCiAgRW1iZXIuYXNzaWduID0gX3BvbHlmaWxscy5hc3NpZ247CiAgRW1iZXIubWVyZ2UgPSBfcG9seWZpbGxzLm1lcmdlOyAvLyAqKioqQGVtYmVyLy1pbnRlcm5hbHMvdXRpbHMqKioqCgogIEVtYmVyLmdlbmVyYXRlR3VpZCA9IHV0aWxzLmdlbmVyYXRlR3VpZDsKICBFbWJlci5HVUlEX0tFWSA9IHV0aWxzLkdVSURfS0VZOwogIEVtYmVyLmd1aWRGb3IgPSB1dGlscy5ndWlkRm9yOwogIEVtYmVyLmluc3BlY3QgPSB1dGlscy5pbnNwZWN0OwogIEVtYmVyLm1ha2VBcnJheSA9IHV0aWxzLm1ha2VBcnJheTsKICBFbWJlci5jYW5JbnZva2UgPSB1dGlscy5jYW5JbnZva2U7CiAgRW1iZXIudHJ5SW52b2tlID0gdXRpbHMudHJ5SW52b2tlOwogIEVtYmVyLndyYXAgPSB1dGlscy53cmFwOwogIEVtYmVyLnV1aWQgPSB1dGlscy51dWlkOyAvLyAqKioqQGVtYmVyLy1pbnRlcm5hbHMvY29udGFpbmVyKioqKgoKICBFbWJlci5Db250YWluZXIgPSBfY29udGFpbmVyLkNvbnRhaW5lcjsKICBFbWJlci5SZWdpc3RyeSA9IF9jb250YWluZXIuUmVnaXN0cnk7IC8vICoqKipAZW1iZXIvZGVidWcqKioqCgogIEVtYmVyLmFzc2VydCA9IEVtYmVyRGVidWcuYXNzZXJ0OwogIEVtYmVyLndhcm4gPSBFbWJlckRlYnVnLndhcm47CiAgRW1iZXIuZGVidWcgPSBFbWJlckRlYnVnLmRlYnVnOwogIEVtYmVyLmRlcHJlY2F0ZSA9IEVtYmVyRGVidWcuZGVwcmVjYXRlOwogIEVtYmVyLmRlcHJlY2F0ZUZ1bmMgPSBFbWJlckRlYnVnLmRlcHJlY2F0ZUZ1bmM7CiAgRW1iZXIucnVuSW5EZWJ1ZyA9IEVtYmVyRGVidWcucnVuSW5EZWJ1ZzsgLy8gKioqKkBlbWJlci9lcnJvcioqKioKCiAgRW1iZXIuRXJyb3IgPSBfZXJyb3IuZGVmYXVsdDsKICAvKioKICAgIEBwdWJsaWMKICAgIEBjbGFzcyBFbWJlci5EZWJ1ZwogICovCgogIEVtYmVyLkRlYnVnID0gewogICAgcmVnaXN0ZXJEZXByZWNhdGlvbkhhbmRsZXI6IEVtYmVyRGVidWcucmVnaXN0ZXJEZXByZWNhdGlvbkhhbmRsZXIsCiAgICByZWdpc3Rlcldhcm5IYW5kbGVyOiBFbWJlckRlYnVnLnJlZ2lzdGVyV2FybkhhbmRsZXIsCiAgICBpc0NvbXB1dGVkOiBtZXRhbC5pc0NvbXB1dGVkCiAgfTsgLy8gKioqKkBlbWJlci9pbnN0cnVtZW50YXRpb24qKioqCgogIEVtYmVyLmluc3RydW1lbnQgPSBpbnN0cnVtZW50YXRpb24uaW5zdHJ1bWVudDsKICBFbWJlci5zdWJzY3JpYmUgPSBpbnN0cnVtZW50YXRpb24uc3Vic2NyaWJlOwogIEVtYmVyLkluc3RydW1lbnRhdGlvbiA9IHsKICAgIGluc3RydW1lbnQ6IGluc3RydW1lbnRhdGlvbi5pbnN0cnVtZW50LAogICAgc3Vic2NyaWJlOiBpbnN0cnVtZW50YXRpb24uc3Vic2NyaWJlLAogICAgdW5zdWJzY3JpYmU6IGluc3RydW1lbnRhdGlvbi51bnN1YnNjcmliZSwKICAgIHJlc2V0OiBpbnN0cnVtZW50YXRpb24ucmVzZXQKICB9OyAvLyAqKioqQGVtYmVyL3J1bmxvb3AqKioqCiAgLy8gVXNpbmcgX2dsb2JhbHNSdW4gaGVyZSBzbyB0aGF0IG11dGF0aW5nIHRoZSBmdW5jdGlvbiAoYWRkaW5nCiAgLy8gYG5leHRgLCBgbGF0ZXJgLCBldGMgdG8gaXQpIGlzIG9ubHkgYXZhaWxhYmxlIGluIGdsb2JhbHMgYnVpbGRzCgogIEVtYmVyLnJ1biA9IHJ1bmxvb3AuX2dsb2JhbHNSdW47CiAgRW1iZXIucnVuLmJhY2tidXJuZXIgPSBydW5sb29wLmJhY2tidXJuZXI7CiAgRW1iZXIucnVuLmJlZ2luID0gcnVubG9vcC5iZWdpbjsKICBFbWJlci5ydW4uYmluZCA9IHJ1bmxvb3AuYmluZDsKICBFbWJlci5ydW4uY2FuY2VsID0gcnVubG9vcC5jYW5jZWw7CiAgRW1iZXIucnVuLmRlYm91bmNlID0gcnVubG9vcC5kZWJvdW5jZTsKICBFbWJlci5ydW4uZW5kID0gcnVubG9vcC5lbmQ7CiAgRW1iZXIucnVuLmhhc1NjaGVkdWxlZFRpbWVycyA9IHJ1bmxvb3AuaGFzU2NoZWR1bGVkVGltZXJzOwogIEVtYmVyLnJ1bi5qb2luID0gcnVubG9vcC5qb2luOwogIEVtYmVyLnJ1bi5sYXRlciA9IHJ1bmxvb3AubGF0ZXI7CiAgRW1iZXIucnVuLm5leHQgPSBydW5sb29wLm5leHQ7CiAgRW1iZXIucnVuLm9uY2UgPSBydW5sb29wLm9uY2U7CiAgRW1iZXIucnVuLnNjaGVkdWxlID0gcnVubG9vcC5zY2hlZHVsZTsKICBFbWJlci5ydW4uc2NoZWR1bGVPbmNlID0gcnVubG9vcC5zY2hlZHVsZU9uY2U7CiAgRW1iZXIucnVuLnRocm90dGxlID0gcnVubG9vcC50aHJvdHRsZTsKICBFbWJlci5ydW4uY2FuY2VsVGltZXJzID0gcnVubG9vcC5jYW5jZWxUaW1lcnM7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVtYmVyLnJ1biwgJ2N1cnJlbnRSdW5Mb29wJywgewogICAgZ2V0OiBydW5sb29wLmdldEN1cnJlbnRSdW5Mb29wLAogICAgZW51bWVyYWJsZTogZmFsc2UKICB9KTsgLy8gKioqKkBlbWJlci8taW50ZXJuYWxzL21ldGFsKioqKgogIC8vIFVzaW5nIF9nbG9iYWxzQ29tcHV0ZWQgaGVyZSBzbyB0aGF0IG11dGF0aW5nIHRoZSBmdW5jdGlvbiBpcyBvbmx5IGF2YWlsYWJsZQogIC8vIGluIGdsb2JhbHMgYnVpbGRzCgogIHZhciBjb21wdXRlZCA9IG1ldGFsLl9nbG9iYWxzQ29tcHV0ZWQ7CiAgRW1iZXIuY29tcHV0ZWQgPSBjb21wdXRlZDsKICBFbWJlci5fZGVzY3JpcHRvciA9IG1ldGFsLm5hdGl2ZURlc2NEZWNvcmF0b3I7CiAgRW1iZXIuX3RyYWNrZWQgPSBtZXRhbC50cmFja2VkOwogIGNvbXB1dGVkLmFsaWFzID0gbWV0YWwuYWxpYXM7CiAgRW1iZXIuY2FjaGVGb3IgPSBtZXRhbC5nZXRDYWNoZWRWYWx1ZUZvcjsKICBFbWJlci5Db21wdXRlZFByb3BlcnR5ID0gbWV0YWwuQ29tcHV0ZWRQcm9wZXJ0eTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRW1iZXIsICdfc2V0Q29tcHV0ZWREZWNvcmF0b3InLCB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmICgwLCBFbWJlckRlYnVnLmRlcHJlY2F0ZSkoJ1BsZWFzZSBtaWdyYXRlIGZyb20gRW1iZXIuX3NldENvbXB1dGVkRGVjb3JhdG9yIHRvIEVtYmVyLl9zZXRDbGFzc2ljRGVjb3JhdG9yJywgZmFsc2UsIHsKICAgICAgICBpZDogJ2VtYmVyLl9zZXRDb21wdXRlZERlY29yYXRvcicsCiAgICAgICAgdW50aWw6ICczLjEzLjAnCiAgICAgIH0pKTsKICAgICAgcmV0dXJuIG1ldGFsLnNldENsYXNzaWNEZWNvcmF0b3I7CiAgICB9CiAgfSk7CiAgRW1iZXIuX3NldENsYXNzaWNEZWNvcmF0b3IgPSBtZXRhbC5zZXRDbGFzc2ljRGVjb3JhdG9yOwogIEVtYmVyLm1ldGEgPSBfbWV0YS5tZXRhOwogIEVtYmVyLmdldCA9IG1ldGFsLmdldDsKICBFbWJlci5nZXRXaXRoRGVmYXVsdCA9IG1ldGFsLmdldFdpdGhEZWZhdWx0OwogIEVtYmVyLl9nZXRQYXRoID0gbWV0YWwuX2dldFBhdGg7CiAgRW1iZXIuc2V0ID0gbWV0YWwuc2V0OwogIEVtYmVyLnRyeVNldCA9IG1ldGFsLnRyeVNldDsKICBFbWJlci5GRUFUVVJFUyA9ICgwLCBfcG9seWZpbGxzLmFzc2lnbikoewogICAgaXNFbmFibGVkOiBfY2FuYXJ5RmVhdHVyZXMuaXNFbmFibGVkCiAgfSwgX2NhbmFyeUZlYXR1cmVzLkZFQVRVUkVTKTsKICBFbWJlci5fQ2FjaGUgPSB1dGlscy5DYWNoZTsKICBFbWJlci5vbiA9IG1ldGFsLm9uOwogIEVtYmVyLmFkZExpc3RlbmVyID0gbWV0YWwuYWRkTGlzdGVuZXI7CiAgRW1iZXIucmVtb3ZlTGlzdGVuZXIgPSBtZXRhbC5yZW1vdmVMaXN0ZW5lcjsKICBFbWJlci5zZW5kRXZlbnQgPSBtZXRhbC5zZW5kRXZlbnQ7CiAgRW1iZXIuaGFzTGlzdGVuZXJzID0gbWV0YWwuaGFzTGlzdGVuZXJzOwogIEVtYmVyLmlzTm9uZSA9IG1ldGFsLmlzTm9uZTsKICBFbWJlci5pc0VtcHR5ID0gbWV0YWwuaXNFbXB0eTsKICBFbWJlci5pc0JsYW5rID0gbWV0YWwuaXNCbGFuazsKICBFbWJlci5pc1ByZXNlbnQgPSBtZXRhbC5pc1ByZXNlbnQ7CiAgRW1iZXIubm90aWZ5UHJvcGVydHlDaGFuZ2UgPSBtZXRhbC5ub3RpZnlQcm9wZXJ0eUNoYW5nZTsKICBFbWJlci5vdmVycmlkZUNoYWlucyA9IG1ldGFsLm92ZXJyaWRlQ2hhaW5zOwogIEVtYmVyLmJlZ2luUHJvcGVydHlDaGFuZ2VzID0gbWV0YWwuYmVnaW5Qcm9wZXJ0eUNoYW5nZXM7CiAgRW1iZXIuZW5kUHJvcGVydHlDaGFuZ2VzID0gbWV0YWwuZW5kUHJvcGVydHlDaGFuZ2VzOwogIEVtYmVyLmNoYW5nZVByb3BlcnRpZXMgPSBtZXRhbC5jaGFuZ2VQcm9wZXJ0aWVzOwogIEVtYmVyLnBsYXRmb3JtID0gewogICAgZGVmaW5lUHJvcGVydHk6IHRydWUsCiAgICBoYXNQcm9wZXJ0eUFjY2Vzc29yczogdHJ1ZQogIH07CiAgRW1iZXIuZGVmaW5lUHJvcGVydHkgPSBtZXRhbC5kZWZpbmVQcm9wZXJ0eTsKICBFbWJlci53YXRjaEtleSA9IG1ldGFsLndhdGNoS2V5OwogIEVtYmVyLnVud2F0Y2hLZXkgPSBtZXRhbC51bndhdGNoS2V5OwogIEVtYmVyLnJlbW92ZUNoYWluV2F0Y2hlciA9IG1ldGFsLnJlbW92ZUNoYWluV2F0Y2hlcjsKICBFbWJlci5fQ2hhaW5Ob2RlID0gbWV0YWwuQ2hhaW5Ob2RlOwogIEVtYmVyLmZpbmlzaENoYWlucyA9IG1ldGFsLmZpbmlzaENoYWluczsKICBFbWJlci53YXRjaFBhdGggPSBtZXRhbC53YXRjaFBhdGg7CiAgRW1iZXIudW53YXRjaFBhdGggPSBtZXRhbC51bndhdGNoUGF0aDsKICBFbWJlci53YXRjaCA9IG1ldGFsLndhdGNoOwogIEVtYmVyLmlzV2F0Y2hpbmcgPSBtZXRhbC5pc1dhdGNoaW5nOwogIEVtYmVyLnVud2F0Y2ggPSBtZXRhbC51bndhdGNoOwogIEVtYmVyLmRlc3Ryb3kgPSBfbWV0YS5kZWxldGVNZXRhOwogIEVtYmVyLmxpYnJhcmllcyA9IG1ldGFsLmxpYnJhcmllczsKICBFbWJlci5nZXRQcm9wZXJ0aWVzID0gbWV0YWwuZ2V0UHJvcGVydGllczsKICBFbWJlci5zZXRQcm9wZXJ0aWVzID0gbWV0YWwuc2V0UHJvcGVydGllczsKICBFbWJlci5leHBhbmRQcm9wZXJ0aWVzID0gbWV0YWwuZXhwYW5kUHJvcGVydGllczsKICBFbWJlci5hZGRPYnNlcnZlciA9IG1ldGFsLmFkZE9ic2VydmVyOwogIEVtYmVyLnJlbW92ZU9ic2VydmVyID0gbWV0YWwucmVtb3ZlT2JzZXJ2ZXI7CiAgRW1iZXIuYWxpYXNNZXRob2QgPSBtZXRhbC5hbGlhc01ldGhvZDsKICBFbWJlci5vYnNlcnZlciA9IG1ldGFsLm9ic2VydmVyOwogIEVtYmVyLm1peGluID0gbWV0YWwubWl4aW47CiAgRW1iZXIuTWl4aW4gPSBtZXRhbC5NaXhpbjsKICAvKioKICAgIEEgZnVuY3Rpb24gbWF5IGJlIGFzc2lnbmVkIHRvIGBFbWJlci5vbmVycm9yYCB0byBiZSBjYWxsZWQgd2hlbiBFbWJlcgogICAgaW50ZXJuYWxzIGVuY291bnRlciBhbiBlcnJvci4gVGhpcyBpcyB1c2VmdWwgZm9yIHNwZWNpYWxpemVkIGVycm9yIGhhbmRsaW5nCiAgICBhbmQgcmVwb3J0aW5nIGNvZGUuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgJCBmcm9tICdqcXVlcnknOwogIAogICAgRW1iZXIub25lcnJvciA9IGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICQuYWpheCgnL3JlcG9ydC1lcnJvcicsICdQT1NUJywgewogICAgICAgIHN0YWNrOiBlcnJvci5zdGFjaywKICAgICAgICBvdGhlckluZm9ybWF0aW9uOiAnd2hhdGV2ZXIgYXBwIHN0YXRlIHlvdSB3YW50IHRvIHByb3ZpZGUnCiAgICAgIH0pOwogICAgfTsKICAgIGBgYAogIAogICAgSW50ZXJuYWxseSwgYEVtYmVyLm9uZXJyb3JgIGlzIHVzZWQgYXMgQmFja2J1cm5lcidzIGVycm9yIGhhbmRsZXIuCiAgCiAgICBAZXZlbnQgb25lcnJvcgogICAgQGZvciBFbWJlcgogICAgQHBhcmFtIHtFeGNlcHRpb259IGVycm9yIHRoZSBlcnJvciBvYmplY3QKICAgIEBwdWJsaWMKICAqLwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRW1iZXIsICdvbmVycm9yJywgewogICAgZ2V0OiBfZXJyb3JIYW5kbGluZy5nZXRPbmVycm9yLAogICAgc2V0OiBfZXJyb3JIYW5kbGluZy5zZXRPbmVycm9yLAogICAgZW51bWVyYWJsZTogZmFsc2UKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRW1iZXIsICd0ZXN0aW5nJywgewogICAgZ2V0OiBFbWJlckRlYnVnLmlzVGVzdGluZywKICAgIHNldDogRW1iZXJEZWJ1Zy5zZXRUZXN0aW5nLAogICAgZW51bWVyYWJsZTogZmFsc2UKICB9KTsKICBFbWJlci5fQmFja2J1cm5lciA9IF9iYWNrYnVybmVyLmRlZmF1bHQ7IC8vICoqKipAZW1iZXIvLWludGVybmFscy9jb25zb2xlKioqKgoKICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5MT0dHRVIpIHsKICAgIEVtYmVyLkxvZ2dlciA9IF9jb25zb2xlLmRlZmF1bHQ7CiAgfSAvLyAqKioqQGVtYmVyLy1pbnRlcm5hbHMvcnVudGltZSoqKioKCgogIEVtYmVyLkEgPSBfcnVudGltZS5BOwogIEVtYmVyLlN0cmluZyA9IHsKICAgIGxvYzogX3N0cmluZy5sb2MsCiAgICB3OiBfc3RyaW5nLncsCiAgICBkYXNoZXJpemU6IF9zdHJpbmcuZGFzaGVyaXplLAogICAgZGVjYW1lbGl6ZTogX3N0cmluZy5kZWNhbWVsaXplLAogICAgY2FtZWxpemU6IF9zdHJpbmcuY2FtZWxpemUsCiAgICBjbGFzc2lmeTogX3N0cmluZy5jbGFzc2lmeSwKICAgIHVuZGVyc2NvcmU6IF9zdHJpbmcudW5kZXJzY29yZSwKICAgIGNhcGl0YWxpemU6IF9zdHJpbmcuY2FwaXRhbGl6ZQogIH07CiAgRW1iZXIuT2JqZWN0ID0gX3J1bnRpbWUuT2JqZWN0OwogIEVtYmVyLl9SZWdpc3RyeVByb3h5TWl4aW4gPSBfcnVudGltZS5SZWdpc3RyeVByb3h5TWl4aW47CiAgRW1iZXIuX0NvbnRhaW5lclByb3h5TWl4aW4gPSBfcnVudGltZS5Db250YWluZXJQcm94eU1peGluOwogIEVtYmVyLmNvbXBhcmUgPSBfcnVudGltZS5jb21wYXJlOwogIEVtYmVyLmNvcHkgPSBfcnVudGltZS5jb3B5OwogIEVtYmVyLmlzRXF1YWwgPSBfcnVudGltZS5pc0VxdWFsOwogIEVtYmVyLl9zZXRGcmFtZXdvcmtDbGFzcyA9IF9ydW50aW1lLnNldEZyYW1ld29ya0NsYXNzOwogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwoKICAvKioKICAgIE5hbWVzcGFjZSBmb3IgaW5qZWN0aW9uIGhlbHBlciBtZXRob2RzLgogIAogICAgQGNsYXNzIGluamVjdAogICAgQG5hbWVzcGFjZSBFbWJlcgogICAgQHN0YXRpYwogICAgQHB1YmxpYwogICovCgogIEVtYmVyLmluamVjdCA9IGZ1bmN0aW9uIGluamVjdCgpIHsKICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgRW1iZXJEZWJ1Zy5hc3NlcnQpKCJJbmplY3RlZCBwcm9wZXJ0aWVzIG11c3QgYmUgY3JlYXRlZCB0aHJvdWdoIGhlbHBlcnMsIHNlZSAnIiArIE9iamVjdC5rZXlzKGluamVjdCkubWFwKGZ1bmN0aW9uIChrKSB7CiAgICAgIHJldHVybiAiJ2luamVjdC4iICsgayArICInIjsKICAgIH0pLmpvaW4oJyBvciAnKSArICInIikpOwogIH07CgogIEVtYmVyLmluamVjdC5zZXJ2aWNlID0gX3NlcnZpY2UuaW5qZWN0OwogIEVtYmVyLmluamVjdC5jb250cm9sbGVyID0gX2NvbnRyb2xsZXIuaW5qZWN0OwogIEVtYmVyLkFycmF5ID0gX3J1bnRpbWUuQXJyYXk7CiAgRW1iZXIuQ29tcGFyYWJsZSA9IF9ydW50aW1lLkNvbXBhcmFibGU7CiAgRW1iZXIuRW51bWVyYWJsZSA9IF9ydW50aW1lLkVudW1lcmFibGU7CiAgRW1iZXIuQXJyYXlQcm94eSA9IF9ydW50aW1lLkFycmF5UHJveHk7CiAgRW1iZXIuT2JqZWN0UHJveHkgPSBfcnVudGltZS5PYmplY3RQcm94eTsKICBFbWJlci5BY3Rpb25IYW5kbGVyID0gX3J1bnRpbWUuQWN0aW9uSGFuZGxlcjsKICBFbWJlci5Db3JlT2JqZWN0ID0gX3J1bnRpbWUuQ29yZU9iamVjdDsKICBFbWJlci5OYXRpdmVBcnJheSA9IF9ydW50aW1lLk5hdGl2ZUFycmF5OwogIEVtYmVyLkNvcHlhYmxlID0gX3J1bnRpbWUuQ29weWFibGU7CiAgRW1iZXIuTXV0YWJsZUVudW1lcmFibGUgPSBfcnVudGltZS5NdXRhYmxlRW51bWVyYWJsZTsKICBFbWJlci5NdXRhYmxlQXJyYXkgPSBfcnVudGltZS5NdXRhYmxlQXJyYXk7CiAgRW1iZXIuVGFyZ2V0QWN0aW9uU3VwcG9ydCA9IF9ydW50aW1lLlRhcmdldEFjdGlvblN1cHBvcnQ7CiAgRW1iZXIuRXZlbnRlZCA9IF9ydW50aW1lLkV2ZW50ZWQ7CiAgRW1iZXIuUHJvbWlzZVByb3h5TWl4aW4gPSBfcnVudGltZS5Qcm9taXNlUHJveHlNaXhpbjsKICBFbWJlci5PYnNlcnZhYmxlID0gX3J1bnRpbWUuT2JzZXJ2YWJsZTsKICBFbWJlci50eXBlT2YgPSBfcnVudGltZS50eXBlT2Y7CiAgRW1iZXIuaXNBcnJheSA9IF9ydW50aW1lLmlzQXJyYXk7CiAgRW1iZXIuT2JqZWN0ID0gX3J1bnRpbWUuT2JqZWN0OwogIEVtYmVyLm9uTG9hZCA9IF9hcHBsaWNhdGlvbi5vbkxvYWQ7CiAgRW1iZXIucnVuTG9hZEhvb2tzID0gX2FwcGxpY2F0aW9uLnJ1bkxvYWRIb29rczsKICBFbWJlci5Db250cm9sbGVyID0gX2NvbnRyb2xsZXIuZGVmYXVsdDsKICBFbWJlci5Db250cm9sbGVyTWl4aW4gPSBfY29udHJvbGxlcl9taXhpbi5kZWZhdWx0OwogIEVtYmVyLlNlcnZpY2UgPSBfc2VydmljZS5kZWZhdWx0OwogIEVtYmVyLl9Qcm94eU1peGluID0gX3J1bnRpbWUuX1Byb3h5TWl4aW47CiAgRW1iZXIuUlNWUCA9IF9ydW50aW1lLlJTVlA7CiAgRW1iZXIuTmFtZXNwYWNlID0gX3J1bnRpbWUuTmFtZXNwYWNlOwogIEVtYmVyLl9hY3Rpb24gPSBfb2JqZWN0LmFjdGlvbjsKICBFbWJlci5fZGVwZW5kZW50S2V5Q29tcGF0ID0gX2NvbXBhdC5kZXBlbmRlbnRLZXlDb21wYXQ7CiAgY29tcHV0ZWQuZW1wdHkgPSBfY29tcHV0ZWQuZW1wdHk7CiAgY29tcHV0ZWQubm90RW1wdHkgPSBfY29tcHV0ZWQubm90RW1wdHk7CiAgY29tcHV0ZWQubm9uZSA9IF9jb21wdXRlZC5ub25lOwogIGNvbXB1dGVkLm5vdCA9IF9jb21wdXRlZC5ub3Q7CiAgY29tcHV0ZWQuYm9vbCA9IF9jb21wdXRlZC5ib29sOwogIGNvbXB1dGVkLm1hdGNoID0gX2NvbXB1dGVkLm1hdGNoOwogIGNvbXB1dGVkLmVxdWFsID0gX2NvbXB1dGVkLmVxdWFsOwogIGNvbXB1dGVkLmd0ID0gX2NvbXB1dGVkLmd0OwogIGNvbXB1dGVkLmd0ZSA9IF9jb21wdXRlZC5ndGU7CiAgY29tcHV0ZWQubHQgPSBfY29tcHV0ZWQubHQ7CiAgY29tcHV0ZWQubHRlID0gX2NvbXB1dGVkLmx0ZTsKICBjb21wdXRlZC5vbmVXYXkgPSBfY29tcHV0ZWQub25lV2F5OwogIGNvbXB1dGVkLnJlYWRzID0gX2NvbXB1dGVkLm9uZVdheTsKICBjb21wdXRlZC5yZWFkT25seSA9IF9jb21wdXRlZC5yZWFkT25seTsKICBjb21wdXRlZC5kZXByZWNhdGluZ0FsaWFzID0gX2NvbXB1dGVkLmRlcHJlY2F0aW5nQWxpYXM7CiAgY29tcHV0ZWQuYW5kID0gX2NvbXB1dGVkLmFuZDsKICBjb21wdXRlZC5vciA9IF9jb21wdXRlZC5vcjsKICBjb21wdXRlZC5zdW0gPSBfY29tcHV0ZWQuc3VtOwogIGNvbXB1dGVkLm1pbiA9IF9jb21wdXRlZC5taW47CiAgY29tcHV0ZWQubWF4ID0gX2NvbXB1dGVkLm1heDsKICBjb21wdXRlZC5tYXAgPSBfY29tcHV0ZWQubWFwOwogIGNvbXB1dGVkLnNvcnQgPSBfY29tcHV0ZWQuc29ydDsKICBjb21wdXRlZC5zZXREaWZmID0gX2NvbXB1dGVkLnNldERpZmY7CiAgY29tcHV0ZWQubWFwQnkgPSBfY29tcHV0ZWQubWFwQnk7CiAgY29tcHV0ZWQuZmlsdGVyID0gX2NvbXB1dGVkLmZpbHRlcjsKICBjb21wdXRlZC5maWx0ZXJCeSA9IF9jb21wdXRlZC5maWx0ZXJCeTsKICBjb21wdXRlZC51bmlxID0gX2NvbXB1dGVkLnVuaXE7CiAgY29tcHV0ZWQudW5pcUJ5ID0gX2NvbXB1dGVkLnVuaXFCeTsKICBjb21wdXRlZC51bmlvbiA9IF9jb21wdXRlZC51bmlvbjsKICBjb21wdXRlZC5pbnRlcnNlY3QgPSBfY29tcHV0ZWQuaW50ZXJzZWN0OwogIGNvbXB1dGVkLmNvbGxlY3QgPSBfY29tcHV0ZWQuY29sbGVjdDsKICAvKioKICAgIERlZmluZXMgdGhlIGhhc2ggb2YgbG9jYWxpemVkIHN0cmluZ3MgZm9yIHRoZSBjdXJyZW50IGxhbmd1YWdlLiBVc2VkIGJ5CiAgICB0aGUgYFN0cmluZy5sb2NgIGhlbHBlci4gVG8gbG9jYWxpemUsIGFkZCBzdHJpbmcgdmFsdWVzIHRvIHRoaXMKICAgIGhhc2guCiAgCiAgICBAcHJvcGVydHkgU1RSSU5HUwogICAgQGZvciBFbWJlcgogICAgQHR5cGUgT2JqZWN0CiAgICBAcHJpdmF0ZQogICovCgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbWJlciwgJ1NUUklOR1MnLCB7CiAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgZ2V0OiBfc3RyaW5nLl9nZXRTdHJpbmdzLAogICAgc2V0OiBfc3RyaW5nLl9zZXRTdHJpbmdzCiAgfSk7CiAgLyoqCiAgICBXaGV0aGVyIHNlYXJjaGluZyBvbiB0aGUgZ2xvYmFsIGZvciBuZXcgTmFtZXNwYWNlIGluc3RhbmNlcyBpcyBlbmFibGVkLgogIAogICAgVGhpcyBpcyBvbmx5IGV4cG9ydGVkIGhlcmUgYXMgdG8gbm90IGJyZWFrIGFueSBhZGRvbnMuICBHaXZlbiB0aGUgbmV3CiAgICB2aXNpdCBBUEksIHlvdSB3aWxsIGhhdmUgaXNzdWVzIGlmIHlvdSB0cmVhdCB0aGlzIGFzIGEgaW5kaWNhdG9yIG9mCiAgICBib290ZWQuCiAgCiAgICBJbnRlcm5hbGx5IHRoaXMgaXMgb25seSBleHBvc2luZyBhIGZsYWcgaW4gTmFtZXNwYWNlLgogIAogICAgQHByb3BlcnR5IEJPT1RFRAogICAgQGZvciBFbWJlcgogICAgQHR5cGUgQm9vbGVhbgogICAgQHByaXZhdGUKICAqLwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRW1iZXIsICdCT09URUQnLCB7CiAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICBnZXQ6IG1ldGFsLmlzTmFtZXNwYWNlU2VhcmNoRGlzYWJsZWQsCiAgICBzZXQ6IG1ldGFsLnNldE5hbWVzcGFjZVNlYXJjaERpc2FibGVkCiAgfSk7IC8vICoqKipAZW1iZXIvLWludGVybmFscy9nbGltbWVyKioqKgoKICBFbWJlci5Db21wb25lbnQgPSBfZ2xpbW1lci5Db21wb25lbnQ7CiAgX2dsaW1tZXIuSGVscGVyLmhlbHBlciA9IF9nbGltbWVyLmhlbHBlcjsKICBFbWJlci5IZWxwZXIgPSBfZ2xpbW1lci5IZWxwZXI7CiAgRW1iZXIuQ2hlY2tib3ggPSBfZ2xpbW1lci5DaGVja2JveDsKICBFbWJlci5UZXh0RmllbGQgPSBfZ2xpbW1lci5UZXh0RmllbGQ7CiAgRW1iZXIuVGV4dEFyZWEgPSBfZ2xpbW1lci5UZXh0QXJlYTsKICBFbWJlci5MaW5rQ29tcG9uZW50ID0gX2dsaW1tZXIuTGlua0NvbXBvbmVudDsKICBFbWJlci5fc2V0Q29tcG9uZW50TWFuYWdlciA9IF9nbGltbWVyLnNldENvbXBvbmVudE1hbmFnZXI7CiAgRW1iZXIuX2NvbXBvbmVudE1hbmFnZXJDYXBhYmlsaXRpZXMgPSBfZ2xpbW1lci5jYXBhYmlsaXRpZXM7CiAgRW1iZXIuX3NldE1vZGlmaWVyTWFuYWdlciA9IF9nbGltbWVyLnNldE1vZGlmaWVyTWFuYWdlcjsKICBFbWJlci5fbW9kaWZpZXJNYW5hZ2VyQ2FwYWJpbGl0aWVzID0gX2dsaW1tZXIubW9kaWZpZXJDYXBhYmlsaXRpZXM7CgogIGlmICh0cnVlCiAgLyogRU1CRVJfR0xJTU1FUl9TRVRfQ09NUE9ORU5UX1RFTVBMQVRFICovCiAgKSB7CiAgICAgIEVtYmVyLl9nZXRDb21wb25lbnRUZW1wbGF0ZSA9IF9nbGltbWVyLmdldENvbXBvbmVudFRlbXBsYXRlOwogICAgICBFbWJlci5fc2V0Q29tcG9uZW50VGVtcGxhdGUgPSBfZ2xpbW1lci5zZXRDb21wb25lbnRUZW1wbGF0ZTsKICAgICAgRW1iZXIuX3RlbXBsYXRlT25seUNvbXBvbmVudCA9IF90ZW1wbGF0ZU9ubHkuZGVmYXVsdDsKICAgIH0KCiAgRW1iZXIuX2NhcHR1cmVSZW5kZXJUcmVlID0gRW1iZXJEZWJ1Zy5jYXB0dXJlUmVuZGVyVHJlZTsKICBFbWJlci5IYW5kbGViYXJzID0gewogICAgdGVtcGxhdGU6IF9nbGltbWVyLnRlbXBsYXRlLAogICAgVXRpbHM6IHsKICAgICAgZXNjYXBlRXhwcmVzc2lvbjogX2dsaW1tZXIuZXNjYXBlRXhwcmVzc2lvbgogICAgfQogIH07CiAgRW1iZXIuSFRNTEJhcnMgPSB7CiAgICB0ZW1wbGF0ZTogX2dsaW1tZXIudGVtcGxhdGUKICB9OwoKICBpZiAoX2Vudmlyb25tZW50LkVOVi5FWFRFTkRfUFJPVE9UWVBFUy5TdHJpbmcpIHsKICAgIFN0cmluZy5wcm90b3R5cGUuaHRtbFNhZmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAoMCwgX2dsaW1tZXIuaHRtbFNhZmUpKHRoaXMpOwogICAgfTsKICB9CgogIEVtYmVyLlN0cmluZy5odG1sU2FmZSA9IF9nbGltbWVyLmh0bWxTYWZlOwogIEVtYmVyLlN0cmluZy5pc0hUTUxTYWZlID0gX2dsaW1tZXIuaXNIVE1MU2FmZTsKICAvKioKICAgIEdsb2JhbCBoYXNoIG9mIHNoYXJlZCB0ZW1wbGF0ZXMuIFRoaXMgd2lsbCBhdXRvbWF0aWNhbGx5IGJlIHBvcHVsYXRlZAogICAgYnkgdGhlIGJ1aWxkIHRvb2xzIHNvIHRoYXQgeW91IGNhbiBzdG9yZSB5b3VyIEhhbmRsZWJhcnMgdGVtcGxhdGVzIGluCiAgICBzZXBhcmF0ZSBmaWxlcyB0aGF0IGdldCBsb2FkZWQgaW50byBKYXZhU2NyaXB0IGF0IGJ1aWxkdGltZS4KICAKICAgIEBwcm9wZXJ0eSBURU1QTEFURVMKICAgIEBmb3IgRW1iZXIKICAgIEB0eXBlIE9iamVjdAogICAgQHByaXZhdGUKICAqLwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRW1iZXIsICdURU1QTEFURVMnLCB7CiAgICBnZXQ6IF9nbGltbWVyLmdldFRlbXBsYXRlcywKICAgIHNldDogX2dsaW1tZXIuc2V0VGVtcGxhdGVzLAogICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgIGVudW1lcmFibGU6IGZhbHNlCiAgfSk7CiAgLyoqCiAgICBUaGUgc2VtYW50aWMgdmVyc2lvbgogIAogICAgQHByb3BlcnR5IFZFUlNJT04KICAgIEB0eXBlIFN0cmluZwogICAgQHB1YmxpYwogICovCgogIEVtYmVyLlZFUlNJT04gPSBfdmVyc2lvbi5kZWZhdWx0OyAvLyAqKioqQGVtYmVyLy1pbnRlcm5hbHMvdmlld3MqKioqCgogIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLkpRVUVSWV9JTlRFR1JBVElPTiAmJiAhdmlld3MualF1ZXJ5RGlzYWJsZWQpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbWJlciwgJyQnLCB7CiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIChmYWxzZSAmJiAhKGZhbHNlKSAmJiAoMCwgRW1iZXJEZWJ1Zy5kZXByZWNhdGUpKCJVc2luZyBFbWJlci4kKCkgaGFzIGJlZW4gZGVwcmVjYXRlZCwgdXNlIGBpbXBvcnQgalF1ZXJ5IGZyb20gJ2pxdWVyeSc7YCBpbnN0ZWFkIiwgZmFsc2UsIHsKICAgICAgICAgIGlkOiAnZW1iZXItdmlld3MuY3VybHktY29tcG9uZW50cy5qcXVlcnktZWxlbWVudCcsCiAgICAgICAgICB1bnRpbDogJzQuMC4wJywKICAgICAgICAgIHVybDogJ2h0dHBzOi8vZW1iZXJqcy5jb20vZGVwcmVjYXRpb25zL3YzLngjdG9jX2pxdWVyeS1hcGlzJwogICAgICAgIH0pKTsKICAgICAgICByZXR1cm4gdmlld3MualF1ZXJ5OwogICAgICB9LAogICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgIGVudW1lcmFibGU6IHRydWUKICAgIH0pOwogIH0KCiAgRW1iZXIuVmlld1V0aWxzID0gewogICAgaXNTaW1wbGVDbGljazogdmlld3MuaXNTaW1wbGVDbGljaywKICAgIGdldEVsZW1lbnRWaWV3OiB2aWV3cy5nZXRFbGVtZW50VmlldywKICAgIGdldFZpZXdFbGVtZW50OiB2aWV3cy5nZXRWaWV3RWxlbWVudCwKICAgIGdldFZpZXdCb3VuZHM6IHZpZXdzLmdldFZpZXdCb3VuZHMsCiAgICBnZXRWaWV3Q2xpZW50UmVjdHM6IHZpZXdzLmdldFZpZXdDbGllbnRSZWN0cywKICAgIGdldFZpZXdCb3VuZGluZ0NsaWVudFJlY3Q6IHZpZXdzLmdldFZpZXdCb3VuZGluZ0NsaWVudFJlY3QsCiAgICBnZXRSb290Vmlld3M6IHZpZXdzLmdldFJvb3RWaWV3cywKICAgIGdldENoaWxkVmlld3M6IHZpZXdzLmdldENoaWxkVmlld3MsCiAgICBpc1NlcmlhbGl6YXRpb25GaXJzdE5vZGU6IF9nbGltbWVyLmlzU2VyaWFsaXphdGlvbkZpcnN0Tm9kZQogIH07CiAgRW1iZXIuVGV4dFN1cHBvcnQgPSB2aWV3cy5UZXh0U3VwcG9ydDsKICBFbWJlci5Db21wb25lbnRMb29rdXAgPSB2aWV3cy5Db21wb25lbnRMb29rdXA7CiAgRW1iZXIuRXZlbnREaXNwYXRjaGVyID0gdmlld3MuRXZlbnREaXNwYXRjaGVyOyAvLyAqKioqQGVtYmVyLy1pbnRlcm5hbHMvcm91dGluZyoqKioKCiAgRW1iZXIuTG9jYXRpb24gPSByb3V0aW5nLkxvY2F0aW9uOwogIEVtYmVyLkF1dG9Mb2NhdGlvbiA9IHJvdXRpbmcuQXV0b0xvY2F0aW9uOwogIEVtYmVyLkhhc2hMb2NhdGlvbiA9IHJvdXRpbmcuSGFzaExvY2F0aW9uOwogIEVtYmVyLkhpc3RvcnlMb2NhdGlvbiA9IHJvdXRpbmcuSGlzdG9yeUxvY2F0aW9uOwogIEVtYmVyLk5vbmVMb2NhdGlvbiA9IHJvdXRpbmcuTm9uZUxvY2F0aW9uOwogIEVtYmVyLmNvbnRyb2xsZXJGb3IgPSByb3V0aW5nLmNvbnRyb2xsZXJGb3I7CiAgRW1iZXIuZ2VuZXJhdGVDb250cm9sbGVyRmFjdG9yeSA9IHJvdXRpbmcuZ2VuZXJhdGVDb250cm9sbGVyRmFjdG9yeTsKICBFbWJlci5nZW5lcmF0ZUNvbnRyb2xsZXIgPSByb3V0aW5nLmdlbmVyYXRlQ29udHJvbGxlcjsKICBFbWJlci5Sb3V0ZXJEU0wgPSByb3V0aW5nLlJvdXRlckRTTDsKICBFbWJlci5Sb3V0ZXIgPSByb3V0aW5nLlJvdXRlcjsKICBFbWJlci5Sb3V0ZSA9IHJvdXRpbmcuUm91dGU7CiAgKDAsIF9hcHBsaWNhdGlvbi5ydW5Mb2FkSG9va3MpKCdFbWJlci5BcHBsaWNhdGlvbicsIF9hcHBsaWNhdGlvbi5kZWZhdWx0KTsKICBFbWJlci5EYXRhQWRhcHRlciA9IGV4dGVuc2lvblN1cHBvcnQuRGF0YUFkYXB0ZXI7CiAgRW1iZXIuQ29udGFpbmVyRGVidWdBZGFwdGVyID0gZXh0ZW5zaW9uU3VwcG9ydC5Db250YWluZXJEZWJ1Z0FkYXB0ZXI7CgogIGlmICgoMCwgX3JlcXVpcmUuaGFzKSgnZW1iZXItdGVtcGxhdGUtY29tcGlsZXInKSkgewogICAgKDAsIF9yZXF1aXJlLmRlZmF1bHQpKCJlbWJlci10ZW1wbGF0ZS1jb21waWxlciIpOwogIH0gLy8gZG8gdGhpcyB0byBlbnN1cmUgdGhhdCBFbWJlci5UZXN0IGlzIGRlZmluZWQgcHJvcGVybHkgb24gdGhlIGdsb2JhbAogIC8vIGlmIGl0IGlzIHByZXNlbnQuCgoKICBpZiAoKDAsIF9yZXF1aXJlLmhhcykoJ2VtYmVyLXRlc3RpbmcnKSkgewogICAgdmFyIHRlc3RpbmcgPSAoMCwgX3JlcXVpcmUuZGVmYXVsdCkoImVtYmVyLXRlc3RpbmciKTsKICAgIEVtYmVyLlRlc3QgPSB0ZXN0aW5nLlRlc3Q7CiAgICBFbWJlci5UZXN0LkFkYXB0ZXIgPSB0ZXN0aW5nLkFkYXB0ZXI7CiAgICBFbWJlci5UZXN0LlFVbml0QWRhcHRlciA9IHRlc3RpbmcuUVVuaXRBZGFwdGVyOwogICAgRW1iZXIuc2V0dXBGb3JUZXN0aW5nID0gdGVzdGluZy5zZXR1cEZvclRlc3Rpbmc7CiAgfQoKICAoMCwgX2FwcGxpY2F0aW9uLnJ1bkxvYWRIb29rcykoJ0VtYmVyJyk7CiAgdmFyIF9kZWZhdWx0ID0gRW1iZXI7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0OwoKICBpZiAoX25vZGVNb2R1bGUuSVNfTk9ERSkgewogICAgX25vZGVNb2R1bGUubW9kdWxlLmV4cG9ydHMgPSBFbWJlcjsKICB9IGVsc2UgewogICAgX2Vudmlyb25tZW50LmNvbnRleHQuZXhwb3J0cy5FbWJlciA9IF9lbnZpcm9ubWVudC5jb250ZXh0LmV4cG9ydHMuRW0gPSBFbWJlcjsKICB9CiAgLyoqCiAgIEBtb2R1bGUganF1ZXJ5CiAgIEBwdWJsaWMKICAgKi8KCiAgLyoqCiAgIEBjbGFzcyBqcXVlcnkKICAgQHB1YmxpYwogICBAc3RhdGljCiAgICovCgogIC8qKgogICAgQWxpYXMgZm9yIGpRdWVyeQogIAogICAgQGZvciBqcXVlcnkKICAgIEBtZXRob2QgJAogICAgQHN0YXRpYwogICAgQHB1YmxpYwogICovCgp9KTsKZGVmaW5lKCJlbWJlci92ZXJzaW9uIiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKICB2YXIgX2RlZmF1bHQgPSAiMy4xNC4xIjsKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoIm5vZGUtbW9kdWxlL2luZGV4IiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMucmVxdWlyZSA9IF9leHBvcnRzLm1vZHVsZSA9IF9leHBvcnRzLklTX05PREUgPSB2b2lkIDA7CgogIC8qZ2xvYmFsIG1vZHVsZSAqLwogIHZhciBJU19OT0RFID0gdHlwZW9mIG1vZHVsZSA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZS5yZXF1aXJlID09PSAnZnVuY3Rpb24nOwogIF9leHBvcnRzLklTX05PREUgPSBJU19OT0RFOwogIHZhciBleHBvcnRNb2R1bGU7CiAgX2V4cG9ydHMubW9kdWxlID0gZXhwb3J0TW9kdWxlOwogIHZhciBleHBvcnRSZXF1aXJlOwogIF9leHBvcnRzLnJlcXVpcmUgPSBleHBvcnRSZXF1aXJlOwoKICBpZiAoSVNfTk9ERSkgewogICAgX2V4cG9ydHMubW9kdWxlID0gZXhwb3J0TW9kdWxlID0gbW9kdWxlOwogICAgX2V4cG9ydHMucmVxdWlyZSA9IGV4cG9ydFJlcXVpcmUgPSBtb2R1bGUucmVxdWlyZTsKICB9IGVsc2UgewogICAgX2V4cG9ydHMubW9kdWxlID0gZXhwb3J0TW9kdWxlID0gbnVsbDsKICAgIF9leHBvcnRzLnJlcXVpcmUgPSBleHBvcnRSZXF1aXJlID0gbnVsbDsKICB9Cn0pOwpkZWZpbmUoInJvdXRlLXJlY29nbml6ZXIiLCBbImV4cG9ydHMiXSwgZnVuY3Rpb24gKF9leHBvcnRzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwogIHZhciBjcmVhdGVPYmplY3QgPSBPYmplY3QuY3JlYXRlOwoKICBmdW5jdGlvbiBjcmVhdGVNYXAoKSB7CiAgICB2YXIgbWFwID0gY3JlYXRlT2JqZWN0KG51bGwpOwogICAgbWFwWyJfXyJdID0gdW5kZWZpbmVkOwogICAgZGVsZXRlIG1hcFsiX18iXTsKICAgIHJldHVybiBtYXA7CiAgfQoKICB2YXIgVGFyZ2V0ID0gZnVuY3Rpb24gVGFyZ2V0KHBhdGgsIG1hdGNoZXIsIGRlbGVnYXRlKSB7CiAgICB0aGlzLnBhdGggPSBwYXRoOwogICAgdGhpcy5tYXRjaGVyID0gbWF0Y2hlcjsKICAgIHRoaXMuZGVsZWdhdGUgPSBkZWxlZ2F0ZTsKICB9OwoKICBUYXJnZXQucHJvdG90eXBlLnRvID0gZnVuY3Rpb24gdG8odGFyZ2V0LCBjYWxsYmFjaykgewogICAgdmFyIGRlbGVnYXRlID0gdGhpcy5kZWxlZ2F0ZTsKCiAgICBpZiAoZGVsZWdhdGUgJiYgZGVsZWdhdGUud2lsbEFkZFJvdXRlKSB7CiAgICAgIHRhcmdldCA9IGRlbGVnYXRlLndpbGxBZGRSb3V0ZSh0aGlzLm1hdGNoZXIudGFyZ2V0LCB0YXJnZXQpOwogICAgfQoKICAgIHRoaXMubWF0Y2hlci5hZGQodGhpcy5wYXRoLCB0YXJnZXQpOwoKICAgIGlmIChjYWxsYmFjaykgewogICAgICBpZiAoY2FsbGJhY2subGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgbXVzdCBoYXZlIGFuIGFyZ3VtZW50IGluIHRoZSBmdW5jdGlvbiBwYXNzZWQgdG8gYHRvYCIpOwogICAgICB9CgogICAgICB0aGlzLm1hdGNoZXIuYWRkQ2hpbGQodGhpcy5wYXRoLCB0YXJnZXQsIGNhbGxiYWNrLCB0aGlzLmRlbGVnYXRlKTsKICAgIH0KICB9OwoKICB2YXIgTWF0Y2hlciA9IGZ1bmN0aW9uIE1hdGNoZXIodGFyZ2V0KSB7CiAgICB0aGlzLnJvdXRlcyA9IGNyZWF0ZU1hcCgpOwogICAgdGhpcy5jaGlsZHJlbiA9IGNyZWF0ZU1hcCgpOwogICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7CiAgfTsKCiAgTWF0Y2hlci5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gYWRkKHBhdGgsIHRhcmdldCkgewogICAgdGhpcy5yb3V0ZXNbcGF0aF0gPSB0YXJnZXQ7CiAgfTsKCiAgTWF0Y2hlci5wcm90b3R5cGUuYWRkQ2hpbGQgPSBmdW5jdGlvbiBhZGRDaGlsZChwYXRoLCB0YXJnZXQsIGNhbGxiYWNrLCBkZWxlZ2F0ZSkgewogICAgdmFyIG1hdGNoZXIgPSBuZXcgTWF0Y2hlcih0YXJnZXQpOwogICAgdGhpcy5jaGlsZHJlbltwYXRoXSA9IG1hdGNoZXI7CiAgICB2YXIgbWF0Y2ggPSBnZW5lcmF0ZU1hdGNoKHBhdGgsIG1hdGNoZXIsIGRlbGVnYXRlKTsKCiAgICBpZiAoZGVsZWdhdGUgJiYgZGVsZWdhdGUuY29udGV4dEVudGVyZWQpIHsKICAgICAgZGVsZWdhdGUuY29udGV4dEVudGVyZWQodGFyZ2V0LCBtYXRjaCk7CiAgICB9CgogICAgY2FsbGJhY2sobWF0Y2gpOwogIH07CgogIGZ1bmN0aW9uIGdlbmVyYXRlTWF0Y2goc3RhcnRpbmdQYXRoLCBtYXRjaGVyLCBkZWxlZ2F0ZSkgewogICAgZnVuY3Rpb24gbWF0Y2gocGF0aCwgY2FsbGJhY2spIHsKICAgICAgdmFyIGZ1bGxQYXRoID0gc3RhcnRpbmdQYXRoICsgcGF0aDsKCiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrKGdlbmVyYXRlTWF0Y2goZnVsbFBhdGgsIG1hdGNoZXIsIGRlbGVnYXRlKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG5ldyBUYXJnZXQoZnVsbFBhdGgsIG1hdGNoZXIsIGRlbGVnYXRlKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBtYXRjaDsKICB9CgogIGZ1bmN0aW9uIGFkZFJvdXRlKHJvdXRlQXJyYXksIHBhdGgsIGhhbmRsZXIpIHsKICAgIHZhciBsZW4gPSAwOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcm91dGVBcnJheS5sZW5ndGg7IGkrKykgewogICAgICBsZW4gKz0gcm91dGVBcnJheVtpXS5wYXRoLmxlbmd0aDsKICAgIH0KCiAgICBwYXRoID0gcGF0aC5zdWJzdHIobGVuKTsKICAgIHZhciByb3V0ZSA9IHsKICAgICAgcGF0aDogcGF0aCwKICAgICAgaGFuZGxlcjogaGFuZGxlcgogICAgfTsKICAgIHJvdXRlQXJyYXkucHVzaChyb3V0ZSk7CiAgfQoKICBmdW5jdGlvbiBlYWNoUm91dGUoYmFzZVJvdXRlLCBtYXRjaGVyLCBjYWxsYmFjaywgYmluZGluZykgewogICAgdmFyIHJvdXRlcyA9IG1hdGNoZXIucm91dGVzOwogICAgdmFyIHBhdGhzID0gT2JqZWN0LmtleXMocm91dGVzKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGhzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBwYXRoID0gcGF0aHNbaV07CiAgICAgIHZhciByb3V0ZUFycmF5ID0gYmFzZVJvdXRlLnNsaWNlKCk7CiAgICAgIGFkZFJvdXRlKHJvdXRlQXJyYXksIHBhdGgsIHJvdXRlc1twYXRoXSk7CiAgICAgIHZhciBuZXN0ZWQgPSBtYXRjaGVyLmNoaWxkcmVuW3BhdGhdOwoKICAgICAgaWYgKG5lc3RlZCkgewogICAgICAgIGVhY2hSb3V0ZShyb3V0ZUFycmF5LCBuZXN0ZWQsIGNhbGxiYWNrLCBiaW5kaW5nKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFjay5jYWxsKGJpbmRpbmcsIHJvdXRlQXJyYXkpOwogICAgICB9CiAgICB9CiAgfQoKICB2YXIgbWFwID0gZnVuY3Rpb24gbWFwKGNhbGxiYWNrLCBhZGRSb3V0ZUNhbGxiYWNrKSB7CiAgICB2YXIgbWF0Y2hlciA9IG5ldyBNYXRjaGVyKCk7CiAgICBjYWxsYmFjayhnZW5lcmF0ZU1hdGNoKCIiLCBtYXRjaGVyLCB0aGlzLmRlbGVnYXRlKSk7CiAgICBlYWNoUm91dGUoW10sIG1hdGNoZXIsIGZ1bmN0aW9uIChyb3V0ZXMpIHsKICAgICAgaWYgKGFkZFJvdXRlQ2FsbGJhY2spIHsKICAgICAgICBhZGRSb3V0ZUNhbGxiYWNrKHRoaXMsIHJvdXRlcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hZGQocm91dGVzKTsKICAgICAgfQogICAgfSwgdGhpcyk7CiAgfTsgLy8gTm9ybWFsaXplcyBwZXJjZW50LWVuY29kZWQgdmFsdWVzIGluIGBwYXRoYCB0byB1cHBlci1jYXNlIGFuZCBkZWNvZGVzIHBlcmNlbnQtZW5jb2RlZAogIC8vIHZhbHVlcyB0aGF0IGFyZSBub3QgcmVzZXJ2ZWQgKGkuZS4sIHVuaWNvZGUgY2hhcmFjdGVycywgZW1vamksIGV0YykuIFRoZSByZXNlcnZlZAogIC8vIGNoYXJzIGFyZSAiLyIgYW5kICIlIi4KICAvLyBTYWZlIHRvIGNhbGwgbXVsdGlwbGUgdGltZXMgb24gdGhlIHNhbWUgcGF0aC4KICAvLyBOb3JtYWxpemVzIHBlcmNlbnQtZW5jb2RlZCB2YWx1ZXMgaW4gYHBhdGhgIHRvIHVwcGVyLWNhc2UgYW5kIGRlY29kZXMgcGVyY2VudC1lbmNvZGVkCgoKICBmdW5jdGlvbiBub3JtYWxpemVQYXRoKHBhdGgpIHsKICAgIHJldHVybiBwYXRoLnNwbGl0KCIvIikubWFwKG5vcm1hbGl6ZVNlZ21lbnQpLmpvaW4oIi8iKTsKICB9IC8vIFdlIHdhbnQgdG8gZW5zdXJlIHRoZSBjaGFyYWN0ZXJzICIlIiBhbmQgIi8iIHJlbWFpbiBpbiBwZXJjZW50LWVuY29kZWQKICAvLyBmb3JtIHdoZW4gbm9ybWFsaXppbmcgcGF0aHMsIHNvIHJlcGxhY2UgdGhlbSB3aXRoIHRoZWlyIGVuY29kZWQgZm9ybSBhZnRlcgogIC8vIGRlY29kaW5nIHRoZSByZXN0IG9mIHRoZSBwYXRoCgoKICB2YXIgU0VHTUVOVF9SRVNFUlZFRF9DSEFSUyA9IC8lfFwvL2c7CgogIGZ1bmN0aW9uIG5vcm1hbGl6ZVNlZ21lbnQoc2VnbWVudCkgewogICAgaWYgKHNlZ21lbnQubGVuZ3RoIDwgMyB8fCBzZWdtZW50LmluZGV4T2YoIiUiKSA9PT0gLTEpIHsKICAgICAgcmV0dXJuIHNlZ21lbnQ7CiAgICB9CgogICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChzZWdtZW50KS5yZXBsYWNlKFNFR01FTlRfUkVTRVJWRURfQ0hBUlMsIGVuY29kZVVSSUNvbXBvbmVudCk7CiAgfSAvLyBXZSBkbyBub3Qgd2FudCB0byBlbmNvZGUgdGhlc2UgY2hhcmFjdGVycyB3aGVuIGdlbmVyYXRpbmcgZHluYW1pYyBwYXRoIHNlZ21lbnRzCiAgLy8gU2VlIGh0dHBzOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmMzOTg2I3NlY3Rpb24tMy4zCiAgLy8gc3ViLWRlbGltczogIiEiLCAiJCIsICImIiwgIiciLCAiKCIsICIpIiwgIioiLCAiKyIsICIsIiwgIjsiLCAiPSIKICAvLyBvdGhlcnMgYWxsb3dlZCBieSBSRkMgMzk4NjogIjoiLCAiQCIKICAvLwogIC8vIEZpcnN0IGVuY29kZSB0aGUgZW50aXJlIHBhdGggc2VnbWVudCwgdGhlbiBkZWNvZGUgYW55IG9mIHRoZSBlbmNvZGVkIHNwZWNpYWwgY2hhcnMuCiAgLy8KICAvLyBUaGUgY2hhcnMgIiEiLCAiJyIsICIoIiwgIikiLCAiKiIgZG8gbm90IGdldCBjaGFuZ2VkIGJ5IGBlbmNvZGVVUklDb21wb25lbnRgLAogIC8vIHNvIHRoZSBwb3NzaWJsZSBlbmNvZGVkIGNoYXJzIGFyZToKICAvLyBbJyUyNCcsICclMjYnLCAnJTJCJywgJyUyQycsICclM0InLCAnJTNEJywgJyUzQScsICclNDAnXS4KCgogIHZhciBQQVRIX1NFR01FTlRfRU5DT0RJTkdTID0gLyUoPzoyKD86NHw2fEJ8Qyl8Myg/OkJ8RHxBKXw0MCkvZzsKCiAgZnVuY3Rpb24gZW5jb2RlUGF0aFNlZ21lbnQoc3RyKSB7CiAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cikucmVwbGFjZShQQVRIX1NFR01FTlRfRU5DT0RJTkdTLCBkZWNvZGVVUklDb21wb25lbnQpOwogIH0KCiAgdmFyIGVzY2FwZVJlZ2V4ID0gLyhcL3xcLnxcKnxcK3xcP3xcfHxcKHxcKXxcW3xcXXxce3xcfXxcXCkvZzsKICB2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXk7CiAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKCiAgZnVuY3Rpb24gZ2V0UGFyYW0ocGFyYW1zLCBrZXkpIHsKICAgIGlmICh0eXBlb2YgcGFyYW1zICE9PSAib2JqZWN0IiB8fCBwYXJhbXMgPT09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgbXVzdCBwYXNzIGFuIG9iamVjdCBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50IHRvIGBnZW5lcmF0ZWAuIik7CiAgICB9CgogICAgaWYgKCFoYXNPd25Qcm9wZXJ0eS5jYWxsKHBhcmFtcywga2V5KSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIllvdSBtdXN0IHByb3ZpZGUgcGFyYW0gYCIgKyBrZXkgKyAiYCB0byBgZ2VuZXJhdGVgLiIpOwogICAgfQoKICAgIHZhciB2YWx1ZSA9IHBhcmFtc1trZXldOwogICAgdmFyIHN0ciA9IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgPyB2YWx1ZSA6ICIiICsgdmFsdWU7CgogICAgaWYgKHN0ci5sZW5ndGggPT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgbXVzdCBwcm92aWRlIGEgcGFyYW0gYCIgKyBrZXkgKyAiYC4iKTsKICAgIH0KCiAgICByZXR1cm4gc3RyOwogIH0KCiAgdmFyIGVhY2hDaGFyID0gW107CgogIGVhY2hDaGFyWzAKICAvKiBTdGF0aWMgKi8KICBdID0gZnVuY3Rpb24gKHNlZ21lbnQsIGN1cnJlbnRTdGF0ZSkgewogICAgdmFyIHN0YXRlID0gY3VycmVudFN0YXRlOwogICAgdmFyIHZhbHVlID0gc2VnbWVudC52YWx1ZTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBjaCA9IHZhbHVlLmNoYXJDb2RlQXQoaSk7CiAgICAgIHN0YXRlID0gc3RhdGUucHV0KGNoLCBmYWxzZSwgZmFsc2UpOwogICAgfQoKICAgIHJldHVybiBzdGF0ZTsKICB9OwoKICBlYWNoQ2hhclsxCiAgLyogRHluYW1pYyAqLwogIF0gPSBmdW5jdGlvbiAoXywgY3VycmVudFN0YXRlKSB7CiAgICByZXR1cm4gY3VycmVudFN0YXRlLnB1dCg0NwogICAgLyogU0xBU0ggKi8KICAgICwgdHJ1ZSwgdHJ1ZSk7CiAgfTsKCiAgZWFjaENoYXJbMgogIC8qIFN0YXIgKi8KICBdID0gZnVuY3Rpb24gKF8sIGN1cnJlbnRTdGF0ZSkgewogICAgcmV0dXJuIGN1cnJlbnRTdGF0ZS5wdXQoLTEKICAgIC8qIEFOWSAqLwogICAgLCBmYWxzZSwgdHJ1ZSk7CiAgfTsKCiAgZWFjaENoYXJbNAogIC8qIEVwc2lsb24gKi8KICBdID0gZnVuY3Rpb24gKF8sIGN1cnJlbnRTdGF0ZSkgewogICAgcmV0dXJuIGN1cnJlbnRTdGF0ZTsKICB9OwoKICB2YXIgcmVnZXggPSBbXTsKCiAgcmVnZXhbMAogIC8qIFN0YXRpYyAqLwogIF0gPSBmdW5jdGlvbiAoc2VnbWVudCkgewogICAgcmV0dXJuIHNlZ21lbnQudmFsdWUucmVwbGFjZShlc2NhcGVSZWdleCwgIlxcJDEiKTsKICB9OwoKICByZWdleFsxCiAgLyogRHluYW1pYyAqLwogIF0gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gIihbXi9dKykiOwogIH07CgogIHJlZ2V4WzIKICAvKiBTdGFyICovCiAgXSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiAiKC4rKSI7CiAgfTsKCiAgcmVnZXhbNAogIC8qIEVwc2lsb24gKi8KICBdID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuICIiOwogIH07CgogIHZhciBnZW5lcmF0ZSA9IFtdOwoKICBnZW5lcmF0ZVswCiAgLyogU3RhdGljICovCiAgXSA9IGZ1bmN0aW9uIChzZWdtZW50KSB7CiAgICByZXR1cm4gc2VnbWVudC52YWx1ZTsKICB9OwoKICBnZW5lcmF0ZVsxCiAgLyogRHluYW1pYyAqLwogIF0gPSBmdW5jdGlvbiAoc2VnbWVudCwgcGFyYW1zKSB7CiAgICB2YXIgdmFsdWUgPSBnZXRQYXJhbShwYXJhbXMsIHNlZ21lbnQudmFsdWUpOwoKICAgIGlmIChSb3V0ZVJlY29nbml6ZXIuRU5DT0RFX0FORF9ERUNPREVfUEFUSF9TRUdNRU5UUykgewogICAgICByZXR1cm4gZW5jb2RlUGF0aFNlZ21lbnQodmFsdWUpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogIH07CgogIGdlbmVyYXRlWzIKICAvKiBTdGFyICovCiAgXSA9IGZ1bmN0aW9uIChzZWdtZW50LCBwYXJhbXMpIHsKICAgIHJldHVybiBnZXRQYXJhbShwYXJhbXMsIHNlZ21lbnQudmFsdWUpOwogIH07CgogIGdlbmVyYXRlWzQKICAvKiBFcHNpbG9uICovCiAgXSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiAiIjsKICB9OwoKICB2YXIgRW1wdHlPYmplY3QgPSBPYmplY3QuZnJlZXplKHt9KTsKICB2YXIgRW1wdHlBcnJheSA9IE9iamVjdC5mcmVlemUoW10pOyAvLyBUaGUgYG5hbWVzYCB3aWxsIGJlIHBvcHVsYXRlZCB3aXRoIHRoZSBwYXJhbXRlciBuYW1lIGZvciBlYWNoIGR5bmFtaWMvc3RhcgogIC8vIHNlZ21lbnQuIGBzaG91bGREZWNvZGVzYCB3aWxsIGJlIHBvcHVsYXRlZCB3aXRoIGEgYm9vbGVhbiBmb3IgZWFjaCBkeWFuYW1pYy9zdGFyCiAgLy8gc2VnbWVudCwgaW5kaWNhdGluZyB3aGV0aGVyIGl0IHNob3VsZCBiZSBkZWNvZGVkIGR1cmluZyByZWNvZ25pdGlvbi4KCiAgZnVuY3Rpb24gcGFyc2Uoc2VnbWVudHMsIHJvdXRlLCB0eXBlcykgewogICAgLy8gbm9ybWFsaXplIHJvdXRlIGFzIG5vdCBzdGFydGluZyB3aXRoIGEgIi8iLiBSZWNvZ25pdGlvbiB3aWxsCiAgICAvLyBhbHNvIG5vcm1hbGl6ZS4KICAgIGlmIChyb3V0ZS5sZW5ndGggPiAwICYmIHJvdXRlLmNoYXJDb2RlQXQoMCkgPT09IDQ3CiAgICAvKiBTTEFTSCAqLwogICAgKSB7CiAgICAgICAgcm91dGUgPSByb3V0ZS5zdWJzdHIoMSk7CiAgICAgIH0KCiAgICB2YXIgcGFydHMgPSByb3V0ZS5zcGxpdCgiLyIpOwogICAgdmFyIG5hbWVzID0gdW5kZWZpbmVkOwogICAgdmFyIHNob3VsZERlY29kZXMgPSB1bmRlZmluZWQ7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgcGFydCA9IHBhcnRzW2ldOwogICAgICB2YXIgZmxhZ3MgPSAwOwogICAgICB2YXIgdHlwZSA9IDA7CgogICAgICBpZiAocGFydCA9PT0gIiIpIHsKICAgICAgICB0eXBlID0gNAogICAgICAgIC8qIEVwc2lsb24gKi8KICAgICAgICA7CiAgICAgIH0gZWxzZSBpZiAocGFydC5jaGFyQ29kZUF0KDApID09PSA1OAogICAgICAvKiBDT0xPTiAqLwogICAgICApIHsKICAgICAgICAgIHR5cGUgPSAxCiAgICAgICAgICAvKiBEeW5hbWljICovCiAgICAgICAgICA7CiAgICAgICAgfSBlbHNlIGlmIChwYXJ0LmNoYXJDb2RlQXQoMCkgPT09IDQyCiAgICAgIC8qIFNUQVIgKi8KICAgICAgKSB7CiAgICAgICAgICB0eXBlID0gMgogICAgICAgICAgLyogU3RhciAqLwogICAgICAgICAgOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgdHlwZSA9IDAKICAgICAgICAvKiBTdGF0aWMgKi8KICAgICAgICA7CiAgICAgIH0KCiAgICAgIGZsYWdzID0gMiA8PCB0eXBlOwoKICAgICAgaWYgKGZsYWdzICYgMTIKICAgICAgLyogTmFtZWQgKi8KICAgICAgKSB7CiAgICAgICAgICBwYXJ0ID0gcGFydC5zbGljZSgxKTsKICAgICAgICAgIG5hbWVzID0gbmFtZXMgfHwgW107CiAgICAgICAgICBuYW1lcy5wdXNoKHBhcnQpOwogICAgICAgICAgc2hvdWxkRGVjb2RlcyA9IHNob3VsZERlY29kZXMgfHwgW107CiAgICAgICAgICBzaG91bGREZWNvZGVzLnB1c2goKGZsYWdzICYgNAogICAgICAgICAgLyogRGVjb2RlZCAqLwogICAgICAgICAgKSAhPT0gMCk7CiAgICAgICAgfQoKICAgICAgaWYgKGZsYWdzICYgMTQKICAgICAgLyogQ291bnRlZCAqLwogICAgICApIHsKICAgICAgICAgIHR5cGVzW3R5cGVdKys7CiAgICAgICAgfQoKICAgICAgc2VnbWVudHMucHVzaCh7CiAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICB2YWx1ZTogbm9ybWFsaXplU2VnbWVudChwYXJ0KQogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICBuYW1lczogbmFtZXMgfHwgRW1wdHlBcnJheSwKICAgICAgc2hvdWxkRGVjb2Rlczogc2hvdWxkRGVjb2RlcyB8fCBFbXB0eUFycmF5CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gaXNFcXVhbENoYXJTcGVjKHNwZWMsIGNoYXIsIG5lZ2F0ZSkgewogICAgcmV0dXJuIHNwZWMuY2hhciA9PT0gY2hhciAmJiBzcGVjLm5lZ2F0ZSA9PT0gbmVnYXRlOwogIH0gLy8gQSBTdGF0ZSBoYXMgYSBjaGFyYWN0ZXIgc3BlY2lmaWNhdGlvbiBhbmQgKGBjaGFyU3BlY2ApIGFuZCBhIGxpc3Qgb2YgcG9zc2libGUKICAvLyBzdWJzZXF1ZW50IHN0YXRlcyAoYG5leHRTdGF0ZXNgKS4KICAvLwogIC8vIElmIGEgU3RhdGUgaXMgYW4gYWNjZXB0aW5nIHN0YXRlLCBpdCB3aWxsIGFsc28gaGF2ZSBzZXZlcmFsIGFkZGl0aW9uYWwKICAvLyBwcm9wZXJ0aWVzOgogIC8vCiAgLy8gKiBgcmVnZXhgOiBBIHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIHVzZWQgdG8gZXh0cmFjdCBwYXJhbWV0ZXJzIGZyb20gcGF0aHMKICAvLyAgIHRoYXQgcmVhY2hlZCB0aGlzIGFjY2VwdGluZyBzdGF0ZS4KICAvLyAqIGBoYW5kbGVyc2A6IEluZm9ybWF0aW9uIG9uIGhvdyB0byBjb252ZXJ0IHRoZSBsaXN0IG9mIGNhcHR1cmVzIGludG8gY2FsbHMKICAvLyAgIHRvIHJlZ2lzdGVyZWQgaGFuZGxlcnMgd2l0aCB0aGUgc3BlY2lmaWVkIHBhcmFtZXRlcnMKICAvLyAqIGB0eXBlc2A6IEhvdyBtYW55IHN0YXRpYywgZHluYW1pYyBvciBzdGFyIHNlZ21lbnRzIGluIHRoaXMgcm91dGUuIFVzZWQgdG8KICAvLyAgIGRlY2lkZSB3aGljaCByb3V0ZSB0byB1c2UgaWYgbXVsdGlwbGUgcmVnaXN0ZXJlZCByb3V0ZXMgbWF0Y2ggYSBwYXRoLgogIC8vCiAgLy8gQ3VycmVudGx5LCBTdGF0ZSBpcyBpbXBsZW1lbnRlZCBuYWl2ZWx5IGJ5IGxvb3Bpbmcgb3ZlciBgbmV4dFN0YXRlc2AgYW5kCiAgLy8gY29tcGFyaW5nIGEgY2hhcmFjdGVyIHNwZWNpZmljYXRpb24gYWdhaW5zdCBhIGNoYXJhY3Rlci4gQSBtb3JlIGVmZmljaWVudAogIC8vIGltcGxlbWVudGF0aW9uIHdvdWxkIHVzZSBhIGhhc2ggb2Yga2V5cyBwb2ludGluZyBhdCBvbmUgb3IgbW9yZSBuZXh0IHN0YXRlcy4KCgogIHZhciBTdGF0ZSA9IGZ1bmN0aW9uIFN0YXRlKHN0YXRlcywgaWQsIGNoYXIsIG5lZ2F0ZSwgcmVwZWF0KSB7CiAgICB0aGlzLnN0YXRlcyA9IHN0YXRlczsKICAgIHRoaXMuaWQgPSBpZDsKICAgIHRoaXMuY2hhciA9IGNoYXI7CiAgICB0aGlzLm5lZ2F0ZSA9IG5lZ2F0ZTsKICAgIHRoaXMubmV4dFN0YXRlcyA9IHJlcGVhdCA/IGlkIDogbnVsbDsKICAgIHRoaXMucGF0dGVybiA9ICIiOwogICAgdGhpcy5fcmVnZXggPSB1bmRlZmluZWQ7CiAgICB0aGlzLmhhbmRsZXJzID0gdW5kZWZpbmVkOwogICAgdGhpcy50eXBlcyA9IHVuZGVmaW5lZDsKICB9OwoKICBTdGF0ZS5wcm90b3R5cGUucmVnZXggPSBmdW5jdGlvbiByZWdleCQxKCkgewogICAgaWYgKCF0aGlzLl9yZWdleCkgewogICAgICB0aGlzLl9yZWdleCA9IG5ldyBSZWdFeHAodGhpcy5wYXR0ZXJuKTsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5fcmVnZXg7CiAgfTsKCiAgU3RhdGUucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldChjaGFyLCBuZWdhdGUpIHsKICAgIHZhciB0aGlzJDEgPSB0aGlzOwogICAgdmFyIG5leHRTdGF0ZXMgPSB0aGlzLm5leHRTdGF0ZXM7CgogICAgaWYgKG5leHRTdGF0ZXMgPT09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChpc0FycmF5KG5leHRTdGF0ZXMpKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV4dFN0YXRlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBjaGlsZCA9IHRoaXMkMS5zdGF0ZXNbbmV4dFN0YXRlc1tpXV07CgogICAgICAgIGlmIChpc0VxdWFsQ2hhclNwZWMoY2hpbGQsIGNoYXIsIG5lZ2F0ZSkpIHsKICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBjaGlsZCQxID0gdGhpcy5zdGF0ZXNbbmV4dFN0YXRlc107CgogICAgICBpZiAoaXNFcXVhbENoYXJTcGVjKGNoaWxkJDEsIGNoYXIsIG5lZ2F0ZSkpIHsKICAgICAgICByZXR1cm4gY2hpbGQkMTsKICAgICAgfQogICAgfQogIH07CgogIFN0YXRlLnByb3RvdHlwZS5wdXQgPSBmdW5jdGlvbiBwdXQoY2hhciwgbmVnYXRlLCByZXBlYXQpIHsKICAgIHZhciBzdGF0ZTsgLy8gSWYgdGhlIGNoYXJhY3RlciBzcGVjaWZpY2F0aW9uIGFscmVhZHkgZXhpc3RzIGluIGEgY2hpbGQgb2YgdGhlIGN1cnJlbnQKICAgIC8vIHN0YXRlLCBqdXN0IHJldHVybiB0aGF0IHN0YXRlLgoKICAgIGlmIChzdGF0ZSA9IHRoaXMuZ2V0KGNoYXIsIG5lZ2F0ZSkpIHsKICAgICAgcmV0dXJuIHN0YXRlOwogICAgfSAvLyBNYWtlIGEgbmV3IHN0YXRlIGZvciB0aGUgY2hhcmFjdGVyIHNwZWMKCgogICAgdmFyIHN0YXRlcyA9IHRoaXMuc3RhdGVzOwogICAgc3RhdGUgPSBuZXcgU3RhdGUoc3RhdGVzLCBzdGF0ZXMubGVuZ3RoLCBjaGFyLCBuZWdhdGUsIHJlcGVhdCk7CiAgICBzdGF0ZXNbc3RhdGVzLmxlbmd0aF0gPSBzdGF0ZTsgLy8gSW5zZXJ0IHRoZSBuZXcgc3RhdGUgYXMgYSBjaGlsZCBvZiB0aGUgY3VycmVudCBzdGF0ZQoKICAgIGlmICh0aGlzLm5leHRTdGF0ZXMgPT0gbnVsbCkgewogICAgICB0aGlzLm5leHRTdGF0ZXMgPSBzdGF0ZS5pZDsKICAgIH0gZWxzZSBpZiAoaXNBcnJheSh0aGlzLm5leHRTdGF0ZXMpKSB7CiAgICAgIHRoaXMubmV4dFN0YXRlcy5wdXNoKHN0YXRlLmlkKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMubmV4dFN0YXRlcyA9IFt0aGlzLm5leHRTdGF0ZXMsIHN0YXRlLmlkXTsKICAgIH0gLy8gUmV0dXJuIHRoZSBuZXcgc3RhdGUKCgogICAgcmV0dXJuIHN0YXRlOwogIH07IC8vIEZpbmQgYSBsaXN0IG9mIGNoaWxkIHN0YXRlcyBtYXRjaGluZyB0aGUgbmV4dCBjaGFyYWN0ZXIKCgogIFN0YXRlLnByb3RvdHlwZS5tYXRjaCA9IGZ1bmN0aW9uIG1hdGNoKGNoKSB7CiAgICB2YXIgdGhpcyQxID0gdGhpczsKICAgIHZhciBuZXh0U3RhdGVzID0gdGhpcy5uZXh0U3RhdGVzOwoKICAgIGlmICghbmV4dFN0YXRlcykgewogICAgICByZXR1cm4gW107CiAgICB9CgogICAgdmFyIHJldHVybmVkID0gW107CgogICAgaWYgKGlzQXJyYXkobmV4dFN0YXRlcykpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXh0U3RhdGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGNoaWxkID0gdGhpcyQxLnN0YXRlc1tuZXh0U3RhdGVzW2ldXTsKCiAgICAgICAgaWYgKGlzTWF0Y2goY2hpbGQsIGNoKSkgewogICAgICAgICAgcmV0dXJuZWQucHVzaChjaGlsZCk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgY2hpbGQkMSA9IHRoaXMuc3RhdGVzW25leHRTdGF0ZXNdOwoKICAgICAgaWYgKGlzTWF0Y2goY2hpbGQkMSwgY2gpKSB7CiAgICAgICAgcmV0dXJuZWQucHVzaChjaGlsZCQxKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByZXR1cm5lZDsKICB9OwoKICBmdW5jdGlvbiBpc01hdGNoKHNwZWMsIGNoYXIpIHsKICAgIHJldHVybiBzcGVjLm5lZ2F0ZSA/IHNwZWMuY2hhciAhPT0gY2hhciAmJiBzcGVjLmNoYXIgIT09IC0xCiAgICAvKiBBTlkgKi8KICAgIDogc3BlYy5jaGFyID09PSBjaGFyIHx8IHNwZWMuY2hhciA9PT0gLTEKICAgIC8qIEFOWSAqLwogICAgOwogIH0gLy8gVGhpcyBpcyBhIHNvbWV3aGF0IG5haXZlIHN0cmF0ZWd5LCBidXQgc2hvdWxkIHdvcmsgaW4gYSBsb3Qgb2YgY2FzZXMKICAvLyBBIGJldHRlciBzdHJhdGVneSB3b3VsZCBwcm9wZXJseSByZXNvbHZlIC9wb3N0cy86aWQvbmV3IGFuZCAvcG9zdHMvZWRpdC86aWQuCiAgLy8KICAvLyBUaGlzIHN0cmF0ZWd5IGdlbmVyYWxseSBwcmVmZXJzIG1vcmUgc3RhdGljIGFuZCBsZXNzIGR5bmFtaWMgbWF0Y2hpbmcuCiAgLy8gU3BlY2lmaWNhbGx5LCBpdAogIC8vCiAgLy8gICogcHJlZmVycyBmZXdlciBzdGFycyB0byBtb3JlLCB0aGVuCiAgLy8gICogcHJlZmVycyB1c2luZyBzdGFycyBmb3IgbGVzcyBvZiB0aGUgbWF0Y2ggdG8gbW9yZSwgdGhlbgogIC8vICAqIHByZWZlcnMgZmV3ZXIgZHluYW1pYyBzZWdtZW50cyB0byBtb3JlLCB0aGVuCiAgLy8gICogcHJlZmVycyBtb3JlIHN0YXRpYyBzZWdtZW50cyB0byBtb3JlCgoKICBmdW5jdGlvbiBzb3J0U29sdXRpb25zKHN0YXRlcykgewogICAgcmV0dXJuIHN0YXRlcy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgIHZhciByZWYgPSBhLnR5cGVzIHx8IFswLCAwLCAwXTsKICAgICAgdmFyIGFzdGF0aWNzID0gcmVmWzBdOwogICAgICB2YXIgYWR5bmFtaWNzID0gcmVmWzFdOwogICAgICB2YXIgYXN0YXJzID0gcmVmWzJdOwogICAgICB2YXIgcmVmJDEgPSBiLnR5cGVzIHx8IFswLCAwLCAwXTsKICAgICAgdmFyIGJzdGF0aWNzID0gcmVmJDFbMF07CiAgICAgIHZhciBiZHluYW1pY3MgPSByZWYkMVsxXTsKICAgICAgdmFyIGJzdGFycyA9IHJlZiQxWzJdOwoKICAgICAgaWYgKGFzdGFycyAhPT0gYnN0YXJzKSB7CiAgICAgICAgcmV0dXJuIGFzdGFycyAtIGJzdGFyczsKICAgICAgfQoKICAgICAgaWYgKGFzdGFycykgewogICAgICAgIGlmIChhc3RhdGljcyAhPT0gYnN0YXRpY3MpIHsKICAgICAgICAgIHJldHVybiBic3RhdGljcyAtIGFzdGF0aWNzOwogICAgICAgIH0KCiAgICAgICAgaWYgKGFkeW5hbWljcyAhPT0gYmR5bmFtaWNzKSB7CiAgICAgICAgICByZXR1cm4gYmR5bmFtaWNzIC0gYWR5bmFtaWNzOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGFkeW5hbWljcyAhPT0gYmR5bmFtaWNzKSB7CiAgICAgICAgcmV0dXJuIGFkeW5hbWljcyAtIGJkeW5hbWljczsKICAgICAgfQoKICAgICAgaWYgKGFzdGF0aWNzICE9PSBic3RhdGljcykgewogICAgICAgIHJldHVybiBic3RhdGljcyAtIGFzdGF0aWNzOwogICAgICB9CgogICAgICByZXR1cm4gMDsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gcmVjb2duaXplQ2hhcihzdGF0ZXMsIGNoKSB7CiAgICB2YXIgbmV4dFN0YXRlcyA9IFtdOwoKICAgIGZvciAodmFyIGkgPSAwLCBsID0gc3RhdGVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICB2YXIgc3RhdGUgPSBzdGF0ZXNbaV07CiAgICAgIG5leHRTdGF0ZXMgPSBuZXh0U3RhdGVzLmNvbmNhdChzdGF0ZS5tYXRjaChjaCkpOwogICAgfQoKICAgIHJldHVybiBuZXh0U3RhdGVzOwogIH0KCiAgdmFyIFJlY29nbml6ZVJlc3VsdHMgPSBmdW5jdGlvbiBSZWNvZ25pemVSZXN1bHRzKHF1ZXJ5UGFyYW1zKSB7CiAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICB0aGlzLnF1ZXJ5UGFyYW1zID0gcXVlcnlQYXJhbXMgfHwge307CiAgfTsKCiAgUmVjb2duaXplUmVzdWx0cy5wcm90b3R5cGUuc3BsaWNlID0gQXJyYXkucHJvdG90eXBlLnNwbGljZTsKICBSZWNvZ25pemVSZXN1bHRzLnByb3RvdHlwZS5zbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICBSZWNvZ25pemVSZXN1bHRzLnByb3RvdHlwZS5wdXNoID0gQXJyYXkucHJvdG90eXBlLnB1c2g7CgogIGZ1bmN0aW9uIGZpbmRIYW5kbGVyKHN0YXRlLCBvcmlnaW5hbFBhdGgsIHF1ZXJ5UGFyYW1zKSB7CiAgICB2YXIgaGFuZGxlcnMgPSBzdGF0ZS5oYW5kbGVyczsKICAgIHZhciByZWdleCA9IHN0YXRlLnJlZ2V4KCk7CgogICAgaWYgKCFyZWdleCB8fCAhaGFuZGxlcnMpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBub3QgaW5pdGlhbGl6ZWQiKTsKICAgIH0KCiAgICB2YXIgY2FwdHVyZXMgPSBvcmlnaW5hbFBhdGgubWF0Y2gocmVnZXgpOwogICAgdmFyIGN1cnJlbnRDYXB0dXJlID0gMTsKICAgIHZhciByZXN1bHQgPSBuZXcgUmVjb2duaXplUmVzdWx0cyhxdWVyeVBhcmFtcyk7CiAgICByZXN1bHQubGVuZ3RoID0gaGFuZGxlcnMubGVuZ3RoOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGFuZGxlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGhhbmRsZXIgPSBoYW5kbGVyc1tpXTsKICAgICAgdmFyIG5hbWVzID0gaGFuZGxlci5uYW1lczsKICAgICAgdmFyIHNob3VsZERlY29kZXMgPSBoYW5kbGVyLnNob3VsZERlY29kZXM7CiAgICAgIHZhciBwYXJhbXMgPSBFbXB0eU9iamVjdDsKICAgICAgdmFyIGlzRHluYW1pYyA9IGZhbHNlOwoKICAgICAgaWYgKG5hbWVzICE9PSBFbXB0eUFycmF5ICYmIHNob3VsZERlY29kZXMgIT09IEVtcHR5QXJyYXkpIHsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IG5hbWVzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBpc0R5bmFtaWMgPSB0cnVlOwogICAgICAgICAgdmFyIG5hbWUgPSBuYW1lc1tqXTsKICAgICAgICAgIHZhciBjYXB0dXJlID0gY2FwdHVyZXMgJiYgY2FwdHVyZXNbY3VycmVudENhcHR1cmUrK107CgogICAgICAgICAgaWYgKHBhcmFtcyA9PT0gRW1wdHlPYmplY3QpIHsKICAgICAgICAgICAgcGFyYW1zID0ge307CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKFJvdXRlUmVjb2duaXplci5FTkNPREVfQU5EX0RFQ09ERV9QQVRIX1NFR01FTlRTICYmIHNob3VsZERlY29kZXNbal0pIHsKICAgICAgICAgICAgcGFyYW1zW25hbWVdID0gY2FwdHVyZSAmJiBkZWNvZGVVUklDb21wb25lbnQoY2FwdHVyZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwYXJhbXNbbmFtZV0gPSBjYXB0dXJlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmVzdWx0W2ldID0gewogICAgICAgIGhhbmRsZXI6IGhhbmRsZXIuaGFuZGxlciwKICAgICAgICBwYXJhbXM6IHBhcmFtcywKICAgICAgICBpc0R5bmFtaWM6IGlzRHluYW1pYwogICAgICB9OwogICAgfQoKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBmdW5jdGlvbiBkZWNvZGVRdWVyeVBhcmFtUGFydChwYXJ0KSB7CiAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9odG1sNDAxL2ludGVyYWN0L2Zvcm1zLmh0bWwjaC0xNy4xMy40LjEKICAgIHBhcnQgPSBwYXJ0LnJlcGxhY2UoL1wrL2dtLCAiJTIwIik7CiAgICB2YXIgcmVzdWx0OwoKICAgIHRyeSB7CiAgICAgIHJlc3VsdCA9IGRlY29kZVVSSUNvbXBvbmVudChwYXJ0KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIHJlc3VsdCA9ICIiOwogICAgfQoKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICB2YXIgUm91dGVSZWNvZ25pemVyID0gZnVuY3Rpb24gUm91dGVSZWNvZ25pemVyKCkgewogICAgdGhpcy5uYW1lcyA9IGNyZWF0ZU1hcCgpOwogICAgdmFyIHN0YXRlcyA9IFtdOwogICAgdmFyIHN0YXRlID0gbmV3IFN0YXRlKHN0YXRlcywgMCwgLTEKICAgIC8qIEFOWSAqLwogICAgLCB0cnVlLCBmYWxzZSk7CiAgICBzdGF0ZXNbMF0gPSBzdGF0ZTsKICAgIHRoaXMuc3RhdGVzID0gc3RhdGVzOwogICAgdGhpcy5yb290U3RhdGUgPSBzdGF0ZTsKICB9OwoKICBSb3V0ZVJlY29nbml6ZXIucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uIGFkZChyb3V0ZXMsIG9wdGlvbnMpIHsKICAgIHZhciBjdXJyZW50U3RhdGUgPSB0aGlzLnJvb3RTdGF0ZTsKICAgIHZhciBwYXR0ZXJuID0gIl4iOwogICAgdmFyIHR5cGVzID0gWzAsIDAsIDBdOwogICAgdmFyIGhhbmRsZXJzID0gbmV3IEFycmF5KHJvdXRlcy5sZW5ndGgpOwogICAgdmFyIGFsbFNlZ21lbnRzID0gW107CiAgICB2YXIgaXNFbXB0eSA9IHRydWU7CiAgICB2YXIgaiA9IDA7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCByb3V0ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIHJvdXRlID0gcm91dGVzW2ldOwogICAgICB2YXIgcmVmID0gcGFyc2UoYWxsU2VnbWVudHMsIHJvdXRlLnBhdGgsIHR5cGVzKTsKICAgICAgdmFyIG5hbWVzID0gcmVmLm5hbWVzOwogICAgICB2YXIgc2hvdWxkRGVjb2RlcyA9IHJlZi5zaG91bGREZWNvZGVzOyAvLyBwcmVzZXJ2ZSBqIHNvIGl0IHBvaW50cyB0byB0aGUgc3RhcnQgb2YgbmV3bHkgYWRkZWQgc2VnbWVudHMKCiAgICAgIGZvciAoOyBqIDwgYWxsU2VnbWVudHMubGVuZ3RoOyBqKyspIHsKICAgICAgICB2YXIgc2VnbWVudCA9IGFsbFNlZ21lbnRzW2pdOwoKICAgICAgICBpZiAoc2VnbWVudC50eXBlID09PSA0CiAgICAgICAgLyogRXBzaWxvbiAqLwogICAgICAgICkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgaXNFbXB0eSA9IGZhbHNlOyAvLyBBZGQgYSAiLyIgZm9yIHRoZSBuZXcgc2VnbWVudAoKICAgICAgICBjdXJyZW50U3RhdGUgPSBjdXJyZW50U3RhdGUucHV0KDQ3CiAgICAgICAgLyogU0xBU0ggKi8KICAgICAgICAsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgcGF0dGVybiArPSAiLyI7IC8vIEFkZCBhIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBzZWdtZW50IHRvIHRoZSBORkEgYW5kIHJlZ2V4CgogICAgICAgIGN1cnJlbnRTdGF0ZSA9IGVhY2hDaGFyW3NlZ21lbnQudHlwZV0oc2VnbWVudCwgY3VycmVudFN0YXRlKTsKICAgICAgICBwYXR0ZXJuICs9IHJlZ2V4W3NlZ21lbnQudHlwZV0oc2VnbWVudCk7CiAgICAgIH0KCiAgICAgIGhhbmRsZXJzW2ldID0gewogICAgICAgIGhhbmRsZXI6IHJvdXRlLmhhbmRsZXIsCiAgICAgICAgbmFtZXM6IG5hbWVzLAogICAgICAgIHNob3VsZERlY29kZXM6IHNob3VsZERlY29kZXMKICAgICAgfTsKICAgIH0KCiAgICBpZiAoaXNFbXB0eSkgewogICAgICBjdXJyZW50U3RhdGUgPSBjdXJyZW50U3RhdGUucHV0KDQ3CiAgICAgIC8qIFNMQVNIICovCiAgICAgICwgZmFsc2UsIGZhbHNlKTsKICAgICAgcGF0dGVybiArPSAiLyI7CiAgICB9CgogICAgY3VycmVudFN0YXRlLmhhbmRsZXJzID0gaGFuZGxlcnM7CiAgICBjdXJyZW50U3RhdGUucGF0dGVybiA9IHBhdHRlcm4gKyAiJCI7CiAgICBjdXJyZW50U3RhdGUudHlwZXMgPSB0eXBlczsKICAgIHZhciBuYW1lOwoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gIm9iamVjdCIgJiYgb3B0aW9ucyAhPT0gbnVsbCAmJiBvcHRpb25zLmFzKSB7CiAgICAgIG5hbWUgPSBvcHRpb25zLmFzOwogICAgfQoKICAgIGlmIChuYW1lKSB7CiAgICAgIC8vIGlmICh0aGlzLm5hbWVzW25hbWVdKSB7CiAgICAgIC8vICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgbWF5IG5vdCBhZGQgYSBkdXBsaWNhdGUgcm91dGUgbmFtZWQgYCIgKyBuYW1lICsgImAuIik7CiAgICAgIC8vIH0KICAgICAgdGhpcy5uYW1lc1tuYW1lXSA9IHsKICAgICAgICBzZWdtZW50czogYWxsU2VnbWVudHMsCiAgICAgICAgaGFuZGxlcnM6IGhhbmRsZXJzCiAgICAgIH07CiAgICB9CiAgfTsKCiAgUm91dGVSZWNvZ25pemVyLnByb3RvdHlwZS5oYW5kbGVyc0ZvciA9IGZ1bmN0aW9uIGhhbmRsZXJzRm9yKG5hbWUpIHsKICAgIHZhciByb3V0ZSA9IHRoaXMubmFtZXNbbmFtZV07CgogICAgaWYgKCFyb3V0ZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZXJlIGlzIG5vIHJvdXRlIG5hbWVkICIgKyBuYW1lKTsKICAgIH0KCiAgICB2YXIgcmVzdWx0ID0gbmV3IEFycmF5KHJvdXRlLmhhbmRsZXJzLmxlbmd0aCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCByb3V0ZS5oYW5kbGVycy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgaGFuZGxlciA9IHJvdXRlLmhhbmRsZXJzW2ldOwogICAgICByZXN1bHRbaV0gPSBoYW5kbGVyOwogICAgfQoKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgUm91dGVSZWNvZ25pemVyLnByb3RvdHlwZS5oYXNSb3V0ZSA9IGZ1bmN0aW9uIGhhc1JvdXRlKG5hbWUpIHsKICAgIHJldHVybiAhIXRoaXMubmFtZXNbbmFtZV07CiAgfTsKCiAgUm91dGVSZWNvZ25pemVyLnByb3RvdHlwZS5nZW5lcmF0ZSA9IGZ1bmN0aW9uIGdlbmVyYXRlJDEobmFtZSwgcGFyYW1zKSB7CiAgICB2YXIgcm91dGUgPSB0aGlzLm5hbWVzW25hbWVdOwogICAgdmFyIG91dHB1dCA9ICIiOwoKICAgIGlmICghcm91dGUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGVyZSBpcyBubyByb3V0ZSBuYW1lZCAiICsgbmFtZSk7CiAgICB9CgogICAgdmFyIHNlZ21lbnRzID0gcm91dGUuc2VnbWVudHM7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZWdtZW50cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgc2VnbWVudCA9IHNlZ21lbnRzW2ldOwoKICAgICAgaWYgKHNlZ21lbnQudHlwZSA9PT0gNAogICAgICAvKiBFcHNpbG9uICovCiAgICAgICkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgb3V0cHV0ICs9ICIvIjsKICAgICAgb3V0cHV0ICs9IGdlbmVyYXRlW3NlZ21lbnQudHlwZV0oc2VnbWVudCwgcGFyYW1zKTsKICAgIH0KCiAgICBpZiAob3V0cHV0LmNoYXJBdCgwKSAhPT0gIi8iKSB7CiAgICAgIG91dHB1dCA9ICIvIiArIG91dHB1dDsKICAgIH0KCiAgICBpZiAocGFyYW1zICYmIHBhcmFtcy5xdWVyeVBhcmFtcykgewogICAgICBvdXRwdXQgKz0gdGhpcy5nZW5lcmF0ZVF1ZXJ5U3RyaW5nKHBhcmFtcy5xdWVyeVBhcmFtcyk7CiAgICB9CgogICAgcmV0dXJuIG91dHB1dDsKICB9OwoKICBSb3V0ZVJlY29nbml6ZXIucHJvdG90eXBlLmdlbmVyYXRlUXVlcnlTdHJpbmcgPSBmdW5jdGlvbiBnZW5lcmF0ZVF1ZXJ5U3RyaW5nKHBhcmFtcykgewogICAgdmFyIHBhaXJzID0gW107CiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHBhcmFtcyk7CiAgICBrZXlzLnNvcnQoKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgIHZhciB2YWx1ZSA9IHBhcmFtc1trZXldOwoKICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgdmFyIHBhaXIgPSBlbmNvZGVVUklDb21wb25lbnQoa2V5KTsKCiAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdmFsdWUubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIHZhciBhcnJheVBhaXIgPSBrZXkgKyAiW10iICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlW2pdKTsKICAgICAgICAgIHBhaXJzLnB1c2goYXJyYXlQYWlyKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFpciArPSAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpOwogICAgICAgIHBhaXJzLnB1c2gocGFpcik7CiAgICAgIH0KICAgIH0KCiAgICBpZiAocGFpcnMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiAiIjsKICAgIH0KCiAgICByZXR1cm4gIj8iICsgcGFpcnMuam9pbigiJiIpOwogIH07CgogIFJvdXRlUmVjb2duaXplci5wcm90b3R5cGUucGFyc2VRdWVyeVN0cmluZyA9IGZ1bmN0aW9uIHBhcnNlUXVlcnlTdHJpbmcocXVlcnlTdHJpbmcpIHsKICAgIHZhciBwYWlycyA9IHF1ZXJ5U3RyaW5nLnNwbGl0KCImIik7CiAgICB2YXIgcXVlcnlQYXJhbXMgPSB7fTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhaXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBwYWlyID0gcGFpcnNbaV0uc3BsaXQoIj0iKSwKICAgICAgICAgIGtleSA9IGRlY29kZVF1ZXJ5UGFyYW1QYXJ0KHBhaXJbMF0pLAogICAgICAgICAga2V5TGVuZ3RoID0ga2V5Lmxlbmd0aCwKICAgICAgICAgIGlzQXJyYXkgPSBmYWxzZSwKICAgICAgICAgIHZhbHVlID0gdm9pZCAwOwoKICAgICAgaWYgKHBhaXIubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdmFsdWUgPSAidHJ1ZSI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSGFuZGxlIGFycmF5cwogICAgICAgIGlmIChrZXlMZW5ndGggPiAyICYmIGtleS5zbGljZShrZXlMZW5ndGggLSAyKSA9PT0gIltdIikgewogICAgICAgICAgaXNBcnJheSA9IHRydWU7CiAgICAgICAgICBrZXkgPSBrZXkuc2xpY2UoMCwga2V5TGVuZ3RoIC0gMik7CgogICAgICAgICAgaWYgKCFxdWVyeVBhcmFtc1trZXldKSB7CiAgICAgICAgICAgIHF1ZXJ5UGFyYW1zW2tleV0gPSBbXTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhbHVlID0gcGFpclsxXSA/IGRlY29kZVF1ZXJ5UGFyYW1QYXJ0KHBhaXJbMV0pIDogIiI7CiAgICAgIH0KCiAgICAgIGlmIChpc0FycmF5KSB7CiAgICAgICAgcXVlcnlQYXJhbXNba2V5XS5wdXNoKHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBxdWVyeVBhcmFtc1trZXldID0gdmFsdWU7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcXVlcnlQYXJhbXM7CiAgfTsKCiAgUm91dGVSZWNvZ25pemVyLnByb3RvdHlwZS5yZWNvZ25pemUgPSBmdW5jdGlvbiByZWNvZ25pemUocGF0aCkgewogICAgdmFyIHJlc3VsdHM7CiAgICB2YXIgc3RhdGVzID0gW3RoaXMucm9vdFN0YXRlXTsKICAgIHZhciBxdWVyeVBhcmFtcyA9IHt9OwogICAgdmFyIGlzU2xhc2hEcm9wcGVkID0gZmFsc2U7CiAgICB2YXIgaGFzaFN0YXJ0ID0gcGF0aC5pbmRleE9mKCIjIik7CgogICAgaWYgKGhhc2hTdGFydCAhPT0gLTEpIHsKICAgICAgcGF0aCA9IHBhdGguc3Vic3RyKDAsIGhhc2hTdGFydCk7CiAgICB9CgogICAgdmFyIHF1ZXJ5U3RhcnQgPSBwYXRoLmluZGV4T2YoIj8iKTsKCiAgICBpZiAocXVlcnlTdGFydCAhPT0gLTEpIHsKICAgICAgdmFyIHF1ZXJ5U3RyaW5nID0gcGF0aC5zdWJzdHIocXVlcnlTdGFydCArIDEsIHBhdGgubGVuZ3RoKTsKICAgICAgcGF0aCA9IHBhdGguc3Vic3RyKDAsIHF1ZXJ5U3RhcnQpOwogICAgICBxdWVyeVBhcmFtcyA9IHRoaXMucGFyc2VRdWVyeVN0cmluZyhxdWVyeVN0cmluZyk7CiAgICB9CgogICAgaWYgKHBhdGguY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgcGF0aCA9ICIvIiArIHBhdGg7CiAgICB9CgogICAgdmFyIG9yaWdpbmFsUGF0aCA9IHBhdGg7CgogICAgaWYgKFJvdXRlUmVjb2duaXplci5FTkNPREVfQU5EX0RFQ09ERV9QQVRIX1NFR01FTlRTKSB7CiAgICAgIHBhdGggPSBub3JtYWxpemVQYXRoKHBhdGgpOwogICAgfSBlbHNlIHsKICAgICAgcGF0aCA9IGRlY29kZVVSSShwYXRoKTsKICAgICAgb3JpZ2luYWxQYXRoID0gZGVjb2RlVVJJKG9yaWdpbmFsUGF0aCk7CiAgICB9CgogICAgdmFyIHBhdGhMZW4gPSBwYXRoLmxlbmd0aDsKCiAgICBpZiAocGF0aExlbiA+IDEgJiYgcGF0aC5jaGFyQXQocGF0aExlbiAtIDEpID09PSAiLyIpIHsKICAgICAgcGF0aCA9IHBhdGguc3Vic3RyKDAsIHBhdGhMZW4gLSAxKTsKICAgICAgb3JpZ2luYWxQYXRoID0gb3JpZ2luYWxQYXRoLnN1YnN0cigwLCBvcmlnaW5hbFBhdGgubGVuZ3RoIC0gMSk7CiAgICAgIGlzU2xhc2hEcm9wcGVkID0gdHJ1ZTsKICAgIH0KCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGgubGVuZ3RoOyBpKyspIHsKICAgICAgc3RhdGVzID0gcmVjb2duaXplQ2hhcihzdGF0ZXMsIHBhdGguY2hhckNvZGVBdChpKSk7CgogICAgICBpZiAoIXN0YXRlcy5sZW5ndGgpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQoKICAgIHZhciBzb2x1dGlvbnMgPSBbXTsKCiAgICBmb3IgKHZhciBpJDEgPSAwOyBpJDEgPCBzdGF0ZXMubGVuZ3RoOyBpJDErKykgewogICAgICBpZiAoc3RhdGVzW2kkMV0uaGFuZGxlcnMpIHsKICAgICAgICBzb2x1dGlvbnMucHVzaChzdGF0ZXNbaSQxXSk7CiAgICAgIH0KICAgIH0KCiAgICBzdGF0ZXMgPSBzb3J0U29sdXRpb25zKHNvbHV0aW9ucyk7CiAgICB2YXIgc3RhdGUgPSBzb2x1dGlvbnNbMF07CgogICAgaWYgKHN0YXRlICYmIHN0YXRlLmhhbmRsZXJzKSB7CiAgICAgIC8vIGlmIGEgdHJhaWxpbmcgc2xhc2ggd2FzIGRyb3BwZWQgYW5kIGEgc3RhciBzZWdtZW50IGlzIHRoZSBsYXN0IHNlZ21lbnQKICAgICAgLy8gc3BlY2lmaWVkLCBwdXQgdGhlIHRyYWlsaW5nIHNsYXNoIGJhY2sKICAgICAgaWYgKGlzU2xhc2hEcm9wcGVkICYmIHN0YXRlLnBhdHRlcm4gJiYgc3RhdGUucGF0dGVybi5zbGljZSgtNSkgPT09ICIoLispJCIpIHsKICAgICAgICBvcmlnaW5hbFBhdGggPSBvcmlnaW5hbFBhdGggKyAiLyI7CiAgICAgIH0KCiAgICAgIHJlc3VsdHMgPSBmaW5kSGFuZGxlcihzdGF0ZSwgb3JpZ2luYWxQYXRoLCBxdWVyeVBhcmFtcyk7CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgUm91dGVSZWNvZ25pemVyLlZFUlNJT04gPSAiMC4zLjQiOyAvLyBTZXQgdG8gZmFsc2UgdG8gb3B0LW91dCBvZiBlbmNvZGluZyBhbmQgZGVjb2RpbmcgcGF0aCBzZWdtZW50cy4KICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3RpbGRlaW8vcm91dGUtcmVjb2duaXplci9wdWxsLzU1CgogIFJvdXRlUmVjb2duaXplci5FTkNPREVfQU5EX0RFQ09ERV9QQVRIX1NFR01FTlRTID0gdHJ1ZTsKICBSb3V0ZVJlY29nbml6ZXIuTm9ybWFsaXplciA9IHsKICAgIG5vcm1hbGl6ZVNlZ21lbnQ6IG5vcm1hbGl6ZVNlZ21lbnQsCiAgICBub3JtYWxpemVQYXRoOiBub3JtYWxpemVQYXRoLAogICAgZW5jb2RlUGF0aFNlZ21lbnQ6IGVuY29kZVBhdGhTZWdtZW50CiAgfTsKICBSb3V0ZVJlY29nbml6ZXIucHJvdG90eXBlLm1hcCA9IG1hcDsKICB2YXIgX2RlZmF1bHQgPSBSb3V0ZVJlY29nbml6ZXI7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKZGVmaW5lKCJyb3V0ZXJfanMiLCBbImV4cG9ydHMiLCAiQGVtYmVyL3BvbHlmaWxscyIsICJlbWJlci1iYWJlbCIsICJyc3ZwIiwgInJvdXRlLXJlY29nbml6ZXIiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfcG9seWZpbGxzLCBfZW1iZXJCYWJlbCwgX3JzdnAsIF9yb3V0ZVJlY29nbml6ZXIpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmxvZ0Fib3J0ID0gbG9nQWJvcnQ7CiAgX2V4cG9ydHMuSW50ZXJuYWxSb3V0ZUluZm8gPSBfZXhwb3J0cy5UcmFuc2l0aW9uRXJyb3IgPSBfZXhwb3J0cy5UcmFuc2l0aW9uU3RhdGUgPSBfZXhwb3J0cy5RVUVSWV9QQVJBTVNfU1lNQk9MID0gX2V4cG9ydHMuUEFSQU1TX1NZTUJPTCA9IF9leHBvcnRzLlNUQVRFX1NZTUJPTCA9IF9leHBvcnRzLkludGVybmFsVHJhbnNpdGlvbiA9IF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIHZhciBUcmFuc2l0aW9uQWJvcnRlZEVycm9yID0gZnVuY3Rpb24gKCkgewogICAgVHJhbnNpdGlvbkFib3J0ZWRFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEVycm9yLnByb3RvdHlwZSk7CiAgICBUcmFuc2l0aW9uQWJvcnRlZEVycm9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFRyYW5zaXRpb25BYm9ydGVkRXJyb3I7CgogICAgZnVuY3Rpb24gVHJhbnNpdGlvbkFib3J0ZWRFcnJvcihtZXNzYWdlKSB7CiAgICAgIHZhciBlcnJvciA9IEVycm9yLmNhbGwodGhpcywgbWVzc2FnZSk7CiAgICAgIHRoaXMubmFtZSA9ICdUcmFuc2l0aW9uQWJvcnRlZCc7CiAgICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2UgfHwgJ1RyYW5zaXRpb25BYm9ydGVkJzsKCiAgICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIFRyYW5zaXRpb25BYm9ydGVkRXJyb3IpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc3RhY2sgPSBlcnJvci5zdGFjazsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBUcmFuc2l0aW9uQWJvcnRlZEVycm9yOwogIH0oKTsKCiAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwogIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgLyoqCiAgICBEZXRlcm1pbmVzIGlmIGFuIG9iamVjdCBpcyBQcm9taXNlIGJ5IGNoZWNraW5nIGlmIGl0IGlzICJ0aGVuYWJsZSIuCiAgKiovCgogIGZ1bmN0aW9uIGlzUHJvbWlzZShwKSB7CiAgICByZXR1cm4gcCAhPT0gbnVsbCAmJiB0eXBlb2YgcCA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIHAudGhlbiA9PT0gJ2Z1bmN0aW9uJzsKICB9CgogIGZ1bmN0aW9uIG1lcmdlKGhhc2gsIG90aGVyKSB7CiAgICBmb3IgKHZhciBwcm9wIGluIG90aGVyKSB7CiAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG90aGVyLCBwcm9wKSkgewogICAgICAgIGhhc2hbcHJvcF0gPSBvdGhlcltwcm9wXTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgIEBwcml2YXRlCiAgCiAgICBFeHRyYWN0cyBxdWVyeSBwYXJhbXMgZnJvbSB0aGUgZW5kIG9mIGFuIGFycmF5CiAgKiovCgoKICBmdW5jdGlvbiBleHRyYWN0UXVlcnlQYXJhbXMoYXJyYXkpIHsKICAgIHZhciBsZW4gPSBhcnJheSAmJiBhcnJheS5sZW5ndGgsCiAgICAgICAgaGVhZCwKICAgICAgICBxdWVyeVBhcmFtczsKCiAgICBpZiAobGVuICYmIGxlbiA+IDApIHsKICAgICAgdmFyIG9iaiA9IGFycmF5W2xlbiAtIDFdOwoKICAgICAgaWYgKGlzUXVlcnlQYXJhbXMob2JqKSkgewogICAgICAgIHF1ZXJ5UGFyYW1zID0gb2JqLnF1ZXJ5UGFyYW1zOwogICAgICAgIGhlYWQgPSBzbGljZS5jYWxsKGFycmF5LCAwLCBsZW4gLSAxKTsKICAgICAgICByZXR1cm4gW2hlYWQsIHF1ZXJ5UGFyYW1zXTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBbYXJyYXksIG51bGxdOwogIH0KCiAgZnVuY3Rpb24gaXNRdWVyeVBhcmFtcyhvYmopIHsKICAgIHJldHVybiBvYmogJiYgaGFzT3duUHJvcGVydHkuY2FsbChvYmosICdxdWVyeVBhcmFtcycpOwogIH0KICAvKioKICAgIEBwcml2YXRlCiAgCiAgICBDb2VyY2VzIHF1ZXJ5IHBhcmFtIHByb3BlcnRpZXMgYW5kIGFycmF5IGVsZW1lbnRzIGludG8gc3RyaW5ncy4KICAqKi8KCgogIGZ1bmN0aW9uIGNvZXJjZVF1ZXJ5UGFyYW1zVG9TdHJpbmcocXVlcnlQYXJhbXMpIHsKICAgIGZvciAodmFyIGtleSBpbiBxdWVyeVBhcmFtcykgewogICAgICB2YXIgdmFsID0gcXVlcnlQYXJhbXNba2V5XTsKCiAgICAgIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgICAgIHF1ZXJ5UGFyYW1zW2tleV0gPSAnJyArIHZhbDsKICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbCkpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHZhbC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHZhbFtpXSA9ICcnICsgdmFsW2ldOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICAvKioKICAgIEBwcml2YXRlCiAgICovCgoKICBmdW5jdGlvbiBfbG9nKHJvdXRlcikgewogICAgaWYgKCFyb3V0ZXIubG9nKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuID4gMSA/IF9sZW4gLSAxIDogMCksIF9rZXkgPSAxOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgIGFyZ3NbX2tleSAtIDFdID0gYXJndW1lbnRzW19rZXldOwogICAgfQoKICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMikgewogICAgICB2YXIgc2VxdWVuY2UgPSBhcmdzWzBdLAogICAgICAgICAgbXNnID0gYXJnc1sxXTsKICAgICAgcm91dGVyLmxvZygnVHJhbnNpdGlvbiAjJyArIHNlcXVlbmNlICsgJzogJyArIG1zZyk7CiAgICB9IGVsc2UgewogICAgICB2YXIgX21zZyA9IGFyZ3NbMF07CiAgICAgIHJvdXRlci5sb2coX21zZyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc1BhcmFtKG9iamVjdCkgewogICAgcmV0dXJuIHR5cGVvZiBvYmplY3QgPT09ICdzdHJpbmcnIHx8IG9iamVjdCBpbnN0YW5jZW9mIFN0cmluZyB8fCB0eXBlb2Ygb2JqZWN0ID09PSAnbnVtYmVyJyB8fCBvYmplY3QgaW5zdGFuY2VvZiBOdW1iZXI7CiAgfQoKICBmdW5jdGlvbiBmb3JFYWNoKGFycmF5LCBjYWxsYmFjaykgewogICAgZm9yICh2YXIgaSA9IDAsIGwgPSBhcnJheS5sZW5ndGg7IGkgPCBsICYmIGNhbGxiYWNrKGFycmF5W2ldKSAhPT0gZmFsc2U7IGkrKykgey8vIGVtcHR5IGludGVudGlvbmFsbHkKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdldENoYW5nZWxpc3Qob2xkT2JqZWN0LCBuZXdPYmplY3QpIHsKICAgIHZhciBrZXk7CiAgICB2YXIgcmVzdWx0cyA9IHsKICAgICAgYWxsOiB7fSwKICAgICAgY2hhbmdlZDoge30sCiAgICAgIHJlbW92ZWQ6IHt9CiAgICB9OwogICAgbWVyZ2UocmVzdWx0cy5hbGwsIG5ld09iamVjdCk7CiAgICB2YXIgZGlkQ2hhbmdlID0gZmFsc2U7CiAgICBjb2VyY2VRdWVyeVBhcmFtc1RvU3RyaW5nKG9sZE9iamVjdCk7CiAgICBjb2VyY2VRdWVyeVBhcmFtc1RvU3RyaW5nKG5ld09iamVjdCk7IC8vIENhbGN1bGF0ZSByZW1vdmFscwoKICAgIGZvciAoa2V5IGluIG9sZE9iamVjdCkgewogICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvbGRPYmplY3QsIGtleSkpIHsKICAgICAgICBpZiAoIWhhc093blByb3BlcnR5LmNhbGwobmV3T2JqZWN0LCBrZXkpKSB7CiAgICAgICAgICBkaWRDaGFuZ2UgPSB0cnVlOwogICAgICAgICAgcmVzdWx0cy5yZW1vdmVkW2tleV0gPSBvbGRPYmplY3Rba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gLy8gQ2FsY3VsYXRlIGNoYW5nZXMKCgogICAgZm9yIChrZXkgaW4gbmV3T2JqZWN0KSB7CiAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG5ld09iamVjdCwga2V5KSkgewogICAgICAgIHZhciBvbGRFbGVtZW50ID0gb2xkT2JqZWN0W2tleV07CiAgICAgICAgdmFyIG5ld0VsZW1lbnQgPSBuZXdPYmplY3Rba2V5XTsKCiAgICAgICAgaWYgKGlzQXJyYXkob2xkRWxlbWVudCkgJiYgaXNBcnJheShuZXdFbGVtZW50KSkgewogICAgICAgICAgaWYgKG9sZEVsZW1lbnQubGVuZ3RoICE9PSBuZXdFbGVtZW50Lmxlbmd0aCkgewogICAgICAgICAgICByZXN1bHRzLmNoYW5nZWRba2V5XSA9IG5ld09iamVjdFtrZXldOwogICAgICAgICAgICBkaWRDaGFuZ2UgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBvbGRFbGVtZW50Lmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgIGlmIChvbGRFbGVtZW50W2ldICE9PSBuZXdFbGVtZW50W2ldKSB7CiAgICAgICAgICAgICAgICByZXN1bHRzLmNoYW5nZWRba2V5XSA9IG5ld09iamVjdFtrZXldOwogICAgICAgICAgICAgICAgZGlkQ2hhbmdlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG9sZE9iamVjdFtrZXldICE9PSBuZXdPYmplY3Rba2V5XSkgewogICAgICAgICAgcmVzdWx0cy5jaGFuZ2VkW2tleV0gPSBuZXdPYmplY3Rba2V5XTsKICAgICAgICAgIGRpZENoYW5nZSA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGRpZENoYW5nZSA/IHJlc3VsdHMgOiB1bmRlZmluZWQ7CiAgfQoKICBmdW5jdGlvbiBpc0FycmF5KG9iaikgewogICAgcmV0dXJuIEFycmF5LmlzQXJyYXkob2JqKTsKICB9CgogIGZ1bmN0aW9uIF9wcm9taXNlTGFiZWwobGFiZWwpIHsKICAgIHJldHVybiAnUm91dGVyOiAnICsgbGFiZWw7CiAgfQoKICB2YXIgU1RBVEVfU1lNQk9MID0gIl9fU1RBVEVfXy0yNjE5ODYwMDAxMzQ1OTIwLTMzMjJ3MyI7CiAgX2V4cG9ydHMuU1RBVEVfU1lNQk9MID0gU1RBVEVfU1lNQk9MOwogIHZhciBQQVJBTVNfU1lNQk9MID0gIl9fUEFSQU1TX18tMjYxOTg2MjMyOTkyODMwMjAzLTIzMzIzIjsKICBfZXhwb3J0cy5QQVJBTVNfU1lNQk9MID0gUEFSQU1TX1NZTUJPTDsKICB2YXIgUVVFUllfUEFSQU1TX1NZTUJPTCA9ICJfX1FQU19fLTI2MTk4NjM5Mjk4MjQ4NDQtMzIzMjMiOwogIC8qKgogICAgQSBUcmFuc2l0aW9uIGlzIGEgdGhlbm5hYmxlIChhIHByb21pc2UtbGlrZSBvYmplY3QpIHRoYXQgcmVwcmVzZW50cwogICAgYW4gYXR0ZW1wdCB0byB0cmFuc2l0aW9uIHRvIGFub3RoZXIgcm91dGUuIEl0IGNhbiBiZSBhYm9ydGVkLCBlaXRoZXIKICAgIGV4cGxpY2l0bHkgdmlhIGBhYm9ydGAgb3IgYnkgYXR0ZW1wdGluZyBhbm90aGVyIHRyYW5zaXRpb24gd2hpbGUgYQogICAgcHJldmlvdXMgb25lIGlzIHN0aWxsIHVuZGVyd2F5LiBBbiBhYm9ydGVkIHRyYW5zaXRpb24gY2FuIGFsc28KICAgIGJlIGByZXRyeSgpYGQgbGF0ZXIuCiAgCiAgICBAY2xhc3MgVHJhbnNpdGlvbgogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge09iamVjdH0gcm91dGVyCiAgICBAcGFyYW0ge09iamVjdH0gaW50ZW50CiAgICBAcGFyYW0ge09iamVjdH0gc3RhdGUKICAgIEBwYXJhbSB7T2JqZWN0fSBlcnJvcgogICAgQHByaXZhdGUKICAgKi8KCiAgX2V4cG9ydHMuUVVFUllfUEFSQU1TX1NZTUJPTCA9IFFVRVJZX1BBUkFNU19TWU1CT0w7CgogIHZhciBUcmFuc2l0aW9uID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gVHJhbnNpdGlvbihyb3V0ZXIsIGludGVudCwgc3RhdGUsIGVycm9yLCBwcmV2aW91c1RyYW5zaXRpb24pIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIGlmIChlcnJvciA9PT0gdm9pZCAwKSB7CiAgICAgICAgZXJyb3IgPSB1bmRlZmluZWQ7CiAgICAgIH0KCiAgICAgIGlmIChwcmV2aW91c1RyYW5zaXRpb24gPT09IHZvaWQgMCkgewogICAgICAgIHByZXZpb3VzVHJhbnNpdGlvbiA9IHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgdGhpcy5mcm9tID0gbnVsbDsKICAgICAgdGhpcy50byA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5pc0Fib3J0ZWQgPSBmYWxzZTsKICAgICAgdGhpcy5pc0FjdGl2ZSA9IHRydWU7CiAgICAgIHRoaXMudXJsTWV0aG9kID0gJ3VwZGF0ZSc7CiAgICAgIHRoaXMucmVzb2x2ZUluZGV4ID0gMDsKICAgICAgdGhpcy5xdWVyeVBhcmFtc09ubHkgPSBmYWxzZTsKICAgICAgdGhpcy5pc1RyYW5zaXRpb24gPSB0cnVlOwogICAgICB0aGlzLmlzQ2F1c2VkQnlBYm9ydGluZ1RyYW5zaXRpb24gPSBmYWxzZTsKICAgICAgdGhpcy5pc0NhdXNlZEJ5SW5pdGlhbFRyYW5zaXRpb24gPSBmYWxzZTsKICAgICAgdGhpcy5pc0NhdXNlZEJ5QWJvcnRpbmdSZXBsYWNlVHJhbnNpdGlvbiA9IGZhbHNlOwogICAgICB0aGlzLl92aXNpYmxlUXVlcnlQYXJhbXMgPSB7fTsKICAgICAgdGhpc1tTVEFURV9TWU1CT0xdID0gc3RhdGUgfHwgcm91dGVyLnN0YXRlOwogICAgICB0aGlzLmludGVudCA9IGludGVudDsKICAgICAgdGhpcy5yb3V0ZXIgPSByb3V0ZXI7CiAgICAgIHRoaXMuZGF0YSA9IGludGVudCAmJiBpbnRlbnQuZGF0YSB8fCB7fTsKICAgICAgdGhpcy5yZXNvbHZlZE1vZGVscyA9IHt9OwogICAgICB0aGlzW1FVRVJZX1BBUkFNU19TWU1CT0xdID0ge307CiAgICAgIHRoaXMucHJvbWlzZSA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5lcnJvciA9IHVuZGVmaW5lZDsKICAgICAgdGhpc1tQQVJBTVNfU1lNQk9MXSA9IHt9OwogICAgICB0aGlzLnJvdXRlSW5mb3MgPSBbXTsKICAgICAgdGhpcy50YXJnZXROYW1lID0gdW5kZWZpbmVkOwogICAgICB0aGlzLnBpdm90SGFuZGxlciA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5zZXF1ZW5jZSA9IC0xOwoKICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgdGhpcy5wcm9taXNlID0gX3JzdnAuUHJvbWlzZS5yZWplY3QoZXJyb3IpOwogICAgICAgIHRoaXMuZXJyb3IgPSBlcnJvcjsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gaWYgeW91J3JlIGRvaW5nIG11bHRpcGxlIHJlZGlyZWN0cywgbmVlZCB0aGUgbmV3IHRyYW5zaXRpb24gdG8ga25vdyBpZiBpdAogICAgICAvLyBpcyBhY3R1YWxseSBwYXJ0IG9mIHRoZSBmaXJzdCB0cmFuc2l0aW9uIG9yIG5vdC4gQW55IGZ1cnRoZXIgcmVkaXJlY3RzCiAgICAgIC8vIGluIHRoZSBpbml0aWFsIHRyYW5zaXRpb24gYWxzbyBuZWVkIHRvIGtub3cgaWYgdGhleSBhcmUgcGFydCBvZiB0aGUKICAgICAgLy8gaW5pdGlhbCB0cmFuc2l0aW9uCgoKICAgICAgdGhpcy5pc0NhdXNlZEJ5QWJvcnRpbmdUcmFuc2l0aW9uID0gISFwcmV2aW91c1RyYW5zaXRpb247CiAgICAgIHRoaXMuaXNDYXVzZWRCeUluaXRpYWxUcmFuc2l0aW9uID0gISFwcmV2aW91c1RyYW5zaXRpb24gJiYgKHByZXZpb3VzVHJhbnNpdGlvbi5pc0NhdXNlZEJ5SW5pdGlhbFRyYW5zaXRpb24gfHwgcHJldmlvdXNUcmFuc2l0aW9uLnNlcXVlbmNlID09PSAwKTsgLy8gRXZlcnkgdHJhbnNpdGlvbiBpbiB0aGUgY2hhaW4gaXMgYSByZXBsYWNlCgogICAgICB0aGlzLmlzQ2F1c2VkQnlBYm9ydGluZ1JlcGxhY2VUcmFuc2l0aW9uID0gISFwcmV2aW91c1RyYW5zaXRpb24gJiYgcHJldmlvdXNUcmFuc2l0aW9uLnVybE1ldGhvZCA9PT0gJ3JlcGxhY2UnICYmICghcHJldmlvdXNUcmFuc2l0aW9uLmlzQ2F1c2VkQnlBYm9ydGluZ1RyYW5zaXRpb24gfHwgcHJldmlvdXNUcmFuc2l0aW9uLmlzQ2F1c2VkQnlBYm9ydGluZ1JlcGxhY2VUcmFuc2l0aW9uKTsKCiAgICAgIGlmIChzdGF0ZSkgewogICAgICAgIHRoaXNbUEFSQU1TX1NZTUJPTF0gPSBzdGF0ZS5wYXJhbXM7CiAgICAgICAgdGhpc1tRVUVSWV9QQVJBTVNfU1lNQk9MXSA9IHN0YXRlLnF1ZXJ5UGFyYW1zOwogICAgICAgIHRoaXMucm91dGVJbmZvcyA9IHN0YXRlLnJvdXRlSW5mb3M7CiAgICAgICAgdmFyIGxlbiA9IHN0YXRlLnJvdXRlSW5mb3MubGVuZ3RoOwoKICAgICAgICBpZiAobGVuKSB7CiAgICAgICAgICB0aGlzLnRhcmdldE5hbWUgPSBzdGF0ZS5yb3V0ZUluZm9zW2xlbiAtIDFdLm5hbWU7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgICB2YXIgaGFuZGxlckluZm8gPSBzdGF0ZS5yb3V0ZUluZm9zW2ldOyAvLyBUT0RPOiB0aGlzIGFsbCBzZWVtcyBoYWNreQoKICAgICAgICAgIGlmICghaGFuZGxlckluZm8uaXNSZXNvbHZlZCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLnBpdm90SGFuZGxlciA9IGhhbmRsZXJJbmZvLnJvdXRlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zZXF1ZW5jZSA9IHJvdXRlci5jdXJyZW50U2VxdWVuY2UrKzsKICAgICAgICB0aGlzLnByb21pc2UgPSBzdGF0ZS5yZXNvbHZlKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChfdGhpcy5pc0Fib3J0ZWQpIHsKICAgICAgICAgICAgcmV0dXJuIF9yc3ZwLlByb21pc2UucmVqZWN0KGZhbHNlLCBfcHJvbWlzZUxhYmVsKCdUcmFuc2l0aW9uIGFib3J0ZWQgLSByZWplY3QnKSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIF9yc3ZwLlByb21pc2UucmVzb2x2ZSh0cnVlKTsKICAgICAgICB9LCB0aGlzKS5jYXRjaChmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgICByZXR1cm4gX3JzdnAuUHJvbWlzZS5yZWplY3QoX3RoaXMucm91dGVyLnRyYW5zaXRpb25EaWRFcnJvcihyZXN1bHQsIF90aGlzKSk7CiAgICAgICAgfSwgX3Byb21pc2VMYWJlbCgnSGFuZGxlIEFib3J0JykpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucHJvbWlzZSA9IF9yc3ZwLlByb21pc2UucmVzb2x2ZSh0aGlzW1NUQVRFX1NZTUJPTF0pOwogICAgICAgIHRoaXNbUEFSQU1TX1NZTUJPTF0gPSB7fTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgIFRoZSBUcmFuc2l0aW9uJ3MgaW50ZXJuYWwgcHJvbWlzZS4gQ2FsbGluZyBgLnRoZW5gIG9uIHRoaXMgcHJvcGVydHkKICAgICAgaXMgdGhhdCBzYW1lIGFzIGNhbGxpbmcgYC50aGVuYCBvbiB0aGUgVHJhbnNpdGlvbiBvYmplY3QgaXRzZWxmLCBidXQKICAgICAgdGhpcyBwcm9wZXJ0eSBpcyBleHBvc2VkIGZvciB3aGVuIHlvdSB3YW50IHRvIHBhc3MgYXJvdW5kIGEKICAgICAgVHJhbnNpdGlvbidzIHByb21pc2UsIGJ1dCBub3QgdGhlIFRyYW5zaXRpb24gb2JqZWN0IGl0c2VsZiwgc2luY2UKICAgICAgVHJhbnNpdGlvbiBvYmplY3QgY2FuIGJlIGV4dGVybmFsbHkgYGFib3J0YGVkLCB3aGlsZSB0aGUgcHJvbWlzZQogICAgICBjYW5ub3QuCiAgICAgICAgIEBwcm9wZXJ0eSBwcm9taXNlCiAgICAgIEB0eXBlIHtPYmplY3R9CiAgICAgIEBwdWJsaWMKICAgICAqLwoKICAgIC8qKgogICAgICBDdXN0b20gc3RhdGUgY2FuIGJlIHN0b3JlZCBvbiBhIFRyYW5zaXRpb24ncyBgZGF0YWAgb2JqZWN0LgogICAgICBUaGlzIGNhbiBiZSB1c2VmdWwgZm9yIGRlY29yYXRpbmcgYSBUcmFuc2l0aW9uIHdpdGhpbiBhbiBlYXJsaWVyCiAgICAgIGhvb2sgYW5kIHNoYXJlZCB3aXRoIGEgbGF0ZXIgaG9vay4gUHJvcGVydGllcyBzZXQgb24gYGRhdGFgIHdpbGwKICAgICAgYmUgY29waWVkIHRvIG5ldyB0cmFuc2l0aW9ucyBnZW5lcmF0ZWQgYnkgY2FsbGluZyBgcmV0cnlgIG9uIHRoaXMKICAgICAgdHJhbnNpdGlvbi4KICAgICAgICAgQHByb3BlcnR5IGRhdGEKICAgICAgQHR5cGUge09iamVjdH0KICAgICAgQHB1YmxpYwogICAgICovCgogICAgLyoqCiAgICAgIEEgc3RhbmRhcmQgcHJvbWlzZSBob29rIHRoYXQgcmVzb2x2ZXMgaWYgdGhlIHRyYW5zaXRpb24KICAgICAgc3VjY2VlZHMgYW5kIHJlamVjdHMgaWYgaXQgZmFpbHMvcmVkaXJlY3RzL2Fib3J0cy4KICAgICAgICAgRm9yd2FyZHMgdG8gdGhlIGludGVybmFsIGBwcm9taXNlYCBwcm9wZXJ0eSB3aGljaCB5b3UgY2FuCiAgICAgIHVzZSBpbiBzaXR1YXRpb25zIHdoZXJlIHlvdSB3YW50IHRvIHBhc3MgYXJvdW5kIGEgdGhlbm5hYmxlLAogICAgICBidXQgbm90IHRoZSBUcmFuc2l0aW9uIGl0c2VsZi4KICAgICAgICAgQG1ldGhvZCB0aGVuCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IG9uRnVsZmlsbGVkCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IG9uUmVqZWN0ZWQKICAgICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgICAgIFVzZWZ1bCBmb3IgdG9vbGluZy4KICAgICAgQHJldHVybiB7UHJvbWlzZX0KICAgICAgQHB1YmxpYwogICAgICovCgoKICAgIHZhciBfcHJvdG8gPSBUcmFuc2l0aW9uLnByb3RvdHlwZTsKCiAgICBfcHJvdG8udGhlbiA9IGZ1bmN0aW9uIHRoZW4ob25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIGxhYmVsKSB7CiAgICAgIHJldHVybiB0aGlzLnByb21pc2UudGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgbGFiZWwpOwogICAgfQogICAgLyoqCiAgICAgICAgIEZvcndhcmRzIHRvIHRoZSBpbnRlcm5hbCBgcHJvbWlzZWAgcHJvcGVydHkgd2hpY2ggeW91IGNhbgogICAgICB1c2UgaW4gc2l0dWF0aW9ucyB3aGVyZSB5b3Ugd2FudCB0byBwYXNzIGFyb3VuZCBhIHRoZW5uYWJsZSwKICAgICAgYnV0IG5vdCB0aGUgVHJhbnNpdGlvbiBpdHNlbGYuCiAgICAgICAgIEBtZXRob2QgY2F0Y2gKICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gb25SZWplY3Rpb24KICAgICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgICAgIFVzZWZ1bCBmb3IgdG9vbGluZy4KICAgICAgQHJldHVybiB7UHJvbWlzZX0KICAgICAgQHB1YmxpYwogICAgICovCiAgICA7CgogICAgX3Byb3RvLmNhdGNoID0gZnVuY3Rpb24gX2NhdGNoKG9uUmVqZWN0aW9uLCBsYWJlbCkgewogICAgICByZXR1cm4gdGhpcy5wcm9taXNlLmNhdGNoKG9uUmVqZWN0aW9uLCBsYWJlbCk7CiAgICB9CiAgICAvKioKICAgICAgICAgRm9yd2FyZHMgdG8gdGhlIGludGVybmFsIGBwcm9taXNlYCBwcm9wZXJ0eSB3aGljaCB5b3UgY2FuCiAgICAgIHVzZSBpbiBzaXR1YXRpb25zIHdoZXJlIHlvdSB3YW50IHRvIHBhc3MgYXJvdW5kIGEgdGhlbm5hYmxlLAogICAgICBidXQgbm90IHRoZSBUcmFuc2l0aW9uIGl0c2VsZi4KICAgICAgICAgQG1ldGhvZCBmaW5hbGx5CiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCBvcHRpb25hbCBzdHJpbmcgZm9yIGxhYmVsaW5nIHRoZSBwcm9taXNlLgogICAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICAgIEByZXR1cm4ge1Byb21pc2V9CiAgICAgIEBwdWJsaWMKICAgICAqLwogICAgOwoKICAgIF9wcm90by5maW5hbGx5ID0gZnVuY3Rpb24gX2ZpbmFsbHkoY2FsbGJhY2ssIGxhYmVsKSB7CiAgICAgIHJldHVybiB0aGlzLnByb21pc2UuZmluYWxseShjYWxsYmFjaywgbGFiZWwpOwogICAgfQogICAgLyoqCiAgICAgIEFib3J0cyB0aGUgVHJhbnNpdGlvbi4gTm90ZSB5b3UgY2FuIGFsc28gaW1wbGljaXRseSBhYm9ydCBhIHRyYW5zaXRpb24KICAgICAgYnkgaW5pdGlhdGluZyBhbm90aGVyIHRyYW5zaXRpb24gd2hpbGUgYSBwcmV2aW91cyBvbmUgaXMgdW5kZXJ3YXkuCiAgICAgICAgIEBtZXRob2QgYWJvcnQKICAgICAgQHJldHVybiB7VHJhbnNpdGlvbn0gdGhpcyB0cmFuc2l0aW9uCiAgICAgIEBwdWJsaWMKICAgICAqLwogICAgOwoKICAgIF9wcm90by5hYm9ydCA9IGZ1bmN0aW9uIGFib3J0KCkgewogICAgICB0aGlzLnJvbGxiYWNrKCk7CiAgICAgIHZhciB0cmFuc2l0aW9uID0gbmV3IFRyYW5zaXRpb24odGhpcy5yb3V0ZXIsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQpOwogICAgICB0cmFuc2l0aW9uLnRvID0gdGhpcy5mcm9tOwogICAgICB0cmFuc2l0aW9uLmZyb20gPSB0aGlzLmZyb207CiAgICAgIHRyYW5zaXRpb24uaXNBYm9ydGVkID0gdHJ1ZTsKICAgICAgdGhpcy5yb3V0ZXIucm91dGVXaWxsQ2hhbmdlKHRyYW5zaXRpb24pOwogICAgICB0aGlzLnJvdXRlci5yb3V0ZURpZENoYW5nZSh0cmFuc2l0aW9uKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIF9wcm90by5yb2xsYmFjayA9IGZ1bmN0aW9uIHJvbGxiYWNrKCkgewogICAgICBpZiAoIXRoaXMuaXNBYm9ydGVkKSB7CiAgICAgICAgX2xvZyh0aGlzLnJvdXRlciwgdGhpcy5zZXF1ZW5jZSwgdGhpcy50YXJnZXROYW1lICsgJzogdHJhbnNpdGlvbiB3YXMgYWJvcnRlZCcpOwoKICAgICAgICBpZiAodGhpcy5pbnRlbnQgIT09IHVuZGVmaW5lZCAmJiB0aGlzLmludGVudCAhPT0gbnVsbCkgewogICAgICAgICAgdGhpcy5pbnRlbnQucHJlVHJhbnNpdGlvblN0YXRlID0gdGhpcy5yb3V0ZXIuc3RhdGU7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmlzQWJvcnRlZCA9IHRydWU7CiAgICAgICAgdGhpcy5pc0FjdGl2ZSA9IGZhbHNlOwogICAgICAgIHRoaXMucm91dGVyLmFjdGl2ZVRyYW5zaXRpb24gPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLnJlZGlyZWN0ID0gZnVuY3Rpb24gcmVkaXJlY3QobmV3VHJhbnNpdGlvbikgewogICAgICB0aGlzLnJvbGxiYWNrKCk7CiAgICAgIHRoaXMucm91dGVyLnJvdXRlV2lsbENoYW5nZShuZXdUcmFuc2l0aW9uKTsKICAgIH0KICAgIC8qKgogICAgICAgICBSZXRyaWVzIGEgcHJldmlvdXNseS1hYm9ydGVkIHRyYW5zaXRpb24gKG1ha2luZyBzdXJlIHRvIGFib3J0IHRoZQogICAgICB0cmFuc2l0aW9uIGlmIGl0J3Mgc3RpbGwgYWN0aXZlKS4gUmV0dXJucyBhIG5ldyB0cmFuc2l0aW9uIHRoYXQKICAgICAgcmVwcmVzZW50cyB0aGUgbmV3IGF0dGVtcHQgdG8gdHJhbnNpdGlvbi4KICAgICAgICAgQG1ldGhvZCByZXRyeQogICAgICBAcmV0dXJuIHtUcmFuc2l0aW9ufSBuZXcgdHJhbnNpdGlvbgogICAgICBAcHVibGljCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucmV0cnkgPSBmdW5jdGlvbiByZXRyeSgpIHsKICAgICAgLy8gVE9ETzogYWRkIHRlc3RzIGZvciBtZXJnZWQgc3RhdGUgcmV0cnkoKXMKICAgICAgdGhpcy5hYm9ydCgpOwogICAgICB2YXIgbmV3VHJhbnNpdGlvbiA9IHRoaXMucm91dGVyLnRyYW5zaXRpb25CeUludGVudCh0aGlzLmludGVudCwgZmFsc2UpOyAvLyBpbmhlcml0aW5nIGEgYG51bGxgIHVybE1ldGhvZCBpcyBub3QgdmFsaWQKICAgICAgLy8gdGhlIHVybE1ldGhvZCBpcyBvbmx5IHNldCB0byBgbnVsbGAgd2hlbgogICAgICAvLyB0aGUgdHJhbnNpdGlvbiBpcyBpbml0aWF0ZWQgKmFmdGVyKiB0aGUgdXJsCiAgICAgIC8vIGhhcyBiZWVuIHVwZGF0ZWQgKGkuZS4gYHJvdXRlci5oYW5kbGVVUkxgKQogICAgICAvLwogICAgICAvLyBpbiB0aGF0IHNjZW5hcmlvLCB0aGUgdXJsIG1ldGhvZCBjYW5ub3QgYmUKICAgICAgLy8gaW5oZXJpdGVkIGZvciBhIG5ldyB0cmFuc2l0aW9uIGJlY2F1c2UgdGhlbgogICAgICAvLyB0aGUgdXJsIHdvdWxkIG5vdCB1cGRhdGUgZXZlbiB0aG91Z2ggaXQgc2hvdWxkCgogICAgICBpZiAodGhpcy51cmxNZXRob2QgIT09IG51bGwpIHsKICAgICAgICBuZXdUcmFuc2l0aW9uLm1ldGhvZCh0aGlzLnVybE1ldGhvZCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBuZXdUcmFuc2l0aW9uOwogICAgfQogICAgLyoqCiAgICAgICAgIFNldHMgdGhlIFVSTC1jaGFuZ2luZyBtZXRob2QgdG8gYmUgZW1wbG95ZWQgYXQgdGhlIGVuZCBvZiBhCiAgICAgIHN1Y2Nlc3NmdWwgdHJhbnNpdGlvbi4gQnkgZGVmYXVsdCwgYSBuZXcgVHJhbnNpdGlvbiB3aWxsIGp1c3QKICAgICAgdXNlIGB1cGRhdGVVUkxgLCBidXQgcGFzc2luZyAncmVwbGFjZScgdG8gdGhpcyBtZXRob2Qgd2lsbAogICAgICBjYXVzZSB0aGUgVVJMIHRvIHVwZGF0ZSB1c2luZyAncmVwbGFjZVdpdGgnIGluc3RlYWQuIE9taXR0aW5nCiAgICAgIGEgcGFyYW1ldGVyIHdpbGwgZGlzYWJsZSB0aGUgVVJMIGNoYW5nZSwgYWxsb3dpbmcgZm9yIHRyYW5zaXRpb25zCiAgICAgIHRoYXQgZG9uJ3QgdXBkYXRlIHRoZSBVUkwgYXQgY29tcGxldGlvbiAodGhpcyBpcyBhbHNvIHVzZWQgZm9yCiAgICAgIGhhbmRsZVVSTCwgc2luY2UgdGhlIFVSTCBoYXMgYWxyZWFkeSBjaGFuZ2VkIGJlZm9yZSB0aGUKICAgICAgdHJhbnNpdGlvbiB0b29rIHBsYWNlKS4KICAgICAgICAgQG1ldGhvZCBtZXRob2QKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1ldGhvZCB0aGUgdHlwZSBvZiBVUkwtY2hhbmdpbmcgbWV0aG9kIHRvIHVzZQogICAgICAgIGF0IHRoZSBlbmQgb2YgYSB0cmFuc2l0aW9uLiBBY2NlcHRlZCB2YWx1ZXMgYXJlICdyZXBsYWNlJywKICAgICAgICBmYWxzeSB2YWx1ZXMsIG9yIGFueSBvdGhlciBub24tZmFsc3kgdmFsdWUgKHdoaWNoIGlzCiAgICAgICAgaW50ZXJwcmV0ZWQgYXMgYW4gdXBkYXRlVVJMIHRyYW5zaXRpb24pLgogICAgICAgICBAcmV0dXJuIHtUcmFuc2l0aW9ufSB0aGlzIHRyYW5zaXRpb24KICAgICAgQHB1YmxpYwogICAgICovCiAgICA7CgogICAgX3Byb3RvLm1ldGhvZCA9IGZ1bmN0aW9uIG1ldGhvZChfbWV0aG9kKSB7CiAgICAgIHRoaXMudXJsTWV0aG9kID0gX21ldGhvZDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IC8vIEFsaWFzICd0cmlnZ2VyJyBhcyAnc2VuZCcKICAgIDsKCiAgICBfcHJvdG8uc2VuZCA9IGZ1bmN0aW9uIHNlbmQoaWdub3JlRmFpbHVyZSwgX25hbWUsIGVyciwgdHJhbnNpdGlvbiwgaGFuZGxlcikgewogICAgICBpZiAoaWdub3JlRmFpbHVyZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgaWdub3JlRmFpbHVyZSA9IGZhbHNlOwogICAgICB9CgogICAgICB0aGlzLnRyaWdnZXIoaWdub3JlRmFpbHVyZSwgX25hbWUsIGVyciwgdHJhbnNpdGlvbiwgaGFuZGxlcik7CiAgICB9CiAgICAvKioKICAgICAgICAgRmlyZXMgYW4gZXZlbnQgb24gdGhlIGN1cnJlbnQgbGlzdCBvZiByZXNvbHZlZC9yZXNvbHZpbmcKICAgICAgaGFuZGxlcnMgd2l0aGluIHRoaXMgdHJhbnNpdGlvbi4gVXNlZnVsIGZvciBmaXJpbmcgZXZlbnRzCiAgICAgIG9uIHJvdXRlIGhpZXJhcmNoaWVzIHRoYXQgaGF2ZW4ndCBmdWxseSBiZWVuIGVudGVyZWQgeWV0LgogICAgICAgICBOb3RlOiBUaGlzIG1ldGhvZCBpcyBhbHNvIGFsaWFzZWQgYXMgYHNlbmRgCiAgICAgICAgIEBtZXRob2QgdHJpZ2dlcgogICAgICBAcGFyYW0ge0Jvb2xlYW59IFtpZ25vcmVGYWlsdXJlPWZhbHNlXSBhIGJvb2xlYW4gc3BlY2lmeWluZyB3aGV0aGVyIHVuaGFuZGxlZCBldmVudHMgdGhyb3cgYW4gZXJyb3IKICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIG5hbWUgb2YgdGhlIGV2ZW50IHRvIGZpcmUKICAgICAgQHB1YmxpYwogICAgICovCiAgICA7CgogICAgX3Byb3RvLnRyaWdnZXIgPSBmdW5jdGlvbiB0cmlnZ2VyKGlnbm9yZUZhaWx1cmUsIG5hbWUpIHsKICAgICAgaWYgKGlnbm9yZUZhaWx1cmUgPT09IHZvaWQgMCkgewogICAgICAgIGlnbm9yZUZhaWx1cmUgPSBmYWxzZTsKICAgICAgfQoKICAgICAgLy8gVE9ETzogRGVwcmVjYXRlIHRoZSBjdXJyZW50IHNpZ25hdHVyZQogICAgICBpZiAodHlwZW9mIGlnbm9yZUZhaWx1cmUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgbmFtZSA9IGlnbm9yZUZhaWx1cmU7CiAgICAgICAgaWdub3JlRmFpbHVyZSA9IGZhbHNlOwogICAgICB9CgogICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjIgPiAyID8gX2xlbjIgLSAyIDogMCksIF9rZXkyID0gMjsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgIGFyZ3NbX2tleTIgLSAyXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgIH0KCiAgICAgIHRoaXMucm91dGVyLnRyaWdnZXJFdmVudCh0aGlzW1NUQVRFX1NZTUJPTF0ucm91dGVJbmZvcy5zbGljZSgwLCB0aGlzLnJlc29sdmVJbmRleCArIDEpLCBpZ25vcmVGYWlsdXJlLCBuYW1lLCBhcmdzKTsKICAgIH0KICAgIC8qKgogICAgICBUcmFuc2l0aW9ucyBhcmUgYWJvcnRlZCBhbmQgdGhlaXIgcHJvbWlzZXMgcmVqZWN0ZWQKICAgICAgd2hlbiByZWRpcmVjdHMgb2NjdXI7IHRoaXMgbWV0aG9kIHJldHVybnMgYSBwcm9taXNlCiAgICAgIHRoYXQgd2lsbCBmb2xsb3cgYW55IHJlZGlyZWN0cyB0aGF0IG9jY3VyIGFuZCBmdWxmaWxsCiAgICAgIHdpdGggdGhlIHZhbHVlIGZ1bGZpbGxlZCBieSBhbnkgcmVkaXJlY3RpbmcgdHJhbnNpdGlvbnMKICAgICAgdGhhdCBvY2N1ci4KICAgICAgICAgQG1ldGhvZCBmb2xsb3dSZWRpcmVjdHMKICAgICAgQHJldHVybiB7UHJvbWlzZX0gYSBwcm9taXNlIHRoYXQgZnVsZmlsbHMgd2l0aCB0aGUgc2FtZQogICAgICAgIHZhbHVlIHRoYXQgdGhlIGZpbmFsIHJlZGlyZWN0aW5nIHRyYW5zaXRpb24gZnVsZmlsbHMgd2l0aAogICAgICBAcHVibGljCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8uZm9sbG93UmVkaXJlY3RzID0gZnVuY3Rpb24gZm9sbG93UmVkaXJlY3RzKCkgewogICAgICB2YXIgcm91dGVyID0gdGhpcy5yb3V0ZXI7CiAgICAgIHJldHVybiB0aGlzLnByb21pc2UuY2F0Y2goZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIGlmIChyb3V0ZXIuYWN0aXZlVHJhbnNpdGlvbikgewogICAgICAgICAgcmV0dXJuIHJvdXRlci5hY3RpdmVUcmFuc2l0aW9uLmZvbGxvd1JlZGlyZWN0cygpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIF9yc3ZwLlByb21pc2UucmVqZWN0KHJlYXNvbik7CiAgICAgIH0pOwogICAgfTsKCiAgICBfcHJvdG8udG9TdHJpbmcgPSBmdW5jdGlvbiB0b1N0cmluZygpIHsKICAgICAgcmV0dXJuICdUcmFuc2l0aW9uIChzZXF1ZW5jZSAnICsgdGhpcy5zZXF1ZW5jZSArICcpJzsKICAgIH0KICAgIC8qKgogICAgICBAcHJpdmF0ZQogICAgICovCiAgICA7CgogICAgX3Byb3RvLmxvZyA9IGZ1bmN0aW9uIGxvZyhtZXNzYWdlKSB7CiAgICAgIF9sb2codGhpcy5yb3V0ZXIsIHRoaXMuc2VxdWVuY2UsIG1lc3NhZ2UpOwogICAgfTsKCiAgICByZXR1cm4gVHJhbnNpdGlvbjsKICB9KCk7CiAgLyoqCiAgICBAcHJpdmF0ZQogIAogICAgTG9ncyBhbmQgcmV0dXJucyBhbiBpbnN0YW5jZSBvZiBUcmFuc2l0aW9uQWJvcnRlZC4KICAgKi8KCgogIF9leHBvcnRzLkludGVybmFsVHJhbnNpdGlvbiA9IFRyYW5zaXRpb247CgogIGZ1bmN0aW9uIGxvZ0Fib3J0KHRyYW5zaXRpb24pIHsKICAgIF9sb2codHJhbnNpdGlvbi5yb3V0ZXIsIHRyYW5zaXRpb24uc2VxdWVuY2UsICdkZXRlY3RlZCBhYm9ydC4nKTsKCiAgICByZXR1cm4gbmV3IFRyYW5zaXRpb25BYm9ydGVkRXJyb3IoKTsKICB9CgogIGZ1bmN0aW9uIGlzVHJhbnNpdGlvbihvYmopIHsKICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJiBvYmogaW5zdGFuY2VvZiBUcmFuc2l0aW9uICYmIG9iai5pc1RyYW5zaXRpb247CiAgfQoKICBmdW5jdGlvbiBwcmVwYXJlUmVzdWx0KG9iaikgewogICAgaWYgKGlzVHJhbnNpdGlvbihvYmopKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfQoKICB2YXIgUk9VVEVfSU5GT1MgPSBuZXcgV2Vha01hcCgpOwoKICBmdW5jdGlvbiB0b1JlYWRPbmx5Um91dGVJbmZvKHJvdXRlSW5mb3MsIHF1ZXJ5UGFyYW1zLCBpbmNsdWRlQXR0cmlidXRlcykgewogICAgaWYgKHF1ZXJ5UGFyYW1zID09PSB2b2lkIDApIHsKICAgICAgcXVlcnlQYXJhbXMgPSB7fTsKICAgIH0KCiAgICBpZiAoaW5jbHVkZUF0dHJpYnV0ZXMgPT09IHZvaWQgMCkgewogICAgICBpbmNsdWRlQXR0cmlidXRlcyA9IGZhbHNlOwogICAgfQoKICAgIHJldHVybiByb3V0ZUluZm9zLm1hcChmdW5jdGlvbiAoaW5mbywgaSkgewogICAgICB2YXIgbmFtZSA9IGluZm8ubmFtZSwKICAgICAgICAgIHBhcmFtcyA9IGluZm8ucGFyYW1zLAogICAgICAgICAgcGFyYW1OYW1lcyA9IGluZm8ucGFyYW1OYW1lcywKICAgICAgICAgIGNvbnRleHQgPSBpbmZvLmNvbnRleHQsCiAgICAgICAgICByb3V0ZSA9IGluZm8ucm91dGU7CgogICAgICBpZiAoUk9VVEVfSU5GT1MuaGFzKGluZm8pICYmIGluY2x1ZGVBdHRyaWJ1dGVzKSB7CiAgICAgICAgdmFyIF9yb3V0ZUluZm8gPSBST1VURV9JTkZPUy5nZXQoaW5mbyk7CgogICAgICAgIF9yb3V0ZUluZm8gPSBhdHRhY2hNZXRhZGF0YShyb3V0ZSwgX3JvdXRlSW5mbyk7CiAgICAgICAgdmFyIHJvdXRlSW5mb1dpdGhBdHRyaWJ1dGUgPSBjcmVhdGVSb3V0ZUluZm9XaXRoQXR0cmlidXRlcyhfcm91dGVJbmZvLCBjb250ZXh0KTsKICAgICAgICBST1VURV9JTkZPUy5zZXQoaW5mbywgcm91dGVJbmZvV2l0aEF0dHJpYnV0ZSk7CiAgICAgICAgcmV0dXJuIHJvdXRlSW5mb1dpdGhBdHRyaWJ1dGU7CiAgICAgIH0KCiAgICAgIHZhciByb3V0ZUluZm8gPSB7CiAgICAgICAgZmluZDogZnVuY3Rpb24gZmluZChwcmVkaWNhdGUsIHRoaXNBcmcpIHsKICAgICAgICAgIHZhciBwdWJsaWNJbmZvOwogICAgICAgICAgdmFyIGFyciA9IFtdOwoKICAgICAgICAgIGlmIChwcmVkaWNhdGUubGVuZ3RoID09PSAzKSB7CiAgICAgICAgICAgIGFyciA9IHJvdXRlSW5mb3MubWFwKGZ1bmN0aW9uIChpbmZvKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFJPVVRFX0lORk9TLmdldChpbmZvKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyByb3V0ZUluZm9zLmxlbmd0aCA+IF9pOyBfaSsrKSB7CiAgICAgICAgICAgIHB1YmxpY0luZm8gPSBST1VURV9JTkZPUy5nZXQocm91dGVJbmZvc1tfaV0pOwoKICAgICAgICAgICAgaWYgKHByZWRpY2F0ZS5jYWxsKHRoaXNBcmcsIHB1YmxpY0luZm8sIF9pLCBhcnIpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHB1YmxpY0luZm87CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIH0sCgogICAgICAgIGdldCBuYW1lKCkgewogICAgICAgICAgcmV0dXJuIG5hbWU7CiAgICAgICAgfSwKCiAgICAgICAgZ2V0IHBhcmFtTmFtZXMoKSB7CiAgICAgICAgICByZXR1cm4gcGFyYW1OYW1lczsKICAgICAgICB9LAoKICAgICAgICBnZXQgbWV0YWRhdGEoKSB7CiAgICAgICAgICByZXR1cm4gYnVpbGRSb3V0ZUluZm9NZXRhZGF0YShpbmZvLnJvdXRlKTsKICAgICAgICB9LAoKICAgICAgICBnZXQgcGFyZW50KCkgewogICAgICAgICAgdmFyIHBhcmVudCA9IHJvdXRlSW5mb3NbaSAtIDFdOwoKICAgICAgICAgIGlmIChwYXJlbnQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gUk9VVEVfSU5GT1MuZ2V0KHBhcmVudCk7CiAgICAgICAgfSwKCiAgICAgICAgZ2V0IGNoaWxkKCkgewogICAgICAgICAgdmFyIGNoaWxkID0gcm91dGVJbmZvc1tpICsgMV07CgogICAgICAgICAgaWYgKGNoaWxkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIFJPVVRFX0lORk9TLmdldChjaGlsZCk7CiAgICAgICAgfSwKCiAgICAgICAgZ2V0IGxvY2FsTmFtZSgpIHsKICAgICAgICAgIHZhciBwYXJ0cyA9IHRoaXMubmFtZS5zcGxpdCgnLicpOwogICAgICAgICAgcmV0dXJuIHBhcnRzW3BhcnRzLmxlbmd0aCAtIDFdOwogICAgICAgIH0sCgogICAgICAgIGdldCBwYXJhbXMoKSB7CiAgICAgICAgICByZXR1cm4gcGFyYW1zOwogICAgICAgIH0sCgogICAgICAgIGdldCBxdWVyeVBhcmFtcygpIHsKICAgICAgICAgIHJldHVybiBxdWVyeVBhcmFtczsKICAgICAgICB9CgogICAgICB9OwoKICAgICAgaWYgKGluY2x1ZGVBdHRyaWJ1dGVzKSB7CiAgICAgICAgcm91dGVJbmZvID0gY3JlYXRlUm91dGVJbmZvV2l0aEF0dHJpYnV0ZXMocm91dGVJbmZvLCBjb250ZXh0KTsKICAgICAgfQoKICAgICAgUk9VVEVfSU5GT1Muc2V0KGluZm8sIHJvdXRlSW5mbyk7CiAgICAgIHJldHVybiByb3V0ZUluZm87CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZVJvdXRlSW5mb1dpdGhBdHRyaWJ1dGVzKHJvdXRlSW5mbywgY29udGV4dCkgewogICAgdmFyIGF0dHJpYnV0ZXMgPSB7CiAgICAgIGdldCBhdHRyaWJ1dGVzKCkgewogICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICB9CgogICAgfTsKCiAgICBpZiAoT2JqZWN0LmlzRnJvemVuKHJvdXRlSW5mbykgfHwgcm91dGVJbmZvLmhhc093blByb3BlcnR5KCdhdHRyaWJ1dGVzJykpIHsKICAgICAgcmV0dXJuIE9iamVjdC5mcmVlemUoKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7fSwgcm91dGVJbmZvLCBhdHRyaWJ1dGVzKSk7CiAgICB9CgogICAgcmV0dXJuICgwLCBfcG9seWZpbGxzLmFzc2lnbikocm91dGVJbmZvLCBhdHRyaWJ1dGVzKTsKICB9CgogIGZ1bmN0aW9uIGJ1aWxkUm91dGVJbmZvTWV0YWRhdGEocm91dGUpIHsKICAgIGlmIChyb3V0ZSAhPT0gdW5kZWZpbmVkICYmIHJvdXRlICE9PSBudWxsICYmIHJvdXRlLmJ1aWxkUm91dGVJbmZvTWV0YWRhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gcm91dGUuYnVpbGRSb3V0ZUluZm9NZXRhZGF0YSgpOwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH0KCiAgZnVuY3Rpb24gYXR0YWNoTWV0YWRhdGEocm91dGUsIHJvdXRlSW5mbykgewogICAgdmFyIG1ldGFkYXRhID0gewogICAgICBnZXQgbWV0YWRhdGEoKSB7CiAgICAgICAgcmV0dXJuIGJ1aWxkUm91dGVJbmZvTWV0YWRhdGEocm91dGUpOwogICAgICB9CgogICAgfTsKCiAgICBpZiAoT2JqZWN0LmlzRnJvemVuKHJvdXRlSW5mbykgfHwgcm91dGVJbmZvLmhhc093blByb3BlcnR5KCdtZXRhZGF0YScpKSB7CiAgICAgIHJldHVybiBPYmplY3QuZnJlZXplKCgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIHJvdXRlSW5mbywgbWV0YWRhdGEpKTsKICAgIH0KCiAgICByZXR1cm4gKDAsIF9wb2x5ZmlsbHMuYXNzaWduKShyb3V0ZUluZm8sIG1ldGFkYXRhKTsKICB9CgogIHZhciBJbnRlcm5hbFJvdXRlSW5mbyA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEludGVybmFsUm91dGVJbmZvKHJvdXRlciwgbmFtZSwgcGFyYW1OYW1lcywgcm91dGUpIHsKICAgICAgdGhpcy5fcm91dGVQcm9taXNlID0gdW5kZWZpbmVkOwogICAgICB0aGlzLl9yb3V0ZSA9IG51bGw7CiAgICAgIHRoaXMucGFyYW1zID0ge307CiAgICAgIHRoaXMuaXNSZXNvbHZlZCA9IGZhbHNlOwogICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICB0aGlzLnBhcmFtTmFtZXMgPSBwYXJhbU5hbWVzOwogICAgICB0aGlzLnJvdXRlciA9IHJvdXRlcjsKCiAgICAgIGlmIChyb3V0ZSkgewogICAgICAgIHRoaXMuX3Byb2Nlc3NSb3V0ZShyb3V0ZSk7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgX3Byb3RvMiA9IEludGVybmFsUm91dGVJbmZvLnByb3RvdHlwZTsKCiAgICBfcHJvdG8yLmdldE1vZGVsID0gZnVuY3Rpb24gZ2V0TW9kZWwoX3RyYW5zaXRpb24pIHsKICAgICAgcmV0dXJuIF9yc3ZwLlByb21pc2UucmVzb2x2ZSh0aGlzLmNvbnRleHQpOwogICAgfTsKCiAgICBfcHJvdG8yLnNlcmlhbGl6ZSA9IGZ1bmN0aW9uIHNlcmlhbGl6ZShfY29udGV4dCkgewogICAgICByZXR1cm4gdGhpcy5wYXJhbXMgfHwge307CiAgICB9OwoKICAgIF9wcm90bzIucmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmUoc2hvdWxkQ29udGludWUsIHRyYW5zaXRpb24pIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICByZXR1cm4gX3JzdnAuUHJvbWlzZS5yZXNvbHZlKHRoaXMucm91dGVQcm9taXNlKS50aGVuKGZ1bmN0aW9uIChyb3V0ZSkgewogICAgICAgIHJldHVybiBfdGhpczIuY2hlY2tGb3JBYm9ydChzaG91bGRDb250aW51ZSwgcm91dGUpOwogICAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gX3RoaXMyLnJ1bkJlZm9yZU1vZGVsSG9vayh0cmFuc2l0aW9uKTsKICAgICAgfSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIF90aGlzMi5jaGVja0ZvckFib3J0KHNob3VsZENvbnRpbnVlLCBudWxsKTsKICAgICAgfSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIF90aGlzMi5nZXRNb2RlbCh0cmFuc2l0aW9uKTsKICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzb2x2ZWRNb2RlbCkgewogICAgICAgIHJldHVybiBfdGhpczIuY2hlY2tGb3JBYm9ydChzaG91bGRDb250aW51ZSwgcmVzb2x2ZWRNb2RlbCk7CiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc29sdmVkTW9kZWwpIHsKICAgICAgICByZXR1cm4gX3RoaXMyLnJ1bkFmdGVyTW9kZWxIb29rKHRyYW5zaXRpb24sIHJlc29sdmVkTW9kZWwpOwogICAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNvbHZlZE1vZGVsKSB7CiAgICAgICAgcmV0dXJuIF90aGlzMi5iZWNvbWVSZXNvbHZlZCh0cmFuc2l0aW9uLCByZXNvbHZlZE1vZGVsKTsKICAgICAgfSk7CiAgICB9OwoKICAgIF9wcm90bzIuYmVjb21lUmVzb2x2ZWQgPSBmdW5jdGlvbiBiZWNvbWVSZXNvbHZlZCh0cmFuc2l0aW9uLCByZXNvbHZlZENvbnRleHQpIHsKICAgICAgdmFyIHBhcmFtcyA9IHRoaXMuc2VyaWFsaXplKHJlc29sdmVkQ29udGV4dCk7CgogICAgICBpZiAodHJhbnNpdGlvbikgewogICAgICAgIHRoaXMuc3Rhc2hSZXNvbHZlZE1vZGVsKHRyYW5zaXRpb24sIHJlc29sdmVkQ29udGV4dCk7CiAgICAgICAgdHJhbnNpdGlvbltQQVJBTVNfU1lNQk9MXSA9IHRyYW5zaXRpb25bUEFSQU1TX1NZTUJPTF0gfHwge307CiAgICAgICAgdHJhbnNpdGlvbltQQVJBTVNfU1lNQk9MXVt0aGlzLm5hbWVdID0gcGFyYW1zOwogICAgICB9CgogICAgICB2YXIgY29udGV4dDsKICAgICAgdmFyIGNvbnRleHRzTWF0Y2ggPSByZXNvbHZlZENvbnRleHQgPT09IHRoaXMuY29udGV4dDsKCiAgICAgIGlmICgnY29udGV4dCcgaW4gdGhpcyB8fCAhY29udGV4dHNNYXRjaCkgewogICAgICAgIGNvbnRleHQgPSByZXNvbHZlZENvbnRleHQ7CiAgICAgIH0KCiAgICAgIHZhciBjYWNoZWQgPSBST1VURV9JTkZPUy5nZXQodGhpcyk7CiAgICAgIHZhciByZXNvbHZlZCA9IG5ldyBSZXNvbHZlZFJvdXRlSW5mbyh0aGlzLnJvdXRlciwgdGhpcy5uYW1lLCB0aGlzLnBhcmFtTmFtZXMsIHBhcmFtcywgdGhpcy5yb3V0ZSwgY29udGV4dCk7CgogICAgICBpZiAoY2FjaGVkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBST1VURV9JTkZPUy5zZXQocmVzb2x2ZWQsIGNhY2hlZCk7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXNvbHZlZDsKICAgIH07CgogICAgX3Byb3RvMi5zaG91bGRTdXBlcmNlZGUgPSBmdW5jdGlvbiBzaG91bGRTdXBlcmNlZGUocm91dGVJbmZvKSB7CiAgICAgIC8vIFByZWZlciB0aGlzIG5ld2VyIHJvdXRlSW5mbyBvdmVyIGBvdGhlcmAgaWY6CiAgICAgIC8vIDEpIFRoZSBvdGhlciBvbmUgZG9lc24ndCBleGlzdAogICAgICAvLyAyKSBUaGUgbmFtZXMgZG9uJ3QgbWF0Y2gKICAgICAgLy8gMykgVGhpcyByb3V0ZSBoYXMgYSBjb250ZXh0IHRoYXQgZG9lc24ndCBtYXRjaAogICAgICAvLyAgICB0aGUgb3RoZXIgb25lIChvciB0aGUgb3RoZXIgb25lIGRvZXNuJ3QgaGF2ZSBvbmUpLgogICAgICAvLyA0KSBUaGlzIHJvdXRlIGhhcyBwYXJhbWV0ZXJzIHRoYXQgZG9uJ3QgbWF0Y2ggdGhlIG90aGVyLgogICAgICBpZiAoIXJvdXRlSW5mbykgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICB2YXIgY29udGV4dHNNYXRjaCA9IHJvdXRlSW5mby5jb250ZXh0ID09PSB0aGlzLmNvbnRleHQ7CiAgICAgIHJldHVybiByb3V0ZUluZm8ubmFtZSAhPT0gdGhpcy5uYW1lIHx8ICdjb250ZXh0JyBpbiB0aGlzICYmICFjb250ZXh0c01hdGNoIHx8IHRoaXMuaGFzT3duUHJvcGVydHkoJ3BhcmFtcycpICYmICFwYXJhbXNNYXRjaCh0aGlzLnBhcmFtcywgcm91dGVJbmZvLnBhcmFtcyk7CiAgICB9OwoKICAgIF9wcm90bzIubG9nID0gZnVuY3Rpb24gbG9nKHRyYW5zaXRpb24sIG1lc3NhZ2UpIHsKICAgICAgaWYgKHRyYW5zaXRpb24ubG9nKSB7CiAgICAgICAgdHJhbnNpdGlvbi5sb2codGhpcy5uYW1lICsgJzogJyArIG1lc3NhZ2UpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzIudXBkYXRlUm91dGUgPSBmdW5jdGlvbiB1cGRhdGVSb3V0ZShyb3V0ZSkgewogICAgICByb3V0ZS5faW50ZXJuYWxOYW1lID0gdGhpcy5uYW1lOwogICAgICByZXR1cm4gdGhpcy5yb3V0ZSA9IHJvdXRlOwogICAgfTsKCiAgICBfcHJvdG8yLnJ1bkJlZm9yZU1vZGVsSG9vayA9IGZ1bmN0aW9uIHJ1bkJlZm9yZU1vZGVsSG9vayh0cmFuc2l0aW9uKSB7CiAgICAgIGlmICh0cmFuc2l0aW9uLnRyaWdnZXIpIHsKICAgICAgICB0cmFuc2l0aW9uLnRyaWdnZXIodHJ1ZSwgJ3dpbGxSZXNvbHZlTW9kZWwnLCB0cmFuc2l0aW9uLCB0aGlzLnJvdXRlKTsKICAgICAgfQoKICAgICAgdmFyIHJlc3VsdDsKCiAgICAgIGlmICh0aGlzLnJvdXRlKSB7CiAgICAgICAgaWYgKHRoaXMucm91dGUuYmVmb3JlTW9kZWwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmVzdWx0ID0gdGhpcy5yb3V0ZS5iZWZvcmVNb2RlbCh0cmFuc2l0aW9uKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChpc1RyYW5zaXRpb24ocmVzdWx0KSkgewogICAgICAgIHJlc3VsdCA9IG51bGw7CiAgICAgIH0KCiAgICAgIHJldHVybiBfcnN2cC5Qcm9taXNlLnJlc29sdmUocmVzdWx0KTsKICAgIH07CgogICAgX3Byb3RvMi5ydW5BZnRlck1vZGVsSG9vayA9IGZ1bmN0aW9uIHJ1bkFmdGVyTW9kZWxIb29rKHRyYW5zaXRpb24sIHJlc29sdmVkTW9kZWwpIHsKICAgICAgLy8gU3Rhc2ggdGhlIHJlc29sdmVkIG1vZGVsIG9uIHRoZSBwYXlsb2FkLgogICAgICAvLyBUaGlzIG1ha2VzIGl0IHBvc3NpYmxlIGZvciB1c2VycyB0byBzd2FwIG91dAogICAgICAvLyB0aGUgcmVzb2x2ZWQgbW9kZWwgaW4gYWZ0ZXJNb2RlbC4KICAgICAgdmFyIG5hbWUgPSB0aGlzLm5hbWU7CiAgICAgIHRoaXMuc3Rhc2hSZXNvbHZlZE1vZGVsKHRyYW5zaXRpb24sIHJlc29sdmVkTW9kZWwpOwogICAgICB2YXIgcmVzdWx0OwoKICAgICAgaWYgKHRoaXMucm91dGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmICh0aGlzLnJvdXRlLmFmdGVyTW9kZWwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmVzdWx0ID0gdGhpcy5yb3V0ZS5hZnRlck1vZGVsKHJlc29sdmVkTW9kZWwsIHRyYW5zaXRpb24pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmVzdWx0ID0gcHJlcGFyZVJlc3VsdChyZXN1bHQpOwogICAgICByZXR1cm4gX3JzdnAuUHJvbWlzZS5yZXNvbHZlKHJlc3VsdCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gSWdub3JlIHRoZSBmdWxmaWxsZWQgdmFsdWUgcmV0dXJuZWQgZnJvbSBhZnRlck1vZGVsLgogICAgICAgIC8vIFJldHVybiB0aGUgdmFsdWUgc3Rhc2hlZCBpbiByZXNvbHZlZE1vZGVscywgd2hpY2gKICAgICAgICAvLyBtaWdodCBoYXZlIGJlZW4gc3dhcHBlZCBvdXQgaW4gYWZ0ZXJNb2RlbC4KICAgICAgICByZXR1cm4gdHJhbnNpdGlvbi5yZXNvbHZlZE1vZGVsc1tuYW1lXTsKICAgICAgfSk7CiAgICB9OwoKICAgIF9wcm90bzIuY2hlY2tGb3JBYm9ydCA9IGZ1bmN0aW9uIGNoZWNrRm9yQWJvcnQoc2hvdWxkQ29udGludWUsIHZhbHVlKSB7CiAgICAgIHJldHVybiBfcnN2cC5Qcm9taXNlLnJlc29sdmUoc2hvdWxkQ29udGludWUoKSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gV2UgZG9uJ3QgY2FyZSBhYm91dCBzaG91bGRDb250aW51ZSdzIHJlc29sdmUgdmFsdWU7CiAgICAgICAgLy8gcGFzcyBhbG9uZyB0aGUgb3JpZ2luYWwgdmFsdWUgcGFzc2VkIHRvIHRoaXMgZm4uCiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9LCBudWxsKTsKICAgIH07CgogICAgX3Byb3RvMi5zdGFzaFJlc29sdmVkTW9kZWwgPSBmdW5jdGlvbiBzdGFzaFJlc29sdmVkTW9kZWwodHJhbnNpdGlvbiwgcmVzb2x2ZWRNb2RlbCkgewogICAgICB0cmFuc2l0aW9uLnJlc29sdmVkTW9kZWxzID0gdHJhbnNpdGlvbi5yZXNvbHZlZE1vZGVscyB8fCB7fTsKICAgICAgdHJhbnNpdGlvbi5yZXNvbHZlZE1vZGVsc1t0aGlzLm5hbWVdID0gcmVzb2x2ZWRNb2RlbDsKICAgIH07CgogICAgX3Byb3RvMi5mZXRjaFJvdXRlID0gZnVuY3Rpb24gZmV0Y2hSb3V0ZSgpIHsKICAgICAgdmFyIHJvdXRlID0gdGhpcy5yb3V0ZXIuZ2V0Um91dGUodGhpcy5uYW1lKTsKICAgICAgcmV0dXJuIHRoaXMuX3Byb2Nlc3NSb3V0ZShyb3V0ZSk7CiAgICB9OwoKICAgIF9wcm90bzIuX3Byb2Nlc3NSb3V0ZSA9IGZ1bmN0aW9uIF9wcm9jZXNzUm91dGUocm91dGUpIHsKICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICAvLyBTZXR1cCBhIHJvdXRlUHJvbWlzZSBzbyB0aGF0IHdlIGNhbiB3YWl0IGZvciBhc3luY2hyb25vdXNseSBsb2FkZWQgcm91dGVzCiAgICAgIHRoaXMucm91dGVQcm9taXNlID0gX3JzdnAuUHJvbWlzZS5yZXNvbHZlKHJvdXRlKTsgLy8gV2FpdCB1bnRpbCB0aGUgJ3JvdXRlJyBwcm9wZXJ0eSBoYXMgYmVlbiB1cGRhdGVkIHdoZW4gY2hhaW5pbmcgdG8gYSByb3V0ZQogICAgICAvLyB0aGF0IGlzIGEgcHJvbWlzZQoKICAgICAgaWYgKGlzUHJvbWlzZShyb3V0ZSkpIHsKICAgICAgICB0aGlzLnJvdXRlUHJvbWlzZSA9IHRoaXMucm91dGVQcm9taXNlLnRoZW4oZnVuY3Rpb24gKHIpIHsKICAgICAgICAgIHJldHVybiBfdGhpczMudXBkYXRlUm91dGUocik7CiAgICAgICAgfSk7IC8vIHNldCB0byB1bmRlZmluZWQgdG8gYXZvaWQgcmVjdXJzaXZlIGxvb3AgaW4gdGhlIHJvdXRlIGdldHRlcgoKICAgICAgICByZXR1cm4gdGhpcy5yb3V0ZSA9IHVuZGVmaW5lZDsKICAgICAgfSBlbHNlIGlmIChyb3V0ZSkgewogICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZVJvdXRlKHJvdXRlKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH07CgogICAgKDAsIF9lbWJlckJhYmVsLmNyZWF0ZUNsYXNzKShJbnRlcm5hbFJvdXRlSW5mbywgW3sKICAgICAga2V5OiAicm91dGUiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAvLyBfcm91dGUgY291bGQgYmUgc2V0IHRvIGVpdGhlciBhIHJvdXRlIG9iamVjdCBvciB1bmRlZmluZWQsIHNvIHdlCiAgICAgICAgLy8gY29tcGFyZSBhZ2FpbnN0IG51bGwgdG8ga25vdyB3aGVuIGl0J3MgYmVlbiBzZXQKICAgICAgICBpZiAodGhpcy5fcm91dGUgIT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yb3V0ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLmZldGNoUm91dGUoKTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQocm91dGUpIHsKICAgICAgICB0aGlzLl9yb3V0ZSA9IHJvdXRlOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJvdXRlUHJvbWlzZSIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIGlmICh0aGlzLl9yb3V0ZVByb21pc2UpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yb3V0ZVByb21pc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmZldGNoUm91dGUoKTsKICAgICAgICByZXR1cm4gdGhpcy5fcm91dGVQcm9taXNlOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldChyb3V0ZVByb21pc2UpIHsKICAgICAgICB0aGlzLl9yb3V0ZVByb21pc2UgPSByb3V0ZVByb21pc2U7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBJbnRlcm5hbFJvdXRlSW5mbzsKICB9KCk7CgogIF9leHBvcnRzLkludGVybmFsUm91dGVJbmZvID0gSW50ZXJuYWxSb3V0ZUluZm87CgogIHZhciBSZXNvbHZlZFJvdXRlSW5mbyA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfSW50ZXJuYWxSb3V0ZUluZm8pIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShSZXNvbHZlZFJvdXRlSW5mbywgX0ludGVybmFsUm91dGVJbmZvKTsKCiAgICBmdW5jdGlvbiBSZXNvbHZlZFJvdXRlSW5mbyhyb3V0ZXIsIG5hbWUsIHBhcmFtTmFtZXMsIHBhcmFtcywgcm91dGUsIGNvbnRleHQpIHsKICAgICAgdmFyIF90aGlzNDsKCiAgICAgIF90aGlzNCA9IF9JbnRlcm5hbFJvdXRlSW5mby5jYWxsKHRoaXMsIHJvdXRlciwgbmFtZSwgcGFyYW1OYW1lcywgcm91dGUpIHx8IHRoaXM7CiAgICAgIF90aGlzNC5wYXJhbXMgPSBwYXJhbXM7CiAgICAgIF90aGlzNC5pc1Jlc29sdmVkID0gdHJ1ZTsKICAgICAgX3RoaXM0LmNvbnRleHQgPSBjb250ZXh0OwogICAgICByZXR1cm4gX3RoaXM0OwogICAgfQoKICAgIHZhciBfcHJvdG8zID0gUmVzb2x2ZWRSb3V0ZUluZm8ucHJvdG90eXBlOwoKICAgIF9wcm90bzMucmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmUoX3Nob3VsZENvbnRpbnVlLCB0cmFuc2l0aW9uKSB7CiAgICAgIC8vIEEgUmVzb2x2ZWRSb3V0ZUluZm8ganVzdCByZXNvbHZlZCB3aXRoIGl0c2VsZi4KICAgICAgaWYgKHRyYW5zaXRpb24gJiYgdHJhbnNpdGlvbi5yZXNvbHZlZE1vZGVscykgewogICAgICAgIHRyYW5zaXRpb24ucmVzb2x2ZWRNb2RlbHNbdGhpcy5uYW1lXSA9IHRoaXMuY29udGV4dDsKICAgICAgfQoKICAgICAgcmV0dXJuIF9yc3ZwLlByb21pc2UucmVzb2x2ZSh0aGlzKTsKICAgIH07CgogICAgcmV0dXJuIFJlc29sdmVkUm91dGVJbmZvOwogIH0oSW50ZXJuYWxSb3V0ZUluZm8pOwoKICB2YXIgVW5yZXNvbHZlZFJvdXRlSW5mb0J5UGFyYW0gPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0ludGVybmFsUm91dGVJbmZvMikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKFVucmVzb2x2ZWRSb3V0ZUluZm9CeVBhcmFtLCBfSW50ZXJuYWxSb3V0ZUluZm8yKTsKCiAgICBmdW5jdGlvbiBVbnJlc29sdmVkUm91dGVJbmZvQnlQYXJhbShyb3V0ZXIsIG5hbWUsIHBhcmFtTmFtZXMsIHBhcmFtcywgcm91dGUpIHsKICAgICAgdmFyIF90aGlzNTsKCiAgICAgIF90aGlzNSA9IF9JbnRlcm5hbFJvdXRlSW5mbzIuY2FsbCh0aGlzLCByb3V0ZXIsIG5hbWUsIHBhcmFtTmFtZXMsIHJvdXRlKSB8fCB0aGlzOwogICAgICBfdGhpczUucGFyYW1zID0ge307CiAgICAgIF90aGlzNS5wYXJhbXMgPSBwYXJhbXM7CiAgICAgIHJldHVybiBfdGhpczU7CiAgICB9CgogICAgdmFyIF9wcm90bzQgPSBVbnJlc29sdmVkUm91dGVJbmZvQnlQYXJhbS5wcm90b3R5cGU7CgogICAgX3Byb3RvNC5nZXRNb2RlbCA9IGZ1bmN0aW9uIGdldE1vZGVsKHRyYW5zaXRpb24pIHsKICAgICAgdmFyIGZ1bGxQYXJhbXMgPSB0aGlzLnBhcmFtczsKCiAgICAgIGlmICh0cmFuc2l0aW9uICYmIHRyYW5zaXRpb25bUVVFUllfUEFSQU1TX1NZTUJPTF0pIHsKICAgICAgICBmdWxsUGFyYW1zID0ge307CiAgICAgICAgbWVyZ2UoZnVsbFBhcmFtcywgdGhpcy5wYXJhbXMpOwogICAgICAgIGZ1bGxQYXJhbXMucXVlcnlQYXJhbXMgPSB0cmFuc2l0aW9uW1FVRVJZX1BBUkFNU19TWU1CT0xdOwogICAgICB9CgogICAgICB2YXIgcm91dGUgPSB0aGlzLnJvdXRlOwogICAgICB2YXIgcmVzdWx0ID0gdW5kZWZpbmVkOwoKICAgICAgaWYgKHJvdXRlLmRlc2VyaWFsaXplKSB7CiAgICAgICAgcmVzdWx0ID0gcm91dGUuZGVzZXJpYWxpemUoZnVsbFBhcmFtcywgdHJhbnNpdGlvbik7CiAgICAgIH0gZWxzZSBpZiAocm91dGUubW9kZWwpIHsKICAgICAgICByZXN1bHQgPSByb3V0ZS5tb2RlbChmdWxsUGFyYW1zLCB0cmFuc2l0aW9uKTsKICAgICAgfQoKICAgICAgaWYgKHJlc3VsdCAmJiBpc1RyYW5zaXRpb24ocmVzdWx0KSkgewogICAgICAgIHJlc3VsdCA9IHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgcmV0dXJuIF9yc3ZwLlByb21pc2UucmVzb2x2ZShyZXN1bHQpOwogICAgfTsKCiAgICByZXR1cm4gVW5yZXNvbHZlZFJvdXRlSW5mb0J5UGFyYW07CiAgfShJbnRlcm5hbFJvdXRlSW5mbyk7CgogIHZhciBVbnJlc29sdmVkUm91dGVJbmZvQnlPYmplY3QgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0ludGVybmFsUm91dGVJbmZvMykgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKFVucmVzb2x2ZWRSb3V0ZUluZm9CeU9iamVjdCwgX0ludGVybmFsUm91dGVJbmZvMyk7CgogICAgZnVuY3Rpb24gVW5yZXNvbHZlZFJvdXRlSW5mb0J5T2JqZWN0KHJvdXRlciwgbmFtZSwgcGFyYW1OYW1lcywgY29udGV4dCkgewogICAgICB2YXIgX3RoaXM2OwoKICAgICAgX3RoaXM2ID0gX0ludGVybmFsUm91dGVJbmZvMy5jYWxsKHRoaXMsIHJvdXRlciwgbmFtZSwgcGFyYW1OYW1lcykgfHwgdGhpczsKICAgICAgX3RoaXM2LmNvbnRleHQgPSBjb250ZXh0OwogICAgICBfdGhpczYuc2VyaWFsaXplciA9IF90aGlzNi5yb3V0ZXIuZ2V0U2VyaWFsaXplcihuYW1lKTsKICAgICAgcmV0dXJuIF90aGlzNjsKICAgIH0KCiAgICB2YXIgX3Byb3RvNSA9IFVucmVzb2x2ZWRSb3V0ZUluZm9CeU9iamVjdC5wcm90b3R5cGU7CgogICAgX3Byb3RvNS5nZXRNb2RlbCA9IGZ1bmN0aW9uIGdldE1vZGVsKHRyYW5zaXRpb24pIHsKICAgICAgaWYgKHRoaXMucm91dGVyLmxvZyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5yb3V0ZXIubG9nKHRoaXMubmFtZSArICc6IHJlc29sdmluZyBwcm92aWRlZCBtb2RlbCcpOwogICAgICB9CgogICAgICByZXR1cm4gX0ludGVybmFsUm91dGVJbmZvMy5wcm90b3R5cGUuZ2V0TW9kZWwuY2FsbCh0aGlzLCB0cmFuc2l0aW9uKTsKICAgIH0KICAgIC8qKgogICAgICBAcHJpdmF0ZQogICAgICAgICBTZXJpYWxpemVzIGEgcm91dGUgdXNpbmcgaXRzIGN1c3RvbSBgc2VyaWFsaXplYCBtZXRob2Qgb3IKICAgICAgYnkgYSBkZWZhdWx0IHRoYXQgbG9va3MgdXAgdGhlIGV4cGVjdGVkIHByb3BlcnR5IG5hbWUgZnJvbQogICAgICB0aGUgZHluYW1pYyBzZWdtZW50LgogICAgICAgICBAcGFyYW0ge09iamVjdH0gbW9kZWwgdGhlIG1vZGVsIHRvIGJlIHNlcmlhbGl6ZWQgZm9yIHRoaXMgcm91dGUKICAgICovCiAgICA7CgogICAgX3Byb3RvNS5zZXJpYWxpemUgPSBmdW5jdGlvbiBzZXJpYWxpemUobW9kZWwpIHsKICAgICAgdmFyIHBhcmFtTmFtZXMgPSB0aGlzLnBhcmFtTmFtZXMsCiAgICAgICAgICBjb250ZXh0ID0gdGhpcy5jb250ZXh0OwoKICAgICAgaWYgKCFtb2RlbCkgewogICAgICAgIG1vZGVsID0gY29udGV4dDsKICAgICAgfQoKICAgICAgdmFyIG9iamVjdCA9IHt9OwoKICAgICAgaWYgKGlzUGFyYW0obW9kZWwpKSB7CiAgICAgICAgb2JqZWN0W3BhcmFtTmFtZXNbMF1dID0gbW9kZWw7CiAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgfSAvLyBVc2UgY3VzdG9tIHNlcmlhbGl6ZSBpZiBpdCBleGlzdHMuCgoKICAgICAgaWYgKHRoaXMuc2VyaWFsaXplcikgewogICAgICAgIC8vIGludm9rZSB0aGlzLnNlcmlhbGl6ZXIgdW5ib3VuZCAoZ2V0U2VyaWFsaXplciByZXR1cm5zIGEgc3RhdGVsZXNzIGZ1bmN0aW9uKQogICAgICAgIHJldHVybiB0aGlzLnNlcmlhbGl6ZXIuY2FsbChudWxsLCBtb2RlbCwgcGFyYW1OYW1lcyk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5yb3V0ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKHRoaXMucm91dGUuc2VyaWFsaXplKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5yb3V0ZS5zZXJpYWxpemUobW9kZWwsIHBhcmFtTmFtZXMpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHBhcmFtTmFtZXMubGVuZ3RoICE9PSAxKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgbmFtZSA9IHBhcmFtTmFtZXNbMF07CgogICAgICBpZiAoL19pZCQvLnRlc3QobmFtZSkpIHsKICAgICAgICBvYmplY3RbbmFtZV0gPSBtb2RlbC5pZDsKICAgICAgfSBlbHNlIHsKICAgICAgICBvYmplY3RbbmFtZV0gPSBtb2RlbDsKICAgICAgfQoKICAgICAgcmV0dXJuIG9iamVjdDsKICAgIH07CgogICAgcmV0dXJuIFVucmVzb2x2ZWRSb3V0ZUluZm9CeU9iamVjdDsKICB9KEludGVybmFsUm91dGVJbmZvKTsKCiAgZnVuY3Rpb24gcGFyYW1zTWF0Y2goYSwgYikgewogICAgaWYgKCFhICE9PSAhYikgewogICAgICAvLyBPbmx5IG9uZSBpcyBudWxsLgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYgKCFhKSB7CiAgICAgIC8vIEJvdGggbXVzdCBiZSBudWxsLgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gLy8gTm90ZTogdGhpcyBhc3N1bWVzIHRoYXQgYm90aCBwYXJhbXMgaGF2ZSB0aGUgc2FtZQogICAgLy8gbnVtYmVyIG9mIGtleXMsIGJ1dCBzaW5jZSB3ZSdyZSBjb21wYXJpbmcgdGhlCiAgICAvLyBzYW1lIHJvdXRlcywgdGhleSBzaG91bGQuCgoKICAgIGZvciAodmFyIGsgaW4gYSkgewogICAgICBpZiAoYS5oYXNPd25Qcm9wZXJ0eShrKSAmJiBhW2tdICE9PSBiW2tdKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfQoKICB2YXIgVHJhbnNpdGlvbkludGVudCA9IGZ1bmN0aW9uIFRyYW5zaXRpb25JbnRlbnQocm91dGVyLCBkYXRhKSB7CiAgICBpZiAoZGF0YSA9PT0gdm9pZCAwKSB7CiAgICAgIGRhdGEgPSB7fTsKICAgIH0KCiAgICB0aGlzLnJvdXRlciA9IHJvdXRlcjsKICAgIHRoaXMuZGF0YSA9IGRhdGE7CiAgfTsKCiAgdmFyIFRyYW5zaXRpb25TdGF0ZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFRyYW5zaXRpb25TdGF0ZSgpIHsKICAgICAgdGhpcy5yb3V0ZUluZm9zID0gW107CiAgICAgIHRoaXMucXVlcnlQYXJhbXMgPSB7fTsKICAgICAgdGhpcy5wYXJhbXMgPSB7fTsKICAgIH0KCiAgICB2YXIgX3Byb3RvNiA9IFRyYW5zaXRpb25TdGF0ZS5wcm90b3R5cGU7CgogICAgX3Byb3RvNi5wcm9taXNlTGFiZWwgPSBmdW5jdGlvbiBwcm9taXNlTGFiZWwobGFiZWwpIHsKICAgICAgdmFyIHRhcmdldE5hbWUgPSAnJzsKICAgICAgZm9yRWFjaCh0aGlzLnJvdXRlSW5mb3MsIGZ1bmN0aW9uIChyb3V0ZUluZm8pIHsKICAgICAgICBpZiAodGFyZ2V0TmFtZSAhPT0gJycpIHsKICAgICAgICAgIHRhcmdldE5hbWUgKz0gJy4nOwogICAgICAgIH0KCiAgICAgICAgdGFyZ2V0TmFtZSArPSByb3V0ZUluZm8ubmFtZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSk7CiAgICAgIHJldHVybiBfcHJvbWlzZUxhYmVsKCInIiArIHRhcmdldE5hbWUgKyAiJzogIiArIGxhYmVsKTsKICAgIH07CgogICAgX3Byb3RvNi5yZXNvbHZlID0gZnVuY3Rpb24gcmVzb2x2ZShzaG91bGRDb250aW51ZSwgdHJhbnNpdGlvbikgewogICAgICAvLyBGaXJzdCwgY2FsY3VsYXRlIHBhcmFtcyBmb3IgdGhpcyBzdGF0ZS4gVGhpcyBpcyB1c2VmdWwKICAgICAgLy8gaW5mb3JtYXRpb24gdG8gcHJvdmlkZSB0byB0aGUgdmFyaW91cyByb3V0ZSBob29rcy4KICAgICAgdmFyIHBhcmFtcyA9IHRoaXMucGFyYW1zOwogICAgICBmb3JFYWNoKHRoaXMucm91dGVJbmZvcywgZnVuY3Rpb24gKHJvdXRlSW5mbykgewogICAgICAgIHBhcmFtc1tyb3V0ZUluZm8ubmFtZV0gPSByb3V0ZUluZm8ucGFyYW1zIHx8IHt9OwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9KTsKICAgICAgdHJhbnNpdGlvbi5yZXNvbHZlSW5kZXggPSAwOwogICAgICB2YXIgY3VycmVudFN0YXRlID0gdGhpczsKICAgICAgdmFyIHdhc0Fib3J0ZWQgPSBmYWxzZTsgLy8gVGhlIHByZWx1ZGUgUlNWUC5yZXNvbHZlKCkgYXN5bmNzIHVzIGludG8gdGhlIHByb21pc2UgbGFuZC4KCiAgICAgIHJldHVybiBfcnN2cC5Qcm9taXNlLnJlc29sdmUobnVsbCwgdGhpcy5wcm9taXNlTGFiZWwoJ1N0YXJ0IHRyYW5zaXRpb24nKSkudGhlbihyZXNvbHZlT25lUm91dGVJbmZvLCBudWxsLCB0aGlzLnByb21pc2VMYWJlbCgnUmVzb2x2ZSByb3V0ZScpKS5jYXRjaChoYW5kbGVFcnJvciwgdGhpcy5wcm9taXNlTGFiZWwoJ0hhbmRsZSBlcnJvcicpKTsKCiAgICAgIGZ1bmN0aW9uIGlubmVyU2hvdWxkQ29udGludWUoKSB7CiAgICAgICAgcmV0dXJuIF9yc3ZwLlByb21pc2UucmVzb2x2ZShzaG91bGRDb250aW51ZSgpLCBjdXJyZW50U3RhdGUucHJvbWlzZUxhYmVsKCdDaGVjayBpZiBzaG91bGQgY29udGludWUnKSkuY2F0Y2goZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgLy8gV2UgZGlzdGluZ3Vpc2ggYmV0d2VlbiBlcnJvcnMgdGhhdCBvY2N1cnJlZAogICAgICAgICAgLy8gZHVyaW5nIHJlc29sdXRpb24gKGUuZy4gYmVmb3JlIk1vZGVsL21vZGVsL2FmdGVyTW9kZWwpLAogICAgICAgICAgLy8gYW5kIGFib3J0cyBkdWUgdG8gYSByZWplY3RpbmcgcHJvbWlzZSBmcm9tIHNob3VsZENvbnRpbnVlKCkuCiAgICAgICAgICB3YXNBYm9ydGVkID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiBfcnN2cC5Qcm9taXNlLnJlamVjdChyZWFzb24pOwogICAgICAgIH0sIGN1cnJlbnRTdGF0ZS5wcm9taXNlTGFiZWwoJ0hhbmRsZSBhYm9ydCcpKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gaGFuZGxlRXJyb3IoZXJyb3IpIHsKICAgICAgICAvLyBUaGlzIGlzIHRoZSBvbmx5IHBvc3NpYmxlCiAgICAgICAgLy8gcmVqZWN0IHZhbHVlIG9mIFRyYW5zaXRpb25TdGF0ZSNyZXNvbHZlCiAgICAgICAgdmFyIHJvdXRlSW5mb3MgPSBjdXJyZW50U3RhdGUucm91dGVJbmZvczsKICAgICAgICB2YXIgZXJyb3JIYW5kbGVySW5kZXggPSB0cmFuc2l0aW9uLnJlc29sdmVJbmRleCA+PSByb3V0ZUluZm9zLmxlbmd0aCA/IHJvdXRlSW5mb3MubGVuZ3RoIC0gMSA6IHRyYW5zaXRpb24ucmVzb2x2ZUluZGV4OwogICAgICAgIHJldHVybiBfcnN2cC5Qcm9taXNlLnJlamVjdChuZXcgVHJhbnNpdGlvbkVycm9yKGVycm9yLCBjdXJyZW50U3RhdGUucm91dGVJbmZvc1tlcnJvckhhbmRsZXJJbmRleF0ucm91dGUsIHdhc0Fib3J0ZWQsIGN1cnJlbnRTdGF0ZSkpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBwcm9jZWVkKHJlc29sdmVkUm91dGVJbmZvKSB7CiAgICAgICAgdmFyIHdhc0FscmVhZHlSZXNvbHZlZCA9IGN1cnJlbnRTdGF0ZS5yb3V0ZUluZm9zW3RyYW5zaXRpb24ucmVzb2x2ZUluZGV4XS5pc1Jlc29sdmVkOyAvLyBTd2FwIHRoZSBwcmV2aW91c2x5IHVucmVzb2x2ZWQgcm91dGVJbmZvIHdpdGgKICAgICAgICAvLyB0aGUgcmVzb2x2ZWQgcm91dGVJbmZvCgogICAgICAgIGN1cnJlbnRTdGF0ZS5yb3V0ZUluZm9zW3RyYW5zaXRpb24ucmVzb2x2ZUluZGV4KytdID0gcmVzb2x2ZWRSb3V0ZUluZm87CgogICAgICAgIGlmICghd2FzQWxyZWFkeVJlc29sdmVkKSB7CiAgICAgICAgICAvLyBDYWxsIHRoZSByZWRpcmVjdCBob29rLiBUaGUgcmVhc29uIHdlIGNhbGwgaXQgaGVyZQogICAgICAgICAgLy8gdnMuIGFmdGVyTW9kZWwgaXMgc28gdGhhdCByZWRpcmVjdHMgaW50byBjaGlsZAogICAgICAgICAgLy8gcm91dGVzIGRvbid0IHJlLXJ1biB0aGUgbW9kZWwgaG9va3MgZm9yIHRoaXMKICAgICAgICAgIC8vIGFscmVhZHktcmVzb2x2ZWQgcm91dGUuCiAgICAgICAgICB2YXIgcm91dGUgPSByZXNvbHZlZFJvdXRlSW5mby5yb3V0ZTsKCiAgICAgICAgICBpZiAocm91dGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBpZiAocm91dGUucmVkaXJlY3QpIHsKICAgICAgICAgICAgICByb3V0ZS5yZWRpcmVjdChyZXNvbHZlZFJvdXRlSW5mby5jb250ZXh0LCB0cmFuc2l0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gLy8gUHJvY2VlZCBhZnRlciBlbnN1cmluZyB0aGF0IHRoZSByZWRpcmVjdCBob29rCiAgICAgICAgLy8gZGlkbid0IGFib3J0IHRoaXMgdHJhbnNpdGlvbiBieSB0cmFuc2l0aW9uaW5nIGVsc2V3aGVyZS4KCgogICAgICAgIHJldHVybiBpbm5lclNob3VsZENvbnRpbnVlKCkudGhlbihyZXNvbHZlT25lUm91dGVJbmZvLCBudWxsLCBjdXJyZW50U3RhdGUucHJvbWlzZUxhYmVsKCdSZXNvbHZlIHJvdXRlJykpOwogICAgICB9CgogICAgICBmdW5jdGlvbiByZXNvbHZlT25lUm91dGVJbmZvKCkgewogICAgICAgIGlmICh0cmFuc2l0aW9uLnJlc29sdmVJbmRleCA9PT0gY3VycmVudFN0YXRlLnJvdXRlSW5mb3MubGVuZ3RoKSB7CiAgICAgICAgICAvLyBUaGlzIGlzIGlzIHRoZSBvbmx5IHBvc3NpYmxlCiAgICAgICAgICAvLyBmdWxmaWxsIHZhbHVlIG9mIFRyYW5zaXRpb25TdGF0ZSNyZXNvbHZlCiAgICAgICAgICByZXR1cm4gY3VycmVudFN0YXRlOwogICAgICAgIH0KCiAgICAgICAgdmFyIHJvdXRlSW5mbyA9IGN1cnJlbnRTdGF0ZS5yb3V0ZUluZm9zW3RyYW5zaXRpb24ucmVzb2x2ZUluZGV4XTsKICAgICAgICByZXR1cm4gcm91dGVJbmZvLnJlc29sdmUoaW5uZXJTaG91bGRDb250aW51ZSwgdHJhbnNpdGlvbikudGhlbihwcm9jZWVkLCBudWxsLCBjdXJyZW50U3RhdGUucHJvbWlzZUxhYmVsKCdQcm9jZWVkJykpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBUcmFuc2l0aW9uU3RhdGU7CiAgfSgpOwoKICBfZXhwb3J0cy5UcmFuc2l0aW9uU3RhdGUgPSBUcmFuc2l0aW9uU3RhdGU7CgogIHZhciBUcmFuc2l0aW9uRXJyb3IgPSBmdW5jdGlvbiBUcmFuc2l0aW9uRXJyb3IoZXJyb3IsIHJvdXRlLCB3YXNBYm9ydGVkLCBzdGF0ZSkgewogICAgdGhpcy5lcnJvciA9IGVycm9yOwogICAgdGhpcy5yb3V0ZSA9IHJvdXRlOwogICAgdGhpcy53YXNBYm9ydGVkID0gd2FzQWJvcnRlZDsKICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTsKICB9OwoKICBfZXhwb3J0cy5UcmFuc2l0aW9uRXJyb3IgPSBUcmFuc2l0aW9uRXJyb3I7CgogIHZhciBOYW1lZFRyYW5zaXRpb25JbnRlbnQgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX1RyYW5zaXRpb25JbnRlbnQpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShOYW1lZFRyYW5zaXRpb25JbnRlbnQsIF9UcmFuc2l0aW9uSW50ZW50KTsKCiAgICBmdW5jdGlvbiBOYW1lZFRyYW5zaXRpb25JbnRlbnQocm91dGVyLCBuYW1lLCBwaXZvdEhhbmRsZXIsIGNvbnRleHRzLCBxdWVyeVBhcmFtcywgZGF0YSkgewogICAgICB2YXIgX3RoaXM3OwoKICAgICAgaWYgKGNvbnRleHRzID09PSB2b2lkIDApIHsKICAgICAgICBjb250ZXh0cyA9IFtdOwogICAgICB9CgogICAgICBpZiAocXVlcnlQYXJhbXMgPT09IHZvaWQgMCkgewogICAgICAgIHF1ZXJ5UGFyYW1zID0ge307CiAgICAgIH0KCiAgICAgIF90aGlzNyA9IF9UcmFuc2l0aW9uSW50ZW50LmNhbGwodGhpcywgcm91dGVyLCBkYXRhKSB8fCB0aGlzOwogICAgICBfdGhpczcucHJlVHJhbnNpdGlvblN0YXRlID0gdW5kZWZpbmVkOwogICAgICBfdGhpczcubmFtZSA9IG5hbWU7CiAgICAgIF90aGlzNy5waXZvdEhhbmRsZXIgPSBwaXZvdEhhbmRsZXI7CiAgICAgIF90aGlzNy5jb250ZXh0cyA9IGNvbnRleHRzOwogICAgICBfdGhpczcucXVlcnlQYXJhbXMgPSBxdWVyeVBhcmFtczsKICAgICAgcmV0dXJuIF90aGlzNzsKICAgIH0KCiAgICB2YXIgX3Byb3RvNyA9IE5hbWVkVHJhbnNpdGlvbkludGVudC5wcm90b3R5cGU7CgogICAgX3Byb3RvNy5hcHBseVRvU3RhdGUgPSBmdW5jdGlvbiBhcHBseVRvU3RhdGUob2xkU3RhdGUsIGlzSW50ZXJtZWRpYXRlKSB7CiAgICAgIC8vIFRPRE86IFdURiBmaXggbWUKICAgICAgdmFyIHBhcnRpdGlvbmVkQXJncyA9IGV4dHJhY3RRdWVyeVBhcmFtcyhbdGhpcy5uYW1lXS5jb25jYXQodGhpcy5jb250ZXh0cykpLAogICAgICAgICAgcHVyZUFyZ3MgPSBwYXJ0aXRpb25lZEFyZ3NbMF0sCiAgICAgICAgICBoYW5kbGVycyA9IHRoaXMucm91dGVyLnJlY29nbml6ZXIuaGFuZGxlcnNGb3IocHVyZUFyZ3NbMF0pOwogICAgICB2YXIgdGFyZ2V0Um91dGVOYW1lID0gaGFuZGxlcnNbaGFuZGxlcnMubGVuZ3RoIC0gMV0uaGFuZGxlcjsKICAgICAgcmV0dXJuIHRoaXMuYXBwbHlUb0hhbmRsZXJzKG9sZFN0YXRlLCBoYW5kbGVycywgdGFyZ2V0Um91dGVOYW1lLCBpc0ludGVybWVkaWF0ZSwgZmFsc2UpOwogICAgfTsKCiAgICBfcHJvdG83LmFwcGx5VG9IYW5kbGVycyA9IGZ1bmN0aW9uIGFwcGx5VG9IYW5kbGVycyhvbGRTdGF0ZSwgcGFyc2VkSGFuZGxlcnMsIHRhcmdldFJvdXRlTmFtZSwgaXNJbnRlcm1lZGlhdGUsIGNoZWNraW5nSWZBY3RpdmUpIHsKICAgICAgdmFyIGksIGxlbjsKICAgICAgdmFyIG5ld1N0YXRlID0gbmV3IFRyYW5zaXRpb25TdGF0ZSgpOwogICAgICB2YXIgb2JqZWN0cyA9IHRoaXMuY29udGV4dHMuc2xpY2UoMCk7CiAgICAgIHZhciBpbnZhbGlkYXRlSW5kZXggPSBwYXJzZWRIYW5kbGVycy5sZW5ndGg7IC8vIFBpdm90IGhhbmRsZXJzIGFyZSBwcm92aWRlZCBmb3IgcmVmcmVzaCB0cmFuc2l0aW9ucwoKICAgICAgaWYgKHRoaXMucGl2b3RIYW5kbGVyKSB7CiAgICAgICAgZm9yIChpID0gMCwgbGVuID0gcGFyc2VkSGFuZGxlcnMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICAgIGlmIChwYXJzZWRIYW5kbGVyc1tpXS5oYW5kbGVyID09PSB0aGlzLnBpdm90SGFuZGxlci5faW50ZXJuYWxOYW1lKSB7CiAgICAgICAgICAgIGludmFsaWRhdGVJbmRleCA9IGk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yIChpID0gcGFyc2VkSGFuZGxlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gcGFyc2VkSGFuZGxlcnNbaV07CiAgICAgICAgdmFyIG5hbWUgPSByZXN1bHQuaGFuZGxlcjsKICAgICAgICB2YXIgb2xkSGFuZGxlckluZm8gPSBvbGRTdGF0ZS5yb3V0ZUluZm9zW2ldOwogICAgICAgIHZhciBuZXdIYW5kbGVySW5mbyA9IG51bGw7CgogICAgICAgIGlmIChyZXN1bHQubmFtZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgaWYgKGkgPj0gaW52YWxpZGF0ZUluZGV4KSB7CiAgICAgICAgICAgIG5ld0hhbmRsZXJJbmZvID0gdGhpcy5jcmVhdGVQYXJhbUhhbmRsZXJJbmZvKG5hbWUsIHJlc3VsdC5uYW1lcywgb2JqZWN0cywgb2xkSGFuZGxlckluZm8pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV3SGFuZGxlckluZm8gPSB0aGlzLmdldEhhbmRsZXJJbmZvRm9yRHluYW1pY1NlZ21lbnQobmFtZSwgcmVzdWx0Lm5hbWVzLCBvYmplY3RzLCBvbGRIYW5kbGVySW5mbywgdGFyZ2V0Um91dGVOYW1lLCBpKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gVGhpcyByb3V0ZSBoYXMgbm8gZHluYW1pYyBzZWdtZW50LgogICAgICAgICAgLy8gVGhlcmVmb3JlIHRyZWF0IGFzIGEgcGFyYW0tYmFzZWQgaGFuZGxlckluZm8KICAgICAgICAgIC8vIHdpdGggZW1wdHkgcGFyYW1zLiBUaGlzIHdpbGwgY2F1c2UgdGhlIGBtb2RlbGAKICAgICAgICAgIC8vIGhvb2sgdG8gYmUgY2FsbGVkIHdpdGggZW1wdHkgcGFyYW1zLCB3aGljaCBpcyBkZXNpcmFibGUuCiAgICAgICAgICBuZXdIYW5kbGVySW5mbyA9IHRoaXMuY3JlYXRlUGFyYW1IYW5kbGVySW5mbyhuYW1lLCByZXN1bHQubmFtZXMsIG9iamVjdHMsIG9sZEhhbmRsZXJJbmZvKTsKICAgICAgICB9CgogICAgICAgIGlmIChjaGVja2luZ0lmQWN0aXZlKSB7CiAgICAgICAgICAvLyBJZiB3ZSdyZSBwZXJmb3JtaW5nIGFuIGlzQWN0aXZlIGNoZWNrLCB3ZSB3YW50IHRvCiAgICAgICAgICAvLyBzZXJpYWxpemUgVVJMIHBhcmFtcyB3aXRoIHRoZSBwcm92aWRlZCBjb250ZXh0LCBidXQKICAgICAgICAgIC8vIGlnbm9yZSBtaXNtYXRjaGVzIGJldHdlZW4gb2xkIGFuZCBuZXcgY29udGV4dC4KICAgICAgICAgIG5ld0hhbmRsZXJJbmZvID0gbmV3SGFuZGxlckluZm8uYmVjb21lUmVzb2x2ZWQobnVsbCwgbmV3SGFuZGxlckluZm8uY29udGV4dCk7CiAgICAgICAgICB2YXIgb2xkQ29udGV4dCA9IG9sZEhhbmRsZXJJbmZvICYmIG9sZEhhbmRsZXJJbmZvLmNvbnRleHQ7CgogICAgICAgICAgaWYgKHJlc3VsdC5uYW1lcy5sZW5ndGggPiAwICYmIG9sZEhhbmRsZXJJbmZvLmNvbnRleHQgIT09IHVuZGVmaW5lZCAmJiBuZXdIYW5kbGVySW5mby5jb250ZXh0ID09PSBvbGRDb250ZXh0KSB7CiAgICAgICAgICAgIC8vIElmIGNvbnRleHRzIG1hdGNoIGluIGlzQWN0aXZlIHRlc3QsIGFzc3VtZSBwYXJhbXMgYWxzbyBtYXRjaC4KICAgICAgICAgICAgLy8gVGhpcyBhbGxvd3MgZm9yIGZsZXhpYmlsaXR5IGluIG5vdCByZXF1aXJpbmcgdGhhdCBldmVyeSBsYXN0CiAgICAgICAgICAgIC8vIGhhbmRsZXIgcHJvdmlkZSBhIGBzZXJpYWxpemVgIG1ldGhvZAogICAgICAgICAgICBuZXdIYW5kbGVySW5mby5wYXJhbXMgPSBvbGRIYW5kbGVySW5mbyAmJiBvbGRIYW5kbGVySW5mby5wYXJhbXM7CiAgICAgICAgICB9CgogICAgICAgICAgbmV3SGFuZGxlckluZm8uY29udGV4dCA9IG9sZENvbnRleHQ7CiAgICAgICAgfQoKICAgICAgICB2YXIgaGFuZGxlclRvVXNlID0gb2xkSGFuZGxlckluZm87CgogICAgICAgIGlmIChpID49IGludmFsaWRhdGVJbmRleCB8fCBuZXdIYW5kbGVySW5mby5zaG91bGRTdXBlcmNlZGUob2xkSGFuZGxlckluZm8pKSB7CiAgICAgICAgICBpbnZhbGlkYXRlSW5kZXggPSBNYXRoLm1pbihpLCBpbnZhbGlkYXRlSW5kZXgpOwogICAgICAgICAgaGFuZGxlclRvVXNlID0gbmV3SGFuZGxlckluZm87CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNJbnRlcm1lZGlhdGUgJiYgIWNoZWNraW5nSWZBY3RpdmUpIHsKICAgICAgICAgIGhhbmRsZXJUb1VzZSA9IGhhbmRsZXJUb1VzZS5iZWNvbWVSZXNvbHZlZChudWxsLCBoYW5kbGVyVG9Vc2UuY29udGV4dCk7CiAgICAgICAgfQoKICAgICAgICBuZXdTdGF0ZS5yb3V0ZUluZm9zLnVuc2hpZnQoaGFuZGxlclRvVXNlKTsKICAgICAgfQoKICAgICAgaWYgKG9iamVjdHMubGVuZ3RoID4gMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignTW9yZSBjb250ZXh0IG9iamVjdHMgd2VyZSBwYXNzZWQgdGhhbiB0aGVyZSBhcmUgZHluYW1pYyBzZWdtZW50cyBmb3IgdGhlIHJvdXRlOiAnICsgdGFyZ2V0Um91dGVOYW1lKTsKICAgICAgfQoKICAgICAgaWYgKCFpc0ludGVybWVkaWF0ZSkgewogICAgICAgIHRoaXMuaW52YWxpZGF0ZUNoaWxkcmVuKG5ld1N0YXRlLnJvdXRlSW5mb3MsIGludmFsaWRhdGVJbmRleCk7CiAgICAgIH0KCiAgICAgIG1lcmdlKG5ld1N0YXRlLnF1ZXJ5UGFyYW1zLCB0aGlzLnF1ZXJ5UGFyYW1zIHx8IHt9KTsKICAgICAgcmV0dXJuIG5ld1N0YXRlOwogICAgfTsKCiAgICBfcHJvdG83LmludmFsaWRhdGVDaGlsZHJlbiA9IGZ1bmN0aW9uIGludmFsaWRhdGVDaGlsZHJlbihoYW5kbGVySW5mb3MsIGludmFsaWRhdGVJbmRleCkgewogICAgICBmb3IgKHZhciBpID0gaW52YWxpZGF0ZUluZGV4LCBsID0gaGFuZGxlckluZm9zLmxlbmd0aDsgaSA8IGw7ICsraSkgewogICAgICAgIHZhciBoYW5kbGVySW5mbyA9IGhhbmRsZXJJbmZvc1tpXTsKCiAgICAgICAgaWYgKGhhbmRsZXJJbmZvLmlzUmVzb2x2ZWQpIHsKICAgICAgICAgIHZhciBfaGFuZGxlckluZm9zJGkgPSBoYW5kbGVySW5mb3NbaV0sCiAgICAgICAgICAgICAgbmFtZSA9IF9oYW5kbGVySW5mb3MkaS5uYW1lLAogICAgICAgICAgICAgIHBhcmFtcyA9IF9oYW5kbGVySW5mb3MkaS5wYXJhbXMsCiAgICAgICAgICAgICAgcm91dGUgPSBfaGFuZGxlckluZm9zJGkucm91dGUsCiAgICAgICAgICAgICAgcGFyYW1OYW1lcyA9IF9oYW5kbGVySW5mb3MkaS5wYXJhbU5hbWVzOwogICAgICAgICAgaGFuZGxlckluZm9zW2ldID0gbmV3IFVucmVzb2x2ZWRSb3V0ZUluZm9CeVBhcmFtKHRoaXMucm91dGVyLCBuYW1lLCBwYXJhbU5hbWVzLCBwYXJhbXMsIHJvdXRlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNy5nZXRIYW5kbGVySW5mb0ZvckR5bmFtaWNTZWdtZW50ID0gZnVuY3Rpb24gZ2V0SGFuZGxlckluZm9Gb3JEeW5hbWljU2VnbWVudChuYW1lLCBuYW1lcywgb2JqZWN0cywgb2xkSGFuZGxlckluZm8sIF90YXJnZXRSb3V0ZU5hbWUsIGkpIHsKICAgICAgdmFyIG9iamVjdFRvVXNlOwoKICAgICAgaWYgKG9iamVjdHMubGVuZ3RoID4gMCkgewogICAgICAgIC8vIFVzZSB0aGUgb2JqZWN0cyBwcm92aWRlZCBmb3IgdGhpcyB0cmFuc2l0aW9uLgogICAgICAgIG9iamVjdFRvVXNlID0gb2JqZWN0c1tvYmplY3RzLmxlbmd0aCAtIDFdOwoKICAgICAgICBpZiAoaXNQYXJhbShvYmplY3RUb1VzZSkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZVBhcmFtSGFuZGxlckluZm8obmFtZSwgbmFtZXMsIG9iamVjdHMsIG9sZEhhbmRsZXJJbmZvKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb2JqZWN0cy5wb3AoKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAob2xkSGFuZGxlckluZm8gJiYgb2xkSGFuZGxlckluZm8ubmFtZSA9PT0gbmFtZSkgewogICAgICAgIC8vIFJldXNlIHRoZSBtYXRjaGluZyBvbGRIYW5kbGVySW5mbwogICAgICAgIHJldHVybiBvbGRIYW5kbGVySW5mbzsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5wcmVUcmFuc2l0aW9uU3RhdGUpIHsKICAgICAgICAgIHZhciBwcmVUcmFuc2l0aW9uSGFuZGxlckluZm8gPSB0aGlzLnByZVRyYW5zaXRpb25TdGF0ZS5yb3V0ZUluZm9zW2ldOwogICAgICAgICAgb2JqZWN0VG9Vc2UgPSBwcmVUcmFuc2l0aW9uSGFuZGxlckluZm8gJiYgcHJlVHJhbnNpdGlvbkhhbmRsZXJJbmZvLmNvbnRleHQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIElkZWFsbHkgd2Ugc2hvdWxkIHRocm93IHRoaXMgZXJyb3IgdG8gcHJvdmlkZSBtYXhpbWFsCiAgICAgICAgICAvLyBpbmZvcm1hdGlvbiB0byB0aGUgdXNlciB0aGF0IG5vdCBlbm91Z2ggY29udGV4dCBvYmplY3RzCiAgICAgICAgICAvLyB3ZXJlIHByb3ZpZGVkLCBidXQgdGhpcyBwcm92ZXMgdG9vIGN1bWJlcnNvbWUgaW4gRW1iZXIKICAgICAgICAgIC8vIGluIGNhc2VzIHdoZXJlIGlubmVyIHRlbXBsYXRlIGhlbHBlcnMgYXJlIGV2YWx1YXRlZAogICAgICAgICAgLy8gYmVmb3JlIHBhcmVudCBoZWxwZXJzIHVuLXJlbmRlciwgaW4gd2hpY2ggY2FzZXMgdGhpcwogICAgICAgICAgLy8gZXJyb3Igc29tZXdoYXQgcHJlbWF0dXJlbHkgZmlyZXMuCiAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcigiTm90IGVub3VnaCBjb250ZXh0IG9iamVjdHMgd2VyZSBwcm92aWRlZCB0byBjb21wbGV0ZSBhIHRyYW5zaXRpb24gdG8gIiArIHRhcmdldFJvdXRlTmFtZSArICIuIFNwZWNpZmljYWxseSwgdGhlICIgKyBuYW1lICsgIiByb3V0ZSBuZWVkcyBhbiBvYmplY3QgdGhhdCBjYW4gYmUgc2VyaWFsaXplZCBpbnRvIGl0cyBkeW5hbWljIFVSTCBzZWdtZW50cyBbIiArIG5hbWVzLmpvaW4oJywgJykgKyAiXSIpOwogICAgICAgICAgcmV0dXJuIG9sZEhhbmRsZXJJbmZvOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG5ldyBVbnJlc29sdmVkUm91dGVJbmZvQnlPYmplY3QodGhpcy5yb3V0ZXIsIG5hbWUsIG5hbWVzLCBvYmplY3RUb1VzZSk7CiAgICB9OwoKICAgIF9wcm90bzcuY3JlYXRlUGFyYW1IYW5kbGVySW5mbyA9IGZ1bmN0aW9uIGNyZWF0ZVBhcmFtSGFuZGxlckluZm8obmFtZSwgbmFtZXMsIG9iamVjdHMsIG9sZEhhbmRsZXJJbmZvKSB7CiAgICAgIHZhciBwYXJhbXMgPSB7fTsgLy8gU29hayB1cCBhbGwgdGhlIHByb3ZpZGVkIHN0cmluZy9udW1iZXJzCgogICAgICB2YXIgbnVtTmFtZXMgPSBuYW1lcy5sZW5ndGg7CiAgICAgIHZhciBtaXNzaW5nUGFyYW1zID0gW107CgogICAgICB3aGlsZSAobnVtTmFtZXMtLSkgewogICAgICAgIC8vIE9ubHkgdXNlIG9sZCBwYXJhbXMgaWYgdGhlIG5hbWVzIG1hdGNoIHdpdGggdGhlIG5ldyBoYW5kbGVyCiAgICAgICAgdmFyIG9sZFBhcmFtcyA9IG9sZEhhbmRsZXJJbmZvICYmIG5hbWUgPT09IG9sZEhhbmRsZXJJbmZvLm5hbWUgJiYgb2xkSGFuZGxlckluZm8ucGFyYW1zIHx8IHt9OwogICAgICAgIHZhciBwZWVrID0gb2JqZWN0c1tvYmplY3RzLmxlbmd0aCAtIDFdOwogICAgICAgIHZhciBwYXJhbU5hbWUgPSBuYW1lc1tudW1OYW1lc107CgogICAgICAgIGlmIChpc1BhcmFtKHBlZWspKSB7CiAgICAgICAgICBwYXJhbXNbcGFyYW1OYW1lXSA9ICcnICsgb2JqZWN0cy5wb3AoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gSWYgd2UncmUgaGVyZSwgdGhpcyBtZWFucyBvbmx5IHNvbWUgb2YgdGhlIHBhcmFtcwogICAgICAgICAgLy8gd2VyZSBzdHJpbmcvbnVtYmVyIHBhcmFtcywgc28gdHJ5IGFuZCB1c2UgYSBwYXJhbQogICAgICAgICAgLy8gdmFsdWUgZnJvbSBhIHByZXZpb3VzIGhhbmRsZXIuCiAgICAgICAgICBpZiAob2xkUGFyYW1zLmhhc093blByb3BlcnR5KHBhcmFtTmFtZSkpIHsKICAgICAgICAgICAgcGFyYW1zW3BhcmFtTmFtZV0gPSBvbGRQYXJhbXNbcGFyYW1OYW1lXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1pc3NpbmdQYXJhbXMucHVzaChwYXJhbU5hbWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKG1pc3NpbmdQYXJhbXMubGVuZ3RoID4gMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiWW91IGRpZG4ndCBwcm92aWRlIGVub3VnaCBzdHJpbmcvbnVtZXJpYyBwYXJhbWV0ZXJzIHRvIHNhdGlzZnkgYWxsIG9mIHRoZSBkeW5hbWljIHNlZ21lbnRzIGZvciByb3V0ZSAiICsgbmFtZSArICIuIiArICgiIE1pc3NpbmcgcGFyYW1zOiAiICsgbWlzc2luZ1BhcmFtcykpOwogICAgICB9CgogICAgICByZXR1cm4gbmV3IFVucmVzb2x2ZWRSb3V0ZUluZm9CeVBhcmFtKHRoaXMucm91dGVyLCBuYW1lLCBuYW1lcywgcGFyYW1zKTsKICAgIH07CgogICAgcmV0dXJuIE5hbWVkVHJhbnNpdGlvbkludGVudDsKICB9KFRyYW5zaXRpb25JbnRlbnQpOwoKICB2YXIgVW5yZWNvZ25pemVkVVJMRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICBVbnJlY29nbml6ZWRVUkxFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEVycm9yLnByb3RvdHlwZSk7CiAgICBVbnJlY29nbml6ZWRVUkxFcnJvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBVbnJlY29nbml6ZWRVUkxFcnJvcjsKCiAgICBmdW5jdGlvbiBVbnJlY29nbml6ZWRVUkxFcnJvcihtZXNzYWdlKSB7CiAgICAgIHZhciBlcnJvciA9IEVycm9yLmNhbGwodGhpcywgbWVzc2FnZSk7CiAgICAgIHRoaXMubmFtZSA9ICdVbnJlY29nbml6ZWRVUkxFcnJvcic7CiAgICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2UgfHwgJ1VucmVjb2duaXplZFVSTCc7CgogICAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBVbnJlY29nbml6ZWRVUkxFcnJvcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zdGFjayA9IGVycm9yLnN0YWNrOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIFVucmVjb2duaXplZFVSTEVycm9yOwogIH0oKTsKCiAgdmFyIFVSTFRyYW5zaXRpb25JbnRlbnQgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX1RyYW5zaXRpb25JbnRlbnQyKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoVVJMVHJhbnNpdGlvbkludGVudCwgX1RyYW5zaXRpb25JbnRlbnQyKTsKCiAgICBmdW5jdGlvbiBVUkxUcmFuc2l0aW9uSW50ZW50KHJvdXRlciwgdXJsLCBkYXRhKSB7CiAgICAgIHZhciBfdGhpczg7CgogICAgICBfdGhpczggPSBfVHJhbnNpdGlvbkludGVudDIuY2FsbCh0aGlzLCByb3V0ZXIsIGRhdGEpIHx8IHRoaXM7CiAgICAgIF90aGlzOC51cmwgPSB1cmw7CiAgICAgIF90aGlzOC5wcmVUcmFuc2l0aW9uU3RhdGUgPSB1bmRlZmluZWQ7CiAgICAgIHJldHVybiBfdGhpczg7CiAgICB9CgogICAgdmFyIF9wcm90bzggPSBVUkxUcmFuc2l0aW9uSW50ZW50LnByb3RvdHlwZTsKCiAgICBfcHJvdG84LmFwcGx5VG9TdGF0ZSA9IGZ1bmN0aW9uIGFwcGx5VG9TdGF0ZShvbGRTdGF0ZSkgewogICAgICB2YXIgbmV3U3RhdGUgPSBuZXcgVHJhbnNpdGlvblN0YXRlKCk7CiAgICAgIHZhciByZXN1bHRzID0gdGhpcy5yb3V0ZXIucmVjb2duaXplci5yZWNvZ25pemUodGhpcy51cmwpLAogICAgICAgICAgaSwKICAgICAgICAgIGxlbjsKCiAgICAgIGlmICghcmVzdWx0cykgewogICAgICAgIHRocm93IG5ldyBVbnJlY29nbml6ZWRVUkxFcnJvcih0aGlzLnVybCk7CiAgICAgIH0KCiAgICAgIHZhciBzdGF0ZXNEaWZmZXIgPSBmYWxzZTsKICAgICAgdmFyIF91cmwgPSB0aGlzLnVybDsgLy8gQ2hlY2tzIGlmIGEgaGFuZGxlciBpcyBhY2Nlc3NpYmxlIGJ5IFVSTC4gSWYgaXQgaXMgbm90LCBhbiBlcnJvciBpcyB0aHJvd24uCiAgICAgIC8vIEZvciB0aGUgY2FzZSB3aGVyZSB0aGUgaGFuZGxlciBpcyBsb2FkZWQgYXN5bmNocm9ub3VzbHksIHRoZSBlcnJvciB3aWxsIGJlCiAgICAgIC8vIHRocm93biBvbmNlIGl0IGlzIGxvYWRlZC4KCiAgICAgIGZ1bmN0aW9uIGNoZWNrSGFuZGxlckFjY2Vzc2liaWxpdHkoaGFuZGxlcikgewogICAgICAgIGlmIChoYW5kbGVyICYmIGhhbmRsZXIuaW5hY2Nlc3NpYmxlQnlVUkwpIHsKICAgICAgICAgIHRocm93IG5ldyBVbnJlY29nbml6ZWRVUkxFcnJvcihfdXJsKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBoYW5kbGVyOwogICAgICB9CgogICAgICBmb3IgKGkgPSAwLCBsZW4gPSByZXN1bHRzLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHJlc3VsdHNbaV07CiAgICAgICAgdmFyIG5hbWUgPSByZXN1bHQuaGFuZGxlcjsKICAgICAgICB2YXIgcGFyYW1OYW1lcyA9IFtdOwoKICAgICAgICBpZiAodGhpcy5yb3V0ZXIucmVjb2duaXplci5oYXNSb3V0ZShuYW1lKSkgewogICAgICAgICAgcGFyYW1OYW1lcyA9IHRoaXMucm91dGVyLnJlY29nbml6ZXIuaGFuZGxlcnNGb3IobmFtZSlbaV0ubmFtZXM7CiAgICAgICAgfQoKICAgICAgICB2YXIgbmV3Um91dGVJbmZvID0gbmV3IFVucmVzb2x2ZWRSb3V0ZUluZm9CeVBhcmFtKHRoaXMucm91dGVyLCBuYW1lLCBwYXJhbU5hbWVzLCByZXN1bHQucGFyYW1zKTsKICAgICAgICB2YXIgcm91dGUgPSBuZXdSb3V0ZUluZm8ucm91dGU7CgogICAgICAgIGlmIChyb3V0ZSkgewogICAgICAgICAgY2hlY2tIYW5kbGVyQWNjZXNzaWJpbGl0eShyb3V0ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIElmIHRoZSBoYW5sZGVyIGlzIGJlaW5nIGxvYWRlZCBhc3luY2hyb25vdXNseSwgY2hlY2sgaWYgd2UgY2FuCiAgICAgICAgICAvLyBhY2Nlc3MgaXQgYWZ0ZXIgaXQgaGFzIHJlc29sdmVkCiAgICAgICAgICBuZXdSb3V0ZUluZm8ucm91dGVQcm9taXNlID0gbmV3Um91dGVJbmZvLnJvdXRlUHJvbWlzZS50aGVuKGNoZWNrSGFuZGxlckFjY2Vzc2liaWxpdHkpOwogICAgICAgIH0KCiAgICAgICAgdmFyIG9sZFJvdXRlSW5mbyA9IG9sZFN0YXRlLnJvdXRlSW5mb3NbaV07CgogICAgICAgIGlmIChzdGF0ZXNEaWZmZXIgfHwgbmV3Um91dGVJbmZvLnNob3VsZFN1cGVyY2VkZShvbGRSb3V0ZUluZm8pKSB7CiAgICAgICAgICBzdGF0ZXNEaWZmZXIgPSB0cnVlOwogICAgICAgICAgbmV3U3RhdGUucm91dGVJbmZvc1tpXSA9IG5ld1JvdXRlSW5mbzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbmV3U3RhdGUucm91dGVJbmZvc1tpXSA9IG9sZFJvdXRlSW5mbzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIG1lcmdlKG5ld1N0YXRlLnF1ZXJ5UGFyYW1zLCByZXN1bHRzLnF1ZXJ5UGFyYW1zKTsKICAgICAgcmV0dXJuIG5ld1N0YXRlOwogICAgfTsKCiAgICByZXR1cm4gVVJMVHJhbnNpdGlvbkludGVudDsKICB9KFRyYW5zaXRpb25JbnRlbnQpOwoKICB2YXIgUm91dGVyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gUm91dGVyKGxvZ2dlcikgewogICAgICB0aGlzLl9sYXN0UXVlcnlQYXJhbXMgPSB7fTsKICAgICAgdGhpcy5zdGF0ZSA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5vbGRTdGF0ZSA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5hY3RpdmVUcmFuc2l0aW9uID0gdW5kZWZpbmVkOwogICAgICB0aGlzLmN1cnJlbnRSb3V0ZUluZm9zID0gdW5kZWZpbmVkOwogICAgICB0aGlzLl9jaGFuZ2VkUXVlcnlQYXJhbXMgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuY3VycmVudFNlcXVlbmNlID0gMDsKICAgICAgdGhpcy5sb2cgPSBsb2dnZXI7CiAgICAgIHRoaXMucmVjb2duaXplciA9IG5ldyBfcm91dGVSZWNvZ25pemVyLmRlZmF1bHQoKTsKICAgICAgdGhpcy5yZXNldCgpOwogICAgfQogICAgLyoqCiAgICAgIFRoZSBtYWluIGVudHJ5IHBvaW50IGludG8gdGhlIHJvdXRlci4gVGhlIEFQSSBpcyBlc3NlbnRpYWxseQogICAgICB0aGUgc2FtZSBhcyB0aGUgYG1hcGAgbWV0aG9kIGluIGByb3V0ZS1yZWNvZ25pemVyYC4KICAgICAgICAgVGhpcyBtZXRob2QgZXh0cmFjdHMgdGhlIFN0cmluZyBoYW5kbGVyIGF0IHRoZSBsYXN0IGAudG8oKWAKICAgICAgY2FsbCBhbmQgdXNlcyBpdCBhcyB0aGUgbmFtZSBvZiB0aGUgd2hvbGUgcm91dGUuCiAgICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgICAqLwoKCiAgICB2YXIgX3Byb3RvOSA9IFJvdXRlci5wcm90b3R5cGU7CgogICAgX3Byb3RvOS5tYXAgPSBmdW5jdGlvbiBtYXAoY2FsbGJhY2spIHsKICAgICAgdGhpcy5yZWNvZ25pemVyLm1hcChjYWxsYmFjaywgZnVuY3Rpb24gKHJlY29nbml6ZXIsIHJvdXRlcykgewogICAgICAgIGZvciAodmFyIGkgPSByb3V0ZXMubGVuZ3RoIC0gMSwgcHJvY2VlZCA9IHRydWU7IGkgPj0gMCAmJiBwcm9jZWVkOyAtLWkpIHsKICAgICAgICAgIHZhciByb3V0ZSA9IHJvdXRlc1tpXTsKICAgICAgICAgIHZhciBoYW5kbGVyID0gcm91dGUuaGFuZGxlcjsKICAgICAgICAgIHJlY29nbml6ZXIuYWRkKHJvdXRlcywgewogICAgICAgICAgICBhczogaGFuZGxlcgogICAgICAgICAgfSk7CiAgICAgICAgICBwcm9jZWVkID0gcm91dGUucGF0aCA9PT0gJy8nIHx8IHJvdXRlLnBhdGggPT09ICcnIHx8IGhhbmRsZXIuc2xpY2UoLTYpID09PSAnLmluZGV4JzsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKCiAgICBfcHJvdG85Lmhhc1JvdXRlID0gZnVuY3Rpb24gaGFzUm91dGUocm91dGUpIHsKICAgICAgcmV0dXJuIHRoaXMucmVjb2duaXplci5oYXNSb3V0ZShyb3V0ZSk7CiAgICB9OwoKICAgIF9wcm90bzkucXVlcnlQYXJhbXNUcmFuc2l0aW9uID0gZnVuY3Rpb24gcXVlcnlQYXJhbXNUcmFuc2l0aW9uKGNoYW5nZWxpc3QsIHdhc1RyYW5zaXRpb25pbmcsIG9sZFN0YXRlLCBuZXdTdGF0ZSkgewogICAgICB2YXIgX3RoaXM5ID0gdGhpczsKCiAgICAgIHRoaXMuZmlyZVF1ZXJ5UGFyYW1EaWRDaGFuZ2UobmV3U3RhdGUsIGNoYW5nZWxpc3QpOwoKICAgICAgaWYgKCF3YXNUcmFuc2l0aW9uaW5nICYmIHRoaXMuYWN0aXZlVHJhbnNpdGlvbikgewogICAgICAgIC8vIE9uZSBvZiB0aGUgcm91dGVzIGluIHF1ZXJ5UGFyYW1zRGlkQ2hhbmdlCiAgICAgICAgLy8gY2F1c2VkIGEgdHJhbnNpdGlvbi4gSnVzdCByZXR1cm4gdGhhdCB0cmFuc2l0aW9uLgogICAgICAgIHJldHVybiB0aGlzLmFjdGl2ZVRyYW5zaXRpb247CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gUnVubmluZyBxdWVyeVBhcmFtc0RpZENoYW5nZSBkaWRuJ3QgY2hhbmdlIGFueXRoaW5nLgogICAgICAgIC8vIEp1c3QgdXBkYXRlIHF1ZXJ5IHBhcmFtcyBhbmQgYmUgb24gb3VyIHdheS4KICAgICAgICAvLyBXZSBoYXZlIHRvIHJldHVybiBhIG5vb3AgdHJhbnNpdGlvbiB0aGF0IHdpbGwKICAgICAgICAvLyBwZXJmb3JtIGEgVVJMIHVwZGF0ZSBhdCB0aGUgZW5kLiBUaGlzIGdpdmVzCiAgICAgICAgLy8gdGhlIHVzZXIgdGhlIGFiaWxpdHkgdG8gc2V0IHRoZSB1cmwgdXBkYXRlCiAgICAgICAgLy8gbWV0aG9kIChkZWZhdWx0IGlzIHJlcGxhY2VTdGF0ZSkuCiAgICAgICAgdmFyIG5ld1RyYW5zaXRpb24gPSBuZXcgVHJhbnNpdGlvbih0aGlzLCB1bmRlZmluZWQsIHVuZGVmaW5lZCk7CiAgICAgICAgbmV3VHJhbnNpdGlvbi5xdWVyeVBhcmFtc09ubHkgPSB0cnVlOwogICAgICAgIG9sZFN0YXRlLnF1ZXJ5UGFyYW1zID0gdGhpcy5maW5hbGl6ZVF1ZXJ5UGFyYW1DaGFuZ2UobmV3U3RhdGUucm91dGVJbmZvcywgbmV3U3RhdGUucXVlcnlQYXJhbXMsIG5ld1RyYW5zaXRpb24pOwogICAgICAgIG5ld1RyYW5zaXRpb25bUVVFUllfUEFSQU1TX1NZTUJPTF0gPSBuZXdTdGF0ZS5xdWVyeVBhcmFtczsKICAgICAgICB0aGlzLnRvUmVhZE9ubHlJbmZvcyhuZXdUcmFuc2l0aW9uLCBuZXdTdGF0ZSk7CiAgICAgICAgdGhpcy5yb3V0ZVdpbGxDaGFuZ2UobmV3VHJhbnNpdGlvbik7CiAgICAgICAgbmV3VHJhbnNpdGlvbi5wcm9taXNlID0gbmV3VHJhbnNpdGlvbi5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgICAgX3RoaXM5Ll91cGRhdGVVUkwobmV3VHJhbnNpdGlvbiwgb2xkU3RhdGUpOwoKICAgICAgICAgIF90aGlzOS5kaWRUcmFuc2l0aW9uKF90aGlzOS5jdXJyZW50Um91dGVJbmZvcyk7CgogICAgICAgICAgX3RoaXM5LnRvSW5mb3MobmV3VHJhbnNpdGlvbiwgbmV3U3RhdGUucm91dGVJbmZvcywgdHJ1ZSk7CgogICAgICAgICAgX3RoaXM5LnJvdXRlRGlkQ2hhbmdlKG5ld1RyYW5zaXRpb24pOwoKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwgbnVsbCwgX3Byb21pc2VMYWJlbCgnVHJhbnNpdGlvbiBjb21wbGV0ZScpKTsKICAgICAgICByZXR1cm4gbmV3VHJhbnNpdGlvbjsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG85LnRyYW5zaXRpb25CeUludGVudCA9IGZ1bmN0aW9uIHRyYW5zaXRpb25CeUludGVudChpbnRlbnQsIGlzSW50ZXJtZWRpYXRlKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VHJhbnNpdGlvbkJ5SW50ZW50KGludGVudCwgaXNJbnRlcm1lZGlhdGUpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmV0dXJuIG5ldyBUcmFuc2l0aW9uKHRoaXMsIGludGVudCwgdW5kZWZpbmVkLCBlLCB1bmRlZmluZWQpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzkucmVjb2duaXplID0gZnVuY3Rpb24gcmVjb2duaXplKHVybCkgewogICAgICB2YXIgaW50ZW50ID0gbmV3IFVSTFRyYW5zaXRpb25JbnRlbnQodGhpcywgdXJsKTsKICAgICAgdmFyIG5ld1N0YXRlID0gdGhpcy5nZW5lcmF0ZU5ld1N0YXRlKGludGVudCk7CgogICAgICBpZiAobmV3U3RhdGUgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gbmV3U3RhdGU7CiAgICAgIH0KCiAgICAgIHZhciByZWFkb25seUluZm9zID0gdG9SZWFkT25seVJvdXRlSW5mbyhuZXdTdGF0ZS5yb3V0ZUluZm9zLCBuZXdTdGF0ZS5xdWVyeVBhcmFtcyk7CiAgICAgIHJldHVybiByZWFkb25seUluZm9zW3JlYWRvbmx5SW5mb3MubGVuZ3RoIC0gMV07CiAgICB9OwoKICAgIF9wcm90bzkucmVjb2duaXplQW5kTG9hZCA9IGZ1bmN0aW9uIHJlY29nbml6ZUFuZExvYWQodXJsKSB7CiAgICAgIHZhciBpbnRlbnQgPSBuZXcgVVJMVHJhbnNpdGlvbkludGVudCh0aGlzLCB1cmwpOwogICAgICB2YXIgbmV3U3RhdGUgPSB0aGlzLmdlbmVyYXRlTmV3U3RhdGUoaW50ZW50KTsKCiAgICAgIGlmIChuZXdTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBfcnN2cC5Qcm9taXNlLnJlamVjdCgiVVJMICIgKyB1cmwgKyAiIHdhcyBub3QgcmVjb2duaXplZCIpOwogICAgICB9CgogICAgICB2YXIgbmV3VHJhbnNpdGlvbiA9IG5ldyBUcmFuc2l0aW9uKHRoaXMsIGludGVudCwgbmV3U3RhdGUsIHVuZGVmaW5lZCk7CiAgICAgIHJldHVybiBuZXdUcmFuc2l0aW9uLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIHZhciByb3V0ZUluZm9zV2l0aEF0dHJpYnV0ZXMgPSB0b1JlYWRPbmx5Um91dGVJbmZvKG5ld1N0YXRlLnJvdXRlSW5mb3MsIG5ld1RyYW5zaXRpb25bUVVFUllfUEFSQU1TX1NZTUJPTF0sIHRydWUpOwogICAgICAgIHJldHVybiByb3V0ZUluZm9zV2l0aEF0dHJpYnV0ZXNbcm91dGVJbmZvc1dpdGhBdHRyaWJ1dGVzLmxlbmd0aCAtIDFdOwogICAgICB9KTsKICAgIH07CgogICAgX3Byb3RvOS5nZW5lcmF0ZU5ld1N0YXRlID0gZnVuY3Rpb24gZ2VuZXJhdGVOZXdTdGF0ZShpbnRlbnQpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gaW50ZW50LmFwcGx5VG9TdGF0ZSh0aGlzLnN0YXRlLCBmYWxzZSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG85LmdldFRyYW5zaXRpb25CeUludGVudCA9IGZ1bmN0aW9uIGdldFRyYW5zaXRpb25CeUludGVudChpbnRlbnQsIGlzSW50ZXJtZWRpYXRlKSB7CiAgICAgIHZhciBfdGhpczEwID0gdGhpczsKCiAgICAgIHZhciB3YXNUcmFuc2l0aW9uaW5nID0gISF0aGlzLmFjdGl2ZVRyYW5zaXRpb247CiAgICAgIHZhciBvbGRTdGF0ZSA9IHdhc1RyYW5zaXRpb25pbmcgPyB0aGlzLmFjdGl2ZVRyYW5zaXRpb25bU1RBVEVfU1lNQk9MXSA6IHRoaXMuc3RhdGU7CiAgICAgIHZhciBuZXdUcmFuc2l0aW9uOwogICAgICB2YXIgbmV3U3RhdGUgPSBpbnRlbnQuYXBwbHlUb1N0YXRlKG9sZFN0YXRlLCBpc0ludGVybWVkaWF0ZSk7CiAgICAgIHZhciBxdWVyeVBhcmFtQ2hhbmdlbGlzdCA9IGdldENoYW5nZWxpc3Qob2xkU3RhdGUucXVlcnlQYXJhbXMsIG5ld1N0YXRlLnF1ZXJ5UGFyYW1zKTsKCiAgICAgIGlmIChyb3V0ZUluZm9zRXF1YWwobmV3U3RhdGUucm91dGVJbmZvcywgb2xkU3RhdGUucm91dGVJbmZvcykpIHsKICAgICAgICAvLyBUaGlzIGlzIGEgbm8tb3AgdHJhbnNpdGlvbi4gU2VlIGlmIHF1ZXJ5IHBhcmFtcyBjaGFuZ2VkLgogICAgICAgIGlmIChxdWVyeVBhcmFtQ2hhbmdlbGlzdCkgewogICAgICAgICAgdmFyIF9uZXdUcmFuc2l0aW9uID0gdGhpcy5xdWVyeVBhcmFtc1RyYW5zaXRpb24ocXVlcnlQYXJhbUNoYW5nZWxpc3QsIHdhc1RyYW5zaXRpb25pbmcsIG9sZFN0YXRlLCBuZXdTdGF0ZSk7CgogICAgICAgICAgX25ld1RyYW5zaXRpb24ucXVlcnlQYXJhbXNPbmx5ID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiBfbmV3VHJhbnNpdGlvbjsKICAgICAgICB9IC8vIE5vLW9wLiBObyBuZWVkIHRvIGNyZWF0ZSBhIG5ldyB0cmFuc2l0aW9uLgoKCiAgICAgICAgcmV0dXJuIHRoaXMuYWN0aXZlVHJhbnNpdGlvbiB8fCBuZXcgVHJhbnNpdGlvbih0aGlzLCB1bmRlZmluZWQsIHVuZGVmaW5lZCk7CiAgICAgIH0KCiAgICAgIGlmIChpc0ludGVybWVkaWF0ZSkgewogICAgICAgIHZhciB0cmFuc2l0aW9uID0gbmV3IFRyYW5zaXRpb24odGhpcywgdW5kZWZpbmVkLCB1bmRlZmluZWQpOwogICAgICAgIHRoaXMudG9SZWFkT25seUluZm9zKHRyYW5zaXRpb24sIG5ld1N0YXRlKTsKICAgICAgICB0aGlzLnNldHVwQ29udGV4dHMobmV3U3RhdGUpOwogICAgICAgIHRoaXMucm91dGVXaWxsQ2hhbmdlKHRyYW5zaXRpb24pOwogICAgICAgIHJldHVybiB0aGlzLmFjdGl2ZVRyYW5zaXRpb247CiAgICAgIH0gLy8gQ3JlYXRlIGEgbmV3IHRyYW5zaXRpb24gdG8gdGhlIGRlc3RpbmF0aW9uIHJvdXRlLgoKCiAgICAgIG5ld1RyYW5zaXRpb24gPSBuZXcgVHJhbnNpdGlvbih0aGlzLCBpbnRlbnQsIG5ld1N0YXRlLCB1bmRlZmluZWQsIHRoaXMuYWN0aXZlVHJhbnNpdGlvbik7IC8vIHRyYW5zaXRpb24gaXMgdG8gc2FtZSByb3V0ZSB3aXRoIHNhbWUgcGFyYW1zLCBvbmx5IHF1ZXJ5IHBhcmFtcyBkaWZmZXIuCiAgICAgIC8vIG5vdCBjYXVnaHQgYWJvdmUgcHJvYmFibHkgYmVjYXVzZSByZWZyZXNoKCkgaGFzIGJlZW4gdXNlZAoKICAgICAgaWYgKHJvdXRlSW5mb3NTYW1lRXhjZXB0UXVlcnlQYXJhbXMobmV3U3RhdGUucm91dGVJbmZvcywgb2xkU3RhdGUucm91dGVJbmZvcykpIHsKICAgICAgICBuZXdUcmFuc2l0aW9uLnF1ZXJ5UGFyYW1zT25seSA9IHRydWU7CiAgICAgIH0KCiAgICAgIHRoaXMudG9SZWFkT25seUluZm9zKG5ld1RyYW5zaXRpb24sIG5ld1N0YXRlKTsgLy8gQWJvcnQgYW5kIHVzdXJwIGFueSBwcmV2aW91c2x5IGFjdGl2ZSB0cmFuc2l0aW9uLgoKICAgICAgaWYgKHRoaXMuYWN0aXZlVHJhbnNpdGlvbikgewogICAgICAgIHRoaXMuYWN0aXZlVHJhbnNpdGlvbi5yZWRpcmVjdChuZXdUcmFuc2l0aW9uKTsKICAgICAgfQoKICAgICAgdGhpcy5hY3RpdmVUcmFuc2l0aW9uID0gbmV3VHJhbnNpdGlvbjsgLy8gVHJhbnNpdGlvbiBwcm9taXNlcyBieSBkZWZhdWx0IHJlc29sdmUgd2l0aCByZXNvbHZlZCBzdGF0ZS4KICAgICAgLy8gRm9yIG91ciBwdXJwb3Nlcywgc3dhcCBvdXQgdGhlIHByb21pc2UgdG8gcmVzb2x2ZQogICAgICAvLyBhZnRlciB0aGUgdHJhbnNpdGlvbiBoYXMgYmVlbiBmaW5hbGl6ZWQuCgogICAgICBuZXdUcmFuc2l0aW9uLnByb21pc2UgPSBuZXdUcmFuc2l0aW9uLnByb21pc2UudGhlbihmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIF90aGlzMTAuZmluYWxpemVUcmFuc2l0aW9uKG5ld1RyYW5zaXRpb24sIHJlc3VsdCk7CiAgICAgIH0sIG51bGwsIF9wcm9taXNlTGFiZWwoJ1NldHRsZSB0cmFuc2l0aW9uIHByb21pc2Ugd2hlbiB0cmFuc2l0aW9uIGlzIGZpbmFsaXplZCcpKTsKCiAgICAgIGlmICghd2FzVHJhbnNpdGlvbmluZykgewogICAgICAgIHRoaXMubm90aWZ5RXhpc3RpbmdIYW5kbGVycyhuZXdTdGF0ZSwgbmV3VHJhbnNpdGlvbik7CiAgICAgIH0KCiAgICAgIHRoaXMuZmlyZVF1ZXJ5UGFyYW1EaWRDaGFuZ2UobmV3U3RhdGUsIHF1ZXJ5UGFyYW1DaGFuZ2VsaXN0KTsKICAgICAgcmV0dXJuIG5ld1RyYW5zaXRpb247CiAgICB9CiAgICAvKioKICAgIEBwcml2YXRlCiAgICAgICBCZWdpbnMgYW5kIHJldHVybnMgYSBUcmFuc2l0aW9uIGJhc2VkIG9uIHRoZSBwcm92aWRlZAogICAgYXJndW1lbnRzLiBBY2NlcHRzIGFyZ3VtZW50cyBpbiB0aGUgZm9ybSBvZiBib3RoIFVSTAogICAgdHJhbnNpdGlvbnMgYW5kIG5hbWVkIHRyYW5zaXRpb25zLgogICAgICAgQHBhcmFtIHtSb3V0ZXJ9IHJvdXRlcgogICAgQHBhcmFtIHtBcnJheVtPYmplY3RdfSBhcmdzIGFyZ3VtZW50cyBwYXNzZWQgdG8gdHJhbnNpdGlvblRvLAogICAgICByZXBsYWNlV2l0aCwgb3IgaGFuZGxlVVJMCiAgICAqLwogICAgOwoKICAgIF9wcm90bzkuZG9UcmFuc2l0aW9uID0gZnVuY3Rpb24gZG9UcmFuc2l0aW9uKG5hbWUsIG1vZGVsc0FycmF5LCBpc0ludGVybWVkaWF0ZSkgewogICAgICBpZiAobW9kZWxzQXJyYXkgPT09IHZvaWQgMCkgewogICAgICAgIG1vZGVsc0FycmF5ID0gW107CiAgICAgIH0KCiAgICAgIGlmIChpc0ludGVybWVkaWF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgaXNJbnRlcm1lZGlhdGUgPSBmYWxzZTsKICAgICAgfQoKICAgICAgdmFyIGxhc3RBcmcgPSBtb2RlbHNBcnJheVttb2RlbHNBcnJheS5sZW5ndGggLSAxXTsKICAgICAgdmFyIHF1ZXJ5UGFyYW1zID0ge307CgogICAgICBpZiAobGFzdEFyZyAhPT0gdW5kZWZpbmVkICYmIGxhc3RBcmcuaGFzT3duUHJvcGVydHkoJ3F1ZXJ5UGFyYW1zJykpIHsKICAgICAgICBxdWVyeVBhcmFtcyA9IG1vZGVsc0FycmF5LnBvcCgpLnF1ZXJ5UGFyYW1zOwogICAgICB9CgogICAgICB2YXIgaW50ZW50OwoKICAgICAgaWYgKG5hbWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIF9sb2codGhpcywgJ1VwZGF0aW5nIHF1ZXJ5IHBhcmFtcycpOyAvLyBBIHF1ZXJ5IHBhcmFtIHVwZGF0ZSBpcyByZWFsbHkganVzdCBhIHRyYW5zaXRpb24KICAgICAgICAvLyBpbnRvIHRoZSByb3V0ZSB5b3UncmUgYWxyZWFkeSBvbi4KCgogICAgICAgIHZhciByb3V0ZUluZm9zID0gdGhpcy5zdGF0ZS5yb3V0ZUluZm9zOwogICAgICAgIGludGVudCA9IG5ldyBOYW1lZFRyYW5zaXRpb25JbnRlbnQodGhpcywgcm91dGVJbmZvc1tyb3V0ZUluZm9zLmxlbmd0aCAtIDFdLm5hbWUsIHVuZGVmaW5lZCwgW10sIHF1ZXJ5UGFyYW1zKTsKICAgICAgfSBlbHNlIGlmIChuYW1lLmNoYXJBdCgwKSA9PT0gJy8nKSB7CiAgICAgICAgX2xvZyh0aGlzLCAnQXR0ZW1wdGluZyBVUkwgdHJhbnNpdGlvbiB0byAnICsgbmFtZSk7CgogICAgICAgIGludGVudCA9IG5ldyBVUkxUcmFuc2l0aW9uSW50ZW50KHRoaXMsIG5hbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIF9sb2codGhpcywgJ0F0dGVtcHRpbmcgdHJhbnNpdGlvbiB0byAnICsgbmFtZSk7CgogICAgICAgIGludGVudCA9IG5ldyBOYW1lZFRyYW5zaXRpb25JbnRlbnQodGhpcywgbmFtZSwgdW5kZWZpbmVkLCBtb2RlbHNBcnJheSwgcXVlcnlQYXJhbXMpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy50cmFuc2l0aW9uQnlJbnRlbnQoaW50ZW50LCBpc0ludGVybWVkaWF0ZSk7CiAgICB9CiAgICAvKioKICAgIEBwcml2YXRlCiAgICAgICBVcGRhdGVzIHRoZSBVUkwgKGlmIG5lY2Vzc2FyeSkgYW5kIGNhbGxzIGBzZXR1cENvbnRleHRzYAogICAgdG8gdXBkYXRlIHRoZSByb3V0ZXIncyBhcnJheSBvZiBgY3VycmVudFJvdXRlSW5mb3NgLgogICAgKi8KICAgIDsKCiAgICBfcHJvdG85LmZpbmFsaXplVHJhbnNpdGlvbiA9IGZ1bmN0aW9uIGZpbmFsaXplVHJhbnNpdGlvbih0cmFuc2l0aW9uLCBuZXdTdGF0ZSkgewogICAgICB0cnkgewogICAgICAgIF9sb2codHJhbnNpdGlvbi5yb3V0ZXIsIHRyYW5zaXRpb24uc2VxdWVuY2UsICdSZXNvbHZlZCBhbGwgbW9kZWxzIG9uIGRlc3RpbmF0aW9uIHJvdXRlOyBmaW5hbGl6aW5nIHRyYW5zaXRpb24uJyk7CgogICAgICAgIHZhciByb3V0ZUluZm9zID0gbmV3U3RhdGUucm91dGVJbmZvczsgLy8gUnVuIGFsbCB0aGUgbmVjZXNzYXJ5IGVudGVyL3NldHVwL2V4aXQgaG9va3MKCiAgICAgICAgdGhpcy5zZXR1cENvbnRleHRzKG5ld1N0YXRlLCB0cmFuc2l0aW9uKTsgLy8gQ2hlY2sgaWYgYSByZWRpcmVjdCBvY2N1cnJlZCBpbiBlbnRlci9zZXR1cAoKICAgICAgICBpZiAodHJhbnNpdGlvbi5pc0Fib3J0ZWQpIHsKICAgICAgICAgIC8vIFRPRE86IGNsZWFuZXIgd2F5PyBkaXN0aW5ndWlzaCBiL3cgdGFyZ2V0Um91dGVJbmZvcz8KICAgICAgICAgIHRoaXMuc3RhdGUucm91dGVJbmZvcyA9IHRoaXMuY3VycmVudFJvdXRlSW5mb3M7CiAgICAgICAgICByZXR1cm4gX3JzdnAuUHJvbWlzZS5yZWplY3QobG9nQWJvcnQodHJhbnNpdGlvbikpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fdXBkYXRlVVJMKHRyYW5zaXRpb24sIG5ld1N0YXRlKTsKCiAgICAgICAgdHJhbnNpdGlvbi5pc0FjdGl2ZSA9IGZhbHNlOwogICAgICAgIHRoaXMuYWN0aXZlVHJhbnNpdGlvbiA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLnRyaWdnZXJFdmVudCh0aGlzLmN1cnJlbnRSb3V0ZUluZm9zLCB0cnVlLCAnZGlkVHJhbnNpdGlvbicsIFtdKTsKICAgICAgICB0aGlzLmRpZFRyYW5zaXRpb24odGhpcy5jdXJyZW50Um91dGVJbmZvcyk7CiAgICAgICAgdGhpcy50b0luZm9zKHRyYW5zaXRpb24sIG5ld1N0YXRlLnJvdXRlSW5mb3MsIHRydWUpOwogICAgICAgIHRoaXMucm91dGVEaWRDaGFuZ2UodHJhbnNpdGlvbik7CgogICAgICAgIF9sb2codGhpcywgdHJhbnNpdGlvbi5zZXF1ZW5jZSwgJ1RSQU5TSVRJT04gQ09NUExFVEUuJyk7IC8vIFJlc29sdmUgd2l0aCB0aGUgZmluYWwgcm91dGUuCgoKICAgICAgICByZXR1cm4gcm91dGVJbmZvc1tyb3V0ZUluZm9zLmxlbmd0aCAtIDFdLnJvdXRlOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgaWYgKCEoZSBpbnN0YW5jZW9mIFRyYW5zaXRpb25BYm9ydGVkRXJyb3IpKSB7CiAgICAgICAgICB2YXIgaW5mb3MgPSB0cmFuc2l0aW9uW1NUQVRFX1NZTUJPTF0ucm91dGVJbmZvczsKICAgICAgICAgIHRyYW5zaXRpb24udHJpZ2dlcih0cnVlLCAnZXJyb3InLCBlLCB0cmFuc2l0aW9uLCBpbmZvc1tpbmZvcy5sZW5ndGggLSAxXS5yb3V0ZSk7CiAgICAgICAgICB0cmFuc2l0aW9uLmFib3J0KCk7CiAgICAgICAgfQoKICAgICAgICB0aHJvdyBlOwogICAgICB9CiAgICB9CiAgICAvKioKICAgIEBwcml2YXRlCiAgICAgICBUYWtlcyBhbiBBcnJheSBvZiBgUm91dGVJbmZvYHMsIGZpZ3VyZXMgb3V0IHdoaWNoIG9uZXMgYXJlCiAgICBleGl0aW5nLCBlbnRlcmluZywgb3IgY2hhbmdpbmcgY29udGV4dHMsIGFuZCBjYWxscyB0aGUKICAgIHByb3BlciByb3V0ZSBob29rcy4KICAgICAgIEZvciBleGFtcGxlLCBjb25zaWRlciB0aGUgZm9sbG93aW5nIHRyZWUgb2Ygcm91dGVzLiBFYWNoIHJvdXRlIGlzCiAgICBmb2xsb3dlZCBieSB0aGUgVVJMIHNlZ21lbnQgaXQgaGFuZGxlcy4KICAgICAgIGBgYAogICAgfH5pbmRleCAoIi8iKQogICAgfCB8fnBvc3RzICgiL3Bvc3RzIikKICAgIHwgfCB8LXNob3dQb3N0ICgiLzppZCIpCiAgICB8IHwgfC1uZXdQb3N0ICgiL25ldyIpCiAgICB8IHwgfC1lZGl0UG9zdCAoIi9lZGl0IikKICAgIHwgfH5hYm91dCAoIi9hYm91dC86aWQiKQogICAgYGBgCiAgICAgICBDb25zaWRlciB0aGUgZm9sbG93aW5nIHRyYW5zaXRpb25zOgogICAgICAgMS4gQSBVUkwgdHJhbnNpdGlvbiB0byBgL3Bvc3RzLzFgLgogICAgICAgMS4gVHJpZ2dlcnMgdGhlIGAqbW9kZWxgIGNhbGxiYWNrcyBvbiB0aGUKICAgICAgICAgIGBpbmRleGAsIGBwb3N0c2AsIGFuZCBgc2hvd1Bvc3RgIHJvdXRlcwogICAgICAgMi4gVHJpZ2dlcnMgdGhlIGBlbnRlcmAgY2FsbGJhY2sgb24gdGhlIHNhbWUKICAgICAgIDMuIFRyaWdnZXJzIHRoZSBgc2V0dXBgIGNhbGxiYWNrIG9uIHRoZSBzYW1lCiAgICAyLiBBIGRpcmVjdCB0cmFuc2l0aW9uIHRvIGBuZXdQb3N0YAogICAgICAgMS4gVHJpZ2dlcnMgdGhlIGBleGl0YCBjYWxsYmFjayBvbiBgc2hvd1Bvc3RgCiAgICAgICAyLiBUcmlnZ2VycyB0aGUgYGVudGVyYCBjYWxsYmFjayBvbiBgbmV3UG9zdGAKICAgICAgIDMuIFRyaWdnZXJzIHRoZSBgc2V0dXBgIGNhbGxiYWNrIG9uIGBuZXdQb3N0YAogICAgMy4gQSBkaXJlY3QgdHJhbnNpdGlvbiB0byBgYWJvdXRgIHdpdGggYSBzcGVjaWZpZWQKICAgICAgIGNvbnRleHQgb2JqZWN0CiAgICAgICAxLiBUcmlnZ2VycyB0aGUgYGV4aXRgIGNhbGxiYWNrIG9uIGBuZXdQb3N0YAogICAgICAgICAgYW5kIGBwb3N0c2AKICAgICAgIDIuIFRyaWdnZXJzIHRoZSBgc2VyaWFsaXplYCBjYWxsYmFjayBvbiBgYWJvdXRgCiAgICAgICAzLiBUcmlnZ2VycyB0aGUgYGVudGVyYCBjYWxsYmFjayBvbiBgYWJvdXRgCiAgICAgICA0LiBUcmlnZ2VycyB0aGUgYHNldHVwYCBjYWxsYmFjayBvbiBgYWJvdXRgCiAgICAgICBAcGFyYW0ge1JvdXRlcn0gdHJhbnNpdGlvbgogICAgQHBhcmFtIHtUcmFuc2l0aW9uU3RhdGV9IG5ld1N0YXRlCiAgICAqLwogICAgOwoKICAgIF9wcm90bzkuc2V0dXBDb250ZXh0cyA9IGZ1bmN0aW9uIHNldHVwQ29udGV4dHMobmV3U3RhdGUsIHRyYW5zaXRpb24pIHsKICAgICAgdmFyIHBhcnRpdGlvbiA9IHRoaXMucGFydGl0aW9uUm91dGVzKHRoaXMuc3RhdGUsIG5ld1N0YXRlKTsKICAgICAgdmFyIGksIGwsIHJvdXRlOwoKICAgICAgZm9yIChpID0gMCwgbCA9IHBhcnRpdGlvbi5leGl0ZWQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgcm91dGUgPSBwYXJ0aXRpb24uZXhpdGVkW2ldLnJvdXRlOwogICAgICAgIGRlbGV0ZSByb3V0ZS5jb250ZXh0OwoKICAgICAgICBpZiAocm91dGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgaWYgKHJvdXRlLl9pbnRlcm5hbFJlc2V0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcm91dGUuX2ludGVybmFsUmVzZXQodHJ1ZSwgdHJhbnNpdGlvbik7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHJvdXRlLmV4aXQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByb3V0ZS5leGl0KHRyYW5zaXRpb24pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIG9sZFN0YXRlID0gdGhpcy5vbGRTdGF0ZSA9IHRoaXMuc3RhdGU7CiAgICAgIHRoaXMuc3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgdmFyIGN1cnJlbnRSb3V0ZUluZm9zID0gdGhpcy5jdXJyZW50Um91dGVJbmZvcyA9IHBhcnRpdGlvbi51bmNoYW5nZWQuc2xpY2UoKTsKCiAgICAgIHRyeSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHBhcnRpdGlvbi5yZXNldC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHJvdXRlID0gcGFydGl0aW9uLnJlc2V0W2ldLnJvdXRlOwoKICAgICAgICAgIGlmIChyb3V0ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGlmIChyb3V0ZS5faW50ZXJuYWxSZXNldCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgcm91dGUuX2ludGVybmFsUmVzZXQoZmFsc2UsIHRyYW5zaXRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3IgKGkgPSAwLCBsID0gcGFydGl0aW9uLnVwZGF0ZWRDb250ZXh0Lmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdGhpcy5yb3V0ZUVudGVyZWRPclVwZGF0ZWQoY3VycmVudFJvdXRlSW5mb3MsIHBhcnRpdGlvbi51cGRhdGVkQ29udGV4dFtpXSwgZmFsc2UsIHRyYW5zaXRpb24pOwogICAgICAgIH0KCiAgICAgICAgZm9yIChpID0gMCwgbCA9IHBhcnRpdGlvbi5lbnRlcmVkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdGhpcy5yb3V0ZUVudGVyZWRPclVwZGF0ZWQoY3VycmVudFJvdXRlSW5mb3MsIHBhcnRpdGlvbi5lbnRlcmVkW2ldLCB0cnVlLCB0cmFuc2l0aW9uKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB0aGlzLnN0YXRlID0gb2xkU3RhdGU7CiAgICAgICAgdGhpcy5jdXJyZW50Um91dGVJbmZvcyA9IG9sZFN0YXRlLnJvdXRlSW5mb3M7CiAgICAgICAgdGhyb3cgZTsKICAgICAgfQoKICAgICAgdGhpcy5zdGF0ZS5xdWVyeVBhcmFtcyA9IHRoaXMuZmluYWxpemVRdWVyeVBhcmFtQ2hhbmdlKGN1cnJlbnRSb3V0ZUluZm9zLCBuZXdTdGF0ZS5xdWVyeVBhcmFtcywgdHJhbnNpdGlvbik7CiAgICB9CiAgICAvKioKICAgIEBwcml2YXRlCiAgICAgICBGaXJlcyBxdWVyeVBhcmFtc0RpZENoYW5nZSBldmVudAogICAgKi8KICAgIDsKCiAgICBfcHJvdG85LmZpcmVRdWVyeVBhcmFtRGlkQ2hhbmdlID0gZnVuY3Rpb24gZmlyZVF1ZXJ5UGFyYW1EaWRDaGFuZ2UobmV3U3RhdGUsIHF1ZXJ5UGFyYW1DaGFuZ2VsaXN0KSB7CiAgICAgIC8vIElmIHF1ZXJ5UGFyYW1zIGNoYW5nZWQgdHJpZ2dlciBldmVudAogICAgICBpZiAocXVlcnlQYXJhbUNoYW5nZWxpc3QpIHsKICAgICAgICAvLyBUaGlzIGlzIGEgbGl0dGxlIGhhY2t5IGJ1dCB3ZSBuZWVkIHNvbWUgd2F5IG9mIHN0b3JpbmcKICAgICAgICAvLyBjaGFuZ2VkIHF1ZXJ5IHBhcmFtcyBnaXZlbiB0aGF0IG5vIGFjdGl2ZVRyYW5zaXRpb24KICAgICAgICAvLyBpcyBndWFyYW50ZWVkIHRvIGhhdmUgb2NjdXJyZWQuCiAgICAgICAgdGhpcy5fY2hhbmdlZFF1ZXJ5UGFyYW1zID0gcXVlcnlQYXJhbUNoYW5nZWxpc3QuYWxsOwogICAgICAgIHRoaXMudHJpZ2dlckV2ZW50KG5ld1N0YXRlLnJvdXRlSW5mb3MsIHRydWUsICdxdWVyeVBhcmFtc0RpZENoYW5nZScsIFtxdWVyeVBhcmFtQ2hhbmdlbGlzdC5jaGFuZ2VkLCBxdWVyeVBhcmFtQ2hhbmdlbGlzdC5hbGwsIHF1ZXJ5UGFyYW1DaGFuZ2VsaXN0LnJlbW92ZWRdKTsKICAgICAgICB0aGlzLl9jaGFuZ2VkUXVlcnlQYXJhbXMgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgQHByaXZhdGUKICAgICAgIEhlbHBlciBtZXRob2QgdXNlZCBieSBzZXR1cENvbnRleHRzLiBIYW5kbGVzIGVycm9ycyBvciByZWRpcmVjdHMKICAgIHRoYXQgbWF5IGhhcHBlbiBpbiBlbnRlci9zZXR1cC4KICAgICovCiAgICA7CgogICAgX3Byb3RvOS5yb3V0ZUVudGVyZWRPclVwZGF0ZWQgPSBmdW5jdGlvbiByb3V0ZUVudGVyZWRPclVwZGF0ZWQoY3VycmVudFJvdXRlSW5mb3MsIHJvdXRlSW5mbywgZW50ZXIsIHRyYW5zaXRpb24pIHsKICAgICAgdmFyIHJvdXRlID0gcm91dGVJbmZvLnJvdXRlLAogICAgICAgICAgY29udGV4dCA9IHJvdXRlSW5mby5jb250ZXh0OwoKICAgICAgZnVuY3Rpb24gX3JvdXRlRW50ZXJlZE9yVXBkYXRlZChyb3V0ZSkgewogICAgICAgIGlmIChlbnRlcikgewogICAgICAgICAgaWYgKHJvdXRlLmVudGVyICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcm91dGUuZW50ZXIodHJhbnNpdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAodHJhbnNpdGlvbiAmJiB0cmFuc2l0aW9uLmlzQWJvcnRlZCkgewogICAgICAgICAgdGhyb3cgbmV3IFRyYW5zaXRpb25BYm9ydGVkRXJyb3IoKTsKICAgICAgICB9CgogICAgICAgIHJvdXRlLmNvbnRleHQgPSBjb250ZXh0OwoKICAgICAgICBpZiAocm91dGUuY29udGV4dERpZENoYW5nZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByb3V0ZS5jb250ZXh0RGlkQ2hhbmdlKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAocm91dGUuc2V0dXAgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcm91dGUuc2V0dXAoY29udGV4dCwgdHJhbnNpdGlvbik7CiAgICAgICAgfQoKICAgICAgICBpZiAodHJhbnNpdGlvbiAmJiB0cmFuc2l0aW9uLmlzQWJvcnRlZCkgewogICAgICAgICAgdGhyb3cgbmV3IFRyYW5zaXRpb25BYm9ydGVkRXJyb3IoKTsKICAgICAgICB9CgogICAgICAgIGN1cnJlbnRSb3V0ZUluZm9zLnB1c2gocm91dGVJbmZvKTsKICAgICAgICByZXR1cm4gcm91dGU7CiAgICAgIH0gLy8gSWYgdGhlIHJvdXRlIGRvZXNuJ3QgZXhpc3QsIGl0IG1lYW5zIHdlIGhhdmVuJ3QgcmVzb2x2ZWQgdGhlIHJvdXRlIHByb21pc2UgeWV0CgoKICAgICAgaWYgKHJvdXRlID09PSB1bmRlZmluZWQpIHsKICAgICAgICByb3V0ZUluZm8ucm91dGVQcm9taXNlID0gcm91dGVJbmZvLnJvdXRlUHJvbWlzZS50aGVuKF9yb3V0ZUVudGVyZWRPclVwZGF0ZWQpOwogICAgICB9IGVsc2UgewogICAgICAgIF9yb3V0ZUVudGVyZWRPclVwZGF0ZWQocm91dGUpOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgQHByaXZhdGUKICAgICAgIFRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIHdoZW4gdHJhbnNpdGlvbmluZyBmcm9tIG9uZSBVUkwgdG8KICAgIGFub3RoZXIgdG8gZGV0ZXJtaW5lIHdoaWNoIHJvdXRlcyBhcmUgbm8gbG9uZ2VyIGFjdGl2ZSwKICAgIHdoaWNoIHJvdXRlcyBhcmUgbmV3bHkgYWN0aXZlLCBhbmQgd2hpY2ggcm91dGVzIHJlbWFpbgogICAgYWN0aXZlIGJ1dCBoYXZlIHRoZWlyIGNvbnRleHQgY2hhbmdlZC4KICAgICAgIFRha2UgYSBsaXN0IG9mIG9sZCByb3V0ZXMgYW5kIG5ldyByb3V0ZXMgYW5kIHBhcnRpdGlvbgogICAgdGhlbSBpbnRvIGZvdXIgYnVja2V0czoKICAgICAgICogdW5jaGFuZ2VkOiB0aGUgcm91dGUgd2FzIGFjdGl2ZSBpbiBib3RoIHRoZSBvbGQgYW5kCiAgICAgIG5ldyBVUkwsIGFuZCBpdHMgY29udGV4dCByZW1haW5zIHRoZSBzYW1lCiAgICAqIHVwZGF0ZWQgY29udGV4dDogdGhlIHJvdXRlIHdhcyBhY3RpdmUgaW4gYm90aCB0aGUKICAgICAgb2xkIGFuZCBuZXcgVVJMLCBidXQgaXRzIGNvbnRleHQgY2hhbmdlZC4gVGhlIHJvdXRlJ3MKICAgICAgYHNldHVwYCBtZXRob2QsIGlmIGFueSwgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgbmV3CiAgICAgIGNvbnRleHQuCiAgICAqIGV4aXRlZDogdGhlIHJvdXRlIHdhcyBhY3RpdmUgaW4gdGhlIG9sZCBVUkwsIGJ1dCBpcwogICAgICBubyBsb25nZXIgYWN0aXZlLgogICAgKiBlbnRlcmVkOiB0aGUgcm91dGUgd2FzIG5vdCBhY3RpdmUgaW4gdGhlIG9sZCBVUkwsIGJ1dAogICAgICBpcyBub3cgYWN0aXZlLgogICAgICAgVGhlIFBhcnRpdGlvbmVkUm91dGVzIHN0cnVjdHVyZSBoYXMgZm91ciBmaWVsZHM6CiAgICAgICAqIGB1cGRhdGVkQ29udGV4dGA6IGEgbGlzdCBvZiBgUm91dGVJbmZvYCBvYmplY3RzIHRoYXQKICAgICAgcmVwcmVzZW50IHJvdXRlcyB0aGF0IHJlbWFpbiBhY3RpdmUgYnV0IGhhdmUgYSBjaGFuZ2VkCiAgICAgIGNvbnRleHQKICAgICogYGVudGVyZWRgOiBhIGxpc3Qgb2YgYFJvdXRlSW5mb2Agb2JqZWN0cyB0aGF0IHJlcHJlc2VudAogICAgICByb3V0ZXMgdGhhdCBhcmUgbmV3bHkgYWN0aXZlCiAgICAqIGBleGl0ZWRgOiBhIGxpc3Qgb2YgYFJvdXRlSW5mb2Agb2JqZWN0cyB0aGF0IGFyZSBubwogICAgICBsb25nZXIgYWN0aXZlLgogICAgKiBgdW5jaGFuZ2VkYDogYSBsaXN0IG9mIGBSb3V0ZUluZm9gIG9iamVjdHMgdGhhdCByZW1haW4gYWN0aXZlLgogICAgICAgQHBhcmFtIHtBcnJheVtJbnRlcm5hbFJvdXRlSW5mb119IG9sZFJvdXRlcyBhIGxpc3Qgb2YgdGhlIHJvdXRlCiAgICAgIGluZm9ybWF0aW9uIGZvciB0aGUgcHJldmlvdXMgVVJMIChvciBgW11gIGlmIHRoaXMgaXMgdGhlCiAgICAgIGZpcnN0IGhhbmRsZWQgdHJhbnNpdGlvbikKICAgIEBwYXJhbSB7QXJyYXlbSW50ZXJuYWxSb3V0ZUluZm9dfSBuZXdSb3V0ZXMgYSBsaXN0IG9mIHRoZSByb3V0ZQogICAgICBpbmZvcm1hdGlvbiBmb3IgdGhlIG5ldyBVUkwKICAgICAgIEByZXR1cm4ge1BhcnRpdGlvbn0KICAgICovCiAgICA7CgogICAgX3Byb3RvOS5wYXJ0aXRpb25Sb3V0ZXMgPSBmdW5jdGlvbiBwYXJ0aXRpb25Sb3V0ZXMob2xkU3RhdGUsIG5ld1N0YXRlKSB7CiAgICAgIHZhciBvbGRSb3V0ZUluZm9zID0gb2xkU3RhdGUucm91dGVJbmZvczsKICAgICAgdmFyIG5ld1JvdXRlSW5mb3MgPSBuZXdTdGF0ZS5yb3V0ZUluZm9zOwogICAgICB2YXIgcm91dGVzID0gewogICAgICAgIHVwZGF0ZWRDb250ZXh0OiBbXSwKICAgICAgICBleGl0ZWQ6IFtdLAogICAgICAgIGVudGVyZWQ6IFtdLAogICAgICAgIHVuY2hhbmdlZDogW10sCiAgICAgICAgcmVzZXQ6IFtdCiAgICAgIH07CiAgICAgIHZhciByb3V0ZUNoYW5nZWQsCiAgICAgICAgICBjb250ZXh0Q2hhbmdlZCA9IGZhbHNlLAogICAgICAgICAgaSwKICAgICAgICAgIGw7CgogICAgICBmb3IgKGkgPSAwLCBsID0gbmV3Um91dGVJbmZvcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB2YXIgb2xkUm91dGVJbmZvID0gb2xkUm91dGVJbmZvc1tpXSwKICAgICAgICAgICAgbmV3Um91dGVJbmZvID0gbmV3Um91dGVJbmZvc1tpXTsKCiAgICAgICAgaWYgKCFvbGRSb3V0ZUluZm8gfHwgb2xkUm91dGVJbmZvLnJvdXRlICE9PSBuZXdSb3V0ZUluZm8ucm91dGUpIHsKICAgICAgICAgIHJvdXRlQ2hhbmdlZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAocm91dGVDaGFuZ2VkKSB7CiAgICAgICAgICByb3V0ZXMuZW50ZXJlZC5wdXNoKG5ld1JvdXRlSW5mbyk7CgogICAgICAgICAgaWYgKG9sZFJvdXRlSW5mbykgewogICAgICAgICAgICByb3V0ZXMuZXhpdGVkLnVuc2hpZnQob2xkUm91dGVJbmZvKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHRDaGFuZ2VkIHx8IG9sZFJvdXRlSW5mby5jb250ZXh0ICE9PSBuZXdSb3V0ZUluZm8uY29udGV4dCkgewogICAgICAgICAgY29udGV4dENoYW5nZWQgPSB0cnVlOwogICAgICAgICAgcm91dGVzLnVwZGF0ZWRDb250ZXh0LnB1c2gobmV3Um91dGVJbmZvKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcm91dGVzLnVuY2hhbmdlZC5wdXNoKG9sZFJvdXRlSW5mbyk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKGkgPSBuZXdSb3V0ZUluZm9zLmxlbmd0aCwgbCA9IG9sZFJvdXRlSW5mb3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgcm91dGVzLmV4aXRlZC51bnNoaWZ0KG9sZFJvdXRlSW5mb3NbaV0pOwogICAgICB9CgogICAgICByb3V0ZXMucmVzZXQgPSByb3V0ZXMudXBkYXRlZENvbnRleHQuc2xpY2UoKTsKICAgICAgcm91dGVzLnJlc2V0LnJldmVyc2UoKTsKICAgICAgcmV0dXJuIHJvdXRlczsKICAgIH07CgogICAgX3Byb3RvOS5fdXBkYXRlVVJMID0gZnVuY3Rpb24gX3VwZGF0ZVVSTCh0cmFuc2l0aW9uLCBzdGF0ZSkgewogICAgICB2YXIgdXJsTWV0aG9kID0gdHJhbnNpdGlvbi51cmxNZXRob2Q7CgogICAgICBpZiAoIXVybE1ldGhvZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHJvdXRlSW5mb3MgPSBzdGF0ZS5yb3V0ZUluZm9zOwogICAgICB2YXIgcm91dGVOYW1lID0gcm91dGVJbmZvc1tyb3V0ZUluZm9zLmxlbmd0aCAtIDFdLm5hbWU7CiAgICAgIHZhciBwYXJhbXMgPSB7fTsKCiAgICAgIGZvciAodmFyIGkgPSByb3V0ZUluZm9zLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgdmFyIHJvdXRlSW5mbyA9IHJvdXRlSW5mb3NbaV07CiAgICAgICAgbWVyZ2UocGFyYW1zLCByb3V0ZUluZm8ucGFyYW1zKTsKCiAgICAgICAgaWYgKHJvdXRlSW5mby5yb3V0ZS5pbmFjY2Vzc2libGVCeVVSTCkgewogICAgICAgICAgdXJsTWV0aG9kID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh1cmxNZXRob2QpIHsKICAgICAgICBwYXJhbXMucXVlcnlQYXJhbXMgPSB0cmFuc2l0aW9uLl92aXNpYmxlUXVlcnlQYXJhbXMgfHwgc3RhdGUucXVlcnlQYXJhbXM7CiAgICAgICAgdmFyIHVybCA9IHRoaXMucmVjb2duaXplci5nZW5lcmF0ZShyb3V0ZU5hbWUsIHBhcmFtcyk7IC8vIHRyYW5zaXRpb25zIGR1cmluZyB0aGUgaW5pdGlhbCB0cmFuc2l0aW9uIG11c3QgYWx3YXlzIHVzZSByZXBsYWNlVVJMLgogICAgICAgIC8vIFdoZW4gdGhlIGFwcCBib290cywgeW91IGFyZSBhdCBhIHVybCwgZS5nLiAvZm9vLiBJZiBzb21lIHJvdXRlCiAgICAgICAgLy8gcmVkaXJlY3RzIHRvIGJhciBhcyBwYXJ0IG9mIHRoZSBpbml0aWFsIHRyYW5zaXRpb24sIHlvdSBkb24ndCB3YW50IHRvCiAgICAgICAgLy8gYWRkIGEgaGlzdG9yeSBlbnRyeSBmb3IgL2Zvby4gSWYgeW91IGRvLCBwcmVzc2luZyBiYWNrIHdpbGwgaW1tZWRpYXRlbHkKICAgICAgICAvLyBoaXQgdGhlIHJlZGlyZWN0IGFnYWluIGFuZCB0YWtlIHlvdSBiYWNrIHRvIC9iYXIsIHRodXMga2lsbGluZyB0aGUgYmFjawogICAgICAgIC8vIGJ1dHRvbgoKICAgICAgICB2YXIgaW5pdGlhbCA9IHRyYW5zaXRpb24uaXNDYXVzZWRCeUluaXRpYWxUcmFuc2l0aW9uOyAvLyBzYXkgeW91IGFyZSBhdCAvIGFuZCB5b3UgY2xpY2sgYSBsaW5rIHRvIHJvdXRlIC9mb28uIEluIC9mb28ncwogICAgICAgIC8vIHJvdXRlLCB0aGUgdHJhbnNpdGlvbiBpcyBhYm9ydGVkIHVzaW5nIHJlcGxhY2V3aXRoKCcvYmFyJykuCiAgICAgICAgLy8gQmVjYXVzZSB0aGUgY3VycmVudCB1cmwgaXMgc3RpbGwgLywgdGhlIGhpc3RvcnkgZW50cnkgZm9yIC8gaXMKICAgICAgICAvLyByZW1vdmVkIGZyb20gdGhlIGhpc3RvcnkuIENsaWNraW5nIGJhY2sgd2lsbCB0YWtlIHlvdSB0byB0aGUgcGFnZQogICAgICAgIC8vIHlvdSB3ZXJlIG9uIGJlZm9yZSAvLCB3aGljaCBpcyBvZnRlbiBub3QgZXZlbiB0aGUgYXBwLCB0aHVzIGtpbGxpbmcKICAgICAgICAvLyB0aGUgYmFjayBidXR0b24uIFRoYXQncyB3aHkgdXBkYXRlVVJMIGlzIGFsd2F5cyBjb3JyZWN0IGZvciBhbgogICAgICAgIC8vIGFib3J0aW5nIHRyYW5zaXRpb24gdGhhdCdzIG5vdCB0aGUgaW5pdGlhbCB0cmFuc2l0aW9uCgogICAgICAgIHZhciByZXBsYWNlQW5kTm90QWJvcnRpbmcgPSB1cmxNZXRob2QgPT09ICdyZXBsYWNlJyAmJiAhdHJhbnNpdGlvbi5pc0NhdXNlZEJ5QWJvcnRpbmdUcmFuc2l0aW9uOyAvLyBiZWNhdXNlIGNhbGxpbmcgcmVmcmVzaCBjYXVzZXMgYW4gYWJvcnRlZCB0cmFuc2l0aW9uLCB0aGlzIG5lZWRzIHRvIGJlCiAgICAgICAgLy8gc3BlY2lhbCBjYXNlZCAtIGlmIHRoZSBpbml0aWFsIHRyYW5zaXRpb24gaXMgYSByZXBsYWNlIHRyYW5zaXRpb24sIHRoZQogICAgICAgIC8vIHVybE1ldGhvZCBzaG91bGQgYmUgaG9ub3JlZCBoZXJlLgoKICAgICAgICB2YXIgaXNRdWVyeVBhcmFtc1JlZnJlc2hUcmFuc2l0aW9uID0gdHJhbnNpdGlvbi5xdWVyeVBhcmFtc09ubHkgJiYgdXJsTWV0aG9kID09PSAncmVwbGFjZSc7IC8vIHNheSB5b3UgYXJlIGF0IC8gYW5kIHlvdSBhIGByZXBsYWNlV2l0aCgvZm9vKWAgaXMgY2FsbGVkLiBUaGVuLCB0aGF0CiAgICAgICAgLy8gdHJhbnNpdGlvbiBpcyBhYm9ydGVkIHdpdGggYHJlcGxhY2VXaXRoKC9iYXIpYC4gQXQgdGhlIGVuZCwgd2Ugc2hvdWxkCiAgICAgICAgLy8gZW5kIHVwIHdpdGggL2JhciByZXBsYWNpbmcgLy4gV2UgYXJlIHJlcGxhY2luZyB0aGUgcmVwbGFjZS4gV2Ugb25seQogICAgICAgIC8vIHdpbGwgcmVwbGFjZSB0aGUgaW5pdGlhbCByb3V0ZSBpZiBhbGwgc3Vic2VxdWVudCBhYm9ydHMgYXJlIGFsc28KICAgICAgICAvLyByZXBsYWNlcy4gSG93ZXZlciwgdGhlcmUgaXMgc29tZSBhbWJpZ3VpdHkgYXJvdW5kIHRoZSBjb3JyZWN0IGJlaGF2aW9yCiAgICAgICAgLy8gaGVyZS4KCiAgICAgICAgdmFyIHJlcGxhY2luZ1JlcGxhY2UgPSB1cmxNZXRob2QgPT09ICdyZXBsYWNlJyAmJiB0cmFuc2l0aW9uLmlzQ2F1c2VkQnlBYm9ydGluZ1JlcGxhY2VUcmFuc2l0aW9uOwoKICAgICAgICBpZiAoaW5pdGlhbCB8fCByZXBsYWNlQW5kTm90QWJvcnRpbmcgfHwgaXNRdWVyeVBhcmFtc1JlZnJlc2hUcmFuc2l0aW9uIHx8IHJlcGxhY2luZ1JlcGxhY2UpIHsKICAgICAgICAgIHRoaXMucmVwbGFjZVVSTCh1cmwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnVwZGF0ZVVSTCh1cmwpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG85LmZpbmFsaXplUXVlcnlQYXJhbUNoYW5nZSA9IGZ1bmN0aW9uIGZpbmFsaXplUXVlcnlQYXJhbUNoYW5nZShyZXNvbHZlZEhhbmRsZXJzLCBuZXdRdWVyeVBhcmFtcywgdHJhbnNpdGlvbikgewogICAgICAvLyBXZSBmaXJlIGEgZmluYWxpemVRdWVyeVBhcmFtQ2hhbmdlIGV2ZW50IHdoaWNoCiAgICAgIC8vIGdpdmVzIHRoZSBuZXcgcm91dGUgaGllcmFyY2h5IGEgY2hhbmNlIHRvIHRlbGwKICAgICAgLy8gdXMgd2hpY2ggcXVlcnkgcGFyYW1zIGl0J3MgY29uc3VtaW5nIGFuZCB3aGF0CiAgICAgIC8vIHRoZWlyIGZpbmFsIHZhbHVlcyBhcmUuIElmIGEgcXVlcnkgcGFyYW0gaXMKICAgICAgLy8gbm8gbG9uZ2VyIGNvbnN1bWVkIGluIHRoZSBmaW5hbCByb3V0ZSBoaWVyYXJjaHksCiAgICAgIC8vIGl0cyBzZXJpYWxpemVkIHNlZ21lbnQgd2lsbCBiZSByZW1vdmVkCiAgICAgIC8vIGZyb20gdGhlIFVSTC4KICAgICAgZm9yICh2YXIgayBpbiBuZXdRdWVyeVBhcmFtcykgewogICAgICAgIGlmIChuZXdRdWVyeVBhcmFtcy5oYXNPd25Qcm9wZXJ0eShrKSAmJiBuZXdRdWVyeVBhcmFtc1trXSA9PT0gbnVsbCkgewogICAgICAgICAgZGVsZXRlIG5ld1F1ZXJ5UGFyYW1zW2tdOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIGZpbmFsUXVlcnlQYXJhbXNBcnJheSA9IFtdOwogICAgICB0aGlzLnRyaWdnZXJFdmVudChyZXNvbHZlZEhhbmRsZXJzLCB0cnVlLCAnZmluYWxpemVRdWVyeVBhcmFtQ2hhbmdlJywgW25ld1F1ZXJ5UGFyYW1zLCBmaW5hbFF1ZXJ5UGFyYW1zQXJyYXksIHRyYW5zaXRpb25dKTsKCiAgICAgIGlmICh0cmFuc2l0aW9uKSB7CiAgICAgICAgdHJhbnNpdGlvbi5fdmlzaWJsZVF1ZXJ5UGFyYW1zID0ge307CiAgICAgIH0KCiAgICAgIHZhciBmaW5hbFF1ZXJ5UGFyYW1zID0ge307CgogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gZmluYWxRdWVyeVBhcmFtc0FycmF5Lmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgdmFyIHFwID0gZmluYWxRdWVyeVBhcmFtc0FycmF5W2ldOwogICAgICAgIGZpbmFsUXVlcnlQYXJhbXNbcXAua2V5XSA9IHFwLnZhbHVlOwoKICAgICAgICBpZiAodHJhbnNpdGlvbiAmJiBxcC52aXNpYmxlICE9PSBmYWxzZSkgewogICAgICAgICAgdHJhbnNpdGlvbi5fdmlzaWJsZVF1ZXJ5UGFyYW1zW3FwLmtleV0gPSBxcC52YWx1ZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBmaW5hbFF1ZXJ5UGFyYW1zOwogICAgfTsKCiAgICBfcHJvdG85LnRvUmVhZE9ubHlJbmZvcyA9IGZ1bmN0aW9uIHRvUmVhZE9ubHlJbmZvcyhuZXdUcmFuc2l0aW9uLCBuZXdTdGF0ZSkgewogICAgICB2YXIgb2xkUm91dGVJbmZvcyA9IHRoaXMuc3RhdGUucm91dGVJbmZvczsKICAgICAgdGhpcy5mcm9tSW5mb3MobmV3VHJhbnNpdGlvbiwgb2xkUm91dGVJbmZvcyk7CiAgICAgIHRoaXMudG9JbmZvcyhuZXdUcmFuc2l0aW9uLCBuZXdTdGF0ZS5yb3V0ZUluZm9zKTsKICAgICAgdGhpcy5fbGFzdFF1ZXJ5UGFyYW1zID0gbmV3U3RhdGUucXVlcnlQYXJhbXM7CiAgICB9OwoKICAgIF9wcm90bzkuZnJvbUluZm9zID0gZnVuY3Rpb24gZnJvbUluZm9zKG5ld1RyYW5zaXRpb24sIG9sZFJvdXRlSW5mb3MpIHsKICAgICAgaWYgKG5ld1RyYW5zaXRpb24gIT09IHVuZGVmaW5lZCAmJiBvbGRSb3V0ZUluZm9zLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgZnJvbUluZm9zID0gdG9SZWFkT25seVJvdXRlSW5mbyhvbGRSb3V0ZUluZm9zLCAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCB0aGlzLl9sYXN0UXVlcnlQYXJhbXMpLCB0cnVlKTsKICAgICAgICBuZXdUcmFuc2l0aW9uLmZyb20gPSBmcm9tSW5mb3NbZnJvbUluZm9zLmxlbmd0aCAtIDFdIHx8IG51bGw7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvOS50b0luZm9zID0gZnVuY3Rpb24gdG9JbmZvcyhuZXdUcmFuc2l0aW9uLCBuZXdSb3V0ZUluZm9zLCBpbmNsdWRlQXR0cmlidXRlcykgewogICAgICBpZiAoaW5jbHVkZUF0dHJpYnV0ZXMgPT09IHZvaWQgMCkgewogICAgICAgIGluY2x1ZGVBdHRyaWJ1dGVzID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmIChuZXdUcmFuc2l0aW9uICE9PSB1bmRlZmluZWQgJiYgbmV3Um91dGVJbmZvcy5sZW5ndGggPiAwKSB7CiAgICAgICAgdmFyIHRvSW5mb3MgPSB0b1JlYWRPbmx5Um91dGVJbmZvKG5ld1JvdXRlSW5mb3MsICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIG5ld1RyYW5zaXRpb25bUVVFUllfUEFSQU1TX1NZTUJPTF0pLCBpbmNsdWRlQXR0cmlidXRlcyk7CiAgICAgICAgbmV3VHJhbnNpdGlvbi50byA9IHRvSW5mb3NbdG9JbmZvcy5sZW5ndGggLSAxXSB8fCBudWxsOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90bzkubm90aWZ5RXhpc3RpbmdIYW5kbGVycyA9IGZ1bmN0aW9uIG5vdGlmeUV4aXN0aW5nSGFuZGxlcnMobmV3U3RhdGUsIG5ld1RyYW5zaXRpb24pIHsKICAgICAgdmFyIG9sZFJvdXRlSW5mb3MgPSB0aGlzLnN0YXRlLnJvdXRlSW5mb3MsCiAgICAgICAgICBpLAogICAgICAgICAgb2xkUm91dGVJbmZvTGVuLAogICAgICAgICAgb2xkSGFuZGxlciwKICAgICAgICAgIG5ld1JvdXRlSW5mbzsKICAgICAgb2xkUm91dGVJbmZvTGVuID0gb2xkUm91dGVJbmZvcy5sZW5ndGg7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgb2xkUm91dGVJbmZvTGVuOyBpKyspIHsKICAgICAgICBvbGRIYW5kbGVyID0gb2xkUm91dGVJbmZvc1tpXTsKICAgICAgICBuZXdSb3V0ZUluZm8gPSBuZXdTdGF0ZS5yb3V0ZUluZm9zW2ldOwoKICAgICAgICBpZiAoIW5ld1JvdXRlSW5mbyB8fCBvbGRIYW5kbGVyLm5hbWUgIT09IG5ld1JvdXRlSW5mby5uYW1lKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIGlmICghbmV3Um91dGVJbmZvLmlzUmVzb2x2ZWQpIHt9CiAgICAgIH0KCiAgICAgIHRoaXMudHJpZ2dlckV2ZW50KG9sZFJvdXRlSW5mb3MsIHRydWUsICd3aWxsVHJhbnNpdGlvbicsIFtuZXdUcmFuc2l0aW9uXSk7CiAgICAgIHRoaXMucm91dGVXaWxsQ2hhbmdlKG5ld1RyYW5zaXRpb24pOwogICAgICB0aGlzLndpbGxUcmFuc2l0aW9uKG9sZFJvdXRlSW5mb3MsIG5ld1N0YXRlLnJvdXRlSW5mb3MsIG5ld1RyYW5zaXRpb24pOwogICAgfQogICAgLyoqCiAgICAgIENsZWFycyB0aGUgY3VycmVudCBhbmQgdGFyZ2V0IHJvdXRlIHJvdXRlcyBhbmQgdHJpZ2dlcnMgZXhpdAogICAgICBvbiBlYWNoIG9mIHRoZW0gc3RhcnRpbmcgYXQgdGhlIGxlYWYgYW5kIHRyYXZlcnNpbmcgdXAgdGhyb3VnaAogICAgICBpdHMgYW5jZXN0b3JzLgogICAgKi8KICAgIDsKCiAgICBfcHJvdG85LnJlc2V0ID0gZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgIGlmICh0aGlzLnN0YXRlKSB7CiAgICAgICAgZm9yRWFjaCh0aGlzLnN0YXRlLnJvdXRlSW5mb3Muc2xpY2UoKS5yZXZlcnNlKCksIGZ1bmN0aW9uIChyb3V0ZUluZm8pIHsKICAgICAgICAgIHZhciByb3V0ZSA9IHJvdXRlSW5mby5yb3V0ZTsKCiAgICAgICAgICBpZiAocm91dGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBpZiAocm91dGUuZXhpdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgcm91dGUuZXhpdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHRoaXMub2xkU3RhdGUgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuc3RhdGUgPSBuZXcgVHJhbnNpdGlvblN0YXRlKCk7CiAgICAgIHRoaXMuY3VycmVudFJvdXRlSW5mb3MgPSB1bmRlZmluZWQ7CiAgICB9CiAgICAvKioKICAgICAgbGV0IGhhbmRsZXIgPSByb3V0ZUluZm8uaGFuZGxlcjsKICAgICAgVGhlIGVudHJ5IHBvaW50IGZvciBoYW5kbGluZyBhIGNoYW5nZSB0byB0aGUgVVJMICh1c3VhbGx5CiAgICAgIHZpYSB0aGUgYmFjayBhbmQgZm9yd2FyZCBidXR0b24pLgogICAgICAgICBSZXR1cm5zIGFuIEFycmF5IG9mIGhhbmRsZXJzIGFuZCB0aGUgcGFyYW1ldGVycyBhc3NvY2lhdGVkCiAgICAgIHdpdGggdGhvc2UgcGFyYW1ldGVycy4KICAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBhIFVSTCB0byBwcm9jZXNzCiAgICAgICAgIEByZXR1cm4ge0FycmF5fSBhbiBBcnJheSBvZiBgW2hhbmRsZXIsIHBhcmFtZXRlcl1gIHR1cGxlcwogICAgKi8KICAgIDsKCiAgICBfcHJvdG85LmhhbmRsZVVSTCA9IGZ1bmN0aW9uIGhhbmRsZVVSTCh1cmwpIHsKICAgICAgLy8gUGVyZm9ybSBhIFVSTC1iYXNlZCB0cmFuc2l0aW9uLCBidXQgZG9uJ3QgY2hhbmdlCiAgICAgIC8vIHRoZSBVUkwgYWZ0ZXJ3YXJkLCBzaW5jZSBpdCBhbHJlYWR5IGhhcHBlbmVkLgogICAgICBpZiAodXJsLmNoYXJBdCgwKSAhPT0gJy8nKSB7CiAgICAgICAgdXJsID0gJy8nICsgdXJsOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5kb1RyYW5zaXRpb24odXJsKS5tZXRob2QobnVsbCk7CiAgICB9CiAgICAvKioKICAgICAgVHJhbnNpdGlvbiBpbnRvIHRoZSBzcGVjaWZpZWQgbmFtZWQgcm91dGUuCiAgICAgICAgIElmIG5lY2Vzc2FyeSwgdHJpZ2dlciB0aGUgZXhpdCBjYWxsYmFjayBvbiBhbnkgcm91dGVzCiAgICAgIHRoYXQgYXJlIG5vIGxvbmdlciByZXByZXNlbnRlZCBieSB0aGUgdGFyZ2V0IHJvdXRlLgogICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgcm91dGUKICAgICovCiAgICA7CgogICAgX3Byb3RvOS50cmFuc2l0aW9uVG8gPSBmdW5jdGlvbiB0cmFuc2l0aW9uVG8obmFtZSkgewogICAgICBmb3IgKHZhciBfbGVuMyA9IGFyZ3VtZW50cy5sZW5ndGgsIGNvbnRleHRzID0gbmV3IEFycmF5KF9sZW4zID4gMSA/IF9sZW4zIC0gMSA6IDApLCBfa2V5MyA9IDE7IF9rZXkzIDwgX2xlbjM7IF9rZXkzKyspIHsKICAgICAgICBjb250ZXh0c1tfa2V5MyAtIDFdID0gYXJndW1lbnRzW19rZXkzXTsKICAgICAgfQoKICAgICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewogICAgICAgIGNvbnRleHRzLnB1c2gobmFtZSk7CiAgICAgICAgcmV0dXJuIHRoaXMuZG9UcmFuc2l0aW9uKHVuZGVmaW5lZCwgY29udGV4dHMsIGZhbHNlKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuZG9UcmFuc2l0aW9uKG5hbWUsIGNvbnRleHRzKTsKICAgIH07CgogICAgX3Byb3RvOS5pbnRlcm1lZGlhdGVUcmFuc2l0aW9uVG8gPSBmdW5jdGlvbiBpbnRlcm1lZGlhdGVUcmFuc2l0aW9uVG8obmFtZSkgewogICAgICBmb3IgKHZhciBfbGVuNCA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjQgPiAxID8gX2xlbjQgLSAxIDogMCksIF9rZXk0ID0gMTsgX2tleTQgPCBfbGVuNDsgX2tleTQrKykgewogICAgICAgIGFyZ3NbX2tleTQgLSAxXSA9IGFyZ3VtZW50c1tfa2V5NF07CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLmRvVHJhbnNpdGlvbihuYW1lLCBhcmdzLCB0cnVlKTsKICAgIH07CgogICAgX3Byb3RvOS5yZWZyZXNoID0gZnVuY3Rpb24gcmVmcmVzaChwaXZvdFJvdXRlKSB7CiAgICAgIHZhciBwcmV2aW91c1RyYW5zaXRpb24gPSB0aGlzLmFjdGl2ZVRyYW5zaXRpb247CiAgICAgIHZhciBzdGF0ZSA9IHByZXZpb3VzVHJhbnNpdGlvbiA/IHByZXZpb3VzVHJhbnNpdGlvbltTVEFURV9TWU1CT0xdIDogdGhpcy5zdGF0ZTsKICAgICAgdmFyIHJvdXRlSW5mb3MgPSBzdGF0ZS5yb3V0ZUluZm9zOwoKICAgICAgaWYgKHBpdm90Um91dGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHBpdm90Um91dGUgPSByb3V0ZUluZm9zWzBdLnJvdXRlOwogICAgICB9CgogICAgICBfbG9nKHRoaXMsICdTdGFydGluZyBhIHJlZnJlc2ggdHJhbnNpdGlvbicpOwoKICAgICAgdmFyIG5hbWUgPSByb3V0ZUluZm9zW3JvdXRlSW5mb3MubGVuZ3RoIC0gMV0ubmFtZTsKICAgICAgdmFyIGludGVudCA9IG5ldyBOYW1lZFRyYW5zaXRpb25JbnRlbnQodGhpcywgbmFtZSwgcGl2b3RSb3V0ZSwgW10sIHRoaXMuX2NoYW5nZWRRdWVyeVBhcmFtcyB8fCBzdGF0ZS5xdWVyeVBhcmFtcyk7CiAgICAgIHZhciBuZXdUcmFuc2l0aW9uID0gdGhpcy50cmFuc2l0aW9uQnlJbnRlbnQoaW50ZW50LCBmYWxzZSk7IC8vIGlmIHRoZSBwcmV2aW91cyB0cmFuc2l0aW9uIGlzIGEgcmVwbGFjZSB0cmFuc2l0aW9uLCB0aGF0IG5lZWRzIHRvIGJlIHByZXNlcnZlZAoKICAgICAgaWYgKHByZXZpb3VzVHJhbnNpdGlvbiAmJiBwcmV2aW91c1RyYW5zaXRpb24udXJsTWV0aG9kID09PSAncmVwbGFjZScpIHsKICAgICAgICBuZXdUcmFuc2l0aW9uLm1ldGhvZChwcmV2aW91c1RyYW5zaXRpb24udXJsTWV0aG9kKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG5ld1RyYW5zaXRpb247CiAgICB9CiAgICAvKioKICAgICAgSWRlbnRpY2FsIHRvIGB0cmFuc2l0aW9uVG9gIGV4Y2VwdCB0aGF0IHRoZSBjdXJyZW50IFVSTCB3aWxsIGJlIHJlcGxhY2VkCiAgICAgIGlmIHBvc3NpYmxlLgogICAgICAgICBUaGlzIG1ldGhvZCBpcyBpbnRlbmRlZCBwcmltYXJpbHkgZm9yIHVzZSB3aXRoIGByZXBsYWNlU3RhdGVgLgogICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgcm91dGUKICAgICovCiAgICA7CgogICAgX3Byb3RvOS5yZXBsYWNlV2l0aCA9IGZ1bmN0aW9uIHJlcGxhY2VXaXRoKG5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuZG9UcmFuc2l0aW9uKG5hbWUpLm1ldGhvZCgncmVwbGFjZScpOwogICAgfQogICAgLyoqCiAgICAgIFRha2UgYSBuYW1lZCByb3V0ZSBhbmQgY29udGV4dCBvYmplY3RzIGFuZCBnZW5lcmF0ZSBhCiAgICAgIFVSTC4KICAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIG5hbWUgb2YgdGhlIHJvdXRlIHRvIGdlbmVyYXRlCiAgICAgICAgYSBVUkwgZm9yCiAgICAgIEBwYXJhbSB7Li4uT2JqZWN0fSBvYmplY3RzIGEgbGlzdCBvZiBvYmplY3RzIHRvIHNlcmlhbGl6ZQogICAgICAgICBAcmV0dXJuIHtTdHJpbmd9IGEgVVJMCiAgICAqLwogICAgOwoKICAgIF9wcm90bzkuZ2VuZXJhdGUgPSBmdW5jdGlvbiBnZW5lcmF0ZShyb3V0ZU5hbWUpIHsKICAgICAgZm9yICh2YXIgX2xlbjUgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW41ID4gMSA/IF9sZW41IC0gMSA6IDApLCBfa2V5NSA9IDE7IF9rZXk1IDwgX2xlbjU7IF9rZXk1KyspIHsKICAgICAgICBhcmdzW19rZXk1IC0gMV0gPSBhcmd1bWVudHNbX2tleTVdOwogICAgICB9CgogICAgICB2YXIgcGFydGl0aW9uZWRBcmdzID0gZXh0cmFjdFF1ZXJ5UGFyYW1zKGFyZ3MpLAogICAgICAgICAgc3VwcGxpZWRQYXJhbXMgPSBwYXJ0aXRpb25lZEFyZ3NbMF0sCiAgICAgICAgICBxdWVyeVBhcmFtcyA9IHBhcnRpdGlvbmVkQXJnc1sxXTsgLy8gQ29uc3RydWN0IGEgVHJhbnNpdGlvbkludGVudCB3aXRoIHRoZSBwcm92aWRlZCBwYXJhbXMKICAgICAgLy8gYW5kIGFwcGx5IGl0IHRvIHRoZSBwcmVzZW50IHN0YXRlIG9mIHRoZSByb3V0ZXIuCgogICAgICB2YXIgaW50ZW50ID0gbmV3IE5hbWVkVHJhbnNpdGlvbkludGVudCh0aGlzLCByb3V0ZU5hbWUsIHVuZGVmaW5lZCwgc3VwcGxpZWRQYXJhbXMpOwogICAgICB2YXIgc3RhdGUgPSBpbnRlbnQuYXBwbHlUb1N0YXRlKHRoaXMuc3RhdGUsIGZhbHNlKTsKICAgICAgdmFyIHBhcmFtcyA9IHt9OwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHN0YXRlLnJvdXRlSW5mb3MubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICB2YXIgcm91dGVJbmZvID0gc3RhdGUucm91dGVJbmZvc1tpXTsKICAgICAgICB2YXIgcm91dGVQYXJhbXMgPSByb3V0ZUluZm8uc2VyaWFsaXplKCk7CiAgICAgICAgbWVyZ2UocGFyYW1zLCByb3V0ZVBhcmFtcyk7CiAgICAgIH0KCiAgICAgIHBhcmFtcy5xdWVyeVBhcmFtcyA9IHF1ZXJ5UGFyYW1zOwogICAgICByZXR1cm4gdGhpcy5yZWNvZ25pemVyLmdlbmVyYXRlKHJvdXRlTmFtZSwgcGFyYW1zKTsKICAgIH07CgogICAgX3Byb3RvOS5hcHBseUludGVudCA9IGZ1bmN0aW9uIGFwcGx5SW50ZW50KHJvdXRlTmFtZSwgY29udGV4dHMpIHsKICAgICAgdmFyIGludGVudCA9IG5ldyBOYW1lZFRyYW5zaXRpb25JbnRlbnQodGhpcywgcm91dGVOYW1lLCB1bmRlZmluZWQsIGNvbnRleHRzKTsKICAgICAgdmFyIHN0YXRlID0gdGhpcy5hY3RpdmVUcmFuc2l0aW9uICYmIHRoaXMuYWN0aXZlVHJhbnNpdGlvbltTVEFURV9TWU1CT0xdIHx8IHRoaXMuc3RhdGU7CiAgICAgIHJldHVybiBpbnRlbnQuYXBwbHlUb1N0YXRlKHN0YXRlLCBmYWxzZSk7CiAgICB9OwoKICAgIF9wcm90bzkuaXNBY3RpdmVJbnRlbnQgPSBmdW5jdGlvbiBpc0FjdGl2ZUludGVudChyb3V0ZU5hbWUsIGNvbnRleHRzLCBxdWVyeVBhcmFtcywgX3N0YXRlKSB7CiAgICAgIHZhciBzdGF0ZSA9IF9zdGF0ZSB8fCB0aGlzLnN0YXRlLAogICAgICAgICAgdGFyZ2V0Um91dGVJbmZvcyA9IHN0YXRlLnJvdXRlSW5mb3MsCiAgICAgICAgICByb3V0ZUluZm8sCiAgICAgICAgICBsZW47CgogICAgICBpZiAoIXRhcmdldFJvdXRlSW5mb3MubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB2YXIgdGFyZ2V0SGFuZGxlciA9IHRhcmdldFJvdXRlSW5mb3NbdGFyZ2V0Um91dGVJbmZvcy5sZW5ndGggLSAxXS5uYW1lOwogICAgICB2YXIgcmVjb2dIYW5kbGVycyA9IHRoaXMucmVjb2duaXplci5oYW5kbGVyc0Zvcih0YXJnZXRIYW5kbGVyKTsKICAgICAgdmFyIGluZGV4ID0gMDsKCiAgICAgIGZvciAobGVuID0gcmVjb2dIYW5kbGVycy5sZW5ndGg7IGluZGV4IDwgbGVuOyArK2luZGV4KSB7CiAgICAgICAgcm91dGVJbmZvID0gdGFyZ2V0Um91dGVJbmZvc1tpbmRleF07CgogICAgICAgIGlmIChyb3V0ZUluZm8ubmFtZSA9PT0gcm91dGVOYW1lKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChpbmRleCA9PT0gcmVjb2dIYW5kbGVycy5sZW5ndGgpIHsKICAgICAgICAvLyBUaGUgcHJvdmlkZWQgcm91dGUgbmFtZSBpc24ndCBldmVuIGluIHRoZSByb3V0ZSBoaWVyYXJjaHkuCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB2YXIgdGVzdFN0YXRlID0gbmV3IFRyYW5zaXRpb25TdGF0ZSgpOwogICAgICB0ZXN0U3RhdGUucm91dGVJbmZvcyA9IHRhcmdldFJvdXRlSW5mb3Muc2xpY2UoMCwgaW5kZXggKyAxKTsKICAgICAgcmVjb2dIYW5kbGVycyA9IHJlY29nSGFuZGxlcnMuc2xpY2UoMCwgaW5kZXggKyAxKTsKICAgICAgdmFyIGludGVudCA9IG5ldyBOYW1lZFRyYW5zaXRpb25JbnRlbnQodGhpcywgdGFyZ2V0SGFuZGxlciwgdW5kZWZpbmVkLCBjb250ZXh0cyk7CiAgICAgIHZhciBuZXdTdGF0ZSA9IGludGVudC5hcHBseVRvSGFuZGxlcnModGVzdFN0YXRlLCByZWNvZ0hhbmRsZXJzLCB0YXJnZXRIYW5kbGVyLCB0cnVlLCB0cnVlKTsKICAgICAgdmFyIHJvdXRlc0VxdWFsID0gcm91dGVJbmZvc0VxdWFsKG5ld1N0YXRlLnJvdXRlSW5mb3MsIHRlc3RTdGF0ZS5yb3V0ZUluZm9zKTsKCiAgICAgIGlmICghcXVlcnlQYXJhbXMgfHwgIXJvdXRlc0VxdWFsKSB7CiAgICAgICAgcmV0dXJuIHJvdXRlc0VxdWFsOwogICAgICB9IC8vIEdldCBhIGhhc2ggb2YgUVBzIHRoYXQgd2lsbCBzdGlsbCBiZSBhY3RpdmUgb24gbmV3IHJvdXRlCgoKICAgICAgdmFyIGFjdGl2ZVFQc09uTmV3SGFuZGxlciA9IHt9OwogICAgICBtZXJnZShhY3RpdmVRUHNPbk5ld0hhbmRsZXIsIHF1ZXJ5UGFyYW1zKTsKICAgICAgdmFyIGFjdGl2ZVF1ZXJ5UGFyYW1zID0gc3RhdGUucXVlcnlQYXJhbXM7CgogICAgICBmb3IgKHZhciBrZXkgaW4gYWN0aXZlUXVlcnlQYXJhbXMpIHsKICAgICAgICBpZiAoYWN0aXZlUXVlcnlQYXJhbXMuaGFzT3duUHJvcGVydHkoa2V5KSAmJiBhY3RpdmVRUHNPbk5ld0hhbmRsZXIuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgYWN0aXZlUVBzT25OZXdIYW5kbGVyW2tleV0gPSBhY3RpdmVRdWVyeVBhcmFtc1trZXldOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHJvdXRlc0VxdWFsICYmICFnZXRDaGFuZ2VsaXN0KGFjdGl2ZVFQc09uTmV3SGFuZGxlciwgcXVlcnlQYXJhbXMpOwogICAgfTsKCiAgICBfcHJvdG85LmlzQWN0aXZlID0gZnVuY3Rpb24gaXNBY3RpdmUocm91dGVOYW1lKSB7CiAgICAgIGZvciAodmFyIF9sZW42ID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuNiA+IDEgPyBfbGVuNiAtIDEgOiAwKSwgX2tleTYgPSAxOyBfa2V5NiA8IF9sZW42OyBfa2V5NisrKSB7CiAgICAgICAgYXJnc1tfa2V5NiAtIDFdID0gYXJndW1lbnRzW19rZXk2XTsKICAgICAgfQoKICAgICAgdmFyIHBhcnRpdGlvbmVkQXJncyA9IGV4dHJhY3RRdWVyeVBhcmFtcyhhcmdzKTsKICAgICAgcmV0dXJuIHRoaXMuaXNBY3RpdmVJbnRlbnQocm91dGVOYW1lLCBwYXJ0aXRpb25lZEFyZ3NbMF0sIHBhcnRpdGlvbmVkQXJnc1sxXSk7CiAgICB9OwoKICAgIF9wcm90bzkudHJpZ2dlciA9IGZ1bmN0aW9uIHRyaWdnZXIobmFtZSkgewogICAgICBmb3IgKHZhciBfbGVuNyA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjcgPiAxID8gX2xlbjcgLSAxIDogMCksIF9rZXk3ID0gMTsgX2tleTcgPCBfbGVuNzsgX2tleTcrKykgewogICAgICAgIGFyZ3NbX2tleTcgLSAxXSA9IGFyZ3VtZW50c1tfa2V5N107CiAgICAgIH0KCiAgICAgIHRoaXMudHJpZ2dlckV2ZW50KHRoaXMuY3VycmVudFJvdXRlSW5mb3MsIGZhbHNlLCBuYW1lLCBhcmdzKTsKICAgIH07CgogICAgcmV0dXJuIFJvdXRlcjsKICB9KCk7CgogIGZ1bmN0aW9uIHJvdXRlSW5mb3NFcXVhbChyb3V0ZUluZm9zLCBvdGhlclJvdXRlSW5mb3MpIHsKICAgIGlmIChyb3V0ZUluZm9zLmxlbmd0aCAhPT0gb3RoZXJSb3V0ZUluZm9zLmxlbmd0aCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHJvdXRlSW5mb3MubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgaWYgKHJvdXRlSW5mb3NbaV0gIT09IG90aGVyUm91dGVJbmZvc1tpXSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0cnVlOwogIH0KCiAgZnVuY3Rpb24gcm91dGVJbmZvc1NhbWVFeGNlcHRRdWVyeVBhcmFtcyhyb3V0ZUluZm9zLCBvdGhlclJvdXRlSW5mb3MpIHsKICAgIGlmIChyb3V0ZUluZm9zLmxlbmd0aCAhPT0gb3RoZXJSb3V0ZUluZm9zLmxlbmd0aCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHJvdXRlSW5mb3MubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgaWYgKHJvdXRlSW5mb3NbaV0ubmFtZSAhPT0gb3RoZXJSb3V0ZUluZm9zW2ldLm5hbWUpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmICghcGFyYW1zRXF1YWwocm91dGVJbmZvc1tpXS5wYXJhbXMsIG90aGVyUm91dGVJbmZvc1tpXS5wYXJhbXMpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfQoKICBmdW5jdGlvbiBwYXJhbXNFcXVhbChwYXJhbXMsIG90aGVyUGFyYW1zKSB7CiAgICBpZiAoIXBhcmFtcyAmJiAhb3RoZXJQYXJhbXMpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgaWYgKCFwYXJhbXMgJiYgISFvdGhlclBhcmFtcyB8fCAhIXBhcmFtcyAmJiAhb3RoZXJQYXJhbXMpIHsKICAgICAgLy8gb25lIGlzIGZhbHN5IGJ1dCBvdGhlciBpcyBub3Q7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHBhcmFtcyk7CiAgICB2YXIgb3RoZXJLZXlzID0gT2JqZWN0LmtleXMob3RoZXJQYXJhbXMpOwoKICAgIGlmIChrZXlzLmxlbmd0aCAhPT0gb3RoZXJLZXlzLmxlbmd0aCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGtleXMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgdmFyIGtleSA9IGtleXNbaV07CgogICAgICBpZiAocGFyYW1zW2tleV0gIT09IG90aGVyUGFyYW1zW2tleV0pIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIHZhciBfZGVmYXVsdCA9IFJvdXRlcjsKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwpkZWZpbmUoInJzdnAiLCBbImV4cG9ydHMiLCAiZW1iZXItYmFiZWwiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZW1iZXJCYWJlbCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuYXNhcCA9IGFzYXA7CiAgX2V4cG9ydHMuYWxsID0gYWxsJDE7CiAgX2V4cG9ydHMuYWxsU2V0dGxlZCA9IGFsbFNldHRsZWQ7CiAgX2V4cG9ydHMucmFjZSA9IHJhY2UkMTsKICBfZXhwb3J0cy5oYXNoID0gaGFzaDsKICBfZXhwb3J0cy5oYXNoU2V0dGxlZCA9IGhhc2hTZXR0bGVkOwogIF9leHBvcnRzLnJldGhyb3cgPSByZXRocm93OwogIF9leHBvcnRzLmRlZmVyID0gZGVmZXI7CiAgX2V4cG9ydHMuZGVub2RlaWZ5ID0gZGVub2RlaWZ5OwogIF9leHBvcnRzLmNvbmZpZ3VyZSA9IGNvbmZpZ3VyZTsKICBfZXhwb3J0cy5vbiA9IG9uOwogIF9leHBvcnRzLm9mZiA9IG9mZjsKICBfZXhwb3J0cy5yZXNvbHZlID0gcmVzb2x2ZSQyOwogIF9leHBvcnRzLnJlamVjdCA9IHJlamVjdCQyOwogIF9leHBvcnRzLm1hcCA9IG1hcDsKICBfZXhwb3J0cy5maWx0ZXIgPSBmaWx0ZXI7CiAgX2V4cG9ydHMuYXN5bmMgPSBfZXhwb3J0cy5FdmVudFRhcmdldCA9IF9leHBvcnRzLlByb21pc2UgPSBfZXhwb3J0cy5jYXN0ID0gX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgZnVuY3Rpb24gY2FsbGJhY2tzRm9yKG9iamVjdCkgewogICAgdmFyIGNhbGxiYWNrcyA9IG9iamVjdC5fcHJvbWlzZUNhbGxiYWNrczsKCiAgICBpZiAoIWNhbGxiYWNrcykgewogICAgICBjYWxsYmFja3MgPSBvYmplY3QuX3Byb21pc2VDYWxsYmFja3MgPSB7fTsKICAgIH0KCiAgICByZXR1cm4gY2FsbGJhY2tzOwogIH0KICAvKioKICAgIEBjbGFzcyBFdmVudFRhcmdldAogICAgQGZvciByc3ZwCiAgICBAcHVibGljCiAgKi8KCgogIHZhciBFdmVudFRhcmdldCA9IHsKICAgIC8qKgogICAgICBgRXZlbnRUYXJnZXQubWl4aW5gIGV4dGVuZHMgYW4gb2JqZWN0IHdpdGggRXZlbnRUYXJnZXQgbWV0aG9kcy4gRm9yCiAgICAgIEV4YW1wbGU6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBFdmVudFRhcmdldCBmcm9tICdyc3ZwJzsKICAgICAgIGxldCBvYmplY3QgPSB7fTsKICAgICAgIEV2ZW50VGFyZ2V0Lm1peGluKG9iamVjdCk7CiAgICAgICBvYmplY3Qub24oJ2ZpbmlzaGVkJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAvLyBoYW5kbGUgZXZlbnQKICAgICAgfSk7CiAgICAgICBvYmplY3QudHJpZ2dlcignZmluaXNoZWQnLCB7IGRldGFpbDogdmFsdWUgfSk7CiAgICAgIGBgYAogICAgICAgYEV2ZW50VGFyZ2V0Lm1peGluYCBhbHNvIHdvcmtzIHdpdGggcHJvdG90eXBlczoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IEV2ZW50VGFyZ2V0IGZyb20gJ3JzdnAnOwogICAgICAgbGV0IFBlcnNvbiA9IGZ1bmN0aW9uKCkge307CiAgICAgIEV2ZW50VGFyZ2V0Lm1peGluKFBlcnNvbi5wcm90b3R5cGUpOwogICAgICAgbGV0IHllaHVkYSA9IG5ldyBQZXJzb24oKTsKICAgICAgbGV0IHRvbSA9IG5ldyBQZXJzb24oKTsKICAgICAgIHllaHVkYS5vbigncG9rZScsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgY29uc29sZS5sb2coJ1llaHVkYSBzYXlzIE9XJyk7CiAgICAgIH0pOwogICAgICAgdG9tLm9uKCdwb2tlJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICBjb25zb2xlLmxvZygnVG9tIHNheXMgT1cnKTsKICAgICAgfSk7CiAgICAgICB5ZWh1ZGEudHJpZ2dlcigncG9rZScpOwogICAgICB0b20udHJpZ2dlcigncG9rZScpOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgbWl4aW4KICAgICAgQGZvciByc3ZwCiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvYmplY3Qgb2JqZWN0IHRvIGV4dGVuZCB3aXRoIEV2ZW50VGFyZ2V0IG1ldGhvZHMKICAgICovCiAgICBtaXhpbjogZnVuY3Rpb24gbWl4aW4ob2JqZWN0KSB7CiAgICAgIG9iamVjdC5vbiA9IHRoaXMub247CiAgICAgIG9iamVjdC5vZmYgPSB0aGlzLm9mZjsKICAgICAgb2JqZWN0LnRyaWdnZXIgPSB0aGlzLnRyaWdnZXI7CiAgICAgIG9iamVjdC5fcHJvbWlzZUNhbGxiYWNrcyA9IHVuZGVmaW5lZDsKICAgICAgcmV0dXJuIG9iamVjdDsKICAgIH0sCgogICAgLyoqCiAgICAgIFJlZ2lzdGVycyBhIGNhbGxiYWNrIHRvIGJlIGV4ZWN1dGVkIHdoZW4gYGV2ZW50TmFtZWAgaXMgdHJpZ2dlcmVkCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIG9iamVjdC5vbignZXZlbnQnLCBmdW5jdGlvbihldmVudEluZm8pewogICAgICAgIC8vIGhhbmRsZSB0aGUgZXZlbnQKICAgICAgfSk7CiAgICAgICBvYmplY3QudHJpZ2dlcignZXZlbnQnKTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIG9uCiAgICAgIEBmb3IgRXZlbnRUYXJnZXQKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50TmFtZSBuYW1lIG9mIHRoZSBldmVudCB0byBsaXN0ZW4gZm9yCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBldmVudCBpcyB0cmlnZ2VyZWQuCiAgICAqLwogICAgb246IGZ1bmN0aW9uIG9uKGV2ZW50TmFtZSwgY2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0NhbGxiYWNrIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICB9CgogICAgICB2YXIgYWxsQ2FsbGJhY2tzID0gY2FsbGJhY2tzRm9yKHRoaXMpOwogICAgICB2YXIgY2FsbGJhY2tzID0gYWxsQ2FsbGJhY2tzW2V2ZW50TmFtZV07CgogICAgICBpZiAoIWNhbGxiYWNrcykgewogICAgICAgIGNhbGxiYWNrcyA9IGFsbENhbGxiYWNrc1tldmVudE5hbWVdID0gW107CiAgICAgIH0KCiAgICAgIGlmIChjYWxsYmFja3MuaW5kZXhPZihjYWxsYmFjaykgPT09IC0xKSB7CiAgICAgICAgY2FsbGJhY2tzLnB1c2goY2FsbGJhY2spOwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBZb3UgY2FuIHVzZSBgb2ZmYCB0byBzdG9wIGZpcmluZyBhIHBhcnRpY3VsYXIgY2FsbGJhY2sgZm9yIGFuIGV2ZW50OgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBmdW5jdGlvbiBkb1N0dWZmKCkgeyAvLyBkbyBzdHVmZiEgfQogICAgICBvYmplY3Qub24oJ3N0dWZmJywgZG9TdHVmZik7CiAgICAgICBvYmplY3QudHJpZ2dlcignc3R1ZmYnKTsgLy8gZG9TdHVmZiB3aWxsIGJlIGNhbGxlZAogICAgICAgLy8gVW5yZWdpc3RlciBPTkxZIHRoZSBkb1N0dWZmIGNhbGxiYWNrCiAgICAgIG9iamVjdC5vZmYoJ3N0dWZmJywgZG9TdHVmZik7CiAgICAgIG9iamVjdC50cmlnZ2VyKCdzdHVmZicpOyAvLyBkb1N0dWZmIHdpbGwgTk9UIGJlIGNhbGxlZAogICAgICBgYGAKICAgICAgIElmIHlvdSBkb24ndCBwYXNzIGEgYGNhbGxiYWNrYCBhcmd1bWVudCB0byBgb2ZmYCwgQUxMIGNhbGxiYWNrcyBmb3IgdGhlCiAgICAgIGV2ZW50IHdpbGwgbm90IGJlIGV4ZWN1dGVkIHdoZW4gdGhlIGV2ZW50IGZpcmVzLiBGb3IgZXhhbXBsZToKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgbGV0IGNhbGxiYWNrMSA9IGZ1bmN0aW9uKCl7fTsKICAgICAgbGV0IGNhbGxiYWNrMiA9IGZ1bmN0aW9uKCl7fTsKICAgICAgIG9iamVjdC5vbignc3R1ZmYnLCBjYWxsYmFjazEpOwogICAgICBvYmplY3Qub24oJ3N0dWZmJywgY2FsbGJhY2syKTsKICAgICAgIG9iamVjdC50cmlnZ2VyKCdzdHVmZicpOyAvLyBjYWxsYmFjazEgYW5kIGNhbGxiYWNrMiB3aWxsIGJlIGV4ZWN1dGVkLgogICAgICAgb2JqZWN0Lm9mZignc3R1ZmYnKTsKICAgICAgb2JqZWN0LnRyaWdnZXIoJ3N0dWZmJyk7IC8vIGNhbGxiYWNrMSBhbmQgY2FsbGJhY2syIHdpbGwgbm90IGJlIGV4ZWN1dGVkIQogICAgICBgYGAKICAgICAgIEBtZXRob2Qgb2ZmCiAgICAgIEBmb3IgcnN2cAogICAgICBAcHJpdmF0ZQogICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnROYW1lIGV2ZW50IHRvIHN0b3AgbGlzdGVuaW5nIHRvCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gb3B0aW9uYWwgYXJndW1lbnQuIElmIGdpdmVuLCBvbmx5IHRoZSBmdW5jdGlvbgogICAgICBnaXZlbiB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgZXZlbnQncyBjYWxsYmFjayBxdWV1ZS4gSWYgbm8gYGNhbGxiYWNrYAogICAgICBhcmd1bWVudCBpcyBnaXZlbiwgYWxsIGNhbGxiYWNrcyB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgZXZlbnQncyBjYWxsYmFjawogICAgICBxdWV1ZS4KICAgICovCiAgICBvZmY6IGZ1bmN0aW9uIG9mZihldmVudE5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBhbGxDYWxsYmFja3MgPSBjYWxsYmFja3NGb3IodGhpcyk7CgogICAgICBpZiAoIWNhbGxiYWNrKSB7CiAgICAgICAgYWxsQ2FsbGJhY2tzW2V2ZW50TmFtZV0gPSBbXTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBjYWxsYmFja3MgPSBhbGxDYWxsYmFja3NbZXZlbnROYW1lXTsKICAgICAgdmFyIGluZGV4ID0gY2FsbGJhY2tzLmluZGV4T2YoY2FsbGJhY2spOwoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgIGNhbGxiYWNrcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBVc2UgYHRyaWdnZXJgIHRvIGZpcmUgY3VzdG9tIGV2ZW50cy4gRm9yIGV4YW1wbGU6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIG9iamVjdC5vbignZm9vJywgZnVuY3Rpb24oKXsKICAgICAgICBjb25zb2xlLmxvZygnZm9vIGV2ZW50IGhhcHBlbmVkIScpOwogICAgICB9KTsKICAgICAgb2JqZWN0LnRyaWdnZXIoJ2ZvbycpOwogICAgICAvLyAnZm9vIGV2ZW50IGhhcHBlbmVkIScgbG9nZ2VkIHRvIHRoZSBjb25zb2xlCiAgICAgIGBgYAogICAgICAgWW91IGNhbiBhbHNvIHBhc3MgYSB2YWx1ZSBhcyBhIHNlY29uZCBhcmd1bWVudCB0byBgdHJpZ2dlcmAgdGhhdCB3aWxsIGJlCiAgICAgIHBhc3NlZCBhcyBhbiBhcmd1bWVudCB0byBhbGwgZXZlbnQgbGlzdGVuZXJzIGZvciB0aGUgZXZlbnQ6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIG9iamVjdC5vbignZm9vJywgZnVuY3Rpb24odmFsdWUpewogICAgICAgIGNvbnNvbGUubG9nKHZhbHVlLm5hbWUpOwogICAgICB9KTsKICAgICAgIG9iamVjdC50cmlnZ2VyKCdmb28nLCB7IG5hbWU6ICdiYXInIH0pOwogICAgICAvLyAnYmFyJyBsb2dnZWQgdG8gdGhlIGNvbnNvbGUKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHRyaWdnZXIKICAgICAgQGZvciByc3ZwCiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudE5hbWUgbmFtZSBvZiB0aGUgZXZlbnQgdG8gYmUgdHJpZ2dlcmVkCiAgICAgIEBwYXJhbSB7Kn0gW29wdGlvbnNdIG9wdGlvbmFsIHZhbHVlIHRvIGJlIHBhc3NlZCB0byBhbnkgZXZlbnQgaGFuZGxlcnMgZm9yCiAgICAgIHRoZSBnaXZlbiBgZXZlbnROYW1lYAogICAgKi8KICAgIHRyaWdnZXI6IGZ1bmN0aW9uIHRyaWdnZXIoZXZlbnROYW1lLCBvcHRpb25zLCBsYWJlbCkgewogICAgICB2YXIgYWxsQ2FsbGJhY2tzID0gY2FsbGJhY2tzRm9yKHRoaXMpOwogICAgICB2YXIgY2FsbGJhY2tzID0gYWxsQ2FsbGJhY2tzW2V2ZW50TmFtZV07CgogICAgICBpZiAoY2FsbGJhY2tzKSB7CiAgICAgICAgLy8gRG9uJ3QgY2FjaGUgdGhlIGNhbGxiYWNrcy5sZW5ndGggc2luY2UgaXQgbWF5IGdyb3cKICAgICAgICB2YXIgY2FsbGJhY2s7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2FsbGJhY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrc1tpXTsKICAgICAgICAgIGNhbGxiYWNrKG9wdGlvbnMsIGxhYmVsKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwogIF9leHBvcnRzLkV2ZW50VGFyZ2V0ID0gRXZlbnRUYXJnZXQ7CiAgdmFyIGNvbmZpZyA9IHsKICAgIGluc3RydW1lbnQ6IGZhbHNlCiAgfTsKICBFdmVudFRhcmdldFsnbWl4aW4nXShjb25maWcpOwoKICBmdW5jdGlvbiBjb25maWd1cmUobmFtZSwgdmFsdWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICAgIGNvbmZpZ1tuYW1lXSA9IHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGNvbmZpZ1tuYW1lXTsKICAgIH0KICB9CgogIHZhciBxdWV1ZSA9IFtdOwoKICBmdW5jdGlvbiBzY2hlZHVsZUZsdXNoKCkgewogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgZW50cnkgPSBxdWV1ZVtpXTsKICAgICAgICB2YXIgcGF5bG9hZCA9IGVudHJ5LnBheWxvYWQ7CiAgICAgICAgcGF5bG9hZC5ndWlkID0gcGF5bG9hZC5rZXkgKyBwYXlsb2FkLmlkOwogICAgICAgIHBheWxvYWQuY2hpbGRHdWlkID0gcGF5bG9hZC5rZXkgKyBwYXlsb2FkLmNoaWxkSWQ7CgogICAgICAgIGlmIChwYXlsb2FkLmVycm9yKSB7CiAgICAgICAgICBwYXlsb2FkLnN0YWNrID0gcGF5bG9hZC5lcnJvci5zdGFjazsKICAgICAgICB9CgogICAgICAgIGNvbmZpZ1sndHJpZ2dlciddKGVudHJ5Lm5hbWUsIGVudHJ5LnBheWxvYWQpOwogICAgICB9CgogICAgICBxdWV1ZS5sZW5ndGggPSAwOwogICAgfSwgNTApOwogIH0KCiAgZnVuY3Rpb24gaW5zdHJ1bWVudChldmVudE5hbWUsIHByb21pc2UsIGNoaWxkKSB7CiAgICBpZiAoMSA9PT0gcXVldWUucHVzaCh7CiAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgcGF5bG9hZDogewogICAgICAgIGtleTogcHJvbWlzZS5fZ3VpZEtleSwKICAgICAgICBpZDogcHJvbWlzZS5faWQsCiAgICAgICAgZXZlbnROYW1lOiBldmVudE5hbWUsCiAgICAgICAgZGV0YWlsOiBwcm9taXNlLl9yZXN1bHQsCiAgICAgICAgY2hpbGRJZDogY2hpbGQgJiYgY2hpbGQuX2lkLAogICAgICAgIGxhYmVsOiBwcm9taXNlLl9sYWJlbCwKICAgICAgICB0aW1lU3RhbXA6IERhdGUubm93KCksCiAgICAgICAgZXJyb3I6IGNvbmZpZ1siaW5zdHJ1bWVudC13aXRoLXN0YWNrIl0gPyBuZXcgRXJyb3IocHJvbWlzZS5fbGFiZWwpIDogbnVsbAogICAgICB9CiAgICB9KSkgewogICAgICBzY2hlZHVsZUZsdXNoKCk7CiAgICB9CiAgfQogIC8qKgogICAgYFByb21pc2UucmVzb2x2ZWAgcmV0dXJucyBhIHByb21pc2UgdGhhdCB3aWxsIGJlY29tZSByZXNvbHZlZCB3aXRoIHRoZQogICAgcGFzc2VkIGB2YWx1ZWAuIEl0IGlzIHNob3J0aGFuZCBmb3IgdGhlIGZvbGxvd2luZzoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBQcm9taXNlIGZyb20gJ3JzdnAnOwogIAogICAgbGV0IHByb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpewogICAgICByZXNvbHZlKDEpOwogICAgfSk7CiAgCiAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsdWUpewogICAgICAvLyB2YWx1ZSA9PT0gMQogICAgfSk7CiAgICBgYGAKICAKICAgIEluc3RlYWQgb2Ygd3JpdGluZyB0aGUgYWJvdmUsIHlvdXIgY29kZSBub3cgc2ltcGx5IGJlY29tZXMgdGhlIGZvbGxvd2luZzoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBQcm9taXNlIGZyb20gJ3JzdnAnOwogIAogICAgbGV0IHByb21pc2UgPSBSU1ZQLlByb21pc2UucmVzb2x2ZSgxKTsKICAKICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSl7CiAgICAgIC8vIHZhbHVlID09PSAxCiAgICB9KTsKICAgIGBgYAogIAogICAgQG1ldGhvZCByZXNvbHZlCiAgICBAZm9yIFByb21pc2UKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7Kn0gb2JqZWN0IHZhbHVlIHRoYXQgdGhlIHJldHVybmVkIHByb21pc2Ugd2lsbCBiZSByZXNvbHZlZCB3aXRoCiAgICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsXSBvcHRpb25hbCBzdHJpbmcgZm9yIGlkZW50aWZ5aW5nIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAgVXNlZnVsIGZvciB0b29saW5nLgogICAgQHJldHVybiB7UHJvbWlzZX0gYSBwcm9taXNlIHRoYXQgd2lsbCBiZWNvbWUgZnVsZmlsbGVkIHdpdGggdGhlIGdpdmVuCiAgICBgdmFsdWVgCiAgKi8KCgogIGZ1bmN0aW9uIHJlc29sdmUkJDEob2JqZWN0LCBsYWJlbCkgewogICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgIHZhciBDb25zdHJ1Y3RvciA9IHRoaXM7CgogICAgaWYgKG9iamVjdCAmJiB0eXBlb2Ygb2JqZWN0ID09PSAnb2JqZWN0JyAmJiBvYmplY3QuY29uc3RydWN0b3IgPT09IENvbnN0cnVjdG9yKSB7CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CgogICAgdmFyIHByb21pc2UgPSBuZXcgQ29uc3RydWN0b3Iobm9vcCwgbGFiZWwpOwogICAgcmVzb2x2ZSQxKHByb21pc2UsIG9iamVjdCk7CiAgICByZXR1cm4gcHJvbWlzZTsKICB9CgogIGZ1bmN0aW9uIHdpdGhPd25Qcm9taXNlKCkgewogICAgcmV0dXJuIG5ldyBUeXBlRXJyb3IoJ0EgcHJvbWlzZXMgY2FsbGJhY2sgY2Fubm90IHJldHVybiB0aGF0IHNhbWUgcHJvbWlzZS4nKTsKICB9CgogIGZ1bmN0aW9uIG9iamVjdE9yRnVuY3Rpb24oeCkgewogICAgdmFyIHR5cGUgPSB0eXBlb2YgeDsKICAgIHJldHVybiB4ICE9PSBudWxsICYmICh0eXBlID09PSAnb2JqZWN0JyB8fCB0eXBlID09PSAnZnVuY3Rpb24nKTsKICB9CgogIGZ1bmN0aW9uIG5vb3AoKSB7fQoKICB2YXIgUEVORElORyA9IHZvaWQgMDsKICB2YXIgRlVMRklMTEVEID0gMTsKICB2YXIgUkVKRUNURUQgPSAyOwoKICBmdW5jdGlvbiB0cnlUaGVuKHRoZW4kJDEsIHZhbHVlLCBmdWxmaWxsbWVudEhhbmRsZXIsIHJlamVjdGlvbkhhbmRsZXIpIHsKICAgIHRyeSB7CiAgICAgIHRoZW4kJDEuY2FsbCh2YWx1ZSwgZnVsZmlsbG1lbnRIYW5kbGVyLCByZWplY3Rpb25IYW5kbGVyKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIGU7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBoYW5kbGVGb3JlaWduVGhlbmFibGUocHJvbWlzZSwgdGhlbmFibGUsIHRoZW4kJDEpIHsKICAgIGNvbmZpZy5hc3luYyhmdW5jdGlvbiAocHJvbWlzZSkgewogICAgICB2YXIgc2VhbGVkID0gZmFsc2U7CiAgICAgIHZhciBlcnJvciA9IHRyeVRoZW4odGhlbiQkMSwgdGhlbmFibGUsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIGlmIChzZWFsZWQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHNlYWxlZCA9IHRydWU7CgogICAgICAgIGlmICh0aGVuYWJsZSA9PT0gdmFsdWUpIHsKICAgICAgICAgIGZ1bGZpbGwocHJvbWlzZSwgdmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXNvbHZlJDEocHJvbWlzZSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIGlmIChzZWFsZWQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHNlYWxlZCA9IHRydWU7CiAgICAgICAgcmVqZWN0KHByb21pc2UsIHJlYXNvbik7CiAgICAgIH0sICdTZXR0bGU6ICcgKyAocHJvbWlzZS5fbGFiZWwgfHwgJyB1bmtub3duIHByb21pc2UnKSk7CgogICAgICBpZiAoIXNlYWxlZCAmJiBlcnJvcikgewogICAgICAgIHNlYWxlZCA9IHRydWU7CiAgICAgICAgcmVqZWN0KHByb21pc2UsIGVycm9yKTsKICAgICAgfQogICAgfSwgcHJvbWlzZSk7CiAgfQoKICBmdW5jdGlvbiBoYW5kbGVPd25UaGVuYWJsZShwcm9taXNlLCB0aGVuYWJsZSkgewogICAgaWYgKHRoZW5hYmxlLl9zdGF0ZSA9PT0gRlVMRklMTEVEKSB7CiAgICAgIGZ1bGZpbGwocHJvbWlzZSwgdGhlbmFibGUuX3Jlc3VsdCk7CiAgICB9IGVsc2UgaWYgKHRoZW5hYmxlLl9zdGF0ZSA9PT0gUkVKRUNURUQpIHsKICAgICAgdGhlbmFibGUuX29uRXJyb3IgPSBudWxsOwogICAgICByZWplY3QocHJvbWlzZSwgdGhlbmFibGUuX3Jlc3VsdCk7CiAgICB9IGVsc2UgewogICAgICBzdWJzY3JpYmUodGhlbmFibGUsIHVuZGVmaW5lZCwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHRoZW5hYmxlID09PSB2YWx1ZSkgewogICAgICAgICAgZnVsZmlsbChwcm9taXNlLCB2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc29sdmUkMShwcm9taXNlLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgcmV0dXJuIHJlamVjdChwcm9taXNlLCByZWFzb24pOwogICAgICB9KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGhhbmRsZU1heWJlVGhlbmFibGUocHJvbWlzZSwgbWF5YmVUaGVuYWJsZSwgdGhlbiQkMSkgewogICAgdmFyIGlzT3duVGhlbmFibGUgPSBtYXliZVRoZW5hYmxlLmNvbnN0cnVjdG9yID09PSBwcm9taXNlLmNvbnN0cnVjdG9yICYmIHRoZW4kJDEgPT09IHRoZW4gJiYgcHJvbWlzZS5jb25zdHJ1Y3Rvci5yZXNvbHZlID09PSByZXNvbHZlJCQxOwoKICAgIGlmIChpc093blRoZW5hYmxlKSB7CiAgICAgIGhhbmRsZU93blRoZW5hYmxlKHByb21pc2UsIG1heWJlVGhlbmFibGUpOwogICAgfSBlbHNlIGlmICh0eXBlb2YgdGhlbiQkMSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBoYW5kbGVGb3JlaWduVGhlbmFibGUocHJvbWlzZSwgbWF5YmVUaGVuYWJsZSwgdGhlbiQkMSk7CiAgICB9IGVsc2UgewogICAgICBmdWxmaWxsKHByb21pc2UsIG1heWJlVGhlbmFibGUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVzb2x2ZSQxKHByb21pc2UsIHZhbHVlKSB7CiAgICBpZiAocHJvbWlzZSA9PT0gdmFsdWUpIHsKICAgICAgZnVsZmlsbChwcm9taXNlLCB2YWx1ZSk7CiAgICB9IGVsc2UgaWYgKG9iamVjdE9yRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgIHZhciB0aGVuJCQxOwoKICAgICAgdHJ5IHsKICAgICAgICB0aGVuJCQxID0gdmFsdWUudGhlbjsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICByZWplY3QocHJvbWlzZSwgZXJyb3IpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaGFuZGxlTWF5YmVUaGVuYWJsZShwcm9taXNlLCB2YWx1ZSwgdGhlbiQkMSk7CiAgICB9IGVsc2UgewogICAgICBmdWxmaWxsKHByb21pc2UsIHZhbHVlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHB1Ymxpc2hSZWplY3Rpb24ocHJvbWlzZSkgewogICAgaWYgKHByb21pc2UuX29uRXJyb3IpIHsKICAgICAgcHJvbWlzZS5fb25FcnJvcihwcm9taXNlLl9yZXN1bHQpOwogICAgfQoKICAgIHB1Ymxpc2gocHJvbWlzZSk7CiAgfQoKICBmdW5jdGlvbiBmdWxmaWxsKHByb21pc2UsIHZhbHVlKSB7CiAgICBpZiAocHJvbWlzZS5fc3RhdGUgIT09IFBFTkRJTkcpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHByb21pc2UuX3Jlc3VsdCA9IHZhbHVlOwogICAgcHJvbWlzZS5fc3RhdGUgPSBGVUxGSUxMRUQ7CgogICAgaWYgKHByb21pc2UuX3N1YnNjcmliZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICBpZiAoY29uZmlnLmluc3RydW1lbnQpIHsKICAgICAgICBpbnN0cnVtZW50KCdmdWxmaWxsZWQnLCBwcm9taXNlKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uZmlnLmFzeW5jKHB1Ymxpc2gsIHByb21pc2UpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVqZWN0KHByb21pc2UsIHJlYXNvbikgewogICAgaWYgKHByb21pc2UuX3N0YXRlICE9PSBQRU5ESU5HKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBwcm9taXNlLl9zdGF0ZSA9IFJFSkVDVEVEOwogICAgcHJvbWlzZS5fcmVzdWx0ID0gcmVhc29uOwogICAgY29uZmlnLmFzeW5jKHB1Ymxpc2hSZWplY3Rpb24sIHByb21pc2UpOwogIH0KCiAgZnVuY3Rpb24gc3Vic2NyaWJlKHBhcmVudCwgY2hpbGQsIG9uRnVsZmlsbG1lbnQsIG9uUmVqZWN0aW9uKSB7CiAgICB2YXIgc3Vic2NyaWJlcnMgPSBwYXJlbnQuX3N1YnNjcmliZXJzOwogICAgdmFyIGxlbmd0aCA9IHN1YnNjcmliZXJzLmxlbmd0aDsKICAgIHBhcmVudC5fb25FcnJvciA9IG51bGw7CiAgICBzdWJzY3JpYmVyc1tsZW5ndGhdID0gY2hpbGQ7CiAgICBzdWJzY3JpYmVyc1tsZW5ndGggKyBGVUxGSUxMRURdID0gb25GdWxmaWxsbWVudDsKICAgIHN1YnNjcmliZXJzW2xlbmd0aCArIFJFSkVDVEVEXSA9IG9uUmVqZWN0aW9uOwoKICAgIGlmIChsZW5ndGggPT09IDAgJiYgcGFyZW50Ll9zdGF0ZSkgewogICAgICBjb25maWcuYXN5bmMocHVibGlzaCwgcGFyZW50KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHB1Ymxpc2gocHJvbWlzZSkgewogICAgdmFyIHN1YnNjcmliZXJzID0gcHJvbWlzZS5fc3Vic2NyaWJlcnM7CiAgICB2YXIgc2V0dGxlZCA9IHByb21pc2UuX3N0YXRlOwoKICAgIGlmIChjb25maWcuaW5zdHJ1bWVudCkgewogICAgICBpbnN0cnVtZW50KHNldHRsZWQgPT09IEZVTEZJTExFRCA/ICdmdWxmaWxsZWQnIDogJ3JlamVjdGVkJywgcHJvbWlzZSk7CiAgICB9CgogICAgaWYgKHN1YnNjcmliZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGNoaWxkLAogICAgICAgIGNhbGxiYWNrLAogICAgICAgIHJlc3VsdCA9IHByb21pc2UuX3Jlc3VsdDsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN1YnNjcmliZXJzLmxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGNoaWxkID0gc3Vic2NyaWJlcnNbaV07CiAgICAgIGNhbGxiYWNrID0gc3Vic2NyaWJlcnNbaSArIHNldHRsZWRdOwoKICAgICAgaWYgKGNoaWxkKSB7CiAgICAgICAgaW52b2tlQ2FsbGJhY2soc2V0dGxlZCwgY2hpbGQsIGNhbGxiYWNrLCByZXN1bHQpOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrKHJlc3VsdCk7CiAgICAgIH0KICAgIH0KCiAgICBwcm9taXNlLl9zdWJzY3JpYmVycy5sZW5ndGggPSAwOwogIH0KCiAgZnVuY3Rpb24gaW52b2tlQ2FsbGJhY2soc3RhdGUsIHByb21pc2UsIGNhbGxiYWNrLCByZXN1bHQpIHsKICAgIHZhciBoYXNDYWxsYmFjayA9IHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJzsKICAgIHZhciB2YWx1ZSwKICAgICAgICBzdWNjZWVkZWQgPSB0cnVlLAogICAgICAgIGVycm9yOwoKICAgIGlmIChoYXNDYWxsYmFjaykgewogICAgICB0cnkgewogICAgICAgIHZhbHVlID0gY2FsbGJhY2socmVzdWx0KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHN1Y2NlZWRlZCA9IGZhbHNlOwogICAgICAgIGVycm9yID0gZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFsdWUgPSByZXN1bHQ7CiAgICB9CgogICAgaWYgKHByb21pc2UuX3N0YXRlICE9PSBQRU5ESU5HKSB7Ly8gbm9vcAogICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gcHJvbWlzZSkgewogICAgICByZWplY3QocHJvbWlzZSwgd2l0aE93blByb21pc2UoKSk7CiAgICB9IGVsc2UgaWYgKHN1Y2NlZWRlZCA9PT0gZmFsc2UpIHsKICAgICAgcmVqZWN0KHByb21pc2UsIGVycm9yKTsKICAgIH0gZWxzZSBpZiAoaGFzQ2FsbGJhY2spIHsKICAgICAgcmVzb2x2ZSQxKHByb21pc2UsIHZhbHVlKTsKICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09IEZVTEZJTExFRCkgewogICAgICBmdWxmaWxsKHByb21pc2UsIHZhbHVlKTsKICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09IFJFSkVDVEVEKSB7CiAgICAgIHJlamVjdChwcm9taXNlLCB2YWx1ZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpbml0aWFsaXplUHJvbWlzZShwcm9taXNlLCByZXNvbHZlcikgewogICAgdmFyIHJlc29sdmVkID0gZmFsc2U7CgogICAgdHJ5IHsKICAgICAgcmVzb2x2ZXIoZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHJlc29sdmVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICByZXNvbHZlZCA9IHRydWU7CiAgICAgICAgcmVzb2x2ZSQxKHByb21pc2UsIHZhbHVlKTsKICAgICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIGlmIChyZXNvbHZlZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgcmVzb2x2ZWQgPSB0cnVlOwogICAgICAgIHJlamVjdChwcm9taXNlLCByZWFzb24pOwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmVqZWN0KHByb21pc2UsIGUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdGhlbihvbkZ1bGZpbGxtZW50LCBvblJlamVjdGlvbiwgbGFiZWwpIHsKICAgIHZhciBwYXJlbnQgPSB0aGlzOwogICAgdmFyIHN0YXRlID0gcGFyZW50Ll9zdGF0ZTsKCiAgICBpZiAoc3RhdGUgPT09IEZVTEZJTExFRCAmJiAhb25GdWxmaWxsbWVudCB8fCBzdGF0ZSA9PT0gUkVKRUNURUQgJiYgIW9uUmVqZWN0aW9uKSB7CiAgICAgIGNvbmZpZy5pbnN0cnVtZW50ICYmIGluc3RydW1lbnQoJ2NoYWluZWQnLCBwYXJlbnQsIHBhcmVudCk7CiAgICAgIHJldHVybiBwYXJlbnQ7CiAgICB9CgogICAgcGFyZW50Ll9vbkVycm9yID0gbnVsbDsKICAgIHZhciBjaGlsZCA9IG5ldyBwYXJlbnQuY29uc3RydWN0b3Iobm9vcCwgbGFiZWwpOwogICAgdmFyIHJlc3VsdCA9IHBhcmVudC5fcmVzdWx0OwogICAgY29uZmlnLmluc3RydW1lbnQgJiYgaW5zdHJ1bWVudCgnY2hhaW5lZCcsIHBhcmVudCwgY2hpbGQpOwoKICAgIGlmIChzdGF0ZSA9PT0gUEVORElORykgewogICAgICBzdWJzY3JpYmUocGFyZW50LCBjaGlsZCwgb25GdWxmaWxsbWVudCwgb25SZWplY3Rpb24pOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGNhbGxiYWNrID0gc3RhdGUgPT09IEZVTEZJTExFRCA/IG9uRnVsZmlsbG1lbnQgOiBvblJlamVjdGlvbjsKICAgICAgY29uZmlnLmFzeW5jKGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gaW52b2tlQ2FsbGJhY2soc3RhdGUsIGNoaWxkLCBjYWxsYmFjaywgcmVzdWx0KTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIGNoaWxkOwogIH0KCiAgdmFyIEVudW1lcmF0b3IgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBFbnVtZXJhdG9yKENvbnN0cnVjdG9yLCBpbnB1dCwgYWJvcnRPblJlamVjdCwgbGFiZWwpIHsKICAgICAgdGhpcy5faW5zdGFuY2VDb25zdHJ1Y3RvciA9IENvbnN0cnVjdG9yOwogICAgICB0aGlzLnByb21pc2UgPSBuZXcgQ29uc3RydWN0b3Iobm9vcCwgbGFiZWwpOwogICAgICB0aGlzLl9hYm9ydE9uUmVqZWN0ID0gYWJvcnRPblJlamVjdDsKICAgICAgdGhpcy5faXNVc2luZ093blByb21pc2UgPSBDb25zdHJ1Y3RvciA9PT0gUHJvbWlzZTsKICAgICAgdGhpcy5faXNVc2luZ093blJlc29sdmUgPSBDb25zdHJ1Y3Rvci5yZXNvbHZlID09PSByZXNvbHZlJCQxOwoKICAgICAgdGhpcy5faW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBFbnVtZXJhdG9yLnByb3RvdHlwZTsKCiAgICBfcHJvdG8uX2luaXQgPSBmdW5jdGlvbiBfaW5pdChDb25zdHJ1Y3RvciwgaW5wdXQpIHsKICAgICAgdmFyIGxlbiA9IGlucHV0Lmxlbmd0aCB8fCAwOwogICAgICB0aGlzLmxlbmd0aCA9IGxlbjsKICAgICAgdGhpcy5fcmVtYWluaW5nID0gbGVuOwogICAgICB0aGlzLl9yZXN1bHQgPSBuZXcgQXJyYXkobGVuKTsKCiAgICAgIHRoaXMuX2VudW1lcmF0ZShpbnB1dCk7CiAgICB9OwoKICAgIF9wcm90by5fZW51bWVyYXRlID0gZnVuY3Rpb24gX2VudW1lcmF0ZShpbnB1dCkgewogICAgICB2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CiAgICAgIHZhciBwcm9taXNlID0gdGhpcy5wcm9taXNlOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IHByb21pc2UuX3N0YXRlID09PSBQRU5ESU5HICYmIGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMuX2VhY2hFbnRyeShpbnB1dFtpXSwgaSwgdHJ1ZSk7CiAgICAgIH0KCiAgICAgIHRoaXMuX2NoZWNrRnVsbGZpbGxtZW50KCk7CiAgICB9OwoKICAgIF9wcm90by5fY2hlY2tGdWxsZmlsbG1lbnQgPSBmdW5jdGlvbiBfY2hlY2tGdWxsZmlsbG1lbnQoKSB7CiAgICAgIGlmICh0aGlzLl9yZW1haW5pbmcgPT09IDApIHsKICAgICAgICB2YXIgcmVzdWx0ID0gdGhpcy5fcmVzdWx0OwogICAgICAgIGZ1bGZpbGwodGhpcy5wcm9taXNlLCByZXN1bHQpOwogICAgICAgIHRoaXMuX3Jlc3VsdCA9IG51bGw7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLl9zZXR0bGVNYXliZVRoZW5hYmxlID0gZnVuY3Rpb24gX3NldHRsZU1heWJlVGhlbmFibGUoZW50cnksIGksIGZpcnN0UGFzcykgewogICAgICB2YXIgYyA9IHRoaXMuX2luc3RhbmNlQ29uc3RydWN0b3I7CgogICAgICBpZiAodGhpcy5faXNVc2luZ093blJlc29sdmUpIHsKICAgICAgICB2YXIgdGhlbiQkMSwKICAgICAgICAgICAgZXJyb3IsCiAgICAgICAgICAgIHN1Y2NlZWRlZCA9IHRydWU7CgogICAgICAgIHRyeSB7CiAgICAgICAgICB0aGVuJCQxID0gZW50cnkudGhlbjsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBzdWNjZWVkZWQgPSBmYWxzZTsKICAgICAgICAgIGVycm9yID0gZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGVuJCQxID09PSB0aGVuICYmIGVudHJ5Ll9zdGF0ZSAhPT0gUEVORElORykgewogICAgICAgICAgZW50cnkuX29uRXJyb3IgPSBudWxsOwoKICAgICAgICAgIHRoaXMuX3NldHRsZWRBdChlbnRyeS5fc3RhdGUsIGksIGVudHJ5Ll9yZXN1bHQsIGZpcnN0UGFzcyk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdGhlbiQkMSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgdGhpcy5fc2V0dGxlZEF0KEZVTEZJTExFRCwgaSwgZW50cnksIGZpcnN0UGFzcyk7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9pc1VzaW5nT3duUHJvbWlzZSkgewogICAgICAgICAgdmFyIHByb21pc2UgPSBuZXcgYyhub29wKTsKCiAgICAgICAgICBpZiAoc3VjY2VlZGVkID09PSBmYWxzZSkgewogICAgICAgICAgICByZWplY3QocHJvbWlzZSwgZXJyb3IpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaGFuZGxlTWF5YmVUaGVuYWJsZShwcm9taXNlLCBlbnRyeSwgdGhlbiQkMSk7CgogICAgICAgICAgICB0aGlzLl93aWxsU2V0dGxlQXQocHJvbWlzZSwgaSwgZmlyc3RQYXNzKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fd2lsbFNldHRsZUF0KG5ldyBjKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgICAgICAgIHJldHVybiByZXNvbHZlKGVudHJ5KTsKICAgICAgICAgIH0pLCBpLCBmaXJzdFBhc3MpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl93aWxsU2V0dGxlQXQoYy5yZXNvbHZlKGVudHJ5KSwgaSwgZmlyc3RQYXNzKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uX2VhY2hFbnRyeSA9IGZ1bmN0aW9uIF9lYWNoRW50cnkoZW50cnksIGksIGZpcnN0UGFzcykgewogICAgICBpZiAoZW50cnkgIT09IG51bGwgJiYgdHlwZW9mIGVudHJ5ID09PSAnb2JqZWN0JykgewogICAgICAgIHRoaXMuX3NldHRsZU1heWJlVGhlbmFibGUoZW50cnksIGksIGZpcnN0UGFzcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fc2V0UmVzdWx0QXQoRlVMRklMTEVELCBpLCBlbnRyeSwgZmlyc3RQYXNzKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uX3NldHRsZWRBdCA9IGZ1bmN0aW9uIF9zZXR0bGVkQXQoc3RhdGUsIGksIHZhbHVlLCBmaXJzdFBhc3MpIHsKICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnByb21pc2U7CgogICAgICBpZiAocHJvbWlzZS5fc3RhdGUgPT09IFBFTkRJTkcpIHsKICAgICAgICBpZiAodGhpcy5fYWJvcnRPblJlamVjdCAmJiBzdGF0ZSA9PT0gUkVKRUNURUQpIHsKICAgICAgICAgIHJlamVjdChwcm9taXNlLCB2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX3NldFJlc3VsdEF0KHN0YXRlLCBpLCB2YWx1ZSwgZmlyc3RQYXNzKTsKCiAgICAgICAgICB0aGlzLl9jaGVja0Z1bGxmaWxsbWVudCgpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uX3NldFJlc3VsdEF0ID0gZnVuY3Rpb24gX3NldFJlc3VsdEF0KHN0YXRlLCBpLCB2YWx1ZSwgZmlyc3RQYXNzKSB7CiAgICAgIHRoaXMuX3JlbWFpbmluZy0tOwogICAgICB0aGlzLl9yZXN1bHRbaV0gPSB2YWx1ZTsKICAgIH07CgogICAgX3Byb3RvLl93aWxsU2V0dGxlQXQgPSBmdW5jdGlvbiBfd2lsbFNldHRsZUF0KHByb21pc2UsIGksIGZpcnN0UGFzcykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgc3Vic2NyaWJlKHByb21pc2UsIHVuZGVmaW5lZCwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIF90aGlzLl9zZXR0bGVkQXQoRlVMRklMTEVELCBpLCB2YWx1ZSwgZmlyc3RQYXNzKTsKICAgICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIHJldHVybiBfdGhpcy5fc2V0dGxlZEF0KFJFSkVDVEVELCBpLCByZWFzb24sIGZpcnN0UGFzcyk7CiAgICAgIH0pOwogICAgfTsKCiAgICByZXR1cm4gRW51bWVyYXRvcjsKICB9KCk7CgogIGZ1bmN0aW9uIHNldFNldHRsZWRSZXN1bHQoc3RhdGUsIGksIHZhbHVlKSB7CiAgICB0aGlzLl9yZW1haW5pbmctLTsKCiAgICBpZiAoc3RhdGUgPT09IEZVTEZJTExFRCkgewogICAgICB0aGlzLl9yZXN1bHRbaV0gPSB7CiAgICAgICAgc3RhdGU6ICdmdWxmaWxsZWQnLAogICAgICAgIHZhbHVlOiB2YWx1ZQogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fcmVzdWx0W2ldID0gewogICAgICAgIHN0YXRlOiAncmVqZWN0ZWQnLAogICAgICAgIHJlYXNvbjogdmFsdWUKICAgICAgfTsKICAgIH0KICB9CiAgLyoqCiAgICBgUHJvbWlzZS5hbGxgIGFjY2VwdHMgYW4gYXJyYXkgb2YgcHJvbWlzZXMsIGFuZCByZXR1cm5zIGEgbmV3IHByb21pc2Ugd2hpY2gKICAgIGlzIGZ1bGZpbGxlZCB3aXRoIGFuIGFycmF5IG9mIGZ1bGZpbGxtZW50IHZhbHVlcyBmb3IgdGhlIHBhc3NlZCBwcm9taXNlcywgb3IKICAgIHJlamVjdGVkIHdpdGggdGhlIHJlYXNvbiBvZiB0aGUgZmlyc3QgcGFzc2VkIHByb21pc2UgdG8gYmUgcmVqZWN0ZWQuIEl0IGNhc3RzIGFsbAogICAgZWxlbWVudHMgb2YgdGhlIHBhc3NlZCBpdGVyYWJsZSB0byBwcm9taXNlcyBhcyBpdCBydW5zIHRoaXMgYWxnb3JpdGhtLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBQcm9taXNlLCB7IHJlc29sdmUgfSBmcm9tICdyc3ZwJzsKICAKICAgIGxldCBwcm9taXNlMSA9IHJlc29sdmUoMSk7CiAgICBsZXQgcHJvbWlzZTIgPSByZXNvbHZlKDIpOwogICAgbGV0IHByb21pc2UzID0gcmVzb2x2ZSgzKTsKICAgIGxldCBwcm9taXNlcyA9IFsgcHJvbWlzZTEsIHByb21pc2UyLCBwcm9taXNlMyBdOwogIAogICAgUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4oZnVuY3Rpb24oYXJyYXkpewogICAgICAvLyBUaGUgYXJyYXkgaGVyZSB3b3VsZCBiZSBbIDEsIDIsIDMgXTsKICAgIH0pOwogICAgYGBgCiAgCiAgICBJZiBhbnkgb2YgdGhlIGBwcm9taXNlc2AgZ2l2ZW4gdG8gYFJTVlAuYWxsYCBhcmUgcmVqZWN0ZWQsIHRoZSBmaXJzdCBwcm9taXNlCiAgICB0aGF0IGlzIHJlamVjdGVkIHdpbGwgYmUgZ2l2ZW4gYXMgYW4gYXJndW1lbnQgdG8gdGhlIHJldHVybmVkIHByb21pc2VzJ3MKICAgIHJlamVjdGlvbiBoYW5kbGVyLiBGb3IgZXhhbXBsZToKICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgUHJvbWlzZSwgeyByZXNvbHZlLCByZWplY3QgfSBmcm9tICdyc3ZwJzsKICAKICAgIGxldCBwcm9taXNlMSA9IHJlc29sdmUoMSk7CiAgICBsZXQgcHJvbWlzZTIgPSByZWplY3QobmV3IEVycm9yKCIyIikpOwogICAgbGV0IHByb21pc2UzID0gcmVqZWN0KG5ldyBFcnJvcigiMyIpKTsKICAgIGxldCBwcm9taXNlcyA9IFsgcHJvbWlzZTEsIHByb21pc2UyLCBwcm9taXNlMyBdOwogIAogICAgUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4oZnVuY3Rpb24oYXJyYXkpewogICAgICAvLyBDb2RlIGhlcmUgbmV2ZXIgcnVucyBiZWNhdXNlIHRoZXJlIGFyZSByZWplY3RlZCBwcm9taXNlcyEKICAgIH0sIGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgIC8vIGVycm9yLm1lc3NhZ2UgPT09ICIyIgogICAgfSk7CiAgICBgYGAKICAKICAgIEBtZXRob2QgYWxsCiAgICBAZm9yIFByb21pc2UKICAgIEBwYXJhbSB7QXJyYXl9IGVudHJpZXMgYXJyYXkgb2YgcHJvbWlzZXMKICAgIEBwYXJhbSB7U3RyaW5nfSBbbGFiZWxdIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIHRoYXQgaXMgZnVsZmlsbGVkIHdoZW4gYWxsIGBwcm9taXNlc2AgaGF2ZSBiZWVuCiAgICBmdWxmaWxsZWQsIG9yIHJlamVjdGVkIGlmIGFueSBvZiB0aGVtIGJlY29tZSByZWplY3RlZC4KICAgIEBzdGF0aWMKICAqLwoKCiAgZnVuY3Rpb24gYWxsKGVudHJpZXMsIGxhYmVsKSB7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZW50cmllcykpIHsKICAgICAgcmV0dXJuIHRoaXMucmVqZWN0KG5ldyBUeXBlRXJyb3IoIlByb21pc2UuYWxsIG11c3QgYmUgY2FsbGVkIHdpdGggYW4gYXJyYXkiKSwgbGFiZWwpOwogICAgfQoKICAgIHJldHVybiBuZXcgRW51bWVyYXRvcih0aGlzLCBlbnRyaWVzLCB0cnVlCiAgICAvKiBhYm9ydCBvbiByZWplY3QgKi8KICAgICwgbGFiZWwpLnByb21pc2U7CiAgfQogIC8qKgogICAgYFByb21pc2UucmFjZWAgcmV0dXJucyBhIG5ldyBwcm9taXNlIHdoaWNoIGlzIHNldHRsZWQgaW4gdGhlIHNhbWUgd2F5IGFzIHRoZQogICAgZmlyc3QgcGFzc2VkIHByb21pc2UgdG8gc2V0dGxlLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBQcm9taXNlIGZyb20gJ3JzdnAnOwogIAogICAgbGV0IHByb21pc2UxID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KXsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgIHJlc29sdmUoJ3Byb21pc2UgMScpOwogICAgICB9LCAyMDApOwogICAgfSk7CiAgCiAgICBsZXQgcHJvbWlzZTIgPSBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpewogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgcmVzb2x2ZSgncHJvbWlzZSAyJyk7CiAgICAgIH0sIDEwMCk7CiAgICB9KTsKICAKICAgIFByb21pc2UucmFjZShbcHJvbWlzZTEsIHByb21pc2UyXSkudGhlbihmdW5jdGlvbihyZXN1bHQpewogICAgICAvLyByZXN1bHQgPT09ICdwcm9taXNlIDInIGJlY2F1c2UgaXQgd2FzIHJlc29sdmVkIGJlZm9yZSBwcm9taXNlMQogICAgICAvLyB3YXMgcmVzb2x2ZWQuCiAgICB9KTsKICAgIGBgYAogIAogICAgYFByb21pc2UucmFjZWAgaXMgZGV0ZXJtaW5pc3RpYyBpbiB0aGF0IG9ubHkgdGhlIHN0YXRlIG9mIHRoZSBmaXJzdAogICAgc2V0dGxlZCBwcm9taXNlIG1hdHRlcnMuIEZvciBleGFtcGxlLCBldmVuIGlmIG90aGVyIHByb21pc2VzIGdpdmVuIHRvIHRoZQogICAgYHByb21pc2VzYCBhcnJheSBhcmd1bWVudCBhcmUgcmVzb2x2ZWQsIGJ1dCB0aGUgZmlyc3Qgc2V0dGxlZCBwcm9taXNlIGhhcwogICAgYmVjb21lIHJlamVjdGVkIGJlZm9yZSB0aGUgb3RoZXIgcHJvbWlzZXMgYmVjYW1lIGZ1bGZpbGxlZCwgdGhlIHJldHVybmVkCiAgICBwcm9taXNlIHdpbGwgYmVjb21lIHJlamVjdGVkOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IFByb21pc2UgZnJvbSAncnN2cCc7CiAgCiAgICBsZXQgcHJvbWlzZTEgPSBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpewogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgcmVzb2x2ZSgncHJvbWlzZSAxJyk7CiAgICAgIH0sIDIwMCk7CiAgICB9KTsKICAKICAgIGxldCBwcm9taXNlMiA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCl7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICByZWplY3QobmV3IEVycm9yKCdwcm9taXNlIDInKSk7CiAgICAgIH0sIDEwMCk7CiAgICB9KTsKICAKICAgIFByb21pc2UucmFjZShbcHJvbWlzZTEsIHByb21pc2UyXSkudGhlbihmdW5jdGlvbihyZXN1bHQpewogICAgICAvLyBDb2RlIGhlcmUgbmV2ZXIgcnVucwogICAgfSwgZnVuY3Rpb24ocmVhc29uKXsKICAgICAgLy8gcmVhc29uLm1lc3NhZ2UgPT09ICdwcm9taXNlIDInIGJlY2F1c2UgcHJvbWlzZSAyIGJlY2FtZSByZWplY3RlZCBiZWZvcmUKICAgICAgLy8gcHJvbWlzZSAxIGJlY2FtZSBmdWxmaWxsZWQKICAgIH0pOwogICAgYGBgCiAgCiAgICBBbiBleGFtcGxlIHJlYWwtd29ybGQgdXNlIGNhc2UgaXMgaW1wbGVtZW50aW5nIHRpbWVvdXRzOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IFByb21pc2UgZnJvbSAncnN2cCc7CiAgCiAgICBQcm9taXNlLnJhY2UoW2FqYXgoJ2Zvby5qc29uJyksIHRpbWVvdXQoNTAwMCldKQogICAgYGBgCiAgCiAgICBAbWV0aG9kIHJhY2UKICAgIEBmb3IgUHJvbWlzZQogICAgQHN0YXRpYwogICAgQHBhcmFtIHtBcnJheX0gZW50cmllcyBhcnJheSBvZiBwcm9taXNlcyB0byBvYnNlcnZlCiAgICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsXSBvcHRpb25hbCBzdHJpbmcgZm9yIGRlc2NyaWJpbmcgdGhlIHByb21pc2UgcmV0dXJuZWQuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2Ugd2hpY2ggc2V0dGxlcyBpbiB0aGUgc2FtZSB3YXkgYXMgdGhlIGZpcnN0IHBhc3NlZAogICAgcHJvbWlzZSB0byBzZXR0bGUuCiAgKi8KCgogIGZ1bmN0aW9uIHJhY2UoZW50cmllcywgbGFiZWwpIHsKICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovCiAgICB2YXIgQ29uc3RydWN0b3IgPSB0aGlzOwogICAgdmFyIHByb21pc2UgPSBuZXcgQ29uc3RydWN0b3Iobm9vcCwgbGFiZWwpOwoKICAgIGlmICghQXJyYXkuaXNBcnJheShlbnRyaWVzKSkgewogICAgICByZWplY3QocHJvbWlzZSwgbmV3IFR5cGVFcnJvcignUHJvbWlzZS5yYWNlIG11c3QgYmUgY2FsbGVkIHdpdGggYW4gYXJyYXknKSk7CiAgICAgIHJldHVybiBwcm9taXNlOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwOyBwcm9taXNlLl9zdGF0ZSA9PT0gUEVORElORyAmJiBpIDwgZW50cmllcy5sZW5ndGg7IGkrKykgewogICAgICBzdWJzY3JpYmUoQ29uc3RydWN0b3IucmVzb2x2ZShlbnRyaWVzW2ldKSwgdW5kZWZpbmVkLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICByZXR1cm4gcmVzb2x2ZSQxKHByb21pc2UsIHZhbHVlKTsKICAgICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIHJldHVybiByZWplY3QocHJvbWlzZSwgcmVhc29uKTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIHByb21pc2U7CiAgfQogIC8qKgogICAgYFByb21pc2UucmVqZWN0YCByZXR1cm5zIGEgcHJvbWlzZSByZWplY3RlZCB3aXRoIHRoZSBwYXNzZWQgYHJlYXNvbmAuCiAgICBJdCBpcyBzaG9ydGhhbmQgZm9yIHRoZSBmb2xsb3dpbmc6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgUHJvbWlzZSBmcm9tICdyc3ZwJzsKICAKICAgIGxldCBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KXsKICAgICAgcmVqZWN0KG5ldyBFcnJvcignV0hPT1BTJykpOwogICAgfSk7CiAgCiAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsdWUpewogICAgICAvLyBDb2RlIGhlcmUgZG9lc24ndCBydW4gYmVjYXVzZSB0aGUgcHJvbWlzZSBpcyByZWplY3RlZCEKICAgIH0sIGZ1bmN0aW9uKHJlYXNvbil7CiAgICAgIC8vIHJlYXNvbi5tZXNzYWdlID09PSAnV0hPT1BTJwogICAgfSk7CiAgICBgYGAKICAKICAgIEluc3RlYWQgb2Ygd3JpdGluZyB0aGUgYWJvdmUsIHlvdXIgY29kZSBub3cgc2ltcGx5IGJlY29tZXMgdGhlIGZvbGxvd2luZzoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBQcm9taXNlIGZyb20gJ3JzdnAnOwogIAogICAgbGV0IHByb21pc2UgPSBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ1dIT09QUycpKTsKICAKICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSl7CiAgICAgIC8vIENvZGUgaGVyZSBkb2Vzbid0IHJ1biBiZWNhdXNlIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkIQogICAgfSwgZnVuY3Rpb24ocmVhc29uKXsKICAgICAgLy8gcmVhc29uLm1lc3NhZ2UgPT09ICdXSE9PUFMnCiAgICB9KTsKICAgIGBgYAogIAogICAgQG1ldGhvZCByZWplY3QKICAgIEBmb3IgUHJvbWlzZQogICAgQHN0YXRpYwogICAgQHBhcmFtIHsqfSByZWFzb24gdmFsdWUgdGhhdCB0aGUgcmV0dXJuZWQgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkIHdpdGguCiAgICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsXSBvcHRpb25hbCBzdHJpbmcgZm9yIGlkZW50aWZ5aW5nIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAgVXNlZnVsIGZvciB0b29saW5nLgogICAgQHJldHVybiB7UHJvbWlzZX0gYSBwcm9taXNlIHJlamVjdGVkIHdpdGggdGhlIGdpdmVuIGByZWFzb25gLgogICovCgoKICBmdW5jdGlvbiByZWplY3QkMShyZWFzb24sIGxhYmVsKSB7CiAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgdmFyIENvbnN0cnVjdG9yID0gdGhpczsKICAgIHZhciBwcm9taXNlID0gbmV3IENvbnN0cnVjdG9yKG5vb3AsIGxhYmVsKTsKICAgIHJlamVjdChwcm9taXNlLCByZWFzb24pOwogICAgcmV0dXJuIHByb21pc2U7CiAgfQoKICB2YXIgZ3VpZEtleSA9ICdyc3ZwXycgKyBEYXRlLm5vdygpICsgJy0nOwogIHZhciBjb3VudGVyID0gMDsKCiAgZnVuY3Rpb24gbmVlZHNSZXNvbHZlcigpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1lvdSBtdXN0IHBhc3MgYSByZXNvbHZlciBmdW5jdGlvbiBhcyB0aGUgZmlyc3QgYXJndW1lbnQgdG8gdGhlIHByb21pc2UgY29uc3RydWN0b3InKTsKICB9CgogIGZ1bmN0aW9uIG5lZWRzTmV3KCkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiRmFpbGVkIHRvIGNvbnN0cnVjdCAnUHJvbWlzZSc6IFBsZWFzZSB1c2UgdGhlICduZXcnIG9wZXJhdG9yLCB0aGlzIG9iamVjdCBjb25zdHJ1Y3RvciBjYW5ub3QgYmUgY2FsbGVkIGFzIGEgZnVuY3Rpb24uIik7CiAgfQogIC8qKgogICAgUHJvbWlzZSBvYmplY3RzIHJlcHJlc2VudCB0aGUgZXZlbnR1YWwgcmVzdWx0IG9mIGFuIGFzeW5jaHJvbm91cyBvcGVyYXRpb24uIFRoZQogICAgcHJpbWFyeSB3YXkgb2YgaW50ZXJhY3Rpbmcgd2l0aCBhIHByb21pc2UgaXMgdGhyb3VnaCBpdHMgYHRoZW5gIG1ldGhvZCwgd2hpY2gKICAgIHJlZ2lzdGVycyBjYWxsYmFja3MgdG8gcmVjZWl2ZSBlaXRoZXIgYSBwcm9taXNl4oCZcyBldmVudHVhbCB2YWx1ZSBvciB0aGUgcmVhc29uCiAgICB3aHkgdGhlIHByb21pc2UgY2Fubm90IGJlIGZ1bGZpbGxlZC4KICAKICAgIFRlcm1pbm9sb2d5CiAgICAtLS0tLS0tLS0tLQogIAogICAgLSBgcHJvbWlzZWAgaXMgYW4gb2JqZWN0IG9yIGZ1bmN0aW9uIHdpdGggYSBgdGhlbmAgbWV0aG9kIHdob3NlIGJlaGF2aW9yIGNvbmZvcm1zIHRvIHRoaXMgc3BlY2lmaWNhdGlvbi4KICAgIC0gYHRoZW5hYmxlYCBpcyBhbiBvYmplY3Qgb3IgZnVuY3Rpb24gdGhhdCBkZWZpbmVzIGEgYHRoZW5gIG1ldGhvZC4KICAgIC0gYHZhbHVlYCBpcyBhbnkgbGVnYWwgSmF2YVNjcmlwdCB2YWx1ZSAoaW5jbHVkaW5nIHVuZGVmaW5lZCwgYSB0aGVuYWJsZSwgb3IgYSBwcm9taXNlKS4KICAgIC0gYGV4Y2VwdGlvbmAgaXMgYSB2YWx1ZSB0aGF0IGlzIHRocm93biB1c2luZyB0aGUgdGhyb3cgc3RhdGVtZW50LgogICAgLSBgcmVhc29uYCBpcyBhIHZhbHVlIHRoYXQgaW5kaWNhdGVzIHdoeSBhIHByb21pc2Ugd2FzIHJlamVjdGVkLgogICAgLSBgc2V0dGxlZGAgdGhlIGZpbmFsIHJlc3Rpbmcgc3RhdGUgb2YgYSBwcm9taXNlLCBmdWxmaWxsZWQgb3IgcmVqZWN0ZWQuCiAgCiAgICBBIHByb21pc2UgY2FuIGJlIGluIG9uZSBvZiB0aHJlZSBzdGF0ZXM6IHBlbmRpbmcsIGZ1bGZpbGxlZCwgb3IgcmVqZWN0ZWQuCiAgCiAgICBQcm9taXNlcyB0aGF0IGFyZSBmdWxmaWxsZWQgaGF2ZSBhIGZ1bGZpbGxtZW50IHZhbHVlIGFuZCBhcmUgaW4gdGhlIGZ1bGZpbGxlZAogICAgc3RhdGUuICBQcm9taXNlcyB0aGF0IGFyZSByZWplY3RlZCBoYXZlIGEgcmVqZWN0aW9uIHJlYXNvbiBhbmQgYXJlIGluIHRoZQogICAgcmVqZWN0ZWQgc3RhdGUuICBBIGZ1bGZpbGxtZW50IHZhbHVlIGlzIG5ldmVyIGEgdGhlbmFibGUuCiAgCiAgICBQcm9taXNlcyBjYW4gYWxzbyBiZSBzYWlkIHRvICpyZXNvbHZlKiBhIHZhbHVlLiAgSWYgdGhpcyB2YWx1ZSBpcyBhbHNvIGEKICAgIHByb21pc2UsIHRoZW4gdGhlIG9yaWdpbmFsIHByb21pc2UncyBzZXR0bGVkIHN0YXRlIHdpbGwgbWF0Y2ggdGhlIHZhbHVlJ3MKICAgIHNldHRsZWQgc3RhdGUuICBTbyBhIHByb21pc2UgdGhhdCAqcmVzb2x2ZXMqIGEgcHJvbWlzZSB0aGF0IHJlamVjdHMgd2lsbAogICAgaXRzZWxmIHJlamVjdCwgYW5kIGEgcHJvbWlzZSB0aGF0ICpyZXNvbHZlcyogYSBwcm9taXNlIHRoYXQgZnVsZmlsbHMgd2lsbAogICAgaXRzZWxmIGZ1bGZpbGwuCiAgCiAgCiAgICBCYXNpYyBVc2FnZToKICAgIC0tLS0tLS0tLS0tLQogIAogICAgYGBganMKICAgIGxldCBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIC8vIG9uIHN1Y2Nlc3MKICAgICAgcmVzb2x2ZSh2YWx1ZSk7CiAgCiAgICAgIC8vIG9uIGZhaWx1cmUKICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICB9KTsKICAKICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSkgewogICAgICAvLyBvbiBmdWxmaWxsbWVudAogICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgIC8vIG9uIHJlamVjdGlvbgogICAgfSk7CiAgICBgYGAKICAKICAgIEFkdmFuY2VkIFVzYWdlOgogICAgLS0tLS0tLS0tLS0tLS0tCiAgCiAgICBQcm9taXNlcyBzaGluZSB3aGVuIGFic3RyYWN0aW5nIGF3YXkgYXN5bmNocm9ub3VzIGludGVyYWN0aW9ucyBzdWNoIGFzCiAgICBgWE1MSHR0cFJlcXVlc3Rgcy4KICAKICAgIGBgYGpzCiAgICBmdW5jdGlvbiBnZXRKU09OKHVybCkgewogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KXsKICAgICAgICBsZXQgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgCiAgICAgICAgeGhyLm9wZW4oJ0dFVCcsIHVybCk7CiAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGhhbmRsZXI7CiAgICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9ICdqc29uJzsKICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignQWNjZXB0JywgJ2FwcGxpY2F0aW9uL2pzb24nKTsKICAgICAgICB4aHIuc2VuZCgpOwogIAogICAgICAgIGZ1bmN0aW9uIGhhbmRsZXIoKSB7CiAgICAgICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID09PSB0aGlzLkRPTkUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgICByZXNvbHZlKHRoaXMucmVzcG9uc2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ2dldEpTT046IGAnICsgdXJsICsgJ2AgZmFpbGVkIHdpdGggc3RhdHVzOiBbJyArIHRoaXMuc3RhdHVzICsgJ10nKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9KTsKICAgIH0KICAKICAgIGdldEpTT04oJy9wb3N0cy5qc29uJykudGhlbihmdW5jdGlvbihqc29uKSB7CiAgICAgIC8vIG9uIGZ1bGZpbGxtZW50CiAgICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgLy8gb24gcmVqZWN0aW9uCiAgICB9KTsKICAgIGBgYAogIAogICAgVW5saWtlIGNhbGxiYWNrcywgcHJvbWlzZXMgYXJlIGdyZWF0IGNvbXBvc2FibGUgcHJpbWl0aXZlcy4KICAKICAgIGBgYGpzCiAgICBQcm9taXNlLmFsbChbCiAgICAgIGdldEpTT04oJy9wb3N0cycpLAogICAgICBnZXRKU09OKCcvY29tbWVudHMnKQogICAgXSkudGhlbihmdW5jdGlvbih2YWx1ZXMpewogICAgICB2YWx1ZXNbMF0gLy8gPT4gcG9zdHNKU09OCiAgICAgIHZhbHVlc1sxXSAvLyA9PiBjb21tZW50c0pTT04KICAKICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH0pOwogICAgYGBgCiAgCiAgICBAY2xhc3MgUHJvbWlzZQogICAgQHB1YmxpYwogICAgQHBhcmFtIHtmdW5jdGlvbn0gcmVzb2x2ZXIKICAgIEBwYXJhbSB7U3RyaW5nfSBbbGFiZWxdIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAY29uc3RydWN0b3IKICAqLwoKCiAgdmFyIFByb21pc2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBQcm9taXNlKHJlc29sdmVyLCBsYWJlbCkgewogICAgICB0aGlzLl9pZCA9IGNvdW50ZXIrKzsKICAgICAgdGhpcy5fbGFiZWwgPSBsYWJlbDsKICAgICAgdGhpcy5fc3RhdGUgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuX3Jlc3VsdCA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5fc3Vic2NyaWJlcnMgPSBbXTsKICAgICAgY29uZmlnLmluc3RydW1lbnQgJiYgaW5zdHJ1bWVudCgnY3JlYXRlZCcsIHRoaXMpOwoKICAgICAgaWYgKG5vb3AgIT09IHJlc29sdmVyKSB7CiAgICAgICAgdHlwZW9mIHJlc29sdmVyICE9PSAnZnVuY3Rpb24nICYmIG5lZWRzUmVzb2x2ZXIoKTsKICAgICAgICB0aGlzIGluc3RhbmNlb2YgUHJvbWlzZSA/IGluaXRpYWxpemVQcm9taXNlKHRoaXMsIHJlc29sdmVyKSA6IG5lZWRzTmV3KCk7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgX3Byb3RvMiA9IFByb21pc2UucHJvdG90eXBlOwoKICAgIF9wcm90bzIuX29uRXJyb3IgPSBmdW5jdGlvbiBfb25FcnJvcihyZWFzb24pIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICBjb25maWcuYWZ0ZXIoZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChfdGhpczIuX29uRXJyb3IpIHsKICAgICAgICAgIGNvbmZpZy50cmlnZ2VyKCdlcnJvcicsIHJlYXNvbiwgX3RoaXMyLl9sYWJlbCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIC8qKgogICAgICBgY2F0Y2hgIGlzIHNpbXBseSBzdWdhciBmb3IgYHRoZW4odW5kZWZpbmVkLCBvblJlamVjdGlvbilgIHdoaWNoIG1ha2VzIGl0IHRoZSBzYW1lCiAgICAgIGFzIHRoZSBjYXRjaCBibG9jayBvZiBhIHRyeS9jYXRjaCBzdGF0ZW1lbnQuCiAgICAKICAgICAgYGBganMKICAgICAgZnVuY3Rpb24gZmluZEF1dGhvcigpewogICAgICAgIHRocm93IG5ldyBFcnJvcignY291bGRuXCd0IGZpbmQgdGhhdCBhdXRob3InKTsKICAgICAgfQogICAgCiAgICAgIC8vIHN5bmNocm9ub3VzCiAgICAgIHRyeSB7CiAgICAgICAgZmluZEF1dGhvcigpOwogICAgICB9IGNhdGNoKHJlYXNvbikgewogICAgICAgIC8vIHNvbWV0aGluZyB3ZW50IHdyb25nCiAgICAgIH0KICAgIAogICAgICAvLyBhc3luYyB3aXRoIHByb21pc2VzCiAgICAgIGZpbmRBdXRob3IoKS5jYXRjaChmdW5jdGlvbihyZWFzb24pewogICAgICAgIC8vIHNvbWV0aGluZyB3ZW50IHdyb25nCiAgICAgIH0pOwogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIGNhdGNoCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IG9uUmVqZWN0aW9uCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBbbGFiZWxdIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgICAgIFVzZWZ1bCBmb3IgdG9vbGluZy4KICAgICAgQHJldHVybiB7UHJvbWlzZX0KICAgICovCiAgICA7CgogICAgX3Byb3RvMi5jYXRjaCA9IGZ1bmN0aW9uIF9jYXRjaChvblJlamVjdGlvbiwgbGFiZWwpIHsKICAgICAgcmV0dXJuIHRoaXMudGhlbih1bmRlZmluZWQsIG9uUmVqZWN0aW9uLCBsYWJlbCk7CiAgICB9CiAgICAvKioKICAgICAgYGZpbmFsbHlgIHdpbGwgYmUgaW52b2tlZCByZWdhcmRsZXNzIG9mIHRoZSBwcm9taXNlJ3MgZmF0ZSBqdXN0IGFzIG5hdGl2ZQogICAgICB0cnkvY2F0Y2gvZmluYWxseSBiZWhhdmVzCiAgICAKICAgICAgU3luY2hyb25vdXMgZXhhbXBsZToKICAgIAogICAgICBgYGBqcwogICAgICBmaW5kQXV0aG9yKCkgewogICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gMC41KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBBdXRob3IoKTsKICAgICAgfQogICAgCiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGZpbmRBdXRob3IoKTsgLy8gc3VjY2VlZCBvciBmYWlsCiAgICAgIH0gY2F0Y2goZXJyb3IpIHsKICAgICAgICByZXR1cm4gZmluZE90aGVyQXV0aG9yKCk7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgLy8gYWx3YXlzIHJ1bnMKICAgICAgICAvLyBkb2Vzbid0IGFmZmVjdCB0aGUgcmV0dXJuIHZhbHVlCiAgICAgIH0KICAgICAgYGBgCiAgICAKICAgICAgQXN5bmNocm9ub3VzIGV4YW1wbGU6CiAgICAKICAgICAgYGBganMKICAgICAgZmluZEF1dGhvcigpLmNhdGNoKGZ1bmN0aW9uKHJlYXNvbil7CiAgICAgICAgcmV0dXJuIGZpbmRPdGhlckF1dGhvcigpOwogICAgICB9KS5maW5hbGx5KGZ1bmN0aW9uKCl7CiAgICAgICAgLy8gYXV0aG9yIHdhcyBlaXRoZXIgZm91bmQsIG9yIG5vdAogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgQG1ldGhvZCBmaW5hbGx5CiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBbbGFiZWxdIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgICAgIFVzZWZ1bCBmb3IgdG9vbGluZy4KICAgICAgQHJldHVybiB7UHJvbWlzZX0KICAgICovCiAgICA7CgogICAgX3Byb3RvMi5maW5hbGx5ID0gZnVuY3Rpb24gX2ZpbmFsbHkoY2FsbGJhY2ssIGxhYmVsKSB7CiAgICAgIHZhciBwcm9taXNlID0gdGhpczsKICAgICAgdmFyIGNvbnN0cnVjdG9yID0gcHJvbWlzZS5jb25zdHJ1Y3RvcjsKCiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgcmV0dXJuIGNvbnN0cnVjdG9yLnJlc29sdmUoY2FsbGJhY2soKSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0pOwogICAgICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgIHJldHVybiBjb25zdHJ1Y3Rvci5yZXNvbHZlKGNhbGxiYWNrKCkpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aHJvdyByZWFzb247CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgcmV0dXJuIHByb21pc2UudGhlbihjYWxsYmFjaywgY2FsbGJhY2spOwogICAgfTsKCiAgICByZXR1cm4gUHJvbWlzZTsKICB9KCk7CgogIF9leHBvcnRzLlByb21pc2UgPSBQcm9taXNlOwogIFByb21pc2UuY2FzdCA9IHJlc29sdmUkJDE7IC8vIGRlcHJlY2F0ZWQKCiAgUHJvbWlzZS5hbGwgPSBhbGw7CiAgUHJvbWlzZS5yYWNlID0gcmFjZTsKICBQcm9taXNlLnJlc29sdmUgPSByZXNvbHZlJCQxOwogIFByb21pc2UucmVqZWN0ID0gcmVqZWN0JDE7CiAgUHJvbWlzZS5wcm90b3R5cGUuX2d1aWRLZXkgPSBndWlkS2V5OwogIC8qKgogICAgVGhlIHByaW1hcnkgd2F5IG9mIGludGVyYWN0aW5nIHdpdGggYSBwcm9taXNlIGlzIHRocm91Z2ggaXRzIGB0aGVuYCBtZXRob2QsCiAgICB3aGljaCByZWdpc3RlcnMgY2FsbGJhY2tzIHRvIHJlY2VpdmUgZWl0aGVyIGEgcHJvbWlzZSdzIGV2ZW50dWFsIHZhbHVlIG9yIHRoZQogICAgcmVhc29uIHdoeSB0aGUgcHJvbWlzZSBjYW5ub3QgYmUgZnVsZmlsbGVkLgogIAogICAgYGBganMKICAgIGZpbmRVc2VyKCkudGhlbihmdW5jdGlvbih1c2VyKXsKICAgICAgLy8gdXNlciBpcyBhdmFpbGFibGUKICAgIH0sIGZ1bmN0aW9uKHJlYXNvbil7CiAgICAgIC8vIHVzZXIgaXMgdW5hdmFpbGFibGUsIGFuZCB5b3UgYXJlIGdpdmVuIHRoZSByZWFzb24gd2h5CiAgICB9KTsKICAgIGBgYAogIAogICAgQ2hhaW5pbmcKICAgIC0tLS0tLS0tCiAgCiAgICBUaGUgcmV0dXJuIHZhbHVlIG9mIGB0aGVuYCBpcyBpdHNlbGYgYSBwcm9taXNlLiAgVGhpcyBzZWNvbmQsICdkb3duc3RyZWFtJwogICAgcHJvbWlzZSBpcyByZXNvbHZlZCB3aXRoIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZpcnN0IHByb21pc2UncyBmdWxmaWxsbWVudAogICAgb3IgcmVqZWN0aW9uIGhhbmRsZXIsIG9yIHJlamVjdGVkIGlmIHRoZSBoYW5kbGVyIHRocm93cyBhbiBleGNlcHRpb24uCiAgCiAgICBgYGBqcwogICAgZmluZFVzZXIoKS50aGVuKGZ1bmN0aW9uICh1c2VyKSB7CiAgICAgIHJldHVybiB1c2VyLm5hbWU7CiAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgIHJldHVybiAnZGVmYXVsdCBuYW1lJzsKICAgIH0pLnRoZW4oZnVuY3Rpb24gKHVzZXJOYW1lKSB7CiAgICAgIC8vIElmIGBmaW5kVXNlcmAgZnVsZmlsbGVkLCBgdXNlck5hbWVgIHdpbGwgYmUgdGhlIHVzZXIncyBuYW1lLCBvdGhlcndpc2UgaXQKICAgICAgLy8gd2lsbCBiZSBgJ2RlZmF1bHQgbmFtZSdgCiAgICB9KTsKICAKICAgIGZpbmRVc2VyKCkudGhlbihmdW5jdGlvbiAodXNlcikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZvdW5kIHVzZXIsIGJ1dCBzdGlsbCB1bmhhcHB5Jyk7CiAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignYGZpbmRVc2VyYCByZWplY3RlZCBhbmQgd2VcJ3JlIHVuaGFwcHknKTsKICAgIH0pLnRoZW4oZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIC8vIG5ldmVyIHJlYWNoZWQKICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgLy8gaWYgYGZpbmRVc2VyYCBmdWxmaWxsZWQsIGByZWFzb25gIHdpbGwgYmUgJ0ZvdW5kIHVzZXIsIGJ1dCBzdGlsbCB1bmhhcHB5Jy4KICAgICAgLy8gSWYgYGZpbmRVc2VyYCByZWplY3RlZCwgYHJlYXNvbmAgd2lsbCBiZSAnYGZpbmRVc2VyYCByZWplY3RlZCBhbmQgd2VcJ3JlIHVuaGFwcHknLgogICAgfSk7CiAgICBgYGAKICAgIElmIHRoZSBkb3duc3RyZWFtIHByb21pc2UgZG9lcyBub3Qgc3BlY2lmeSBhIHJlamVjdGlvbiBoYW5kbGVyLCByZWplY3Rpb24gcmVhc29ucyB3aWxsIGJlIHByb3BhZ2F0ZWQgZnVydGhlciBkb3duc3RyZWFtLgogIAogICAgYGBganMKICAgIGZpbmRVc2VyKCkudGhlbihmdW5jdGlvbiAodXNlcikgewogICAgICB0aHJvdyBuZXcgUGVkYWdvZ2ljYWxFeGNlcHRpb24oJ1Vwc3RyZWFtIGVycm9yJyk7CiAgICB9KS50aGVuKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAvLyBuZXZlciByZWFjaGVkCiAgICB9KS50aGVuKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAvLyBuZXZlciByZWFjaGVkCiAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgIC8vIFRoZSBgUGVkZ2Fnb2NpYWxFeGNlcHRpb25gIGlzIHByb3BhZ2F0ZWQgYWxsIHRoZSB3YXkgZG93biB0byBoZXJlCiAgICB9KTsKICAgIGBgYAogIAogICAgQXNzaW1pbGF0aW9uCiAgICAtLS0tLS0tLS0tLS0KICAKICAgIFNvbWV0aW1lcyB0aGUgdmFsdWUgeW91IHdhbnQgdG8gcHJvcGFnYXRlIHRvIGEgZG93bnN0cmVhbSBwcm9taXNlIGNhbiBvbmx5IGJlCiAgICByZXRyaWV2ZWQgYXN5bmNocm9ub3VzbHkuIFRoaXMgY2FuIGJlIGFjaGlldmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgaW4gdGhlCiAgICBmdWxmaWxsbWVudCBvciByZWplY3Rpb24gaGFuZGxlci4gVGhlIGRvd25zdHJlYW0gcHJvbWlzZSB3aWxsIHRoZW4gYmUgcGVuZGluZwogICAgdW50aWwgdGhlIHJldHVybmVkIHByb21pc2UgaXMgc2V0dGxlZC4gVGhpcyBpcyBjYWxsZWQgKmFzc2ltaWxhdGlvbiouCiAgCiAgICBgYGBqcwogICAgZmluZFVzZXIoKS50aGVuKGZ1bmN0aW9uICh1c2VyKSB7CiAgICAgIHJldHVybiBmaW5kQ29tbWVudHNCeUF1dGhvcih1c2VyKTsKICAgIH0pLnRoZW4oZnVuY3Rpb24gKGNvbW1lbnRzKSB7CiAgICAgIC8vIFRoZSB1c2VyJ3MgY29tbWVudHMgYXJlIG5vdyBhdmFpbGFibGUKICAgIH0pOwogICAgYGBgCiAgCiAgICBJZiB0aGUgYXNzaW1saWF0ZWQgcHJvbWlzZSByZWplY3RzLCB0aGVuIHRoZSBkb3duc3RyZWFtIHByb21pc2Ugd2lsbCBhbHNvIHJlamVjdC4KICAKICAgIGBgYGpzCiAgICBmaW5kVXNlcigpLnRoZW4oZnVuY3Rpb24gKHVzZXIpIHsKICAgICAgcmV0dXJuIGZpbmRDb21tZW50c0J5QXV0aG9yKHVzZXIpOwogICAgfSkudGhlbihmdW5jdGlvbiAoY29tbWVudHMpIHsKICAgICAgLy8gSWYgYGZpbmRDb21tZW50c0J5QXV0aG9yYCBmdWxmaWxscywgd2UnbGwgaGF2ZSB0aGUgdmFsdWUgaGVyZQogICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAvLyBJZiBgZmluZENvbW1lbnRzQnlBdXRob3JgIHJlamVjdHMsIHdlJ2xsIGhhdmUgdGhlIHJlYXNvbiBoZXJlCiAgICB9KTsKICAgIGBgYAogIAogICAgU2ltcGxlIEV4YW1wbGUKICAgIC0tLS0tLS0tLS0tLS0tCiAgCiAgICBTeW5jaHJvbm91cyBFeGFtcGxlCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBsZXQgcmVzdWx0OwogIAogICAgdHJ5IHsKICAgICAgcmVzdWx0ID0gZmluZFJlc3VsdCgpOwogICAgICAvLyBzdWNjZXNzCiAgICB9IGNhdGNoKHJlYXNvbikgewogICAgICAvLyBmYWlsdXJlCiAgICB9CiAgICBgYGAKICAKICAgIEVycmJhY2sgRXhhbXBsZQogIAogICAgYGBganMKICAgIGZpbmRSZXN1bHQoZnVuY3Rpb24ocmVzdWx0LCBlcnIpewogICAgICBpZiAoZXJyKSB7CiAgICAgICAgLy8gZmFpbHVyZQogICAgICB9IGVsc2UgewogICAgICAgIC8vIHN1Y2Nlc3MKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIFByb21pc2UgRXhhbXBsZTsKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGZpbmRSZXN1bHQoKS50aGVuKGZ1bmN0aW9uKHJlc3VsdCl7CiAgICAgIC8vIHN1Y2Nlc3MKICAgIH0sIGZ1bmN0aW9uKHJlYXNvbil7CiAgICAgIC8vIGZhaWx1cmUKICAgIH0pOwogICAgYGBgCiAgCiAgICBBZHZhbmNlZCBFeGFtcGxlCiAgICAtLS0tLS0tLS0tLS0tLQogIAogICAgU3luY2hyb25vdXMgRXhhbXBsZQogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IGF1dGhvciwgYm9va3M7CiAgCiAgICB0cnkgewogICAgICBhdXRob3IgPSBmaW5kQXV0aG9yKCk7CiAgICAgIGJvb2tzICA9IGZpbmRCb29rc0J5QXV0aG9yKGF1dGhvcik7CiAgICAgIC8vIHN1Y2Nlc3MKICAgIH0gY2F0Y2gocmVhc29uKSB7CiAgICAgIC8vIGZhaWx1cmUKICAgIH0KICAgIGBgYAogIAogICAgRXJyYmFjayBFeGFtcGxlCiAgCiAgICBgYGBqcwogIAogICAgZnVuY3Rpb24gZm91bmRCb29rcyhib29rcykgewogIAogICAgfQogIAogICAgZnVuY3Rpb24gZmFpbHVyZShyZWFzb24pIHsKICAKICAgIH0KICAKICAgIGZpbmRBdXRob3IoZnVuY3Rpb24oYXV0aG9yLCBlcnIpewogICAgICBpZiAoZXJyKSB7CiAgICAgICAgZmFpbHVyZShlcnIpOwogICAgICAgIC8vIGZhaWx1cmUKICAgICAgfSBlbHNlIHsKICAgICAgICB0cnkgewogICAgICAgICAgZmluZEJvb29rc0J5QXV0aG9yKGF1dGhvciwgZnVuY3Rpb24oYm9va3MsIGVycikgewogICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgZmFpbHVyZShlcnIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBmb3VuZEJvb2tzKGJvb2tzKTsKICAgICAgICAgICAgICB9IGNhdGNoKHJlYXNvbikgewogICAgICAgICAgICAgICAgZmFpbHVyZShyZWFzb24pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBjYXRjaChlcnJvcikgewogICAgICAgICAgZmFpbHVyZShlcnIpOwogICAgICAgIH0KICAgICAgICAvLyBzdWNjZXNzCiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBQcm9taXNlIEV4YW1wbGU7CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBmaW5kQXV0aG9yKCkuCiAgICAgIHRoZW4oZmluZEJvb2tzQnlBdXRob3IpLgogICAgICB0aGVuKGZ1bmN0aW9uKGJvb2tzKXsKICAgICAgICAvLyBmb3VuZCBib29rcwogICAgfSkuY2F0Y2goZnVuY3Rpb24ocmVhc29uKXsKICAgICAgLy8gc29tZXRoaW5nIHdlbnQgd3JvbmcKICAgIH0pOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIHRoZW4KICAgIEBwYXJhbSB7RnVuY3Rpb259IG9uRnVsZmlsbG1lbnQKICAgIEBwYXJhbSB7RnVuY3Rpb259IG9uUmVqZWN0aW9uCiAgICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsXSBvcHRpb25hbCBzdHJpbmcgZm9yIGxhYmVsaW5nIHRoZSBwcm9taXNlLgogICAgVXNlZnVsIGZvciB0b29saW5nLgogICAgQHJldHVybiB7UHJvbWlzZX0KICAqLwoKICBQcm9taXNlLnByb3RvdHlwZS50aGVuID0gdGhlbjsKCiAgZnVuY3Rpb24gbWFrZU9iamVjdChfLCBhcmd1bWVudE5hbWVzKSB7CiAgICB2YXIgb2JqID0ge307CiAgICB2YXIgbGVuZ3RoID0gXy5sZW5ndGg7CiAgICB2YXIgYXJncyA9IG5ldyBBcnJheShsZW5ndGgpOwoKICAgIGZvciAodmFyIHggPSAwOyB4IDwgbGVuZ3RoOyB4KyspIHsKICAgICAgYXJnc1t4XSA9IF9beF07CiAgICB9CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudE5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBuYW1lID0gYXJndW1lbnROYW1lc1tpXTsKICAgICAgb2JqW25hbWVdID0gYXJnc1tpICsgMV07CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9CgogIGZ1bmN0aW9uIGFycmF5UmVzdWx0KF8pIHsKICAgIHZhciBsZW5ndGggPSBfLmxlbmd0aDsKICAgIHZhciBhcmdzID0gbmV3IEFycmF5KGxlbmd0aCAtIDEpOwoKICAgIGZvciAodmFyIGkgPSAxOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgYXJnc1tpIC0gMV0gPSBfW2ldOwogICAgfQoKICAgIHJldHVybiBhcmdzOwogIH0KCiAgZnVuY3Rpb24gd3JhcFRoZW5hYmxlKF90aGVuLCBwcm9taXNlKSB7CiAgICByZXR1cm4gewogICAgICB0aGVuOiBmdW5jdGlvbiB0aGVuKG9uRnVsRmlsbG1lbnQsIG9uUmVqZWN0aW9uKSB7CiAgICAgICAgcmV0dXJuIF90aGVuLmNhbGwocHJvbWlzZSwgb25GdWxGaWxsbWVudCwgb25SZWplY3Rpb24pOwogICAgICB9CiAgICB9OwogIH0KICAvKioKICAgIGBkZW5vZGVpZnlgIHRha2VzIGEgJ25vZGUtc3R5bGUnIGZ1bmN0aW9uIGFuZCByZXR1cm5zIGEgZnVuY3Rpb24gdGhhdAogICAgd2lsbCByZXR1cm4gYW4gYFByb21pc2VgLiBZb3UgY2FuIHVzZSBgZGVub2RlaWZ5YCBpbiBOb2RlLmpzIG9yIHRoZQogICAgYnJvd3NlciB3aGVuIHlvdSdkIHByZWZlciB0byB1c2UgcHJvbWlzZXMgb3ZlciB1c2luZyBjYWxsYmFja3MuIEZvciBleGFtcGxlLAogICAgYGRlbm9kZWlmeWAgdHJhbnNmb3JtcyB0aGUgZm9sbG93aW5nOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IGZzID0gcmVxdWlyZSgnZnMnKTsKICAKICAgIGZzLnJlYWRGaWxlKCdteWZpbGUudHh0JywgZnVuY3Rpb24oZXJyLCBkYXRhKXsKICAgICAgaWYgKGVycikgcmV0dXJuIGhhbmRsZUVycm9yKGVycik7CiAgICAgIGhhbmRsZURhdGEoZGF0YSk7CiAgICB9KTsKICAgIGBgYAogIAogICAgaW50bzoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCBmcyA9IHJlcXVpcmUoJ2ZzJyk7CiAgICBsZXQgcmVhZEZpbGUgPSBkZW5vZGVpZnkoZnMucmVhZEZpbGUpOwogIAogICAgcmVhZEZpbGUoJ215ZmlsZS50eHQnKS50aGVuKGhhbmRsZURhdGEsIGhhbmRsZUVycm9yKTsKICAgIGBgYAogIAogICAgSWYgdGhlIG5vZGUgZnVuY3Rpb24gaGFzIG11bHRpcGxlIHN1Y2Nlc3MgcGFyYW1ldGVycywgdGhlbiBgZGVub2RlaWZ5YAogICAganVzdCByZXR1cm5zIHRoZSBmaXJzdCBvbmU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBsZXQgcmVxdWVzdCA9IGRlbm9kZWlmeShyZXF1aXJlKCdyZXF1ZXN0JykpOwogIAogICAgcmVxdWVzdCgnaHR0cDovL2V4YW1wbGUuY29tJykudGhlbihmdW5jdGlvbihyZXMpIHsKICAgICAgLy8gLi4uCiAgICB9KTsKICAgIGBgYAogIAogICAgSG93ZXZlciwgaWYgeW91IG5lZWQgYWxsIHN1Y2Nlc3MgcGFyYW1ldGVycywgc2V0dGluZyBgZGVub2RlaWZ5YCdzCiAgICBzZWNvbmQgcGFyYW1ldGVyIHRvIGB0cnVlYCBjYXVzZXMgaXQgdG8gcmV0dXJuIGFsbCBzdWNjZXNzIHBhcmFtZXRlcnMKICAgIGFzIGFuIGFycmF5OgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHJlcXVlc3QgPSBkZW5vZGVpZnkocmVxdWlyZSgncmVxdWVzdCcpLCB0cnVlKTsKICAKICAgIHJlcXVlc3QoJ2h0dHA6Ly9leGFtcGxlLmNvbScpLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgIC8vIHJlc3VsdFswXSAtPiByZXMKICAgICAgLy8gcmVzdWx0WzFdIC0+IGJvZHkKICAgIH0pOwogICAgYGBgCiAgCiAgICBPciBpZiB5b3UgcGFzcyBpdCBhbiBhcnJheSB3aXRoIG5hbWVzIGl0IHJldHVybnMgdGhlIHBhcmFtZXRlcnMgYXMgYSBoYXNoOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHJlcXVlc3QgPSBkZW5vZGVpZnkocmVxdWlyZSgncmVxdWVzdCcpLCBbJ3JlcycsICdib2R5J10pOwogIAogICAgcmVxdWVzdCgnaHR0cDovL2V4YW1wbGUuY29tJykudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgLy8gcmVzdWx0LnJlcwogICAgICAvLyByZXN1bHQuYm9keQogICAgfSk7CiAgICBgYGAKICAKICAgIFNvbWV0aW1lcyB5b3UgbmVlZCB0byByZXRhaW4gdGhlIGB0aGlzYDoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCBhcHAgPSByZXF1aXJlKCdleHByZXNzJykoKTsKICAgIGxldCByZW5kZXIgPSBkZW5vZGVpZnkoYXBwLnJlbmRlci5iaW5kKGFwcCkpOwogICAgYGBgCiAgCiAgICBUaGUgZGVub2RpZmllZCBmdW5jdGlvbiBpbmhlcml0cyBmcm9tIHRoZSBvcmlnaW5hbCBmdW5jdGlvbi4gSXQgd29ya3MgaW4gYWxsCiAgICBlbnZpcm9ubWVudHMsIGV4Y2VwdCBJRSAxMCBhbmQgYmVsb3cuIENvbnNlcXVlbnRseSBhbGwgcHJvcGVydGllcyBvZiB0aGUgb3JpZ2luYWwKICAgIGZ1bmN0aW9uIGFyZSBhdmFpbGFibGUgdG8geW91LiBIb3dldmVyLCBhbnkgcHJvcGVydGllcyB5b3UgY2hhbmdlIG9uIHRoZQogICAgZGVub2RlaWZpZWQgZnVuY3Rpb24gd29uJ3QgYmUgY2hhbmdlZCBvbiB0aGUgb3JpZ2luYWwgZnVuY3Rpb24uIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBsZXQgcmVxdWVzdCA9IGRlbm9kZWlmeShyZXF1aXJlKCdyZXF1ZXN0JykpLAogICAgICAgIGNvb2tpZUphciA9IHJlcXVlc3QuamFyKCk7IC8vIDwtIEluaGVyaXRhbmNlIGlzIHVzZWQgaGVyZQogIAogICAgcmVxdWVzdCgnaHR0cDovL2V4YW1wbGUuY29tJywge2phcjogY29va2llSmFyfSkudGhlbihmdW5jdGlvbihyZXMpIHsKICAgICAgLy8gY29va2llSmFyLmNvb2tpZXMgaG9sZHMgbm93IHRoZSBjb29raWVzIHJldHVybmVkIGJ5IGV4YW1wbGUuY29tCiAgICB9KTsKICAgIGBgYAogIAogICAgVXNpbmcgYGRlbm9kZWlmeWAgbWFrZXMgaXQgZWFzaWVyIHRvIGNvbXBvc2UgYXN5bmNocm9ub3VzIG9wZXJhdGlvbnMgaW5zdGVhZAogICAgb2YgdXNpbmcgY2FsbGJhY2tzLiBGb3IgZXhhbXBsZSwgaW5zdGVhZCBvZjoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCBmcyA9IHJlcXVpcmUoJ2ZzJyk7CiAgCiAgICBmcy5yZWFkRmlsZSgnbXlmaWxlLnR4dCcsIGZ1bmN0aW9uKGVyciwgZGF0YSl7CiAgICAgIGlmIChlcnIpIHsgLi4uIH0gLy8gSGFuZGxlIGVycm9yCiAgICAgIGZzLndyaXRlRmlsZSgnbXlmaWxlMi50eHQnLCBkYXRhLCBmdW5jdGlvbihlcnIpewogICAgICAgIGlmIChlcnIpIHsgLi4uIH0gLy8gSGFuZGxlIGVycm9yCiAgICAgICAgY29uc29sZS5sb2coJ2RvbmUnKQogICAgICB9KTsKICAgIH0pOwogICAgYGBgCiAgCiAgICB5b3UgY2FuIGNoYWluIHRoZSBvcGVyYXRpb25zIHRvZ2V0aGVyIHVzaW5nIGB0aGVuYCBmcm9tIHRoZSByZXR1cm5lZCBwcm9taXNlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IGZzID0gcmVxdWlyZSgnZnMnKTsKICAgIGxldCByZWFkRmlsZSA9IGRlbm9kZWlmeShmcy5yZWFkRmlsZSk7CiAgICBsZXQgd3JpdGVGaWxlID0gZGVub2RlaWZ5KGZzLndyaXRlRmlsZSk7CiAgCiAgICByZWFkRmlsZSgnbXlmaWxlLnR4dCcpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgIHJldHVybiB3cml0ZUZpbGUoJ215ZmlsZTIudHh0JywgZGF0YSk7CiAgICB9KS50aGVuKGZ1bmN0aW9uKCl7CiAgICAgIGNvbnNvbGUubG9nKCdkb25lJykKICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycm9yKXsKICAgICAgLy8gSGFuZGxlIGVycm9yCiAgICB9KTsKICAgIGBgYAogIAogICAgQG1ldGhvZCBkZW5vZGVpZnkKICAgIEBwdWJsaWMKICAgIEBzdGF0aWMKICAgIEBmb3IgcnN2cAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbm9kZUZ1bmMgYSAnbm9kZS1zdHlsZScgZnVuY3Rpb24gdGhhdCB0YWtlcyBhIGNhbGxiYWNrIGFzCiAgICBpdHMgbGFzdCBhcmd1bWVudC4gVGhlIGNhbGxiYWNrIGV4cGVjdHMgYW4gZXJyb3IgdG8gYmUgcGFzc2VkIGFzIGl0cyBmaXJzdAogICAgYXJndW1lbnQgKGlmIGFuIGVycm9yIG9jY3VycmVkLCBvdGhlcndpc2UgbnVsbCksIGFuZCB0aGUgdmFsdWUgZnJvbSB0aGUKICAgIG9wZXJhdGlvbiBhcyBpdHMgc2Vjb25kIGFyZ3VtZW50ICgnZnVuY3Rpb24oZXJyLCB2YWx1ZSl7IH0nKS4KICAgIEBwYXJhbSB7Qm9vbGVhbnxBcnJheX0gW29wdGlvbnNdIEFuIG9wdGlvbmFsIHBhcmFtdGVyIHRoYXQgaWYgc2V0CiAgICB0byBgdHJ1ZWAgY2F1c2VzIHRoZSBwcm9taXNlIHRvIGZ1bGZpbGwgd2l0aCB0aGUgY2FsbGJhY2sncyBzdWNjZXNzIGFyZ3VtZW50cwogICAgYXMgYW4gYXJyYXkuIFRoaXMgaXMgdXNlZnVsIGlmIHRoZSBub2RlIGZ1bmN0aW9uIGhhcyBtdWx0aXBsZSBzdWNjZXNzCiAgICBwYXJhbXRlcnMuIElmIHlvdSBzZXQgdGhpcyBwYXJhbXRlciB0byBhbiBhcnJheSB3aXRoIG5hbWVzLCB0aGUgcHJvbWlzZSB3aWxsCiAgICBmdWxmaWxsIHdpdGggYSBoYXNoIHdpdGggdGhlc2UgbmFtZXMgYXMga2V5cyBhbmQgdGhlIHN1Y2Nlc3MgcGFyYW1ldGVycyBhcwogICAgdmFsdWVzLgogICAgQHJldHVybiB7RnVuY3Rpb259IGEgZnVuY3Rpb24gdGhhdCB3cmFwcyBgbm9kZUZ1bmNgIHRvIHJldHVybiBhIGBQcm9taXNlYAogICovCgoKICBmdW5jdGlvbiBkZW5vZGVpZnkobm9kZUZ1bmMsIG9wdGlvbnMpIHsKICAgIHZhciBmbiA9IGZ1bmN0aW9uIGZuKCkgewogICAgICB2YXIgbCA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICAgIHZhciBhcmdzID0gbmV3IEFycmF5KGwgKyAxKTsKICAgICAgdmFyIHByb21pc2VJbnB1dCA9IGZhbHNlOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsOyArK2kpIHsKICAgICAgICB2YXIgYXJnID0gYXJndW1lbnRzW2ldOyAvLyBUT0RPOiB0aGlzIGNvZGUgcmVhbGx5IG5lZWRzIHRvIGJlIGNsZWFuZWQgdXAKCiAgICAgICAgaWYgKCFwcm9taXNlSW5wdXQpIHsKICAgICAgICAgIGlmIChhcmcgIT09IG51bGwgJiYgdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgaWYgKGFyZy5jb25zdHJ1Y3RvciA9PT0gUHJvbWlzZSkgewogICAgICAgICAgICAgIHByb21pc2VJbnB1dCA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHByb21pc2VJbnB1dCA9IGFyZy50aGVuOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICB2YXIgcCA9IG5ldyBQcm9taXNlKG5vb3ApOwogICAgICAgICAgICAgICAgcmVqZWN0KHAsIGVycm9yKTsKICAgICAgICAgICAgICAgIHJldHVybiBwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJvbWlzZUlucHV0ID0gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHByb21pc2VJbnB1dCAmJiBwcm9taXNlSW5wdXQgIT09IHRydWUpIHsKICAgICAgICAgICAgYXJnID0gd3JhcFRoZW5hYmxlKHByb21pc2VJbnB1dCwgYXJnKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGFyZ3NbaV0gPSBhcmc7CiAgICAgIH0KCiAgICAgIHZhciBwcm9taXNlID0gbmV3IFByb21pc2Uobm9vcCk7CgogICAgICBhcmdzW2xdID0gZnVuY3Rpb24gKGVyciwgdmFsKSB7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgcmVqZWN0KHByb21pc2UsIGVycik7CiAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJlc29sdmUkMShwcm9taXNlLCB2YWwpOwogICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucyA9PT0gdHJ1ZSkgewogICAgICAgICAgcmVzb2x2ZSQxKHByb21pc2UsIGFycmF5UmVzdWx0KGFyZ3VtZW50cykpOwogICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShvcHRpb25zKSkgewogICAgICAgICAgcmVzb2x2ZSQxKHByb21pc2UsIG1ha2VPYmplY3QoYXJndW1lbnRzLCBvcHRpb25zKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc29sdmUkMShwcm9taXNlLCB2YWwpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlmIChwcm9taXNlSW5wdXQpIHsKICAgICAgICByZXR1cm4gaGFuZGxlUHJvbWlzZUlucHV0KHByb21pc2UsIGFyZ3MsIG5vZGVGdW5jLCB0aGlzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gaGFuZGxlVmFsdWVJbnB1dChwcm9taXNlLCBhcmdzLCBub2RlRnVuYywgdGhpcyk7CiAgICAgIH0KICAgIH07CgogICAgZm4uX19wcm90b19fID0gbm9kZUZ1bmM7CiAgICByZXR1cm4gZm47CiAgfQoKICBmdW5jdGlvbiBoYW5kbGVWYWx1ZUlucHV0KHByb21pc2UsIGFyZ3MsIG5vZGVGdW5jLCBzZWxmKSB7CiAgICB0cnkgewogICAgICBub2RlRnVuYy5hcHBseShzZWxmLCBhcmdzKTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIHJlamVjdChwcm9taXNlLCBlcnJvcik7CiAgICB9CgogICAgcmV0dXJuIHByb21pc2U7CiAgfQoKICBmdW5jdGlvbiBoYW5kbGVQcm9taXNlSW5wdXQocHJvbWlzZSwgYXJncywgbm9kZUZ1bmMsIHNlbGYpIHsKICAgIHJldHVybiBQcm9taXNlLmFsbChhcmdzKS50aGVuKGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgIHJldHVybiBoYW5kbGVWYWx1ZUlucHV0KHByb21pc2UsIGFyZ3MsIG5vZGVGdW5jLCBzZWxmKTsKICAgIH0pOwogIH0KICAvKioKICAgIFRoaXMgaXMgYSBjb252ZW5pZW50IGFsaWFzIGZvciBgUHJvbWlzZS5hbGxgLgogIAogICAgQG1ldGhvZCBhbGwKICAgIEBwdWJsaWMKICAgIEBzdGF0aWMKICAgIEBmb3IgcnN2cAogICAgQHBhcmFtIHtBcnJheX0gYXJyYXkgQXJyYXkgb2YgcHJvbWlzZXMuCiAgICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsXSBBbiBvcHRpb25hbCBsYWJlbC4gVGhpcyBpcyB1c2VmdWwKICAgIGZvciB0b29saW5nLgogICovCgoKICBmdW5jdGlvbiBhbGwkMShhcnJheSwgbGFiZWwpIHsKICAgIHJldHVybiBQcm9taXNlLmFsbChhcnJheSwgbGFiZWwpOwogIH0KICAvKioKICBAbW9kdWxlIHJzdnAKICBAcHVibGljCiAgKiovCgoKICB2YXIgQWxsU2V0dGxlZCA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfRW51bWVyYXRvcikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKEFsbFNldHRsZWQsIF9FbnVtZXJhdG9yKTsKCiAgICBmdW5jdGlvbiBBbGxTZXR0bGVkKENvbnN0cnVjdG9yLCBlbnRyaWVzLCBsYWJlbCkgewogICAgICByZXR1cm4gX0VudW1lcmF0b3IuY2FsbCh0aGlzLCBDb25zdHJ1Y3RvciwgZW50cmllcywgZmFsc2UKICAgICAgLyogZG9uJ3QgYWJvcnQgb24gcmVqZWN0ICovCiAgICAgICwgbGFiZWwpIHx8IHRoaXM7CiAgICB9CgogICAgcmV0dXJuIEFsbFNldHRsZWQ7CiAgfShFbnVtZXJhdG9yKTsKCiAgQWxsU2V0dGxlZC5wcm90b3R5cGUuX3NldFJlc3VsdEF0ID0gc2V0U2V0dGxlZFJlc3VsdDsKICAvKioKICBgUlNWUC5hbGxTZXR0bGVkYCBpcyBzaW1pbGFyIHRvIGBSU1ZQLmFsbGAsIGJ1dCBpbnN0ZWFkIG9mIGltcGxlbWVudGluZwogIGEgZmFpbC1mYXN0IG1ldGhvZCwgaXQgd2FpdHMgdW50aWwgYWxsIHRoZSBwcm9taXNlcyBoYXZlIHJldHVybmVkIGFuZAogIHNob3dzIHlvdSBhbGwgdGhlIHJlc3VsdHMuIFRoaXMgaXMgdXNlZnVsIGlmIHlvdSB3YW50IHRvIGhhbmRsZSBtdWx0aXBsZQogIHByb21pc2VzJyBmYWlsdXJlIHN0YXRlcyB0b2dldGhlciBhcyBhIHNldC4KICAgUmV0dXJucyBhIHByb21pc2UgdGhhdCBpcyBmdWxmaWxsZWQgd2hlbiBhbGwgdGhlIGdpdmVuIHByb21pc2VzIGhhdmUgYmVlbgogIHNldHRsZWQuIFRoZSByZXR1cm4gcHJvbWlzZSBpcyBmdWxmaWxsZWQgd2l0aCBhbiBhcnJheSBvZiB0aGUgc3RhdGVzIG9mCiAgdGhlIHByb21pc2VzIHBhc3NlZCBpbnRvIHRoZSBgcHJvbWlzZXNgIGFycmF5IGFyZ3VtZW50LgogICBFYWNoIHN0YXRlIG9iamVjdCB3aWxsIGVpdGhlciBpbmRpY2F0ZSBmdWxmaWxsbWVudCBvciByZWplY3Rpb24sIGFuZAogIHByb3ZpZGUgdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWUgb3IgcmVhc29uLiBUaGUgc3RhdGVzIHdpbGwgdGFrZSBvbmUgb2YKICB0aGUgZm9sbG93aW5nIGZvcm1hdHM6CiAgIGBgYGphdmFzY3JpcHQKICB7IHN0YXRlOiAnZnVsZmlsbGVkJywgdmFsdWU6IHZhbHVlIH0KICAgIG9yCiAgeyBzdGF0ZTogJ3JlamVjdGVkJywgcmVhc29uOiByZWFzb24gfQogIGBgYAogICBFeGFtcGxlOgogICBgYGBqYXZhc2NyaXB0CiAgbGV0IHByb21pc2UxID0gUlNWUC5Qcm9taXNlLnJlc29sdmUoMSk7CiAgbGV0IHByb21pc2UyID0gUlNWUC5Qcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJzInKSk7CiAgbGV0IHByb21pc2UzID0gUlNWUC5Qcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJzMnKSk7CiAgbGV0IHByb21pc2VzID0gWyBwcm9taXNlMSwgcHJvbWlzZTIsIHByb21pc2UzIF07CiAgIFJTVlAuYWxsU2V0dGxlZChwcm9taXNlcykudGhlbihmdW5jdGlvbihhcnJheSl7CiAgICAvLyBhcnJheSA9PSBbCiAgICAvLyAgIHsgc3RhdGU6ICdmdWxmaWxsZWQnLCB2YWx1ZTogMSB9LAogICAgLy8gICB7IHN0YXRlOiAncmVqZWN0ZWQnLCByZWFzb246IEVycm9yIH0sCiAgICAvLyAgIHsgc3RhdGU6ICdyZWplY3RlZCcsIHJlYXNvbjogRXJyb3IgfQogICAgLy8gXQogICAgLy8gTm90ZSB0aGF0IGZvciB0aGUgc2Vjb25kIGl0ZW0sIHJlYXNvbi5tZXNzYWdlIHdpbGwgYmUgJzInLCBhbmQgZm9yIHRoZQogICAgLy8gdGhpcmQgaXRlbSwgcmVhc29uLm1lc3NhZ2Ugd2lsbCBiZSAnMycuCiAgfSwgZnVuY3Rpb24oZXJyb3IpIHsKICAgIC8vIE5vdCBydW4uIChUaGlzIGJsb2NrIHdvdWxkIG9ubHkgYmUgY2FsbGVkIGlmIGFsbFNldHRsZWQgaGFkIGZhaWxlZCwKICAgIC8vIGZvciBpbnN0YW5jZSBpZiBwYXNzZWQgYW4gaW5jb3JyZWN0IGFyZ3VtZW50IHR5cGUuKQogIH0pOwogIGBgYAogICBAbWV0aG9kIGFsbFNldHRsZWQKICBAcHVibGljCiAgQHN0YXRpYwogIEBmb3IgcnN2cAogIEBwYXJhbSB7QXJyYXl9IGVudHJpZXMKICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsXSAtIG9wdGlvbmFsIHN0cmluZyB0aGF0IGRlc2NyaWJlcyB0aGUgcHJvbWlzZS4KICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSB0aGF0IGlzIGZ1bGZpbGxlZCB3aXRoIGFuIGFycmF5IG9mIHRoZSBzZXR0bGVkCiAgc3RhdGVzIG9mIHRoZSBjb25zdGl0dWVudCBwcm9taXNlcy4KICAqLwoKICBmdW5jdGlvbiBhbGxTZXR0bGVkKGVudHJpZXMsIGxhYmVsKSB7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZW50cmllcykpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBUeXBlRXJyb3IoIlByb21pc2UuYWxsU2V0dGxlZCBtdXN0IGJlIGNhbGxlZCB3aXRoIGFuIGFycmF5IiksIGxhYmVsKTsKICAgIH0KCiAgICByZXR1cm4gbmV3IEFsbFNldHRsZWQoUHJvbWlzZSwgZW50cmllcywgbGFiZWwpLnByb21pc2U7CiAgfQogIC8qKgogICAgVGhpcyBpcyBhIGNvbnZlbmllbnQgYWxpYXMgZm9yIGBQcm9taXNlLnJhY2VgLgogIAogICAgQG1ldGhvZCByYWNlCiAgICBAcHVibGljCiAgICBAc3RhdGljCiAgICBAZm9yIHJzdnAKICAgIEBwYXJhbSB7QXJyYXl9IGFycmF5IEFycmF5IG9mIHByb21pc2VzLgogICAgQHBhcmFtIHtTdHJpbmd9IFtsYWJlbF0gQW4gb3B0aW9uYWwgbGFiZWwuIFRoaXMgaXMgdXNlZnVsCiAgICBmb3IgdG9vbGluZy4KICAgKi8KCgogIGZ1bmN0aW9uIHJhY2UkMShhcnJheSwgbGFiZWwpIHsKICAgIHJldHVybiBQcm9taXNlLnJhY2UoYXJyYXksIGxhYmVsKTsKICB9CgogIHZhciBQcm9taXNlSGFzaCA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfRW51bWVyYXRvcjIpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0c0xvb3NlKShQcm9taXNlSGFzaCwgX0VudW1lcmF0b3IyKTsKCiAgICBmdW5jdGlvbiBQcm9taXNlSGFzaChDb25zdHJ1Y3Rvciwgb2JqZWN0LCBhYm9ydE9uUmVqZWN0LCBsYWJlbCkgewogICAgICBpZiAoYWJvcnRPblJlamVjdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgYWJvcnRPblJlamVjdCA9IHRydWU7CiAgICAgIH0KCiAgICAgIHJldHVybiBfRW51bWVyYXRvcjIuY2FsbCh0aGlzLCBDb25zdHJ1Y3Rvciwgb2JqZWN0LCBhYm9ydE9uUmVqZWN0LCBsYWJlbCkgfHwgdGhpczsKICAgIH0KCiAgICB2YXIgX3Byb3RvMyA9IFByb21pc2VIYXNoLnByb3RvdHlwZTsKCiAgICBfcHJvdG8zLl9pbml0ID0gZnVuY3Rpb24gX2luaXQoQ29uc3RydWN0b3IsIG9iamVjdCkgewogICAgICB0aGlzLl9yZXN1bHQgPSB7fTsKCiAgICAgIHRoaXMuX2VudW1lcmF0ZShvYmplY3QpOwogICAgfTsKCiAgICBfcHJvdG8zLl9lbnVtZXJhdGUgPSBmdW5jdGlvbiBfZW51bWVyYXRlKGlucHV0KSB7CiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoaW5wdXQpOwogICAgICB2YXIgbGVuZ3RoID0ga2V5cy5sZW5ndGg7CiAgICAgIHZhciBwcm9taXNlID0gdGhpcy5wcm9taXNlOwogICAgICB0aGlzLl9yZW1haW5pbmcgPSBsZW5ndGg7CiAgICAgIHZhciBrZXksIHZhbDsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBwcm9taXNlLl9zdGF0ZSA9PT0gUEVORElORyAmJiBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBrZXkgPSBrZXlzW2ldOwogICAgICAgIHZhbCA9IGlucHV0W2tleV07CgogICAgICAgIHRoaXMuX2VhY2hFbnRyeSh2YWwsIGtleSwgdHJ1ZSk7CiAgICAgIH0KCiAgICAgIHRoaXMuX2NoZWNrRnVsbGZpbGxtZW50KCk7CiAgICB9OwoKICAgIHJldHVybiBQcm9taXNlSGFzaDsKICB9KEVudW1lcmF0b3IpOwogIC8qKgogICAgYGhhc2hgIGlzIHNpbWlsYXIgdG8gYGFsbGAsIGJ1dCB0YWtlcyBhbiBvYmplY3QgaW5zdGVhZCBvZiBhbiBhcnJheQogICAgZm9yIGl0cyBgcHJvbWlzZXNgIGFyZ3VtZW50LgogIAogICAgUmV0dXJucyBhIHByb21pc2UgdGhhdCBpcyBmdWxmaWxsZWQgd2hlbiBhbGwgdGhlIGdpdmVuIHByb21pc2VzIGhhdmUgYmVlbgogICAgZnVsZmlsbGVkLCBvciByZWplY3RlZCBpZiBhbnkgb2YgdGhlbSBiZWNvbWUgcmVqZWN0ZWQuIFRoZSByZXR1cm5lZCBwcm9taXNlCiAgICBpcyBmdWxmaWxsZWQgd2l0aCBhIGhhc2ggdGhhdCBoYXMgdGhlIHNhbWUga2V5IG5hbWVzIGFzIHRoZSBgcHJvbWlzZXNgIG9iamVjdAogICAgYXJndW1lbnQuIElmIGFueSBvZiB0aGUgdmFsdWVzIGluIHRoZSBvYmplY3QgYXJlIG5vdCBwcm9taXNlcywgdGhleSB3aWxsCiAgICBzaW1wbHkgYmUgY29waWVkIG92ZXIgdG8gdGhlIGZ1bGZpbGxlZCBvYmplY3QuCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHByb21pc2VzID0gewogICAgICBteVByb21pc2U6IHJlc29sdmUoMSksCiAgICAgIHlvdXJQcm9taXNlOiByZXNvbHZlKDIpLAogICAgICB0aGVpclByb21pc2U6IHJlc29sdmUoMyksCiAgICAgIG5vdEFQcm9taXNlOiA0CiAgICB9OwogIAogICAgaGFzaChwcm9taXNlcykudGhlbihmdW5jdGlvbihoYXNoKXsKICAgICAgLy8gaGFzaCBoZXJlIGlzIGFuIG9iamVjdCB0aGF0IGxvb2tzIGxpa2U6CiAgICAgIC8vIHsKICAgICAgLy8gICBteVByb21pc2U6IDEsCiAgICAgIC8vICAgeW91clByb21pc2U6IDIsCiAgICAgIC8vICAgdGhlaXJQcm9taXNlOiAzLAogICAgICAvLyAgIG5vdEFQcm9taXNlOiA0CiAgICAgIC8vIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBJZiBhbnkgb2YgdGhlIGBwcm9taXNlc2AgZ2l2ZW4gdG8gYGhhc2hgIGFyZSByZWplY3RlZCwgdGhlIGZpcnN0IHByb21pc2UKICAgIHRoYXQgaXMgcmVqZWN0ZWQgd2lsbCBiZSBnaXZlbiBhcyB0aGUgcmVhc29uIHRvIHRoZSByZWplY3Rpb24gaGFuZGxlci4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBsZXQgcHJvbWlzZXMgPSB7CiAgICAgIG15UHJvbWlzZTogcmVzb2x2ZSgxKSwKICAgICAgcmVqZWN0ZWRQcm9taXNlOiByZWplY3QobmV3IEVycm9yKCdyZWplY3RlZFByb21pc2UnKSksCiAgICAgIGFub3RoZXJSZWplY3RlZFByb21pc2U6IHJlamVjdChuZXcgRXJyb3IoJ2Fub3RoZXJSZWplY3RlZFByb21pc2UnKSksCiAgICB9OwogIAogICAgaGFzaChwcm9taXNlcykudGhlbihmdW5jdGlvbihoYXNoKXsKICAgICAgLy8gQ29kZSBoZXJlIG5ldmVyIHJ1bnMgYmVjYXVzZSB0aGVyZSBhcmUgcmVqZWN0ZWQgcHJvbWlzZXMhCiAgICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgLy8gcmVhc29uLm1lc3NhZ2UgPT09ICdyZWplY3RlZFByb21pc2UnCiAgICB9KTsKICAgIGBgYAogIAogICAgQW4gaW1wb3J0YW50IG5vdGU6IGBoYXNoYCBpcyBpbnRlbmRlZCBmb3IgcGxhaW4gSmF2YVNjcmlwdCBvYmplY3RzIHRoYXQKICAgIGFyZSBqdXN0IGEgc2V0IG9mIGtleXMgYW5kIHZhbHVlcy4gYGhhc2hgIHdpbGwgTk9UIHByZXNlcnZlIHByb3RvdHlwZQogICAgY2hhaW5zLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGhhc2gsIHJlc29sdmUgfSBmcm9tICdyc3ZwJzsKICAgIGZ1bmN0aW9uIE15Q29uc3RydWN0b3IoKXsKICAgICAgdGhpcy5leGFtcGxlID0gcmVzb2x2ZSgnRXhhbXBsZScpOwogICAgfQogIAogICAgTXlDb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSB7CiAgICAgIHByb3RvUHJvcGVydHk6IHJlc29sdmUoJ1Byb3RvIFByb3BlcnR5JykKICAgIH07CiAgCiAgICBsZXQgbXlPYmplY3QgPSBuZXcgTXlDb25zdHJ1Y3RvcigpOwogIAogICAgaGFzaChteU9iamVjdCkudGhlbihmdW5jdGlvbihoYXNoKXsKICAgICAgLy8gcHJvdG9Qcm9wZXJ0eSB3aWxsIG5vdCBiZSBwcmVzZW50LCBpbnN0ZWFkIHlvdSB3aWxsIGp1c3QgaGF2ZSBhbgogICAgICAvLyBvYmplY3QgdGhhdCBsb29rcyBsaWtlOgogICAgICAvLyB7CiAgICAgIC8vICAgZXhhbXBsZTogJ0V4YW1wbGUnCiAgICAgIC8vIH0KICAgICAgLy8KICAgICAgLy8gaGFzaC5oYXNPd25Qcm9wZXJ0eSgncHJvdG9Qcm9wZXJ0eScpOyAvLyBmYWxzZQogICAgICAvLyAndW5kZWZpbmVkJyA9PT0gdHlwZW9mIGhhc2gucHJvdG9Qcm9wZXJ0eQogICAgfSk7CiAgICBgYGAKICAKICAgIEBtZXRob2QgaGFzaAogICAgQHB1YmxpYwogICAgQHN0YXRpYwogICAgQGZvciByc3ZwCiAgICBAcGFyYW0ge09iamVjdH0gb2JqZWN0CiAgICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsXSBvcHRpb25hbCBzdHJpbmcgdGhhdCBkZXNjcmliZXMgdGhlIHByb21pc2UuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIHRoYXQgaXMgZnVsZmlsbGVkIHdoZW4gYWxsIHByb3BlcnRpZXMgb2YgYHByb21pc2VzYAogICAgaGF2ZSBiZWVuIGZ1bGZpbGxlZCwgb3IgcmVqZWN0ZWQgaWYgYW55IG9mIHRoZW0gYmVjb21lIHJlamVjdGVkLgogICovCgoKICBmdW5jdGlvbiBoYXNoKG9iamVjdCwgbGFiZWwpIHsKICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUob2JqZWN0LCBsYWJlbCkudGhlbihmdW5jdGlvbiAob2JqZWN0KSB7CiAgICAgIGlmIChvYmplY3QgPT09IG51bGwgfHwgdHlwZW9mIG9iamVjdCAhPT0gJ29iamVjdCcpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJQcm9taXNlLmhhc2ggbXVzdCBiZSBjYWxsZWQgd2l0aCBhbiBvYmplY3QiKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlSGFzaChQcm9taXNlLCBvYmplY3QsIGxhYmVsKS5wcm9taXNlOwogICAgfSk7CiAgfQoKICB2YXIgSGFzaFNldHRsZWQgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX1Byb21pc2VIYXNoKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoSGFzaFNldHRsZWQsIF9Qcm9taXNlSGFzaCk7CgogICAgZnVuY3Rpb24gSGFzaFNldHRsZWQoQ29uc3RydWN0b3IsIG9iamVjdCwgbGFiZWwpIHsKICAgICAgcmV0dXJuIF9Qcm9taXNlSGFzaC5jYWxsKHRoaXMsIENvbnN0cnVjdG9yLCBvYmplY3QsIGZhbHNlLCBsYWJlbCkgfHwgdGhpczsKICAgIH0KCiAgICByZXR1cm4gSGFzaFNldHRsZWQ7CiAgfShQcm9taXNlSGFzaCk7CgogIEhhc2hTZXR0bGVkLnByb3RvdHlwZS5fc2V0UmVzdWx0QXQgPSBzZXRTZXR0bGVkUmVzdWx0OwogIC8qKgogICAgYGhhc2hTZXR0bGVkYCBpcyBzaW1pbGFyIHRvIGBhbGxTZXR0bGVkYCwgYnV0IHRha2VzIGFuIG9iamVjdAogICAgaW5zdGVhZCBvZiBhbiBhcnJheSBmb3IgaXRzIGBwcm9taXNlc2AgYXJndW1lbnQuCiAgCiAgICBVbmxpa2UgYGFsbGAgb3IgYGhhc2hgLCB3aGljaCBpbXBsZW1lbnQgYSBmYWlsLWZhc3QgbWV0aG9kLAogICAgYnV0IGxpa2UgYGFsbFNldHRsZWRgLCBgaGFzaFNldHRsZWRgIHdhaXRzIHVudGlsIGFsbCB0aGUKICAgIGNvbnN0aXR1ZW50IHByb21pc2VzIGhhdmUgcmV0dXJuZWQgYW5kIHRoZW4gc2hvd3MgeW91IGFsbCB0aGUgcmVzdWx0cwogICAgd2l0aCB0aGVpciBzdGF0ZXMgYW5kIHZhbHVlcy9yZWFzb25zLiBUaGlzIGlzIHVzZWZ1bCBpZiB5b3Ugd2FudCB0bwogICAgaGFuZGxlIG11bHRpcGxlIHByb21pc2VzJyBmYWlsdXJlIHN0YXRlcyB0b2dldGhlciBhcyBhIHNldC4KICAKICAgIFJldHVybnMgYSBwcm9taXNlIHRoYXQgaXMgZnVsZmlsbGVkIHdoZW4gYWxsIHRoZSBnaXZlbiBwcm9taXNlcyBoYXZlIGJlZW4KICAgIHNldHRsZWQsIG9yIHJlamVjdGVkIGlmIHRoZSBwYXNzZWQgcGFyYW1ldGVycyBhcmUgaW52YWxpZC4KICAKICAgIFRoZSByZXR1cm5lZCBwcm9taXNlIGlzIGZ1bGZpbGxlZCB3aXRoIGEgaGFzaCB0aGF0IGhhcyB0aGUgc2FtZSBrZXkgbmFtZXMgYXMKICAgIHRoZSBgcHJvbWlzZXNgIG9iamVjdCBhcmd1bWVudC4gSWYgYW55IG9mIHRoZSB2YWx1ZXMgaW4gdGhlIG9iamVjdCBhcmUgbm90CiAgICBwcm9taXNlcywgdGhleSB3aWxsIGJlIGNvcGllZCBvdmVyIHRvIHRoZSBmdWxmaWxsZWQgb2JqZWN0IGFuZCBtYXJrZWQgd2l0aCBzdGF0ZQogICAgJ2Z1bGZpbGxlZCcuCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgaGFzaFNldHRsZWQsIHJlc29sdmUgfSBmcm9tICdyc3ZwJzsKICAKICAgIGxldCBwcm9taXNlcyA9IHsKICAgICAgbXlQcm9taXNlOiByZXNvbHZlKDEpLAogICAgICB5b3VyUHJvbWlzZTogcmVzb2x2ZSgyKSwKICAgICAgdGhlaXJQcm9taXNlOiByZXNvbHZlKDMpLAogICAgICBub3RBUHJvbWlzZTogNAogICAgfTsKICAKICAgIGhhc2hTZXR0bGVkKHByb21pc2VzKS50aGVuKGZ1bmN0aW9uKGhhc2gpewogICAgICAvLyBoYXNoIGhlcmUgaXMgYW4gb2JqZWN0IHRoYXQgbG9va3MgbGlrZToKICAgICAgLy8gewogICAgICAvLyAgIG15UHJvbWlzZTogeyBzdGF0ZTogJ2Z1bGZpbGxlZCcsIHZhbHVlOiAxIH0sCiAgICAgIC8vICAgeW91clByb21pc2U6IHsgc3RhdGU6ICdmdWxmaWxsZWQnLCB2YWx1ZTogMiB9LAogICAgICAvLyAgIHRoZWlyUHJvbWlzZTogeyBzdGF0ZTogJ2Z1bGZpbGxlZCcsIHZhbHVlOiAzIH0sCiAgICAgIC8vICAgbm90QVByb21pc2U6IHsgc3RhdGU6ICdmdWxmaWxsZWQnLCB2YWx1ZTogNCB9CiAgICAgIC8vIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBJZiBhbnkgb2YgdGhlIGBwcm9taXNlc2AgZ2l2ZW4gdG8gYGhhc2hgIGFyZSByZWplY3RlZCwgdGhlIHN0YXRlIHdpbGwKICAgIGJlIHNldCB0byAncmVqZWN0ZWQnIGFuZCB0aGUgcmVhc29uIGZvciByZWplY3Rpb24gcHJvdmlkZWQuCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgaGFzaFNldHRsZWQsIHJlamVjdCwgcmVzb2x2ZSB9IGZyb20gJ3JzdnAnOwogIAogICAgbGV0IHByb21pc2VzID0gewogICAgICBteVByb21pc2U6IHJlc29sdmUoMSksCiAgICAgIHJlamVjdGVkUHJvbWlzZTogcmVqZWN0KG5ldyBFcnJvcigncmVqZWN0aW9uJykpLAogICAgICBhbm90aGVyUmVqZWN0ZWRQcm9taXNlOiByZWplY3QobmV3IEVycm9yKCdtb3JlIHJlamVjdGlvbicpKSwKICAgIH07CiAgCiAgICBoYXNoU2V0dGxlZChwcm9taXNlcykudGhlbihmdW5jdGlvbihoYXNoKXsKICAgICAgLy8gaGFzaCBoZXJlIGlzIGFuIG9iamVjdCB0aGF0IGxvb2tzIGxpa2U6CiAgICAgIC8vIHsKICAgICAgLy8gICBteVByb21pc2U6ICAgICAgICAgICAgICB7IHN0YXRlOiAnZnVsZmlsbGVkJywgdmFsdWU6IDEgfSwKICAgICAgLy8gICByZWplY3RlZFByb21pc2U6ICAgICAgICB7IHN0YXRlOiAncmVqZWN0ZWQnLCByZWFzb246IEVycm9yIH0sCiAgICAgIC8vICAgYW5vdGhlclJlamVjdGVkUHJvbWlzZTogeyBzdGF0ZTogJ3JlamVjdGVkJywgcmVhc29uOiBFcnJvciB9LAogICAgICAvLyB9CiAgICAgIC8vIE5vdGUgdGhhdCBmb3IgcmVqZWN0ZWRQcm9taXNlLCByZWFzb24ubWVzc2FnZSA9PSAncmVqZWN0aW9uJywKICAgICAgLy8gYW5kIGZvciBhbm90aGVyUmVqZWN0ZWRQcm9taXNlLCByZWFzb24ubWVzc2FnZSA9PSAnbW9yZSByZWplY3Rpb24nLgogICAgfSk7CiAgICBgYGAKICAKICAgIEFuIGltcG9ydGFudCBub3RlOiBgaGFzaFNldHRsZWRgIGlzIGludGVuZGVkIGZvciBwbGFpbiBKYXZhU2NyaXB0IG9iamVjdHMgdGhhdAogICAgYXJlIGp1c3QgYSBzZXQgb2Yga2V5cyBhbmQgdmFsdWVzLiBgaGFzaFNldHRsZWRgIHdpbGwgTk9UIHByZXNlcnZlIHByb3RvdHlwZQogICAgY2hhaW5zLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBQcm9taXNlLCB7IGhhc2hTZXR0bGVkLCByZXNvbHZlIH0gZnJvbSAncnN2cCc7CiAgCiAgICBmdW5jdGlvbiBNeUNvbnN0cnVjdG9yKCl7CiAgICAgIHRoaXMuZXhhbXBsZSA9IHJlc29sdmUoJ0V4YW1wbGUnKTsKICAgIH0KICAKICAgIE15Q29uc3RydWN0b3IucHJvdG90eXBlID0gewogICAgICBwcm90b1Byb3BlcnR5OiBQcm9taXNlLnJlc29sdmUoJ1Byb3RvIFByb3BlcnR5JykKICAgIH07CiAgCiAgICBsZXQgbXlPYmplY3QgPSBuZXcgTXlDb25zdHJ1Y3RvcigpOwogIAogICAgaGFzaFNldHRsZWQobXlPYmplY3QpLnRoZW4oZnVuY3Rpb24oaGFzaCl7CiAgICAgIC8vIHByb3RvUHJvcGVydHkgd2lsbCBub3QgYmUgcHJlc2VudCwgaW5zdGVhZCB5b3Ugd2lsbCBqdXN0IGhhdmUgYW4KICAgICAgLy8gb2JqZWN0IHRoYXQgbG9va3MgbGlrZToKICAgICAgLy8gewogICAgICAvLyAgIGV4YW1wbGU6IHsgc3RhdGU6ICdmdWxmaWxsZWQnLCB2YWx1ZTogJ0V4YW1wbGUnIH0KICAgICAgLy8gfQogICAgICAvLwogICAgICAvLyBoYXNoLmhhc093blByb3BlcnR5KCdwcm90b1Byb3BlcnR5Jyk7IC8vIGZhbHNlCiAgICAgIC8vICd1bmRlZmluZWQnID09PSB0eXBlb2YgaGFzaC5wcm90b1Byb3BlcnR5CiAgICB9KTsKICAgIGBgYAogIAogICAgQG1ldGhvZCBoYXNoU2V0dGxlZAogICAgQHB1YmxpYwogICAgQGZvciByc3ZwCiAgICBAcGFyYW0ge09iamVjdH0gb2JqZWN0CiAgICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsXSBvcHRpb25hbCBzdHJpbmcgdGhhdCBkZXNjcmliZXMgdGhlIHByb21pc2UuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIHRoYXQgaXMgZnVsZmlsbGVkIHdoZW4gd2hlbiBhbGwgcHJvcGVydGllcyBvZiBgcHJvbWlzZXNgCiAgICBoYXZlIGJlZW4gc2V0dGxlZC4KICAgIEBzdGF0aWMKICAqLwoKICBmdW5jdGlvbiBoYXNoU2V0dGxlZChvYmplY3QsIGxhYmVsKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG9iamVjdCwgbGFiZWwpLnRoZW4oZnVuY3Rpb24gKG9iamVjdCkgewogICAgICBpZiAob2JqZWN0ID09PSBudWxsIHx8IHR5cGVvZiBvYmplY3QgIT09ICdvYmplY3QnKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiaGFzaFNldHRsZWQgbXVzdCBiZSBjYWxsZWQgd2l0aCBhbiBvYmplY3QiKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG5ldyBIYXNoU2V0dGxlZChQcm9taXNlLCBvYmplY3QsIGZhbHNlLCBsYWJlbCkucHJvbWlzZTsKICAgIH0pOwogIH0KICAvKioKICAgIGByZXRocm93YCB3aWxsIHJldGhyb3cgYW4gZXJyb3Igb24gdGhlIG5leHQgdHVybiBvZiB0aGUgSmF2YVNjcmlwdCBldmVudAogICAgbG9vcCBpbiBvcmRlciB0byBhaWQgZGVidWdnaW5nLgogIAogICAgUHJvbWlzZXMgQSsgc3BlY2lmaWVzIHRoYXQgYW55IGV4Y2VwdGlvbnMgdGhhdCBvY2N1ciB3aXRoIGEgcHJvbWlzZSBtdXN0IGJlCiAgICBjYXVnaHQgYnkgdGhlIHByb21pc2VzIGltcGxlbWVudGF0aW9uIGFuZCBidWJibGVkIHRvIHRoZSBsYXN0IGhhbmRsZXIuIEZvcgogICAgdGhpcyByZWFzb24sIGl0IGlzIHJlY29tbWVuZGVkIHRoYXQgeW91IGFsd2F5cyBzcGVjaWZ5IGEgc2Vjb25kIHJlamVjdGlvbgogICAgaGFuZGxlciBmdW5jdGlvbiB0byBgdGhlbmAuIEhvd2V2ZXIsIGByZXRocm93YCB3aWxsIHRocm93IHRoZSBleGNlcHRpb24KICAgIG91dHNpZGUgb2YgdGhlIHByb21pc2UsIHNvIGl0IGJ1YmJsZXMgdXAgdG8geW91ciBjb25zb2xlIGlmIGluIHRoZSBicm93c2VyLAogICAgb3IgZG9tYWluL2NhdXNlIHVuY2F1Z2h0IGV4Y2VwdGlvbiBpbiBOb2RlLiBgcmV0aHJvd2Agd2lsbCBhbHNvIHRocm93IHRoZQogICAgZXJyb3IgYWdhaW4gc28gdGhlIGVycm9yIGNhbiBiZSBoYW5kbGVkIGJ5IHRoZSBwcm9taXNlIHBlciB0aGUgc3BlYy4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHJldGhyb3cgfSBmcm9tICdyc3ZwJzsKICAKICAgIGZ1bmN0aW9uIHRocm93cygpewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ1dob29wcyEnKTsKICAgIH0KICAKICAgIGxldCBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KXsKICAgICAgdGhyb3dzKCk7CiAgICB9KTsKICAKICAgIHByb21pc2UuY2F0Y2gocmV0aHJvdykudGhlbihmdW5jdGlvbigpewogICAgICAvLyBDb2RlIGhlcmUgZG9lc24ndCBydW4gYmVjYXVzZSB0aGUgcHJvbWlzZSBiZWNhbWUgcmVqZWN0ZWQgZHVlIHRvIGFuCiAgICAgIC8vIGVycm9yIQogICAgfSwgZnVuY3Rpb24gKGVycil7CiAgICAgIC8vIGhhbmRsZSB0aGUgZXJyb3IgaGVyZQogICAgfSk7CiAgICBgYGAKICAKICAgIFRoZSAnV2hvb3BzJyBlcnJvciB3aWxsIGJlIHRocm93biBvbiB0aGUgbmV4dCB0dXJuIG9mIHRoZSBldmVudCBsb29wCiAgICBhbmQgeW91IGNhbiB3YXRjaCBmb3IgaXQgaW4geW91ciBjb25zb2xlLiBZb3UgY2FuIGFsc28gaGFuZGxlIGl0IHVzaW5nIGEKICAgIHJlamVjdGlvbiBoYW5kbGVyIGdpdmVuIHRvIGAudGhlbmAgb3IgYC5jYXRjaGAgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgCiAgICBAbWV0aG9kIHJldGhyb3cKICAgIEBwdWJsaWMKICAgIEBzdGF0aWMKICAgIEBmb3IgcnN2cAogICAgQHBhcmFtIHtFcnJvcn0gcmVhc29uIHJlYXNvbiB0aGUgcHJvbWlzZSBiZWNhbWUgcmVqZWN0ZWQuCiAgICBAdGhyb3dzIEVycm9yCiAgICBAc3RhdGljCiAgKi8KCgogIGZ1bmN0aW9uIHJldGhyb3cocmVhc29uKSB7CiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgdGhyb3cgcmVhc29uOwogICAgfSk7CiAgICB0aHJvdyByZWFzb247CiAgfQogIC8qKgogICAgYGRlZmVyYCByZXR1cm5zIGFuIG9iamVjdCBzaW1pbGFyIHRvIGpRdWVyeSdzIGAkLkRlZmVycmVkYC4KICAgIGBkZWZlcmAgc2hvdWxkIGJlIHVzZWQgd2hlbiBwb3J0aW5nIG92ZXIgY29kZSByZWxpYW50IG9uIGAkLkRlZmVycmVkYCdzCiAgICBpbnRlcmZhY2UuIE5ldyBjb2RlIHNob3VsZCB1c2UgdGhlIGBQcm9taXNlYCBjb25zdHJ1Y3RvciBpbnN0ZWFkLgogIAogICAgVGhlIG9iamVjdCByZXR1cm5lZCBmcm9tIGBkZWZlcmAgaXMgYSBwbGFpbiBvYmplY3Qgd2l0aCB0aHJlZSBwcm9wZXJ0aWVzOgogIAogICAgKiBwcm9taXNlIC0gYW4gYFByb21pc2VgLgogICAgKiByZWplY3QgLSBhIGZ1bmN0aW9uIHRoYXQgY2F1c2VzIHRoZSBgcHJvbWlzZWAgcHJvcGVydHkgb24gdGhpcyBvYmplY3QgdG8KICAgICAgYmVjb21lIHJlamVjdGVkCiAgICAqIHJlc29sdmUgLSBhIGZ1bmN0aW9uIHRoYXQgY2F1c2VzIHRoZSBgcHJvbWlzZWAgcHJvcGVydHkgb24gdGhpcyBvYmplY3QgdG8KICAgICAgYmVjb21lIGZ1bGZpbGxlZC4KICAKICAgIEV4YW1wbGU6CiAgCiAgICAgYGBgamF2YXNjcmlwdAogICAgIGxldCBkZWZlcnJlZCA9IGRlZmVyKCk7CiAgCiAgICAgZGVmZXJyZWQucmVzb2x2ZSgiU3VjY2VzcyEiKTsKICAKICAgICBkZWZlcnJlZC5wcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsdWUpewogICAgICAgLy8gdmFsdWUgaGVyZSBpcyAiU3VjY2VzcyEiCiAgICAgfSk7CiAgICAgYGBgCiAgCiAgICBAbWV0aG9kIGRlZmVyCiAgICBAcHVibGljCiAgICBAc3RhdGljCiAgICBAZm9yIHJzdnAKICAgIEBwYXJhbSB7U3RyaW5nfSBbbGFiZWxdIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAcmV0dXJuIHtPYmplY3R9CiAgICovCgoKICBmdW5jdGlvbiBkZWZlcihsYWJlbCkgewogICAgdmFyIGRlZmVycmVkID0gewogICAgICByZXNvbHZlOiB1bmRlZmluZWQsCiAgICAgIHJlamVjdDogdW5kZWZpbmVkCiAgICB9OwogICAgZGVmZXJyZWQucHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgZGVmZXJyZWQucmVzb2x2ZSA9IHJlc29sdmU7CiAgICAgIGRlZmVycmVkLnJlamVjdCA9IHJlamVjdDsKICAgIH0sIGxhYmVsKTsKICAgIHJldHVybiBkZWZlcnJlZDsKICB9CgogIHZhciBNYXBFbnVtZXJhdG9yID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9FbnVtZXJhdG9yMykgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzTG9vc2UpKE1hcEVudW1lcmF0b3IsIF9FbnVtZXJhdG9yMyk7CgogICAgZnVuY3Rpb24gTWFwRW51bWVyYXRvcihDb25zdHJ1Y3RvciwgZW50cmllcywgbWFwRm4sIGxhYmVsKSB7CiAgICAgIHJldHVybiBfRW51bWVyYXRvcjMuY2FsbCh0aGlzLCBDb25zdHJ1Y3RvciwgZW50cmllcywgdHJ1ZSwgbGFiZWwsIG1hcEZuKSB8fCB0aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG80ID0gTWFwRW51bWVyYXRvci5wcm90b3R5cGU7CgogICAgX3Byb3RvNC5faW5pdCA9IGZ1bmN0aW9uIF9pbml0KENvbnN0cnVjdG9yLCBpbnB1dCwgYm9vbCwgbGFiZWwsIG1hcEZuKSB7CiAgICAgIHZhciBsZW4gPSBpbnB1dC5sZW5ndGggfHwgMDsKICAgICAgdGhpcy5sZW5ndGggPSBsZW47CiAgICAgIHRoaXMuX3JlbWFpbmluZyA9IGxlbjsKICAgICAgdGhpcy5fcmVzdWx0ID0gbmV3IEFycmF5KGxlbik7CiAgICAgIHRoaXMuX21hcEZuID0gbWFwRm47CgogICAgICB0aGlzLl9lbnVtZXJhdGUoaW5wdXQpOwogICAgfTsKCiAgICBfcHJvdG80Ll9zZXRSZXN1bHRBdCA9IGZ1bmN0aW9uIF9zZXRSZXN1bHRBdChzdGF0ZSwgaSwgdmFsdWUsIGZpcnN0UGFzcykgewogICAgICBpZiAoZmlyc3RQYXNzKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHRoaXMuX2VhY2hFbnRyeSh0aGlzLl9tYXBGbih2YWx1ZSwgaSksIGksIGZhbHNlKTsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgdGhpcy5fc2V0dGxlZEF0KFJFSkVDVEVELCBpLCBlcnJvciwgZmFsc2UpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9yZW1haW5pbmctLTsKICAgICAgICB0aGlzLl9yZXN1bHRbaV0gPSB2YWx1ZTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gTWFwRW51bWVyYXRvcjsKICB9KEVudW1lcmF0b3IpOwogIC8qKgogICBgbWFwYCBpcyBzaW1pbGFyIHRvIEphdmFTY3JpcHQncyBuYXRpdmUgYG1hcGAgbWV0aG9kLiBgbWFwRm5gIGlzIGVhZ2VybHkgY2FsbGVkCiAgICBtZWFuaW5nIHRoYXQgYXMgc29vbiBhcyBhbnkgcHJvbWlzZSByZXNvbHZlcyBpdHMgdmFsdWUgd2lsbCBiZSBwYXNzZWQgdG8gYG1hcEZuYC4KICAgIGBtYXBgIHJldHVybnMgYSBwcm9taXNlIHRoYXQgd2lsbCBiZWNvbWUgZnVsZmlsbGVkIHdpdGggdGhlIHJlc3VsdCBvZiBydW5uaW5nCiAgICBgbWFwRm5gIG9uIHRoZSB2YWx1ZXMgdGhlIHByb21pc2VzIGJlY29tZSBmdWxmaWxsZWQgd2l0aC4KICAKICAgIEZvciBleGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgbWFwLCByZXNvbHZlIH0gZnJvbSAncnN2cCc7CiAgCiAgICBsZXQgcHJvbWlzZTEgPSByZXNvbHZlKDEpOwogICAgbGV0IHByb21pc2UyID0gcmVzb2x2ZSgyKTsKICAgIGxldCBwcm9taXNlMyA9IHJlc29sdmUoMyk7CiAgICBsZXQgcHJvbWlzZXMgPSBbIHByb21pc2UxLCBwcm9taXNlMiwgcHJvbWlzZTMgXTsKICAKICAgIGxldCBtYXBGbiA9IGZ1bmN0aW9uKGl0ZW0pewogICAgICByZXR1cm4gaXRlbSArIDE7CiAgICB9OwogIAogICAgbWFwKHByb21pc2VzLCBtYXBGbikudGhlbihmdW5jdGlvbihyZXN1bHQpewogICAgICAvLyByZXN1bHQgaXMgWyAyLCAzLCA0IF0KICAgIH0pOwogICAgYGBgCiAgCiAgICBJZiBhbnkgb2YgdGhlIGBwcm9taXNlc2AgZ2l2ZW4gdG8gYG1hcGAgYXJlIHJlamVjdGVkLCB0aGUgZmlyc3QgcHJvbWlzZQogICAgdGhhdCBpcyByZWplY3RlZCB3aWxsIGJlIGdpdmVuIGFzIGFuIGFyZ3VtZW50IHRvIHRoZSByZXR1cm5lZCBwcm9taXNlJ3MKICAgIHJlamVjdGlvbiBoYW5kbGVyLiBGb3IgZXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IG1hcCwgcmVqZWN0LCByZXNvbHZlIH0gZnJvbSAncnN2cCc7CiAgCiAgICBsZXQgcHJvbWlzZTEgPSByZXNvbHZlKDEpOwogICAgbGV0IHByb21pc2UyID0gcmVqZWN0KG5ldyBFcnJvcignMicpKTsKICAgIGxldCBwcm9taXNlMyA9IHJlamVjdChuZXcgRXJyb3IoJzMnKSk7CiAgICBsZXQgcHJvbWlzZXMgPSBbIHByb21pc2UxLCBwcm9taXNlMiwgcHJvbWlzZTMgXTsKICAKICAgIGxldCBtYXBGbiA9IGZ1bmN0aW9uKGl0ZW0pewogICAgICByZXR1cm4gaXRlbSArIDE7CiAgICB9OwogIAogICAgbWFwKHByb21pc2VzLCBtYXBGbikudGhlbihmdW5jdGlvbihhcnJheSl7CiAgICAgIC8vIENvZGUgaGVyZSBuZXZlciBydW5zIGJlY2F1c2UgdGhlcmUgYXJlIHJlamVjdGVkIHByb21pc2VzIQogICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgIC8vIHJlYXNvbi5tZXNzYWdlID09PSAnMicKICAgIH0pOwogICAgYGBgCiAgCiAgICBgbWFwYCB3aWxsIGFsc28gd2FpdCBpZiBhIHByb21pc2UgaXMgcmV0dXJuZWQgZnJvbSBgbWFwRm5gLiBGb3IgZXhhbXBsZSwKICAgIHNheSB5b3Ugd2FudCB0byBnZXQgYWxsIGNvbW1lbnRzIGZyb20gYSBzZXQgb2YgYmxvZyBwb3N0cywgYnV0IHlvdSBuZWVkCiAgICB0aGUgYmxvZyBwb3N0cyBmaXJzdCBiZWNhdXNlIHRoZXkgY29udGFpbiBhIHVybCB0byB0aG9zZSBjb21tZW50cy4KICAKICAgIGBgYGphdnNjcmlwdAogICAgaW1wb3J0IHsgbWFwIH0gZnJvbSAncnN2cCc7CiAgCiAgICBsZXQgbWFwRm4gPSBmdW5jdGlvbihibG9nUG9zdCl7CiAgICAgIC8vIGdldENvbW1lbnRzIGRvZXMgc29tZSBhamF4IGFuZCByZXR1cm5zIGFuIFByb21pc2UgdGhhdCBpcyBmdWxmaWxsZWQKICAgICAgLy8gd2l0aCBzb21lIGNvbW1lbnRzIGRhdGEKICAgICAgcmV0dXJuIGdldENvbW1lbnRzKGJsb2dQb3N0LmNvbW1lbnRzX3VybCk7CiAgICB9OwogIAogICAgLy8gZ2V0QmxvZ1Bvc3RzIGRvZXMgc29tZSBhamF4IGFuZCByZXR1cm5zIGFuIFByb21pc2UgdGhhdCBpcyBmdWxmaWxsZWQKICAgIC8vIHdpdGggc29tZSBibG9nIHBvc3QgZGF0YQogICAgbWFwKGdldEJsb2dQb3N0cygpLCBtYXBGbikudGhlbihmdW5jdGlvbihjb21tZW50cyl7CiAgICAgIC8vIGNvbW1lbnRzIGlzIHRoZSByZXN1bHQgb2YgYXNraW5nIHRoZSBzZXJ2ZXIgZm9yIHRoZSBjb21tZW50cwogICAgICAvLyBvZiBhbGwgYmxvZyBwb3N0cyByZXR1cm5lZCBmcm9tIGdldEJsb2dQb3N0cygpCiAgICB9KTsKICAgIGBgYAogIAogICAgQG1ldGhvZCBtYXAKICAgIEBwdWJsaWMKICAgIEBzdGF0aWMKICAgIEBmb3IgcnN2cAogICAgQHBhcmFtIHtBcnJheX0gcHJvbWlzZXMKICAgIEBwYXJhbSB7RnVuY3Rpb259IG1hcEZuIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBvbiBlYWNoIGZ1bGZpbGxlZCBwcm9taXNlLgogICAgQHBhcmFtIHtTdHJpbmd9IFtsYWJlbF0gb3B0aW9uYWwgc3RyaW5nIGZvciBsYWJlbGluZyB0aGUgcHJvbWlzZS4KICAgIFVzZWZ1bCBmb3IgdG9vbGluZy4KICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UgdGhhdCBpcyBmdWxmaWxsZWQgd2l0aCB0aGUgcmVzdWx0IG9mIGNhbGxpbmcKICAgIGBtYXBGbmAgb24gZWFjaCBmdWxmaWxsZWQgcHJvbWlzZSBvciB2YWx1ZSB3aGVuIHRoZXkgYmVjb21lIGZ1bGZpbGxlZC4KICAgICBUaGUgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkIGlmIGFueSBvZiB0aGUgZ2l2ZW4gYHByb21pc2VzYCBiZWNvbWUgcmVqZWN0ZWQuCiAgKi8KCgogIGZ1bmN0aW9uIG1hcChwcm9taXNlcywgbWFwRm4sIGxhYmVsKSB7CiAgICBpZiAodHlwZW9mIG1hcEZuICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgVHlwZUVycm9yKCJtYXAgZXhwZWN0cyBhIGZ1bmN0aW9uIGFzIGEgc2Vjb25kIGFyZ3VtZW50IiksIGxhYmVsKTsKICAgIH0KCiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHByb21pc2VzLCBsYWJlbCkudGhlbihmdW5jdGlvbiAocHJvbWlzZXMpIHsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHByb21pc2VzKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIm1hcCBtdXN0IGJlIGNhbGxlZCB3aXRoIGFuIGFycmF5Iik7CiAgICAgIH0KCiAgICAgIHJldHVybiBuZXcgTWFwRW51bWVyYXRvcihQcm9taXNlLCBwcm9taXNlcywgbWFwRm4sIGxhYmVsKS5wcm9taXNlOwogICAgfSk7CiAgfQogIC8qKgogICAgVGhpcyBpcyBhIGNvbnZlbmllbnQgYWxpYXMgZm9yIGBQcm9taXNlLnJlc29sdmVgLgogIAogICAgQG1ldGhvZCByZXNvbHZlCiAgICBAcHVibGljCiAgICBAc3RhdGljCiAgICBAZm9yIHJzdnAKICAgIEBwYXJhbSB7Kn0gdmFsdWUgdmFsdWUgdGhhdCB0aGUgcmV0dXJuZWQgcHJvbWlzZSB3aWxsIGJlIHJlc29sdmVkIHdpdGgKICAgIEBwYXJhbSB7U3RyaW5nfSBbbGFiZWxdIG9wdGlvbmFsIHN0cmluZyBmb3IgaWRlbnRpZnlpbmcgdGhlIHJldHVybmVkIHByb21pc2UuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2UgdGhhdCB3aWxsIGJlY29tZSBmdWxmaWxsZWQgd2l0aCB0aGUgZ2l2ZW4KICAgIGB2YWx1ZWAKICAqLwoKCiAgZnVuY3Rpb24gcmVzb2x2ZSQyKHZhbHVlLCBsYWJlbCkgewogICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh2YWx1ZSwgbGFiZWwpOwogIH0KICAvKioKICAgIFRoaXMgaXMgYSBjb252ZW5pZW50IGFsaWFzIGZvciBgUHJvbWlzZS5yZWplY3RgLgogIAogICAgQG1ldGhvZCByZWplY3QKICAgIEBwdWJsaWMKICAgIEBzdGF0aWMKICAgIEBmb3IgcnN2cAogICAgQHBhcmFtIHsqfSByZWFzb24gdmFsdWUgdGhhdCB0aGUgcmV0dXJuZWQgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkIHdpdGguCiAgICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsXSBvcHRpb25hbCBzdHJpbmcgZm9yIGlkZW50aWZ5aW5nIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAgVXNlZnVsIGZvciB0b29saW5nLgogICAgQHJldHVybiB7UHJvbWlzZX0gYSBwcm9taXNlIHJlamVjdGVkIHdpdGggdGhlIGdpdmVuIGByZWFzb25gLgogICovCgoKICBmdW5jdGlvbiByZWplY3QkMihyZWFzb24sIGxhYmVsKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QocmVhc29uLCBsYWJlbCk7CiAgfQoKICB2YXIgRU1QVFlfT0JKRUNUID0ge307CgogIHZhciBGaWx0ZXJFbnVtZXJhdG9yID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9NYXBFbnVtZXJhdG9yKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHNMb29zZSkoRmlsdGVyRW51bWVyYXRvciwgX01hcEVudW1lcmF0b3IpOwoKICAgIGZ1bmN0aW9uIEZpbHRlckVudW1lcmF0b3IoKSB7CiAgICAgIHJldHVybiBfTWFwRW51bWVyYXRvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7CiAgICB9CgogICAgdmFyIF9wcm90bzUgPSBGaWx0ZXJFbnVtZXJhdG9yLnByb3RvdHlwZTsKCiAgICBfcHJvdG81Ll9jaGVja0Z1bGxmaWxsbWVudCA9IGZ1bmN0aW9uIF9jaGVja0Z1bGxmaWxsbWVudCgpIHsKICAgICAgaWYgKHRoaXMuX3JlbWFpbmluZyA9PT0gMCAmJiB0aGlzLl9yZXN1bHQgIT09IG51bGwpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gdGhpcy5fcmVzdWx0LmZpbHRlcihmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICByZXR1cm4gdmFsICE9PSBFTVBUWV9PQkpFQ1Q7CiAgICAgICAgfSk7CgogICAgICAgIGZ1bGZpbGwodGhpcy5wcm9taXNlLCByZXN1bHQpOwogICAgICAgIHRoaXMuX3Jlc3VsdCA9IG51bGw7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvNS5fc2V0UmVzdWx0QXQgPSBmdW5jdGlvbiBfc2V0UmVzdWx0QXQoc3RhdGUsIGksIHZhbHVlLCBmaXJzdFBhc3MpIHsKICAgICAgaWYgKGZpcnN0UGFzcykgewogICAgICAgIHRoaXMuX3Jlc3VsdFtpXSA9IHZhbHVlOwogICAgICAgIHZhciB2YWwsCiAgICAgICAgICAgIHN1Y2NlZWRlZCA9IHRydWU7CgogICAgICAgIHRyeSB7CiAgICAgICAgICB2YWwgPSB0aGlzLl9tYXBGbih2YWx1ZSwgaSk7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgIHN1Y2NlZWRlZCA9IGZhbHNlOwoKICAgICAgICAgIHRoaXMuX3NldHRsZWRBdChSRUpFQ1RFRCwgaSwgZXJyb3IsIGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIGlmIChzdWNjZWVkZWQpIHsKICAgICAgICAgIHRoaXMuX2VhY2hFbnRyeSh2YWwsIGksIGZhbHNlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fcmVtYWluaW5nLS07CgogICAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICAgIHRoaXMuX3Jlc3VsdFtpXSA9IEVNUFRZX09CSkVDVDsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIEZpbHRlckVudW1lcmF0b3I7CiAgfShNYXBFbnVtZXJhdG9yKTsKICAvKioKICAgYGZpbHRlcmAgaXMgc2ltaWxhciB0byBKYXZhU2NyaXB0J3MgbmF0aXZlIGBmaWx0ZXJgIG1ldGhvZC4KICAgYGZpbHRlckZuYCBpcyBlYWdlcmx5IGNhbGxlZCBtZWFuaW5nIHRoYXQgYXMgc29vbiBhcyBhbnkgcHJvbWlzZQogICAgcmVzb2x2ZXMgaXRzIHZhbHVlIHdpbGwgYmUgcGFzc2VkIHRvIGBmaWx0ZXJGbmAuIGBmaWx0ZXJgIHJldHVybnMKICAgIGEgcHJvbWlzZSB0aGF0IHdpbGwgYmVjb21lIGZ1bGZpbGxlZCB3aXRoIHRoZSByZXN1bHQgb2YgcnVubmluZwogICAgYGZpbHRlckZuYCBvbiB0aGUgdmFsdWVzIHRoZSBwcm9taXNlcyBiZWNvbWUgZnVsZmlsbGVkIHdpdGguCiAgCiAgICBGb3IgZXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGZpbHRlciwgcmVzb2x2ZSB9IGZyb20gJ3JzdnAnOwogIAogICAgbGV0IHByb21pc2UxID0gcmVzb2x2ZSgxKTsKICAgIGxldCBwcm9taXNlMiA9IHJlc29sdmUoMik7CiAgICBsZXQgcHJvbWlzZTMgPSByZXNvbHZlKDMpOwogIAogICAgbGV0IHByb21pc2VzID0gW3Byb21pc2UxLCBwcm9taXNlMiwgcHJvbWlzZTNdOwogIAogICAgbGV0IGZpbHRlckZuID0gZnVuY3Rpb24oaXRlbSl7CiAgICAgIHJldHVybiBpdGVtID4gMTsKICAgIH07CiAgCiAgICBmaWx0ZXIocHJvbWlzZXMsIGZpbHRlckZuKS50aGVuKGZ1bmN0aW9uKHJlc3VsdCl7CiAgICAgIC8vIHJlc3VsdCBpcyBbIDIsIDMgXQogICAgfSk7CiAgICBgYGAKICAKICAgIElmIGFueSBvZiB0aGUgYHByb21pc2VzYCBnaXZlbiB0byBgZmlsdGVyYCBhcmUgcmVqZWN0ZWQsIHRoZSBmaXJzdCBwcm9taXNlCiAgICB0aGF0IGlzIHJlamVjdGVkIHdpbGwgYmUgZ2l2ZW4gYXMgYW4gYXJndW1lbnQgdG8gdGhlIHJldHVybmVkIHByb21pc2UncwogICAgcmVqZWN0aW9uIGhhbmRsZXIuIEZvciBleGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgZmlsdGVyLCByZWplY3QsIHJlc29sdmUgfSBmcm9tICdyc3ZwJzsKICAKICAgIGxldCBwcm9taXNlMSA9IHJlc29sdmUoMSk7CiAgICBsZXQgcHJvbWlzZTIgPSByZWplY3QobmV3IEVycm9yKCcyJykpOwogICAgbGV0IHByb21pc2UzID0gcmVqZWN0KG5ldyBFcnJvcignMycpKTsKICAgIGxldCBwcm9taXNlcyA9IFsgcHJvbWlzZTEsIHByb21pc2UyLCBwcm9taXNlMyBdOwogIAogICAgbGV0IGZpbHRlckZuID0gZnVuY3Rpb24oaXRlbSl7CiAgICAgIHJldHVybiBpdGVtID4gMTsKICAgIH07CiAgCiAgICBmaWx0ZXIocHJvbWlzZXMsIGZpbHRlckZuKS50aGVuKGZ1bmN0aW9uKGFycmF5KXsKICAgICAgLy8gQ29kZSBoZXJlIG5ldmVyIHJ1bnMgYmVjYXVzZSB0aGVyZSBhcmUgcmVqZWN0ZWQgcHJvbWlzZXMhCiAgICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgLy8gcmVhc29uLm1lc3NhZ2UgPT09ICcyJwogICAgfSk7CiAgICBgYGAKICAKICAgIGBmaWx0ZXJgIHdpbGwgYWxzbyB3YWl0IGZvciBhbnkgcHJvbWlzZXMgcmV0dXJuZWQgZnJvbSBgZmlsdGVyRm5gLgogICAgRm9yIGluc3RhbmNlLCB5b3UgbWF5IHdhbnQgdG8gZmV0Y2ggYSBsaXN0IG9mIHVzZXJzIHRoZW4gcmV0dXJuIGEgc3Vic2V0CiAgICBvZiB0aG9zZSB1c2VycyBiYXNlZCBvbiBzb21lIGFzeW5jaHJvbm91cyBvcGVyYXRpb246CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBmaWx0ZXIsIHJlc29sdmUgfSBmcm9tICdyc3ZwJzsKICAKICAgIGxldCBhbGljZSA9IHsgbmFtZTogJ2FsaWNlJyB9OwogICAgbGV0IGJvYiAgID0geyBuYW1lOiAnYm9iJyB9OwogICAgbGV0IHVzZXJzID0gWyBhbGljZSwgYm9iIF07CiAgCiAgICBsZXQgcHJvbWlzZXMgPSB1c2Vycy5tYXAoZnVuY3Rpb24odXNlcil7CiAgICAgIHJldHVybiByZXNvbHZlKHVzZXIpOwogICAgfSk7CiAgCiAgICBsZXQgZmlsdGVyRm4gPSBmdW5jdGlvbih1c2VyKXsKICAgICAgLy8gSGVyZSwgQWxpY2UgaGFzIHBlcm1pc3Npb25zIHRvIGNyZWF0ZSBhIGJsb2cgcG9zdCwgYnV0IEJvYiBkb2VzIG5vdC4KICAgICAgcmV0dXJuIGdldFByaXZpbGVnZXNGb3JVc2VyKHVzZXIpLnRoZW4oZnVuY3Rpb24ocHJpdnMpewogICAgICAgIHJldHVybiBwcml2cy5jYW5fY3JlYXRlX2Jsb2dfcG9zdCA9PT0gdHJ1ZTsKICAgICAgfSk7CiAgICB9OwogICAgZmlsdGVyKHByb21pc2VzLCBmaWx0ZXJGbikudGhlbihmdW5jdGlvbih1c2Vycyl7CiAgICAgIC8vIHRydWUsIGJlY2F1c2UgdGhlIHNlcnZlciB0b2xkIHVzIG9ubHkgQWxpY2UgY2FuIGNyZWF0ZSBhIGJsb2cgcG9zdC4KICAgICAgdXNlcnMubGVuZ3RoID09PSAxOwogICAgICAvLyBmYWxzZSwgYmVjYXVzZSBBbGljZSBpcyB0aGUgb25seSB1c2VyIHByZXNlbnQgaW4gYHVzZXJzYAogICAgICB1c2Vyc1swXSA9PT0gYm9iOwogICAgfSk7CiAgICBgYGAKICAKICAgIEBtZXRob2QgZmlsdGVyCiAgICBAcHVibGljCiAgICBAc3RhdGljCiAgICBAZm9yIHJzdnAKICAgIEBwYXJhbSB7QXJyYXl9IHByb21pc2VzCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBmaWx0ZXJGbiAtIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBvbiBlYWNoIHJlc29sdmVkIHZhbHVlIHRvCiAgICBmaWx0ZXIgdGhlIGZpbmFsIHJlc3VsdHMuCiAgICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsXSBvcHRpb25hbCBzdHJpbmcgZGVzY3JpYmluZyB0aGUgcHJvbWlzZS4gVXNlZnVsIGZvcgogICAgdG9vbGluZy4KICAgIEByZXR1cm4ge1Byb21pc2V9CiAgKi8KCgogIGZ1bmN0aW9uIGZpbHRlcihwcm9taXNlcywgZmlsdGVyRm4sIGxhYmVsKSB7CiAgICBpZiAodHlwZW9mIGZpbHRlckZuICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgVHlwZUVycm9yKCJmaWx0ZXIgZXhwZWN0cyBmdW5jdGlvbiBhcyBhIHNlY29uZCBhcmd1bWVudCIpLCBsYWJlbCk7CiAgICB9CgogICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShwcm9taXNlcywgbGFiZWwpLnRoZW4oZnVuY3Rpb24gKHByb21pc2VzKSB7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShwcm9taXNlcykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJmaWx0ZXIgbXVzdCBiZSBjYWxsZWQgd2l0aCBhbiBhcnJheSIpOwogICAgICB9CgogICAgICByZXR1cm4gbmV3IEZpbHRlckVudW1lcmF0b3IoUHJvbWlzZSwgcHJvbWlzZXMsIGZpbHRlckZuLCBsYWJlbCkucHJvbWlzZTsKICAgIH0pOwogIH0KCiAgdmFyIGxlbiA9IDA7CiAgdmFyIHZlcnR4TmV4dDsKCiAgZnVuY3Rpb24gYXNhcChjYWxsYmFjaywgYXJnKSB7CiAgICBxdWV1ZSQxW2xlbl0gPSBjYWxsYmFjazsKICAgIHF1ZXVlJDFbbGVuICsgMV0gPSBhcmc7CiAgICBsZW4gKz0gMjsKCiAgICBpZiAobGVuID09PSAyKSB7CiAgICAgIC8vIElmIGxlbiBpcyAxLCB0aGF0IG1lYW5zIHRoYXQgd2UgbmVlZCB0byBzY2hlZHVsZSBhbiBhc3luYyBmbHVzaC4KICAgICAgLy8gSWYgYWRkaXRpb25hbCBjYWxsYmFja3MgYXJlIHF1ZXVlZCBiZWZvcmUgdGhlIHF1ZXVlIGlzIGZsdXNoZWQsIHRoZXkKICAgICAgLy8gd2lsbCBiZSBwcm9jZXNzZWQgYnkgdGhpcyBmbHVzaCB0aGF0IHdlIGFyZSBzY2hlZHVsaW5nLgogICAgICBzY2hlZHVsZUZsdXNoJDEoKTsKICAgIH0KICB9CgogIHZhciBicm93c2VyV2luZG93ID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgPyB3aW5kb3cgOiB1bmRlZmluZWQ7CiAgdmFyIGJyb3dzZXJHbG9iYWwgPSBicm93c2VyV2luZG93IHx8IHt9OwogIHZhciBCcm93c2VyTXV0YXRpb25PYnNlcnZlciA9IGJyb3dzZXJHbG9iYWwuTXV0YXRpb25PYnNlcnZlciB8fCBicm93c2VyR2xvYmFsLldlYktpdE11dGF0aW9uT2JzZXJ2ZXI7CiAgdmFyIGlzTm9kZSA9IHR5cGVvZiBzZWxmID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgcHJvY2VzcyAhPT0gJ3VuZGVmaW5lZCcgJiYge30udG9TdHJpbmcuY2FsbChwcm9jZXNzKSA9PT0gJ1tvYmplY3QgcHJvY2Vzc10nOyAvLyB0ZXN0IGZvciB3ZWIgd29ya2VyIGJ1dCBub3QgaW4gSUUxMAoKICB2YXIgaXNXb3JrZXIgPSB0eXBlb2YgVWludDhDbGFtcGVkQXJyYXkgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBpbXBvcnRTY3JpcHRzICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgTWVzc2FnZUNoYW5uZWwgIT09ICd1bmRlZmluZWQnOyAvLyBub2RlCgogIGZ1bmN0aW9uIHVzZU5leHRUaWNrKCkgewogICAgdmFyIG5leHRUaWNrID0gcHJvY2Vzcy5uZXh0VGljazsgLy8gbm9kZSB2ZXJzaW9uIDAuMTAueCBkaXNwbGF5cyBhIGRlcHJlY2F0aW9uIHdhcm5pbmcgd2hlbiBuZXh0VGljayBpcyB1c2VkIHJlY3Vyc2l2ZWx5CiAgICAvLyBzZXRJbW1lZGlhdGUgc2hvdWxkIGJlIHVzZWQgaW5zdGVhZCBpbnN0ZWFkCgogICAgdmFyIHZlcnNpb24gPSBwcm9jZXNzLnZlcnNpb25zLm5vZGUubWF0Y2goL14oPzooXGQrKVwuKT8oPzooXGQrKVwuKT8oXCp8XGQrKSQvKTsKCiAgICBpZiAoQXJyYXkuaXNBcnJheSh2ZXJzaW9uKSAmJiB2ZXJzaW9uWzFdID09PSAnMCcgJiYgdmVyc2lvblsyXSA9PT0gJzEwJykgewogICAgICBuZXh0VGljayA9IHNldEltbWVkaWF0ZTsKICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gbmV4dFRpY2soZmx1c2gpOwogICAgfTsKICB9IC8vIHZlcnR4CgoKICBmdW5jdGlvbiB1c2VWZXJ0eFRpbWVyKCkgewogICAgaWYgKHR5cGVvZiB2ZXJ0eE5leHQgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmVydHhOZXh0KGZsdXNoKTsKICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gdXNlU2V0VGltZW91dCgpOwogIH0KCiAgZnVuY3Rpb24gdXNlTXV0YXRpb25PYnNlcnZlcigpIHsKICAgIHZhciBpdGVyYXRpb25zID0gMDsKICAgIHZhciBvYnNlcnZlciA9IG5ldyBCcm93c2VyTXV0YXRpb25PYnNlcnZlcihmbHVzaCk7CiAgICB2YXIgbm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCcnKTsKICAgIG9ic2VydmVyLm9ic2VydmUobm9kZSwgewogICAgICBjaGFyYWN0ZXJEYXRhOiB0cnVlCiAgICB9KTsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBub2RlLmRhdGEgPSBpdGVyYXRpb25zID0gKytpdGVyYXRpb25zICUgMjsKICAgIH07CiAgfSAvLyB3ZWIgd29ya2VyCgoKICBmdW5jdGlvbiB1c2VNZXNzYWdlQ2hhbm5lbCgpIHsKICAgIHZhciBjaGFubmVsID0gbmV3IE1lc3NhZ2VDaGFubmVsKCk7CiAgICBjaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IGZsdXNoOwogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGNoYW5uZWwucG9ydDIucG9zdE1lc3NhZ2UoMCk7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gdXNlU2V0VGltZW91dCgpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBzZXRUaW1lb3V0KGZsdXNoLCAxKTsKICAgIH07CiAgfQoKICB2YXIgcXVldWUkMSA9IG5ldyBBcnJheSgxMDAwKTsKCiAgZnVuY3Rpb24gZmx1c2goKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSArPSAyKSB7CiAgICAgIHZhciBjYWxsYmFjayA9IHF1ZXVlJDFbaV07CiAgICAgIHZhciBhcmcgPSBxdWV1ZSQxW2kgKyAxXTsKICAgICAgY2FsbGJhY2soYXJnKTsKICAgICAgcXVldWUkMVtpXSA9IHVuZGVmaW5lZDsKICAgICAgcXVldWUkMVtpICsgMV0gPSB1bmRlZmluZWQ7CiAgICB9CgogICAgbGVuID0gMDsKICB9CgogIGZ1bmN0aW9uIGF0dGVtcHRWZXJ0ZXgoKSB7CiAgICB0cnkgewogICAgICB2YXIgdmVydHggPSBGdW5jdGlvbigncmV0dXJuIHRoaXMnKSgpLnJlcXVpcmUoJ3ZlcnR4Jyk7CgogICAgICB2ZXJ0eE5leHQgPSB2ZXJ0eC5ydW5Pbkxvb3AgfHwgdmVydHgucnVuT25Db250ZXh0OwogICAgICByZXR1cm4gdXNlVmVydHhUaW1lcigpOwogICAgfSBjYXRjaCAoZSkgewogICAgICByZXR1cm4gdXNlU2V0VGltZW91dCgpOwogICAgfQogIH0KCiAgdmFyIHNjaGVkdWxlRmx1c2gkMTsgLy8gRGVjaWRlIHdoYXQgYXN5bmMgbWV0aG9kIHRvIHVzZSB0byB0cmlnZ2VyaW5nIHByb2Nlc3Npbmcgb2YgcXVldWVkIGNhbGxiYWNrczoKCiAgaWYgKGlzTm9kZSkgewogICAgc2NoZWR1bGVGbHVzaCQxID0gdXNlTmV4dFRpY2soKTsKICB9IGVsc2UgaWYgKEJyb3dzZXJNdXRhdGlvbk9ic2VydmVyKSB7CiAgICBzY2hlZHVsZUZsdXNoJDEgPSB1c2VNdXRhdGlvbk9ic2VydmVyKCk7CiAgfSBlbHNlIGlmIChpc1dvcmtlcikgewogICAgc2NoZWR1bGVGbHVzaCQxID0gdXNlTWVzc2FnZUNoYW5uZWwoKTsKICB9IGVsc2UgaWYgKGJyb3dzZXJXaW5kb3cgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgcmVxdWlyZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgc2NoZWR1bGVGbHVzaCQxID0gYXR0ZW1wdFZlcnRleCgpOwogIH0gZWxzZSB7CiAgICBzY2hlZHVsZUZsdXNoJDEgPSB1c2VTZXRUaW1lb3V0KCk7CiAgfSAvLyBkZWZhdWx0cwoKCiAgY29uZmlnLmFzeW5jID0gYXNhcDsKCiAgY29uZmlnLmFmdGVyID0gZnVuY3Rpb24gKGNiKSB7CiAgICByZXR1cm4gc2V0VGltZW91dChjYiwgMCk7CiAgfTsKCiAgdmFyIGNhc3QgPSByZXNvbHZlJDI7CiAgX2V4cG9ydHMuY2FzdCA9IGNhc3Q7CgogIHZhciBhc3luYyA9IGZ1bmN0aW9uIGFzeW5jKGNhbGxiYWNrLCBhcmcpIHsKICAgIHJldHVybiBjb25maWcuYXN5bmMoY2FsbGJhY2ssIGFyZyk7CiAgfTsKCiAgX2V4cG9ydHMuYXN5bmMgPSBhc3luYzsKCiAgZnVuY3Rpb24gb24oKSB7CiAgICBjb25maWcub24uYXBwbHkoY29uZmlnLCBhcmd1bWVudHMpOwogIH0KCiAgZnVuY3Rpb24gb2ZmKCkgewogICAgY29uZmlnLm9mZi5hcHBseShjb25maWcsIGFyZ3VtZW50cyk7CiAgfSAvLyBTZXQgdXAgaW5zdHJ1bWVudGF0aW9uIHRocm91Z2ggYHdpbmRvdy5fX1BST01JU0VfSU5UUlVNRU5UQVRJT05fX2AKCgogIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Ygd2luZG93WydfX1BST01JU0VfSU5TVFJVTUVOVEFUSU9OX18nXSA9PT0gJ29iamVjdCcpIHsKICAgIHZhciBjYWxsYmFja3MgPSB3aW5kb3dbJ19fUFJPTUlTRV9JTlNUUlVNRU5UQVRJT05fXyddOwogICAgY29uZmlndXJlKCdpbnN0cnVtZW50JywgdHJ1ZSk7CgogICAgZm9yICh2YXIgZXZlbnROYW1lIGluIGNhbGxiYWNrcykgewogICAgICBpZiAoY2FsbGJhY2tzLmhhc093blByb3BlcnR5KGV2ZW50TmFtZSkpIHsKICAgICAgICBvbihldmVudE5hbWUsIGNhbGxiYWNrc1tldmVudE5hbWVdKTsKICAgICAgfQogICAgfQogIH0gLy8gdGhlIGRlZmF1bHQgZXhwb3J0IGhlcmUgaXMgZm9yIGJhY2t3YXJkcyBjb21wYXQ6CiAgLy8gICBodHRwczovL2dpdGh1Yi5jb20vdGlsZGVpby9yc3ZwLmpzL2lzc3Vlcy80MzQKCgogIHZhciByc3ZwID0gewogICAgYXNhcDogYXNhcCwKICAgIGNhc3Q6IGNhc3QsCiAgICBQcm9taXNlOiBQcm9taXNlLAogICAgRXZlbnRUYXJnZXQ6IEV2ZW50VGFyZ2V0LAogICAgYWxsOiBhbGwkMSwKICAgIGFsbFNldHRsZWQ6IGFsbFNldHRsZWQsCiAgICByYWNlOiByYWNlJDEsCiAgICBoYXNoOiBoYXNoLAogICAgaGFzaFNldHRsZWQ6IGhhc2hTZXR0bGVkLAogICAgcmV0aHJvdzogcmV0aHJvdywKICAgIGRlZmVyOiBkZWZlciwKICAgIGRlbm9kZWlmeTogZGVub2RlaWZ5LAogICAgY29uZmlndXJlOiBjb25maWd1cmUsCiAgICBvbjogb24sCiAgICBvZmY6IG9mZiwKICAgIHJlc29sdmU6IHJlc29sdmUkMiwKICAgIHJlamVjdDogcmVqZWN0JDIsCiAgICBtYXA6IG1hcCwKICAgIGFzeW5jOiBhc3luYywKICAgIGZpbHRlcjogZmlsdGVyCiAgfTsKICB2YXIgX2RlZmF1bHQgPSByc3ZwOwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CnJlcXVpcmUoJ2VtYmVyJyk7Cn0oKSk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPWVtYmVyLm1hcAoKO2RlZmluZSgnQGVtYmVyLWRhdGEvYWRhcHRlci8tcHJpdmF0ZScsIFsnZXhwb3J0cycsICdyZXF1aXJlJywgJ2VtYmVyLWluZmxlY3RvciddLCBmdW5jdGlvbiAoZXhwb3J0cywgcmVxdWlyZSwgZW1iZXJJbmZsZWN0b3IpIHsgJ3VzZSBzdHJpY3QnOwoKICB2YXIgcmVxdWlyZV9fZGVmYXVsdCA9ICdkZWZhdWx0JyBpbiByZXF1aXJlID8gcmVxdWlyZVsnZGVmYXVsdCddIDogcmVxdWlyZTsKCiAgdmFyIG5ld2xpbmUgPSAvXHI/XG4vOwogIGZ1bmN0aW9uIHBhcnNlUmVzcG9uc2VIZWFkZXJzKGhlYWRlcnNTdHJpbmcpIHsKICAgIHZhciBoZWFkZXJzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCiAgICBpZiAoIWhlYWRlcnNTdHJpbmcpIHsKICAgICAgcmV0dXJuIGhlYWRlcnM7CiAgICB9CgogICAgdmFyIGhlYWRlclBhaXJzID0gaGVhZGVyc1N0cmluZy5zcGxpdChuZXdsaW5lKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhlYWRlclBhaXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBoZWFkZXIgPSBoZWFkZXJQYWlyc1tpXTsKICAgICAgdmFyIGogPSAwOwogICAgICB2YXIgZm91bmRTZXAgPSBmYWxzZTsKCiAgICAgIGZvciAoOyBqIDwgaGVhZGVyLmxlbmd0aDsgaisrKSB7CiAgICAgICAgaWYgKGhlYWRlci5jaGFyQ29kZUF0KGopID09PSA1OAogICAgICAgIC8qICc6JyAqLwogICAgICAgICkgewogICAgICAgICAgICBmb3VuZFNlcCA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoZm91bmRTZXAgPT09IGZhbHNlKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIHZhciBmaWVsZCA9IGhlYWRlci5zdWJzdHJpbmcoMCwgaikudHJpbSgpOwogICAgICB2YXIgdmFsdWUgPSBoZWFkZXIuc3Vic3RyaW5nKGogKyAxLCBoZWFkZXIubGVuZ3RoKS50cmltKCk7CgogICAgICBpZiAodmFsdWUpIHsKICAgICAgICB2YXIgbG93ZXJDYXNlZEZpZWxkID0gZmllbGQudG9Mb3dlckNhc2UoKTsKICAgICAgICBoZWFkZXJzW2xvd2VyQ2FzZWRGaWVsZF0gPSB2YWx1ZTsKICAgICAgICBoZWFkZXJzW2ZpZWxkXSA9IHZhbHVlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGhlYWRlcnM7CiAgfQoKICAvKgogICAqIEZ1bmN0aW9uIHRoYXQgYWx3YXlzIGF0dGVtcHRzIHRvIHBhcnNlIHRoZSByZXNwb25zZSBhcyBqc29uLCBhbmQgaWYgYW4gZXJyb3IgaXMgdGhyb3duLAogICAqIHJldHVybnMgYHVuZGVmaW5lZGAgaWYgdGhlIHJlc3BvbnNlIGlzIHN1Y2Nlc3NmdWwgYW5kIGhhcyBhIHN0YXR1cyBjb2RlIG9mIDIwNCAoTm8gQ29udGVudCksCiAgICogb3IgMjA1IChSZXNldCBDb250ZW50KSBvciBpZiB0aGUgcmVxdWVzdCBtZXRob2Qgd2FzICdIRUFEJywgYW5kIHRoZSBwbGFpbiBwYXlsb2FkIG90aGVyd2lzZS4KICAgKi8KICBmdW5jdGlvbiBkZXRlcm1pbmVCb2R5UHJvbWlzZShyZXNwb25zZSwgcmVxdWVzdERhdGEpIHsKICAgIHJldHVybiByZXNwb25zZS50ZXh0KCkudGhlbihmdW5jdGlvbiAocGF5bG9hZCkgewogICAgICB2YXIgcmV0ID0gcGF5bG9hZDsKCiAgICAgIHRyeSB7CiAgICAgICAgcmV0ID0gSlNPTi5wYXJzZShwYXlsb2FkKTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBpZiAoIShlcnJvciBpbnN0YW5jZW9mIFN5bnRheEVycm9yKSkgewogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfQoKICAgICAgICB2YXIgc3RhdHVzID0gcmVzcG9uc2Uuc3RhdHVzOwoKICAgICAgICBpZiAocmVzcG9uc2Uub2sgJiYgKHN0YXR1cyA9PT0gMjA0IHx8IHN0YXR1cyA9PT0gMjA1IHx8IHJlcXVlc3REYXRhLm1ldGhvZCA9PT0gJ0hFQUQnKSkgewogICAgICAgICAgcmV0ID0gdW5kZWZpbmVkOwogICAgICAgIH0gZWxzZSB7CgoKICAgICAgICAgIGNvbnNvbGUud2FybignVGhpcyByZXNwb25zZSB3YXMgdW5hYmxlIHRvIGJlIHBhcnNlZCBhcyBqc29uLicsIHBheWxvYWQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHJldDsKICAgIH0pOwogIH0KCiAgdmFyIFJCUkFDS0VUID0gL1xbXF0kLzsKCiAgZnVuY3Rpb24gaXNQbGFpbk9iamVjdChvYmopIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgT2JqZWN0XSc7CiAgfQogIC8qCiAgICogSGVscGVyIGZ1bmN0aW9uIHRoYXQgdHVybnMgdGhlIGRhdGEvYm9keSBvZiBhIHJlcXVlc3QgaW50byBhIHF1ZXJ5IHBhcmFtIHN0cmluZy4KICAgKiBUaGlzIGlzIGRpcmVjdGx5IGNvcGllZCBmcm9tIGpRdWVyeS5wYXJhbS4KICAgKi8KCgogIGZ1bmN0aW9uIHNlcmlhbGl6ZVF1ZXJ5UGFyYW1zKHF1ZXJ5UGFyYW1zT2JqZWN0KSB7CiAgICB2YXIgcyA9IFtdOwoKICAgIGZ1bmN0aW9uIGJ1aWxkUGFyYW1zKHByZWZpeCwgb2JqKSB7CiAgICAgIHZhciBpLCBsZW4sIGtleTsKCiAgICAgIGlmIChwcmVmaXgpIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSBvYmoubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKFJCUkFDS0VULnRlc3QocHJlZml4KSkgewogICAgICAgICAgICAgIGFkZChzLCBwcmVmaXgsIG9ialtpXSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4ICsgJ1snICsgKHR5cGVvZiBvYmpbaV0gPT09ICdvYmplY3QnID8gaSA6ICcnKSArICddJywgb2JqW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoaXNQbGFpbk9iamVjdChvYmopKSB7CiAgICAgICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4ICsgJ1snICsga2V5ICsgJ10nLCBvYmpba2V5XSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFkZChzLCBwcmVmaXgsIG9iaik7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkob2JqKSkgewogICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IG9iai5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgYWRkKHMsIG9ialtpXS5uYW1lLCBvYmpbaV0udmFsdWUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICAgIGJ1aWxkUGFyYW1zKGtleSwgb2JqW2tleV0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHM7CiAgICB9CgogICAgcmV0dXJuIGJ1aWxkUGFyYW1zKCcnLCBxdWVyeVBhcmFtc09iamVjdCkuam9pbignJicpLnJlcGxhY2UoLyUyMC9nLCAnKycpOwogIH0KICAvKgogICAqIFBhcnQgb2YgdGhlIGBzZXJpYWxpemVRdWVyeVBhcmFtc2AgaGVscGVyIGZ1bmN0aW9uLgogICAqLwoKICBmdW5jdGlvbiBhZGQocywgaywgdikgewogICAgLy8gU3RyaXAgb3V0IGtleXMgd2l0aCB1bmRlZmluZWQgdmFsdWUgYW5kIHJlcGxhY2UgbnVsbCB2YWx1ZXMgd2l0aAogICAgLy8gZW1wdHkgc3RyaW5ncyAobWltaWNzIGpRdWVyeS5hamF4KQogICAgaWYgKHYgPT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm47CiAgICB9IGVsc2UgaWYgKHYgPT09IG51bGwpIHsKICAgICAgdiA9ICcnOwogICAgfQoKICAgIHYgPSB0eXBlb2YgdiA9PT0gJ2Z1bmN0aW9uJyA/IHYoKSA6IHY7CiAgICBzW3MubGVuZ3RoXSA9IGVuY29kZVVSSUNvbXBvbmVudChrKSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2KTsKICB9CgogIHZhciBfZmV0Y2ggPSBudWxsOwogIGZ1bmN0aW9uIGdldEZldGNoRnVuY3Rpb24oKSB7CiAgICBpZiAoX2ZldGNoICE9PSBudWxsKSB7CiAgICAgIHJldHVybiBfZmV0Y2goKTsKICAgIH0KCiAgICBpZiAocmVxdWlyZS5oYXMoJ2ZldGNoJykpIHsKICAgICAgLy8gdXNlIGBmZXRjaGAgbW9kdWxlIGJ5IGRlZmF1bHQsIHRoaXMgaXMgY29tbW9ubHkgcHJvdmlkZWQgYnkgZW1iZXItZmV0Y2gKICAgICAgdmFyIGZldGNoRm4gPSByZXF1aXJlX19kZWZhdWx0KCdmZXRjaCcpLmRlZmF1bHQ7CgogICAgICBfZmV0Y2ggPSBmdW5jdGlvbiBfZmV0Y2goKSB7CiAgICAgICAgcmV0dXJuIGZldGNoRm47CiAgICAgIH07CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBmZXRjaCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAvLyBmYWxsYmFjayB0byB1c2luZyBnbG9iYWwgZmV0Y2gKICAgICAgX2ZldGNoID0gZnVuY3Rpb24gX2ZldGNoKCkgewogICAgICAgIHJldHVybiBmZXRjaDsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignY2Fubm90IGZpbmQgdGhlIGBmZXRjaGAgbW9kdWxlIG9yIHRoZSBgZmV0Y2hgIGdsb2JhbC4gRGlkIHlvdSBtZWFuIHRvIGluc3RhbGwgdGhlIGBlbWJlci1mZXRjaGAgYWRkb24/Jyk7CiAgICB9CgogICAgcmV0dXJuIF9mZXRjaCgpOwogIH0KCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL2FkYXB0ZXIKICAqLwoKICAvKioKICAgICMjIFVzaW5nIEJ1aWxkVVJMTWl4aW4KCiAgICBUbyB1c2UgVVJMIGJ1aWxkaW5nLCBpbmNsdWRlIHRoZSBtaXhpbiB3aGVuIGV4dGVuZGluZyBhbiBhZGFwdGVyLCBhbmQgY2FsbCBgYnVpbGRVUkxgIHdoZXJlIG5lZWRlZC4KICAgIFRoZSBkZWZhdWx0IGJlaGF2aW91ciBpcyBkZXNpZ25lZCBmb3IgUkVTVEFkYXB0ZXIuCgogICAgIyMjIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgQWRhcHRlciwgeyBCdWlsZFVSTE1peGluIH0gZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlcic7CgogICAgZXhwb3J0IGRlZmF1bHQgQWRhcHRlci5leHRlbmQoQnVpbGRVUkxNaXhpbiwgewogICAgICBmaW5kUmVjb3JkOiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgaWQsIHNuYXBzaG90KSB7CiAgICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRVUkwodHlwZS5tb2RlbE5hbWUsIGlkLCBzbmFwc2hvdCwgJ2ZpbmRSZWNvcmQnKTsKICAgICAgICByZXR1cm4gdGhpcy5hamF4KHVybCwgJ0dFVCcpOwogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgICMjIyBBdHRyaWJ1dGVzCgogICAgVGhlIGBob3N0YCBhbmQgYG5hbWVzcGFjZWAgYXR0cmlidXRlcyB3aWxsIGJlIHVzZWQgaWYgZGVmaW5lZCwgYW5kIGFyZSBvcHRpb25hbC4KCiAgICBAY2xhc3MgQnVpbGRVUkxNaXhpbgogICovCgogIHZhciBidWlsZFVybE1peGluID0gRW1iZXIuTWl4aW4uY3JlYXRlKHsKICAgIC8qKgogICAgICBCdWlsZHMgYSBVUkwgZm9yIGEgZ2l2ZW4gdHlwZSBhbmQgb3B0aW9uYWwgSUQuCiAgICAgICBCeSBkZWZhdWx0LCBpdCBwbHVyYWxpemVzIHRoZSB0eXBlJ3MgbmFtZSAoZm9yIGV4YW1wbGUsICdwb3N0JwogICAgICBiZWNvbWVzICdwb3N0cycgYW5kICdwZXJzb24nIGJlY29tZXMgJ3Blb3BsZScpLiBUbyBvdmVycmlkZSB0aGUKICAgICAgcGx1cmFsaXphdGlvbiBzZWUgW3BhdGhGb3JUeXBlXShCdWlsZFVybE1peGluL21ldGhvZHMvcGF0aEZvclR5cGU/YW5jaG9yPXBhdGhGb3JUeXBlKS4KICAgICAgIElmIGFuIElEIGlzIHNwZWNpZmllZCwgaXQgYWRkcyB0aGUgSUQgdG8gdGhlIHBhdGggZ2VuZXJhdGVkCiAgICAgIGZvciB0aGUgdHlwZSwgc2VwYXJhdGVkIGJ5IGEgYC9gLgogICAgICAgV2hlbiBjYWxsZWQgYnkgYFJFU1RBZGFwdGVyLmZpbmRNYW55KClgIHRoZSBgaWRgIGFuZCBgc25hcHNob3RgIHBhcmFtZXRlcnMKICAgICAgd2lsbCBiZSBhcnJheXMgb2YgaWRzIGFuZCBzbmFwc2hvdHMuCiAgICAgICBAbWV0aG9kIGJ1aWxkVVJMCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgICAgQHBhcmFtIHsoU3RyaW5nfEFycmF5fE9iamVjdCl9IGlkIHNpbmdsZSBpZCBvciBhcnJheSBvZiBpZHMgb3IgcXVlcnkKICAgICAgQHBhcmFtIHsoU25hcHNob3R8U25hcHNob3RSZWNvcmRBcnJheSl9IHNuYXBzaG90IHNpbmdsZSBzbmFwc2hvdCBvciBhcnJheSBvZiBzbmFwc2hvdHMKICAgICAgQHBhcmFtIHtTdHJpbmd9IHJlcXVlc3RUeXBlCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBxdWVyeSBvYmplY3Qgb2YgcXVlcnkgcGFyYW1ldGVycyB0byBzZW5kIGZvciBxdWVyeSByZXF1ZXN0cy4KICAgICAgQHJldHVybiB7U3RyaW5nfSB1cmwKICAgICovCiAgICBidWlsZFVSTDogZnVuY3Rpb24gYnVpbGRVUkwobW9kZWxOYW1lLCBpZCwgc25hcHNob3QsIHJlcXVlc3RUeXBlLCBxdWVyeSkgewogICAgICBzd2l0Y2ggKHJlcXVlc3RUeXBlKSB7CiAgICAgICAgY2FzZSAnZmluZFJlY29yZCc6CiAgICAgICAgICByZXR1cm4gdGhpcy51cmxGb3JGaW5kUmVjb3JkKGlkLCBtb2RlbE5hbWUsIHNuYXBzaG90KTsKCiAgICAgICAgY2FzZSAnZmluZEFsbCc6CiAgICAgICAgICByZXR1cm4gdGhpcy51cmxGb3JGaW5kQWxsKG1vZGVsTmFtZSwgc25hcHNob3QpOwoKICAgICAgICBjYXNlICdxdWVyeSc6CiAgICAgICAgICByZXR1cm4gdGhpcy51cmxGb3JRdWVyeShxdWVyeSwgbW9kZWxOYW1lKTsKCiAgICAgICAgY2FzZSAncXVlcnlSZWNvcmQnOgogICAgICAgICAgcmV0dXJuIHRoaXMudXJsRm9yUXVlcnlSZWNvcmQocXVlcnksIG1vZGVsTmFtZSk7CgogICAgICAgIGNhc2UgJ2ZpbmRNYW55JzoKICAgICAgICAgIHJldHVybiB0aGlzLnVybEZvckZpbmRNYW55KGlkLCBtb2RlbE5hbWUsIHNuYXBzaG90KTsKCiAgICAgICAgY2FzZSAnZmluZEhhc01hbnknOgogICAgICAgICAgcmV0dXJuIHRoaXMudXJsRm9yRmluZEhhc01hbnkoaWQsIG1vZGVsTmFtZSwgc25hcHNob3QpOwoKICAgICAgICBjYXNlICdmaW5kQmVsb25nc1RvJzoKICAgICAgICAgIHJldHVybiB0aGlzLnVybEZvckZpbmRCZWxvbmdzVG8oaWQsIG1vZGVsTmFtZSwgc25hcHNob3QpOwoKICAgICAgICBjYXNlICdjcmVhdGVSZWNvcmQnOgogICAgICAgICAgcmV0dXJuIHRoaXMudXJsRm9yQ3JlYXRlUmVjb3JkKG1vZGVsTmFtZSwgc25hcHNob3QpOwoKICAgICAgICBjYXNlICd1cGRhdGVSZWNvcmQnOgogICAgICAgICAgcmV0dXJuIHRoaXMudXJsRm9yVXBkYXRlUmVjb3JkKGlkLCBtb2RlbE5hbWUsIHNuYXBzaG90KTsKCiAgICAgICAgY2FzZSAnZGVsZXRlUmVjb3JkJzoKICAgICAgICAgIHJldHVybiB0aGlzLnVybEZvckRlbGV0ZVJlY29yZChpZCwgbW9kZWxOYW1lLCBzbmFwc2hvdCk7CgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gdGhpcy5fYnVpbGRVUkwobW9kZWxOYW1lLCBpZCk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2QgX2J1aWxkVVJMCiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgICAgQHBhcmFtIHtTdHJpbmd9IGlkCiAgICAgIEByZXR1cm4ge1N0cmluZ30gdXJsCiAgICAqLwogICAgX2J1aWxkVVJMOiBmdW5jdGlvbiBfYnVpbGRVUkwobW9kZWxOYW1lLCBpZCkgewogICAgICB2YXIgcGF0aDsKICAgICAgdmFyIHVybCA9IFtdOwogICAgICB2YXIgaG9zdCA9IEVtYmVyLmdldCh0aGlzLCAnaG9zdCcpOwogICAgICB2YXIgcHJlZml4ID0gdGhpcy51cmxQcmVmaXgoKTsKCiAgICAgIGlmIChtb2RlbE5hbWUpIHsKICAgICAgICBwYXRoID0gdGhpcy5wYXRoRm9yVHlwZShtb2RlbE5hbWUpOwoKICAgICAgICBpZiAocGF0aCkgewogICAgICAgICAgdXJsLnB1c2gocGF0aCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaWQpIHsKICAgICAgICB1cmwucHVzaChlbmNvZGVVUklDb21wb25lbnQoaWQpKTsKICAgICAgfQoKICAgICAgaWYgKHByZWZpeCkgewogICAgICAgIHVybC51bnNoaWZ0KHByZWZpeCk7CiAgICAgIH0KCiAgICAgIHVybCA9IHVybC5qb2luKCcvJyk7CgogICAgICBpZiAoIWhvc3QgJiYgdXJsICYmIHVybC5jaGFyQXQoMCkgIT09ICcvJykgewogICAgICAgIHVybCA9ICcvJyArIHVybDsKICAgICAgfQoKICAgICAgcmV0dXJuIHVybDsKICAgIH0sCgogICAgLyoqCiAgICAgQnVpbGRzIGEgVVJMIGZvciBhIGBzdG9yZS5maW5kUmVjb3JkKHR5cGUsIGlkKWAgY2FsbC4KICAgICAgRXhhbXBsZToKICAgICAgYGBgYXBwL2FkYXB0ZXJzL3VzZXIuanMKICAgICBpbXBvcnQgSlNPTkFQSUFkYXB0ZXIgZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlci9qc29uLWFwaSc7CiAgICAgIGV4cG9ydCBkZWZhdWx0IEpTT05BUElBZGFwdGVyLmV4dGVuZCh7CiAgICAgICB1cmxGb3JGaW5kUmVjb3JkKGlkLCBtb2RlbE5hbWUsIHNuYXBzaG90KSB7CiAgICAgICAgIGxldCBiYXNlVXJsID0gdGhpcy5idWlsZFVSTChtb2RlbE5hbWUsIGlkLCBzbmFwc2hvdCk7CiAgICAgICAgIHJldHVybiBgJHtiYXNlVXJsfS91c2Vycy8ke3NuYXBzaG90LmFkYXB0ZXJPcHRpb25zLnVzZXJfaWR9L3BsYXlsaXN0cy8ke2lkfWA7CiAgICAgICB9CiAgICAgfSk7CiAgICAgYGBgCiAgICAgIEBtZXRob2QgdXJsRm9yRmluZFJlY29yZAogICAgIEBwYXJhbSB7U3RyaW5nfSBpZAogICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgICBAcGFyYW0ge1NuYXBzaG90fSBzbmFwc2hvdAogICAgIEByZXR1cm4ge1N0cmluZ30gdXJsCiAgICAgICovCiAgICB1cmxGb3JGaW5kUmVjb3JkOiBmdW5jdGlvbiB1cmxGb3JGaW5kUmVjb3JkKGlkLCBtb2RlbE5hbWUsIHNuYXBzaG90KSB7CiAgICAgIHJldHVybiB0aGlzLl9idWlsZFVSTChtb2RlbE5hbWUsIGlkKTsKICAgIH0sCgogICAgLyoqCiAgICAgQnVpbGRzIGEgVVJMIGZvciBhIGBzdG9yZS5maW5kQWxsKHR5cGUpYCBjYWxsLgogICAgICBFeGFtcGxlOgogICAgICBgYGBhcHAvYWRhcHRlcnMvY29tbWVudC5qcwogICAgIGltcG9ydCBKU09OQVBJQWRhcHRlciBmcm9tICdAZW1iZXItZGF0YS9hZGFwdGVyL2pzb24tYXBpJzsKICAgICAgZXhwb3J0IGRlZmF1bHQgSlNPTkFQSUFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgIHVybEZvckZpbmRBbGwobW9kZWxOYW1lLCBzbmFwc2hvdCkgewogICAgICAgICByZXR1cm4gJ2RhdGEvY29tbWVudHMuanNvbic7CiAgICAgICB9CiAgICAgfSk7CiAgICAgYGBgCiAgICAgIEBtZXRob2QgdXJsRm9yRmluZEFsbAogICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgICBAcGFyYW0ge1NuYXBzaG90UmVjb3JkQXJyYXl9IHNuYXBzaG90CiAgICAgQHJldHVybiB7U3RyaW5nfSB1cmwKICAgICAqLwogICAgdXJsRm9yRmluZEFsbDogZnVuY3Rpb24gdXJsRm9yRmluZEFsbChtb2RlbE5hbWUsIHNuYXBzaG90KSB7CiAgICAgIHJldHVybiB0aGlzLl9idWlsZFVSTChtb2RlbE5hbWUpOwogICAgfSwKCiAgICAvKioKICAgICBCdWlsZHMgYSBVUkwgZm9yIGEgYHN0b3JlLnF1ZXJ5KHR5cGUsIHF1ZXJ5KWAgY2FsbC4KICAgICAgRXhhbXBsZToKICAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgaW1wb3J0IFJFU1RBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXIvcmVzdCc7CiAgICAgIGV4cG9ydCBkZWZhdWx0IFJFU1RBZGFwdGVyLmV4dGVuZCh7CiAgICAgICBob3N0OiAnaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbScsCiAgICAgICB1cmxGb3JRdWVyeSAocXVlcnksIG1vZGVsTmFtZSkgewogICAgICAgICBzd2l0Y2gobW9kZWxOYW1lKSB7CiAgICAgICAgICAgY2FzZSAncmVwbyc6CiAgICAgICAgICAgICByZXR1cm4gYGh0dHBzOi8vYXBpLmdpdGh1Yi5jb20vb3Jncy8ke3F1ZXJ5Lm9yZ0lkfS9yZXBvc2A7CiAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgIHJldHVybiB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpOwogICAgICAgICB9CiAgICAgICB9CiAgICAgfSk7CiAgICAgYGBgCiAgICAgIEBtZXRob2QgdXJsRm9yUXVlcnkKICAgICBAcGFyYW0ge09iamVjdH0gcXVlcnkKICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICAgQHJldHVybiB7U3RyaW5nfSB1cmwKICAgICAqLwogICAgdXJsRm9yUXVlcnk6IGZ1bmN0aW9uIHVybEZvclF1ZXJ5KHF1ZXJ5LCBtb2RlbE5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuX2J1aWxkVVJMKG1vZGVsTmFtZSk7CiAgICB9LAoKICAgIC8qKgogICAgIEJ1aWxkcyBhIFVSTCBmb3IgYSBgc3RvcmUucXVlcnlSZWNvcmQodHlwZSwgcXVlcnkpYCBjYWxsLgogICAgICBFeGFtcGxlOgogICAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgICBpbXBvcnQgUkVTVEFkYXB0ZXIgZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlci9yZXN0JzsKICAgICAgZXhwb3J0IGRlZmF1bHQgUkVTVEFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgIHVybEZvclF1ZXJ5UmVjb3JkKHsgc2x1ZyB9LCBtb2RlbE5hbWUpIHsKICAgICAgICAgbGV0IGJhc2VVcmwgPSB0aGlzLmJ1aWxkVVJMKCk7CiAgICAgICAgIHJldHVybiBgJHtiYXNlVXJsfS8ke2VuY29kZVVSSUNvbXBvbmVudChzbHVnKX1gOwogICAgICAgfQogICAgIH0pOwogICAgIGBgYAogICAgICBAbWV0aG9kIHVybEZvclF1ZXJ5UmVjb3JkCiAgICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5CiAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgIEByZXR1cm4ge1N0cmluZ30gdXJsCiAgICAgKi8KICAgIHVybEZvclF1ZXJ5UmVjb3JkOiBmdW5jdGlvbiB1cmxGb3JRdWVyeVJlY29yZChxdWVyeSwgbW9kZWxOYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLl9idWlsZFVSTChtb2RlbE5hbWUpOwogICAgfSwKCiAgICAvKioKICAgICBCdWlsZHMgYSBVUkwgZm9yIGNvYWxlc2NpbmcgbXVsdGlwbGUgYHN0b3JlLmZpbmRSZWNvcmQodHlwZSwgaWQpYAogICAgIHJlY29yZHMgaW50byAxIHJlcXVlc3Qgd2hlbiB0aGUgYWRhcHRlcidzIGBjb2FsZXNjZUZpbmRSZXF1ZXN0c2AKICAgICBwcm9wZXJ0eSBpcyBgdHJ1ZWAuCiAgICAgIEV4YW1wbGU6CiAgICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgIGltcG9ydCBSRVNUQWRhcHRlciBmcm9tICdAZW1iZXItZGF0YS9hZGFwdGVyL3Jlc3QnOwogICAgICBleHBvcnQgZGVmYXVsdCBSRVNUQWRhcHRlci5leHRlbmQoewogICAgICAgdXJsRm9yRmluZE1hbnkoaWRzLCBtb2RlbE5hbWUpIHsKICAgICAgICAgbGV0IGJhc2VVcmwgPSB0aGlzLmJ1aWxkVVJMKCk7CiAgICAgICAgIHJldHVybiBgJHtiYXNlVXJsfS9jb2FsZXNjZWA7CiAgICAgICB9CiAgICAgfSk7CiAgICAgYGBgCiAgICAgIEBtZXRob2QgdXJsRm9yRmluZE1hbnkKICAgICBAcGFyYW0ge0FycmF5fSBpZHMKICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICAgQHBhcmFtIHtBcnJheX0gc25hcHNob3RzCiAgICAgQHJldHVybiB7U3RyaW5nfSB1cmwKICAgICAqLwogICAgdXJsRm9yRmluZE1hbnk6IGZ1bmN0aW9uIHVybEZvckZpbmRNYW55KGlkcywgbW9kZWxOYW1lLCBzbmFwc2hvdHMpIHsKICAgICAgcmV0dXJuIHRoaXMuX2J1aWxkVVJMKG1vZGVsTmFtZSk7CiAgICB9LAoKICAgIC8qKgogICAgIEJ1aWxkcyBhIFVSTCBmb3IgZmV0Y2hpbmcgYW4gYXN5bmMgYGhhc01hbnlgIHJlbGF0aW9uc2hpcCB3aGVuIGEgVVJMCiAgICAgaXMgbm90IHByb3ZpZGVkIGJ5IHRoZSBzZXJ2ZXIuCiAgICAgIEV4YW1wbGU6CiAgICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgIGltcG9ydCBKU09OQVBJQWRhcHRlciBmcm9tICdAZW1iZXItZGF0YS9hZGFwdGVyL2pzb24tYXBpJzsKICAgICAgZXhwb3J0IGRlZmF1bHQgSlNPTkFQSUFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgIHVybEZvckZpbmRIYXNNYW55KGlkLCBtb2RlbE5hbWUsIHNuYXBzaG90KSB7CiAgICAgICAgIGxldCBiYXNlVXJsID0gdGhpcy5idWlsZFVSTChtb2RlbE5hbWUsIGlkKTsKICAgICAgICAgcmV0dXJuIGAke2Jhc2VVcmx9L3JlbGF0aW9uc2hpcHNgOwogICAgICAgfQogICAgIH0pOwogICAgIGBgYAogICAgICBAbWV0aG9kIHVybEZvckZpbmRIYXNNYW55CiAgICAgQHBhcmFtIHtTdHJpbmd9IGlkCiAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgIEBwYXJhbSB7U25hcHNob3R9IHNuYXBzaG90CiAgICAgQHJldHVybiB7U3RyaW5nfSB1cmwKICAgICAqLwogICAgdXJsRm9yRmluZEhhc01hbnk6IGZ1bmN0aW9uIHVybEZvckZpbmRIYXNNYW55KGlkLCBtb2RlbE5hbWUsIHNuYXBzaG90KSB7CiAgICAgIHJldHVybiB0aGlzLl9idWlsZFVSTChtb2RlbE5hbWUsIGlkKTsKICAgIH0sCgogICAgLyoqCiAgICAgQnVpbGRzIGEgVVJMIGZvciBmZXRjaGluZyBhbiBhc3luYyBgYmVsb25nc1RvYCByZWxhdGlvbnNoaXAgd2hlbiBhIHVybAogICAgIGlzIG5vdCBwcm92aWRlZCBieSB0aGUgc2VydmVyLgogICAgICBFeGFtcGxlOgogICAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgICBpbXBvcnQgSlNPTkFQSUFkYXB0ZXIgZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlci9qc29uLWFwaSc7CiAgICAgIGV4cG9ydCBkZWZhdWx0IEpTT05BUElBZGFwdGVyLmV4dGVuZCh7CiAgICAgICB1cmxGb3JGaW5kQmVsb25nc1RvKGlkLCBtb2RlbE5hbWUsIHNuYXBzaG90KSB7CiAgICAgICAgIGxldCBiYXNlVXJsID0gdGhpcy5idWlsZFVSTChtb2RlbE5hbWUsIGlkKTsKICAgICAgICAgcmV0dXJuIGAke2Jhc2VVcmx9L3JlbGF0aW9uc2hpcHNgOwogICAgICAgfQogICAgIH0pOwogICAgIGBgYAogICAgICBAbWV0aG9kIHVybEZvckZpbmRCZWxvbmdzVG8KICAgICBAcGFyYW0ge1N0cmluZ30gaWQKICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICAgQHBhcmFtIHtTbmFwc2hvdH0gc25hcHNob3QKICAgICBAcmV0dXJuIHtTdHJpbmd9IHVybAogICAgICovCiAgICB1cmxGb3JGaW5kQmVsb25nc1RvOiBmdW5jdGlvbiB1cmxGb3JGaW5kQmVsb25nc1RvKGlkLCBtb2RlbE5hbWUsIHNuYXBzaG90KSB7CiAgICAgIHJldHVybiB0aGlzLl9idWlsZFVSTChtb2RlbE5hbWUsIGlkKTsKICAgIH0sCgogICAgLyoqCiAgICAgQnVpbGRzIGEgVVJMIGZvciBhIGByZWNvcmQuc2F2ZSgpYCBjYWxsIHdoZW4gdGhlIHJlY29yZCB3YXMgY3JlYXRlZAogICAgIGxvY2FsbHkgdXNpbmcgYHN0b3JlLmNyZWF0ZVJlY29yZCgpYC4KICAgICAgRXhhbXBsZToKICAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgaW1wb3J0IFJFU1RBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXIvcmVzdCc7CiAgICAgIGV4cG9ydCBkZWZhdWx0IFJFU1RBZGFwdGVyLmV4dGVuZCh7CiAgICAgICB1cmxGb3JDcmVhdGVSZWNvcmQobW9kZWxOYW1lLCBzbmFwc2hvdCkgewogICAgICAgICByZXR1cm4gdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKSArICcvbmV3JzsKICAgICAgIH0KICAgICB9KTsKICAgICBgYGAKICAgICAgQG1ldGhvZCB1cmxGb3JDcmVhdGVSZWNvcmQKICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICAgQHBhcmFtIHtTbmFwc2hvdH0gc25hcHNob3QKICAgICBAcmV0dXJuIHtTdHJpbmd9IHVybAogICAgICovCiAgICB1cmxGb3JDcmVhdGVSZWNvcmQ6IGZ1bmN0aW9uIHVybEZvckNyZWF0ZVJlY29yZChtb2RlbE5hbWUsIHNuYXBzaG90KSB7CiAgICAgIHJldHVybiB0aGlzLl9idWlsZFVSTChtb2RlbE5hbWUpOwogICAgfSwKCiAgICAvKioKICAgICBCdWlsZHMgYSBVUkwgZm9yIGEgYHJlY29yZC5zYXZlKClgIGNhbGwgd2hlbiB0aGUgcmVjb3JkIGhhcyBiZWVuIHVwZGF0ZWQgbG9jYWxseS4KICAgICAgRXhhbXBsZToKICAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgaW1wb3J0IFJFU1RBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXIvcmVzdCc7CiAgICAgIGV4cG9ydCBkZWZhdWx0IFJFU1RBZGFwdGVyLmV4dGVuZCh7CiAgICAgICB1cmxGb3JVcGRhdGVSZWNvcmQoaWQsIG1vZGVsTmFtZSwgc25hcHNob3QpIHsKICAgICAgICAgcmV0dXJuIGAvJHtpZH0vZmVlZD9hY2Nlc3NfdG9rZW49JHtzbmFwc2hvdC5hZGFwdGVyT3B0aW9ucy50b2tlbn1gOwogICAgICAgfQogICAgIH0pOwogICAgIGBgYAogICAgICBAbWV0aG9kIHVybEZvclVwZGF0ZVJlY29yZAogICAgIEBwYXJhbSB7U3RyaW5nfSBpZAogICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgICBAcGFyYW0ge1NuYXBzaG90fSBzbmFwc2hvdAogICAgIEByZXR1cm4ge1N0cmluZ30gdXJsCiAgICAgKi8KICAgIHVybEZvclVwZGF0ZVJlY29yZDogZnVuY3Rpb24gdXJsRm9yVXBkYXRlUmVjb3JkKGlkLCBtb2RlbE5hbWUsIHNuYXBzaG90KSB7CiAgICAgIHJldHVybiB0aGlzLl9idWlsZFVSTChtb2RlbE5hbWUsIGlkKTsKICAgIH0sCgogICAgLyoqCiAgICAgQnVpbGRzIGEgVVJMIGZvciBhIGByZWNvcmQuc2F2ZSgpYCBjYWxsIHdoZW4gdGhlIHJlY29yZCBoYXMgYmVlbiBkZWxldGVkIGxvY2FsbHkuCiAgICAgIEV4YW1wbGU6CiAgICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgIGltcG9ydCBSRVNUQWRhcHRlciBmcm9tICdAZW1iZXItZGF0YS9hZGFwdGVyL3Jlc3QnOwogICAgICBleHBvcnQgZGVmYXVsdCBSRVNUQWRhcHRlci5leHRlbmQoewogICAgICAgdXJsRm9yRGVsZXRlUmVjb3JkKGlkLCBtb2RlbE5hbWUsIHNuYXBzaG90KSB7CiAgICAgICAgIHJldHVybiB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpICsgJy9kZXN0cm95JzsKICAgICAgIH0KICAgICB9KTsKICAgICBgYGAKICAgICAgQG1ldGhvZCB1cmxGb3JEZWxldGVSZWNvcmQKICAgICBAcGFyYW0ge1N0cmluZ30gaWQKICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICAgQHBhcmFtIHtTbmFwc2hvdH0gc25hcHNob3QKICAgICBAcmV0dXJuIHtTdHJpbmd9IHVybAogICAgICovCiAgICB1cmxGb3JEZWxldGVSZWNvcmQ6IGZ1bmN0aW9uIHVybEZvckRlbGV0ZVJlY29yZChpZCwgbW9kZWxOYW1lLCBzbmFwc2hvdCkgewogICAgICByZXR1cm4gdGhpcy5fYnVpbGRVUkwobW9kZWxOYW1lLCBpZCk7CiAgICB9LAoKICAgIC8qKgogICAgICBAbWV0aG9kIHVybFByZWZpeAogICAgICBAcHJpdmF0ZQogICAgICBAcGFyYW0ge1N0cmluZ30gcGF0aAogICAgICBAcGFyYW0ge1N0cmluZ30gcGFyZW50VVJMCiAgICAgIEByZXR1cm4ge1N0cmluZ30gdXJsUHJlZml4CiAgICAqLwogICAgdXJsUHJlZml4OiBmdW5jdGlvbiB1cmxQcmVmaXgocGF0aCwgcGFyZW50VVJMKSB7CiAgICAgIHZhciBob3N0ID0gRW1iZXIuZ2V0KHRoaXMsICdob3N0Jyk7CiAgICAgIHZhciBuYW1lc3BhY2UgPSBFbWJlci5nZXQodGhpcywgJ25hbWVzcGFjZScpOwoKICAgICAgaWYgKCFob3N0IHx8IGhvc3QgPT09ICcvJykgewogICAgICAgIGhvc3QgPSAnJzsKICAgICAgfQoKICAgICAgaWYgKHBhdGgpIHsKICAgICAgICAvLyBQcm90b2NvbCByZWxhdGl2ZSB1cmwKICAgICAgICBpZiAoL15cL1wvLy50ZXN0KHBhdGgpIHx8IC9odHRwKHMpPzpcL1wvLy50ZXN0KHBhdGgpKSB7CiAgICAgICAgICAvLyBEbyBub3RoaW5nLCB0aGUgZnVsbCBob3N0IGlzIGFscmVhZHkgaW5jbHVkZWQuCiAgICAgICAgICByZXR1cm4gcGF0aDsgLy8gQWJzb2x1dGUgcGF0aAogICAgICAgIH0gZWxzZSBpZiAocGF0aC5jaGFyQXQoMCkgPT09ICcvJykgewogICAgICAgICAgcmV0dXJuICIiICsgaG9zdCArIHBhdGg7IC8vIFJlbGF0aXZlIHBhdGgKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHBhcmVudFVSTCArICIvIiArIHBhdGg7CiAgICAgICAgfQogICAgICB9IC8vIE5vIHBhdGggcHJvdmlkZWQKCgogICAgICB2YXIgdXJsID0gW107CgogICAgICBpZiAoaG9zdCkgewogICAgICAgIHVybC5wdXNoKGhvc3QpOwogICAgICB9CgogICAgICBpZiAobmFtZXNwYWNlKSB7CiAgICAgICAgdXJsLnB1c2gobmFtZXNwYWNlKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHVybC5qb2luKCcvJyk7CiAgICB9LAoKICAgIC8qKgogICAgICBEZXRlcm1pbmVzIHRoZSBwYXRobmFtZSBmb3IgYSBnaXZlbiB0eXBlLgogICAgICAgQnkgZGVmYXVsdCwgaXQgcGx1cmFsaXplcyB0aGUgdHlwZSdzIG5hbWUgKGZvciBleGFtcGxlLAogICAgICAncG9zdCcgYmVjb21lcyAncG9zdHMnIGFuZCAncGVyc29uJyBiZWNvbWVzICdwZW9wbGUnKS4KICAgICAgICMjIyBQYXRobmFtZSBjdXN0b21pemF0aW9uCiAgICAgICBGb3IgZXhhbXBsZSwgaWYgeW91IGhhdmUgYW4gb2JqZWN0IGBMaW5lSXRlbWAgd2l0aCBhbgogICAgICBlbmRwb2ludCBvZiBgL2xpbmVfaXRlbXMvYC4KICAgICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgUkVTVEFkYXB0ZXIgZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlci9yZXN0JzsKICAgICAgaW1wb3J0IHsgZGVjYW1lbGl6ZSB9IGZyb20gJ0BlbWJlci9zdHJpbmcnOwogICAgICBpbXBvcnQgeyBwbHVyYWxpemUgfSBmcm9tICdlbWJlci1pbmZsZWN0b3InOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUkVTVEFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICBwYXRoRm9yVHlwZTogZnVuY3Rpb24obW9kZWxOYW1lKSB7CiAgICAgICAgICB2YXIgZGVjYW1lbGl6ZWQgPSBkZWNhbWVsaXplKG1vZGVsTmFtZSk7CiAgICAgICAgICByZXR1cm4gcGx1cmFsaXplKGRlY2FtZWxpemVkKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgcGF0aEZvclR5cGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgICBAcmV0dXJuIHtTdHJpbmd9IHBhdGgKICAgICoqLwogICAgcGF0aEZvclR5cGU6IGZ1bmN0aW9uIHBhdGhGb3JUeXBlKG1vZGVsTmFtZSkgewogICAgICB2YXIgY2FtZWxpemVkID0gRW1iZXIuU3RyaW5nLmNhbWVsaXplKG1vZGVsTmFtZSk7CiAgICAgIHJldHVybiBlbWJlckluZmxlY3Rvci5wbHVyYWxpemUoY2FtZWxpemVkKTsKICAgIH0KICB9KTsKCiAgZnVuY3Rpb24gc2VyaWFsaXplSW50b0hhc2goc3RvcmUsIG1vZGVsQ2xhc3MsIHNuYXBzaG90LCBvcHRpb25zKSB7CiAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgIG9wdGlvbnMgPSB7CiAgICAgICAgaW5jbHVkZUlkOiB0cnVlCiAgICAgIH07CiAgICB9CgogICAgdmFyIHNlcmlhbGl6ZXIgPSBzdG9yZS5zZXJpYWxpemVyRm9yKG1vZGVsQ2xhc3MubW9kZWxOYW1lKTsKCiAgICBpZiAodHlwZW9mIHNlcmlhbGl6ZXIuc2VyaWFsaXplSW50b0hhc2ggPT09ICdmdW5jdGlvbicpIHsKICAgICAgdmFyIGRhdGEgPSB7fTsKICAgICAgc2VyaWFsaXplci5zZXJpYWxpemVJbnRvSGFzaChkYXRhLCBtb2RlbENsYXNzLCBzbmFwc2hvdCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBkYXRhOwogICAgfQoKICAgIHJldHVybiBzZXJpYWxpemVyLnNlcmlhbGl6ZShzbmFwc2hvdCwgb3B0aW9ucyk7CiAgfQoKICBleHBvcnRzLkJ1aWxkVVJMTWl4aW4gPSBidWlsZFVybE1peGluOwogIGV4cG9ydHMuZGV0ZXJtaW5lQm9keVByb21pc2UgPSBkZXRlcm1pbmVCb2R5UHJvbWlzZTsKICBleHBvcnRzLmZldGNoID0gZ2V0RmV0Y2hGdW5jdGlvbjsKICBleHBvcnRzLnBhcnNlUmVzcG9uc2VIZWFkZXJzID0gcGFyc2VSZXNwb25zZUhlYWRlcnM7CiAgZXhwb3J0cy5zZXJpYWxpemVJbnRvSGFzaCA9IHNlcmlhbGl6ZUludG9IYXNoOwogIGV4cG9ydHMuc2VyaWFsaXplUXVlcnlQYXJhbXMgPSBzZXJpYWxpemVRdWVyeVBhcmFtczsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgeyB2YWx1ZTogdHJ1ZSB9KTsKCn0pOwoKO2RlZmluZSgiQGVtYmVyLWRhdGEvYWRhcHRlci9lcnJvciIsIFsiZXhwb3J0cyIsICJAZW1iZXItZGF0YS9zdG9yZS8tcHJpdmF0ZSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9wcml2YXRlKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJlcnJvcnNIYXNoVG9BcnJheSIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9wcml2YXRlLmVycm9yc0hhc2hUb0FycmF5OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImVycm9yc0FycmF5VG9IYXNoIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3ByaXZhdGUuZXJyb3JzQXJyYXlUb0hhc2g7CiAgICB9CiAgfSk7CiAgX2V4cG9ydHMuU2VydmVyRXJyb3IgPSBfZXhwb3J0cy5Db25mbGljdEVycm9yID0gX2V4cG9ydHMuTm90Rm91bmRFcnJvciA9IF9leHBvcnRzLkZvcmJpZGRlbkVycm9yID0gX2V4cG9ydHMuVW5hdXRob3JpemVkRXJyb3IgPSBfZXhwb3J0cy5BYm9ydEVycm9yID0gX2V4cG9ydHMuVGltZW91dEVycm9yID0gX2V4cG9ydHMuSW52YWxpZEVycm9yID0gX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL2FkYXB0ZXIKICAqLwoKICAvKioKICAgIEEgYEFkYXB0ZXJFcnJvcmAgaXMgdXNlZCBieSBhbiBhZGFwdGVyIHRvIHNpZ25hbCB0aGF0IGFuIGVycm9yIG9jY3VycmVkCiAgICBkdXJpbmcgYSByZXF1ZXN0IHRvIGFuIGV4dGVybmFsIEFQSS4gSXQgaW5kaWNhdGVzIGEgZ2VuZXJpYyBlcnJvciwgYW5kCiAgICBzdWJjbGFzc2VzIGFyZSB1c2VkIHRvIGluZGljYXRlIHNwZWNpZmljIGVycm9yIHN0YXRlcy4gVGhlIGZvbGxvd2luZwogICAgc3ViY2xhc3NlcyBhcmUgcHJvdmlkZWQ6CiAgCiAgICAtIGBJbnZhbGlkRXJyb3JgCiAgICAtIGBUaW1lb3V0RXJyb3JgCiAgICAtIGBBYm9ydEVycm9yYAogICAgLSBgVW5hdXRob3JpemVkRXJyb3JgCiAgICAtIGBGb3JiaWRkZW5FcnJvcmAKICAgIC0gYE5vdEZvdW5kRXJyb3JgCiAgICAtIGBDb25mbGljdEVycm9yYAogICAgLSBgU2VydmVyRXJyb3JgCiAgCiAgICBUbyBjcmVhdGUgYSBjdXN0b20gZXJyb3IgdG8gc2lnbmFsIGEgc3BlY2lmaWMgZXJyb3Igc3RhdGUgaW4gY29tbXVuaWNhdGluZwogICAgd2l0aCBhbiBleHRlcm5hbCBBUEksIGV4dGVuZCB0aGUgYEFkYXB0ZXJFcnJvcmAuIEZvciBleGFtcGxlLCBpZiB0aGUKICAgIGV4dGVybmFsIEFQSSBleGNsdXNpdmVseSB1c2VkIEhUVFAgYDUwMyBTZXJ2aWNlIFVuYXZhaWxhYmxlYCB0byBpbmRpY2F0ZQogICAgaXQgd2FzIGNsb3NlZCBmb3IgbWFpbnRlbmFuY2U6CiAgCiAgICBgYGBhcHAvYWRhcHRlcnMvbWFpbnRlbmFuY2UtZXJyb3IuanMKICAgIGltcG9ydCBBZGFwdGVyRXJyb3IgZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlci9lcnJvcic7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBBZGFwdGVyRXJyb3IuZXh0ZW5kKHsgbWVzc2FnZTogIkRvd24gZm9yIG1haW50ZW5hbmNlLiIgfSk7CiAgICBgYGAKICAKICAgIFRoaXMgZXJyb3Igd291bGQgdGhlbiBiZSByZXR1cm5lZCBieSBhbiBhZGFwdGVyJ3MgYGhhbmRsZVJlc3BvbnNlYCBtZXRob2Q6CiAgCiAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgIGltcG9ydCBKU09OQVBJQWRhcHRlciBmcm9tICdAZW1iZXItZGF0YS9hZGFwdGVyL2pzb24tYXBpJzsKICAgIGltcG9ydCBNYWludGVuYW5jZUVycm9yIGZyb20gJy4vbWFpbnRlbmFuY2UtZXJyb3InOwogIAogICAgZXhwb3J0IGRlZmF1bHQgSlNPTkFQSUFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgaGFuZGxlUmVzcG9uc2Uoc3RhdHVzKSB7CiAgICAgICAgaWYgKDUwMyA9PT0gc3RhdHVzKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1haW50ZW5hbmNlRXJyb3IoKTsKICAgICAgICB9CiAgCiAgICAgICAgcmV0dXJuIHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBBbmQgY2FuIHRoZW4gYmUgZGV0ZWN0ZWQgaW4gYW4gYXBwbGljYXRpb24gYW5kIHVzZWQgdG8gc2VuZCB0aGUgdXNlciB0byBhbgogICAgYHVuZGVyLW1haW50ZW5hbmNlYCByb3V0ZToKICAKICAgIGBgYGFwcC9yb3V0ZXMvYXBwbGljYXRpb24uanMKICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICBpbXBvcnQgTWFpbnRlbmFuY2VFcnJvciBmcm9tICcuLi9hZGFwdGVycy9tYWludGVuYW5jZS1lcnJvcic7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgZXJyb3IoZXJyb3IsIHRyYW5zaXRpb24pIHsKICAgICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIE1haW50ZW5hbmNlRXJyb3IpIHsKICAgICAgICAgICAgdGhpcy50cmFuc2l0aW9uVG8oJ3VuZGVyLW1haW50ZW5hbmNlJyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAKICAgICAgICAgIC8vIC4uLm90aGVyIGVycm9yIGhhbmRsaW5nIGxvZ2ljCiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgQGNsYXNzIEFkYXB0ZXJFcnJvcgogICovCiAgZnVuY3Rpb24gQWRhcHRlckVycm9yKGVycm9ycywgbWVzc2FnZSkgewogICAgaWYgKG1lc3NhZ2UgPT09IHZvaWQgMCkgewogICAgICBtZXNzYWdlID0gJ0FkYXB0ZXIgb3BlcmF0aW9uIGZhaWxlZCc7CiAgICB9CgogICAgdGhpcy5pc0FkYXB0ZXJFcnJvciA9IHRydWU7CiAgICB2YXIgZXJyb3IgPSBFbWJlci5FcnJvci5jYWxsKHRoaXMsIG1lc3NhZ2UpOyAvLyBpbiBlbWJlciAzLjgrIEVycm9yIGlzIGEgTmF0aXZlIEVycm9yIGFuZCB3ZSBkb24ndAogICAgLy8gZ2FpbiB0aGVzZSBhdXRvbWF0aWNhbGx5IGZyb20gdGhlIEVtYmVyRXJyb3IuY2FsbAoKICAgIGlmIChlcnJvcikgewogICAgICB0aGlzLnN0YWNrID0gZXJyb3Iuc3RhY2s7CiAgICAgIHRoaXMuZGVzY3JpcHRpb24gPSBlcnJvci5kZXNjcmlwdGlvbjsKICAgICAgdGhpcy5maWxlTmFtZSA9IGVycm9yLmZpbGVOYW1lOwogICAgICB0aGlzLmxpbmVOdW1iZXIgPSBlcnJvci5saW5lTnVtYmVyOwogICAgICB0aGlzLm1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogICAgICB0aGlzLm5hbWUgPSBlcnJvci5uYW1lOwogICAgICB0aGlzLm51bWJlciA9IGVycm9yLm51bWJlcjsKICAgIH0KCiAgICB0aGlzLmVycm9ycyA9IGVycm9ycyB8fCBbewogICAgICB0aXRsZTogJ0FkYXB0ZXIgRXJyb3InLAogICAgICBkZXRhaWw6IG1lc3NhZ2UKICAgIH1dOwogIH0KCiAgdmFyIF9kZWZhdWx0ID0gQWRhcHRlckVycm9yOwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKCiAgZnVuY3Rpb24gZXh0ZW5kRm4oRXJyb3JDbGFzcykgewogICAgcmV0dXJuIGZ1bmN0aW9uIChfdGVtcCkgewogICAgICB2YXIgX3JlZiA9IF90ZW1wID09PSB2b2lkIDAgPyB7fSA6IF90ZW1wLAogICAgICAgICAgZGVmYXVsdE1lc3NhZ2UgPSBfcmVmLm1lc3NhZ2U7CgogICAgICByZXR1cm4gZXh0ZW5kKEVycm9yQ2xhc3MsIGRlZmF1bHRNZXNzYWdlKTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBleHRlbmQoUGFyZW50RXJyb3JDbGFzcywgZGVmYXVsdE1lc3NhZ2UpIHsKICAgIHZhciBFcnJvckNsYXNzID0gZnVuY3Rpb24gRXJyb3JDbGFzcyhlcnJvcnMsIG1lc3NhZ2UpIHsKICAgICAgKGZhbHNlICYmICEoQXJyYXkuaXNBcnJheShlcnJvcnMgfHwgW10pKSAmJiBFbWJlci5hc3NlcnQoJ2BBZGFwdGVyRXJyb3JgIGV4cGVjdHMganNvbi1hcGkgZm9ybWF0dGVkIGVycm9ycyBhcnJheS4nLCBBcnJheS5pc0FycmF5KGVycm9ycyB8fCBbXSkpKTsKICAgICAgUGFyZW50RXJyb3JDbGFzcy5jYWxsKHRoaXMsIGVycm9ycywgbWVzc2FnZSB8fCBkZWZhdWx0TWVzc2FnZSk7CiAgICB9OwoKICAgIEVycm9yQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQYXJlbnRFcnJvckNsYXNzLnByb3RvdHlwZSk7CiAgICBFcnJvckNsYXNzLmV4dGVuZCA9IGV4dGVuZEZuKEVycm9yQ2xhc3MpOwogICAgcmV0dXJuIEVycm9yQ2xhc3M7CiAgfQoKICBBZGFwdGVyRXJyb3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShFbWJlci5FcnJvci5wcm90b3R5cGUpOwogIEFkYXB0ZXJFcnJvci5wcm90b3R5cGUuY29kZSA9ICdBZGFwdGVyRXJyb3InOwogIEFkYXB0ZXJFcnJvci5leHRlbmQgPSBleHRlbmRGbihBZGFwdGVyRXJyb3IpOwogIC8qKgogICAgQSBgSW52YWxpZEVycm9yYCBpcyB1c2VkIGJ5IGFuIGFkYXB0ZXIgdG8gc2lnbmFsIHRoZSBleHRlcm5hbCBBUEkKICAgIHdhcyB1bmFibGUgdG8gcHJvY2VzcyBhIHJlcXVlc3QgYmVjYXVzZSB0aGUgY29udGVudCB3YXMgbm90CiAgICBzZW1hbnRpY2FsbHkgY29ycmVjdCBvciBtZWFuaW5nZnVsIHBlciB0aGUgQVBJLiBVc3VhbGx5LCB0aGlzIG1lYW5zIGEKICAgIHJlY29yZCBmYWlsZWQgc29tZSBmb3JtIG9mIHNlcnZlci1zaWRlIHZhbGlkYXRpb24uIFdoZW4gYSBwcm9taXNlCiAgICBmcm9tIGFuIGFkYXB0ZXIgaXMgcmVqZWN0ZWQgd2l0aCBhIGBJbnZhbGlkRXJyb3JgIHRoZSByZWNvcmQgd2lsbAogICAgdHJhbnNpdGlvbiB0byB0aGUgYGludmFsaWRgIHN0YXRlIGFuZCB0aGUgZXJyb3JzIHdpbGwgYmUgc2V0IHRvIHRoZQogICAgYGVycm9yc2AgcHJvcGVydHkgb24gdGhlIHJlY29yZC4KICAKICAgIEZvciBFbWJlciBEYXRhIHRvIGNvcnJlY3RseSBtYXAgZXJyb3JzIHRvIHRoZWlyIGNvcnJlc3BvbmRpbmcKICAgIHByb3BlcnRpZXMgb24gdGhlIG1vZGVsLCBFbWJlciBEYXRhIGV4cGVjdHMgZWFjaCBlcnJvciB0byBiZQogICAgYSB2YWxpZCBKU09OLUFQSSBlcnJvciBvYmplY3Qgd2l0aCBhIGBzb3VyY2UvcG9pbnRlcmAgdGhhdCBtYXRjaGVzCiAgICB0aGUgcHJvcGVydHkgbmFtZS4gRm9yIGV4YW1wbGUsIGlmIHlvdSBoYWQgYSBQb3N0IG1vZGVsIHRoYXQKICAgIGxvb2tlZCBsaWtlIHRoaXMuCiAgCiAgICBgYGBhcHAvbW9kZWxzL3Bvc3QuanMKICAgIGltcG9ydCBNb2RlbCwgeyBhdHRyIH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogIAogICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgdGl0bGU6IGF0dHIoJ3N0cmluZycpLAogICAgICBjb250ZW50OiBhdHRyKCdzdHJpbmcnKQogICAgfSk7CiAgICBgYGAKICAKICAgIFRvIHNob3cgYW4gZXJyb3IgZnJvbSB0aGUgc2VydmVyIHJlbGF0ZWQgdG8gdGhlIGB0aXRsZWAgYW5kCiAgICBgY29udGVudGAgcHJvcGVydGllcyB5b3VyIGFkYXB0ZXIgY291bGQgcmV0dXJuIGEgcHJvbWlzZSB0aGF0CiAgICByZWplY3RzIHdpdGggYSBgSW52YWxpZEVycm9yYCBvYmplY3QgdGhhdCBsb29rcyBsaWtlIHRoaXM6CiAgCiAgICBgYGBhcHAvYWRhcHRlcnMvcG9zdC5qcwogICAgaW1wb3J0IFJTVlAgZnJvbSAnUlNWUCc7CiAgICBpbXBvcnQgUkVTVEFkYXB0ZXIgZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlci9yZXN0JzsKICAgIGltcG9ydCB7IEludmFsaWRFcnJvciB9IGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXIvZXJyb3InOwogIAogICAgZXhwb3J0IGRlZmF1bHQgUkVTVEFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgdXBkYXRlUmVjb3JkKCkgewogICAgICAgIC8vIEZpY3Rpb25hbCBhZGFwdGVyIHRoYXQgYWx3YXlzIHJlamVjdHMKICAgICAgICByZXR1cm4gUlNWUC5yZWplY3QobmV3IEludmFsaWRFcnJvcihbCiAgICAgICAgICB7CiAgICAgICAgICAgIGRldGFpbDogJ011c3QgYmUgdW5pcXVlJywKICAgICAgICAgICAgc291cmNlOiB7IHBvaW50ZXI6ICcvZGF0YS9hdHRyaWJ1dGVzL3RpdGxlJyB9CiAgICAgICAgICB9LAogICAgICAgICAgewogICAgICAgICAgICBkZXRhaWw6ICdNdXN0IG5vdCBiZSBibGFuaycsCiAgICAgICAgICAgIHNvdXJjZTogeyBwb2ludGVyOiAnL2RhdGEvYXR0cmlidXRlcy9jb250ZW50J30KICAgICAgICAgIH0KICAgICAgICBdKSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBZb3VyIGJhY2tlbmQgbWF5IHVzZSBkaWZmZXJlbnQgcHJvcGVydHkgbmFtZXMgZm9yIHlvdXIgcmVjb3JkcyB0aGUKICAgIHN0b3JlIHdpbGwgYXR0ZW1wdCB0byBleHRyYWN0IGFuZCBub3JtYWxpemUgdGhlIGVycm9ycyB1c2luZyB0aGUKICAgIHNlcmlhbGl6ZXIncyBgZXh0cmFjdEVycm9yc2AgbWV0aG9kIGJlZm9yZSB0aGUgZXJyb3JzIGdldCBhZGRlZCB0bwogICAgdGhlIG1vZGVsLiBBcyBhIHJlc3VsdCwgaXQgaXMgc2FmZSBmb3IgdGhlIGBJbnZhbGlkRXJyb3JgIHRvCiAgICB3cmFwIHRoZSBlcnJvciBwYXlsb2FkIHVuYWx0ZXJlZC4KICAKICAgIEBjbGFzcyBJbnZhbGlkRXJyb3IKICAgIEBleHRlbmRzIEFkYXB0ZXJFcnJvcgogICovCgogIHZhciBJbnZhbGlkRXJyb3IgPSBleHRlbmQoQWRhcHRlckVycm9yLCAnVGhlIGFkYXB0ZXIgcmVqZWN0ZWQgdGhlIGNvbW1pdCBiZWNhdXNlIGl0IHdhcyBpbnZhbGlkJyk7CiAgX2V4cG9ydHMuSW52YWxpZEVycm9yID0gSW52YWxpZEVycm9yOwogIEludmFsaWRFcnJvci5wcm90b3R5cGUuY29kZSA9ICdJbnZhbGlkRXJyb3InOwogIC8qKgogICAgQSBgVGltZW91dEVycm9yYCBpcyB1c2VkIGJ5IGFuIGFkYXB0ZXIgdG8gc2lnbmFsIHRoYXQgYSByZXF1ZXN0CiAgICB0byB0aGUgZXh0ZXJuYWwgQVBJIGhhcyB0aW1lZCBvdXQuIEkuZS4gbm8gcmVzcG9uc2Ugd2FzIHJlY2VpdmVkIGZyb20KICAgIHRoZSBleHRlcm5hbCBBUEkgd2l0aGluIGFuIGFsbG93ZWQgdGltZSBwZXJpb2QuCiAgCiAgICBBbiBleGFtcGxlIHVzZSBjYXNlIHdvdWxkIGJlIHRvIHdhcm4gdGhlIHVzZXIgdG8gY2hlY2sgdGhlaXIgaW50ZXJuZXQKICAgIGNvbm5lY3Rpb24gaWYgYW4gYWRhcHRlciBvcGVyYXRpb24gaGFzIHRpbWVkIG91dDoKICAKICAgIGBgYGFwcC9yb3V0ZXMvYXBwbGljYXRpb24uanMKICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICBpbXBvcnQgeyBUaW1lb3V0RXJyb3IgfSBmcm9tICdAZW1iZXItZGF0YS9hZGFwdGVyL2Vycm9yJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgIGFjdGlvbnM6IHsKICAgICAgICBlcnJvcihlcnJvciwgdHJhbnNpdGlvbikgewogICAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgVGltZW91dEVycm9yKSB7CiAgICAgICAgICAgIC8vIGFsZXJ0IHRoZSB1c2VyCiAgICAgICAgICAgIGFsZXJ0KCdBcmUgeW91IHN0aWxsIGNvbm5lY3RlZCB0byB0aGUgaW50ZXJuZXQ/Jyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAKICAgICAgICAgIC8vIC4uLm90aGVyIGVycm9yIGhhbmRsaW5nIGxvZ2ljCiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgQGNsYXNzIFRpbWVvdXRFcnJvcgogICAgQGV4dGVuZHMgQWRhcHRlckVycm9yCiAgKi8KCiAgdmFyIFRpbWVvdXRFcnJvciA9IGV4dGVuZChBZGFwdGVyRXJyb3IsICdUaGUgYWRhcHRlciBvcGVyYXRpb24gdGltZWQgb3V0Jyk7CiAgX2V4cG9ydHMuVGltZW91dEVycm9yID0gVGltZW91dEVycm9yOwogIFRpbWVvdXRFcnJvci5wcm90b3R5cGUuY29kZSA9ICdUaW1lb3V0RXJyb3InOwogIC8qKgogICAgQSBgQWJvcnRFcnJvcmAgaXMgdXNlZCBieSBhbiBhZGFwdGVyIHRvIHNpZ25hbCB0aGF0IGEgcmVxdWVzdCB0bwogICAgdGhlIGV4dGVybmFsIEFQSSB3YXMgYWJvcnRlZC4gRm9yIGV4YW1wbGUsIHRoaXMgY2FuIG9jY3VyIGlmIHRoZSB1c2VyCiAgICBuYXZpZ2F0ZXMgYXdheSBmcm9tIHRoZSBjdXJyZW50IHBhZ2UgYWZ0ZXIgYSByZXF1ZXN0IHRvIHRoZSBleHRlcm5hbCBBUEkKICAgIGhhcyBiZWVuIGluaXRpYXRlZCBidXQgYmVmb3JlIGEgcmVzcG9uc2UgaGFzIGJlZW4gcmVjZWl2ZWQuCiAgCiAgICBAY2xhc3MgQWJvcnRFcnJvcgogICAgQGV4dGVuZHMgQWRhcHRlckVycm9yCiAgKi8KCiAgdmFyIEFib3J0RXJyb3IgPSBleHRlbmQoQWRhcHRlckVycm9yLCAnVGhlIGFkYXB0ZXIgb3BlcmF0aW9uIHdhcyBhYm9ydGVkJyk7CiAgX2V4cG9ydHMuQWJvcnRFcnJvciA9IEFib3J0RXJyb3I7CiAgQWJvcnRFcnJvci5wcm90b3R5cGUuY29kZSA9ICdBYm9ydEVycm9yJzsKICAvKioKICAgIEEgYFVuYXV0aG9yaXplZEVycm9yYCBlcXVhdGVzIHRvIGEgSFRUUCBgNDAxIFVuYXV0aG9yaXplZGAgcmVzcG9uc2UKICAgIHN0YXR1cy4gSXQgaXMgdXNlZCBieSBhbiBhZGFwdGVyIHRvIHNpZ25hbCB0aGF0IGEgcmVxdWVzdCB0byB0aGUgZXh0ZXJuYWwKICAgIEFQSSB3YXMgcmVqZWN0ZWQgYmVjYXVzZSBhdXRob3JpemF0aW9uIGlzIHJlcXVpcmVkIGFuZCBoYXMgZmFpbGVkIG9yIGhhcyBub3QKICAgIHlldCBiZWVuIHByb3ZpZGVkLgogIAogICAgQW4gZXhhbXBsZSB1c2UgY2FzZSB3b3VsZCBiZSB0byByZWRpcmVjdCB0aGUgdXNlciB0byBhIGxvZ2luIHJvdXRlIGlmIGEKICAgIHJlcXVlc3QgaXMgdW5hdXRob3JpemVkOgogIAogICAgYGBgYXBwL3JvdXRlcy9hcHBsaWNhdGlvbi5qcwogICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgIGltcG9ydCB7IFVuYXV0aG9yaXplZEVycm9yIH0gZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlci9lcnJvcic7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgZXJyb3IoZXJyb3IsIHRyYW5zaXRpb24pIHsKICAgICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIFVuYXV0aG9yaXplZEVycm9yKSB7CiAgICAgICAgICAgIC8vIGdvIHRvIHRoZSBzaWduIGluIHJvdXRlCiAgICAgICAgICAgIHRoaXMudHJhbnNpdGlvblRvKCdsb2dpbicpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgCiAgICAgICAgICAvLyAuLi5vdGhlciBlcnJvciBoYW5kbGluZyBsb2dpYwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIEBjbGFzcyBVbmF1dGhvcml6ZWRFcnJvcgogICAgQGV4dGVuZHMgQWRhcHRlckVycm9yCiAgKi8KCiAgdmFyIFVuYXV0aG9yaXplZEVycm9yID0gZXh0ZW5kKEFkYXB0ZXJFcnJvciwgJ1RoZSBhZGFwdGVyIG9wZXJhdGlvbiBpcyB1bmF1dGhvcml6ZWQnKTsKICBfZXhwb3J0cy5VbmF1dGhvcml6ZWRFcnJvciA9IFVuYXV0aG9yaXplZEVycm9yOwogIFVuYXV0aG9yaXplZEVycm9yLnByb3RvdHlwZS5jb2RlID0gJ1VuYXV0aG9yaXplZEVycm9yJzsKICAvKioKICAgIEEgYEZvcmJpZGRlbkVycm9yYCBlcXVhdGVzIHRvIGEgSFRUUCBgNDAzIEZvcmJpZGRlbmAgcmVzcG9uc2Ugc3RhdHVzLgogICAgSXQgaXMgdXNlZCBieSBhbiBhZGFwdGVyIHRvIHNpZ25hbCB0aGF0IGEgcmVxdWVzdCB0byB0aGUgZXh0ZXJuYWwgQVBJIHdhcwogICAgdmFsaWQgYnV0IHRoZSBzZXJ2ZXIgaXMgcmVmdXNpbmcgdG8gcmVzcG9uZCB0byBpdC4gSWYgYXV0aG9yaXphdGlvbiB3YXMKICAgIHByb3ZpZGVkIGFuZCBpcyB2YWxpZCwgdGhlbiB0aGUgYXV0aGVudGljYXRlZCB1c2VyIGRvZXMgbm90IGhhdmUgdGhlCiAgICBuZWNlc3NhcnkgcGVybWlzc2lvbnMgZm9yIHRoZSByZXF1ZXN0LgogIAogICAgQGNsYXNzIEZvcmJpZGRlbkVycm9yCiAgICBAZXh0ZW5kcyBBZGFwdGVyRXJyb3IKICAqLwoKICB2YXIgRm9yYmlkZGVuRXJyb3IgPSBleHRlbmQoQWRhcHRlckVycm9yLCAnVGhlIGFkYXB0ZXIgb3BlcmF0aW9uIGlzIGZvcmJpZGRlbicpOwogIF9leHBvcnRzLkZvcmJpZGRlbkVycm9yID0gRm9yYmlkZGVuRXJyb3I7CiAgRm9yYmlkZGVuRXJyb3IucHJvdG90eXBlLmNvZGUgPSAnRm9yYmlkZGVuRXJyb3InOwogIC8qKgogICAgQSBgTm90Rm91bmRFcnJvcmAgZXF1YXRlcyB0byBhIEhUVFAgYDQwNCBOb3QgRm91bmRgIHJlc3BvbnNlIHN0YXR1cy4KICAgIEl0IGlzIHVzZWQgYnkgYW4gYWRhcHRlciB0byBzaWduYWwgdGhhdCBhIHJlcXVlc3QgdG8gdGhlIGV4dGVybmFsIEFQSQogICAgd2FzIHJlamVjdGVkIGJlY2F1c2UgdGhlIHJlc291cmNlIGNvdWxkIG5vdCBiZSBmb3VuZCBvbiB0aGUgQVBJLgogIAogICAgQW4gZXhhbXBsZSB1c2UgY2FzZSB3b3VsZCBiZSB0byBkZXRlY3QgaWYgdGhlIHVzZXIgaGFzIGVudGVyZWQgYSByb3V0ZQogICAgZm9yIGEgc3BlY2lmaWMgbW9kZWwgdGhhdCBkb2VzIG5vdCBleGlzdC4gRm9yIGV4YW1wbGU6CiAgCiAgICBgYGBhcHAvcm91dGVzL3Bvc3QuanMKICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICBpbXBvcnQgeyBOb3RGb3VuZEVycm9yIH0gZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlci9lcnJvcic7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoewogICAgICBtb2RlbChwYXJhbXMpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXQoJ3N0b3JlJykuZmluZFJlY29yZCgncG9zdCcsIHBhcmFtcy5wb3N0X2lkKTsKICAgICAgfSwKICAKICAgICAgYWN0aW9uczogewogICAgICAgIGVycm9yKGVycm9yLCB0cmFuc2l0aW9uKSB7CiAgICAgICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEVycm9yKSB7CiAgICAgICAgICAgIC8vIHJlZGlyZWN0IHRvIGEgbGlzdCBvZiBhbGwgcG9zdHMgaW5zdGVhZAogICAgICAgICAgICB0aGlzLnRyYW5zaXRpb25UbygncG9zdHMnKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIG90aGVyd2lzZSBsZXQgdGhlIGVycm9yIGJ1YmJsZQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBAY2xhc3MgTm90Rm91bmRFcnJvcgogICAgQGV4dGVuZHMgQWRhcHRlckVycm9yCiAgKi8KCiAgdmFyIE5vdEZvdW5kRXJyb3IgPSBleHRlbmQoQWRhcHRlckVycm9yLCAnVGhlIGFkYXB0ZXIgY291bGQgbm90IGZpbmQgdGhlIHJlc291cmNlJyk7CiAgX2V4cG9ydHMuTm90Rm91bmRFcnJvciA9IE5vdEZvdW5kRXJyb3I7CiAgTm90Rm91bmRFcnJvci5wcm90b3R5cGUuY29kZSA9ICdOb3RGb3VuZEVycm9yJzsKICAvKioKICAgIEEgYENvbmZsaWN0RXJyb3JgIGVxdWF0ZXMgdG8gYSBIVFRQIGA0MDkgQ29uZmxpY3RgIHJlc3BvbnNlIHN0YXR1cy4KICAgIEl0IGlzIHVzZWQgYnkgYW4gYWRhcHRlciB0byBpbmRpY2F0ZSB0aGF0IHRoZSByZXF1ZXN0IGNvdWxkIG5vdCBiZSBwcm9jZXNzZWQKICAgIGJlY2F1c2Ugb2YgYSBjb25mbGljdCBpbiB0aGUgcmVxdWVzdC4gQW4gZXhhbXBsZSBzY2VuYXJpbyB3b3VsZCBiZSB3aGVuCiAgICBjcmVhdGluZyBhIHJlY29yZCB3aXRoIGEgY2xpZW50LWdlbmVyYXRlZCBJRCBidXQgdGhhdCBJRCBpcyBhbHJlYWR5IGtub3duCiAgICB0byB0aGUgZXh0ZXJuYWwgQVBJLgogIAogICAgQGNsYXNzIENvbmZsaWN0RXJyb3IKICAgIEBleHRlbmRzIEFkYXB0ZXJFcnJvcgogICovCgogIHZhciBDb25mbGljdEVycm9yID0gZXh0ZW5kKEFkYXB0ZXJFcnJvciwgJ1RoZSBhZGFwdGVyIG9wZXJhdGlvbiBmYWlsZWQgZHVlIHRvIGEgY29uZmxpY3QnKTsKICBfZXhwb3J0cy5Db25mbGljdEVycm9yID0gQ29uZmxpY3RFcnJvcjsKICBDb25mbGljdEVycm9yLnByb3RvdHlwZS5jb2RlID0gJ0NvbmZsaWN0RXJyb3InOwogIC8qKgogICAgQSBgU2VydmVyRXJyb3JgIGVxdWF0ZXMgdG8gYSBIVFRQIGA1MDAgSW50ZXJuYWwgU2VydmVyIEVycm9yYCByZXNwb25zZQogICAgc3RhdHVzLiBJdCBpcyB1c2VkIGJ5IHRoZSBhZGFwdGVyIHRvIGluZGljYXRlIHRoYXQgYSByZXF1ZXN0IGhhcyBmYWlsZWQKICAgIGJlY2F1c2Ugb2YgYW4gZXJyb3IgaW4gdGhlIGV4dGVybmFsIEFQSS4KICAKICAgIEBjbGFzcyBTZXJ2ZXJFcnJvcgogICAgQGV4dGVuZHMgQWRhcHRlckVycm9yCiAgKi8KCiAgdmFyIFNlcnZlckVycm9yID0gZXh0ZW5kKEFkYXB0ZXJFcnJvciwgJ1RoZSBhZGFwdGVyIG9wZXJhdGlvbiBmYWlsZWQgZHVlIHRvIGEgc2VydmVyIGVycm9yJyk7CiAgX2V4cG9ydHMuU2VydmVyRXJyb3IgPSBTZXJ2ZXJFcnJvcjsKICBTZXJ2ZXJFcnJvci5wcm90b3R5cGUuY29kZSA9ICdTZXJ2ZXJFcnJvcic7Cn0pOwo7ZGVmaW5lKCJAZW1iZXItZGF0YS9hZGFwdGVyL2luZGV4IiwgWyJleHBvcnRzIiwgIkBlbWJlci1kYXRhL2FkYXB0ZXIvLXByaXZhdGUiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfcHJpdmF0ZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiQnVpbGRVUkxNaXhpbiIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9wcml2YXRlLkJ1aWxkVVJMTWl4aW47CiAgICB9CiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgICBBbiBhZGFwdGVyIGlzIGFuIG9iamVjdCB0aGF0IHJlY2VpdmVzIHJlcXVlc3RzIGZyb20gYSBzdG9yZSBhbmQKICAgIHRyYW5zbGF0ZXMgdGhlbSBpbnRvIHRoZSBhcHByb3ByaWF0ZSBhY3Rpb24gdG8gdGFrZSBhZ2FpbnN0IHlvdXIKICAgIHBlcnNpc3RlbmNlIGxheWVyLiBUaGUgcGVyc2lzdGVuY2UgbGF5ZXIgaXMgdXN1YWxseSBhbiBIVFRQIEFQSSBidXQKICAgIG1heSBiZSBhbnl0aGluZywgc3VjaCBhcyB0aGUgYnJvd3NlcidzIGxvY2FsIHN0b3JhZ2UuIFR5cGljYWxseSB0aGUKICAgIGFkYXB0ZXIgaXMgbm90IGludm9rZWQgZGlyZWN0bHkgaW5zdGVhZCBpdHMgZnVuY3Rpb25hbGl0eSBpcyBhY2Nlc3NlZAogICAgdGhyb3VnaCB0aGUgYHN0b3JlYC4KICAKICAgICMjIyBDcmVhdGluZyBhbiBBZGFwdGVyCiAgCiAgICBDcmVhdGUgYSBuZXcgc3ViY2xhc3Mgb2YgYEFkYXB0ZXJgIGluIHRoZSBgYXBwL2FkYXB0ZXJzYCBmb2xkZXI6CiAgCiAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgIGltcG9ydCBBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXInOwogIAogICAgZXhwb3J0IGRlZmF1bHQgQWRhcHRlci5leHRlbmQoewogICAgICAvLyAuLi55b3VyIGNvZGUgaGVyZQogICAgfSk7CiAgICBgYGAKICAKICAgIE1vZGVsLXNwZWNpZmljIGFkYXB0ZXJzIGNhbiBiZSBjcmVhdGVkIGJ5IHB1dHRpbmcgeW91ciBhZGFwdGVyCiAgICBjbGFzcyBpbiBhbiBgYXBwL2FkYXB0ZXJzL2AgKyBgbW9kZWwtbmFtZWAgKyBgLmpzYCBmaWxlIG9mIHRoZSBhcHBsaWNhdGlvbi4KICAKICAgIGBgYGFwcC9hZGFwdGVycy9wb3N0LmpzCiAgICBpbXBvcnQgQWRhcHRlciBmcm9tICdAZW1iZXItZGF0YS9hZGFwdGVyJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IEFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgLy8gLi4uUG9zdC1zcGVjaWZpYyBhZGFwdGVyIGNvZGUgZ29lcyBoZXJlCiAgICB9KTsKICAgIGBgYAogIAogICAgYEFkYXB0ZXJgIGlzIGFuIGFic3RyYWN0IGJhc2UgY2xhc3MgdGhhdCB5b3Ugc2hvdWxkIG92ZXJyaWRlIGluIHlvdXIKICAgIGFwcGxpY2F0aW9uIHRvIGN1c3RvbWl6ZSBpdCBmb3IgeW91ciBiYWNrZW5kLiBUaGUgbWluaW11bSBzZXQgb2YgbWV0aG9kcwogICAgdGhhdCB5b3Ugc2hvdWxkIGltcGxlbWVudCBpczoKICAKICAgICAgKiBgZmluZFJlY29yZCgpYAogICAgICAqIGBjcmVhdGVSZWNvcmQoKWAKICAgICAgKiBgdXBkYXRlUmVjb3JkKClgCiAgICAgICogYGRlbGV0ZVJlY29yZCgpYAogICAgICAqIGBmaW5kQWxsKClgCiAgICAgICogYHF1ZXJ5KClgCiAgCiAgICBUbyBpbXByb3ZlIHRoZSBuZXR3b3JrIHBlcmZvcm1hbmNlIG9mIHlvdXIgYXBwbGljYXRpb24sIHlvdSBjYW4gb3B0aW1pemUKICAgIHlvdXIgYWRhcHRlciBieSBvdmVycmlkaW5nIHRoZXNlIGxvd2VyLWxldmVsIG1ldGhvZHM6CiAgCiAgICAgICogYGZpbmRNYW55KClgCiAgCiAgCiAgICBGb3IgYW4gZXhhbXBsZSBvZiB0aGUgaW1wbGVtZW50YXRpb24sIHNlZSBgUkVTVEFkYXB0ZXJgLCB0aGUKICAgIGluY2x1ZGVkIFJFU1QgYWRhcHRlci4KICAKICAgIEBtb2R1bGUgQGVtYmVyLWRhdGEvYWRhcHRlcgogICAgQGNsYXNzIEFkYXB0ZXIKICAgIEBleHRlbmRzIEVtYmVyT2JqZWN0CiAgKi8KICB2YXIgX2RlZmF1bHQgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIC8qKgogICAgICBJZiB5b3Ugd291bGQgbGlrZSB5b3VyIGFkYXB0ZXIgdG8gdXNlIGEgY3VzdG9tIHNlcmlhbGl6ZXIgeW91IGNhbgogICAgICBzZXQgdGhlIGBkZWZhdWx0U2VyaWFsaXplcmAgcHJvcGVydHkgdG8gYmUgdGhlIG5hbWUgb2YgdGhlIGN1c3RvbQogICAgICBzZXJpYWxpemVyLgogICAgICAgTm90ZSB0aGUgYGRlZmF1bHRTZXJpYWxpemVyYCBzZXJpYWxpemVyIGhhcyBhIGxvd2VyIHByaW9yaXR5IHRoYW4KICAgICAgYSBtb2RlbCBzcGVjaWZpYyBzZXJpYWxpemVyIChpLmUuIGBQb3N0U2VyaWFsaXplcmApIG9yIHRoZQogICAgICBgYXBwbGljYXRpb25gIHNlcmlhbGl6ZXIuCiAgICAgICBgYGBhcHAvYWRhcHRlcnMvZGphbmdvLmpzCiAgICAgIGltcG9ydCBBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXInOwogICAgICAgZXhwb3J0IGRlZmF1bHQgQWRhcHRlci5leHRlbmQoewogICAgICAgIGRlZmF1bHRTZXJpYWxpemVyOiAnZGphbmdvJwogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAZGVwcmVjYXRlZAogICAgICBAcHJvcGVydHkgZGVmYXVsdFNlcmlhbGl6ZXIKICAgICAgQHR5cGUge1N0cmluZ30KICAgICovCiAgICBkZWZhdWx0U2VyaWFsaXplcjogJy1kZWZhdWx0JywKCiAgICAvKioKICAgICAgVGhlIGBmaW5kUmVjb3JkKClgIG1ldGhvZCBpcyBpbnZva2VkIHdoZW4gdGhlIHN0b3JlIGlzIGFza2VkIGZvciBhIHJlY29yZCB0aGF0CiAgICAgIGhhcyBub3QgcHJldmlvdXNseSBiZWVuIGxvYWRlZC4gSW4gcmVzcG9uc2UgdG8gYGZpbmRSZWNvcmQoKWAgYmVpbmcgY2FsbGVkLCB5b3UKICAgICAgc2hvdWxkIHF1ZXJ5IHlvdXIgcGVyc2lzdGVuY2UgbGF5ZXIgZm9yIGEgcmVjb3JkIHdpdGggdGhlIGdpdmVuIElELiBUaGUgYGZpbmRSZWNvcmRgCiAgICAgIG1ldGhvZCBzaG91bGQgcmV0dXJuIGEgcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSB0byBhIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgd2lsbCBiZQogICAgICBub3JtYWxpemVkIGJ5IHRoZSBzZXJpYWxpemVyLgogICAgICAgSGVyZSBpcyBhbiBleGFtcGxlIG9mIHRoZSBgZmluZFJlY29yZGAgaW1wbGVtZW50YXRpb246CiAgICAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IEFkYXB0ZXIgZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlcic7CiAgICAgIGltcG9ydCBSU1ZQIGZyb20gJ1JTVlAnOwogICAgICBpbXBvcnQgJCBmcm9tICdqcXVlcnknOwogICAgICAgZXhwb3J0IGRlZmF1bHQgQWRhcHRlci5leHRlbmQoewogICAgICAgIGZpbmRSZWNvcmQoc3RvcmUsIHR5cGUsIGlkLCBzbmFwc2hvdCkgewogICAgICAgICAgcmV0dXJuIG5ldyBSU1ZQLlByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICQuZ2V0SlNPTihgLyR7dHlwZS5tb2RlbE5hbWV9LyR7aWR9YCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24oanFYSFIpIHsKICAgICAgICAgICAgICByZWplY3QoanFYSFIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBmaW5kUmVjb3JkCiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7TW9kZWx9IHR5cGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IGlkCiAgICAgIEBwYXJhbSB7U25hcHNob3R9IHNuYXBzaG90CiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICovCiAgICBmaW5kUmVjb3JkOiBudWxsLAoKICAgIC8qKgogICAgICBUaGUgYGZpbmRBbGwoKWAgbWV0aG9kIGlzIHVzZWQgdG8gcmV0cmlldmUgYWxsIHJlY29yZHMgZm9yIGEgZ2l2ZW4gdHlwZS4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgQWRhcHRlciBmcm9tICdAZW1iZXItZGF0YS9hZGFwdGVyJzsKICAgICAgaW1wb3J0IFJTVlAgZnJvbSAnUlNWUCc7CiAgICAgIGltcG9ydCAkIGZyb20gJ2pxdWVyeSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBBZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgZmluZEFsbChzdG9yZSwgdHlwZSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSU1ZQLlByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICQuZ2V0SlNPTihgLyR7dHlwZS5tb2RlbE5hbWV9YCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24oanFYSFIpIHsKICAgICAgICAgICAgICByZWplY3QoanFYSFIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBmaW5kQWxsCiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7TW9kZWx9IHR5cGUKICAgICAgQHBhcmFtIHt1bmRlZmluZWR9IG5ldmVyU2V0IGEgdmFsdWUgaXMgbmV2ZXIgcHJvdmlkZWQgdG8gdGhpcyBhcmd1bWVudAogICAgICBAcGFyYW0ge1NuYXBzaG90UmVjb3JkQXJyYXl9IHNuYXBzaG90UmVjb3JkQXJyYXkKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIGZpbmRBbGw6IG51bGwsCgogICAgLyoqCiAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCB3aGVuIHlvdSBjYWxsIGBxdWVyeWAgb24gdGhlIHN0b3JlLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXInOwogICAgICBpbXBvcnQgUlNWUCBmcm9tICdSU1ZQJzsKICAgICAgaW1wb3J0ICQgZnJvbSAnanF1ZXJ5JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IEFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICBxdWVyeShzdG9yZSwgdHlwZSwgcXVlcnkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUlNWUC5Qcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAkLmdldEpTT04oYC8ke3R5cGUubW9kZWxOYW1lfWAsIHF1ZXJ5KS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICB9LCBmdW5jdGlvbihqcVhIUikgewogICAgICAgICAgICAgIHJlamVjdChqcVhIUik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHF1ZXJ5CiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7TW9kZWx9IHR5cGUKICAgICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5CiAgICAgIEBwYXJhbSB7QWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5fSByZWNvcmRBcnJheQogICAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgICAqLwogICAgcXVlcnk6IG51bGwsCgogICAgLyoqCiAgICAgIFRoZSBgcXVlcnlSZWNvcmQoKWAgbWV0aG9kIGlzIGludm9rZWQgd2hlbiB0aGUgc3RvcmUgaXMgYXNrZWQgZm9yIGEgc2luZ2xlCiAgICAgIHJlY29yZCB0aHJvdWdoIGEgcXVlcnkgb2JqZWN0LgogICAgICAgSW4gcmVzcG9uc2UgdG8gYHF1ZXJ5UmVjb3JkKClgIGJlaW5nIGNhbGxlZCwgeW91IHNob3VsZCBhbHdheXMgZmV0Y2ggZnJlc2gKICAgICAgZGF0YS4gT25jZSBmb3VuZCwgeW91IGNhbiBhc3luY2hyb25vdXNseSBjYWxsIHRoZSBzdG9yZSdzIGBwdXNoKClgIG1ldGhvZAogICAgICB0byBwdXNoIHRoZSByZWNvcmQgaW50byB0aGUgc3RvcmUuCiAgICAgICBIZXJlIGlzIGFuIGV4YW1wbGUgYHF1ZXJ5UmVjb3JkYCBpbXBsZW1lbnRhdGlvbjoKICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgQWRhcHRlciwgeyBCdWlsZFVSTE1peGluIH0gZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlcic7CiAgICAgIGltcG9ydCBSU1ZQIGZyb20gJ1JTVlAnOwogICAgICBpbXBvcnQgJCBmcm9tICdqcXVlcnknOwogICAgICAgZXhwb3J0IGRlZmF1bHQgQWRhcHRlci5leHRlbmQoQnVpbGRVUkxNaXhpbiwgewogICAgICAgIHF1ZXJ5UmVjb3JkKHN0b3JlLCB0eXBlLCBxdWVyeSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSU1ZQLlByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICQuZ2V0SlNPTihgLyR7dHlwZS5tb2RlbE5hbWV9YCwgcXVlcnkpLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGpxWEhSKSB7CiAgICAgICAgICAgICAgcmVqZWN0KGpxWEhSKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgcXVlcnlSZWNvcmQKICAgICAgQHBhcmFtIHtTdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtzdWJjbGFzcyBvZiBNb2RlbH0gdHlwZQogICAgICBAcGFyYW0ge09iamVjdH0gcXVlcnkKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIHF1ZXJ5UmVjb3JkOiBudWxsLAoKICAgIC8qKgogICAgICBJZiB0aGUgZ2xvYmFsbHkgdW5pcXVlIElEcyBmb3IgeW91ciByZWNvcmRzIHNob3VsZCBiZSBnZW5lcmF0ZWQgb24gdGhlIGNsaWVudCwKICAgICAgaW1wbGVtZW50IHRoZSBgZ2VuZXJhdGVJZEZvclJlY29yZCgpYCBtZXRob2QuIFRoaXMgbWV0aG9kIHdpbGwgYmUgaW52b2tlZAogICAgICBlYWNoIHRpbWUgeW91IGNyZWF0ZSBhIG5ldyByZWNvcmQsIGFuZCB0aGUgdmFsdWUgcmV0dXJuZWQgZnJvbSBpdCB3aWxsIGJlCiAgICAgIGFzc2lnbmVkIHRvIHRoZSByZWNvcmQncyBgcHJpbWFyeUtleWAuCiAgICAgICBNb3N0IHRyYWRpdGlvbmFsIFJFU1QtbGlrZSBIVFRQIEFQSXMgd2lsbCBub3QgdXNlIHRoaXMgbWV0aG9kLiBJbnN0ZWFkLCB0aGUgSUQKICAgICAgb2YgdGhlIHJlY29yZCB3aWxsIGJlIHNldCBieSB0aGUgc2VydmVyLCBhbmQgeW91ciBhZGFwdGVyIHdpbGwgdXBkYXRlIHRoZSBzdG9yZQogICAgICB3aXRoIHRoZSBuZXcgSUQgd2hlbiBpdCBjYWxscyBgZGlkQ3JlYXRlUmVjb3JkKClgLiBPbmx5IGltcGxlbWVudCB0aGlzIG1ldGhvZCBpZgogICAgICB5b3UgaW50ZW5kIHRvIGdlbmVyYXRlIHJlY29yZCBJRHMgb24gdGhlIGNsaWVudC1zaWRlLgogICAgICAgVGhlIGBnZW5lcmF0ZUlkRm9yUmVjb3JkKClgIG1ldGhvZCB3aWxsIGJlIGludm9rZWQgd2l0aCB0aGUgcmVxdWVzdGluZyBzdG9yZSBhcwogICAgICB0aGUgZmlyc3QgcGFyYW1ldGVyIGFuZCB0aGUgbmV3bHkgY3JlYXRlZCByZWNvcmQgYXMgdGhlIHNlY29uZCBwYXJhbWV0ZXI6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXInOwogICAgICBpbXBvcnQgeyB2NCB9IGZyb20gJ3V1aWQnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgQWRhcHRlci5leHRlbmQoewogICAgICAgIGdlbmVyYXRlSWRGb3JSZWNvcmQoc3RvcmUsIHR5cGUsIGlucHV0UHJvcGVydGllcykgewogICAgICAgICAgcmV0dXJuIHY0KCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGdlbmVyYXRlSWRGb3JSZWNvcmQKICAgICAgQHBhcmFtIHtTdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtNb2RlbH0gdHlwZSAgIHRoZSBNb2RlbCBjbGFzcyBvZiB0aGUgcmVjb3JkCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBpbnB1dFByb3BlcnRpZXMgYSBoYXNoIG9mIHByb3BlcnRpZXMgdG8gc2V0IG9uIHRoZQogICAgICAgIG5ld2x5IGNyZWF0ZWQgcmVjb3JkLgogICAgICBAcmV0dXJuIHsoU3RyaW5nfE51bWJlcil9IGlkCiAgICAqLwogICAgZ2VuZXJhdGVJZEZvclJlY29yZDogbnVsbCwKCiAgICAvKioKICAgICAgUHJveGllcyB0byB0aGUgc2VyaWFsaXplcidzIGBzZXJpYWxpemVgIG1ldGhvZC4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgQWRhcHRlciBmcm9tICdAZW1iZXItZGF0YS9hZGFwdGVyJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IEFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICBjcmVhdGVSZWNvcmQoc3RvcmUsIHR5cGUsIHNuYXBzaG90KSB7CiAgICAgICAgICBsZXQgZGF0YSA9IHRoaXMuc2VyaWFsaXplKHNuYXBzaG90LCB7IGluY2x1ZGVJZDogdHJ1ZSB9KTsKICAgICAgICAgIGxldCB1cmwgPSBgLyR7dHlwZS5tb2RlbE5hbWV9YDsKICAgICAgICAgICAvLyAuLi4KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2Qgc2VyaWFsaXplCiAgICAgIEBwYXJhbSB7U25hcHNob3R9IHNuYXBzaG90CiAgICAgIEBwYXJhbSB7T2JqZWN0fSAgIG9wdGlvbnMKICAgICAgQHJldHVybiB7T2JqZWN0fSBzZXJpYWxpemVkIHNuYXBzaG90CiAgICAqLwogICAgc2VyaWFsaXplOiBmdW5jdGlvbiBzZXJpYWxpemUoc25hcHNob3QsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHNuYXBzaG90LnNlcmlhbGl6ZShvcHRpb25zKTsKICAgIH0sCgogICAgLyoqCiAgICAgIEltcGxlbWVudCB0aGlzIG1ldGhvZCBpbiBhIHN1YmNsYXNzIHRvIGhhbmRsZSB0aGUgY3JlYXRpb24gb2YKICAgICAgbmV3IHJlY29yZHMuCiAgICAgICBTZXJpYWxpemVzIHRoZSByZWNvcmQgYW5kIHNlbmRzIGl0IHRvIHRoZSBzZXJ2ZXIuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IEFkYXB0ZXIgZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlcic7CiAgICAgIGltcG9ydCB7IHJ1biB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAgICAgaW1wb3J0IFJTVlAgZnJvbSAnUlNWUCc7CiAgICAgIGltcG9ydCAkIGZyb20gJ2pxdWVyeSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBBZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgY3JlYXRlUmVjb3JkKHN0b3JlLCB0eXBlLCBzbmFwc2hvdCkgewogICAgICAgICAgbGV0IGRhdGEgPSB0aGlzLnNlcmlhbGl6ZShzbmFwc2hvdCwgeyBpbmNsdWRlSWQ6IHRydWUgfSk7CiAgICAgICAgICAgcmV0dXJuIG5ldyBSU1ZQLlByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgdHlwZTogJ1BPU1QnLAogICAgICAgICAgICAgIHVybDogYC8ke3R5cGUubW9kZWxOYW1lfWAsCiAgICAgICAgICAgICAgZGF0YVR5cGU6ICdqc29uJywKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgIHJ1bihudWxsLCByZXNvbHZlLCBkYXRhKTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24oanFYSFIpIHsKICAgICAgICAgICAgICBqcVhIUi50aGVuID0gbnVsbDsgLy8gdGFtZSBqUXVlcnkncyBpbGwgbWFubmVyZWQgcHJvbWlzZXMKICAgICAgICAgICAgICBydW4obnVsbCwgcmVqZWN0LCBqcVhIUik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGNyZWF0ZVJlY29yZAogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge01vZGVsfSB0eXBlICAgdGhlIE1vZGVsIGNsYXNzIG9mIHRoZSByZWNvcmQKICAgICAgQHBhcmFtIHtTbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIGNyZWF0ZVJlY29yZDogbnVsbCwKCiAgICAvKioKICAgICAgSW1wbGVtZW50IHRoaXMgbWV0aG9kIGluIGEgc3ViY2xhc3MgdG8gaGFuZGxlIHRoZSB1cGRhdGluZyBvZgogICAgICBhIHJlY29yZC4KICAgICAgIFNlcmlhbGl6ZXMgdGhlIHJlY29yZCB1cGRhdGUgYW5kIHNlbmRzIGl0IHRvIHRoZSBzZXJ2ZXIuCiAgICAgICBUaGUgdXBkYXRlUmVjb3JkIG1ldGhvZCBpcyBleHBlY3RlZCB0byByZXR1cm4gYSBwcm9taXNlIHRoYXQgd2lsbAogICAgICByZXNvbHZlIHdpdGggdGhlIHNlcmlhbGl6ZWQgcmVjb3JkLiBUaGlzIGFsbG93cyB0aGUgYmFja2VuZCB0bwogICAgICBpbmZvcm0gdGhlIEVtYmVyIERhdGEgc3RvcmUgdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhpcyByZWNvcmQgYWZ0ZXIKICAgICAgdGhlIHVwZGF0ZS4gSWYgaXQgaXMgbm90IHBvc3NpYmxlIHRvIHJldHVybiBhIHNlcmlhbGl6ZWQgcmVjb3JkCiAgICAgIHRoZSB1cGRhdGVSZWNvcmQgcHJvbWlzZSBjYW4gYWxzbyByZXNvbHZlIHdpdGggYHVuZGVmaW5lZGAgYW5kIHRoZQogICAgICBFbWJlciBEYXRhIHN0b3JlIHdpbGwgYXNzdW1lIGFsbCBvZiB0aGUgdXBkYXRlcyB3ZXJlIHN1Y2Nlc3NmdWxseQogICAgICBhcHBsaWVkIG9uIHRoZSBiYWNrZW5kLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXInOwogICAgICBpbXBvcnQgeyBydW4gfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgICAgIGltcG9ydCBSU1ZQIGZyb20gJ1JTVlAnOwogICAgICBpbXBvcnQgJCBmcm9tICdqcXVlcnknOwogICAgICAgZXhwb3J0IGRlZmF1bHQgQWRhcHRlci5leHRlbmQoewogICAgICAgIHVwZGF0ZVJlY29yZChzdG9yZSwgdHlwZSwgc25hcHNob3QpIHsKICAgICAgICAgIGxldCBkYXRhID0gdGhpcy5zZXJpYWxpemUoc25hcHNob3QsIHsgaW5jbHVkZUlkOiB0cnVlIH0pOwogICAgICAgICAgbGV0IGlkID0gc25hcHNob3QuaWQ7CiAgICAgICAgICAgcmV0dXJuIG5ldyBSU1ZQLlByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgdHlwZTogJ1BVVCcsCiAgICAgICAgICAgICAgdXJsOiBgLyR7dHlwZS5tb2RlbE5hbWV9LyR7aWR9YCwKICAgICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgcnVuKG51bGwsIHJlc29sdmUsIGRhdGEpOwogICAgICAgICAgICB9LCBmdW5jdGlvbihqcVhIUikgewogICAgICAgICAgICAgIGpxWEhSLnRoZW4gPSBudWxsOyAvLyB0YW1lIGpRdWVyeSdzIGlsbCBtYW5uZXJlZCBwcm9taXNlcwogICAgICAgICAgICAgIHJ1bihudWxsLCByZWplY3QsIGpxWEhSKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgdXBkYXRlUmVjb3JkCiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7TW9kZWx9IHR5cGUgICB0aGUgTW9kZWwgY2xhc3Mgb2YgdGhlIHJlY29yZAogICAgICBAcGFyYW0ge1NuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgICAqLwogICAgdXBkYXRlUmVjb3JkOiBudWxsLAoKICAgIC8qKgogICAgICBJbXBsZW1lbnQgdGhpcyBtZXRob2QgaW4gYSBzdWJjbGFzcyB0byBoYW5kbGUgdGhlIGRlbGV0aW9uIG9mCiAgICAgIGEgcmVjb3JkLgogICAgICAgU2VuZHMgYSBkZWxldGUgcmVxdWVzdCBmb3IgdGhlIHJlY29yZCB0byB0aGUgc2VydmVyLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXInOwogICAgICBpbXBvcnQgeyBydW4gfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgICAgIGltcG9ydCBSU1ZQIGZyb20gJ1JTVlAnOwogICAgICBpbXBvcnQgJCBmcm9tICdqcXVlcnknOwogICAgICAgZXhwb3J0IGRlZmF1bHQgQWRhcHRlci5leHRlbmQoewogICAgICAgIGRlbGV0ZVJlY29yZChzdG9yZSwgdHlwZSwgc25hcHNob3QpIHsKICAgICAgICAgIGxldCBkYXRhID0gdGhpcy5zZXJpYWxpemUoc25hcHNob3QsIHsgaW5jbHVkZUlkOiB0cnVlIH0pOwogICAgICAgICAgbGV0IGlkID0gc25hcHNob3QuaWQ7CiAgICAgICAgICAgcmV0dXJuIG5ldyBSU1ZQLlByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgdHlwZTogJ0RFTEVURScsCiAgICAgICAgICAgICAgdXJsOiBgLyR7dHlwZS5tb2RlbE5hbWV9LyR7aWR9YCwKICAgICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgcnVuKG51bGwsIHJlc29sdmUsIGRhdGEpOwogICAgICAgICAgICB9LCBmdW5jdGlvbihqcVhIUikgewogICAgICAgICAgICAgIGpxWEhSLnRoZW4gPSBudWxsOyAvLyB0YW1lIGpRdWVyeSdzIGlsbCBtYW5uZXJlZCBwcm9taXNlcwogICAgICAgICAgICAgIHJ1bihudWxsLCByZWplY3QsIGpxWEhSKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgZGVsZXRlUmVjb3JkCiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7TW9kZWx9IHR5cGUgICB0aGUgTW9kZWwgY2xhc3Mgb2YgdGhlIHJlY29yZAogICAgICBAcGFyYW0ge1NuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgICAqLwogICAgZGVsZXRlUmVjb3JkOiBudWxsLAoKICAgIC8qKgogICAgICBCeSBkZWZhdWx0IHRoZSBzdG9yZSB3aWxsIHRyeSB0byBjb2FsZXNjZSBhbGwgYGZldGNoUmVjb3JkYCBjYWxscyB3aXRoaW4gdGhlIHNhbWUgcnVubG9vcAogICAgICBpbnRvIGFzIGZldyByZXF1ZXN0cyBhcyBwb3NzaWJsZSBieSBjYWxsaW5nIGdyb3VwUmVjb3Jkc0ZvckZpbmRNYW55IGFuZCBwYXNzaW5nIGl0IGludG8gYSBmaW5kTWFueSBjYWxsLgogICAgICBZb3UgY2FuIG9wdCBvdXQgb2YgdGhpcyBiZWhhdmlvdXIgYnkgZWl0aGVyIG5vdCBpbXBsZW1lbnRpbmcgdGhlIGZpbmRNYW55IGhvb2sgb3IgYnkgc2V0dGluZwogICAgICBjb2FsZXNjZUZpbmRSZXF1ZXN0cyB0byBmYWxzZS4KICAgICAgIEBwcm9wZXJ0eSBjb2FsZXNjZUZpbmRSZXF1ZXN0cwogICAgICBAdHlwZSB7Ym9vbGVhbn0KICAgICovCiAgICBjb2FsZXNjZUZpbmRSZXF1ZXN0czogdHJ1ZSwKCiAgICAvKioKICAgICAgVGhlIHN0b3JlIHdpbGwgY2FsbCBgZmluZE1hbnlgIGluc3RlYWQgb2YgbXVsdGlwbGUgYGZpbmRSZWNvcmRgCiAgICAgIHJlcXVlc3RzIHRvIGZpbmQgbXVsdGlwbGUgcmVjb3JkcyBhdCBvbmNlIGlmIGNvYWxlc2NlRmluZFJlcXVlc3RzCiAgICAgIGlzIHRydWUuCiAgICAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IEFkYXB0ZXIgZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlcic7CiAgICAgIGltcG9ydCB7IHJ1biB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAgICAgaW1wb3J0IFJTVlAgZnJvbSAnUlNWUCc7CiAgICAgIGltcG9ydCAkIGZyb20gJ2pxdWVyeSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBBZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgZmluZE1hbnkoc3RvcmUsIHR5cGUsIGlkcywgc25hcHNob3RzKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICB0eXBlOiAnR0VUJywKICAgICAgICAgICAgICB1cmw6IGAvJHt0eXBlLm1vZGVsTmFtZX0vYCwKICAgICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nLAogICAgICAgICAgICAgIGRhdGE6IHsgZmlsdGVyOiB7IGlkOiBpZHMuam9pbignLCcpIH0gfQogICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICBydW4obnVsbCwgcmVzb2x2ZSwgZGF0YSk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGpxWEhSKSB7CiAgICAgICAgICAgICAganFYSFIudGhlbiA9IG51bGw7IC8vIHRhbWUgalF1ZXJ5J3MgaWxsIG1hbm5lcmVkIHByb21pc2VzCiAgICAgICAgICAgICAgcnVuKG51bGwsIHJlamVjdCwganFYSFIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBmaW5kTWFueQogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge01vZGVsfSB0eXBlICAgdGhlIE1vZGVsIGNsYXNzIG9mIHRoZSByZWNvcmRzCiAgICAgIEBwYXJhbSB7QXJyYXl9ICAgIGlkcwogICAgICBAcGFyYW0ge0FycmF5fSBzbmFwc2hvdHMKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIGZpbmRNYW55OiBudWxsLAoKICAgIC8qKgogICAgICBPcmdhbml6ZSByZWNvcmRzIGludG8gZ3JvdXBzLCBlYWNoIG9mIHdoaWNoIGlzIHRvIGJlIHBhc3NlZCB0byBzZXBhcmF0ZQogICAgICBjYWxscyB0byBgZmluZE1hbnlgLgogICAgICAgRm9yIGV4YW1wbGUsIGlmIHlvdXIgQVBJIGhhcyBuZXN0ZWQgVVJMcyB0aGF0IGRlcGVuZCBvbiB0aGUgcGFyZW50LCB5b3Ugd2lsbAogICAgICB3YW50IHRvIGdyb3VwIHJlY29yZHMgYnkgdGhlaXIgcGFyZW50LgogICAgICAgVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gcmV0dXJucyB0aGUgcmVjb3JkcyBhcyBhIHNpbmdsZSBncm91cC4KICAgICAgIEBtZXRob2QgZ3JvdXBSZWNvcmRzRm9yRmluZE1hbnkKICAgICAgQHBhcmFtIHtTdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtBcnJheX0gc25hcHNob3RzCiAgICAgIEByZXR1cm4ge0FycmF5fSAgYW4gYXJyYXkgb2YgYXJyYXlzIG9mIHJlY29yZHMsIGVhY2ggb2Ygd2hpY2ggaXMgdG8gYmUKICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGVkIHNlcGFyYXRlbHkgYnkgYGZpbmRNYW55YC4KICAgICovCiAgICBncm91cFJlY29yZHNGb3JGaW5kTWFueTogZnVuY3Rpb24gZ3JvdXBSZWNvcmRzRm9yRmluZE1hbnkoc3RvcmUsIHNuYXBzaG90cykgewogICAgICByZXR1cm4gW3NuYXBzaG90c107CiAgICB9LAoKICAgIC8qKgogICAgICBUaGlzIG1ldGhvZCBpcyB1c2VkIGJ5IHRoZSBzdG9yZSB0byBkZXRlcm1pbmUgaWYgdGhlIHN0b3JlIHNob3VsZAogICAgICByZWxvYWQgYSByZWNvcmQgZnJvbSB0aGUgYWRhcHRlciB3aGVuIGEgcmVjb3JkIGlzIHJlcXVlc3RlZCBieQogICAgICBgc3RvcmUuZmluZFJlY29yZGAuCiAgICAgICBJZiB0aGlzIG1ldGhvZCByZXR1cm5zIGB0cnVlYCwgdGhlIHN0b3JlIHdpbGwgcmUtZmV0Y2ggYSByZWNvcmQgZnJvbQogICAgICB0aGUgYWRhcHRlci4gSWYgdGhpcyBtZXRob2QgcmV0dXJucyBgZmFsc2VgLCB0aGUgc3RvcmUgd2lsbCByZXNvbHZlCiAgICAgIGltbWVkaWF0ZWx5IHVzaW5nIHRoZSBjYWNoZWQgcmVjb3JkLgogICAgICAgRm9yIGV4YW1wbGUsIGlmIHlvdSBhcmUgYnVpbGRpbmcgYW4gZXZlbnRzIHRpY2tldGluZyBzeXN0ZW0sIGluIHdoaWNoIHVzZXJzCiAgICAgIGNhbiBvbmx5IHJlc2VydmUgdGlja2V0cyBmb3IgMjAgbWludXRlcyBhdCBhIHRpbWUsIGFuZCB3YW50IHRvIGVuc3VyZSB0aGF0CiAgICAgIGluIGVhY2ggcm91dGUgeW91IGhhdmUgZGF0YSB0aGF0IGlzIG5vIG1vcmUgdGhhbiAyMCBtaW51dGVzIG9sZCB5b3UgY291bGQKICAgICAgd3JpdGU6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHNob3VsZFJlbG9hZFJlY29yZChzdG9yZSwgdGlja2V0U25hcHNob3QpIHsKICAgICAgICBsZXQgbGFzdEFjY2Vzc2VkQXQgPSB0aWNrZXRTbmFwc2hvdC5hdHRyKCdsYXN0QWNjZXNzZWRBdCcpOwogICAgICAgIGxldCB0aW1lRGlmZiA9IG1vbWVudCgpLmRpZmYobGFzdEFjY2Vzc2VkQXQsICdtaW51dGVzJyk7CiAgICAgICAgIGlmICh0aW1lRGlmZiA+IDIwKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgIFRoaXMgbWV0aG9kIHdvdWxkIGVuc3VyZSB0aGF0IHdoZW5ldmVyIHlvdSBkbyBgc3RvcmUuZmluZFJlY29yZCgndGlja2V0JywKICAgICAgaWQpYCB5b3Ugd2lsbCBhbHdheXMgZ2V0IGEgdGlja2V0IHRoYXQgaXMgbm8gbW9yZSB0aGFuIDIwIG1pbnV0ZXMgb2xkLiBJbgogICAgICBjYXNlIHRoZSBjYWNoZWQgdmVyc2lvbiBpcyBtb3JlIHRoYW4gMjAgbWludXRlcyBvbGQsIGBmaW5kUmVjb3JkYCB3aWxsIG5vdAogICAgICByZXNvbHZlIHVudGlsIHlvdSBmZXRjaGVkIHRoZSBsYXRlc3QgdmVyc2lvbi4KICAgICAgIEJ5IGRlZmF1bHQgdGhpcyBob29rIHJldHVybnMgYGZhbHNlYCwgYXMgbW9zdCBVSXMgc2hvdWxkIG5vdCBibG9jayB1c2VyCiAgICAgIGludGVyYWN0aW9ucyB3aGlsZSB3YWl0aW5nIG9uIGRhdGEgdXBkYXRlLgogICAgICAgTm90ZSB0aGF0LCB3aXRoIGRlZmF1bHQgc2V0dGluZ3MsIGBzaG91bGRCYWNrZ3JvdW5kUmVsb2FkUmVjb3JkYCB3aWxsIGFsd2F5cwogICAgICByZS1mZXRjaCB0aGUgcmVjb3JkcyBpbiB0aGUgYmFja2dyb3VuZCBldmVuIGlmIGBzaG91bGRSZWxvYWRSZWNvcmRgIHJldHVybnMKICAgICAgYGZhbHNlYC4gWW91IGNhbiBvdmVycmlkZSBgc2hvdWxkQmFja2dyb3VuZFJlbG9hZFJlY29yZGAgaWYgdGhpcyBkb2VzIG5vdAogICAgICBzdWl0IHlvdXIgdXNlIGNhc2UuCiAgICAgICBAc2luY2UgMS4xMy4wCiAgICAgIEBtZXRob2Qgc2hvdWxkUmVsb2FkUmVjb3JkCiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7U25hcHNob3R9IHNuYXBzaG90CiAgICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICAqLwogICAgc2hvdWxkUmVsb2FkUmVjb3JkOiBmdW5jdGlvbiBzaG91bGRSZWxvYWRSZWNvcmQoc3RvcmUsIHNuYXBzaG90KSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgLyoqCiAgICAgIFRoaXMgbWV0aG9kIGlzIHVzZWQgYnkgdGhlIHN0b3JlIHRvIGRldGVybWluZSBpZiB0aGUgc3RvcmUgc2hvdWxkCiAgICAgIHJlbG9hZCBhbGwgcmVjb3JkcyBmcm9tIHRoZSBhZGFwdGVyIHdoZW4gcmVjb3JkcyBhcmUgcmVxdWVzdGVkIGJ5CiAgICAgIGBzdG9yZS5maW5kQWxsYC4KICAgICAgIElmIHRoaXMgbWV0aG9kIHJldHVybnMgYHRydWVgLCB0aGUgc3RvcmUgd2lsbCByZS1mZXRjaCBhbGwgcmVjb3JkcyBmcm9tCiAgICAgIHRoZSBhZGFwdGVyLiBJZiB0aGlzIG1ldGhvZCByZXR1cm5zIGBmYWxzZWAsIHRoZSBzdG9yZSB3aWxsIHJlc29sdmUKICAgICAgaW1tZWRpYXRlbHkgdXNpbmcgdGhlIGNhY2hlZCByZWNvcmRzLgogICAgICAgRm9yIGV4YW1wbGUsIGlmIHlvdSBhcmUgYnVpbGRpbmcgYW4gZXZlbnRzIHRpY2tldGluZyBzeXN0ZW0sIGluIHdoaWNoIHVzZXJzCiAgICAgIGNhbiBvbmx5IHJlc2VydmUgdGlja2V0cyBmb3IgMjAgbWludXRlcyBhdCBhIHRpbWUsIGFuZCB3YW50IHRvIGVuc3VyZSB0aGF0CiAgICAgIGluIGVhY2ggcm91dGUgeW91IGhhdmUgZGF0YSB0aGF0IGlzIG5vIG1vcmUgdGhhbiAyMCBtaW51dGVzIG9sZCB5b3UgY291bGQKICAgICAgd3JpdGU6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHNob3VsZFJlbG9hZEFsbChzdG9yZSwgc25hcHNob3RBcnJheSkgewogICAgICAgIGxldCBzbmFwc2hvdHMgPSBzbmFwc2hvdEFycmF5LnNuYXBzaG90cygpOwogICAgICAgICByZXR1cm4gc25hcHNob3RzLmFueSgodGlja2V0U25hcHNob3QpID0+IHsKICAgICAgICAgIGxldCBsYXN0QWNjZXNzZWRBdCA9IHRpY2tldFNuYXBzaG90LmF0dHIoJ2xhc3RBY2Nlc3NlZEF0Jyk7CiAgICAgICAgICBsZXQgdGltZURpZmYgPSBtb21lbnQoKS5kaWZmKGxhc3RBY2Nlc3NlZEF0LCAnbWludXRlcycpOwogICAgICAgICAgIGlmICh0aW1lRGlmZiA+IDIwKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICAgIGBgYAogICAgICAgVGhpcyBtZXRob2Qgd291bGQgZW5zdXJlIHRoYXQgd2hlbmV2ZXIgeW91IGRvIGBzdG9yZS5maW5kQWxsKCd0aWNrZXQnKWAgeW91CiAgICAgIHdpbGwgYWx3YXlzIGdldCBhIGxpc3Qgb2YgdGlja2V0cyB0aGF0IGFyZSBubyBtb3JlIHRoYW4gMjAgbWludXRlcyBvbGQuIEluCiAgICAgIGNhc2UgYSBjYWNoZWQgdmVyc2lvbiBpcyBtb3JlIHRoYW4gMjAgbWludXRlcyBvbGQsIGBmaW5kQWxsYCB3aWxsIG5vdAogICAgICByZXNvbHZlIHVudGlsIHlvdSBmZXRjaGVkIHRoZSBsYXRlc3QgdmVyc2lvbnMuCiAgICAgICBCeSBkZWZhdWx0LCB0aGlzIG1ldGhvZCByZXR1cm5zIGB0cnVlYCBpZiB0aGUgcGFzc2VkIGBzbmFwc2hvdFJlY29yZEFycmF5YAogICAgICBpcyBlbXB0eSAobWVhbmluZyB0aGF0IHRoZXJlIGFyZSBubyByZWNvcmRzIGxvY2FsbHkgYXZhaWxhYmxlIHlldCksCiAgICAgIG90aGVyd2lzZSwgaXQgcmV0dXJucyBgZmFsc2VgLgogICAgICAgTm90ZSB0aGF0LCB3aXRoIGRlZmF1bHQgc2V0dGluZ3MsIGBzaG91bGRCYWNrZ3JvdW5kUmVsb2FkQWxsYCB3aWxsIGFsd2F5cwogICAgICByZS1mZXRjaCBhbGwgdGhlIHJlY29yZHMgaW4gdGhlIGJhY2tncm91bmQgZXZlbiBpZiBgc2hvdWxkUmVsb2FkQWxsYCByZXR1cm5zCiAgICAgIGBmYWxzZWAuIFlvdSBjYW4gb3ZlcnJpZGUgYHNob3VsZEJhY2tncm91bmRSZWxvYWRBbGxgIGlmIHRoaXMgZG9lcyBub3Qgc3VpdAogICAgICB5b3VyIHVzZSBjYXNlLgogICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIHNob3VsZFJlbG9hZEFsbAogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge1NuYXBzaG90UmVjb3JkQXJyYXl9IHNuYXBzaG90UmVjb3JkQXJyYXkKICAgICAgQHJldHVybiB7Qm9vbGVhbn0KICAgICovCiAgICBzaG91bGRSZWxvYWRBbGw6IGZ1bmN0aW9uIHNob3VsZFJlbG9hZEFsbChzdG9yZSwgc25hcHNob3RSZWNvcmRBcnJheSkgewogICAgICByZXR1cm4gIXNuYXBzaG90UmVjb3JkQXJyYXkubGVuZ3RoOwogICAgfSwKCiAgICAvKioKICAgICAgVGhpcyBtZXRob2QgaXMgdXNlZCBieSB0aGUgc3RvcmUgdG8gZGV0ZXJtaW5lIGlmIHRoZSBzdG9yZSBzaG91bGQKICAgICAgcmVsb2FkIGEgcmVjb3JkIGFmdGVyIHRoZSBgc3RvcmUuZmluZFJlY29yZGAgbWV0aG9kIHJlc29sdmVzIGEKICAgICAgY2FjaGVkIHJlY29yZC4KICAgICAgIFRoaXMgbWV0aG9kIGlzICpvbmx5KiBjaGVja2VkIGJ5IHRoZSBzdG9yZSB3aGVuIHRoZSBzdG9yZSBpcwogICAgICByZXR1cm5pbmcgYSBjYWNoZWQgcmVjb3JkLgogICAgICAgSWYgdGhpcyBtZXRob2QgcmV0dXJucyBgdHJ1ZWAgdGhlIHN0b3JlIHdpbGwgcmUtZmV0Y2ggYSByZWNvcmQgZnJvbQogICAgICB0aGUgYWRhcHRlci4KICAgICAgIEZvciBleGFtcGxlLCBpZiB5b3UgZG8gbm90IHdhbnQgdG8gZmV0Y2ggY29tcGxleCBkYXRhIG92ZXIgYSBtb2JpbGUKICAgICAgY29ubmVjdGlvbiwgb3IgaWYgdGhlIG5ldHdvcmsgaXMgZG93biwgeW91IGNhbiBpbXBsZW1lbnQKICAgICAgYHNob3VsZEJhY2tncm91bmRSZWxvYWRSZWNvcmRgIGFzIGZvbGxvd3M6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHNob3VsZEJhY2tncm91bmRSZWxvYWRSZWNvcmQoc3RvcmUsIHNuYXBzaG90KSB7CiAgICAgICAgbGV0IHsgZG93bmxpbmssIGVmZmVjdGl2ZVR5cGUgfSA9IG5hdmlnYXRvci5jb25uZWN0aW9uOwogICAgICAgICByZXR1cm4gZG93bmxpbmsgPiAwICYmIGVmZmVjdGl2ZVR5cGUgPT09ICc0Zyc7CiAgICAgIH0KICAgICAgYGBgCiAgICAgICBCeSBkZWZhdWx0LCB0aGlzIGhvb2sgcmV0dXJucyBgdHJ1ZWAgc28gdGhlIGRhdGEgZm9yIHRoZSByZWNvcmQgaXMgdXBkYXRlZAogICAgICBpbiB0aGUgYmFja2dyb3VuZC4KICAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBzaG91bGRCYWNrZ3JvdW5kUmVsb2FkUmVjb3JkCiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7U25hcHNob3R9IHNuYXBzaG90CiAgICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICAqLwogICAgc2hvdWxkQmFja2dyb3VuZFJlbG9hZFJlY29yZDogZnVuY3Rpb24gc2hvdWxkQmFja2dyb3VuZFJlbG9hZFJlY29yZChzdG9yZSwgc25hcHNob3QpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIC8qKgogICAgICBUaGlzIG1ldGhvZCBpcyB1c2VkIGJ5IHRoZSBzdG9yZSB0byBkZXRlcm1pbmUgaWYgdGhlIHN0b3JlIHNob3VsZAogICAgICByZWxvYWQgYSByZWNvcmQgYXJyYXkgYWZ0ZXIgdGhlIGBzdG9yZS5maW5kQWxsYCBtZXRob2QgcmVzb2x2ZXMKICAgICAgd2l0aCBhIGNhY2hlZCByZWNvcmQgYXJyYXkuCiAgICAgICBUaGlzIG1ldGhvZCBpcyAqb25seSogY2hlY2tlZCBieSB0aGUgc3RvcmUgd2hlbiB0aGUgc3RvcmUgaXMKICAgICAgcmV0dXJuaW5nIGEgY2FjaGVkIHJlY29yZCBhcnJheS4KICAgICAgIElmIHRoaXMgbWV0aG9kIHJldHVybnMgYHRydWVgIHRoZSBzdG9yZSB3aWxsIHJlLWZldGNoIGFsbCByZWNvcmRzCiAgICAgIGZyb20gdGhlIGFkYXB0ZXIuCiAgICAgICBGb3IgZXhhbXBsZSwgaWYgeW91IGRvIG5vdCB3YW50IHRvIGZldGNoIGNvbXBsZXggZGF0YSBvdmVyIGEgbW9iaWxlCiAgICAgIGNvbm5lY3Rpb24sIG9yIGlmIHRoZSBuZXR3b3JrIGlzIGRvd24sIHlvdSBjYW4gaW1wbGVtZW50CiAgICAgIGBzaG91bGRCYWNrZ3JvdW5kUmVsb2FkQWxsYCBhcyBmb2xsb3dzOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBzaG91bGRCYWNrZ3JvdW5kUmVsb2FkQWxsKHN0b3JlLCBzbmFwc2hvdEFycmF5KSB7CiAgICAgICAgbGV0IHsgZG93bmxpbmssIGVmZmVjdGl2ZVR5cGUgfSA9IG5hdmlnYXRvci5jb25uZWN0aW9uOwogICAgICAgICByZXR1cm4gZG93bmxpbmsgPiAwICYmIGVmZmVjdGl2ZVR5cGUgPT09ICc0Zyc7CiAgICAgIH0KICAgICAgYGBgCiAgICAgICBCeSBkZWZhdWx0IHRoaXMgbWV0aG9kIHJldHVybnMgYHRydWVgLCBpbmRpY2F0aW5nIHRoYXQgYSBiYWNrZ3JvdW5kIHJlbG9hZAogICAgICBzaG91bGQgYWx3YXlzIGJlIHRyaWdnZXJlZC4KICAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBzaG91bGRCYWNrZ3JvdW5kUmVsb2FkQWxsCiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7U25hcHNob3RSZWNvcmRBcnJheX0gc25hcHNob3RSZWNvcmRBcnJheQogICAgICBAcmV0dXJuIHtCb29sZWFufQogICAgKi8KICAgIHNob3VsZEJhY2tncm91bmRSZWxvYWRBbGw6IGZ1bmN0aW9uIHNob3VsZEJhY2tncm91bmRSZWxvYWRBbGwoc3RvcmUsIHNuYXBzaG90UmVjb3JkQXJyYXkpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfSk7CgogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CjtkZWZpbmUoIkBlbWJlci1kYXRhL2FkYXB0ZXIvanNvbi1hcGkiLCBbImV4cG9ydHMiLCAiQGVtYmVyLWRhdGEvYWRhcHRlci9yZXN0IiwgImVtYmVyLWluZmxlY3RvciIsICJAZW1iZXItZGF0YS9hZGFwdGVyLy1wcml2YXRlIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX3Jlc3QsIF9lbWJlckluZmxlY3RvciwgX3ByaXZhdGUpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIC8qKgogICAgVGhlIGBKU09OQVBJQWRhcHRlcmAgaXMgdGhlIGRlZmF1bHQgYWRhcHRlciB1c2VkIGJ5IEVtYmVyIERhdGEuIEl0CiAgICBpcyByZXNwb25zaWJsZSBmb3IgdHJhbnNmb3JtaW5nIHRoZSBzdG9yZSdzIHJlcXVlc3RzIGludG8gSFRUUAogICAgcmVxdWVzdHMgdGhhdCBmb2xsb3cgdGhlIFtKU09OIEFQSV0oaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8pCiAgICBmb3JtYXQuCiAgCiAgICAjIyBKU09OIEFQSSBDb252ZW50aW9ucwogIAogICAgVGhlIEpTT05BUElBZGFwdGVyIHVzZXMgSlNPTiBBUEkgY29udmVudGlvbnMgZm9yIGJ1aWxkaW5nIHRoZSBVUkwKICAgIGZvciBhIHJlY29yZCBhbmQgc2VsZWN0aW5nIHRoZSBIVFRQIHZlcmIgdG8gdXNlIHdpdGggYSByZXF1ZXN0LiBUaGUKICAgIGFjdGlvbnMgeW91IGNhbiB0YWtlIG9uIGEgcmVjb3JkIG1hcCBvbnRvIHRoZSBmb2xsb3dpbmcgVVJMcyBpbiB0aGUKICAgIEpTT04gQVBJIGFkYXB0ZXI6CiAgCiAgPHRhYmxlPgogICAgPHRyPgogICAgICA8dGg+CiAgICAgICAgQWN0aW9uCiAgICAgIDwvdGg+CiAgICAgIDx0aD4KICAgICAgICBIVFRQIFZlcmIKICAgICAgPC90aD4KICAgICAgPHRoPgogICAgICAgIFVSTAogICAgICA8L3RoPgogICAgPC90cj4KICAgIDx0cj4KICAgICAgPHRoPgogICAgICAgIGBzdG9yZS5maW5kUmVjb3JkKCdwb3N0JywgMTIzKWAKICAgICAgPC90aD4KICAgICAgPHRkPgogICAgICAgIEdFVAogICAgICA8L3RkPgogICAgICA8dGQ+CiAgICAgICAgL3Bvc3RzLzEyMwogICAgICA8L3RkPgogICAgPC90cj4KICAgIDx0cj4KICAgICAgPHRoPgogICAgICAgIGBzdG9yZS5maW5kQWxsKCdwb3N0JylgCiAgICAgIDwvdGg+CiAgICAgIDx0ZD4KICAgICAgICBHRVQKICAgICAgPC90ZD4KICAgICAgPHRkPgogICAgICAgIC9wb3N0cwogICAgICA8L3RkPgogICAgPC90cj4KICAgIDx0cj4KICAgICAgPHRoPgogICAgICAgIFVwZGF0ZSBgcG9zdFJlY29yZC5zYXZlKClgCiAgICAgIDwvdGg+CiAgICAgIDx0ZD4KICAgICAgICBQQVRDSAogICAgICA8L3RkPgogICAgICA8dGQ+CiAgICAgICAgL3Bvc3RzLzEyMwogICAgICA8L3RkPgogICAgPC90cj4KICAgIDx0cj4KICAgICAgPHRoPgogICAgICAgIENyZWF0ZSBgc3RvcmUuY3JlYXRlUmVjb3JkKCdwb3N0Jykuc2F2ZSgpYAogICAgICA8L3RoPgogICAgICA8dGQ+CiAgICAgICAgUE9TVAogICAgICA8L3RkPgogICAgICA8dGQ+CiAgICAgICAgL3Bvc3RzCiAgICAgIDwvdGQ+CiAgICA8L3RyPgogICAgPHRyPgogICAgICA8dGg+CiAgICAgICAgRGVsZXRlIGBwb3N0UmVjb3JkLmRlc3Ryb3lSZWNvcmQoKWAKICAgICAgPC90aD4KICAgICAgPHRkPgogICAgICAgIERFTEVURQogICAgICA8L3RkPgogICAgICA8dGQ+CiAgICAgICAgL3Bvc3RzLzEyMwogICAgICA8L3RkPgogICAgPC90cj4KICA8L3RhYmxlPgogIAogICAgIyMgU3VjY2VzcyBhbmQgZmFpbHVyZQogIAogICAgVGhlIEpTT05BUElBZGFwdGVyIHdpbGwgY29uc2lkZXIgYSBzdWNjZXNzIGFueSByZXNwb25zZSB3aXRoIGEKICAgIHN0YXR1cyBjb2RlIG9mIHRoZSAyeHggZmFtaWx5ICgiU3VjY2VzcyIpLCBhcyB3ZWxsIGFzIDMwNCAoIk5vdAogICAgTW9kaWZpZWQiKS4gQW55IG90aGVyIHN0YXR1cyBjb2RlIHdpbGwgYmUgY29uc2lkZXJlZCBhIGZhaWx1cmUuCiAgCiAgICBPbiBzdWNjZXNzLCB0aGUgcmVxdWVzdCBwcm9taXNlIHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCB0aGUgZnVsbAogICAgcmVzcG9uc2UgcGF5bG9hZC4KICAKICAgIEZhaWxlZCByZXNwb25zZXMgd2l0aCBzdGF0dXMgY29kZSA0MjIgKCJVbnByb2Nlc3NhYmxlIEVudGl0eSIpIHdpbGwKICAgIGJlIGNvbnNpZGVyZWQgImludmFsaWQiLiBUaGUgcmVzcG9uc2Ugd2lsbCBiZSBkaXNjYXJkZWQsIGV4Y2VwdCBmb3IKICAgIHRoZSBgZXJyb3JzYCBrZXkuIFRoZSByZXF1ZXN0IHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCB3aXRoIGEKICAgIGBJbnZhbGlkRXJyb3JgLiBUaGlzIGVycm9yIG9iamVjdCB3aWxsIGVuY2Fwc3VsYXRlIHRoZSBzYXZlZAogICAgYGVycm9yc2AgdmFsdWUuCiAgCiAgICBBbnkgb3RoZXIgc3RhdHVzIGNvZGVzIHdpbGwgYmUgdHJlYXRlZCBhcyBhbiBhZGFwdGVyIGVycm9yLiBUaGUKICAgIHJlcXVlc3QgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkLCBzaW1pbGFybHkgdG8gdGhlIGludmFsaWQgY2FzZSwKICAgIGJ1dCB3aXRoIGFuIGluc3RhbmNlIG9mIGBBZGFwdGVyRXJyb3JgIGluc3RlYWQuCiAgCiAgICAjIyMgRW5kcG9pbnQgcGF0aCBjdXN0b21pemF0aW9uCiAgCiAgICBFbmRwb2ludCBwYXRocyBjYW4gYmUgcHJlZml4ZWQgd2l0aCBhIGBuYW1lc3BhY2VgIGJ5IHNldHRpbmcgdGhlCiAgICBuYW1lc3BhY2UgcHJvcGVydHkgb24gdGhlIGFkYXB0ZXI6CiAgCiAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgIGltcG9ydCBKU09OQVBJQWRhcHRlciBmcm9tICdAZW1iZXItZGF0YS9hZGFwdGVyL2pzb24tYXBpJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IEpTT05BUElBZGFwdGVyLmV4dGVuZCh7CiAgICAgIG5hbWVzcGFjZTogJ2FwaS8xJwogICAgfSk7CiAgICBgYGAKICAgIFJlcXVlc3RzIGZvciB0aGUgYHBlcnNvbmAgbW9kZWwgd291bGQgbm93IHRhcmdldCBgL2FwaS8xL3Blb3BsZS8xYC4KICAKICAgICMjIyBIb3N0IGN1c3RvbWl6YXRpb24KICAKICAgIEFuIGFkYXB0ZXIgY2FuIHRhcmdldCBvdGhlciBob3N0cyBieSBzZXR0aW5nIHRoZSBgaG9zdGAgcHJvcGVydHkuCiAgCiAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgIGltcG9ydCBKU09OQVBJQWRhcHRlciBmcm9tICdAZW1iZXItZGF0YS9hZGFwdGVyL2pzb24tYXBpJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IEpTT05BUElBZGFwdGVyLmV4dGVuZCh7CiAgICAgIGhvc3Q6ICdodHRwczovL2FwaS5leGFtcGxlLmNvbScKICAgIH0pOwogICAgYGBgCiAgCiAgICBSZXF1ZXN0cyBmb3IgdGhlIGBwZXJzb25gIG1vZGVsIHdvdWxkIG5vdyB0YXJnZXQKICAgIGBodHRwczovL2FwaS5leGFtcGxlLmNvbS9wZW9wbGUvMWAuCiAgCiAgICBAc2luY2UgMS4xMy4wCiAgICBAY2xhc3MgSlNPTkFQSUFkYXB0ZXIKICAgIEBjb25zdHJ1Y3RvcgogICAgQGV4dGVuZHMgUkVTVEFkYXB0ZXIKICAqLwogIHZhciBKU09OQVBJQWRhcHRlciA9IF9yZXN0LmRlZmF1bHQuZXh0ZW5kKHsKICAgIGRlZmF1bHRTZXJpYWxpemVyOiAnLWpzb24tYXBpJywKICAgIF9kZWZhdWx0Q29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi92bmQuYXBpK2pzb24nLAoKICAgIC8qKgogICAgICBAbWV0aG9kIGFqYXhPcHRpb25zCiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwKICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHJlcXVlc3QgdHlwZSBHRVQsIFBPU1QsIFBVVCwgREVMRVRFIGV0Yy4KICAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAgQHJldHVybiB7T2JqZWN0fQogICAgKi8KICAgIGFqYXhPcHRpb25zOiBmdW5jdGlvbiBhamF4T3B0aW9ucyh1cmwsIHR5cGUsIG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgdmFyIGhhc2ggPSB0aGlzLl9zdXBlcih1cmwsIHR5cGUsIG9wdGlvbnMpOwoKICAgICAgaGFzaC5oZWFkZXJzWydBY2NlcHQnXSA9IGhhc2guaGVhZGVyc1snQWNjZXB0J10gfHwgJ2FwcGxpY2F0aW9uL3ZuZC5hcGkranNvbic7CiAgICAgIHJldHVybiBoYXNoOwogICAgfSwKCiAgICAvKioKICAgICAgQnkgZGVmYXVsdCB0aGUgSlNPTkFQSUFkYXB0ZXIgd2lsbCBzZW5kIGVhY2ggZmluZCByZXF1ZXN0IGNvbWluZyBmcm9tIGEgYHN0b3JlLmZpbmRgCiAgICAgIG9yIGZyb20gYWNjZXNzaW5nIGEgcmVsYXRpb25zaGlwIHNlcGFyYXRlbHkgdG8gdGhlIHNlcnZlci4gSWYgeW91ciBzZXJ2ZXIgc3VwcG9ydHMgcGFzc2luZwogICAgICBpZHMgYXMgYSBxdWVyeSBzdHJpbmcsIHlvdSBjYW4gc2V0IGNvYWxlc2NlRmluZFJlcXVlc3RzIHRvIHRydWUgdG8gY29hbGVzY2UgYWxsIGZpbmQgcmVxdWVzdHMKICAgICAgd2l0aGluIGEgc2luZ2xlIHJ1bmxvb3AuCiAgICAgICBGb3IgZXhhbXBsZSwgaWYgeW91IGhhdmUgYW4gaW5pdGlhbCBwYXlsb2FkIG9mOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICB7CiAgICAgICAgZGF0YTogewogICAgICAgICAgaWQ6IDEsCiAgICAgICAgICB0eXBlOiAncG9zdCcsCiAgICAgICAgICByZWxhdGlvbnNoaXA6IHsKICAgICAgICAgICAgY29tbWVudHM6IHsKICAgICAgICAgICAgICBkYXRhOiBbCiAgICAgICAgICAgICAgICB7IGlkOiAxLCB0eXBlOiAnY29tbWVudCcgfSwKICAgICAgICAgICAgICAgIHsgaWQ6IDIsIHR5cGU6ICdjb21tZW50JyB9CiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgQnkgZGVmYXVsdCBjYWxsaW5nIGBwb3N0LmdldCgnY29tbWVudHMnKWAgd2lsbCB0cmlnZ2VyIHRoZSBmb2xsb3dpbmcgcmVxdWVzdHMoYXNzdW1pbmcgdGhlCiAgICAgIGNvbW1lbnRzIGhhdmVuJ3QgYmVlbiBsb2FkZWQgYmVmb3JlKToKICAgICAgIGBgYAogICAgICBHRVQgL2NvbW1lbnRzLzEKICAgICAgR0VUIC9jb21tZW50cy8yCiAgICAgIGBgYAogICAgICAgSWYgeW91IHNldCBjb2FsZXNjZUZpbmRSZXF1ZXN0cyB0byBgdHJ1ZWAgaXQgd2lsbCBpbnN0ZWFkIHRyaWdnZXIgdGhlIGZvbGxvd2luZyByZXF1ZXN0OgogICAgICAgYGBgCiAgICAgIEdFVCAvY29tbWVudHM/ZmlsdGVyW2lkXT0xLDIKICAgICAgYGBgCiAgICAgICBTZXR0aW5nIGNvYWxlc2NlRmluZFJlcXVlc3RzIHRvIGB0cnVlYCBhbHNvIHdvcmtzIGZvciBgc3RvcmUuZmluZGAgcmVxdWVzdHMgYW5kIGBiZWxvbmdzVG9gCiAgICAgIHJlbGF0aW9uc2hpcHMgYWNjZXNzZWQgd2l0aGluIHRoZSBzYW1lIHJ1bmxvb3AuIElmIHlvdSBzZXQgYGNvYWxlc2NlRmluZFJlcXVlc3RzOiB0cnVlYAogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBzdG9yZS5maW5kUmVjb3JkKCdjb21tZW50JywgMSk7CiAgICAgIHN0b3JlLmZpbmRSZWNvcmQoJ2NvbW1lbnQnLCAyKTsKICAgICAgYGBgCiAgICAgICB3aWxsIGFsc28gc2VuZCBhIHJlcXVlc3QgdG86IGBHRVQgL2NvbW1lbnRzP2ZpbHRlcltpZF09MSwyYAogICAgICAgTm90ZTogUmVxdWVzdHMgY29hbGVzY2luZyByZWx5IG9uIFVSTCBidWlsZGluZyBzdHJhdGVneS4gU28gaWYgeW91IG92ZXJyaWRlIGBidWlsZFVSTGAgaW4geW91ciBhcHAKICAgICAgYGdyb3VwUmVjb3Jkc0ZvckZpbmRNYW55YCBtb3JlIGxpa2VseSBzaG91bGQgYmUgb3ZlcnJpZGRlbiBhcyB3ZWxsIGluIG9yZGVyIGZvciBjb2FsZXNjaW5nIHRvIHdvcmsuCiAgICAgICBAcHJvcGVydHkgY29hbGVzY2VGaW5kUmVxdWVzdHMKICAgICAgQHR5cGUge2Jvb2xlYW59CiAgICAqLwogICAgY29hbGVzY2VGaW5kUmVxdWVzdHM6IGZhbHNlLAogICAgZmluZE1hbnk6IGZ1bmN0aW9uIGZpbmRNYW55KHN0b3JlLCB0eXBlLCBpZHMsIHNuYXBzaG90cykgewogICAgICB2YXIgdXJsID0gdGhpcy5idWlsZFVSTCh0eXBlLm1vZGVsTmFtZSwgaWRzLCBzbmFwc2hvdHMsICdmaW5kTWFueScpOwogICAgICByZXR1cm4gdGhpcy5hamF4KHVybCwgJ0dFVCcsIHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICBmaWx0ZXI6IHsKICAgICAgICAgICAgaWQ6IGlkcy5qb2luKCcsJykKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIHBhdGhGb3JUeXBlOiBmdW5jdGlvbiBwYXRoRm9yVHlwZShtb2RlbE5hbWUpIHsKICAgICAgdmFyIGRhc2hlcml6ZWQgPSBFbWJlci5TdHJpbmcuZGFzaGVyaXplKG1vZGVsTmFtZSk7CiAgICAgIHJldHVybiAoMCwgX2VtYmVySW5mbGVjdG9yLnBsdXJhbGl6ZSkoZGFzaGVyaXplZCk7CiAgICB9LAogICAgdXBkYXRlUmVjb3JkOiBmdW5jdGlvbiB1cGRhdGVSZWNvcmQoc3RvcmUsIHR5cGUsIHNuYXBzaG90KSB7CiAgICAgIHZhciBkYXRhID0gKDAsIF9wcml2YXRlLnNlcmlhbGl6ZUludG9IYXNoKShzdG9yZSwgdHlwZSwgc25hcHNob3QpOwogICAgICB2YXIgdXJsID0gdGhpcy5idWlsZFVSTCh0eXBlLm1vZGVsTmFtZSwgc25hcHNob3QuaWQsIHNuYXBzaG90LCAndXBkYXRlUmVjb3JkJyk7CiAgICAgIHJldHVybiB0aGlzLmFqYXgodXJsLCAnUEFUQ0gnLCB7CiAgICAgICAgZGF0YTogZGF0YQogICAgICB9KTsKICAgIH0KICB9KTsKCiAgdmFyIF9kZWZhdWx0ID0gSlNPTkFQSUFkYXB0ZXI7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKO2RlZmluZSgiQGVtYmVyLWRhdGEvYWRhcHRlci9yZXN0IiwgWyJleHBvcnRzIiwgIkBlbWJlci1kYXRhL2FkYXB0ZXIiLCAiQGVtYmVyLWRhdGEvYWRhcHRlci8tcHJpdmF0ZSIsICJAZW1iZXItZGF0YS9hZGFwdGVyL2Vycm9yIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2FkYXB0ZXIsIF9wcml2YXRlLCBfZXJyb3IpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmZldGNoT3B0aW9ucyA9IGZldGNoT3B0aW9uczsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwogIHZhciBQcm9taXNlID0gRW1iZXIuUlNWUC5Qcm9taXNlOwogIHZhciBoYXNKUXVlcnkgPSB0eXBlb2YgalF1ZXJ5ICE9PSAndW5kZWZpbmVkJzsKICB2YXIgaGFzTmFqYXggPSB0eXBlb2YgbmFqYXggIT09ICd1bmRlZmluZWQnOwogIC8qKgogICAgVGhlIFJFU1QgYWRhcHRlciBhbGxvd3MgeW91ciBzdG9yZSB0byBjb21tdW5pY2F0ZSB3aXRoIGFuIEhUVFAgc2VydmVyIGJ5CiAgICB0cmFuc21pdHRpbmcgSlNPTiB2aWEgWEhSLiBNb3N0IEVtYmVyLmpzIGFwcHMgdGhhdCBjb25zdW1lIGEgSlNPTiBBUEkKICAgIHNob3VsZCB1c2UgdGhlIFJFU1QgYWRhcHRlci4KICAKICAgIFRoaXMgYWRhcHRlciBpcyBkZXNpZ25lZCBhcm91bmQgdGhlIGlkZWEgdGhhdCB0aGUgSlNPTiBleGNoYW5nZWQgd2l0aAogICAgdGhlIHNlcnZlciBzaG91bGQgYmUgY29udmVudGlvbmFsLgogIAogICAgIyMgU3VjY2VzcyBhbmQgZmFpbHVyZQogIAogICAgVGhlIFJFU1QgYWRhcHRlciB3aWxsIGNvbnNpZGVyIGEgc3VjY2VzcyBhbnkgcmVzcG9uc2Ugd2l0aCBhIHN0YXR1cyBjb2RlCiAgICBvZiB0aGUgMnh4IGZhbWlseSAoIlN1Y2Nlc3MiKSwgYXMgd2VsbCBhcyAzMDQgKCJOb3QgTW9kaWZpZWQiKS4gQW55IG90aGVyCiAgICBzdGF0dXMgY29kZSB3aWxsIGJlIGNvbnNpZGVyZWQgYSBmYWlsdXJlLgogIAogICAgT24gc3VjY2VzcywgdGhlIHJlcXVlc3QgcHJvbWlzZSB3aWxsIGJlIHJlc29sdmVkIHdpdGggdGhlIGZ1bGwgcmVzcG9uc2UKICAgIHBheWxvYWQuCiAgCiAgICBGYWlsZWQgcmVzcG9uc2VzIHdpdGggc3RhdHVzIGNvZGUgNDIyICgiVW5wcm9jZXNzYWJsZSBFbnRpdHkiKSB3aWxsIGJlCiAgICBjb25zaWRlcmVkICJpbnZhbGlkIi4gVGhlIHJlc3BvbnNlIHdpbGwgYmUgZGlzY2FyZGVkLCBleGNlcHQgZm9yIHRoZQogICAgYGVycm9yc2Aga2V5LiBUaGUgcmVxdWVzdCBwcm9taXNlIHdpbGwgYmUgcmVqZWN0ZWQgd2l0aCBhIGBJbnZhbGlkRXJyb3JgLgogICAgVGhpcyBlcnJvciBvYmplY3Qgd2lsbCBlbmNhcHN1bGF0ZSB0aGUgc2F2ZWQgYGVycm9yc2AgdmFsdWUuCiAgCiAgICBBbnkgb3RoZXIgc3RhdHVzIGNvZGVzIHdpbGwgYmUgdHJlYXRlZCBhcyBhbiAiYWRhcHRlciBlcnJvciIuIFRoZSByZXF1ZXN0CiAgICBwcm9taXNlIHdpbGwgYmUgcmVqZWN0ZWQsIHNpbWlsYXJseSB0byB0aGUgImludmFsaWQiIGNhc2UsIGJ1dCB3aXRoCiAgICBhbiBpbnN0YW5jZSBvZiBgQWRhcHRlckVycm9yYCBpbnN0ZWFkLgogIAogICAgIyMgSlNPTiBTdHJ1Y3R1cmUKICAKICAgIFRoZSBSRVNUIGFkYXB0ZXIgZXhwZWN0cyB0aGUgSlNPTiByZXR1cm5lZCBmcm9tIHlvdXIgc2VydmVyIHRvIGZvbGxvdwogICAgdGhlc2UgY29udmVudGlvbnMuCiAgCiAgICAjIyMgT2JqZWN0IFJvb3QKICAKICAgIFRoZSBKU09OIHBheWxvYWQgc2hvdWxkIGJlIGFuIG9iamVjdCB0aGF0IGNvbnRhaW5zIHRoZSByZWNvcmQgaW5zaWRlIGEKICAgIHJvb3QgcHJvcGVydHkuIEZvciBleGFtcGxlLCBpbiByZXNwb25zZSB0byBhIGBHRVRgIHJlcXVlc3QgZm9yCiAgICBgL3Bvc3RzLzFgLCB0aGUgSlNPTiBzaG91bGQgbG9vayBsaWtlIHRoaXM6CiAgCiAgICBgYGBqcwogICAgewogICAgICAicG9zdHMiOiB7CiAgICAgICAgImlkIjogMSwKICAgICAgICAidGl0bGUiOiAiSSdtIFJ1bm5pbmcgdG8gUmVmb3JtIHRoZSBXM0MncyBUYWciLAogICAgICAgICJhdXRob3IiOiAiWWVodWRhIEthdHoiCiAgICAgIH0KICAgIH0KICAgIGBgYAogIAogICAgU2ltaWxhcmx5LCBpbiByZXNwb25zZSB0byBhIGBHRVRgIHJlcXVlc3QgZm9yIGAvcG9zdHNgLCB0aGUgSlNPTiBzaG91bGQKICAgIGxvb2sgbGlrZSB0aGlzOgogIAogICAgYGBganMKICAgIHsKICAgICAgInBvc3RzIjogWwogICAgICAgIHsKICAgICAgICAgICJpZCI6IDEsCiAgICAgICAgICAidGl0bGUiOiAiSSdtIFJ1bm5pbmcgdG8gUmVmb3JtIHRoZSBXM0MncyBUYWciLAogICAgICAgICAgImF1dGhvciI6ICJZZWh1ZGEgS2F0eiIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICJpZCI6IDIsCiAgICAgICAgICAidGl0bGUiOiAiUmFpbHMgaXMgb21ha2FzZSIsCiAgICAgICAgICAiYXV0aG9yIjogIkQySCIKICAgICAgICB9CiAgICAgIF0KICAgIH0KICAgIGBgYAogIAogICAgTm90ZSB0aGF0IHRoZSBvYmplY3Qgcm9vdCBjYW4gYmUgcGx1cmFsaXplZCBmb3IgYm90aCBhIHNpbmdsZS1vYmplY3QgcmVzcG9uc2UKICAgIGFuZCBhbiBhcnJheSByZXNwb25zZTogdGhlIFJFU1QgYWRhcHRlciBpcyBub3Qgc3RyaWN0IG9uIHRoaXMuIEZ1cnRoZXIsIGlmIHRoZQogICAgSFRUUCBzZXJ2ZXIgcmVzcG9uZHMgdG8gYSBgR0VUYCByZXF1ZXN0IHRvIGAvcG9zdHMvMWAgKGUuZy4gdGhlIHJlc3BvbnNlIHRvIGEKICAgIGBmaW5kUmVjb3JkYCBxdWVyeSkgd2l0aCBtb3JlIHRoYW4gb25lIG9iamVjdCBpbiB0aGUgYXJyYXksIEVtYmVyIERhdGEgd2lsbAogICAgb25seSBkaXNwbGF5IHRoZSBvYmplY3Qgd2l0aCB0aGUgbWF0Y2hpbmcgSUQuCiAgCiAgICAjIyMgQ29udmVudGlvbmFsIE5hbWVzCiAgCiAgICBBdHRyaWJ1dGUgbmFtZXMgaW4geW91ciBKU09OIHBheWxvYWQgc2hvdWxkIGJlIHRoZSBjYW1lbENhc2VkIHZlcnNpb25zIG9mCiAgICB0aGUgYXR0cmlidXRlcyBpbiB5b3VyIEVtYmVyLmpzIG1vZGVscy4KICAKICAgIEZvciBleGFtcGxlLCBpZiB5b3UgaGF2ZSBhIGBQZXJzb25gIG1vZGVsOgogIAogICAgYGBgYXBwL21vZGVscy9wZXJzb24uanMKICAgIGltcG9ydCBNb2RlbCwgeyBhdHRyIH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogIAogICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgZmlyc3ROYW1lOiBhdHRyKCdzdHJpbmcnKSwKICAgICAgbGFzdE5hbWU6IGF0dHIoJ3N0cmluZycpLAogICAgICBvY2N1cGF0aW9uOiBhdHRyKCdzdHJpbmcnKQogICAgfSk7CiAgICBgYGAKICAKICAgIFRoZSBKU09OIHJldHVybmVkIHNob3VsZCBsb29rIGxpa2UgdGhpczoKICAKICAgIGBgYGpzCiAgICB7CiAgICAgICJwZW9wbGUiOiB7CiAgICAgICAgImlkIjogNSwKICAgICAgICAiZmlyc3ROYW1lIjogIlphcGhvZCIsCiAgICAgICAgImxhc3ROYW1lIjogIkJlZWJsZWJyb3giLAogICAgICAgICJvY2N1cGF0aW9uIjogIlByZXNpZGVudCIKICAgICAgfQogICAgfQogICAgYGBgCiAgCiAgICAjIyMjIFJlbGF0aW9uc2hpcHMKICAKICAgIFJlbGF0aW9uc2hpcHMgYXJlIHVzdWFsbHkgcmVwcmVzZW50ZWQgYnkgaWRzIHRvIHRoZSByZWNvcmQgaW4gdGhlCiAgICByZWxhdGlvbnNoaXAuIFRoZSByZWxhdGVkIHJlY29yZHMgY2FuIHRoZW4gYmUgc2lkZWxvYWRlZCBpbiB0aGUKICAgIHJlc3BvbnNlIHVuZGVyIGEga2V5IGZvciB0aGUgdHlwZS4KICAKICAgIGBgYGpzCiAgICB7CiAgICAgICJwb3N0cyI6IHsKICAgICAgICAiaWQiOiA1LAogICAgICAgICJ0aXRsZSI6ICJJJ20gUnVubmluZyB0byBSZWZvcm0gdGhlIFczQydzIFRhZyIsCiAgICAgICAgImF1dGhvciI6ICJZZWh1ZGEgS2F0eiIsCiAgICAgICAgImNvbW1lbnRzIjogWzEsIDJdCiAgICAgIH0sCiAgICAgICJjb21tZW50cyI6IFt7CiAgICAgICAgImlkIjogMSwKICAgICAgICAiYXV0aG9yIjogIlVzZXIgMSIsCiAgICAgICAgIm1lc3NhZ2UiOiAiRmlyc3QhIiwKICAgICAgfSwgewogICAgICAgICJpZCI6IDIsCiAgICAgICAgImF1dGhvciI6ICJVc2VyIDIiLAogICAgICAgICJtZXNzYWdlIjogIkdvb2QgTHVjayEiLAogICAgICB9XQogICAgfQogICAgYGBgCiAgCiAgICBJZiB0aGUgcmVjb3JkcyBpbiB0aGUgcmVsYXRpb25zaGlwIGFyZSBub3Qga25vd24gd2hlbiB0aGUgcmVzcG9uc2UKICAgIGlzIHNlcmlhbGl6ZWQgaXQncyBhbHNvIHBvc3NpYmxlIHRvIHJlcHJlc2VudCB0aGUgcmVsYXRpb25zaGlwIGFzIGEKICAgIFVSTCB1c2luZyB0aGUgYGxpbmtzYCBrZXkgaW4gdGhlIHJlc3BvbnNlLiBFbWJlciBEYXRhIHdpbGwgZmV0Y2gKICAgIHRoaXMgVVJMIHRvIHJlc29sdmUgdGhlIHJlbGF0aW9uc2hpcCB3aGVuIGl0IGlzIGFjY2Vzc2VkIGZvciB0aGUKICAgIGZpcnN0IHRpbWUuCiAgCiAgICBgYGBqcwogICAgewogICAgICAicG9zdHMiOiB7CiAgICAgICAgImlkIjogNSwKICAgICAgICAidGl0bGUiOiAiSSdtIFJ1bm5pbmcgdG8gUmVmb3JtIHRoZSBXM0MncyBUYWciLAogICAgICAgICJhdXRob3IiOiAiWWVodWRhIEthdHoiLAogICAgICAgICJsaW5rcyI6IHsKICAgICAgICAgICJjb21tZW50cyI6ICIvcG9zdHMvNS9jb21tZW50cyIKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGBgYAogIAogICAgIyMjIEVycm9ycwogIAogICAgSWYgYSByZXNwb25zZSBpcyBjb25zaWRlcmVkIGEgZmFpbHVyZSwgdGhlIEpTT04gcGF5bG9hZCBpcyBleHBlY3RlZCB0byBpbmNsdWRlCiAgICBhIHRvcC1sZXZlbCBrZXkgYGVycm9yc2AsIGRldGFpbGluZyBhbnkgc3BlY2lmaWMgaXNzdWVzLiBGb3IgZXhhbXBsZToKICAKICAgIGBgYGpzCiAgICB7CiAgICAgICJlcnJvcnMiOiB7CiAgICAgICAgIm1zZyI6ICJTb21ldGhpbmcgd2VudCB3cm9uZyIKICAgICAgfQogICAgfQogICAgYGBgCiAgCiAgICBUaGlzIGFkYXB0ZXIgZG9lcyBub3QgbWFrZSBhbnkgYXNzdW1wdGlvbnMgYXMgdG8gdGhlIGZvcm1hdCBvZiB0aGUgYGVycm9yc2AKICAgIG9iamVjdC4gSXQgd2lsbCBzaW1wbHkgYmUgcGFzc2VkIGFsb25nIGFzIGlzLCB3cmFwcGVkIGluIGFuIGluc3RhbmNlCiAgICBvZiBgSW52YWxpZEVycm9yYCBvciBgQWRhcHRlckVycm9yYC4gVGhlIHNlcmlhbGl6ZXIgY2FuIGludGVycHJldCBpdAogICAgYWZ0ZXJ3YXJkcy4KICAKICAgICMjIEN1c3RvbWl6YXRpb24KICAKICAgICMjIyBFbmRwb2ludCBwYXRoIGN1c3RvbWl6YXRpb24KICAKICAgIEVuZHBvaW50IHBhdGhzIGNhbiBiZSBwcmVmaXhlZCB3aXRoIGEgYG5hbWVzcGFjZWAgYnkgc2V0dGluZyB0aGUgbmFtZXNwYWNlCiAgICBwcm9wZXJ0eSBvbiB0aGUgYWRhcHRlcjoKICAKICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgaW1wb3J0IFJFU1RBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXIvcmVzdCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBSRVNUQWRhcHRlci5leHRlbmQoewogICAgICBuYW1lc3BhY2U6ICdhcGkvMScKICAgIH0pOwogICAgYGBgCiAgICBSZXF1ZXN0cyBmb3IgdGhlIGBQZXJzb25gIG1vZGVsIHdvdWxkIG5vdyB0YXJnZXQgYC9hcGkvMS9wZW9wbGUvMWAuCiAgCiAgICAjIyMgSG9zdCBjdXN0b21pemF0aW9uCiAgCiAgICBBbiBhZGFwdGVyIGNhbiB0YXJnZXQgb3RoZXIgaG9zdHMgYnkgc2V0dGluZyB0aGUgYGhvc3RgIHByb3BlcnR5LgogIAogICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICBpbXBvcnQgUkVTVEFkYXB0ZXIgZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlci9yZXN0JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IFJFU1RBZGFwdGVyLmV4dGVuZCh7CiAgICAgIGhvc3Q6ICdodHRwczovL2FwaS5leGFtcGxlLmNvbScKICAgIH0pOwogICAgYGBgCiAgCiAgICAjIyMgSGVhZGVycyBjdXN0b21pemF0aW9uCiAgCiAgICBTb21lIEFQSXMgcmVxdWlyZSBIVFRQIGhlYWRlcnMsIGUuZy4gdG8gcHJvdmlkZSBhbiBBUEkga2V5LiBBcmJpdHJhcnkKICAgIGhlYWRlcnMgY2FuIGJlIHNldCBhcyBrZXkvdmFsdWUgcGFpcnMgb24gdGhlIGBSRVNUQWRhcHRlcmAncyBgaGVhZGVyc2AKICAgIG9iamVjdCBhbmQgRW1iZXIgRGF0YSB3aWxsIHNlbmQgdGhlbSBhbG9uZyB3aXRoIGVhY2ggYWpheCByZXF1ZXN0LgogIAogIAogICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICBpbXBvcnQgUkVTVEFkYXB0ZXIgZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlci9yZXN0JzsKICAgIGltcG9ydCB7IGNvbXB1dGVkIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBSRVNUQWRhcHRlci5leHRlbmQoewogICAgICBoZWFkZXJzOiBjb21wdXRlZChmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgJ0FQSV9LRVknOiAnc2VjcmV0IGtleScsCiAgICAgICAgICAnQU5PVEhFUl9IRUFERVInOiAnU29tZSBoZWFkZXIgdmFsdWUnCiAgICAgICAgfTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIGBoZWFkZXJzYCBjYW4gYWxzbyBiZSB1c2VkIGFzIGEgY29tcHV0ZWQgcHJvcGVydHkgdG8gc3VwcG9ydCBkeW5hbWljCiAgICBoZWFkZXJzLiBJbiB0aGUgZXhhbXBsZSBiZWxvdywgdGhlIGBzZXNzaW9uYCBvYmplY3QgaGFzIGJlZW4KICAgIGluamVjdGVkIGludG8gYW4gYWRhcHRlciBieSBFbWJlcidzIGNvbnRhaW5lci4KICAKICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgaW1wb3J0IFJFU1RBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXIvcmVzdCc7CiAgICBpbXBvcnQgeyBjb21wdXRlZCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgZXhwb3J0IGRlZmF1bHQgUkVTVEFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgaGVhZGVyczogY29tcHV0ZWQoJ3Nlc3Npb24uYXV0aFRva2VuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICdBUElfS0VZJzogdGhpcy5nZXQoJ3Nlc3Npb24uYXV0aFRva2VuJyksCiAgICAgICAgICAnQU5PVEhFUl9IRUFERVInOiAnU29tZSBoZWFkZXIgdmFsdWUnCiAgICAgICAgfTsKICAgICAgfSkKICAgIH0pOwogICAgYGBgCiAgCiAgICBJbiBzb21lIGNhc2VzLCB5b3VyIGR5bmFtaWMgaGVhZGVycyBtYXkgcmVxdWlyZSBkYXRhIGZyb20gc29tZQogICAgb2JqZWN0IG91dHNpZGUgb2YgRW1iZXIncyBvYnNlcnZlciBzeXN0ZW0gKGZvciBleGFtcGxlCiAgICBgZG9jdW1lbnQuY29va2llYCkuIFlvdSBjYW4gdXNlIHRoZQogICAgW3ZvbGF0aWxlXSgvYXBpL2NsYXNzZXMvRW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eS5odG1sP2FuY2hvcj12b2xhdGlsZSkKICAgIGZ1bmN0aW9uIHRvIHNldCB0aGUgcHJvcGVydHkgaW50byBhIG5vbi1jYWNoZWQgbW9kZSBjYXVzaW5nIHRoZSBoZWFkZXJzIHRvCiAgICBiZSByZWNvbXB1dGVkIHdpdGggZXZlcnkgcmVxdWVzdC4KICAKICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgaW1wb3J0IFJFU1RBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXIvcmVzdCc7CiAgICBpbXBvcnQgeyBnZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIGltcG9ydCB7IGNvbXB1dGVkIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBSRVNUQWRhcHRlci5leHRlbmQoewogICAgICBoZWFkZXJzOiBjb21wdXRlZChmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgJ0FQSV9LRVknOiBnZXQoZG9jdW1lbnQuY29va2llLm1hdGNoKC9hcGlLZXlcPShbXjtdKikvKSwgJzEnKSwKICAgICAgICAgICdBTk9USEVSX0hFQURFUic6ICdTb21lIGhlYWRlciB2YWx1ZScKICAgICAgICB9OwogICAgICB9KS52b2xhdGlsZSgpCiAgICB9KTsKICAgIGBgYAogIAogICAgQGNsYXNzIFJFU1RBZGFwdGVyCiAgICBAY29uc3RydWN0b3IKICAgIEBleHRlbmRzIEFkYXB0ZXIKICAgIEB1c2VzIEJ1aWxkVVJMTWl4aW4KICAqLwoKICB2YXIgUkVTVEFkYXB0ZXIgPSBfYWRhcHRlci5kZWZhdWx0LmV4dGVuZChfYWRhcHRlci5CdWlsZFVSTE1peGluLCB7CiAgICBkZWZhdWx0U2VyaWFsaXplcjogJy1yZXN0JywKICAgIF9kZWZhdWx0Q29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04JywKICAgIGZhc3Rib290OiBFbWJlci5jb21wdXRlZChmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBFbWJlci5nZXRPd25lcih0aGlzKS5sb29rdXAoJ3NlcnZpY2U6ZmFzdGJvb3QnKTsKICAgIH0pLAogICAgdXNlRmV0Y2g6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIEVOViA9IEVtYmVyLmdldE93bmVyKHRoaXMpLnJlc29sdmVSZWdpc3RyYXRpb24oJ2NvbmZpZzplbnZpcm9ubWVudCcpOyAvLyBUT0RPOiBodHRwczovL2dpdGh1Yi5jb20vZW1iZXJqcy9kYXRhL2lzc3Vlcy82MDkzCgogICAgICB2YXIgalF1ZXJ5SW50ZWdyYXRpb25EaXNhYmxlZCA9IEVOViAmJiBFTlYuRW1iZXJFTlYgJiYgRU5WLkVtYmVyRU5WLl9KUVVFUllfSU5URUdSQVRJT04gPT09IGZhbHNlOwoKICAgICAgaWYgKGpRdWVyeUludGVncmF0aW9uRGlzYWJsZWQpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmIChoYXNOYWpheCB8fCBoYXNKUXVlcnkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0pLAoKICAgIC8qKgogICAgICBCeSBkZWZhdWx0LCB0aGUgUkVTVEFkYXB0ZXIgd2lsbCBzZW5kIHRoZSBxdWVyeSBwYXJhbXMgc29ydGVkIGFscGhhYmV0aWNhbGx5IHRvIHRoZQogICAgICBzZXJ2ZXIuCiAgICAgICBGb3IgZXhhbXBsZToKICAgICAgIGBgYGpzCiAgICAgIHN0b3JlLnF1ZXJ5KCdwb3N0cycsIHsgc29ydDogJ3ByaWNlJywgY2F0ZWdvcnk6ICdwZXRzJyB9KTsKICAgICAgYGBgCiAgICAgICB3aWxsIGdlbmVyYXRlIGEgcmVxdWVzdHMgbGlrZSB0aGlzIGAvcG9zdHM/Y2F0ZWdvcnk9cGV0cyZzb3J0PXByaWNlYCwgZXZlbiBpZiB0aGUKICAgICAgcGFyYW1ldGVycyB3ZXJlIHNwZWNpZmllZCBpbiBhIGRpZmZlcmVudCBvcmRlci4KICAgICAgIFRoYXQgd2F5IHRoZSBnZW5lcmF0ZWQgVVJMIHdpbGwgYmUgZGV0ZXJtaW5pc3RpYyBhbmQgdGhhdCBzaW1wbGlmaWVzIGNhY2hpbmcgbWVjaGFuaXNtcwogICAgICBpbiB0aGUgYmFja2VuZC4KICAgICAgIFNldHRpbmcgYHNvcnRRdWVyeVBhcmFtc2AgdG8gYSBmYWxzZXkgdmFsdWUgd2lsbCByZXNwZWN0IHRoZSBvcmlnaW5hbCBvcmRlci4KICAgICAgIEluIGNhc2UgeW91IHdhbnQgdG8gc29ydCB0aGUgcXVlcnkgcGFyYW1ldGVycyB3aXRoIGEgZGlmZmVyZW50IGNyaXRlcmlhLCBzZXQKICAgICAgYHNvcnRRdWVyeVBhcmFtc2AgdG8geW91ciBjdXN0b20gc29ydCBmdW5jdGlvbi4KICAgICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgUkVTVEFkYXB0ZXIgZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlci9yZXN0JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJFU1RBZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgc29ydFF1ZXJ5UGFyYW1zKHBhcmFtcykgewogICAgICAgICAgbGV0IHNvcnRlZEtleXMgPSBPYmplY3Qua2V5cyhwYXJhbXMpLnNvcnQoKS5yZXZlcnNlKCk7CiAgICAgICAgICBsZXQgbGVuID0gc29ydGVkS2V5cy5sZW5ndGgsIG5ld1BhcmFtcyA9IHt9OwogICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgbmV3UGFyYW1zW3NvcnRlZEtleXNbaV1dID0gcGFyYW1zW3NvcnRlZEtleXNbaV1dOwogICAgICAgICAgfQogICAgICAgICAgIHJldHVybiBuZXdQYXJhbXM7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHNvcnRRdWVyeVBhcmFtcwogICAgICBAcGFyYW0ge09iamVjdH0gb2JqCiAgICAgIEByZXR1cm4ge09iamVjdH0KICAgICovCiAgICBzb3J0UXVlcnlQYXJhbXM6IGZ1bmN0aW9uIHNvcnRRdWVyeVBhcmFtcyhvYmopIHsKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmopOwogICAgICB2YXIgbGVuID0ga2V5cy5sZW5ndGg7CgogICAgICBpZiAobGVuIDwgMikgewogICAgICAgIHJldHVybiBvYmo7CiAgICAgIH0KCiAgICAgIHZhciBuZXdRdWVyeVBhcmFtcyA9IHt9OwogICAgICB2YXIgc29ydGVkS2V5cyA9IGtleXMuc29ydCgpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgIG5ld1F1ZXJ5UGFyYW1zW3NvcnRlZEtleXNbaV1dID0gb2JqW3NvcnRlZEtleXNbaV1dOwogICAgICB9CgogICAgICByZXR1cm4gbmV3UXVlcnlQYXJhbXM7CiAgICB9LAoKICAgIC8qKgogICAgICBCeSBkZWZhdWx0IHRoZSBSRVNUQWRhcHRlciB3aWxsIHNlbmQgZWFjaCBmaW5kIHJlcXVlc3QgY29taW5nIGZyb20gYSBgc3RvcmUuZmluZGAKICAgICAgb3IgZnJvbSBhY2Nlc3NpbmcgYSByZWxhdGlvbnNoaXAgc2VwYXJhdGVseSB0byB0aGUgc2VydmVyLiBJZiB5b3VyIHNlcnZlciBzdXBwb3J0cyBwYXNzaW5nCiAgICAgIGlkcyBhcyBhIHF1ZXJ5IHN0cmluZywgeW91IGNhbiBzZXQgY29hbGVzY2VGaW5kUmVxdWVzdHMgdG8gdHJ1ZSB0byBjb2FsZXNjZSBhbGwgZmluZCByZXF1ZXN0cwogICAgICB3aXRoaW4gYSBzaW5nbGUgcnVubG9vcC4KICAgICAgIEZvciBleGFtcGxlLCBpZiB5b3UgaGF2ZSBhbiBpbml0aWFsIHBheWxvYWQgb2Y6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHsKICAgICAgICBwb3N0OiB7CiAgICAgICAgICBpZDogMSwKICAgICAgICAgIGNvbW1lbnRzOiBbMSwgMl0KICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICBCeSBkZWZhdWx0IGNhbGxpbmcgYHBvc3QuZ2V0KCdjb21tZW50cycpYCB3aWxsIHRyaWdnZXIgdGhlIGZvbGxvd2luZyByZXF1ZXN0cyhhc3N1bWluZyB0aGUKICAgICAgY29tbWVudHMgaGF2ZW4ndCBiZWVuIGxvYWRlZCBiZWZvcmUpOgogICAgICAgYGBgCiAgICAgIEdFVCAvY29tbWVudHMvMQogICAgICBHRVQgL2NvbW1lbnRzLzIKICAgICAgYGBgCiAgICAgICBJZiB5b3Ugc2V0IGNvYWxlc2NlRmluZFJlcXVlc3RzIHRvIGB0cnVlYCBpdCB3aWxsIGluc3RlYWQgdHJpZ2dlciB0aGUgZm9sbG93aW5nIHJlcXVlc3Q6CiAgICAgICBgYGAKICAgICAgR0VUIC9jb21tZW50cz9pZHNbXT0xJmlkc1tdPTIKICAgICAgYGBgCiAgICAgICBTZXR0aW5nIGNvYWxlc2NlRmluZFJlcXVlc3RzIHRvIGB0cnVlYCBhbHNvIHdvcmtzIGZvciBgc3RvcmUuZmluZGAgcmVxdWVzdHMgYW5kIGBiZWxvbmdzVG9gCiAgICAgIHJlbGF0aW9uc2hpcHMgYWNjZXNzZWQgd2l0aGluIHRoZSBzYW1lIHJ1bmxvb3AuIElmIHlvdSBzZXQgYGNvYWxlc2NlRmluZFJlcXVlc3RzOiB0cnVlYAogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBzdG9yZS5maW5kUmVjb3JkKCdjb21tZW50JywgMSk7CiAgICAgIHN0b3JlLmZpbmRSZWNvcmQoJ2NvbW1lbnQnLCAyKTsKICAgICAgYGBgCiAgICAgICB3aWxsIGFsc28gc2VuZCBhIHJlcXVlc3QgdG86IGBHRVQgL2NvbW1lbnRzP2lkc1tdPTEmaWRzW109MmAKICAgICAgIE5vdGU6IFJlcXVlc3RzIGNvYWxlc2NpbmcgcmVseSBvbiBVUkwgYnVpbGRpbmcgc3RyYXRlZ3kuIFNvIGlmIHlvdSBvdmVycmlkZSBgYnVpbGRVUkxgIGluIHlvdXIgYXBwCiAgICAgIGBncm91cFJlY29yZHNGb3JGaW5kTWFueWAgbW9yZSBsaWtlbHkgc2hvdWxkIGJlIG92ZXJyaWRkZW4gYXMgd2VsbCBpbiBvcmRlciBmb3IgY29hbGVzY2luZyB0byB3b3JrLgogICAgICAgQHByb3BlcnR5IGNvYWxlc2NlRmluZFJlcXVlc3RzCiAgICAgIEB0eXBlIHtib29sZWFufQogICAgKi8KICAgIGNvYWxlc2NlRmluZFJlcXVlc3RzOiBmYWxzZSwKCiAgICAvKioKICAgICAgRW5kcG9pbnQgcGF0aHMgY2FuIGJlIHByZWZpeGVkIHdpdGggYSBgbmFtZXNwYWNlYCBieSBzZXR0aW5nIHRoZSBuYW1lc3BhY2UKICAgICAgcHJvcGVydHkgb24gdGhlIGFkYXB0ZXI6CiAgICAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IFJFU1RBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXIvcmVzdCc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSRVNUQWRhcHRlci5leHRlbmQoewogICAgICAgIG5hbWVzcGFjZTogJ2FwaS8xJwogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBSZXF1ZXN0cyBmb3IgdGhlIGBQb3N0YCBtb2RlbCB3b3VsZCBub3cgdGFyZ2V0IGAvYXBpLzEvcG9zdC9gLgogICAgICAgQHByb3BlcnR5IG5hbWVzcGFjZQogICAgICBAdHlwZSB7U3RyaW5nfQogICAgKi8KCiAgICAvKioKICAgICAgQW4gYWRhcHRlciBjYW4gdGFyZ2V0IG90aGVyIGhvc3RzIGJ5IHNldHRpbmcgdGhlIGBob3N0YCBwcm9wZXJ0eS4KICAgICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgUkVTVEFkYXB0ZXIgZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlci9yZXN0JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJFU1RBZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgaG9zdDogJ2h0dHBzOi8vYXBpLmV4YW1wbGUuY29tJwogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBSZXF1ZXN0cyBmb3IgdGhlIGBQb3N0YCBtb2RlbCB3b3VsZCBub3cgdGFyZ2V0IGBodHRwczovL2FwaS5leGFtcGxlLmNvbS9wb3N0L2AuCiAgICAgICBAcHJvcGVydHkgaG9zdAogICAgICBAdHlwZSB7U3RyaW5nfQogICAgKi8KCiAgICAvKioKICAgICAgU29tZSBBUElzIHJlcXVpcmUgSFRUUCBoZWFkZXJzLCBlLmcuIHRvIHByb3ZpZGUgYW4gQVBJCiAgICAgIGtleS4gQXJiaXRyYXJ5IGhlYWRlcnMgY2FuIGJlIHNldCBhcyBrZXkvdmFsdWUgcGFpcnMgb24gdGhlCiAgICAgIGBSRVNUQWRhcHRlcmAncyBgaGVhZGVyc2Agb2JqZWN0IGFuZCBFbWJlciBEYXRhIHdpbGwgc2VuZCB0aGVtCiAgICAgIGFsb25nIHdpdGggZWFjaCBhamF4IHJlcXVlc3QuIEZvciBkeW5hbWljIGhlYWRlcnMgc2VlIFtoZWFkZXJzCiAgICAgIGN1c3RvbWl6YXRpb25dKC9lbWJlci1kYXRhL3JlbGVhc2UvY2xhc3Nlcy9SRVNUQWRhcHRlcikuCiAgICAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IFJFU1RBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXIvcmVzdCc7CiAgICAgIGltcG9ydCB7IGNvbXB1dGVkIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSRVNUQWRhcHRlci5leHRlbmQoewogICAgICAgIGhlYWRlcnM6IGNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ0FQSV9LRVknOiAnc2VjcmV0IGtleScsCiAgICAgICAgICAgICdBTk9USEVSX0hFQURFUic6ICdTb21lIGhlYWRlciB2YWx1ZScKICAgICAgICAgIH07CiAgICAgICAgfSkKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQHByb3BlcnR5IGhlYWRlcnMKICAgICAgQHR5cGUge09iamVjdH0KICAgICAqLwoKICAgIC8qKgogICAgICBDYWxsZWQgYnkgdGhlIHN0b3JlIGluIG9yZGVyIHRvIGZldGNoIHRoZSBKU09OIGZvciBhIGdpdmVuCiAgICAgIHR5cGUgYW5kIElELgogICAgICAgVGhlIGBmaW5kUmVjb3JkYCBtZXRob2QgbWFrZXMgYW4gQWpheCByZXF1ZXN0IHRvIGEgVVJMIGNvbXB1dGVkIGJ5CiAgICAgIGBidWlsZFVSTGAsIGFuZCByZXR1cm5zIGEgcHJvbWlzZSBmb3IgdGhlIHJlc3VsdGluZyBwYXlsb2FkLgogICAgICAgVGhpcyBtZXRob2QgcGVyZm9ybXMgYW4gSFRUUCBgR0VUYCByZXF1ZXN0IHdpdGggdGhlIGlkIHByb3ZpZGVkIGFzIHBhcnQgb2YgdGhlIHF1ZXJ5IHN0cmluZy4KICAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBmaW5kUmVjb3JkCiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7TW9kZWx9IHR5cGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IGlkCiAgICAgIEBwYXJhbSB7U25hcHNob3R9IHNuYXBzaG90CiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICovCiAgICBmaW5kUmVjb3JkOiBmdW5jdGlvbiBmaW5kUmVjb3JkKHN0b3JlLCB0eXBlLCBpZCwgc25hcHNob3QpIHsKICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRVUkwodHlwZS5tb2RlbE5hbWUsIGlkLCBzbmFwc2hvdCwgJ2ZpbmRSZWNvcmQnKTsKICAgICAgdmFyIHF1ZXJ5ID0gdGhpcy5idWlsZFF1ZXJ5KHNuYXBzaG90KTsKICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsICdHRVQnLCB7CiAgICAgICAgZGF0YTogcXVlcnkKICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICBDYWxsZWQgYnkgdGhlIHN0b3JlIGluIG9yZGVyIHRvIGZldGNoIGEgSlNPTiBhcnJheSBmb3IgYWxsCiAgICAgIG9mIHRoZSByZWNvcmRzIGZvciBhIGdpdmVuIHR5cGUuCiAgICAgICBUaGUgYGZpbmRBbGxgIG1ldGhvZCBtYWtlcyBhbiBBamF4IChIVFRQIEdFVCkgcmVxdWVzdCB0byBhIFVSTCBjb21wdXRlZCBieSBgYnVpbGRVUkxgLCBhbmQgcmV0dXJucyBhCiAgICAgIHByb21pc2UgZm9yIHRoZSByZXN1bHRpbmcgcGF5bG9hZC4KICAgICAgIEBtZXRob2QgZmluZEFsbAogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge01vZGVsfSB0eXBlCiAgICAgIEBwYXJhbSB7dW5kZWZpbmVkfSBuZXZlclNldCBhIHZhbHVlIGlzIG5ldmVyIHByb3ZpZGVkIHRvIHRoaXMgYXJndW1lbnQKICAgICAgQHBhcmFtIHtTbmFwc2hvdFJlY29yZEFycmF5fSBzbmFwc2hvdFJlY29yZEFycmF5CiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICovCiAgICBmaW5kQWxsOiBmdW5jdGlvbiBmaW5kQWxsKHN0b3JlLCB0eXBlLCBzaW5jZVRva2VuLCBzbmFwc2hvdFJlY29yZEFycmF5KSB7CiAgICAgIHZhciBxdWVyeSA9IHRoaXMuYnVpbGRRdWVyeShzbmFwc2hvdFJlY29yZEFycmF5KTsKICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRVUkwodHlwZS5tb2RlbE5hbWUsIG51bGwsIHNuYXBzaG90UmVjb3JkQXJyYXksICdmaW5kQWxsJyk7CgogICAgICBpZiAoc2luY2VUb2tlbikgewogICAgICAgIHF1ZXJ5LnNpbmNlID0gc2luY2VUb2tlbjsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsICdHRVQnLCB7CiAgICAgICAgZGF0YTogcXVlcnkKICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICBDYWxsZWQgYnkgdGhlIHN0b3JlIGluIG9yZGVyIHRvIGZldGNoIGEgSlNPTiBhcnJheSBmb3IKICAgICAgdGhlIHJlY29yZHMgdGhhdCBtYXRjaCBhIHBhcnRpY3VsYXIgcXVlcnkuCiAgICAgICBUaGUgYHF1ZXJ5YCBtZXRob2QgbWFrZXMgYW4gQWpheCAoSFRUUCBHRVQpIHJlcXVlc3QgdG8gYSBVUkwKICAgICAgY29tcHV0ZWQgYnkgYGJ1aWxkVVJMYCwgYW5kIHJldHVybnMgYSBwcm9taXNlIGZvciB0aGUgcmVzdWx0aW5nCiAgICAgIHBheWxvYWQuCiAgICAgICBUaGUgYHF1ZXJ5YCBhcmd1bWVudCBpcyBhIHNpbXBsZSBKYXZhU2NyaXB0IG9iamVjdCB0aGF0IHdpbGwgYmUgcGFzc2VkIGRpcmVjdGx5CiAgICAgIHRvIHRoZSBzZXJ2ZXIgYXMgcGFyYW1ldGVycy4KICAgICAgIEBtZXRob2QgcXVlcnkKICAgICAgQHBhcmFtIHtTdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtNb2RlbH0gdHlwZQogICAgICBAcGFyYW0ge09iamVjdH0gcXVlcnkKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIHF1ZXJ5OiBmdW5jdGlvbiBxdWVyeShzdG9yZSwgdHlwZSwgX3F1ZXJ5KSB7CiAgICAgIHZhciB1cmwgPSB0aGlzLmJ1aWxkVVJMKHR5cGUubW9kZWxOYW1lLCBudWxsLCBudWxsLCAncXVlcnknLCBfcXVlcnkpOwoKICAgICAgaWYgKHRoaXMuc29ydFF1ZXJ5UGFyYW1zKSB7CiAgICAgICAgX3F1ZXJ5ID0gdGhpcy5zb3J0UXVlcnlQYXJhbXMoX3F1ZXJ5KTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsICdHRVQnLCB7CiAgICAgICAgZGF0YTogX3F1ZXJ5CiAgICAgIH0pOwogICAgfSwKCiAgICAvKioKICAgICAgQ2FsbGVkIGJ5IHRoZSBzdG9yZSBpbiBvcmRlciB0byBmZXRjaCBhIEpTT04gb2JqZWN0IGZvcgogICAgICB0aGUgcmVjb3JkIHRoYXQgbWF0Y2hlcyBhIHBhcnRpY3VsYXIgcXVlcnkuCiAgICAgICBUaGUgYHF1ZXJ5UmVjb3JkYCBtZXRob2QgbWFrZXMgYW4gQWpheCAoSFRUUCBHRVQpIHJlcXVlc3QgdG8gYSBVUkwKICAgICAgY29tcHV0ZWQgYnkgYGJ1aWxkVVJMYCwgYW5kIHJldHVybnMgYSBwcm9taXNlIGZvciB0aGUgcmVzdWx0aW5nCiAgICAgIHBheWxvYWQuCiAgICAgICBUaGUgYHF1ZXJ5YCBhcmd1bWVudCBpcyBhIHNpbXBsZSBKYXZhU2NyaXB0IG9iamVjdCB0aGF0IHdpbGwgYmUgcGFzc2VkIGRpcmVjdGx5CiAgICAgIHRvIHRoZSBzZXJ2ZXIgYXMgcGFyYW1ldGVycy4KICAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBxdWVyeVJlY29yZAogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge01vZGVsfSB0eXBlCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBxdWVyeQogICAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgICAqLwogICAgcXVlcnlSZWNvcmQ6IGZ1bmN0aW9uIHF1ZXJ5UmVjb3JkKHN0b3JlLCB0eXBlLCBxdWVyeSkgewogICAgICB2YXIgdXJsID0gdGhpcy5idWlsZFVSTCh0eXBlLm1vZGVsTmFtZSwgbnVsbCwgbnVsbCwgJ3F1ZXJ5UmVjb3JkJywgcXVlcnkpOwoKICAgICAgaWYgKHRoaXMuc29ydFF1ZXJ5UGFyYW1zKSB7CiAgICAgICAgcXVlcnkgPSB0aGlzLnNvcnRRdWVyeVBhcmFtcyhxdWVyeSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLmFqYXgodXJsLCAnR0VUJywgewogICAgICAgIGRhdGE6IHF1ZXJ5CiAgICAgIH0pOwogICAgfSwKCiAgICAvKioKICAgICAgQ2FsbGVkIGJ5IHRoZSBzdG9yZSBpbiBvcmRlciB0byBmZXRjaCBzZXZlcmFsIHJlY29yZHMgdG9nZXRoZXIgaWYgYGNvYWxlc2NlRmluZFJlcXVlc3RzYCBpcyB0cnVlCiAgICAgICBGb3IgZXhhbXBsZSwgaWYgdGhlIG9yaWdpbmFsIHBheWxvYWQgbG9va3MgbGlrZToKICAgICAgIGBgYGpzCiAgICAgIHsKICAgICAgICAiaWQiOiAxLAogICAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgICAiY29tbWVudHMiOiBbIDEsIDIsIDMgXQogICAgICB9CiAgICAgIGBgYAogICAgICAgVGhlIElEcyB3aWxsIGJlIHBhc3NlZCBhcyBhIFVSTC1lbmNvZGVkIEFycmF5IG9mIElEcywgaW4gdGhpcyBmb3JtOgogICAgICAgYGBgCiAgICAgIGlkc1tdPTEmaWRzW109MiZpZHNbXT0zCiAgICAgIGBgYAogICAgICAgTWFueSBzZXJ2ZXJzLCBzdWNoIGFzIFJhaWxzIGFuZCBQSFAsIHdpbGwgYXV0b21hdGljYWxseSBjb252ZXJ0IHRoaXMgVVJMLWVuY29kZWQgYXJyYXkKICAgICAgaW50byBhbiBBcnJheSBmb3IgeW91IG9uIHRoZSBzZXJ2ZXItc2lkZS4gSWYgeW91IHdhbnQgdG8gZW5jb2RlIHRoZQogICAgICBJRHMsIGRpZmZlcmVudGx5LCBqdXN0IG92ZXJyaWRlIHRoaXMgKG9uZS1saW5lKSBtZXRob2QuCiAgICAgICBUaGUgYGZpbmRNYW55YCBtZXRob2QgbWFrZXMgYW4gQWpheCAoSFRUUCBHRVQpIHJlcXVlc3QgdG8gYSBVUkwgY29tcHV0ZWQgYnkgYGJ1aWxkVVJMYCwgYW5kIHJldHVybnMgYQogICAgICBwcm9taXNlIGZvciB0aGUgcmVzdWx0aW5nIHBheWxvYWQuCiAgICAgICBAbWV0aG9kIGZpbmRNYW55CiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7TW9kZWx9IHR5cGUKICAgICAgQHBhcmFtIHtBcnJheX0gaWRzCiAgICAgIEBwYXJhbSB7QXJyYXl9IHNuYXBzaG90cwogICAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgICAqLwogICAgZmluZE1hbnk6IGZ1bmN0aW9uIGZpbmRNYW55KHN0b3JlLCB0eXBlLCBpZHMsIHNuYXBzaG90cykgewogICAgICB2YXIgdXJsID0gdGhpcy5idWlsZFVSTCh0eXBlLm1vZGVsTmFtZSwgaWRzLCBzbmFwc2hvdHMsICdmaW5kTWFueScpOwogICAgICByZXR1cm4gdGhpcy5hamF4KHVybCwgJ0dFVCcsIHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICBpZHM6IGlkcwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICBDYWxsZWQgYnkgdGhlIHN0b3JlIGluIG9yZGVyIHRvIGZldGNoIGEgSlNPTiBhcnJheSBmb3IKICAgICAgdGhlIHVubG9hZGVkIHJlY29yZHMgaW4gYSBoYXMtbWFueSByZWxhdGlvbnNoaXAgdGhhdCB3ZXJlIG9yaWdpbmFsbHkKICAgICAgc3BlY2lmaWVkIGFzIGEgVVJMIChpbnNpZGUgb2YgYGxpbmtzYCkuCiAgICAgICBGb3IgZXhhbXBsZSwgaWYgeW91ciBvcmlnaW5hbCBwYXlsb2FkIGxvb2tzIGxpa2UgdGhpczoKICAgICAgIGBgYGpzCiAgICAgIHsKICAgICAgICAicG9zdCI6IHsKICAgICAgICAgICJpZCI6IDEsCiAgICAgICAgICAidGl0bGUiOiAiUmFpbHMgaXMgb21ha2FzZSIsCiAgICAgICAgICAibGlua3MiOiB7ICJjb21tZW50cyI6ICIvcG9zdHMvMS9jb21tZW50cyIgfQogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgIFRoaXMgbWV0aG9kIHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIHBhcmVudCByZWNvcmQgYW5kIGAvcG9zdHMvMS9jb21tZW50c2AuCiAgICAgICBUaGUgYGZpbmRIYXNNYW55YCBtZXRob2Qgd2lsbCBtYWtlIGFuIEFqYXggKEhUVFAgR0VUKSByZXF1ZXN0IHRvIHRoZSBvcmlnaW5hbGx5IHNwZWNpZmllZCBVUkwuCiAgICAgICBUaGUgZm9ybWF0IG9mIHlvdXIgYGxpbmtzYCB2YWx1ZSB3aWxsIGluZmx1ZW5jZSB0aGUgZmluYWwgcmVxdWVzdCBVUkwgdmlhIHRoZSBgdXJsUHJlZml4YCBtZXRob2Q6CiAgICAgICAqIExpbmtzIGJlZ2lubmluZyB3aXRoIGAvL2AsIGBodHRwOi8vYCwgYGh0dHBzOi8vYCwgd2lsbCBiZSB1c2VkIGFzIGlzLCB3aXRoIG5vIGZ1cnRoZXIgbWFuaXB1bGF0aW9uLgogICAgICAgKiBMaW5rcyBiZWdpbm5pbmcgd2l0aCBhIHNpbmdsZSBgL2Agd2lsbCBoYXZlIHRoZSBjdXJyZW50IGFkYXB0ZXIncyBgaG9zdGAgdmFsdWUgcHJlcGVuZGVkIHRvIGl0LgogICAgICAgKiBMaW5rcyB3aXRoIG5vIGJlZ2lubmluZyBgL2Agd2lsbCBoYXZlIGEgcGFyZW50VVJMIHByZXBlbmRlZCB0byBpdCwgdmlhIHRoZSBjdXJyZW50IGFkYXB0ZXIncyBgYnVpbGRVUkxgLgogICAgICAgQG1ldGhvZCBmaW5kSGFzTWFueQogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge1NuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcGFyYW0ge1N0cmluZ30gdXJsCiAgICAgIEBwYXJhbSB7T2JqZWN0fSByZWxhdGlvbnNoaXAgbWV0YSBvYmplY3QgZGVzY3JpYmluZyB0aGUgcmVsYXRpb25zaGlwCiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICovCiAgICBmaW5kSGFzTWFueTogZnVuY3Rpb24gZmluZEhhc01hbnkoc3RvcmUsIHNuYXBzaG90LCB1cmwsIHJlbGF0aW9uc2hpcCkgewogICAgICB2YXIgaWQgPSBzbmFwc2hvdC5pZDsKICAgICAgdmFyIHR5cGUgPSBzbmFwc2hvdC5tb2RlbE5hbWU7CiAgICAgIHVybCA9IHRoaXMudXJsUHJlZml4KHVybCwgdGhpcy5idWlsZFVSTCh0eXBlLCBpZCwgc25hcHNob3QsICdmaW5kSGFzTWFueScpKTsKICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsICdHRVQnKTsKICAgIH0sCgogICAgLyoqCiAgICAgIENhbGxlZCBieSB0aGUgc3RvcmUgaW4gb3JkZXIgdG8gZmV0Y2ggdGhlIEpTT04gZm9yIHRoZSB1bmxvYWRlZCByZWNvcmQgaW4gYQogICAgICBiZWxvbmdzLXRvIHJlbGF0aW9uc2hpcCB0aGF0IHdhcyBvcmlnaW5hbGx5IHNwZWNpZmllZCBhcyBhIFVSTCAoaW5zaWRlIG9mCiAgICAgIGBsaW5rc2ApLgogICAgICAgRm9yIGV4YW1wbGUsIGlmIHlvdXIgb3JpZ2luYWwgcGF5bG9hZCBsb29rcyBsaWtlIHRoaXM6CiAgICAgICBgYGBqcwogICAgICB7CiAgICAgICAgInBlcnNvbiI6IHsKICAgICAgICAgICJpZCI6IDEsCiAgICAgICAgICAibmFtZSI6ICJUb20gRGFsZSIsCiAgICAgICAgICAibGlua3MiOiB7ICJncm91cCI6ICIvcGVvcGxlLzEvZ3JvdXAiIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICBUaGlzIG1ldGhvZCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSBwYXJlbnQgcmVjb3JkIGFuZCBgL3Blb3BsZS8xL2dyb3VwYC4KICAgICAgIFRoZSBgZmluZEJlbG9uZ3NUb2AgbWV0aG9kIHdpbGwgbWFrZSBhbiBBamF4IChIVFRQIEdFVCkgcmVxdWVzdCB0byB0aGUgb3JpZ2luYWxseSBzcGVjaWZpZWQgVVJMLgogICAgICAgVGhlIGZvcm1hdCBvZiB5b3VyIGBsaW5rc2AgdmFsdWUgd2lsbCBpbmZsdWVuY2UgdGhlIGZpbmFsIHJlcXVlc3QgVVJMIHZpYSB0aGUgYHVybFByZWZpeGAgbWV0aG9kOgogICAgICAgKiBMaW5rcyBiZWdpbm5pbmcgd2l0aCBgLy9gLCBgaHR0cDovL2AsIGBodHRwczovL2AsIHdpbGwgYmUgdXNlZCBhcyBpcywgd2l0aCBubyBmdXJ0aGVyIG1hbmlwdWxhdGlvbi4KICAgICAgICogTGlua3MgYmVnaW5uaW5nIHdpdGggYSBzaW5nbGUgYC9gIHdpbGwgaGF2ZSB0aGUgY3VycmVudCBhZGFwdGVyJ3MgYGhvc3RgIHZhbHVlIHByZXBlbmRlZCB0byBpdC4KICAgICAgICogTGlua3Mgd2l0aCBubyBiZWdpbm5pbmcgYC9gIHdpbGwgaGF2ZSBhIHBhcmVudFVSTCBwcmVwZW5kZWQgdG8gaXQsIHZpYSB0aGUgY3VycmVudCBhZGFwdGVyJ3MgYGJ1aWxkVVJMYC4KICAgICAgIEBtZXRob2QgZmluZEJlbG9uZ3NUbwogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge1NuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcGFyYW0ge1N0cmluZ30gdXJsCiAgICAgIEBwYXJhbSB7T2JqZWN0fSByZWxhdGlvbnNoaXAgbWV0YSBvYmplY3QgZGVzY3JpYmluZyB0aGUgcmVsYXRpb25zaGlwCiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICovCiAgICBmaW5kQmVsb25nc1RvOiBmdW5jdGlvbiBmaW5kQmVsb25nc1RvKHN0b3JlLCBzbmFwc2hvdCwgdXJsLCByZWxhdGlvbnNoaXApIHsKICAgICAgdmFyIGlkID0gc25hcHNob3QuaWQ7CiAgICAgIHZhciB0eXBlID0gc25hcHNob3QubW9kZWxOYW1lOwogICAgICB1cmwgPSB0aGlzLnVybFByZWZpeCh1cmwsIHRoaXMuYnVpbGRVUkwodHlwZSwgaWQsIHNuYXBzaG90LCAnZmluZEJlbG9uZ3NUbycpKTsKICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsICdHRVQnKTsKICAgIH0sCgogICAgLyoqCiAgICAgIENhbGxlZCBieSB0aGUgc3RvcmUgd2hlbiBhIG5ld2x5IGNyZWF0ZWQgcmVjb3JkIGlzCiAgICAgIHNhdmVkIHZpYSB0aGUgYHNhdmVgIG1ldGhvZCBvbiBhIG1vZGVsIHJlY29yZCBpbnN0YW5jZS4KICAgICAgIFRoZSBgY3JlYXRlUmVjb3JkYCBtZXRob2Qgc2VyaWFsaXplcyB0aGUgcmVjb3JkIGFuZCBtYWtlcyBhbiBBamF4IChIVFRQIFBPU1QpIHJlcXVlc3QKICAgICAgdG8gYSBVUkwgY29tcHV0ZWQgYnkgYGJ1aWxkVVJMYC4KICAgICAgIFNlZSBgc2VyaWFsaXplYCBmb3IgaW5mb3JtYXRpb24gb24gaG93IHRvIGN1c3RvbWl6ZSB0aGUgc2VyaWFsaXplZCBmb3JtCiAgICAgIG9mIGEgcmVjb3JkLgogICAgICAgQG1ldGhvZCBjcmVhdGVSZWNvcmQKICAgICAgQHBhcmFtIHtTdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtNb2RlbH0gdHlwZQogICAgICBAcGFyYW0ge1NuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgICAqLwogICAgY3JlYXRlUmVjb3JkOiBmdW5jdGlvbiBjcmVhdGVSZWNvcmQoc3RvcmUsIHR5cGUsIHNuYXBzaG90KSB7CiAgICAgIHZhciB1cmwgPSB0aGlzLmJ1aWxkVVJMKHR5cGUubW9kZWxOYW1lLCBudWxsLCBzbmFwc2hvdCwgJ2NyZWF0ZVJlY29yZCcpOwogICAgICB2YXIgZGF0YSA9ICgwLCBfcHJpdmF0ZS5zZXJpYWxpemVJbnRvSGFzaCkoc3RvcmUsIHR5cGUsIHNuYXBzaG90KTsKICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsICdQT1NUJywgewogICAgICAgIGRhdGE6IGRhdGEKICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICBDYWxsZWQgYnkgdGhlIHN0b3JlIHdoZW4gYW4gZXhpc3RpbmcgcmVjb3JkIGlzIHNhdmVkCiAgICAgIHZpYSB0aGUgYHNhdmVgIG1ldGhvZCBvbiBhIG1vZGVsIHJlY29yZCBpbnN0YW5jZS4KICAgICAgIFRoZSBgdXBkYXRlUmVjb3JkYCBtZXRob2Qgc2VyaWFsaXplcyB0aGUgcmVjb3JkIGFuZCBtYWtlcyBhbiBBamF4IChIVFRQIFBVVCkgcmVxdWVzdAogICAgICB0byBhIFVSTCBjb21wdXRlZCBieSBgYnVpbGRVUkxgLgogICAgICAgU2VlIGBzZXJpYWxpemVgIGZvciBpbmZvcm1hdGlvbiBvbiBob3cgdG8gY3VzdG9taXplIHRoZSBzZXJpYWxpemVkIGZvcm0KICAgICAgb2YgYSByZWNvcmQuCiAgICAgICBAbWV0aG9kIHVwZGF0ZVJlY29yZAogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge01vZGVsfSB0eXBlCiAgICAgIEBwYXJhbSB7U25hcHNob3R9IHNuYXBzaG90CiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICovCiAgICB1cGRhdGVSZWNvcmQ6IGZ1bmN0aW9uIHVwZGF0ZVJlY29yZChzdG9yZSwgdHlwZSwgc25hcHNob3QpIHsKICAgICAgdmFyIGRhdGEgPSAoMCwgX3ByaXZhdGUuc2VyaWFsaXplSW50b0hhc2gpKHN0b3JlLCB0eXBlLCBzbmFwc2hvdCwge30pOwogICAgICB2YXIgaWQgPSBzbmFwc2hvdC5pZDsKICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRVUkwodHlwZS5tb2RlbE5hbWUsIGlkLCBzbmFwc2hvdCwgJ3VwZGF0ZVJlY29yZCcpOwogICAgICByZXR1cm4gdGhpcy5hamF4KHVybCwgJ1BVVCcsIHsKICAgICAgICBkYXRhOiBkYXRhCiAgICAgIH0pOwogICAgfSwKCiAgICAvKioKICAgICAgQ2FsbGVkIGJ5IHRoZSBzdG9yZSB3aGVuIGEgcmVjb3JkIGlzIGRlbGV0ZWQuCiAgICAgICBUaGUgYGRlbGV0ZVJlY29yZGAgbWV0aG9kICBtYWtlcyBhbiBBamF4IChIVFRQIERFTEVURSkgcmVxdWVzdCB0byBhIFVSTCBjb21wdXRlZCBieSBgYnVpbGRVUkxgLgogICAgICAgQG1ldGhvZCBkZWxldGVSZWNvcmQKICAgICAgQHBhcmFtIHtTdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtNb2RlbH0gdHlwZQogICAgICBAcGFyYW0ge1NuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgICAqLwogICAgZGVsZXRlUmVjb3JkOiBmdW5jdGlvbiBkZWxldGVSZWNvcmQoc3RvcmUsIHR5cGUsIHNuYXBzaG90KSB7CiAgICAgIHZhciBpZCA9IHNuYXBzaG90LmlkOwogICAgICByZXR1cm4gdGhpcy5hamF4KHRoaXMuYnVpbGRVUkwodHlwZS5tb2RlbE5hbWUsIGlkLCBzbmFwc2hvdCwgJ2RlbGV0ZVJlY29yZCcpLCAnREVMRVRFJyk7CiAgICB9LAogICAgX3N0cmlwSURGcm9tVVJMOiBmdW5jdGlvbiBfc3RyaXBJREZyb21VUkwoc3RvcmUsIHNuYXBzaG90KSB7CiAgICAgIHZhciB1cmwgPSB0aGlzLmJ1aWxkVVJMKHNuYXBzaG90Lm1vZGVsTmFtZSwgc25hcHNob3QuaWQsIHNuYXBzaG90KTsKICAgICAgdmFyIGV4cGFuZGVkVVJMID0gdXJsLnNwbGl0KCcvJyk7IC8vIENhc2Ugd2hlbiB0aGUgdXJsIGlzIG9mIHRoZSBmb3JtYXQgLi4uc29tZXRoaW5nLzppZAogICAgICAvLyBXZSBhcmUgZGVjb2RlVVJJQ29tcG9uZW50LWluZyB0aGUgbGFzdFNlZ21lbnQgYmVjYXVzZSBpZiBpdCByZXByZXNlbnRzCiAgICAgIC8vIHRoZSBpZCwgaXQgaGFzIGJlZW4gZW5jb2RlVVJJQ29tcG9uZW50LWlmaWVkIHdpdGhpbiBgYnVpbGRVUkxgLiBJZiB3ZQogICAgICAvLyBkb24ndCBkbyB0aGlzLCB0aGVuIHJlY29yZHMgd2l0aCBpZCBoYXZpbmcgc3BlY2lhbCBjaGFyYWN0ZXJzIGFyZSBub3QKICAgICAgLy8gY29hbGVzY2VkIGNvcnJlY3RseSAoc2VlIEdIICM0MTkwIGZvciB0aGUgcmVwb3J0ZWQgYnVnKQoKICAgICAgdmFyIGxhc3RTZWdtZW50ID0gZXhwYW5kZWRVUkxbZXhwYW5kZWRVUkwubGVuZ3RoIC0gMV07CiAgICAgIHZhciBpZCA9IHNuYXBzaG90LmlkOwoKICAgICAgaWYgKGRlY29kZVVSSUNvbXBvbmVudChsYXN0U2VnbWVudCkgPT09IGlkKSB7CiAgICAgICAgZXhwYW5kZWRVUkxbZXhwYW5kZWRVUkwubGVuZ3RoIC0gMV0gPSAnJzsKICAgICAgfSBlbHNlIGlmIChlbmRzV2l0aChsYXN0U2VnbWVudCwgJz9pZD0nICsgaWQpKSB7CiAgICAgICAgLy9DYXNlIHdoZW4gdGhlIHVybCBpcyBvZiB0aGUgZm9ybWF0IC4uLnNvbWV0aGluZz9pZD06aWQKICAgICAgICBleHBhbmRlZFVSTFtleHBhbmRlZFVSTC5sZW5ndGggLSAxXSA9IGxhc3RTZWdtZW50LnN1YnN0cmluZygwLCBsYXN0U2VnbWVudC5sZW5ndGggLSBpZC5sZW5ndGggLSAxKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGV4cGFuZGVkVVJMLmpvaW4oJy8nKTsKICAgIH0sCiAgICAvLyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzQxNzE0Mi93aGF0LWlzLXRoZS1tYXhpbXVtLWxlbmd0aC1vZi1hLXVybC1pbi1kaWZmZXJlbnQtYnJvd3NlcnMKICAgIG1heFVSTExlbmd0aDogMjA0OCwKCiAgICAvKioKICAgICAgT3JnYW5pemUgcmVjb3JkcyBpbnRvIGdyb3VwcywgZWFjaCBvZiB3aGljaCBpcyB0byBiZSBwYXNzZWQgdG8gc2VwYXJhdGUKICAgICAgY2FsbHMgdG8gYGZpbmRNYW55YC4KICAgICAgIFRoaXMgaW1wbGVtZW50YXRpb24gZ3JvdXBzIHRvZ2V0aGVyIHJlY29yZHMgdGhhdCBoYXZlIHRoZSBzYW1lIGJhc2UgVVJMIGJ1dAogICAgICBkaWZmZXJpbmcgaWRzLiBGb3IgZXhhbXBsZSBgL2NvbW1lbnRzLzFgIGFuZCBgL2NvbW1lbnRzLzJgIHdpbGwgYmUgZ3JvdXBlZCB0b2dldGhlcgogICAgICBiZWNhdXNlIHdlIGtub3cgZmluZE1hbnkgY2FuIGNvYWxlc2NlIHRoZW0gdG9nZXRoZXIgYXMgYC9jb21tZW50cz9pZHNbXT0xJmlkc1tdPTJgCiAgICAgICBJdCBhbHNvIHN1cHBvcnRzIHVybHMgd2hlcmUgaWRzIGFyZSBwYXNzZWQgYXMgYSBxdWVyeSBwYXJhbSwgc3VjaCBhcyBgL2NvbW1lbnRzP2lkPTFgCiAgICAgIGJ1dCBub3QgdGhvc2Ugd2hlcmUgdGhlcmUgaXMgbW9yZSB0aGFuIDEgcXVlcnkgcGFyYW0gc3VjaCBhcyBgL2NvbW1lbnRzP2lkPTImbmFtZT1EYXZpZGAKICAgICAgQ3VycmVudGx5IG9ubHkgdGhlIHF1ZXJ5IHBhcmFtIG9mIGBpZGAgaXMgc3VwcG9ydGVkLiBJZiB5b3UgbmVlZCB0byBzdXBwb3J0IG90aGVycywgcGxlYXNlCiAgICAgIG92ZXJyaWRlIHRoaXMgb3IgdGhlIGBfc3RyaXBJREZyb21VUkxgIG1ldGhvZC4KICAgICAgIEl0IGRvZXMgbm90IGdyb3VwIHJlY29yZHMgdGhhdCBoYXZlIGRpZmZlcmluZyBiYXNlIHVybHMsIHN1Y2ggYXMgZm9yIGV4YW1wbGU6IGAvcG9zdHMvMS9jb21tZW50cy8yYAogICAgICBhbmQgYC9wb3N0cy8yL2NvbW1lbnRzLzNgCiAgICAgICBAbWV0aG9kIGdyb3VwUmVjb3Jkc0ZvckZpbmRNYW55CiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7QXJyYXl9IHNuYXBzaG90cwogICAgICBAcmV0dXJuIHtBcnJheX0gIGFuIGFycmF5IG9mIGFycmF5cyBvZiByZWNvcmRzLCBlYWNoIG9mIHdoaWNoIGlzIHRvIGJlCiAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRlZCBzZXBhcmF0ZWx5IGJ5IGBmaW5kTWFueWAuCiAgICAqLwogICAgZ3JvdXBSZWNvcmRzRm9yRmluZE1hbnk6IGZ1bmN0aW9uIGdyb3VwUmVjb3Jkc0ZvckZpbmRNYW55KHN0b3JlLCBzbmFwc2hvdHMpIHsKICAgICAgdmFyIGdyb3VwcyA9IG5ldyBNYXAoKTsKICAgICAgdmFyIGFkYXB0ZXIgPSB0aGlzOwogICAgICB2YXIgbWF4VVJMTGVuZ3RoID0gdGhpcy5tYXhVUkxMZW5ndGg7CiAgICAgIHNuYXBzaG90cy5mb3JFYWNoKGZ1bmN0aW9uIChzbmFwc2hvdCkgewogICAgICAgIHZhciBiYXNlVXJsID0gYWRhcHRlci5fc3RyaXBJREZyb21VUkwoc3RvcmUsIHNuYXBzaG90KTsKCiAgICAgICAgaWYgKCFncm91cHMuaGFzKGJhc2VVcmwpKSB7CiAgICAgICAgICBncm91cHMuc2V0KGJhc2VVcmwsIFtdKTsKICAgICAgICB9CgogICAgICAgIGdyb3Vwcy5nZXQoYmFzZVVybCkucHVzaChzbmFwc2hvdCk7CiAgICAgIH0pOwoKICAgICAgZnVuY3Rpb24gc3BsaXRHcm91cFRvRml0SW5VcmwoZ3JvdXAsIG1heFVSTExlbmd0aCwgcGFyYW1OYW1lTGVuZ3RoKSB7CiAgICAgICAgdmFyIGlkc1NpemUgPSAwOwoKICAgICAgICB2YXIgYmFzZVVybCA9IGFkYXB0ZXIuX3N0cmlwSURGcm9tVVJMKHN0b3JlLCBncm91cFswXSk7CgogICAgICAgIHZhciBzcGxpdEdyb3VwcyA9IFtbXV07CiAgICAgICAgZ3JvdXAuZm9yRWFjaChmdW5jdGlvbiAoc25hcHNob3QpIHsKICAgICAgICAgIHZhciBhZGRpdGlvbmFsTGVuZ3RoID0gZW5jb2RlVVJJQ29tcG9uZW50KHNuYXBzaG90LmlkKS5sZW5ndGggKyBwYXJhbU5hbWVMZW5ndGg7CgogICAgICAgICAgaWYgKGJhc2VVcmwubGVuZ3RoICsgaWRzU2l6ZSArIGFkZGl0aW9uYWxMZW5ndGggPj0gbWF4VVJMTGVuZ3RoKSB7CiAgICAgICAgICAgIGlkc1NpemUgPSAwOwogICAgICAgICAgICBzcGxpdEdyb3Vwcy5wdXNoKFtdKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZHNTaXplICs9IGFkZGl0aW9uYWxMZW5ndGg7CiAgICAgICAgICB2YXIgbGFzdEdyb3VwSW5kZXggPSBzcGxpdEdyb3Vwcy5sZW5ndGggLSAxOwogICAgICAgICAgc3BsaXRHcm91cHNbbGFzdEdyb3VwSW5kZXhdLnB1c2goc25hcHNob3QpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBzcGxpdEdyb3VwczsKICAgICAgfQoKICAgICAgdmFyIGdyb3Vwc0FycmF5ID0gW107CiAgICAgIGdyb3Vwcy5mb3JFYWNoKGZ1bmN0aW9uIChncm91cCwga2V5KSB7CiAgICAgICAgdmFyIHBhcmFtTmFtZUxlbmd0aCA9ICcmaWRzJTVCJTVEPScubGVuZ3RoOwogICAgICAgIHZhciBzcGxpdEdyb3VwcyA9IHNwbGl0R3JvdXBUb0ZpdEluVXJsKGdyb3VwLCBtYXhVUkxMZW5ndGgsIHBhcmFtTmFtZUxlbmd0aCk7CiAgICAgICAgc3BsaXRHcm91cHMuZm9yRWFjaChmdW5jdGlvbiAoc3BsaXRHcm91cCkgewogICAgICAgICAgcmV0dXJuIGdyb3Vwc0FycmF5LnB1c2goc3BsaXRHcm91cCk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gZ3JvdXBzQXJyYXk7CiAgICB9LAoKICAgIC8qKgogICAgICBUYWtlcyBhbiBhamF4IHJlc3BvbnNlLCBhbmQgcmV0dXJucyB0aGUganNvbiBwYXlsb2FkIG9yIGFuIGVycm9yLgogICAgICAgQnkgZGVmYXVsdCB0aGlzIGhvb2sganVzdCByZXR1cm5zIHRoZSBqc29uIHBheWxvYWQgcGFzc2VkIHRvIGl0LgogICAgICBZb3UgbWlnaHQgd2FudCB0byBvdmVycmlkZSBpdCBpbiB0d28gY2FzZXM6CiAgICAgICAxLiBZb3VyIEFQSSBtaWdodCByZXR1cm4gdXNlZnVsIHJlc3VsdHMgaW4gdGhlIHJlc3BvbnNlIGhlYWRlcnMuCiAgICAgIFJlc3BvbnNlIGhlYWRlcnMgYXJlIHBhc3NlZCBpbiBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50LgogICAgICAgMi4gWW91ciBBUEkgbWlnaHQgcmV0dXJuIGVycm9ycyBhcyBzdWNjZXNzZnVsIHJlc3BvbnNlcyB3aXRoIHN0YXR1cyBjb2RlCiAgICAgIDIwMCBhbmQgYW4gRXJyb3JzIHRleHQgb3Igb2JqZWN0LiBZb3UgY2FuIHJldHVybiBhIGBJbnZhbGlkRXJyb3JgIG9yIGEKICAgICAgYEFkYXB0ZXJFcnJvcmAgKG9yIGEgc3ViIGNsYXNzKSBmcm9tIHRoaXMgaG9vayBhbmQgaXQgd2lsbCBhdXRvbWF0aWNhbGx5CiAgICAgIHJlamVjdCB0aGUgcHJvbWlzZSBhbmQgcHV0IHlvdXIgcmVjb3JkIGludG8gdGhlIGludmFsaWQgb3IgZXJyb3Igc3RhdGUuCiAgICAgICBSZXR1cm5pbmcgYSBgSW52YWxpZEVycm9yYCBmcm9tIHRoaXMgbWV0aG9kIHdpbGwgY2F1c2UgdGhlCiAgICAgIHJlY29yZCB0byB0cmFuc2l0aW9uIGludG8gdGhlIGBpbnZhbGlkYCBzdGF0ZSBhbmQgbWFrZSB0aGUKICAgICAgYGVycm9yc2Agb2JqZWN0IGF2YWlsYWJsZSBvbiB0aGUgcmVjb3JkLiBXaGVuIHJldHVybmluZyBhbgogICAgICBgSW52YWxpZEVycm9yYCB0aGUgc3RvcmUgd2lsbCBhdHRlbXB0IHRvIG5vcm1hbGl6ZSB0aGUgZXJyb3IgZGF0YQogICAgICByZXR1cm5lZCBmcm9tIHRoZSBzZXJ2ZXIgdXNpbmcgdGhlIHNlcmlhbGl6ZXIncyBgZXh0cmFjdEVycm9yc2AKICAgICAgbWV0aG9kLgogICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIGhhbmRsZVJlc3BvbnNlCiAgICAgIEBwYXJhbSAge051bWJlcn0gc3RhdHVzCiAgICAgIEBwYXJhbSAge09iamVjdH0gaGVhZGVycwogICAgICBAcGFyYW0gIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHBhcmFtICB7T2JqZWN0fSByZXF1ZXN0RGF0YSAtIHRoZSBvcmlnaW5hbCByZXF1ZXN0IGluZm9ybWF0aW9uCiAgICAgIEByZXR1cm4ge09iamVjdCB8IEFkYXB0ZXJFcnJvcn0gcmVzcG9uc2UKICAgICovCiAgICBoYW5kbGVSZXNwb25zZTogZnVuY3Rpb24gaGFuZGxlUmVzcG9uc2Uoc3RhdHVzLCBoZWFkZXJzLCBwYXlsb2FkLCByZXF1ZXN0RGF0YSkgewogICAgICBpZiAodGhpcy5pc1N1Y2Nlc3Moc3RhdHVzLCBoZWFkZXJzLCBwYXlsb2FkKSkgewogICAgICAgIHJldHVybiBwYXlsb2FkOwogICAgICB9IGVsc2UgaWYgKHRoaXMuaXNJbnZhbGlkKHN0YXR1cywgaGVhZGVycywgcGF5bG9hZCkpIHsKICAgICAgICByZXR1cm4gbmV3IF9lcnJvci5JbnZhbGlkRXJyb3IocGF5bG9hZC5lcnJvcnMpOwogICAgICB9CgogICAgICB2YXIgZXJyb3JzID0gdGhpcy5ub3JtYWxpemVFcnJvclJlc3BvbnNlKHN0YXR1cywgaGVhZGVycywgcGF5bG9hZCk7CiAgICAgIHZhciBkZXRhaWxlZE1lc3NhZ2UgPSB0aGlzLmdlbmVyYXRlZERldGFpbGVkTWVzc2FnZShzdGF0dXMsIGhlYWRlcnMsIHBheWxvYWQsIHJlcXVlc3REYXRhKTsKCiAgICAgIHN3aXRjaCAoc3RhdHVzKSB7CiAgICAgICAgY2FzZSA0MDE6CiAgICAgICAgICByZXR1cm4gbmV3IF9lcnJvci5VbmF1dGhvcml6ZWRFcnJvcihlcnJvcnMsIGRldGFpbGVkTWVzc2FnZSk7CgogICAgICAgIGNhc2UgNDAzOgogICAgICAgICAgcmV0dXJuIG5ldyBfZXJyb3IuRm9yYmlkZGVuRXJyb3IoZXJyb3JzLCBkZXRhaWxlZE1lc3NhZ2UpOwoKICAgICAgICBjYXNlIDQwNDoKICAgICAgICAgIHJldHVybiBuZXcgX2Vycm9yLk5vdEZvdW5kRXJyb3IoZXJyb3JzLCBkZXRhaWxlZE1lc3NhZ2UpOwoKICAgICAgICBjYXNlIDQwOToKICAgICAgICAgIHJldHVybiBuZXcgX2Vycm9yLkNvbmZsaWN0RXJyb3IoZXJyb3JzLCBkZXRhaWxlZE1lc3NhZ2UpOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaWYgKHN0YXR1cyA+PSA1MDApIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBfZXJyb3IuU2VydmVyRXJyb3IoZXJyb3JzLCBkZXRhaWxlZE1lc3NhZ2UpOwogICAgICAgICAgfQoKICAgICAgfQoKICAgICAgcmV0dXJuIG5ldyBfZXJyb3IuZGVmYXVsdChlcnJvcnMsIGRldGFpbGVkTWVzc2FnZSk7CiAgICB9LAoKICAgIC8qKgogICAgICBEZWZhdWx0IGBoYW5kbGVSZXNwb25zZWAgaW1wbGVtZW50YXRpb24gdXNlcyB0aGlzIGhvb2sgdG8gZGVjaWRlIGlmIHRoZQogICAgICByZXNwb25zZSBpcyBhIHN1Y2Nlc3MuCiAgICAgICBAc2luY2UgMS4xMy4wCiAgICAgIEBtZXRob2QgaXNTdWNjZXNzCiAgICAgIEBwYXJhbSAge051bWJlcn0gc3RhdHVzCiAgICAgIEBwYXJhbSAge09iamVjdH0gaGVhZGVycwogICAgICBAcGFyYW0gIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHJldHVybiB7Qm9vbGVhbn0KICAgICovCiAgICBpc1N1Y2Nlc3M6IGZ1bmN0aW9uIGlzU3VjY2VzcyhzdGF0dXMsIGhlYWRlcnMsIHBheWxvYWQpIHsKICAgICAgcmV0dXJuIHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwIHx8IHN0YXR1cyA9PT0gMzA0OwogICAgfSwKCiAgICAvKioKICAgICAgRGVmYXVsdCBgaGFuZGxlUmVzcG9uc2VgIGltcGxlbWVudGF0aW9uIHVzZXMgdGhpcyBob29rIHRvIGRlY2lkZSBpZiB0aGUKICAgICAgcmVzcG9uc2UgaXMgYW4gaW52YWxpZCBlcnJvci4KICAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBpc0ludmFsaWQKICAgICAgQHBhcmFtICB7TnVtYmVyfSBzdGF0dXMKICAgICAgQHBhcmFtICB7T2JqZWN0fSBoZWFkZXJzCiAgICAgIEBwYXJhbSAge09iamVjdH0gcGF5bG9hZAogICAgICBAcmV0dXJuIHtCb29sZWFufQogICAgKi8KICAgIGlzSW52YWxpZDogZnVuY3Rpb24gaXNJbnZhbGlkKHN0YXR1cywgaGVhZGVycywgcGF5bG9hZCkgewogICAgICByZXR1cm4gc3RhdHVzID09PSA0MjI7CiAgICB9LAoKICAgIC8qKgogICAgICBUYWtlcyBhIFVSTCwgYW4gSFRUUCBtZXRob2QgYW5kIGEgaGFzaCBvZiBkYXRhLCBhbmQgbWFrZXMgYW4KICAgICAgSFRUUCByZXF1ZXN0LgogICAgICAgV2hlbiB0aGUgc2VydmVyIHJlc3BvbmRzIHdpdGggYSBwYXlsb2FkLCBFbWJlciBEYXRhIHdpbGwgY2FsbCBpbnRvIGBleHRyYWN0U2luZ2xlYAogICAgICBvciBgZXh0cmFjdEFycmF5YCAoZGVwZW5kaW5nIG9uIHdoZXRoZXIgdGhlIG9yaWdpbmFsIHF1ZXJ5IHdhcyBmb3Igb25lIHJlY29yZCBvcgogICAgICBtYW55IHJlY29yZHMpLgogICAgICAgQnkgZGVmYXVsdCwgYGFqYXhgIG1ldGhvZCBoYXMgdGhlIGZvbGxvd2luZyBiZWhhdmlvcjoKICAgICAgICogSXQgc2V0cyB0aGUgcmVzcG9uc2UgYGRhdGFUeXBlYCB0byBgImpzb24iYAogICAgICAqIElmIHRoZSBIVFRQIG1ldGhvZCBpcyBub3QgYCJHRVQiYCwgaXQgc2V0cyB0aGUgYENvbnRlbnQtVHlwZWAgdG8gYmUKICAgICAgICBgYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOGAKICAgICAgKiBJZiB0aGUgSFRUUCBtZXRob2QgaXMgbm90IGAiR0VUImAsIGl0IHN0cmluZ2lmaWVzIHRoZSBkYXRhIHBhc3NlZCBpbi4gVGhlCiAgICAgICAgZGF0YSBpcyB0aGUgc2VyaWFsaXplZCByZWNvcmQgaW4gdGhlIGNhc2Ugb2YgYSBzYXZlLgogICAgICAqIFJlZ2lzdGVycyBzdWNjZXNzIGFuZCBmYWlsdXJlIGhhbmRsZXJzLgogICAgICAgQG1ldGhvZCBhamF4CiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwKICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHJlcXVlc3QgdHlwZSBHRVQsIFBPU1QsIFBVVCwgREVMRVRFIGV0Yy4KICAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIGFqYXg6IGZ1bmN0aW9uIGFqYXgodXJsLCB0eXBlLCBvcHRpb25zKSB7CiAgICAgIHZhciBhZGFwdGVyID0gdGhpczsKICAgICAgdmFyIHVzZUZldGNoID0gRW1iZXIuZ2V0KHRoaXMsICd1c2VGZXRjaCcpOwogICAgICB2YXIgcmVxdWVzdERhdGEgPSB7CiAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgbWV0aG9kOiB0eXBlCiAgICAgIH07CiAgICAgIHZhciBoYXNoID0gYWRhcHRlci5hamF4T3B0aW9ucyh1cmwsIHR5cGUsIG9wdGlvbnMpOwoKICAgICAgaWYgKHVzZUZldGNoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ZldGNoUmVxdWVzdChoYXNoKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgcmV0dXJuIEVtYmVyLlJTVlAuaGFzaCh7CiAgICAgICAgICAgIHJlc3BvbnNlOiByZXNwb25zZSwKICAgICAgICAgICAgcGF5bG9hZDogKDAsIF9wcml2YXRlLmRldGVybWluZUJvZHlQcm9taXNlKShyZXNwb25zZSwgcmVxdWVzdERhdGEpCiAgICAgICAgICB9KTsKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChfcmVmKSB7CiAgICAgICAgICB2YXIgcmVzcG9uc2UgPSBfcmVmLnJlc3BvbnNlLAogICAgICAgICAgICAgIHBheWxvYWQgPSBfcmVmLnBheWxvYWQ7CgogICAgICAgICAgaWYgKHJlc3BvbnNlLm9rKSB7CiAgICAgICAgICAgIHJldHVybiBmZXRjaFN1Y2Nlc3NIYW5kbGVyKGFkYXB0ZXIsIHBheWxvYWQsIHJlc3BvbnNlLCByZXF1ZXN0RGF0YSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBmZXRjaEVycm9ySGFuZGxlcihhZGFwdGVyLCBwYXlsb2FkLCByZXNwb25zZSwgbnVsbCwgcmVxdWVzdERhdGEpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIGhhc2guc3VjY2VzcyA9IGZ1bmN0aW9uIChwYXlsb2FkLCB0ZXh0U3RhdHVzLCBqcVhIUikgewogICAgICAgICAgdmFyIHJlc3BvbnNlID0gYWpheFN1Y2Nlc3NIYW5kbGVyKGFkYXB0ZXIsIHBheWxvYWQsIGpxWEhSLCByZXF1ZXN0RGF0YSk7CiAgICAgICAgICBFbWJlci5ydW4uam9pbihudWxsLCByZXNvbHZlLCByZXNwb25zZSk7CiAgICAgICAgfTsKCiAgICAgICAgaGFzaC5lcnJvciA9IGZ1bmN0aW9uIChqcVhIUiwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHsKICAgICAgICAgIHZhciBlcnJvciA9IGFqYXhFcnJvckhhbmRsZXIoYWRhcHRlciwganFYSFIsIGVycm9yVGhyb3duLCByZXF1ZXN0RGF0YSk7CiAgICAgICAgICBFbWJlci5ydW4uam9pbihudWxsLCByZWplY3QsIGVycm9yKTsKICAgICAgICB9OwoKICAgICAgICBhZGFwdGVyLl9hamF4KGhhc2gpOwogICAgICB9LCAnRFM6IFJFU1RBZGFwdGVyI2FqYXggJyArIHR5cGUgKyAnIHRvICcgKyB1cmwpOwogICAgfSwKCiAgICAvKioKICAgICAgQG1ldGhvZCBfYWpheFJlcXVlc3QKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgalF1ZXJ5IGFqYXggb3B0aW9ucyB0byBiZSB1c2VkIGZvciB0aGUgYWpheCByZXF1ZXN0CiAgICAqLwogICAgX2FqYXhSZXF1ZXN0OiBmdW5jdGlvbiBfYWpheFJlcXVlc3Qob3B0aW9ucykgewogICAgICBqUXVlcnkuYWpheChvcHRpb25zKTsKICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2QgX25hamF4UmVxdWVzdAogICAgICBAcHJpdmF0ZQogICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBqUXVlcnkgYWpheCBvcHRpb25zIHRvIGJlIHVzZWQgZm9yIHRoZSBuYWpheCByZXF1ZXN0CiAgICAqLwogICAgX25hamF4UmVxdWVzdDogZnVuY3Rpb24gX25hamF4UmVxdWVzdChvcHRpb25zKSB7CiAgICAgIGlmIChoYXNOYWpheCkgewogICAgICAgIG5hamF4KG9wdGlvbnMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignbmFqYXggZG9lcyBub3Qgc2VlbSB0byBiZSBkZWZpbmVkIGluIHlvdXIgYXBwLiBEaWQgeW91IG92ZXJyaWRlIGl0IHZpYSBgYWRkT3JPdmVycmlkZVNhbmRib3hHbG9iYWxzYCBpbiB0aGUgZmFzdGJvb3Qgc2VydmVyPycpOwogICAgICB9CiAgICB9LAogICAgX2ZldGNoUmVxdWVzdDogZnVuY3Rpb24gX2ZldGNoUmVxdWVzdChvcHRpb25zKSB7CiAgICAgIHZhciBmZXRjaEZ1bmN0aW9uID0gKDAsIF9wcml2YXRlLmZldGNoKSgpOwoKICAgICAgaWYgKGZldGNoRnVuY3Rpb24pIHsKICAgICAgICByZXR1cm4gZmV0Y2hGdW5jdGlvbihvcHRpb25zLnVybCwgb3B0aW9ucyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdjYW5ub3QgZmluZCB0aGUgYGZldGNoYCBtb2R1bGUgb3IgdGhlIGBmZXRjaGAgZ2xvYmFsLiBEaWQgeW91IG1lYW4gdG8gaW5zdGFsbCB0aGUgYGVtYmVyLWZldGNoYCBhZGRvbj8nKTsKICAgICAgfQogICAgfSwKICAgIF9hamF4OiBmdW5jdGlvbiBfYWpheChvcHRpb25zKSB7CiAgICAgIGlmIChFbWJlci5nZXQodGhpcywgJ3VzZUZldGNoJykpIHsKICAgICAgICB0aGlzLl9mZXRjaFJlcXVlc3Qob3B0aW9ucyk7CiAgICAgIH0gZWxzZSBpZiAoRW1iZXIuZ2V0KHRoaXMsICdmYXN0Ym9vdC5pc0Zhc3RCb290JykpIHsKICAgICAgICB0aGlzLl9uYWpheFJlcXVlc3Qob3B0aW9ucyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fYWpheFJlcXVlc3Qob3B0aW9ucyk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2QgYWpheE9wdGlvbnMKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybAogICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgcmVxdWVzdCB0eXBlIEdFVCwgUE9TVCwgUFVULCBERUxFVEUgZXRjLgogICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAqLwogICAgYWpheE9wdGlvbnM6IGZ1bmN0aW9uIGFqYXhPcHRpb25zKHVybCwgbWV0aG9kLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBFbWJlci5hc3NpZ24oewogICAgICAgIHVybDogdXJsLAogICAgICAgIG1ldGhvZDogbWV0aG9kLAogICAgICAgIHR5cGU6IG1ldGhvZAogICAgICB9LCBvcHRpb25zKTsKICAgICAgdmFyIGhlYWRlcnMgPSBFbWJlci5nZXQodGhpcywgJ2hlYWRlcnMnKTsKCiAgICAgIGlmIChoZWFkZXJzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBvcHRpb25zLmhlYWRlcnMgPSBFbWJlci5hc3NpZ24oe30sIGhlYWRlcnMsIG9wdGlvbnMuaGVhZGVycyk7CiAgICAgIH0gZWxzZSBpZiAoIW9wdGlvbnMuaGVhZGVycykgewogICAgICAgIG9wdGlvbnMuaGVhZGVycyA9IHt9OwogICAgICB9CgogICAgICB2YXIgY29udGVudFR5cGUgPSBvcHRpb25zLmNvbnRlbnRUeXBlIHx8IHRoaXMuX2RlZmF1bHRDb250ZW50VHlwZTsKCiAgICAgIGlmIChFbWJlci5nZXQodGhpcywgJ3VzZUZldGNoJykpIHsKICAgICAgICBpZiAob3B0aW9ucy5kYXRhICYmIG9wdGlvbnMudHlwZSAhPT0gJ0dFVCcpIHsKICAgICAgICAgIGlmICghb3B0aW9ucy5oZWFkZXJzWydDb250ZW50LVR5cGUnXSAmJiAhb3B0aW9ucy5oZWFkZXJzWydjb250ZW50LXR5cGUnXSkgewogICAgICAgICAgICBvcHRpb25zLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddID0gY29udGVudFR5cGU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBvcHRpb25zID0gZmV0Y2hPcHRpb25zKG9wdGlvbnMsIHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIEdFVCByZXF1ZXN0cyB3aXRob3V0IGEgYm9keSBzaG91bGQgbm90IGhhdmUgYSBjb250ZW50LXR5cGUgaGVhZGVyCiAgICAgICAgLy8gYW5kIG1heSBiZSB1bmV4cGVjdGVkIGJ5IGEgc2VydmVyCiAgICAgICAgaWYgKG9wdGlvbnMuZGF0YSAmJiBvcHRpb25zLnR5cGUgIT09ICdHRVQnKSB7CiAgICAgICAgICBvcHRpb25zID0gRW1iZXIuYXNzaWduKG9wdGlvbnMsIHsKICAgICAgICAgICAgY29udGVudFR5cGU6IGNvbnRlbnRUeXBlCiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIG9wdGlvbnMgPSBfYWpheE9wdGlvbnMob3B0aW9ucywgdGhpcyk7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMudXJsID0gdGhpcy5fYWpheFVSTChvcHRpb25zLnVybCk7CiAgICAgIHJldHVybiBvcHRpb25zOwogICAgfSwKICAgIF9hamF4VVJMOiBmdW5jdGlvbiBfYWpheFVSTCh1cmwpIHsKICAgICAgaWYgKEVtYmVyLmdldCh0aGlzLCAnZmFzdGJvb3QuaXNGYXN0Qm9vdCcpKSB7CiAgICAgICAgdmFyIGh0dHBSZWdleCA9IC9eaHR0cHM/OlwvXC8vOwogICAgICAgIHZhciBwcm90b2NvbFJlbGF0aXZlUmVnZXggPSAvXlwvXC8vOwogICAgICAgIHZhciBwcm90b2NvbCA9IEVtYmVyLmdldCh0aGlzLCAnZmFzdGJvb3QucmVxdWVzdC5wcm90b2NvbCcpOwogICAgICAgIHZhciBob3N0ID0gRW1iZXIuZ2V0KHRoaXMsICdmYXN0Ym9vdC5yZXF1ZXN0Lmhvc3QnKTsKCiAgICAgICAgaWYgKHByb3RvY29sUmVsYXRpdmVSZWdleC50ZXN0KHVybCkpIHsKICAgICAgICAgIHJldHVybiAiIiArIHByb3RvY29sICsgdXJsOwogICAgICAgIH0gZWxzZSBpZiAoIWh0dHBSZWdleC50ZXN0KHVybCkpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBwcm90b2NvbCArICIvLyIgKyBob3N0ICsgdXJsOwogICAgICAgICAgfSBjYXRjaCAoZmJFcnJvcikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBhcmUgdXNpbmcgRW1iZXIgRGF0YSB3aXRoIG5vIGhvc3QgZGVmaW5lZCBpbiB5b3VyIGFkYXB0ZXIuIFRoaXMgd2lsbCBhdHRlbXB0IHRvIHVzZSB0aGUgaG9zdCBvZiB0aGUgRmFzdEJvb3QgcmVxdWVzdCwgd2hpY2ggaXMgbm90IGNvbmZpZ3VyZWQgZm9yIHRoZSBjdXJyZW50IGhvc3Qgb2YgdGhpcyByZXF1ZXN0LiBQbGVhc2Ugc2V0IHRoZSBob3N0V2hpdGVsaXN0IHByb3BlcnR5IGZvciBpbiB5b3VyIGVudmlyb25tZW50LmpzLiBGYXN0Qm9vdCBFcnJvcjogJyArIGZiRXJyb3IubWVzc2FnZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdXJsOwogICAgfSwKCiAgICAvKioKICAgICAgQG1ldGhvZCBwYXJzZUVycm9yUmVzcG9uc2UKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IHJlc3BvbnNlVGV4dAogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAqLwogICAgcGFyc2VFcnJvclJlc3BvbnNlOiBmdW5jdGlvbiBwYXJzZUVycm9yUmVzcG9uc2UocmVzcG9uc2VUZXh0KSB7CiAgICAgIHZhciBqc29uID0gcmVzcG9uc2VUZXh0OwoKICAgICAgdHJ5IHsKICAgICAgICBqc29uID0gSlNPTi5wYXJzZShyZXNwb25zZVRleHQpOwogICAgICB9IGNhdGNoIChlKSB7Ly8gaWdub3JlZAogICAgICB9CgogICAgICByZXR1cm4ganNvbjsKICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2Qgbm9ybWFsaXplRXJyb3JSZXNwb25zZQogICAgICBAcHJpdmF0ZQogICAgICBAcGFyYW0gIHtOdW1iZXJ9IHN0YXR1cwogICAgICBAcGFyYW0gIHtPYmplY3R9IGhlYWRlcnMKICAgICAgQHBhcmFtICB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEByZXR1cm4ge0FycmF5fSBlcnJvcnMgcGF5bG9hZAogICAgKi8KICAgIG5vcm1hbGl6ZUVycm9yUmVzcG9uc2U6IGZ1bmN0aW9uIG5vcm1hbGl6ZUVycm9yUmVzcG9uc2Uoc3RhdHVzLCBoZWFkZXJzLCBwYXlsb2FkKSB7CiAgICAgIGlmIChwYXlsb2FkICYmIHR5cGVvZiBwYXlsb2FkID09PSAnb2JqZWN0JyAmJiBwYXlsb2FkLmVycm9ycykgewogICAgICAgIHJldHVybiBwYXlsb2FkLmVycm9yczsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gW3sKICAgICAgICAgIHN0YXR1czogIiIgKyBzdGF0dXMsCiAgICAgICAgICB0aXRsZTogJ1RoZSBiYWNrZW5kIHJlc3BvbmRlZCB3aXRoIGFuIGVycm9yJywKICAgICAgICAgIGRldGFpbDogIiIgKyBwYXlsb2FkCiAgICAgICAgfV07CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgIEdlbmVyYXRlcyBhIGRldGFpbGVkICgiZnJpZW5kbHkiKSBlcnJvciBtZXNzYWdlLCB3aXRoIHBsZW50eQogICAgICBvZiBpbmZvcm1hdGlvbiBmb3IgZGVidWdnaW5nIChnb29kIGx1Y2shKQogICAgICAgQG1ldGhvZCBnZW5lcmF0ZWREZXRhaWxlZE1lc3NhZ2UKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtICB7TnVtYmVyfSBzdGF0dXMKICAgICAgQHBhcmFtICB7T2JqZWN0fSBoZWFkZXJzCiAgICAgIEBwYXJhbSAge09iamVjdH0gcGF5bG9hZAogICAgICBAcGFyYW0gIHtPYmplY3R9IHJlcXVlc3REYXRhCiAgICAgIEByZXR1cm4ge1N0cmluZ30gZGV0YWlsZWQgZXJyb3IgbWVzc2FnZQogICAgKi8KICAgIGdlbmVyYXRlZERldGFpbGVkTWVzc2FnZTogZnVuY3Rpb24gZ2VuZXJhdGVkRGV0YWlsZWRNZXNzYWdlKHN0YXR1cywgaGVhZGVycywgcGF5bG9hZCwgcmVxdWVzdERhdGEpIHsKICAgICAgdmFyIHNob3J0ZW5lZFBheWxvYWQ7CiAgICAgIHZhciBwYXlsb2FkQ29udGVudFR5cGUgPSBoZWFkZXJzWydjb250ZW50LXR5cGUnXSB8fCAnRW1wdHkgQ29udGVudC1UeXBlJzsKCiAgICAgIGlmIChwYXlsb2FkQ29udGVudFR5cGUgPT09ICd0ZXh0L2h0bWwnICYmIHBheWxvYWQubGVuZ3RoID4gMjUwKSB7CiAgICAgICAgc2hvcnRlbmVkUGF5bG9hZCA9ICdbT21pdHRlZCBMZW5ndGh5IEhUTUxdJzsKICAgICAgfSBlbHNlIHsKICAgICAgICBzaG9ydGVuZWRQYXlsb2FkID0gcGF5bG9hZDsKICAgICAgfQoKICAgICAgdmFyIHJlcXVlc3REZXNjcmlwdGlvbiA9IHJlcXVlc3REYXRhLm1ldGhvZCArICcgJyArIHJlcXVlc3REYXRhLnVybDsKICAgICAgdmFyIHBheWxvYWREZXNjcmlwdGlvbiA9ICdQYXlsb2FkICgnICsgcGF5bG9hZENvbnRlbnRUeXBlICsgJyknOwogICAgICByZXR1cm4gWydFbWJlciBEYXRhIFJlcXVlc3QgJyArIHJlcXVlc3REZXNjcmlwdGlvbiArICcgcmV0dXJuZWQgYSAnICsgc3RhdHVzLCBwYXlsb2FkRGVzY3JpcHRpb24sIHNob3J0ZW5lZFBheWxvYWRdLmpvaW4oJ1xuJyk7CiAgICB9LAogICAgLy8gQHNpbmNlIDIuNS4wCiAgICBidWlsZFF1ZXJ5OiBmdW5jdGlvbiBidWlsZFF1ZXJ5KHNuYXBzaG90KSB7CiAgICAgIHZhciBxdWVyeSA9IHt9OwoKICAgICAgaWYgKHNuYXBzaG90KSB7CiAgICAgICAgdmFyIGluY2x1ZGUgPSBzbmFwc2hvdC5pbmNsdWRlOwoKICAgICAgICBpZiAoaW5jbHVkZSkgewogICAgICAgICAgcXVlcnkuaW5jbHVkZSA9IGluY2x1ZGU7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gcXVlcnk7CiAgICB9CiAgfSk7CgogIGZ1bmN0aW9uIGFqYXhTdWNjZXNzKGFkYXB0ZXIsIHBheWxvYWQsIHJlcXVlc3REYXRhLCByZXNwb25zZURhdGEpIHsKICAgIHZhciByZXNwb25zZTsKCiAgICB0cnkgewogICAgICByZXNwb25zZSA9IGFkYXB0ZXIuaGFuZGxlUmVzcG9uc2UocmVzcG9uc2VEYXRhLnN0YXR1cywgcmVzcG9uc2VEYXRhLmhlYWRlcnMsIHBheWxvYWQsIHJlcXVlc3REYXRhKTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7CiAgICB9CgogICAgaWYgKHJlc3BvbnNlICYmIHJlc3BvbnNlLmlzQWRhcHRlckVycm9yKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChyZXNwb25zZSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhamF4RXJyb3IoYWRhcHRlciwgcGF5bG9hZCwgcmVxdWVzdERhdGEsIHJlc3BvbnNlRGF0YSkgewogICAgdmFyIGVycm9yOwoKICAgIGlmIChyZXNwb25zZURhdGEuZXJyb3JUaHJvd24gaW5zdGFuY2VvZiBFcnJvcikgewogICAgICBlcnJvciA9IHJlc3BvbnNlRGF0YS5lcnJvclRocm93bjsKICAgIH0gZWxzZSBpZiAocmVzcG9uc2VEYXRhLnRleHRTdGF0dXMgPT09ICd0aW1lb3V0JykgewogICAgICBlcnJvciA9IG5ldyBfZXJyb3IuVGltZW91dEVycm9yKCk7CiAgICB9IGVsc2UgaWYgKHJlc3BvbnNlRGF0YS50ZXh0U3RhdHVzID09PSAnYWJvcnQnIHx8IHJlc3BvbnNlRGF0YS5zdGF0dXMgPT09IDApIHsKICAgICAgZXJyb3IgPSBoYW5kbGVBYm9ydChyZXF1ZXN0RGF0YSwgcmVzcG9uc2VEYXRhKTsKICAgIH0gZWxzZSB7CiAgICAgIHRyeSB7CiAgICAgICAgZXJyb3IgPSBhZGFwdGVyLmhhbmRsZVJlc3BvbnNlKHJlc3BvbnNlRGF0YS5zdGF0dXMsIHJlc3BvbnNlRGF0YS5oZWFkZXJzLCBwYXlsb2FkIHx8IHJlc3BvbnNlRGF0YS5lcnJvclRocm93biwgcmVxdWVzdERhdGEpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgZXJyb3IgPSBlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGVycm9yOwogIH0gLy8gQWRhcHRlciBhYm9ydCBlcnJvciB0byBpbmNsdWRlIGFueSByZWxldmVudCBpbmZvLCBlLmcuIHJlcXVlc3QvcmVzcG9uc2U6CgoKICBmdW5jdGlvbiBoYW5kbGVBYm9ydChyZXF1ZXN0RGF0YSwgcmVzcG9uc2VEYXRhKSB7CiAgICB2YXIgbWV0aG9kID0gcmVxdWVzdERhdGEubWV0aG9kLAogICAgICAgIHVybCA9IHJlcXVlc3REYXRhLnVybCwKICAgICAgICBlcnJvclRocm93biA9IHJlcXVlc3REYXRhLmVycm9yVGhyb3duOwogICAgdmFyIHN0YXR1cyA9IHJlc3BvbnNlRGF0YS5zdGF0dXM7CiAgICB2YXIgbXNnID0gIlJlcXVlc3QgZmFpbGVkOiAiICsgbWV0aG9kICsgIiAiICsgdXJsICsgIiAiICsgKGVycm9yVGhyb3duIHx8ICcnKTsKICAgIHZhciBlcnJvcnMgPSBbewogICAgICB0aXRsZTogJ0FkYXB0ZXIgRXJyb3InLAogICAgICBkZXRhaWw6IG1zZy50cmltKCksCiAgICAgIHN0YXR1czogc3RhdHVzCiAgICB9XTsKICAgIHJldHVybiBuZXcgX2Vycm9yLkFib3J0RXJyb3IoZXJyb3JzKTsKICB9IC8vRnJvbSBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzI4MDYzNC9lbmRzd2l0aC1pbi1qYXZhc2NyaXB0CgoKICBmdW5jdGlvbiBlbmRzV2l0aChzdHJpbmcsIHN1ZmZpeCkgewogICAgaWYgKHR5cGVvZiBTdHJpbmcucHJvdG90eXBlLmVuZHNXaXRoICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHJldHVybiBzdHJpbmcuaW5kZXhPZihzdWZmaXgsIHN0cmluZy5sZW5ndGggLSBzdWZmaXgubGVuZ3RoKSAhPT0gLTE7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gc3RyaW5nLmVuZHNXaXRoKHN1ZmZpeCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBmZXRjaFN1Y2Nlc3NIYW5kbGVyKGFkYXB0ZXIsIHBheWxvYWQsIHJlc3BvbnNlLCByZXF1ZXN0RGF0YSkgewogICAgdmFyIHJlc3BvbnNlRGF0YSA9IGZldGNoUmVzcG9uc2VEYXRhKHJlc3BvbnNlKTsKICAgIHJldHVybiBhamF4U3VjY2VzcyhhZGFwdGVyLCBwYXlsb2FkLCByZXF1ZXN0RGF0YSwgcmVzcG9uc2VEYXRhKTsKICB9CgogIGZ1bmN0aW9uIGZldGNoRXJyb3JIYW5kbGVyKGFkYXB0ZXIsIHBheWxvYWQsIHJlc3BvbnNlLCBlcnJvclRocm93biwgcmVxdWVzdERhdGEpIHsKICAgIHZhciByZXNwb25zZURhdGEgPSBmZXRjaFJlc3BvbnNlRGF0YShyZXNwb25zZSk7CiAgICByZXNwb25zZURhdGEuZXJyb3JUaHJvd24gPSBlcnJvclRocm93bjsKICAgIHJldHVybiBhamF4RXJyb3IoYWRhcHRlciwgcGF5bG9hZCwgcmVxdWVzdERhdGEsIHJlc3BvbnNlRGF0YSk7CiAgfQoKICBmdW5jdGlvbiBhamF4U3VjY2Vzc0hhbmRsZXIoYWRhcHRlciwgcGF5bG9hZCwganFYSFIsIHJlcXVlc3REYXRhKSB7CiAgICB2YXIgcmVzcG9uc2VEYXRhID0gYWpheFJlc3BvbnNlRGF0YShqcVhIUik7CiAgICByZXR1cm4gYWpheFN1Y2Nlc3MoYWRhcHRlciwgcGF5bG9hZCwgcmVxdWVzdERhdGEsIHJlc3BvbnNlRGF0YSk7CiAgfQoKICBmdW5jdGlvbiBhamF4RXJyb3JIYW5kbGVyKGFkYXB0ZXIsIGpxWEhSLCBlcnJvclRocm93biwgcmVxdWVzdERhdGEpIHsKICAgIHZhciByZXNwb25zZURhdGEgPSBhamF4UmVzcG9uc2VEYXRhKGpxWEhSKTsKICAgIHJlc3BvbnNlRGF0YS5lcnJvclRocm93biA9IGVycm9yVGhyb3duOwogICAgdmFyIHBheWxvYWQgPSBhZGFwdGVyLnBhcnNlRXJyb3JSZXNwb25zZShqcVhIUi5yZXNwb25zZVRleHQpOwoKICAgIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICkgewogICAgICB2YXIgbWVzc2FnZSA9ICJUaGUgc2VydmVyIHJldHVybmVkIGFuIGVtcHR5IHN0cmluZyBmb3IgIiArIHJlcXVlc3REYXRhLm1ldGhvZCArICIgIiArIHJlcXVlc3REYXRhLnVybCArICIsIHdoaWNoIGNhbm5vdCBiZSBwYXJzZWQgaW50byBhIHZhbGlkIEpTT04uIFJldHVybiBlaXRoZXIgbnVsbCBvciB7fS4iOwogICAgICB2YXIgdmFsaWRKU09OU3RyaW5nID0gIShyZXNwb25zZURhdGEudGV4dFN0YXR1cyA9PT0gJ3BhcnNlcmVycm9yJyAmJiBwYXlsb2FkID09PSAnJyk7CiAgICAgIChmYWxzZSAmJiBFbWJlci53YXJuKG1lc3NhZ2UsIHZhbGlkSlNPTlN0cmluZywgewogICAgICAgIGlkOiAnZHMuYWRhcHRlci5yZXR1cm5lZC1lbXB0eS1zdHJpbmctYXMtSlNPTicKICAgICAgfSkpOwogICAgfQoKICAgIHJldHVybiBhamF4RXJyb3IoYWRhcHRlciwgcGF5bG9hZCwgcmVxdWVzdERhdGEsIHJlc3BvbnNlRGF0YSk7CiAgfQoKICBmdW5jdGlvbiBmZXRjaFJlc3BvbnNlRGF0YShyZXNwb25zZSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhdHVzOiByZXNwb25zZS5zdGF0dXMsCiAgICAgIHRleHRTdGF0dXM6IHJlc3BvbnNlLnRleHRTdGF0dXMsCiAgICAgIGhlYWRlcnM6IGhlYWRlcnNUb09iamVjdChyZXNwb25zZS5oZWFkZXJzKQogICAgfTsKICB9CgogIGZ1bmN0aW9uIGFqYXhSZXNwb25zZURhdGEoanFYSFIpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXR1czoganFYSFIuc3RhdHVzLAogICAgICB0ZXh0U3RhdHVzOiBqcVhIUi5zdGF0dXNUZXh0LAogICAgICBoZWFkZXJzOiAoMCwgX3ByaXZhdGUucGFyc2VSZXNwb25zZUhlYWRlcnMpKGpxWEhSLmdldEFsbFJlc3BvbnNlSGVhZGVycygpKQogICAgfTsKICB9CgogIGZ1bmN0aW9uIGhlYWRlcnNUb09iamVjdChoZWFkZXJzKSB7CiAgICB2YXIgaGVhZGVyc09iamVjdCA9IHt9OwoKICAgIGlmIChoZWFkZXJzKSB7CiAgICAgIGhlYWRlcnMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIHJldHVybiBoZWFkZXJzT2JqZWN0W2tleV0gPSB2YWx1ZTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIGhlYWRlcnNPYmplY3Q7CiAgfQogIC8qKgogICAqIEhlbHBlciBmdW5jdGlvbiB0aGF0IHRyYW5zbGF0ZXMgdGhlIG9wdGlvbnMgcGFzc2VkIHRvIGBqUXVlcnkuYWpheGAgaW50byBhIGZvcm1hdCB0aGF0IGBmZXRjaGAgZXhwZWN0cy4KICAgKiBAcGFyYW0ge09iamVjdH0gX29wdGlvbnMKICAgKiBAcGFyYW0ge0FkYXB0ZXJ9IGFkYXB0ZXIKICAgKiBAcmV0dXJucyB7T2JqZWN0fQogICAqLwoKCiAgZnVuY3Rpb24gZmV0Y2hPcHRpb25zKG9wdGlvbnMsIGFkYXB0ZXIpIHsKICAgIG9wdGlvbnMuY3JlZGVudGlhbHMgPSAnc2FtZS1vcmlnaW4nOwoKICAgIGlmIChvcHRpb25zLmRhdGEpIHsKICAgICAgLy8gR0VUIGFuZCBIRUFEIHJlcXVlc3RzIGNhbid0IGhhdmUgYSBgYm9keWAKICAgICAgaWYgKG9wdGlvbnMubWV0aG9kID09PSAnR0VUJyB8fCBvcHRpb25zLm1ldGhvZCA9PT0gJ0hFQUQnKSB7CiAgICAgICAgLy8gSWYgbm8gb3B0aW9ucyBhcmUgcGFzc2VkLCBFbWJlciBEYXRhIHNldHMgYGRhdGFgIHRvIGFuIGVtcHR5IG9iamVjdCwgd2hpY2ggd2UgdGVzdCBmb3IuCiAgICAgICAgaWYgKE9iamVjdC5rZXlzKG9wdGlvbnMuZGF0YSkubGVuZ3RoKSB7CiAgICAgICAgICAvLyBUZXN0IGlmIHRoZXJlIGFyZSBhbHJlYWR5IHF1ZXJ5IHBhcmFtcyBpbiB0aGUgdXJsIChtaW1pY3MgalF1ZXkuYWpheCkuCiAgICAgICAgICB2YXIgcXVlcnlQYXJhbURlbGltaXRlciA9IG9wdGlvbnMudXJsLmluZGV4T2YoJz8nKSA+IC0xID8gJyYnIDogJz8nOwogICAgICAgICAgb3B0aW9ucy51cmwgKz0gIiIgKyBxdWVyeVBhcmFtRGVsaW1pdGVyICsgKDAsIF9wcml2YXRlLnNlcmlhbGl6ZVF1ZXJ5UGFyYW1zKShvcHRpb25zLmRhdGEpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBOT1RFOiBhIHJlcXVlc3QncyBib2R5IGNhbm5vdCBiZSBhbiBvYmplY3QsIHNvIHdlIHN0cmluZ2lmeSBpdCBpZiBpdCBpcy4KICAgICAgICAvLyBKU09OLnN0cmluZ2lmeSByZW1vdmVzIGtleXMgd2l0aCB2YWx1ZXMgb2YgYHVuZGVmaW5lZGAgKG1pbWljcyBqUXVlcnkuYWpheCkuCiAgICAgICAgLy8gSWYgdGhlIGRhdGEgaXMgbm90IGEgUE9KTyAoaXQncyBhIFN0cmluZywgRm9ybURhdGEsIGV0YyksIHdlIGp1c3Qgc2V0IGl0LgogICAgICAgIC8vIElmIHRoZSBkYXRhIGlzIGEgc3RyaW5nLCB3ZSBhc3N1bWUgaXQncyBhIHN0cmluZ2lmaWVkIG9iamVjdC4KCiAgICAgICAgLyogV2UgY2hlY2sgZm9yIE9iamVjdHMgdGhpcyB3YXkgYmVjYXVzZSB3ZSB3YW50IHRoZSBsb2dpYyBpbnNpZGUgdGhlIGNvbnNlcXVlbnQgdG8gcnVuCiAgICAgICAgICogaWYgYG9wdGlvbnMuZGF0YWAgaXMgYSBQT0pPLCBub3QgaWYgaXQgaXMgYSBkYXRhIHN0cnVjdHVyZSB3aG9zZSBgdHlwZW9mYCByZXR1cm5zICJvYmplY3QiCiAgICAgICAgICogd2hlbiBpdCdzIG5vdCAoQXJyYXksIEZvcm1EYXRhLCBldGMpLiBUaGUgcmVhc29uIHdlIGRvbid0IHVzZSBgb3B0aW9ucy5kYXRhLmNvbnN0cnVjdG9yYAogICAgICAgICAqIHRvIGNoZWNrIGlzIGluIGNhc2UgYGRhdGFgIGlzIGFuIG9iamVjdCB3aXRoIG5vIHByb3RvdHlwZSAoZS5nLiBjcmVhdGVkIHdpdGggbnVsbCkuCiAgICAgICAgICovCiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvcHRpb25zLmRhdGEpID09PSAnW29iamVjdCBPYmplY3RdJykgewogICAgICAgICAgb3B0aW9ucy5ib2R5ID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5kYXRhKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb3B0aW9ucy5ib2R5ID0gb3B0aW9ucy5kYXRhOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiBvcHRpb25zOwogIH0KCiAgZnVuY3Rpb24gX2FqYXhPcHRpb25zKG9wdGlvbnMsIGFkYXB0ZXIpIHsKICAgIG9wdGlvbnMuZGF0YVR5cGUgPSAnanNvbic7CiAgICBvcHRpb25zLmNvbnRleHQgPSBhZGFwdGVyOwoKICAgIGlmIChvcHRpb25zLmRhdGEgJiYgb3B0aW9ucy50eXBlICE9PSAnR0VUJykgewogICAgICBvcHRpb25zLmRhdGEgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLmRhdGEpOwogICAgfQoKICAgIG9wdGlvbnMuYmVmb3JlU2VuZCA9IGZ1bmN0aW9uICh4aHIpIHsKICAgICAgT2JqZWN0LmtleXMob3B0aW9ucy5oZWFkZXJzKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICByZXR1cm4geGhyLnNldFJlcXVlc3RIZWFkZXIoa2V5LCBvcHRpb25zLmhlYWRlcnNba2V5XSk7CiAgICAgIH0pOwogICAgfTsKCiAgICByZXR1cm4gb3B0aW9uczsKICB9CgogIHZhciBfZGVmYXVsdCA9IFJFU1RBZGFwdGVyOwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CjtkZWZpbmUoIkBlbWJlci1kYXRhL2NhbmFyeS1mZWF0dXJlcy9kZWZhdWx0LWZlYXR1cmVzIiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL2NhbmFyeS1mZWF0dXJlcwogICovCgogIC8qCiAgICBUaGlzIGxpc3Qgb2YgZmVhdHVyZXMgaXMgdXNlZCBib3RoIGF0IGJ1aWxkIHRpbWUgKGJ5IGBAZW1iZXItZGF0YS9wcml2YXRlLWJ1aWxkLWluZnJhYCkKICAgIGFuZCBhdCBydW50aW1lIChieSBgQGVtYmVyLWRhdGEvY2FuYXJ5LWZlYXR1cmVzYCkuCiAgCiAgICBUaGUgdmFsaWQgdmFsdWVzIGFyZToKICAKICAgIC0gdHJ1ZSAtIFRoZSBmZWF0dXJlIGlzIGVuYWJsZWQgYXQgYWxsIHRpbWVzLCBhbmQgY2Fubm90IGJlIGRpc2FibGVkLgogICAgLSBmYWxzZSAtIFRoZSBmZWF0dXJlIGlzIGRpc2FibGVkIGF0IGFsbCB0aW1lcywgYW5kIGNhbm5vdCBiZSBlbmFibGVkLgogICAgLSBudWxsIC0gVGhlIGZlYXR1cmUgaXMgZGlzYWJsZWQgYnkgZGVmYXVsdCwgYnV0IGNhbiBiZSBlbmFibGVkIGF0IHJ1bnRpbWUgdmlhIGBFbWJlckRhdGFFTlZgLgogICovCiAgdmFyIF9kZWZhdWx0ID0gewogICAgU0FNUExFX0ZFQVRVUkVfRkxBRzogbnVsbCwKICAgIFJFQ09SRF9EQVRBX0VSUk9SUzogbnVsbCwKICAgIFJFQ09SRF9EQVRBX1NUQVRFOiBudWxsLAogICAgSURFTlRJRklFUlM6IHRydWUsCiAgICBSRVFVRVNUX1NFUlZJQ0U6IG51bGwsCiAgICBDVVNUT01fTU9ERUxfQ0xBU1M6IG51bGwsCiAgICBGVUxMX0xJTktTX09OX1JFTEFUSU9OU0hJUFM6IG51bGwKICB9OwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CjtkZWZpbmUoIkBlbWJlci1kYXRhL2NhbmFyeS1mZWF0dXJlcy9pbmRleCIsIFsiZXhwb3J0cyIsICJAZW1iZXItZGF0YS9jYW5hcnktZmVhdHVyZXMvZGVmYXVsdC1mZWF0dXJlcyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9kZWZhdWx0RmVhdHVyZXMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLkZVTExfTElOS1NfT05fUkVMQVRJT05TSElQUyA9IF9leHBvcnRzLkNVU1RPTV9NT0RFTF9DTEFTUyA9IF9leHBvcnRzLklERU5USUZJRVJTID0gX2V4cG9ydHMuUkVRVUVTVF9TRVJWSUNFID0gX2V4cG9ydHMuUkVDT1JEX0RBVEFfU1RBVEUgPSBfZXhwb3J0cy5SRUNPUkRfREFUQV9FUlJPUlMgPSBfZXhwb3J0cy5TQU1QTEVfRkVBVFVSRV9GTEFHID0gX2V4cG9ydHMuRkVBVFVSRVMgPSB2b2lkIDA7CgogIGZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7IGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBTeW1ib2wuaXRlcmF0b3IgPT09ICJzeW1ib2wiKSB7IF90eXBlb2YgPSBmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyByZXR1cm4gdHlwZW9mIG9iajsgfTsgfSBlbHNlIHsgX3R5cGVvZiA9IGZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7IHJldHVybiBvYmogJiYgdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBvYmouY29uc3RydWN0b3IgPT09IFN5bWJvbCAmJiBvYmogIT09IFN5bWJvbC5wcm90b3R5cGUgPyAic3ltYm9sIiA6IHR5cGVvZiBvYmo7IH07IH0gcmV0dXJuIF90eXBlb2Yob2JqKTsgfQoKICB2YXIgRU5WID0gKHR5cGVvZiBFbWJlckRhdGFFTlYgPT09ICJ1bmRlZmluZWQiID8gInVuZGVmaW5lZCIgOiBfdHlwZW9mKEVtYmVyRGF0YUVOVikpID09PSAnb2JqZWN0JyAmJiBFbWJlckRhdGFFTlYgIT09IG51bGwgPyBFbWJlckRhdGFFTlYgOiB7fTsKCiAgZnVuY3Rpb24gZmVhdHVyZVZhbHVlKHZhbHVlKSB7CiAgICBpZiAoRU5WLkVOQUJMRV9PUFRJT05BTF9GRUFUVVJFUyAmJiB2YWx1ZSA9PT0gbnVsbCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICByZXR1cm4gdmFsdWU7CiAgfQoKICB2YXIgRkVBVFVSRVMgPSBFbWJlci5hc3NpZ24oe30sIF9kZWZhdWx0RmVhdHVyZXMuZGVmYXVsdCwgRU5WLkZFQVRVUkVTKTsKICBfZXhwb3J0cy5GRUFUVVJFUyA9IEZFQVRVUkVTOwogIHZhciBTQU1QTEVfRkVBVFVSRV9GTEFHID0gZmVhdHVyZVZhbHVlKEZFQVRVUkVTLlNBTVBMRV9GRUFUVVJFX0ZMQUcpOwogIF9leHBvcnRzLlNBTVBMRV9GRUFUVVJFX0ZMQUcgPSBTQU1QTEVfRkVBVFVSRV9GTEFHOwogIHZhciBSRUNPUkRfREFUQV9FUlJPUlMgPSBmZWF0dXJlVmFsdWUoRkVBVFVSRVMuUkVDT1JEX0RBVEFfRVJST1JTKTsKICBfZXhwb3J0cy5SRUNPUkRfREFUQV9FUlJPUlMgPSBSRUNPUkRfREFUQV9FUlJPUlM7CiAgdmFyIFJFQ09SRF9EQVRBX1NUQVRFID0gZmVhdHVyZVZhbHVlKEZFQVRVUkVTLlJFQ09SRF9EQVRBX1NUQVRFKTsKICBfZXhwb3J0cy5SRUNPUkRfREFUQV9TVEFURSA9IFJFQ09SRF9EQVRBX1NUQVRFOwogIHZhciBSRVFVRVNUX1NFUlZJQ0UgPSBmZWF0dXJlVmFsdWUoRkVBVFVSRVMuUkVRVUVTVF9TRVJWSUNFKTsKICBfZXhwb3J0cy5SRVFVRVNUX1NFUlZJQ0UgPSBSRVFVRVNUX1NFUlZJQ0U7CiAgdmFyIElERU5USUZJRVJTID0gZmVhdHVyZVZhbHVlKEZFQVRVUkVTLklERU5USUZJRVJTKTsKICBfZXhwb3J0cy5JREVOVElGSUVSUyA9IElERU5USUZJRVJTOwogIHZhciBDVVNUT01fTU9ERUxfQ0xBU1MgPSBmZWF0dXJlVmFsdWUoRkVBVFVSRVMuQ1VTVE9NX01PREVMX0NMQVNTKTsKICBfZXhwb3J0cy5DVVNUT01fTU9ERUxfQ0xBU1MgPSBDVVNUT01fTU9ERUxfQ0xBU1M7CiAgdmFyIEZVTExfTElOS1NfT05fUkVMQVRJT05TSElQUyA9IGZlYXR1cmVWYWx1ZShGRUFUVVJFUy5GVUxMX0xJTktTX09OX1JFTEFUSU9OU0hJUFMpOwogIF9leHBvcnRzLkZVTExfTElOS1NfT05fUkVMQVRJT05TSElQUyA9IEZVTExfTElOS1NfT05fUkVMQVRJT05TSElQUzsKfSk7CjtkZWZpbmUoIkBlbWJlci1kYXRhL2RlYnVnL2luZGV4IiwgWyJleHBvcnRzIiwgIkBlbWJlci1kYXRhL2RlYnVnL3NldHVwIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX3NldHVwKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICAgIEltcGxlbWVudHMgYEBlbWJlci9kZWJ1Zy9kYXRhLWFkYXB0ZXJgIHdpdGggZm9yIEVtYmVyRGF0YQogICAgaW50ZWdyYXRpb24gd2l0aCB0aGUgZW1iZXItaW5zcGVjdG9yLgogIAogICAgQGNsYXNzIEluc3BlY3RvckRlYnVnQWRhcHRlcgogICAgQGV4dGVuZHMgRGF0YUFkYXB0ZXIKICAgIEBwcml2YXRlCiAgKi8KICB2YXIgX2RlZmF1bHQgPSBFbWJlci5EYXRhQWRhcHRlci5leHRlbmQoewogICAgc3RvcmU6IEVtYmVyLmluamVjdC5zZXJ2aWNlKCdzdG9yZScpLAoKICAgIC8qKgogICAgICBTcGVjaWZpZXMgaG93IHJlY29yZHMgY2FuIGJlIGZpbHRlcmVkIGJhc2VkIG9uIHRoZSBzdGF0ZSBvZiB0aGUgcmVjb3JkCiAgICAgIFJlY29yZHMgcmV0dXJuZWQgd2lsbCBuZWVkIHRvIGhhdmUgYSBgZmlsdGVyVmFsdWVzYAogICAgICBwcm9wZXJ0eSB3aXRoIGEga2V5IGZvciBldmVyeSBuYW1lIGluIHRoZSByZXR1cm5lZCBhcnJheQogICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIGdldEZpbHRlcnMKICAgICAgQHJldHVybiB7QXJyYXl9IExpc3Qgb2Ygb2JqZWN0cyBkZWZpbmluZyBmaWx0ZXJzCiAgICAgICBUaGUgb2JqZWN0IHNob3VsZCBoYXZlIGEgYG5hbWVgIGFuZCBgZGVzY2AgcHJvcGVydHkKICAgICovCiAgICBnZXRGaWx0ZXJzOiBmdW5jdGlvbiBnZXRGaWx0ZXJzKCkgewogICAgICByZXR1cm4gW3sKICAgICAgICBuYW1lOiAnaXNOZXcnLAogICAgICAgIGRlc2M6ICdOZXcnCiAgICAgIH0sIHsKICAgICAgICBuYW1lOiAnaXNNb2RpZmllZCcsCiAgICAgICAgZGVzYzogJ01vZGlmaWVkJwogICAgICB9LCB7CiAgICAgICAgbmFtZTogJ2lzQ2xlYW4nLAogICAgICAgIGRlc2M6ICdDbGVhbicKICAgICAgfV07CiAgICB9LAogICAgX25hbWVUb0NsYXNzOiBmdW5jdGlvbiBfbmFtZVRvQ2xhc3ModHlwZSkgewogICAgICByZXR1cm4gRW1iZXIuZ2V0KHRoaXMsICdzdG9yZScpLm1vZGVsRm9yKHR5cGUpOwogICAgfSwKCiAgICAvKioKICAgICAgRmV0Y2ggdGhlIG1vZGVsIHR5cGVzIGFuZCBvYnNlcnZlIHRoZW0gZm9yIGNoYW5nZXMuCiAgICAgIE1haW50YWlucyB0aGUgbGlzdCBvZiBtb2RlbCB0eXBlcyB3aXRob3V0IG5lZWRpbmcgdGhlIE1vZGVsIHBhY2thZ2UgZm9yIGRldGVjdGlvbi4KICAgICAgQHB1YmxpYwogICAgICBAbWV0aG9kIHdhdGNoTW9kZWxUeXBlcwogICAgICBAcGFyYW0ge0Z1bmN0aW9ufSB0eXBlc0FkZGVkIENhbGxiYWNrIHRvIGNhbGwgdG8gYWRkIHR5cGVzLgogICAgICBUYWtlcyBhbiBhcnJheSBvZiBvYmplY3RzIGNvbnRhaW5pbmcgd3JhcHBlZCB0eXBlcyAocmV0dXJuZWQgZnJvbSBgd3JhcE1vZGVsVHlwZWApLgogICAgICBAcGFyYW0ge0Z1bmN0aW9ufSB0eXBlc1VwZGF0ZWQgQ2FsbGJhY2sgdG8gY2FsbCB3aGVuIGEgdHlwZSBoYXMgY2hhbmdlZC4KICAgICAgVGFrZXMgYW4gYXJyYXkgb2Ygb2JqZWN0cyBjb250YWluaW5nIHdyYXBwZWQgdHlwZXMuCiAgICAgIEByZXR1cm4ge0Z1bmN0aW9ufSBNZXRob2QgdG8gY2FsbCB0byByZW1vdmUgYWxsIG9ic2VydmVycwogICAgKi8KICAgIHdhdGNoTW9kZWxUeXBlczogZnVuY3Rpb24gd2F0Y2hNb2RlbFR5cGVzKHR5cGVzQWRkZWQsIHR5cGVzVXBkYXRlZCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIHN0b3JlID0gRW1iZXIuZ2V0KHRoaXMsICdzdG9yZScpOwogICAgICB2YXIgX19jcmVhdGVSZWNvcmREYXRhID0gc3RvcmUuX2NyZWF0ZVJlY29yZERhdGE7CiAgICAgIHZhciBfcmVsZWFzZU1ldGhvZHMgPSBbXTsKICAgICAgdmFyIGRpc2NvdmVyZWRUeXBlcyA9ICgwLCBfc2V0dXAudHlwZXNNYXBGb3IpKHN0b3JlKTsgLy8gQWRkIGFueSBtb2RlbHMgdGhhdCB3ZXJlIGFkZGVkIGR1cmluZyBpbml0aWFsaXphdGlvbiBvZiB0aGUgYXBwLCBiZWZvcmUgdGhlIGluc3BlY3RvciB3YXMgb3BlbmVkCgogICAgICBkaXNjb3ZlcmVkVHlwZXMuZm9yRWFjaChmdW5jdGlvbiAoXywgdHlwZSkgewogICAgICAgIF90aGlzLndhdGNoVHlwZUlmVW5zZWVuKHN0b3JlLCBkaXNjb3ZlcmVkVHlwZXMsIHR5cGUsIHR5cGVzQWRkZWQsIHR5cGVzVXBkYXRlZCwgX3JlbGVhc2VNZXRob2RzKTsKICAgICAgfSk7IC8vIE92ZXJ3cml0ZSBfY3JlYXRlUmVjb3JkRGF0YSBzbyBuZXdseSBhZGRlZCBtb2RlbHMgd2lsbCBnZXQgYWRkZWQgdG8gdGhlIGxpc3QKCiAgICAgIHN0b3JlLl9jcmVhdGVSZWNvcmREYXRhID0gZnVuY3Rpb24gKGlkZW50aWZpZXIpIHsKICAgICAgICBfdGhpcy53YXRjaFR5cGVJZlVuc2VlbihzdG9yZSwgZGlzY292ZXJlZFR5cGVzLCBpZGVudGlmaWVyLnR5cGUsIHR5cGVzQWRkZWQsIHR5cGVzVXBkYXRlZCwgX3JlbGVhc2VNZXRob2RzKTsKCiAgICAgICAgcmV0dXJuIF9fY3JlYXRlUmVjb3JkRGF0YS5jYWxsKHN0b3JlLCBpZGVudGlmaWVyKTsKICAgICAgfTsKCiAgICAgIHZhciByZWxlYXNlID0gZnVuY3Rpb24gcmVsZWFzZSgpIHsKICAgICAgICBfcmVsZWFzZU1ldGhvZHMuZm9yRWFjaChmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgIHJldHVybiBmbigpOwogICAgICAgIH0pOwoKICAgICAgICBzdG9yZS5fY3JlYXRlUmVjb3JkRGF0YSA9IF9fY3JlYXRlUmVjb3JkRGF0YTsgLy8gcmVzZXQgdGhlIGxpc3Qgc28gdGhlIG1vZGVscyBjYW4gYmUgYWRkZWQgaWYgdGhlIGluc3BlY3RvciBpcyByZS1vcGVuZWQKICAgICAgICAvLyB0aGUgZW50cmllcyBhcmUgc2V0IHRvIGZhbHNlIGluc3RlYWQgb2YgcmVtb3ZlZCwgc2luY2UgdGhlIG1vZGVscyBzdGlsbCBleGlzdCBpbiB0aGUgYXBwCiAgICAgICAgLy8gd2UganVzdCBuZWVkIHRoZSBpbnNwZWN0b3IgdG8gYmVjb21lIGF3YXJlIG9mIHRoZW0KCiAgICAgICAgZGlzY292ZXJlZFR5cGVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgIGRpc2NvdmVyZWRUeXBlcy5zZXQoa2V5LCBmYWxzZSk7CiAgICAgICAgfSk7CgogICAgICAgIF90aGlzLnJlbGVhc2VNZXRob2RzLnJlbW92ZU9iamVjdChyZWxlYXNlKTsKICAgICAgfTsKCiAgICAgIHRoaXMucmVsZWFzZU1ldGhvZHMucHVzaE9iamVjdChyZWxlYXNlKTsKICAgICAgcmV0dXJuIHJlbGVhc2U7CiAgICB9LAoKICAgIC8qKgogICAgICogTG9vcCBvdmVyIHRoZSBkaXNjb3ZlcmVkIHR5cGVzIGFuZCB1c2UgdGhlIGNhbGxiYWNrcyBmcm9tIHdhdGNoTW9kZWxUeXBlcyB0byBub3RpZnkKICAgICAqIHRoZSBjb25zdW1lciBvZiB0aGlzIGFkYXB0ZXIgYWJvdXQgdGhlIG1kb2Vscy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0b3JlfSBzdG9yZQogICAgICogQHBhcmFtIHtNYXB9IGRpc2NvdmVyZWRUeXBlcwogICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHR5cGVzQWRkZWQKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHR5cGVzVXBkYXRlZAogICAgICogQHBhcmFtIHtBcnJheX0gcmVsZWFzZU1ldGhvZHMKICAgICAqLwogICAgd2F0Y2hUeXBlSWZVbnNlZW46IGZ1bmN0aW9uIHdhdGNoVHlwZUlmVW5zZWVuKHN0b3JlLCBkaXNjb3ZlcmVkVHlwZXMsIHR5cGUsIHR5cGVzQWRkZWQsIHR5cGVzVXBkYXRlZCwgcmVsZWFzZU1ldGhvZHMpIHsKICAgICAgaWYgKGRpc2NvdmVyZWRUeXBlcy5nZXQodHlwZSkgIT09IHRydWUpIHsKICAgICAgICB2YXIga2xhc3MgPSBzdG9yZS5tb2RlbEZvcih0eXBlKTsKICAgICAgICB2YXIgd3JhcHBlZCA9IHRoaXMud3JhcE1vZGVsVHlwZShrbGFzcywgdHlwZSk7CiAgICAgICAgcmVsZWFzZU1ldGhvZHMucHVzaCh0aGlzLm9ic2VydmVNb2RlbFR5cGUodHlwZSwgdHlwZXNVcGRhdGVkKSk7CiAgICAgICAgdHlwZXNBZGRlZChbd3JhcHBlZF0pOwogICAgICAgIGRpc2NvdmVyZWRUeXBlcy5zZXQodHlwZSwgdHJ1ZSk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgIENyZWF0ZXMgYSBodW1hbiByZWFkYWJsZSBzdHJpbmcgdXNlZCBmb3IgY29sdW1uIGhlYWRlcnMKICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBjb2x1bW5OYW1lVG9EZXNjCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBhdHRyaWJ1dGUgbmFtZQogICAgICBAcmV0dXJuIHtTdHJpbmd9IEh1bWFuIHJlYWRhYmxlIHN0cmluZyBiYXNlZCBvbiB0aGUgYXR0cmlidXRlIG5hbWUKICAgICovCiAgICBjb2x1bW5OYW1lVG9EZXNjOiBmdW5jdGlvbiBjb2x1bW5OYW1lVG9EZXNjKG5hbWUpIHsKICAgICAgcmV0dXJuIEVtYmVyLlN0cmluZy5jYXBpdGFsaXplKEVtYmVyLlN0cmluZy51bmRlcnNjb3JlKG5hbWUpLnJlcGxhY2UoL18vZywgJyAnKS50cmltKCkpOwogICAgfSwKCiAgICAvKioKICAgICAgR2V0IHRoZSBjb2x1bW5zIGZvciBhIGdpdmVuIG1vZGVsIHR5cGUKICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBjb2x1bW5zRm9yVHlwZQogICAgICBAcGFyYW0ge01vZGVsfSB0eXBlQ2xhc3MKICAgICAgQHJldHVybiB7QXJyYXl9IEFuIGFycmF5IG9mIGNvbHVtbnMgb2YgdGhlIGZvbGxvd2luZyBmb3JtYXQ6CiAgICAgICBuYW1lOiB7U3RyaW5nfSBUaGUgbmFtZSBvZiB0aGUgY29sdW1uCiAgICAgICBkZXNjOiB7U3RyaW5nfSBIdW1hbml6ZWQgZGVzY3JpcHRpb24gKHdoYXQgd291bGQgc2hvdyBpbiBhIHRhYmxlIGNvbHVtbiBuYW1lKQogICAgKi8KICAgIGNvbHVtbnNGb3JUeXBlOiBmdW5jdGlvbiBjb2x1bW5zRm9yVHlwZSh0eXBlQ2xhc3MpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB2YXIgY29sdW1ucyA9IFt7CiAgICAgICAgbmFtZTogJ2lkJywKICAgICAgICBkZXNjOiAnSWQnCiAgICAgIH1dOwogICAgICB2YXIgY291bnQgPSAwOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIEVtYmVyLmdldCh0eXBlQ2xhc3MsICdhdHRyaWJ1dGVzJykuZm9yRWFjaChmdW5jdGlvbiAobWV0YSwgbmFtZSkgewogICAgICAgIGlmIChjb3VudCsrID4gc2VsZi5hdHRyaWJ1dGVMaW1pdCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdmFyIGRlc2MgPSBfdGhpczIuY29sdW1uTmFtZVRvRGVzYyhuYW1lKTsKCiAgICAgICAgY29sdW1ucy5wdXNoKHsKICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICBkZXNjOiBkZXNjCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gY29sdW1uczsKICAgIH0sCgogICAgLyoqCiAgICAgIEZldGNoZXMgYWxsIGxvYWRlZCByZWNvcmRzIGZvciBhIGdpdmVuIHR5cGUKICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBnZXRSZWNvcmRzCiAgICAgIEBwYXJhbSB7TW9kZWx9IG1vZGVsQ2xhc3Mgb2YgdGhlIHJlY29yZAogICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lIG9mIHRoZSByZWNvcmQKICAgICAgQHJldHVybiB7QXJyYXl9IEFuIGFycmF5IG9mIE1vZGVsIHJlY29yZHMKICAgICAgIFRoaXMgYXJyYXkgd2lsbCBiZSBvYnNlcnZlZCBmb3IgY2hhbmdlcywKICAgICAgIHNvIGl0IHNob3VsZCB1cGRhdGUgd2hlbiBuZXcgcmVjb3JkcyBhcmUgYWRkZWQvcmVtb3ZlZAogICAgKi8KICAgIGdldFJlY29yZHM6IGZ1bmN0aW9uIGdldFJlY29yZHMobW9kZWxDbGFzcywgbW9kZWxOYW1lKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMikgewogICAgICAgIC8vIExlZ2FjeSBFbWJlci5qcyA8IDEuMTMgc3VwcG9ydAogICAgICAgIHZhciBjb250YWluZXJLZXkgPSBtb2RlbENsYXNzLl9kZWJ1Z0NvbnRhaW5lcktleTsKCiAgICAgICAgaWYgKGNvbnRhaW5lcktleSkgewogICAgICAgICAgdmFyIG1hdGNoID0gY29udGFpbmVyS2V5Lm1hdGNoKC9tb2RlbDooLiopLyk7CgogICAgICAgICAgaWYgKG1hdGNoICE9PSBudWxsKSB7CiAgICAgICAgICAgIG1vZGVsTmFtZSA9IG1hdGNoWzFdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgKGZhbHNlICYmICEoISFtb2RlbE5hbWUpICYmIEVtYmVyLmFzc2VydCgnQ2Fubm90IGZpbmQgbW9kZWwgbmFtZS4gUGxlYXNlIHVwZ3JhZGUgdG8gRW1iZXIuanMgPj0gMS4xMyBmb3IgRW1iZXIgSW5zcGVjdG9yIHN1cHBvcnQnLCAhIW1vZGVsTmFtZSkpOwogICAgICByZXR1cm4gdGhpcy5nZXQoJ3N0b3JlJykucGVla0FsbChtb2RlbE5hbWUpOwogICAgfSwKCiAgICAvKioKICAgICAgR2V0cyB0aGUgdmFsdWVzIGZvciBlYWNoIGNvbHVtbgogICAgICBUaGlzIGlzIHRoZSBhdHRyaWJ1dGUgdmFsdWVzIGZvciBhIGdpdmVuIHJlY29yZAogICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIGdldFJlY29yZENvbHVtblZhbHVlcwogICAgICBAcGFyYW0ge01vZGVsfSByZWNvcmQgdG8gZ2V0IHZhbHVlcyBmcm9tCiAgICAgIEByZXR1cm4ge09iamVjdH0gS2V5cyBzaG91bGQgbWF0Y2ggY29sdW1uIG5hbWVzIGRlZmluZWQgYnkgdGhlIG1vZGVsIHR5cGUKICAgICovCiAgICBnZXRSZWNvcmRDb2x1bW5WYWx1ZXM6IGZ1bmN0aW9uIGdldFJlY29yZENvbHVtblZhbHVlcyhyZWNvcmQpIHsKICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICB2YXIgY291bnQgPSAwOwogICAgICB2YXIgY29sdW1uVmFsdWVzID0gewogICAgICAgIGlkOiBFbWJlci5nZXQocmVjb3JkLCAnaWQnKQogICAgICB9OwogICAgICByZWNvcmQuZWFjaEF0dHJpYnV0ZShmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgaWYgKGNvdW50KysgPiBfdGhpczMuYXR0cmlidXRlTGltaXQpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGNvbHVtblZhbHVlc1trZXldID0gRW1iZXIuZ2V0KHJlY29yZCwga2V5KTsKICAgICAgfSk7CiAgICAgIHJldHVybiBjb2x1bW5WYWx1ZXM7CiAgICB9LAoKICAgIC8qKgogICAgICBSZXR1cm5zIGtleXdvcmRzIHRvIG1hdGNoIHdoZW4gc2VhcmNoaW5nIHJlY29yZHMKICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBnZXRSZWNvcmRLZXl3b3JkcwogICAgICBAcGFyYW0ge01vZGVsfSByZWNvcmQKICAgICAgQHJldHVybiB7QXJyYXl9IFJlbGV2YW50IGtleXdvcmRzIGZvciBzZWFyY2ggYmFzZWQgb24gdGhlIHJlY29yZCdzIGF0dHJpYnV0ZSB2YWx1ZXMKICAgICovCiAgICBnZXRSZWNvcmRLZXl3b3JkczogZnVuY3Rpb24gZ2V0UmVjb3JkS2V5d29yZHMocmVjb3JkKSB7CiAgICAgIHZhciBrZXl3b3JkcyA9IFtdOwogICAgICB2YXIga2V5cyA9IEVtYmVyLkEoWydpZCddKTsKICAgICAgcmVjb3JkLmVhY2hBdHRyaWJ1dGUoZnVuY3Rpb24gKGtleSkgewogICAgICAgIHJldHVybiBrZXlzLnB1c2goa2V5KTsKICAgICAgfSk7CiAgICAgIGtleXMuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgcmV0dXJuIGtleXdvcmRzLnB1c2goRW1iZXIuZ2V0KHJlY29yZCwga2V5KSk7CiAgICAgIH0pOwogICAgICByZXR1cm4ga2V5d29yZHM7CiAgICB9LAoKICAgIC8qKgogICAgICBSZXR1cm5zIHRoZSB2YWx1ZXMgb2YgZmlsdGVycyBkZWZpbmVkIGJ5IGBnZXRGaWx0ZXJzYAogICAgICBUaGVzZSByZWZsZWN0IHRoZSBzdGF0ZSBvZiB0aGUgcmVjb3JkCiAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgZ2V0UmVjb3JkRmlsdGVyVmFsdWVzCiAgICAgIEBwYXJhbSB7TW9kZWx9IHJlY29yZAogICAgICBAcmV0dXJuIHtPYmplY3R9IFRoZSByZWNvcmQgc3RhdGUgZmlsdGVyIHZhbHVlcwogICAgKi8KICAgIGdldFJlY29yZEZpbHRlclZhbHVlczogZnVuY3Rpb24gZ2V0UmVjb3JkRmlsdGVyVmFsdWVzKHJlY29yZCkgewogICAgICByZXR1cm4gewogICAgICAgIGlzTmV3OiByZWNvcmQuZ2V0KCdpc05ldycpLAogICAgICAgIGlzTW9kaWZpZWQ6IHJlY29yZC5nZXQoJ2hhc0RpcnR5QXR0cmlidXRlcycpICYmICFyZWNvcmQuZ2V0KCdpc05ldycpLAogICAgICAgIGlzQ2xlYW46ICFyZWNvcmQuZ2V0KCdoYXNEaXJ0eUF0dHJpYnV0ZXMnKQogICAgICB9OwogICAgfSwKCiAgICAvKioKICAgICAgUmV0dXJucyBhIGNvbG9yIHRoYXQgcmVwcmVzZW50cyB0aGUgcmVjb3JkJ3Mgc3RhdGUKICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBnZXRSZWNvcmRDb2xvcgogICAgICBAcGFyYW0ge01vZGVsfSByZWNvcmQKICAgICAgQHJldHVybiB7U3RyaW5nfSBUaGUgcmVjb3JkIGNvbG9yCiAgICAgICAgUG9zc2libGUgb3B0aW9uczogYmxhY2ssIGJsdWUsIGdyZWVuCiAgICAqLwogICAgZ2V0UmVjb3JkQ29sb3I6IGZ1bmN0aW9uIGdldFJlY29yZENvbG9yKHJlY29yZCkgewogICAgICB2YXIgY29sb3IgPSAnYmxhY2snOwoKICAgICAgaWYgKHJlY29yZC5nZXQoJ2lzTmV3JykpIHsKICAgICAgICBjb2xvciA9ICdncmVlbic7CiAgICAgIH0gZWxzZSBpZiAocmVjb3JkLmdldCgnaGFzRGlydHlBdHRyaWJ1dGVzJykpIHsKICAgICAgICBjb2xvciA9ICdibHVlJzsKICAgICAgfQoKICAgICAgcmV0dXJuIGNvbG9yOwogICAgfSwKCiAgICAvKioKICAgICAgT2JzZXJ2ZXMgYWxsIHJlbGV2YW50IHByb3BlcnRpZXMgYW5kIHJlLXNlbmRzIHRoZSB3cmFwcGVkIHJlY29yZAogICAgICB3aGVuIGEgY2hhbmdlIG9jY3VycwogICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIG9ic2VydmVyUmVjb3JkCiAgICAgIEBwYXJhbSB7TW9kZWx9IHJlY29yZAogICAgICBAcGFyYW0ge0Z1bmN0aW9ufSByZWNvcmRVcGRhdGVkIENhbGxiYWNrIHVzZWQgdG8gbm90aWZ5IGNoYW5nZXMKICAgICAgQHJldHVybiB7RnVuY3Rpb259IFRoZSBmdW5jdGlvbiB0byBjYWxsIHRvIHJlbW92ZSBhbGwgb2JzZXJ2ZXJzCiAgICAqLwogICAgb2JzZXJ2ZVJlY29yZDogZnVuY3Rpb24gb2JzZXJ2ZVJlY29yZChyZWNvcmQsIHJlY29yZFVwZGF0ZWQpIHsKICAgICAgdmFyIHJlbGVhc2VNZXRob2RzID0gRW1iZXIuQSgpOwogICAgICB2YXIga2V5c1RvT2JzZXJ2ZSA9IEVtYmVyLkEoWydpZCcsICdpc05ldycsICdoYXNEaXJ0eUF0dHJpYnV0ZXMnXSk7CiAgICAgIHJlY29yZC5lYWNoQXR0cmlidXRlKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICByZXR1cm4ga2V5c1RvT2JzZXJ2ZS5wdXNoKGtleSk7CiAgICAgIH0pOwogICAgICB2YXIgYWRhcHRlciA9IHRoaXM7CiAgICAgIGtleXNUb09ic2VydmUuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgdmFyIGhhbmRsZXIgPSBmdW5jdGlvbiBoYW5kbGVyKCkgewogICAgICAgICAgcmVjb3JkVXBkYXRlZChhZGFwdGVyLndyYXBSZWNvcmQocmVjb3JkKSk7CiAgICAgICAgfTsKCiAgICAgICAgRW1iZXIuYWRkT2JzZXJ2ZXIocmVjb3JkLCBrZXksIGhhbmRsZXIpOwogICAgICAgIHJlbGVhc2VNZXRob2RzLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgRW1iZXIucmVtb3ZlT2JzZXJ2ZXIocmVjb3JkLCBrZXksIGhhbmRsZXIpOwogICAgICAgIH0pOwogICAgICB9KTsKCiAgICAgIHZhciByZWxlYXNlID0gZnVuY3Rpb24gcmVsZWFzZSgpIHsKICAgICAgICByZWxlYXNlTWV0aG9kcy5mb3JFYWNoKGZ1bmN0aW9uIChmbikgewogICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgfSk7CiAgICAgIH07CgogICAgICByZXR1cm4gcmVsZWFzZTsKICAgIH0KICB9KTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKO2RlZmluZSgiQGVtYmVyLWRhdGEvZGVidWcvc2V0dXAiLCBbImV4cG9ydHMiLCAiQGVtYmVyLWRhdGEvc3RvcmUiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfc3RvcmUpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLnR5cGVzTWFwRm9yID0gdHlwZXNNYXBGb3I7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKICB2YXIgU3RvcmVUeXBlc01hcCA9IG5ldyBXZWFrTWFwKCk7CgogIGZ1bmN0aW9uIHR5cGVzTWFwRm9yKHN0b3JlKSB7CiAgICB2YXIgdHlwZXNNYXAgPSBTdG9yZVR5cGVzTWFwLmdldChzdG9yZSk7CgogICAgaWYgKHR5cGVzTWFwID09PSB1bmRlZmluZWQpIHsKICAgICAgdHlwZXNNYXAgPSBuZXcgTWFwKCk7CiAgICAgIFN0b3JlVHlwZXNNYXAuc2V0KHN0b3JlLCB0eXBlc01hcCk7CiAgICB9CgogICAgcmV0dXJuIHR5cGVzTWFwOwogIH0gLy8gb3ZlcnJpZGUgX2NyZWF0ZVJlY29yZERhdGEgdG8gYWRkIHRoZSBrbm93biBtb2RlbHMgdG8gdGhlIHR5cGVzTWFwCgoKICB2YXIgX19jcmVhdGVSZWNvcmREYXRhID0gX3N0b3JlLmRlZmF1bHQucHJvdG90eXBlLl9jcmVhdGVSZWNvcmREYXRhOwoKICBfc3RvcmUuZGVmYXVsdC5wcm90b3R5cGUuX2NyZWF0ZVJlY29yZERhdGEgPSBmdW5jdGlvbiAoaWRlbnRpZmllcikgewogICAgdmFyIHR5cGVzTWFwID0gdHlwZXNNYXBGb3IodGhpcyk7CgogICAgaWYgKCF0eXBlc01hcC5oYXMoaWRlbnRpZmllci50eXBlKSkgewogICAgICB0eXBlc01hcC5zZXQoaWRlbnRpZmllci50eXBlLCBmYWxzZSk7CiAgICB9CgogICAgcmV0dXJuIF9fY3JlYXRlUmVjb3JkRGF0YS5jYWxsKHRoaXMsIGlkZW50aWZpZXIpOwogIH07CgogIHZhciBfZGVmYXVsdCA9IHsKICAgIG5hbWU6ICdAZW1iZXItZGF0YS9kYXRhLWFkYXB0ZXInLAogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gaW5pdGlhbGl6ZSgpIHt9CiAgfTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwo7ZGVmaW5lKCdAZW1iZXItZGF0YS9tb2RlbC8tcHJpdmF0ZScsIFsnZXhwb3J0cycsICdAZW1iZXItZGF0YS9zdG9yZS8tcHJpdmF0ZScsICdAZW1iZXItZGF0YS9jYW5hcnktZmVhdHVyZXMnLCAnQGVtYmVyLWRhdGEvc3RvcmUnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIFByaXZhdGUsIGNhbmFyeUZlYXR1cmVzLCBzdG9yZSkgeyAndXNlIHN0cmljdCc7CgogIGZ1bmN0aW9uIGlzRWxlbWVudERlc2NyaXB0b3IoYXJncykgewogICAgdmFyIG1heWJlVGFyZ2V0ID0gYXJnc1swXSwKICAgICAgICBtYXliZUtleSA9IGFyZ3NbMV0sCiAgICAgICAgbWF5YmVEZXNjID0gYXJnc1syXTsKICAgIHJldHVybiAoLy8gRW5zdXJlIHdlIGhhdmUgdGhlIHJpZ2h0IG51bWJlciBvZiBhcmdzCiAgICAgIGFyZ3MubGVuZ3RoID09PSAzICYmICggLy8gTWFrZSBzdXJlIHRoZSB0YXJnZXQgaXMgYSBjbGFzcyBvciBvYmplY3QgKHByb3RvdHlwZSkKICAgICAgdHlwZW9mIG1heWJlVGFyZ2V0ID09PSAnZnVuY3Rpb24nIHx8IHR5cGVvZiBtYXliZVRhcmdldCA9PT0gJ29iamVjdCcgJiYgbWF5YmVUYXJnZXQgIT09IG51bGwpICYmIC8vIE1ha2Ugc3VyZSB0aGUga2V5IGlzIGEgc3RyaW5nCiAgICAgIHR5cGVvZiBtYXliZUtleSA9PT0gJ3N0cmluZycgJiYgKCAvLyBNYWtlIHN1cmUgdGhlIGRlc2NyaXB0b3IgaXMgdGhlIHJpZ2h0IHNoYXBlCiAgICAgIHR5cGVvZiBtYXliZURlc2MgPT09ICdvYmplY3QnICYmIG1heWJlRGVzYyAhPT0gbnVsbCAmJiAnZW51bWVyYWJsZScgaW4gbWF5YmVEZXNjICYmICdjb25maWd1cmFibGUnIGluIG1heWJlRGVzYyB8fCAvLyBUUyBjb21wYXRpYmlsaXR5CiAgICAgIG1heWJlRGVzYyA9PT0gdW5kZWZpbmVkKQogICAgKTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZWRNYWNyb1dpdGhPcHRpb25hbFBhcmFtcyhmbikgewogICAgewogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBtYXliZURlc2MgPSBuZXcgQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgICBtYXliZURlc2NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaXNFbGVtZW50RGVzY3JpcHRvcihtYXliZURlc2MpID8gZm4oKS5hcHBseSh2b2lkIDAsIG1heWJlRGVzYykgOiBmbi5hcHBseSh2b2lkIDAsIG1heWJlRGVzYyk7CiAgICAgIH07CiAgICB9CiAgfQoKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyLWRhdGEvbW9kZWwKICAqLwoKICBmdW5jdGlvbiBnZXREZWZhdWx0VmFsdWUocmVjb3JkLCBvcHRpb25zLCBrZXkpIHsKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5kZWZhdWx0VmFsdWUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgcmV0dXJuIG9wdGlvbnMuZGVmYXVsdFZhbHVlLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICB9IGVsc2UgewogICAgICB2YXIgZGVmYXVsdFZhbHVlID0gb3B0aW9ucy5kZWZhdWx0VmFsdWU7CiAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBoYXNWYWx1ZShpbnRlcm5hbE1vZGVsLCBrZXkpIHsKICAgIHJldHVybiBQcml2YXRlLnJlY29yZERhdGFGb3IoaW50ZXJuYWxNb2RlbCkuaGFzQXR0cihrZXkpOwogIH0KICAvKioKICAgIGBhdHRyYCBkZWZpbmVzIGFuIGF0dHJpYnV0ZSBvbiBhIFtNb2RlbF0oL2VtYmVyLWRhdGEvcmVsZWFzZS9jbGFzc2VzL01vZGVsKS4KICAgIEJ5IGRlZmF1bHQsIGF0dHJpYnV0ZXMgYXJlIHBhc3NlZCB0aHJvdWdoIGFzLWlzLCBob3dldmVyIHlvdSBjYW4gc3BlY2lmeSBhbgogICAgb3B0aW9uYWwgdHlwZSB0byBoYXZlIHRoZSB2YWx1ZSBhdXRvbWF0aWNhbGx5IHRyYW5zZm9ybWVkLgogICAgRW1iZXIgRGF0YSBzaGlwcyB3aXRoIGZvdXIgYmFzaWMgdHJhbnNmb3JtIHR5cGVzOiBgc3RyaW5nYCwgYG51bWJlcmAsCiAgICBgYm9vbGVhbmAgYW5kIGBkYXRlYC4gWW91IGNhbiBkZWZpbmUgeW91ciBvd24gdHJhbnNmb3JtcyBieSBzdWJjbGFzc2luZwogICAgW1RyYW5zZm9ybV0oL2VtYmVyLWRhdGEvcmVsZWFzZS9jbGFzc2VzL1RyYW5zZm9ybSkuCgogICAgTm90ZSB0aGF0IHlvdSBjYW5ub3QgdXNlIGBhdHRyYCB0byBkZWZpbmUgYW4gYXR0cmlidXRlIG9mIGBpZGAuCgogICAgYGF0dHJgIHRha2VzIGFuIG9wdGlvbmFsIGhhc2ggYXMgYSBzZWNvbmQgcGFyYW1ldGVyLCBjdXJyZW50bHkKICAgIHN1cHBvcnRlZCBvcHRpb25zIGFyZToKCiAgICAtIGBkZWZhdWx0VmFsdWVgOiBQYXNzIGEgc3RyaW5nIG9yIGEgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHRvIHNldCB0aGUgYXR0cmlidXRlCiAgICB0byBhIGRlZmF1bHQgdmFsdWUgaWYgbm9uZSBpcyBzdXBwbGllZC4KCiAgICBFeGFtcGxlCgogICAgYGBgYXBwL21vZGVscy91c2VyLmpzCiAgICBpbXBvcnQgTW9kZWwsIHsgYXR0ciB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKCiAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICB1c2VybmFtZTogYXR0cignc3RyaW5nJyksCiAgICAgIGVtYWlsOiBhdHRyKCdzdHJpbmcnKSwKICAgICAgdmVyaWZpZWQ6IGF0dHIoJ2Jvb2xlYW4nLCB7IGRlZmF1bHRWYWx1ZTogZmFsc2UgfSkKICAgIH0pOwogICAgYGBgCgogICAgRGVmYXVsdCB2YWx1ZSBjYW4gYWxzbyBiZSBhIGZ1bmN0aW9uLiBUaGlzIGlzIHVzZWZ1bCBpdCB5b3Ugd2FudCB0byByZXR1cm4KICAgIGEgbmV3IG9iamVjdCBmb3IgZWFjaCBhdHRyaWJ1dGUuCgogICAgYGBgYXBwL21vZGVscy91c2VyLmpzCiAgICBpbXBvcnQgTW9kZWwsIHsgYXR0ciB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKCiAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICB1c2VybmFtZTogYXR0cignc3RyaW5nJyksCiAgICAgIGVtYWlsOiBhdHRyKCdzdHJpbmcnKSwKICAgICAgc2V0dGluZ3M6IGF0dHIoewogICAgICAgIGRlZmF1bHRWYWx1ZSgpIHsKICAgICAgICAgIHJldHVybiB7fTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9KTsKICAgIGBgYAoKICAgIFRoZSBgb3B0aW9uc2AgaGFzaCBpcyBwYXNzZWQgYXMgc2Vjb25kIGFyZ3VtZW50IHRvIGEgdHJhbnNmb3JtcycKICAgIGBzZXJpYWxpemVgIGFuZCBgZGVzZXJpYWxpemVgIG1ldGhvZC4gVGhpcyBhbGxvd3MgdG8gY29uZmlndXJlIGEKICAgIHRyYW5zZm9ybWF0aW9uIGFuZCBhZGFwdCB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZSwgYmFzZWQgb24gdGhlIGNvbmZpZzoKCiAgICBgYGBhcHAvbW9kZWxzL3Bvc3QuanMKICAgIGltcG9ydCBNb2RlbCwgeyBhdHRyIH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwoKICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgIHRleHQ6IGF0dHIoJ3RleHQnLCB7CiAgICAgICAgdXBwZXJjYXNlOiB0cnVlCiAgICAgIH0pCiAgICB9KTsKICAgIGBgYAoKICAgIGBgYGFwcC90cmFuc2Zvcm1zL3RleHQuanMKICAgIGltcG9ydCBUcmFuc2Zvcm0gZnJvbSAnQGVtYmVyLWRhdGEvc2VyaWFsaXplci90cmFuc2Zvcm0nOwoKICAgIGV4cG9ydCBkZWZhdWx0IFRyYW5zZm9ybS5leHRlbmQoewogICAgICBzZXJpYWxpemUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBpZiAob3B0aW9ucy51cHBlcmNhc2UpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZS50b1VwcGVyQ2FzZSgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9LAoKICAgICAgZGVzZXJpYWxpemUodmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgIH0pCiAgICBgYGAKCiAgICBAbWV0aG9kIGF0dHIKICAgIEBwdWJsaWMKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyLWRhdGEvbW9kZWwKICAgIEBwYXJhbSB7U3RyaW5nfE9iamVjdH0gdHlwZSB0aGUgYXR0cmlidXRlIHR5cGUKICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIGEgaGFzaCBvZiBvcHRpb25zCiAgICBAcmV0dXJuIHtBdHRyaWJ1dGV9CiAgKi8KCgogIGZ1bmN0aW9uIGF0dHIodHlwZSwgb3B0aW9ucykgewogICAgaWYgKHR5cGVvZiB0eXBlID09PSAnb2JqZWN0JykgewogICAgICBvcHRpb25zID0gdHlwZTsKICAgICAgdHlwZSA9IHVuZGVmaW5lZDsKICAgIH0gZWxzZSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgfQoKICAgIHZhciBtZXRhID0gewogICAgICB0eXBlOiB0eXBlLAogICAgICBpc0F0dHJpYnV0ZTogdHJ1ZSwKICAgICAga2luZDogJ2F0dHJpYnV0ZScsCiAgICAgIG9wdGlvbnM6IG9wdGlvbnMKICAgIH07CiAgICByZXR1cm4gRW1iZXIuY29tcHV0ZWQoewogICAgICBnZXQ6IGZ1bmN0aW9uIGdldChrZXkpIHsKCiAgICAgICAgdmFyIGludGVybmFsTW9kZWwgPSB0aGlzLl9pbnRlcm5hbE1vZGVsOwoKICAgICAgICBpZiAoaGFzVmFsdWUoaW50ZXJuYWxNb2RlbCwga2V5KSkgewogICAgICAgICAgcmV0dXJuIGludGVybmFsTW9kZWwuZ2V0QXR0cmlidXRlVmFsdWUoa2V5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGdldERlZmF1bHRWYWx1ZSh0aGlzLCBvcHRpb25zLCBrZXkpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoa2V5LCB2YWx1ZSkgewoKICAgICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuUkVDT1JEX0RBVEFfRVJST1JTKSB7CiAgICAgICAgICB2YXIgb2xkVmFsdWUgPSB0aGlzLl9pbnRlcm5hbE1vZGVsLl9yZWNvcmREYXRhLmdldEF0dHIoa2V5KTsKCiAgICAgICAgICBpZiAob2xkVmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBlcnJvcnMgPSB0aGlzLmdldCgnZXJyb3JzJyk7CgogICAgICAgICAgICBpZiAoZXJyb3JzLmdldChrZXkpKSB7CiAgICAgICAgICAgICAgZXJyb3JzLnJlbW92ZShrZXkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9tYXJrSW52YWxpZFJlcXVlc3RBc0NsZWFuKCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5faW50ZXJuYWxNb2RlbC5zZXREaXJ0eUF0dHJpYnV0ZShrZXksIHZhbHVlKTsKICAgICAgfQogICAgfSkubWV0YShtZXRhKTsKICB9CgogIHZhciBhdHRyJDEgPSBjb21wdXRlZE1hY3JvV2l0aE9wdGlvbmFsUGFyYW1zKGF0dHIpOwoKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyLWRhdGEvbW9kZWwKICAqLwoKICAvKioKICAgIGBiZWxvbmdzVG9gIGlzIHVzZWQgdG8gZGVmaW5lIE9uZS1Uby1PbmUgYW5kIE9uZS1Uby1NYW55CiAgICByZWxhdGlvbnNoaXBzIG9uIGEgW01vZGVsXSgvZW1iZXItZGF0YS9yZWxlYXNlL2NsYXNzZXMvTW9kZWwpLgoKCiAgICBgYmVsb25nc1RvYCB0YWtlcyBhbiBvcHRpb25hbCBoYXNoIGFzIGEgc2Vjb25kIHBhcmFtZXRlciwgY3VycmVudGx5CiAgICBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CgogICAgLSBgYXN5bmNgOiBBIGJvb2xlYW4gdmFsdWUgdXNlZCB0byBleHBsaWNpdGx5IGRlY2xhcmUgdGhpcyB0byBiZSBhbiBhc3luYyByZWxhdGlvbnNoaXAuIFRoZSBkZWZhdWx0IGlzIHRydWUuCiAgICAtIGBpbnZlcnNlYDogQSBzdHJpbmcgdXNlZCB0byBpZGVudGlmeSB0aGUgaW52ZXJzZSBwcm9wZXJ0eSBvbiBhCiAgICAgIHJlbGF0ZWQgbW9kZWwgaW4gYSBPbmUtVG8tTWFueSByZWxhdGlvbnNoaXAuIFNlZSBbRXhwbGljaXQgSW52ZXJzZXNdKCNleHBsaWNpdC1pbnZlcnNlcykKICAgIC0gYHBvbHltb3JwaGljYCBBIGJvb2xlYW4gdmFsdWUgdG8gbWFyayB0aGUgcmVsYXRpb25zaGlwIGFzIHBvbHltb3JwaGljCgogICAgIyMjIyBPbmUtVG8tT25lCiAgICBUbyBkZWNsYXJlIGEgb25lLXRvLW9uZSByZWxhdGlvbnNoaXAgYmV0d2VlbiB0d28gbW9kZWxzLCB1c2UKICAgIGBiZWxvbmdzVG9gOgoKICAgIGBgYGFwcC9tb2RlbHMvdXNlci5qcwogICAgaW1wb3J0IE1vZGVsLCB7IGJlbG9uZ3NUbyB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKCiAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICBwcm9maWxlOiBiZWxvbmdzVG8oJ3Byb2ZpbGUnKQogICAgfSk7CiAgICBgYGAKCiAgICBgYGBhcHAvbW9kZWxzL3Byb2ZpbGUuanMKICAgIGltcG9ydCBNb2RlbCwgeyBiZWxvbmdzVG8gfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CgogICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgdXNlcjogYmVsb25nc1RvKCd1c2VyJykKICAgIH0pOwogICAgYGBgCgogICAgIyMjIyBPbmUtVG8tTWFueQogICAgVG8gZGVjbGFyZSBhIG9uZS10by1tYW55IHJlbGF0aW9uc2hpcCBiZXR3ZWVuIHR3byBtb2RlbHMsIHVzZQogICAgYGJlbG9uZ3NUb2AgaW4gY29tYmluYXRpb24gd2l0aCBgaGFzTWFueWAsIGxpa2UgdGhpczoKCiAgICBgYGBhcHAvbW9kZWxzL3Bvc3QuanMKICAgIGltcG9ydCBNb2RlbCwgeyBoYXNNYW55IH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwoKICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgIGNvbW1lbnRzOiBoYXNNYW55KCdjb21tZW50JykKICAgIH0pOwogICAgYGBgCgogICAgYGBgYXBwL21vZGVscy9jb21tZW50LmpzCiAgICBpbXBvcnQgTW9kZWwsIHsgYmVsb25nc1RvIH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwoKICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgIHBvc3Q6IGJlbG9uZ3NUbygncG9zdCcpCiAgICB9KTsKICAgIGBgYAoKICAgIFlvdSBjYW4gYXZvaWQgcGFzc2luZyBhIHN0cmluZyBhcyB0aGUgZmlyc3QgcGFyYW1ldGVyLiBJbiB0aGF0IGNhc2UgRW1iZXIgRGF0YQogICAgd2lsbCBpbmZlciB0aGUgdHlwZSBmcm9tIHRoZSBrZXkgbmFtZS4KCiAgICBgYGBhcHAvbW9kZWxzL2NvbW1lbnQuanMKICAgIGltcG9ydCBNb2RlbCwgeyBiZWxvbmdzVG8gfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CgogICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgcG9zdDogYmVsb25nc1RvKCkKICAgIH0pOwogICAgYGBgCgogICAgd2lsbCBsb29rdXAgZm9yIGEgUG9zdCB0eXBlLgoKICAgICMjIyMgU3luYyByZWxhdGlvbnNoaXBzCgogICAgRW1iZXIgRGF0YSByZXNvbHZlcyBzeW5jIHJlbGF0aW9uc2hpcHMgd2l0aCB0aGUgcmVsYXRlZCByZXNvdXJjZXMKICAgIGF2YWlsYWJsZSBpbiBpdHMgbG9jYWwgc3RvcmUsIGhlbmNlIGl0IGlzIGV4cGVjdGVkIHRoZXNlIHJlc291cmNlcwogICAgdG8gYmUgbG9hZGVkIGJlZm9yZSBvciBhbG9uZy1zaWRlIHRoZSBwcmltYXJ5IHJlc291cmNlLgoKICAgIGBgYGFwcC9tb2RlbHMvY29tbWVudC5qcwogICAgaW1wb3J0IE1vZGVsLCB7IGJlbG9uZ3NUbyB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKCiAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICBwb3N0OiBiZWxvbmdzVG8oJ3Bvc3QnLCB7CiAgICAgICAgYXN5bmM6IGZhbHNlCiAgICAgIH0pCiAgICB9KTsKICAgIGBgYAoKICAgIEluIGNvbnRyYXN0IHRvIGFzeW5jIHJlbGF0aW9uc2hpcCwgYWNjZXNzaW5nIGEgc3luYyByZWxhdGlvbnNoaXAKICAgIHdpbGwgYWx3YXlzIHJldHVybiB0aGUgcmVjb3JkIChNb2RlbCBpbnN0YW5jZSkgZm9yIHRoZSBleGlzdGluZwogICAgbG9jYWwgcmVzb3VyY2UsIG9yIG51bGwuIEJ1dCBpdCB3aWxsIGVycm9yIG9uIGFjY2VzcyB3aGVuCiAgICBhIHJlbGF0ZWQgcmVzb3VyY2UgaXMga25vd24gdG8gZXhpc3QgYW5kIGl0IGhhcyBub3QgYmVlbiBsb2FkZWQuCgogICAgYGBgCiAgICBsZXQgcG9zdCA9IGNvbW1lbnQuZ2V0KCdwb3N0Jyk7CgogICAgYGBgCgogICAgQG1ldGhvZCBiZWxvbmdzVG8KICAgIEBwdWJsaWMKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyLWRhdGEvbW9kZWwKICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUgKG9wdGlvbmFsKSB0eXBlIG9mIHRoZSByZWxhdGlvbnNoaXAKICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIChvcHRpb25hbCkgYSBoYXNoIG9mIG9wdGlvbnMKICAgIEByZXR1cm4ge0VtYmVyLmNvbXB1dGVkfSByZWxhdGlvbnNoaXAKICAqLwoKICBmdW5jdGlvbiBiZWxvbmdzVG8obW9kZWxOYW1lLCBvcHRpb25zKSB7CiAgICB2YXIgb3B0cywgdXNlckVudGVyZWRNb2RlbE5hbWU7CgogICAgaWYgKHR5cGVvZiBtb2RlbE5hbWUgPT09ICdvYmplY3QnKSB7CiAgICAgIG9wdHMgPSBtb2RlbE5hbWU7CiAgICAgIHVzZXJFbnRlcmVkTW9kZWxOYW1lID0gdW5kZWZpbmVkOwogICAgfSBlbHNlIHsKICAgICAgb3B0cyA9IG9wdGlvbnM7CiAgICAgIHVzZXJFbnRlcmVkTW9kZWxOYW1lID0gbW9kZWxOYW1lOwogICAgfQoKICAgIGlmICh0eXBlb2YgdXNlckVudGVyZWRNb2RlbE5hbWUgPT09ICdzdHJpbmcnKSB7CiAgICAgIHVzZXJFbnRlcmVkTW9kZWxOYW1lID0gc3RvcmUubm9ybWFsaXplTW9kZWxOYW1lKHVzZXJFbnRlcmVkTW9kZWxOYW1lKTsKICAgIH0KICAgIG9wdHMgPSBvcHRzIHx8IHt9OwogICAgdmFyIG1ldGEgPSB7CiAgICAgIHR5cGU6IHVzZXJFbnRlcmVkTW9kZWxOYW1lLAogICAgICBpc1JlbGF0aW9uc2hpcDogdHJ1ZSwKICAgICAgb3B0aW9uczogb3B0cywKICAgICAga2luZDogJ2JlbG9uZ3NUbycsCiAgICAgIG5hbWU6ICdCZWxvbmdzIFRvJywKICAgICAga2V5OiBudWxsCiAgICB9OwogICAgcmV0dXJuIEVtYmVyLmNvbXB1dGVkKHsKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoa2V5KSB7CgogICAgICAgIHJldHVybiB0aGlzLl9pbnRlcm5hbE1vZGVsLmdldEJlbG9uZ3NUbyhrZXkpOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldChrZXksIHZhbHVlKSB7CgogICAgICAgIHRoaXMuX2ludGVybmFsTW9kZWwuc2V0RGlydHlCZWxvbmdzVG8oa2V5LCB2YWx1ZSk7CgogICAgICAgIHJldHVybiB0aGlzLl9pbnRlcm5hbE1vZGVsLmdldEJlbG9uZ3NUbyhrZXkpOwogICAgICB9CiAgICB9KS5tZXRhKG1ldGEpOwogIH0KCiAgdmFyIGJlbG9uZ3NUbyQxID0gY29tcHV0ZWRNYWNyb1dpdGhPcHRpb25hbFBhcmFtcyhiZWxvbmdzVG8pOwoKICAvKioKICAgIGBoYXNNYW55YCBpcyB1c2VkIHRvIGRlZmluZSBPbmUtVG8tTWFueSBhbmQgTWFueS1Uby1NYW55CiAgICByZWxhdGlvbnNoaXBzIG9uIGEgW01vZGVsXSgvZW1iZXItZGF0YS9yZWxlYXNlL2NsYXNzZXMvTW9kZWwpLgoKICAgIGBoYXNNYW55YCB0YWtlcyBhbiBvcHRpb25hbCBoYXNoIGFzIGEgc2Vjb25kIHBhcmFtZXRlciwgY3VycmVudGx5CiAgICBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CgogICAgLSBgYXN5bmNgOiBBIGJvb2xlYW4gdmFsdWUgdXNlZCB0byBleHBsaWNpdGx5IGRlY2xhcmUgdGhpcyB0byBiZSBhbiBhc3luYyByZWxhdGlvbnNoaXAuIFRoZSBkZWZhdWx0IGlzIHRydWUuCiAgICAtIGBpbnZlcnNlYDogQSBzdHJpbmcgdXNlZCB0byBpZGVudGlmeSB0aGUgaW52ZXJzZSBwcm9wZXJ0eSBvbiBhIHJlbGF0ZWQgbW9kZWwuCiAgICAtIGBwb2x5bW9ycGhpY2AgQSBib29sZWFuIHZhbHVlIHRvIG1hcmsgdGhlIHJlbGF0aW9uc2hpcCBhcyBwb2x5bW9ycGhpYwoKICAgICMjIyMgT25lLVRvLU1hbnkKICAgIFRvIGRlY2xhcmUgYSBvbmUtdG8tbWFueSByZWxhdGlvbnNoaXAgYmV0d2VlbiB0d28gbW9kZWxzLCB1c2UKICAgIGBiZWxvbmdzVG9gIGluIGNvbWJpbmF0aW9uIHdpdGggYGhhc01hbnlgLCBsaWtlIHRoaXM6CgogICAgYGBgYXBwL21vZGVscy9wb3N0LmpzCiAgICBpbXBvcnQgTW9kZWwsIHsgaGFzTWFueSB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKCiAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICBjb21tZW50czogaGFzTWFueSgnY29tbWVudCcpCiAgICB9KTsKICAgIGBgYAoKICAgIGBgYGFwcC9tb2RlbHMvY29tbWVudC5qcwogICAgaW1wb3J0IE1vZGVsLCB7IGJlbG9uZ3NUbyB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKCiAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICBwb3N0OiBiZWxvbmdzVG8oJ3Bvc3QnKQogICAgfSk7CiAgICBgYGAKCiAgICAjIyMjIE1hbnktVG8tTWFueQogICAgVG8gZGVjbGFyZSBhIG1hbnktdG8tbWFueSByZWxhdGlvbnNoaXAgYmV0d2VlbiB0d28gbW9kZWxzLCB1c2UKICAgIGBoYXNNYW55YDoKCiAgICBgYGBhcHAvbW9kZWxzL3Bvc3QuanMKICAgIGltcG9ydCBNb2RlbCwgeyBoYXNNYW55IH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwoKICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgIHRhZ3M6IGhhc01hbnkoJ3RhZycpCiAgICB9KTsKICAgIGBgYAoKICAgIGBgYGFwcC9tb2RlbHMvdGFnLmpzCiAgICBpbXBvcnQgTW9kZWwsIHsgaGFzTWFueSB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKCiAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICBwb3N0czogaGFzTWFueSgncG9zdCcpCiAgICB9KTsKICAgIGBgYAoKICAgIFlvdSBjYW4gYXZvaWQgcGFzc2luZyBhIHN0cmluZyBhcyB0aGUgZmlyc3QgcGFyYW1ldGVyLiBJbiB0aGF0IGNhc2UgRW1iZXIgRGF0YQogICAgd2lsbCBpbmZlciB0aGUgdHlwZSBmcm9tIHRoZSBzaW5ndWxhcml6ZWQga2V5IG5hbWUuCgogICAgYGBgYXBwL21vZGVscy9wb3N0LmpzCiAgICBpbXBvcnQgTW9kZWwsIHsgaGFzTWFueSB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKCiAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICB0YWdzOiBoYXNNYW55KCkKICAgIH0pOwogICAgYGBgCgogICAgd2lsbCBsb29rdXAgZm9yIGEgVGFnIHR5cGUuCgogICAgIyMjIyBFeHBsaWNpdCBJbnZlcnNlcwoKICAgIEVtYmVyIERhdGEgd2lsbCBkbyBpdHMgYmVzdCB0byBkaXNjb3ZlciB3aGljaCByZWxhdGlvbnNoaXBzIG1hcCB0bwogICAgb25lIGFub3RoZXIuIEluIHRoZSBvbmUtdG8tbWFueSBjb2RlIGFib3ZlLCBmb3IgZXhhbXBsZSwgRW1iZXIgRGF0YQogICAgY2FuIGZpZ3VyZSBvdXQgdGhhdCBjaGFuZ2luZyB0aGUgYGNvbW1lbnRzYCByZWxhdGlvbnNoaXAgc2hvdWxkIHVwZGF0ZQogICAgdGhlIGBwb3N0YCByZWxhdGlvbnNoaXAgb24gdGhlIGludmVyc2UgYmVjYXVzZSBwb3N0IGlzIHRoZSBvbmx5CiAgICByZWxhdGlvbnNoaXAgdG8gdGhhdCBtb2RlbC4KCiAgICBIb3dldmVyLCBzb21ldGltZXMgeW91IG1heSBoYXZlIG11bHRpcGxlIGBiZWxvbmdzVG9gL2BoYXNNYW55YCBmb3IgdGhlCiAgICBzYW1lIHR5cGUuIFlvdSBjYW4gc3BlY2lmeSB3aGljaCBwcm9wZXJ0eSBvbiB0aGUgcmVsYXRlZCBtb2RlbCBpcwogICAgdGhlIGludmVyc2UgdXNpbmcgYGhhc01hbnlgJ3MgYGludmVyc2VgIG9wdGlvbjoKCiAgICBgYGBhcHAvbW9kZWxzL2NvbW1lbnQuanMKICAgIGltcG9ydCBNb2RlbCwgeyBiZWxvbmdzVG8gfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CgogICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgb25lUG9zdDogYmVsb25nc1RvKCdwb3N0JyksCiAgICAgIHR3b1Bvc3Q6IGJlbG9uZ3NUbygncG9zdCcpLAogICAgICByZWRQb3N0OiBiZWxvbmdzVG8oJ3Bvc3QnKSwKICAgICAgYmx1ZVBvc3Q6IGJlbG9uZ3NUbygncG9zdCcpCiAgICB9KTsKICAgIGBgYAoKICAgIGBgYGFwcC9tb2RlbHMvcG9zdC5qcwogICAgaW1wb3J0IE1vZGVsLCB7IGhhc01hbnkgfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CgogICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgY29tbWVudHM6IGhhc01hbnkoJ2NvbW1lbnQnLCB7CiAgICAgICAgaW52ZXJzZTogJ3JlZFBvc3QnCiAgICAgIH0pCiAgICB9KTsKICAgIGBgYAoKICAgIFlvdSBjYW4gYWxzbyBzcGVjaWZ5IGFuIGludmVyc2Ugb24gYSBgYmVsb25nc1RvYCwgd2hpY2ggd29ya3MgaG93CiAgICB5b3UnZCBleHBlY3QuCgogICAgIyMjIyBTeW5jIHJlbGF0aW9uc2hpcHMKCiAgICBFbWJlciBEYXRhIHJlc29sdmVzIHN5bmMgcmVsYXRpb25zaGlwcyB3aXRoIHRoZSByZWxhdGVkIHJlc291cmNlcwogICAgYXZhaWxhYmxlIGluIGl0cyBsb2NhbCBzdG9yZSwgaGVuY2UgaXQgaXMgZXhwZWN0ZWQgdGhlc2UgcmVzb3VyY2VzCiAgICB0byBiZSBsb2FkZWQgYmVmb3JlIG9yIGFsb25nLXNpZGUgdGhlIHByaW1hcnkgcmVzb3VyY2UuCgogICAgYGBgYXBwL21vZGVscy9wb3N0LmpzCiAgICBpbXBvcnQgTW9kZWwsIHsgaGFzTWFueSB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKCiAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICBjb21tZW50czogaGFzTWFueSgnY29tbWVudCcsIHsKICAgICAgICBhc3luYzogZmFsc2UKICAgICAgfSkKICAgIH0pOwogICAgYGBgCgogICAgSW4gY29udHJhc3QgdG8gYXN5bmMgcmVsYXRpb25zaGlwLCBhY2Nlc3NpbmcgYSBzeW5jIHJlbGF0aW9uc2hpcAogICAgd2lsbCBhbHdheXMgcmV0dXJuIGEgW01hbnlBcnJheV0oL2VtYmVyLWRhdGEvcmVsZWFzZS9jbGFzc2VzL01hbnlBcnJheSkgaW5zdGFuY2UKICAgIGNvbnRhaW5pbmcgdGhlIGV4aXN0aW5nIGxvY2FsIHJlc291cmNlcy4gQnV0IGl0IHdpbGwgZXJyb3Igb24gYWNjZXNzCiAgICB3aGVuIGFueSBvZiB0aGUga25vd24gcmVsYXRlZCByZXNvdXJjZXMgaGF2ZSBub3QgYmVlbiBsb2FkZWQuCgogICAgYGBgCiAgICBwb3N0LmdldCgnY29tbWVudHMnKS5mb3JFYWNoKChjb21tZW50KSA9PiB7CgogICAgfSk7CgogICAgYGBgCgogICAgSWYgeW91IGFyZSB1c2luZyBgbGlua3NgIHdpdGggc3luYyByZWxhdGlvbnNoaXBzLCB5b3UgaGF2ZSB0byB1c2UKICAgIGByZWYucmVsb2FkYCB0byBmZXRjaCB0aGUgcmVzb3VyY2VzLgoKICAgIEBtZXRob2QgaGFzTWFueQogICAgQHB1YmxpYwogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXItZGF0YS9tb2RlbAogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgKG9wdGlvbmFsKSB0eXBlIG9mIHRoZSByZWxhdGlvbnNoaXAKICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIChvcHRpb25hbCkgYSBoYXNoIG9mIG9wdGlvbnMKICAgIEByZXR1cm4ge0VtYmVyLmNvbXB1dGVkfSByZWxhdGlvbnNoaXAKICAqLwoKICBmdW5jdGlvbiBoYXNNYW55KHR5cGUsIG9wdGlvbnMpIHsKICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gJ29iamVjdCcpIHsKICAgICAgb3B0aW9ucyA9IHR5cGU7CiAgICAgIHR5cGUgPSB1bmRlZmluZWQ7CiAgICB9CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICBpZiAodHlwZW9mIHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgIHR5cGUgPSBzdG9yZS5ub3JtYWxpemVNb2RlbE5hbWUodHlwZSk7CiAgICB9IC8vIE1ldGFkYXRhIGFib3V0IHJlbGF0aW9uc2hpcHMgaXMgc3RvcmVkIG9uIHRoZSBtZXRhIG9mCiAgICAvLyB0aGUgcmVsYXRpb25zaGlwLiBUaGlzIGlzIHVzZWQgZm9yIGludHJvc3BlY3Rpb24gYW5kCiAgICAvLyBzZXJpYWxpemF0aW9uLiBOb3RlIHRoYXQgYGtleWAgaXMgcG9wdWxhdGVkIGxhemlseQogICAgLy8gdGhlIGZpcnN0IHRpbWUgdGhlIENQIGlzIGNhbGxlZC4KCgogICAgdmFyIG1ldGEgPSB7CiAgICAgIHR5cGU6IHR5cGUsCiAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgIGlzUmVsYXRpb25zaGlwOiB0cnVlLAogICAgICBraW5kOiAnaGFzTWFueScsCiAgICAgIG5hbWU6ICdIYXMgTWFueScsCiAgICAgIGtleTogbnVsbAogICAgfTsKICAgIHJldHVybiBFbWJlci5jb21wdXRlZCh7CiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KGtleSkgewoKICAgICAgICByZXR1cm4gdGhpcy5faW50ZXJuYWxNb2RlbC5nZXRIYXNNYW55KGtleSk7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gc2V0KGtleSwgcmVjb3JkcykgewoKICAgICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IHRoaXMuX2ludGVybmFsTW9kZWw7CiAgICAgICAgaW50ZXJuYWxNb2RlbC5zZXREaXJ0eUhhc01hbnkoa2V5LCByZWNvcmRzKTsKICAgICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbC5nZXRIYXNNYW55KGtleSk7CiAgICAgIH0KICAgIH0pLm1ldGEobWV0YSk7CiAgfQoKICB2YXIgaGFzTWFueSQxID0gY29tcHV0ZWRNYWNyb1dpdGhPcHRpb25hbFBhcmFtcyhoYXNNYW55KTsKCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL3N0b3JlCiAgKi8KCiAgLyoqCiAgICBIb2xkcyB2YWxpZGF0aW9uIGVycm9ycyBmb3IgYSBnaXZlbiByZWNvcmQsIG9yZ2FuaXplZCBieSBhdHRyaWJ1dGUgbmFtZXMuCgogICAgRXZlcnkgYE1vZGVsYCBoYXMgYW4gYGVycm9yc2AgcHJvcGVydHkgdGhhdCBpcyBhbiBpbnN0YW5jZSBvZgogICAgYEVycm9yc2AuIFRoaXMgY2FuIGJlIHVzZWQgdG8gZGlzcGxheSB2YWxpZGF0aW9uIGVycm9yCiAgICBtZXNzYWdlcyByZXR1cm5lZCBmcm9tIHRoZSBzZXJ2ZXIgd2hlbiBhIGByZWNvcmQuc2F2ZSgpYCByZWplY3RzLgoKICAgIEZvciBFeGFtcGxlLCBpZiB5b3UgaGFkIGEgYFVzZXJgIG1vZGVsIHRoYXQgbG9va2VkIGxpa2UgdGhpczoKCiAgICBgYGBhcHAvbW9kZWxzL3VzZXIuanMKICAgIGltcG9ydCBNb2RlbCwgeyBhdHRyIH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwoKICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgIHVzZXJuYW1lOiBhdHRyKCdzdHJpbmcnKSwKICAgICAgZW1haWw6IGF0dHIoJ3N0cmluZycpCiAgICB9KTsKICAgIGBgYAogICAgQW5kIHlvdSBhdHRlbXB0ZWQgdG8gc2F2ZSBhIHJlY29yZCB0aGF0IGRpZCBub3QgdmFsaWRhdGUgb24gdGhlIGJhY2tlbmQ6CgogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHVzZXIgPSBzdG9yZS5jcmVhdGVSZWNvcmQoJ3VzZXInLCB7CiAgICAgIHVzZXJuYW1lOiAndG9tc3RlcicsCiAgICAgIGVtYWlsOiAnaW52YWxpZEVtYWlsJwogICAgfSk7CiAgICB1c2VyLnNhdmUoKTsKICAgIGBgYAoKICAgIFlvdXIgYmFja2VuZCB3b3VsZCBiZSBleHBlY3RlZCB0byByZXR1cm4gYW4gZXJyb3IgcmVzcG9uc2UgdGhhdCBkZXNjcmliZWQKICAgIHRoZSBwcm9ibGVtLCBzbyB0aGF0IGVycm9yIG1lc3NhZ2VzIGNhbiBiZSBnZW5lcmF0ZWQgb24gdGhlIGFwcC4KCiAgICBBUEkgcmVzcG9uc2VzIHdpbGwgYmUgdHJhbnNsYXRlZCBpbnRvIGluc3RhbmNlcyBvZiBgRXJyb3JzYCBkaWZmZXJlbnRseSwKICAgIGRlcGVuZGluZyBvbiB0aGUgc3BlY2lmaWMgY29tYmluYXRpb24gb2YgYWRhcHRlciBhbmQgc2VyaWFsaXplciB1c2VkLiBZb3UKICAgIG1heSB3YW50IHRvIGNoZWNrIHRoZSBkb2N1bWVudGF0aW9uIG9yIHRoZSBzb3VyY2UgY29kZSBvZiB0aGUgbGlicmFyaWVzCiAgICB0aGF0IHlvdSBhcmUgdXNpbmcsIHRvIGtub3cgaG93IHRoZXkgZXhwZWN0IGVycm9ycyB0byBiZSBjb21tdW5pY2F0ZWQuCgogICAgRXJyb3JzIGNhbiBiZSBkaXNwbGF5ZWQgdG8gdGhlIHVzZXIgYnkgYWNjZXNzaW5nIHRoZWlyIHByb3BlcnR5IG5hbWUKICAgIHRvIGdldCBhbiBhcnJheSBvZiBhbGwgdGhlIGVycm9yIG9iamVjdHMgZm9yIHRoYXQgcHJvcGVydHkuIEVhY2gKICAgIGVycm9yIG9iamVjdCBpcyBhIEphdmFTY3JpcHQgb2JqZWN0IHdpdGggdHdvIGtleXM6CgogICAgLSBgbWVzc2FnZWAgQSBzdHJpbmcgY29udGFpbmluZyB0aGUgZXJyb3IgbWVzc2FnZSBmcm9tIHRoZSBiYWNrZW5kCiAgICAtIGBhdHRyaWJ1dGVgIFRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSBhc3NvY2lhdGVkIHdpdGggdGhpcyBlcnJvciBtZXNzYWdlCgogICAgYGBgaGFuZGxlYmFycwogICAgPGxhYmVsPlVzZXJuYW1lOiB7e2lucHV0IHZhbHVlPXVzZXJuYW1lfX0gPC9sYWJlbD4KICAgIHt7I2VhY2ggbW9kZWwuZXJyb3JzLnVzZXJuYW1lIGFzIHxlcnJvcnx9fQogICAgICA8ZGl2IGNsYXNzPSJlcnJvciI+CiAgICAgICAge3tlcnJvci5tZXNzYWdlfX0KICAgICAgPC9kaXY+CiAgICB7ey9lYWNofX0KCiAgICA8bGFiZWw+RW1haWw6IHt7aW5wdXQgdmFsdWU9ZW1haWx9fSA8L2xhYmVsPgogICAge3sjZWFjaCBtb2RlbC5lcnJvcnMuZW1haWwgYXMgfGVycm9yfH19CiAgICAgIDxkaXYgY2xhc3M9ImVycm9yIj4KICAgICAgICB7e2Vycm9yLm1lc3NhZ2V9fQogICAgICA8L2Rpdj4KICAgIHt7L2VhY2h9fQogICAgYGBgCgogICAgWW91IGNhbiBhbHNvIGFjY2VzcyB0aGUgc3BlY2lhbCBgbWVzc2FnZXNgIHByb3BlcnR5IG9uIHRoZSBlcnJvcgogICAgb2JqZWN0IHRvIGdldCBhbiBhcnJheSBvZiBhbGwgdGhlIGVycm9yIHN0cmluZ3MuCgogICAgYGBgaGFuZGxlYmFycwogICAge3sjZWFjaCBtb2RlbC5lcnJvcnMubWVzc2FnZXMgYXMgfG1lc3NhZ2V8fX0KICAgICAgPGRpdiBjbGFzcz0iZXJyb3IiPgogICAgICAgIHt7bWVzc2FnZX19CiAgICAgIDwvZGl2PgogICAge3svZWFjaH19CiAgICBgYGAKCiAgICBAY2xhc3MgRXJyb3JzCiAgICBAZXh0ZW5kcyBFbWJlci5BcnJheVByb3h5CiAgICBAdXNlcyBFbWJlci5FdmVudGVkCiAgICovCiAgdmFyIEVycm9ycyA9IEVtYmVyLkFycmF5UHJveHkuZXh0ZW5kKFByaXZhdGUuRGVwcmVjYXRlZEV2ZW50ZWQsIHsKICAgIC8qKgogICAgICBSZWdpc3RlciB3aXRoIHRhcmdldCBoYW5kbGVyCiAgICAgICBAbWV0aG9kIF9yZWdpc3RlckhhbmRsZXJzCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgX3JlZ2lzdGVySGFuZGxlcnM6IGZ1bmN0aW9uIF9yZWdpc3RlckhhbmRsZXJzKGJlY2FtZUludmFsaWQsIGJlY2FtZVZhbGlkKSB7CiAgICAgIHRoaXMuX3JlZ2lzdGVyZWRIYW5kbGVycyA9IHsKICAgICAgICBiZWNhbWVJbnZhbGlkOiBiZWNhbWVJbnZhbGlkLAogICAgICAgIGJlY2FtZVZhbGlkOiBiZWNhbWVWYWxpZAogICAgICB9OwogICAgfSwKCiAgICAvKioKICAgICAgQHByb3BlcnR5IGVycm9yc0J5QXR0cmlidXRlTmFtZQogICAgICBAdHlwZSB7TWFwV2l0aERlZmF1bHR9CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgZXJyb3JzQnlBdHRyaWJ1dGVOYW1lOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBuZXcgTWFwKCk7CiAgICB9KSwKCiAgICAvKioKICAgICAgUmV0dXJucyBlcnJvcnMgZm9yIGEgZ2l2ZW4gYXR0cmlidXRlCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGxldCB1c2VyID0gc3RvcmUuY3JlYXRlUmVjb3JkKCd1c2VyJywgewogICAgICAgIHVzZXJuYW1lOiAndG9tc3RlcicsCiAgICAgICAgZW1haWw6ICdpbnZhbGlkRW1haWwnCiAgICAgIH0pOwogICAgICB1c2VyLnNhdmUoKS5jYXRjaChmdW5jdGlvbigpewogICAgICAgIHVzZXIuZ2V0KCdlcnJvcnMnKS5lcnJvcnNGb3IoJ2VtYWlsJyk7IC8vIHJldHVybnM6CiAgICAgICAgLy8gW3thdHRyaWJ1dGU6ICJlbWFpbCIsIG1lc3NhZ2U6ICJEb2Vzbid0IGxvb2sgbGlrZSBhIHZhbGlkIGVtYWlsLiJ9XQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGVycm9yc0ZvcgogICAgICBAcGFyYW0ge1N0cmluZ30gYXR0cmlidXRlCiAgICAgIEByZXR1cm4ge0FycmF5fQogICAgKi8KICAgIGVycm9yc0ZvcjogZnVuY3Rpb24gZXJyb3JzRm9yKGF0dHJpYnV0ZSkgewogICAgICB2YXIgbWFwID0gRW1iZXIuZ2V0KHRoaXMsICdlcnJvcnNCeUF0dHJpYnV0ZU5hbWUnKTsKCiAgICAgIGlmICghbWFwLmhhcyhhdHRyaWJ1dGUpKSB7CiAgICAgICAgbWFwLnNldChhdHRyaWJ1dGUsIEVtYmVyLkEoKSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBtYXAuZ2V0KGF0dHJpYnV0ZSk7CiAgICB9LAoKICAgIC8qKgogICAgICBBbiBhcnJheSBjb250YWluaW5nIGFsbCBvZiB0aGUgZXJyb3IgbWVzc2FnZXMgZm9yIHRoaXMKICAgICAgcmVjb3JkLiBUaGlzIGlzIHVzZWZ1bCBmb3IgZGlzcGxheWluZyBhbGwgZXJyb3JzIHRvIHRoZSB1c2VyLgogICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7eyNlYWNoIG1vZGVsLmVycm9ycy5tZXNzYWdlcyBhcyB8bWVzc2FnZXx9fQogICAgICAgIDxkaXYgY2xhc3M9ImVycm9yIj4KICAgICAgICAgIHt7bWVzc2FnZX19CiAgICAgICAgPC9kaXY+CiAgICAgIHt7L2VhY2h9fQogICAgICBgYGAKICAgICAgIEBwcm9wZXJ0eSBtZXNzYWdlcwogICAgICBAdHlwZSB7QXJyYXl9CiAgICAqLwogICAgbWVzc2FnZXM6IEVtYmVyLmNvbXB1dGVkLm1hcEJ5KCdjb250ZW50JywgJ21lc3NhZ2UnKSwKCiAgICAvKioKICAgICAgQHByb3BlcnR5IGNvbnRlbnQKICAgICAgQHR5cGUge0FycmF5fQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGNvbnRlbnQ6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIEVtYmVyLkEoKTsKICAgIH0pLAoKICAgIC8qKgogICAgICBAbWV0aG9kIHVua25vd25Qcm9wZXJ0eQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIHVua25vd25Qcm9wZXJ0eTogZnVuY3Rpb24gdW5rbm93blByb3BlcnR5KGF0dHJpYnV0ZSkgewogICAgICB2YXIgZXJyb3JzID0gdGhpcy5lcnJvcnNGb3IoYXR0cmlidXRlKTsKCiAgICAgIGlmIChlcnJvcnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgcmV0dXJuIGVycm9yczsKICAgIH0sCgogICAgLyoqCiAgICAgIFRvdGFsIG51bWJlciBvZiBlcnJvcnMuCiAgICAgICBAcHJvcGVydHkgbGVuZ3RoCiAgICAgIEB0eXBlIHtOdW1iZXJ9CiAgICAgIEByZWFkT25seQogICAgKi8KCiAgICAvKioKICAgICAgQHByb3BlcnR5IGlzRW1wdHkKICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgIEByZWFkT25seQogICAgKi8KICAgIGlzRW1wdHk6IEVtYmVyLmNvbXB1dGVkLm5vdCgnbGVuZ3RoJykucmVhZE9ubHkoKSwKCiAgICAvKioKICAgICBNYW51YWxseSBhZGRzIGVycm9ycyB0byB0aGUgcmVjb3JkLiBUaGlzIHdpbGwgdHJpZ2VyIHRoZSBgYmVjYW1lSW52YWxpZGAgZXZlbnQvIGxpZmVjeWNsZSBtZXRob2Qgb24KICAgICAgdGhlIHJlY29yZCBhbmQgdHJhbnNpdGlvbiB0aGUgcmVjb3JkIGludG8gYW4gYGludmFsaWRgIHN0YXRlLgogICAgICBFeGFtcGxlCiAgICAgYGBgamF2YXNjcmlwdAogICAgICBsZXQgZXJyb3JzID0gZ2V0KHVzZXIsICdlcnJvcnMnKTsKICAgICAgIC8vIGFkZCBtdWx0aXBsZSBlcnJvcnMKICAgICAgZXJyb3JzLmFkZCgncGFzc3dvcmQnLCBbCiAgICAgICAgJ011c3QgYmUgYXQgbGVhc3QgMTIgY2hhcmFjdGVycycsCiAgICAgICAgJ011c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgc3ltYm9sJywKICAgICAgICAnQ2Fubm90IGNvbnRhaW4geW91ciBuYW1lJwogICAgICBdKTsKICAgICAgIGVycm9ycy5lcnJvcnNGb3IoJ3Bhc3N3b3JkJyk7CiAgICAgIC8vID0+CiAgICAgIC8vIFsKICAgICAgLy8gICB7IGF0dHJpYnV0ZTogJ3Bhc3N3b3JkJywgbWVzc2FnZTogJ011c3QgYmUgYXQgbGVhc3QgMTIgY2hhcmFjdGVycycgfSwKICAgICAgLy8gICB7IGF0dHJpYnV0ZTogJ3Bhc3N3b3JkJywgbWVzc2FnZTogJ011c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgc3ltYm9sJyB9LAogICAgICAvLyAgIHsgYXR0cmlidXRlOiAncGFzc3dvcmQnLCBtZXNzYWdlOiAnQ2Fubm90IGNvbnRhaW4geW91ciBuYW1lJyB9LAogICAgICAvLyBdCiAgICAgICAvLyBhZGQgYSBzaW5nbGUgZXJyb3IKICAgICAgZXJyb3JzLmFkZCgndXNlcm5hbWUnLCAnVGhpcyBmaWVsZCBpcyByZXF1aXJlZCcpOwogICAgICAgZXJyb3JzLmVycm9yc0ZvcigncGFzc3dvcmQnKTsKICAgICAgLy8gPT4KICAgICAgLy8gWwogICAgICAvLyAgIHsgYXR0cmlidXRlOiAndXNlcm5hbWUnLCBtZXNzYWdlOiAnVGhpcyBmaWVsZCBpcyByZXF1aXJlZCcgfSwKICAgICAgLy8gXQogICAgIGBgYAogICAgQG1ldGhvZCBhZGQKICAgIEBwYXJhbSB7c3RyaW5nfSBhdHRyaWJ1dGUgLSB0aGUgcHJvcGVydHkgbmFtZSBvZiBhbiBhdHRyaWJ1dGUgb3IgcmVsYXRpb25zaGlwCiAgICBAcGFyYW0ge3N0cmluZ1tdfHN0cmluZ30gbWVzc2FnZXMgLSBhbiBlcnJvciBtZXNzYWdlIG9yIGFycmF5IG9mIGVycm9yIG1lc3NhZ2VzIGZvciB0aGUgYXR0cmlidXRlCiAgICAgKi8KICAgIGFkZDogZnVuY3Rpb24gYWRkKGF0dHJpYnV0ZSwgbWVzc2FnZXMpIHsKICAgICAgdmFyIHdhc0VtcHR5ID0gRW1iZXIuZ2V0KHRoaXMsICdpc0VtcHR5Jyk7CgogICAgICB0aGlzLl9hZGQoYXR0cmlidXRlLCBtZXNzYWdlcyk7CgogICAgICBpZiAod2FzRW1wdHkgJiYgIUVtYmVyLmdldCh0aGlzLCAnaXNFbXB0eScpKSB7CiAgICAgICAgdGhpcy5fcmVnaXN0ZXJlZEhhbmRsZXJzICYmIHRoaXMuX3JlZ2lzdGVyZWRIYW5kbGVycy5iZWNhbWVJbnZhbGlkKCk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgIEFkZHMgZXJyb3IgbWVzc2FnZXMgdG8gYSBnaXZlbiBhdHRyaWJ1dGUgd2l0aG91dCBzZW5kaW5nIGV2ZW50LgogICAgICAgQG1ldGhvZCBfYWRkCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgX2FkZDogZnVuY3Rpb24gX2FkZChhdHRyaWJ1dGUsIG1lc3NhZ2VzKSB7CiAgICAgIG1lc3NhZ2VzID0gdGhpcy5fZmluZE9yQ3JlYXRlTWVzc2FnZXMoYXR0cmlidXRlLCBtZXNzYWdlcyk7CiAgICAgIHRoaXMuYWRkT2JqZWN0cyhtZXNzYWdlcyk7CiAgICAgIHRoaXMuZXJyb3JzRm9yKGF0dHJpYnV0ZSkuYWRkT2JqZWN0cyhtZXNzYWdlcyk7CiAgICAgIHRoaXMubm90aWZ5UHJvcGVydHlDaGFuZ2UoYXR0cmlidXRlKTsKICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2QgX2ZpbmRPckNyZWF0ZU1lc3NhZ2VzCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgX2ZpbmRPckNyZWF0ZU1lc3NhZ2VzOiBmdW5jdGlvbiBfZmluZE9yQ3JlYXRlTWVzc2FnZXMoYXR0cmlidXRlLCBtZXNzYWdlcykgewogICAgICB2YXIgZXJyb3JzID0gdGhpcy5lcnJvcnNGb3IoYXR0cmlidXRlKTsKICAgICAgdmFyIG1lc3NhZ2VzQXJyYXkgPSBFbWJlci5tYWtlQXJyYXkobWVzc2FnZXMpOwoKICAgICAgdmFyIF9tZXNzYWdlcyA9IG5ldyBBcnJheShtZXNzYWdlc0FycmF5Lmxlbmd0aCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1lc3NhZ2VzQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgbWVzc2FnZSA9IG1lc3NhZ2VzQXJyYXlbaV07CiAgICAgICAgdmFyIGVyciA9IGVycm9ycy5maW5kQnkoJ21lc3NhZ2UnLCBtZXNzYWdlKTsKCiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgX21lc3NhZ2VzW2ldID0gZXJyOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBfbWVzc2FnZXNbaV0gPSB7CiAgICAgICAgICAgIGF0dHJpYnV0ZTogYXR0cmlidXRlLAogICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIF9tZXNzYWdlczsKICAgIH0sCgogICAgLyoqCiAgICAgTWFudWFsbHkgcmVtb3ZlcyBhbGwgZXJyb3JzIGZvciBhIGdpdmVuIG1lbWJlciBmcm9tIHRoZSByZWNvcmQuCiAgICAgICBUaGlzIHdpbGwgdHJhbnNpdGlvbiB0aGUgcmVjb3JkIGludG8gYSBgdmFsaWRgIHN0YXRlLCBhbmQKICAgICAgdHJpZ2dlcnMgdGhlIGBiZWNhbWVWYWxpZGAgZXZlbnQgYW5kIGxpZmVjeWNsZSBtZXRob2QuCiAgICAgIEV4YW1wbGU6CiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgbGV0IGVycm9ycyA9IGdldCgndXNlcicsIGVycm9ycyk7CiAgICAgIGVycm9ycy5hZGQoJ3Bob25lJywgWydlcnJvci0xJywgJ2Vycm9yLTInXSk7CiAgICAgICBlcnJvcnMuZXJyb3JzRm9yKCdwaG9uZScpOwogICAgICAvLyA9PgogICAgICAvLyBbCiAgICAgIC8vICAgeyBhdHRyaWJ1dGU6ICdwaG9uZScsIG1lc3NhZ2U6ICdlcnJvci0xJyB9LAogICAgICAvLyAgIHsgYXR0cmlidXRlOiAncGhvbmUnLCBtZXNzYWdlOiAnZXJyb3ItMicgfSwKICAgICAgLy8gXQogICAgICAgZXJyb3JzLnJlbW92ZSgncGhvbmUnKTsKICAgICAgIGVycm9ycy5lcnJvcnNGb3IoJ3Bob25lJyk7CiAgICAgIC8vID0+IHVuZGVmaW5lZAogICAgIGBgYAogICAgIEBtZXRob2QgcmVtb3ZlCiAgICAgQHBhcmFtIHtzdHJpbmd9IG1lbWJlciAtIHRoZSBwcm9wZXJ0eSBuYW1lIG9mIGFuIGF0dHJpYnV0ZSBvciByZWxhdGlvbnNoaXAKICAgICAqLwogICAgcmVtb3ZlOiBmdW5jdGlvbiByZW1vdmUoYXR0cmlidXRlKSB7CiAgICAgIGlmIChFbWJlci5nZXQodGhpcywgJ2lzRW1wdHknKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5fcmVtb3ZlKGF0dHJpYnV0ZSk7CgogICAgICBpZiAoRW1iZXIuZ2V0KHRoaXMsICdpc0VtcHR5JykpIHsKICAgICAgICB0aGlzLl9yZWdpc3RlcmVkSGFuZGxlcnMgJiYgdGhpcy5fcmVnaXN0ZXJlZEhhbmRsZXJzLmJlY2FtZVZhbGlkKCk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgIFJlbW92ZXMgYWxsIGVycm9yIG1lc3NhZ2VzIGZyb20gdGhlIGdpdmVuIGF0dHJpYnV0ZSB3aXRob3V0IHNlbmRpbmcgZXZlbnQuCiAgICAgICBAbWV0aG9kIF9yZW1vdmUKICAgICAgQHByaXZhdGUKICAgICovCiAgICBfcmVtb3ZlOiBmdW5jdGlvbiBfcmVtb3ZlKGF0dHJpYnV0ZSkgewogICAgICBpZiAoRW1iZXIuZ2V0KHRoaXMsICdpc0VtcHR5JykpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBjb250ZW50ID0gdGhpcy5yZWplY3RCeSgnYXR0cmlidXRlJywgYXR0cmlidXRlKTsKICAgICAgRW1iZXIuZ2V0KHRoaXMsICdjb250ZW50Jykuc2V0T2JqZWN0cyhjb250ZW50KTsKICAgICAgRW1iZXIuZ2V0KHRoaXMsICdlcnJvcnNCeUF0dHJpYnV0ZU5hbWUnKS5kZWxldGUoYXR0cmlidXRlKTsKICAgICAgdGhpcy5ub3RpZnlQcm9wZXJ0eUNoYW5nZShhdHRyaWJ1dGUpOwogICAgICB0aGlzLm5vdGlmeVByb3BlcnR5Q2hhbmdlKCdsZW5ndGgnKTsKICAgIH0sCgogICAgLyoqCiAgICAgTWFudWFsbHkgY2xlYXJzIGFsbCBlcnJvcnMgZm9yIHRoZSByZWNvcmQuCiAgICAgICBUaGlzIHdpbGwgdHJhbnNpdGlvbiB0aGUgcmVjb3JkIGludG8gYSBgdmFsaWRgIHN0YXRlLCBhbmQKICAgICAgIHdpbGwgdHJpZ2dlciB0aGUgYGJlY2FtZVZhbGlkYCBldmVudCBhbmQgbGlmZWN5Y2xlIG1ldGhvZC4KICAgICBFeGFtcGxlOgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgbGV0IGVycm9ycyA9IGdldCgndXNlcicsIGVycm9ycyk7CiAgICAgZXJyb3JzLmFkZCgndXNlcm5hbWUnLCBbJ2Vycm9yLWEnXSk7CiAgICAgZXJyb3JzLmFkZCgncGhvbmUnLCBbJ2Vycm9yLTEnLCAnZXJyb3ItMiddKTsKICAgICAgZXJyb3JzLmVycm9yc0ZvcigndXNlcm5hbWUnKTsKICAgICAvLyA9PgogICAgIC8vIFsKICAgICAvLyAgIHsgYXR0cmlidXRlOiAndXNlcm5hbWUnLCBtZXNzYWdlOiAnZXJyb3ItYScgfSwKICAgICAvLyBdCiAgICAgIGVycm9ycy5lcnJvcnNGb3IoJ3Bob25lJyk7CiAgICAgLy8gPT4KICAgICAvLyBbCiAgICAgLy8gICB7IGF0dHJpYnV0ZTogJ3Bob25lJywgbWVzc2FnZTogJ2Vycm9yLTEnIH0sCiAgICAgLy8gICB7IGF0dHJpYnV0ZTogJ3Bob25lJywgbWVzc2FnZTogJ2Vycm9yLTInIH0sCiAgICAgLy8gXQogICAgICBlcnJvcnMuY2xlYXIoKTsKICAgICAgZXJyb3JzLmVycm9yc0ZvcigndXNlcm5hbWUnKTsKICAgICAvLyA9PiB1bmRlZmluZWQKICAgICAgZXJyb3JzLmVycm9yc0ZvcigncGhvbmUnKTsKICAgICAvLyA9PiB1bmRlZmluZWQKICAgICAgZXJyb3JzLmdldCgnbWVzc2FnZXMnKQogICAgIC8vID0+IFtdCiAgICAgYGBgCiAgICAgQG1ldGhvZCByZW1vdmUKICAgICAqLwogICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICBpZiAoRW1iZXIuZ2V0KHRoaXMsICdpc0VtcHR5JykpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuX2NsZWFyKCk7CgogICAgICB0aGlzLl9yZWdpc3RlcmVkSGFuZGxlcnMgJiYgdGhpcy5fcmVnaXN0ZXJlZEhhbmRsZXJzLmJlY2FtZVZhbGlkKCk7CiAgICB9LAoKICAgIC8qKgogICAgICBSZW1vdmVzIGFsbCBlcnJvciBtZXNzYWdlcy4KICAgICAgdG8gdGhlIHJlY29yZC4KICAgICAgIEBtZXRob2QgX2NsZWFyCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgX2NsZWFyOiBmdW5jdGlvbiBfY2xlYXIoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBpZiAoRW1iZXIuZ2V0KHRoaXMsICdpc0VtcHR5JykpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBlcnJvcnNCeUF0dHJpYnV0ZU5hbWUgPSBFbWJlci5nZXQodGhpcywgJ2Vycm9yc0J5QXR0cmlidXRlTmFtZScpOwogICAgICB2YXIgYXR0cmlidXRlcyA9IFtdOwogICAgICBlcnJvcnNCeUF0dHJpYnV0ZU5hbWUuZm9yRWFjaChmdW5jdGlvbiAoXywgYXR0cmlidXRlKSB7CiAgICAgICAgYXR0cmlidXRlcy5wdXNoKGF0dHJpYnV0ZSk7CiAgICAgIH0pOwogICAgICBlcnJvcnNCeUF0dHJpYnV0ZU5hbWUuY2xlYXIoKTsKICAgICAgYXR0cmlidXRlcy5mb3JFYWNoKGZ1bmN0aW9uIChhdHRyaWJ1dGUpIHsKICAgICAgICBfdGhpcy5ub3RpZnlQcm9wZXJ0eUNoYW5nZShhdHRyaWJ1dGUpOwogICAgICB9KTsKICAgICAgRW1iZXIuQXJyYXlQcm94eS5wcm90b3R5cGUuY2xlYXIuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgLyoqCiAgICAgIENoZWNrcyBpZiB0aGVyZSBhcmUgZXJyb3IgbWVzc2FnZXMgZm9yIHRoZSBnaXZlbiBhdHRyaWJ1dGUuCiAgICAgICBgYGBhcHAvcm91dGVzL3VzZXIvZWRpdC5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgICBhY3Rpb25zOiB7CiAgICAgICAgICBzYXZlOiBmdW5jdGlvbih1c2VyKSB7CiAgICAgICAgICAgIGlmICh1c2VyLmdldCgnZXJyb3JzJykuaGFzKCdlbWFpbCcpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGFsZXJ0KCdQbGVhc2UgdXBkYXRlIHlvdXIgZW1haWwgYmVmb3JlIGF0dGVtcHRpbmcgdG8gc2F2ZS4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB1c2VyLnNhdmUoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgaGFzCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBhdHRyaWJ1dGUKICAgICAgQHJldHVybiB7Qm9vbGVhbn0gdHJ1ZSBpZiB0aGVyZSBzb21lIGVycm9ycyBvbiBnaXZlbiBhdHRyaWJ1dGUKICAgICovCiAgICBoYXM6IGZ1bmN0aW9uIGhhcyhhdHRyaWJ1dGUpIHsKICAgICAgcmV0dXJuIHRoaXMuZXJyb3JzRm9yKGF0dHJpYnV0ZSkubGVuZ3RoID4gMDsKICAgIH0KICB9KTsKCiAgdmFyIGNoYW5nZVByb3BlcnRpZXMgPSBFbWJlci5jaGFuZ2VQcm9wZXJ0aWVzOwoKICBmdW5jdGlvbiBpc0ludmFsaWRFcnJvcihlcnJvcikgewogICAgcmV0dXJuIGVycm9yICYmIGVycm9yLmlzQWRhcHRlckVycm9yID09PSB0cnVlICYmIGVycm9yLmNvZGUgPT09ICdJbnZhbGlkRXJyb3InOwogIH0KCiAgZnVuY3Rpb24gZmluZFBvc3NpYmxlSW52ZXJzZXModHlwZSwgaW52ZXJzZVR5cGUsIG5hbWUsIHJlbGF0aW9uc2hpcHNTb0ZhcikgewogICAgdmFyIHBvc3NpYmxlUmVsYXRpb25zaGlwcyA9IHJlbGF0aW9uc2hpcHNTb0ZhciB8fCBbXTsKICAgIHZhciByZWxhdGlvbnNoaXBNYXAgPSBFbWJlci5nZXQoaW52ZXJzZVR5cGUsICdyZWxhdGlvbnNoaXBzJyk7CgogICAgaWYgKCFyZWxhdGlvbnNoaXBNYXApIHsKICAgICAgcmV0dXJuIHBvc3NpYmxlUmVsYXRpb25zaGlwczsKICAgIH0KCiAgICB2YXIgcmVsYXRpb25zaGlwc0ZvclR5cGUgPSByZWxhdGlvbnNoaXBNYXAuZ2V0KHR5cGUubW9kZWxOYW1lKTsKICAgIHZhciByZWxhdGlvbnNoaXBzID0gQXJyYXkuaXNBcnJheShyZWxhdGlvbnNoaXBzRm9yVHlwZSkgPyByZWxhdGlvbnNoaXBzRm9yVHlwZS5maWx0ZXIoZnVuY3Rpb24gKHJlbGF0aW9uc2hpcCkgewogICAgICB2YXIgb3B0aW9uc0ZvclJlbGF0aW9uc2hpcCA9IGludmVyc2VUeXBlLm1ldGFGb3JQcm9wZXJ0eShyZWxhdGlvbnNoaXAubmFtZSkub3B0aW9uczsKCiAgICAgIGlmICghb3B0aW9uc0ZvclJlbGF0aW9uc2hpcC5pbnZlcnNlICYmIG9wdGlvbnNGb3JSZWxhdGlvbnNoaXAuaW52ZXJzZSAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICByZXR1cm4gbmFtZSA9PT0gb3B0aW9uc0ZvclJlbGF0aW9uc2hpcC5pbnZlcnNlOwogICAgfSkgOiBudWxsOwoKICAgIGlmIChyZWxhdGlvbnNoaXBzKSB7CiAgICAgIHBvc3NpYmxlUmVsYXRpb25zaGlwcy5wdXNoLmFwcGx5KHBvc3NpYmxlUmVsYXRpb25zaGlwcywgcmVsYXRpb25zaGlwcyk7CiAgICB9IC8vUmVjdXJzZSB0byBzdXBwb3J0IHBvbHltb3JwaGlzbQoKCiAgICBpZiAodHlwZS5zdXBlcmNsYXNzKSB7CiAgICAgIGZpbmRQb3NzaWJsZUludmVyc2VzKHR5cGUuc3VwZXJjbGFzcywgaW52ZXJzZVR5cGUsIG5hbWUsIHBvc3NpYmxlUmVsYXRpb25zaGlwcyk7CiAgICB9CgogICAgcmV0dXJuIHBvc3NpYmxlUmVsYXRpb25zaGlwczsKICB9CgogIHZhciByZXRyaWV2ZUZyb21DdXJyZW50U3RhdGUgPSBFbWJlci5jb21wdXRlZCgnY3VycmVudFN0YXRlJywgZnVuY3Rpb24gKGtleSkgewogICAgcmV0dXJuIEVtYmVyLmdldCh0aGlzLl9pbnRlcm5hbE1vZGVsLmN1cnJlbnRTdGF0ZSwga2V5KTsKICB9KS5yZWFkT25seSgpOwogIHZhciBpc1ZhbGlkUmVjb3JkRGF0YSA9IEVtYmVyLmNvbXB1dGVkKCdlcnJvcnMubGVuZ3RoJywgZnVuY3Rpb24gKGtleSkgewogICAgcmV0dXJuICEodGhpcy5nZXQoJ2Vycm9ycy5sZW5ndGgnKSA+IDApOwogIH0pLnJlYWRPbmx5KCk7CiAgdmFyIGlzVmFsaWQgPSBjYW5hcnlGZWF0dXJlcy5SRUNPUkRfREFUQV9FUlJPUlMgPyBpc1ZhbGlkUmVjb3JkRGF0YSA6IHJldHJpZXZlRnJvbUN1cnJlbnRTdGF0ZTsKICB2YXIgaXNEZWxldGVkQ1A7CgogIGlmIChjYW5hcnlGZWF0dXJlcy5SRUNPUkRfREFUQV9TVEFURSkgewogICAgaXNEZWxldGVkQ1AgPSBFbWJlci5jb21wdXRlZCgnY3VycmVudFN0YXRlJywgZnVuY3Rpb24gKCkgewogICAgICB2YXIgcmQgPSBQcml2YXRlLnJlY29yZERhdGFGb3IodGhpcyk7CgogICAgICBpZiAocmQuaXNEZWxldGVkKSB7CiAgICAgICAgcmV0dXJuIHJkLmlzRGVsZXRlZCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBFbWJlci5nZXQodGhpcy5faW50ZXJuYWxNb2RlbC5jdXJyZW50U3RhdGUsICdpc0RlbGV0ZWQnKTsKICAgICAgfQogICAgfSkucmVhZE9ubHkoKTsKICB9IGVsc2UgewogICAgaXNEZWxldGVkQ1AgPSByZXRyaWV2ZUZyb21DdXJyZW50U3RhdGU7CiAgfQoKICB2YXIgaXNOZXdDUDsKCiAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFQ09SRF9EQVRBX1NUQVRFKSB7CiAgICBpc05ld0NQID0gRW1iZXIuY29tcHV0ZWQoJ2N1cnJlbnRTdGF0ZScsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHJkID0gUHJpdmF0ZS5yZWNvcmREYXRhRm9yKHRoaXMpOwoKICAgICAgaWYgKHJkLmlzTmV3KSB7CiAgICAgICAgcmV0dXJuIHJkLmlzTmV3KCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIEVtYmVyLmdldCh0aGlzLl9pbnRlcm5hbE1vZGVsLmN1cnJlbnRTdGF0ZSwgJ2lzTmV3Jyk7CiAgICAgIH0KICAgIH0pLnJlYWRPbmx5KCk7CiAgfSBlbHNlIHsKICAgIGlzTmV3Q1AgPSByZXRyaWV2ZUZyb21DdXJyZW50U3RhdGU7CiAgfQoKICB2YXIgYWRhcHRlckVycm9yOwoKICBpZiAoY2FuYXJ5RmVhdHVyZXMuUkVRVUVTVF9TRVJWSUNFKSB7CiAgICBhZGFwdGVyRXJyb3IgPSBFbWJlci5jb21wdXRlZChmdW5jdGlvbiAoKSB7CiAgICAgIHZhciByZXF1ZXN0ID0gdGhpcy5fbGFzdEVycm9yOwoKICAgICAgaWYgKCFyZXF1ZXN0KSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXF1ZXN0LnN0YXRlID09PSAncmVqZWN0ZWQnICYmIHJlcXVlc3QucmVzcG9uc2UuZGF0YTsKICAgIH0pOwogIH0gZWxzZSB7CiAgICBhZGFwdGVyRXJyb3IgPSBudWxsOwogIH0KCiAgdmFyIGlzRXJyb3I7CgogIGlmIChjYW5hcnlGZWF0dXJlcy5SRVFVRVNUX1NFUlZJQ0UpIHsKICAgIGlzRXJyb3IgPSBFbWJlci5jb21wdXRlZChmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBlcnJvclJlcSA9IHRoaXMuX2Vycm9yUmVxdWVzdHNbdGhpcy5fZXJyb3JSZXF1ZXN0cy5sZW5ndGggLSAxXTsKCiAgICAgIGlmICghZXJyb3JSZXEpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0pOwogIH0gZWxzZSB7CiAgICBpc0Vycm9yID0gZmFsc2U7CiAgfQoKICB2YXIgaXNSZWxvYWRpbmc7CgogIGlmIChjYW5hcnlGZWF0dXJlcy5SRVFVRVNUX1NFUlZJQ0UpIHsKICAgIGlzUmVsb2FkaW5nID0gRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24gKCkgewogICAgICB2YXIgcmVxdWVzdHMgPSB0aGlzLnN0b3JlLmdldFJlcXVlc3RTdGF0ZVNlcnZpY2UoKS5nZXRQZW5kaW5nUmVxdWVzdHNGb3JSZWNvcmQoUHJpdmF0ZS5yZWNvcmRJZGVudGlmaWVyRm9yKHRoaXMpKTsKICAgICAgcmV0dXJuICEhcmVxdWVzdHMuZmluZChmdW5jdGlvbiAocmVxKSB7CiAgICAgICAgcmV0dXJuIHJlcS5yZXF1ZXN0LmRhdGFbMF0ub3B0aW9ucy5pc1JlbG9hZGluZzsKICAgICAgfSk7CiAgICB9KTsKICB9IGVsc2UgewogICAgaXNSZWxvYWRpbmcgPSBmYWxzZTsKICB9CiAgLyoqCiAgICBAY2xhc3MgTW9kZWwKICAgIEBtb2R1bGUgQGVtYmVyLWRhdGEvbW9kZWwKICAgIEBleHRlbmRzIEVtYmVyT2JqZWN0CiAgICBAdXNlcyBFbWJlckRhdGEuRGVwcmVjYXRlZEV2ZW50ZWQKICAqLwoKCiAgdmFyIE1vZGVsID0gRW1iZXIuT2JqZWN0LmV4dGVuZChQcml2YXRlLkRlcHJlY2F0ZWRFdmVudGVkLCB7CiAgICBpbml0OiBmdW5jdGlvbiBpbml0KCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5SRUNPUkRfREFUQV9FUlJPUlMpIHsKICAgICAgICB0aGlzLl9pbnZhbGlkUmVxdWVzdHMgPSBbXTsKICAgICAgfQoKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFUVVFU1RfU0VSVklDRSkgewogICAgICAgIHRoaXMuc3RvcmUuZ2V0UmVxdWVzdFN0YXRlU2VydmljZSgpLnN1YnNjcmliZUZvclJlY29yZCh0aGlzLl9pbnRlcm5hbE1vZGVsLmlkZW50aWZpZXIsIGZ1bmN0aW9uIChyZXF1ZXN0KSB7CiAgICAgICAgICBpZiAocmVxdWVzdC5zdGF0ZSA9PT0gJ3JlamVjdGVkJykgewogICAgICAgICAgICAvLyBUT0RPIGZpbHRlciBvdXQgcXVlcmllcwogICAgICAgICAgICBfdGhpcy5fbGFzdEVycm9yID0gcmVxdWVzdDsKCiAgICAgICAgICAgIGlmICghKHJlcXVlc3QucmVzcG9uc2UgJiYgaXNJbnZhbGlkRXJyb3IocmVxdWVzdC5yZXNwb25zZS5kYXRhKSkpIHsKICAgICAgICAgICAgICBfdGhpcy5fZXJyb3JSZXF1ZXN0cy5wdXNoKHJlcXVlc3QpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIF90aGlzLl9pbnZhbGlkUmVxdWVzdHMucHVzaChyZXF1ZXN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChyZXF1ZXN0LnN0YXRlID09PSAnZnVsZmlsbGVkJykgewogICAgICAgICAgICBfdGhpcy5faW52YWxpZFJlcXVlc3RzID0gW107CiAgICAgICAgICAgIF90aGlzLl9lcnJvclJlcXVlc3RzID0gW107CiAgICAgICAgICAgIF90aGlzLl9sYXN0RXJyb3IgPSBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIF90aGlzLl9ub3RpZnlOZXR3b3JrQ2hhbmdlcygpOwogICAgICAgIH0pOwogICAgICAgIHRoaXMuX2Vycm9yUmVxdWVzdHMgPSBbXTsKICAgICAgICB0aGlzLl9sYXN0RXJyb3IgPSBudWxsOwogICAgICB9CiAgICB9LAogICAgX25vdGlmeU5ldHdvcmtDaGFuZ2VzOiBmdW5jdGlvbiBfbm90aWZ5TmV0d29ya0NoYW5nZXMoKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFUVVFU1RfU0VSVklDRSkgewogICAgICAgIFsnaXNTYXZpbmcnLCAnaXNWYWxpZCcsICdpc0Vycm9yJywgJ2FkYXB0ZXJFcnJvcicsICdpc1JlbG9hZGluZyddLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgcmV0dXJuIF90aGlzMi5ub3RpZnlQcm9wZXJ0eUNoYW5nZShrZXkpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIFsnaXNWYWxpZCddLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgcmV0dXJuIF90aGlzMi5ub3RpZnlQcm9wZXJ0eUNoYW5nZShrZXkpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBJZiB0aGlzIHByb3BlcnR5IGlzIGB0cnVlYCB0aGUgcmVjb3JkIGlzIGluIHRoZSBgZW1wdHlgCiAgICAgIHN0YXRlLiBFbXB0eSBpcyB0aGUgZmlyc3Qgc3RhdGUgYWxsIHJlY29yZHMgZW50ZXIgYWZ0ZXIgdGhleSBoYXZlCiAgICAgIGJlZW4gY3JlYXRlZC4gTW9zdCByZWNvcmRzIGNyZWF0ZWQgYnkgdGhlIHN0b3JlIHdpbGwgcXVpY2tseQogICAgICB0cmFuc2l0aW9uIHRvIHRoZSBgbG9hZGluZ2Agc3RhdGUgaWYgZGF0YSBuZWVkcyB0byBiZSBmZXRjaGVkIGZyb20KICAgICAgdGhlIHNlcnZlciBvciB0aGUgYGNyZWF0ZWRgIHN0YXRlIGlmIHRoZSByZWNvcmQgaXMgY3JlYXRlZCBvbiB0aGUKICAgICAgY2xpZW50LiBBIHJlY29yZCBjYW4gYWxzbyBlbnRlciB0aGUgZW1wdHkgc3RhdGUgaWYgdGhlIGFkYXB0ZXIgaXMKICAgICAgdW5hYmxlIHRvIGxvY2F0ZSB0aGUgcmVjb3JkLgogICAgICAgQHByb3BlcnR5IGlzRW1wdHkKICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgIEByZWFkT25seQogICAgKi8KICAgIGlzRW1wdHk6IHJldHJpZXZlRnJvbUN1cnJlbnRTdGF0ZSwKCiAgICAvKioKICAgICAgSWYgdGhpcyBwcm9wZXJ0eSBpcyBgdHJ1ZWAgdGhlIHJlY29yZCBpcyBpbiB0aGUgYGxvYWRpbmdgIHN0YXRlLiBBCiAgICAgIHJlY29yZCBlbnRlcnMgdGhpcyBzdGF0ZSB3aGVuIHRoZSBzdG9yZSBhc2tzIHRoZSBhZGFwdGVyIGZvciBpdHMKICAgICAgZGF0YS4gSXQgcmVtYWlucyBpbiB0aGlzIHN0YXRlIHVudGlsIHRoZSBhZGFwdGVyIHByb3ZpZGVzIHRoZQogICAgICByZXF1ZXN0ZWQgZGF0YS4KICAgICAgIEBwcm9wZXJ0eSBpc0xvYWRpbmcKICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgIEByZWFkT25seQogICAgKi8KICAgIGlzTG9hZGluZzogcmV0cmlldmVGcm9tQ3VycmVudFN0YXRlLAoKICAgIC8qKgogICAgICBJZiB0aGlzIHByb3BlcnR5IGlzIGB0cnVlYCB0aGUgcmVjb3JkIGlzIGluIHRoZSBgbG9hZGVkYCBzdGF0ZS4gQQogICAgICByZWNvcmQgZW50ZXJzIHRoaXMgc3RhdGUgd2hlbiBpdHMgZGF0YSBpcyBwb3B1bGF0ZWQuIE1vc3Qgb2YgYQogICAgICByZWNvcmQncyBsaWZlY3ljbGUgaXMgc3BlbnQgaW5zaWRlIHN1YnN0YXRlcyBvZiB0aGUgYGxvYWRlZGAKICAgICAgc3RhdGUuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGxldCByZWNvcmQgPSBzdG9yZS5jcmVhdGVSZWNvcmQoJ21vZGVsJyk7CiAgICAgIHJlY29yZC5nZXQoJ2lzTG9hZGVkJyk7IC8vIHRydWUKICAgICAgIHN0b3JlLmZpbmRSZWNvcmQoJ21vZGVsJywgMSkudGhlbihmdW5jdGlvbihtb2RlbCkgewogICAgICAgIG1vZGVsLmdldCgnaXNMb2FkZWQnKTsgLy8gdHJ1ZQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAcHJvcGVydHkgaXNMb2FkZWQKICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgIEByZWFkT25seQogICAgKi8KICAgIGlzTG9hZGVkOiByZXRyaWV2ZUZyb21DdXJyZW50U3RhdGUsCgogICAgLyoqCiAgICAgIElmIHRoaXMgcHJvcGVydHkgaXMgYHRydWVgIHRoZSByZWNvcmQgaXMgaW4gdGhlIGBkaXJ0eWAgc3RhdGUuIFRoZQogICAgICByZWNvcmQgaGFzIGxvY2FsIGNoYW5nZXMgdGhhdCBoYXZlIG5vdCB5ZXQgYmVlbiBzYXZlZCBieSB0aGUKICAgICAgYWRhcHRlci4gVGhpcyBpbmNsdWRlcyByZWNvcmRzIHRoYXQgaGF2ZSBiZWVuIGNyZWF0ZWQgKGJ1dCBub3QgeWV0CiAgICAgIHNhdmVkKSBvciBkZWxldGVkLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBsZXQgcmVjb3JkID0gc3RvcmUuY3JlYXRlUmVjb3JkKCdtb2RlbCcpOwogICAgICByZWNvcmQuZ2V0KCdoYXNEaXJ0eUF0dHJpYnV0ZXMnKTsgLy8gdHJ1ZQogICAgICAgc3RvcmUuZmluZFJlY29yZCgnbW9kZWwnLCAxKS50aGVuKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgbW9kZWwuZ2V0KCdoYXNEaXJ0eUF0dHJpYnV0ZXMnKTsgLy8gZmFsc2UKICAgICAgICBtb2RlbC5zZXQoJ2ZvbycsICdzb21lIHZhbHVlJyk7CiAgICAgICAgbW9kZWwuZ2V0KCdoYXNEaXJ0eUF0dHJpYnV0ZXMnKTsgLy8gdHJ1ZQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAc2luY2UgMS4xMy4wCiAgICAgIEBwcm9wZXJ0eSBoYXNEaXJ0eUF0dHJpYnV0ZXMKICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgIEByZWFkT25seQogICAgKi8KICAgIGhhc0RpcnR5QXR0cmlidXRlczogRW1iZXIuY29tcHV0ZWQoJ2N1cnJlbnRTdGF0ZS5pc0RpcnR5JywgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5nZXQoJ2N1cnJlbnRTdGF0ZS5pc0RpcnR5Jyk7CiAgICB9KSwKCiAgICAvKioKICAgICAgSWYgdGhpcyBwcm9wZXJ0eSBpcyBgdHJ1ZWAgdGhlIHJlY29yZCBpcyBpbiB0aGUgYHNhdmluZ2Agc3RhdGUuIEEKICAgICAgcmVjb3JkIGVudGVycyB0aGUgc2F2aW5nIHN0YXRlIHdoZW4gYHNhdmVgIGlzIGNhbGxlZCwgYnV0IHRoZQogICAgICBhZGFwdGVyIGhhcyBub3QgeWV0IGFja25vd2xlZGdlZCB0aGF0IHRoZSBjaGFuZ2VzIGhhdmUgYmVlbgogICAgICBwZXJzaXN0ZWQgdG8gdGhlIGJhY2tlbmQuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGxldCByZWNvcmQgPSBzdG9yZS5jcmVhdGVSZWNvcmQoJ21vZGVsJyk7CiAgICAgIHJlY29yZC5nZXQoJ2lzU2F2aW5nJyk7IC8vIGZhbHNlCiAgICAgIGxldCBwcm9taXNlID0gcmVjb3JkLnNhdmUoKTsKICAgICAgcmVjb3JkLmdldCgnaXNTYXZpbmcnKTsgLy8gdHJ1ZQogICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgcmVjb3JkLmdldCgnaXNTYXZpbmcnKTsgLy8gZmFsc2UKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQHByb3BlcnR5IGlzU2F2aW5nCiAgICAgIEB0eXBlIHtCb29sZWFufQogICAgICBAcmVhZE9ubHkKICAgICovCiAgICBpc1NhdmluZzogcmV0cmlldmVGcm9tQ3VycmVudFN0YXRlLAoKICAgIC8qKgogICAgICBJZiB0aGlzIHByb3BlcnR5IGlzIGB0cnVlYCB0aGUgcmVjb3JkIGlzIGluIHRoZSBgZGVsZXRlZGAgc3RhdGUKICAgICAgYW5kIGhhcyBiZWVuIG1hcmtlZCBmb3IgZGVsZXRpb24uIFdoZW4gYGlzRGVsZXRlZGAgaXMgdHJ1ZSBhbmQKICAgICAgYGhhc0RpcnR5QXR0cmlidXRlc2AgaXMgdHJ1ZSwgdGhlIHJlY29yZCBpcyBkZWxldGVkIGxvY2FsbHkgYnV0IHRoZSBkZWxldGlvbgogICAgICB3YXMgbm90IHlldCBwZXJzaXN0ZWQuIFdoZW4gYGlzU2F2aW5nYCBpcyB0cnVlLCB0aGUgY2hhbmdlIGlzCiAgICAgIGluLWZsaWdodC4gV2hlbiBib3RoIGBoYXNEaXJ0eUF0dHJpYnV0ZXNgIGFuZCBgaXNTYXZpbmdgIGFyZSBmYWxzZSwgdGhlCiAgICAgIGNoYW5nZSBoYXMgcGVyc2lzdGVkLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBsZXQgcmVjb3JkID0gc3RvcmUuY3JlYXRlUmVjb3JkKCdtb2RlbCcpOwogICAgICByZWNvcmQuZ2V0KCdpc0RlbGV0ZWQnKTsgICAgLy8gZmFsc2UKICAgICAgcmVjb3JkLmRlbGV0ZVJlY29yZCgpOwogICAgICAgLy8gTG9jYWxseSBkZWxldGVkCiAgICAgIHJlY29yZC5nZXQoJ2lzRGVsZXRlZCcpOyAgICAgICAgICAgLy8gdHJ1ZQogICAgICByZWNvcmQuZ2V0KCdoYXNEaXJ0eUF0dHJpYnV0ZXMnKTsgIC8vIHRydWUKICAgICAgcmVjb3JkLmdldCgnaXNTYXZpbmcnKTsgICAgICAgICAgICAvLyBmYWxzZQogICAgICAgLy8gUGVyc2lzdGluZyB0aGUgZGVsZXRpb24KICAgICAgbGV0IHByb21pc2UgPSByZWNvcmQuc2F2ZSgpOwogICAgICByZWNvcmQuZ2V0KCdpc0RlbGV0ZWQnKTsgICAgLy8gdHJ1ZQogICAgICByZWNvcmQuZ2V0KCdpc1NhdmluZycpOyAgICAgLy8gdHJ1ZQogICAgICAgLy8gRGVsZXRpb24gUGVyc2lzdGVkCiAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbigpIHsKICAgICAgICByZWNvcmQuZ2V0KCdpc0RlbGV0ZWQnKTsgICAgICAgICAgLy8gdHJ1ZQogICAgICAgIHJlY29yZC5nZXQoJ2lzU2F2aW5nJyk7ICAgICAgICAgICAvLyBmYWxzZQogICAgICAgIHJlY29yZC5nZXQoJ2hhc0RpcnR5QXR0cmlidXRlcycpOyAvLyBmYWxzZQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAcHJvcGVydHkgaXNEZWxldGVkCiAgICAgIEB0eXBlIHtCb29sZWFufQogICAgICBAcmVhZE9ubHkKICAgICovCiAgICBpc0RlbGV0ZWQ6IGlzRGVsZXRlZENQLAoKICAgIC8qKgogICAgICBJZiB0aGlzIHByb3BlcnR5IGlzIGB0cnVlYCB0aGUgcmVjb3JkIGlzIGluIHRoZSBgbmV3YCBzdGF0ZS4gQQogICAgICByZWNvcmQgd2lsbCBiZSBpbiB0aGUgYG5ld2Agc3RhdGUgd2hlbiBpdCBoYXMgYmVlbiBjcmVhdGVkIG9uIHRoZQogICAgICBjbGllbnQgYW5kIHRoZSBhZGFwdGVyIGhhcyBub3QgeWV0IHJlcG9ydCB0aGF0IGl0IHdhcyBzdWNjZXNzZnVsbHkKICAgICAgc2F2ZWQuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGxldCByZWNvcmQgPSBzdG9yZS5jcmVhdGVSZWNvcmQoJ21vZGVsJyk7CiAgICAgIHJlY29yZC5nZXQoJ2lzTmV3Jyk7IC8vIHRydWUKICAgICAgIHJlY29yZC5zYXZlKCkudGhlbihmdW5jdGlvbihtb2RlbCkgewogICAgICAgIG1vZGVsLmdldCgnaXNOZXcnKTsgLy8gZmFsc2UKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQHByb3BlcnR5IGlzTmV3CiAgICAgIEB0eXBlIHtCb29sZWFufQogICAgICBAcmVhZE9ubHkKICAgICovCiAgICBpc05ldzogaXNOZXdDUCwKCiAgICAvKioKICAgICAgSWYgdGhpcyBwcm9wZXJ0eSBpcyBgdHJ1ZWAgdGhlIHJlY29yZCBpcyBpbiB0aGUgYHZhbGlkYCBzdGF0ZS4KICAgICAgIEEgcmVjb3JkIHdpbGwgYmUgaW4gdGhlIGB2YWxpZGAgc3RhdGUgd2hlbiB0aGUgYWRhcHRlciBkaWQgbm90IHJlcG9ydCBhbnkKICAgICAgc2VydmVyLXNpZGUgdmFsaWRhdGlvbiBmYWlsdXJlcy4KICAgICAgIEBwcm9wZXJ0eSBpc1ZhbGlkCiAgICAgIEB0eXBlIHtCb29sZWFufQogICAgICBAcmVhZE9ubHkKICAgICovCiAgICBpc1ZhbGlkOiBpc1ZhbGlkLAogICAgX21hcmtJbnZhbGlkUmVxdWVzdEFzQ2xlYW46IGZ1bmN0aW9uIF9tYXJrSW52YWxpZFJlcXVlc3RBc0NsZWFuKCkgewogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuUkVDT1JEX0RBVEFfRVJST1JTKSB7CiAgICAgICAgdGhpcy5faW52YWxpZFJlcXVlc3RzID0gW107CgogICAgICAgIHRoaXMuX25vdGlmeU5ldHdvcmtDaGFuZ2VzKCk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgIElmIHRoZSByZWNvcmQgaXMgaW4gdGhlIGRpcnR5IHN0YXRlIHRoaXMgcHJvcGVydHkgd2lsbCByZXBvcnQgd2hhdAogICAgICBraW5kIG9mIGNoYW5nZSBoYXMgY2F1c2VkIGl0IHRvIG1vdmUgaW50byB0aGUgZGlydHkKICAgICAgc3RhdGUuIFBvc3NpYmxlIHZhbHVlcyBhcmU6CiAgICAgICAtIGBjcmVhdGVkYCBUaGUgcmVjb3JkIGhhcyBiZWVuIGNyZWF0ZWQgYnkgdGhlIGNsaWVudCBhbmQgbm90IHlldCBzYXZlZCB0byB0aGUgYWRhcHRlci4KICAgICAgLSBgdXBkYXRlZGAgVGhlIHJlY29yZCBoYXMgYmVlbiB1cGRhdGVkIGJ5IHRoZSBjbGllbnQgYW5kIG5vdCB5ZXQgc2F2ZWQgdG8gdGhlIGFkYXB0ZXIuCiAgICAgIC0gYGRlbGV0ZWRgIFRoZSByZWNvcmQgaGFzIGJlZW4gZGVsZXRlZCBieSB0aGUgY2xpZW50IGFuZCBub3QgeWV0IHNhdmVkIHRvIHRoZSBhZGFwdGVyLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBsZXQgcmVjb3JkID0gc3RvcmUuY3JlYXRlUmVjb3JkKCdtb2RlbCcpOwogICAgICByZWNvcmQuZ2V0KCdkaXJ0eVR5cGUnKTsgLy8gJ2NyZWF0ZWQnCiAgICAgIGBgYAogICAgICAgQHByb3BlcnR5IGRpcnR5VHlwZQogICAgICBAdHlwZSB7U3RyaW5nfQogICAgICBAcmVhZE9ubHkKICAgICovCiAgICBkaXJ0eVR5cGU6IHJldHJpZXZlRnJvbUN1cnJlbnRTdGF0ZSwKCiAgICAvKioKICAgICAgSWYgYHRydWVgIHRoZSBhZGFwdGVyIHJlcG9ydGVkIHRoYXQgaXQgd2FzIHVuYWJsZSB0byBzYXZlIGxvY2FsCiAgICAgIGNoYW5nZXMgdG8gdGhlIGJhY2tlbmQgZm9yIGFueSByZWFzb24gb3RoZXIgdGhhbiBhIHNlcnZlci1zaWRlCiAgICAgIHZhbGlkYXRpb24gZXJyb3IuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHJlY29yZC5nZXQoJ2lzRXJyb3InKTsgLy8gZmFsc2UKICAgICAgcmVjb3JkLnNldCgnZm9vJywgJ3ZhbGlkIHZhbHVlJyk7CiAgICAgIHJlY29yZC5zYXZlKCkudGhlbihudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICByZWNvcmQuZ2V0KCdpc0Vycm9yJyk7IC8vIHRydWUKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQHByb3BlcnR5IGlzRXJyb3IKICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgIEByZWFkT25seQogICAgKi8KICAgIGlzRXJyb3I6IGlzRXJyb3IsCiAgICBfbWFya0Vycm9yUmVxdWVzdEFzQ2xlYW46IGZ1bmN0aW9uIF9tYXJrRXJyb3JSZXF1ZXN0QXNDbGVhbigpIHsKICAgICAgdGhpcy5fZXJyb3JSZXF1ZXN0cyA9IFtdOwogICAgICB0aGlzLl9sYXN0RXJyb3IgPSBudWxsOwoKICAgICAgdGhpcy5fbm90aWZ5TmV0d29ya0NoYW5nZXMoKTsKICAgIH0sCgogICAgLyoqCiAgICAgIElmIGB0cnVlYCB0aGUgc3RvcmUgaXMgYXR0ZW1wdGluZyB0byByZWxvYWQgdGhlIHJlY29yZCBmcm9tIHRoZSBhZGFwdGVyLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgamF2YXNjcmlwdAogICAgICByZWNvcmQuZ2V0KCdpc1JlbG9hZGluZycpOyAvLyBmYWxzZQogICAgICByZWNvcmQucmVsb2FkKCk7CiAgICAgIHJlY29yZC5nZXQoJ2lzUmVsb2FkaW5nJyk7IC8vIHRydWUKICAgICAgYGBgCiAgICAgICBAcHJvcGVydHkgaXNSZWxvYWRpbmcKICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgIEByZWFkT25seQogICAgKi8KICAgIGlzUmVsb2FkaW5nOiBpc1JlbG9hZGluZywKCiAgICAvKioKICAgICAgQWxsIGVtYmVyIG1vZGVscyBoYXZlIGFuIGlkIHByb3BlcnR5LiBUaGlzIGlzIGFuIGlkZW50aWZpZXIKICAgICAgbWFuYWdlZCBieSBhbiBleHRlcm5hbCBzb3VyY2UuIFRoZXNlIGFyZSBhbHdheXMgY29lcmNlZCB0byBiZQogICAgICBzdHJpbmdzIGJlZm9yZSBiZWluZyB1c2VkIGludGVybmFsbHkuIE5vdGUgd2hlbiBkZWNsYXJpbmcgdGhlCiAgICAgIGF0dHJpYnV0ZXMgZm9yIGEgbW9kZWwgaXQgaXMgYW4gZXJyb3IgdG8gZGVjbGFyZSBhbiBpZAogICAgICBhdHRyaWJ1dGUuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGxldCByZWNvcmQgPSBzdG9yZS5jcmVhdGVSZWNvcmQoJ21vZGVsJyk7CiAgICAgIHJlY29yZC5nZXQoJ2lkJyk7IC8vIG51bGwKICAgICAgIHN0b3JlLmZpbmRSZWNvcmQoJ21vZGVsJywgMSkudGhlbihmdW5jdGlvbihtb2RlbCkgewogICAgICAgIG1vZGVsLmdldCgnaWQnKTsgLy8gJzEnCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBwcm9wZXJ0eSBpZAogICAgICBAdHlwZSB7U3RyaW5nfQogICAgKi8KCiAgICAvKioKICAgICAgQHByb3BlcnR5IGN1cnJlbnRTdGF0ZQogICAgICBAcHJpdmF0ZQogICAgICBAdHlwZSB7T2JqZWN0fQogICAgKi8KICAgIGN1cnJlbnRTdGF0ZTogUHJpdmF0ZS5Sb290U3RhdGUuZW1wdHksCiAgICAvLyBkZWZpbmVkIGhlcmUgdG8gYXZvaWQgdHJpZ2dlcmluZyBzZXRVbmtub3duUHJvcGVydHkKCiAgICAvKioKICAgICBAcHJvcGVydHkgX2ludGVybmFsTW9kZWwKICAgICBAcHJpdmF0ZQogICAgIEB0eXBlIHtPYmplY3R9CiAgICAgKi8KICAgIF9pbnRlcm5hbE1vZGVsOiBudWxsLAogICAgLy8gZGVmaW5lZCBoZXJlIHRvIGF2b2lkIHRyaWdnZXJpbmcgc2V0VW5rbm93blByb3BlcnR5CgogICAgLyoqCiAgICAgQHByb3BlcnR5IHJlY29yZERhdGEKICAgICBAcHJpdmF0ZQogICAgIEB0eXBlIHVuZGVmaW5lZCAocmVzZXJ2ZWQpCiAgICAgKi8KICAgIC8vIHdpbGwgYmUgZGVmaW5lZCBoZXJlIHRvIGF2b2lkIHRyaWdnZXJpbmcgc2V0VW5rbm93blByb3BlcnR5CgogICAgLyoqCiAgICAgQHByb3BlcnR5IHN0b3JlCiAgICAgKi8KICAgIHN0b3JlOiBudWxsLAogICAgLy8gZGVmaW5lZCBoZXJlIHRvIGF2b2lkIHRyaWdnZXJpbmcgc2V0VW5rbm93blByb3BlcnR5CgogICAgLyoqCiAgICAgIFdoZW4gdGhlIHJlY29yZCBpcyBpbiB0aGUgYGludmFsaWRgIHN0YXRlIHRoaXMgb2JqZWN0IHdpbGwgY29udGFpbgogICAgICBhbnkgZXJyb3JzIHJldHVybmVkIGJ5IHRoZSBhZGFwdGVyLiBXaGVuIHByZXNlbnQgdGhlIGVycm9ycyBoYXNoCiAgICAgIGNvbnRhaW5zIGtleXMgY29ycmVzcG9uZGluZyB0byB0aGUgaW52YWxpZCBwcm9wZXJ0eSBuYW1lcwogICAgICBhbmQgdmFsdWVzIHdoaWNoIGFyZSBhcnJheXMgb2YgSmF2YXNjcmlwdCBvYmplY3RzIHdpdGggdHdvIGtleXM6CiAgICAgICAtIGBtZXNzYWdlYCBBIHN0cmluZyBjb250YWluaW5nIHRoZSBlcnJvciBtZXNzYWdlIGZyb20gdGhlIGJhY2tlbmQKICAgICAgLSBgYXR0cmlidXRlYCBUaGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgYXNzb2NpYXRlZCB3aXRoIHRoaXMgZXJyb3IgbWVzc2FnZQogICAgICAgYGBgamF2YXNjcmlwdAogICAgICByZWNvcmQuZ2V0KCdlcnJvcnMubGVuZ3RoJyk7IC8vIDAKICAgICAgcmVjb3JkLnNldCgnZm9vJywgJ2ludmFsaWQgdmFsdWUnKTsKICAgICAgcmVjb3JkLnNhdmUoKS5jYXRjaChmdW5jdGlvbigpIHsKICAgICAgICByZWNvcmQuZ2V0KCdlcnJvcnMnKS5nZXQoJ2ZvbycpOwogICAgICAgIC8vIFt7bWVzc2FnZTogJ2ZvbyBzaG91bGQgYmUgYSBudW1iZXIuJywgYXR0cmlidXRlOiAnZm9vJ31dCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFRoZSBgZXJyb3JzYCBwcm9wZXJ0eSB1cyB1c2VmdWwgZm9yIGRpc3BsYXlpbmcgZXJyb3IgbWVzc2FnZXMgdG8KICAgICAgdGhlIHVzZXIuCiAgICAgICBgYGBoYW5kbGViYXJzCiAgICAgIDxsYWJlbD5Vc2VybmFtZToge3tpbnB1dCB2YWx1ZT11c2VybmFtZX19IDwvbGFiZWw+CiAgICAgIHt7I2VhY2ggbW9kZWwuZXJyb3JzLnVzZXJuYW1lIGFzIHxlcnJvcnx9fQogICAgICAgIDxkaXYgY2xhc3M9ImVycm9yIj4KICAgICAgICAgIHt7ZXJyb3IubWVzc2FnZX19CiAgICAgICAgPC9kaXY+CiAgICAgIHt7L2VhY2h9fQogICAgICA8bGFiZWw+RW1haWw6IHt7aW5wdXQgdmFsdWU9ZW1haWx9fSA8L2xhYmVsPgogICAgICB7eyNlYWNoIG1vZGVsLmVycm9ycy5lbWFpbCBhcyB8ZXJyb3J8fX0KICAgICAgICA8ZGl2IGNsYXNzPSJlcnJvciI+CiAgICAgICAgICB7e2Vycm9yLm1lc3NhZ2V9fQogICAgICAgIDwvZGl2PgogICAgICB7ey9lYWNofX0KICAgICAgYGBgCiAgICAgICAgWW91IGNhbiBhbHNvIGFjY2VzcyB0aGUgc3BlY2lhbCBgbWVzc2FnZXNgIHByb3BlcnR5IG9uIHRoZSBlcnJvcgogICAgICBvYmplY3QgdG8gZ2V0IGFuIGFycmF5IG9mIGFsbCB0aGUgZXJyb3Igc3RyaW5ncy4KICAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3sjZWFjaCBtb2RlbC5lcnJvcnMubWVzc2FnZXMgYXMgfG1lc3NhZ2V8fX0KICAgICAgICA8ZGl2IGNsYXNzPSJlcnJvciI+CiAgICAgICAgICB7e21lc3NhZ2V9fQogICAgICAgIDwvZGl2PgogICAgICB7ey9lYWNofX0KICAgICAgYGBgCiAgICAgICBAcHJvcGVydHkgZXJyb3JzCiAgICAgIEB0eXBlIHtFcnJvcnN9CiAgICAqLwogICAgZXJyb3JzOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgdmFyIGVycm9ycyA9IEVycm9ycy5jcmVhdGUoKTsKCiAgICAgIGVycm9ycy5fcmVnaXN0ZXJIYW5kbGVycyhmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMzLnNlbmQoJ2JlY2FtZUludmFsaWQnKTsKICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzMy5zZW5kKCdiZWNhbWVWYWxpZCcpOwogICAgICB9KTsKCiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5SRUNPUkRfREFUQV9FUlJPUlMpIHsKICAgICAgICB2YXIgcmVjb3JkRGF0YSA9IFByaXZhdGUucmVjb3JkRGF0YUZvcih0aGlzKTsKICAgICAgICB2YXIganNvbkFwaUVycm9yczsKCiAgICAgICAgaWYgKHJlY29yZERhdGEuZ2V0RXJyb3JzKSB7CiAgICAgICAgICBqc29uQXBpRXJyb3JzID0gcmVjb3JkRGF0YS5nZXRFcnJvcnMoKTsKCiAgICAgICAgICBpZiAoanNvbkFwaUVycm9ycykgewogICAgICAgICAgICB2YXIgZXJyb3JzSGFzaCA9IFByaXZhdGUuZXJyb3JzQXJyYXlUb0hhc2goanNvbkFwaUVycm9ycyk7CiAgICAgICAgICAgIHZhciBlcnJvcktleXMgPSBPYmplY3Qua2V5cyhlcnJvcnNIYXNoKTsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXJyb3JLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgZXJyb3JzLl9hZGQoZXJyb3JLZXlzW2ldLCBlcnJvcnNIYXNoW2Vycm9yS2V5c1tpXV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gZXJyb3JzOwogICAgfSkucmVhZE9ubHkoKSwKICAgIGludmFsaWRFcnJvcnNDaGFuZ2VkOiBmdW5jdGlvbiBpbnZhbGlkRXJyb3JzQ2hhbmdlZChqc29uQXBpRXJyb3JzKSB7CiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5SRUNPUkRfREFUQV9FUlJPUlMpIHsKICAgICAgICB0aGlzLl9jbGVhckVycm9yTWVzc2FnZXMoKTsKCiAgICAgICAgdmFyIGVycm9ycyA9IFByaXZhdGUuZXJyb3JzQXJyYXlUb0hhc2goanNvbkFwaUVycm9ycyk7CiAgICAgICAgdmFyIGVycm9yS2V5cyA9IE9iamVjdC5rZXlzKGVycm9ycyk7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXJyb3JLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB0aGlzLl9hZGRFcnJvck1lc3NhZ2VUb0F0dHJpYnV0ZShlcnJvcktleXNbaV0sIGVycm9yc1tlcnJvcktleXNbaV1dKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBfYWRkRXJyb3JNZXNzYWdlVG9BdHRyaWJ1dGU6IGZ1bmN0aW9uIF9hZGRFcnJvck1lc3NhZ2VUb0F0dHJpYnV0ZShhdHRyaWJ1dGUsIG1lc3NhZ2UpIHsKICAgICAgdGhpcy5nZXQoJ2Vycm9ycycpLl9hZGQoYXR0cmlidXRlLCBtZXNzYWdlKTsKICAgIH0sCiAgICBfY2xlYXJFcnJvck1lc3NhZ2VzOiBmdW5jdGlvbiBfY2xlYXJFcnJvck1lc3NhZ2VzKCkgewogICAgICB0aGlzLmdldCgnZXJyb3JzJykuX2NsZWFyKCk7CiAgICB9LAoKICAgIC8qKgogICAgICBUaGlzIHByb3BlcnR5IGhvbGRzIHRoZSBgQWRhcHRlckVycm9yYCBvYmplY3Qgd2l0aCB3aGljaAogICAgICBsYXN0IGFkYXB0ZXIgb3BlcmF0aW9uIHdhcyByZWplY3RlZC4KICAgICAgIEBwcm9wZXJ0eSBhZGFwdGVyRXJyb3IKICAgICAgQHR5cGUge0FkYXB0ZXJFcnJvcn0KICAgICovCiAgICBhZGFwdGVyRXJyb3I6IGFkYXB0ZXJFcnJvciwKCiAgICAvKioKICAgICAgQ3JlYXRlIGEgSlNPTiByZXByZXNlbnRhdGlvbiBvZiB0aGUgcmVjb3JkLCB1c2luZyB0aGUgc2VyaWFsaXphdGlvbgogICAgICBzdHJhdGVneSBvZiB0aGUgc3RvcmUncyBhZGFwdGVyLgogICAgICBgc2VyaWFsaXplYCB0YWtlcyBhbiBvcHRpb25hbCBoYXNoIGFzIGEgcGFyYW1ldGVyLCBjdXJyZW50bHkKICAgICAgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAgICAtIGBpbmNsdWRlSWRgOiBgdHJ1ZWAgaWYgdGhlIHJlY29yZCdzIElEIHNob3VsZCBiZSBpbmNsdWRlZCBpbiB0aGUKICAgICAgICBKU09OIHJlcHJlc2VudGF0aW9uLgogICAgICAgQG1ldGhvZCBzZXJpYWxpemUKICAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAgQHJldHVybiB7T2JqZWN0fSBhbiBvYmplY3Qgd2hvc2UgdmFsdWVzIGFyZSBwcmltaXRpdmUgSlNPTiB2YWx1ZXMgb25seQogICAgKi8KICAgIHNlcmlhbGl6ZTogZnVuY3Rpb24gc2VyaWFsaXplKG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuX2ludGVybmFsTW9kZWwuY3JlYXRlU25hcHNob3QoKS5zZXJpYWxpemUob3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKgogICAgICBVc2UgW0pTT05TZXJpYWxpemVyXShKU09OU2VyaWFsaXplci5odG1sKSB0bwogICAgICBnZXQgdGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSByZWNvcmQuCiAgICAgICBgdG9KU09OYCB0YWtlcyBhbiBvcHRpb25hbCBoYXNoIGFzIGEgcGFyYW1ldGVyLCBjdXJyZW50bHkKICAgICAgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAgICAgLSBgaW5jbHVkZUlkYDogYHRydWVgIGlmIHRoZSByZWNvcmQncyBJRCBzaG91bGQgYmUgaW5jbHVkZWQgaW4gdGhlCiAgICAgICAgSlNPTiByZXByZXNlbnRhdGlvbi4KICAgICAgIEBtZXRob2QgdG9KU09OCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgIEByZXR1cm4ge09iamVjdH0gQSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBvYmplY3QuCiAgICAqLwogICAgdG9KU09OOiBmdW5jdGlvbiB0b0pTT04ob3B0aW9ucykgewoKICAgICAgdmFyIHNlcmlhbGl6ZXIgPSB0aGlzLl9pbnRlcm5hbE1vZGVsLnN0b3JlLnNlcmlhbGl6ZXJGb3IoJy1kZWZhdWx0Jyk7CgogICAgICB2YXIgc25hcHNob3QgPSB0aGlzLl9pbnRlcm5hbE1vZGVsLmNyZWF0ZVNuYXBzaG90KCk7CgogICAgICByZXR1cm4gc2VyaWFsaXplci5zZXJpYWxpemUoc25hcHNob3QsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvKioKICAgICAgRmlyZWQgd2hlbiB0aGUgcmVjb3JkIGlzIHJlYWR5IHRvIGJlIGludGVyYWN0ZWQgd2l0aCwKICAgICAgdGhhdCBpcyBlaXRoZXIgbG9hZGVkIGZyb20gdGhlIHNlcnZlciBvciBjcmVhdGVkIGxvY2FsbHkuCiAgICAgICBAZXZlbnQgcmVhZHkKICAgICovCiAgICByZWFkeTogbnVsbCwKCiAgICAvKioKICAgICAgRmlyZWQgd2hlbiB0aGUgcmVjb3JkIGlzIGxvYWRlZCBmcm9tIHRoZSBzZXJ2ZXIuCiAgICAgICBAZXZlbnQgZGlkTG9hZAogICAgKi8KICAgIGRpZExvYWQ6IG51bGwsCgogICAgLyoqCiAgICAgIEZpcmVkIHdoZW4gdGhlIHJlY29yZCBpcyB1cGRhdGVkLgogICAgICAgQGV2ZW50IGRpZFVwZGF0ZQogICAgKi8KICAgIGRpZFVwZGF0ZTogbnVsbCwKCiAgICAvKioKICAgICAgRmlyZWQgd2hlbiBhIG5ldyByZWNvcmQgaXMgY29tbWl0ZWQgdG8gdGhlIHNlcnZlci4KICAgICAgIEBldmVudCBkaWRDcmVhdGUKICAgICovCiAgICBkaWRDcmVhdGU6IG51bGwsCgogICAgLyoqCiAgICAgIEZpcmVkIHdoZW4gdGhlIHJlY29yZCBpcyBkZWxldGVkLgogICAgICAgQGV2ZW50IGRpZERlbGV0ZQogICAgKi8KICAgIGRpZERlbGV0ZTogbnVsbCwKCiAgICAvKioKICAgICAgRmlyZWQgd2hlbiB0aGUgcmVjb3JkIGJlY29tZXMgaW52YWxpZC4KICAgICAgIEBldmVudCBiZWNhbWVJbnZhbGlkCiAgICAqLwogICAgYmVjYW1lSW52YWxpZDogbnVsbCwKCiAgICAvKioKICAgICAgRmlyZWQgd2hlbiB0aGUgcmVjb3JkIGVudGVycyB0aGUgZXJyb3Igc3RhdGUuCiAgICAgICBAZXZlbnQgYmVjYW1lRXJyb3IKICAgICovCiAgICBiZWNhbWVFcnJvcjogbnVsbCwKCiAgICAvKioKICAgICAgRmlyZWQgd2hlbiB0aGUgcmVjb3JkIGlzIHJvbGxlZCBiYWNrLgogICAgICAgQGV2ZW50IHJvbGxlZEJhY2sKICAgICovCiAgICByb2xsZWRCYWNrOiBudWxsLAogICAgLy9UT0RPIERvIHdlIHdhbnQgdG8gZGVwcmVjYXRlIHRoZXNlPwoKICAgIC8qKgogICAgICBAbWV0aG9kIHNlbmQKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUKICAgICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQKICAgICovCiAgICBzZW5kOiBmdW5jdGlvbiBzZW5kKG5hbWUsIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIHRoaXMuX2ludGVybmFsTW9kZWwuc2VuZChuYW1lLCBjb250ZXh0KTsKICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2QgdHJhbnNpdGlvblRvCiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lCiAgICAqLwogICAgdHJhbnNpdGlvblRvOiBmdW5jdGlvbiB0cmFuc2l0aW9uVG8obmFtZSkgewogICAgICByZXR1cm4gdGhpcy5faW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8obmFtZSk7CiAgICB9LAoKICAgIC8qKgogICAgICBNYXJrcyB0aGUgcmVjb3JkIGFzIGRlbGV0ZWQgYnV0IGRvZXMgbm90IHNhdmUgaXQuIFlvdSBtdXN0IGNhbGwKICAgICAgYHNhdmVgIGFmdGVyd2FyZHMgaWYgeW91IHdhbnQgdG8gcGVyc2lzdCBpdC4gWW91IG1pZ2h0IHVzZSB0aGlzCiAgICAgIG1ldGhvZCBpZiB5b3Ugd2FudCB0byBhbGxvdyB0aGUgdXNlciB0byBzdGlsbCBgcm9sbGJhY2tBdHRyaWJ1dGVzKClgCiAgICAgIGFmdGVyIGEgZGVsZXRlIHdhcyBtYWRlLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL3JvdXRlcy9tb2RlbC9kZWxldGUuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgICAgYWN0aW9uczogewogICAgICAgICAgc29mdERlbGV0ZSgpIHsKICAgICAgICAgICAgdGhpcy5nZXQoJ2NvbnRyb2xsZXIubW9kZWwnKS5kZWxldGVSZWNvcmQoKTsKICAgICAgICAgIH0sCiAgICAgICAgICBjb25maXJtKCkgewogICAgICAgICAgICB0aGlzLmdldCgnY29udHJvbGxlci5tb2RlbCcpLnNhdmUoKTsKICAgICAgICAgIH0sCiAgICAgICAgICB1bmRvKCkgewogICAgICAgICAgICB0aGlzLmdldCgnY29udHJvbGxlci5tb2RlbCcpLnJvbGxiYWNrQXR0cmlidXRlcygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBkZWxldGVSZWNvcmQKICAgICovCiAgICBkZWxldGVSZWNvcmQ6IGZ1bmN0aW9uIGRlbGV0ZVJlY29yZCgpIHsKICAgICAgdGhpcy5faW50ZXJuYWxNb2RlbC5kZWxldGVSZWNvcmQoKTsKICAgIH0sCgogICAgLyoqCiAgICAgIFNhbWUgYXMgYGRlbGV0ZVJlY29yZGAsIGJ1dCBzYXZlcyB0aGUgcmVjb3JkIGltbWVkaWF0ZWx5LgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL3JvdXRlcy9tb2RlbC9kZWxldGUuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgICAgYWN0aW9uczogewogICAgICAgICAgZGVsZXRlKCkgewogICAgICAgICAgICB0aGlzLmdldCgnY29udHJvbGxlci5tb2RlbCcpLmRlc3Ryb3lSZWNvcmQoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGNvbnRyb2xsZXIudHJhbnNpdGlvblRvUm91dGUoJ21vZGVsLmluZGV4Jyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgSWYgeW91IHBhc3MgYW4gb2JqZWN0IG9uIHRoZSBgYWRhcHRlck9wdGlvbnNgIHByb3BlcnR5IG9mIHRoZSBvcHRpb25zCiAgICAgIGFyZ3VtZW50IGl0IHdpbGwgYmUgcGFzc2VkIHRvIHlvdXIgYWRhcHRlciB2aWEgdGhlIHNuYXBzaG90CiAgICAgICBgYGBqcwogICAgICByZWNvcmQuZGVzdHJveVJlY29yZCh7IGFkYXB0ZXJPcHRpb25zOiB7IHN1YnNjcmliZTogZmFsc2UgfSB9KTsKICAgICAgYGBgCiAgICAgICBgYGBhcHAvYWRhcHRlcnMvcG9zdC5qcwogICAgICBpbXBvcnQgTXlDdXN0b21BZGFwdGVyIGZyb20gJy4vY3VzdG9tLWFkYXB0ZXInOwogICAgICAgZXhwb3J0IGRlZmF1bHQgTXlDdXN0b21BZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgZGVsZXRlUmVjb3JkKHN0b3JlLCB0eXBlLCBzbmFwc2hvdCkgewogICAgICAgICAgaWYgKHNuYXBzaG90LmFkYXB0ZXJPcHRpb25zLnN1YnNjcmliZSkgewogICAgICAgICAgICAvLyAuLi4KICAgICAgICAgIH0KICAgICAgICAgIC8vIC4uLgogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBkZXN0cm95UmVjb3JkCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgIEByZXR1cm4ge1Byb21pc2V9IGEgcHJvbWlzZSB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgd2hlbiB0aGUgYWRhcHRlciByZXR1cm5zCiAgICAgIHN1Y2Nlc3NmdWxseSBvciByZWplY3RlZCBpZiB0aGUgYWRhcHRlciByZXR1cm5zIHdpdGggYW4gZXJyb3IuCiAgICAqLwogICAgZGVzdHJveVJlY29yZDogZnVuY3Rpb24gZGVzdHJveVJlY29yZChvcHRpb25zKSB7CiAgICAgIHRoaXMuZGVsZXRlUmVjb3JkKCk7CiAgICAgIHJldHVybiB0aGlzLnNhdmUob3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKgogICAgICBVbmxvYWRzIHRoZSByZWNvcmQgZnJvbSB0aGUgc3RvcmUuIFRoaXMgd2lsbCBub3Qgc2VuZCBhIGRlbGV0ZSByZXF1ZXN0CiAgICAgIHRvIHlvdXIgc2VydmVyLCBpdCBqdXN0IHVubG9hZHMgdGhlIHJlY29yZCBmcm9tIG1lbW9yeS4KICAgICAgIEBtZXRob2QgdW5sb2FkUmVjb3JkCiAgICAqLwogICAgdW5sb2FkUmVjb3JkOiBmdW5jdGlvbiB1bmxvYWRSZWNvcmQoKSB7CiAgICAgIGlmICh0aGlzLmlzRGVzdHJveWVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl9pbnRlcm5hbE1vZGVsLnVubG9hZFJlY29yZCgpOwogICAgfSwKCiAgICAvKioKICAgICAgQG1ldGhvZCBfbm90aWZ5UHJvcGVydGllcwogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9ub3RpZnlQcm9wZXJ0aWVzOiBmdW5jdGlvbiBfbm90aWZ5UHJvcGVydGllcyhrZXlzKSB7CiAgICAgIHZhciBfdGhpczQgPSB0aGlzOwoKICAgICAgLy8gY2hhbmdlUHJvcGVydGllcyBkZWZlcnMgbm90aWZpY2F0aW9ucyB1bnRpbCBhZnRlciB0aGUgZGVsZWdhdGUKICAgICAgLy8gYW5kIHByb3RlY3RzIHdpdGggYSB0cnkuLi5maW5hbGx5IGJsb2NrCiAgICAgIC8vIHByZXZpb3VzbHkgdXNlZCBiZWdpbi4uLmVuZFByb3BlcnR5Q2hhbmdlcyBidXQgdGhpcyBpcyBwcml2YXRlIEFQSQogICAgICBjaGFuZ2VQcm9wZXJ0aWVzKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIga2V5OwoKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0ga2V5cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAga2V5ID0ga2V5c1tpXTsKCiAgICAgICAgICBfdGhpczQubm90aWZ5UHJvcGVydHlDaGFuZ2Uoa2V5KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICAvKioKICAgICAgUmV0dXJucyBhbiBvYmplY3QsIHdob3NlIGtleXMgYXJlIGNoYW5nZWQgcHJvcGVydGllcywgYW5kIHZhbHVlIGlzCiAgICAgIGFuIFtvbGRQcm9wLCBuZXdQcm9wXSBhcnJheS4KICAgICAgIFRoZSBhcnJheSByZXByZXNlbnRzIHRoZSBkaWZmIG9mIHRoZSBjYW5vbmljYWwgc3RhdGUgd2l0aCB0aGUgbG9jYWwgc3RhdGUKICAgICAgb2YgdGhlIG1vZGVsLiBOb3RlOiBpZiB0aGUgbW9kZWwgaXMgY3JlYXRlZCBsb2NhbGx5LCB0aGUgY2Fub25pY2FsIHN0YXRlIGlzCiAgICAgIGVtcHR5IHNpbmNlIHRoZSBhZGFwdGVyIGhhc24ndCBhY2tub3dsZWRnZWQgdGhlIGF0dHJpYnV0ZXMgeWV0OgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL21vZGVscy9tYXNjb3QuanMKICAgICAgaW1wb3J0IE1vZGVsLCB7IGF0dHIgfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICAgIG5hbWU6IGF0dHIoJ3N0cmluZycpLAogICAgICAgIGlzQWRtaW46IGF0dHIoJ2Jvb2xlYW4nLCB7CiAgICAgICAgICBkZWZhdWx0VmFsdWU6IGZhbHNlCiAgICAgICAgfSkKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBsZXQgbWFzY290ID0gc3RvcmUuY3JlYXRlUmVjb3JkKCdtYXNjb3QnKTsKICAgICAgIG1hc2NvdC5jaGFuZ2VkQXR0cmlidXRlcygpOyAvLyB7fQogICAgICAgbWFzY290LnNldCgnbmFtZScsICdUb21zdGVyJyk7CiAgICAgIG1hc2NvdC5jaGFuZ2VkQXR0cmlidXRlcygpOyAvLyB7IG5hbWU6IFt1bmRlZmluZWQsICdUb21zdGVyJ10gfQogICAgICAgbWFzY290LnNldCgnaXNBZG1pbicsIHRydWUpOwogICAgICBtYXNjb3QuY2hhbmdlZEF0dHJpYnV0ZXMoKTsgLy8geyBpc0FkbWluOiBbdW5kZWZpbmVkLCB0cnVlXSwgbmFtZTogW3VuZGVmaW5lZCwgJ1RvbXN0ZXInXSB9CiAgICAgICBtYXNjb3Quc2F2ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgbWFzY290LmNoYW5nZWRBdHRyaWJ1dGVzKCk7IC8vIHt9CiAgICAgICAgIG1hc2NvdC5zZXQoJ2lzQWRtaW4nLCBmYWxzZSk7CiAgICAgICAgbWFzY290LmNoYW5nZWRBdHRyaWJ1dGVzKCk7IC8vIHsgaXNBZG1pbjogW3RydWUsIGZhbHNlXSB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgY2hhbmdlZEF0dHJpYnV0ZXMKICAgICAgQHJldHVybiB7T2JqZWN0fSBhbiBvYmplY3QsIHdob3NlIGtleXMgYXJlIGNoYW5nZWQgcHJvcGVydGllcywKICAgICAgICBhbmQgdmFsdWUgaXMgYW4gW29sZFByb3AsIG5ld1Byb3BdIGFycmF5LgogICAgKi8KICAgIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbiBjaGFuZ2VkQXR0cmlidXRlcygpIHsKICAgICAgcmV0dXJuIHRoaXMuX2ludGVybmFsTW9kZWwuY2hhbmdlZEF0dHJpYnV0ZXMoKTsKICAgIH0sCgogICAgLyoqCiAgICAgIElmIHRoZSBtb2RlbCBgaGFzRGlydHlBdHRyaWJ1dGVzYCB0aGlzIGZ1bmN0aW9uIHdpbGwgZGlzY2FyZCBhbnkgdW5zYXZlZAogICAgICBjaGFuZ2VzLiBJZiB0aGUgbW9kZWwgYGlzTmV3YCBpdCB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgc3RvcmUuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHJlY29yZC5nZXQoJ25hbWUnKTsgLy8gJ1VudGl0bGVkIERvY3VtZW50JwogICAgICByZWNvcmQuc2V0KCduYW1lJywgJ0RvYyAxJyk7CiAgICAgIHJlY29yZC5nZXQoJ25hbWUnKTsgLy8gJ0RvYyAxJwogICAgICByZWNvcmQucm9sbGJhY2tBdHRyaWJ1dGVzKCk7CiAgICAgIHJlY29yZC5nZXQoJ25hbWUnKTsgLy8gJ1VudGl0bGVkIERvY3VtZW50JwogICAgICBgYGAKICAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCByb2xsYmFja0F0dHJpYnV0ZXMKICAgICovCiAgICByb2xsYmFja0F0dHJpYnV0ZXM6IGZ1bmN0aW9uIHJvbGxiYWNrQXR0cmlidXRlcygpIHsKICAgICAgdGhpcy5faW50ZXJuYWxNb2RlbC5yb2xsYmFja0F0dHJpYnV0ZXMoKTsKCiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5SRUNPUkRfREFUQV9FUlJPUlMpIHsKICAgICAgICB0aGlzLl9tYXJrSW52YWxpZFJlcXVlc3RBc0NsZWFuKCk7CiAgICAgIH0KCiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5SRVFVRVNUX1NFUlZJQ0UpIHsKICAgICAgICB0aGlzLl9tYXJrRXJyb3JSZXF1ZXN0QXNDbGVhbigpOwogICAgICB9CiAgICB9LAoKICAgIC8qCiAgICAgIEBtZXRob2QgX2NyZWF0ZVNuYXBzaG90CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgX2NyZWF0ZVNuYXBzaG90OiBmdW5jdGlvbiBfY3JlYXRlU25hcHNob3QoKSB7CiAgICAgIHJldHVybiB0aGlzLl9pbnRlcm5hbE1vZGVsLmNyZWF0ZVNuYXBzaG90KCk7CiAgICB9LAogICAgdG9TdHJpbmdFeHRlbnNpb246IGZ1bmN0aW9uIHRvU3RyaW5nRXh0ZW5zaW9uKCkgewogICAgICAvLyB0aGUgX2ludGVybmFsTW9kZWwgZ3VhcmQgZXhpc3RzLCBiZWNhdXNlIHNvbWUgZGV2LW9ubHkgZGVwcmVjYXRpb24gY29kZQogICAgICAvLyAoYWRkTGlzdGVuZXIgdmlhIHZhbGlkYXRlUHJvcGVydHlJbmplY3Rpb25zKSBpbnZva2VzIHRvU3RyaW5nIGJlZm9yZSB0aGUKICAgICAgLy8gb2JqZWN0IGlzIHJlYWwuCiAgICAgIHJldHVybiB0aGlzLl9pbnRlcm5hbE1vZGVsICYmIHRoaXMuX2ludGVybmFsTW9kZWwuaWQ7CiAgICB9LAoKICAgIC8qKgogICAgICBTYXZlIHRoZSByZWNvcmQgYW5kIHBlcnNpc3QgYW55IGNoYW5nZXMgdG8gdGhlIHJlY29yZCB0byBhbgogICAgICBleHRlcm5hbCBzb3VyY2UgdmlhIHRoZSBhZGFwdGVyLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgamF2YXNjcmlwdAogICAgICByZWNvcmQuc2V0KCduYW1lJywgJ1RvbXN0ZXInKTsKICAgICAgcmVjb3JkLnNhdmUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgIC8vIFN1Y2Nlc3MgY2FsbGJhY2sKICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gRXJyb3IgY2FsbGJhY2sKICAgICAgfSk7CiAgICAgIGBgYAogICAgICBJZiB5b3UgcGFzcyBhbiBvYmplY3QgdXNpbmcgdGhlIGBhZGFwdGVyT3B0aW9uc2AgcHJvcGVydHkgb2YgdGhlIG9wdGlvbnMKICAgICBhcmd1bWVudCBpdCB3aWxsIGJlIHBhc3NlZCB0byB5b3VyIGFkYXB0ZXIgdmlhIHRoZSBzbmFwc2hvdC4KICAgICAgIGBgYGpzCiAgICAgIHJlY29yZC5zYXZlKHsgYWRhcHRlck9wdGlvbnM6IHsgc3Vic2NyaWJlOiBmYWxzZSB9IH0pOwogICAgICBgYGAKICAgICAgIGBgYGFwcC9hZGFwdGVycy9wb3N0LmpzCiAgICAgIGltcG9ydCBNeUN1c3RvbUFkYXB0ZXIgZnJvbSAnLi9jdXN0b20tYWRhcHRlcic7CiAgICAgICBleHBvcnQgZGVmYXVsdCBNeUN1c3RvbUFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICB1cGRhdGVSZWNvcmQoc3RvcmUsIHR5cGUsIHNuYXBzaG90KSB7CiAgICAgICAgICBpZiAoc25hcHNob3QuYWRhcHRlck9wdGlvbnMuc3Vic2NyaWJlKSB7CiAgICAgICAgICAgIC8vIC4uLgogICAgICAgICAgfQogICAgICAgICAgLy8gLi4uCiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHNhdmUKICAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAgQHJldHVybiB7UHJvbWlzZX0gYSBwcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCB3aGVuIHRoZSBhZGFwdGVyIHJldHVybnMKICAgICAgc3VjY2Vzc2Z1bGx5IG9yIHJlamVjdGVkIGlmIHRoZSBhZGFwdGVyIHJldHVybnMgd2l0aCBhbiBlcnJvci4KICAgICovCiAgICBzYXZlOiBmdW5jdGlvbiBzYXZlKG9wdGlvbnMpIHsKICAgICAgdmFyIF90aGlzNSA9IHRoaXM7CgogICAgICByZXR1cm4gUHJpdmF0ZS5Qcm9taXNlT2JqZWN0LmNyZWF0ZSh7CiAgICAgICAgcHJvbWlzZTogdGhpcy5faW50ZXJuYWxNb2RlbC5zYXZlKG9wdGlvbnMpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIF90aGlzNTsKICAgICAgICB9KQogICAgICB9KTsKICAgIH0sCgogICAgLyoqCiAgICAgIFJlbG9hZCB0aGUgcmVjb3JkIGZyb20gdGhlIGFkYXB0ZXIuCiAgICAgICBUaGlzIHdpbGwgb25seSB3b3JrIGlmIHRoZSByZWNvcmQgaGFzIGFscmVhZHkgZmluaXNoZWQgbG9hZGluZy4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9yb3V0ZXMvbW9kZWwvdmlldy5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgICBhY3Rpb25zOiB7CiAgICAgICAgICByZWxvYWQoKSB7CiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5nZXQoJ21vZGVsJykucmVsb2FkKCkudGhlbihmdW5jdGlvbihtb2RlbCkgewogICAgICAgICAgICAgIC8vIGRvIHNvbWV0aGluZyB3aXRoIHRoZSByZWxvYWRlZCBtb2RlbAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgcmVsb2FkCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIG9wdGlvbmFsLCBtYXkgaW5jbHVkZSBgYWRhcHRlck9wdGlvbnNgIGhhc2ggd2hpY2ggd2lsbCBiZSBwYXNzZWQgdG8gYWRhcHRlciByZXF1ZXN0CiAgICAgIEByZXR1cm4ge1Byb21pc2V9IGEgcHJvbWlzZSB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCB0aGUgcmVjb3JkIHdoZW4gdGhlCiAgICAgIGFkYXB0ZXIgcmV0dXJucyBzdWNjZXNzZnVsbHkgb3IgcmVqZWN0ZWQgaWYgdGhlIGFkYXB0ZXIgcmV0dXJucwogICAgICB3aXRoIGFuIGVycm9yLgogICAgKi8KICAgIHJlbG9hZDogZnVuY3Rpb24gcmVsb2FkKG9wdGlvbnMpIHsKICAgICAgdmFyIF90aGlzNiA9IHRoaXM7CgogICAgICB2YXIgd3JhcHBlZEFkYXB0ZXJPcHRpb25zOwoKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnb2JqZWN0JyAmJiBvcHRpb25zICE9PSBudWxsICYmIG9wdGlvbnMuYWRhcHRlck9wdGlvbnMpIHsKICAgICAgICB3cmFwcGVkQWRhcHRlck9wdGlvbnMgPSB7CiAgICAgICAgICBhZGFwdGVyT3B0aW9uczogb3B0aW9ucy5hZGFwdGVyT3B0aW9ucwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHJldHVybiBQcml2YXRlLlByb21pc2VPYmplY3QuY3JlYXRlKHsKICAgICAgICBwcm9taXNlOiB0aGlzLl9pbnRlcm5hbE1vZGVsLnJlbG9hZCh3cmFwcGVkQWRhcHRlck9wdGlvbnMpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIF90aGlzNjsKICAgICAgICB9KQogICAgICB9KTsKICAgIH0sCgogICAgLyoqCiAgICAgIE92ZXJyaWRlIHRoZSBkZWZhdWx0IGV2ZW50IGZpcmluZyBmcm9tIEVtYmVyLkV2ZW50ZWQgdG8KICAgICAgYWxzbyBjYWxsIG1ldGhvZHMgd2l0aCB0aGUgZ2l2ZW4gbmFtZS4KICAgICAgIEBtZXRob2QgdHJpZ2dlcgogICAgICBAcHJpdmF0ZQogICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZQogICAgKi8KICAgIHRyaWdnZXI6IGZ1bmN0aW9uIHRyaWdnZXIobmFtZSkgewogICAgICB2YXIgZm4gPSB0aGlzW25hbWVdOwoKICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHZhciBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOwogICAgICAgIHZhciBhcmdzID0gbmV3IEFycmF5KGxlbmd0aCAtIDEpOwoKICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBhcmdzW2kgLSAxXSA9IGFyZ3VtZW50c1tpXTsKICAgICAgICB9CgogICAgICAgIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9CgogICAgICB2YXIgX2hhc0V2ZW50ID0gIHRoaXMuaGFzKG5hbWUpOwoKICAgICAgaWYgKF9oYXNFdmVudCkgewogICAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH0sCiAgICBhdHRyOiBmdW5jdGlvbiBhdHRyKCkgewogICAgfSwKCiAgICAvKioKICAgICAgR2V0IHRoZSByZWZlcmVuY2UgZm9yIHRoZSBzcGVjaWZpZWQgYmVsb25nc1RvIHJlbGF0aW9uc2hpcC4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9tb2RlbHMvYmxvZy5qcwogICAgICBpbXBvcnQgTW9kZWwsIHsgYmVsb25nc1RvIH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgICB1c2VyOiBiZWxvbmdzVG8oeyBhc3luYzogdHJ1ZSB9KQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGxldCBibG9nID0gc3RvcmUucHVzaCh7CiAgICAgICAgZGF0YTogewogICAgICAgICAgdHlwZTogJ2Jsb2cnLAogICAgICAgICAgaWQ6IDEsCiAgICAgICAgICByZWxhdGlvbnNoaXBzOiB7CiAgICAgICAgICAgIHVzZXI6IHsKICAgICAgICAgICAgICBkYXRhOiB7IHR5cGU6ICd1c2VyJywgaWQ6IDEgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgbGV0IHVzZXJSZWYgPSBibG9nLmJlbG9uZ3NUbygndXNlcicpOwogICAgICAgLy8gY2hlY2sgaWYgdGhlIHVzZXIgcmVsYXRpb25zaGlwIGlzIGxvYWRlZAogICAgICBsZXQgaXNMb2FkZWQgPSB1c2VyUmVmLnZhbHVlKCkgIT09IG51bGw7CiAgICAgICAvLyBnZXQgdGhlIHJlY29yZCBvZiB0aGUgcmVmZXJlbmNlIChudWxsIGlmIG5vdCB5ZXQgYXZhaWxhYmxlKQogICAgICBsZXQgdXNlciA9IHVzZXJSZWYudmFsdWUoKTsKICAgICAgIC8vIGdldCB0aGUgaWRlbnRpZmllciBvZiB0aGUgcmVmZXJlbmNlCiAgICAgIGlmICh1c2VyUmVmLnJlbW90ZVR5cGUoKSA9PT0gImlkIikgewogICAgICAgIGxldCBpZCA9IHVzZXJSZWYuaWQoKTsKICAgICAgfSBlbHNlIGlmICh1c2VyUmVmLnJlbW90ZVR5cGUoKSA9PT0gImxpbmsiKSB7CiAgICAgICAgbGV0IGxpbmsgPSB1c2VyUmVmLmxpbmsoKTsKICAgICAgfQogICAgICAgLy8gbG9hZCB1c2VyICh2aWEgc3RvcmUuZmluZFJlY29yZCBvciBzdG9yZS5maW5kQmVsb25nc1RvKQogICAgICB1c2VyUmVmLmxvYWQoKS50aGVuKC4uLikKICAgICAgIC8vIG9yIHRyaWdnZXIgYSByZWxvYWQKICAgICAgdXNlclJlZi5yZWxvYWQoKS50aGVuKC4uLikKICAgICAgIC8vIHByb3ZpZGUgZGF0YSBmb3IgcmVmZXJlbmNlCiAgICAgIHVzZXJSZWYucHVzaCh7CiAgICAgICAgdHlwZTogJ3VzZXInLAogICAgICAgIGlkOiAxLAogICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgIHVzZXJuYW1lOiAiQHVzZXIiCiAgICAgICAgfQogICAgICB9KS50aGVuKGZ1bmN0aW9uKHVzZXIpIHsKICAgICAgICB1c2VyUmVmLnZhbHVlKCkgPT09IHVzZXI7CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgYmVsb25nc1RvCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIG9mIHRoZSByZWxhdGlvbnNoaXAKICAgICAgQHNpbmNlIDIuNS4wCiAgICAgIEByZXR1cm4ge0JlbG9uZ3NUb1JlZmVyZW5jZX0gcmVmZXJlbmNlIGZvciB0aGlzIHJlbGF0aW9uc2hpcAogICAgKi8KICAgIGJlbG9uZ3NUbzogZnVuY3Rpb24gYmVsb25nc1RvKG5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuX2ludGVybmFsTW9kZWwucmVmZXJlbmNlRm9yKCdiZWxvbmdzVG8nLCBuYW1lKTsKICAgIH0sCgogICAgLyoqCiAgICAgIEdldCB0aGUgcmVmZXJlbmNlIGZvciB0aGUgc3BlY2lmaWVkIGhhc01hbnkgcmVsYXRpb25zaGlwLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL21vZGVscy9ibG9nLmpzCiAgICAgIGltcG9ydCBNb2RlbCwgeyBoYXNNYW55IH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgICBjb21tZW50czogaGFzTWFueSh7IGFzeW5jOiB0cnVlIH0pCiAgICAgIH0pOwogICAgICAgbGV0IGJsb2cgPSBzdG9yZS5wdXNoKHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICB0eXBlOiAnYmxvZycsCiAgICAgICAgICBpZDogMSwKICAgICAgICAgIHJlbGF0aW9uc2hpcHM6IHsKICAgICAgICAgICAgY29tbWVudHM6IHsKICAgICAgICAgICAgICBkYXRhOiBbCiAgICAgICAgICAgICAgICB7IHR5cGU6ICdjb21tZW50JywgaWQ6IDEgfSwKICAgICAgICAgICAgICAgIHsgdHlwZTogJ2NvbW1lbnQnLCBpZDogMiB9CiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgbGV0IGNvbW1lbnRzUmVmID0gYmxvZy5oYXNNYW55KCdjb21tZW50cycpOwogICAgICAgLy8gY2hlY2sgaWYgdGhlIGNvbW1lbnRzIGFyZSBsb2FkZWQgYWxyZWFkeQogICAgICBsZXQgaXNMb2FkZWQgPSBjb21tZW50c1JlZi52YWx1ZSgpICE9PSBudWxsOwogICAgICAgLy8gZ2V0IHRoZSByZWNvcmRzIG9mIHRoZSByZWZlcmVuY2UgKG51bGwgaWYgbm90IHlldCBhdmFpbGFibGUpCiAgICAgIGxldCBjb21tZW50cyA9IGNvbW1lbnRzUmVmLnZhbHVlKCk7CiAgICAgICAvLyBnZXQgdGhlIGlkZW50aWZpZXIgb2YgdGhlIHJlZmVyZW5jZQogICAgICBpZiAoY29tbWVudHNSZWYucmVtb3RlVHlwZSgpID09PSAiaWRzIikgewogICAgICAgIGxldCBpZHMgPSBjb21tZW50c1JlZi5pZHMoKTsKICAgICAgfSBlbHNlIGlmIChjb21tZW50c1JlZi5yZW1vdGVUeXBlKCkgPT09ICJsaW5rIikgewogICAgICAgIGxldCBsaW5rID0gY29tbWVudHNSZWYubGluaygpOwogICAgICB9CiAgICAgICAvLyBsb2FkIGNvbW1lbnRzICh2aWEgc3RvcmUuZmluZE1hbnkgb3Igc3RvcmUuZmluZEhhc01hbnkpCiAgICAgIGNvbW1lbnRzUmVmLmxvYWQoKS50aGVuKC4uLikKICAgICAgIC8vIG9yIHRyaWdnZXIgYSByZWxvYWQKICAgICAgY29tbWVudHNSZWYucmVsb2FkKCkudGhlbiguLi4pCiAgICAgICAvLyBwcm92aWRlIGRhdGEgZm9yIHJlZmVyZW5jZQogICAgICBjb21tZW50c1JlZi5wdXNoKFt7IHR5cGU6ICdjb21tZW50JywgaWQ6IDEgfSwgeyB0eXBlOiAnY29tbWVudCcsIGlkOiAyIH1dKS50aGVuKGZ1bmN0aW9uKGNvbW1lbnRzKSB7CiAgICAgICAgY29tbWVudHNSZWYudmFsdWUoKSA9PT0gY29tbWVudHM7CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgaGFzTWFueQogICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBvZiB0aGUgcmVsYXRpb25zaGlwCiAgICAgIEBzaW5jZSAyLjUuMAogICAgICBAcmV0dXJuIHtIYXNNYW55UmVmZXJlbmNlfSByZWZlcmVuY2UgZm9yIHRoaXMgcmVsYXRpb25zaGlwCiAgICAqLwogICAgaGFzTWFueTogZnVuY3Rpb24gaGFzTWFueShuYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLl9pbnRlcm5hbE1vZGVsLnJlZmVyZW5jZUZvcignaGFzTWFueScsIG5hbWUpOwogICAgfSwKCiAgICAvKioKICAgICBQcm92aWRlcyBpbmZvIGFib3V0IHRoZSBtb2RlbCBmb3IgZGVidWdnaW5nIHB1cnBvc2VzCiAgICAgYnkgZ3JvdXBpbmcgdGhlIHByb3BlcnRpZXMgaW50byBtb3JlIHNlbWFudGljIGdyb3Vwcy4KICAgICAgTWVhbnQgdG8gYmUgdXNlZCBieSBkZWJ1Z2dpbmcgdG9vbHMgc3VjaCBhcyB0aGUgQ2hyb21lIEVtYmVyIEV4dGVuc2lvbi4KICAgICAgLSBHcm91cHMgYWxsIGF0dHJpYnV0ZXMgaW4gIkF0dHJpYnV0ZXMiIGdyb3VwLgogICAgIC0gR3JvdXBzIGFsbCBiZWxvbmdzVG8gcmVsYXRpb25zaGlwcyBpbiAiQmVsb25ncyBUbyIgZ3JvdXAuCiAgICAgLSBHcm91cHMgYWxsIGhhc01hbnkgcmVsYXRpb25zaGlwcyBpbiAiSGFzIE1hbnkiIGdyb3VwLgogICAgIC0gR3JvdXBzIGFsbCBmbGFncyBpbiAiRmxhZ3MiIGdyb3VwLgogICAgIC0gRmxhZ3MgcmVsYXRpb25zaGlwIENQcyBhcyBleHBlbnNpdmUgcHJvcGVydGllcy4KICAgICAgQG1ldGhvZCBfZGVidWdJbmZvCiAgICAgQGZvciBNb2RlbAogICAgIEBwcml2YXRlCiAgICAgKi8KICAgIF9kZWJ1Z0luZm86IGZ1bmN0aW9uIF9kZWJ1Z0luZm8oKSB7CiAgICAgIHZhciBhdHRyaWJ1dGVzID0gWydpZCddOwogICAgICB2YXIgcmVsYXRpb25zaGlwcyA9IHt9OwogICAgICB2YXIgZXhwZW5zaXZlUHJvcGVydGllcyA9IFtdOwogICAgICB0aGlzLmVhY2hBdHRyaWJ1dGUoZnVuY3Rpb24gKG5hbWUsIG1ldGEpIHsKICAgICAgICByZXR1cm4gYXR0cmlidXRlcy5wdXNoKG5hbWUpOwogICAgICB9KTsKICAgICAgdmFyIGdyb3VwcyA9IFt7CiAgICAgICAgbmFtZTogJ0F0dHJpYnV0ZXMnLAogICAgICAgIHByb3BlcnRpZXM6IGF0dHJpYnV0ZXMsCiAgICAgICAgZXhwYW5kOiB0cnVlCiAgICAgIH1dOwogICAgICB0aGlzLmVhY2hSZWxhdGlvbnNoaXAoZnVuY3Rpb24gKG5hbWUsIHJlbGF0aW9uc2hpcCkgewogICAgICAgIHZhciBwcm9wZXJ0aWVzID0gcmVsYXRpb25zaGlwc1tyZWxhdGlvbnNoaXAua2luZF07CgogICAgICAgIGlmIChwcm9wZXJ0aWVzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHByb3BlcnRpZXMgPSByZWxhdGlvbnNoaXBzW3JlbGF0aW9uc2hpcC5raW5kXSA9IFtdOwogICAgICAgICAgZ3JvdXBzLnB1c2goewogICAgICAgICAgICBuYW1lOiByZWxhdGlvbnNoaXAua2luZCwKICAgICAgICAgICAgcHJvcGVydGllczogcHJvcGVydGllcywKICAgICAgICAgICAgZXhwYW5kOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIHByb3BlcnRpZXMucHVzaChuYW1lKTsKICAgICAgICBleHBlbnNpdmVQcm9wZXJ0aWVzLnB1c2gobmFtZSk7CiAgICAgIH0pOwogICAgICBncm91cHMucHVzaCh7CiAgICAgICAgbmFtZTogJ0ZsYWdzJywKICAgICAgICBwcm9wZXJ0aWVzOiBbJ2lzTG9hZGVkJywgJ2hhc0RpcnR5QXR0cmlidXRlcycsICdpc1NhdmluZycsICdpc0RlbGV0ZWQnLCAnaXNFcnJvcicsICdpc05ldycsICdpc1ZhbGlkJ10KICAgICAgfSk7CiAgICAgIHJldHVybiB7CiAgICAgICAgcHJvcGVydHlJbmZvOiB7CiAgICAgICAgICAvLyBpbmNsdWRlIGFsbCBvdGhlciBtaXhpbnMgLyBwcm9wZXJ0aWVzIChub3QganVzdCB0aGUgZ3JvdXBlZCBvbmVzKQogICAgICAgICAgaW5jbHVkZU90aGVyUHJvcGVydGllczogdHJ1ZSwKICAgICAgICAgIGdyb3VwczogZ3JvdXBzLAogICAgICAgICAgLy8gZG9uJ3QgcHJlLWNhbGN1bGF0ZSB1bmxlc3MgY2FjaGVkCiAgICAgICAgICBleHBlbnNpdmVQcm9wZXJ0aWVzOiBleHBlbnNpdmVQcm9wZXJ0aWVzCiAgICAgICAgfQogICAgICB9OwogICAgfSwKICAgIG5vdGlmeUJlbG9uZ3NUb0NoYW5nZTogZnVuY3Rpb24gbm90aWZ5QmVsb25nc1RvQ2hhbmdlKGtleSkgewogICAgICB0aGlzLm5vdGlmeVByb3BlcnR5Q2hhbmdlKGtleSk7CiAgICB9LAoKICAgIC8qKgogICAgIEdpdmVuIGEgY2FsbGJhY2ssIGl0ZXJhdGVzIG92ZXIgZWFjaCBvZiB0aGUgcmVsYXRpb25zaGlwcyBpbiB0aGUgbW9kZWwsCiAgICAgaW52b2tpbmcgdGhlIGNhbGxiYWNrIHdpdGggdGhlIG5hbWUgb2YgZWFjaCByZWxhdGlvbnNoaXAgYW5kIGl0cyByZWxhdGlvbnNoaXAKICAgICBkZXNjcmlwdG9yLgogICAgICAgVGhlIGNhbGxiYWNrIG1ldGhvZCB5b3UgcHJvdmlkZSBzaG91bGQgaGF2ZSB0aGUgZm9sbG93aW5nIHNpZ25hdHVyZSAoYWxsCiAgICAgcGFyYW1ldGVycyBhcmUgb3B0aW9uYWwpOgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgZnVuY3Rpb24obmFtZSwgZGVzY3JpcHRvcik7CiAgICAgYGBgCiAgICAgIC0gYG5hbWVgIHRoZSBuYW1lIG9mIHRoZSBjdXJyZW50IHByb3BlcnR5IGluIHRoZSBpdGVyYXRpb24KICAgICAtIGBkZXNjcmlwdG9yYCB0aGUgbWV0YSBvYmplY3QgdGhhdCBkZXNjcmliZXMgdGhpcyByZWxhdGlvbnNoaXAKICAgICAgVGhlIHJlbGF0aW9uc2hpcCBkZXNjcmlwdG9yIGFyZ3VtZW50IGlzIGFuIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllcy4KICAgICAgLSAqKmtleSoqIDxzcGFuIGNsYXNzPSJ0eXBlIj5TdHJpbmc8L3NwYW4+IHRoZSBuYW1lIG9mIHRoaXMgcmVsYXRpb25zaGlwIG9uIHRoZSBNb2RlbAogICAgIC0gKipraW5kKiogPHNwYW4gY2xhc3M9InR5cGUiPlN0cmluZzwvc3Bhbj4gImhhc01hbnkiIG9yICJiZWxvbmdzVG8iCiAgICAgLSAqKm9wdGlvbnMqKiA8c3BhbiBjbGFzcz0idHlwZSI+T2JqZWN0PC9zcGFuPiB0aGUgb3JpZ2luYWwgb3B0aW9ucyBoYXNoIHBhc3NlZCB3aGVuIHRoZSByZWxhdGlvbnNoaXAgd2FzIGRlY2xhcmVkCiAgICAgLSAqKnBhcmVudFR5cGUqKiA8c3BhbiBjbGFzcz0idHlwZSI+TW9kZWw8L3NwYW4+IHRoZSB0eXBlIG9mIHRoZSBNb2RlbCB0aGF0IG93bnMgdGhpcyByZWxhdGlvbnNoaXAKICAgICAtICoqdHlwZSoqIDxzcGFuIGNsYXNzPSJ0eXBlIj5TdHJpbmc8L3NwYW4+IHRoZSB0eXBlIG5hbWUgb2YgdGhlIHJlbGF0ZWQgTW9kZWwKICAgICAgTm90ZSB0aGF0IGluIGFkZGl0aW9uIHRvIGEgY2FsbGJhY2ssIHlvdSBjYW4gYWxzbyBwYXNzIGFuIG9wdGlvbmFsIHRhcmdldAogICAgIG9iamVjdCB0aGF0IHdpbGwgYmUgc2V0IGFzIGB0aGlzYCBvbiB0aGUgY29udGV4dC4KICAgICAgRXhhbXBsZQogICAgICBgYGBhcHAvc2VyaWFsaXplcnMvYXBwbGljYXRpb24uanMKICAgICBpbXBvcnQgSlNPTlNlcmlhbGl6ZXIgZnJvbSAnQGVtYmVyLWRhdGEvc2VyaWFsaXplci9qc29uJzsKICAgICAgZXhwb3J0IGRlZmF1bHQgSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgc2VyaWFsaXplOiBmdW5jdGlvbihyZWNvcmQsIG9wdGlvbnMpIHsKICAgICAgICBsZXQganNvbiA9IHt9OwogICAgICAgICByZWNvcmQuZWFjaFJlbGF0aW9uc2hpcChmdW5jdGlvbihuYW1lLCBkZXNjcmlwdG9yKSB7CiAgICAgICAgICBpZiAoZGVzY3JpcHRvci5raW5kID09PSAnaGFzTWFueScpIHsKICAgICAgICAgICAgbGV0IHNlcmlhbGl6ZWRIYXNNYW55TmFtZSA9IG5hbWUudG9VcHBlckNhc2UoKSArICdfSURTJzsKICAgICAgICAgICAganNvbltzZXJpYWxpemVkSGFzTWFueU5hbWVdID0gcmVjb3JkLmdldChuYW1lKS5tYXBCeSgnaWQnKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICAgcmV0dXJuIGpzb247CiAgICAgIH0KICAgIH0pOwogICAgIGBgYAogICAgICBAbWV0aG9kIGVhY2hSZWxhdGlvbnNoaXAKICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayB0aGUgY2FsbGJhY2sgdG8gaW52b2tlCiAgICAgQHBhcmFtIHthbnl9IGJpbmRpbmcgdGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBjYWxsYmFjaydzIGB0aGlzYCBzaG91bGQgYmUgYm91bmQKICAgICAqLwogICAgZWFjaFJlbGF0aW9uc2hpcDogZnVuY3Rpb24gZWFjaFJlbGF0aW9uc2hpcChjYWxsYmFjaywgYmluZGluZykgewogICAgICB0aGlzLmNvbnN0cnVjdG9yLmVhY2hSZWxhdGlvbnNoaXAoY2FsbGJhY2ssIGJpbmRpbmcpOwogICAgfSwKICAgIHJlbGF0aW9uc2hpcEZvcjogZnVuY3Rpb24gcmVsYXRpb25zaGlwRm9yKG5hbWUpIHsKICAgICAgcmV0dXJuIEVtYmVyLmdldCh0aGlzLmNvbnN0cnVjdG9yLCAncmVsYXRpb25zaGlwc0J5TmFtZScpLmdldChuYW1lKTsKICAgIH0sCiAgICBpbnZlcnNlRm9yOiBmdW5jdGlvbiBpbnZlcnNlRm9yKGtleSkgewogICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci5pbnZlcnNlRm9yKGtleSwgdGhpcy5faW50ZXJuYWxNb2RlbC5zdG9yZSk7CiAgICB9LAogICAgbm90aWZ5SGFzTWFueUFkZGVkOiBmdW5jdGlvbiBub3RpZnlIYXNNYW55QWRkZWQoa2V5KSB7CiAgICAgIC8vV2UgbmVlZCB0byBub3RpZnlQcm9wZXJ0eUNoYW5nZSBpbiB0aGUgYWRkaW5nIGNhc2UgYmVjYXVzZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZQogICAgICAvL3dlIGZldGNoIHRoZSBuZXdseSBhZGRlZCByZWNvcmQgaW4gY2FzZSBpdCBpcyB1bmxvYWRlZAogICAgICAvL1RPRE8oSWdvcik6IENvbnNpZGVyIHdoZXRoZXIgd2UgY291bGQgZG8gdGhpcyBvbmx5IGlmIHRoZSByZWNvcmQgc3RhdGUgaXMgdW5sb2FkZWQKICAgICAgdGhpcy5ub3RpZnlQcm9wZXJ0eUNoYW5nZShrZXkpOwogICAgfSwKICAgIGVhY2hBdHRyaWJ1dGU6IGZ1bmN0aW9uIGVhY2hBdHRyaWJ1dGUoY2FsbGJhY2ssIGJpbmRpbmcpIHsKICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5lYWNoQXR0cmlidXRlKGNhbGxiYWNrLCBiaW5kaW5nKTsKICAgIH0KICB9KTsKICAvKioKICAgQHByb3BlcnR5IGRhdGEKICAgQHByaXZhdGUKICAgQGRlcHJlY2F0ZWQKICAgQHR5cGUge09iamVjdH0KICAgKi8KCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KE1vZGVsLnByb3RvdHlwZSwgJ2RhdGEnLCB7CiAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBQcml2YXRlLnJlY29yZERhdGFGb3IodGhpcykuX2RhdGE7CiAgICB9CiAgfSk7CiAgdmFyIElEX0RFU0NSSVBUT1IgPSB7CiAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgc2V0OiBmdW5jdGlvbiBzZXQoaWQpIHsKICAgICAgdmFyIG5vcm1hbGl6ZWRJZCA9IFByaXZhdGUuY29lcmNlSWQoaWQpOwoKICAgICAgaWYgKG5vcm1hbGl6ZWRJZCAhPT0gbnVsbCkgewogICAgICAgIHRoaXMuX2ludGVybmFsTW9kZWwuc2V0SWQobm9ybWFsaXplZElkKTsKICAgICAgfQogICAgfSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAvLyB0aGUgX2ludGVybmFsTW9kZWwgZ3VhcmQgZXhpc3RzLCBiZWNhdXNlIHNvbWUgZGV2LW9ubHkgZGVwcmVjYXRpb24gY29kZQogICAgICAvLyAoYWRkTGlzdGVuZXIgdmlhIHZhbGlkYXRlUHJvcGVydHlJbmplY3Rpb25zKSBpbnZva2VzIHRvU3RyaW5nIGJlZm9yZSB0aGUKICAgICAgLy8gb2JqZWN0IGlzIHJlYWwuCiAgICAgIHJldHVybiB0aGlzLl9pbnRlcm5hbE1vZGVsICYmIHRoaXMuX2ludGVybmFsTW9kZWwuaWQ7CiAgICB9CiAgfTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTW9kZWwucHJvdG90eXBlLCAnaWQnLCBJRF9ERVNDUklQVE9SKTsKCiAgTW9kZWwucmVvcGVuQ2xhc3MoewogICAgaXNNb2RlbDogdHJ1ZSwKCiAgICAvKioKICAgICAgQ3JlYXRlIHNob3VsZCBvbmx5IGV2ZXIgYmUgY2FsbGVkIGJ5IHRoZSBzdG9yZS4gVG8gY3JlYXRlIGFuIGluc3RhbmNlIG9mIGEKICAgICAgYE1vZGVsYCBpbiBhIGRpcnR5IHN0YXRlIHVzZSBgc3RvcmUuY3JlYXRlUmVjb3JkYC4KICAgICAgVG8gY3JlYXRlIGluc3RhbmNlcyBvZiBgTW9kZWxgIGluIGEgY2xlYW4gc3RhdGUsIHVzZSBgc3RvcmUucHVzaGAKICAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgIEBwcml2YXRlCiAgICAgIEBzdGF0aWMKICAgICovCgogICAgLyoqCiAgICAgUmVwcmVzZW50cyB0aGUgbW9kZWwncyBjbGFzcyBuYW1lIGFzIGEgc3RyaW5nLiBUaGlzIGNhbiBiZSB1c2VkIHRvIGxvb2sgdXAgdGhlIG1vZGVsJ3MgY2xhc3MgbmFtZSB0aHJvdWdoCiAgICAgYFN0b3JlYCdzIG1vZGVsRm9yIG1ldGhvZC4KICAgICAgYG1vZGVsTmFtZWAgaXMgZ2VuZXJhdGVkIGZvciB5b3UgYnkgRW1iZXIgRGF0YS4gSXQgd2lsbCBiZSBhIGxvd2VyY2FzZWQsIGRhc2hlcml6ZWQgc3RyaW5nLgogICAgIEZvciBleGFtcGxlOgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgc3RvcmUubW9kZWxGb3IoJ3Bvc3QnKS5tb2RlbE5hbWU7IC8vICdwb3N0JwogICAgIHN0b3JlLm1vZGVsRm9yKCdibG9nLXBvc3QnKS5tb2RlbE5hbWU7IC8vICdibG9nLXBvc3QnCiAgICAgYGBgCiAgICAgIFRoZSBtb3N0IGNvbW1vbiBwbGFjZSB5b3UnbGwgd2FudCB0byBhY2Nlc3MgYG1vZGVsTmFtZWAgaXMgaW4geW91ciBzZXJpYWxpemVyJ3MgYHBheWxvYWRLZXlGcm9tTW9kZWxOYW1lYCBtZXRob2QuIEZvciBleGFtcGxlLCB0byBjaGFuZ2UgcGF5bG9hZAogICAgIGtleXMgdG8gdW5kZXJzY29yZSAoaW5zdGVhZCBvZiBkYXNoZXJpemVkKSwgeW91IG1pZ2h0IHVzZSB0aGUgZm9sbG93aW5nIGNvZGU6CiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBpbXBvcnQgUkVTVFNlcmlhbGl6ZXIgZnJvbSAnQGVtYmVyLWRhdGEvc2VyaWFsaXplci9yZXN0JzsKICAgICBpbXBvcnQgeyB1bmRlcnNjb3JlIH0gZnJvbSAnQGVtYmVyL3N0cmluZyc7CiAgICAgIGV4cG9ydCBkZWZhdWx0IGNvbnN0IFBvc3RTZXJpYWxpemVyID0gUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgIHBheWxvYWRLZXlGcm9tTW9kZWxOYW1lKG1vZGVsTmFtZSkgewogICAgICAgICByZXR1cm4gdW5kZXJzY29yZShtb2RlbE5hbWUpOwogICAgICAgfQogICAgIH0pOwogICAgIGBgYAogICAgIEBwcm9wZXJ0eSBtb2RlbE5hbWUKICAgICBAdHlwZSBTdHJpbmcKICAgICBAcmVhZG9ubHkKICAgICBAc3RhdGljCiAgICAqLwogICAgbW9kZWxOYW1lOiBudWxsLAoKICAgIC8qCiAgICAgVGhlc2UgY2xhc3MgbWV0aG9kcyBiZWxvdyBwcm92aWRlIHJlbGF0aW9uc2hpcAogICAgIGludHJvc3BlY3Rpb24gYWJpbGl0aWVzIGFib3V0IHJlbGF0aW9uc2hpcHMuCiAgICAgIEEgbm90ZSBhYm91dCB0aGUgY29tcHV0ZWQgcHJvcGVydGllcyBjb250YWluZWQgaGVyZToKICAgICAgKipUaGVzZSBwcm9wZXJ0aWVzIGFyZSBlZmZlY3RpdmVseSBzZWFsZWQgb25jZSBjYWxsZWQgZm9yIHRoZSBmaXJzdCB0aW1lLioqCiAgICAgVG8gYXZvaWQgcmVwZWF0ZWRseSBkb2luZyBleHBlbnNpdmUgaXRlcmF0aW9uIG92ZXIgYSBtb2RlbCdzIGZpZWxkcywgdGhlc2UKICAgICB2YWx1ZXMgYXJlIGNvbXB1dGVkIG9uY2UgYW5kIHRoZW4gY2FjaGVkIGZvciB0aGUgcmVtYWluZGVyIG9mIHRoZSBydW50aW1lIG9mCiAgICAgeW91ciBhcHBsaWNhdGlvbi4KICAgICAgSWYgeW91ciBhcHBsaWNhdGlvbiBuZWVkcyB0byBtb2RpZnkgYSBjbGFzcyBhZnRlciBpdHMgaW5pdGlhbCBkZWZpbml0aW9uCiAgICAgKGZvciBleGFtcGxlLCB1c2luZyBgcmVvcGVuKClgIHRvIGFkZCBhZGRpdGlvbmFsIGF0dHJpYnV0ZXMpLCBtYWtlIHN1cmUgeW91CiAgICAgZG8gaXQgYmVmb3JlIHVzaW5nIHlvdXIgbW9kZWwgd2l0aCB0aGUgc3RvcmUsIHdoaWNoIHVzZXMgdGhlc2UgcHJvcGVydGllcwogICAgIGV4dGVuc2l2ZWx5LgogICAgICovCgogICAgLyoqCiAgICAgRm9yIGEgZ2l2ZW4gcmVsYXRpb25zaGlwIG5hbWUsIHJldHVybnMgdGhlIG1vZGVsIHR5cGUgb2YgdGhlIHJlbGF0aW9uc2hpcC4KICAgICAgRm9yIGV4YW1wbGUsIGlmIHlvdSBkZWZpbmUgYSBtb2RlbCBsaWtlIHRoaXM6CiAgICAgIGBgYGFwcC9tb2RlbHMvcG9zdC5qcwogICAgIGltcG9ydCBNb2RlbCwgeyBoYXNNYW55IH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogICAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICAgIGNvbW1lbnRzOiBoYXNNYW55KCdjb21tZW50JykKICAgICAgfSk7CiAgICAgYGBgCiAgICAgIENhbGxpbmcgYHN0b3JlLm1vZGVsRm9yKCdwb3N0JykudHlwZUZvclJlbGF0aW9uc2hpcCgnY29tbWVudHMnLCBzdG9yZSlgIHdpbGwgcmV0dXJuIGBDb21tZW50YC4KICAgICAgQG1ldGhvZCB0eXBlRm9yUmVsYXRpb25zaGlwCiAgICAgQHN0YXRpYwogICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIHRoZSBuYW1lIG9mIHRoZSByZWxhdGlvbnNoaXAKICAgICBAcGFyYW0ge3N0b3JlfSBzdG9yZSBhbiBpbnN0YW5jZSBvZiBTdG9yZQogICAgIEByZXR1cm4ge01vZGVsfSB0aGUgdHlwZSBvZiB0aGUgcmVsYXRpb25zaGlwLCBvciB1bmRlZmluZWQKICAgICAqLwogICAgdHlwZUZvclJlbGF0aW9uc2hpcDogZnVuY3Rpb24gdHlwZUZvclJlbGF0aW9uc2hpcChuYW1lLCBzdG9yZSkgewogICAgICB2YXIgcmVsYXRpb25zaGlwID0gRW1iZXIuZ2V0KHRoaXMsICdyZWxhdGlvbnNoaXBzQnlOYW1lJykuZ2V0KG5hbWUpOwogICAgICByZXR1cm4gcmVsYXRpb25zaGlwICYmIHN0b3JlLm1vZGVsRm9yKHJlbGF0aW9uc2hpcC50eXBlKTsKICAgIH0sCiAgICBpbnZlcnNlTWFwOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgfSksCgogICAgLyoqCiAgICAgRmluZCB0aGUgcmVsYXRpb25zaGlwIHdoaWNoIGlzIHRoZSBpbnZlcnNlIG9mIHRoZSBvbmUgYXNrZWQgZm9yLgogICAgICBGb3IgZXhhbXBsZSwgaWYgeW91IGRlZmluZSBtb2RlbHMgbGlrZSB0aGlzOgogICAgICBgYGBhcHAvbW9kZWxzL3Bvc3QuanMKICAgICBpbXBvcnQgTW9kZWwsIHsgaGFzTWFueSB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKICAgICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgICBjb21tZW50czogaGFzTWFueSgnbWVzc2FnZScpCiAgICAgIH0pOwogICAgIGBgYAogICAgICBgYGBhcHAvbW9kZWxzL21lc3NhZ2UuanMKICAgICBpbXBvcnQgTW9kZWwsIHsgYmVsb25nc1RvIH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogICAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICAgIG93bmVyOiBiZWxvbmdzVG8oJ3Bvc3QnKQogICAgICB9KTsKICAgICBgYGAKICAgICAgYGBgIGpzCiAgICAgc3RvcmUubW9kZWxGb3IoJ3Bvc3QnKS5pbnZlcnNlRm9yKCdjb21tZW50cycsIHN0b3JlKSAvLyB7IHR5cGU6IEFwcC5NZXNzYWdlLCBuYW1lOiAnb3duZXInLCBraW5kOiAnYmVsb25nc1RvJyB9CiAgICAgc3RvcmUubW9kZWxGb3IoJ21lc3NhZ2UnKS5pbnZlcnNlRm9yKCdvd25lcicsIHN0b3JlKSAvLyB7IHR5cGU6IEFwcC5Qb3N0LCBuYW1lOiAnY29tbWVudHMnLCBraW5kOiAnaGFzTWFueScgfQogICAgIGBgYAogICAgICBAbWV0aG9kIGludmVyc2VGb3IKICAgICBAc3RhdGljCiAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIG5hbWUgb2YgdGhlIHJlbGF0aW9uc2hpcAogICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgQHJldHVybiB7T2JqZWN0fSB0aGUgaW52ZXJzZSByZWxhdGlvbnNoaXAsIG9yIG51bGwKICAgICAqLwogICAgaW52ZXJzZUZvcjogZnVuY3Rpb24gaW52ZXJzZUZvcihuYW1lLCBzdG9yZSkgewogICAgICB2YXIgaW52ZXJzZU1hcCA9IEVtYmVyLmdldCh0aGlzLCAnaW52ZXJzZU1hcCcpOwoKICAgICAgaWYgKGludmVyc2VNYXBbbmFtZV0pIHsKICAgICAgICByZXR1cm4gaW52ZXJzZU1hcFtuYW1lXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgaW52ZXJzZSA9IHRoaXMuX2ZpbmRJbnZlcnNlRm9yKG5hbWUsIHN0b3JlKTsKCiAgICAgICAgaW52ZXJzZU1hcFtuYW1lXSA9IGludmVyc2U7CiAgICAgICAgcmV0dXJuIGludmVyc2U7CiAgICAgIH0KICAgIH0sCiAgICAvL0NhbGN1bGF0ZSB0aGUgaW52ZXJzZSwgaWdub3JpbmcgdGhlIGNhY2hlCiAgICBfZmluZEludmVyc2VGb3I6IGZ1bmN0aW9uIF9maW5kSW52ZXJzZUZvcihuYW1lLCBzdG9yZSkgewogICAgICB2YXIgaW52ZXJzZVR5cGUgPSB0aGlzLnR5cGVGb3JSZWxhdGlvbnNoaXAobmFtZSwgc3RvcmUpOwoKICAgICAgaWYgKCFpbnZlcnNlVHlwZSkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICB2YXIgcHJvcGVydHlNZXRhID0gdGhpcy5tZXRhRm9yUHJvcGVydHkobmFtZSk7IC8vSWYgaW52ZXJzZSBpcyBtYW51YWxseSBzcGVjaWZpZWQgdG8gYmUgbnVsbCwgbGlrZSAgYGNvbW1lbnRzOiBoYXNNYW55KCdtZXNzYWdlJywgeyBpbnZlcnNlOiBudWxsIH0pYAoKICAgICAgdmFyIG9wdGlvbnMgPSBwcm9wZXJ0eU1ldGEub3B0aW9uczsKCiAgICAgIGlmIChvcHRpb25zLmludmVyc2UgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgdmFyIGludmVyc2VOYW1lLCBpbnZlcnNlS2luZCwgaW52ZXJzZSwgaW52ZXJzZU9wdGlvbnM7IC8vSWYgaW52ZXJzZSBpcyBzcGVjaWZpZWQgbWFudWFsbHksIHJldHVybiB0aGUgaW52ZXJzZQoKICAgICAgaWYgKG9wdGlvbnMuaW52ZXJzZSkgewogICAgICAgIGludmVyc2VOYW1lID0gb3B0aW9ucy5pbnZlcnNlOwogICAgICAgIGludmVyc2UgPSBFbWJlci5nZXQoaW52ZXJzZVR5cGUsICdyZWxhdGlvbnNoaXBzQnlOYW1lJykuZ2V0KGludmVyc2VOYW1lKTsKCiAgICAgICAgaW52ZXJzZUtpbmQgPSBpbnZlcnNlLmtpbmQ7CiAgICAgICAgaW52ZXJzZU9wdGlvbnMgPSBpbnZlcnNlLm9wdGlvbnM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy9ObyBpbnZlcnNlIHdhcyBzcGVjaWZpZWQgbWFudWFsbHksIHdlIG5lZWQgdG8gdXNlIGEgaGV1cmlzdGljIHRvIGd1ZXNzIG9uZQogICAgICAgIGlmIChwcm9wZXJ0eU1ldGEudHlwZSA9PT0gcHJvcGVydHlNZXRhLnBhcmVudE1vZGVsTmFtZSkgOwoKICAgICAgICB2YXIgcG9zc2libGVSZWxhdGlvbnNoaXBzID0gZmluZFBvc3NpYmxlSW52ZXJzZXModGhpcywgaW52ZXJzZVR5cGUsIG5hbWUpOwoKICAgICAgICBpZiAocG9zc2libGVSZWxhdGlvbnNoaXBzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICB2YXIgZmlsdGVyZWRSZWxhdGlvbnNoaXBzID0gcG9zc2libGVSZWxhdGlvbnNoaXBzLmZpbHRlcihmdW5jdGlvbiAocG9zc2libGVSZWxhdGlvbnNoaXApIHsKICAgICAgICAgIHZhciBvcHRpb25zRm9yUmVsYXRpb25zaGlwID0gaW52ZXJzZVR5cGUubWV0YUZvclByb3BlcnR5KHBvc3NpYmxlUmVsYXRpb25zaGlwLm5hbWUpLm9wdGlvbnM7CiAgICAgICAgICByZXR1cm4gbmFtZSA9PT0gb3B0aW9uc0ZvclJlbGF0aW9uc2hpcC5pbnZlcnNlOwogICAgICAgIH0pOwoKICAgICAgICBpZiAoZmlsdGVyZWRSZWxhdGlvbnNoaXBzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgcG9zc2libGVSZWxhdGlvbnNoaXBzID0gZmlsdGVyZWRSZWxhdGlvbnNoaXBzOwogICAgICAgIH0KICAgICAgICBpbnZlcnNlTmFtZSA9IHBvc3NpYmxlUmVsYXRpb25zaGlwc1swXS5uYW1lOwogICAgICAgIGludmVyc2VLaW5kID0gcG9zc2libGVSZWxhdGlvbnNoaXBzWzBdLmtpbmQ7CiAgICAgICAgaW52ZXJzZU9wdGlvbnMgPSBwb3NzaWJsZVJlbGF0aW9uc2hpcHNbMF0ub3B0aW9uczsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHR5cGU6IGludmVyc2VUeXBlLAogICAgICAgIG5hbWU6IGludmVyc2VOYW1lLAogICAgICAgIGtpbmQ6IGludmVyc2VLaW5kLAogICAgICAgIG9wdGlvbnM6IGludmVyc2VPcHRpb25zCiAgICAgIH07CiAgICB9LAoKICAgIC8qKgogICAgIFRoZSBtb2RlbCdzIHJlbGF0aW9uc2hpcHMgYXMgYSBtYXAsIGtleWVkIG9uIHRoZSB0eXBlIG9mIHRoZQogICAgIHJlbGF0aW9uc2hpcC4gVGhlIHZhbHVlIG9mIGVhY2ggZW50cnkgaXMgYW4gYXJyYXkgY29udGFpbmluZyBhIGRlc2NyaXB0b3IKICAgICBmb3IgZWFjaCByZWxhdGlvbnNoaXAgd2l0aCB0aGF0IHR5cGUsIGRlc2NyaWJpbmcgdGhlIG5hbWUgb2YgdGhlIHJlbGF0aW9uc2hpcAogICAgIGFzIHdlbGwgYXMgdGhlIHR5cGUuCiAgICAgIEZvciBleGFtcGxlLCBnaXZlbiB0aGUgZm9sbG93aW5nIG1vZGVsIGRlZmluaXRpb246CiAgICAgIGBgYGFwcC9tb2RlbHMvYmxvZy5qcwogICAgIGltcG9ydCBNb2RlbCwgeyBiZWxvbmdzVG8sIGhhc01hbnkgfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CiAgICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgICAgdXNlcnM6IGhhc01hbnkoJ3VzZXInKSwKICAgICAgICBvd25lcjogYmVsb25nc1RvKCd1c2VyJyksCiAgICAgICAgcG9zdHM6IGhhc01hbnkoJ3Bvc3QnKQogICAgICB9KTsKICAgICBgYGAKICAgICAgVGhpcyBjb21wdXRlZCBwcm9wZXJ0eSB3b3VsZCByZXR1cm4gYSBtYXAgZGVzY3JpYmluZyB0aGVzZQogICAgIHJlbGF0aW9uc2hpcHMsIGxpa2UgdGhpczoKICAgICAgYGBgamF2YXNjcmlwdAogICAgIGltcG9ydCBFbWJlciBmcm9tICdlbWJlcic7CiAgICAgaW1wb3J0IEJsb2cgZnJvbSAnYXBwL21vZGVscy9ibG9nJzsKICAgICBpbXBvcnQgVXNlciBmcm9tICdhcHAvbW9kZWxzL3VzZXInOwogICAgIGltcG9ydCBQb3N0IGZyb20gJ2FwcC9tb2RlbHMvcG9zdCc7CiAgICAgIGxldCByZWxhdGlvbnNoaXBzID0gRW1iZXIuZ2V0KEJsb2csICdyZWxhdGlvbnNoaXBzJyk7CiAgICAgcmVsYXRpb25zaGlwcy5nZXQoJ3VzZXInKTsKICAgICAvLz0+IFsgeyBuYW1lOiAndXNlcnMnLCBraW5kOiAnaGFzTWFueScgfSwKICAgICAvLyAgICAgeyBuYW1lOiAnb3duZXInLCBraW5kOiAnYmVsb25nc1RvJyB9IF0KICAgICByZWxhdGlvbnNoaXBzLmdldCgncG9zdCcpOwogICAgIC8vPT4gWyB7IG5hbWU6ICdwb3N0cycsIGtpbmQ6ICdoYXNNYW55JyB9IF0KICAgICBgYGAKICAgICAgQHByb3BlcnR5IHJlbGF0aW9uc2hpcHMKICAgICBAc3RhdGljCiAgICAgQHR5cGUgTWFwCiAgICAgQHJlYWRPbmx5CiAgICAgKi8KICAgIHJlbGF0aW9uc2hpcHM6IFByaXZhdGUucmVsYXRpb25zaGlwc0Rlc2NyaXB0b3IsCgogICAgLyoqCiAgICAgQSBoYXNoIGNvbnRhaW5pbmcgbGlzdHMgb2YgdGhlIG1vZGVsJ3MgcmVsYXRpb25zaGlwcywgZ3JvdXBlZAogICAgIGJ5IHRoZSByZWxhdGlvbnNoaXAga2luZC4gRm9yIGV4YW1wbGUsIGdpdmVuIGEgbW9kZWwgd2l0aCB0aGlzCiAgICAgZGVmaW5pdGlvbjoKICAgICAgYGBgYXBwL21vZGVscy9ibG9nLmpzCiAgICAgaW1wb3J0IE1vZGVsLCB7IGJlbG9uZ3NUbywgaGFzTWFueSB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKICAgICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgICB1c2VyczogaGFzTWFueSgndXNlcicpLAogICAgICAgIG93bmVyOiBiZWxvbmdzVG8oJ3VzZXInKSwKICAgICAgICAgcG9zdHM6IGhhc01hbnkoJ3Bvc3QnKQogICAgICB9KTsKICAgICBgYGAKICAgICAgVGhpcyBwcm9wZXJ0eSB3b3VsZCBjb250YWluIHRoZSBmb2xsb3dpbmc6CiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBpbXBvcnQgRW1iZXIgZnJvbSAnZW1iZXInOwogICAgIGltcG9ydCBCbG9nIGZyb20gJ2FwcC9tb2RlbHMvYmxvZyc7CiAgICAgIGxldCByZWxhdGlvbnNoaXBOYW1lcyA9IEVtYmVyLmdldChCbG9nLCAncmVsYXRpb25zaGlwTmFtZXMnKTsKICAgICByZWxhdGlvbnNoaXBOYW1lcy5oYXNNYW55OwogICAgIC8vPT4gWyd1c2VycycsICdwb3N0cyddCiAgICAgcmVsYXRpb25zaGlwTmFtZXMuYmVsb25nc1RvOwogICAgIC8vPT4gWydvd25lciddCiAgICAgYGBgCiAgICAgIEBwcm9wZXJ0eSByZWxhdGlvbnNoaXBOYW1lcwogICAgIEBzdGF0aWMKICAgICBAdHlwZSBPYmplY3QKICAgICBAcmVhZE9ubHkKICAgICAqLwogICAgcmVsYXRpb25zaGlwTmFtZXM6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIG5hbWVzID0gewogICAgICAgIGhhc01hbnk6IFtdLAogICAgICAgIGJlbG9uZ3NUbzogW10KICAgICAgfTsKICAgICAgdGhpcy5lYWNoQ29tcHV0ZWRQcm9wZXJ0eShmdW5jdGlvbiAobmFtZSwgbWV0YSkgewogICAgICAgIGlmIChtZXRhLmlzUmVsYXRpb25zaGlwKSB7CiAgICAgICAgICBuYW1lc1ttZXRhLmtpbmRdLnB1c2gobmFtZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIG5hbWVzOwogICAgfSksCgogICAgLyoqCiAgICAgQW4gYXJyYXkgb2YgdHlwZXMgZGlyZWN0bHkgcmVsYXRlZCB0byBhIG1vZGVsLiBFYWNoIHR5cGUgd2lsbCBiZQogICAgIGluY2x1ZGVkIG9uY2UsIHJlZ2FyZGxlc3Mgb2YgdGhlIG51bWJlciBvZiByZWxhdGlvbnNoaXBzIGl0IGhhcyB3aXRoCiAgICAgdGhlIG1vZGVsLgogICAgICBGb3IgZXhhbXBsZSwgZ2l2ZW4gYSBtb2RlbCB3aXRoIHRoaXMgZGVmaW5pdGlvbjoKICAgICAgYGBgYXBwL21vZGVscy9ibG9nLmpzCiAgICAgaW1wb3J0IE1vZGVsLCB7IGJlbG9uZ3NUbywgaGFzTWFueSB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKICAgICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgICB1c2VyczogaGFzTWFueSgndXNlcicpLAogICAgICAgIG93bmVyOiBiZWxvbmdzVG8oJ3VzZXInKSwKICAgICAgICAgcG9zdHM6IGhhc01hbnkoJ3Bvc3QnKQogICAgICB9KTsKICAgICBgYGAKICAgICAgVGhpcyBwcm9wZXJ0eSB3b3VsZCBjb250YWluIHRoZSBmb2xsb3dpbmc6CiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBpbXBvcnQgRW1iZXIgZnJvbSAnZW1iZXInOwogICAgIGltcG9ydCBCbG9nIGZyb20gJ2FwcC9tb2RlbHMvYmxvZyc7CiAgICAgIGxldCByZWxhdGVkVHlwZXMgPSBFbWJlci5nZXQoQmxvZywgJ3JlbGF0ZWRUeXBlcycpOwogICAgIC8vPT4gWyBVc2VyLCBQb3N0IF0KICAgICBgYGAKICAgICAgQHByb3BlcnR5IHJlbGF0ZWRUeXBlcwogICAgIEBzdGF0aWMKICAgICBAdHlwZSBFbWJlci5BcnJheQogICAgIEByZWFkT25seQogICAgICovCiAgICByZWxhdGVkVHlwZXM6IFByaXZhdGUucmVsYXRlZFR5cGVzRGVzY3JpcHRvciwKCiAgICAvKioKICAgICBBIG1hcCB3aG9zZSBrZXlzIGFyZSB0aGUgcmVsYXRpb25zaGlwcyBvZiBhIG1vZGVsIGFuZCB3aG9zZSB2YWx1ZXMgYXJlCiAgICAgcmVsYXRpb25zaGlwIGRlc2NyaXB0b3JzLgogICAgICBGb3IgZXhhbXBsZSwgZ2l2ZW4gYSBtb2RlbCB3aXRoIHRoaXMKICAgICBkZWZpbml0aW9uOgogICAgICBgYGBhcHAvbW9kZWxzL2Jsb2cuanMKICAgICBpbXBvcnQgTW9kZWwsIHsgYmVsb25nc1RvLCBoYXNNYW55IH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogICAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICAgIHVzZXJzOiBoYXNNYW55KCd1c2VyJyksCiAgICAgICAgb3duZXI6IGJlbG9uZ3NUbygndXNlcicpLAogICAgICAgICBwb3N0czogaGFzTWFueSgncG9zdCcpCiAgICAgIH0pOwogICAgIGBgYAogICAgICBUaGlzIHByb3BlcnR5IHdvdWxkIGNvbnRhaW4gdGhlIGZvbGxvd2luZzoKICAgICAgYGBgamF2YXNjcmlwdAogICAgIGltcG9ydCBFbWJlciBmcm9tICdlbWJlcic7CiAgICAgaW1wb3J0IEJsb2cgZnJvbSAnYXBwL21vZGVscy9ibG9nJzsKICAgICAgbGV0IHJlbGF0aW9uc2hpcHNCeU5hbWUgPSBFbWJlci5nZXQoQmxvZywgJ3JlbGF0aW9uc2hpcHNCeU5hbWUnKTsKICAgICByZWxhdGlvbnNoaXBzQnlOYW1lLmdldCgndXNlcnMnKTsKICAgICAvLz0+IHsga2V5OiAndXNlcnMnLCBraW5kOiAnaGFzTWFueScsIHR5cGU6ICd1c2VyJywgb3B0aW9uczogT2JqZWN0LCBpc1JlbGF0aW9uc2hpcDogdHJ1ZSB9CiAgICAgcmVsYXRpb25zaGlwc0J5TmFtZS5nZXQoJ293bmVyJyk7CiAgICAgLy89PiB7IGtleTogJ293bmVyJywga2luZDogJ2JlbG9uZ3NUbycsIHR5cGU6ICd1c2VyJywgb3B0aW9uczogT2JqZWN0LCBpc1JlbGF0aW9uc2hpcDogdHJ1ZSB9CiAgICAgYGBgCiAgICAgIEBwcm9wZXJ0eSByZWxhdGlvbnNoaXBzQnlOYW1lCiAgICAgQHN0YXRpYwogICAgIEB0eXBlIE1hcAogICAgIEByZWFkT25seQogICAgICovCiAgICByZWxhdGlvbnNoaXBzQnlOYW1lOiBQcml2YXRlLnJlbGF0aW9uc2hpcHNCeU5hbWVEZXNjcmlwdG9yLAogICAgcmVsYXRpb25zaGlwc09iamVjdDogUHJpdmF0ZS5yZWxhdGlvbnNoaXBzT2JqZWN0RGVzY3JpcHRvciwKCiAgICAvKioKICAgICBBIG1hcCB3aG9zZSBrZXlzIGFyZSB0aGUgZmllbGRzIG9mIHRoZSBtb2RlbCBhbmQgd2hvc2UgdmFsdWVzIGFyZSBzdHJpbmdzCiAgICAgZGVzY3JpYmluZyB0aGUga2luZCBvZiB0aGUgZmllbGQuIEEgbW9kZWwncyBmaWVsZHMgYXJlIHRoZSB1bmlvbiBvZiBhbGwgb2YgaXRzCiAgICAgYXR0cmlidXRlcyBhbmQgcmVsYXRpb25zaGlwcy4KICAgICAgRm9yIGV4YW1wbGU6CiAgICAgIGBgYGFwcC9tb2RlbHMvYmxvZy5qcwogICAgIGltcG9ydCBNb2RlbCwgeyBhdHRyLCBiZWxvbmdzVG8sIGhhc01hbnkgfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CiAgICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgICAgdXNlcnM6IGhhc01hbnkoJ3VzZXInKSwKICAgICAgICBvd25lcjogYmVsb25nc1RvKCd1c2VyJyksCiAgICAgICAgIHBvc3RzOiBoYXNNYW55KCdwb3N0JyksCiAgICAgICAgIHRpdGxlOiBhdHRyKCdzdHJpbmcnKQogICAgICB9KTsKICAgICBgYGAKICAgICAgYGBganMKICAgICBpbXBvcnQgRW1iZXIgZnJvbSAnZW1iZXInOwogICAgIGltcG9ydCBCbG9nIGZyb20gJ2FwcC9tb2RlbHMvYmxvZyc7CiAgICAgIGxldCBmaWVsZHMgPSBFbWJlci5nZXQoQmxvZywgJ2ZpZWxkcycpOwogICAgIGZpZWxkcy5mb3JFYWNoKGZ1bmN0aW9uKGtpbmQsIGZpZWxkKSB7CiAgICAgICAgY29uc29sZS5sb2coZmllbGQsIGtpbmQpOwogICAgICB9KTsKICAgICAgLy8gcHJpbnRzOgogICAgIC8vIHVzZXJzLCBoYXNNYW55CiAgICAgLy8gb3duZXIsIGJlbG9uZ3NUbwogICAgIC8vIHBvc3RzLCBoYXNNYW55CiAgICAgLy8gdGl0bGUsIGF0dHJpYnV0ZQogICAgIGBgYAogICAgICBAcHJvcGVydHkgZmllbGRzCiAgICAgQHN0YXRpYwogICAgIEB0eXBlIE1hcAogICAgIEByZWFkT25seQogICAgICovCiAgICBmaWVsZHM6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIG1hcCA9IG5ldyBNYXAoKTsKICAgICAgdGhpcy5lYWNoQ29tcHV0ZWRQcm9wZXJ0eShmdW5jdGlvbiAobmFtZSwgbWV0YSkgewogICAgICAgIGlmIChtZXRhLmlzUmVsYXRpb25zaGlwKSB7CiAgICAgICAgICBtYXAuc2V0KG5hbWUsIG1ldGEua2luZCk7CiAgICAgICAgfSBlbHNlIGlmIChtZXRhLmlzQXR0cmlidXRlKSB7CiAgICAgICAgICBtYXAuc2V0KG5hbWUsICdhdHRyaWJ1dGUnKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gbWFwOwogICAgfSkucmVhZE9ubHkoKSwKCiAgICAvKioKICAgICBHaXZlbiBhIGNhbGxiYWNrLCBpdGVyYXRlcyBvdmVyIGVhY2ggb2YgdGhlIHJlbGF0aW9uc2hpcHMgaW4gdGhlIG1vZGVsLAogICAgIGludm9raW5nIHRoZSBjYWxsYmFjayB3aXRoIHRoZSBuYW1lIG9mIGVhY2ggcmVsYXRpb25zaGlwIGFuZCBpdHMgcmVsYXRpb25zaGlwCiAgICAgZGVzY3JpcHRvci4KICAgICAgQG1ldGhvZCBlYWNoUmVsYXRpb25zaGlwCiAgICAgQHN0YXRpYwogICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIHRoZSBjYWxsYmFjayB0byBpbnZva2UKICAgICBAcGFyYW0ge2FueX0gYmluZGluZyB0aGUgdmFsdWUgdG8gd2hpY2ggdGhlIGNhbGxiYWNrJ3MgYHRoaXNgIHNob3VsZCBiZSBib3VuZAogICAgICovCiAgICBlYWNoUmVsYXRpb25zaGlwOiBmdW5jdGlvbiBlYWNoUmVsYXRpb25zaGlwKGNhbGxiYWNrLCBiaW5kaW5nKSB7CiAgICAgIEVtYmVyLmdldCh0aGlzLCAncmVsYXRpb25zaGlwc0J5TmFtZScpLmZvckVhY2goZnVuY3Rpb24gKHJlbGF0aW9uc2hpcCwgbmFtZSkgewogICAgICAgIGNhbGxiYWNrLmNhbGwoYmluZGluZywgbmFtZSwgcmVsYXRpb25zaGlwKTsKICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgIEdpdmVuIGEgY2FsbGJhY2ssIGl0ZXJhdGVzIG92ZXIgZWFjaCBvZiB0aGUgdHlwZXMgcmVsYXRlZCB0byBhIG1vZGVsLAogICAgIGludm9raW5nIHRoZSBjYWxsYmFjayB3aXRoIHRoZSByZWxhdGVkIHR5cGUncyBjbGFzcy4gRWFjaCB0eXBlIHdpbGwgYmUKICAgICByZXR1cm5lZCBqdXN0IG9uY2UsIHJlZ2FyZGxlc3Mgb2YgaG93IG1hbnkgZGlmZmVyZW50IHJlbGF0aW9uc2hpcHMgaXQgaGFzCiAgICAgd2l0aCBhIG1vZGVsLgogICAgICBAbWV0aG9kIGVhY2hSZWxhdGVkVHlwZQogICAgIEBzdGF0aWMKICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayB0aGUgY2FsbGJhY2sgdG8gaW52b2tlCiAgICAgQHBhcmFtIHthbnl9IGJpbmRpbmcgdGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBjYWxsYmFjaydzIGB0aGlzYCBzaG91bGQgYmUgYm91bmQKICAgICAqLwogICAgZWFjaFJlbGF0ZWRUeXBlOiBmdW5jdGlvbiBlYWNoUmVsYXRlZFR5cGUoY2FsbGJhY2ssIGJpbmRpbmcpIHsKICAgICAgdmFyIHJlbGF0aW9uc2hpcFR5cGVzID0gRW1iZXIuZ2V0KHRoaXMsICdyZWxhdGVkVHlwZXMnKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVsYXRpb25zaGlwVHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgdHlwZSA9IHJlbGF0aW9uc2hpcFR5cGVzW2ldOwogICAgICAgIGNhbGxiYWNrLmNhbGwoYmluZGluZywgdHlwZSk7CiAgICAgIH0KICAgIH0sCiAgICBkZXRlcm1pbmVSZWxhdGlvbnNoaXBUeXBlOiBmdW5jdGlvbiBkZXRlcm1pbmVSZWxhdGlvbnNoaXBUeXBlKGtub3duU2lkZSwgc3RvcmUpIHsKICAgICAgdmFyIGtub3duS2V5ID0ga25vd25TaWRlLmtleTsKICAgICAgdmFyIGtub3duS2luZCA9IGtub3duU2lkZS5raW5kOwogICAgICB2YXIgaW52ZXJzZSA9IHRoaXMuaW52ZXJzZUZvcihrbm93bktleSwgc3RvcmUpOyAvLyBsZXQga2V5OwoKICAgICAgdmFyIG90aGVyS2luZDsKCiAgICAgIGlmICghaW52ZXJzZSkgewogICAgICAgIHJldHVybiBrbm93bktpbmQgPT09ICdiZWxvbmdzVG8nID8gJ29uZVRvTm9uZScgOiAnbWFueVRvTm9uZSc7CiAgICAgIH0gLy8ga2V5ID0gaW52ZXJzZS5uYW1lOwoKCiAgICAgIG90aGVyS2luZCA9IGludmVyc2Uua2luZDsKCiAgICAgIGlmIChvdGhlcktpbmQgPT09ICdiZWxvbmdzVG8nKSB7CiAgICAgICAgcmV0dXJuIGtub3duS2luZCA9PT0gJ2JlbG9uZ3NUbycgPyAnb25lVG9PbmUnIDogJ21hbnlUb09uZSc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGtub3duS2luZCA9PT0gJ2JlbG9uZ3NUbycgPyAnb25lVG9NYW55JyA6ICdtYW55VG9NYW55JzsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICBBIG1hcCB3aG9zZSBrZXlzIGFyZSB0aGUgYXR0cmlidXRlcyBvZiB0aGUgbW9kZWwgKHByb3BlcnRpZXMKICAgICBkZXNjcmliZWQgYnkgYXR0cikgYW5kIHdob3NlIHZhbHVlcyBhcmUgdGhlIG1ldGEgb2JqZWN0IGZvciB0aGUKICAgICBwcm9wZXJ0eS4KICAgICAgRXhhbXBsZQogICAgICBgYGBhcHAvbW9kZWxzL3BlcnNvbi5qcwogICAgIGltcG9ydCBNb2RlbCwgeyBhdHRyIH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogICAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICAgIGZpcnN0TmFtZTogYXR0cignc3RyaW5nJyksCiAgICAgICAgbGFzdE5hbWU6IGF0dHIoJ3N0cmluZycpLAogICAgICAgIGJpcnRoZGF5OiBhdHRyKCdkYXRlJykKICAgICAgfSk7CiAgICAgYGBgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBpbXBvcnQgRW1iZXIgZnJvbSAnZW1iZXInOwogICAgIGltcG9ydCBQZXJzb24gZnJvbSAnYXBwL21vZGVscy9wZXJzb24nOwogICAgICBsZXQgYXR0cmlidXRlcyA9IEVtYmVyLmdldChQZXJzb24sICdhdHRyaWJ1dGVzJykKICAgICAgYXR0cmlidXRlcy5mb3JFYWNoKGZ1bmN0aW9uKG1ldGEsIG5hbWUpIHsKICAgICAgICBjb25zb2xlLmxvZyhuYW1lLCBtZXRhKTsKICAgICAgfSk7CiAgICAgIC8vIHByaW50czoKICAgICAvLyBmaXJzdE5hbWUge3R5cGU6ICJzdHJpbmciLCBpc0F0dHJpYnV0ZTogdHJ1ZSwgb3B0aW9uczogT2JqZWN0LCBwYXJlbnRUeXBlOiBmdW5jdGlvbiwgbmFtZTogImZpcnN0TmFtZSJ9CiAgICAgLy8gbGFzdE5hbWUge3R5cGU6ICJzdHJpbmciLCBpc0F0dHJpYnV0ZTogdHJ1ZSwgb3B0aW9uczogT2JqZWN0LCBwYXJlbnRUeXBlOiBmdW5jdGlvbiwgbmFtZTogImxhc3ROYW1lIn0KICAgICAvLyBiaXJ0aGRheSB7dHlwZTogImRhdGUiLCBpc0F0dHJpYnV0ZTogdHJ1ZSwgb3B0aW9uczogT2JqZWN0LCBwYXJlbnRUeXBlOiBmdW5jdGlvbiwgbmFtZTogImJpcnRoZGF5In0KICAgICBgYGAKICAgICAgQHByb3BlcnR5IGF0dHJpYnV0ZXMKICAgICBAc3RhdGljCiAgICAgQHR5cGUge01hcH0KICAgICBAcmVhZE9ubHkKICAgICAqLwogICAgYXR0cmlidXRlczogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24gKCkgewoKICAgICAgdmFyIG1hcCA9IG5ldyBNYXAoKTsKICAgICAgdGhpcy5lYWNoQ29tcHV0ZWRQcm9wZXJ0eShmdW5jdGlvbiAobmFtZSwgbWV0YSkgewogICAgICAgIGlmIChtZXRhLmlzQXR0cmlidXRlKSB7CiAgICAgICAgICBtZXRhLm5hbWUgPSBuYW1lOwogICAgICAgICAgbWFwLnNldChuYW1lLCBtZXRhKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gbWFwOwogICAgfSkucmVhZE9ubHkoKSwKCiAgICAvKioKICAgICBBIG1hcCB3aG9zZSBrZXlzIGFyZSB0aGUgYXR0cmlidXRlcyBvZiB0aGUgbW9kZWwgKHByb3BlcnRpZXMKICAgICBkZXNjcmliZWQgYnkgYXR0cikgYW5kIHdob3NlIHZhbHVlcyBhcmUgdHlwZSBvZiB0cmFuc2Zvcm1hdGlvbgogICAgIGFwcGxpZWQgdG8gZWFjaCBhdHRyaWJ1dGUuIFRoaXMgbWFwIGRvZXMgbm90IGluY2x1ZGUgYW55CiAgICAgYXR0cmlidXRlcyB0aGF0IGRvIG5vdCBoYXZlIGFuIHRyYW5zZm9ybWF0aW9uIHR5cGUuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgYXBwL21vZGVscy9wZXJzb24uanMKICAgICBpbXBvcnQgTW9kZWwsIHsgYXR0ciB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKICAgICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgICBmaXJzdE5hbWU6IGF0dHIoKSwKICAgICAgICBsYXN0TmFtZTogYXR0cignc3RyaW5nJyksCiAgICAgICAgYmlydGhkYXk6IGF0dHIoJ2RhdGUnKQogICAgICB9KTsKICAgICBgYGAKICAgICAgYGBgamF2YXNjcmlwdAogICAgIGltcG9ydCBFbWJlciBmcm9tICdlbWJlcic7CiAgICAgaW1wb3J0IFBlcnNvbiBmcm9tICdhcHAvbW9kZWxzL3BlcnNvbic7CiAgICAgIGxldCB0cmFuc2Zvcm1lZEF0dHJpYnV0ZXMgPSBFbWJlci5nZXQoUGVyc29uLCAndHJhbnNmb3JtZWRBdHRyaWJ1dGVzJykKICAgICAgdHJhbnNmb3JtZWRBdHRyaWJ1dGVzLmZvckVhY2goZnVuY3Rpb24oZmllbGQsIHR5cGUpIHsKICAgICAgICBjb25zb2xlLmxvZyhmaWVsZCwgdHlwZSk7CiAgICAgIH0pOwogICAgICAvLyBwcmludHM6CiAgICAgLy8gbGFzdE5hbWUgc3RyaW5nCiAgICAgLy8gYmlydGhkYXkgZGF0ZQogICAgIGBgYAogICAgICBAcHJvcGVydHkgdHJhbnNmb3JtZWRBdHRyaWJ1dGVzCiAgICAgQHN0YXRpYwogICAgIEB0eXBlIHtNYXB9CiAgICAgQHJlYWRPbmx5CiAgICAgKi8KICAgIHRyYW5zZm9ybWVkQXR0cmlidXRlczogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24gKCkgewogICAgICB2YXIgbWFwID0gbmV3IE1hcCgpOwogICAgICB0aGlzLmVhY2hBdHRyaWJ1dGUoZnVuY3Rpb24gKGtleSwgbWV0YSkgewogICAgICAgIGlmIChtZXRhLnR5cGUpIHsKICAgICAgICAgIG1hcC5zZXQoa2V5LCBtZXRhLnR5cGUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBtYXA7CiAgICB9KS5yZWFkT25seSgpLAoKICAgIC8qKgogICAgIEl0ZXJhdGVzIHRocm91Z2ggdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsLCBjYWxsaW5nIHRoZSBwYXNzZWQgZnVuY3Rpb24gb24gZWFjaAogICAgIGF0dHJpYnV0ZS4KICAgICAgVGhlIGNhbGxiYWNrIG1ldGhvZCB5b3UgcHJvdmlkZSBzaG91bGQgaGF2ZSB0aGUgZm9sbG93aW5nIHNpZ25hdHVyZSAoYWxsCiAgICAgcGFyYW1ldGVycyBhcmUgb3B0aW9uYWwpOgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgZnVuY3Rpb24obmFtZSwgbWV0YSk7CiAgICAgYGBgCiAgICAgIC0gYG5hbWVgIHRoZSBuYW1lIG9mIHRoZSBjdXJyZW50IHByb3BlcnR5IGluIHRoZSBpdGVyYXRpb24KICAgICAtIGBtZXRhYCB0aGUgbWV0YSBvYmplY3QgZm9yIHRoZSBhdHRyaWJ1dGUgcHJvcGVydHkgaW4gdGhlIGl0ZXJhdGlvbgogICAgICBOb3RlIHRoYXQgaW4gYWRkaXRpb24gdG8gYSBjYWxsYmFjaywgeW91IGNhbiBhbHNvIHBhc3MgYW4gb3B0aW9uYWwgdGFyZ2V0CiAgICAgb2JqZWN0IHRoYXQgd2lsbCBiZSBzZXQgYXMgYHRoaXNgIG9uIHRoZSBjb250ZXh0LgogICAgICBFeGFtcGxlCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBpbXBvcnQgTW9kZWwsIHsgYXR0ciB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKICAgICAgbGV0IFBlcnNvbiA9IE1vZGVsLmV4dGVuZCh7CiAgICAgICAgZmlyc3ROYW1lOiBhdHRyKCdzdHJpbmcnKSwKICAgICAgICBsYXN0TmFtZTogYXR0cignc3RyaW5nJyksCiAgICAgICAgYmlydGhkYXk6IGF0dHIoJ2RhdGUnKQogICAgICB9KTsKICAgICAgUGVyc29uLmVhY2hBdHRyaWJ1dGUoZnVuY3Rpb24obmFtZSwgbWV0YSkgewogICAgICAgIGNvbnNvbGUubG9nKG5hbWUsIG1ldGEpOwogICAgICB9KTsKICAgICAgLy8gcHJpbnRzOgogICAgIC8vIGZpcnN0TmFtZSB7dHlwZTogInN0cmluZyIsIGlzQXR0cmlidXRlOiB0cnVlLCBvcHRpb25zOiBPYmplY3QsIHBhcmVudFR5cGU6IGZ1bmN0aW9uLCBuYW1lOiAiZmlyc3ROYW1lIn0KICAgICAvLyBsYXN0TmFtZSB7dHlwZTogInN0cmluZyIsIGlzQXR0cmlidXRlOiB0cnVlLCBvcHRpb25zOiBPYmplY3QsIHBhcmVudFR5cGU6IGZ1bmN0aW9uLCBuYW1lOiAibGFzdE5hbWUifQogICAgIC8vIGJpcnRoZGF5IHt0eXBlOiAiZGF0ZSIsIGlzQXR0cmlidXRlOiB0cnVlLCBvcHRpb25zOiBPYmplY3QsIHBhcmVudFR5cGU6IGZ1bmN0aW9uLCBuYW1lOiAiYmlydGhkYXkifQogICAgIGBgYAogICAgICBAbWV0aG9kIGVhY2hBdHRyaWJ1dGUKICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgdG8gZXhlY3V0ZQogICAgIEBwYXJhbSB7T2JqZWN0fSBbYmluZGluZ10gdGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBjYWxsYmFjaydzIGB0aGlzYCBzaG91bGQgYmUgYm91bmQKICAgICBAc3RhdGljCiAgICAgKi8KICAgIGVhY2hBdHRyaWJ1dGU6IGZ1bmN0aW9uIGVhY2hBdHRyaWJ1dGUoY2FsbGJhY2ssIGJpbmRpbmcpIHsKICAgICAgRW1iZXIuZ2V0KHRoaXMsICdhdHRyaWJ1dGVzJykuZm9yRWFjaChmdW5jdGlvbiAobWV0YSwgbmFtZSkgewogICAgICAgIGNhbGxiYWNrLmNhbGwoYmluZGluZywgbmFtZSwgbWV0YSk7CiAgICAgIH0pOwogICAgfSwKCiAgICAvKioKICAgICBJdGVyYXRlcyB0aHJvdWdoIHRoZSB0cmFuc2Zvcm1lZEF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsLCBjYWxsaW5nCiAgICAgdGhlIHBhc3NlZCBmdW5jdGlvbiBvbiBlYWNoIGF0dHJpYnV0ZS4gTm90ZSB0aGUgY2FsbGJhY2sgd2lsbCBub3QgYmUKICAgICBjYWxsZWQgZm9yIGFueSBhdHRyaWJ1dGVzIHRoYXQgZG8gbm90IGhhdmUgYW4gdHJhbnNmb3JtYXRpb24gdHlwZS4KICAgICAgVGhlIGNhbGxiYWNrIG1ldGhvZCB5b3UgcHJvdmlkZSBzaG91bGQgaGF2ZSB0aGUgZm9sbG93aW5nIHNpZ25hdHVyZSAoYWxsCiAgICAgcGFyYW1ldGVycyBhcmUgb3B0aW9uYWwpOgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgZnVuY3Rpb24obmFtZSwgdHlwZSk7CiAgICAgYGBgCiAgICAgIC0gYG5hbWVgIHRoZSBuYW1lIG9mIHRoZSBjdXJyZW50IHByb3BlcnR5IGluIHRoZSBpdGVyYXRpb24KICAgICAtIGB0eXBlYCBhIHN0cmluZyBjb250YWluaW5nIHRoZSBuYW1lIG9mIHRoZSB0eXBlIG9mIHRyYW5zZm9ybWVkCiAgICAgYXBwbGllZCB0byB0aGUgYXR0cmlidXRlCiAgICAgIE5vdGUgdGhhdCBpbiBhZGRpdGlvbiB0byBhIGNhbGxiYWNrLCB5b3UgY2FuIGFsc28gcGFzcyBhbiBvcHRpb25hbCB0YXJnZXQKICAgICBvYmplY3QgdGhhdCB3aWxsIGJlIHNldCBhcyBgdGhpc2Agb24gdGhlIGNvbnRleHQuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgamF2YXNjcmlwdAogICAgIGltcG9ydCBNb2RlbCwgeyBhdHRyIH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogICAgICBsZXQgUGVyc29uID0gTW9kZWwuZXh0ZW5kKHsKICAgICAgICBmaXJzdE5hbWU6IGF0dHIoKSwKICAgICAgICBsYXN0TmFtZTogYXR0cignc3RyaW5nJyksCiAgICAgICAgYmlydGhkYXk6IGF0dHIoJ2RhdGUnKQogICAgICB9KTsKICAgICAgUGVyc29uLmVhY2hUcmFuc2Zvcm1lZEF0dHJpYnV0ZShmdW5jdGlvbihuYW1lLCB0eXBlKSB7CiAgICAgICAgY29uc29sZS5sb2cobmFtZSwgdHlwZSk7CiAgICAgIH0pOwogICAgICAvLyBwcmludHM6CiAgICAgLy8gbGFzdE5hbWUgc3RyaW5nCiAgICAgLy8gYmlydGhkYXkgZGF0ZQogICAgIGBgYAogICAgICBAbWV0aG9kIGVhY2hUcmFuc2Zvcm1lZEF0dHJpYnV0ZQogICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayB0byBleGVjdXRlCiAgICAgQHBhcmFtIHtPYmplY3R9IFtiaW5kaW5nXSB0aGUgdmFsdWUgdG8gd2hpY2ggdGhlIGNhbGxiYWNrJ3MgYHRoaXNgIHNob3VsZCBiZSBib3VuZAogICAgIEBzdGF0aWMKICAgICAqLwogICAgZWFjaFRyYW5zZm9ybWVkQXR0cmlidXRlOiBmdW5jdGlvbiBlYWNoVHJhbnNmb3JtZWRBdHRyaWJ1dGUoY2FsbGJhY2ssIGJpbmRpbmcpIHsKICAgICAgRW1iZXIuZ2V0KHRoaXMsICd0cmFuc2Zvcm1lZEF0dHJpYnV0ZXMnKS5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlLCBuYW1lKSB7CiAgICAgICAgY2FsbGJhY2suY2FsbChiaW5kaW5nLCBuYW1lLCB0eXBlKTsKICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgIFJldHVybnMgdGhlIG5hbWUgb2YgdGhlIG1vZGVsIGNsYXNzLgogICAgICBAbWV0aG9kIHRvU3RyaW5nCiAgICAgQHN0YXRpYwogICAgICovCiAgICB0b1N0cmluZzogZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgIHJldHVybiAibW9kZWw6IiArIEVtYmVyLmdldCh0aGlzLCAnbW9kZWxOYW1lJyk7CiAgICB9CiAgfSk7CgogIGV4cG9ydHMuRXJyb3JzID0gRXJyb3JzOwogIGV4cG9ydHMuTW9kZWwgPSBNb2RlbDsKICBleHBvcnRzLmF0dHIgPSBhdHRyJDE7CiAgZXhwb3J0cy5iZWxvbmdzVG8gPSBiZWxvbmdzVG8kMTsKICBleHBvcnRzLmhhc01hbnkgPSBoYXNNYW55JDE7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsgdmFsdWU6IHRydWUgfSk7Cgp9KTsKCjtkZWZpbmUoIkBlbWJlci1kYXRhL21vZGVsL2luZGV4IiwgWyJleHBvcnRzIiwgIkBlbWJlci1kYXRhL21vZGVsLy1wcml2YXRlIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX3ByaXZhdGUpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImRlZmF1bHQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcHJpdmF0ZS5Nb2RlbDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJhdHRyIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3ByaXZhdGUuYXR0cjsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJiZWxvbmdzVG8iLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcHJpdmF0ZS5iZWxvbmdzVG87CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiaGFzTWFueSIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9wcml2YXRlLmhhc01hbnk7CiAgICB9CiAgfSk7Cn0pOwo7ZGVmaW5lKCdAZW1iZXItZGF0YS9yZWNvcmQtZGF0YS8tcHJpdmF0ZScsIFsnZXhwb3J0cycsICdAZW1iZXItZGF0YS9zdG9yZS8tcHJpdmF0ZScsICdAZW1iZXIvb3JkZXJlZC1zZXQnLCAnQGVtYmVyLWRhdGEvY2FuYXJ5LWZlYXR1cmVzJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBQcml2YXRlLCBFbWJlck9yZGVyZWRTZXQsIGNhbmFyeUZlYXR1cmVzKSB7ICd1c2Ugc3RyaWN0JzsKCiAgRW1iZXJPcmRlcmVkU2V0ID0gRW1iZXJPcmRlcmVkU2V0ICYmIEVtYmVyT3JkZXJlZFNldC5oYXNPd25Qcm9wZXJ0eSgnZGVmYXVsdCcpID8gRW1iZXJPcmRlcmVkU2V0WydkZWZhdWx0J10gOiBFbWJlck9yZGVyZWRTZXQ7CgogIGZ1bmN0aW9uIHJlbGF0aW9uc2hpcHNGb3IoaW5zdGFuY2UpIHsKICAgIHZhciByZWNvcmREYXRhID0gUHJpdmF0ZS5yZWNvcmREYXRhRm9yKGluc3RhbmNlKSB8fCBpbnN0YW5jZTsKICAgIHJldHVybiByZWNvcmREYXRhLl9yZWxhdGlvbnNoaXBzOwogIH0KICBmdW5jdGlvbiByZWxhdGlvbnNoaXBTdGF0ZUZvcihpbnN0YW5jZSwgcHJvcGVydHlOYW1lKSB7CiAgICByZXR1cm4gcmVsYXRpb25zaGlwc0ZvcihpbnN0YW5jZSkuZ2V0KHByb3BlcnR5TmFtZSk7CiAgfQogIGZ1bmN0aW9uIGltcGxpY2l0UmVsYXRpb25zaGlwc0ZvcihpbnN0YW5jZSkgewogICAgdmFyIHJlY29yZERhdGEgPSBQcml2YXRlLnJlY29yZERhdGFGb3IoaW5zdGFuY2UpIHx8IGluc3RhbmNlOwogICAgcmV0dXJuIHJlY29yZERhdGEuX2ltcGxpY2l0UmVsYXRpb25zaGlwczsKICB9CiAgZnVuY3Rpb24gaW1wbGljaXRSZWxhdGlvbnNoaXBTdGF0ZUZvcihpbnN0YW5jZSwgcHJvcGVydHlOYW1lKSB7CiAgICByZXR1cm4gaW1wbGljaXRSZWxhdGlvbnNoaXBzRm9yKGluc3RhbmNlKVtwcm9wZXJ0eU5hbWVdOwogIH0KCiAgZnVuY3Rpb24gX2luaGVyaXRzTG9vc2Uoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzLnByb3RvdHlwZSk7IHN1YkNsYXNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHN1YkNsYXNzOyBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9CgogIHZhciBFbWJlckRhdGFPcmRlcmVkU2V0ID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9FbWJlck9yZGVyZWRTZXQpIHsKICAgIF9pbmhlcml0c0xvb3NlKEVtYmVyRGF0YU9yZGVyZWRTZXQsIF9FbWJlck9yZGVyZWRTZXQpOwoKICAgIGZ1bmN0aW9uIEVtYmVyRGF0YU9yZGVyZWRTZXQoKSB7CiAgICAgIHJldHVybiBfRW1iZXJPcmRlcmVkU2V0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgIH0KCiAgICBFbWJlckRhdGFPcmRlcmVkU2V0LmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZSgpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzKCk7CiAgICB9OwoKICAgIHZhciBfcHJvdG8gPSBFbWJlckRhdGFPcmRlcmVkU2V0LnByb3RvdHlwZTsKCiAgICBfcHJvdG8uYWRkV2l0aEluZGV4ID0gZnVuY3Rpb24gYWRkV2l0aEluZGV4KG9iaiwgaWR4KSB7CiAgICAgIHZhciBndWlkID0gRW1iZXIuZ3VpZEZvcihvYmopOwogICAgICB2YXIgcHJlc2VuY2VTZXQgPSB0aGlzLnByZXNlbmNlU2V0OwogICAgICB2YXIgbGlzdCA9IHRoaXMubGlzdDsKCiAgICAgIGlmIChwcmVzZW5jZVNldFtndWlkXSA9PT0gdHJ1ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgcHJlc2VuY2VTZXRbZ3VpZF0gPSB0cnVlOwoKICAgICAgaWYgKGlkeCA9PT0gdW5kZWZpbmVkIHx8IGlkeCA9PT0gbnVsbCkgewogICAgICAgIGxpc3QucHVzaChvYmopOwogICAgICB9IGVsc2UgewogICAgICAgIGxpc3Quc3BsaWNlKGlkeCwgMCwgb2JqKTsKICAgICAgfQoKICAgICAgdGhpcy5zaXplICs9IDE7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICByZXR1cm4gRW1iZXJEYXRhT3JkZXJlZFNldDsKICB9KEVtYmVyT3JkZXJlZFNldCk7CgogIC8qCiAgICBUaGlzIG1ldGhvZCBub3JtYWxpemVzIGEgbGluayB0byBhbiAibGlua3Mgb2JqZWN0Ii4gSWYgdGhlIHBhc3NlZCBsaW5rIGlzCiAgICBhbHJlYWR5IGFuIG9iamVjdCBpdCdzIHJldHVybmVkIHdpdGhvdXQgYW55IG1vZGlmaWNhdGlvbnMuCgogICAgU2VlIGh0dHA6Ly9qc29uYXBpLm9yZy9mb3JtYXQvI2RvY3VtZW50LWxpbmtzIGZvciBtb3JlIGluZm9ybWF0aW9uLgoKICAgIEBtZXRob2QgX25vcm1hbGl6ZUxpbmsKICAgIEBpbnRlcm5hbAogICAgQHBhcmFtIHtTdHJpbmd9IGxpbmsKICAgIEByZXR1cm4ge09iamVjdHxudWxsfQogICovCiAgZnVuY3Rpb24gX25vcm1hbGl6ZUxpbmsobGluaykgewogICAgc3dpdGNoICh0eXBlb2YgbGluaykgewogICAgICBjYXNlICdvYmplY3QnOgogICAgICAgIHJldHVybiBsaW5rOwoKICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICByZXR1cm4gewogICAgICAgICAgaHJlZjogbGluawogICAgICAgIH07CiAgICB9CgogICAgcmV0dXJuIG51bGw7CiAgfQoKICBmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKICBmdW5jdGlvbiBfY3JlYXRlQ2xhc3MoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKICB2YXIgUmVsYXRpb25zaGlwID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gUmVsYXRpb25zaGlwKHN0b3JlLCBpbnZlcnNlS2V5LCByZWxhdGlvbnNoaXBNZXRhLCByZWNvcmREYXRhLCBpbnZlcnNlSXNBc3luYykgewogICAgICB0aGlzLmludmVyc2VJc0FzeW5jID0gdm9pZCAwOwogICAgICB0aGlzLmtpbmQgPSB2b2lkIDA7CiAgICAgIHRoaXMucmVjb3JkRGF0YSA9IHZvaWQgMDsKICAgICAgdGhpcy5tZW1iZXJzID0gdm9pZCAwOwogICAgICB0aGlzLmNhbm9uaWNhbE1lbWJlcnMgPSB2b2lkIDA7CiAgICAgIHRoaXMuc3RvcmUgPSB2b2lkIDA7CiAgICAgIHRoaXMua2V5ID0gdm9pZCAwOwogICAgICB0aGlzLmludmVyc2VLZXkgPSB2b2lkIDA7CiAgICAgIHRoaXMuaXNBc3luYyA9IHZvaWQgMDsKICAgICAgdGhpcy5pc1BvbHltb3JwaGljID0gdm9pZCAwOwogICAgICB0aGlzLnJlbGF0aW9uc2hpcE1ldGEgPSB2b2lkIDA7CiAgICAgIHRoaXMuaW52ZXJzZUtleUZvckltcGxpY2l0ID0gdm9pZCAwOwogICAgICB0aGlzLm1ldGEgPSB2b2lkIDA7CiAgICAgIHRoaXMuX19pbnZlcnNlTWV0YSA9IHZvaWQgMDsKICAgICAgdGhpcy5fdGVtcE1vZGVsTmFtZSA9IHZvaWQgMDsKICAgICAgdGhpcy5zaG91bGRGb3JjZVJlbG9hZCA9IGZhbHNlOwogICAgICB0aGlzLnJlbGF0aW9uc2hpcElzU3RhbGUgPSB2b2lkIDA7CiAgICAgIHRoaXMuaGFzRGVtYXRlcmlhbGl6ZWRJbnZlcnNlID0gdm9pZCAwOwogICAgICB0aGlzLmhhc0FueVJlbGF0aW9uc2hpcERhdGEgPSB2b2lkIDA7CiAgICAgIHRoaXMucmVsYXRpb25zaGlwSXNFbXB0eSA9IHZvaWQgMDsKICAgICAgdGhpcy5oYXNGYWlsZWRMb2FkQXR0ZW1wdCA9IGZhbHNlOwogICAgICB0aGlzLmxpbmtzID0gdm9pZCAwOwogICAgICB0aGlzLndpbGxTeW5jID0gdm9pZCAwOwogICAgICB0aGlzLmludmVyc2VJc0FzeW5jID0gaW52ZXJzZUlzQXN5bmM7CiAgICAgIHRoaXMua2luZCA9IHJlbGF0aW9uc2hpcE1ldGEua2luZDsKICAgICAgdmFyIGFzeW5jID0gcmVsYXRpb25zaGlwTWV0YS5vcHRpb25zLmFzeW5jOwogICAgICB2YXIgcG9seW1vcnBoaWMgPSByZWxhdGlvbnNoaXBNZXRhLm9wdGlvbnMucG9seW1vcnBoaWM7CiAgICAgIHRoaXMucmVjb3JkRGF0YSA9IHJlY29yZERhdGE7CiAgICAgIHRoaXMubWVtYmVycyA9IG5ldyBFbWJlckRhdGFPcmRlcmVkU2V0KCk7CiAgICAgIHRoaXMuY2Fub25pY2FsTWVtYmVycyA9IG5ldyBFbWJlckRhdGFPcmRlcmVkU2V0KCk7CiAgICAgIHRoaXMuc3RvcmUgPSBzdG9yZTsKICAgICAgdGhpcy5rZXkgPSByZWxhdGlvbnNoaXBNZXRhLmtleSB8fCBudWxsOwogICAgICB0aGlzLmludmVyc2VLZXkgPSBpbnZlcnNlS2V5OwogICAgICB0aGlzLmlzQXN5bmMgPSB0eXBlb2YgYXN5bmMgPT09ICd1bmRlZmluZWQnID8gdHJ1ZSA6IGFzeW5jOwogICAgICB0aGlzLmlzUG9seW1vcnBoaWMgPSB0eXBlb2YgcG9seW1vcnBoaWMgPT09ICd1bmRlZmluZWQnID8gZmFsc2UgOiBwb2x5bW9ycGhpYzsKICAgICAgdGhpcy5yZWxhdGlvbnNoaXBNZXRhID0gcmVsYXRpb25zaGlwTWV0YTsgLy9UaGlzIHByb2JhYmx5IGJyZWFrcyBmb3IgcG9seW1vcnBoaWMgcmVsYXRpb25zaGlwIGluIGNvbXBsZXggc2NlbmFyaW9zLCBkdWUgdG8KICAgICAgLy9tdWx0aXBsZSBwb3NzaWJsZSBtb2RlbE5hbWVzCgogICAgICB0aGlzLmludmVyc2VLZXlGb3JJbXBsaWNpdCA9IHRoaXMuX3RlbXBNb2RlbE5hbWUgKyB0aGlzLmtleTsKICAgICAgdGhpcy5tZXRhID0gbnVsbDsKICAgICAgdGhpcy5fX2ludmVyc2VNZXRhID0gdW5kZWZpbmVkOwogICAgICAvKgogICAgICAgVGhpcyBmbGFnIGZvcmNlcyBmZXRjaC4gYHRydWVgIGZvciBhIHNpbmdsZSByZXF1ZXN0IG9uY2UgYHJlbG9hZCgpYAogICAgICAgICBoYXMgYmVlbiBjYWxsZWQgYGZhbHNlYCBhdCBhbGwgb3RoZXIgdGltZXMuCiAgICAgICovCiAgICAgIC8vIHRoaXMuc2hvdWxkRm9yY2VSZWxvYWQgPSBmYWxzZTsKCiAgICAgIC8qCiAgICAgICAgIFRoaXMgZmxhZyBpbmRpY2F0ZXMgd2hldGhlciB3ZSBzaG91bGQKICAgICAgICAgIHJlLWZldGNoIHRoZSByZWxhdGlvbnNoaXAgdGhlIG5leHQgdGltZQogICAgICAgICAgaXQgaXMgYWNjZXNzZWQuCiAgICAgICAgICAgVGhlIGRpZmZlcmVuY2UgYmV0d2VlbiB0aGlzIGZsYWcgYW5kIGBzaG91bGRGb3JjZVJlbG9hZGAKICAgICAgICAgIGlzIGluIGhvdyB3ZSB0cmVhdCB0aGUgcHJlc2VuY2Ugb2YgcGFydGlhbGx5IG1pc3NpbmcgZGF0YToKICAgICAgICAgICAgLSBmb3IgYSBmb3JjZWQgcmVsb2FkLCB3ZSB3aWxsIHJlbG9hZCB0aGUgbGluayBvciBFVkVSWSByZWNvcmQKICAgICAgICAgICAgLSBmb3IgYSBzdGFsZSByZWxvYWQsIHdlIHdpbGwgcmVsb2FkIHRoZSBsaW5rIChpZiBwcmVzZW50KSBlbHNlIG9ubHkgTUlTU0lORyByZWNvcmRzCiAgICAgICAgICAgSWRlYWxseSB0aGVzZSBmbGFncyBjb3VsZCBiZSBtZXJnZWQsIGJ1dCBiZWNhdXNlIHdlIGRvbid0IGdpdmUgdGhlCiAgICAgICAgICByZXF1ZXN0IGxheWVyIHRoZSBvcHRpb24gb2YgZGVjaWRpbmcgaG93IHRvIHJlc29sdmUgdGhlIGRhdGEgYmVpbmcgcXVlcmllZAogICAgICAgICAgd2UgYXJlIGZvcmNlZCB0byBkaWZmZXJlbnRpYXRlIGZvciBub3cuCiAgICAgICAgICAgSXQgaXMgYWxzbyBwb3NzaWJsZSBmb3IgYSByZWxhdGlvbnNoaXAgdG8gcmVtYWluIHN0YWxlIGFmdGVyIGEgZm9yY2VkIHJlbG9hZDsgaG93ZXZlciwKICAgICAgICAgIGluIHRoaXMgY2FzZSBgaGFzRmFpbGVkTG9hZEF0dGVtcHRgIG91Z2h0IHRvIGJlIGB0cnVlYC4KICAgICAgICAgZmFsc2Ugd2hlbgogICAgICAgICAgPT4gcmVjb3JkRGF0YS5pc05ldygpIG9uIGluaXRpYWwgc2V0dXAKICAgICAgICAgID0+IGEgcHJldmlvdXNseSB0cmlnZ2VyZWQgcmVxdWVzdCBoYXMgcmVzb2x2ZWQKICAgICAgICAgID0+IHdlIGdldCByZWxhdGlvbnNoaXAgZGF0YSB2aWEgcHVzaAogICAgICAgICB0cnVlIHdoZW4KICAgICAgICAgID0+ICFyZWNvcmREYXRhLmlzTmV3KCkgb24gaW5pdGlhbCBzZXR1cAogICAgICAgICAgPT4gYW4gaW52ZXJzZSBoYXMgYmVlbiB1bmxvYWRlZAogICAgICAgICAgPT4gd2UgZ2V0IGEgbmV3IGxpbmsgZm9yIHRoZSByZWxhdGlvbnNoaXAKICAgICAgICAgVE9ETyBAcnVuc3BpcmVkIHVuc2tpcCB0aGUgYWNjZXB0YW5jZSB0ZXN0cyBhbmQgZml4IHRoZXNlIGZsYWdzCiAgICAgICAqLwoKICAgICAgdGhpcy5yZWxhdGlvbnNoaXBJc1N0YWxlID0gZmFsc2U7CiAgICAgIC8qCiAgICAgICBUaGlzIGZsYWcgaW5kaWNhdGVzIHdoZXRoZXIgd2Ugc2hvdWxkCiAgICAgICAgKipwYXJ0aWFsbHkqKiByZS1mZXRjaCB0aGUgcmVsYXRpb25zaGlwIHRoZQogICAgICAgIG5leHQgdGltZSBpdCBpcyBhY2Nlc3NlZC4KICAgICAgIGZhbHNlIHdoZW4KICAgICAgICA9PiBpbml0aWFsIHNldHVwCiAgICAgICAgPT4gYSBwcmV2aW91c2x5IHRyaWdnZXJlZCByZXF1ZXN0IGhhcyByZXNvbHZlZAogICAgICAgdHJ1ZSB3aGVuCiAgICAgICAgPT4gYW4gaW52ZXJzZSBoYXMgYmVlbiB1bmxvYWRlZAogICAgICAqLwoKICAgICAgdGhpcy5oYXNEZW1hdGVyaWFsaXplZEludmVyc2UgPSBmYWxzZTsKICAgICAgLyoKICAgICAgICBUaGlzIGZsYWcgaW5kaWNhdGVzIHdoZXRoZXIgd2Ugc2hvdWxkIGNvbnNpZGVyIHRoZSBjb250ZW50CiAgICAgICAgIG9mIHRoaXMgcmVsYXRpb25zaGlwICJrbm93biIuCiAgICAgICAgIElmIHdlIGhhdmUgbm8gcmVsYXRpb25zaGlwIGtub3dsZWRnZSwgYW5kIHRoZSByZWxhdGlvbnNoaXAKICAgICAgICAgaXMgYGFzeW5jYCwgd2Ugd2lsbCBhdHRlbXB0IHRvIGZldGNoIHRoZSByZWxhdGlvbnNoaXAgb24KICAgICAgICAgYWNjZXNzIGlmIGl0IGlzIGFsc28gc3RhbGUuCiAgICAgICAgU25hcHNob3QgdXNlcyB0aGlzIHRvIHRlbGwgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiB1bmtub3duCiAgICAgICAgKGB1bmRlZmluZWRgKSBvciBlbXB0eSAoYG51bGxgKS4gVGhlIHJlYXNvbiBmb3IgdGhpcyBpcyB0aGF0CiAgICAgICAgd2Ugd291bGRuJ3Qgd2FudCB0byBzZXJpYWxpemUgIHVua25vd24gcmVsYXRpb25zaGlwcyBhcyBgbnVsbGAKICAgICAgICBhcyB0aGF0IG1pZ2h0IG92ZXJ3cml0ZSByZW1vdGUgc3RhdGUuCiAgICAgICAgIEFsbCByZWxhdGlvbnNoaXBzIGZvciBhIG5ld2x5IGNyZWF0ZWQgKGBzdG9yZS5jcmVhdGVSZWNvcmQoKWApIGFyZQogICAgICAgICBjb25zaWRlcmVkIGtub3duIChgaGFzQW55UmVsYXRpb25zaGlwRGF0YSA9PT0gdHJ1ZWApLgogICAgICAgICB0cnVlIHdoZW4KICAgICAgICAgID0+IHdlIHJlY2VpdmUgYSBwdXNoIHdpdGggZWl0aGVyIG5ldyBkYXRhIG9yIGV4cGxpY2l0IGVtcHR5IChgW11gIG9yIGBudWxsYCkKICAgICAgICAgID0+IHRoZSByZWxhdGlvbnNoaXAgaXMgYSBiZWxvbmdzVG8gYW5kIHdlIGhhdmUgcmVjZWl2ZWQgZGF0YSBmcm9tCiAgICAgICAgICAgICAgIHRoZSBvdGhlciBzaWRlLgogICAgICAgICBmYWxzZSB3aGVuCiAgICAgICAgICA9PiB3ZSBoYXZlIHJlY2VpdmVkIG5vIHNpZ25hbCBhYm91dCB3aGF0IGRhdGEgYmVsb25ncyBpbiB0aGlzIHJlbGF0aW9uc2hpcAogICAgICAgICAgPT4gdGhlIHJlbGF0aW9uc2hpcCBpcyBhIGhhc01hbnkgYW5kIHdlIGhhdmUgb25seSByZWNlaXZlZCBkYXRhIGZyb20KICAgICAgICAgICAgICB0aGUgb3RoZXIgc2lkZS4KICAgICAgICovCgogICAgICB0aGlzLmhhc0FueVJlbGF0aW9uc2hpcERhdGEgPSBmYWxzZTsKICAgICAgLyoKICAgICAgICBGbGFnIHRoYXQgaW5kaWNhdGVzIHdoZXRoZXIgYW4gZW1wdHkgcmVsYXRpb25zaGlwIGlzIGV4cGxpY2l0bHkgZW1wdHkKICAgICAgICAgIChzaWduYWxlZCBieSBwdXNoIGdpdmluZyB1cyBhbiBlbXB0eSBhcnJheSBvciBudWxsIHJlbGF0aW9uc2hpcCkKICAgICAgICAgIGUuZy4gYW4gQVBJIHJlc3BvbnNlIGhhcyB0b2xkIHVzIHRoYXQgdGhpcyByZWxhdGlvbnNoaXAgaXMgZW1wdHkuCiAgICAgICAgIFRodXMgZmFyLCBpdCBkb2VzIG5vdCBhcHBlYXIgdGhhdCB3ZSBhY3R1YWxseSBuZWVkIHRoaXMgZmxhZzsgaG93ZXZlciwKICAgICAgICAgIEBydW5zcGlyZWQgaGFzIGZvdW5kIGl0IGludmFsdWFibGUgd2hlbiBkZWJ1Z2dpbmcgcmVsYXRpb25zaGlwIHRlc3RzCiAgICAgICAgICB0byBkZXRlcm1pbmUgd2hldGhlciAoYW5kIHdoeSBpZiBzbykgd2UgYXJlIGluIGFuIGluY29ycmVjdCBzdGF0ZS4KICAgICAgICAgdHJ1ZSB3aGVuCiAgICAgICAgICA9PiB3ZSByZWNlaXZlIGEgcHVzaCB3aXRoIGV4cGxpY2l0IGVtcHR5IChgW11gIG9yIGBudWxsYCkKICAgICAgICAgID0+IHdlIGhhdmUgcmVjZWl2ZWQgbm8gc2lnbmFsIGFib3V0IHdoYXQgZGF0YSBiZWxvbmdzIGluIHRoaXMgcmVsYXRpb25zaGlwCiAgICAgICAgICA9PiBvbiBpbml0aWFsIGNyZWF0ZSAoYXMgbm8gc2lnbmFsIGlzIGtub3duIHlldCkKICAgICAgICAgZmFsc2UgYXQgYWxsIG90aGVyIHRpbWVzCiAgICAgICAqLwoKICAgICAgdGhpcy5yZWxhdGlvbnNoaXBJc0VtcHR5ID0gdHJ1ZTsKICAgICAgLyoKICAgICAgICBGbGFnIGRlZiBoZXJlIGZvciByZWZlcmVuY2UsIGRlZmluZWQgYXMgZ2V0dGVyIGluIGhhcy1tYW55LmpzIC8gYmVsb25ncy10by5qcwogICAgICAgICB0cnVlIHdoZW4KICAgICAgICAgID0+IGhhc0FueVJlbGF0aW9uc2hpcERhdGEgaXMgdHJ1ZQogICAgICAgICAgQU5ECiAgICAgICAgICA9PiBtZW1iZXJzIChOT1QgY2Fub25pY2FsTWVtYmVycykgQGVhY2ggIWlzRW1wdHkKICAgICAgICAgVE9ETywgY29uc2lkZXIgY2hhbmdpbmcgdGhlIGNvbmRpdGlvbmFsIGhlcmUgZnJvbSAhaXNFbXB0eSB0byAhaGlkZGVuRnJvbVJlY29yZEFycmF5cwogICAgICAqLwogICAgICAvLyBUT0RPIGRvIHdlIHdhbnQgdGhpcyBhbnltb3JlPyBTZWVtcyBzb21ld2hhdCB1c2VmdWwKICAgICAgLy8gICBlc3BlY2lhbGx5IGlmIHdlIHJlbmFtZSB0byBgaGFzVXBkYXRlZExpbmtgCiAgICAgIC8vICAgd2hpY2ggd291bGQgdGVsbCB1cyBzbGlnaHRseSBtb3JlIGFib3V0IHdoeSB0aGUKICAgICAgLy8gICByZWxhdGlvbnNoaXAgaXMgc3RhbGUKICAgICAgLy8gdGhpcy51cGRhdGVkTGluayA9IGZhbHNlOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBSZWxhdGlvbnNoaXAucHJvdG90eXBlOwoKICAgIF9wcm90by5faW52ZXJzZUlzQXN5bmMgPSBmdW5jdGlvbiBfaW52ZXJzZUlzQXN5bmMoKSB7CiAgICAgIHJldHVybiAhIXRoaXMuaW52ZXJzZUlzQXN5bmM7CiAgICB9OwoKICAgIF9wcm90by5faW52ZXJzZUlzU3luYyA9IGZ1bmN0aW9uIF9pbnZlcnNlSXNTeW5jKCkgewogICAgICByZXR1cm4gISEodGhpcy5pbnZlcnNlS2V5ICYmICF0aGlzLmludmVyc2VJc0FzeW5jKTsKICAgIH07CgogICAgX3Byb3RvLl9oYXNTdXBwb3J0Rm9ySW1wbGljaXRSZWxhdGlvbnNoaXBzID0gZnVuY3Rpb24gX2hhc1N1cHBvcnRGb3JJbXBsaWNpdFJlbGF0aW9uc2hpcHMocmVjb3JkRGF0YSkgewogICAgICByZXR1cm4gcmVjb3JkRGF0YS5faW1wbGljaXRSZWxhdGlvbnNoaXBzICE9PSB1bmRlZmluZWQgJiYgcmVjb3JkRGF0YS5faW1wbGljaXRSZWxhdGlvbnNoaXBzICE9PSBudWxsOwogICAgfTsKCiAgICBfcHJvdG8uX2hhc1N1cHBvcnRGb3JSZWxhdGlvbnNoaXBzID0gZnVuY3Rpb24gX2hhc1N1cHBvcnRGb3JSZWxhdGlvbnNoaXBzKHJlY29yZERhdGEpIHsKICAgICAgcmV0dXJuIHJlY29yZERhdGEuX3JlbGF0aW9uc2hpcHMgIT09IHVuZGVmaW5lZCAmJiByZWNvcmREYXRhLl9yZWxhdGlvbnNoaXBzICE9PSBudWxsOwogICAgfTsKCiAgICBfcHJvdG8ucmVjb3JkRGF0YURpZERlbWF0ZXJpYWxpemUgPSBmdW5jdGlvbiByZWNvcmREYXRhRGlkRGVtYXRlcmlhbGl6ZSgpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBpbnZlcnNlS2V5ID0gdGhpcy5pbnZlcnNlS2V5OwoKICAgICAgaWYgKCFpbnZlcnNlS2V5KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vIHdlIGFjdHVhbGx5IHdhbnQgYSB1bmlvbiBvZiBtZW1iZXJzIGFuZCBjYW5vbmljYWxNZW1iZXJzCiAgICAgIC8vIHRoZXkgc2hvdWxkIGJlIGRpc2pvaW50IGJ1dCBjdXJyZW50bHkgYXJlIG5vdCBkdWUgdG8gYSBidWcKCgogICAgICB0aGlzLmZvckFsbE1lbWJlcnMoZnVuY3Rpb24gKGludmVyc2VSZWNvcmREYXRhKSB7CiAgICAgICAgaWYgKCFfdGhpcy5faGFzU3VwcG9ydEZvclJlbGF0aW9uc2hpcHMoaW52ZXJzZVJlY29yZERhdGEpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVsYXRpb25zaGlwID0gcmVsYXRpb25zaGlwU3RhdGVGb3IoaW52ZXJzZVJlY29yZERhdGEsIGludmVyc2VLZXkpOwoKICAgICAgICB2YXIgYmVsb25nc1RvUmVsYXRpb25zaGlwID0gaW52ZXJzZVJlY29yZERhdGEuZ2V0QmVsb25nc1RvKGludmVyc2VLZXkpLl9yZWxhdGlvbnNoaXA7IC8vIEZvciBjYW5vbmljYWwgbWVtYmVycywgaXQgaXMgcG9zc2libGUgdGhhdCBpbnZlcnNlUmVjb3JkRGF0YSBoYXMgYWxyZWFkeSBiZWVuIGFzc29jaWF0ZWQgdG8KICAgICAgICAvLyB0byBhbm90aGVyIHJlY29yZC4gRm9yIHN1Y2ggY2FzZXMsIGRvIG5vdCBkZW1hdGVyaWFsaXplIHRoZSBpbnZlcnNlUmVjb3JkRGF0YQoKCiAgICAgICAgaWYgKCFiZWxvbmdzVG9SZWxhdGlvbnNoaXAgfHwgIWJlbG9uZ3NUb1JlbGF0aW9uc2hpcC5pbnZlcnNlUmVjb3JkRGF0YSB8fCBfdGhpcy5yZWNvcmREYXRhID09PSBiZWxvbmdzVG9SZWxhdGlvbnNoaXAuaW52ZXJzZVJlY29yZERhdGEpIHsKICAgICAgICAgIHJlbGF0aW9uc2hpcC5pbnZlcnNlRGlkRGVtYXRlcmlhbGl6ZShfdGhpcy5yZWNvcmREYXRhKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKCiAgICBfcHJvdG8uZm9yQWxsTWVtYmVycyA9IGZ1bmN0aW9uIGZvckFsbE1lbWJlcnMoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlZW4gPSBPYmplY3QuY3JlYXRlKG51bGwpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLm1lbWJlcnMubGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBpbnZlcnNlSW50ZXJuYWxNb2RlbCA9IHRoaXMubWVtYmVycy5saXN0W2ldOwogICAgICAgIHZhciBpZCA9IEVtYmVyLmd1aWRGb3IoaW52ZXJzZUludGVybmFsTW9kZWwpOwoKICAgICAgICBpZiAoIXNlZW5baWRdKSB7CiAgICAgICAgICBzZWVuW2lkXSA9IHRydWU7CiAgICAgICAgICBjYWxsYmFjayhpbnZlcnNlSW50ZXJuYWxNb2RlbCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgdGhpcy5jYW5vbmljYWxNZW1iZXJzLmxpc3QubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgdmFyIF9pbnZlcnNlSW50ZXJuYWxNb2RlbCA9IHRoaXMuY2Fub25pY2FsTWVtYmVycy5saXN0W19pXTsKCiAgICAgICAgdmFyIF9pZCA9IEVtYmVyLmd1aWRGb3IoX2ludmVyc2VJbnRlcm5hbE1vZGVsKTsKCiAgICAgICAgaWYgKCFzZWVuW19pZF0pIHsKICAgICAgICAgIHNlZW5bX2lkXSA9IHRydWU7CiAgICAgICAgICBjYWxsYmFjayhfaW52ZXJzZUludGVybmFsTW9kZWwpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uaW52ZXJzZURpZERlbWF0ZXJpYWxpemUgPSBmdW5jdGlvbiBpbnZlcnNlRGlkRGVtYXRlcmlhbGl6ZShpbnZlcnNlUmVjb3JkRGF0YSkgewogICAgICBpZiAoIXRoaXMuaXNBc3luYyB8fCBpbnZlcnNlUmVjb3JkRGF0YSAmJiBpbnZlcnNlUmVjb3JkRGF0YS5pc05ldygpKSB7CiAgICAgICAgLy8gdW5sb2FkaW5nIGludmVyc2Ugb2YgYSBzeW5jIHJlbGF0aW9uc2hpcCBpcyB0cmVhdGVkIGFzIGEgY2xpZW50LXNpZGUKICAgICAgICAvLyBkZWxldGUsIHNvIGFjdHVhbGx5IHJlbW92ZSB0aGUgbW9kZWxzIGRvbid0IG1lcmVseSBpbnZhbGlkYXRlIHRoZSBjcAogICAgICAgIC8vIGNhY2hlLgogICAgICAgIC8vIGlmIHRoZSByZWNvcmQgYmVpbmcgdW5sb2FkZWQgb25seSBleGlzdHMgb24gdGhlIGNsaWVudCwgd2Ugc2ltaWxhcmx5CiAgICAgICAgLy8gdHJlYXQgaXQgYXMgYSBjbGllbnQgc2lkZSBkZWxldGUKICAgICAgICB0aGlzLnJlbW92ZVJlY29yZERhdGFGcm9tT3duKGludmVyc2VSZWNvcmREYXRhKTsKICAgICAgICB0aGlzLnJlbW92ZUNhbm9uaWNhbFJlY29yZERhdGFGcm9tT3duKGludmVyc2VSZWNvcmREYXRhKTsKICAgICAgICB0aGlzLnNldFJlbGF0aW9uc2hpcElzRW1wdHkodHJ1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZXRIYXNEZW1hdGVyaWFsaXplZEludmVyc2UodHJ1ZSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLnVwZGF0ZU1ldGEgPSBmdW5jdGlvbiB1cGRhdGVNZXRhKG1ldGEpIHsKICAgICAgdGhpcy5tZXRhID0gbWV0YTsKICAgIH07CgogICAgX3Byb3RvLmNsZWFyID0gZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAgIHZhciBtZW1iZXJzID0gdGhpcy5tZW1iZXJzLmxpc3Q7CgogICAgICB3aGlsZSAobWVtYmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgdmFyIG1lbWJlciA9IG1lbWJlcnNbMF07CiAgICAgICAgdGhpcy5yZW1vdmVSZWNvcmREYXRhKG1lbWJlcik7CiAgICAgIH0KCiAgICAgIHZhciBjYW5vbmljYWxNZW1iZXJzID0gdGhpcy5jYW5vbmljYWxNZW1iZXJzLmxpc3Q7CgogICAgICB3aGlsZSAoY2Fub25pY2FsTWVtYmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgdmFyIF9tZW1iZXIgPSBjYW5vbmljYWxNZW1iZXJzWzBdOwogICAgICAgIHRoaXMucmVtb3ZlQ2Fub25pY2FsUmVjb3JkRGF0YShfbWVtYmVyKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8ucmVtb3ZlQWxsUmVjb3JkRGF0YXNGcm9tT3duID0gZnVuY3Rpb24gcmVtb3ZlQWxsUmVjb3JkRGF0YXNGcm9tT3duKCkgewogICAgICB0aGlzLnNldFJlbGF0aW9uc2hpcElzU3RhbGUodHJ1ZSk7CiAgICAgIHRoaXMubWVtYmVycy5jbGVhcigpOwogICAgfTsKCiAgICBfcHJvdG8ucmVtb3ZlQWxsQ2Fub25pY2FsUmVjb3JkRGF0YXNGcm9tT3duID0gZnVuY3Rpb24gcmVtb3ZlQWxsQ2Fub25pY2FsUmVjb3JkRGF0YXNGcm9tT3duKCkgewogICAgICB0aGlzLmNhbm9uaWNhbE1lbWJlcnMuY2xlYXIoKTsKICAgICAgdGhpcy5mbHVzaENhbm9uaWNhbExhdGVyKCk7CiAgICB9OwoKICAgIF9wcm90by5yZW1vdmVSZWNvcmREYXRhcyA9IGZ1bmN0aW9uIHJlbW92ZVJlY29yZERhdGFzKHJlY29yZERhdGFzKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgcmVjb3JkRGF0YXMuZm9yRWFjaChmdW5jdGlvbiAocmVjb3JkRGF0YSkgewogICAgICAgIHJldHVybiBfdGhpczIucmVtb3ZlUmVjb3JkRGF0YShyZWNvcmREYXRhKTsKICAgICAgfSk7CiAgICB9OwoKICAgIF9wcm90by5hZGRSZWNvcmREYXRhcyA9IGZ1bmN0aW9uIGFkZFJlY29yZERhdGFzKHJlY29yZERhdGFzLCBpZHgpIHsKICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICByZWNvcmREYXRhcy5mb3JFYWNoKGZ1bmN0aW9uIChyZWNvcmREYXRhKSB7CiAgICAgICAgX3RoaXMzLmFkZFJlY29yZERhdGEocmVjb3JkRGF0YSwgaWR4KTsKCiAgICAgICAgaWYgKGlkeCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBpZHgrKzsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKCiAgICBfcHJvdG8uYWRkQ2Fub25pY2FsUmVjb3JkRGF0YXMgPSBmdW5jdGlvbiBhZGRDYW5vbmljYWxSZWNvcmREYXRhcyhyZWNvcmREYXRhcywgaWR4KSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVjb3JkRGF0YXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoaWR4ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHRoaXMuYWRkQ2Fub25pY2FsUmVjb3JkRGF0YShyZWNvcmREYXRhc1tpXSwgaSArIGlkeCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuYWRkQ2Fub25pY2FsUmVjb3JkRGF0YShyZWNvcmREYXRhc1tpXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5hZGRDYW5vbmljYWxSZWNvcmREYXRhID0gZnVuY3Rpb24gYWRkQ2Fub25pY2FsUmVjb3JkRGF0YShyZWNvcmREYXRhLCBpZHgpIHsKICAgICAgaWYgKCF0aGlzLmNhbm9uaWNhbE1lbWJlcnMuaGFzKHJlY29yZERhdGEpKSB7CiAgICAgICAgdGhpcy5jYW5vbmljYWxNZW1iZXJzLmFkZChyZWNvcmREYXRhKTsKICAgICAgICB0aGlzLnNldHVwSW52ZXJzZVJlbGF0aW9uc2hpcChyZWNvcmREYXRhKTsKICAgICAgfQoKICAgICAgdGhpcy5mbHVzaENhbm9uaWNhbExhdGVyKCk7CiAgICAgIHRoaXMuc2V0SGFzQW55UmVsYXRpb25zaGlwRGF0YSh0cnVlKTsKICAgIH07CgogICAgX3Byb3RvLnNldHVwSW52ZXJzZVJlbGF0aW9uc2hpcCA9IGZ1bmN0aW9uIHNldHVwSW52ZXJzZVJlbGF0aW9uc2hpcChyZWNvcmREYXRhKSB7CiAgICAgIGlmICh0aGlzLmludmVyc2VLZXkpIHsKICAgICAgICBpZiAoIXRoaXMuX2hhc1N1cHBvcnRGb3JSZWxhdGlvbnNoaXBzKHJlY29yZERhdGEpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVsYXRpb25zaGlwID0gcmVsYXRpb25zaGlwU3RhdGVGb3IocmVjb3JkRGF0YSwgdGhpcy5pbnZlcnNlS2V5KTsgLy8gaWYgd2UgaGF2ZSBvbmx5IGp1c3QgaW5pdGlhbGl6ZWQgdGhlIGludmVyc2UgcmVsYXRpb25zaGlwLCB0aGVuIGl0CiAgICAgICAgLy8gYWxyZWFkeSBoYXMgdGhpcy5yZWNvcmREYXRhIGluIGl0cyBjYW5vbmljYWxNZW1iZXJzLCBzbyBza2lwIHRoZQogICAgICAgIC8vIHVubmVjZXNzYXJ5IHdvcmsuICBUaGUgZXhjZXB0aW9uIHRvIHRoaXMgaXMgcG9seW1vcnBoaWMKICAgICAgICAvLyByZWxhdGlvbnNoaXBzIHdob3NlIG1lbWJlcnMgYXJlIGRldGVybWluZWQgYnkgdGhlaXIgaW52ZXJzZSwgYXMgdGhvc2UKICAgICAgICAvLyByZWxhdGlvbnNoaXBzIGNhbm5vdCBlZmZpY2llbnRseSBmaW5kIHRoZWlyIGludmVyc2UgcGF5bG9hZHMuCgogICAgICAgIHJlbGF0aW9uc2hpcC5hZGRDYW5vbmljYWxSZWNvcmREYXRhKHRoaXMucmVjb3JkRGF0YSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCF0aGlzLl9oYXNTdXBwb3J0Rm9ySW1wbGljaXRSZWxhdGlvbnNoaXBzKHJlY29yZERhdGEpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVsYXRpb25zaGlwcyA9IHJlY29yZERhdGEuX2ltcGxpY2l0UmVsYXRpb25zaGlwczsKICAgICAgICB2YXIgX3JlbGF0aW9uc2hpcCA9IHJlbGF0aW9uc2hpcHNbdGhpcy5pbnZlcnNlS2V5Rm9ySW1wbGljaXRdOwoKICAgICAgICBpZiAoIV9yZWxhdGlvbnNoaXApIHsKICAgICAgICAgIF9yZWxhdGlvbnNoaXAgPSByZWxhdGlvbnNoaXBzW3RoaXMuaW52ZXJzZUtleUZvckltcGxpY2l0XSA9IG5ldyBSZWxhdGlvbnNoaXAodGhpcy5zdG9yZSwgdGhpcy5rZXksIHsKICAgICAgICAgICAgb3B0aW9uczogewogICAgICAgICAgICAgIGFzeW5jOiB0aGlzLmlzQXN5bmMKICAgICAgICAgICAgfQogICAgICAgICAgfSwgcmVjb3JkRGF0YSk7CiAgICAgICAgfQoKICAgICAgICBfcmVsYXRpb25zaGlwLmFkZENhbm9uaWNhbFJlY29yZERhdGEodGhpcy5yZWNvcmREYXRhKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8ucmVtb3ZlQ2Fub25pY2FsUmVjb3JkRGF0YXMgPSBmdW5jdGlvbiByZW1vdmVDYW5vbmljYWxSZWNvcmREYXRhcyhyZWNvcmREYXRhcywgaWR4KSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVjb3JkRGF0YXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoaWR4ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHRoaXMucmVtb3ZlQ2Fub25pY2FsUmVjb3JkRGF0YShyZWNvcmREYXRhc1tpXSwgaSArIGlkeCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMucmVtb3ZlQ2Fub25pY2FsUmVjb3JkRGF0YShyZWNvcmREYXRhc1tpXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5yZW1vdmVDYW5vbmljYWxSZWNvcmREYXRhID0gZnVuY3Rpb24gcmVtb3ZlQ2Fub25pY2FsUmVjb3JkRGF0YShyZWNvcmREYXRhLCBpZHgpIHsKICAgICAgaWYgKHRoaXMuY2Fub25pY2FsTWVtYmVycy5oYXMocmVjb3JkRGF0YSkpIHsKICAgICAgICB0aGlzLnJlbW92ZUNhbm9uaWNhbFJlY29yZERhdGFGcm9tT3duKHJlY29yZERhdGEpOwoKICAgICAgICBpZiAodGhpcy5pbnZlcnNlS2V5KSB7CiAgICAgICAgICB0aGlzLnJlbW92ZUNhbm9uaWNhbFJlY29yZERhdGFGcm9tSW52ZXJzZShyZWNvcmREYXRhKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHRoaXMuX2hhc1N1cHBvcnRGb3JJbXBsaWNpdFJlbGF0aW9uc2hpcHMocmVjb3JkRGF0YSkgJiYgcmVjb3JkRGF0YS5faW1wbGljaXRSZWxhdGlvbnNoaXBzW3RoaXMuaW52ZXJzZUtleUZvckltcGxpY2l0XSkgewogICAgICAgICAgICByZWNvcmREYXRhLl9pbXBsaWNpdFJlbGF0aW9uc2hpcHNbdGhpcy5pbnZlcnNlS2V5Rm9ySW1wbGljaXRdLnJlbW92ZUNhbm9uaWNhbFJlY29yZERhdGEodGhpcy5yZWNvcmREYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuZmx1c2hDYW5vbmljYWxMYXRlcigpOwogICAgfTsKCiAgICBfcHJvdG8uYWRkUmVjb3JkRGF0YSA9IGZ1bmN0aW9uIGFkZFJlY29yZERhdGEocmVjb3JkRGF0YSwgaWR4KSB7CiAgICAgIGlmICghdGhpcy5tZW1iZXJzLmhhcyhyZWNvcmREYXRhKSkgewogICAgICAgIHRoaXMubWVtYmVycy5hZGRXaXRoSW5kZXgocmVjb3JkRGF0YSwgaWR4KTsKICAgICAgICB0aGlzLm5vdGlmeVJlY29yZFJlbGF0aW9uc2hpcEFkZGVkKHJlY29yZERhdGEsIGlkeCk7CgogICAgICAgIGlmICh0aGlzLl9oYXNTdXBwb3J0Rm9yUmVsYXRpb25zaGlwcyhyZWNvcmREYXRhKSAmJiB0aGlzLmludmVyc2VLZXkpIHsKICAgICAgICAgIHJlbGF0aW9uc2hpcFN0YXRlRm9yKHJlY29yZERhdGEsIHRoaXMuaW52ZXJzZUtleSkuYWRkUmVjb3JkRGF0YSh0aGlzLnJlY29yZERhdGEpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodGhpcy5faGFzU3VwcG9ydEZvckltcGxpY2l0UmVsYXRpb25zaGlwcyhyZWNvcmREYXRhKSkgewogICAgICAgICAgICBpZiAoIXJlY29yZERhdGEuX2ltcGxpY2l0UmVsYXRpb25zaGlwc1t0aGlzLmludmVyc2VLZXlGb3JJbXBsaWNpdF0pIHsKICAgICAgICAgICAgICByZWNvcmREYXRhLl9pbXBsaWNpdFJlbGF0aW9uc2hpcHNbdGhpcy5pbnZlcnNlS2V5Rm9ySW1wbGljaXRdID0gbmV3IFJlbGF0aW9uc2hpcCh0aGlzLnN0b3JlLCB0aGlzLmtleSwgewogICAgICAgICAgICAgICAgb3B0aW9uczogewogICAgICAgICAgICAgICAgICBhc3luYzogdGhpcy5pc0FzeW5jCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwgcmVjb3JkRGF0YSwgdGhpcy5pc0FzeW5jKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmVjb3JkRGF0YS5faW1wbGljaXRSZWxhdGlvbnNoaXBzW3RoaXMuaW52ZXJzZUtleUZvckltcGxpY2l0XS5hZGRSZWNvcmREYXRhKHRoaXMucmVjb3JkRGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLnNldEhhc0FueVJlbGF0aW9uc2hpcERhdGEodHJ1ZSk7CiAgICB9OwoKICAgIF9wcm90by5yZW1vdmVSZWNvcmREYXRhID0gZnVuY3Rpb24gcmVtb3ZlUmVjb3JkRGF0YShyZWNvcmREYXRhKSB7CiAgICAgIGlmICh0aGlzLm1lbWJlcnMuaGFzKHJlY29yZERhdGEpKSB7CiAgICAgICAgdGhpcy5yZW1vdmVSZWNvcmREYXRhRnJvbU93bihyZWNvcmREYXRhKTsKCiAgICAgICAgaWYgKHRoaXMuaW52ZXJzZUtleSkgewogICAgICAgICAgdGhpcy5yZW1vdmVSZWNvcmREYXRhRnJvbUludmVyc2UocmVjb3JkRGF0YSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICh0aGlzLl9oYXNTdXBwb3J0Rm9ySW1wbGljaXRSZWxhdGlvbnNoaXBzKHJlY29yZERhdGEpICYmIHJlY29yZERhdGEuX2ltcGxpY2l0UmVsYXRpb25zaGlwc1t0aGlzLmludmVyc2VLZXlGb3JJbXBsaWNpdF0pIHsKICAgICAgICAgICAgcmVjb3JkRGF0YS5faW1wbGljaXRSZWxhdGlvbnNoaXBzW3RoaXMuaW52ZXJzZUtleUZvckltcGxpY2l0XS5yZW1vdmVSZWNvcmREYXRhKHRoaXMucmVjb3JkRGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5yZW1vdmVSZWNvcmREYXRhRnJvbUludmVyc2UgPSBmdW5jdGlvbiByZW1vdmVSZWNvcmREYXRhRnJvbUludmVyc2UocmVjb3JkRGF0YSkgewogICAgICBpZiAoIXRoaXMuX2hhc1N1cHBvcnRGb3JSZWxhdGlvbnNoaXBzKHJlY29yZERhdGEpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAodGhpcy5pbnZlcnNlS2V5KSB7CiAgICAgICAgdmFyIGludmVyc2VSZWxhdGlvbnNoaXAgPSByZWxhdGlvbnNoaXBTdGF0ZUZvcihyZWNvcmREYXRhLCB0aGlzLmludmVyc2VLZXkpOyAvL05lZWQgdG8gY2hlY2sgZm9yIGV4aXN0ZW5jZSwgYXMgdGhlIHJlY29yZCBtaWdodCB1bmxvYWRpbmcgYXQgdGhlIG1vbWVudAoKICAgICAgICBpZiAoaW52ZXJzZVJlbGF0aW9uc2hpcCkgewogICAgICAgICAgaW52ZXJzZVJlbGF0aW9uc2hpcC5yZW1vdmVSZWNvcmREYXRhRnJvbU93bih0aGlzLnJlY29yZERhdGEpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8ucmVtb3ZlUmVjb3JkRGF0YUZyb21Pd24gPSBmdW5jdGlvbiByZW1vdmVSZWNvcmREYXRhRnJvbU93bihyZWNvcmREYXRhLCBpZHgpIHsKICAgICAgdGhpcy5tZW1iZXJzLmRlbGV0ZShyZWNvcmREYXRhKTsKICAgIH07CgogICAgX3Byb3RvLnJlbW92ZUNhbm9uaWNhbFJlY29yZERhdGFGcm9tSW52ZXJzZSA9IGZ1bmN0aW9uIHJlbW92ZUNhbm9uaWNhbFJlY29yZERhdGFGcm9tSW52ZXJzZShyZWNvcmREYXRhKSB7CiAgICAgIGlmICghdGhpcy5faGFzU3VwcG9ydEZvclJlbGF0aW9uc2hpcHMocmVjb3JkRGF0YSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmludmVyc2VLZXkpIHsKICAgICAgICB2YXIgaW52ZXJzZVJlbGF0aW9uc2hpcCA9IHJlbGF0aW9uc2hpcFN0YXRlRm9yKHJlY29yZERhdGEsIHRoaXMuaW52ZXJzZUtleSk7IC8vTmVlZCB0byBjaGVjayBmb3IgZXhpc3RlbmNlLCBhcyB0aGUgcmVjb3JkIG1pZ2h0IHVubG9hZGluZyBhdCB0aGUgbW9tZW50CgogICAgICAgIGlmIChpbnZlcnNlUmVsYXRpb25zaGlwKSB7CiAgICAgICAgICBpbnZlcnNlUmVsYXRpb25zaGlwLnJlbW92ZUNhbm9uaWNhbFJlY29yZERhdGFGcm9tT3duKHRoaXMucmVjb3JkRGF0YSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5yZW1vdmVDYW5vbmljYWxSZWNvcmREYXRhRnJvbU93biA9IGZ1bmN0aW9uIHJlbW92ZUNhbm9uaWNhbFJlY29yZERhdGFGcm9tT3duKHJlY29yZERhdGEsIGlkeCkgewogICAgICB0aGlzLmNhbm9uaWNhbE1lbWJlcnMuZGVsZXRlKHJlY29yZERhdGEpOwogICAgICB0aGlzLmZsdXNoQ2Fub25pY2FsTGF0ZXIoKTsKICAgIH0KICAgIC8qCiAgICAgIENhbGwgdGhpcyBtZXRob2Qgb25jZSBhIHJlY29yZCBkZWxldGlvbiBoYXMgYmVlbiBwZXJzaXN0ZWQKICAgICAgdG8gcHVyZ2UgaXQgZnJvbSBCT1RIIGN1cnJlbnQgYW5kIGNhbm9uaWNhbCBzdGF0ZSBvZiBhbGwKICAgICAgcmVsYXRpb25zaGlwcy4KICAgICAgIEBtZXRob2QgcmVtb3ZlQ29tcGxldGVseUZyb21JbnZlcnNlCiAgICAgIEBwcml2YXRlCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucmVtb3ZlQ29tcGxldGVseUZyb21JbnZlcnNlID0gZnVuY3Rpb24gcmVtb3ZlQ29tcGxldGVseUZyb21JbnZlcnNlKCkgewogICAgICB2YXIgX3RoaXM0ID0gdGhpczsKCiAgICAgIGlmICghdGhpcy5pbnZlcnNlS2V5ICYmICF0aGlzLmludmVyc2VLZXlGb3JJbXBsaWNpdCkgewogICAgICAgIHJldHVybjsKICAgICAgfSAvLyB3ZSBhY3R1YWxseSB3YW50IGEgdW5pb24gb2YgbWVtYmVycyBhbmQgY2Fub25pY2FsTWVtYmVycwogICAgICAvLyB0aGV5IHNob3VsZCBiZSBkaXNqb2ludCBidXQgY3VycmVudGx5IGFyZSBub3QgZHVlIHRvIGEgYnVnCgoKICAgICAgdmFyIHNlZW4gPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB2YXIgcmVjb3JkRGF0YSA9IHRoaXMucmVjb3JkRGF0YTsKICAgICAgdmFyIHVubG9hZDsKCiAgICAgIGlmICh0aGlzLmludmVyc2VLZXkpIHsKICAgICAgICB1bmxvYWQgPSBmdW5jdGlvbiB1bmxvYWQoaW52ZXJzZVJlY29yZERhdGEpIHsKICAgICAgICAgIHZhciBpZCA9IEVtYmVyLmd1aWRGb3IoaW52ZXJzZVJlY29yZERhdGEpOwoKICAgICAgICAgIGlmIChfdGhpczQuX2hhc1N1cHBvcnRGb3JSZWxhdGlvbnNoaXBzKGludmVyc2VSZWNvcmREYXRhKSAmJiBzZWVuW2lkXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGlmIChfdGhpczQuaW52ZXJzZUtleSkgewogICAgICAgICAgICAgIHZhciByZWxhdGlvbnNoaXAgPSByZWxhdGlvbnNoaXBTdGF0ZUZvcihpbnZlcnNlUmVjb3JkRGF0YSwgX3RoaXM0LmludmVyc2VLZXkpOwogICAgICAgICAgICAgIHJlbGF0aW9uc2hpcC5yZW1vdmVDb21wbGV0ZWx5RnJvbU93bihyZWNvcmREYXRhKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc2VlbltpZF0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdW5sb2FkID0gZnVuY3Rpb24gdW5sb2FkKGludmVyc2VSZWNvcmREYXRhKSB7CiAgICAgICAgICB2YXIgaWQgPSBFbWJlci5ndWlkRm9yKGludmVyc2VSZWNvcmREYXRhKTsKCiAgICAgICAgICBpZiAoX3RoaXM0Ll9oYXNTdXBwb3J0Rm9ySW1wbGljaXRSZWxhdGlvbnNoaXBzKGludmVyc2VSZWNvcmREYXRhKSAmJiBzZWVuW2lkXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHZhciByZWxhdGlvbnNoaXAgPSBpbXBsaWNpdFJlbGF0aW9uc2hpcFN0YXRlRm9yKGludmVyc2VSZWNvcmREYXRhLCBfdGhpczQuaW52ZXJzZUtleUZvckltcGxpY2l0KTsKICAgICAgICAgICAgcmVsYXRpb25zaGlwLnJlbW92ZUNvbXBsZXRlbHlGcm9tT3duKHJlY29yZERhdGEpOwogICAgICAgICAgICBzZWVuW2lkXSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgdGhpcy5tZW1iZXJzLmZvckVhY2godW5sb2FkKTsKICAgICAgdGhpcy5jYW5vbmljYWxNZW1iZXJzLmZvckVhY2godW5sb2FkKTsKCiAgICAgIGlmICghdGhpcy5pc0FzeW5jKSB7CiAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICB9CiAgICB9CiAgICAvKgogICAgICBSZW1vdmVzIHRoZSBnaXZlbiBSZWNvcmREYXRhIGZyb20gQk9USCBjYW5vbmljYWwgQU5EIGN1cnJlbnQgc3RhdGUuCiAgICAgICBUaGlzIG1ldGhvZCBpcyB1c2VmdWwgd2hlbiBlaXRoZXIgYSBkZWxldGlvbiBvciBhIHJvbGxiYWNrIG9uIGEgbmV3IHJlY29yZAogICAgICBuZWVkcyB0byBlbnRpcmVseSBwdXJnZSBpdHNlbGYgZnJvbSBhbiBpbnZlcnNlIHJlbGF0aW9uc2hpcC4KICAgICAqLwogICAgOwoKICAgIF9wcm90by5yZW1vdmVDb21wbGV0ZWx5RnJvbU93biA9IGZ1bmN0aW9uIHJlbW92ZUNvbXBsZXRlbHlGcm9tT3duKHJlY29yZERhdGEpIHsKICAgICAgdGhpcy5jYW5vbmljYWxNZW1iZXJzLmRlbGV0ZShyZWNvcmREYXRhKTsKICAgICAgdGhpcy5tZW1iZXJzLmRlbGV0ZShyZWNvcmREYXRhKTsKICAgIH07CgogICAgX3Byb3RvLmZsdXNoQ2Fub25pY2FsID0gZnVuY3Rpb24gZmx1c2hDYW5vbmljYWwoKSB7CiAgICAgIHZhciBsaXN0ID0gdGhpcy5tZW1iZXJzLmxpc3Q7CiAgICAgIHRoaXMud2lsbFN5bmMgPSBmYWxzZTsgLy9hIGhhY2sgZm9yIG5vdCByZW1vdmluZyBuZXcgUmVjb3JkRGF0YXMKICAgICAgLy9UT0RPIHJlbW92ZSBvbmNlIHdlIGhhdmUgcHJvcGVyIGRpZmZpbmcKCiAgICAgIHZhciBuZXdSZWNvcmREYXRhcyA9IFtdOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgLy8gVE9ETyBJZ29yIGRlYWwgd2l0aCB0aGlzCiAgICAgICAgaWYgKGxpc3RbaV0uaXNOZXcoKSkgewogICAgICAgICAgbmV3UmVjb3JkRGF0YXMucHVzaChsaXN0W2ldKTsKICAgICAgICB9CiAgICAgIH0gLy9UT0RPKElnb3IpIG1ha2UgdGhpcyBsZXNzIGFieXNtYWxseSBzbG93CgoKICAgICAgdGhpcy5tZW1iZXJzID0gdGhpcy5jYW5vbmljYWxNZW1iZXJzLmNvcHkoKTsKCiAgICAgIGZvciAodmFyIF9pMiA9IDA7IF9pMiA8IG5ld1JlY29yZERhdGFzLmxlbmd0aDsgX2kyKyspIHsKICAgICAgICB0aGlzLm1lbWJlcnMuYWRkKG5ld1JlY29yZERhdGFzW19pMl0pOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5mbHVzaENhbm9uaWNhbExhdGVyID0gZnVuY3Rpb24gZmx1c2hDYW5vbmljYWxMYXRlcigpIHsKICAgICAgaWYgKHRoaXMud2lsbFN5bmMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMud2lsbFN5bmMgPSB0cnVlOyAvLyBSZWFjaGluZyBiYWNrIGludG8gdGhlIHN0b3JlIHRvIHVzZSBFRCdzIHJ1bmxvb3AKCiAgICAgIHRoaXMuc3RvcmUuX3VwZGF0ZVJlbGF0aW9uc2hpcFN0YXRlKHRoaXMpOwogICAgfTsKCiAgICBfcHJvdG8udXBkYXRlTGlua3MgPSBmdW5jdGlvbiB1cGRhdGVMaW5rcyhsaW5rcykgewogICAgICB0aGlzLmxpbmtzID0gbGlua3M7CiAgICB9OwoKICAgIF9wcm90by51cGRhdGVSZWNvcmREYXRhc0Zyb21BZGFwdGVyID0gZnVuY3Rpb24gdXBkYXRlUmVjb3JkRGF0YXNGcm9tQWRhcHRlcihyZWNvcmREYXRhcykgewogICAgICB0aGlzLnNldEhhc0FueVJlbGF0aW9uc2hpcERhdGEodHJ1ZSk7IC8vVE9ETyhJZ29yKSBtb3ZlIHRoaXMgdG8gYSBwcm9wZXIgcGxhY2UKICAgICAgLy9UT0RPIE9uY2Ugd2UgaGF2ZSBhZGFwdGVyIHN1cHBvcnQsIHdlIG5lZWQgdG8gaGFuZGxlIHVwZGF0ZWQgYW5kIGNhbm9uaWNhbCBjaGFuZ2VzCgogICAgICB0aGlzLmNvbXB1dGVDaGFuZ2VzKHJlY29yZERhdGFzKTsKICAgIH07CgogICAgX3Byb3RvLmNvbXB1dGVDaGFuZ2VzID0gZnVuY3Rpb24gY29tcHV0ZUNoYW5nZXMocmVjb3JkRGF0YXMpIHt9OwoKICAgIF9wcm90by5ub3RpZnlSZWNvcmRSZWxhdGlvbnNoaXBBZGRlZCA9IGZ1bmN0aW9uIG5vdGlmeVJlY29yZFJlbGF0aW9uc2hpcEFkZGVkKHJlY29yZERhdGEsIGlkeHMpIHt9OwoKICAgIF9wcm90by5zZXRIYXNBbnlSZWxhdGlvbnNoaXBEYXRhID0gZnVuY3Rpb24gc2V0SGFzQW55UmVsYXRpb25zaGlwRGF0YSh2YWx1ZSkgewogICAgICB0aGlzLmhhc0FueVJlbGF0aW9uc2hpcERhdGEgPSB2YWx1ZTsKICAgIH07CgogICAgX3Byb3RvLnNldEhhc0RlbWF0ZXJpYWxpemVkSW52ZXJzZSA9IGZ1bmN0aW9uIHNldEhhc0RlbWF0ZXJpYWxpemVkSW52ZXJzZSh2YWx1ZSkgewogICAgICB0aGlzLmhhc0RlbWF0ZXJpYWxpemVkSW52ZXJzZSA9IHZhbHVlOwogICAgfTsKCiAgICBfcHJvdG8uc2V0UmVsYXRpb25zaGlwSXNTdGFsZSA9IGZ1bmN0aW9uIHNldFJlbGF0aW9uc2hpcElzU3RhbGUodmFsdWUpIHsKICAgICAgdGhpcy5yZWxhdGlvbnNoaXBJc1N0YWxlID0gdmFsdWU7CiAgICB9OwoKICAgIF9wcm90by5zZXRSZWxhdGlvbnNoaXBJc0VtcHR5ID0gZnVuY3Rpb24gc2V0UmVsYXRpb25zaGlwSXNFbXB0eSh2YWx1ZSkgewogICAgICB0aGlzLnJlbGF0aW9uc2hpcElzRW1wdHkgPSB2YWx1ZTsKICAgIH07CgogICAgX3Byb3RvLnNldFNob3VsZEZvcmNlUmVsb2FkID0gZnVuY3Rpb24gc2V0U2hvdWxkRm9yY2VSZWxvYWQodmFsdWUpIHsKICAgICAgdGhpcy5zaG91bGRGb3JjZVJlbG9hZCA9IHZhbHVlOwogICAgfTsKCiAgICBfcHJvdG8uc2V0SGFzRmFpbGVkTG9hZEF0dGVtcHQgPSBmdW5jdGlvbiBzZXRIYXNGYWlsZWRMb2FkQXR0ZW1wdCh2YWx1ZSkgewogICAgICB0aGlzLmhhc0ZhaWxlZExvYWRBdHRlbXB0ID0gdmFsdWU7CiAgICB9CiAgICAvKgogICAgIGBwdXNoYCBmb3IgYSByZWxhdGlvbnNoaXAgYWxsb3dzIHRoZSBzdG9yZSB0byBwdXNoIGEgSlNPTiBBUEkgUmVsYXRpb25zaGlwCiAgICAgT2JqZWN0IG9udG8gdGhlIHJlbGF0aW9uc2hpcC4gVGhlIHJlbGF0aW9uc2hpcCB3aWxsIHRoZW4gZXh0cmFjdCBhbmQgc2V0IHRoZQogICAgIG1ldGEsIGRhdGEgYW5kIGxpbmtzIG9mIHRoYXQgcmVsYXRpb25zaGlwLgogICAgICBgcHVzaGAgdXNlIGB1cGRhdGVNZXRhYCwgYHVwZGF0ZURhdGFgIGFuZCBgdXBkYXRlTGlua2AgdG8gdXBkYXRlIHRoZSBzdGF0ZQogICAgIG9mIHRoZSByZWxhdGlvbnNoaXAuCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucHVzaCA9IGZ1bmN0aW9uIHB1c2gocGF5bG9hZCwgaW5pdGlhbCkgewogICAgICB2YXIgaGFzUmVsYXRpb25zaGlwRGF0YVByb3BlcnR5ID0gZmFsc2U7CiAgICAgIHZhciBoYXNMaW5rID0gZmFsc2U7CgogICAgICBpZiAocGF5bG9hZC5tZXRhKSB7CiAgICAgICAgdGhpcy51cGRhdGVNZXRhKHBheWxvYWQubWV0YSk7CiAgICAgIH0KCiAgICAgIGlmIChwYXlsb2FkLmRhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGhhc1JlbGF0aW9uc2hpcERhdGFQcm9wZXJ0eSA9IHRydWU7CiAgICAgICAgdGhpcy51cGRhdGVEYXRhKHBheWxvYWQuZGF0YSwgaW5pdGlhbCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0FzeW5jID09PSBmYWxzZSAmJiAhdGhpcy5oYXNBbnlSZWxhdGlvbnNoaXBEYXRhKSB7CiAgICAgICAgaGFzUmVsYXRpb25zaGlwRGF0YVByb3BlcnR5ID0gdHJ1ZTsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMua2luZCA9PT0gJ2hhc01hbnknID8gW10gOiBudWxsOwogICAgICAgIHRoaXMudXBkYXRlRGF0YShkYXRhLCBpbml0aWFsKTsKICAgICAgfQoKICAgICAgaWYgKHBheWxvYWQubGlua3MpIHsKICAgICAgICB2YXIgb3JpZ2luYWxMaW5rcyA9IHRoaXMubGlua3M7CiAgICAgICAgdGhpcy51cGRhdGVMaW5rcyhwYXlsb2FkLmxpbmtzKTsKCiAgICAgICAgaWYgKHBheWxvYWQubGlua3MucmVsYXRlZCkgewogICAgICAgICAgdmFyIHJlbGF0ZWRMaW5rID0gX25vcm1hbGl6ZUxpbmsocGF5bG9hZC5saW5rcy5yZWxhdGVkKTsKCiAgICAgICAgICB2YXIgY3VycmVudExpbmsgPSBvcmlnaW5hbExpbmtzICYmIG9yaWdpbmFsTGlua3MucmVsYXRlZCA/IF9ub3JtYWxpemVMaW5rKG9yaWdpbmFsTGlua3MucmVsYXRlZCkgOiBudWxsOwogICAgICAgICAgdmFyIGN1cnJlbnRMaW5rSHJlZiA9IGN1cnJlbnRMaW5rID8gY3VycmVudExpbmsuaHJlZiA6IG51bGw7CgogICAgICAgICAgaWYgKHJlbGF0ZWRMaW5rICYmIHJlbGF0ZWRMaW5rLmhyZWYgJiYgcmVsYXRlZExpbmsuaHJlZiAhPT0gY3VycmVudExpbmtIcmVmKSB7CiAgICAgICAgICAgIGhhc0xpbmsgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvKgogICAgICAgRGF0YSBiZWluZyBwdXNoZWQgaW50byB0aGUgcmVsYXRpb25zaGlwIG1pZ2h0IGNvbnRhaW4gb25seSBkYXRhIG9yIGxpbmtzLAogICAgICAgb3IgYSBjb21iaW5hdGlvbiBvZiBib3RoLgogICAgICAgIElGIGNvbnRhaW5zIG9ubHkgZGF0YQogICAgICAgSUYgY29udGFpbnMgYm90aCBsaW5rcyBhbmQgZGF0YQogICAgICAgIHJlbGF0aW9uc2hpcElzRW1wdHkgLT4gdHJ1ZSBpZiBpcyBlbXB0eSBhcnJheSAoaGFzLW1hbnkpIG9yIGlzIG51bGwgKGJlbG9uZ3MtdG8pCiAgICAgICAgaGFzQW55UmVsYXRpb25zaGlwRGF0YSAtPiB0cnVlCiAgICAgICAgaGFzRGVtYXRlcmlhbGl6ZWRJbnZlcnNlIC0+IGZhbHNlCiAgICAgICAgcmVsYXRpb25zaGlwSXNTdGFsZSAtPiBmYWxzZQogICAgICAgIGFsbEludmVyc2VSZWNvcmRzQXJlTG9hZGVkIC0+IHJ1bi1jaGVjay10by1kZXRlcm1pbmUKICAgICAgICBJRiBjb250YWlucyBvbmx5IGxpbmtzCiAgICAgICAgcmVsYXRpb25zaGlwSXNTdGFsZSAtPiB0cnVlCiAgICAgICAqLwoKCiAgICAgIHRoaXMuc2V0SGFzRmFpbGVkTG9hZEF0dGVtcHQoZmFsc2UpOwoKICAgICAgaWYgKGhhc1JlbGF0aW9uc2hpcERhdGFQcm9wZXJ0eSkgewogICAgICAgIHZhciByZWxhdGlvbnNoaXBJc0VtcHR5ID0gcGF5bG9hZC5kYXRhID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkocGF5bG9hZC5kYXRhKSAmJiBwYXlsb2FkLmRhdGEubGVuZ3RoID09PSAwOwogICAgICAgIHRoaXMuc2V0SGFzQW55UmVsYXRpb25zaGlwRGF0YSh0cnVlKTsKICAgICAgICB0aGlzLnNldFJlbGF0aW9uc2hpcElzU3RhbGUoZmFsc2UpOwogICAgICAgIHRoaXMuc2V0SGFzRGVtYXRlcmlhbGl6ZWRJbnZlcnNlKGZhbHNlKTsKICAgICAgICB0aGlzLnNldFJlbGF0aW9uc2hpcElzRW1wdHkocmVsYXRpb25zaGlwSXNFbXB0eSk7CiAgICAgIH0gZWxzZSBpZiAoaGFzTGluaykgewogICAgICAgIHRoaXMuc2V0UmVsYXRpb25zaGlwSXNTdGFsZSh0cnVlKTsKCiAgICAgICAgaWYgKCFpbml0aWFsKSB7CiAgICAgICAgICB2YXIgcmVjb3JkRGF0YSA9IHRoaXMucmVjb3JkRGF0YTsKICAgICAgICAgIHZhciBzdG9yZVdyYXBwZXIgPSB0aGlzLnJlY29yZERhdGEuc3RvcmVXcmFwcGVyOwoKICAgICAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MpIHsKICAgICAgICAgICAgc3RvcmVXcmFwcGVyLm5vdGlmeUJlbG9uZ3NUb0NoYW5nZShyZWNvcmREYXRhLm1vZGVsTmFtZSwgcmVjb3JkRGF0YS5pZCwgcmVjb3JkRGF0YS5jbGllbnRJZCwgdGhpcy5rZXkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RvcmVXcmFwcGVyLm5vdGlmeVByb3BlcnR5Q2hhbmdlKHJlY29yZERhdGEubW9kZWxOYW1lLCByZWNvcmREYXRhLmlkLCByZWNvcmREYXRhLmNsaWVudElkLCAvLyBXZSBrbm93IHdlIGFyZSBub3QgYW4gaW1wbGljaXQgcmVsYXRpb25zaGlwIGhlcmUKICAgICAgICAgICAgdGhpcy5rZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8ubG9jYWxTdGF0ZUlzRW1wdHkgPSBmdW5jdGlvbiBsb2NhbFN0YXRlSXNFbXB0eSgpIHt9OwoKICAgIF9wcm90by51cGRhdGVEYXRhID0gZnVuY3Rpb24gdXBkYXRlRGF0YShwYXlsb2FkLCBpbml0aWFsKSB7fTsKCiAgICBfcHJvdG8uZGVzdHJveSA9IGZ1bmN0aW9uIGRlc3Ryb3koKSB7fTsKCiAgICBfY3JlYXRlQ2xhc3MoUmVsYXRpb25zaGlwLCBbewogICAgICBrZXk6ICJpc05ldyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLnJlY29yZERhdGEuaXNOZXcoKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfaW52ZXJzZU1ldGEiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICBpZiAodGhpcy5fX2ludmVyc2VNZXRhID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciBpbnZlcnNlTWV0YSA9IG51bGw7CgogICAgICAgICAgaWYgKHRoaXMuaW52ZXJzZUtleSkgewogICAgICAgICAgICAvLyBXZSBrbm93IHdlIGhhdmUgYSBmdWxsIGludmVyc2UgcmVsYXRpb25zaGlwCiAgICAgICAgICAgIHZhciB0eXBlID0gdGhpcy5yZWxhdGlvbnNoaXBNZXRhLnR5cGU7CiAgICAgICAgICAgIHZhciBpbnZlcnNlTW9kZWxDbGFzcyA9IHRoaXMuc3RvcmUubW9kZWxGb3IodHlwZSk7CiAgICAgICAgICAgIHZhciBpbnZlcnNlUmVsYXRpb25zaGlwcyA9IEVtYmVyLmdldChpbnZlcnNlTW9kZWxDbGFzcywgJ3JlbGF0aW9uc2hpcHNCeU5hbWUnKTsKICAgICAgICAgICAgaW52ZXJzZU1ldGEgPSBpbnZlcnNlUmVsYXRpb25zaGlwcy5nZXQodGhpcy5pbnZlcnNlS2V5KTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLl9faW52ZXJzZU1ldGEgPSBpbnZlcnNlTWV0YTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLl9faW52ZXJzZU1ldGE7CiAgICAgIH0KICAgIH1dKTsKCiAgICByZXR1cm4gUmVsYXRpb25zaGlwOwogIH0oKTsKCiAgZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXMkMSh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKICBmdW5jdGlvbiBfY3JlYXRlQ2xhc3MkMShDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzJDEoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyQxKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKICBmdW5jdGlvbiBfaW5oZXJpdHNMb29zZSQxKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcy5wcm90b3R5cGUpOyBzdWJDbGFzcy5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBzdWJDbGFzczsgc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQogIC8qKgogICAgQG1vZHVsZSBAZW1iZXItZGF0YS9zdG9yZQogICovCgogIHZhciBNYW55UmVsYXRpb25zaGlwID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9SZWxhdGlvbnNoaXApIHsKICAgIF9pbmhlcml0c0xvb3NlJDEoTWFueVJlbGF0aW9uc2hpcCwgX1JlbGF0aW9uc2hpcCk7CgogICAgZnVuY3Rpb24gTWFueVJlbGF0aW9uc2hpcChzdG9yZSwgaW52ZXJzZUtleSwgcmVsYXRpb25zaGlwTWV0YSwgcmVjb3JkRGF0YSwgaW52ZXJzZUlzQXN5bmMpIHsKICAgICAgdmFyIF90aGlzOwoKICAgICAgX3RoaXMgPSBfUmVsYXRpb25zaGlwLmNhbGwodGhpcywgc3RvcmUsIGludmVyc2VLZXksIHJlbGF0aW9uc2hpcE1ldGEsIHJlY29yZERhdGEsIGludmVyc2VJc0FzeW5jKSB8fCB0aGlzOwogICAgICBfdGhpcy5jYW5vbmljYWxTdGF0ZSA9IHZvaWQgMDsKICAgICAgX3RoaXMuY3VycmVudFN0YXRlID0gdm9pZCAwOwogICAgICBfdGhpcy5fd2lsbFVwZGF0ZU1hbnlBcnJheSA9IHZvaWQgMDsKICAgICAgX3RoaXMuX3BlbmRpbmdNYW55QXJyYXlVcGRhdGVzID0gdm9pZCAwOwogICAgICBfdGhpcy5rZXkgPSB2b2lkIDA7CiAgICAgIF90aGlzLmNhbm9uaWNhbFN0YXRlID0gW107CiAgICAgIF90aGlzLmN1cnJlbnRTdGF0ZSA9IFtdOwogICAgICBfdGhpcy5fd2lsbFVwZGF0ZU1hbnlBcnJheSA9IGZhbHNlOwogICAgICBfdGhpcy5fcGVuZGluZ01hbnlBcnJheVVwZGF0ZXMgPSBudWxsOwogICAgICBfdGhpcy5rZXkgPSByZWxhdGlvbnNoaXBNZXRhLmtleTsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBNYW55UmVsYXRpb25zaGlwLnByb3RvdHlwZTsKCiAgICBfcHJvdG8uYWRkQ2Fub25pY2FsUmVjb3JkRGF0YSA9IGZ1bmN0aW9uIGFkZENhbm9uaWNhbFJlY29yZERhdGEocmVjb3JkRGF0YSwgaWR4KSB7CiAgICAgIGlmICh0aGlzLmNhbm9uaWNhbE1lbWJlcnMuaGFzKHJlY29yZERhdGEpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoaWR4ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLmNhbm9uaWNhbFN0YXRlLnNwbGljZShpZHgsIDAsIHJlY29yZERhdGEpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuY2Fub25pY2FsU3RhdGUucHVzaChyZWNvcmREYXRhKTsKICAgICAgfQoKICAgICAgX1JlbGF0aW9uc2hpcC5wcm90b3R5cGUuYWRkQ2Fub25pY2FsUmVjb3JkRGF0YS5jYWxsKHRoaXMsIHJlY29yZERhdGEsIGlkeCk7CiAgICB9OwoKICAgIF9wcm90by5pbnZlcnNlRGlkRGVtYXRlcmlhbGl6ZSA9IGZ1bmN0aW9uIGludmVyc2VEaWREZW1hdGVyaWFsaXplKGludmVyc2VSZWNvcmREYXRhKSB7CiAgICAgIF9SZWxhdGlvbnNoaXAucHJvdG90eXBlLmludmVyc2VEaWREZW1hdGVyaWFsaXplLmNhbGwodGhpcywgaW52ZXJzZVJlY29yZERhdGEpOwoKICAgICAgaWYgKHRoaXMuaXNBc3luYykgewogICAgICAgIHRoaXMubm90aWZ5TWFueUFycmF5SXNTdGFsZSgpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5hZGRSZWNvcmREYXRhID0gZnVuY3Rpb24gYWRkUmVjb3JkRGF0YShyZWNvcmREYXRhLCBpZHgpIHsKICAgICAgaWYgKHRoaXMubWVtYmVycy5oYXMocmVjb3JkRGF0YSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gVE9ETyBUeXBlIHRoaXMKCgogICAgICBfUmVsYXRpb25zaGlwLnByb3RvdHlwZS5hZGRSZWNvcmREYXRhLmNhbGwodGhpcywgcmVjb3JkRGF0YSwgaWR4KTsgLy8gbWFrZSBsYXp5IGxhdGVyCgoKICAgICAgaWYgKGlkeCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWR4ID0gdGhpcy5jdXJyZW50U3RhdGUubGVuZ3RoOwogICAgICB9CgogICAgICB0aGlzLmN1cnJlbnRTdGF0ZS5zcGxpY2UoaWR4LCAwLCByZWNvcmREYXRhKTsgLy8gVE9ETyBJZ29yIGNvbnNpZGVyIG1ha2luZyBkaXJlY3QgdG8gcmVtb3ZlIHRoZSBpbmRpcmVjdGlvbgogICAgICAvLyBXZSBhcmUgbm90IGxhemlseSBhY2Nlc3NpbmcgdGhlIG1hbnlBcnJheSBoZXJlIGJlY2F1c2UgdGhlIGNoYW5nZSBpcyBjb21pbmcgZnJvbSBhcHAgc2lkZQogICAgICAvLyB0aGlzLm1hbnlBcnJheS5mbHVzaENhbm9uaWNhbCh0aGlzLmN1cnJlbnRTdGF0ZSk7CgogICAgICB0aGlzLm5vdGlmeUhhc01hbnlDaGFuZ2UoKTsKICAgIH07CgogICAgX3Byb3RvLnJlbW92ZUNhbm9uaWNhbFJlY29yZERhdGFGcm9tT3duID0gZnVuY3Rpb24gcmVtb3ZlQ2Fub25pY2FsUmVjb3JkRGF0YUZyb21Pd24ocmVjb3JkRGF0YSwgaWR4KSB7CiAgICAgIHZhciBpID0gaWR4OwoKICAgICAgaWYgKCF0aGlzLmNhbm9uaWNhbE1lbWJlcnMuaGFzKHJlY29yZERhdGEpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoaSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaSA9IHRoaXMuY2Fub25pY2FsU3RhdGUuaW5kZXhPZihyZWNvcmREYXRhKTsKICAgICAgfQoKICAgICAgaWYgKGkgPiAtMSkgewogICAgICAgIHRoaXMuY2Fub25pY2FsU3RhdGUuc3BsaWNlKGksIDEpOwogICAgICB9CgogICAgICBfUmVsYXRpb25zaGlwLnByb3RvdHlwZS5yZW1vdmVDYW5vbmljYWxSZWNvcmREYXRhRnJvbU93bi5jYWxsKHRoaXMsIHJlY29yZERhdGEsIGlkeCk7IC8vVE9ETyhJZ29yKSBGaWd1cmUgb3V0IHdoYXQgdG8gZG8gaGVyZQoKICAgIH07CgogICAgX3Byb3RvLnJlbW92ZUFsbENhbm9uaWNhbFJlY29yZERhdGFzRnJvbU93biA9IGZ1bmN0aW9uIHJlbW92ZUFsbENhbm9uaWNhbFJlY29yZERhdGFzRnJvbU93bigpIHsKICAgICAgX1JlbGF0aW9uc2hpcC5wcm90b3R5cGUucmVtb3ZlQWxsQ2Fub25pY2FsUmVjb3JkRGF0YXNGcm9tT3duLmNhbGwodGhpcyk7CgogICAgICB0aGlzLmNhbm9uaWNhbE1lbWJlcnMuY2xlYXIoKTsKICAgICAgdGhpcy5jYW5vbmljYWxTdGF0ZS5zcGxpY2UoMCwgdGhpcy5jYW5vbmljYWxTdGF0ZS5sZW5ndGgpOwoKICAgICAgX1JlbGF0aW9uc2hpcC5wcm90b3R5cGUucmVtb3ZlQWxsQ2Fub25pY2FsUmVjb3JkRGF0YXNGcm9tT3duLmNhbGwodGhpcyk7CiAgICB9IC8vVE9ETyhJZ29yKSBETyBXRSBORUVEIFRISVM/CiAgICA7CgogICAgX3Byb3RvLnJlbW92ZUNvbXBsZXRlbHlGcm9tT3duID0gZnVuY3Rpb24gcmVtb3ZlQ29tcGxldGVseUZyb21Pd24ocmVjb3JkRGF0YSkgewogICAgICBfUmVsYXRpb25zaGlwLnByb3RvdHlwZS5yZW1vdmVDb21wbGV0ZWx5RnJvbU93bi5jYWxsKHRoaXMsIHJlY29yZERhdGEpOyAvLyBUT0RPIFNrRVBUSUNBTAoKCiAgICAgIHZhciBjYW5vbmljYWxJbmRleCA9IHRoaXMuY2Fub25pY2FsU3RhdGUuaW5kZXhPZihyZWNvcmREYXRhKTsKCiAgICAgIGlmIChjYW5vbmljYWxJbmRleCAhPT0gLTEpIHsKICAgICAgICB0aGlzLmNhbm9uaWNhbFN0YXRlLnNwbGljZShjYW5vbmljYWxJbmRleCwgMSk7CiAgICAgIH0KCiAgICAgIHRoaXMucmVtb3ZlUmVjb3JkRGF0YUZyb21Pd24ocmVjb3JkRGF0YSk7CiAgICB9OwoKICAgIF9wcm90by5mbHVzaENhbm9uaWNhbCA9IGZ1bmN0aW9uIGZsdXNoQ2Fub25pY2FsKCkgewogICAgICB2YXIgdG9TZXQgPSB0aGlzLmNhbm9uaWNhbFN0YXRlOyAvL2EgaGFjayBmb3Igbm90IHJlbW92aW5nIG5ldyByZWNvcmRzCiAgICAgIC8vVE9ETyByZW1vdmUgb25jZSB3ZSBoYXZlIHByb3BlciBkaWZmaW5nCgogICAgICB2YXIgbmV3UmVjb3JkRGF0YXMgPSB0aGlzLmN1cnJlbnRTdGF0ZS5maWx0ZXIoIC8vIG9ubHkgYWRkIG5ldyBpbnRlcm5hbE1vZGVscyB3aGljaCBhcmUgbm90IHlldCBpbiB0aGUgY2Fub25pY2FsIHN0YXRlIG9mIHRoaXMKICAgICAgLy8gcmVsYXRpb25zaGlwIChhIG5ldyBpbnRlcm5hbE1vZGVsIGNhbiBiZSBpbiB0aGUgY2Fub25pY2FsIHN0YXRlIGlmIGl0IGhhcwogICAgICAvLyBiZWVuICdhY2tub3dsZWdlZCcgdG8gYmUgaW4gdGhlIHJlbGF0aW9uc2hpcCB2aWEgYSBzdG9yZS5wdXNoKQogICAgICAvL1RPRE8gSWdvciBkZWFsIHdpdGggdGhpcwogICAgICBmdW5jdGlvbiAocmVjb3JkRGF0YSkgewogICAgICAgIHJldHVybiByZWNvcmREYXRhLmlzTmV3KCkgJiYgdG9TZXQuaW5kZXhPZihyZWNvcmREYXRhKSA9PT0gLTE7CiAgICAgIH0pOwogICAgICB0b1NldCA9IHRvU2V0LmNvbmNhdChuZXdSZWNvcmREYXRhcyk7CiAgICAgIC8qCiAgICAgIGlmICh0aGlzLl9tYW55QXJyYXkpIHsKICAgICAgICB0aGlzLl9tYW55QXJyYXkuZmx1c2hDYW5vbmljYWwodG9TZXQpOwogICAgICB9CiAgICAgICovCgogICAgICB0aGlzLmN1cnJlbnRTdGF0ZSA9IHRvU2V0OwoKICAgICAgX1JlbGF0aW9uc2hpcC5wcm90b3R5cGUuZmx1c2hDYW5vbmljYWwuY2FsbCh0aGlzKTsgLy8gT25jZSB3ZSBjbGVhbiB1cCBhbGwgdGhlIGZsdXNoaW5nLCB3ZSB3aWxsIGJlIGxlZnQgd2l0aCBhdCBsZWFzdCB0aGUgbm90aWZ5aW5nIHBhcnQKCgogICAgICB0aGlzLm5vdGlmeUhhc01hbnlDaGFuZ2UoKTsKICAgIH0gLy9UT0RPKElnb3IpIGlkeCBub3QgdXNlZCBjdXJyZW50bHksIGZpeAogICAgOwoKICAgIF9wcm90by5yZW1vdmVSZWNvcmREYXRhRnJvbU93biA9IGZ1bmN0aW9uIHJlbW92ZVJlY29yZERhdGFGcm9tT3duKHJlY29yZERhdGEsIGlkeCkgewogICAgICBfUmVsYXRpb25zaGlwLnByb3RvdHlwZS5yZW1vdmVSZWNvcmREYXRhRnJvbU93bi5jYWxsKHRoaXMsIHJlY29yZERhdGEsIGlkeCk7CgogICAgICB2YXIgaW5kZXggPSBpZHggfHwgdGhpcy5jdXJyZW50U3RhdGUuaW5kZXhPZihyZWNvcmREYXRhKTsgLy9UT0RPIElHT1IgREFWSUQgSU5WRVNUSUdBVEUKCiAgICAgIGlmIChpbmRleCA9PT0gLTEpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuY3VycmVudFN0YXRlLnNwbGljZShpbmRleCwgMSk7IC8vIFRPRE8gSWdvciBjb25zaWRlciBtYWtpbmcgZGlyZWN0IHRvIHJlbW92ZSB0aGUgaW5kaXJlY3Rpb24KICAgICAgLy8gV2UgYXJlIG5vdCBsYXppbHkgYWNjZXNzaW5nIHRoZSBtYW55QXJyYXkgaGVyZSBiZWNhdXNlIHRoZSBjaGFuZ2UgaXMgY29taW5nIGZyb20gYXBwIHNpZGUKCiAgICAgIHRoaXMubm90aWZ5SGFzTWFueUNoYW5nZSgpOyAvLyB0aGlzLm1hbnlBcnJheS5mbHVzaENhbm9uaWNhbCh0aGlzLmN1cnJlbnRTdGF0ZSk7CiAgICB9OwoKICAgIF9wcm90by5ub3RpZnlSZWNvcmRSZWxhdGlvbnNoaXBBZGRlZCA9IGZ1bmN0aW9uIG5vdGlmeVJlY29yZFJlbGF0aW9uc2hpcEFkZGVkKCkgewogICAgICB0aGlzLm5vdGlmeUhhc01hbnlDaGFuZ2UoKTsKICAgIH07CgogICAgX3Byb3RvLmNvbXB1dGVDaGFuZ2VzID0gZnVuY3Rpb24gY29tcHV0ZUNoYW5nZXMocmVjb3JkRGF0YXMpIHsKICAgICAgaWYgKHJlY29yZERhdGFzID09PSB2b2lkIDApIHsKICAgICAgICByZWNvcmREYXRhcyA9IFtdOwogICAgICB9CgogICAgICB2YXIgbWVtYmVycyA9IHRoaXMuY2Fub25pY2FsTWVtYmVyczsKICAgICAgdmFyIHJlY29yZERhdGFzVG9SZW1vdmUgPSBbXTsKICAgICAgdmFyIHJlY29yZERhdGFzU2V0ID0gc2V0Rm9yQXJyYXkocmVjb3JkRGF0YXMpOwogICAgICBtZW1iZXJzLmZvckVhY2goZnVuY3Rpb24gKG1lbWJlcikgewogICAgICAgIGlmIChyZWNvcmREYXRhc1NldC5oYXMobWVtYmVyKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgcmVjb3JkRGF0YXNUb1JlbW92ZS5wdXNoKG1lbWJlcik7CiAgICAgIH0pOwogICAgICB0aGlzLnJlbW92ZUNhbm9uaWNhbFJlY29yZERhdGFzKHJlY29yZERhdGFzVG9SZW1vdmUpOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSByZWNvcmREYXRhcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB2YXIgcmVjb3JkRGF0YSA9IHJlY29yZERhdGFzW2ldOwogICAgICAgIHRoaXMucmVtb3ZlQ2Fub25pY2FsUmVjb3JkRGF0YShyZWNvcmREYXRhKTsKICAgICAgICB0aGlzLmFkZENhbm9uaWNhbFJlY29yZERhdGEocmVjb3JkRGF0YSwgaSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLnNldEluaXRpYWxSZWNvcmREYXRhcyA9IGZ1bmN0aW9uIHNldEluaXRpYWxSZWNvcmREYXRhcyhyZWNvcmREYXRhcykgewogICAgICBpZiAoQXJyYXkuaXNBcnJheShyZWNvcmREYXRhcykgPT09IGZhbHNlIHx8ICFyZWNvcmREYXRhcyB8fCByZWNvcmREYXRhcy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVjb3JkRGF0YXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgcmVjb3JkRGF0YSA9IHJlY29yZERhdGFzW2ldOwoKICAgICAgICBpZiAodGhpcy5jYW5vbmljYWxNZW1iZXJzLmhhcyhyZWNvcmREYXRhKSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNhbm9uaWNhbE1lbWJlcnMuYWRkKHJlY29yZERhdGEpOwogICAgICAgIHRoaXMubWVtYmVycy5hZGQocmVjb3JkRGF0YSk7CiAgICAgICAgdGhpcy5zZXR1cEludmVyc2VSZWxhdGlvbnNoaXAocmVjb3JkRGF0YSk7CiAgICAgIH0KCiAgICAgIHRoaXMuY2Fub25pY2FsU3RhdGUgPSB0aGlzLmNhbm9uaWNhbE1lbWJlcnMudG9BcnJheSgpOwogICAgfQogICAgLyoKICAgICAgVGhpcyBpcyBlc3NlbnRpYWxseSBhICJzeW5jIiB2ZXJzaW9uIG9mCiAgICAgICAgbm90aWZ5SGFzTWFueUNoYW5nZS4gV2Ugc2hvdWxkIHdvcmsgdG8gdW5pZnkKICAgICAgICB0aGVzZSB3b3JsZHMKICAgICAgICAgLSBAcnVuc3BpcmVkCiAgICAqLwogICAgOwoKICAgIF9wcm90by5ub3RpZnlNYW55QXJyYXlJc1N0YWxlID0gZnVuY3Rpb24gbm90aWZ5TWFueUFycmF5SXNTdGFsZSgpIHsKICAgICAgdmFyIHJlY29yZERhdGEgPSB0aGlzLnJlY29yZERhdGE7CiAgICAgIHZhciBzdG9yZVdyYXBwZXIgPSByZWNvcmREYXRhLnN0b3JlV3JhcHBlcjsKCiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MpIHsKICAgICAgICBzdG9yZVdyYXBwZXIubm90aWZ5SGFzTWFueUNoYW5nZShyZWNvcmREYXRhLm1vZGVsTmFtZSwgcmVjb3JkRGF0YS5pZCwgcmVjb3JkRGF0YS5jbGllbnRJZCwgdGhpcy5rZXkpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0b3JlV3JhcHBlci5ub3RpZnlQcm9wZXJ0eUNoYW5nZShyZWNvcmREYXRhLm1vZGVsTmFtZSwgcmVjb3JkRGF0YS5pZCwgcmVjb3JkRGF0YS5jbGllbnRJZCwgdGhpcy5rZXkpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5ub3RpZnlIYXNNYW55Q2hhbmdlID0gZnVuY3Rpb24gbm90aWZ5SGFzTWFueUNoYW5nZSgpIHsKICAgICAgdmFyIHJlY29yZERhdGEgPSB0aGlzLnJlY29yZERhdGE7CiAgICAgIHZhciBzdG9yZVdyYXBwZXIgPSByZWNvcmREYXRhLnN0b3JlV3JhcHBlcjsKICAgICAgc3RvcmVXcmFwcGVyLm5vdGlmeUhhc01hbnlDaGFuZ2UocmVjb3JkRGF0YS5tb2RlbE5hbWUsIHJlY29yZERhdGEuaWQsIHJlY29yZERhdGEuY2xpZW50SWQsIHRoaXMua2V5KTsKICAgIH07CgogICAgX3Byb3RvLmdldERhdGEgPSBmdW5jdGlvbiBnZXREYXRhKCkgewogICAgICB2YXIgcGF5bG9hZCA9IHt9OwoKICAgICAgaWYgKHRoaXMuaGFzQW55UmVsYXRpb25zaGlwRGF0YSkgewogICAgICAgIHBheWxvYWQuZGF0YSA9IHRoaXMuY3VycmVudFN0YXRlLm1hcChmdW5jdGlvbiAocmVjb3JkRGF0YSkgewogICAgICAgICAgcmV0dXJuIHJlY29yZERhdGEuZ2V0UmVzb3VyY2VJZGVudGlmaWVyKCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmxpbmtzKSB7CiAgICAgICAgcGF5bG9hZC5saW5rcyA9IHRoaXMubGlua3M7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLm1ldGEpIHsKICAgICAgICBwYXlsb2FkLm1ldGEgPSB0aGlzLm1ldGE7CiAgICAgIH0gLy8gVE9ETyBAcnVuc3BpcmVkOiB0aGUgQGlnb3IgcmVmYWN0b3IgaXMgdG9vIGxpbWl0aW5nIGZvciByZWxhdGlvbnNoaXAgc3RhdGUKICAgICAgLy8gICB3ZSBzaG91bGQgcmVjb25zaWRlciB3aGVyZSB3ZSBmZXRjaCBmcm9tLgoKCiAgICAgIHBheWxvYWQuX3JlbGF0aW9uc2hpcCA9IHRoaXM7CiAgICAgIHJldHVybiBwYXlsb2FkOwogICAgfTsKCiAgICBfcHJvdG8udXBkYXRlRGF0YSA9IGZ1bmN0aW9uIHVwZGF0ZURhdGEoZGF0YSwgaW5pdGlhbCkgewogICAgICB2YXIgcmVjb3JkRGF0YXM7CgogICAgICBpZiAoRW1iZXIuaXNOb25lKGRhdGEpKSB7CiAgICAgICAgcmVjb3JkRGF0YXMgPSB1bmRlZmluZWQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVjb3JkRGF0YXMgPSBuZXcgQXJyYXkoZGF0YS5sZW5ndGgpOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHJlY29yZERhdGFzW2ldID0gdGhpcy5yZWNvcmREYXRhLnN0b3JlV3JhcHBlci5yZWNvcmREYXRhRm9yKGRhdGFbaV0udHlwZSwgZGF0YVtpXS5pZCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaW5pdGlhbCkgewogICAgICAgIHRoaXMuc2V0SW5pdGlhbFJlY29yZERhdGFzKHJlY29yZERhdGFzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnVwZGF0ZVJlY29yZERhdGFzRnJvbUFkYXB0ZXIocmVjb3JkRGF0YXMpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEZsYWcgaW5kaWNhdGluZyB3aGV0aGVyIGFsbCBpbnZlcnNlIHJlY29yZHMgYXJlIGF2YWlsYWJsZQogICAgICoKICAgICAqIHRydWUgaWYgaW52ZXJzZSByZWNvcmRzIGV4aXN0IGFuZCBhcmUgYWxsIGxvYWRlZCAoYWxsIG5vdCBlbXB0eSkKICAgICAqIHRydWUgaWYgdGhlcmUgYXJlIG5vIGludmVyc2UgcmVjb3JkcwogICAgICogZmFsc2UgaWYgdGhlIGludmVyc2UgcmVjb3JkcyBleGlzdCBhbmQgYW55IGFyZSBub3QgbG9hZGVkIChhbnkgZW1wdHkpCiAgICAgKgogICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICAqLwogICAgOwoKICAgIF9jcmVhdGVDbGFzcyQxKE1hbnlSZWxhdGlvbnNoaXAsIFt7CiAgICAgIGtleTogImFsbEludmVyc2VSZWNvcmRzQXJlTG9hZGVkIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgLy8gY2hlY2sgY3VycmVudFN0YXRlIGZvciB1bmxvYWRlZCByZWNvcmRzCiAgICAgICAgdmFyIGhhc0VtcHR5UmVjb3JkcyA9IHRoaXMuY3VycmVudFN0YXRlLnJlZHVjZShmdW5jdGlvbiAoaGFzRW1wdHlNb2RlbCwgaSkgewogICAgICAgICAgcmV0dXJuIGhhc0VtcHR5TW9kZWwgfHwgaS5pc0VtcHR5KCk7CiAgICAgICAgfSwgZmFsc2UpOyAvLyBjaGVjayB1bi1zeW5jZWQgc3RhdGUgZm9yIHVubG9hZGVkIHJlY29yZHMKCiAgICAgICAgaWYgKCFoYXNFbXB0eVJlY29yZHMgJiYgdGhpcy53aWxsU3luYykgewogICAgICAgICAgaGFzRW1wdHlSZWNvcmRzID0gdGhpcy5jYW5vbmljYWxTdGF0ZS5yZWR1Y2UoZnVuY3Rpb24gKGhhc0VtcHR5TW9kZWwsIGkpIHsKICAgICAgICAgICAgcmV0dXJuIGhhc0VtcHR5TW9kZWwgfHwgIWkuaXNFbXB0eSgpOwogICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICFoYXNFbXB0eVJlY29yZHM7CiAgICAgIH0KICAgIH1dKTsKCiAgICByZXR1cm4gTWFueVJlbGF0aW9uc2hpcDsKICB9KFJlbGF0aW9uc2hpcCk7CgogIGZ1bmN0aW9uIHNldEZvckFycmF5KGFycmF5KSB7CiAgICB2YXIgc2V0ID0gbmV3IEVtYmVyRGF0YU9yZGVyZWRTZXQoKTsKCiAgICBpZiAoYXJyYXkpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBhcnJheS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBzZXQuYWRkKGFycmF5W2ldKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBzZXQ7CiAgfQoKICBmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyQyKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9CgogIGZ1bmN0aW9uIF9jcmVhdGVDbGFzcyQyKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMkMihDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzJDIoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9CgogIGZ1bmN0aW9uIF9pbmhlcml0c0xvb3NlJDIoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzLnByb3RvdHlwZSk7IHN1YkNsYXNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHN1YkNsYXNzOyBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9CgogIHZhciBCZWxvbmdzVG9SZWxhdGlvbnNoaXAgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX1JlbGF0aW9uc2hpcCkgewogICAgX2luaGVyaXRzTG9vc2UkMihCZWxvbmdzVG9SZWxhdGlvbnNoaXAsIF9SZWxhdGlvbnNoaXApOwoKICAgIGZ1bmN0aW9uIEJlbG9uZ3NUb1JlbGF0aW9uc2hpcChzdG9yZSwgaW52ZXJzZUtleSwgcmVsYXRpb25zaGlwTWV0YSwgcmVjb3JkRGF0YSwgaW52ZXJzZUlzQXN5bmMpIHsKICAgICAgdmFyIF90aGlzOwoKICAgICAgX3RoaXMgPSBfUmVsYXRpb25zaGlwLmNhbGwodGhpcywgc3RvcmUsIGludmVyc2VLZXksIHJlbGF0aW9uc2hpcE1ldGEsIHJlY29yZERhdGEsIGludmVyc2VJc0FzeW5jKSB8fCB0aGlzOwogICAgICBfdGhpcy5pbnZlcnNlUmVjb3JkRGF0YSA9IHZvaWQgMDsKICAgICAgX3RoaXMuY2Fub25pY2FsU3RhdGUgPSB2b2lkIDA7CiAgICAgIF90aGlzLmtleSA9IHZvaWQgMDsKICAgICAgX3RoaXMua2V5ID0gcmVsYXRpb25zaGlwTWV0YS5rZXk7CiAgICAgIF90aGlzLmludmVyc2VSZWNvcmREYXRhID0gbnVsbDsKICAgICAgX3RoaXMuY2Fub25pY2FsU3RhdGUgPSBudWxsOwogICAgICBfdGhpcy5rZXkgPSByZWxhdGlvbnNoaXBNZXRhLmtleTsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBCZWxvbmdzVG9SZWxhdGlvbnNoaXAucHJvdG90eXBlOwoKICAgIF9wcm90by5zZXRSZWNvcmREYXRhID0gZnVuY3Rpb24gc2V0UmVjb3JkRGF0YShyZWNvcmREYXRhKSB7CiAgICAgIGlmIChyZWNvcmREYXRhKSB7CiAgICAgICAgdGhpcy5hZGRSZWNvcmREYXRhKHJlY29yZERhdGEpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuaW52ZXJzZVJlY29yZERhdGEpIHsKICAgICAgICB0aGlzLnJlbW92ZVJlY29yZERhdGEodGhpcy5pbnZlcnNlUmVjb3JkRGF0YSk7CiAgICAgIH0KCiAgICAgIHRoaXMuc2V0SGFzQW55UmVsYXRpb25zaGlwRGF0YSh0cnVlKTsKICAgICAgdGhpcy5zZXRSZWxhdGlvbnNoaXBJc1N0YWxlKGZhbHNlKTsKICAgICAgdGhpcy5zZXRSZWxhdGlvbnNoaXBJc0VtcHR5KGZhbHNlKTsKICAgIH07CgogICAgX3Byb3RvLnNldENhbm9uaWNhbFJlY29yZERhdGEgPSBmdW5jdGlvbiBzZXRDYW5vbmljYWxSZWNvcmREYXRhKHJlY29yZERhdGEpIHsKICAgICAgaWYgKHJlY29yZERhdGEpIHsKICAgICAgICB0aGlzLmFkZENhbm9uaWNhbFJlY29yZERhdGEocmVjb3JkRGF0YSk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5jYW5vbmljYWxTdGF0ZSkgewogICAgICAgIHRoaXMucmVtb3ZlQ2Fub25pY2FsUmVjb3JkRGF0YSh0aGlzLmNhbm9uaWNhbFN0YXRlKTsKICAgICAgfQoKICAgICAgdGhpcy5mbHVzaENhbm9uaWNhbExhdGVyKCk7CiAgICB9OwoKICAgIF9wcm90by5zZXRJbml0aWFsQ2Fub25pY2FsUmVjb3JkRGF0YSA9IGZ1bmN0aW9uIHNldEluaXRpYWxDYW5vbmljYWxSZWNvcmREYXRhKHJlY29yZERhdGEpIHsKICAgICAgaWYgKCFyZWNvcmREYXRhKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vIFdoZW4gd2UgaW5pdGlhbGl6ZSBhIGJlbG9uZ3NUbyByZWxhdGlvbnNoaXAsIHdlIHdhbnQgdG8gYXZvaWQgd29yayBsaWtlCiAgICAgIC8vIG5vdGlmeWluZyBvdXIgaW50ZXJuYWxNb2RlbCB0aGF0IHdlJ3ZlICJjaGFuZ2VkIiBhbmQgZXhjZXNzaXZlIHRocmFzaCBvbgogICAgICAvLyBzZXR0aW5nIHVwIGludmVyc2UgcmVsYXRpb25zaGlwcwoKCiAgICAgIHRoaXMuY2Fub25pY2FsTWVtYmVycy5hZGQocmVjb3JkRGF0YSk7CiAgICAgIHRoaXMubWVtYmVycy5hZGQocmVjb3JkRGF0YSk7CiAgICAgIHRoaXMuaW52ZXJzZVJlY29yZERhdGEgPSB0aGlzLmNhbm9uaWNhbFN0YXRlID0gcmVjb3JkRGF0YTsKICAgICAgdGhpcy5zZXR1cEludmVyc2VSZWxhdGlvbnNoaXAocmVjb3JkRGF0YSk7CiAgICB9OwoKICAgIF9wcm90by5hZGRDYW5vbmljYWxSZWNvcmREYXRhID0gZnVuY3Rpb24gYWRkQ2Fub25pY2FsUmVjb3JkRGF0YShyZWNvcmREYXRhKSB7CiAgICAgIGlmICh0aGlzLmNhbm9uaWNhbE1lbWJlcnMuaGFzKHJlY29yZERhdGEpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAodGhpcy5jYW5vbmljYWxTdGF0ZSkgewogICAgICAgIHRoaXMucmVtb3ZlQ2Fub25pY2FsUmVjb3JkRGF0YSh0aGlzLmNhbm9uaWNhbFN0YXRlKTsKICAgICAgfQoKICAgICAgdGhpcy5jYW5vbmljYWxTdGF0ZSA9IHJlY29yZERhdGE7CgogICAgICBfUmVsYXRpb25zaGlwLnByb3RvdHlwZS5hZGRDYW5vbmljYWxSZWNvcmREYXRhLmNhbGwodGhpcywgcmVjb3JkRGF0YSk7CgogICAgICB0aGlzLnNldEhhc0FueVJlbGF0aW9uc2hpcERhdGEodHJ1ZSk7CiAgICAgIHRoaXMuc2V0UmVsYXRpb25zaGlwSXNFbXB0eShmYWxzZSk7CiAgICB9OwoKICAgIF9wcm90by5pbnZlcnNlRGlkRGVtYXRlcmlhbGl6ZSA9IGZ1bmN0aW9uIGludmVyc2VEaWREZW1hdGVyaWFsaXplKCkgewogICAgICBfUmVsYXRpb25zaGlwLnByb3RvdHlwZS5pbnZlcnNlRGlkRGVtYXRlcmlhbGl6ZS5jYWxsKHRoaXMsIHRoaXMuaW52ZXJzZVJlY29yZERhdGEpOwoKICAgICAgdGhpcy5ub3RpZnlCZWxvbmdzVG9DaGFuZ2UoKTsKICAgIH07CgogICAgX3Byb3RvLnJlbW92ZUNvbXBsZXRlbHlGcm9tT3duID0gZnVuY3Rpb24gcmVtb3ZlQ29tcGxldGVseUZyb21Pd24ocmVjb3JkRGF0YSkgewogICAgICBfUmVsYXRpb25zaGlwLnByb3RvdHlwZS5yZW1vdmVDb21wbGV0ZWx5RnJvbU93bi5jYWxsKHRoaXMsIHJlY29yZERhdGEpOwoKICAgICAgaWYgKHRoaXMuY2Fub25pY2FsU3RhdGUgPT09IHJlY29yZERhdGEpIHsKICAgICAgICB0aGlzLmNhbm9uaWNhbFN0YXRlID0gbnVsbDsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuaW52ZXJzZVJlY29yZERhdGEgPT09IHJlY29yZERhdGEpIHsKICAgICAgICB0aGlzLmludmVyc2VSZWNvcmREYXRhID0gbnVsbDsKICAgICAgICB0aGlzLm5vdGlmeUJlbG9uZ3NUb0NoYW5nZSgpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5yZW1vdmVDb21wbGV0ZWx5RnJvbUludmVyc2UgPSBmdW5jdGlvbiByZW1vdmVDb21wbGV0ZWx5RnJvbUludmVyc2UoKSB7CiAgICAgIF9SZWxhdGlvbnNoaXAucHJvdG90eXBlLnJlbW92ZUNvbXBsZXRlbHlGcm9tSW52ZXJzZS5jYWxsKHRoaXMpOwoKICAgICAgdGhpcy5pbnZlcnNlUmVjb3JkRGF0YSA9IG51bGw7CiAgICB9OwoKICAgIF9wcm90by5mbHVzaENhbm9uaWNhbCA9IGZ1bmN0aW9uIGZsdXNoQ2Fub25pY2FsKCkgewogICAgICAvL3RlbXBvcmFyeSBmaXggdG8gbm90IHJlbW92ZSBuZXdseSBjcmVhdGVkIHJlY29yZHMgaWYgc2VydmVyIHJldHVybmVkIG51bGwuCiAgICAgIC8vVE9ETyByZW1vdmUgb25jZSB3ZSBoYXZlIHByb3BlciBkaWZmaW5nCiAgICAgIGlmICh0aGlzLmludmVyc2VSZWNvcmREYXRhICYmIHRoaXMuaW52ZXJzZVJlY29yZERhdGEuaXNOZXcoKSAmJiAhdGhpcy5jYW5vbmljYWxTdGF0ZSkgewogICAgICAgIHRoaXMud2lsbFN5bmMgPSBmYWxzZTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmludmVyc2VSZWNvcmREYXRhICE9PSB0aGlzLmNhbm9uaWNhbFN0YXRlKSB7CiAgICAgICAgdGhpcy5pbnZlcnNlUmVjb3JkRGF0YSA9IHRoaXMuY2Fub25pY2FsU3RhdGU7CiAgICAgICAgdGhpcy5ub3RpZnlCZWxvbmdzVG9DaGFuZ2UoKTsKICAgICAgfQoKICAgICAgX1JlbGF0aW9uc2hpcC5wcm90b3R5cGUuZmx1c2hDYW5vbmljYWwuY2FsbCh0aGlzKTsKICAgIH07CgogICAgX3Byb3RvLmFkZFJlY29yZERhdGEgPSBmdW5jdGlvbiBhZGRSZWNvcmREYXRhKHJlY29yZERhdGEpIHsKICAgICAgaWYgKHRoaXMubWVtYmVycy5oYXMocmVjb3JkRGF0YSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gVE9ETyBJZ29yIGNsZWFudXAKCgogICAgICBpZiAodGhpcy5pbnZlcnNlUmVjb3JkRGF0YSkgewogICAgICAgIHRoaXMucmVtb3ZlUmVjb3JkRGF0YSh0aGlzLmludmVyc2VSZWNvcmREYXRhKTsKICAgICAgfQoKICAgICAgdGhpcy5pbnZlcnNlUmVjb3JkRGF0YSA9IHJlY29yZERhdGE7CgogICAgICBfUmVsYXRpb25zaGlwLnByb3RvdHlwZS5hZGRSZWNvcmREYXRhLmNhbGwodGhpcywgcmVjb3JkRGF0YSk7CgogICAgICB0aGlzLm5vdGlmeUJlbG9uZ3NUb0NoYW5nZSgpOwogICAgfTsKCiAgICBfcHJvdG8ucmVtb3ZlUmVjb3JkRGF0YUZyb21Pd24gPSBmdW5jdGlvbiByZW1vdmVSZWNvcmREYXRhRnJvbU93bihyZWNvcmREYXRhKSB7CiAgICAgIGlmICghdGhpcy5tZW1iZXJzLmhhcyhyZWNvcmREYXRhKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5pbnZlcnNlUmVjb3JkRGF0YSA9IG51bGw7CgogICAgICBfUmVsYXRpb25zaGlwLnByb3RvdHlwZS5yZW1vdmVSZWNvcmREYXRhRnJvbU93bi5jYWxsKHRoaXMsIHJlY29yZERhdGEpOwoKICAgICAgdGhpcy5ub3RpZnlCZWxvbmdzVG9DaGFuZ2UoKTsKICAgIH07CgogICAgX3Byb3RvLnJlbW92ZUFsbFJlY29yZERhdGFzRnJvbU93biA9IGZ1bmN0aW9uIHJlbW92ZUFsbFJlY29yZERhdGFzRnJvbU93bigpIHsKICAgICAgX1JlbGF0aW9uc2hpcC5wcm90b3R5cGUucmVtb3ZlQWxsUmVjb3JkRGF0YXNGcm9tT3duLmNhbGwodGhpcyk7CgogICAgICB0aGlzLmludmVyc2VSZWNvcmREYXRhID0gbnVsbDsKICAgICAgdGhpcy5ub3RpZnlCZWxvbmdzVG9DaGFuZ2UoKTsKICAgIH07CgogICAgX3Byb3RvLm5vdGlmeUJlbG9uZ3NUb0NoYW5nZSA9IGZ1bmN0aW9uIG5vdGlmeUJlbG9uZ3NUb0NoYW5nZSgpIHsKICAgICAgdmFyIHJlY29yZERhdGEgPSB0aGlzLnJlY29yZERhdGE7CiAgICAgIHZhciBzdG9yZVdyYXBwZXIgPSB0aGlzLnJlY29yZERhdGEuc3RvcmVXcmFwcGVyOwogICAgICBzdG9yZVdyYXBwZXIubm90aWZ5QmVsb25nc1RvQ2hhbmdlKHJlY29yZERhdGEubW9kZWxOYW1lLCByZWNvcmREYXRhLmlkLCByZWNvcmREYXRhLmNsaWVudElkLCB0aGlzLmtleSk7CiAgICB9OwoKICAgIF9wcm90by5yZW1vdmVDYW5vbmljYWxSZWNvcmREYXRhRnJvbU93biA9IGZ1bmN0aW9uIHJlbW92ZUNhbm9uaWNhbFJlY29yZERhdGFGcm9tT3duKHJlY29yZERhdGEpIHsKICAgICAgaWYgKCF0aGlzLmNhbm9uaWNhbE1lbWJlcnMuaGFzKHJlY29yZERhdGEpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLmNhbm9uaWNhbFN0YXRlID0gbnVsbDsKICAgICAgdGhpcy5zZXRIYXNBbnlSZWxhdGlvbnNoaXBEYXRhKHRydWUpOwogICAgICB0aGlzLnNldFJlbGF0aW9uc2hpcElzRW1wdHkodHJ1ZSk7CgogICAgICBfUmVsYXRpb25zaGlwLnByb3RvdHlwZS5yZW1vdmVDYW5vbmljYWxSZWNvcmREYXRhRnJvbU93bi5jYWxsKHRoaXMsIHJlY29yZERhdGEpOwogICAgfTsKCiAgICBfcHJvdG8ucmVtb3ZlQWxsQ2Fub25pY2FsUmVjb3JkRGF0YXNGcm9tT3duID0gZnVuY3Rpb24gcmVtb3ZlQWxsQ2Fub25pY2FsUmVjb3JkRGF0YXNGcm9tT3duKCkgewogICAgICBfUmVsYXRpb25zaGlwLnByb3RvdHlwZS5yZW1vdmVBbGxDYW5vbmljYWxSZWNvcmREYXRhc0Zyb21Pd24uY2FsbCh0aGlzKTsKCiAgICAgIHRoaXMuY2Fub25pY2FsU3RhdGUgPSBudWxsOwogICAgfTsKCiAgICBfcHJvdG8uZ2V0RGF0YSA9IGZ1bmN0aW9uIGdldERhdGEoKSB7CiAgICAgIHZhciBkYXRhOwogICAgICB2YXIgcGF5bG9hZCA9IHt9OwoKICAgICAgaWYgKHRoaXMuaW52ZXJzZVJlY29yZERhdGEpIHsKICAgICAgICBkYXRhID0gdGhpcy5pbnZlcnNlUmVjb3JkRGF0YS5nZXRSZXNvdXJjZUlkZW50aWZpZXIoKTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuaW52ZXJzZVJlY29yZERhdGEgPT09IG51bGwgJiYgdGhpcy5oYXNBbnlSZWxhdGlvbnNoaXBEYXRhKSB7CiAgICAgICAgZGF0YSA9IG51bGw7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmxpbmtzKSB7CiAgICAgICAgcGF5bG9hZC5saW5rcyA9IHRoaXMubGlua3M7CiAgICAgIH0KCiAgICAgIGlmIChkYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBwYXlsb2FkLmRhdGEgPSBkYXRhOwogICAgICB9CgogICAgICBpZiAodGhpcy5tZXRhKSB7CiAgICAgICAgcGF5bG9hZC5tZXRhID0gdGhpcy5tZXRhOwogICAgICB9CgogICAgICBwYXlsb2FkLl9yZWxhdGlvbnNoaXAgPSB0aGlzOwogICAgICByZXR1cm4gcGF5bG9hZDsKICAgIH0KICAgIC8qKgogICAgICogRmxhZyBpbmRpY2F0aW5nIHdoZXRoZXIgYWxsIGludmVyc2UgcmVjb3JkcyBhcmUgYXZhaWxhYmxlCiAgICAgKgogICAgICogdHJ1ZSBpZiB0aGUgaW52ZXJzZSBleGlzdHMgYW5kIGlzIGxvYWRlZCAobm90IGVtcHR5KQogICAgICogdHJ1ZSBpZiB0aGVyZSBpcyBubyBpbnZlcnNlCiAgICAgKiBmYWxzZSBpZiB0aGUgaW52ZXJzZSBleGlzdHMgYW5kIGlzIG5vdCBsb2FkZWQgKGVtcHR5KQogICAgICoKICAgICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8udXBkYXRlRGF0YSA9IGZ1bmN0aW9uIHVwZGF0ZURhdGEoZGF0YSwgaW5pdGlhbCkgewogICAgICB2YXIgcmVjb3JkRGF0YTsKCiAgICAgIGlmIChFbWJlci5pc05vbmUoZGF0YSkpIHsKICAgICAgICByZWNvcmREYXRhID0gbnVsbDsKICAgICAgfQoKICAgICAgaWYgKHJlY29yZERhdGEgIT09IG51bGwpIHsKICAgICAgICByZWNvcmREYXRhID0gdGhpcy5yZWNvcmREYXRhLnN0b3JlV3JhcHBlci5yZWNvcmREYXRhRm9yKGRhdGEudHlwZSwgZGF0YS5pZCk7CiAgICAgIH0KCiAgICAgIGlmIChpbml0aWFsKSB7CiAgICAgICAgdGhpcy5zZXRJbml0aWFsQ2Fub25pY2FsUmVjb3JkRGF0YShyZWNvcmREYXRhKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnNldENhbm9uaWNhbFJlY29yZERhdGEocmVjb3JkRGF0YSk7CiAgICAgIH0KICAgIH07CgogICAgX2NyZWF0ZUNsYXNzJDIoQmVsb25nc1RvUmVsYXRpb25zaGlwLCBbewogICAgICBrZXk6ICJhbGxJbnZlcnNlUmVjb3Jkc0FyZUxvYWRlZCIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHZhciByZWNvcmREYXRhID0gdGhpcy5pbnZlcnNlUmVjb3JkRGF0YTsKICAgICAgICB2YXIgaXNFbXB0eSA9IHJlY29yZERhdGEgIT09IG51bGwgJiYgcmVjb3JkRGF0YS5pc0VtcHR5KCk7CiAgICAgICAgcmV0dXJuICFpc0VtcHR5OwogICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIEJlbG9uZ3NUb1JlbGF0aW9uc2hpcDsKICB9KFJlbGF0aW9uc2hpcCk7CgogIGZ1bmN0aW9uIGNyZWF0ZVJlbGF0aW9uc2hpcEZvcihyZWxhdGlvbnNoaXBNZXRhLCBzdG9yZSwgcmVjb3JkRGF0YSwga2V5KSB7CiAgICB2YXIgaW52ZXJzZUtleSA9IHJlY29yZERhdGEuc3RvcmVXcmFwcGVyLmludmVyc2VGb3JSZWxhdGlvbnNoaXAocmVjb3JkRGF0YS5tb2RlbE5hbWUsIGtleSk7CiAgICB2YXIgaW52ZXJzZUlzQXN5bmMgPSByZWNvcmREYXRhLnN0b3JlV3JhcHBlci5pbnZlcnNlSXNBc3luY0ZvclJlbGF0aW9uc2hpcChyZWNvcmREYXRhLm1vZGVsTmFtZSwga2V5KTsKCiAgICBpZiAocmVsYXRpb25zaGlwTWV0YS5raW5kID09PSAnaGFzTWFueScpIHsKICAgICAgcmV0dXJuIG5ldyBNYW55UmVsYXRpb25zaGlwKHN0b3JlLCBpbnZlcnNlS2V5LCByZWxhdGlvbnNoaXBNZXRhLCByZWNvcmREYXRhLCBpbnZlcnNlSXNBc3luYyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmV3IEJlbG9uZ3NUb1JlbGF0aW9uc2hpcChzdG9yZSwgaW52ZXJzZUtleSwgcmVsYXRpb25zaGlwTWV0YSwgcmVjb3JkRGF0YSwgaW52ZXJzZUlzQXN5bmMpOwogICAgfQogIH0KCiAgdmFyIFJlbGF0aW9uc2hpcHMgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBSZWxhdGlvbnNoaXBzKHJlY29yZERhdGEpIHsKICAgICAgdGhpcy5yZWNvcmREYXRhID0gcmVjb3JkRGF0YTsKICAgICAgdGhpcy5fc3RvcmUgPSB2b2lkIDA7CiAgICAgIHRoaXMuX3N0b3JlV3JhcHBlciA9IHZvaWQgMDsKICAgICAgdGhpcy5pbml0aWFsaXplZFJlbGF0aW9uc2hpcHMgPSB2b2lkIDA7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZWRSZWxhdGlvbnNoaXBzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgdGhpcy5fc3RvcmVXcmFwcGVyID0gUHJpdmF0ZS51cGdyYWRlRm9ySW50ZXJuYWwocmVjb3JkRGF0YS5zdG9yZVdyYXBwZXIpOwogICAgICB0aGlzLl9zdG9yZSA9IHRoaXMuX3N0b3JlV3JhcHBlci5fc3RvcmU7CiAgICB9CgogICAgdmFyIF9wcm90byA9IFJlbGF0aW9uc2hpcHMucHJvdG90eXBlOwoKICAgIF9wcm90by5oYXMgPSBmdW5jdGlvbiBoYXMoa2V5KSB7CiAgICAgIHJldHVybiAhIXRoaXMuaW5pdGlhbGl6ZWRSZWxhdGlvbnNoaXBzW2tleV07CiAgICB9OwoKICAgIF9wcm90by5mb3JFYWNoID0gZnVuY3Rpb24gZm9yRWFjaChjYikgewogICAgICB2YXIgcmVscyA9IHRoaXMuaW5pdGlhbGl6ZWRSZWxhdGlvbnNoaXBzOwogICAgICBPYmplY3Qua2V5cyhyZWxzKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgY2IobmFtZSwgcmVsc1tuYW1lXSk7CiAgICAgIH0pOwogICAgfTsKCiAgICBfcHJvdG8uZ2V0ID0gZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICB2YXIgcmVsYXRpb25zaGlwcyA9IHRoaXMuaW5pdGlhbGl6ZWRSZWxhdGlvbnNoaXBzOwogICAgICB2YXIgcmVsYXRpb25zaGlwID0gcmVsYXRpb25zaGlwc1trZXldOwoKICAgICAgaWYgKCFyZWxhdGlvbnNoaXApIHsKICAgICAgICB2YXIgX3JlY29yZERhdGEgPSB0aGlzLnJlY29yZERhdGE7CiAgICAgICAgdmFyIHJlbCA9IHRoaXMucmVjb3JkRGF0YS5zdG9yZVdyYXBwZXIucmVsYXRpb25zaGlwc0RlZmluaXRpb25Gb3IodGhpcy5yZWNvcmREYXRhLm1vZGVsTmFtZSlba2V5XTsKCiAgICAgICAgaWYgKHJlbCkgewogICAgICAgICAgcmVsYXRpb25zaGlwID0gcmVsYXRpb25zaGlwc1trZXldID0gY3JlYXRlUmVsYXRpb25zaGlwRm9yKHJlbCwgdGhpcy5fc3RvcmUsIF9yZWNvcmREYXRhLCBrZXkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHJlbGF0aW9uc2hpcDsKICAgIH07CgogICAgcmV0dXJuIFJlbGF0aW9uc2hpcHM7CiAgfSgpOwoKICAvLyBVc2VkIGJ5IHRoZSBzdG9yZSB0byBub3JtYWxpemUgSURzIGVudGVyaW5nIHRoZSBzdG9yZS4gIERlc3BpdGUgdGhlIGZhY3QKICAvLyB0aGF0IGRldmVsb3BlcnMgbWF5IHByb3ZpZGUgSURzIGFzIG51bWJlcnMgKGUuZy4sIGBzdG9yZS5maW5kUmVjb3JkKCdwZXJzb24nLCAxKWApLAogIC8vIGl0IGlzIGltcG9ydGFudCB0aGF0IGludGVybmFsbHkgd2UgdXNlIHN0cmluZ3MsIHNpbmNlIElEcyBtYXkgYmUgc2VyaWFsaXplZAogIC8vIGFuZCBsb3NlIHR5cGUgaW5mb3JtYXRpb24uICBGb3IgZXhhbXBsZSwgRW1iZXIncyByb3V0ZXIgbWF5IHB1dCBhIHJlY29yZCdzCiAgLy8gSUQgaW50byB0aGUgVVJMLCBhbmQgaWYgd2UgbGF0ZXIgdHJ5IHRvIGRlc2VyaWFsaXplIHRoYXQgVVJMIGFuZCBmaW5kIHRoZQogIC8vIGNvcnJlc3BvbmRpbmcgcmVjb3JkLCB3ZSB3aWxsIG5vdCBrbm93IGlmIGl0IGlzIGEgc3RyaW5nIG9yIGEgbnVtYmVyLgogIGZ1bmN0aW9uIGNvZXJjZUlkKGlkKSB7CiAgICBpZiAoaWQgPT09IG51bGwgfHwgaWQgPT09IHVuZGVmaW5lZCB8fCBpZCA9PT0gJycpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgaWYgKHR5cGVvZiBpZCA9PT0gJ3N0cmluZycpIHsKICAgICAgcmV0dXJuIGlkOwogICAgfQoKICAgIGlmICh0eXBlb2YgaWQgPT09ICdzeW1ib2wnKSB7CiAgICAgIHJldHVybiBpZC50b1N0cmluZygpOwogICAgfQoKICAgIHJldHVybiAnJyArIGlkOwogIH0KCiAgZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXMkMyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKICBmdW5jdGlvbiBfY3JlYXRlQ2xhc3MkMyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzJDMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyQzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQogIHZhciBuZXh0QmZzSWQgPSAxOwoKICB2YXIgUmVjb3JkRGF0YURlZmF1bHQgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBSZWNvcmREYXRhRGVmYXVsdChhcmcxLCBhcmcyKSB7CiAgICAgIHRoaXMuX2Vycm9ycyA9IHZvaWQgMDsKICAgICAgdGhpcy5fX3JlbGF0aW9uc2hpcHMgPSB2b2lkIDA7CiAgICAgIHRoaXMuX19pbXBsaWNpdFJlbGF0aW9uc2hpcHMgPSB2b2lkIDA7CiAgICAgIHRoaXMubW9kZWxOYW1lID0gdm9pZCAwOwogICAgICB0aGlzLmNsaWVudElkID0gdm9pZCAwOwogICAgICB0aGlzLmlkID0gdm9pZCAwOwogICAgICB0aGlzLmlzRGVzdHJveWVkID0gdm9pZCAwOwogICAgICB0aGlzLl9pc05ldyA9IHZvaWQgMDsKICAgICAgdGhpcy5fYmZzSWQgPSB2b2lkIDA7CiAgICAgIHRoaXMuX19hdHRyaWJ1dGVzID0gdm9pZCAwOwogICAgICB0aGlzLl9faW5GbGlnaHRBdHRyaWJ1dGVzID0gdm9pZCAwOwogICAgICB0aGlzLl9fZGF0YSA9IHZvaWQgMDsKICAgICAgdGhpcy5fc2NoZWR1bGVkRGVzdHJveSA9IHZvaWQgMDsKICAgICAgdGhpcy5faXNEZWxldGVkID0gdm9pZCAwOwogICAgICB0aGlzLl9pc0RlbGV0aW9uQ29tbWl0ZWQgPSB2b2lkIDA7CiAgICAgIHRoaXMuaWRlbnRpZmllciA9IHZvaWQgMDsKICAgICAgdGhpcy5zdG9yZVdyYXBwZXIgPSB2b2lkIDA7CgogICAgICB7CiAgICAgICAgdmFyIF9pZGVudGlmaWVyID0gYXJndW1lbnRzWzBdLAogICAgICAgICAgICBfc3RvcmVXcmFwcGVyID0gYXJndW1lbnRzWzFdOwogICAgICAgIHRoaXMuaWRlbnRpZmllciA9IF9pZGVudGlmaWVyOwogICAgICAgIHRoaXMubW9kZWxOYW1lID0gX2lkZW50aWZpZXIudHlwZTsKICAgICAgICB0aGlzLmNsaWVudElkID0gX2lkZW50aWZpZXIubGlkOwogICAgICAgIHRoaXMuaWQgPSBfaWRlbnRpZmllci5pZDsKICAgICAgICB0aGlzLnN0b3JlV3JhcHBlciA9IF9zdG9yZVdyYXBwZXI7CiAgICAgIH0KCiAgICAgIHRoaXMuX19yZWxhdGlvbnNoaXBzID0gbnVsbDsKICAgICAgdGhpcy5fX2ltcGxpY2l0UmVsYXRpb25zaGlwcyA9IG51bGw7CiAgICAgIHRoaXMuaXNEZXN0cm95ZWQgPSBmYWxzZTsKICAgICAgdGhpcy5faXNOZXcgPSBmYWxzZTsKICAgICAgdGhpcy5faXNEZWxldGVkID0gZmFsc2U7IC8vIFVzZWQgZHVyaW5nIHRoZSBtYXJrIHBoYXNlIG9mIHVubG9hZGluZyB0byBhdm9pZCBjaGVja2luZyB0aGUgc2FtZSBpbnRlcm5hbAogICAgICAvLyBtb2RlbCB0d2ljZSBpbiB0aGUgc2FtZSBzY2FuCgogICAgICB0aGlzLl9iZnNJZCA9IDA7CiAgICAgIHRoaXMucmVzZXQoKTsKICAgIH0gLy8gUFVCTElDIEFQSQoKCiAgICB2YXIgX3Byb3RvID0gUmVjb3JkRGF0YURlZmF1bHQucHJvdG90eXBlOwoKICAgIF9wcm90by5nZXRSZXNvdXJjZUlkZW50aWZpZXIgPSBmdW5jdGlvbiBnZXRSZXNvdXJjZUlkZW50aWZpZXIoKSB7CiAgICAgIHJldHVybiAgdGhpcy5pZGVudGlmaWVyIDsKICAgIH07CgogICAgX3Byb3RvLnB1c2hEYXRhID0gZnVuY3Rpb24gcHVzaERhdGEoZGF0YSwgY2FsY3VsYXRlQ2hhbmdlKSB7CiAgICAgIHZhciBjaGFuZ2VkS2V5czsKCiAgICAgIGlmICh0aGlzLl9pc05ldykgewogICAgICAgIHRoaXMuX2lzTmV3ID0gZmFsc2U7CiAgICAgICAgdGhpcy5ub3RpZnlTdGF0ZUNoYW5nZSgpOwogICAgICB9CgogICAgICBpZiAoY2FsY3VsYXRlQ2hhbmdlKSB7CiAgICAgICAgY2hhbmdlZEtleXMgPSB0aGlzLl9jaGFuZ2VkS2V5cyhkYXRhLmF0dHJpYnV0ZXMpOwogICAgICB9CgogICAgICBFbWJlci5hc3NpZ24odGhpcy5fZGF0YSwgZGF0YS5hdHRyaWJ1dGVzKTsKCiAgICAgIGlmICh0aGlzLl9fYXR0cmlidXRlcykgewogICAgICAgIC8vIG9ubHkgZG8gaWYgd2UgaGF2ZSBhdHRyaWJ1dGUgY2hhbmdlcwogICAgICAgIHRoaXMuX3VwZGF0ZUNoYW5nZWRBdHRyaWJ1dGVzKCk7CiAgICAgIH0KCiAgICAgIGlmIChkYXRhLnJlbGF0aW9uc2hpcHMpIHsKICAgICAgICB0aGlzLl9zZXR1cFJlbGF0aW9uc2hpcHMoZGF0YSk7CiAgICAgIH0KCiAgICAgIGlmIChkYXRhLmlkKSB7CiAgICAgICAgdGhpcy5pZCA9IGNvZXJjZUlkKGRhdGEuaWQpOwogICAgICB9CgogICAgICByZXR1cm4gY2hhbmdlZEtleXM7CiAgICB9OwoKICAgIF9wcm90by53aWxsQ29tbWl0ID0gZnVuY3Rpb24gd2lsbENvbW1pdCgpIHsKICAgICAgdGhpcy5faW5GbGlnaHRBdHRyaWJ1dGVzID0gdGhpcy5fYXR0cmlidXRlczsKICAgICAgdGhpcy5fYXR0cmlidXRlcyA9IG51bGw7CiAgICB9OwoKICAgIF9wcm90by5oYXNDaGFuZ2VkQXR0cmlidXRlcyA9IGZ1bmN0aW9uIGhhc0NoYW5nZWRBdHRyaWJ1dGVzKCkgewogICAgICByZXR1cm4gdGhpcy5fX2F0dHJpYnV0ZXMgIT09IG51bGwgJiYgT2JqZWN0LmtleXModGhpcy5fX2F0dHJpYnV0ZXMpLmxlbmd0aCA+IDA7CiAgICB9OwoKICAgIF9wcm90by5fY2xlYXJFcnJvcnMgPSBmdW5jdGlvbiBfY2xlYXJFcnJvcnMoKSB7CiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5SRUNPUkRfREFUQV9FUlJPUlMpIHsKICAgICAgICBpZiAodGhpcy5fZXJyb3JzKSB7CiAgICAgICAgICB0aGlzLl9lcnJvcnMgPSB1bmRlZmluZWQ7CiAgICAgICAgICB0aGlzLnN0b3JlV3JhcHBlci5ub3RpZnlFcnJvcnNDaGFuZ2UodGhpcy5tb2RlbE5hbWUsIHRoaXMuaWQsIHRoaXMuY2xpZW50SWQpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uZ2V0RXJyb3JzID0gZnVuY3Rpb24gZ2V0RXJyb3JzKCkgewoKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFQ09SRF9EQVRBX0VSUk9SUykgewogICAgICAgIHZhciBlcnJvcnMgPSB0aGlzLl9lcnJvcnMgfHwgW107CiAgICAgICAgcmV0dXJuIGVycm9yczsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgIH0gLy8gdGhpcyBpcyBhIGhhY2sgYmMgd2UgZG9uJ3QgaGF2ZSBhY2Nlc3MgdG8gdGhlIHN0YXRlIG1hY2hpbmUKICAgIC8vICAgYW5kIHJlbGF0aW9uc2hpcHMgbmVlZCB0aGlzIGluZm8gYW5kIEBydW5zcGlyZWQgZGlkbid0IHNlZQogICAgLy8gICBob3cgdG8gZ2V0IGl0IGp1c3QgeWV0IGZyb20gc3RvcmVXcmFwcGVyLgogICAgOwoKICAgIF9wcm90by5pc0VtcHR5ID0gZnVuY3Rpb24gaXNFbXB0eSgpIHsKICAgICAgcmV0dXJuIHRoaXMuX19hdHRyaWJ1dGVzID09PSBudWxsICYmIHRoaXMuX19pbkZsaWdodEF0dHJpYnV0ZXMgPT09IG51bGwgJiYgdGhpcy5fX2RhdGEgPT09IG51bGw7CiAgICB9OwoKICAgIF9wcm90by5kZWxldGVSZWNvcmQgPSBmdW5jdGlvbiBkZWxldGVSZWNvcmQoKSB7CiAgICAgIHRoaXMuX2lzRGVsZXRlZCA9IHRydWU7CiAgICAgIHRoaXMubm90aWZ5U3RhdGVDaGFuZ2UoKTsKICAgIH07CgogICAgX3Byb3RvLmlzRGVsZXRlZCA9IGZ1bmN0aW9uIGlzRGVsZXRlZCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2lzRGVsZXRlZDsKICAgIH07CgogICAgX3Byb3RvLnNldElzRGVsZXRlZCA9IGZ1bmN0aW9uIHNldElzRGVsZXRlZChpc0RlbGV0ZWQpIHsKICAgICAgdGhpcy5faXNEZWxldGVkID0gaXNEZWxldGVkOwoKICAgICAgaWYgKHRoaXMuX2lzTmV3KSB7CiAgICAgICAgdGhpcy5fZGVsZXRpb25Db25maXJtZWQoKTsKICAgICAgfQoKICAgICAgdGhpcy5ub3RpZnlTdGF0ZUNoYW5nZSgpOwogICAgfTsKCiAgICBfcHJvdG8uaXNEZWxldGlvbkNvbW1pdHRlZCA9IGZ1bmN0aW9uIGlzRGVsZXRpb25Db21taXR0ZWQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9pc0RlbGV0aW9uQ29tbWl0ZWQ7CiAgICB9OwoKICAgIF9wcm90by5yZXNldCA9IGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICB0aGlzLl9fYXR0cmlidXRlcyA9IG51bGw7CiAgICAgIHRoaXMuX19pbkZsaWdodEF0dHJpYnV0ZXMgPSBudWxsOwogICAgICB0aGlzLl9fZGF0YSA9IG51bGw7CiAgICAgIHRoaXMuX2Vycm9ycyA9IHVuZGVmaW5lZDsKICAgIH07CgogICAgX3Byb3RvLl9zZXR1cFJlbGF0aW9uc2hpcHMgPSBmdW5jdGlvbiBfc2V0dXBSZWxhdGlvbnNoaXBzKGRhdGEpIHsKICAgICAgdmFyIHJlbGF0aW9uc2hpcHMgPSB0aGlzLnN0b3JlV3JhcHBlci5yZWxhdGlvbnNoaXBzRGVmaW5pdGlvbkZvcih0aGlzLm1vZGVsTmFtZSk7CiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMocmVsYXRpb25zaGlwcyk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgcmVsYXRpb25zaGlwTmFtZSA9IGtleXNbaV07CgogICAgICAgIGlmICghZGF0YS5yZWxhdGlvbnNoaXBzW3JlbGF0aW9uc2hpcE5hbWVdKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9IC8vIGluIGRlYnVnLCBhc3NlcnQgcGF5bG9hZCB2YWxpZGl0eSBlYWdlcmx5CgoKICAgICAgICB2YXIgcmVsYXRpb25zaGlwRGF0YSA9IGRhdGEucmVsYXRpb25zaGlwc1tyZWxhdGlvbnNoaXBOYW1lXTsKCiAgICAgICAgdmFyIHJlbGF0aW9uc2hpcCA9IHRoaXMuX3JlbGF0aW9uc2hpcHMuZ2V0KHJlbGF0aW9uc2hpcE5hbWUpOwoKICAgICAgICByZWxhdGlvbnNoaXAucHVzaChyZWxhdGlvbnNoaXBEYXRhKTsKICAgICAgfQogICAgfQogICAgLyoKICAgICAgQ2hlY2tzIGlmIHRoZSBhdHRyaWJ1dGVzIHdoaWNoIGFyZSBjb25zaWRlcmVkIGFzIGNoYW5nZWQgYXJlIHN0aWxsCiAgICAgIGRpZmZlcmVudCB0byB0aGUgc3RhdGUgd2hpY2ggaXMgYWNrbm93bGVkZ2VkIGJ5IHRoZSBzZXJ2ZXIuCiAgICAgICBUaGlzIG1ldGhvZCBpcyBuZWVkZWQgd2hlbiBkYXRhIGZvciB0aGUgaW50ZXJuYWwgbW9kZWwgaXMgcHVzaGVkIGFuZCB0aGUKICAgICAgcHVzaGVkIGRhdGEgbWlnaHQgYWNrbm93bGVkZ2UgZGlydHkgYXR0cmlidXRlcyBhcyBjb25maXJtZWQuCiAgICAgICBAbWV0aG9kIHVwZGF0ZUNoYW5nZWRBdHRyaWJ1dGVzCiAgICAgIEBwcml2YXRlCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8uX3VwZGF0ZUNoYW5nZWRBdHRyaWJ1dGVzID0gZnVuY3Rpb24gX3VwZGF0ZUNoYW5nZWRBdHRyaWJ1dGVzKCkgewogICAgICB2YXIgY2hhbmdlZEF0dHJpYnV0ZXMgPSB0aGlzLmNoYW5nZWRBdHRyaWJ1dGVzKCk7CiAgICAgIHZhciBjaGFuZ2VkQXR0cmlidXRlTmFtZXMgPSBPYmplY3Qua2V5cyhjaGFuZ2VkQXR0cmlidXRlcyk7CiAgICAgIHZhciBhdHRycyA9IHRoaXMuX2F0dHJpYnV0ZXM7CgogICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gY2hhbmdlZEF0dHJpYnV0ZU5hbWVzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGF0dHJpYnV0ZSA9IGNoYW5nZWRBdHRyaWJ1dGVOYW1lc1tpXTsKICAgICAgICB2YXIgZGF0YSA9IGNoYW5nZWRBdHRyaWJ1dGVzW2F0dHJpYnV0ZV07CiAgICAgICAgdmFyIG9sZERhdGEgPSBkYXRhWzBdOwogICAgICAgIHZhciBuZXdEYXRhID0gZGF0YVsxXTsKCiAgICAgICAgaWYgKG9sZERhdGEgPT09IG5ld0RhdGEpIHsKICAgICAgICAgIGRlbGV0ZSBhdHRyc1thdHRyaWJ1dGVdOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoKICAgICAgUmV0dXJucyBhbiBvYmplY3QsIHdob3NlIGtleXMgYXJlIGNoYW5nZWQgcHJvcGVydGllcywgYW5kIHZhbHVlIGlzIGFuCiAgICAgIFtvbGRQcm9wLCBuZXdQcm9wXSBhcnJheS4KICAgICAgIEBtZXRob2QgY2hhbmdlZEF0dHJpYnV0ZXMKICAgICAgQHByaXZhdGUKICAgICovCiAgICA7CgogICAgX3Byb3RvLmNoYW5nZWRBdHRyaWJ1dGVzID0gZnVuY3Rpb24gY2hhbmdlZEF0dHJpYnV0ZXMoKSB7CiAgICAgIHZhciBvbGREYXRhID0gdGhpcy5fZGF0YTsKICAgICAgdmFyIGN1cnJlbnREYXRhID0gdGhpcy5fYXR0cmlidXRlczsKICAgICAgdmFyIGluRmxpZ2h0RGF0YSA9IHRoaXMuX2luRmxpZ2h0QXR0cmlidXRlczsKICAgICAgdmFyIG5ld0RhdGEgPSBFbWJlci5hc3NpZ24oe30sIGluRmxpZ2h0RGF0YSwgY3VycmVudERhdGEpOwogICAgICB2YXIgZGlmZkRhdGEgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB2YXIgbmV3RGF0YUtleXMgPSBPYmplY3Qua2V5cyhuZXdEYXRhKTsKCiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBuZXdEYXRhS2V5cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHZhciBfa2V5ID0gbmV3RGF0YUtleXNbaV07CiAgICAgICAgZGlmZkRhdGFbX2tleV0gPSBbb2xkRGF0YVtfa2V5XSwgbmV3RGF0YVtfa2V5XV07CiAgICAgIH0KCiAgICAgIHJldHVybiBkaWZmRGF0YTsKICAgIH07CgogICAgX3Byb3RvLmlzTmV3ID0gZnVuY3Rpb24gaXNOZXcoKSB7CiAgICAgIHJldHVybiB0aGlzLl9pc05ldzsKICAgIH07CgogICAgX3Byb3RvLnJvbGxiYWNrQXR0cmlidXRlcyA9IGZ1bmN0aW9uIHJvbGxiYWNrQXR0cmlidXRlcygpIHsKICAgICAgdmFyIGRpcnR5S2V5czsKICAgICAgdGhpcy5faXNEZWxldGVkID0gZmFsc2U7CgogICAgICBpZiAodGhpcy5oYXNDaGFuZ2VkQXR0cmlidXRlcygpKSB7CiAgICAgICAgZGlydHlLZXlzID0gT2JqZWN0LmtleXModGhpcy5fYXR0cmlidXRlcyk7CiAgICAgICAgdGhpcy5fYXR0cmlidXRlcyA9IG51bGw7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHsKICAgICAgICB0aGlzLnJlbW92ZUZyb21JbnZlcnNlUmVsYXRpb25zaGlwcyh0cnVlKTsKICAgICAgICB0aGlzLl9pc0RlbGV0ZWQgPSB0cnVlOwogICAgICAgIHRoaXMuX2lzTmV3ID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIHRoaXMuX2luRmxpZ2h0QXR0cmlidXRlcyA9IG51bGw7CgogICAgICB0aGlzLl9jbGVhckVycm9ycygpOwoKICAgICAgdGhpcy5ub3RpZnlTdGF0ZUNoYW5nZSgpOwogICAgICByZXR1cm4gZGlydHlLZXlzOwogICAgfTsKCiAgICBfcHJvdG8uX2RlbGV0aW9uQ29uZmlybWVkID0gZnVuY3Rpb24gX2RlbGV0aW9uQ29uZmlybWVkKCkgewogICAgICB0aGlzLnJlbW92ZUZyb21JbnZlcnNlUmVsYXRpb25zaGlwcygpOwogICAgfTsKCiAgICBfcHJvdG8uZGlkQ29tbWl0ID0gZnVuY3Rpb24gZGlkQ29tbWl0KGRhdGEpIHsKICAgICAgaWYgKHRoaXMuX2lzRGVsZXRlZCkgewogICAgICAgIHRoaXMuX2RlbGV0aW9uQ29uZmlybWVkKCk7CgogICAgICAgIHRoaXMuX2lzRGVsZXRpb25Db21taXRlZCA9IHRydWU7CiAgICAgIH0KCiAgICAgIHRoaXMuX2lzTmV3ID0gZmFsc2U7CiAgICAgIHZhciBuZXdDYW5vbmljYWxBdHRyaWJ1dGVzID0gbnVsbDsKCiAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgLy8gdGhpcy5zdG9yZS5faW50ZXJuYWxNb2RlbERpZFJlY2VpdmVSZWxhdGlvbnNoaXBEYXRhKHRoaXMubW9kZWxOYW1lLCB0aGlzLmlkLCBkYXRhLnJlbGF0aW9uc2hpcHMpOwogICAgICAgIGlmIChkYXRhLnJlbGF0aW9uc2hpcHMpIHsKICAgICAgICAgIHRoaXMuX3NldHVwUmVsYXRpb25zaGlwcyhkYXRhKTsKICAgICAgICB9CgogICAgICAgIGlmIChkYXRhLmlkKSB7CiAgICAgICAgICAvLyBkaWRDb21taXQgcHJvdmlkZWQgYW4gSUQsIG5vdGlmeSB0aGUgc3RvcmUgb2YgaXQKICAgICAgICAgIHRoaXMuc3RvcmVXcmFwcGVyLnNldFJlY29yZElkKHRoaXMubW9kZWxOYW1lLCBkYXRhLmlkLCB0aGlzLmNsaWVudElkKTsKICAgICAgICAgIHRoaXMuaWQgPSBjb2VyY2VJZChkYXRhLmlkKTsKICAgICAgICB9CgogICAgICAgIG5ld0Nhbm9uaWNhbEF0dHJpYnV0ZXMgPSBkYXRhLmF0dHJpYnV0ZXMgfHwgbnVsbDsKICAgICAgfQoKICAgICAgdmFyIGNoYW5nZWRLZXlzID0gdGhpcy5fY2hhbmdlZEtleXMobmV3Q2Fub25pY2FsQXR0cmlidXRlcyk7CgogICAgICBFbWJlci5hc3NpZ24odGhpcy5fZGF0YSwgdGhpcy5fX2luRmxpZ2h0QXR0cmlidXRlcywgbmV3Q2Fub25pY2FsQXR0cmlidXRlcyk7CiAgICAgIHRoaXMuX2luRmxpZ2h0QXR0cmlidXRlcyA9IG51bGw7CgogICAgICB0aGlzLl91cGRhdGVDaGFuZ2VkQXR0cmlidXRlcygpOwoKICAgICAgdGhpcy5fY2xlYXJFcnJvcnMoKTsKCiAgICAgIHRoaXMubm90aWZ5U3RhdGVDaGFuZ2UoKTsKICAgICAgcmV0dXJuIGNoYW5nZWRLZXlzOwogICAgfTsKCiAgICBfcHJvdG8ubm90aWZ5U3RhdGVDaGFuZ2UgPSBmdW5jdGlvbiBub3RpZnlTdGF0ZUNoYW5nZSgpIHsKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFQ09SRF9EQVRBX1NUQVRFKSB7CiAgICAgICAgdGhpcy5zdG9yZVdyYXBwZXIubm90aWZ5U3RhdGVDaGFuZ2UodGhpcy5tb2RlbE5hbWUsIHRoaXMuaWQsIHRoaXMuY2xpZW50SWQpOwogICAgICB9CiAgICB9IC8vIGdldCBSZXNvdXJjZUlkZW50aWZpZXJzIGZvciAiY3VycmVudCBzdGF0ZSIKICAgIDsKCiAgICBfcHJvdG8uZ2V0SGFzTWFueSA9IGZ1bmN0aW9uIGdldEhhc01hbnkoa2V5KSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWxhdGlvbnNoaXBzLmdldChrZXkpLmdldERhdGEoKTsKICAgIH0gLy8gc2V0IGEgbmV3ICJjdXJyZW50IHN0YXRlIiB2aWEgUmVzb3VyY2VJZGVudGlmaWVycwogICAgOwoKICAgIF9wcm90by5zZXREaXJ0eUhhc01hbnkgPSBmdW5jdGlvbiBzZXREaXJ0eUhhc01hbnkoa2V5LCByZWNvcmREYXRhcykgewogICAgICB2YXIgcmVsYXRpb25zaGlwID0gdGhpcy5fcmVsYXRpb25zaGlwcy5nZXQoa2V5KTsKCiAgICAgIHJlbGF0aW9uc2hpcC5jbGVhcigpOwogICAgICByZWxhdGlvbnNoaXAuYWRkUmVjb3JkRGF0YXMocmVjb3JkRGF0YXMpOwogICAgfSAvLyBhcHBlbmQgdG8gImN1cnJlbnQgc3RhdGUiIHZpYSBSZWNvcmREYXRhcwogICAgOwoKICAgIF9wcm90by5hZGRUb0hhc01hbnkgPSBmdW5jdGlvbiBhZGRUb0hhc01hbnkoa2V5LCByZWNvcmREYXRhcywgaWR4KSB7CiAgICAgIHRoaXMuX3JlbGF0aW9uc2hpcHMuZ2V0KGtleSkuYWRkUmVjb3JkRGF0YXMocmVjb3JkRGF0YXMsIGlkeCk7CiAgICB9IC8vIHJlbW92ZSBmcm9tICJjdXJyZW50IHN0YXRlIiB2aWEgUmVjb3JkRGF0YXMKICAgIDsKCiAgICBfcHJvdG8ucmVtb3ZlRnJvbUhhc01hbnkgPSBmdW5jdGlvbiByZW1vdmVGcm9tSGFzTWFueShrZXksIHJlY29yZERhdGFzKSB7CiAgICAgIHRoaXMuX3JlbGF0aW9uc2hpcHMuZ2V0KGtleSkucmVtb3ZlUmVjb3JkRGF0YXMocmVjb3JkRGF0YXMpOwogICAgfTsKCiAgICBfcHJvdG8uY29tbWl0V2FzUmVqZWN0ZWQgPSBmdW5jdGlvbiBjb21taXRXYXNSZWplY3RlZChpZGVudGlmaWVyLCBlcnJvcnMpIHsKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh0aGlzLl9pbkZsaWdodEF0dHJpYnV0ZXMpOwoKICAgICAgaWYgKGtleXMubGVuZ3RoID4gMCkgewogICAgICAgIHZhciBhdHRycyA9IHRoaXMuX2F0dHJpYnV0ZXM7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGF0dHJzW2tleXNbaV1dID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgYXR0cnNba2V5c1tpXV0gPSB0aGlzLl9pbkZsaWdodEF0dHJpYnV0ZXNba2V5c1tpXV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLl9pbkZsaWdodEF0dHJpYnV0ZXMgPSBudWxsOwoKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFQ09SRF9EQVRBX0VSUk9SUykgewogICAgICAgIGlmIChlcnJvcnMpIHsKICAgICAgICAgIHRoaXMuX2Vycm9ycyA9IGVycm9yczsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3RvcmVXcmFwcGVyLm5vdGlmeUVycm9yc0NoYW5nZSh0aGlzLm1vZGVsTmFtZSwgdGhpcy5pZCwgdGhpcy5jbGllbnRJZCk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLmdldEJlbG9uZ3NUbyA9IGZ1bmN0aW9uIGdldEJlbG9uZ3NUbyhrZXkpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JlbGF0aW9uc2hpcHMuZ2V0KGtleSkuZ2V0RGF0YSgpOwogICAgfTsKCiAgICBfcHJvdG8uc2V0RGlydHlCZWxvbmdzVG8gPSBmdW5jdGlvbiBzZXREaXJ0eUJlbG9uZ3NUbyhrZXksIHJlY29yZERhdGEpIHsKICAgICAgdGhpcy5fcmVsYXRpb25zaGlwcy5nZXQoa2V5KS5zZXRSZWNvcmREYXRhKHJlY29yZERhdGEpOwogICAgfTsKCiAgICBfcHJvdG8uc2V0RGlydHlBdHRyaWJ1dGUgPSBmdW5jdGlvbiBzZXREaXJ0eUF0dHJpYnV0ZShrZXksIHZhbHVlKSB7CiAgICAgIHZhciBvcmlnaW5hbFZhbHVlOyAvLyBBZGQgdGhlIG5ldyB2YWx1ZSB0byB0aGUgY2hhbmdlZCBhdHRyaWJ1dGVzIGhhc2gKCiAgICAgIHRoaXMuX2F0dHJpYnV0ZXNba2V5XSA9IHZhbHVlOwoKICAgICAgaWYgKGtleSBpbiB0aGlzLl9pbkZsaWdodEF0dHJpYnV0ZXMpIHsKICAgICAgICBvcmlnaW5hbFZhbHVlID0gdGhpcy5faW5GbGlnaHRBdHRyaWJ1dGVzW2tleV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3JpZ2luYWxWYWx1ZSA9IHRoaXMuX2RhdGFba2V5XTsKICAgICAgfSAvLyBJZiB3ZSB3ZW50IGJhY2sgdG8gb3VyIG9yaWdpbmFsIHZhbHVlLCB3ZSBzaG91bGRuJ3Qga2VlcCB0aGUgYXR0cmlidXRlIGFyb3VuZCBhbnltb3JlCgoKICAgICAgaWYgKHZhbHVlID09PSBvcmlnaW5hbFZhbHVlKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2F0dHJpYnV0ZXNba2V5XTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uZ2V0QXR0ciA9IGZ1bmN0aW9uIGdldEF0dHIoa2V5KSB7CiAgICAgIGlmIChrZXkgaW4gdGhpcy5fYXR0cmlidXRlcykgewogICAgICAgIHJldHVybiB0aGlzLl9hdHRyaWJ1dGVzW2tleV07CiAgICAgIH0gZWxzZSBpZiAoa2V5IGluIHRoaXMuX2luRmxpZ2h0QXR0cmlidXRlcykgewogICAgICAgIHJldHVybiB0aGlzLl9pbkZsaWdodEF0dHJpYnV0ZXNba2V5XTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5fZGF0YVtrZXldOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5oYXNBdHRyID0gZnVuY3Rpb24gaGFzQXR0cihrZXkpIHsKICAgICAgcmV0dXJuIGtleSBpbiB0aGlzLl9hdHRyaWJ1dGVzIHx8IGtleSBpbiB0aGlzLl9pbkZsaWdodEF0dHJpYnV0ZXMgfHwga2V5IGluIHRoaXMuX2RhdGE7CiAgICB9OwoKICAgIF9wcm90by51bmxvYWRSZWNvcmQgPSBmdW5jdGlvbiB1bmxvYWRSZWNvcmQoKSB7CiAgICAgIGlmICh0aGlzLmlzRGVzdHJveWVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl9kZXN0cm95UmVsYXRpb25zaGlwcygpOwoKICAgICAgdGhpcy5yZXNldCgpOwoKICAgICAgaWYgKCF0aGlzLl9zY2hlZHVsZWREZXN0cm95KSB7CiAgICAgICAgdGhpcy5fc2NoZWR1bGVkRGVzdHJveSA9IEVtYmVyLnJ1bi5iYWNrYnVybmVyLnNjaGVkdWxlKCdkZXN0cm95JywgdGhpcywgJ19jbGVhbnVwT3JwaGFuZWRSZWNvcmREYXRhcycpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5fY2xlYW51cE9ycGhhbmVkUmVjb3JkRGF0YXMgPSBmdW5jdGlvbiBfY2xlYW51cE9ycGhhbmVkUmVjb3JkRGF0YXMoKSB7CiAgICAgIHZhciByZWxhdGVkUmVjb3JkRGF0YXMgPSB0aGlzLl9hbGxSZWxhdGVkUmVjb3JkRGF0YXMoKTsKCiAgICAgIGlmIChhcmVBbGxNb2RlbHNVbmxvYWRlZChyZWxhdGVkUmVjb3JkRGF0YXMpKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWxhdGVkUmVjb3JkRGF0YXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIHZhciByZWNvcmREYXRhID0gcmVsYXRlZFJlY29yZERhdGFzW2ldOwoKICAgICAgICAgIGlmICghcmVjb3JkRGF0YS5pc0Rlc3Ryb3llZCkgewogICAgICAgICAgICByZWNvcmREYXRhLmRlc3Ryb3koKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuX3NjaGVkdWxlZERlc3Ryb3kgPSBudWxsOwogICAgfTsKCiAgICBfcHJvdG8uZGVzdHJveSA9IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgIHRoaXMuX3JlbGF0aW9uc2hpcHMuZm9yRWFjaChmdW5jdGlvbiAobmFtZSwgcmVsKSB7CiAgICAgICAgcmV0dXJuIHJlbC5kZXN0cm95KCk7CiAgICAgIH0pOwoKICAgICAgdGhpcy5pc0Rlc3Ryb3llZCA9IHRydWU7CiAgICAgIHRoaXMuc3RvcmVXcmFwcGVyLmRpc2Nvbm5lY3RSZWNvcmQodGhpcy5tb2RlbE5hbWUsIHRoaXMuaWQsIHRoaXMuY2xpZW50SWQpOwogICAgfTsKCiAgICBfcHJvdG8uaXNSZWNvcmRJblVzZSA9IGZ1bmN0aW9uIGlzUmVjb3JkSW5Vc2UoKSB7CiAgICAgIHJldHVybiB0aGlzLnN0b3JlV3JhcHBlci5pc1JlY29yZEluVXNlKHRoaXMubW9kZWxOYW1lLCB0aGlzLmlkLCB0aGlzLmNsaWVudElkKTsKICAgIH0KICAgIC8qKgogICAgICBDb21wdXRlcyB0aGUgc2V0IG9mIGludGVybmFsIG1vZGVscyByZWFjaGFibGUgZnJvbSBgdGhpc2AgYWNyb3NzIGV4YWN0bHkgb25lCiAgICAgIHJlbGF0aW9uc2hpcC4KICAgICAgIEByZXR1cm4ge0FycmF5fSBBbiBhcnJheSBjb250YWluaW5nIHRoZSBpbnRlcm5hbCBtb2RlbHMgdGhhdCBgdGhpc2AgYmVsb25ncwogICAgICB0byBvciBoYXMgbWFueS4KICAgICAqLwogICAgOwoKICAgIF9wcm90by5fZGlyZWN0bHlSZWxhdGVkUmVjb3JkRGF0YXMgPSBmdW5jdGlvbiBfZGlyZWN0bHlSZWxhdGVkUmVjb3JkRGF0YXMoKSB7CiAgICAgIHZhciBhcnJheSA9IFtdOwoKICAgICAgdGhpcy5fcmVsYXRpb25zaGlwcy5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lLCByZWwpIHsKICAgICAgICB2YXIgbWVtYmVycyA9IHJlbC5tZW1iZXJzLmxpc3Q7CiAgICAgICAgdmFyIGNhbm9uaWNhbE1lbWJlcnMgPSByZWwuY2Fub25pY2FsTWVtYmVycy5saXN0OwogICAgICAgIGFycmF5ID0gYXJyYXkuY29uY2F0KG1lbWJlcnMsIGNhbm9uaWNhbE1lbWJlcnMpOwogICAgICB9KTsKCiAgICAgIHJldHVybiBhcnJheTsKICAgIH0KICAgIC8qKgogICAgICBDb21wdXRlcyB0aGUgc2V0IG9mIGludGVybmFsIG1vZGVscyByZWFjaGFibGUgZnJvbSB0aGlzIGludGVybmFsIG1vZGVsLgogICAgICAgUmVhY2hhYmlsaXR5IGlzIGRldGVybWluZWQgb3ZlciB0aGUgcmVsYXRpb25zaGlwIGdyYXBoIChpZSBhIGdyYXBoIHdoZXJlCiAgICAgIG5vZGVzIGFyZSBpbnRlcm5hbCBtb2RlbHMgYW5kIGVkZ2VzIGFyZSBiZWxvbmdzIHRvIG9yIGhhcyBtYW55CiAgICAgIHJlbGF0aW9uc2hpcHMpLgogICAgICAgQHJldHVybiB7QXJyYXl9IEFuIGFycmF5IGluY2x1ZGluZyBgdGhpc2AgYW5kIGFsbCBpbnRlcm5hbCBtb2RlbHMgcmVhY2hhYmxlCiAgICAgIGZyb20gYHRoaXNgLgogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uX2FsbFJlbGF0ZWRSZWNvcmREYXRhcyA9IGZ1bmN0aW9uIF9hbGxSZWxhdGVkUmVjb3JkRGF0YXMoKSB7CiAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICB2YXIgcXVldWUgPSBbXTsKICAgICAgdmFyIGJmc0lkID0gbmV4dEJmc0lkKys7CiAgICAgIHF1ZXVlLnB1c2godGhpcyk7CiAgICAgIHRoaXMuX2Jmc0lkID0gYmZzSWQ7CgogICAgICB3aGlsZSAocXVldWUubGVuZ3RoID4gMCkgewogICAgICAgIHZhciBub2RlID0gcXVldWUuc2hpZnQoKTsKICAgICAgICBhcnJheS5wdXNoKG5vZGUpOwoKICAgICAgICB2YXIgcmVsYXRlZCA9IG5vZGUuX2RpcmVjdGx5UmVsYXRlZFJlY29yZERhdGFzKCk7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVsYXRlZC5sZW5ndGg7ICsraSkgewogICAgICAgICAgdmFyIHJlY29yZERhdGEgPSByZWxhdGVkW2ldOwoKICAgICAgICAgIGlmIChyZWNvcmREYXRhIGluc3RhbmNlb2YgUmVjb3JkRGF0YURlZmF1bHQpIHsKCiAgICAgICAgICAgIGlmIChyZWNvcmREYXRhLl9iZnNJZCA8IGJmc0lkKSB7CiAgICAgICAgICAgICAgcXVldWUucHVzaChyZWNvcmREYXRhKTsKICAgICAgICAgICAgICByZWNvcmREYXRhLl9iZnNJZCA9IGJmc0lkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gYXJyYXk7CiAgICB9OwoKICAgIF9wcm90by5pc0F0dHJEaXJ0eSA9IGZ1bmN0aW9uIGlzQXR0ckRpcnR5KGtleSkgewogICAgICBpZiAodGhpcy5fYXR0cmlidXRlc1trZXldID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHZhciBvcmlnaW5hbFZhbHVlOwoKICAgICAgaWYgKHRoaXMuX2luRmxpZ2h0QXR0cmlidXRlc1trZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBvcmlnaW5hbFZhbHVlID0gdGhpcy5faW5GbGlnaHRBdHRyaWJ1dGVzW2tleV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3JpZ2luYWxWYWx1ZSA9IHRoaXMuX2RhdGFba2V5XTsKICAgICAgfQoKICAgICAgcmV0dXJuIG9yaWdpbmFsVmFsdWUgIT09IHRoaXMuX2F0dHJpYnV0ZXNba2V5XTsKICAgIH07CgogICAgLyoqCiAgICAgKiBSZWNlaXZlcyBvcHRpb25zIHBhc3NlZCB0byBgc3RvcmUuY3JlYXRlUmVjb3JkYCBhbmQgaXMgZ2l2ZW4gdGhlIG9wcG9ydHVuaXR5CiAgICAgKiB0byBoYW5kbGUgdGhlbS4KICAgICAqCiAgICAgKiBUaGUgcmV0dXJuIHZhbHVlIGlzIGFuIG9iamVjdCBvZiBvcHRpb25zIHRvIHBhc3MgdG8gYFJlY29yZC5jcmVhdGUoKWAKICAgICAqCiAgICAgKiBAcGFyYW0gb3B0aW9ucwogICAgICogQHByaXZhdGUKICAgICAqLwogICAgX3Byb3RvLl9pbml0UmVjb3JkQ3JlYXRlT3B0aW9ucyA9IGZ1bmN0aW9uIF9pbml0UmVjb3JkQ3JlYXRlT3B0aW9ucyhvcHRpb25zKSB7CiAgICAgIHZhciBjcmVhdGVPcHRpb25zID0ge307CgogICAgICBpZiAob3B0aW9ucyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdmFyIF9tb2RlbE5hbWUyID0gdGhpcy5tb2RlbE5hbWUsCiAgICAgICAgICAgIF9zdG9yZVdyYXBwZXI0ID0gdGhpcy5zdG9yZVdyYXBwZXI7CgogICAgICAgIHZhciBhdHRyaWJ1dGVEZWZzID0gX3N0b3JlV3JhcHBlcjQuYXR0cmlidXRlc0RlZmluaXRpb25Gb3IoX21vZGVsTmFtZTIpOwoKICAgICAgICB2YXIgcmVsYXRpb25zaGlwRGVmcyA9IF9zdG9yZVdyYXBwZXI0LnJlbGF0aW9uc2hpcHNEZWZpbml0aW9uRm9yKF9tb2RlbE5hbWUyKTsKCiAgICAgICAgdmFyIHJlbGF0aW9uc2hpcHMgPSB0aGlzLl9yZWxhdGlvbnNoaXBzOwogICAgICAgIHZhciBwcm9wZXJ0eU5hbWVzID0gT2JqZWN0LmtleXMob3B0aW9ucyk7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcGVydHlOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIG5hbWUgPSBwcm9wZXJ0eU5hbWVzW2ldOwogICAgICAgICAgdmFyIHByb3BlcnR5VmFsdWUgPSBvcHRpb25zW25hbWVdOwoKICAgICAgICAgIGlmIChuYW1lID09PSAnaWQnKSB7CiAgICAgICAgICAgIHRoaXMuaWQgPSBwcm9wZXJ0eVZhbHVlOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgZmllbGRUeXBlID0gcmVsYXRpb25zaGlwRGVmc1tuYW1lXSB8fCBhdHRyaWJ1dGVEZWZzW25hbWVdOwogICAgICAgICAgdmFyIGtpbmQgPSBmaWVsZFR5cGUgIT09IHVuZGVmaW5lZCA/IGZpZWxkVHlwZS5raW5kIDogbnVsbDsKICAgICAgICAgIHZhciByZWxhdGlvbnNoaXAgPSB2b2lkIDA7CgogICAgICAgICAgc3dpdGNoIChraW5kKSB7CiAgICAgICAgICAgIGNhc2UgJ2F0dHJpYnV0ZSc6CiAgICAgICAgICAgICAgdGhpcy5zZXREaXJ0eUF0dHJpYnV0ZShuYW1lLCBwcm9wZXJ0eVZhbHVlKTsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ2JlbG9uZ3NUbyc6CiAgICAgICAgICAgICAgdGhpcy5zZXREaXJ0eUJlbG9uZ3NUbyhuYW1lLCBwcm9wZXJ0eVZhbHVlKTsKICAgICAgICAgICAgICByZWxhdGlvbnNoaXAgPSByZWxhdGlvbnNoaXBzLmdldChuYW1lKTsKICAgICAgICAgICAgICByZWxhdGlvbnNoaXAuc2V0SGFzQW55UmVsYXRpb25zaGlwRGF0YSh0cnVlKTsKICAgICAgICAgICAgICByZWxhdGlvbnNoaXAuc2V0UmVsYXRpb25zaGlwSXNFbXB0eShmYWxzZSk7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICdoYXNNYW55JzoKICAgICAgICAgICAgICB0aGlzLnNldERpcnR5SGFzTWFueShuYW1lLCBwcm9wZXJ0eVZhbHVlKTsKICAgICAgICAgICAgICByZWxhdGlvbnNoaXAgPSByZWxhdGlvbnNoaXBzLmdldChuYW1lKTsKICAgICAgICAgICAgICByZWxhdGlvbnNoaXAuc2V0SGFzQW55UmVsYXRpb25zaGlwRGF0YSh0cnVlKTsKICAgICAgICAgICAgICByZWxhdGlvbnNoaXAuc2V0UmVsYXRpb25zaGlwSXNFbXB0eShmYWxzZSk7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIC8vIHJlZmxlY3QgYmFjayAocGFzcy10aHJ1KSB1bmtub3duIHByb3BlcnRpZXMKICAgICAgICAgICAgICBjcmVhdGVPcHRpb25zW25hbWVdID0gcHJvcGVydHlWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBjcmVhdGVPcHRpb25zOwogICAgfQogICAgLyoKICAgICAgICBUT0RPIElHT1IgQU5EIERBVklEIHRoaXMgc2hvdWxkbid0IGJlIHB1YmxpYwogICAgIFRoaXMgbWV0aG9kIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBieSByZWNvcmRzIGluIHRoZSBgaXNOZXcoKWAgc3RhdGUgT1Igb25jZSB0aGUgcmVjb3JkCiAgICAgaGFzIGJlZW4gZGVsZXRlZCBhbmQgdGhhdCBkZWxldGlvbiBoYXMgYmVlbiBwZXJzaXN0ZWQuCiAgICAgIEl0IHdpbGwgcmVtb3ZlIHRoaXMgcmVjb3JkIGZyb20gYW55IGFzc29jaWF0ZWQgcmVsYXRpb25zaGlwcy4KICAgICAgSWYgYGlzTmV3YCBpcyB0cnVlIChkZWZhdWx0IGZhbHNlKSwgaXQgd2lsbCBhbHNvIGNvbXBsZXRlbHkgcmVzZXQgYWxsCiAgICAgIHJlbGF0aW9uc2hpcHMgdG8gYW4gZW1wdHkgc3RhdGUgYXMgd2VsbC4KICAgICAgIEBtZXRob2QgcmVtb3ZlRnJvbUludmVyc2VSZWxhdGlvbnNoaXBzCiAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gaXNOZXcgd2hldGhlciB0byB1bmxvYWQgZnJvbSB0aGUgYGlzTmV3YCBwZXJzcGVjdGl2ZQogICAgICBAcHJpdmF0ZQogICAgICovCiAgICA7CgogICAgX3Byb3RvLnJlbW92ZUZyb21JbnZlcnNlUmVsYXRpb25zaGlwcyA9IGZ1bmN0aW9uIHJlbW92ZUZyb21JbnZlcnNlUmVsYXRpb25zaGlwcyhpc05ldykgewogICAgICBpZiAoaXNOZXcgPT09IHZvaWQgMCkgewogICAgICAgIGlzTmV3ID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIHRoaXMuX3JlbGF0aW9uc2hpcHMuZm9yRWFjaChmdW5jdGlvbiAobmFtZSwgcmVsKSB7CiAgICAgICAgcmVsLnJlbW92ZUNvbXBsZXRlbHlGcm9tSW52ZXJzZSgpOwoKICAgICAgICBpZiAoaXNOZXcgPT09IHRydWUpIHsKICAgICAgICAgIHJlbC5jbGVhcigpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICB2YXIgaW1wbGljaXRSZWxhdGlvbnNoaXBzID0gdGhpcy5faW1wbGljaXRSZWxhdGlvbnNoaXBzOwogICAgICB0aGlzLl9faW1wbGljaXRSZWxhdGlvbnNoaXBzID0gbnVsbDsKICAgICAgT2JqZWN0LmtleXMoaW1wbGljaXRSZWxhdGlvbnNoaXBzKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIgcmVsID0gaW1wbGljaXRSZWxhdGlvbnNoaXBzW2tleV07CiAgICAgICAgcmVsLnJlbW92ZUNvbXBsZXRlbHlGcm9tSW52ZXJzZSgpOwoKICAgICAgICBpZiAoaXNOZXcgPT09IHRydWUpIHsKICAgICAgICAgIHJlbC5jbGVhcigpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9OwoKICAgIF9wcm90by5fZGVzdHJveVJlbGF0aW9uc2hpcHMgPSBmdW5jdGlvbiBfZGVzdHJveVJlbGF0aW9uc2hpcHMoKSB7CiAgICAgIHZhciByZWxhdGlvbnNoaXBzID0gdGhpcy5fcmVsYXRpb25zaGlwczsKICAgICAgcmVsYXRpb25zaGlwcy5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lLCByZWwpIHsKICAgICAgICByZXR1cm4gZGVzdHJveVJlbGF0aW9uc2hpcChyZWwpOwogICAgICB9KTsKICAgICAgdmFyIGltcGxpY2l0UmVsYXRpb25zaGlwcyA9IHRoaXMuX2ltcGxpY2l0UmVsYXRpb25zaGlwczsKICAgICAgdGhpcy5fX2ltcGxpY2l0UmVsYXRpb25zaGlwcyA9IG51bGw7CiAgICAgIE9iamVjdC5rZXlzKGltcGxpY2l0UmVsYXRpb25zaGlwcykuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgdmFyIHJlbCA9IGltcGxpY2l0UmVsYXRpb25zaGlwc1trZXldOwogICAgICAgIGRlc3Ryb3lSZWxhdGlvbnNoaXAocmVsKTsKICAgICAgfSk7CiAgICB9OwoKICAgIF9wcm90by5jbGllbnREaWRDcmVhdGUgPSBmdW5jdGlvbiBjbGllbnREaWRDcmVhdGUoKSB7CiAgICAgIHRoaXMuX2lzTmV3ID0gdHJ1ZTsKICAgIH0KICAgIC8qCiAgICAgIEVtYmVyIERhdGEgaGFzIDMgYnVja2V0cyBmb3Igc3RvcmluZyB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlIG9uIGFuIGludGVybmFsTW9kZWwuCiAgICAgICBgX2RhdGFgIGhvbGRzIGFsbCBvZiB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgYmVlbiBhY2tub3dsZWRnZWQgYnkKICAgICAgYSBiYWNrZW5kIHZpYSB0aGUgYWRhcHRlci4gV2hlbiByb2xsYmFja0F0dHJpYnV0ZXMgaXMgY2FsbGVkIG9uIGEgbW9kZWwgYWxsCiAgICAgIGF0dHJpYnV0ZXMgd2lsbCByZXZlcnQgdG8gdGhlIHJlY29yZCdzIHN0YXRlIGluIGBfZGF0YWAuCiAgICAgICBgX2F0dHJpYnV0ZXNgIGhvbGRzIGFueSBjaGFuZ2UgdGhlIHVzZXIgaGFzIG1hZGUgdG8gYW4gYXR0cmlidXRlCiAgICAgIHRoYXQgaGFzIG5vdCBiZWVuIGFja25vd2xlZGdlZCBieSB0aGUgYWRhcHRlci4gQW55IHZhbHVlcyBpbgogICAgICBgX2F0dHJpYnV0ZXNgIGFyZSBoYXZlIHByaW9yaXR5IG92ZXIgdmFsdWVzIGluIGBfZGF0YWAuCiAgICAgICBgX2luRmxpZ2h0QXR0cmlidXRlc2AuIFdoZW4gYSByZWNvcmQgaXMgYmVpbmcgc3luY2VkIHdpdGggdGhlCiAgICAgIGJhY2tlbmQgdGhlIHZhbHVlcyBpbiBgX2F0dHJpYnV0ZXNgIGFyZSBjb3BpZWQgdG8KICAgICAgYF9pbkZsaWdodEF0dHJpYnV0ZXNgLiBUaGlzIHdheSBpZiB0aGUgYmFja2VuZCBhY2tub3dsZWRnZXMgdGhlCiAgICAgIHNhdmUgYnV0IGRvZXMgbm90IHJldHVybiB0aGUgbmV3IHN0YXRlIEVtYmVyIERhdGEgY2FuIGNvcHkgdGhlCiAgICAgIHZhbHVlcyBmcm9tIGBfaW5GbGlnaHRBdHRyaWJ1dGVzYCB0byBgX2RhdGFgLiBXaXRob3V0IGhhdmluZyB0bwogICAgICB3b3JyeSBhYm91dCBjaGFuZ2VzIG1hZGUgdG8gYF9hdHRyaWJ1dGVzYCB3aGlsZSB0aGUgc2F2ZSB3YXMKICAgICAgaGFwcGVuaWduLgogICAgICAgIENoYW5nZWQga2V5cyBidWlsZHMgYSBsaXN0IG9mIGFsbCBvZiB0aGUgdmFsdWVzIHRoYXQgbWF5IGhhdmUgYmVlbgogICAgICBjaGFuZ2VkIGJ5IHRoZSBiYWNrZW5kIGFmdGVyIGEgc3VjY2Vzc2Z1bCBzYXZlLgogICAgICAgSXQgZG9lcyB0aGlzIGJ5IGl0ZXJhdGluZyBvdmVyIGVhY2gga2V5LCB2YWx1ZSBwYWlyIGluIHRoZSBwYXlsb2FkCiAgICAgIHJldHVybmVkIGZyb20gdGhlIHNlcnZlciBhZnRlciBhIHNhdmUuIElmIHRoZSBga2V5YCBpcyBmb3VuZCBpbgogICAgICBgX2F0dHJpYnV0ZXNgIHRoZW4gdGhlIHVzZXIgaGFzIGEgbG9jYWwgY2hhbmdlZCB0byB0aGUgYXR0cmlidXRlCiAgICAgIHRoYXQgaGFzIG5vdCBiZWVuIHN5bmNlZCB3aXRoIHRoZSBzZXJ2ZXIgYW5kIHRoZSBrZXkgaXMgbm90CiAgICAgIGluY2x1ZGVkIGluIHRoZSBsaXN0IG9mIGNoYW5nZWQga2V5cy4KICAgIAogICAgICBJZiB0aGUgdmFsdWUsIGZvciBhIGtleSBkaWZmZXJzIGZyb20gdGhlIHZhbHVlIGluIHdoYXQgRW1iZXIgRGF0YQogICAgICBiZWxpZXZlcyB0byBiZSB0aGUgdHJ1dGggYWJvdXQgdGhlIGJhY2tlbmQgc3RhdGUgKEEgbWVyZ2VyIG9mIHRoZQogICAgICBgX2RhdGFgIGFuZCBgX2luRmxpZ2h0QXR0cmlidXRlc2Agb2JqZWN0cyB3aGVyZQogICAgICBgX2luRmxpZ2h0QXR0cmlidXRlc2AgaGFzIHByaW9yaXR5KSB0aGVuIHRoYXQgbWVhbnMgdGhlIGJhY2tlbmQKICAgICAgaGFzIHVwZGF0ZWQgdGhlIHZhbHVlIGFuZCB0aGUga2V5IGlzIGFkZGVkIHRvIHRoZSBsaXN0IG9mIGNoYW5nZWQKICAgICAga2V5cy4KICAgICAgIEBtZXRob2QgX2NoYW5nZWRLZXlzCiAgICAgIEBwcml2YXRlCiAgICAqLwoKICAgIC8qCiAgICAgICAgVE9ETyBJR09SIERBVklECiAgICAgICAgVGhlcmUgc2VlbXMgdG8gYmUgYSBwb3RlbnRpYWwgYnVnIGhlcmUsIHdoZXJlIHdlIHdpbGwgcmV0dXJuIGtleXMgdGhhdCBhcmUgbm90CiAgICAgICAgaW4gdGhlIHNjaGVtYQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uX2NoYW5nZWRLZXlzID0gZnVuY3Rpb24gX2NoYW5nZWRLZXlzKHVwZGF0ZXMpIHsKICAgICAgdmFyIGNoYW5nZWRLZXlzID0gW107CgogICAgICBpZiAodXBkYXRlcykgewogICAgICAgIHZhciBvcmlnaW5hbCwgaSwgdmFsdWUsIF9rZXkyOwoKICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHVwZGF0ZXMpOwogICAgICAgIHZhciBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgICAgICB2YXIgaGFzQXR0cnMgPSB0aGlzLmhhc0NoYW5nZWRBdHRyaWJ1dGVzKCk7CiAgICAgICAgdmFyIGF0dHJzOwoKICAgICAgICBpZiAoaGFzQXR0cnMpIHsKICAgICAgICAgIGF0dHJzID0gdGhpcy5fYXR0cmlidXRlczsKICAgICAgICB9CgogICAgICAgIG9yaWdpbmFsID0gRW1iZXIuYXNzaWduKE9iamVjdC5jcmVhdGUobnVsbCksIHRoaXMuX2RhdGEsIHRoaXMuX19pbkZsaWdodEF0dHJpYnV0ZXMpOwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIF9rZXkyID0ga2V5c1tpXTsKICAgICAgICAgIHZhbHVlID0gdXBkYXRlc1tfa2V5Ml07IC8vIEEgdmFsdWUgaW4gX2F0dHJpYnV0ZXMgbWVhbnMgdGhlIHVzZXIgaGFzIGEgbG9jYWwgY2hhbmdlIHRvCiAgICAgICAgICAvLyB0aGlzIGF0dHJpYnV0ZXMuIFdlIG5ldmVyIG92ZXJyaWRlIHRoaXMgdmFsdWUgd2hlbiBtZXJnaW5nCiAgICAgICAgICAvLyB1cGRhdGVzIGZyb20gdGhlIGJhY2tlbmQgc28gd2Ugc2hvdWxkIG5vdCBzZW50IGEgY2hhbmdlCiAgICAgICAgICAvLyBub3RpZmljYXRpb24gaWYgdGhlIHNlcnZlciB2YWx1ZSBkaWZmZXJzIGZyb20gdGhlIG9yaWdpbmFsLgoKICAgICAgICAgIGlmIChoYXNBdHRycyA9PT0gdHJ1ZSAmJiBhdHRyc1tfa2V5Ml0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIUVtYmVyLmlzRXF1YWwob3JpZ2luYWxbX2tleTJdLCB2YWx1ZSkpIHsKICAgICAgICAgICAgY2hhbmdlZEtleXMucHVzaChfa2V5Mik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gY2hhbmdlZEtleXM7CiAgICB9OwoKICAgIF9wcm90by50b1N0cmluZyA9IGZ1bmN0aW9uIHRvU3RyaW5nKCkgewogICAgICByZXR1cm4gIjwiICsgdGhpcy5tb2RlbE5hbWUgKyAiOiIgKyB0aGlzLmlkICsgIj4iOwogICAgfTsKCiAgICBfY3JlYXRlQ2xhc3MkMyhSZWNvcmREYXRhRGVmYXVsdCwgW3sKICAgICAga2V5OiAiX2F0dHJpYnV0ZXMiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICBpZiAodGhpcy5fX2F0dHJpYnV0ZXMgPT09IG51bGwpIHsKICAgICAgICAgIHRoaXMuX19hdHRyaWJ1dGVzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLl9fYXR0cmlidXRlczsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQodikgewogICAgICAgIHRoaXMuX19hdHRyaWJ1dGVzID0gdjsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfcmVsYXRpb25zaGlwcyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIGlmICh0aGlzLl9fcmVsYXRpb25zaGlwcyA9PT0gbnVsbCkgewogICAgICAgICAgdGhpcy5fX3JlbGF0aW9uc2hpcHMgPSBuZXcgUmVsYXRpb25zaGlwcyh0aGlzKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLl9fcmVsYXRpb25zaGlwczsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfZGF0YSIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIGlmICh0aGlzLl9fZGF0YSA9PT0gbnVsbCkgewogICAgICAgICAgdGhpcy5fX2RhdGEgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuX19kYXRhOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldCh2KSB7CiAgICAgICAgdGhpcy5fX2RhdGEgPSB2OwogICAgICB9CiAgICAgIC8qCiAgICAgICBpbXBsaWNpdCByZWxhdGlvbnNoaXBzIGFyZSByZWxhdGlvbnNoaXAgd2hpY2ggaGF2ZSBub3QgYmVlbiBkZWNsYXJlZCBidXQgdGhlIGludmVyc2Ugc2lkZSBleGlzdHMgb24KICAgICAgIGFub3RoZXIgcmVjb3JkIHNvbWV3aGVyZQogICAgICAgRm9yIGV4YW1wbGUgaWYgdGhlcmUgd2FzCiAgICAgICAgYGBgYXBwL21vZGVscy9jb21tZW50LmpzCiAgICAgICBpbXBvcnQgTW9kZWwsIHsgYXR0ciB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKICAgICAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICAgICBuYW1lOiBhdHRyKCkKICAgICAgIH0pOwogICAgICAgYGBgCiAgICAgICAgYnV0IHRoZXJlIGlzIGFsc28KICAgICAgICBgYGBhcHAvbW9kZWxzL3Bvc3QuanMKICAgICAgIGltcG9ydCBNb2RlbCwgeyBhdHRyLCBoYXNNYW55IH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogICAgICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgICAgIG5hbWU6IGF0dHIoKSwKICAgICAgICAgY29tbWVudHM6IGhhc01hbnkoJ2NvbW1lbnQnKQogICAgICAgfSk7CiAgICAgICBgYGAKICAgICAgICB3b3VsZCBoYXZlIGEgaW1wbGljaXQgcG9zdCByZWxhdGlvbnNoaXAgaW4gb3JkZXIgdG8gYmUgZG8gdGhpbmdzIGxpa2UgcmVtb3ZlIG91cnNlbHZlcyBmcm9tIHRoZSBwb3N0CiAgICAgICB3aGVuIHdlIGFyZSBkZWxldGVkCiAgICAgICovCgogICAgfSwgewogICAgICBrZXk6ICJfaW1wbGljaXRSZWxhdGlvbnNoaXBzIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgaWYgKHRoaXMuX19pbXBsaWNpdFJlbGF0aW9uc2hpcHMgPT09IG51bGwpIHsKICAgICAgICAgIHZhciByZWxhdGlvbnNoaXBzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICAgIHRoaXMuX19pbXBsaWNpdFJlbGF0aW9uc2hpcHMgPSByZWxhdGlvbnNoaXBzOwogICAgICAgICAgcmV0dXJuIHJlbGF0aW9uc2hpcHM7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5fX2ltcGxpY2l0UmVsYXRpb25zaGlwczsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfaW5GbGlnaHRBdHRyaWJ1dGVzIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgaWYgKHRoaXMuX19pbkZsaWdodEF0dHJpYnV0ZXMgPT09IG51bGwpIHsKICAgICAgICAgIHRoaXMuX19pbkZsaWdodEF0dHJpYnV0ZXMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuX19pbkZsaWdodEF0dHJpYnV0ZXM7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gc2V0KHYpIHsKICAgICAgICB0aGlzLl9faW5GbGlnaHRBdHRyaWJ1dGVzID0gdjsKICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBSZWNvcmREYXRhRGVmYXVsdDsKICB9KCk7CiAgLy8gcmVsYXRpb25zaGlwIG9mIHRoZSBkZW1hdGVyaWFsaXphdGlvbjogdGhpcyBpcyBkb25lIHNvIHRoZSByZWxhdGlvbnNoaXAgY2FuCiAgLy8gbm90aWZ5IGl0cyBpbnZlcnNlIHdoaWNoIG5lZWRzIHRvIHVwZGF0ZSBzdGF0ZQogIC8vCiAgLy8gSWYgdGhlIGludmVyc2UgaXMgc3luYywgdW5sb2FkaW5nIHRoaXMgcmVjb3JkIGlzIHRyZWF0ZWQgYXMgYSBjbGllbnQtc2lkZQogIC8vIGRlbGV0ZSwgc28gd2UgcmVtb3ZlIHRoZSBpbnZlcnNlIHJlY29yZHMgZnJvbSB0aGlzIHJlbGF0aW9uc2hpcCB0bwogIC8vIGRpc2Nvbm5lY3QgdGhlIGdyYXBoLiAgQmVjYXVzZSBpdCdzIG5vdCBhc3luYywgd2UgZG9uJ3QgbmVlZCB0byBrZWVwIGFyb3VuZAogIC8vIHRoZSBpbnRlcm5hbE1vZGVsIGFzIGFuIGlkLXdyYXBwZXIgZm9yIHJlZmVyZW5jZXMgYW5kIGJlY2F1c2UgdGhlIGdyYXBoIGlzCiAgLy8gZGlzY29ubmVjdGVkIHdlIGNhbiBhY3R1YWxseSBkZXN0cm95IHRoZSBpbnRlcm5hbE1vZGVsIHdoZW4gY2hlY2tpbmcgZm9yCiAgLy8gb3JwaGFuZWQgbW9kZWxzLgoKCiAgZnVuY3Rpb24gZGVzdHJveVJlbGF0aW9uc2hpcChyZWwpIHsKICAgIHJlbC5yZWNvcmREYXRhRGlkRGVtYXRlcmlhbGl6ZSgpOwoKICAgIGlmIChyZWwuX2ludmVyc2VJc1N5bmMoKSkgewogICAgICByZWwucmVtb3ZlQWxsUmVjb3JkRGF0YXNGcm9tT3duKCk7CiAgICAgIHJlbC5yZW1vdmVBbGxDYW5vbmljYWxSZWNvcmREYXRhc0Zyb21Pd24oKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGFyZUFsbE1vZGVsc1VubG9hZGVkKHJlY29yZERhdGFzKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlY29yZERhdGFzLmxlbmd0aDsgKytpKSB7CiAgICAgIGlmIChyZWNvcmREYXRhc1tpXS5pc1JlY29yZEluVXNlKCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGV4cG9ydHMuQmVsb25nc1RvUmVsYXRpb25zaGlwID0gQmVsb25nc1RvUmVsYXRpb25zaGlwOwogIGV4cG9ydHMuTWFueVJlbGF0aW9uc2hpcCA9IE1hbnlSZWxhdGlvbnNoaXA7CiAgZXhwb3J0cy5SZWNvcmREYXRhID0gUmVjb3JkRGF0YURlZmF1bHQ7CiAgZXhwb3J0cy5SZWxhdGlvbnNoaXAgPSBSZWxhdGlvbnNoaXA7CiAgZXhwb3J0cy5yZWxhdGlvbnNoaXBTdGF0ZUZvciA9IHJlbGF0aW9uc2hpcFN0YXRlRm9yOwogIGV4cG9ydHMucmVsYXRpb25zaGlwc0ZvciA9IHJlbGF0aW9uc2hpcHNGb3I7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsgdmFsdWU6IHRydWUgfSk7Cgp9KTsKCjtkZWZpbmUoJ0BlbWJlci1kYXRhL3NlcmlhbGl6ZXIvLXByaXZhdGUnLCBbJ2V4cG9ydHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsgJ3VzZSBzdHJpY3QnOwoKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyLWRhdGEvc2VyaWFsaXplcgogICovCgogIC8qKgogICAgIyMgVXNpbmcgRW1iZWRkZWQgUmVjb3JkcwoKICAgIGBFbWJlZGRlZFJlY29yZHNNaXhpbmAgc3VwcG9ydHMgc2VyaWFsaXppbmcgZW1iZWRkZWQgcmVjb3Jkcy4KCiAgICBUbyBzZXQgdXAgZW1iZWRkZWQgcmVjb3JkcywgaW5jbHVkZSB0aGUgbWl4aW4gd2hlbiBleHRlbmRpbmcgYSBzZXJpYWxpemVyLAogICAgdGhlbiBkZWZpbmUgYW5kIGNvbmZpZ3VyZSBlbWJlZGRlZCAobW9kZWwpIHJlbGF0aW9uc2hpcHMuCgogICAgTm90ZSB0aGF0IGVtYmVkZGVkIHJlY29yZHMgd2lsbCBzZXJpYWxpemUgd2l0aCB0aGUgc2VyaWFsaXplciBmb3IgdGhlaXIgbW9kZWwgaW5zdGVhZCBvZiB0aGUgc2VyaWFsaXplciBpbiB3aGljaCB0aGV5IGFyZSBkZWZpbmVkLgoKICAgIEJlbG93IGlzIGFuIGV4YW1wbGUgb2YgYSBwZXItdHlwZSBzZXJpYWxpemVyIChgcG9zdGAgdHlwZSkuCgogICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgIGltcG9ydCBSRVNUU2VyaWFsaXplciwgeyBFbWJlZGRlZFJlY29yZHNNaXhpbiB9IGZyb20gJ0BlbWJlci1kYXRhL3NlcmlhbGl6ZXIvcmVzdCc7CgogICAgZXhwb3J0IGRlZmF1bHQgUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKEVtYmVkZGVkUmVjb3Jkc01peGluLCB7CiAgICAgIGF0dHJzOiB7CiAgICAgICAgYXV0aG9yOiB7IGVtYmVkZGVkOiAnYWx3YXlzJyB9LAogICAgICAgIGNvbW1lbnRzOiB7IHNlcmlhbGl6ZTogJ2lkcycgfQogICAgICB9CiAgICB9KTsKICAgIGBgYAogICAgTm90ZSB0aGF0IHRoaXMgdXNlIG9mIGB7IGVtYmVkZGVkOiAnYWx3YXlzJyB9YCBpcyB1bnJlbGF0ZWQgdG8KICAgIHRoZSBgeyBlbWJlZGRlZDogJ2Fsd2F5cycgfWAgdGhhdCBpcyBkZWZpbmVkIGFzIGFuIG9wdGlvbiBvbiBgYXR0cmAgYXMgcGFydCBvZgogICAgZGVmaW5pbmcgYSBtb2RlbCB3aGlsZSB3b3JraW5nIHdpdGggdGhlIGBBY3RpdmVNb2RlbFNlcmlhbGl6ZXJgLiAgTmV2ZXJ0aGVsZXNzLAogICAgdXNpbmcgYHsgZW1iZWRkZWQ6ICdhbHdheXMnIH1gIGFzIGFuIG9wdGlvbiB0byBgYXR0cmAgaXMgbm90IGEgdmFsaWQgd2F5IHRvIHNldCB1cAogICAgZW1iZWRkZWQgcmVjb3Jkcy4KCiAgICBUaGUgYGF0dHJzYCBvcHRpb24gZm9yIGEgcmVzb3VyY2UgYHsgZW1iZWRkZWQ6ICdhbHdheXMnIH1gIGlzIHNob3J0aGFuZCBmb3I6CgogICAgYGBganMKICAgIHsKICAgICAgc2VyaWFsaXplOiAncmVjb3JkcycsCiAgICAgIGRlc2VyaWFsaXplOiAncmVjb3JkcycKICAgIH0KICAgIGBgYAoKICAgICMjIyBDb25maWd1cmluZyBBdHRycwoKICAgIEEgcmVzb3VyY2UncyBgYXR0cnNgIG9wdGlvbiBtYXkgYmUgc2V0IHRvIHVzZSBgaWRzYCwgYHJlY29yZHNgIG9yIGZhbHNlIGZvciB0aGUKICAgIGBzZXJpYWxpemVgICBhbmQgYGRlc2VyaWFsaXplYCBzZXR0aW5ncy4KCiAgICBUaGUgYGF0dHJzYCBwcm9wZXJ0eSBjYW4gYmUgc2V0IG9uIHRoZSBgQXBwbGljYXRpb25TZXJpYWxpemVyYCBvciBhIHBlci10eXBlCiAgICBzZXJpYWxpemVyLgoKICAgIEluIHRoZSBjYXNlIHdoZXJlIGVtYmVkZGVkIEpTT04gaXMgZXhwZWN0ZWQgd2hpbGUgZXh0cmFjdGluZyBhIHBheWxvYWQgKHJlYWRpbmcpCiAgICB0aGUgc2V0dGluZyBpcyBgZGVzZXJpYWxpemU6ICdyZWNvcmRzJ2AsIHRoZXJlIGlzIG5vIG5lZWQgdG8gdXNlIGBpZHNgIHdoZW4KICAgIGV4dHJhY3RpbmcgYXMgdGhhdCBpcyB0aGUgZGVmYXVsdCBiZWhhdmlvdXIgd2l0aG91dCB0aGlzIG1peGluIGlmIHlvdSBhcmUgdXNpbmcKICAgIHRoZSB2YW5pbGxhIGBFbWJlZGRlZFJlY29yZHNNaXhpbmAuIExpa2V3aXNlLCB0byBlbWJlZCBKU09OIGluIHRoZSBwYXlsb2FkIHdoaWxlCiAgICBzZXJpYWxpemluZyBgc2VyaWFsaXplOiAncmVjb3JkcydgIGlzIHRoZSBzZXR0aW5nIHRvIHVzZS4gVGhlcmUgaXMgYW4gb3B0aW9uIG9mCiAgICBub3QgZW1iZWRkaW5nIEpTT04gaW4gdGhlIHNlcmlhbGl6ZWQgcGF5bG9hZCBieSB1c2luZyBgc2VyaWFsaXplOiAnaWRzJ2AuIElmIHlvdQogICAgZG8gbm90IHdhbnQgdGhlIHJlbGF0aW9uc2hpcCBzZW50IGF0IGFsbCwgeW91IGNhbiB1c2UgYHNlcmlhbGl6ZTogZmFsc2VgLgoKCiAgICAjIyMgRW1iZWRkZWRSZWNvcmRzTWl4aW4gZGVmYXVsdHMKICAgIElmIHlvdSBkbyBub3Qgb3ZlcndyaXRlIGBhdHRyc2AgZm9yIGEgc3BlY2lmaWMgcmVsYXRpb25zaGlwLCB0aGUgYEVtYmVkZGVkUmVjb3Jkc01peGluYAogICAgd2lsbCBiZWhhdmUgaW4gdGhlIGZvbGxvd2luZyB3YXk6CgogICAgQmVsb25nc1RvOiBgeyBzZXJpYWxpemU6ICdpZCcsIGRlc2VyaWFsaXplOiAnaWQnIH1gCiAgICBIYXNNYW55OiAgIGB7IHNlcmlhbGl6ZTogZmFsc2UsIGRlc2VyaWFsaXplOiAnaWRzJyB9YAoKICAgICMjIyBNb2RlbCBSZWxhdGlvbnNoaXBzCgogICAgRW1iZWRkZWQgcmVjb3JkcyBtdXN0IGhhdmUgYSBtb2RlbCBkZWZpbmVkIHRvIGJlIGV4dHJhY3RlZCBhbmQgc2VyaWFsaXplZC4gTm90ZSB0aGF0CiAgICB3aGVuIGRlZmluaW5nIGFueSByZWxhdGlvbnNoaXBzIG9uIHlvdXIgbW9kZWwgc3VjaCBhcyBgYmVsb25nc1RvYCBhbmQgYGhhc01hbnlgLCB5b3UKICAgIHNob3VsZCBub3QgYm90aCBzcGVjaWZ5IGBhc3luYzogdHJ1ZWAgYW5kIGFsc28gaW5kaWNhdGUgdGhyb3VnaCB0aGUgc2VyaWFsaXplcidzCiAgICBgYXR0cnNgIGF0dHJpYnV0ZSB0aGF0IHRoZSByZWxhdGVkIG1vZGVsIHNob3VsZCBiZSBlbWJlZGRlZCBmb3IgZGVzZXJpYWxpemF0aW9uLgogICAgSWYgYSBtb2RlbCBpcyBkZWNsYXJlZCBlbWJlZGRlZCBmb3IgZGVzZXJpYWxpemF0aW9uIChgZW1iZWRkZWQ6ICdhbHdheXMnYCBvciBgZGVzZXJpYWxpemU6ICdyZWNvcmRzJ2ApLAogICAgdGhlbiBkbyBub3QgdXNlIGBhc3luYzogdHJ1ZWAuCgogICAgVG8gc3VjY2Vzc2Z1bGx5IGV4dHJhY3QgYW5kIHNlcmlhbGl6ZSBlbWJlZGRlZCByZWNvcmRzIHRoZSBtb2RlbCByZWxhdGlvbnNoaXBzCiAgICBtdXN0IGJlIHNldCB1cCBjb3JyZWN0bHkuIFNlZSB0aGUKICAgIFtkZWZpbmluZyByZWxhdGlvbnNoaXBzXShodHRwczovL2d1aWRlcy5lbWJlcmpzLmNvbS9jdXJyZW50L21vZGVscy9yZWxhdGlvbnNoaXBzKQogICAgc2VjdGlvbiBvZiB0aGUgKipEZWZpbmluZyBNb2RlbHMqKiBndWlkZSBwYWdlLgoKICAgIFJlY29yZHMgd2l0aG91dCBhbiBgaWRgIHByb3BlcnR5IGFyZSBub3QgY29uc2lkZXJlZCBlbWJlZGRlZCByZWNvcmRzLCBtb2RlbAogICAgaW5zdGFuY2VzIG11c3QgaGF2ZSBhbiBgaWRgIHByb3BlcnR5IHRvIGJlIHVzZWQgd2l0aCBFbWJlciBEYXRhLgoKICAgICMjIyBFeGFtcGxlIEpTT04gcGF5bG9hZHMsIE1vZGVscyBhbmQgU2VyaWFsaXplcnMKCiAgICAqKldoZW4gY3VzdG9taXppbmcgYSBzZXJpYWxpemVyIGl0IGlzIGltcG9ydGFudCB0byBncm9rIHdoYXQgdGhlIGN1c3RvbWl6YXRpb25zCiAgICBhcmUuIFBsZWFzZSByZWFkIHRoZSBkb2NzIGZvciB0aGUgbWV0aG9kcyB0aGlzIG1peGluIHByb3ZpZGVzLCBpbiBjYXNlIHlvdSBuZWVkCiAgICB0byBtb2RpZnkgaXQgdG8gZml0IHlvdXIgc3BlY2lmaWMgbmVlZHMuKioKCiAgICBGb3IgZXhhbXBsZSwgcmV2aWV3IHRoZSBkb2NzIGZvciBlYWNoIG1ldGhvZCBvZiB0aGlzIG1peGluOgogICAgKiBbbm9ybWFsaXplXSgvZW1iZXItZGF0YS9yZWxlYXNlL2NsYXNzZXMvRW1iZWRkZWRSZWNvcmRzTWl4aW4vbWV0aG9kcy9ub3JtYWxpemU/YW5jaG9yPW5vcm1hbGl6ZSkKICAgICogW3NlcmlhbGl6ZUJlbG9uZ3NUb10oL2VtYmVyLWRhdGEvcmVsZWFzZS9jbGFzc2VzL0VtYmVkZGVkUmVjb3Jkc01peGluL21ldGhvZHMvc2VyaWFsaXplQmVsb25nc1RvP2FuY2hvcj1zZXJpYWxpemVCZWxvbmdzVG8pCiAgICAqIFtzZXJpYWxpemVIYXNNYW55XSgvZW1iZXItZGF0YS9yZWxlYXNlL2NsYXNzZXMvRW1iZWRkZWRSZWNvcmRzTWl4aW4vbWV0aG9kcy9zZXJpYWxpemVIYXNNYW55P2FuY2hvcj1zZXJpYWxpemVIYXNNYW55KQoKICAgIEBjbGFzcyBFbWJlZGRlZFJlY29yZHNNaXhpbgogICovCiAgdmFyIGVtYmVkZGVkUmVjb3Jkc01peGluID0gRW1iZXIuTWl4aW4uY3JlYXRlKHsKICAgIC8qKgogICAgICBOb3JtYWxpemUgdGhlIHJlY29yZCBhbmQgcmVjdXJzaXZlbHkgbm9ybWFsaXplL2V4dHJhY3QgYWxsIHRoZSBlbWJlZGRlZCByZWNvcmRzCiAgICAgIHdoaWxlIHB1c2hpbmcgdGhlbSBpbnRvIHRoZSBzdG9yZSBhcyB0aGV5IGFyZSBlbmNvdW50ZXJlZAogICAgICAgQSBwYXlsb2FkIHdpdGggYW4gYXR0ciBjb25maWd1cmVkIGZvciBlbWJlZGRlZCByZWNvcmRzIG5lZWRzIHRvIGJlIGV4dHJhY3RlZDoKICAgICAgIGBgYGpzCiAgICAgIHsKICAgICAgICAicG9zdCI6IHsKICAgICAgICAgICJpZCI6ICIxIgogICAgICAgICAgInRpdGxlIjogIlJhaWxzIGlzIG9tYWthc2UiLAogICAgICAgICAgImNvbW1lbnRzIjogW3sKICAgICAgICAgICAgImlkIjogIjEiLAogICAgICAgICAgICAiYm9keSI6ICJSYWlscyBpcyB1bmFnaSIKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgImlkIjogIjIiLAogICAgICAgICAgICAiYm9keSI6ICJPbWFrYXNlIE9fbyIKICAgICAgICAgIH1dCiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgIEBtZXRob2Qgbm9ybWFsaXplCiAgICAgQHBhcmFtIHtNb2RlbH0gdHlwZUNsYXNzCiAgICAgQHBhcmFtIHtPYmplY3R9IGhhc2ggdG8gYmUgbm9ybWFsaXplZAogICAgIEBwYXJhbSB7U3RyaW5nfSBwcm9wIHRoZSBoYXNoIGhhcyBiZWVuIHJlZmVyZW5jZWQgYnkKICAgICBAcmV0dXJuIHtPYmplY3R9IHRoZSBub3JtYWxpemVkIGhhc2gKICAgICoqLwogICAgbm9ybWFsaXplOiBmdW5jdGlvbiBub3JtYWxpemUodHlwZUNsYXNzLCBoYXNoLCBwcm9wKSB7CiAgICAgIHZhciBub3JtYWxpemVkSGFzaCA9IHRoaXMuX3N1cGVyKHR5cGVDbGFzcywgaGFzaCwgcHJvcCk7CgogICAgICByZXR1cm4gdGhpcy5fZXh0cmFjdEVtYmVkZGVkUmVjb3Jkcyh0aGlzLCB0aGlzLnN0b3JlLCB0eXBlQ2xhc3MsIG5vcm1hbGl6ZWRIYXNoKTsKICAgIH0sCiAgICBrZXlGb3JSZWxhdGlvbnNoaXA6IGZ1bmN0aW9uIGtleUZvclJlbGF0aW9uc2hpcChrZXksIHR5cGVDbGFzcywgbWV0aG9kKSB7CiAgICAgIGlmIChtZXRob2QgPT09ICdzZXJpYWxpemUnICYmIHRoaXMuaGFzU2VyaWFsaXplUmVjb3Jkc09wdGlvbihrZXkpIHx8IG1ldGhvZCA9PT0gJ2Rlc2VyaWFsaXplJyAmJiB0aGlzLmhhc0Rlc2VyaWFsaXplUmVjb3Jkc09wdGlvbihrZXkpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMua2V5Rm9yQXR0cmlidXRlKGtleSwgbWV0aG9kKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5fc3VwZXIoa2V5LCB0eXBlQ2xhc3MsIG1ldGhvZCkgfHwga2V5OwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBTZXJpYWxpemUgYGJlbG9uZ3NUb2AgcmVsYXRpb25zaGlwIHdoZW4gaXQgaXMgY29uZmlndXJlZCBhcyBhbiBlbWJlZGRlZCBvYmplY3QuCiAgICAgICBUaGlzIGV4YW1wbGUgb2YgYW4gYXV0aG9yIG1vZGVsIGJlbG9uZ3MgdG8gYSBwb3N0IG1vZGVsOgogICAgICAgYGBganMKICAgICAgaW1wb3J0IE1vZGVsLCB7IGF0dHIsIGJlbG9uZ3NUbyB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKICAgICAgIFBvc3QgPSBNb2RlbC5leHRlbmQoewogICAgICAgIHRpdGxlOiAgICBhdHRyKCdzdHJpbmcnKSwKICAgICAgICBib2R5OiAgICAgYXR0cignc3RyaW5nJyksCiAgICAgICAgYXV0aG9yOiAgIGJlbG9uZ3NUbygnYXV0aG9yJykKICAgICAgfSk7CiAgICAgICBBdXRob3IgPSBNb2RlbC5leHRlbmQoewogICAgICAgIG5hbWU6ICAgICBhdHRyKCdzdHJpbmcnKSwKICAgICAgICBwb3N0OiAgICAgYmVsb25nc1RvKCdwb3N0JykKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgVXNlIGEgY3VzdG9tICh0eXBlKSBzZXJpYWxpemVyIGZvciB0aGUgcG9zdCBtb2RlbCB0byBjb25maWd1cmUgZW1iZWRkZWQgYXV0aG9yCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvcG9zdC5qcwogICAgICBpbXBvcnQgUkVTVFNlcmlhbGl6ZXIsIHsgRW1iZWRkZWRSZWNvcmRzTWl4aW4gfSBmcm9tICdAZW1iZXItZGF0YS9zZXJpYWxpemVyL3Jlc3QnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKEVtYmVkZGVkUmVjb3Jkc01peGluLCB7CiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgIGF1dGhvcjogeyBlbWJlZGRlZDogJ2Fsd2F5cycgfQogICAgICAgIH0KICAgICAgfSkKICAgICAgYGBgCiAgICAgICBBIHBheWxvYWQgd2l0aCBhbiBhdHRyaWJ1dGUgY29uZmlndXJlZCBmb3IgZW1iZWRkZWQgcmVjb3JkcyBjYW4gc2VyaWFsaXplCiAgICAgIHRoZSByZWNvcmRzIHRvZ2V0aGVyIHVuZGVyIHRoZSByb290IGF0dHJpYnV0ZSdzIHBheWxvYWQ6CiAgICAgICBgYGBqcwogICAgICB7CiAgICAgICAgInBvc3QiOiB7CiAgICAgICAgICAiaWQiOiAiMSIKICAgICAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgICAgICJhdXRob3IiOiB7CiAgICAgICAgICAgICJpZCI6ICIyIgogICAgICAgICAgICAibmFtZSI6ICJkaGgiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBzZXJpYWxpemVCZWxvbmdzVG8KICAgICAgQHBhcmFtIHtTbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHBhcmFtIHtPYmplY3R9IGpzb24KICAgICAgQHBhcmFtIHtPYmplY3R9IHJlbGF0aW9uc2hpcAogICAgKi8KICAgIHNlcmlhbGl6ZUJlbG9uZ3NUbzogZnVuY3Rpb24gc2VyaWFsaXplQmVsb25nc1RvKHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApIHsKICAgICAgdmFyIGF0dHIgPSByZWxhdGlvbnNoaXAua2V5OwoKICAgICAgaWYgKHRoaXMubm9TZXJpYWxpemVPcHRpb25TcGVjaWZpZWQoYXR0cikpIHsKICAgICAgICB0aGlzLl9zdXBlcihzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKTsKCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgaW5jbHVkZUlkcyA9IHRoaXMuaGFzU2VyaWFsaXplSWRzT3B0aW9uKGF0dHIpOwogICAgICB2YXIgaW5jbHVkZVJlY29yZHMgPSB0aGlzLmhhc1NlcmlhbGl6ZVJlY29yZHNPcHRpb24oYXR0cik7CiAgICAgIHZhciBlbWJlZGRlZFNuYXBzaG90ID0gc25hcHNob3QuYmVsb25nc1RvKGF0dHIpOwoKICAgICAgaWYgKGluY2x1ZGVJZHMpIHsKICAgICAgICB2YXIgc2VyaWFsaXplZEtleSA9IHRoaXMuX2dldE1hcHBlZEtleShyZWxhdGlvbnNoaXAua2V5LCBzbmFwc2hvdC50eXBlKTsKCiAgICAgICAgaWYgKHNlcmlhbGl6ZWRLZXkgPT09IHJlbGF0aW9uc2hpcC5rZXkgJiYgdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXApIHsKICAgICAgICAgIHNlcmlhbGl6ZWRLZXkgPSB0aGlzLmtleUZvclJlbGF0aW9uc2hpcChyZWxhdGlvbnNoaXAua2V5LCByZWxhdGlvbnNoaXAua2luZCwgJ3NlcmlhbGl6ZScpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFlbWJlZGRlZFNuYXBzaG90KSB7CiAgICAgICAgICBqc29uW3NlcmlhbGl6ZWRLZXldID0gbnVsbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAganNvbltzZXJpYWxpemVkS2V5XSA9IGVtYmVkZGVkU25hcHNob3QuaWQ7CgogICAgICAgICAgaWYgKHJlbGF0aW9uc2hpcC5vcHRpb25zLnBvbHltb3JwaGljKSB7CiAgICAgICAgICAgIHRoaXMuc2VyaWFsaXplUG9seW1vcnBoaWNUeXBlKHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpbmNsdWRlUmVjb3JkcykgewogICAgICAgIHRoaXMuX3NlcmlhbGl6ZUVtYmVkZGVkQmVsb25nc1RvKHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApOwogICAgICB9CiAgICB9LAogICAgX3NlcmlhbGl6ZUVtYmVkZGVkQmVsb25nc1RvOiBmdW5jdGlvbiBfc2VyaWFsaXplRW1iZWRkZWRCZWxvbmdzVG8oc25hcHNob3QsIGpzb24sIHJlbGF0aW9uc2hpcCkgewogICAgICB2YXIgZW1iZWRkZWRTbmFwc2hvdCA9IHNuYXBzaG90LmJlbG9uZ3NUbyhyZWxhdGlvbnNoaXAua2V5KTsKCiAgICAgIHZhciBzZXJpYWxpemVkS2V5ID0gdGhpcy5fZ2V0TWFwcGVkS2V5KHJlbGF0aW9uc2hpcC5rZXksIHNuYXBzaG90LnR5cGUpOwoKICAgICAgaWYgKHNlcmlhbGl6ZWRLZXkgPT09IHJlbGF0aW9uc2hpcC5rZXkgJiYgdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXApIHsKICAgICAgICBzZXJpYWxpemVkS2V5ID0gdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXAocmVsYXRpb25zaGlwLmtleSwgcmVsYXRpb25zaGlwLmtpbmQsICdzZXJpYWxpemUnKTsKICAgICAgfQoKICAgICAgaWYgKCFlbWJlZGRlZFNuYXBzaG90KSB7CiAgICAgICAganNvbltzZXJpYWxpemVkS2V5XSA9IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAganNvbltzZXJpYWxpemVkS2V5XSA9IGVtYmVkZGVkU25hcHNob3Quc2VyaWFsaXplKHsKICAgICAgICAgIGluY2x1ZGVJZDogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIHRoaXMucmVtb3ZlRW1iZWRkZWRGb3JlaWduS2V5KHNuYXBzaG90LCBlbWJlZGRlZFNuYXBzaG90LCByZWxhdGlvbnNoaXAsIGpzb25bc2VyaWFsaXplZEtleV0pOwoKICAgICAgICBpZiAocmVsYXRpb25zaGlwLm9wdGlvbnMucG9seW1vcnBoaWMpIHsKICAgICAgICAgIHRoaXMuc2VyaWFsaXplUG9seW1vcnBoaWNUeXBlKHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAgU2VyaWFsaXplcyBgaGFzTWFueWAgcmVsYXRpb25zaGlwcyB3aGVuIGl0IGlzIGNvbmZpZ3VyZWQgYXMgZW1iZWRkZWQgb2JqZWN0cy4KICAgICAgIFRoaXMgZXhhbXBsZSBvZiBhIHBvc3QgbW9kZWwgaGFzIG1hbnkgY29tbWVudHM6CiAgICAgICBgYGBqcwogICAgICBpbXBvcnQgTW9kZWwsIHsgYXR0ciwgYmVsb25nc1RvLCBoYXNNYW55IH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogICAgICAgUG9zdCA9IE1vZGVsLmV4dGVuZCh7CiAgICAgICAgdGl0bGU6ICAgIGF0dHIoJ3N0cmluZycpLAogICAgICAgIGJvZHk6ICAgICBhdHRyKCdzdHJpbmcnKSwKICAgICAgICBjb21tZW50czogaGFzTWFueSgnY29tbWVudCcpCiAgICAgIH0pOwogICAgICAgQ29tbWVudCA9IE1vZGVsLmV4dGVuZCh7CiAgICAgICAgYm9keTogICAgIGF0dHIoJ3N0cmluZycpLAogICAgICAgIHBvc3Q6ICAgICBiZWxvbmdzVG8oJ3Bvc3QnKQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBVc2UgYSBjdXN0b20gKHR5cGUpIHNlcmlhbGl6ZXIgZm9yIHRoZSBwb3N0IG1vZGVsIHRvIGNvbmZpZ3VyZSBlbWJlZGRlZCBjb21tZW50cwogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICAgaW1wb3J0IFJFU1RTZXJpYWxpemVyLCB7IEVtYmVkZGVkUmVjb3Jkc01peGluIH0gZnJvbSAnQGVtYmVyLWRhdGEvc2VyaWFsaXplci9yZXN0JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJFU1RTZXJpYWxpemVyLmV4dGVuZChFbWJlZGRlZFJlY29yZHNNaXhpbiwgewogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICBjb21tZW50czogeyBlbWJlZGRlZDogJ2Fsd2F5cycgfQogICAgICAgIH0KICAgICAgfSkKICAgICAgYGBgCiAgICAgICBBIHBheWxvYWQgd2l0aCBhbiBhdHRyaWJ1dGUgY29uZmlndXJlZCBmb3IgZW1iZWRkZWQgcmVjb3JkcyBjYW4gc2VyaWFsaXplCiAgICAgIHRoZSByZWNvcmRzIHRvZ2V0aGVyIHVuZGVyIHRoZSByb290IGF0dHJpYnV0ZSdzIHBheWxvYWQ6CiAgICAgICBgYGBqcwogICAgICB7CiAgICAgICAgInBvc3QiOiB7CiAgICAgICAgICAiaWQiOiAiMSIKICAgICAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgICAgICJib2R5IjogIkkgd2FudCB0aGlzIGZvciBteSBPUk0sIEkgd2FudCB0aGF0IGZvciBteSB0ZW1wbGF0ZSBsYW5ndWFnZS4uLiIKICAgICAgICAgICJjb21tZW50cyI6IFt7CiAgICAgICAgICAgICJpZCI6ICIxIiwKICAgICAgICAgICAgImJvZHkiOiAiUmFpbHMgaXMgdW5hZ2kiCiAgICAgICAgICB9LCB7CiAgICAgICAgICAgICJpZCI6ICIyIiwKICAgICAgICAgICAgImJvZHkiOiAiT21ha2FzZSBPX28iCiAgICAgICAgICB9XQogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgIFRoZSBhdHRycyBvcHRpb25zIG9iamVjdCBjYW4gdXNlIG1vcmUgc3BlY2lmaWMgaW5zdHJ1Y3Rpb24gZm9yIGV4dHJhY3RpbmcgYW5kCiAgICAgIHNlcmlhbGl6aW5nLiBXaGVuIHNlcmlhbGl6aW5nLCBhbiBvcHRpb24gdG8gZW1iZWQgYGlkc2AsIGBpZHMtYW5kLXR5cGVzYCBvciBgcmVjb3Jkc2AgY2FuIGJlIHNldC4KICAgICAgV2hlbiBleHRyYWN0aW5nIHRoZSBvbmx5IG9wdGlvbiBpcyBgcmVjb3Jkc2AuCiAgICAgICBTbyBgeyBlbWJlZGRlZDogJ2Fsd2F5cycgfWAgaXMgc2hvcnRoYW5kIGZvcjoKICAgICAgYHsgc2VyaWFsaXplOiAncmVjb3JkcycsIGRlc2VyaWFsaXplOiAncmVjb3JkcycgfWAKICAgICAgIFRvIGVtYmVkIHRoZSBgaWRzYCBmb3IgYSByZWxhdGVkIG9iamVjdCAodXNpbmcgYSBoYXNNYW55IHJlbGF0aW9uc2hpcCk6CiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvcG9zdC5qcwogICAgICBpbXBvcnQgUkVTVFNlcmlhbGl6ZXIsIHsgRW1iZWRkZWRSZWNvcmRzTWl4aW4gfSBmcm9tICdAZW1iZXItZGF0YS9zZXJpYWxpemVyL3Jlc3QnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKEVtYmVkZGVkUmVjb3Jkc01peGluLCB7CiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgIGNvbW1lbnRzOiB7IHNlcmlhbGl6ZTogJ2lkcycsIGRlc2VyaWFsaXplOiAncmVjb3JkcycgfQogICAgICAgIH0KICAgICAgfSkKICAgICAgYGBgCiAgICAgICBgYGBqcwogICAgICB7CiAgICAgICAgInBvc3QiOiB7CiAgICAgICAgICAiaWQiOiAiMSIKICAgICAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgICAgICJib2R5IjogIkkgd2FudCB0aGlzIGZvciBteSBPUk0sIEkgd2FudCB0aGF0IGZvciBteSB0ZW1wbGF0ZSBsYW5ndWFnZS4uLiIKICAgICAgICAgICJjb21tZW50cyI6IFsiMSIsICIyIl0KICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICBUbyBlbWJlZCB0aGUgcmVsYXRpb25zaGlwIGFzIGEgY29sbGVjdGlvbiBvZiBvYmplY3RzIHdpdGggYGlkYCBhbmQgYHR5cGVgIGtleXMsIHNldAogICAgICBgaWRzLWFuZC10eXBlc2AgZm9yIHRoZSByZWxhdGVkIG9iamVjdC4KICAgICAgIFRoaXMgaXMgcGFydGljdWxhcmx5IHVzZWZ1bCBmb3IgcG9seW1vcnBoaWMgcmVsYXRpb25zaGlwcyB3aGVyZSByZWNvcmRzIGRvbid0IHNoYXJlCiAgICAgIHRoZSBzYW1lIHRhYmxlIGFuZCB0aGUgYGlkYCBpcyBub3QgZW5vdWdoIGluZm9ybWF0aW9uLgogICAgICAgRm9yIGV4YW1wbGUgaGF2aW5nIGEgdXNlciB0aGF0IGhhcyBtYW55IHBldHM6CiAgICAgICBgYGBqcwogICAgICBVc2VyID0gTW9kZWwuZXh0ZW5kKHsKICAgICAgICBuYW1lOiBhdHRyKCdzdHJpbmcnKSwKICAgICAgICBwZXRzOiBoYXNNYW55KCdwZXQnLCB7IHBvbHltb3JwaGljOiB0cnVlIH0pCiAgICAgIH0pOwogICAgICAgUGV0ID0gTW9kZWwuZXh0ZW5kKHsKICAgICAgICBuYW1lOiBhdHRyKCdzdHJpbmcnKSwKICAgICAgfSk7CiAgICAgICBDYXQgPSBQZXQuZXh0ZW5kKHsKICAgICAgICAvLyAuLi4KICAgICAgfSk7CiAgICAgICBQYXJyb3QgPSBQZXQuZXh0ZW5kKHsKICAgICAgICAvLyAuLi4KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3VzZXIuanMKICAgICAgaW1wb3J0IFJFU1RTZXJpYWxpemVyLCB7IEVtYmVkZGVkUmVjb3Jkc01peGluIH0gZnJvbSAnQGVtYmVyLWRhdGEvc2VyaWFsaXplci9yZXN0JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJFU1RTZXJpYWxpemVyLmV4dGVuZChFbWJlZGRlZFJlY29yZHNNaXhpbiwgewogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICBwZXRzOiB7IHNlcmlhbGl6ZTogJ2lkcy1hbmQtdHlwZXMnLCBkZXNlcmlhbGl6ZTogJ3JlY29yZHMnIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIGBgYGpzCiAgICAgIHsKICAgICAgICAidXNlciI6IHsKICAgICAgICAgICJpZCI6ICIxIgogICAgICAgICAgIm5hbWUiOiAiQmVydGluIE9zYm9ybmUiLAogICAgICAgICAgInBldHMiOiBbCiAgICAgICAgICAgIHsgImlkIjogIjEiLCAidHlwZSI6ICJDYXQiIH0sCiAgICAgICAgICAgIHsgImlkIjogIjEiLCAidHlwZSI6ICJQYXJyb3QifQogICAgICAgICAgXQogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgIEBtZXRob2Qgc2VyaWFsaXplSGFzTWFueQogICAgICBAcGFyYW0ge1NuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcGFyYW0ge09iamVjdH0ganNvbgogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwCiAgICAqLwogICAgc2VyaWFsaXplSGFzTWFueTogZnVuY3Rpb24gc2VyaWFsaXplSGFzTWFueShzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKSB7CiAgICAgIHZhciBhdHRyID0gcmVsYXRpb25zaGlwLmtleTsKCiAgICAgIGlmICh0aGlzLm5vU2VyaWFsaXplT3B0aW9uU3BlY2lmaWVkKGF0dHIpKSB7CiAgICAgICAgdGhpcy5fc3VwZXIoc25hcHNob3QsIGpzb24sIHJlbGF0aW9uc2hpcCk7CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuaGFzU2VyaWFsaXplSWRzT3B0aW9uKGF0dHIpKSB7CiAgICAgICAgdmFyIHNlcmlhbGl6ZWRLZXkgPSB0aGlzLl9nZXRNYXBwZWRLZXkocmVsYXRpb25zaGlwLmtleSwgc25hcHNob3QudHlwZSk7CgogICAgICAgIGlmIChzZXJpYWxpemVkS2V5ID09PSByZWxhdGlvbnNoaXAua2V5ICYmIHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKSB7CiAgICAgICAgICBzZXJpYWxpemVkS2V5ID0gdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXAocmVsYXRpb25zaGlwLmtleSwgcmVsYXRpb25zaGlwLmtpbmQsICdzZXJpYWxpemUnKTsKICAgICAgICB9CgogICAgICAgIGpzb25bc2VyaWFsaXplZEtleV0gPSBzbmFwc2hvdC5oYXNNYW55KGF0dHIsIHsKICAgICAgICAgIGlkczogdHJ1ZQogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHRoaXMuaGFzU2VyaWFsaXplUmVjb3Jkc09wdGlvbihhdHRyKSkgewogICAgICAgIHRoaXMuX3NlcmlhbGl6ZUVtYmVkZGVkSGFzTWFueShzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5oYXNTZXJpYWxpemVJZHNBbmRUeXBlc09wdGlvbihhdHRyKSkgewogICAgICAgICAgdGhpcy5fc2VyaWFsaXplSGFzTWFueUFzSWRzQW5kVHlwZXMoc25hcHNob3QsIGpzb24sIHJlbGF0aW9uc2hpcCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qCiAgICAgIFNlcmlhbGl6ZXMgYSBoYXNNYW55IHJlbGF0aW9uc2hpcCBhcyBhbiBhcnJheSBvZiBvYmplY3RzIGNvbnRhaW5pbmcgb25seSBgaWRgIGFuZCBgdHlwZWAKICAgICAga2V5cy4KICAgICAgVGhpcyBoYXMgaXRzIHVzZSBjYXNlIG9uIHBvbHltb3JwaGljIGhhc01hbnkgcmVsYXRpb25zaGlwcyB3aGVyZSB0aGUgc2VydmVyIGlzIG5vdCBzdG9yaW5nCiAgICAgIGFsbCByZWNvcmRzIGluIHRoZSBzYW1lIHRhYmxlIHVzaW5nIFNUSSwgYW5kIHRoZXJlZm9yZSB0aGUgYGlkYCBpcyBub3QgZW5vdWdoIGluZm9ybWF0aW9uCiAgICAgICBUT0RPOiBNYWtlIHRoZSBkZWZhdWx0IGluIEVtYmVyLWRhdGEgMy4wPz8KICAgICovCiAgICBfc2VyaWFsaXplSGFzTWFueUFzSWRzQW5kVHlwZXM6IGZ1bmN0aW9uIF9zZXJpYWxpemVIYXNNYW55QXNJZHNBbmRUeXBlcyhzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKSB7CiAgICAgIHZhciBzZXJpYWxpemVkS2V5ID0gdGhpcy5rZXlGb3JBdHRyaWJ1dGUocmVsYXRpb25zaGlwLmtleSwgJ3NlcmlhbGl6ZScpOwogICAgICB2YXIgaGFzTWFueSA9IHNuYXBzaG90Lmhhc01hbnkocmVsYXRpb25zaGlwLmtleSk7CiAgICAgIGpzb25bc2VyaWFsaXplZEtleV0gPSBFbWJlci5BKGhhc01hbnkpLm1hcChmdW5jdGlvbiAocmVjb3JkU25hcHNob3QpIHsKICAgICAgICAvLwogICAgICAgIC8vIEknbSBzdXJlIEknbSBiZWluZyB1dHRlcmx5IG5haXZlIGhlcmUuIFByb3BhYmx5IGlkIGlzIGEgY29uZmlndXJhdGUgcHJvcGVydHkgYW5kCiAgICAgICAgLy8gdHlwZSB0b28sIGFuZCB0aGUgbW9kZWxOYW1lIGhhcyB0byBiZSBub3JtYWxpemVkIHNvbWVob3cuCiAgICAgICAgLy8KICAgICAgICByZXR1cm4gewogICAgICAgICAgaWQ6IHJlY29yZFNuYXBzaG90LmlkLAogICAgICAgICAgdHlwZTogcmVjb3JkU25hcHNob3QubW9kZWxOYW1lCiAgICAgICAgfTsKICAgICAgfSk7CiAgICB9LAogICAgX3NlcmlhbGl6ZUVtYmVkZGVkSGFzTWFueTogZnVuY3Rpb24gX3NlcmlhbGl6ZUVtYmVkZGVkSGFzTWFueShzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKSB7CiAgICAgIHZhciBzZXJpYWxpemVkS2V5ID0gdGhpcy5fZ2V0TWFwcGVkS2V5KHJlbGF0aW9uc2hpcC5rZXksIHNuYXBzaG90LnR5cGUpOwoKICAgICAgaWYgKHNlcmlhbGl6ZWRLZXkgPT09IHJlbGF0aW9uc2hpcC5rZXkgJiYgdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXApIHsKICAgICAgICBzZXJpYWxpemVkS2V5ID0gdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXAocmVsYXRpb25zaGlwLmtleSwgcmVsYXRpb25zaGlwLmtpbmQsICdzZXJpYWxpemUnKTsKICAgICAgfQogICAgICBqc29uW3NlcmlhbGl6ZWRLZXldID0gdGhpcy5fZ2VuZXJhdGVTZXJpYWxpemVkSGFzTWFueShzbmFwc2hvdCwgcmVsYXRpb25zaGlwKTsKICAgIH0sCgogICAgLyoKICAgICAgUmV0dXJucyBhbiBhcnJheSBvZiBlbWJlZGRlZCByZWNvcmRzIHNlcmlhbGl6ZWQgdG8gSlNPTgogICAgKi8KICAgIF9nZW5lcmF0ZVNlcmlhbGl6ZWRIYXNNYW55OiBmdW5jdGlvbiBfZ2VuZXJhdGVTZXJpYWxpemVkSGFzTWFueShzbmFwc2hvdCwgcmVsYXRpb25zaGlwKSB7CiAgICAgIHZhciBoYXNNYW55ID0gc25hcHNob3QuaGFzTWFueShyZWxhdGlvbnNoaXAua2V5KTsKICAgICAgdmFyIG1hbnlBcnJheSA9IEVtYmVyLkEoaGFzTWFueSk7CiAgICAgIHZhciByZXQgPSBuZXcgQXJyYXkobWFueUFycmF5Lmxlbmd0aCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1hbnlBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBlbWJlZGRlZFNuYXBzaG90ID0gbWFueUFycmF5W2ldOwogICAgICAgIHZhciBlbWJlZGRlZEpzb24gPSBlbWJlZGRlZFNuYXBzaG90LnNlcmlhbGl6ZSh7CiAgICAgICAgICBpbmNsdWRlSWQ6IHRydWUKICAgICAgICB9KTsKICAgICAgICB0aGlzLnJlbW92ZUVtYmVkZGVkRm9yZWlnbktleShzbmFwc2hvdCwgZW1iZWRkZWRTbmFwc2hvdCwgcmVsYXRpb25zaGlwLCBlbWJlZGRlZEpzb24pOwogICAgICAgIHJldFtpXSA9IGVtYmVkZGVkSnNvbjsKICAgICAgfQoKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCgogICAgLyoqCiAgICAgIFdoZW4gc2VyaWFsaXppbmcgYW4gZW1iZWRkZWQgcmVjb3JkLCBtb2RpZnkgdGhlIHByb3BlcnR5IChpbiB0aGUgYEpTT05gIHBheWxvYWQpCiAgICAgIHRoYXQgcmVmZXJzIHRvIHRoZSBwYXJlbnQgcmVjb3JkIChmb3JlaWduIGtleSBmb3IgdGhlIHJlbGF0aW9uc2hpcCkuCiAgICAgICBTZXJpYWxpemluZyBhIGBiZWxvbmdzVG9gIHJlbGF0aW9uc2hpcCByZW1vdmVzIHRoZSBwcm9wZXJ0eSB0aGF0IHJlZmVycyB0byB0aGUKICAgICAgcGFyZW50IHJlY29yZAogICAgICAgU2VyaWFsaXppbmcgYSBgaGFzTWFueWAgcmVsYXRpb25zaGlwIGRvZXMgbm90IHJlbW92ZSB0aGUgcHJvcGVydHkgdGhhdCByZWZlcnMgdG8KICAgICAgdGhlIHBhcmVudCByZWNvcmQuCiAgICAgICBAbWV0aG9kIHJlbW92ZUVtYmVkZGVkRm9yZWlnbktleQogICAgICBAcGFyYW0ge1NuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcGFyYW0ge1NuYXBzaG90fSBlbWJlZGRlZFNuYXBzaG90CiAgICAgIEBwYXJhbSB7T2JqZWN0fSByZWxhdGlvbnNoaXAKICAgICAgQHBhcmFtIHtPYmplY3R9IGpzb24KICAgICovCiAgICByZW1vdmVFbWJlZGRlZEZvcmVpZ25LZXk6IGZ1bmN0aW9uIHJlbW92ZUVtYmVkZGVkRm9yZWlnbktleShzbmFwc2hvdCwgZW1iZWRkZWRTbmFwc2hvdCwgcmVsYXRpb25zaGlwLCBqc29uKSB7CiAgICAgIGlmIChyZWxhdGlvbnNoaXAua2luZCA9PT0gJ2JlbG9uZ3NUbycpIHsKICAgICAgICB2YXIgcGFyZW50UmVjb3JkID0gc25hcHNob3QudHlwZS5pbnZlcnNlRm9yKHJlbGF0aW9uc2hpcC5rZXksIHRoaXMuc3RvcmUpOwoKICAgICAgICBpZiAocGFyZW50UmVjb3JkKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IHBhcmVudFJlY29yZC5uYW1lOwogICAgICAgICAgdmFyIGVtYmVkZGVkU2VyaWFsaXplciA9IHRoaXMuc3RvcmUuc2VyaWFsaXplckZvcihlbWJlZGRlZFNuYXBzaG90Lm1vZGVsTmFtZSk7CiAgICAgICAgICB2YXIgcGFyZW50S2V5ID0gZW1iZWRkZWRTZXJpYWxpemVyLmtleUZvclJlbGF0aW9uc2hpcChuYW1lLCBwYXJlbnRSZWNvcmQua2luZCwgJ2Rlc2VyaWFsaXplJyk7CgogICAgICAgICAgaWYgKHBhcmVudEtleSkgewogICAgICAgICAgICBkZWxldGUganNvbltwYXJlbnRLZXldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvKmVsc2UgaWYgKHJlbGF0aW9uc2hpcC5raW5kID09PSAnaGFzTWFueScpIHsKICAgICAgcmV0dXJuOwogICAgICB9Ki8KCiAgICB9LAogICAgLy8gY2hlY2tzIGNvbmZpZyBmb3IgYXR0cnMgb3B0aW9uIHRvIGVtYmVkZGVkIChhbHdheXMpIC0gc2VyaWFsaXplIGFuZCBkZXNlcmlhbGl6ZQogICAgaGFzRW1iZWRkZWRBbHdheXNPcHRpb246IGZ1bmN0aW9uIGhhc0VtYmVkZGVkQWx3YXlzT3B0aW9uKGF0dHIpIHsKICAgICAgdmFyIG9wdGlvbiA9IHRoaXMuYXR0cnNPcHRpb24oYXR0cik7CiAgICAgIHJldHVybiBvcHRpb24gJiYgb3B0aW9uLmVtYmVkZGVkID09PSAnYWx3YXlzJzsKICAgIH0sCiAgICAvLyBjaGVja3MgY29uZmlnIGZvciBhdHRycyBvcHRpb24gdG8gc2VyaWFsaXplIGlkcwogICAgaGFzU2VyaWFsaXplUmVjb3Jkc09wdGlvbjogZnVuY3Rpb24gaGFzU2VyaWFsaXplUmVjb3Jkc09wdGlvbihhdHRyKSB7CiAgICAgIHZhciBhbHdheXNFbWJlZCA9IHRoaXMuaGFzRW1iZWRkZWRBbHdheXNPcHRpb24oYXR0cik7CiAgICAgIHZhciBvcHRpb24gPSB0aGlzLmF0dHJzT3B0aW9uKGF0dHIpOwogICAgICByZXR1cm4gYWx3YXlzRW1iZWQgfHwgb3B0aW9uICYmIG9wdGlvbi5zZXJpYWxpemUgPT09ICdyZWNvcmRzJzsKICAgIH0sCiAgICAvLyBjaGVja3MgY29uZmlnIGZvciBhdHRycyBvcHRpb24gdG8gc2VyaWFsaXplIHJlY29yZHMKICAgIGhhc1NlcmlhbGl6ZUlkc09wdGlvbjogZnVuY3Rpb24gaGFzU2VyaWFsaXplSWRzT3B0aW9uKGF0dHIpIHsKICAgICAgdmFyIG9wdGlvbiA9IHRoaXMuYXR0cnNPcHRpb24oYXR0cik7CiAgICAgIHJldHVybiBvcHRpb24gJiYgKG9wdGlvbi5zZXJpYWxpemUgPT09ICdpZHMnIHx8IG9wdGlvbi5zZXJpYWxpemUgPT09ICdpZCcpOwogICAgfSwKICAgIC8vIGNoZWNrcyBjb25maWcgZm9yIGF0dHJzIG9wdGlvbiB0byBzZXJpYWxpemUgcmVjb3JkcyBhcyBvYmplY3RzIGNvbnRhaW5pbmcgaWQgYW5kIHR5cGVzCiAgICBoYXNTZXJpYWxpemVJZHNBbmRUeXBlc09wdGlvbjogZnVuY3Rpb24gaGFzU2VyaWFsaXplSWRzQW5kVHlwZXNPcHRpb24oYXR0cikgewogICAgICB2YXIgb3B0aW9uID0gdGhpcy5hdHRyc09wdGlvbihhdHRyKTsKICAgICAgcmV0dXJuIG9wdGlvbiAmJiAob3B0aW9uLnNlcmlhbGl6ZSA9PT0gJ2lkcy1hbmQtdHlwZXMnIHx8IG9wdGlvbi5zZXJpYWxpemUgPT09ICdpZC1hbmQtdHlwZScpOwogICAgfSwKICAgIC8vIGNoZWNrcyBjb25maWcgZm9yIGF0dHJzIG9wdGlvbiB0byBzZXJpYWxpemUgcmVjb3JkcwogICAgbm9TZXJpYWxpemVPcHRpb25TcGVjaWZpZWQ6IGZ1bmN0aW9uIG5vU2VyaWFsaXplT3B0aW9uU3BlY2lmaWVkKGF0dHIpIHsKICAgICAgdmFyIG9wdGlvbiA9IHRoaXMuYXR0cnNPcHRpb24oYXR0cik7CiAgICAgIHJldHVybiAhKG9wdGlvbiAmJiAob3B0aW9uLnNlcmlhbGl6ZSB8fCBvcHRpb24uZW1iZWRkZWQpKTsKICAgIH0sCiAgICAvLyBjaGVja3MgY29uZmlnIGZvciBhdHRycyBvcHRpb24gdG8gZGVzZXJpYWxpemUgcmVjb3JkcwogICAgLy8gYSBkZWZpbmVkIG9wdGlvbiBvYmplY3QgZm9yIGEgcmVzb3VyY2UgaXMgdHJlYXRlZCB0aGUgc2FtZSBhcwogICAgLy8gYGRlc2VyaWFsaXplOiAncmVjb3JkcydgCiAgICBoYXNEZXNlcmlhbGl6ZVJlY29yZHNPcHRpb246IGZ1bmN0aW9uIGhhc0Rlc2VyaWFsaXplUmVjb3Jkc09wdGlvbihhdHRyKSB7CiAgICAgIHZhciBhbHdheXNFbWJlZCA9IHRoaXMuaGFzRW1iZWRkZWRBbHdheXNPcHRpb24oYXR0cik7CiAgICAgIHZhciBvcHRpb24gPSB0aGlzLmF0dHJzT3B0aW9uKGF0dHIpOwogICAgICByZXR1cm4gYWx3YXlzRW1iZWQgfHwgb3B0aW9uICYmIG9wdGlvbi5kZXNlcmlhbGl6ZSA9PT0gJ3JlY29yZHMnOwogICAgfSwKICAgIGF0dHJzT3B0aW9uOiBmdW5jdGlvbiBhdHRyc09wdGlvbihhdHRyKSB7CiAgICAgIHZhciBhdHRycyA9IHRoaXMuZ2V0KCdhdHRycycpOwogICAgICByZXR1cm4gYXR0cnMgJiYgKGF0dHJzW0VtYmVyLlN0cmluZy5jYW1lbGl6ZShhdHRyKV0gfHwgYXR0cnNbYXR0cl0pOwogICAgfSwKCiAgICAvKioKICAgICBAbWV0aG9kIF9leHRyYWN0RW1iZWRkZWRSZWNvcmRzCiAgICAgQHByaXZhdGUKICAgICovCiAgICBfZXh0cmFjdEVtYmVkZGVkUmVjb3JkczogZnVuY3Rpb24gX2V4dHJhY3RFbWJlZGRlZFJlY29yZHMoc2VyaWFsaXplciwgc3RvcmUsIHR5cGVDbGFzcywgcGFydGlhbCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdHlwZUNsYXNzLmVhY2hSZWxhdGlvbnNoaXAoZnVuY3Rpb24gKGtleSwgcmVsYXRpb25zaGlwKSB7CiAgICAgICAgaWYgKHNlcmlhbGl6ZXIuaGFzRGVzZXJpYWxpemVSZWNvcmRzT3B0aW9uKGtleSkpIHsKICAgICAgICAgIGlmIChyZWxhdGlvbnNoaXAua2luZCA9PT0gJ2hhc01hbnknKSB7CiAgICAgICAgICAgIF90aGlzLl9leHRyYWN0RW1iZWRkZWRIYXNNYW55KHN0b3JlLCBrZXksIHBhcnRpYWwsIHJlbGF0aW9uc2hpcCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHJlbGF0aW9uc2hpcC5raW5kID09PSAnYmVsb25nc1RvJykgewogICAgICAgICAgICBfdGhpcy5fZXh0cmFjdEVtYmVkZGVkQmVsb25nc1RvKHN0b3JlLCBrZXksIHBhcnRpYWwsIHJlbGF0aW9uc2hpcCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHBhcnRpYWw7CiAgICB9LAoKICAgIC8qKgogICAgIEBtZXRob2QgX2V4dHJhY3RFbWJlZGRlZEhhc01hbnkKICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9leHRyYWN0RW1iZWRkZWRIYXNNYW55OiBmdW5jdGlvbiBfZXh0cmFjdEVtYmVkZGVkSGFzTWFueShzdG9yZSwga2V5LCBoYXNoLCByZWxhdGlvbnNoaXBNZXRhKSB7CiAgICAgIHZhciByZWxhdGlvbnNoaXBIYXNoID0gRW1iZXIuZ2V0KGhhc2gsICJkYXRhLnJlbGF0aW9uc2hpcHMuIiArIGtleSArICIuZGF0YSIpOwoKICAgICAgaWYgKCFyZWxhdGlvbnNoaXBIYXNoKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgaGFzTWFueSA9IG5ldyBBcnJheShyZWxhdGlvbnNoaXBIYXNoLmxlbmd0aCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlbGF0aW9uc2hpcEhhc2gubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgaXRlbSA9IHJlbGF0aW9uc2hpcEhhc2hbaV07CgogICAgICAgIHZhciBfdGhpcyRfbm9ybWFsaXplRW1iZWQgPSB0aGlzLl9ub3JtYWxpemVFbWJlZGRlZFJlbGF0aW9uc2hpcChzdG9yZSwgcmVsYXRpb25zaGlwTWV0YSwgaXRlbSksCiAgICAgICAgICAgIGRhdGEgPSBfdGhpcyRfbm9ybWFsaXplRW1iZWQuZGF0YSwKICAgICAgICAgICAgaW5jbHVkZWQgPSBfdGhpcyRfbm9ybWFsaXplRW1iZWQuaW5jbHVkZWQ7CgogICAgICAgIGhhc2guaW5jbHVkZWQgPSBoYXNoLmluY2x1ZGVkIHx8IFtdOwogICAgICAgIGhhc2guaW5jbHVkZWQucHVzaChkYXRhKTsKCiAgICAgICAgaWYgKGluY2x1ZGVkKSB7CiAgICAgICAgICB2YXIgX2hhc2gkaW5jbHVkZWQ7CgogICAgICAgICAgKF9oYXNoJGluY2x1ZGVkID0gaGFzaC5pbmNsdWRlZCkucHVzaC5hcHBseShfaGFzaCRpbmNsdWRlZCwgaW5jbHVkZWQpOwogICAgICAgIH0KCiAgICAgICAgaGFzTWFueVtpXSA9IHsKICAgICAgICAgIGlkOiBkYXRhLmlkLAogICAgICAgICAgdHlwZTogZGF0YS50eXBlCiAgICAgICAgfTsKICAgICAgfQoKICAgICAgdmFyIHJlbGF0aW9uc2hpcCA9IHsKICAgICAgICBkYXRhOiBoYXNNYW55CiAgICAgIH07CiAgICAgIEVtYmVyLnNldChoYXNoLCAiZGF0YS5yZWxhdGlvbnNoaXBzLiIgKyBrZXksIHJlbGF0aW9uc2hpcCk7CiAgICB9LAoKICAgIC8qKgogICAgIEBtZXRob2QgX2V4dHJhY3RFbWJlZGRlZEJlbG9uZ3NUbwogICAgIEBwcml2YXRlCiAgICAqLwogICAgX2V4dHJhY3RFbWJlZGRlZEJlbG9uZ3NUbzogZnVuY3Rpb24gX2V4dHJhY3RFbWJlZGRlZEJlbG9uZ3NUbyhzdG9yZSwga2V5LCBoYXNoLCByZWxhdGlvbnNoaXBNZXRhKSB7CiAgICAgIHZhciByZWxhdGlvbnNoaXBIYXNoID0gRW1iZXIuZ2V0KGhhc2gsICJkYXRhLnJlbGF0aW9uc2hpcHMuIiArIGtleSArICIuZGF0YSIpOwoKICAgICAgaWYgKCFyZWxhdGlvbnNoaXBIYXNoKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgX3RoaXMkX25vcm1hbGl6ZUVtYmVkMiA9IHRoaXMuX25vcm1hbGl6ZUVtYmVkZGVkUmVsYXRpb25zaGlwKHN0b3JlLCByZWxhdGlvbnNoaXBNZXRhLCByZWxhdGlvbnNoaXBIYXNoKSwKICAgICAgICAgIGRhdGEgPSBfdGhpcyRfbm9ybWFsaXplRW1iZWQyLmRhdGEsCiAgICAgICAgICBpbmNsdWRlZCA9IF90aGlzJF9ub3JtYWxpemVFbWJlZDIuaW5jbHVkZWQ7CgogICAgICBoYXNoLmluY2x1ZGVkID0gaGFzaC5pbmNsdWRlZCB8fCBbXTsKICAgICAgaGFzaC5pbmNsdWRlZC5wdXNoKGRhdGEpOwoKICAgICAgaWYgKGluY2x1ZGVkKSB7CiAgICAgICAgdmFyIF9oYXNoJGluY2x1ZGVkMjsKCiAgICAgICAgKF9oYXNoJGluY2x1ZGVkMiA9IGhhc2guaW5jbHVkZWQpLnB1c2guYXBwbHkoX2hhc2gkaW5jbHVkZWQyLCBpbmNsdWRlZCk7CiAgICAgIH0KCiAgICAgIHZhciBiZWxvbmdzVG8gPSB7CiAgICAgICAgaWQ6IGRhdGEuaWQsCiAgICAgICAgdHlwZTogZGF0YS50eXBlCiAgICAgIH07CiAgICAgIHZhciByZWxhdGlvbnNoaXAgPSB7CiAgICAgICAgZGF0YTogYmVsb25nc1RvCiAgICAgIH07CiAgICAgIEVtYmVyLnNldChoYXNoLCAiZGF0YS5yZWxhdGlvbnNoaXBzLiIgKyBrZXksIHJlbGF0aW9uc2hpcCk7CiAgICB9LAoKICAgIC8qKgogICAgIEBtZXRob2QgX25vcm1hbGl6ZUVtYmVkZGVkUmVsYXRpb25zaGlwCiAgICAgQHByaXZhdGUKICAgICovCiAgICBfbm9ybWFsaXplRW1iZWRkZWRSZWxhdGlvbnNoaXA6IGZ1bmN0aW9uIF9ub3JtYWxpemVFbWJlZGRlZFJlbGF0aW9uc2hpcChzdG9yZSwgcmVsYXRpb25zaGlwTWV0YSwgcmVsYXRpb25zaGlwSGFzaCkgewogICAgICB2YXIgbW9kZWxOYW1lID0gcmVsYXRpb25zaGlwTWV0YS50eXBlOwoKICAgICAgaWYgKHJlbGF0aW9uc2hpcE1ldGEub3B0aW9ucy5wb2x5bW9ycGhpYykgewogICAgICAgIG1vZGVsTmFtZSA9IHJlbGF0aW9uc2hpcEhhc2gudHlwZTsKICAgICAgfQoKICAgICAgdmFyIG1vZGVsQ2xhc3MgPSBzdG9yZS5tb2RlbEZvcihtb2RlbE5hbWUpOwogICAgICB2YXIgc2VyaWFsaXplciA9IHN0b3JlLnNlcmlhbGl6ZXJGb3IobW9kZWxOYW1lKTsKICAgICAgcmV0dXJuIHNlcmlhbGl6ZXIubm9ybWFsaXplKG1vZGVsQ2xhc3MsIHJlbGF0aW9uc2hpcEhhc2gsIG51bGwpOwogICAgfSwKICAgIGlzRW1iZWRkZWRSZWNvcmRzTWl4aW46IHRydWUKICB9KTsKCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL3NlcmlhbGl6ZXIKICAqLwoKICAvKgogICAgQ2hlY2sgaWYgdGhlIHBhc3NlZCBtb2RlbCBoYXMgYSBgdHlwZWAgYXR0cmlidXRlIG9yIGEgcmVsYXRpb25zaGlwIG5hbWVkIGB0eXBlYC4KCiAgICBAbWV0aG9kIG1vZGVsSGFzQXR0cmlidXRlT3JSZWxhdGlvbnNoaXBOYW1lZFR5cGUKICAgIEBwYXJhbSBtb2RlbENsYXNzCiAgICovCiAgZnVuY3Rpb24gbW9kZWxIYXNBdHRyaWJ1dGVPclJlbGF0aW9uc2hpcE5hbWVkVHlwZShtb2RlbENsYXNzKSB7CiAgICByZXR1cm4gRW1iZXIuZ2V0KG1vZGVsQ2xhc3MsICdhdHRyaWJ1dGVzJykuaGFzKCd0eXBlJykgfHwgRW1iZXIuZ2V0KG1vZGVsQ2xhc3MsICdyZWxhdGlvbnNoaXBzQnlOYW1lJykuaGFzKCd0eXBlJyk7CiAgfQoKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyLWRhdGEvc2VyaWFsaXplcgogICovCgogIC8qKgogICAgVGhlIGBUcmFuc2Zvcm1gIGNsYXNzIGlzIHVzZWQgdG8gc2VyaWFsaXplIGFuZCBkZXNlcmlhbGl6ZSBtb2RlbAogICAgYXR0cmlidXRlcyB3aGVuIHRoZXkgYXJlIHNhdmVkIG9yIGxvYWRlZCBmcm9tIGFuCiAgICBhZGFwdGVyLiBTdWJjbGFzc2luZyBgVHJhbnNmb3JtYCBpcyB1c2VmdWwgZm9yIGNyZWF0aW5nIGN1c3RvbQogICAgYXR0cmlidXRlcy4gQWxsIHN1YmNsYXNzZXMgb2YgYFRyYW5zZm9ybWAgbXVzdCBpbXBsZW1lbnQgYQogICAgYHNlcmlhbGl6ZWAgYW5kIGEgYGRlc2VyaWFsaXplYCBtZXRob2QuCgogICAgRXhhbXBsZQoKICAgIGBgYGFwcC90cmFuc2Zvcm1zL3RlbXBlcmF0dXJlLmpzCiAgICBpbXBvcnQgVHJhbnNmb3JtIGZyb20gJ0BlbWJlci1kYXRhL3NlcmlhbGl6ZXIvdHJhbnNmb3JtJzsKCiAgICAvLyBDb252ZXJ0cyBjZW50aWdyYWRlIGluIHRoZSBKU09OIHRvIGZhaHJlbmhlaXQgaW4gdGhlIGFwcAogICAgZXhwb3J0IGRlZmF1bHQgVHJhbnNmb3JtLmV4dGVuZCh7CiAgICAgIGRlc2VyaWFsaXplKHNlcmlhbGl6ZWQsIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gKHNlcmlhbGl6ZWQgKiAgMS44KSArIDMyOwogICAgICB9LAoKICAgICAgc2VyaWFsaXplKGRlc2VyaWFsaXplZCwgb3B0aW9ucykgewogICAgICAgIHJldHVybiAoZGVzZXJpYWxpemVkIC0gMzIpIC8gMS44OwogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIFVzYWdlCgogICAgYGBgYXBwL21vZGVscy9yZXF1aXJlbWVudC5qcwogICAgaW1wb3J0IE1vZGVsLCB7IGF0dHIgfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CgogICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgbmFtZTogYXR0cignc3RyaW5nJyksCiAgICAgIHRlbXBlcmF0dXJlOiBhdHRyKCd0ZW1wZXJhdHVyZScpCiAgICB9KTsKICAgIGBgYAoKICAgIFRoZSBvcHRpb25zIHBhc3NlZCBpbnRvIHRoZSBgYXR0cmAgZnVuY3Rpb24gd2hlbiB0aGUgYXR0cmlidXRlIGlzCiAgICBkZWNsYXJlZCBvbiB0aGUgbW9kZWwgaXMgYWxzbyBhdmFpbGFibGUgaW4gdGhlIHRyYW5zZm9ybS4KCiAgICBgYGBhcHAvbW9kZWxzL3Bvc3QuanMKICAgIGltcG9ydCBNb2RlbCwgeyBhdHRyIH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwoKICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgIHRpdGxlOiBhdHRyKCdzdHJpbmcnKSwKICAgICAgbWFya2Rvd246IGF0dHIoJ21hcmtkb3duJywgewogICAgICAgIG1hcmtkb3duOiB7CiAgICAgICAgICBnZm06IGZhbHNlLAogICAgICAgICAgc2FuaXRpemU6IHRydWUKICAgICAgICB9CiAgICAgIH0pCiAgICB9KTsKICAgIGBgYAoKICAgIGBgYGFwcC90cmFuc2Zvcm1zL21hcmtkb3duLmpzCiAgICBpbXBvcnQgVHJhbnNmb3JtIGZyb20gJ0BlbWJlci1kYXRhL3NlcmlhbGl6ZXIvdHJhbnNmb3JtJzsKCiAgICBleHBvcnQgZGVmYXVsdCBUcmFuc2Zvcm0uZXh0ZW5kKHsKICAgICAgc2VyaWFsaXplKGRlc2VyaWFsaXplZCwgb3B0aW9ucykgewogICAgICAgIHJldHVybiBkZXNlcmlhbGl6ZWQucmF3OwogICAgICB9LAoKICAgICAgZGVzZXJpYWxpemUoc2VyaWFsaXplZCwgb3B0aW9ucykgewogICAgICAgIHZhciBtYXJrZG93bk9wdGlvbnMgPSBvcHRpb25zLm1hcmtkb3duIHx8IHt9OwoKICAgICAgICByZXR1cm4gbWFya2VkKHNlcmlhbGl6ZWQsIG1hcmtkb3duT3B0aW9ucyk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQGNsYXNzIFRyYW5zZm9ybQogICAqLwogIHZhciBUcmFuc2Zvcm0gPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIC8qKgogICAgICBXaGVuIGdpdmVuIGEgZGVzZXJpYWxpemVkIHZhbHVlIGZyb20gYSByZWNvcmQgYXR0cmlidXRlIHRoaXMKICAgICAgbWV0aG9kIG11c3QgcmV0dXJuIHRoZSBzZXJpYWxpemVkIHZhbHVlLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgeyBpc0VtcHR5IH0gZnJvbSAnQGVtYmVyL3V0aWxzJzsKICAgICAgIHNlcmlhbGl6ZShkZXNlcmlhbGl6ZWQsIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gaXNFbXB0eShkZXNlcmlhbGl6ZWQpID8gbnVsbCA6IE51bWJlcihkZXNlcmlhbGl6ZWQpOwogICAgICB9CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBzZXJpYWxpemUKICAgICAgQHBhcmFtIGRlc2VyaWFsaXplZCBUaGUgZGVzZXJpYWxpemVkIHZhbHVlCiAgICAgIEBwYXJhbSBvcHRpb25zIGhhc2ggb2Ygb3B0aW9ucyBwYXNzZWQgdG8gYGF0dHJgCiAgICAgIEByZXR1cm4gVGhlIHNlcmlhbGl6ZWQgdmFsdWUKICAgICovCiAgICBzZXJpYWxpemU6IG51bGwsCgogICAgLyoqCiAgICAgIFdoZW4gZ2l2ZW4gYSBzZXJpYWxpemVkIHZhbHVlIGZyb20gYSBKU09OIG9iamVjdCB0aGlzIG1ldGhvZCBtdXN0CiAgICAgIHJldHVybiB0aGUgZGVzZXJpYWxpemVkIHZhbHVlIGZvciB0aGUgcmVjb3JkIGF0dHJpYnV0ZS4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgZGVzZXJpYWxpemUoc2VyaWFsaXplZCwgb3B0aW9ucykgewogICAgICAgIHJldHVybiBlbXB0eShzZXJpYWxpemVkKSA/IG51bGwgOiBOdW1iZXIoc2VyaWFsaXplZCk7CiAgICAgIH0KICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGRlc2VyaWFsaXplCiAgICAgIEBwYXJhbSBzZXJpYWxpemVkIFRoZSBzZXJpYWxpemVkIHZhbHVlCiAgICAgIEBwYXJhbSBvcHRpb25zIGhhc2ggb2Ygb3B0aW9ucyBwYXNzZWQgdG8gYGF0dHJgCiAgICAgIEByZXR1cm4gVGhlIGRlc2VyaWFsaXplZCB2YWx1ZQogICAgKi8KICAgIGRlc2VyaWFsaXplOiBudWxsCiAgfSk7CgogIC8qKgogICAgQG1vZHVsZSBAZW1iZXItZGF0YS9zZXJpYWxpemVyCiAgKi8KCiAgLyoqCiAgICBUaGUgYEJvb2xlYW5UcmFuc2Zvcm1gIGNsYXNzIGlzIHVzZWQgdG8gc2VyaWFsaXplIGFuZCBkZXNlcmlhbGl6ZQogICAgYm9vbGVhbiBhdHRyaWJ1dGVzIG9uIEVtYmVyIERhdGEgcmVjb3JkIG9iamVjdHMuIFRoaXMgdHJhbnNmb3JtIGlzCiAgICB1c2VkIHdoZW4gYGJvb2xlYW5gIGlzIHBhc3NlZCBhcyB0aGUgdHlwZSBwYXJhbWV0ZXIgdG8gdGhlCiAgICBbYXR0cl0oL2VtYmVyLWRhdGEvcmVsZWFzZS9mdW5jdGlvbnMvQGVtYmVyLWRhdGElMkZtb2RlbC9hdHRyKSBmdW5jdGlvbi4KCiAgICBVc2FnZQoKICAgIGBgYGFwcC9tb2RlbHMvdXNlci5qcwogICAgaW1wb3J0IE1vZGVsLCB7IGF0dHIgfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CgogICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgaXNBZG1pbjogYXR0cignYm9vbGVhbicpLAogICAgICBuYW1lOiBhdHRyKCdzdHJpbmcnKSwKICAgICAgZW1haWw6IGF0dHIoJ3N0cmluZycpCiAgICB9KTsKICAgIGBgYAoKICAgIEJ5IGRlZmF1bHQsIHRoZSBib29sZWFuIHRyYW5zZm9ybSBvbmx5IGFsbG93cyBmb3IgdmFsdWVzIG9mIGB0cnVlYCBvcgogICAgYGZhbHNlYC4gWW91IGNhbiBvcHQgaW50byBhbGxvd2luZyBgbnVsbGAgdmFsdWVzIGZvcgogICAgYm9vbGVhbiBhdHRyaWJ1dGVzIHZpYSBgYXR0cignYm9vbGVhbicsIHsgYWxsb3dOdWxsOiB0cnVlIH0pYAoKICAgIGBgYGFwcC9tb2RlbHMvdXNlci5qcwogICAgaW1wb3J0IE1vZGVsLCB7IGF0dHIgfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CgogICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgZW1haWw6IGF0dHIoJ3N0cmluZycpLAogICAgICB1c2VybmFtZTogYXR0cignc3RyaW5nJyksCiAgICAgIHdhbnRzV2Vla2x5RW1haWw6IGF0dHIoJ2Jvb2xlYW4nLCB7IGFsbG93TnVsbDogdHJ1ZSB9KQogICAgfSk7CiAgICBgYGAKCiAgICBAY2xhc3MgQm9vbGVhblRyYW5zZm9ybQogICAgQGV4dGVuZHMgVHJhbnNmb3JtCiAgICovCgogIHZhciBib29sZWFuID0gVHJhbnNmb3JtLmV4dGVuZCh7CiAgICBkZXNlcmlhbGl6ZTogZnVuY3Rpb24gZGVzZXJpYWxpemUoc2VyaWFsaXplZCwgb3B0aW9ucykgewogICAgICBpZiAoRW1iZXIuaXNOb25lKHNlcmlhbGl6ZWQpICYmIG9wdGlvbnMuYWxsb3dOdWxsID09PSB0cnVlKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIHZhciB0eXBlID0gdHlwZW9mIHNlcmlhbGl6ZWQ7CgogICAgICBpZiAodHlwZSA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQ7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gL14odHJ1ZXx0fDEpJC9pLnRlc3Qoc2VyaWFsaXplZCk7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ251bWJlcicpIHsKICAgICAgICByZXR1cm4gc2VyaWFsaXplZCA9PT0gMTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0sCiAgICBzZXJpYWxpemU6IGZ1bmN0aW9uIHNlcmlhbGl6ZShkZXNlcmlhbGl6ZWQsIG9wdGlvbnMpIHsKICAgICAgaWYgKEVtYmVyLmlzTm9uZShkZXNlcmlhbGl6ZWQpICYmIG9wdGlvbnMuYWxsb3dOdWxsID09PSB0cnVlKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIHJldHVybiBCb29sZWFuKGRlc2VyaWFsaXplZCk7CiAgICB9CiAgfSk7CgogIC8qKgogICAgQG1vZHVsZSBAZW1iZXItZGF0YS9zZXJpYWxpemVyCiAgKi8KCiAgLyoqCiAgIFRoZSBgRGF0ZVRyYW5zZm9ybWAgY2xhc3MgaXMgdXNlZCB0byBzZXJpYWxpemUgYW5kIGRlc2VyaWFsaXplCiAgIGRhdGUgYXR0cmlidXRlcyBvbiBFbWJlciBEYXRhIHJlY29yZCBvYmplY3RzLiBUaGlzIHRyYW5zZm9ybSBpcyB1c2VkCiAgIHdoZW4gYGRhdGVgIGlzIHBhc3NlZCBhcyB0aGUgdHlwZSBwYXJhbWV0ZXIgdG8gdGhlCiAgIFthdHRyXSgvZW1iZXItZGF0YS9yZWxlYXNlL2Z1bmN0aW9ucy9AZW1iZXItZGF0YSUyRm1vZGVsL2F0dHIpIGZ1bmN0aW9uLiBJdCB1c2VzIHRoZSBbYElTTyA4NjAxYF0oaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSVNPXzg2MDEpCiAgIHN0YW5kYXJkLgoKICAgYGBgYXBwL21vZGVscy9zY29yZS5qcwogICBpbXBvcnQgTW9kZWwsIHsgYXR0ciwgYmVsb25nc1RvIH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwoKICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgdmFsdWU6IGF0dHIoJ251bWJlcicpLAogICAgICBwbGF5ZXI6IGJlbG9uZ3NUbygncGxheWVyJyksCiAgICAgIGRhdGU6IGF0dHIoJ2RhdGUnKQogICAgfSk7CiAgIGBgYAoKICAgQGNsYXNzIERhdGVUcmFuc2Zvcm0KICAgQGV4dGVuZHMgVHJhbnNmb3JtCiAgICovCgogIHZhciBkYXRlID0gVHJhbnNmb3JtLmV4dGVuZCh7CiAgICBkZXNlcmlhbGl6ZTogZnVuY3Rpb24gZGVzZXJpYWxpemUoc2VyaWFsaXplZCkgewogICAgICB2YXIgdHlwZSA9IHR5cGVvZiBzZXJpYWxpemVkOwoKICAgICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdmFyIG9mZnNldCA9IHNlcmlhbGl6ZWQuaW5kZXhPZignKycpOwoKICAgICAgICBpZiAob2Zmc2V0ICE9PSAtMSAmJiBzZXJpYWxpemVkLmxlbmd0aCAtIDUgPT09IG9mZnNldCkgewogICAgICAgICAgb2Zmc2V0ICs9IDM7CiAgICAgICAgICByZXR1cm4gbmV3IERhdGUoc2VyaWFsaXplZC5zbGljZSgwLCBvZmZzZXQpICsgJzonICsgc2VyaWFsaXplZC5zbGljZShvZmZzZXQpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBuZXcgRGF0ZShzZXJpYWxpemVkKTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbnVtYmVyJykgewogICAgICAgIHJldHVybiBuZXcgRGF0ZShzZXJpYWxpemVkKTsKICAgICAgfSBlbHNlIGlmIChzZXJpYWxpemVkID09PSBudWxsIHx8IHNlcmlhbGl6ZWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vIGlmIHRoZSB2YWx1ZSBpcyBudWxsIHJldHVybiBudWxsCiAgICAgICAgLy8gaWYgdGhlIHZhbHVlIGlzIG5vdCBwcmVzZW50IGluIHRoZSBkYXRhIHJldHVybiB1bmRlZmluZWQKICAgICAgICByZXR1cm4gc2VyaWFsaXplZDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfSwKICAgIHNlcmlhbGl6ZTogZnVuY3Rpb24gc2VyaWFsaXplKGRhdGUpIHsKICAgICAgaWYgKGRhdGUgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihkYXRlKSkgewogICAgICAgIHJldHVybiBkYXRlLnRvSVNPU3RyaW5nKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgIH0KICB9KTsKCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL3NlcmlhbGl6ZXIKICAqLwoKICBmdW5jdGlvbiBpc051bWJlcih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09PSB2YWx1ZSAmJiB2YWx1ZSAhPT0gSW5maW5pdHkgJiYgdmFsdWUgIT09IC1JbmZpbml0eTsKICB9CiAgLyoqCiAgICBUaGUgYE51bWJlclRyYW5zZm9ybWAgY2xhc3MgaXMgdXNlZCB0byBzZXJpYWxpemUgYW5kIGRlc2VyaWFsaXplCiAgICBudW1lcmljIGF0dHJpYnV0ZXMgb24gRW1iZXIgRGF0YSByZWNvcmQgb2JqZWN0cy4gVGhpcyB0cmFuc2Zvcm0gaXMKICAgIHVzZWQgd2hlbiBgbnVtYmVyYCBpcyBwYXNzZWQgYXMgdGhlIHR5cGUgcGFyYW1ldGVyIHRvIHRoZQogICAgW2F0dHJdKC9lbWJlci1kYXRhL3JlbGVhc2UvZnVuY3Rpb25zL0BlbWJlci1kYXRhJTJGbW9kZWwvYXR0cikgZnVuY3Rpb24uCgogICAgVXNhZ2UKCiAgICBgYGBhcHAvbW9kZWxzL3Njb3JlLmpzCiAgICBpbXBvcnQgTW9kZWwsIHsgYXR0ciwgYmVsb25nc1RvIH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwoKICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgIHZhbHVlOiBhdHRyKCdudW1iZXInKSwKICAgICAgcGxheWVyOiBiZWxvbmdzVG8oJ3BsYXllcicpLAogICAgICBkYXRlOiBhdHRyKCdkYXRlJykKICAgIH0pOwogICAgYGBgCgogICAgQGNsYXNzIE51bWJlclRyYW5zZm9ybQogICAgQGV4dGVuZHMgVHJhbnNmb3JtCiAgICovCgoKICB2YXIgbnVtYmVyID0gVHJhbnNmb3JtLmV4dGVuZCh7CiAgICBkZXNlcmlhbGl6ZTogZnVuY3Rpb24gZGVzZXJpYWxpemUoc2VyaWFsaXplZCkgewogICAgICB2YXIgdHJhbnNmb3JtZWQ7CgogICAgICBpZiAoc2VyaWFsaXplZCA9PT0gJycgfHwgc2VyaWFsaXplZCA9PT0gbnVsbCB8fCBzZXJpYWxpemVkID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICB0cmFuc2Zvcm1lZCA9IE51bWJlcihzZXJpYWxpemVkKTsKICAgICAgICByZXR1cm4gaXNOdW1iZXIodHJhbnNmb3JtZWQpID8gdHJhbnNmb3JtZWQgOiBudWxsOwogICAgICB9CiAgICB9LAogICAgc2VyaWFsaXplOiBmdW5jdGlvbiBzZXJpYWxpemUoZGVzZXJpYWxpemVkKSB7CiAgICAgIHZhciB0cmFuc2Zvcm1lZDsKCiAgICAgIGlmIChkZXNlcmlhbGl6ZWQgPT09ICcnIHx8IGRlc2VyaWFsaXplZCA9PT0gbnVsbCB8fCBkZXNlcmlhbGl6ZWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9IGVsc2UgewogICAgICAgIHRyYW5zZm9ybWVkID0gTnVtYmVyKGRlc2VyaWFsaXplZCk7CiAgICAgICAgcmV0dXJuIGlzTnVtYmVyKHRyYW5zZm9ybWVkKSA/IHRyYW5zZm9ybWVkIDogbnVsbDsKICAgICAgfQogICAgfQogIH0pOwoKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyLWRhdGEvc2VyaWFsaXplcgogICovCgogIC8qKgogICAgVGhlIGBTdHJpbmdUcmFuc2Zvcm1gIGNsYXNzIGlzIHVzZWQgdG8gc2VyaWFsaXplIGFuZCBkZXNlcmlhbGl6ZQogICAgc3RyaW5nIGF0dHJpYnV0ZXMgb24gRW1iZXIgRGF0YSByZWNvcmQgb2JqZWN0cy4gVGhpcyB0cmFuc2Zvcm0gaXMKICAgIHVzZWQgd2hlbiBgc3RyaW5nYCBpcyBwYXNzZWQgYXMgdGhlIHR5cGUgcGFyYW1ldGVyIHRvIHRoZQogICAgW2F0dHJdKC9lbWJlci1kYXRhL3JlbGVhc2UvZnVuY3Rpb25zL0BlbWJlci1kYXRhJTJGbW9kZWwvYXR0cikgZnVuY3Rpb24uCgogICAgVXNhZ2UKCiAgICBgYGBhcHAvbW9kZWxzL3VzZXIuanMKICAgIGltcG9ydCBNb2RlbCwgeyBhdHRyLCBiZWxvbmdzVG8gfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CgogICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgaXNBZG1pbjogYXR0cignYm9vbGVhbicpLAogICAgICBuYW1lOiBhdHRyKCdzdHJpbmcnKSwKICAgICAgZW1haWw6IGF0dHIoJ3N0cmluZycpCiAgICB9KTsKICAgIGBgYAoKICAgIEBjbGFzcyBTdHJpbmdUcmFuc2Zvcm0KICAgIEBleHRlbmRzIFRyYW5zZm9ybQogICAqLwoKICB2YXIgc3RyaW5nID0gVHJhbnNmb3JtLmV4dGVuZCh7CiAgICBkZXNlcmlhbGl6ZTogZnVuY3Rpb24gZGVzZXJpYWxpemUoc2VyaWFsaXplZCkgewogICAgICByZXR1cm4gRW1iZXIuaXNOb25lKHNlcmlhbGl6ZWQpID8gbnVsbCA6IFN0cmluZyhzZXJpYWxpemVkKTsKICAgIH0sCiAgICBzZXJpYWxpemU6IGZ1bmN0aW9uIHNlcmlhbGl6ZShkZXNlcmlhbGl6ZWQpIHsKICAgICAgcmV0dXJuIEVtYmVyLmlzTm9uZShkZXNlcmlhbGl6ZWQpID8gbnVsbCA6IFN0cmluZyhkZXNlcmlhbGl6ZWQpOwogICAgfQogIH0pOwoKICBleHBvcnRzLkJvb2xlYW5UcmFuc2Zvcm0gPSBib29sZWFuOwogIGV4cG9ydHMuRGF0ZVRyYW5zZm9ybSA9IGRhdGU7CiAgZXhwb3J0cy5FbWJlZGRlZFJlY29yZHNNaXhpbiA9IGVtYmVkZGVkUmVjb3Jkc01peGluOwogIGV4cG9ydHMuTnVtYmVyVHJhbnNmb3JtID0gbnVtYmVyOwogIGV4cG9ydHMuU3RyaW5nVHJhbnNmb3JtID0gc3RyaW5nOwogIGV4cG9ydHMuVHJhbnNmb3JtID0gVHJhbnNmb3JtOwogIGV4cG9ydHMubW9kZWxIYXNBdHRyaWJ1dGVPclJlbGF0aW9uc2hpcE5hbWVkVHlwZSA9IG1vZGVsSGFzQXR0cmlidXRlT3JSZWxhdGlvbnNoaXBOYW1lZFR5cGU7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsgdmFsdWU6IHRydWUgfSk7Cgp9KTsKCjtkZWZpbmUoIkBlbWJlci1kYXRhL3NlcmlhbGl6ZXIvaW5kZXgiLCBbImV4cG9ydHMiXSwgZnVuY3Rpb24gKF9leHBvcnRzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICAgIGBTZXJpYWxpemVyYCBpcyBhbiBhYnN0cmFjdCBiYXNlIGNsYXNzIHRoYXQgeW91IHNob3VsZCBvdmVycmlkZSBpbiB5b3VyCiAgICBhcHBsaWNhdGlvbiB0byBjdXN0b21pemUgaXQgZm9yIHlvdXIgYmFja2VuZC4gVGhlIG1pbmltdW0gc2V0IG9mIG1ldGhvZHMKICAgIHRoYXQgeW91IHNob3VsZCBpbXBsZW1lbnQgaXM6CiAgCiAgICAgICogYG5vcm1hbGl6ZVJlc3BvbnNlKClgCiAgICAgICogYHNlcmlhbGl6ZSgpYAogIAogICAgQW5kIHlvdSBjYW4gb3B0aW9uYWxseSBvdmVycmlkZSB0aGUgZm9sbG93aW5nIG1ldGhvZHM6CiAgCiAgICAgICogYG5vcm1hbGl6ZSgpYAogIAogICAgRm9yIGFuIGV4YW1wbGUgaW1wbGVtZW50YXRpb24sIHNlZQogICAgW0pTT05TZXJpYWxpemVyXShKU09OU2VyaWFsaXplciksIHRoZSBpbmNsdWRlZCBKU09OIHNlcmlhbGl6ZXIuCiAgCiAgICBAY2xhc3MgU2VyaWFsaXplcgogICAgQGV4dGVuZHMgRW1iZXJPYmplY3QKICAqLwogIHZhciBfZGVmYXVsdCA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgLyoqCiAgICAgIFRoZSBgc3RvcmVgIHByb3BlcnR5IGlzIHRoZSBhcHBsaWNhdGlvbidzIGBzdG9yZWAgdGhhdCBjb250YWlucwogICAgICBhbGwgcmVjb3Jkcy4gSXQgY2FuIGJlIHVzZWQgdG8gbG9vayB1cCBzZXJpYWxpemVycyBmb3Igb3RoZXIgbW9kZWwKICAgICAgdHlwZXMgdGhhdCBtYXkgYmUgbmVzdGVkIGluc2lkZSB0aGUgcGF5bG9hZCByZXNwb25zZS4KICAgICAgIEV4YW1wbGU6CiAgICAgICBgYGBqcwogICAgICBTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgZXh0cmFjdFJlbGF0aW9uc2hpcChyZWxhdGlvbnNoaXBNb2RlbE5hbWUsIHJlbGF0aW9uc2hpcEhhc2gpIHsKICAgICAgICAgIHZhciBtb2RlbENsYXNzID0gdGhpcy5zdG9yZS5tb2RlbEZvcihyZWxhdGlvbnNoaXBNb2RlbE5hbWUpOwogICAgICAgICAgdmFyIHJlbGF0aW9uc2hpcFNlcmlhbGl6ZXIgPSB0aGlzLnN0b3JlLnNlcmlhbGl6ZXJGb3IocmVsYXRpb25zaGlwTW9kZWxOYW1lKTsKICAgICAgICAgIHJldHVybiByZWxhdGlvbnNoaXBTZXJpYWxpemVyLm5vcm1hbGl6ZShtb2RlbENsYXNzLCByZWxhdGlvbnNoaXBIYXNoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBwcm9wZXJ0eSBzdG9yZQogICAgICBAdHlwZSB7U3RvcmV9CiAgICAgIEBwdWJsaWMKICAgICovCgogICAgLyoqCiAgICAgIFRoZSBgbm9ybWFsaXplUmVzcG9uc2VgIG1ldGhvZCBpcyB1c2VkIHRvIG5vcm1hbGl6ZSBhIHBheWxvYWQgZnJvbSB0aGUKICAgICAgc2VydmVyIHRvIGEgSlNPTi1BUEkgRG9jdW1lbnQuCiAgICAgICBodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0LyNkb2N1bWVudC1zdHJ1Y3R1cmUKICAgICAgIEV4YW1wbGU6CiAgICAgICBgYGBqcwogICAgICBTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgbm9ybWFsaXplUmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgICAgIGlmIChyZXF1ZXN0VHlwZSA9PT0gJ2ZpbmRSZWNvcmQnKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZShwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gcGF5bG9hZC5yZWR1Y2UoZnVuY3Rpb24oZG9jdW1lbnRIYXNoLCBpdGVtKSB7CiAgICAgICAgICAgICAgbGV0IHsgZGF0YSwgaW5jbHVkZWQgfSA9IHRoaXMubm9ybWFsaXplKHByaW1hcnlNb2RlbENsYXNzLCBpdGVtKTsKICAgICAgICAgICAgICBkb2N1bWVudEhhc2guaW5jbHVkZWQucHVzaCguLi5pbmNsdWRlZCk7CiAgICAgICAgICAgICAgZG9jdW1lbnRIYXNoLmRhdGEucHVzaChkYXRhKTsKICAgICAgICAgICAgICByZXR1cm4gZG9jdW1lbnRIYXNoOwogICAgICAgICAgICB9LCB7IGRhdGE6IFtdLCBpbmNsdWRlZDogW10gfSkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBub3JtYWxpemVSZXNwb25zZQogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge01vZGVsfSBwcmltYXJ5TW9kZWxDbGFzcwogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IGlkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSByZXF1ZXN0VHlwZQogICAgICBAcmV0dXJuIHtPYmplY3R9IEpTT04tQVBJIERvY3VtZW50CiAgICAqLwogICAgbm9ybWFsaXplUmVzcG9uc2U6IG51bGwsCgogICAgLyoqCiAgICAgIFRoZSBgc2VyaWFsaXplYCBtZXRob2QgaXMgdXNlZCB3aGVuIGEgcmVjb3JkIGlzIHNhdmVkIGluIG9yZGVyIHRvIGNvbnZlcnQKICAgICAgdGhlIHJlY29yZCBpbnRvIHRoZSBmb3JtIHRoYXQgeW91ciBleHRlcm5hbCBkYXRhIHNvdXJjZSBleHBlY3RzLgogICAgICAgYHNlcmlhbGl6ZWAgdGFrZXMgYW4gb3B0aW9uYWwgYG9wdGlvbnNgIGhhc2ggd2l0aCBhIHNpbmdsZSBvcHRpb246CiAgICAgICAtIGBpbmNsdWRlSWRgOiBJZiB0aGlzIGlzIGB0cnVlYCwgYHNlcmlhbGl6ZWAgc2hvdWxkIGluY2x1ZGUgdGhlIElECiAgICAgICAgaW4gdGhlIHNlcmlhbGl6ZWQgb2JqZWN0IGl0IGJ1aWxkcy4KICAgICAgIEV4YW1wbGU6CiAgICAgICBgYGBqcwogICAgICBTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgc2VyaWFsaXplKHNuYXBzaG90LCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIganNvbiA9IHsKICAgICAgICAgICAgaWQ6IHNuYXBzaG90LmlkCiAgICAgICAgICB9OwogICAgICAgICAgIHNuYXBzaG90LmVhY2hBdHRyaWJ1dGUoKGtleSwgYXR0cmlidXRlKSA9PiB7CiAgICAgICAgICAgIGpzb25ba2V5XSA9IHNuYXBzaG90LmF0dHIoa2V5KTsKICAgICAgICAgIH0pOwogICAgICAgICAgIHNuYXBzaG90LmVhY2hSZWxhdGlvbnNoaXAoKGtleSwgcmVsYXRpb25zaGlwKSA9PiB7CiAgICAgICAgICAgIGlmIChyZWxhdGlvbnNoaXAua2luZCA9PT0gJ2JlbG9uZ3NUbycpIHsKICAgICAgICAgICAgICBqc29uW2tleV0gPSBzbmFwc2hvdC5iZWxvbmdzVG8oa2V5LCB7IGlkOiB0cnVlIH0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJlbGF0aW9uc2hpcC5raW5kID09PSAnaGFzTWFueScpIHsKICAgICAgICAgICAgICBqc29uW2tleV0gPSBzbmFwc2hvdC5oYXNNYW55KGtleSwgeyBpZHM6IHRydWUgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgIHJldHVybiBqc29uOwogICAgICAgIH0sCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2Qgc2VyaWFsaXplCiAgICAgIEBwYXJhbSB7U25hcHNob3R9IHNuYXBzaG90CiAgICAgIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10KICAgICAgQHJldHVybiB7T2JqZWN0fQogICAgKi8KICAgIHNlcmlhbGl6ZTogbnVsbCwKCiAgICAvKioKICAgICAgVGhlIGBub3JtYWxpemVgIG1ldGhvZCBpcyB1c2VkIHRvIGNvbnZlcnQgYSBwYXlsb2FkIHJlY2VpdmVkIGZyb20geW91cgogICAgICBleHRlcm5hbCBkYXRhIHNvdXJjZSBpbnRvIHRoZSBub3JtYWxpemVkIGZvcm0gYHN0b3JlLnB1c2goKWAgZXhwZWN0cy4gWW91CiAgICAgIHNob3VsZCBvdmVycmlkZSB0aGlzIG1ldGhvZCwgbXVuZ2UgdGhlIGhhc2ggYW5kIHJldHVybiB0aGUgbm9ybWFsaXplZAogICAgICBwYXlsb2FkLgogICAgICAgRXhhbXBsZToKICAgICAgIGBgYGpzCiAgICAgIFNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBub3JtYWxpemUobW9kZWxDbGFzcywgcmVzb3VyY2VIYXNoKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IHsKICAgICAgICAgICAgaWQ6ICAgICAgICAgICAgcmVzb3VyY2VIYXNoLmlkLAogICAgICAgICAgICB0eXBlOiAgICAgICAgICBtb2RlbENsYXNzLm1vZGVsTmFtZSwKICAgICAgICAgICAgYXR0cmlidXRlczogICAgcmVzb3VyY2VIYXNoCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHsgZGF0YTogZGF0YSB9OwogICAgICAgIH0KICAgICAgfSkKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIG5vcm1hbGl6ZQogICAgICBAcGFyYW0ge01vZGVsfSB0eXBlQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IGhhc2gKICAgICAgQHJldHVybiB7T2JqZWN0fQogICAgKi8KICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24gbm9ybWFsaXplKHR5cGVDbGFzcywgaGFzaCkgewogICAgICByZXR1cm4gaGFzaDsKICAgIH0KICB9KTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKO2RlZmluZSgiQGVtYmVyLWRhdGEvc2VyaWFsaXplci9qc29uLWFwaSIsIFsiZXhwb3J0cyIsICJlbWJlci1pbmZsZWN0b3IiLCAiQGVtYmVyLWRhdGEvc2VyaWFsaXplci9qc29uIiwgIkBlbWJlci1kYXRhL3N0b3JlIiwgIkBlbWJlci1kYXRhL2NhbmFyeS1mZWF0dXJlcyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9lbWJlckluZmxlY3RvciwgX2pzb24sIF9zdG9yZSwgX2NhbmFyeUZlYXR1cmVzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICAgIEVtYmVyIERhdGEgMi4wIFNlcmlhbGl6ZXI6CiAgCiAgICBJbiBFbWJlciBEYXRhIGEgU2VyaWFsaXplciBpcyB1c2VkIHRvIHNlcmlhbGl6ZSBhbmQgZGVzZXJpYWxpemUKICAgIHJlY29yZHMgd2hlbiB0aGV5IGFyZSB0cmFuc2ZlcnJlZCBpbiBhbmQgb3V0IG9mIGFuIGV4dGVybmFsIHNvdXJjZS4KICAgIFRoaXMgcHJvY2VzcyBpbnZvbHZlcyBub3JtYWxpemluZyBwcm9wZXJ0eSBuYW1lcywgdHJhbnNmb3JtaW5nCiAgICBhdHRyaWJ1dGUgdmFsdWVzIGFuZCBzZXJpYWxpemluZyByZWxhdGlvbnNoaXBzLgogIAogICAgYEpTT05BUElTZXJpYWxpemVyYCBzdXBwb3J0cyB0aGUgaHR0cDovL2pzb25hcGkub3JnLyBzcGVjIGFuZCBpcyB0aGUKICAgIHNlcmlhbGl6ZXIgcmVjb21tZW5kZWQgYnkgRW1iZXIgRGF0YS4KICAKICAgIFRoaXMgc2VyaWFsaXplciBub3JtYWxpemVzIGEgSlNPTiBBUEkgcGF5bG9hZCB0aGF0IGxvb2tzIGxpa2U6CiAgCiAgICBgYGBhcHAvbW9kZWxzL3BsYXllci5qcwogICAgaW1wb3J0IE1vZGVsLCB7IGF0dHIsIGJlbG9uZ3NUbyB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgIG5hbWU6IGF0dHIoJ3N0cmluZycpLAogICAgICBza2lsbDogYXR0cignc3RyaW5nJyksCiAgICAgIGdhbWVzUGxheWVkOiBhdHRyKCdudW1iZXInKSwKICAgICAgY2x1YjogYmVsb25nc1RvKCdjbHViJykKICAgIH0pOwogICAgYGBgCiAgCiAgICBgYGBhcHAvbW9kZWxzL2NsdWIuanMKICAgIGltcG9ydCBNb2RlbCwgeyBhdHRyLCBoYXNNYW55IH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogIAogICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgbmFtZTogYXR0cignc3RyaW5nJyksCiAgICAgIGxvY2F0aW9uOiBhdHRyKCdzdHJpbmcnKSwKICAgICAgcGxheWVyczogaGFzTWFueSgncGxheWVyJykKICAgIH0pOwogICAgYGBgCiAgCiAgICBgYGBqcwogICAgICB7CiAgICAgICAgImRhdGEiOiBbCiAgICAgICAgICB7CiAgICAgICAgICAgICJhdHRyaWJ1dGVzIjogewogICAgICAgICAgICAgICJuYW1lIjogIkJlbmZpY2EiLAogICAgICAgICAgICAgICJsb2NhdGlvbiI6ICJQb3J0dWdhbCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImlkIjogIjEiLAogICAgICAgICAgICAicmVsYXRpb25zaGlwcyI6IHsKICAgICAgICAgICAgICAicGxheWVycyI6IHsKICAgICAgICAgICAgICAgICJkYXRhIjogWwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgImlkIjogIjMiLAogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInBsYXllcnMiCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJ0eXBlIjogImNsdWJzIgogICAgICAgICAgfQogICAgICAgIF0sCiAgICAgICAgImluY2x1ZGVkIjogWwogICAgICAgICAgewogICAgICAgICAgICAiYXR0cmlidXRlcyI6IHsKICAgICAgICAgICAgICAibmFtZSI6ICJFdXNlYmlvIFNpbHZhIEZlcnJlaXJhIiwKICAgICAgICAgICAgICAic2tpbGwiOiAiUm9ja2V0IHNob3QiLAogICAgICAgICAgICAgICJnYW1lcy1wbGF5ZWQiOiA0MzEKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImlkIjogIjMiLAogICAgICAgICAgICAicmVsYXRpb25zaGlwcyI6IHsKICAgICAgICAgICAgICAiY2x1YiI6IHsKICAgICAgICAgICAgICAgICJkYXRhIjogewogICAgICAgICAgICAgICAgICAiaWQiOiAiMSIsCiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNsdWJzIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgInR5cGUiOiAicGxheWVycyIKICAgICAgICAgIH0KICAgICAgICBdCiAgICAgIH0KICAgIGBgYAogIAogICAgdG8gdGhlIGZvcm1hdCB0aGF0IHRoZSBFbWJlciBEYXRhIHN0b3JlIGV4cGVjdHMuCiAgCiAgICAjIyMgQ3VzdG9taXppbmcgbWV0YQogIAogICAgU2luY2UgYSBKU09OIEFQSSBEb2N1bWVudCBjYW4gaGF2ZSBtZXRhIGRlZmluZWQgaW4gbXVsdGlwbGUgbG9jYXRpb25zIHlvdSBjYW4KICAgIHVzZSB0aGUgc3BlY2lmaWMgc2VyaWFsaXplciBob29rcyBpZiB5b3UgbmVlZCB0byBjdXN0b21pemUgdGhlIG1ldGEuCiAgCiAgICBPbmUgc2NlbmFyaW8gd291bGQgYmUgdG8gY2FtZWxDYXNlIHRoZSBtZXRhIGtleXMgb2YgeW91ciBwYXlsb2FkLiBUaGUgZXhhbXBsZQogICAgYmVsb3cgc2hvd3MgaG93IHRoaXMgY291bGQgYmUgZG9uZSB1c2luZyBgbm9ybWFsaXplQXJyYXlSZXNwb25zZWAgYW5kCiAgICBgZXh0cmFjdFJlbGF0aW9uc2hpcGAuCiAgCiAgICBgYGBhcHAvc2VyaWFsaXplcnMvYXBwbGljYXRpb24uanMKICAgIGV4cG9ydCBkZWZhdWx0IEpTT05BUElTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgIG5vcm1hbGl6ZUFycmF5UmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgICBsZXQgbm9ybWFsaXplZERvY3VtZW50ID0gdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAKICAgICAgICAvLyBDdXN0b21pemUgZG9jdW1lbnQgbWV0YQogICAgICAgIG5vcm1hbGl6ZWREb2N1bWVudC5tZXRhID0gY2FtZWxDYXNlS2V5cyhub3JtYWxpemVkRG9jdW1lbnQubWV0YSk7CiAgCiAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZWREb2N1bWVudDsKICAgICAgfSwKICAKICAgICAgZXh0cmFjdFJlbGF0aW9uc2hpcChyZWxhdGlvbnNoaXBIYXNoKSB7CiAgICAgICAgbGV0IG5vcm1hbGl6ZWRSZWxhdGlvbnNoaXAgPSB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpOwogIAogICAgICAgIC8vIEN1c3RvbWl6ZSByZWxhdGlvbnNoaXAgbWV0YQogICAgICAgIG5vcm1hbGl6ZWRSZWxhdGlvbnNoaXAubWV0YSA9IGNhbWVsQ2FzZUtleXMobm9ybWFsaXplZFJlbGF0aW9uc2hpcC5tZXRhKTsKICAKICAgICAgICByZXR1cm4gbm9ybWFsaXplZFJlbGF0aW9uc2hpcDsKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIEBzaW5jZSAxLjEzLjAKICAgIEBjbGFzcyBKU09OQVBJU2VyaWFsaXplcgogICAgQGV4dGVuZHMgSlNPTlNlcmlhbGl6ZXIKICAqLwogIHZhciBKU09OQVBJU2VyaWFsaXplciA9IF9qc29uLmRlZmF1bHQuZXh0ZW5kKHsKICAgIC8qKgogICAgICBAbWV0aG9kIF9ub3JtYWxpemVEb2N1bWVudEhlbHBlcgogICAgICBAcGFyYW0ge09iamVjdH0gZG9jdW1lbnRIYXNoCiAgICAgIEByZXR1cm4ge09iamVjdH0KICAgICAgQHByaXZhdGUKICAgICovCiAgICBfbm9ybWFsaXplRG9jdW1lbnRIZWxwZXI6IGZ1bmN0aW9uIF9ub3JtYWxpemVEb2N1bWVudEhlbHBlcihkb2N1bWVudEhhc2gpIHsKICAgICAgaWYgKEVtYmVyLnR5cGVPZihkb2N1bWVudEhhc2guZGF0YSkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgZG9jdW1lbnRIYXNoLmRhdGEgPSB0aGlzLl9ub3JtYWxpemVSZXNvdXJjZUhlbHBlcihkb2N1bWVudEhhc2guZGF0YSk7CiAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShkb2N1bWVudEhhc2guZGF0YSkpIHsKICAgICAgICB2YXIgcmV0ID0gbmV3IEFycmF5KGRvY3VtZW50SGFzaC5kYXRhLmxlbmd0aCk7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZG9jdW1lbnRIYXNoLmRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBkYXRhID0gZG9jdW1lbnRIYXNoLmRhdGFbaV07CiAgICAgICAgICByZXRbaV0gPSB0aGlzLl9ub3JtYWxpemVSZXNvdXJjZUhlbHBlcihkYXRhKTsKICAgICAgICB9CgogICAgICAgIGRvY3VtZW50SGFzaC5kYXRhID0gcmV0OwogICAgICB9CgogICAgICBpZiAoQXJyYXkuaXNBcnJheShkb2N1bWVudEhhc2guaW5jbHVkZWQpKSB7CiAgICAgICAgdmFyIF9yZXQgPSBuZXcgQXJyYXkoKTsKCiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGRvY3VtZW50SGFzaC5pbmNsdWRlZC5sZW5ndGg7IF9pKyspIHsKICAgICAgICAgIHZhciBpbmNsdWRlZCA9IGRvY3VtZW50SGFzaC5pbmNsdWRlZFtfaV07CgogICAgICAgICAgdmFyIG5vcm1hbGl6ZWQgPSB0aGlzLl9ub3JtYWxpemVSZXNvdXJjZUhlbHBlcihpbmNsdWRlZCk7CgogICAgICAgICAgaWYgKG5vcm1hbGl6ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgLy8gY2FuIGJlIG51bGwgd2hlbiB1bmtub3duIHR5cGUgaXMgZW5jb3VudGVyZWQKICAgICAgICAgICAgX3JldC5wdXNoKG5vcm1hbGl6ZWQpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZG9jdW1lbnRIYXNoLmluY2x1ZGVkID0gX3JldDsKICAgICAgfQoKICAgICAgcmV0dXJuIGRvY3VtZW50SGFzaDsKICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2QgX25vcm1hbGl6ZVJlbGF0aW9uc2hpcERhdGFIZWxwZXIKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlbGF0aW9uc2hpcERhdGFIYXNoCiAgICAgIEByZXR1cm4ge09iamVjdH0KICAgICAgQHByaXZhdGUKICAgICovCiAgICBfbm9ybWFsaXplUmVsYXRpb25zaGlwRGF0YUhlbHBlcjogZnVuY3Rpb24gX25vcm1hbGl6ZVJlbGF0aW9uc2hpcERhdGFIZWxwZXIocmVsYXRpb25zaGlwRGF0YUhhc2gpIHsKICAgICAgcmVsYXRpb25zaGlwRGF0YUhhc2gudHlwZSA9IHRoaXMubW9kZWxOYW1lRnJvbVBheWxvYWRLZXkocmVsYXRpb25zaGlwRGF0YUhhc2gudHlwZSk7CiAgICAgIHJldHVybiByZWxhdGlvbnNoaXBEYXRhSGFzaDsKICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2QgX25vcm1hbGl6ZVJlc291cmNlSGVscGVyCiAgICAgIEBwYXJhbSB7T2JqZWN0fSByZXNvdXJjZUhhc2gKICAgICAgQHJldHVybiB7T2JqZWN0fQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9ub3JtYWxpemVSZXNvdXJjZUhlbHBlcjogZnVuY3Rpb24gX25vcm1hbGl6ZVJlc291cmNlSGVscGVyKHJlc291cmNlSGFzaCkgewogICAgICAoZmFsc2UgJiYgISghRW1iZXIuaXNOb25lKHJlc291cmNlSGFzaC50eXBlKSkgJiYgRW1iZXIuYXNzZXJ0KHRoaXMud2Fybk1lc3NhZ2VGb3JVbmRlZmluZWRUeXBlKCksICFFbWJlci5pc05vbmUocmVzb3VyY2VIYXNoLnR5cGUpLCB7CiAgICAgICAgaWQ6ICdkcy5zZXJpYWxpemVyLnR5cGUtaXMtdW5kZWZpbmVkJwogICAgICB9KSk7CiAgICAgIHZhciBtb2RlbE5hbWUsIHVzZWRMb29rdXA7CiAgICAgIG1vZGVsTmFtZSA9IHRoaXMubW9kZWxOYW1lRnJvbVBheWxvYWRLZXkocmVzb3VyY2VIYXNoLnR5cGUpOwogICAgICB1c2VkTG9va3VwID0gJ21vZGVsTmFtZUZyb21QYXlsb2FkS2V5JzsKCiAgICAgIGlmICghdGhpcy5zdG9yZS5faGFzTW9kZWxGb3IobW9kZWxOYW1lKSkgewogICAgICAgIChmYWxzZSAmJiBFbWJlci53YXJuKHRoaXMud2Fybk1lc3NhZ2VOb01vZGVsRm9yVHlwZShtb2RlbE5hbWUsIHJlc291cmNlSGFzaC50eXBlLCB1c2VkTG9va3VwKSwgZmFsc2UsIHsKICAgICAgICAgIGlkOiAnZHMuc2VyaWFsaXplci5tb2RlbC1mb3ItdHlwZS1taXNzaW5nJwogICAgICAgIH0pKTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgdmFyIG1vZGVsQ2xhc3MgPSB0aGlzLnN0b3JlLm1vZGVsRm9yKG1vZGVsTmFtZSk7CiAgICAgIHZhciBzZXJpYWxpemVyID0gdGhpcy5zdG9yZS5zZXJpYWxpemVyRm9yKG1vZGVsTmFtZSk7CgogICAgICB2YXIgX3NlcmlhbGl6ZXIkbm9ybWFsaXplID0gc2VyaWFsaXplci5ub3JtYWxpemUobW9kZWxDbGFzcywgcmVzb3VyY2VIYXNoKSwKICAgICAgICAgIGRhdGEgPSBfc2VyaWFsaXplciRub3JtYWxpemUuZGF0YTsKCiAgICAgIHJldHVybiBkYXRhOwogICAgfSwKCiAgICAvKioKICAgICAgQG1ldGhvZCBwdXNoUGF5bG9hZAogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgKi8KICAgIHB1c2hQYXlsb2FkOiBmdW5jdGlvbiBwdXNoUGF5bG9hZChzdG9yZSwgcGF5bG9hZCkgewogICAgICB2YXIgbm9ybWFsaXplZFBheWxvYWQgPSB0aGlzLl9ub3JtYWxpemVEb2N1bWVudEhlbHBlcihwYXlsb2FkKTsKCiAgICAgIHN0b3JlLnB1c2gobm9ybWFsaXplZFBheWxvYWQpOwogICAgfSwKCiAgICAvKioKICAgICAgQG1ldGhvZCBfbm9ybWFsaXplUmVzcG9uc2UKICAgICAgQHBhcmFtIHtTdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtNb2RlbH0gcHJpbWFyeU1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBpZAogICAgICBAcGFyYW0ge1N0cmluZ30gcmVxdWVzdFR5cGUKICAgICAgQHBhcmFtIHtCb29sZWFufSBpc1NpbmdsZQogICAgICBAcmV0dXJuIHtPYmplY3R9IEpTT04tQVBJIERvY3VtZW50CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgX25vcm1hbGl6ZVJlc3BvbnNlOiBmdW5jdGlvbiBfbm9ybWFsaXplUmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUsIGlzU2luZ2xlKSB7CiAgICAgIHZhciBub3JtYWxpemVkUGF5bG9hZCA9IHRoaXMuX25vcm1hbGl6ZURvY3VtZW50SGVscGVyKHBheWxvYWQpOwoKICAgICAgcmV0dXJuIG5vcm1hbGl6ZWRQYXlsb2FkOwogICAgfSwKICAgIG5vcm1hbGl6ZVF1ZXJ5UmVjb3JkUmVzcG9uc2U6IGZ1bmN0aW9uIG5vcm1hbGl6ZVF1ZXJ5UmVjb3JkUmVzcG9uc2UoKSB7CiAgICAgIHZhciBub3JtYWxpemVkID0gdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgIChmYWxzZSAmJiAhKCFBcnJheS5pc0FycmF5KG5vcm1hbGl6ZWQuZGF0YSkpICYmIEVtYmVyLmFzc2VydCgnRXhwZWN0ZWQgdGhlIHByaW1hcnkgZGF0YSByZXR1cm5lZCBieSB0aGUgc2VyaWFsaXplciBmb3IgYSBgcXVlcnlSZWNvcmRgIHJlc3BvbnNlIHRvIGJlIGEgc2luZ2xlIG9iamVjdCBidXQgaW5zdGVhZCBpdCB3YXMgYW4gYXJyYXkuJywgIUFycmF5LmlzQXJyYXkobm9ybWFsaXplZC5kYXRhKSwgewogICAgICAgIGlkOiAnZHMuc2VyaWFsaXplci5qc29uLWFwaS5xdWVyeVJlY29yZC1hcnJheS1yZXNwb25zZScKICAgICAgfSkpOwogICAgICByZXR1cm4gbm9ybWFsaXplZDsKICAgIH0sCiAgICBleHRyYWN0QXR0cmlidXRlczogZnVuY3Rpb24gZXh0cmFjdEF0dHJpYnV0ZXMobW9kZWxDbGFzcywgcmVzb3VyY2VIYXNoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgYXR0cmlidXRlcyA9IHt9OwoKICAgICAgaWYgKHJlc291cmNlSGFzaC5hdHRyaWJ1dGVzKSB7CiAgICAgICAgbW9kZWxDbGFzcy5lYWNoQXR0cmlidXRlKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIHZhciBhdHRyaWJ1dGVLZXkgPSBfdGhpcy5rZXlGb3JBdHRyaWJ1dGUoa2V5LCAnZGVzZXJpYWxpemUnKTsKCiAgICAgICAgICBpZiAocmVzb3VyY2VIYXNoLmF0dHJpYnV0ZXNbYXR0cmlidXRlS2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGF0dHJpYnV0ZXNba2V5XSA9IHJlc291cmNlSGFzaC5hdHRyaWJ1dGVzW2F0dHJpYnV0ZUtleV07CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGZhbHNlCiAgICAgICAgICAvKiBERUJVRyAqLwogICAgICAgICAgKSB7CiAgICAgICAgICAgIGlmIChyZXNvdXJjZUhhc2guYXR0cmlidXRlc1thdHRyaWJ1dGVLZXldID09PSB1bmRlZmluZWQgJiYgcmVzb3VyY2VIYXNoLmF0dHJpYnV0ZXNba2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmIEVtYmVyLmFzc2VydCgiWW91ciBwYXlsb2FkIGZvciAnIiArIG1vZGVsQ2xhc3MubW9kZWxOYW1lICsgIicgY29udGFpbnMgJyIgKyBrZXkgKyAiJywgYnV0IHlvdXIgc2VyaWFsaXplciBpcyBzZXR1cCB0byBsb29rIGZvciAnIiArIGF0dHJpYnV0ZUtleSArICInLiBUaGlzIGlzIG1vc3QgbGlrZWx5IGJlY2F1c2UgRW1iZXIgRGF0YSdzIEpTT04gQVBJIHNlcmlhbGl6ZXIgZGFzaGVyaXplcyBhdHRyaWJ1dGUga2V5cyBieSBkZWZhdWx0LiBZb3Ugc2hvdWxkIHN1YmNsYXNzIEpTT05BUElTZXJpYWxpemVyIGFuZCBpbXBsZW1lbnQgJ2tleUZvckF0dHJpYnV0ZShrZXkpIHsgcmV0dXJuIGtleTsgfScgdG8gcHJldmVudCBFbWJlciBEYXRhIGZyb20gY3VzdG9taXppbmcgeW91ciBhdHRyaWJ1dGUga2V5cy4iLCBmYWxzZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBhdHRyaWJ1dGVzOwogICAgfSwKCiAgICAvKioKICAgICAgIFJldHVybnMgYSByZWxhdGlvbnNoaXAgZm9ybWF0dGVkIGFzIGEgSlNPTi1BUEkgInJlbGF0aW9uc2hpcCBvYmplY3QiLgogICAgICAgIGh0dHA6Ly9qc29uYXBpLm9yZy9mb3JtYXQvI2RvY3VtZW50LXJlc291cmNlLW9iamVjdC1yZWxhdGlvbnNoaXBzCiAgICAgICAgQG1ldGhvZCBleHRyYWN0UmVsYXRpb25zaGlwCiAgICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwSGFzaAogICAgICAgQHJldHVybiB7T2JqZWN0fQogICAgKi8KICAgIGV4dHJhY3RSZWxhdGlvbnNoaXA6IGZ1bmN0aW9uIGV4dHJhY3RSZWxhdGlvbnNoaXAocmVsYXRpb25zaGlwSGFzaCkgewogICAgICBpZiAoRW1iZXIudHlwZU9mKHJlbGF0aW9uc2hpcEhhc2guZGF0YSkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgcmVsYXRpb25zaGlwSGFzaC5kYXRhID0gdGhpcy5fbm9ybWFsaXplUmVsYXRpb25zaGlwRGF0YUhlbHBlcihyZWxhdGlvbnNoaXBIYXNoLmRhdGEpOwogICAgICB9CgogICAgICBpZiAoQXJyYXkuaXNBcnJheShyZWxhdGlvbnNoaXBIYXNoLmRhdGEpKSB7CiAgICAgICAgdmFyIHJldCA9IG5ldyBBcnJheShyZWxhdGlvbnNoaXBIYXNoLmRhdGEubGVuZ3RoKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWxhdGlvbnNoaXBIYXNoLmRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBkYXRhID0gcmVsYXRpb25zaGlwSGFzaC5kYXRhW2ldOwogICAgICAgICAgcmV0W2ldID0gdGhpcy5fbm9ybWFsaXplUmVsYXRpb25zaGlwRGF0YUhlbHBlcihkYXRhKTsKICAgICAgICB9CgogICAgICAgIHJlbGF0aW9uc2hpcEhhc2guZGF0YSA9IHJldDsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlbGF0aW9uc2hpcEhhc2g7CiAgICB9LAoKICAgIC8qKgogICAgICAgUmV0dXJucyB0aGUgcmVzb3VyY2UncyByZWxhdGlvbnNoaXBzIGZvcm1hdHRlZCBhcyBhIEpTT04tQVBJICJyZWxhdGlvbnNoaXBzIG9iamVjdCIuCiAgICAgICAgaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZG9jdW1lbnQtcmVzb3VyY2Utb2JqZWN0LXJlbGF0aW9uc2hpcHMKICAgICAgICBAbWV0aG9kIGV4dHJhY3RSZWxhdGlvbnNoaXBzCiAgICAgICBAcGFyYW0ge09iamVjdH0gbW9kZWxDbGFzcwogICAgICAgQHBhcmFtIHtPYmplY3R9IHJlc291cmNlSGFzaAogICAgICAgQHJldHVybiB7T2JqZWN0fQogICAgKi8KICAgIGV4dHJhY3RSZWxhdGlvbnNoaXBzOiBmdW5jdGlvbiBleHRyYWN0UmVsYXRpb25zaGlwcyhtb2RlbENsYXNzLCByZXNvdXJjZUhhc2gpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB2YXIgcmVsYXRpb25zaGlwcyA9IHt9OwoKICAgICAgaWYgKHJlc291cmNlSGFzaC5yZWxhdGlvbnNoaXBzKSB7CiAgICAgICAgbW9kZWxDbGFzcy5lYWNoUmVsYXRpb25zaGlwKGZ1bmN0aW9uIChrZXksIHJlbGF0aW9uc2hpcE1ldGEpIHsKICAgICAgICAgIHZhciByZWxhdGlvbnNoaXBLZXkgPSBfdGhpczIua2V5Rm9yUmVsYXRpb25zaGlwKGtleSwgcmVsYXRpb25zaGlwTWV0YS5raW5kLCAnZGVzZXJpYWxpemUnKTsKCiAgICAgICAgICBpZiAocmVzb3VyY2VIYXNoLnJlbGF0aW9uc2hpcHNbcmVsYXRpb25zaGlwS2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHZhciByZWxhdGlvbnNoaXBIYXNoID0gcmVzb3VyY2VIYXNoLnJlbGF0aW9uc2hpcHNbcmVsYXRpb25zaGlwS2V5XTsKICAgICAgICAgICAgcmVsYXRpb25zaGlwc1trZXldID0gX3RoaXMyLmV4dHJhY3RSZWxhdGlvbnNoaXAocmVsYXRpb25zaGlwSGFzaCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGZhbHNlCiAgICAgICAgICAvKiBERUJVRyAqLwogICAgICAgICAgKSB7CiAgICAgICAgICAgIGlmIChyZXNvdXJjZUhhc2gucmVsYXRpb25zaGlwc1tyZWxhdGlvbnNoaXBLZXldID09PSB1bmRlZmluZWQgJiYgcmVzb3VyY2VIYXNoLnJlbGF0aW9uc2hpcHNba2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmIEVtYmVyLmFzc2VydCgiWW91ciBwYXlsb2FkIGZvciAnIiArIG1vZGVsQ2xhc3MubW9kZWxOYW1lICsgIicgY29udGFpbnMgJyIgKyBrZXkgKyAiJywgYnV0IHlvdXIgc2VyaWFsaXplciBpcyBzZXR1cCB0byBsb29rIGZvciAnIiArIHJlbGF0aW9uc2hpcEtleSArICInLiBUaGlzIGlzIG1vc3QgbGlrZWx5IGJlY2F1c2UgRW1iZXIgRGF0YSdzIEpTT04gQVBJIHNlcmlhbGl6ZXIgZGFzaGVyaXplcyByZWxhdGlvbnNoaXAga2V5cyBieSBkZWZhdWx0LiBZb3Ugc2hvdWxkIHN1YmNsYXNzIEpTT05BUElTZXJpYWxpemVyIGFuZCBpbXBsZW1lbnQgJ2tleUZvclJlbGF0aW9uc2hpcChrZXkpIHsgcmV0dXJuIGtleTsgfScgdG8gcHJldmVudCBFbWJlciBEYXRhIGZyb20gY3VzdG9taXppbmcgeW91ciByZWxhdGlvbnNoaXAga2V5cy4iLCBmYWxzZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiByZWxhdGlvbnNoaXBzOwogICAgfSwKCiAgICAvKioKICAgICAgQG1ldGhvZCBfZXh0cmFjdFR5cGUKICAgICAgQHBhcmFtIHtNb2RlbH0gbW9kZWxDbGFzcwogICAgICBAcGFyYW0ge09iamVjdH0gcmVzb3VyY2VIYXNoCiAgICAgIEByZXR1cm4ge1N0cmluZ30KICAgICAgQHByaXZhdGUKICAgICovCiAgICBfZXh0cmFjdFR5cGU6IGZ1bmN0aW9uIF9leHRyYWN0VHlwZShtb2RlbENsYXNzLCByZXNvdXJjZUhhc2gpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxOYW1lRnJvbVBheWxvYWRLZXkocmVzb3VyY2VIYXNoLnR5cGUpOwogICAgfSwKCiAgICAvKioKICAgICAgRGFzaGVyaXplcyBhbmQgc2luZ3VsYXJpemVzIHRoZSBtb2RlbCBuYW1lIGluIHRoZSBwYXlsb2FkIHRvIG1hdGNoCiAgICAgIHRoZSBmb3JtYXQgRW1iZXIgRGF0YSB1c2VzIGludGVybmFsbHkgZm9yIHRoZSBtb2RlbCBuYW1lLgogICAgICAgRm9yIGV4YW1wbGUgdGhlIGtleSBgcG9zdHNgIHdvdWxkIGJlIGNvbnZlcnRlZCB0byBgcG9zdGAgYW5kIHRoZQogICAgICBrZXkgYHN0dWRlbnRBc3Nlc21lbnRzYCB3b3VsZCBiZSBjb252ZXJ0ZWQgdG8gYHN0dWRlbnQtYXNzZXNtZW50YC4KICAgICAgIEBtZXRob2QgbW9kZWxOYW1lRnJvbVBheWxvYWRLZXkKICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleQogICAgICBAcmV0dXJuIHtTdHJpbmd9IHRoZSBtb2RlbCdzIG1vZGVsTmFtZQogICAgKi8KICAgIC8vIFRPRE8gQGRlcHJlY2F0ZWQgVXNlIG1vZGVsTmFtZUZyb21QYXlsb2FkVHlwZSBpbnN0ZWFkCiAgICBtb2RlbE5hbWVGcm9tUGF5bG9hZEtleTogZnVuY3Rpb24gbW9kZWxOYW1lRnJvbVBheWxvYWRLZXkoa2V5KSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVySW5mbGVjdG9yLnNpbmd1bGFyaXplKSgoMCwgX3N0b3JlLm5vcm1hbGl6ZU1vZGVsTmFtZSkoa2V5KSk7CiAgICB9LAoKICAgIC8qKgogICAgICBDb252ZXJ0cyB0aGUgbW9kZWwgbmFtZSB0byBhIHBsdXJhbGl6ZWQgdmVyc2lvbiBvZiB0aGUgbW9kZWwgbmFtZS4KICAgICAgIEZvciBleGFtcGxlIGBwb3N0YCB3b3VsZCBiZSBjb252ZXJ0ZWQgdG8gYHBvc3RzYCBhbmQKICAgICAgYHN0dWRlbnQtYXNzZXNtZW50YCB3b3VsZCBiZSBjb252ZXJ0ZWQgdG8gYHN0dWRlbnQtYXNzZXNtZW50c2AuCiAgICAgICBAbWV0aG9kIHBheWxvYWRLZXlGcm9tTW9kZWxOYW1lCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgICAgQHJldHVybiB7U3RyaW5nfQogICAgKi8KICAgIC8vIFRPRE8gQGRlcHJlY2F0ZWQgVXNlIHBheWxvYWRUeXBlRnJvbU1vZGVsTmFtZSBpbnN0ZWFkCiAgICBwYXlsb2FkS2V5RnJvbU1vZGVsTmFtZTogZnVuY3Rpb24gcGF5bG9hZEtleUZyb21Nb2RlbE5hbWUobW9kZWxOYW1lKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVySW5mbGVjdG9yLnBsdXJhbGl6ZSkobW9kZWxOYW1lKTsKICAgIH0sCiAgICBub3JtYWxpemU6IGZ1bmN0aW9uIG5vcm1hbGl6ZShtb2RlbENsYXNzLCByZXNvdXJjZUhhc2gpIHsKICAgICAgaWYgKHJlc291cmNlSGFzaC5hdHRyaWJ1dGVzKSB7CiAgICAgICAgdGhpcy5ub3JtYWxpemVVc2luZ0RlY2xhcmVkTWFwcGluZyhtb2RlbENsYXNzLCByZXNvdXJjZUhhc2guYXR0cmlidXRlcyk7CiAgICAgIH0KCiAgICAgIGlmIChyZXNvdXJjZUhhc2gucmVsYXRpb25zaGlwcykgewogICAgICAgIHRoaXMubm9ybWFsaXplVXNpbmdEZWNsYXJlZE1hcHBpbmcobW9kZWxDbGFzcywgcmVzb3VyY2VIYXNoLnJlbGF0aW9uc2hpcHMpOwogICAgICB9CgogICAgICB2YXIgZGF0YSA9IHsKICAgICAgICBpZDogdGhpcy5leHRyYWN0SWQobW9kZWxDbGFzcywgcmVzb3VyY2VIYXNoKSwKICAgICAgICB0eXBlOiB0aGlzLl9leHRyYWN0VHlwZShtb2RlbENsYXNzLCByZXNvdXJjZUhhc2gpLAogICAgICAgIGF0dHJpYnV0ZXM6IHRoaXMuZXh0cmFjdEF0dHJpYnV0ZXMobW9kZWxDbGFzcywgcmVzb3VyY2VIYXNoKSwKICAgICAgICByZWxhdGlvbnNoaXBzOiB0aGlzLmV4dHJhY3RSZWxhdGlvbnNoaXBzKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCkKICAgICAgfTsKICAgICAgdGhpcy5hcHBseVRyYW5zZm9ybXMobW9kZWxDbGFzcywgZGF0YS5hdHRyaWJ1dGVzKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiBkYXRhCiAgICAgIH07CiAgICB9LAoKICAgIC8qKgogICAgICBga2V5Rm9yQXR0cmlidXRlYCBjYW4gYmUgdXNlZCB0byBkZWZpbmUgcnVsZXMgZm9yIGhvdyB0byBjb252ZXJ0IGFuCiAgICAgIGF0dHJpYnV0ZSBuYW1lIGluIHlvdXIgbW9kZWwgdG8gYSBrZXkgaW4geW91ciBKU09OLgogICAgICBCeSBkZWZhdWx0IGBKU09OQVBJU2VyaWFsaXplcmAgZm9sbG93cyB0aGUgZm9ybWF0IHVzZWQgb24gdGhlIGV4YW1wbGVzIG9mCiAgICAgIGh0dHA6Ly9qc29uYXBpLm9yZy9mb3JtYXQgYW5kIHVzZXMgZGFzaGVzIGFzIHRoZSB3b3JkIHNlcGFyYXRvciBpbiB0aGUgSlNPTgogICAgICBhdHRyaWJ1dGUga2V5cy4KICAgICAgIFRoaXMgYmVoYXZpb3VyIGNhbiBiZSBlYXNpbHkgY3VzdG9taXplZCBieSBleHRlbmRpbmcgdGhpcyBtZXRob2QuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IEpTT05BUElTZXJpYWxpemVyIGZyb20gJ0BlbWJlci1kYXRhL3NlcmlhbGl6ZXIvanNvbi1hcGknOwogICAgICBpbXBvcnQgeyBkYXNoZXJpemUgfSBmcm9tICdAZW1iZXIvc3RyaW5nJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IEpTT05BUElTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAga2V5Rm9yQXR0cmlidXRlKGF0dHIsIG1ldGhvZCkgewogICAgICAgICAgcmV0dXJuIGRhc2hlcml6ZShhdHRyKS50b1VwcGVyQ2FzZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBrZXlGb3JBdHRyaWJ1dGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleQogICAgICBAcGFyYW0ge1N0cmluZ30gbWV0aG9kCiAgICAgIEByZXR1cm4ge1N0cmluZ30gbm9ybWFsaXplZCBrZXkKICAgICovCiAgICBrZXlGb3JBdHRyaWJ1dGU6IGZ1bmN0aW9uIGtleUZvckF0dHJpYnV0ZShrZXksIG1ldGhvZCkgewogICAgICByZXR1cm4gRW1iZXIuU3RyaW5nLmRhc2hlcml6ZShrZXkpOwogICAgfSwKCiAgICAvKioKICAgICBga2V5Rm9yUmVsYXRpb25zaGlwYCBjYW4gYmUgdXNlZCB0byBkZWZpbmUgYSBjdXN0b20ga2V5IHdoZW4KICAgICBzZXJpYWxpemluZyBhbmQgZGVzZXJpYWxpemluZyByZWxhdGlvbnNoaXAgcHJvcGVydGllcy4KICAgICBCeSBkZWZhdWx0IGBKU09OQVBJU2VyaWFsaXplcmAgZm9sbG93cyB0aGUgZm9ybWF0IHVzZWQgb24gdGhlIGV4YW1wbGVzIG9mCiAgICAgaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdCBhbmQgdXNlcyBkYXNoZXMgYXMgd29yZCBzZXBhcmF0b3JzIGluCiAgICAgcmVsYXRpb25zaGlwIHByb3BlcnRpZXMuCiAgICAgIFRoaXMgYmVoYXZpb3VyIGNhbiBiZSBlYXNpbHkgY3VzdG9taXplZCBieSBleHRlbmRpbmcgdGhpcyBtZXRob2QuCiAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9wb3N0LmpzCiAgICAgIGltcG9ydCBKU09OQVBJU2VyaWFsaXplciBmcm9tICdAZW1iZXItZGF0YS9zZXJpYWxpemVyL2pzb24tYXBpJzsKICAgICAgaW1wb3J0IHsgdW5kZXJzY29yZSB9IGZyb20gJ0BlbWJlci9zdHJpbmcnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgSlNPTkFQSVNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBrZXlGb3JSZWxhdGlvbnNoaXAoa2V5LCByZWxhdGlvbnNoaXAsIG1ldGhvZCkgewogICAgICAgICAgcmV0dXJuIHVuZGVyc2NvcmUoa2V5KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICBAbWV0aG9kIGtleUZvclJlbGF0aW9uc2hpcAogICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkKICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZUNsYXNzCiAgICAgQHBhcmFtIHtTdHJpbmd9IG1ldGhvZAogICAgIEByZXR1cm4ge1N0cmluZ30gbm9ybWFsaXplZCBrZXkKICAgICovCiAgICBrZXlGb3JSZWxhdGlvbnNoaXA6IGZ1bmN0aW9uIGtleUZvclJlbGF0aW9uc2hpcChrZXksIHR5cGVDbGFzcywgbWV0aG9kKSB7CiAgICAgIHJldHVybiBFbWJlci5TdHJpbmcuZGFzaGVyaXplKGtleSk7CiAgICB9LAogICAgc2VyaWFsaXplOiBmdW5jdGlvbiBzZXJpYWxpemUoc25hcHNob3QsIG9wdGlvbnMpIHsKICAgICAgdmFyIGRhdGEgPSB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgZGF0YS50eXBlID0gdGhpcy5wYXlsb2FkS2V5RnJvbU1vZGVsTmFtZShzbmFwc2hvdC5tb2RlbE5hbWUpOwogICAgICByZXR1cm4gewogICAgICAgIGRhdGE6IGRhdGEKICAgICAgfTsKICAgIH0sCiAgICBzZXJpYWxpemVBdHRyaWJ1dGU6IGZ1bmN0aW9uIHNlcmlhbGl6ZUF0dHJpYnV0ZShzbmFwc2hvdCwganNvbiwga2V5LCBhdHRyaWJ1dGUpIHsKICAgICAgdmFyIHR5cGUgPSBhdHRyaWJ1dGUudHlwZTsKCiAgICAgIGlmICh0aGlzLl9jYW5TZXJpYWxpemUoa2V5KSkgewogICAgICAgIGpzb24uYXR0cmlidXRlcyA9IGpzb24uYXR0cmlidXRlcyB8fCB7fTsKICAgICAgICB2YXIgdmFsdWUgPSBzbmFwc2hvdC5hdHRyKGtleSk7CgogICAgICAgIGlmICh0eXBlKSB7CiAgICAgICAgICB2YXIgdHJhbnNmb3JtID0gdGhpcy50cmFuc2Zvcm1Gb3IodHlwZSk7CiAgICAgICAgICB2YWx1ZSA9IHRyYW5zZm9ybS5zZXJpYWxpemUodmFsdWUsIGF0dHJpYnV0ZS5vcHRpb25zKTsKICAgICAgICB9CgogICAgICAgIHZhciBwYXlsb2FkS2V5ID0gdGhpcy5fZ2V0TWFwcGVkS2V5KGtleSwgc25hcHNob3QudHlwZSk7CgogICAgICAgIGlmIChwYXlsb2FkS2V5ID09PSBrZXkpIHsKICAgICAgICAgIHBheWxvYWRLZXkgPSB0aGlzLmtleUZvckF0dHJpYnV0ZShrZXksICdzZXJpYWxpemUnKTsKICAgICAgICB9CgogICAgICAgIGpzb24uYXR0cmlidXRlc1twYXlsb2FkS2V5XSA9IHZhbHVlOwogICAgICB9CiAgICB9LAogICAgc2VyaWFsaXplQmVsb25nc1RvOiBmdW5jdGlvbiBzZXJpYWxpemVCZWxvbmdzVG8oc25hcHNob3QsIGpzb24sIHJlbGF0aW9uc2hpcCkgewogICAgICB2YXIga2V5ID0gcmVsYXRpb25zaGlwLmtleTsKCiAgICAgIGlmICh0aGlzLl9jYW5TZXJpYWxpemUoa2V5KSkgewogICAgICAgIHZhciBiZWxvbmdzVG8gPSBzbmFwc2hvdC5iZWxvbmdzVG8oa2V5KTsKICAgICAgICB2YXIgYmVsb25nc1RvSXNOb3ROZXc7CgogICAgICAgIGlmIChfY2FuYXJ5RmVhdHVyZXMuQ1VTVE9NX01PREVMX0NMQVNTKSB7CiAgICAgICAgICBiZWxvbmdzVG9Jc05vdE5ldyA9IGJlbG9uZ3NUbyAmJiAhYmVsb25nc1RvLmlzTmV3OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBiZWxvbmdzVG9Jc05vdE5ldyA9IGJlbG9uZ3NUbyAmJiBiZWxvbmdzVG8ucmVjb3JkICYmICFiZWxvbmdzVG8ucmVjb3JkLmdldCgnaXNOZXcnKTsKICAgICAgICB9CgogICAgICAgIGlmIChiZWxvbmdzVG8gPT09IG51bGwgfHwgYmVsb25nc1RvSXNOb3ROZXcpIHsKICAgICAgICAgIGpzb24ucmVsYXRpb25zaGlwcyA9IGpzb24ucmVsYXRpb25zaGlwcyB8fCB7fTsKCiAgICAgICAgICB2YXIgcGF5bG9hZEtleSA9IHRoaXMuX2dldE1hcHBlZEtleShrZXksIHNuYXBzaG90LnR5cGUpOwoKICAgICAgICAgIGlmIChwYXlsb2FkS2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgcGF5bG9hZEtleSA9IHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKGtleSwgJ2JlbG9uZ3NUbycsICdzZXJpYWxpemUnKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgZGF0YSA9IG51bGw7CgogICAgICAgICAgaWYgKGJlbG9uZ3NUbykgewogICAgICAgICAgICB2YXIgcGF5bG9hZFR5cGUgPSB0aGlzLnBheWxvYWRLZXlGcm9tTW9kZWxOYW1lKGJlbG9uZ3NUby5tb2RlbE5hbWUpOwogICAgICAgICAgICBkYXRhID0gewogICAgICAgICAgICAgIHR5cGU6IHBheWxvYWRUeXBlLAogICAgICAgICAgICAgIGlkOiBiZWxvbmdzVG8uaWQKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KCiAgICAgICAgICBqc29uLnJlbGF0aW9uc2hpcHNbcGF5bG9hZEtleV0gPSB7CiAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgc2VyaWFsaXplSGFzTWFueTogZnVuY3Rpb24gc2VyaWFsaXplSGFzTWFueShzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKSB7CiAgICAgIHZhciBrZXkgPSByZWxhdGlvbnNoaXAua2V5OwoKICAgICAgaWYgKHRoaXMuc2hvdWxkU2VyaWFsaXplSGFzTWFueShzbmFwc2hvdCwga2V5LCByZWxhdGlvbnNoaXApKSB7CiAgICAgICAgdmFyIGhhc01hbnkgPSBzbmFwc2hvdC5oYXNNYW55KGtleSk7CgogICAgICAgIGlmIChoYXNNYW55ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGpzb24ucmVsYXRpb25zaGlwcyA9IGpzb24ucmVsYXRpb25zaGlwcyB8fCB7fTsKCiAgICAgICAgICB2YXIgcGF5bG9hZEtleSA9IHRoaXMuX2dldE1hcHBlZEtleShrZXksIHNuYXBzaG90LnR5cGUpOwoKICAgICAgICAgIGlmIChwYXlsb2FkS2V5ID09PSBrZXkgJiYgdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXApIHsKICAgICAgICAgICAgcGF5bG9hZEtleSA9IHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKGtleSwgJ2hhc01hbnknLCAnc2VyaWFsaXplJyk7CiAgICAgICAgICB9IC8vIG9ubHkgc2VyaWFsaXplIGhhcyBtYW55IHJlbGF0aW9uc2hpcHMgdGhhdCBhcmUgbm90IG5ldwoKCiAgICAgICAgICB2YXIgbm9uTmV3SGFzTWFueSA9IGhhc01hbnkuZmlsdGVyKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgICAgIHJldHVybiBpdGVtLnJlY29yZCAmJiAhaXRlbS5yZWNvcmQuZ2V0KCdpc05ldycpOwogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgZGF0YSA9IG5ldyBBcnJheShub25OZXdIYXNNYW55Lmxlbmd0aCk7CgogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub25OZXdIYXNNYW55Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBpdGVtID0gaGFzTWFueVtpXTsKICAgICAgICAgICAgdmFyIHBheWxvYWRUeXBlID0gdGhpcy5wYXlsb2FkS2V5RnJvbU1vZGVsTmFtZShpdGVtLm1vZGVsTmFtZSk7CiAgICAgICAgICAgIGRhdGFbaV0gPSB7CiAgICAgICAgICAgICAgdHlwZTogcGF5bG9hZFR5cGUsCiAgICAgICAgICAgICAgaWQ6IGl0ZW0uaWQKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KCiAgICAgICAgICBqc29uLnJlbGF0aW9uc2hpcHNbcGF5bG9hZEtleV0gPSB7CiAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSk7CgogIGlmIChmYWxzZQogIC8qIERFQlVHICovCiAgKSB7CiAgICBKU09OQVBJU2VyaWFsaXplci5yZW9wZW4oewogICAgICB3aWxsTWVyZ2VNaXhpbjogZnVuY3Rpb24gd2lsbE1lcmdlTWl4aW4ocHJvcHMpIHsKICAgICAgICB2YXIgY29uc3RydWN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIChmYWxzZSAmJiBFbWJlci53YXJuKCJZb3UndmUgZGVmaW5lZCAnZXh0cmFjdE1ldGEnIGluICIgKyBjb25zdHJ1Y3Rvci50b1N0cmluZygpICsgIiB3aGljaCBpcyBub3QgdXNlZCBmb3Igc2VyaWFsaXplcnMgZXh0ZW5kaW5nIEpTT05BUElTZXJpYWxpemVyLiBSZWFkIG1vcmUgYXQgaHR0cHM6Ly9hcGkuZW1iZXJqcy5jb20vZW1iZXItZGF0YS9yZWxlYXNlL2NsYXNzZXMvSlNPTkFQSVNlcmlhbGl6ZXIgb24gaG93IHRvIGN1c3RvbWl6ZSBtZXRhIHdoZW4gdXNpbmcgSlNPTiBBUEkuIiwgRW1iZXIuaXNOb25lKHByb3BzLmV4dHJhY3RNZXRhKSB8fCBwcm9wcy5leHRyYWN0TWV0YSA9PT0gX2pzb24uZGVmYXVsdC5wcm90b3R5cGUuZXh0cmFjdE1ldGEsIHsKICAgICAgICAgIGlkOiAnZHMuc2VyaWFsaXplci5qc29uLWFwaS5leHRyYWN0TWV0YScKICAgICAgICB9KSk7CiAgICAgICAgKGZhbHNlICYmIEVtYmVyLndhcm4oJ1RoZSBKU09OQVBJU2VyaWFsaXplciBkb2VzIG5vdCB3b3JrIHdpdGggdGhlIEVtYmVkZGVkUmVjb3Jkc01peGluIGJlY2F1c2UgdGhlIEpTT04gQVBJIHNwZWMgZG9lcyBub3QgZGVzY3JpYmUgaG93IHRvIGZvcm1hdCBlbWJlZGRlZCByZXNvdXJjZXMuJywgIXByb3BzLmlzRW1iZWRkZWRSZWNvcmRzTWl4aW4sIHsKICAgICAgICAgIGlkOiAnZHMuc2VyaWFsaXplci5lbWJlZGRlZC1yZWNvcmRzLW1peGluLW5vdC1zdXBwb3J0ZWQnCiAgICAgICAgfSkpOwogICAgICB9LAogICAgICB3YXJuTWVzc2FnZUZvclVuZGVmaW5lZFR5cGU6IGZ1bmN0aW9uIHdhcm5NZXNzYWdlRm9yVW5kZWZpbmVkVHlwZSgpIHsKICAgICAgICByZXR1cm4gJ0VuY291bnRlcmVkIGEgcmVzb3VyY2Ugb2JqZWN0IHdpdGggYW4gdW5kZWZpbmVkIHR5cGUgKHJlc29sdmVkIHJlc291cmNlIHVzaW5nICcgKyB0aGlzLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkgKyAnKSc7CiAgICAgIH0sCiAgICAgIHdhcm5NZXNzYWdlTm9Nb2RlbEZvclR5cGU6IGZ1bmN0aW9uIHdhcm5NZXNzYWdlTm9Nb2RlbEZvclR5cGUobW9kZWxOYW1lLCBvcmlnaW5hbFR5cGUsIHVzZWRMb29rdXApIHsKICAgICAgICByZXR1cm4gIkVuY291bnRlcmVkIGEgcmVzb3VyY2Ugb2JqZWN0IHdpdGggdHlwZSBcIiIgKyBvcmlnaW5hbFR5cGUgKyAiXCIsIGJ1dCBubyBtb2RlbCB3YXMgZm91bmQgZm9yIG1vZGVsIG5hbWUgXCIiICsgbW9kZWxOYW1lICsgIlwiIChyZXNvbHZlZCBtb2RlbCBuYW1lIHVzaW5nICciICsgdGhpcy5jb25zdHJ1Y3Rvci50b1N0cmluZygpICsgIi4iICsgdXNlZExvb2t1cCArICIoXCIiICsgb3JpZ2luYWxUeXBlICsgIlwiKScpLiI7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgdmFyIF9kZWZhdWx0ID0gSlNPTkFQSVNlcmlhbGl6ZXI7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKO2RlZmluZSgiQGVtYmVyLWRhdGEvc2VyaWFsaXplci9qc29uIiwgWyJleHBvcnRzIiwgIkBlbWJlci1kYXRhL3NlcmlhbGl6ZXIiLCAiQGVtYmVyLWRhdGEvc3RvcmUvLXByaXZhdGUiLCAiQGVtYmVyLWRhdGEvc2VyaWFsaXplci8tcHJpdmF0ZSIsICJAZW1iZXItZGF0YS9zdG9yZSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9zZXJpYWxpemVyLCBfcHJpdmF0ZSwgX3ByaXZhdGUyLCBfc3RvcmUpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIC8qKgogICAgQG1vZHVsZSBAZW1iZXItZGF0YS9zZXJpYWxpemVyCiAgKi8KCiAgLyoqCiAgICBFbWJlciBEYXRhIDIuMCBTZXJpYWxpemVyOgogIAogICAgSW4gRW1iZXIgRGF0YSBhIFNlcmlhbGl6ZXIgaXMgdXNlZCB0byBzZXJpYWxpemUgYW5kIGRlc2VyaWFsaXplCiAgICByZWNvcmRzIHdoZW4gdGhleSBhcmUgdHJhbnNmZXJyZWQgaW4gYW5kIG91dCBvZiBhbiBleHRlcm5hbCBzb3VyY2UuCiAgICBUaGlzIHByb2Nlc3MgaW52b2x2ZXMgbm9ybWFsaXppbmcgcHJvcGVydHkgbmFtZXMsIHRyYW5zZm9ybWluZwogICAgYXR0cmlidXRlIHZhbHVlcyBhbmQgc2VyaWFsaXppbmcgcmVsYXRpb25zaGlwcy4KICAKICAgIEJ5IGRlZmF1bHQsIEVtYmVyIERhdGEgdXNlcyBhbmQgcmVjb21tZW5kcyB0aGUgYEpTT05BUElTZXJpYWxpemVyYC4KICAKICAgIGBKU09OU2VyaWFsaXplcmAgaXMgdXNlZnVsIGZvciBzaW1wbGVyIG9yIGxlZ2FjeSBiYWNrZW5kcyB0aGF0IG1heQogICAgbm90IHN1cHBvcnQgdGhlIGh0dHA6Ly9qc29uYXBpLm9yZy8gc3BlYy4KICAKICAgIEZvciBleGFtcGxlLCBnaXZlbiB0aGUgZm9sbG93aW5nIGBVc2VyYCBtb2RlbCBhbmQgSlNPTiBwYXlsb2FkOgogIAogICAgYGBgYXBwL21vZGVscy91c2VyLmpzCiAgICBpbXBvcnQgTW9kZWwsIHsgYXR0ciwgYmVsb25nc1RvLCBoYXNNYW55IH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogIAogICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgZnJpZW5kczogaGFzTWFueSgndXNlcicpLAogICAgICBob3VzZTogYmVsb25nc1RvKCdsb2NhdGlvbicpLAogIAogICAgICBuYW1lOiBhdHRyKCdzdHJpbmcnKQogICAgfSk7CiAgICBgYGAKICAKICAgIGBgYGpzCiAgICB7CiAgICAgIGlkOiAxLAogICAgICBuYW1lOiAnU2ViYXN0aWFuJywKICAgICAgZnJpZW5kczogWzMsIDRdLAogICAgICBsaW5rczogewogICAgICAgIGhvdXNlOiAnL2hvdXNlcy9sZWZrYWRhJwogICAgICB9CiAgICB9CiAgICBgYGAKICAKICAgIGBKU09OU2VyaWFsaXplcmAgd2lsbCBub3JtYWxpemUgdGhlIEpTT04gcGF5bG9hZCB0byB0aGUgSlNPTiBBUEkgZm9ybWF0IHRoYXQgdGhlCiAgICBFbWJlciBEYXRhIHN0b3JlIGV4cGVjdHMuCiAgCiAgICBZb3UgY2FuIGN1c3RvbWl6ZSBob3cgSlNPTlNlcmlhbGl6ZXIgcHJvY2Vzc2VzIGl0cyBwYXlsb2FkIGJ5IHBhc3Npbmcgb3B0aW9ucyBpbgogICAgdGhlIGBhdHRyc2AgaGFzaCBvciBieSBzdWJjbGFzc2luZyB0aGUgYEpTT05TZXJpYWxpemVyYCBhbmQgb3ZlcnJpZGluZyBob29rczoKICAKICAgICAgLSBUbyBjdXN0b21pemUgaG93IGEgc2luZ2xlIHJlY29yZCBpcyBub3JtYWxpemVkLCB1c2UgdGhlIGBub3JtYWxpemVgIGhvb2suCiAgICAgIC0gVG8gY3VzdG9taXplIGhvdyBgSlNPTlNlcmlhbGl6ZXJgIG5vcm1hbGl6ZXMgdGhlIHdob2xlIHNlcnZlciByZXNwb25zZSwgdXNlIHRoZQogICAgICAgIGBub3JtYWxpemVSZXNwb25zZWAgaG9vay4KICAgICAgLSBUbyBjdXN0b21pemUgaG93IGBKU09OU2VyaWFsaXplcmAgbm9ybWFsaXplcyBhIHNwZWNpZmljIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlciwKICAgICAgICB1c2Ugb25lIG9mIHRoZSBtYW55IHNwZWNpZmljIGBub3JtYWxpemVSZXNwb25zZWAgaG9va3MuCiAgICAgIC0gVG8gY3VzdG9taXplIGhvdyBgSlNPTlNlcmlhbGl6ZXJgIG5vcm1hbGl6ZXMgeW91ciBpZCwgYXR0cmlidXRlcyBvciByZWxhdGlvbnNoaXBzLAogICAgICAgIHVzZSB0aGUgYGV4dHJhY3RJZGAsIGBleHRyYWN0QXR0cmlidXRlc2AgYW5kIGBleHRyYWN0UmVsYXRpb25zaGlwc2AgaG9va3MuCiAgCiAgICBUaGUgYEpTT05TZXJpYWxpemVyYCBub3JtYWxpemF0aW9uIHByb2Nlc3MgZm9sbG93cyB0aGVzZSBzdGVwczoKICAKICAgICAgLSBgbm9ybWFsaXplUmVzcG9uc2VgIC0gZW50cnkgbWV0aG9kIHRvIHRoZSBzZXJpYWxpemVyLgogICAgICAtIGBub3JtYWxpemVDcmVhdGVSZWNvcmRSZXNwb25zZWAgLSBhIGBub3JtYWxpemVSZXNwb25zZWAgZm9yIGEgc3BlY2lmaWMgb3BlcmF0aW9uIGlzIGNhbGxlZC4KICAgICAgLSBgbm9ybWFsaXplU2luZ2xlUmVzcG9uc2VgfGBub3JtYWxpemVBcnJheVJlc3BvbnNlYCAtIGZvciBtZXRob2RzIGxpa2UgYGNyZWF0ZVJlY29yZGAgd2UgZXhwZWN0CiAgICAgICAgYSBzaW5nbGUgcmVjb3JkIGJhY2ssIHdoaWxlIGZvciBtZXRob2RzIGxpa2UgYGZpbmRBbGxgIHdlIGV4cGVjdCBtdWx0aXBsZSByZWNvcmRzIGJhY2suCiAgICAgIC0gYG5vcm1hbGl6ZWAgLSBgbm9ybWFsaXplQXJyYXlgIGl0ZXJhdGVzIGFuZCBjYWxscyBgbm9ybWFsaXplYCBmb3IgZWFjaCBvZiBpdHMgcmVjb3JkcyB3aGlsZSBgbm9ybWFsaXplU2luZ2xlYAogICAgICAgIGNhbGxzIGl0IG9uY2UuIFRoaXMgaXMgdGhlIG1ldGhvZCB5b3UgbW9zdCBsaWtlbHkgd2FudCB0byBzdWJjbGFzcy4KICAgICAgLSBgZXh0cmFjdElkYCB8IGBleHRyYWN0QXR0cmlidXRlc2AgfCBgZXh0cmFjdFJlbGF0aW9uc2hpcHNgIC0gYG5vcm1hbGl6ZWAgZGVsZWdhdGVzIHRvIHRoZXNlIG1ldGhvZHMgdG8KICAgICAgICB0dXJuIHRoZSByZWNvcmQgcGF5bG9hZCBpbnRvIHRoZSBKU09OIEFQSSBmb3JtYXQuCiAgCiAgICBAY2xhc3MgSlNPTlNlcmlhbGl6ZXIKICAgIEBleHRlbmRzIFNlcmlhbGl6ZXIKICAqLwogIHZhciBKU09OU2VyaWFsaXplciA9IF9zZXJpYWxpemVyLmRlZmF1bHQuZXh0ZW5kKHsKICAgIC8qKgogICAgICBUaGUgYHByaW1hcnlLZXlgIGlzIHVzZWQgd2hlbiBzZXJpYWxpemluZyBhbmQgZGVzZXJpYWxpemluZwogICAgICBkYXRhLiBFbWJlciBEYXRhIGFsd2F5cyB1c2VzIHRoZSBgaWRgIHByb3BlcnR5IHRvIHN0b3JlIHRoZSBpZCBvZgogICAgICB0aGUgcmVjb3JkLiBUaGUgZXh0ZXJuYWwgc291cmNlIG1heSBub3QgYWx3YXlzIGZvbGxvdyB0aGlzCiAgICAgIGNvbnZlbnRpb24uIEluIHRoZXNlIGNhc2VzIGl0IGlzIHVzZWZ1bCB0byBvdmVycmlkZSB0aGUKICAgICAgYHByaW1hcnlLZXlgIHByb3BlcnR5IHRvIG1hdGNoIHRoZSBgcHJpbWFyeUtleWAgb2YgeW91ciBleHRlcm5hbAogICAgICBzdG9yZS4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgSlNPTlNlcmlhbGl6ZXIgZnJvbSAnQGVtYmVyLWRhdGEvc2VyaWFsaXplci9qc29uJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IEpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgcHJpbWFyeUtleTogJ19pZCcKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQHByb3BlcnR5IHByaW1hcnlLZXkKICAgICAgQHR5cGUge1N0cmluZ30KICAgICAgQGRlZmF1bHQgJ2lkJwogICAgKi8KICAgIHByaW1hcnlLZXk6ICdpZCcsCgogICAgLyoqCiAgICAgIFRoZSBgYXR0cnNgIG9iamVjdCBjYW4gYmUgdXNlZCB0byBkZWNsYXJlIGEgc2ltcGxlIG1hcHBpbmcgYmV0d2VlbgogICAgICBwcm9wZXJ0eSBuYW1lcyBvbiBgTW9kZWxgIHJlY29yZHMgYW5kIHBheWxvYWQga2V5cyBpbiB0aGUKICAgICAgc2VyaWFsaXplZCBKU09OIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJlY29yZC4gQW4gb2JqZWN0IHdpdGggdGhlCiAgICAgIHByb3BlcnR5IGBrZXlgIGNhbiBhbHNvIGJlIHVzZWQgdG8gZGVzaWduYXRlIHRoZSBhdHRyaWJ1dGUncyBrZXkgb24KICAgICAgdGhlIHJlc3BvbnNlIHBheWxvYWQuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBhcHAvbW9kZWxzL3BlcnNvbi5qcwogICAgICBpbXBvcnQgTW9kZWwsIHsgYXR0ciB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgICAgZmlyc3ROYW1lOiBhdHRyKCdzdHJpbmcnKSwKICAgICAgICBsYXN0TmFtZTogYXR0cignc3RyaW5nJyksCiAgICAgICAgb2NjdXBhdGlvbjogYXR0cignc3RyaW5nJyksCiAgICAgICAgYWRtaW46IGF0dHIoJ2Jvb2xlYW4nKQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvcGVyc29uLmpzCiAgICAgIGltcG9ydCBKU09OU2VyaWFsaXplciBmcm9tICdAZW1iZXItZGF0YS9zZXJpYWxpemVyL2pzb24nOwogICAgICAgZXhwb3J0IGRlZmF1bHQgSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBhdHRyczogewogICAgICAgICAgYWRtaW46ICdpc19hZG1pbicsCiAgICAgICAgICBvY2N1cGF0aW9uOiB7IGtleTogJ2NhcmVlcicgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgWW91IGNhbiBhbHNvIHJlbW92ZSBhdHRyaWJ1dGVzIGFuZCByZWxhdGlvbnNoaXBzIGJ5IHNldHRpbmcgdGhlIGBzZXJpYWxpemVgCiAgICAgIGtleSB0byBgZmFsc2VgIGluIHlvdXIgbWFwcGluZyBvYmplY3QuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvcGVyc29uLmpzCiAgICAgIGltcG9ydCBKU09OU2VyaWFsaXplciBmcm9tICdAZW1iZXItZGF0YS9zZXJpYWxpemVyL2pzb24nOwogICAgICAgZXhwb3J0IGRlZmF1bHQgSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBhdHRyczogewogICAgICAgICAgYWRtaW46IHsgc2VyaWFsaXplOiBmYWxzZSB9LAogICAgICAgICAgb2NjdXBhdGlvbjogeyBrZXk6ICdjYXJlZXInIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFdoZW4gc2VyaWFsaXplZDoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgewogICAgICAgICJmaXJzdE5hbWUiOiAiSGFycnkiLAogICAgICAgICJsYXN0TmFtZSI6ICJIb3VkaW5pIiwKICAgICAgICAiY2FyZWVyIjogIm1hZ2ljaWFuIgogICAgICB9CiAgICAgIGBgYAogICAgICAgTm90ZSB0aGF0IHRoZSBgYWRtaW5gIGlzIG5vdyBub3QgaW5jbHVkZWQgaW4gdGhlIHBheWxvYWQuCiAgICAgICBTZXR0aW5nIGBzZXJpYWxpemVgIHRvIGB0cnVlYCBlbmZvcmNlcyBzZXJpYWxpemF0aW9uIGZvciBoYXNNYW55CiAgICAgIHJlbGF0aW9uc2hpcHMgZXZlbiBpZiBpdCdzIG5laXRoZXIgYSBtYW55LXRvLW1hbnkgbm9yIG1hbnktdG8tbm9uZQogICAgICByZWxhdGlvbnNoaXAuCiAgICAgICBAcHJvcGVydHkgYXR0cnMKICAgICAgQHR5cGUge09iamVjdH0KICAgICovCiAgICBtZXJnZWRQcm9wZXJ0aWVzOiBbJ2F0dHJzJ10sCgogICAgLyoqCiAgICAgR2l2ZW4gYSBzdWJjbGFzcyBvZiBgTW9kZWxgIGFuZCBhIEpTT04gb2JqZWN0IHRoaXMgbWV0aG9kIHdpbGwKICAgICBpdGVyYXRlIHRocm91Z2ggZWFjaCBhdHRyaWJ1dGUgb2YgdGhlIGBNb2RlbGAgYW5kIGludm9rZSB0aGUKICAgICBgVHJhbnNmb3JtI2Rlc2VyaWFsaXplYCBtZXRob2Qgb24gdGhlIG1hdGNoaW5nIHByb3BlcnR5IG9mIHRoZQogICAgIEpTT04gb2JqZWN0LiAgVGhpcyBtZXRob2QgaXMgdHlwaWNhbGx5IGNhbGxlZCBhZnRlciB0aGUKICAgICBzZXJpYWxpemVyJ3MgYG5vcm1hbGl6ZWAgbWV0aG9kLgogICAgICBAbWV0aG9kIGFwcGx5VHJhbnNmb3JtcwogICAgIEBwcml2YXRlCiAgICAgQHBhcmFtIHtNb2RlbH0gdHlwZUNsYXNzCiAgICAgQHBhcmFtIHtPYmplY3R9IGRhdGEgVGhlIGRhdGEgdG8gdHJhbnNmb3JtCiAgICAgQHJldHVybiB7T2JqZWN0fSBkYXRhIFRoZSB0cmFuc2Zvcm1lZCBkYXRhIG9iamVjdAogICAgKi8KICAgIGFwcGx5VHJhbnNmb3JtczogZnVuY3Rpb24gYXBwbHlUcmFuc2Zvcm1zKHR5cGVDbGFzcywgZGF0YSkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIGF0dHJpYnV0ZXMgPSBFbWJlci5nZXQodHlwZUNsYXNzLCAnYXR0cmlidXRlcycpOwogICAgICB0eXBlQ2xhc3MuZWFjaFRyYW5zZm9ybWVkQXR0cmlidXRlKGZ1bmN0aW9uIChrZXksIHR5cGVDbGFzcykgewogICAgICAgIGlmIChkYXRhW2tleV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHRyYW5zZm9ybSA9IF90aGlzLnRyYW5zZm9ybUZvcih0eXBlQ2xhc3MpOwoKICAgICAgICB2YXIgdHJhbnNmb3JtTWV0YSA9IGF0dHJpYnV0ZXMuZ2V0KGtleSk7CiAgICAgICAgZGF0YVtrZXldID0gdHJhbnNmb3JtLmRlc2VyaWFsaXplKGRhdGFba2V5XSwgdHJhbnNmb3JtTWV0YS5vcHRpb25zKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBkYXRhOwogICAgfSwKCiAgICAvKioKICAgICAgVGhlIGBub3JtYWxpemVSZXNwb25zZWAgbWV0aG9kIGlzIHVzZWQgdG8gbm9ybWFsaXplIGEgcGF5bG9hZCBmcm9tIHRoZQogICAgICBzZXJ2ZXIgdG8gYSBKU09OLUFQSSBEb2N1bWVudC4KICAgICAgIGh0dHA6Ly9qc29uYXBpLm9yZy9mb3JtYXQvI2RvY3VtZW50LXN0cnVjdHVyZQogICAgICAgVGhpcyBtZXRob2QgZGVsZWdhdGVzIHRvIGEgbW9yZSBzcGVjaWZpYyBub3JtYWxpemUgbWV0aG9kIGJhc2VkIG9uCiAgICAgIHRoZSBgcmVxdWVzdFR5cGVgLgogICAgICAgVG8gb3ZlcnJpZGUgdGhpcyBtZXRob2Qgd2l0aCBhIGN1c3RvbSBvbmUsIG1ha2Ugc3VyZSB0byBjYWxsCiAgICAgIGByZXR1cm4gdGhpcy5fc3VwZXIoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpYCB3aXRoIHlvdXIKICAgICAgcHJlLXByb2Nlc3NlZCBkYXRhLgogICAgICAgSGVyZSdzIGFuIGV4YW1wbGUgb2YgdXNpbmcgYG5vcm1hbGl6ZVJlc3BvbnNlYCBtYW51YWxseToKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgc29ja2V0Lm9uKCdtZXNzYWdlJywgZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgIHZhciBkYXRhID0gbWVzc2FnZS5kYXRhOwogICAgICAgIHZhciBtb2RlbENsYXNzID0gc3RvcmUubW9kZWxGb3IoZGF0YS5tb2RlbE5hbWUpOwogICAgICAgIHZhciBzZXJpYWxpemVyID0gc3RvcmUuc2VyaWFsaXplckZvcihkYXRhLm1vZGVsTmFtZSk7CiAgICAgICAgdmFyIG5vcm1hbGl6ZWQgPSBzZXJpYWxpemVyLm5vcm1hbGl6ZVNpbmdsZVJlc3BvbnNlKHN0b3JlLCBtb2RlbENsYXNzLCBkYXRhLCBkYXRhLmlkKTsKICAgICAgICAgc3RvcmUucHVzaChub3JtYWxpemVkKTsKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIG5vcm1hbGl6ZVJlc3BvbnNlCiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7TW9kZWx9IHByaW1hcnlNb2RlbENsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEBwYXJhbSB7U3RyaW5nfE51bWJlcn0gaWQKICAgICAgQHBhcmFtIHtTdHJpbmd9IHJlcXVlc3RUeXBlCiAgICAgIEByZXR1cm4ge09iamVjdH0gSlNPTi1BUEkgRG9jdW1lbnQKICAgICovCiAgICBub3JtYWxpemVSZXNwb25zZTogZnVuY3Rpb24gbm9ybWFsaXplUmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgc3dpdGNoIChyZXF1ZXN0VHlwZSkgewogICAgICAgIGNhc2UgJ2ZpbmRSZWNvcmQnOgogICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplRmluZFJlY29yZFJlc3BvbnNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIGNhc2UgJ3F1ZXJ5UmVjb3JkJzoKICAgICAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZVF1ZXJ5UmVjb3JkUmVzcG9uc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgY2FzZSAnZmluZEFsbCc6CiAgICAgICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVGaW5kQWxsUmVzcG9uc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgY2FzZSAnZmluZEJlbG9uZ3NUbyc6CiAgICAgICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVGaW5kQmVsb25nc1RvUmVzcG9uc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgY2FzZSAnZmluZEhhc01hbnknOgogICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplRmluZEhhc01hbnlSZXNwb25zZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICBjYXNlICdmaW5kTWFueSc6CiAgICAgICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVGaW5kTWFueVJlc3BvbnNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIGNhc2UgJ3F1ZXJ5JzoKICAgICAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZVF1ZXJ5UmVzcG9uc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgY2FzZSAnY3JlYXRlUmVjb3JkJzoKICAgICAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZUNyZWF0ZVJlY29yZFJlc3BvbnNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIGNhc2UgJ2RlbGV0ZVJlY29yZCc6CiAgICAgICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVEZWxldGVSZWNvcmRSZXNwb25zZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICBjYXNlICd1cGRhdGVSZWNvcmQnOgogICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplVXBkYXRlUmVjb3JkUmVzcG9uc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIG5vcm1hbGl6ZUZpbmRSZWNvcmRSZXNwb25zZQogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge01vZGVsfSBwcmltYXJ5TW9kZWxDbGFzcwogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IGlkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSByZXF1ZXN0VHlwZQogICAgICBAcmV0dXJuIHtPYmplY3R9IEpTT04tQVBJIERvY3VtZW50CiAgICAqLwogICAgbm9ybWFsaXplRmluZFJlY29yZFJlc3BvbnNlOiBmdW5jdGlvbiBub3JtYWxpemVGaW5kUmVjb3JkUmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplU2luZ2xlUmVzcG9uc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLyoqCiAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBub3JtYWxpemVRdWVyeVJlY29yZFJlc3BvbnNlCiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7TW9kZWx9IHByaW1hcnlNb2RlbENsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEBwYXJhbSB7U3RyaW5nfE51bWJlcn0gaWQKICAgICAgQHBhcmFtIHtTdHJpbmd9IHJlcXVlc3RUeXBlCiAgICAgIEByZXR1cm4ge09iamVjdH0gSlNPTi1BUEkgRG9jdW1lbnQKICAgICovCiAgICBub3JtYWxpemVRdWVyeVJlY29yZFJlc3BvbnNlOiBmdW5jdGlvbiBub3JtYWxpemVRdWVyeVJlY29yZFJlc3BvbnNlKHN0b3JlLCBwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCwgaWQsIHJlcXVlc3RUeXBlKSB7CiAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZVNpbmdsZVJlc3BvbnNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8qKgogICAgICBAc2luY2UgMS4xMy4wCiAgICAgIEBtZXRob2Qgbm9ybWFsaXplRmluZEFsbFJlc3BvbnNlCiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7TW9kZWx9IHByaW1hcnlNb2RlbENsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEBwYXJhbSB7U3RyaW5nfE51bWJlcn0gaWQKICAgICAgQHBhcmFtIHtTdHJpbmd9IHJlcXVlc3RUeXBlCiAgICAgIEByZXR1cm4ge09iamVjdH0gSlNPTi1BUEkgRG9jdW1lbnQKICAgICovCiAgICBub3JtYWxpemVGaW5kQWxsUmVzcG9uc2U6IGZ1bmN0aW9uIG5vcm1hbGl6ZUZpbmRBbGxSZXNwb25zZShzdG9yZSwgcHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSkgewogICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVBcnJheVJlc3BvbnNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8qKgogICAgICBAc2luY2UgMS4xMy4wCiAgICAgIEBtZXRob2Qgbm9ybWFsaXplRmluZEJlbG9uZ3NUb1Jlc3BvbnNlCiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7TW9kZWx9IHByaW1hcnlNb2RlbENsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEBwYXJhbSB7U3RyaW5nfE51bWJlcn0gaWQKICAgICAgQHBhcmFtIHtTdHJpbmd9IHJlcXVlc3RUeXBlCiAgICAgIEByZXR1cm4ge09iamVjdH0gSlNPTi1BUEkgRG9jdW1lbnQKICAgICovCiAgICBub3JtYWxpemVGaW5kQmVsb25nc1RvUmVzcG9uc2U6IGZ1bmN0aW9uIG5vcm1hbGl6ZUZpbmRCZWxvbmdzVG9SZXNwb25zZShzdG9yZSwgcHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSkgewogICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVTaW5nbGVSZXNwb25zZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvKioKICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIG5vcm1hbGl6ZUZpbmRIYXNNYW55UmVzcG9uc2UKICAgICAgQHBhcmFtIHtTdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtNb2RlbH0gcHJpbWFyeU1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBpZAogICAgICBAcGFyYW0ge1N0cmluZ30gcmVxdWVzdFR5cGUKICAgICAgQHJldHVybiB7T2JqZWN0fSBKU09OLUFQSSBEb2N1bWVudAogICAgKi8KICAgIG5vcm1hbGl6ZUZpbmRIYXNNYW55UmVzcG9uc2U6IGZ1bmN0aW9uIG5vcm1hbGl6ZUZpbmRIYXNNYW55UmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplQXJyYXlSZXNwb25zZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvKioKICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIG5vcm1hbGl6ZUZpbmRNYW55UmVzcG9uc2UKICAgICAgQHBhcmFtIHtTdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtNb2RlbH0gcHJpbWFyeU1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBpZAogICAgICBAcGFyYW0ge1N0cmluZ30gcmVxdWVzdFR5cGUKICAgICAgQHJldHVybiB7T2JqZWN0fSBKU09OLUFQSSBEb2N1bWVudAogICAgKi8KICAgIG5vcm1hbGl6ZUZpbmRNYW55UmVzcG9uc2U6IGZ1bmN0aW9uIG5vcm1hbGl6ZUZpbmRNYW55UmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplQXJyYXlSZXNwb25zZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvKioKICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIG5vcm1hbGl6ZVF1ZXJ5UmVzcG9uc2UKICAgICAgQHBhcmFtIHtTdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtNb2RlbH0gcHJpbWFyeU1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBpZAogICAgICBAcGFyYW0ge1N0cmluZ30gcmVxdWVzdFR5cGUKICAgICAgQHJldHVybiB7T2JqZWN0fSBKU09OLUFQSSBEb2N1bWVudAogICAgKi8KICAgIG5vcm1hbGl6ZVF1ZXJ5UmVzcG9uc2U6IGZ1bmN0aW9uIG5vcm1hbGl6ZVF1ZXJ5UmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplQXJyYXlSZXNwb25zZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvKioKICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIG5vcm1hbGl6ZUNyZWF0ZVJlY29yZFJlc3BvbnNlCiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7TW9kZWx9IHByaW1hcnlNb2RlbENsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEBwYXJhbSB7U3RyaW5nfE51bWJlcn0gaWQKICAgICAgQHBhcmFtIHtTdHJpbmd9IHJlcXVlc3RUeXBlCiAgICAgIEByZXR1cm4ge09iamVjdH0gSlNPTi1BUEkgRG9jdW1lbnQKICAgICovCiAgICBub3JtYWxpemVDcmVhdGVSZWNvcmRSZXNwb25zZTogZnVuY3Rpb24gbm9ybWFsaXplQ3JlYXRlUmVjb3JkUmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplU2F2ZVJlc3BvbnNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8qKgogICAgICBAc2luY2UgMS4xMy4wCiAgICAgIEBtZXRob2Qgbm9ybWFsaXplRGVsZXRlUmVjb3JkUmVzcG9uc2UKICAgICAgQHBhcmFtIHtTdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtNb2RlbH0gcHJpbWFyeU1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBpZAogICAgICBAcGFyYW0ge1N0cmluZ30gcmVxdWVzdFR5cGUKICAgICAgQHJldHVybiB7T2JqZWN0fSBKU09OLUFQSSBEb2N1bWVudAogICAgKi8KICAgIG5vcm1hbGl6ZURlbGV0ZVJlY29yZFJlc3BvbnNlOiBmdW5jdGlvbiBub3JtYWxpemVEZWxldGVSZWNvcmRSZXNwb25zZShzdG9yZSwgcHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSkgewogICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVTYXZlUmVzcG9uc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLyoqCiAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBub3JtYWxpemVVcGRhdGVSZWNvcmRSZXNwb25zZQogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge01vZGVsfSBwcmltYXJ5TW9kZWxDbGFzcwogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IGlkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSByZXF1ZXN0VHlwZQogICAgICBAcmV0dXJuIHtPYmplY3R9IEpTT04tQVBJIERvY3VtZW50CiAgICAqLwogICAgbm9ybWFsaXplVXBkYXRlUmVjb3JkUmVzcG9uc2U6IGZ1bmN0aW9uIG5vcm1hbGl6ZVVwZGF0ZVJlY29yZFJlc3BvbnNlKHN0b3JlLCBwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCwgaWQsIHJlcXVlc3RUeXBlKSB7CiAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZVNhdmVSZXNwb25zZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvKioKICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIG5vcm1hbGl6ZVNhdmVSZXNwb25zZQogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge01vZGVsfSBwcmltYXJ5TW9kZWxDbGFzcwogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IGlkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSByZXF1ZXN0VHlwZQogICAgICBAcmV0dXJuIHtPYmplY3R9IEpTT04tQVBJIERvY3VtZW50CiAgICAqLwogICAgbm9ybWFsaXplU2F2ZVJlc3BvbnNlOiBmdW5jdGlvbiBub3JtYWxpemVTYXZlUmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplU2luZ2xlUmVzcG9uc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLyoqCiAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBub3JtYWxpemVTaW5nbGVSZXNwb25zZQogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge01vZGVsfSBwcmltYXJ5TW9kZWxDbGFzcwogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IGlkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSByZXF1ZXN0VHlwZQogICAgICBAcmV0dXJuIHtPYmplY3R9IEpTT04tQVBJIERvY3VtZW50CiAgICAqLwogICAgbm9ybWFsaXplU2luZ2xlUmVzcG9uc2U6IGZ1bmN0aW9uIG5vcm1hbGl6ZVNpbmdsZVJlc3BvbnNlKHN0b3JlLCBwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCwgaWQsIHJlcXVlc3RUeXBlKSB7CiAgICAgIHJldHVybiB0aGlzLl9ub3JtYWxpemVSZXNwb25zZShzdG9yZSwgcHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSwgdHJ1ZSk7CiAgICB9LAoKICAgIC8qKgogICAgICBAc2luY2UgMS4xMy4wCiAgICAgIEBtZXRob2Qgbm9ybWFsaXplQXJyYXlSZXNwb25zZQogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge01vZGVsfSBwcmltYXJ5TW9kZWxDbGFzcwogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IGlkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSByZXF1ZXN0VHlwZQogICAgICBAcmV0dXJuIHtPYmplY3R9IEpTT04tQVBJIERvY3VtZW50CiAgICAqLwogICAgbm9ybWFsaXplQXJyYXlSZXNwb25zZTogZnVuY3Rpb24gbm9ybWFsaXplQXJyYXlSZXNwb25zZShzdG9yZSwgcHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSkgewogICAgICByZXR1cm4gdGhpcy5fbm9ybWFsaXplUmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUsIGZhbHNlKTsKICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2QgX25vcm1hbGl6ZVJlc3BvbnNlCiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7TW9kZWx9IHByaW1hcnlNb2RlbENsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEBwYXJhbSB7U3RyaW5nfE51bWJlcn0gaWQKICAgICAgQHBhcmFtIHtTdHJpbmd9IHJlcXVlc3RUeXBlCiAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gaXNTaW5nbGUKICAgICAgQHJldHVybiB7T2JqZWN0fSBKU09OLUFQSSBEb2N1bWVudAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9ub3JtYWxpemVSZXNwb25zZTogZnVuY3Rpb24gX25vcm1hbGl6ZVJlc3BvbnNlKHN0b3JlLCBwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCwgaWQsIHJlcXVlc3RUeXBlLCBpc1NpbmdsZSkgewogICAgICB2YXIgZG9jdW1lbnRIYXNoID0gewogICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgaW5jbHVkZWQ6IFtdCiAgICAgIH07CiAgICAgIHZhciBtZXRhID0gdGhpcy5leHRyYWN0TWV0YShzdG9yZSwgcHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQpOwoKICAgICAgaWYgKG1ldGEpIHsKICAgICAgICAoZmFsc2UgJiYgIShFbWJlci50eXBlT2YobWV0YSkgPT09ICdvYmplY3QnKSAmJiBFbWJlci5hc3NlcnQoJ1RoZSBgbWV0YWAgcmV0dXJuZWQgZnJvbSBgZXh0cmFjdE1ldGFgIGhhcyB0byBiZSBhbiBvYmplY3QsIG5vdCAiJyArIEVtYmVyLnR5cGVPZihtZXRhKSArICciLicsIEVtYmVyLnR5cGVPZihtZXRhKSA9PT0gJ29iamVjdCcpKTsKICAgICAgICBkb2N1bWVudEhhc2gubWV0YSA9IG1ldGE7CiAgICAgIH0KCiAgICAgIGlmIChpc1NpbmdsZSkgewogICAgICAgIHZhciBfdGhpcyRub3JtYWxpemUgPSB0aGlzLm5vcm1hbGl6ZShwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCksCiAgICAgICAgICAgIGRhdGEgPSBfdGhpcyRub3JtYWxpemUuZGF0YSwKICAgICAgICAgICAgaW5jbHVkZWQgPSBfdGhpcyRub3JtYWxpemUuaW5jbHVkZWQ7CgogICAgICAgIGRvY3VtZW50SGFzaC5kYXRhID0gZGF0YTsKCiAgICAgICAgaWYgKGluY2x1ZGVkKSB7CiAgICAgICAgICBkb2N1bWVudEhhc2guaW5jbHVkZWQgPSBpbmNsdWRlZDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHJldCA9IG5ldyBBcnJheShwYXlsb2FkLmxlbmd0aCk7CgogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gcGF5bG9hZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHZhciBpdGVtID0gcGF5bG9hZFtpXTsKCiAgICAgICAgICB2YXIgX3RoaXMkbm9ybWFsaXplMiA9IHRoaXMubm9ybWFsaXplKHByaW1hcnlNb2RlbENsYXNzLCBpdGVtKSwKICAgICAgICAgICAgICBfZGF0YSA9IF90aGlzJG5vcm1hbGl6ZTIuZGF0YSwKICAgICAgICAgICAgICBfaW5jbHVkZWQgPSBfdGhpcyRub3JtYWxpemUyLmluY2x1ZGVkOwoKICAgICAgICAgIGlmIChfaW5jbHVkZWQpIHsKICAgICAgICAgICAgdmFyIF9kb2N1bWVudEhhc2gkaW5jbHVkZTsKCiAgICAgICAgICAgIChfZG9jdW1lbnRIYXNoJGluY2x1ZGUgPSBkb2N1bWVudEhhc2guaW5jbHVkZWQpLnB1c2guYXBwbHkoX2RvY3VtZW50SGFzaCRpbmNsdWRlLCBfaW5jbHVkZWQpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldFtpXSA9IF9kYXRhOwogICAgICAgIH0KCiAgICAgICAgZG9jdW1lbnRIYXNoLmRhdGEgPSByZXQ7CiAgICAgIH0KCiAgICAgIHJldHVybiBkb2N1bWVudEhhc2g7CiAgICB9LAoKICAgIC8qKgogICAgICBOb3JtYWxpemVzIGEgcGFydCBvZiB0aGUgSlNPTiBwYXlsb2FkIHJldHVybmVkIGJ5CiAgICAgIHRoZSBzZXJ2ZXIuIFlvdSBzaG91bGQgb3ZlcnJpZGUgdGhpcyBtZXRob2QsIG11bmdlIHRoZSBoYXNoCiAgICAgIGFuZCBjYWxsIHN1cGVyIGlmIHlvdSBoYXZlIGdlbmVyaWMgbm9ybWFsaXphdGlvbiB0byBkby4KICAgICAgIEl0IHRha2VzIHRoZSB0eXBlIG9mIHRoZSByZWNvcmQgdGhhdCBpcyBiZWluZyBub3JtYWxpemVkCiAgICAgIChhcyBhIE1vZGVsIGNsYXNzKSwgdGhlIHByb3BlcnR5IHdoZXJlIHRoZSBoYXNoIHdhcwogICAgICBvcmlnaW5hbGx5IGZvdW5kLCBhbmQgdGhlIGhhc2ggdG8gbm9ybWFsaXplLgogICAgICAgWW91IGNhbiB1c2UgdGhpcyBtZXRob2QsIGZvciBleGFtcGxlLCB0byBub3JtYWxpemUgdW5kZXJzY29yZWQga2V5cyB0byBjYW1lbGl6ZWQKICAgICAgb3Igb3RoZXIgZ2VuZXJhbC1wdXJwb3NlIG5vcm1hbGl6YXRpb25zLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBKU09OU2VyaWFsaXplciBmcm9tICdAZW1iZXItZGF0YS9zZXJpYWxpemVyL2pzb24nOwogICAgICBpbXBvcnQgeyB1bmRlcnNjb3JlIH0gZnJvbSAnQGVtYmVyL3N0cmluZyc7CiAgICAgIGltcG9ydCB7IGdldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBub3JtYWxpemUodHlwZUNsYXNzLCBoYXNoKSB7CiAgICAgICAgICB2YXIgZmllbGRzID0gZ2V0KHR5cGVDbGFzcywgJ2ZpZWxkcycpOwogICAgICAgICAgIGZpZWxkcy5mb3JFYWNoKGZ1bmN0aW9uKHR5cGUsIGZpZWxkKSB7CiAgICAgICAgICAgIHZhciBwYXlsb2FkRmllbGQgPSB1bmRlcnNjb3JlKGZpZWxkKTsKICAgICAgICAgICAgaWYgKGZpZWxkID09PSBwYXlsb2FkRmllbGQpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgICBoYXNoW2ZpZWxkXSA9IGhhc2hbcGF5bG9hZEZpZWxkXTsKICAgICAgICAgICAgZGVsZXRlIGhhc2hbcGF5bG9hZEZpZWxkXTsKICAgICAgICAgIH0pOwogICAgICAgICAgIHJldHVybiB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBub3JtYWxpemUKICAgICAgQHBhcmFtIHtNb2RlbH0gdHlwZUNsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBoYXNoCiAgICAgIEByZXR1cm4ge09iamVjdH0KICAgICovCiAgICBub3JtYWxpemU6IGZ1bmN0aW9uIG5vcm1hbGl6ZShtb2RlbENsYXNzLCByZXNvdXJjZUhhc2gpIHsKICAgICAgdmFyIGRhdGEgPSBudWxsOwoKICAgICAgaWYgKHJlc291cmNlSGFzaCkgewogICAgICAgIHRoaXMubm9ybWFsaXplVXNpbmdEZWNsYXJlZE1hcHBpbmcobW9kZWxDbGFzcywgcmVzb3VyY2VIYXNoKTsKCiAgICAgICAgaWYgKEVtYmVyLnR5cGVPZihyZXNvdXJjZUhhc2gubGlua3MpID09PSAnb2JqZWN0JykgewogICAgICAgICAgdGhpcy5ub3JtYWxpemVVc2luZ0RlY2xhcmVkTWFwcGluZyhtb2RlbENsYXNzLCByZXNvdXJjZUhhc2gubGlua3MpOwogICAgICAgIH0KCiAgICAgICAgZGF0YSA9IHsKICAgICAgICAgIGlkOiB0aGlzLmV4dHJhY3RJZChtb2RlbENsYXNzLCByZXNvdXJjZUhhc2gpLAogICAgICAgICAgdHlwZTogbW9kZWxDbGFzcy5tb2RlbE5hbWUsCiAgICAgICAgICBhdHRyaWJ1dGVzOiB0aGlzLmV4dHJhY3RBdHRyaWJ1dGVzKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCksCiAgICAgICAgICByZWxhdGlvbnNoaXBzOiB0aGlzLmV4dHJhY3RSZWxhdGlvbnNoaXBzKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCkKICAgICAgICB9OwogICAgICAgIHRoaXMuYXBwbHlUcmFuc2Zvcm1zKG1vZGVsQ2xhc3MsIGRhdGEuYXR0cmlidXRlcyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgZGF0YTogZGF0YQogICAgICB9OwogICAgfSwKCiAgICAvKioKICAgICAgUmV0dXJucyB0aGUgcmVzb3VyY2UncyBJRC4KICAgICAgIEBtZXRob2QgZXh0cmFjdElkCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2RlbENsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSByZXNvdXJjZUhhc2gKICAgICAgQHJldHVybiB7U3RyaW5nfQogICAgKi8KICAgIGV4dHJhY3RJZDogZnVuY3Rpb24gZXh0cmFjdElkKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCkgewogICAgICB2YXIgcHJpbWFyeUtleSA9IEVtYmVyLmdldCh0aGlzLCAncHJpbWFyeUtleScpOwogICAgICB2YXIgaWQgPSByZXNvdXJjZUhhc2hbcHJpbWFyeUtleV07CiAgICAgIHJldHVybiAoMCwgX3ByaXZhdGUuY29lcmNlSWQpKGlkKTsKICAgIH0sCgogICAgLyoqCiAgICAgIFJldHVybnMgdGhlIHJlc291cmNlJ3MgYXR0cmlidXRlcyBmb3JtYXR0ZWQgYXMgYSBKU09OLUFQSSAiYXR0cmlidXRlcyBvYmplY3QiLgogICAgICAgaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZG9jdW1lbnQtcmVzb3VyY2Utb2JqZWN0LWF0dHJpYnV0ZXMKICAgICAgIEBtZXRob2QgZXh0cmFjdEF0dHJpYnV0ZXMKICAgICAgQHBhcmFtIHtPYmplY3R9IG1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlc291cmNlSGFzaAogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAqLwogICAgZXh0cmFjdEF0dHJpYnV0ZXM6IGZ1bmN0aW9uIGV4dHJhY3RBdHRyaWJ1dGVzKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIHZhciBhdHRyaWJ1dGVLZXk7CiAgICAgIHZhciBhdHRyaWJ1dGVzID0ge307CiAgICAgIG1vZGVsQ2xhc3MuZWFjaEF0dHJpYnV0ZShmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgYXR0cmlidXRlS2V5ID0gX3RoaXMyLmtleUZvckF0dHJpYnV0ZShrZXksICdkZXNlcmlhbGl6ZScpOwoKICAgICAgICBpZiAocmVzb3VyY2VIYXNoW2F0dHJpYnV0ZUtleV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgYXR0cmlidXRlc1trZXldID0gcmVzb3VyY2VIYXNoW2F0dHJpYnV0ZUtleV07CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIGF0dHJpYnV0ZXM7CiAgICB9LAoKICAgIC8qKgogICAgICBSZXR1cm5zIGEgcmVsYXRpb25zaGlwIGZvcm1hdHRlZCBhcyBhIEpTT04tQVBJICJyZWxhdGlvbnNoaXAgb2JqZWN0Ii4KICAgICAgIGh0dHA6Ly9qc29uYXBpLm9yZy9mb3JtYXQvI2RvY3VtZW50LXJlc291cmNlLW9iamVjdC1yZWxhdGlvbnNoaXBzCiAgICAgICBAbWV0aG9kIGV4dHJhY3RSZWxhdGlvbnNoaXAKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlbGF0aW9uc2hpcE1vZGVsTmFtZQogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwSGFzaAogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAqLwogICAgZXh0cmFjdFJlbGF0aW9uc2hpcDogZnVuY3Rpb24gZXh0cmFjdFJlbGF0aW9uc2hpcChyZWxhdGlvbnNoaXBNb2RlbE5hbWUsIHJlbGF0aW9uc2hpcEhhc2gpIHsKICAgICAgaWYgKEVtYmVyLmlzTm9uZShyZWxhdGlvbnNoaXBIYXNoKSkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIC8qCiAgICAgICAgV2hlbiBgcmVsYXRpb25zaGlwSGFzaGAgaXMgYW4gb2JqZWN0IGl0IHVzdWFsbHkgbWVhbnMgdGhhdCB0aGUgcmVsYXRpb25zaGlwCiAgICAgICAgaXMgcG9seW1vcnBoaWMuIEl0IGNvdWxkIGhvd2V2ZXIgYWxzbyBiZSBlbWJlZGRlZCByZXNvdXJjZXMgdGhhdCB0aGUKICAgICAgICBFbWJlZGRlZFJlY29yZHNNaXhpbiBoYXMgYmUgYWJsZSB0byBwcm9jZXNzLgogICAgICAqLwoKCiAgICAgIGlmIChFbWJlci50eXBlT2YocmVsYXRpb25zaGlwSGFzaCkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgaWYgKHJlbGF0aW9uc2hpcEhhc2guaWQpIHsKICAgICAgICAgIHJlbGF0aW9uc2hpcEhhc2guaWQgPSAoMCwgX3ByaXZhdGUuY29lcmNlSWQpKHJlbGF0aW9uc2hpcEhhc2guaWQpOwogICAgICAgIH0KCiAgICAgICAgdmFyIG1vZGVsQ2xhc3MgPSB0aGlzLnN0b3JlLm1vZGVsRm9yKHJlbGF0aW9uc2hpcE1vZGVsTmFtZSk7CgogICAgICAgIGlmIChyZWxhdGlvbnNoaXBIYXNoLnR5cGUgJiYgISgwLCBfcHJpdmF0ZTIubW9kZWxIYXNBdHRyaWJ1dGVPclJlbGF0aW9uc2hpcE5hbWVkVHlwZSkobW9kZWxDbGFzcykpIHsKICAgICAgICAgIHJlbGF0aW9uc2hpcEhhc2gudHlwZSA9IHRoaXMubW9kZWxOYW1lRnJvbVBheWxvYWRLZXkocmVsYXRpb25zaGlwSGFzaC50eXBlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZWxhdGlvbnNoaXBIYXNoOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGlkOiAoMCwgX3ByaXZhdGUuY29lcmNlSWQpKHJlbGF0aW9uc2hpcEhhc2gpLAogICAgICAgIHR5cGU6IHJlbGF0aW9uc2hpcE1vZGVsTmFtZQogICAgICB9OwogICAgfSwKCiAgICAvKioKICAgICAgUmV0dXJucyBhIHBvbHltb3JwaGljIHJlbGF0aW9uc2hpcCBmb3JtYXR0ZWQgYXMgYSBKU09OLUFQSSAicmVsYXRpb25zaGlwIG9iamVjdCIuCiAgICAgICBodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0LyNkb2N1bWVudC1yZXNvdXJjZS1vYmplY3QtcmVsYXRpb25zaGlwcwogICAgICAgYHJlbGF0aW9uc2hpcE9wdGlvbnNgIGlzIGEgaGFzaCB3aGljaCBjb250YWlucyBtb3JlIGluZm9ybWF0aW9uIGFib3V0IHRoZQogICAgICBwb2x5bW9ycGhpYyByZWxhdGlvbnNoaXAgd2hpY2ggc2hvdWxkIGJlIGV4dHJhY3RlZDoKICAgICAgICAtIGByZXNvdXJjZUhhc2hgIGNvbXBsZXRlIGhhc2ggb2YgdGhlIHJlc291cmNlIHRoZSByZWxhdGlvbnNoaXAgc2hvdWxkIGJlCiAgICAgICAgICBleHRyYWN0ZWQgZnJvbQogICAgICAgIC0gYHJlbGF0aW9uc2hpcEtleWAga2V5IHVuZGVyIHdoaWNoIHRoZSB2YWx1ZSBmb3IgdGhlIHJlbGF0aW9uc2hpcCBpcwogICAgICAgICAgZXh0cmFjdGVkIGZyb20gdGhlIHJlc291cmNlSGFzaAogICAgICAgIC0gYHJlbGF0aW9uc2hpcE1ldGFgIG1ldGEgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlbGF0aW9uc2hpcAogICAgICAgQG1ldGhvZCBleHRyYWN0UG9seW1vcnBoaWNSZWxhdGlvbnNoaXAKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlbGF0aW9uc2hpcE1vZGVsTmFtZQogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwSGFzaAogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwT3B0aW9ucwogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAqLwogICAgZXh0cmFjdFBvbHltb3JwaGljUmVsYXRpb25zaGlwOiBmdW5jdGlvbiBleHRyYWN0UG9seW1vcnBoaWNSZWxhdGlvbnNoaXAocmVsYXRpb25zaGlwTW9kZWxOYW1lLCByZWxhdGlvbnNoaXBIYXNoLCByZWxhdGlvbnNoaXBPcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLmV4dHJhY3RSZWxhdGlvbnNoaXAocmVsYXRpb25zaGlwTW9kZWxOYW1lLCByZWxhdGlvbnNoaXBIYXNoKTsKICAgIH0sCgogICAgLyoqCiAgICAgIFJldHVybnMgdGhlIHJlc291cmNlJ3MgcmVsYXRpb25zaGlwcyBmb3JtYXR0ZWQgYXMgYSBKU09OLUFQSSAicmVsYXRpb25zaGlwcyBvYmplY3QiLgogICAgICAgaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZG9jdW1lbnQtcmVzb3VyY2Utb2JqZWN0LXJlbGF0aW9uc2hpcHMKICAgICAgIEBtZXRob2QgZXh0cmFjdFJlbGF0aW9uc2hpcHMKICAgICAgQHBhcmFtIHtPYmplY3R9IG1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlc291cmNlSGFzaAogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAqLwogICAgZXh0cmFjdFJlbGF0aW9uc2hpcHM6IGZ1bmN0aW9uIGV4dHJhY3RSZWxhdGlvbnNoaXBzKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCkgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIHZhciByZWxhdGlvbnNoaXBzID0ge307CiAgICAgIG1vZGVsQ2xhc3MuZWFjaFJlbGF0aW9uc2hpcChmdW5jdGlvbiAoa2V5LCByZWxhdGlvbnNoaXBNZXRhKSB7CiAgICAgICAgdmFyIHJlbGF0aW9uc2hpcCA9IG51bGw7CgogICAgICAgIHZhciByZWxhdGlvbnNoaXBLZXkgPSBfdGhpczMua2V5Rm9yUmVsYXRpb25zaGlwKGtleSwgcmVsYXRpb25zaGlwTWV0YS5raW5kLCAnZGVzZXJpYWxpemUnKTsKCiAgICAgICAgaWYgKHJlc291cmNlSGFzaFtyZWxhdGlvbnNoaXBLZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciBkYXRhID0gbnVsbDsKICAgICAgICAgIHZhciByZWxhdGlvbnNoaXBIYXNoID0gcmVzb3VyY2VIYXNoW3JlbGF0aW9uc2hpcEtleV07CgogICAgICAgICAgaWYgKHJlbGF0aW9uc2hpcE1ldGEua2luZCA9PT0gJ2JlbG9uZ3NUbycpIHsKICAgICAgICAgICAgaWYgKHJlbGF0aW9uc2hpcE1ldGEub3B0aW9ucy5wb2x5bW9ycGhpYykgewogICAgICAgICAgICAgIC8vIGV4dHJhY3RpbmcgYSBwb2x5bW9ycGhpYyBiZWxvbmdzVG8gbWF5IG5lZWQgbW9yZSBpbmZvcm1hdGlvbgogICAgICAgICAgICAgIC8vIHRoYW4gdGhlIHR5cGUgYW5kIHRoZSBoYXNoICh3aGljaCBtaWdodCBvbmx5IGJlIGFuIGlkKSBmb3IgdGhlCiAgICAgICAgICAgICAgLy8gcmVsYXRpb25zaGlwLCBoZW5jZSB3ZSBwYXNzIHRoZSBrZXksIHJlc291cmNlIGFuZAogICAgICAgICAgICAgIC8vIHJlbGF0aW9uc2hpcE1ldGEgdG9vCiAgICAgICAgICAgICAgZGF0YSA9IF90aGlzMy5leHRyYWN0UG9seW1vcnBoaWNSZWxhdGlvbnNoaXAocmVsYXRpb25zaGlwTWV0YS50eXBlLCByZWxhdGlvbnNoaXBIYXNoLCB7CiAgICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICAgIHJlc291cmNlSGFzaDogcmVzb3VyY2VIYXNoLAogICAgICAgICAgICAgICAgcmVsYXRpb25zaGlwTWV0YTogcmVsYXRpb25zaGlwTWV0YQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRhdGEgPSBfdGhpczMuZXh0cmFjdFJlbGF0aW9uc2hpcChyZWxhdGlvbnNoaXBNZXRhLnR5cGUsIHJlbGF0aW9uc2hpcEhhc2gpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHJlbGF0aW9uc2hpcE1ldGEua2luZCA9PT0gJ2hhc01hbnknKSB7CiAgICAgICAgICAgIGlmICghRW1iZXIuaXNOb25lKHJlbGF0aW9uc2hpcEhhc2gpKSB7CiAgICAgICAgICAgICAgZGF0YSA9IG5ldyBBcnJheShyZWxhdGlvbnNoaXBIYXNoLmxlbmd0aCk7CgogICAgICAgICAgICAgIGlmIChyZWxhdGlvbnNoaXBNZXRhLm9wdGlvbnMucG9seW1vcnBoaWMpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gcmVsYXRpb25zaGlwSGFzaC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSByZWxhdGlvbnNoaXBIYXNoW2ldOwogICAgICAgICAgICAgICAgICBkYXRhW2ldID0gX3RoaXMzLmV4dHJhY3RQb2x5bW9ycGhpY1JlbGF0aW9uc2hpcChyZWxhdGlvbnNoaXBNZXRhLnR5cGUsIGl0ZW0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICAgICAgICByZXNvdXJjZUhhc2g6IHJlc291cmNlSGFzaCwKICAgICAgICAgICAgICAgICAgICByZWxhdGlvbnNoaXBNZXRhOiByZWxhdGlvbnNoaXBNZXRhCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBfaSA9IDAsIF9sID0gcmVsYXRpb25zaGlwSGFzaC5sZW5ndGg7IF9pIDwgX2w7IF9pKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIF9pdGVtID0gcmVsYXRpb25zaGlwSGFzaFtfaV07CiAgICAgICAgICAgICAgICAgIGRhdGFbX2ldID0gX3RoaXMzLmV4dHJhY3RSZWxhdGlvbnNoaXAocmVsYXRpb25zaGlwTWV0YS50eXBlLCBfaXRlbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgcmVsYXRpb25zaGlwID0gewogICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgdmFyIGxpbmtLZXkgPSBfdGhpczMua2V5Rm9yTGluayhrZXksIHJlbGF0aW9uc2hpcE1ldGEua2luZCk7CgogICAgICAgIGlmIChyZXNvdXJjZUhhc2gubGlua3MgJiYgcmVzb3VyY2VIYXNoLmxpbmtzW2xpbmtLZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciByZWxhdGVkID0gcmVzb3VyY2VIYXNoLmxpbmtzW2xpbmtLZXldOwogICAgICAgICAgcmVsYXRpb25zaGlwID0gcmVsYXRpb25zaGlwIHx8IHt9OwogICAgICAgICAgcmVsYXRpb25zaGlwLmxpbmtzID0gewogICAgICAgICAgICByZWxhdGVkOiByZWxhdGVkCiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgaWYgKHJlbGF0aW9uc2hpcCkgewogICAgICAgICAgcmVsYXRpb25zaGlwc1trZXldID0gcmVsYXRpb25zaGlwOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiByZWxhdGlvbnNoaXBzOwogICAgfSwKCiAgICAvKioKICAgICAgQG1ldGhvZCBtb2RlbE5hbWVGcm9tUGF5bG9hZEtleQogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5CiAgICAgIEByZXR1cm4ge1N0cmluZ30gdGhlIG1vZGVsJ3MgbW9kZWxOYW1lCiAgICAqLwogICAgLy8gVE9ETyBAZGVwcmVjYXRlZCBVc2UgbW9kZWxOYW1lRnJvbVBheWxvYWRUeXBlIGluc3RlYWQKICAgIG1vZGVsTmFtZUZyb21QYXlsb2FkS2V5OiBmdW5jdGlvbiBtb2RlbE5hbWVGcm9tUGF5bG9hZEtleShrZXkpIHsKICAgICAgcmV0dXJuICgwLCBfc3RvcmUubm9ybWFsaXplTW9kZWxOYW1lKShrZXkpOwogICAgfSwKCiAgICAvKioKICAgICAgQG1ldGhvZCBub3JtYWxpemVSZWxhdGlvbnNoaXBzCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgbm9ybWFsaXplUmVsYXRpb25zaGlwczogZnVuY3Rpb24gbm9ybWFsaXplUmVsYXRpb25zaGlwcyh0eXBlQ2xhc3MsIGhhc2gpIHsKICAgICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgICB2YXIgcGF5bG9hZEtleTsKCiAgICAgIGlmICh0aGlzLmtleUZvclJlbGF0aW9uc2hpcCkgewogICAgICAgIHR5cGVDbGFzcy5lYWNoUmVsYXRpb25zaGlwKGZ1bmN0aW9uIChrZXksIHJlbGF0aW9uc2hpcCkgewogICAgICAgICAgcGF5bG9hZEtleSA9IF90aGlzNC5rZXlGb3JSZWxhdGlvbnNoaXAoa2V5LCByZWxhdGlvbnNoaXAua2luZCwgJ2Rlc2VyaWFsaXplJyk7CgogICAgICAgICAgaWYgKGtleSA9PT0gcGF5bG9hZEtleSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGhhc2hbcGF5bG9hZEtleV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgaGFzaFtrZXldID0gaGFzaFtwYXlsb2FkS2V5XTsKICAgICAgICAgIGRlbGV0ZSBoYXNoW3BheWxvYWRLZXldOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBAbWV0aG9kIG5vcm1hbGl6ZVVzaW5nRGVjbGFyZWRNYXBwaW5nCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgbm9ybWFsaXplVXNpbmdEZWNsYXJlZE1hcHBpbmc6IGZ1bmN0aW9uIG5vcm1hbGl6ZVVzaW5nRGVjbGFyZWRNYXBwaW5nKG1vZGVsQ2xhc3MsIGhhc2gpIHsKICAgICAgdmFyIGF0dHJzID0gRW1iZXIuZ2V0KHRoaXMsICdhdHRycycpOwogICAgICB2YXIgbm9ybWFsaXplZEtleTsKICAgICAgdmFyIHBheWxvYWRLZXk7CgogICAgICBpZiAoYXR0cnMpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cnMpIHsKICAgICAgICAgIG5vcm1hbGl6ZWRLZXkgPSBwYXlsb2FkS2V5ID0gdGhpcy5fZ2V0TWFwcGVkS2V5KGtleSwgbW9kZWxDbGFzcyk7CgogICAgICAgICAgaWYgKGhhc2hbcGF5bG9hZEtleV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoRW1iZXIuZ2V0KG1vZGVsQ2xhc3MsICdhdHRyaWJ1dGVzJykuaGFzKGtleSkpIHsKICAgICAgICAgICAgbm9ybWFsaXplZEtleSA9IHRoaXMua2V5Rm9yQXR0cmlidXRlKGtleSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKEVtYmVyLmdldChtb2RlbENsYXNzLCAncmVsYXRpb25zaGlwc0J5TmFtZScpLmhhcyhrZXkpKSB7CiAgICAgICAgICAgIG5vcm1hbGl6ZWRLZXkgPSB0aGlzLmtleUZvclJlbGF0aW9uc2hpcChrZXkpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChwYXlsb2FkS2V5ICE9PSBub3JtYWxpemVkS2V5KSB7CiAgICAgICAgICAgIGhhc2hbbm9ybWFsaXplZEtleV0gPSBoYXNoW3BheWxvYWRLZXldOwogICAgICAgICAgICBkZWxldGUgaGFzaFtwYXlsb2FkS2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgIExvb2tzIHVwIHRoZSBwcm9wZXJ0eSBrZXkgdGhhdCB3YXMgc2V0IGJ5IHRoZSBjdXN0b20gYGF0dHJgIG1hcHBpbmcKICAgICAgcGFzc2VkIHRvIHRoZSBzZXJpYWxpemVyLgogICAgICAgQG1ldGhvZCBfZ2V0TWFwcGVkS2V5CiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkKICAgICAgQHJldHVybiB7U3RyaW5nfSBrZXkKICAgICovCiAgICBfZ2V0TWFwcGVkS2V5OiBmdW5jdGlvbiBfZ2V0TWFwcGVkS2V5KGtleSwgbW9kZWxDbGFzcykgewogICAgICAoZmFsc2UgJiYgRW1iZXIud2FybignVGhlcmUgaXMgbm8gYXR0cmlidXRlIG9yIHJlbGF0aW9uc2hpcCB3aXRoIHRoZSBuYW1lIGAnICsga2V5ICsgJ2Agb24gYCcgKyBtb2RlbENsYXNzLm1vZGVsTmFtZSArICdgLiBDaGVjayB5b3VyIHNlcmlhbGl6ZXJzIGF0dHJzIGhhc2guJywgRW1iZXIuZ2V0KG1vZGVsQ2xhc3MsICdhdHRyaWJ1dGVzJykuaGFzKGtleSkgfHwgRW1iZXIuZ2V0KG1vZGVsQ2xhc3MsICdyZWxhdGlvbnNoaXBzQnlOYW1lJykuaGFzKGtleSksIHsKICAgICAgICBpZDogJ2RzLnNlcmlhbGl6ZXIubm8tbWFwcGVkLWF0dHJzLWtleScKICAgICAgfSkpOwogICAgICB2YXIgYXR0cnMgPSBFbWJlci5nZXQodGhpcywgJ2F0dHJzJyk7CiAgICAgIHZhciBtYXBwZWRLZXk7CgogICAgICBpZiAoYXR0cnMgJiYgYXR0cnNba2V5XSkgewogICAgICAgIG1hcHBlZEtleSA9IGF0dHJzW2tleV07IC8vV2UgbmVlZCB0byBhY2NvdW50IGZvciBib3RoIHRoZSB7IHRpdGxlOiAncG9zdF90aXRsZScgfSBhbmQKICAgICAgICAvL3sgdGl0bGU6IHsga2V5OiAncG9zdF90aXRsZScgfX0gZm9ybXMKCiAgICAgICAgaWYgKG1hcHBlZEtleS5rZXkpIHsKICAgICAgICAgIG1hcHBlZEtleSA9IG1hcHBlZEtleS5rZXk7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIG1hcHBlZEtleSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGtleSA9IG1hcHBlZEtleTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBrZXk7CiAgICB9LAoKICAgIC8qKgogICAgICBDaGVjayBhdHRycy5rZXkuc2VyaWFsaXplIHByb3BlcnR5IHRvIGluZm9ybSBpZiB0aGUgYGtleWAKICAgICAgY2FuIGJlIHNlcmlhbGl6ZWQKICAgICAgIEBtZXRob2QgX2NhblNlcmlhbGl6ZQogICAgICBAcHJpdmF0ZQogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5CiAgICAgIEByZXR1cm4ge2Jvb2xlYW59IHRydWUgaWYgdGhlIGtleSBjYW4gYmUgc2VyaWFsaXplZAogICAgKi8KICAgIF9jYW5TZXJpYWxpemU6IGZ1bmN0aW9uIF9jYW5TZXJpYWxpemUoa2V5KSB7CiAgICAgIHZhciBhdHRycyA9IEVtYmVyLmdldCh0aGlzLCAnYXR0cnMnKTsKICAgICAgcmV0dXJuICFhdHRycyB8fCAhYXR0cnNba2V5XSB8fCBhdHRyc1trZXldLnNlcmlhbGl6ZSAhPT0gZmFsc2U7CiAgICB9LAoKICAgIC8qKgogICAgICBXaGVuIGF0dHJzLmtleS5zZXJpYWxpemUgaXMgc2V0IHRvIHRydWUgdGhlbgogICAgICBpdCB0YWtlcyBwcmlvcml0eSBvdmVyIHRoZSBvdGhlciBjaGVja3MgYW5kIHRoZSByZWxhdGVkCiAgICAgIGF0dHJpYnV0ZS9yZWxhdGlvbnNoaXAgd2lsbCBiZSBzZXJpYWxpemVkCiAgICAgICBAbWV0aG9kIF9tdXN0U2VyaWFsaXplCiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkKICAgICAgQHJldHVybiB7Ym9vbGVhbn0gdHJ1ZSBpZiB0aGUga2V5IG11c3QgYmUgc2VyaWFsaXplZAogICAgKi8KICAgIF9tdXN0U2VyaWFsaXplOiBmdW5jdGlvbiBfbXVzdFNlcmlhbGl6ZShrZXkpIHsKICAgICAgdmFyIGF0dHJzID0gRW1iZXIuZ2V0KHRoaXMsICdhdHRycycpOwogICAgICByZXR1cm4gYXR0cnMgJiYgYXR0cnNba2V5XSAmJiBhdHRyc1trZXldLnNlcmlhbGl6ZSA9PT0gdHJ1ZTsKICAgIH0sCgogICAgLyoqCiAgICAgIENoZWNrIGlmIHRoZSBnaXZlbiBoYXNNYW55IHJlbGF0aW9uc2hpcCBzaG91bGQgYmUgc2VyaWFsaXplZAogICAgICAgQnkgZGVmYXVsdCBvbmx5IG1hbnktdG8tbWFueSBhbmQgbWFueS10by1ub25lIHJlbGF0aW9uc2hpcHMgYXJlIHNlcmlhbGl6ZWQuCiAgICAgIFRoaXMgY291bGQgYmUgY29uZmlndXJlZCBwZXIgcmVsYXRpb25zaGlwIGJ5IFNlcmlhbGl6ZXIncyBgYXR0cnNgIG9iamVjdC4KICAgICAgIEBtZXRob2Qgc2hvdWxkU2VyaWFsaXplSGFzTWFueQogICAgICBAcGFyYW0ge1NuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5CiAgICAgIEBwYXJhbSB7U3RyaW5nfSByZWxhdGlvbnNoaXBUeXBlCiAgICAgIEByZXR1cm4ge2Jvb2xlYW59IHRydWUgaWYgdGhlIGhhc01hbnkgcmVsYXRpb25zaGlwIHNob3VsZCBiZSBzZXJpYWxpemVkCiAgICAqLwogICAgc2hvdWxkU2VyaWFsaXplSGFzTWFueTogZnVuY3Rpb24gc2hvdWxkU2VyaWFsaXplSGFzTWFueShzbmFwc2hvdCwga2V5LCByZWxhdGlvbnNoaXApIHsKICAgICAgdmFyIHJlbGF0aW9uc2hpcFR5cGUgPSBzbmFwc2hvdC50eXBlLmRldGVybWluZVJlbGF0aW9uc2hpcFR5cGUocmVsYXRpb25zaGlwLCB0aGlzLnN0b3JlKTsKCiAgICAgIGlmICh0aGlzLl9tdXN0U2VyaWFsaXplKGtleSkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuX2NhblNlcmlhbGl6ZShrZXkpICYmIChyZWxhdGlvbnNoaXBUeXBlID09PSAnbWFueVRvTm9uZScgfHwgcmVsYXRpb25zaGlwVHlwZSA9PT0gJ21hbnlUb01hbnknKTsKICAgIH0sCiAgICAvLyBTRVJJQUxJWkUKCiAgICAvKioKICAgICAgQ2FsbGVkIHdoZW4gYSByZWNvcmQgaXMgc2F2ZWQgaW4gb3JkZXIgdG8gY29udmVydCB0aGUKICAgICAgcmVjb3JkIGludG8gSlNPTi4KICAgICAgIEJ5IGRlZmF1bHQsIGl0IGNyZWF0ZXMgYSBKU09OIG9iamVjdCB3aXRoIGEga2V5IGZvcgogICAgICBlYWNoIGF0dHJpYnV0ZSBhbmQgYmVsb25nc1RvIHJlbGF0aW9uc2hpcC4KICAgICAgIEZvciBleGFtcGxlLCBjb25zaWRlciB0aGlzIG1vZGVsOgogICAgICAgYGBgYXBwL21vZGVscy9jb21tZW50LmpzCiAgICAgIGltcG9ydCBNb2RlbCwgeyBhdHRyLCBiZWxvbmdzVG8gfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICAgIHRpdGxlOiBhdHRyKCksCiAgICAgICAgYm9keTogYXR0cigpLAogICAgICAgICBhdXRob3I6IGJlbG9uZ3NUbygndXNlcicpCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFRoZSBkZWZhdWx0IHNlcmlhbGl6YXRpb24gd291bGQgY3JlYXRlIGEgSlNPTiBvYmplY3QgbGlrZToKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgewogICAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyB1bmFnaSIsCiAgICAgICAgImJvZHkiOiAiUmFpbHM/IE9tYWthc2U/IE9fTyIsCiAgICAgICAgImF1dGhvciI6IDEyCiAgICAgIH0KICAgICAgYGBgCiAgICAgICBCeSBkZWZhdWx0LCBhdHRyaWJ1dGVzIGFyZSBwYXNzZWQgdGhyb3VnaCBhcy1pcywgdW5sZXNzCiAgICAgIHlvdSBzcGVjaWZpZWQgYW4gYXR0cmlidXRlIHR5cGUgKGBhdHRyKCdkYXRlJylgKS4gSWYKICAgICAgeW91IHNwZWNpZnkgYSB0cmFuc2Zvcm0sIHRoZSBKYXZhU2NyaXB0IHZhbHVlIHdpbGwgYmUKICAgICAgc2VyaWFsaXplZCB3aGVuIGluc2VydGVkIGludG8gdGhlIEpTT04gaGFzaC4KICAgICAgIEJ5IGRlZmF1bHQsIGJlbG9uZ3MtdG8gcmVsYXRpb25zaGlwcyBhcmUgY29udmVydGVkIGludG8KICAgICAgSURzIHdoZW4gaW5zZXJ0ZWQgaW50byB0aGUgSlNPTiBoYXNoLgogICAgICAgIyMgSURzCiAgICAgICBgc2VyaWFsaXplYCB0YWtlcyBhbiBvcHRpb25zIGhhc2ggd2l0aCBhIHNpbmdsZSBvcHRpb246CiAgICAgIGBpbmNsdWRlSWRgLiBJZiB0aGlzIG9wdGlvbiBpcyBgdHJ1ZWAsIGBzZXJpYWxpemVgIHdpbGwsCiAgICAgIGJ5IGRlZmF1bHQgaW5jbHVkZSB0aGUgSUQgaW4gdGhlIEpTT04gb2JqZWN0IGl0IGJ1aWxkcy4KICAgICAgIFRoZSBhZGFwdGVyIHBhc3NlcyBpbiBgaW5jbHVkZUlkOiB0cnVlYCB3aGVuIHNlcmlhbGl6aW5nCiAgICAgIGEgcmVjb3JkIGZvciBgY3JlYXRlUmVjb3JkYCwgYnV0IG5vdCBmb3IgYHVwZGF0ZVJlY29yZGAuCiAgICAgICAjIyBDdXN0b21pemF0aW9uCiAgICAgICBZb3VyIHNlcnZlciBtYXkgZXhwZWN0IGEgZGlmZmVyZW50IEpTT04gZm9ybWF0IHRoYW4gdGhlCiAgICAgIGJ1aWx0LWluIHNlcmlhbGl6YXRpb24gZm9ybWF0LgogICAgICAgSW4gdGhhdCBjYXNlLCB5b3UgY2FuIGltcGxlbWVudCBgc2VyaWFsaXplYCB5b3Vyc2VsZiBhbmQKICAgICAgcmV0dXJuIGEgSlNPTiBoYXNoIG9mIHlvdXIgY2hvb3NpbmcuCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvcG9zdC5qcwogICAgICBpbXBvcnQgSlNPTlNlcmlhbGl6ZXIgZnJvbSAnQGVtYmVyLWRhdGEvc2VyaWFsaXplci9qc29uJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IEpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgc2VyaWFsaXplKHNuYXBzaG90LCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIganNvbiA9IHsKICAgICAgICAgICAgUE9TVF9UVEw6IHNuYXBzaG90LmF0dHIoJ3RpdGxlJyksCiAgICAgICAgICAgIFBPU1RfQkRZOiBzbmFwc2hvdC5hdHRyKCdib2R5JyksCiAgICAgICAgICAgIFBPU1RfQ01TOiBzbmFwc2hvdC5oYXNNYW55KCdjb21tZW50cycsIHsgaWRzOiB0cnVlIH0pCiAgICAgICAgICB9OwogICAgICAgICAgIGlmIChvcHRpb25zLmluY2x1ZGVJZCkgewogICAgICAgICAgICBqc29uLlBPU1RfSURfID0gc25hcHNob3QuaWQ7CiAgICAgICAgICB9CiAgICAgICAgICAgcmV0dXJuIGpzb247CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICAjIyBDdXN0b21pemluZyBhbiBBcHAtV2lkZSBTZXJpYWxpemVyCiAgICAgICBJZiB5b3Ugd2FudCB0byBkZWZpbmUgYSBzZXJpYWxpemVyIGZvciB5b3VyIGVudGlyZQogICAgICBhcHBsaWNhdGlvbiwgeW91J2xsIHByb2JhYmx5IHdhbnQgdG8gdXNlIGBlYWNoQXR0cmlidXRlYAogICAgICBhbmQgYGVhY2hSZWxhdGlvbnNoaXBgIG9uIHRoZSByZWNvcmQuCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IEpTT05TZXJpYWxpemVyIGZyb20gJ0BlbWJlci1kYXRhL3NlcmlhbGl6ZXIvanNvbic7CiAgICAgIGltcG9ydCB7IHNpbmd1bGFyaXplIH0gZnJvbSAnZW1iZXItaW5mbGVjdG9yJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IEpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgc2VyaWFsaXplKHNuYXBzaG90LCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIganNvbiA9IHt9OwogICAgICAgICAgIHNuYXBzaG90LmVhY2hBdHRyaWJ1dGUoZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBqc29uW3NlcnZlckF0dHJpYnV0ZU5hbWUobmFtZSldID0gc25hcHNob3QuYXR0cihuYW1lKTsKICAgICAgICAgIH0pOwogICAgICAgICAgIHNuYXBzaG90LmVhY2hSZWxhdGlvbnNoaXAoZnVuY3Rpb24obmFtZSwgcmVsYXRpb25zaGlwKSB7CiAgICAgICAgICAgIGlmIChyZWxhdGlvbnNoaXAua2luZCA9PT0gJ2hhc01hbnknKSB7CiAgICAgICAgICAgICAganNvbltzZXJ2ZXJIYXNNYW55TmFtZShuYW1lKV0gPSBzbmFwc2hvdC5oYXNNYW55KG5hbWUsIHsgaWRzOiB0cnVlIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgICBpZiAob3B0aW9ucy5pbmNsdWRlSWQpIHsKICAgICAgICAgICAganNvbi5JRF8gPSBzbmFwc2hvdC5pZDsKICAgICAgICAgIH0KICAgICAgICAgICByZXR1cm4ganNvbjsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAgZnVuY3Rpb24gc2VydmVyQXR0cmlidXRlTmFtZShhdHRyaWJ1dGUpIHsKICAgICAgICByZXR1cm4gYXR0cmlidXRlLnVuZGVyc2NvcmUoKS50b1VwcGVyQ2FzZSgpOwogICAgICB9CiAgICAgICBmdW5jdGlvbiBzZXJ2ZXJIYXNNYW55TmFtZShuYW1lKSB7CiAgICAgICAgcmV0dXJuIHNlcnZlckF0dHJpYnV0ZU5hbWUoc2luZ3VsYXJpemUobmFtZSkpICsgIl9JRFMiOwogICAgICB9CiAgICAgIGBgYAogICAgICAgVGhpcyBzZXJpYWxpemVyIHdpbGwgZ2VuZXJhdGUgSlNPTiB0aGF0IGxvb2tzIGxpa2UgdGhpczoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgewogICAgICAgICJUSVRMRSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgICAiQk9EWSI6ICJZZXAuIE9tYWthc2UuIiwKICAgICAgICAiQ09NTUVOVF9JRFMiOiBbIDEsIDIsIDMgXQogICAgICB9CiAgICAgIGBgYAogICAgICAgIyMgVHdlYWtpbmcgdGhlIERlZmF1bHQgSlNPTgogICAgICAgSWYgeW91IGp1c3Qgd2FudCB0byBkbyBzb21lIHNtYWxsIHR3ZWFrcyBvbiB0aGUgZGVmYXVsdCBKU09OLAogICAgICB5b3UgY2FuIGNhbGwgc3VwZXIgZmlyc3QgYW5kIG1ha2UgdGhlIHR3ZWFrcyBvbiB0aGUgcmV0dXJuZWQKICAgICAgSlNPTi4KICAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9wb3N0LmpzCiAgICAgIGltcG9ydCBKU09OU2VyaWFsaXplciBmcm9tICdAZW1iZXItZGF0YS9zZXJpYWxpemVyL2pzb24nOwogICAgICAgZXhwb3J0IGRlZmF1bHQgSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBzZXJpYWxpemUoc25hcHNob3QsIG9wdGlvbnMpIHsKICAgICAgICAgIHZhciBqc29uID0gdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgICAgICAgICBqc29uLnN1YmplY3QgPSBqc29uLnRpdGxlOwogICAgICAgICAgZGVsZXRlIGpzb24udGl0bGU7CiAgICAgICAgICAgcmV0dXJuIGpzb247CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHNlcmlhbGl6ZQogICAgICBAcGFyYW0ge1NuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgICBAcmV0dXJuIHtPYmplY3R9IGpzb24KICAgICovCiAgICBzZXJpYWxpemU6IGZ1bmN0aW9uIHNlcmlhbGl6ZShzbmFwc2hvdCwgb3B0aW9ucykgewogICAgICB2YXIgX3RoaXM1ID0gdGhpczsKCiAgICAgIHZhciBqc29uID0ge307CgogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmluY2x1ZGVJZCkgewogICAgICAgIHZhciBpZCA9IHNuYXBzaG90LmlkOwoKICAgICAgICBpZiAoaWQpIHsKICAgICAgICAgIGpzb25bRW1iZXIuZ2V0KHRoaXMsICdwcmltYXJ5S2V5JyldID0gaWQ7CiAgICAgICAgfQogICAgICB9CgogICAgICBzbmFwc2hvdC5lYWNoQXR0cmlidXRlKGZ1bmN0aW9uIChrZXksIGF0dHJpYnV0ZSkgewogICAgICAgIF90aGlzNS5zZXJpYWxpemVBdHRyaWJ1dGUoc25hcHNob3QsIGpzb24sIGtleSwgYXR0cmlidXRlKTsKICAgICAgfSk7CiAgICAgIHNuYXBzaG90LmVhY2hSZWxhdGlvbnNoaXAoZnVuY3Rpb24gKGtleSwgcmVsYXRpb25zaGlwKSB7CiAgICAgICAgaWYgKHJlbGF0aW9uc2hpcC5raW5kID09PSAnYmVsb25nc1RvJykgewogICAgICAgICAgX3RoaXM1LnNlcmlhbGl6ZUJlbG9uZ3NUbyhzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKTsKICAgICAgICB9IGVsc2UgaWYgKHJlbGF0aW9uc2hpcC5raW5kID09PSAnaGFzTWFueScpIHsKICAgICAgICAgIF90aGlzNS5zZXJpYWxpemVIYXNNYW55KHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBqc29uOwogICAgfSwKCiAgICAvKioKICAgICAgWW91IGNhbiB1c2UgdGhpcyBtZXRob2QgdG8gY3VzdG9taXplIGhvdyBhIHNlcmlhbGl6ZWQgcmVjb3JkIGlzIGFkZGVkIHRvIHRoZSBjb21wbGV0ZQogICAgICBKU09OIGhhc2ggdG8gYmUgc2VudCB0byB0aGUgc2VydmVyLiBCeSBkZWZhdWx0IHRoZSBKU09OIFNlcmlhbGl6ZXIgZG9lcyBub3QgbmFtZXNwYWNlCiAgICAgIHRoZSBwYXlsb2FkIGFuZCBqdXN0IHNlbmRzIHRoZSByYXcgc2VyaWFsaXplZCBKU09OIG9iamVjdC4KICAgICAgSWYgeW91ciBzZXJ2ZXIgZXhwZWN0cyBuYW1lc3BhY2VkIGtleXMsIHlvdSBzaG91bGQgY29uc2lkZXIgdXNpbmcgdGhlIFJFU1RTZXJpYWxpemVyLgogICAgICBPdGhlcndpc2UgeW91IGNhbiBvdmVycmlkZSB0aGlzIG1ldGhvZCB0byBjdXN0b21pemUgaG93IHRoZSByZWNvcmQgaXMgYWRkZWQgdG8gdGhlIGhhc2guCiAgICAgIFRoZSBoYXNoIHByb3BlcnR5IHNob3VsZCBiZSBtb2RpZmllZCBieSByZWZlcmVuY2UuCiAgICAgICBGb3IgZXhhbXBsZSwgeW91ciBzZXJ2ZXIgbWF5IGV4cGVjdCB1bmRlcnNjb3JlZCByb290IG9iamVjdHMuCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IFJFU1RTZXJpYWxpemVyIGZyb20gJ0BlbWJlci1kYXRhL3NlcmlhbGl6ZXIvcmVzdCc7CiAgICAgIGltcG9ydCB7IGRlY2FtZWxpemUgfSBmcm9tICdAZW1iZXIvc3RyaW5nJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJFU1RTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgc2VyaWFsaXplSW50b0hhc2goZGF0YSwgdHlwZSwgc25hcHNob3QsIG9wdGlvbnMpIHsKICAgICAgICAgIHZhciByb290ID0gZGVjYW1lbGl6ZSh0eXBlLm1vZGVsTmFtZSk7CiAgICAgICAgICBkYXRhW3Jvb3RdID0gdGhpcy5zZXJpYWxpemUoc25hcHNob3QsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBzZXJpYWxpemVJbnRvSGFzaAogICAgICBAcGFyYW0ge09iamVjdH0gaGFzaAogICAgICBAcGFyYW0ge01vZGVsfSB0eXBlQ2xhc3MKICAgICAgQHBhcmFtIHtTbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICovCiAgICBzZXJpYWxpemVJbnRvSGFzaDogZnVuY3Rpb24gc2VyaWFsaXplSW50b0hhc2goaGFzaCwgdHlwZUNsYXNzLCBzbmFwc2hvdCwgb3B0aW9ucykgewogICAgICBFbWJlci5hc3NpZ24oaGFzaCwgdGhpcy5zZXJpYWxpemUoc25hcHNob3QsIG9wdGlvbnMpKTsKICAgIH0sCgogICAgLyoqCiAgICAgIGBzZXJpYWxpemVBdHRyaWJ1dGVgIGNhbiBiZSB1c2VkIHRvIGN1c3RvbWl6ZSBob3cgYGF0dHJgCiAgICAgIHByb3BlcnRpZXMgYXJlIHNlcmlhbGl6ZWQKICAgICAgIEZvciBleGFtcGxlIGlmIHlvdSB3YW50ZWQgdG8gZW5zdXJlIGFsbCB5b3VyIGF0dHJpYnV0ZXMgd2VyZSBhbHdheXMKICAgICAgc2VyaWFsaXplZCBhcyBwcm9wZXJ0aWVzIG9uIGFuIGBhdHRyaWJ1dGVzYCBvYmplY3QgeW91IGNvdWxkCiAgICAgIHdyaXRlOgogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBKU09OU2VyaWFsaXplciBmcm9tICdAZW1iZXItZGF0YS9zZXJpYWxpemVyL2pzb24nOwogICAgICAgZXhwb3J0IGRlZmF1bHQgSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBzZXJpYWxpemVBdHRyaWJ1dGUoc25hcHNob3QsIGpzb24sIGtleSwgYXR0cmlidXRlcykgewogICAgICAgICAganNvbi5hdHRyaWJ1dGVzID0ganNvbi5hdHRyaWJ1dGVzIHx8IHt9OwogICAgICAgICAgdGhpcy5fc3VwZXIoc25hcHNob3QsIGpzb24uYXR0cmlidXRlcywga2V5LCBhdHRyaWJ1dGVzKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2Qgc2VyaWFsaXplQXR0cmlidXRlCiAgICAgIEBwYXJhbSB7U25hcHNob3R9IHNuYXBzaG90CiAgICAgIEBwYXJhbSB7T2JqZWN0fSBqc29uCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkKICAgICAgQHBhcmFtIHtPYmplY3R9IGF0dHJpYnV0ZQogICAgKi8KICAgIHNlcmlhbGl6ZUF0dHJpYnV0ZTogZnVuY3Rpb24gc2VyaWFsaXplQXR0cmlidXRlKHNuYXBzaG90LCBqc29uLCBrZXksIGF0dHJpYnV0ZSkgewogICAgICBpZiAodGhpcy5fY2FuU2VyaWFsaXplKGtleSkpIHsKICAgICAgICB2YXIgdHlwZSA9IGF0dHJpYnV0ZS50eXBlOwogICAgICAgIHZhciB2YWx1ZSA9IHNuYXBzaG90LmF0dHIoa2V5KTsKCiAgICAgICAgaWYgKHR5cGUpIHsKICAgICAgICAgIHZhciB0cmFuc2Zvcm0gPSB0aGlzLnRyYW5zZm9ybUZvcih0eXBlKTsKICAgICAgICAgIHZhbHVlID0gdHJhbnNmb3JtLnNlcmlhbGl6ZSh2YWx1ZSwgYXR0cmlidXRlLm9wdGlvbnMpOwogICAgICAgIH0gLy8gaWYgcHJvdmlkZWQsIHVzZSB0aGUgbWFwcGluZyBwcm92aWRlZCBieSBgYXR0cnNgIGluCiAgICAgICAgLy8gdGhlIHNlcmlhbGl6ZXIKCgogICAgICAgIHZhciBwYXlsb2FkS2V5ID0gdGhpcy5fZ2V0TWFwcGVkS2V5KGtleSwgc25hcHNob3QudHlwZSk7CgogICAgICAgIGlmIChwYXlsb2FkS2V5ID09PSBrZXkgJiYgdGhpcy5rZXlGb3JBdHRyaWJ1dGUpIHsKICAgICAgICAgIHBheWxvYWRLZXkgPSB0aGlzLmtleUZvckF0dHJpYnV0ZShrZXksICdzZXJpYWxpemUnKTsKICAgICAgICB9CgogICAgICAgIGpzb25bcGF5bG9hZEtleV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAgYHNlcmlhbGl6ZUJlbG9uZ3NUb2AgY2FuIGJlIHVzZWQgdG8gY3VzdG9taXplIGhvdyBgYmVsb25nc1RvYAogICAgICBwcm9wZXJ0aWVzIGFyZSBzZXJpYWxpemVkLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICAgaW1wb3J0IEpTT05TZXJpYWxpemVyIGZyb20gJ0BlbWJlci1kYXRhL3NlcmlhbGl6ZXIvanNvbic7CiAgICAgIGltcG9ydCB7IGlzTm9uZSB9IGZyb20gJ0BlbWJlci91dGlscyc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBKU09OU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIHNlcmlhbGl6ZUJlbG9uZ3NUbyhzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKSB7CiAgICAgICAgICB2YXIga2V5ID0gcmVsYXRpb25zaGlwLmtleTsKICAgICAgICAgIHZhciBiZWxvbmdzVG8gPSBzbmFwc2hvdC5iZWxvbmdzVG8oa2V5KTsKICAgICAgICAgICBrZXkgPSB0aGlzLmtleUZvclJlbGF0aW9uc2hpcCA/IHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKGtleSwgImJlbG9uZ3NUbyIsICJzZXJpYWxpemUiKSA6IGtleTsKICAgICAgICAgICBqc29uW2tleV0gPSBpc05vbmUoYmVsb25nc1RvKSA/IGJlbG9uZ3NUbyA6IGJlbG9uZ3NUby5yZWNvcmQudG9KU09OKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHNlcmlhbGl6ZUJlbG9uZ3NUbwogICAgICBAcGFyYW0ge1NuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcGFyYW0ge09iamVjdH0ganNvbgogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwCiAgICAqLwogICAgc2VyaWFsaXplQmVsb25nc1RvOiBmdW5jdGlvbiBzZXJpYWxpemVCZWxvbmdzVG8oc25hcHNob3QsIGpzb24sIHJlbGF0aW9uc2hpcCkgewogICAgICB2YXIga2V5ID0gcmVsYXRpb25zaGlwLmtleTsKCiAgICAgIGlmICh0aGlzLl9jYW5TZXJpYWxpemUoa2V5KSkgewogICAgICAgIHZhciBiZWxvbmdzVG9JZCA9IHNuYXBzaG90LmJlbG9uZ3NUbyhrZXksIHsKICAgICAgICAgIGlkOiB0cnVlCiAgICAgICAgfSk7IC8vIGlmIHByb3ZpZGVkLCB1c2UgdGhlIG1hcHBpbmcgcHJvdmlkZWQgYnkgYGF0dHJzYCBpbgogICAgICAgIC8vIHRoZSBzZXJpYWxpemVyCgogICAgICAgIHZhciBwYXlsb2FkS2V5ID0gdGhpcy5fZ2V0TWFwcGVkS2V5KGtleSwgc25hcHNob3QudHlwZSk7CgogICAgICAgIGlmIChwYXlsb2FkS2V5ID09PSBrZXkgJiYgdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXApIHsKICAgICAgICAgIHBheWxvYWRLZXkgPSB0aGlzLmtleUZvclJlbGF0aW9uc2hpcChrZXksICdiZWxvbmdzVG8nLCAnc2VyaWFsaXplJyk7CiAgICAgICAgfSAvL05lZWQgdG8gY2hlY2sgd2hldGhlciB0aGUgaWQgaXMgdGhlcmUgZm9yIG5ldyZhc3luYyByZWNvcmRzCgoKICAgICAgICBpZiAoRW1iZXIuaXNOb25lKGJlbG9uZ3NUb0lkKSkgewogICAgICAgICAganNvbltwYXlsb2FkS2V5XSA9IG51bGw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGpzb25bcGF5bG9hZEtleV0gPSBiZWxvbmdzVG9JZDsKICAgICAgICB9CgogICAgICAgIGlmIChyZWxhdGlvbnNoaXAub3B0aW9ucy5wb2x5bW9ycGhpYykgewogICAgICAgICAgdGhpcy5zZXJpYWxpemVQb2x5bW9ycGhpY1R5cGUoc25hcHNob3QsIGpzb24sIHJlbGF0aW9uc2hpcCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgIGBzZXJpYWxpemVIYXNNYW55YCBjYW4gYmUgdXNlZCB0byBjdXN0b21pemUgaG93IGBoYXNNYW55YAogICAgIHByb3BlcnRpZXMgYXJlIHNlcmlhbGl6ZWQuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICBpbXBvcnQgSlNPTlNlcmlhbGl6ZXIgZnJvbSAnQGVtYmVyLWRhdGEvc2VyaWFsaXplci9qc29uJzsKICAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgIGV4cG9ydCBkZWZhdWx0IEpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICBzZXJpYWxpemVIYXNNYW55KHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApIHsKICAgICAgICAgdmFyIGtleSA9IHJlbGF0aW9uc2hpcC5rZXk7CiAgICAgICAgIGlmIChrZXkgPT09ICdjb21tZW50cycpIHsKICAgICAgICAgICByZXR1cm47CiAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgICAgICAgfQogICAgICAgfQogICAgIH0pOwogICAgIGBgYAogICAgICBAbWV0aG9kIHNlcmlhbGl6ZUhhc01hbnkKICAgICBAcGFyYW0ge1NuYXBzaG90fSBzbmFwc2hvdAogICAgIEBwYXJhbSB7T2JqZWN0fSBqc29uCiAgICAgQHBhcmFtIHtPYmplY3R9IHJlbGF0aW9uc2hpcAogICAgKi8KICAgIHNlcmlhbGl6ZUhhc01hbnk6IGZ1bmN0aW9uIHNlcmlhbGl6ZUhhc01hbnkoc25hcHNob3QsIGpzb24sIHJlbGF0aW9uc2hpcCkgewogICAgICB2YXIga2V5ID0gcmVsYXRpb25zaGlwLmtleTsKCiAgICAgIGlmICh0aGlzLnNob3VsZFNlcmlhbGl6ZUhhc01hbnkoc25hcHNob3QsIGtleSwgcmVsYXRpb25zaGlwKSkgewogICAgICAgIHZhciBoYXNNYW55ID0gc25hcHNob3QuaGFzTWFueShrZXksIHsKICAgICAgICAgIGlkczogdHJ1ZQogICAgICAgIH0pOwoKICAgICAgICBpZiAoaGFzTWFueSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAvLyBpZiBwcm92aWRlZCwgdXNlIHRoZSBtYXBwaW5nIHByb3ZpZGVkIGJ5IGBhdHRyc2AgaW4KICAgICAgICAgIC8vIHRoZSBzZXJpYWxpemVyCiAgICAgICAgICB2YXIgcGF5bG9hZEtleSA9IHRoaXMuX2dldE1hcHBlZEtleShrZXksIHNuYXBzaG90LnR5cGUpOwoKICAgICAgICAgIGlmIChwYXlsb2FkS2V5ID09PSBrZXkgJiYgdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXApIHsKICAgICAgICAgICAgcGF5bG9hZEtleSA9IHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKGtleSwgJ2hhc01hbnknLCAnc2VyaWFsaXplJyk7CiAgICAgICAgICB9CgogICAgICAgICAganNvbltwYXlsb2FkS2V5XSA9IGhhc01hbnk7IC8vIFRPRE8gc3VwcG9ydCBmb3IgcG9seW1vcnBoaWMgbWFueVRvTm9uZSBhbmQgbWFueVRvTWFueSByZWxhdGlvbnNoaXBzCiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBZb3UgY2FuIHVzZSB0aGlzIG1ldGhvZCB0byBjdXN0b21pemUgaG93IHBvbHltb3JwaGljIG9iamVjdHMgYXJlCiAgICAgIHNlcmlhbGl6ZWQuIE9iamVjdHMgYXJlIGNvbnNpZGVyZWQgdG8gYmUgcG9seW1vcnBoaWMgaWYKICAgICAgYHsgcG9seW1vcnBoaWM6IHRydWUgfWAgaXMgcGFzcyBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50IHRvIHRoZQogICAgICBgYmVsb25nc1RvYCBmdW5jdGlvbi4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9jb21tZW50LmpzCiAgICAgIGltcG9ydCBKU09OU2VyaWFsaXplciBmcm9tICdAZW1iZXItZGF0YS9zZXJpYWxpemVyL2pzb24nOwogICAgICBpbXBvcnQgeyBpc05vbmUgfSBmcm9tICdAZW1iZXIvdXRpbHMnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBzZXJpYWxpemVQb2x5bW9ycGhpY1R5cGUoc25hcHNob3QsIGpzb24sIHJlbGF0aW9uc2hpcCkgewogICAgICAgICAgdmFyIGtleSA9IHJlbGF0aW9uc2hpcC5rZXk7CiAgICAgICAgICB2YXIgYmVsb25nc1RvID0gc25hcHNob3QuYmVsb25nc1RvKGtleSk7CiAgICAgICAgICAga2V5ID0gdGhpcy5rZXlGb3JBdHRyaWJ1dGUgPyB0aGlzLmtleUZvckF0dHJpYnV0ZShrZXksICdzZXJpYWxpemUnKSA6IGtleTsKICAgICAgICAgICBpZiAoaXNOb25lKGJlbG9uZ3NUbykpIHsKICAgICAgICAgICAganNvbltrZXkgKyAnX3R5cGUnXSA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBqc29uW2tleSArICdfdHlwZSddID0gYmVsb25nc1RvLm1vZGVsTmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2Qgc2VyaWFsaXplUG9seW1vcnBoaWNUeXBlCiAgICAgIEBwYXJhbSB7U25hcHNob3R9IHNuYXBzaG90CiAgICAgIEBwYXJhbSB7T2JqZWN0fSBqc29uCiAgICAgIEBwYXJhbSB7T2JqZWN0fSByZWxhdGlvbnNoaXAKICAgICovCiAgICBzZXJpYWxpemVQb2x5bW9ycGhpY1R5cGU6IGZ1bmN0aW9uIHNlcmlhbGl6ZVBvbHltb3JwaGljVHlwZSgpIHt9LAoKICAgIC8qKgogICAgICBgZXh0cmFjdE1ldGFgIGlzIHVzZWQgdG8gZGVzZXJpYWxpemUgYW55IG1ldGEgaW5mb3JtYXRpb24gaW4gdGhlCiAgICAgIGFkYXB0ZXIgcGF5bG9hZC4gQnkgZGVmYXVsdCBFbWJlciBEYXRhIGV4cGVjdHMgbWV0YSBpbmZvcm1hdGlvbiB0bwogICAgICBiZSBsb2NhdGVkIG9uIHRoZSBgbWV0YWAgcHJvcGVydHkgb2YgdGhlIHBheWxvYWQgb2JqZWN0LgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICAgaW1wb3J0IEpTT05TZXJpYWxpemVyIGZyb20gJ0BlbWJlci1kYXRhL3NlcmlhbGl6ZXIvanNvbic7CiAgICAgICBleHBvcnQgZGVmYXVsdCBKU09OU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIGV4dHJhY3RNZXRhKHN0b3JlLCB0eXBlQ2xhc3MsIHBheWxvYWQpIHsKICAgICAgICAgIGlmIChwYXlsb2FkICYmIHBheWxvYWQuaGFzT3duUHJvcGVydHkoJ19wYWdpbmF0aW9uJykpIHsKICAgICAgICAgICAgbGV0IG1ldGEgPSBwYXlsb2FkLl9wYWdpbmF0aW9uOwogICAgICAgICAgICBkZWxldGUgcGF5bG9hZC5fcGFnaW5hdGlvbjsKICAgICAgICAgICAgcmV0dXJuIG1ldGE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGV4dHJhY3RNZXRhCiAgICAgIEBwYXJhbSB7U3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7TW9kZWx9IG1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICovCiAgICBleHRyYWN0TWV0YTogZnVuY3Rpb24gZXh0cmFjdE1ldGEoc3RvcmUsIG1vZGVsQ2xhc3MsIHBheWxvYWQpIHsKICAgICAgaWYgKHBheWxvYWQgJiYgcGF5bG9hZFsnbWV0YSddICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgbWV0YSA9IHBheWxvYWQubWV0YTsKICAgICAgICBkZWxldGUgcGF5bG9hZC5tZXRhOwogICAgICAgIHJldHVybiBtZXRhOwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBgZXh0cmFjdEVycm9yc2AgaXMgdXNlZCB0byBleHRyYWN0IG1vZGVsIGVycm9ycyB3aGVuIGEgY2FsbAogICAgICB0byBgTW9kZWwjc2F2ZWAgZmFpbHMgd2l0aCBhbiBgSW52YWxpZEVycm9yYC4gQnkgZGVmYXVsdAogICAgICBFbWJlciBEYXRhIGV4cGVjdHMgZXJyb3IgaW5mb3JtYXRpb24gdG8gYmUgbG9jYXRlZCBvbiB0aGUgYGVycm9yc2AKICAgICAgcHJvcGVydHkgb2YgdGhlIHBheWxvYWQgb2JqZWN0LgogICAgICAgVGhpcyBzZXJpYWxpemVyIGV4cGVjdHMgdGhpcyBgZXJyb3JzYCBvYmplY3QgdG8gYmUgYW4gQXJyYXkgc2ltaWxhcgogICAgICB0byB0aGUgZm9sbG93aW5nLCBjb21wbGlhbnQgd2l0aCB0aGUgaHR0cHM6Ly9qc29uYXBpLm9yZy9mb3JtYXQvI2Vycm9ycyBzcGVjaWZpY2F0aW9uOgogICAgICAgYGBganMKICAgICAgewogICAgICAgICJlcnJvcnMiOiBbCiAgICAgICAgICB7CiAgICAgICAgICAgICJkZXRhaWwiOiAiVGhpcyB1c2VybmFtZSBpcyBhbHJlYWR5IHRha2VuISIsCiAgICAgICAgICAgICJzb3VyY2UiOiB7CiAgICAgICAgICAgICAgInBvaW50ZXIiOiAiZGF0YS9hdHRyaWJ1dGVzL3VzZXJuYW1lIgogICAgICAgICAgICB9CiAgICAgICAgICB9LCB7CiAgICAgICAgICAgICJkZXRhaWwiOiAiRG9lc24ndCBsb29rIGxpa2UgYSB2YWxpZCBlbWFpbC4iLAogICAgICAgICAgICAic291cmNlIjogewogICAgICAgICAgICAgICJwb2ludGVyIjogImRhdGEvYXR0cmlidXRlcy9lbWFpbCIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIF0KICAgICAgfQogICAgICBgYGAKICAgICAgIFRoZSBrZXkgYGRldGFpbGAgcHJvdmlkZXMgYSB0ZXh0dWFsIGRlc2NyaXB0aW9uIG9mIHRoZSBwcm9ibGVtLgogICAgICBBbHRlcm5hdGl2ZWx5LCB0aGUga2V5IGB0aXRsZWAgY2FuIGJlIHVzZWQgZm9yIHRoZSBzYW1lIHB1cnBvc2UuCiAgICAgICBUaGUgbmVzdGVkIGtleXMgYHNvdXJjZS5wb2ludGVyYCBkZXRhaWwgd2hpY2ggc3BlY2lmaWMgZWxlbWVudAogICAgICBvZiB0aGUgcmVxdWVzdCBkYXRhIHdhcyBpbnZhbGlkLgogICAgICAgTm90ZSB0aGF0IEpTT04tQVBJIGFsc28gYWxsb3dzIGZvciBvYmplY3QtbGV2ZWwgZXJyb3JzIHRvIGJlIHBsYWNlZAogICAgICBpbiBhbiBvYmplY3Qgd2l0aCBwb2ludGVyIGBkYXRhYCwgc2lnbmlmeWluZyB0aGF0IHRoZSBwcm9ibGVtCiAgICAgIGNhbm5vdCBiZSB0cmFjZWQgdG8gYSBzcGVjaWZpYyBhdHRyaWJ1dGU6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHsKICAgICAgICAiZXJyb3JzIjogWwogICAgICAgICAgewogICAgICAgICAgICAiZGV0YWlsIjogIlNvbWUgZ2VuZXJpYyBub24gcHJvcGVydHkgZXJyb3IgbWVzc2FnZSIsCiAgICAgICAgICAgICJzb3VyY2UiOiB7CiAgICAgICAgICAgICAgInBvaW50ZXIiOiAiZGF0YSIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIF0KICAgICAgfQogICAgICBgYGAKICAgICAgIFdoZW4gdHVybiBpbnRvIGEgYEVycm9yc2Agb2JqZWN0LCB5b3UgY2FuIHJlYWQgdGhlc2UgZXJyb3JzCiAgICAgIHRocm91Z2ggdGhlIHByb3BlcnR5IGBiYXNlYDoKICAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3sjZWFjaCBtb2RlbC5lcnJvcnMuYmFzZSBhcyB8ZXJyb3J8fX0KICAgICAgICA8ZGl2IGNsYXNzPSJlcnJvciI+CiAgICAgICAgICB7e2Vycm9yLm1lc3NhZ2V9fQogICAgICAgIDwvZGl2PgogICAgICB7ey9lYWNofX0KICAgICAgYGBgCiAgICAgICBFeGFtcGxlIG9mIGFsdGVybmF0aXZlIGltcGxlbWVudGF0aW9uLCBvdmVycmlkaW5nIHRoZSBkZWZhdWx0CiAgICAgIGJlaGF2aW9yIHRvIGRlYWwgd2l0aCBhIGRpZmZlcmVudCBmb3JtYXQgb2YgZXJyb3JzOgogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBleHRyYWN0RXJyb3JzKHN0b3JlLCB0eXBlQ2xhc3MsIHBheWxvYWQsIGlkKSB7CiAgICAgICAgICBpZiAocGF5bG9hZCAmJiB0eXBlb2YgcGF5bG9hZCA9PT0gJ29iamVjdCcgJiYgcGF5bG9hZC5fcHJvYmxlbXMpIHsKICAgICAgICAgICAgcGF5bG9hZCA9IHBheWxvYWQuX3Byb2JsZW1zOwogICAgICAgICAgICB0aGlzLm5vcm1hbGl6ZUVycm9ycyh0eXBlQ2xhc3MsIHBheWxvYWQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBheWxvYWQ7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGV4dHJhY3RFcnJvcnMKICAgICAgQHBhcmFtIHtTdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtNb2RlbH0gdHlwZUNsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEBwYXJhbSB7KFN0cmluZ3xOdW1iZXIpfSBpZAogICAgICBAcmV0dXJuIHtPYmplY3R9IGpzb24gVGhlIGRlc2VyaWFsaXplZCBlcnJvcnMKICAgICovCiAgICBleHRyYWN0RXJyb3JzOiBmdW5jdGlvbiBleHRyYWN0RXJyb3JzKHN0b3JlLCB0eXBlQ2xhc3MsIHBheWxvYWQsIGlkKSB7CiAgICAgIHZhciBfdGhpczYgPSB0aGlzOwoKICAgICAgaWYgKHBheWxvYWQgJiYgdHlwZW9mIHBheWxvYWQgPT09ICdvYmplY3QnICYmIHBheWxvYWQuZXJyb3JzKSB7CiAgICAgICAgcGF5bG9hZCA9ICgwLCBfcHJpdmF0ZS5lcnJvcnNBcnJheVRvSGFzaCkocGF5bG9hZC5lcnJvcnMpOwogICAgICAgIHRoaXMubm9ybWFsaXplVXNpbmdEZWNsYXJlZE1hcHBpbmcodHlwZUNsYXNzLCBwYXlsb2FkKTsKICAgICAgICB0eXBlQ2xhc3MuZWFjaEF0dHJpYnV0ZShmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgdmFyIGtleSA9IF90aGlzNi5rZXlGb3JBdHRyaWJ1dGUobmFtZSwgJ2Rlc2VyaWFsaXplJyk7CgogICAgICAgICAgaWYgKGtleSAhPT0gbmFtZSAmJiBwYXlsb2FkW2tleV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBwYXlsb2FkW25hbWVdID0gcGF5bG9hZFtrZXldOwogICAgICAgICAgICBkZWxldGUgcGF5bG9hZFtrZXldOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHR5cGVDbGFzcy5lYWNoUmVsYXRpb25zaGlwKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICB2YXIga2V5ID0gX3RoaXM2LmtleUZvclJlbGF0aW9uc2hpcChuYW1lLCAnZGVzZXJpYWxpemUnKTsKCiAgICAgICAgICBpZiAoa2V5ICE9PSBuYW1lICYmIHBheWxvYWRba2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHBheWxvYWRbbmFtZV0gPSBwYXlsb2FkW2tleV07CiAgICAgICAgICAgIGRlbGV0ZSBwYXlsb2FkW2tleV07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwYXlsb2FkOwogICAgfSwKCiAgICAvKioKICAgICAgYGtleUZvckF0dHJpYnV0ZWAgY2FuIGJlIHVzZWQgdG8gZGVmaW5lIHJ1bGVzIGZvciBob3cgdG8gY29udmVydCBhbgogICAgICBhdHRyaWJ1dGUgbmFtZSBpbiB5b3VyIG1vZGVsIHRvIGEga2V5IGluIHlvdXIgSlNPTi4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgSlNPTlNlcmlhbGl6ZXIgZnJvbSAnQGVtYmVyLWRhdGEvc2VyaWFsaXplci9qc29uJzsKICAgICAgaW1wb3J0IHsgdW5kZXJzY29yZSB9IGZyb20gJ0BlbWJlci9zdHJpbmcnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBrZXlGb3JBdHRyaWJ1dGUoYXR0ciwgbWV0aG9kKSB7CiAgICAgICAgICByZXR1cm4gdW5kZXJzY29yZShhdHRyKS50b1VwcGVyQ2FzZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBrZXlGb3JBdHRyaWJ1dGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleQogICAgICBAcGFyYW0ge1N0cmluZ30gbWV0aG9kCiAgICAgIEByZXR1cm4ge1N0cmluZ30gbm9ybWFsaXplZCBrZXkKICAgICovCiAgICBrZXlGb3JBdHRyaWJ1dGU6IGZ1bmN0aW9uIGtleUZvckF0dHJpYnV0ZShrZXksIG1ldGhvZCkgewogICAgICByZXR1cm4ga2V5OwogICAgfSwKCiAgICAvKioKICAgICAgYGtleUZvclJlbGF0aW9uc2hpcGAgY2FuIGJlIHVzZWQgdG8gZGVmaW5lIGEgY3VzdG9tIGtleSB3aGVuCiAgICAgIHNlcmlhbGl6aW5nIGFuZCBkZXNlcmlhbGl6aW5nIHJlbGF0aW9uc2hpcCBwcm9wZXJ0aWVzLiBCeSBkZWZhdWx0CiAgICAgIGBKU09OU2VyaWFsaXplcmAgZG9lcyBub3QgcHJvdmlkZSBhbiBpbXBsZW1lbnRhdGlvbiBvZiB0aGlzIG1ldGhvZC4KICAgICAgIEV4YW1wbGUKICAgICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICAgICBpbXBvcnQgSlNPTlNlcmlhbGl6ZXIgZnJvbSAnQGVtYmVyLWRhdGEvc2VyaWFsaXplci9qc29uJzsKICAgICAgICBpbXBvcnQgeyB1bmRlcnNjb3JlIH0gZnJvbSAnQGVtYmVyL3N0cmluZyc7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IEpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgICBrZXlGb3JSZWxhdGlvbnNoaXAoa2V5LCByZWxhdGlvbnNoaXAsIG1ldGhvZCkgewogICAgICAgICAgICByZXR1cm4gYHJlbF8ke3VuZGVyc2NvcmUoa2V5KX1gOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGBgYAogICAgICAgQG1ldGhvZCBrZXlGb3JSZWxhdGlvbnNoaXAKICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleQogICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZUNsYXNzCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QKICAgICAgQHJldHVybiB7U3RyaW5nfSBub3JtYWxpemVkIGtleQogICAgKi8KICAgIGtleUZvclJlbGF0aW9uc2hpcDogZnVuY3Rpb24ga2V5Rm9yUmVsYXRpb25zaGlwKGtleSwgdHlwZUNsYXNzLCBtZXRob2QpIHsKICAgICAgcmV0dXJuIGtleTsKICAgIH0sCgogICAgLyoqCiAgICAgYGtleUZvckxpbmtgIGNhbiBiZSB1c2VkIHRvIGRlZmluZSBhIGN1c3RvbSBrZXkgd2hlbiBkZXNlcmlhbGl6aW5nIGxpbmsKICAgICBwcm9wZXJ0aWVzLgogICAgICBAbWV0aG9kIGtleUZvckxpbmsKICAgICBAcGFyYW0ge1N0cmluZ30ga2V5CiAgICAgQHBhcmFtIHtTdHJpbmd9IGtpbmQgYGJlbG9uZ3NUb2Agb3IgYGhhc01hbnlgCiAgICAgQHJldHVybiB7U3RyaW5nfSBub3JtYWxpemVkIGtleQogICAgKi8KICAgIGtleUZvckxpbms6IGZ1bmN0aW9uIGtleUZvckxpbmsoa2V5LCBraW5kKSB7CiAgICAgIHJldHVybiBrZXk7CiAgICB9LAogICAgLy8gSEVMUEVSUwoKICAgIC8qKgogICAgIEBtZXRob2QgdHJhbnNmb3JtRm9yCiAgICAgQHByaXZhdGUKICAgICBAcGFyYW0ge1N0cmluZ30gYXR0cmlidXRlVHlwZQogICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2tpcEFzc2VydGlvbgogICAgIEByZXR1cm4ge1RyYW5zZm9ybX0gdHJhbnNmb3JtCiAgICAqLwogICAgdHJhbnNmb3JtRm9yOiBmdW5jdGlvbiB0cmFuc2Zvcm1Gb3IoYXR0cmlidXRlVHlwZSwgc2tpcEFzc2VydGlvbikgewogICAgICB2YXIgdHJhbnNmb3JtID0gRW1iZXIuZ2V0T3duZXIodGhpcykubG9va3VwKCd0cmFuc2Zvcm06JyArIGF0dHJpYnV0ZVR5cGUpOwogICAgICAoZmFsc2UgJiYgIShza2lwQXNzZXJ0aW9uIHx8ICEhdHJhbnNmb3JtKSAmJiBFbWJlci5hc3NlcnQoIlVuYWJsZSB0byBmaW5kIHRoZSB0cmFuc2Zvcm0gZm9yIGBhdHRyKCciICsgYXR0cmlidXRlVHlwZSArICInKWAiLCBza2lwQXNzZXJ0aW9uIHx8ICEhdHJhbnNmb3JtKSk7CiAgICAgIHJldHVybiB0cmFuc2Zvcm07CiAgICB9CiAgfSk7CgogIHZhciBfZGVmYXVsdCA9IEpTT05TZXJpYWxpemVyOwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CjtkZWZpbmUoIkBlbWJlci1kYXRhL3NlcmlhbGl6ZXIvcmVzdCIsIFsiZXhwb3J0cyIsICJlbWJlci1pbmZsZWN0b3IiLCAiQGVtYmVyLWRhdGEvc2VyaWFsaXplci9qc29uIiwgIkBlbWJlci1kYXRhL3N0b3JlLy1wcml2YXRlIiwgIkBlbWJlci1kYXRhL3NlcmlhbGl6ZXIvLXByaXZhdGUiLCAiQGVtYmVyLWRhdGEvc3RvcmUiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZW1iZXJJbmZsZWN0b3IsIF9qc29uLCBfcHJpdmF0ZSwgX3ByaXZhdGUyLCBfc3RvcmUpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIkVtYmVkZGVkUmVjb3Jkc01peGluIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3ByaXZhdGUyLkVtYmVkZGVkUmVjb3Jkc01peGluOwogICAgfQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIC8qKgogICAgTm9ybWFsbHksIGFwcGxpY2F0aW9ucyB3aWxsIHVzZSB0aGUgYFJFU1RTZXJpYWxpemVyYCBieSBpbXBsZW1lbnRpbmcKICAgIHRoZSBgbm9ybWFsaXplYCBtZXRob2QuCiAgCiAgICBUaGlzIGFsbG93cyB5b3UgdG8gZG8gd2hhdGV2ZXIga2luZCBvZiBtdW5naW5nIHlvdSBuZWVkIGFuZCBpcwogICAgZXNwZWNpYWxseSB1c2VmdWwgaWYgeW91ciBzZXJ2ZXIgaXMgaW5jb25zaXN0ZW50IGFuZCB5b3UgbmVlZCB0bwogICAgZG8gbXVuZ2luZyBkaWZmZXJlbnRseSBmb3IgbWFueSBkaWZmZXJlbnQga2luZHMgb2YgcmVzcG9uc2VzLgogIAogICAgU2VlIHRoZSBgbm9ybWFsaXplYCBkb2N1bWVudGF0aW9uIGZvciBtb3JlIGluZm9ybWF0aW9uLgogIAogICAgIyMgQWNyb3NzIHRoZSBCb2FyZCBOb3JtYWxpemF0aW9uCiAgCiAgICBUaGVyZSBhcmUgYWxzbyBhIG51bWJlciBvZiBob29rcyB0aGF0IHlvdSBtaWdodCBmaW5kIHVzZWZ1bCB0byBkZWZpbmUKICAgIGFjcm9zcy10aGUtYm9hcmQgcnVsZXMgZm9yIHlvdXIgcGF5bG9hZC4gVGhlc2UgcnVsZXMgd2lsbCBiZSB1c2VmdWwKICAgIGlmIHlvdXIgc2VydmVyIGlzIGNvbnNpc3RlbnQsIG9yIGlmIHlvdSdyZSBidWlsZGluZyBhbiBhZGFwdGVyIGZvcgogICAgYW4gaW5mcmFzdHJ1Y3R1cmUgc2VydmljZSwgbGlrZSBGaXJlYmFzZSwgYW5kIHdhbnQgdG8gZW5jb2RlIHNlcnZpY2UKICAgIGNvbnZlbnRpb25zLgogIAogICAgRm9yIGV4YW1wbGUsIGlmIGFsbCBvZiB5b3VyIGtleXMgYXJlIHVuZGVyc2NvcmVkIGFuZCBhbGwtY2FwcywgYnV0CiAgICBvdGhlcndpc2UgY29uc2lzdGVudCB3aXRoIHRoZSBuYW1lcyB5b3UgdXNlIGluIHlvdXIgbW9kZWxzLCB5b3UKICAgIGNhbiBpbXBsZW1lbnQgYWNyb3NzLXRoZS1ib2FyZCBydWxlcyBmb3IgaG93IHRvIGNvbnZlcnQgYW4gYXR0cmlidXRlCiAgICBuYW1lIGluIHlvdXIgbW9kZWwgdG8gYSBrZXkgaW4geW91ciBKU09OLgogIAogICAgYGBgYXBwL3NlcmlhbGl6ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICBpbXBvcnQgUkVTVFNlcmlhbGl6ZXIgZnJvbSAnQGVtYmVyLWRhdGEvc2VyaWFsaXplci9yZXN0JzsKICAgIGltcG9ydCB7IHVuZGVyc2NvcmUgfSBmcm9tICdAZW1iZXIvc3RyaW5nJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IFJFU1RTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgIGtleUZvckF0dHJpYnV0ZShhdHRyLCBtZXRob2QpIHsKICAgICAgICByZXR1cm4gdW5kZXJzY29yZShhdHRyKS50b1VwcGVyQ2FzZSgpOwogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgWW91IGNhbiBhbHNvIGltcGxlbWVudCBga2V5Rm9yUmVsYXRpb25zaGlwYCwgd2hpY2ggdGFrZXMgdGhlIG5hbWUKICAgIG9mIHRoZSByZWxhdGlvbnNoaXAgYXMgdGhlIGZpcnN0IHBhcmFtZXRlciwgdGhlIGtpbmQgb2YKICAgIHJlbGF0aW9uc2hpcCAoYGhhc01hbnlgIG9yIGBiZWxvbmdzVG9gKSBhcyB0aGUgc2Vjb25kIHBhcmFtZXRlciwgYW5kCiAgICB0aGUgbWV0aG9kIChgc2VyaWFsaXplYCBvciBgZGVzZXJpYWxpemVgKSBhcyB0aGUgdGhpcmQgcGFyYW1ldGVyLgogIAogICAgQGNsYXNzIFJFU1RTZXJpYWxpemVyCiAgICBAZXh0ZW5kcyBKU09OU2VyaWFsaXplcgogICovCiAgdmFyIFJFU1RTZXJpYWxpemVyID0gX2pzb24uZGVmYXVsdC5leHRlbmQoewogICAgLyoqCiAgICAgYGtleUZvclBvbHltb3JwaGljVHlwZWAgY2FuIGJlIHVzZWQgdG8gZGVmaW5lIGEgY3VzdG9tIGtleSB3aGVuCiAgICAgc2VyaWFsaXppbmcgYW5kIGRlc2VyaWFsaXppbmcgYSBwb2x5bW9ycGhpYyB0eXBlLiBCeSBkZWZhdWx0LCB0aGUKICAgICByZXR1cm5lZCBrZXkgaXMgYCR7a2V5fVR5cGVgLgogICAgICBFeGFtcGxlCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvcG9zdC5qcwogICAgICBpbXBvcnQgUkVTVFNlcmlhbGl6ZXIgZnJvbSAnQGVtYmVyLWRhdGEvc2VyaWFsaXplci9yZXN0JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJFU1RTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAga2V5Rm9yUG9seW1vcnBoaWNUeXBlKGtleSwgcmVsYXRpb25zaGlwKSB7CiAgICAgICAgICB2YXIgcmVsYXRpb25zaGlwS2V5ID0gdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXAoa2V5KTsKICAgICAgICAgICByZXR1cm4gJ3R5cGUtJyArIHJlbGF0aW9uc2hpcEtleTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgQG1ldGhvZCBrZXlGb3JQb2x5bW9ycGhpY1R5cGUKICAgICBAcGFyYW0ge1N0cmluZ30ga2V5CiAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGVDbGFzcwogICAgIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QKICAgICBAcmV0dXJuIHtTdHJpbmd9IG5vcm1hbGl6ZWQga2V5CiAgICAqLwogICAga2V5Rm9yUG9seW1vcnBoaWNUeXBlOiBmdW5jdGlvbiBrZXlGb3JQb2x5bW9ycGhpY1R5cGUoa2V5LCB0eXBlQ2xhc3MsIG1ldGhvZCkgewogICAgICB2YXIgcmVsYXRpb25zaGlwS2V5ID0gdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXAoa2V5KTsKICAgICAgcmV0dXJuIHJlbGF0aW9uc2hpcEtleSArICJUeXBlIjsKICAgIH0sCgogICAgLyoqCiAgICAgIE5vcm1hbGl6ZXMgYSBwYXJ0IG9mIHRoZSBKU09OIHBheWxvYWQgcmV0dXJuZWQgYnkKICAgICAgdGhlIHNlcnZlci4gWW91IHNob3VsZCBvdmVycmlkZSB0aGlzIG1ldGhvZCwgbXVuZ2UgdGhlIGhhc2gKICAgICAgYW5kIGNhbGwgc3VwZXIgaWYgeW91IGhhdmUgZ2VuZXJpYyBub3JtYWxpemF0aW9uIHRvIGRvLgogICAgICAgSXQgdGFrZXMgdGhlIHR5cGUgb2YgdGhlIHJlY29yZCB0aGF0IGlzIGJlaW5nIG5vcm1hbGl6ZWQKICAgICAgKGFzIGEgTW9kZWwgY2xhc3MpLCB0aGUgcHJvcGVydHkgd2hlcmUgdGhlIGhhc2ggd2FzCiAgICAgIG9yaWdpbmFsbHkgZm91bmQsIGFuZCB0aGUgaGFzaCB0byBub3JtYWxpemUuCiAgICAgICBGb3IgZXhhbXBsZSwgaWYgeW91IGhhdmUgYSBwYXlsb2FkIHRoYXQgbG9va3MgbGlrZSB0aGlzOgogICAgICAgYGBganMKICAgICAgewogICAgICAgICJwb3N0IjogewogICAgICAgICAgImlkIjogMSwKICAgICAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgICAgICJjb21tZW50cyI6IFsgMSwgMiBdCiAgICAgICAgfSwKICAgICAgICAiY29tbWVudHMiOiBbewogICAgICAgICAgImlkIjogMSwKICAgICAgICAgICJib2R5IjogIkZJUlNUIgogICAgICAgIH0sIHsKICAgICAgICAgICJpZCI6IDIsCiAgICAgICAgICAiYm9keSI6ICJSYWlscyBpcyB1bmFnaSIKICAgICAgICB9XQogICAgICB9CiAgICAgIGBgYAogICAgICAgVGhlIGBub3JtYWxpemVgIG1ldGhvZCB3aWxsIGJlIGNhbGxlZCB0aHJlZSB0aW1lczoKICAgICAgICogV2l0aCBgQXBwLlBvc3RgLCBgInBvc3RzImAgYW5kIGB7IGlkOiAxLCB0aXRsZTogIlJhaWxzIGlzIG9tYWthc2UiLCAuLi4gfWAKICAgICAgKiBXaXRoIGBBcHAuQ29tbWVudGAsIGAiY29tbWVudHMiYCBhbmQgYHsgaWQ6IDEsIGJvZHk6ICJGSVJTVCIgfWAKICAgICAgKiBXaXRoIGBBcHAuQ29tbWVudGAsIGAiY29tbWVudHMiYCBhbmQgYHsgaWQ6IDIsIGJvZHk6ICJSYWlscyBpcyB1bmFnaSIgfWAKICAgICAgIFlvdSBjYW4gdXNlIHRoaXMgbWV0aG9kLCBmb3IgZXhhbXBsZSwgdG8gbm9ybWFsaXplIHVuZGVyc2NvcmVkIGtleXMgdG8gY2FtZWxpemVkCiAgICAgIG9yIG90aGVyIGdlbmVyYWwtcHVycG9zZSBub3JtYWxpemF0aW9ucy4gWW91IHdpbGwgb25seSBuZWVkIHRvIGltcGxlbWVudAogICAgICBgbm9ybWFsaXplYCBhbmQgbWFuaXB1bGF0ZSB0aGUgcGF5bG9hZCBhcyBkZXNpcmVkLgogICAgICAgRm9yIGV4YW1wbGUsIGlmIHRoZSBgSURzYCB1bmRlciBgImNvbW1lbnRzImAgYXJlIHByb3ZpZGVkIGFzIGBfaWRgIGluc3RlYWQgb2YKICAgICAgYGlkYCwgeW91IGNhbiBzcGVjaWZ5IGhvdyB0byBub3JtYWxpemUganVzdCB0aGUgY29tbWVudHM6CiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvcG9zdC5qcwogICAgICBpbXBvcnQgUkVTVFNlcmlhbGl6ZXIgZnJvbSAnQGVtYmVyLWRhdGEvc2VyaWFsaXplci9yZXN0JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJFU1RTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgbm9ybWFsaXplKG1vZGVsLCBoYXNoLCBwcm9wKSB7CiAgICAgICAgICBpZiAocHJvcCA9PT0gJ2NvbW1lbnRzJykgewogICAgICAgICAgICBoYXNoLmlkID0gaGFzaC5faWQ7CiAgICAgICAgICAgIGRlbGV0ZSBoYXNoLl9pZDsKICAgICAgICAgIH0KICAgICAgICAgICByZXR1cm4gdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIE9uIGVhY2ggY2FsbCB0byB0aGUgYG5vcm1hbGl6ZWAgbWV0aG9kLCB0aGUgdGhpcmQgcGFyYW1ldGVyIChgcHJvcGApIGlzIGFsd2F5cwogICAgICBvbmUgb2YgdGhlIGtleXMgdGhhdCB3ZXJlIGluIHRoZSBvcmlnaW5hbCBwYXlsb2FkIG9yIGluIHRoZSByZXN1bHQgb2YgYW5vdGhlcgogICAgICBub3JtYWxpemF0aW9uIGFzIGBub3JtYWxpemVSZXNwb25zZWAuCiAgICAgICBAbWV0aG9kIG5vcm1hbGl6ZQogICAgICBAcGFyYW0ge01vZGVsfSBtb2RlbENsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSByZXNvdXJjZUhhc2gKICAgICAgQHBhcmFtIHtTdHJpbmd9IHByb3AKICAgICAgQHJldHVybiB7T2JqZWN0fQogICAgKi8KCiAgICAvKioKICAgICAgTm9ybWFsaXplcyBhbiBhcnJheSBvZiByZXNvdXJjZSBwYXlsb2FkcyBhbmQgcmV0dXJucyBhIEpTT04tQVBJIERvY3VtZW50CiAgICAgIHdpdGggcHJpbWFyeSBkYXRhIGFuZCwgaWYgYW55LCBpbmNsdWRlZCBkYXRhIGFzIGB7IGRhdGEsIGluY2x1ZGVkIH1gLgogICAgICAgQG1ldGhvZCBfbm9ybWFsaXplQXJyYXkKICAgICAgQHBhcmFtIHtTdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgICBAcGFyYW0ge09iamVjdH0gYXJyYXlIYXNoCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBwcm9wCiAgICAgIEByZXR1cm4ge09iamVjdH0KICAgICAgQHByaXZhdGUKICAgICovCiAgICBfbm9ybWFsaXplQXJyYXk6IGZ1bmN0aW9uIF9ub3JtYWxpemVBcnJheShzdG9yZSwgbW9kZWxOYW1lLCBhcnJheUhhc2gsIHByb3ApIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBkb2N1bWVudEhhc2ggPSB7CiAgICAgICAgZGF0YTogW10sCiAgICAgICAgaW5jbHVkZWQ6IFtdCiAgICAgIH07CiAgICAgIHZhciBtb2RlbENsYXNzID0gc3RvcmUubW9kZWxGb3IobW9kZWxOYW1lKTsKICAgICAgdmFyIHNlcmlhbGl6ZXIgPSBzdG9yZS5zZXJpYWxpemVyRm9yKG1vZGVsTmFtZSk7CiAgICAgIEVtYmVyLm1ha2VBcnJheShhcnJheUhhc2gpLmZvckVhY2goZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICB2YXIgX3RoaXMkX25vcm1hbGl6ZVBvbHltID0gX3RoaXMuX25vcm1hbGl6ZVBvbHltb3JwaGljUmVjb3JkKHN0b3JlLCBoYXNoLCBwcm9wLCBtb2RlbENsYXNzLCBzZXJpYWxpemVyKSwKICAgICAgICAgICAgZGF0YSA9IF90aGlzJF9ub3JtYWxpemVQb2x5bS5kYXRhLAogICAgICAgICAgICBpbmNsdWRlZCA9IF90aGlzJF9ub3JtYWxpemVQb2x5bS5pbmNsdWRlZDsKCiAgICAgICAgZG9jdW1lbnRIYXNoLmRhdGEucHVzaChkYXRhKTsKCiAgICAgICAgaWYgKGluY2x1ZGVkKSB7CiAgICAgICAgICB2YXIgX2RvY3VtZW50SGFzaCRpbmNsdWRlOwoKICAgICAgICAgIChfZG9jdW1lbnRIYXNoJGluY2x1ZGUgPSBkb2N1bWVudEhhc2guaW5jbHVkZWQpLnB1c2guYXBwbHkoX2RvY3VtZW50SGFzaCRpbmNsdWRlLCBpbmNsdWRlZCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIGRvY3VtZW50SGFzaDsKICAgIH0sCiAgICBfbm9ybWFsaXplUG9seW1vcnBoaWNSZWNvcmQ6IGZ1bmN0aW9uIF9ub3JtYWxpemVQb2x5bW9ycGhpY1JlY29yZChzdG9yZSwgaGFzaCwgcHJvcCwgcHJpbWFyeU1vZGVsQ2xhc3MsIHByaW1hcnlTZXJpYWxpemVyKSB7CiAgICAgIHZhciBzZXJpYWxpemVyID0gcHJpbWFyeVNlcmlhbGl6ZXI7CiAgICAgIHZhciBtb2RlbENsYXNzID0gcHJpbWFyeU1vZGVsQ2xhc3M7CiAgICAgIHZhciBwcmltYXJ5SGFzVHlwZUF0dHJpYnV0ZSA9ICgwLCBfcHJpdmF0ZTIubW9kZWxIYXNBdHRyaWJ1dGVPclJlbGF0aW9uc2hpcE5hbWVkVHlwZSkocHJpbWFyeU1vZGVsQ2xhc3MpOwoKICAgICAgaWYgKCFwcmltYXJ5SGFzVHlwZUF0dHJpYnV0ZSAmJiBoYXNoLnR5cGUpIHsKICAgICAgICAvLyBTdXBwb3J0IHBvbHltb3JwaGljIHJlY29yZHMgaW4gYXN5bmMgcmVsYXRpb25zaGlwcwogICAgICAgIHZhciBtb2RlbE5hbWUgPSB0aGlzLm1vZGVsTmFtZUZyb21QYXlsb2FkS2V5KGhhc2gudHlwZSk7CgogICAgICAgIGlmIChzdG9yZS5faGFzTW9kZWxGb3IobW9kZWxOYW1lKSkgewogICAgICAgICAgc2VyaWFsaXplciA9IHN0b3JlLnNlcmlhbGl6ZXJGb3IobW9kZWxOYW1lKTsKICAgICAgICAgIG1vZGVsQ2xhc3MgPSBzdG9yZS5tb2RlbEZvcihtb2RlbE5hbWUpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHNlcmlhbGl6ZXIubm9ybWFsaXplKG1vZGVsQ2xhc3MsIGhhc2gsIHByb3ApOwogICAgfSwKCiAgICAvKgogICAgICBAbWV0aG9kIF9ub3JtYWxpemVSZXNwb25zZQogICAgICBAcGFyYW0ge1N0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge01vZGVsfSBwcmltYXJ5TW9kZWxDbGFzcwogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IGlkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSByZXF1ZXN0VHlwZQogICAgICBAcGFyYW0ge0Jvb2xlYW59IGlzU2luZ2xlCiAgICAgIEByZXR1cm4ge09iamVjdH0gSlNPTi1BUEkgRG9jdW1lbnQKICAgICAgQHByaXZhdGUKICAgICovCiAgICBfbm9ybWFsaXplUmVzcG9uc2U6IGZ1bmN0aW9uIF9ub3JtYWxpemVSZXNwb25zZShzdG9yZSwgcHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSwgaXNTaW5nbGUpIHsKICAgICAgdmFyIGRvY3VtZW50SGFzaCA9IHsKICAgICAgICBkYXRhOiBudWxsLAogICAgICAgIGluY2x1ZGVkOiBbXQogICAgICB9OwogICAgICB2YXIgbWV0YSA9IHRoaXMuZXh0cmFjdE1ldGEoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkKTsKCiAgICAgIGlmIChtZXRhKSB7CiAgICAgICAgKGZhbHNlICYmICEoRW1iZXIudHlwZU9mKG1ldGEpID09PSAnb2JqZWN0JykgJiYgRW1iZXIuYXNzZXJ0KCdUaGUgYG1ldGFgIHJldHVybmVkIGZyb20gYGV4dHJhY3RNZXRhYCBoYXMgdG8gYmUgYW4gb2JqZWN0LCBub3QgIicgKyBFbWJlci50eXBlT2YobWV0YSkgKyAnIi4nLCBFbWJlci50eXBlT2YobWV0YSkgPT09ICdvYmplY3QnKSk7CiAgICAgICAgZG9jdW1lbnRIYXNoLm1ldGEgPSBtZXRhOwogICAgICB9CgogICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHBheWxvYWQpOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGtleXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgcHJvcCA9IGtleXNbaV07CiAgICAgICAgdmFyIG1vZGVsTmFtZSA9IHByb3A7CiAgICAgICAgdmFyIGZvcmNlZFNlY29uZGFyeSA9IGZhbHNlOwogICAgICAgIC8qCiAgICAgICAgICBJZiB5b3Ugd2FudCB0byBwcm92aWRlIHNpZGVsb2FkZWQgcmVjb3JkcyBvZiB0aGUgc2FtZSB0eXBlIHRoYXQgdGhlCiAgICAgICAgICBwcmltYXJ5IGRhdGEgeW91IGNhbiBkbyB0aGF0IGJ5IHByZWZpeGluZyB0aGUga2V5IHdpdGggYF9gLgogICAgICAgICAgIEV4YW1wbGUKICAgICAgICAgICBgYGAKICAgICAgICAgIHsKICAgICAgICAgICAgdXNlcnM6IFsKICAgICAgICAgICAgICB7IGlkOiAxLCB0aXRsZTogJ1RvbScsIG1hbmFnZXI6IDMgfSwKICAgICAgICAgICAgICB7IGlkOiAyLCB0aXRsZTogJ1llaHVkYScsIG1hbmFnZXI6IDMgfQogICAgICAgICAgICBdLAogICAgICAgICAgICBfdXNlcnM6IFsKICAgICAgICAgICAgICB7IGlkOiAzLCB0aXRsZTogJ1RvbXN0ZXInIH0KICAgICAgICAgICAgXQogICAgICAgICAgfQogICAgICAgICAgYGBgCiAgICAgICAgICAgVGhpcyBmb3JjZXMgYF91c2Vyc2AgdG8gYmUgYWRkZWQgdG8gYGluY2x1ZGVkYCBpbnN0ZWFkIG9mIGBkYXRhYC4KICAgICAgICAgKi8KCiAgICAgICAgaWYgKHByb3AuY2hhckF0KDApID09PSAnXycpIHsKICAgICAgICAgIGZvcmNlZFNlY29uZGFyeSA9IHRydWU7CiAgICAgICAgICBtb2RlbE5hbWUgPSBwcm9wLnN1YnN0cigxKTsKICAgICAgICB9CgogICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMubW9kZWxOYW1lRnJvbVBheWxvYWRLZXkobW9kZWxOYW1lKTsKCiAgICAgICAgaWYgKCFzdG9yZS5faGFzTW9kZWxGb3IodHlwZU5hbWUpKSB7CiAgICAgICAgICAoZmFsc2UgJiYgRW1iZXIud2Fybih0aGlzLndhcm5NZXNzYWdlTm9Nb2RlbEZvcktleShtb2RlbE5hbWUsIHR5cGVOYW1lKSwgZmFsc2UsIHsKICAgICAgICAgICAgaWQ6ICdkcy5zZXJpYWxpemVyLm1vZGVsLWZvci1rZXktbWlzc2luZycKICAgICAgICAgIH0pKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgdmFyIGlzUHJpbWFyeSA9ICFmb3JjZWRTZWNvbmRhcnkgJiYgdGhpcy5pc1ByaW1hcnlUeXBlKHN0b3JlLCB0eXBlTmFtZSwgcHJpbWFyeU1vZGVsQ2xhc3MpOwogICAgICAgIHZhciB2YWx1ZSA9IHBheWxvYWRbcHJvcF07CgogICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBpZiAoZmFsc2UKICAgICAgICAvKiBERUJVRyAqLwogICAgICAgICkgewogICAgICAgICAgdmFyIGlzUXVlcnlSZWNvcmRBbkFycmF5ID0gcmVxdWVzdFR5cGUgPT09ICdxdWVyeVJlY29yZCcgJiYgaXNQcmltYXJ5ICYmIEFycmF5LmlzQXJyYXkodmFsdWUpOwogICAgICAgICAgdmFyIG1lc3NhZ2UgPSAnVGhlIGFkYXB0ZXIgcmV0dXJuZWQgYW4gYXJyYXkgZm9yIHRoZSBwcmltYXJ5IGRhdGEgb2YgYSBgcXVlcnlSZWNvcmRgIHJlc3BvbnNlLiBUaGlzIGlzIGRlcHJlY2F0ZWQgYXMgYHF1ZXJ5UmVjb3JkYCBzaG91bGQgcmV0dXJuIGEgc2luZ2xlIHJlY29yZC4nOwogICAgICAgICAgKGZhbHNlICYmICEoIWlzUXVlcnlSZWNvcmRBbkFycmF5KSAmJiBFbWJlci5kZXByZWNhdGUobWVzc2FnZSwgIWlzUXVlcnlSZWNvcmRBbkFycmF5LCB7CiAgICAgICAgICAgIGlkOiAnZHMuc2VyaWFsaXplci5yZXN0LnF1ZXJ5UmVjb3JkLWFycmF5LXJlc3BvbnNlJywKICAgICAgICAgICAgdW50aWw6ICczLjAnLAogICAgICAgICAgICB1cmw6ICdodHRwczovL2RlcHJlY2F0aW9ucy5lbWJlcmpzLmNvbS9lbWJlci1kYXRhL3YyLngvI3RvY19zdG9yZS1xdWVyeXJlY29yZC1hcnJheS1yZXNwb25zZS13aXRoLXJlc3RzZXJpYWxpemVyJwogICAgICAgICAgfSkpOwogICAgICAgIH0KICAgICAgICAvKgogICAgICAgICAgU3VwcG9ydCBwcmltYXJ5IGRhdGEgYXMgYW4gb2JqZWN0IGluc3RlYWQgb2YgYW4gYXJyYXkuCiAgICAgICAgICAgRXhhbXBsZQogICAgICAgICAgIGBgYAogICAgICAgICAgewogICAgICAgICAgICB1c2VyOiB7IGlkOiAxLCB0aXRsZTogJ1RvbScsIG1hbmFnZXI6IDMgfQogICAgICAgICAgfQogICAgICAgICAgYGBgCiAgICAgICAgICovCgoKICAgICAgICBpZiAoaXNQcmltYXJ5ICYmICFBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgdmFyIF90aGlzJF9ub3JtYWxpemVQb2x5bTIgPSB0aGlzLl9ub3JtYWxpemVQb2x5bW9ycGhpY1JlY29yZChzdG9yZSwgdmFsdWUsIHByb3AsIHByaW1hcnlNb2RlbENsYXNzLCB0aGlzKSwKICAgICAgICAgICAgICBfZGF0YSA9IF90aGlzJF9ub3JtYWxpemVQb2x5bTIuZGF0YSwKICAgICAgICAgICAgICBfaW5jbHVkZWQgPSBfdGhpcyRfbm9ybWFsaXplUG9seW0yLmluY2x1ZGVkOwoKICAgICAgICAgIGRvY3VtZW50SGFzaC5kYXRhID0gX2RhdGE7CgogICAgICAgICAgaWYgKF9pbmNsdWRlZCkgewogICAgICAgICAgICB2YXIgX2RvY3VtZW50SGFzaCRpbmNsdWRlMjsKCiAgICAgICAgICAgIChfZG9jdW1lbnRIYXNoJGluY2x1ZGUyID0gZG9jdW1lbnRIYXNoLmluY2x1ZGVkKS5wdXNoLmFwcGx5KF9kb2N1bWVudEhhc2gkaW5jbHVkZTIsIF9pbmNsdWRlZCk7CiAgICAgICAgICB9CgogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgX3RoaXMkX25vcm1hbGl6ZUFycmF5ID0gdGhpcy5fbm9ybWFsaXplQXJyYXkoc3RvcmUsIHR5cGVOYW1lLCB2YWx1ZSwgcHJvcCksCiAgICAgICAgICAgIGRhdGEgPSBfdGhpcyRfbm9ybWFsaXplQXJyYXkuZGF0YSwKICAgICAgICAgICAgaW5jbHVkZWQgPSBfdGhpcyRfbm9ybWFsaXplQXJyYXkuaW5jbHVkZWQ7CgogICAgICAgIGlmIChpbmNsdWRlZCkgewogICAgICAgICAgdmFyIF9kb2N1bWVudEhhc2gkaW5jbHVkZTM7CgogICAgICAgICAgKF9kb2N1bWVudEhhc2gkaW5jbHVkZTMgPSBkb2N1bWVudEhhc2guaW5jbHVkZWQpLnB1c2guYXBwbHkoX2RvY3VtZW50SGFzaCRpbmNsdWRlMywgaW5jbHVkZWQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzU2luZ2xlKSB7CiAgICAgICAgICBkYXRhLmZvckVhY2goZnVuY3Rpb24gKHJlc291cmNlKSB7CiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgRmlndXJlcyBvdXQgaWYgdGhpcyBpcyB0aGUgcHJpbWFyeSByZWNvcmQgb3Igbm90LgogICAgICAgICAgICAgICBJdCdzIGVpdGhlcjoKICAgICAgICAgICAgICAgMS4gVGhlIHJlY29yZCB3aXRoIHRoZSBzYW1lIElEIGFzIHRoZSBvcmlnaW5hbCByZXF1ZXN0CiAgICAgICAgICAgICAgMi4gSWYgaXQncyBhIG5ld2x5IGNyZWF0ZWQgcmVjb3JkIHdpdGhvdXQgYW4gSUQsIHRoZSBmaXJzdCByZWNvcmQKICAgICAgICAgICAgICAgICBpbiB0aGUgYXJyYXkKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHZhciBpc1VwZGF0ZWRSZWNvcmQgPSBpc1ByaW1hcnkgJiYgKDAsIF9wcml2YXRlLmNvZXJjZUlkKShyZXNvdXJjZS5pZCkgPT09IGlkOwogICAgICAgICAgICB2YXIgaXNGaXJzdENyZWF0ZWRSZWNvcmQgPSBpc1ByaW1hcnkgJiYgIWlkICYmICFkb2N1bWVudEhhc2guZGF0YTsKCiAgICAgICAgICAgIGlmIChpc0ZpcnN0Q3JlYXRlZFJlY29yZCB8fCBpc1VwZGF0ZWRSZWNvcmQpIHsKICAgICAgICAgICAgICBkb2N1bWVudEhhc2guZGF0YSA9IHJlc291cmNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRvY3VtZW50SGFzaC5pbmNsdWRlZC5wdXNoKHJlc291cmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChpc1ByaW1hcnkpIHsKICAgICAgICAgICAgZG9jdW1lbnRIYXNoLmRhdGEgPSBkYXRhOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgICAgICB2YXIgX2RvY3VtZW50SGFzaCRpbmNsdWRlNDsKCiAgICAgICAgICAgICAgKF9kb2N1bWVudEhhc2gkaW5jbHVkZTQgPSBkb2N1bWVudEhhc2guaW5jbHVkZWQpLnB1c2guYXBwbHkoX2RvY3VtZW50SGFzaCRpbmNsdWRlNCwgZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBkb2N1bWVudEhhc2g7CiAgICB9LAogICAgaXNQcmltYXJ5VHlwZTogZnVuY3Rpb24gaXNQcmltYXJ5VHlwZShzdG9yZSwgdHlwZU5hbWUsIHByaW1hcnlUeXBlQ2xhc3MpIHsKICAgICAgcmV0dXJuIHN0b3JlLm1vZGVsRm9yKHR5cGVOYW1lKSA9PT0gcHJpbWFyeVR5cGVDbGFzczsKICAgIH0sCgogICAgLyoqCiAgICAgIFRoaXMgbWV0aG9kIGFsbG93cyB5b3UgdG8gcHVzaCBhIHBheWxvYWQgY29udGFpbmluZyB0b3AtbGV2ZWwKICAgICAgY29sbGVjdGlvbnMgb2YgcmVjb3JkcyBvcmdhbml6ZWQgcGVyIHR5cGUuCiAgICAgICBgYGBqcwogICAgICB7CiAgICAgICAgInBvc3RzIjogW3sKICAgICAgICAgICJpZCI6ICIxIiwKICAgICAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgICAgICJhdXRob3IiLCAiMSIsCiAgICAgICAgICAiY29tbWVudHMiOiBbICIxIiBdCiAgICAgICAgfV0sCiAgICAgICAgImNvbW1lbnRzIjogW3sKICAgICAgICAgICJpZCI6ICIxIiwKICAgICAgICAgICJib2R5IjogIkZJUlNUIgogICAgICAgIH1dLAogICAgICAgICJ1c2VycyI6IFt7CiAgICAgICAgICAiaWQiOiAiMSIsCiAgICAgICAgICAibmFtZSI6ICJAZDJoIgogICAgICAgIH1dCiAgICAgIH0KICAgICAgYGBgCiAgICAgICBJdCB3aWxsIGZpcnN0IG5vcm1hbGl6ZSB0aGUgcGF5bG9hZCwgc28geW91IGNhbiB1c2UgdGhpcyB0byBwdXNoCiAgICAgIGluIGRhdGEgc3RyZWFtaW5nIGluIGZyb20geW91ciBzZXJ2ZXIgc3RydWN0dXJlZCB0aGUgc2FtZSB3YXkKICAgICAgdGhhdCBmZXRjaGVzIGFuZCBzYXZlcyBhcmUgc3RydWN0dXJlZC4KICAgICAgIEBtZXRob2QgcHVzaFBheWxvYWQKICAgICAgQHBhcmFtIHtTdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICovCiAgICBwdXNoUGF5bG9hZDogZnVuY3Rpb24gcHVzaFBheWxvYWQoc3RvcmUsIHBheWxvYWQpIHsKICAgICAgdmFyIGRvY3VtZW50SGFzaCA9IHsKICAgICAgICBkYXRhOiBbXSwKICAgICAgICBpbmNsdWRlZDogW10KICAgICAgfTsKCiAgICAgIGZvciAodmFyIHByb3AgaW4gcGF5bG9hZCkgewogICAgICAgIHZhciBtb2RlbE5hbWUgPSB0aGlzLm1vZGVsTmFtZUZyb21QYXlsb2FkS2V5KHByb3ApOwoKICAgICAgICBpZiAoIXN0b3JlLl9oYXNNb2RlbEZvcihtb2RlbE5hbWUpKSB7CiAgICAgICAgICAoZmFsc2UgJiYgRW1iZXIud2Fybih0aGlzLndhcm5NZXNzYWdlTm9Nb2RlbEZvcktleShwcm9wLCBtb2RlbE5hbWUpLCBmYWxzZSwgewogICAgICAgICAgICBpZDogJ2RzLnNlcmlhbGl6ZXIubW9kZWwtZm9yLWtleS1taXNzaW5nJwogICAgICAgICAgfSkpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgdHlwZSA9IHN0b3JlLm1vZGVsRm9yKG1vZGVsTmFtZSk7CiAgICAgICAgdmFyIHR5cGVTZXJpYWxpemVyID0gc3RvcmUuc2VyaWFsaXplckZvcih0eXBlLm1vZGVsTmFtZSk7CiAgICAgICAgRW1iZXIubWFrZUFycmF5KHBheWxvYWRbcHJvcF0pLmZvckVhY2goZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICAgIHZhciBfdHlwZVNlcmlhbGl6ZXIkbm9ybWEgPSB0eXBlU2VyaWFsaXplci5ub3JtYWxpemUodHlwZSwgaGFzaCwgcHJvcCksCiAgICAgICAgICAgICAgZGF0YSA9IF90eXBlU2VyaWFsaXplciRub3JtYS5kYXRhLAogICAgICAgICAgICAgIGluY2x1ZGVkID0gX3R5cGVTZXJpYWxpemVyJG5vcm1hLmluY2x1ZGVkOwoKICAgICAgICAgIGRvY3VtZW50SGFzaC5kYXRhLnB1c2goZGF0YSk7CgogICAgICAgICAgaWYgKGluY2x1ZGVkKSB7CiAgICAgICAgICAgIHZhciBfZG9jdW1lbnRIYXNoJGluY2x1ZGU1OwoKICAgICAgICAgICAgKF9kb2N1bWVudEhhc2gkaW5jbHVkZTUgPSBkb2N1bWVudEhhc2guaW5jbHVkZWQpLnB1c2guYXBwbHkoX2RvY3VtZW50SGFzaCRpbmNsdWRlNSwgaW5jbHVkZWQpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICBzdG9yZS5wdXNoKGRvY3VtZW50SGFzaCk7CiAgICB9LAoKICAgIC8qKgogICAgICBUaGlzIG1ldGhvZCBpcyB1c2VkIHRvIGNvbnZlcnQgZWFjaCBKU09OIHJvb3Qga2V5IGluIHRoZSBwYXlsb2FkCiAgICAgIGludG8gYSBtb2RlbE5hbWUgdGhhdCBpdCBjYW4gdXNlIHRvIGxvb2sgdXAgdGhlIGFwcHJvcHJpYXRlIG1vZGVsIGZvcgogICAgICB0aGF0IHBhcnQgb2YgdGhlIHBheWxvYWQuCiAgICAgICBGb3IgZXhhbXBsZSwgeW91ciBzZXJ2ZXIgbWF5IHNlbmQgYSBtb2RlbCBuYW1lIHRoYXQgZG9lcyBub3QgY29ycmVzcG9uZCB3aXRoCiAgICAgIHRoZSBuYW1lIG9mIHRoZSBtb2RlbCBpbiB5b3VyIGFwcC4gTGV0J3MgdGFrZSBhIGxvb2sgYXQgYW4gZXhhbXBsZSBtb2RlbCwKICAgICAgYW5kIGFuIGV4YW1wbGUgcGF5bG9hZDoKICAgICAgIGBgYGFwcC9tb2RlbHMvcG9zdC5qcwogICAgICBpbXBvcnQgTW9kZWwgZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgIHsKICAgICAgICAgICJibG9nL3Bvc3QiOiB7CiAgICAgICAgICAgICJpZCI6ICIxCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICBgYGAKICAgICAgIEVtYmVyIERhdGEgaXMgZ29pbmcgdG8gbm9ybWFsaXplIHRoZSBwYXlsb2FkJ3Mgcm9vdCBrZXkgZm9yIHRoZSBtb2RlbE5hbWUuIEFzIGEgcmVzdWx0LAogICAgICBpdCB3aWxsIHRyeSB0byBsb29rIHVwIHRoZSAiYmxvZy9wb3N0IiBtb2RlbC4gU2luY2Ugd2UgZG9uJ3QgaGF2ZSBhIG1vZGVsIGNhbGxlZCAiYmxvZy9wb3N0IgogICAgICAob3IgYSBmaWxlIGNhbGxlZCBhcHAvbW9kZWxzL2Jsb2cvcG9zdC5qcyBpbiBlbWJlci1jbGkpLCBFbWJlciBEYXRhIHdpbGwgdGhyb3cgYW4gZXJyb3IKICAgICAgYmVjYXVzZSBpdCBjYW5ub3QgZmluZCB0aGUgImJsb2cvcG9zdCIgbW9kZWwuCiAgICAgICBTaW5jZSB3ZSB3YW50IHRvIHJlbW92ZSB0aGlzIG5hbWVzcGFjZSwgd2UgY2FuIGRlZmluZSBhIHNlcmlhbGl6ZXIgZm9yIHRoZSBhcHBsaWNhdGlvbiB0aGF0IHdpbGwKICAgICAgcmVtb3ZlICJibG9nLyIgZnJvbSB0aGUgcGF5bG9hZCBrZXkgd2hlbnZlciBpdCdzIGVuY291bnRlcmVkIGJ5IEVtYmVyIERhdGE6CiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IFJFU1RTZXJpYWxpemVyIGZyb20gJ0BlbWJlci1kYXRhL3NlcmlhbGl6ZXIvcmVzdCc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSRVNUU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIG1vZGVsTmFtZUZyb21QYXlsb2FkS2V5KHBheWxvYWRLZXkpIHsKICAgICAgICAgIGlmIChwYXlsb2FkS2V5ID09PSAnYmxvZy9wb3N0JykgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc3VwZXIocGF5bG9hZEtleS5yZXBsYWNlKCdibG9nLycsICcnKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgIHJldHVybiB0aGlzLl9zdXBlcihwYXlsb2FkS2V5KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEFmdGVyIHJlZnJlc2hpbmcsIEVtYmVyIERhdGEgd2lsbCBhcHByb3ByaWF0ZWx5IGxvb2sgdXAgdGhlICJwb3N0IiBtb2RlbC4KICAgICAgIEJ5IGRlZmF1bHQgdGhlIG1vZGVsTmFtZSBmb3IgYSBtb2RlbCBpcyBpdHMKICAgICAgbmFtZSBpbiBkYXNoZXJpemVkIGZvcm0uIFRoaXMgbWVhbnMgdGhhdCBhIHBheWxvYWQga2V5IGxpa2UgImJsb2dQb3N0IiB3b3VsZCBiZQogICAgICBub3JtYWxpemVkIHRvICJibG9nLXBvc3QiIHdoZW4gRW1iZXIgRGF0YSBsb29rcyB1cCB0aGUgbW9kZWwuIFVzdWFsbHksIEVtYmVyIERhdGEKICAgICAgY2FuIHVzZSB0aGUgY29ycmVjdCBpbmZsZWN0aW9uIHRvIGRvIHRoaXMgZm9yIHlvdS4gTW9zdCBvZiB0aGUgdGltZSwgeW91IHdvbid0CiAgICAgIG5lZWQgdG8gb3ZlcnJpZGUgYG1vZGVsTmFtZUZyb21QYXlsb2FkS2V5YCBmb3IgdGhpcyBwdXJwb3NlLgogICAgICAgQG1ldGhvZCBtb2RlbE5hbWVGcm9tUGF5bG9hZEtleQogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5CiAgICAgIEByZXR1cm4ge1N0cmluZ30gdGhlIG1vZGVsJ3MgbW9kZWxOYW1lCiAgICAqLwogICAgbW9kZWxOYW1lRnJvbVBheWxvYWRLZXk6IGZ1bmN0aW9uIG1vZGVsTmFtZUZyb21QYXlsb2FkS2V5KGtleSkgewogICAgICByZXR1cm4gKDAsIF9lbWJlckluZmxlY3Rvci5zaW5ndWxhcml6ZSkoKDAsIF9zdG9yZS5ub3JtYWxpemVNb2RlbE5hbWUpKGtleSkpOwogICAgfSwKICAgIC8vIFNFUklBTElaRQoKICAgIC8qKgogICAgICBDYWxsZWQgd2hlbiBhIHJlY29yZCBpcyBzYXZlZCBpbiBvcmRlciB0byBjb252ZXJ0IHRoZQogICAgICByZWNvcmQgaW50byBKU09OLgogICAgICAgQnkgZGVmYXVsdCwgaXQgY3JlYXRlcyBhIEpTT04gb2JqZWN0IHdpdGggYSBrZXkgZm9yCiAgICAgIGVhY2ggYXR0cmlidXRlIGFuZCBiZWxvbmdzVG8gcmVsYXRpb25zaGlwLgogICAgICAgRm9yIGV4YW1wbGUsIGNvbnNpZGVyIHRoaXMgbW9kZWw6CiAgICAgICBgYGBhcHAvbW9kZWxzL2NvbW1lbnQuanMKICAgICAgaW1wb3J0IE1vZGVsLCB7IGF0dHIsIGJlbG9uZ3NUbyB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgICAgdGl0bGU6IGF0dHIoKSwKICAgICAgICBib2R5OiBhdHRyKCksCiAgICAgICAgIGF1dGhvcjogYmVsb25nc1RvKCd1c2VyJykKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgVGhlIGRlZmF1bHQgc2VyaWFsaXphdGlvbiB3b3VsZCBjcmVhdGUgYSBKU09OIG9iamVjdCBsaWtlOgogICAgICAgYGBganMKICAgICAgewogICAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyB1bmFnaSIsCiAgICAgICAgImJvZHkiOiAiUmFpbHM/IE9tYWthc2U/IE9fTyIsCiAgICAgICAgImF1dGhvciI6IDEyCiAgICAgIH0KICAgICAgYGBgCiAgICAgICBCeSBkZWZhdWx0LCBhdHRyaWJ1dGVzIGFyZSBwYXNzZWQgdGhyb3VnaCBhcy1pcywgdW5sZXNzCiAgICAgIHlvdSBzcGVjaWZpZWQgYW4gYXR0cmlidXRlIHR5cGUgKGBhdHRyKCdkYXRlJylgKS4gSWYKICAgICAgeW91IHNwZWNpZnkgYSB0cmFuc2Zvcm0sIHRoZSBKYXZhU2NyaXB0IHZhbHVlIHdpbGwgYmUKICAgICAgc2VyaWFsaXplZCB3aGVuIGluc2VydGVkIGludG8gdGhlIEpTT04gaGFzaC4KICAgICAgIEJ5IGRlZmF1bHQsIGJlbG9uZ3MtdG8gcmVsYXRpb25zaGlwcyBhcmUgY29udmVydGVkIGludG8KICAgICAgSURzIHdoZW4gaW5zZXJ0ZWQgaW50byB0aGUgSlNPTiBoYXNoLgogICAgICAgIyMgSURzCiAgICAgICBgc2VyaWFsaXplYCB0YWtlcyBhbiBvcHRpb25zIGhhc2ggd2l0aCBhIHNpbmdsZSBvcHRpb246CiAgICAgIGBpbmNsdWRlSWRgLiBJZiB0aGlzIG9wdGlvbiBpcyBgdHJ1ZWAsIGBzZXJpYWxpemVgIHdpbGwsCiAgICAgIGJ5IGRlZmF1bHQgaW5jbHVkZSB0aGUgSUQgaW4gdGhlIEpTT04gb2JqZWN0IGl0IGJ1aWxkcy4KICAgICAgIFRoZSBhZGFwdGVyIHBhc3NlcyBpbiBgaW5jbHVkZUlkOiB0cnVlYCB3aGVuIHNlcmlhbGl6aW5nCiAgICAgIGEgcmVjb3JkIGZvciBgY3JlYXRlUmVjb3JkYCwgYnV0IG5vdCBmb3IgYHVwZGF0ZVJlY29yZGAuCiAgICAgICAjIyBDdXN0b21pemF0aW9uCiAgICAgICBZb3VyIHNlcnZlciBtYXkgZXhwZWN0IGEgZGlmZmVyZW50IEpTT04gZm9ybWF0IHRoYW4gdGhlCiAgICAgIGJ1aWx0LWluIHNlcmlhbGl6YXRpb24gZm9ybWF0LgogICAgICAgSW4gdGhhdCBjYXNlLCB5b3UgY2FuIGltcGxlbWVudCBgc2VyaWFsaXplYCB5b3Vyc2VsZiBhbmQKICAgICAgcmV0dXJuIGEgSlNPTiBoYXNoIG9mIHlvdXIgY2hvb3NpbmcuCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvcG9zdC5qcwogICAgICBpbXBvcnQgUkVTVFNlcmlhbGl6ZXIgZnJvbSAnQGVtYmVyLWRhdGEvc2VyaWFsaXplci9yZXN0JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJFU1RTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgc2VyaWFsaXplKHNuYXBzaG90LCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIganNvbiA9IHsKICAgICAgICAgICAgUE9TVF9UVEw6IHNuYXBzaG90LmF0dHIoJ3RpdGxlJyksCiAgICAgICAgICAgIFBPU1RfQkRZOiBzbmFwc2hvdC5hdHRyKCdib2R5JyksCiAgICAgICAgICAgIFBPU1RfQ01TOiBzbmFwc2hvdC5oYXNNYW55KCdjb21tZW50cycsIHsgaWRzOiB0cnVlIH0pCiAgICAgICAgICB9OwogICAgICAgICAgIGlmIChvcHRpb25zLmluY2x1ZGVJZCkgewogICAgICAgICAgICBqc29uLlBPU1RfSURfID0gc25hcHNob3QuaWQ7CiAgICAgICAgICB9CiAgICAgICAgICAgcmV0dXJuIGpzb247CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICAjIyBDdXN0b21pemluZyBhbiBBcHAtV2lkZSBTZXJpYWxpemVyCiAgICAgICBJZiB5b3Ugd2FudCB0byBkZWZpbmUgYSBzZXJpYWxpemVyIGZvciB5b3VyIGVudGlyZQogICAgICBhcHBsaWNhdGlvbiwgeW91J2xsIHByb2JhYmx5IHdhbnQgdG8gdXNlIGBlYWNoQXR0cmlidXRlYAogICAgICBhbmQgYGVhY2hSZWxhdGlvbnNoaXBgIG9uIHRoZSByZWNvcmQuCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IFJFU1RTZXJpYWxpemVyIGZyb20gJ0BlbWJlci1kYXRhL3NlcmlhbGl6ZXIvcmVzdCc7CiAgICAgIGltcG9ydCB7IHBsdXJhbGl6ZSB9IGZyb20gJ2VtYmVyLWluZmxlY3Rvcic7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSRVNUU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIHNlcmlhbGl6ZShzbmFwc2hvdCwgb3B0aW9ucykgewogICAgICAgICAgdmFyIGpzb24gPSB7fTsKICAgICAgICAgICBzbmFwc2hvdC5lYWNoQXR0cmlidXRlKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAganNvbltzZXJ2ZXJBdHRyaWJ1dGVOYW1lKG5hbWUpXSA9IHNuYXBzaG90LmF0dHIobmFtZSk7CiAgICAgICAgICB9KTsKICAgICAgICAgICBzbmFwc2hvdC5lYWNoUmVsYXRpb25zaGlwKGZ1bmN0aW9uKG5hbWUsIHJlbGF0aW9uc2hpcCkgewogICAgICAgICAgICBpZiAocmVsYXRpb25zaGlwLmtpbmQgPT09ICdoYXNNYW55JykgewogICAgICAgICAgICAgIGpzb25bc2VydmVySGFzTWFueU5hbWUobmFtZSldID0gc25hcHNob3QuaGFzTWFueShuYW1lLCB7IGlkczogdHJ1ZSB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICAgaWYgKG9wdGlvbnMuaW5jbHVkZUlkKSB7CiAgICAgICAgICAgIGpzb24uSURfID0gc25hcHNob3QuaWQ7CiAgICAgICAgICB9CiAgICAgICAgICAgcmV0dXJuIGpzb247CiAgICAgICAgfQogICAgICB9KTsKICAgICAgIGZ1bmN0aW9uIHNlcnZlckF0dHJpYnV0ZU5hbWUoYXR0cmlidXRlKSB7CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZS51bmRlcnNjb3JlKCkudG9VcHBlckNhc2UoKTsKICAgICAgfQogICAgICAgZnVuY3Rpb24gc2VydmVySGFzTWFueU5hbWUobmFtZSkgewogICAgICAgIHJldHVybiBzZXJ2ZXJBdHRyaWJ1dGVOYW1lKHNpbmd1bGFyaXplKG5hbWUpKSArICJfSURTIjsKICAgICAgfQogICAgICBgYGAKICAgICAgIFRoaXMgc2VyaWFsaXplciB3aWxsIGdlbmVyYXRlIEpTT04gdGhhdCBsb29rcyBsaWtlIHRoaXM6CiAgICAgICBgYGBqcwogICAgICB7CiAgICAgICAgIlRJVExFIjogIlJhaWxzIGlzIG9tYWthc2UiLAogICAgICAgICJCT0RZIjogIlllcC4gT21ha2FzZS4iLAogICAgICAgICJDT01NRU5UX0lEUyI6IFsgMSwgMiwgMyBdCiAgICAgIH0KICAgICAgYGBgCiAgICAgICAjIyBUd2Vha2luZyB0aGUgRGVmYXVsdCBKU09OCiAgICAgICBJZiB5b3UganVzdCB3YW50IHRvIGRvIHNvbWUgc21hbGwgdHdlYWtzIG9uIHRoZSBkZWZhdWx0IEpTT04sCiAgICAgIHlvdSBjYW4gY2FsbCBzdXBlciBmaXJzdCBhbmQgbWFrZSB0aGUgdHdlYWtzIG9uIHRoZSByZXR1cm5lZAogICAgICBKU09OLgogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICAgaW1wb3J0IFJFU1RTZXJpYWxpemVyIGZyb20gJ0BlbWJlci1kYXRhL3NlcmlhbGl6ZXIvcmVzdCc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSRVNUU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIHNlcmlhbGl6ZShzbmFwc2hvdCwgb3B0aW9ucykgewogICAgICAgICAgdmFyIGpzb24gPSB0aGlzLl9zdXBlcihzbmFwc2hvdCwgb3B0aW9ucyk7CiAgICAgICAgICAganNvbi5zdWJqZWN0ID0ganNvbi50aXRsZTsKICAgICAgICAgIGRlbGV0ZSBqc29uLnRpdGxlOwogICAgICAgICAgIHJldHVybiBqc29uOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBzZXJpYWxpemUKICAgICAgQHBhcmFtIHtTbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAgQHJldHVybiB7T2JqZWN0fSBqc29uCiAgICAqLwogICAgc2VyaWFsaXplOiBmdW5jdGlvbiBzZXJpYWxpemUoc25hcHNob3QsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8qKgogICAgICBZb3UgY2FuIHVzZSB0aGlzIG1ldGhvZCB0byBjdXN0b21pemUgdGhlIHJvb3Qga2V5cyBzZXJpYWxpemVkIGludG8gdGhlIEpTT04uCiAgICAgIFRoZSBoYXNoIHByb3BlcnR5IHNob3VsZCBiZSBtb2RpZmllZCBieSByZWZlcmVuY2UgKHBvc3NpYmx5IHVzaW5nIHNvbWV0aGluZyBsaWtlIF8uZXh0ZW5kKQogICAgICBCeSBkZWZhdWx0IHRoZSBSRVNUIFNlcmlhbGl6ZXIgc2VuZHMgdGhlIG1vZGVsTmFtZSBvZiBhIG1vZGVsLCB3aGljaCBpcyBhIGNhbWVsaXplZAogICAgICB2ZXJzaW9uIG9mIHRoZSBuYW1lLgogICAgICAgRm9yIGV4YW1wbGUsIHlvdXIgc2VydmVyIG1heSBleHBlY3QgdW5kZXJzY29yZWQgcm9vdCBvYmplY3RzLgogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBSRVNUU2VyaWFsaXplciBmcm9tICdAZW1iZXItZGF0YS9zZXJpYWxpemVyL3Jlc3QnOwogICAgICBpbXBvcnQgeyBkZWNhbWVsaXplIH0gZnJvbSAnQGVtYmVyL3N0cmluZyc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSRVNUU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIHNlcmlhbGl6ZUludG9IYXNoKGRhdGEsIHR5cGUsIHJlY29yZCwgb3B0aW9ucykgewogICAgICAgICAgdmFyIHJvb3QgPSBkZWNhbWVsaXplKHR5cGUubW9kZWxOYW1lKTsKICAgICAgICAgIGRhdGFbcm9vdF0gPSB0aGlzLnNlcmlhbGl6ZShyZWNvcmQsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBzZXJpYWxpemVJbnRvSGFzaAogICAgICBAcGFyYW0ge09iamVjdH0gaGFzaAogICAgICBAcGFyYW0ge01vZGVsfSB0eXBlQ2xhc3MKICAgICAgQHBhcmFtIHtTbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICovCiAgICBzZXJpYWxpemVJbnRvSGFzaDogZnVuY3Rpb24gc2VyaWFsaXplSW50b0hhc2goaGFzaCwgdHlwZUNsYXNzLCBzbmFwc2hvdCwgb3B0aW9ucykgewogICAgICB2YXIgbm9ybWFsaXplZFJvb3RLZXkgPSB0aGlzLnBheWxvYWRLZXlGcm9tTW9kZWxOYW1lKHR5cGVDbGFzcy5tb2RlbE5hbWUpOwogICAgICBoYXNoW25vcm1hbGl6ZWRSb290S2V5XSA9IHRoaXMuc2VyaWFsaXplKHNuYXBzaG90LCBvcHRpb25zKTsKICAgIH0sCgogICAgLyoqCiAgICAgIFlvdSBjYW4gdXNlIGBwYXlsb2FkS2V5RnJvbU1vZGVsTmFtZWAgdG8gb3ZlcnJpZGUgdGhlIHJvb3Qga2V5IGZvciBhbiBvdXRnb2luZwogICAgICByZXF1ZXN0LiBCeSBkZWZhdWx0LCB0aGUgUkVTVFNlcmlhbGl6ZXIgcmV0dXJucyBhIGNhbWVsaXplZCB2ZXJzaW9uIG9mIHRoZQogICAgICBtb2RlbCdzIG5hbWUuCiAgICAgICBGb3IgYSBtb2RlbCBjYWxsZWQgVGFjb1BhcnR5LCBpdHMgYG1vZGVsTmFtZWAgd291bGQgYmUgdGhlIHN0cmluZyBgdGFjby1wYXJ0eWAuIFRoZSBSRVNUU2VyaWFsaXplcgogICAgICB3aWxsIHNlbmQgaXQgdG8gdGhlIHNlcnZlciB3aXRoIGB0YWNvUGFydHlgIGFzIHRoZSByb290IGtleSBpbiB0aGUgSlNPTiBwYXlsb2FkOgogICAgICAgYGBganMKICAgICAgewogICAgICAgICJ0YWNvUGFydHkiOiB7CiAgICAgICAgICAiaWQiOiAiMSIsCiAgICAgICAgICAibG9jYXRpb24iOiAiTWF0dGhldyBCZWFsZSdzIEhvdXNlIgogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgIEZvciBleGFtcGxlLCB5b3VyIHNlcnZlciBtYXkgZXhwZWN0IGRhc2hlcml6ZWQgcm9vdCBvYmplY3RzOgogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBSRVNUU2VyaWFsaXplciBmcm9tICdAZW1iZXItZGF0YS9zZXJpYWxpemVyL3Jlc3QnOwogICAgICBpbXBvcnQgeyBkYXNoZXJpemUgfSBmcm9tICdAZW1iZXIvc3RyaW5nJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJFU1RTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgcGF5bG9hZEtleUZyb21Nb2RlbE5hbWUobW9kZWxOYW1lKSB7CiAgICAgICAgICByZXR1cm4gZGFzaGVyaXplKG1vZGVsTmFtZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBHaXZlbiBhIGBUYWNvUGFydHlgIG1vZGVsLCBjYWxsaW5nIGBzYXZlYCBvbiBpdCB3b3VsZCBwcm9kdWNlIGFuIG91dGdvaW5nCiAgICAgIHJlcXVlc3QgbGlrZToKICAgICAgIGBgYGpzCiAgICAgIHsKICAgICAgICAidGFjby1wYXJ0eSI6IHsKICAgICAgICAgICJpZCI6ICIxIiwKICAgICAgICAgICJsb2NhdGlvbiI6ICJNYXR0aGV3IEJlYWxlJ3MgSG91c2UiCiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBwYXlsb2FkS2V5RnJvbU1vZGVsTmFtZQogICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICAgIEByZXR1cm4ge1N0cmluZ30KICAgICovCiAgICBwYXlsb2FkS2V5RnJvbU1vZGVsTmFtZTogZnVuY3Rpb24gcGF5bG9hZEtleUZyb21Nb2RlbE5hbWUobW9kZWxOYW1lKSB7CiAgICAgIHJldHVybiBFbWJlci5TdHJpbmcuY2FtZWxpemUobW9kZWxOYW1lKTsKICAgIH0sCgogICAgLyoqCiAgICAgIFlvdSBjYW4gdXNlIHRoaXMgbWV0aG9kIHRvIGN1c3RvbWl6ZSBob3cgcG9seW1vcnBoaWMgb2JqZWN0cyBhcmUgc2VyaWFsaXplZC4KICAgICAgQnkgZGVmYXVsdCB0aGUgUkVTVCBTZXJpYWxpemVyIGNyZWF0ZXMgdGhlIGtleSBieSBhcHBlbmRpbmcgYFR5cGVgIHRvCiAgICAgIHRoZSBhdHRyaWJ1dGUgYW5kIHZhbHVlIGZyb20gdGhlIG1vZGVsJ3MgY2FtZWxjYXNlZCBtb2RlbCBuYW1lLgogICAgICAgQG1ldGhvZCBzZXJpYWxpemVQb2x5bW9ycGhpY1R5cGUKICAgICAgQHBhcmFtIHtTbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHBhcmFtIHtPYmplY3R9IGpzb24KICAgICAgQHBhcmFtIHtPYmplY3R9IHJlbGF0aW9uc2hpcAogICAgKi8KICAgIHNlcmlhbGl6ZVBvbHltb3JwaGljVHlwZTogZnVuY3Rpb24gc2VyaWFsaXplUG9seW1vcnBoaWNUeXBlKHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApIHsKICAgICAgdmFyIGtleSA9IHJlbGF0aW9uc2hpcC5rZXk7CiAgICAgIHZhciB0eXBlS2V5ID0gdGhpcy5rZXlGb3JQb2x5bW9ycGhpY1R5cGUoa2V5LCByZWxhdGlvbnNoaXAudHlwZSwgJ3NlcmlhbGl6ZScpOwogICAgICB2YXIgYmVsb25nc1RvID0gc25hcHNob3QuYmVsb25nc1RvKGtleSk7CgogICAgICBpZiAoRW1iZXIuaXNOb25lKGJlbG9uZ3NUbykpIHsKICAgICAgICBqc29uW3R5cGVLZXldID0gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICBqc29uW3R5cGVLZXldID0gRW1iZXIuU3RyaW5nLmNhbWVsaXplKGJlbG9uZ3NUby5tb2RlbE5hbWUpOwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBZb3UgY2FuIHVzZSB0aGlzIG1ldGhvZCB0byBjdXN0b21pemUgaG93IGEgcG9seW1vcnBoaWMgcmVsYXRpb25zaGlwIHNob3VsZAogICAgICBiZSBleHRyYWN0ZWQuCiAgICAgICBAbWV0aG9kIGV4dHJhY3RQb2x5bW9ycGhpY1JlbGF0aW9uc2hpcAogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwVHlwZQogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwSGFzaAogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwT3B0aW9ucwogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAgKi8KICAgIGV4dHJhY3RQb2x5bW9ycGhpY1JlbGF0aW9uc2hpcDogZnVuY3Rpb24gZXh0cmFjdFBvbHltb3JwaGljUmVsYXRpb25zaGlwKHJlbGF0aW9uc2hpcFR5cGUsIHJlbGF0aW9uc2hpcEhhc2gsIHJlbGF0aW9uc2hpcE9wdGlvbnMpIHsKICAgICAgdmFyIGtleSA9IHJlbGF0aW9uc2hpcE9wdGlvbnMua2V5LAogICAgICAgICAgcmVzb3VyY2VIYXNoID0gcmVsYXRpb25zaGlwT3B0aW9ucy5yZXNvdXJjZUhhc2gsCiAgICAgICAgICByZWxhdGlvbnNoaXBNZXRhID0gcmVsYXRpb25zaGlwT3B0aW9ucy5yZWxhdGlvbnNoaXBNZXRhOyAvLyBBIHBvbHltb3JwaGljIGJlbG9uZ3NUbyByZWxhdGlvbnNoaXAgY2FuIGJlIHByZXNlbnQgaW4gdGhlIHBheWxvYWQKICAgICAgLy8gZWl0aGVyIGluIHRoZSBmb3JtIHdoZXJlIHRoZSBgaWRgIGFuZCB0aGUgYHR5cGVgIGFyZSBnaXZlbjoKICAgICAgLy8KICAgICAgLy8gICB7CiAgICAgIC8vICAgICBtZXNzYWdlOiB7IGlkOiAxLCB0eXBlOiAncG9zdCcgfQogICAgICAvLyAgIH0KICAgICAgLy8KICAgICAgLy8gb3IgYnkgdGhlIGBpZGAgYW5kIGEgYDxyZWxhdGlvbnNoaXA+VHlwZWAgYXR0cmlidXRlOgogICAgICAvLwogICAgICAvLyAgIHsKICAgICAgLy8gICAgIG1lc3NhZ2U6IDEsCiAgICAgIC8vICAgICBtZXNzYWdlVHlwZTogJ3Bvc3QnCiAgICAgIC8vICAgfQogICAgICAvLwogICAgICAvLyBUaGUgbmV4dCBjb2RlIGNoZWNrcyBpZiB0aGUgbGF0dGVyIGNhc2UgaXMgcHJlc2VudCBhbmQgcmV0dXJucyB0aGUKICAgICAgLy8gY29ycmVzcG9uZGluZyBKU09OLUFQSSByZXByZXNlbnRhdGlvbi4gVGhlIGZvcm1lciBjYXNlIGlzIGhhbmRsZWQgd2l0aGluCiAgICAgIC8vIHRoZSBiYXNlIGNsYXNzIEpTT05TZXJpYWxpemVyLgoKICAgICAgdmFyIGlzUG9seW1vcnBoaWMgPSByZWxhdGlvbnNoaXBNZXRhLm9wdGlvbnMucG9seW1vcnBoaWM7CiAgICAgIHZhciB0eXBlUHJvcGVydHkgPSB0aGlzLmtleUZvclBvbHltb3JwaGljVHlwZShrZXksIHJlbGF0aW9uc2hpcFR5cGUsICdkZXNlcmlhbGl6ZScpOwoKICAgICAgaWYgKGlzUG9seW1vcnBoaWMgJiYgcmVzb3VyY2VIYXNoW3R5cGVQcm9wZXJ0eV0gIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgcmVsYXRpb25zaGlwSGFzaCAhPT0gJ29iamVjdCcpIHsKICAgICAgICB2YXIgdHlwZSA9IHRoaXMubW9kZWxOYW1lRnJvbVBheWxvYWRLZXkocmVzb3VyY2VIYXNoW3R5cGVQcm9wZXJ0eV0pOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBpZDogcmVsYXRpb25zaGlwSGFzaCwKICAgICAgICAgIHR5cGU6IHR5cGUKICAgICAgICB9OwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9KTsKCiAgaWYgKGZhbHNlCiAgLyogREVCVUcgKi8KICApIHsKICAgIFJFU1RTZXJpYWxpemVyLnJlb3Blbih7CiAgICAgIHdhcm5NZXNzYWdlTm9Nb2RlbEZvcktleTogZnVuY3Rpb24gd2Fybk1lc3NhZ2VOb01vZGVsRm9yS2V5KHByb3AsIHR5cGVLZXkpIHsKICAgICAgICByZXR1cm4gJ0VuY291bnRlcmVkICInICsgcHJvcCArICciIGluIHBheWxvYWQsIGJ1dCBubyBtb2RlbCB3YXMgZm91bmQgZm9yIG1vZGVsIG5hbWUgIicgKyB0eXBlS2V5ICsgJyIgKHJlc29sdmVkIG1vZGVsIG5hbWUgdXNpbmcgJyArIHRoaXMuY29uc3RydWN0b3IudG9TdHJpbmcoKSArICcubW9kZWxOYW1lRnJvbVBheWxvYWRLZXkoIicgKyBwcm9wICsgJyIpKSc7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgdmFyIF9kZWZhdWx0ID0gUkVTVFNlcmlhbGl6ZXI7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KTsKO2RlZmluZSgiQGVtYmVyLWRhdGEvc2VyaWFsaXplci90cmFuc2Zvcm0iLCBbImV4cG9ydHMiLCAiQGVtYmVyLWRhdGEvc2VyaWFsaXplci8tcHJpdmF0ZSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9wcml2YXRlKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyLWRhdGEvc2VyaWFsaXplcgogICovCiAgdmFyIF9kZWZhdWx0ID0gX3ByaXZhdGUuVHJhbnNmb3JtOwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CjtkZWZpbmUoJ0BlbWJlci1kYXRhL3N0b3JlLy1wcml2YXRlJywgWydleHBvcnRzJywgJ3JlcXVpcmUnLCAnQGVtYmVyLWRhdGEvY2FuYXJ5LWZlYXR1cmVzJywgJ2VtYmVyLWluZmxlY3RvciddLCBmdW5jdGlvbiAoZXhwb3J0cywgcmVxdWlyZSwgY2FuYXJ5RmVhdHVyZXMsIGVtYmVySW5mbGVjdG9yKSB7ICd1c2Ugc3RyaWN0JzsKCiAgdmFyIHJlcXVpcmVfX2RlZmF1bHQgPSAnZGVmYXVsdCcgaW4gcmVxdWlyZSA/IHJlcXVpcmVbJ2RlZmF1bHQnXSA6IHJlcXVpcmU7CgogIC8qKgogICAgQG1vZHVsZSBAZW1iZXItZGF0YS9zdG9yZQogICovCiAgLy8gQWxsIG1vZGVsTmFtZXMgYXJlIGRhc2hlcml6ZWQgaW50ZXJuYWxseS4gQ2hhbmdpbmcgdGhpcyBmdW5jdGlvbiBtYXkKICAvLyByZXF1aXJlIGNoYW5nZXMgdG8gb3RoZXIgbm9ybWFsaXphdGlvbiBob29rcyAoc3VjaCBhcyB0eXBlRm9yUm9vdCkuCgogIC8qKgogICBUaGlzIG1ldGhvZCBub3JtYWxpemVzIGEgbW9kZWxOYW1lIGludG8gdGhlIGZvcm1hdCBFbWJlciBEYXRhIHVzZXMKICAgaW50ZXJuYWxseS4KCiAgICBAbWV0aG9kIG5vcm1hbGl6ZU1vZGVsTmFtZQogICAgQHB1YmxpYwogICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgQHJldHVybiB7U3RyaW5nfSBub3JtYWxpemVkTW9kZWxOYW1lCiAgKi8KICBmdW5jdGlvbiBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKSB7CiAgICByZXR1cm4gRW1iZXIuU3RyaW5nLmRhc2hlcml6ZShtb2RlbE5hbWUpOwogIH0KCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL3N0b3JlCiAgKi8KCiAgLyoqCiAgICogVGhpcyBzeW1ib2wgcHJvdmlkZXMgYSBTeW1ib2wgcmVwbGFjZW1lbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG8gbm90IGhhdmUgaXQKICAgKiAoZWcuIElFIDExKS4KICAgKgogICAqIFRoZSByZXBsYWNlbWVudCBpcyBkaWZmZXJlbnQgZnJvbSB0aGUgbmF0aXZlIFN5bWJvbCBpbiBzb21lIHdheXMuIEl0IGlzIGEKICAgKiBmdW5jdGlvbiB0aGF0IHByb2R1Y2VzIGFuIG91dHB1dDoKICAgKiAtIGl0ZXJhYmxlOwogICAqIC0gdGhhdCBpcyBhIHN0cmluZywgbm90IGEgc3ltYm9sLgogICAqCiAgICogQGludGVybmFsCiAgICovCiAgdmFyIHN5bWJvbCA9IHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnID8gU3ltYm9sIDogZnVuY3Rpb24gKGtleSkgewogICAgcmV0dXJuICJfXyIgKyBrZXkgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBEYXRlLm5vdygpKSArICJfXyI7CiAgfTsKCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL3N0b3JlCiAgKi8KCiAgLyoqCiAgICogVXNlIHRoaXMgYnJhbmQgdG8gYXNzaWduIGEgc3RyaW5nIGtleSB0byBhbiBpbnRlcmZhY2UKICAgKiBmb3IgbWFwcGluZyB0aGUgaW50ZXJmYWNlIHRvIGEgdGlnaHRseSBjb3VwbGVkIGludGVybmFsCiAgICogY2xhc3MgaW1wbGVtZW50YXRpb24uCiAgICoKICAgKiBUaGlzIGFsbG93cyB1cyB0byBleHBvc2UgdGhlIGludGVyZmFjZSBwdWJsaWNseSBidXQKICAgKiBzZWFtbGVzc2x5IHVwZ3JhZGUgdGhlc2UgaW50ZXJmYWNlcyBmb3Igb3VyIG93biB1c2UKICAgKiBpbnRlcm5hbGx5IHdoZW4gaW50ZXJuYWwgbWV0aG9kcyBhbmQgcHJvcGVydGllcyBhcmUKICAgKiBuZWVkZWQuCiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KCiAgdmFyIEJSQU5EX1NZTUJPTCA9IHN5bWJvbCgnREVCVUctdHMtYnJhbmQnKTsKCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL3N0b3JlCiAgKi8KCiAgLyoqCiAgICogQ2FzdHMgYSBwdWJsaWMgaW50ZXJmYWNlIHRvIHRoZSBtYXRjaGluZyBpbnRlcm5hbCBjbGFzcyBpbXBsZW1lbnRhdGlvbgogICAqCiAgICogQGludGVybmFsCiAgICovCiAgZnVuY3Rpb24gdXBncmFkZUZvckludGVybmFsKGV4dGVybmFsKSB7CiAgICByZXR1cm4gZXh0ZXJuYWw7CiAgfQoKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyLWRhdGEvc3RvcmUKICAqLwogIC8vIFVzZWQgYnkgdGhlIHN0b3JlIHRvIG5vcm1hbGl6ZSBJRHMgZW50ZXJpbmcgdGhlIHN0b3JlLiAgRGVzcGl0ZSB0aGUgZmFjdAogIC8vIHRoYXQgZGV2ZWxvcGVycyBtYXkgcHJvdmlkZSBJRHMgYXMgbnVtYmVycyAoZS5nLiwgYHN0b3JlLmZpbmRSZWNvcmQoJ3BlcnNvbicsIDEpYCksCiAgLy8gaXQgaXMgaW1wb3J0YW50IHRoYXQgaW50ZXJuYWxseSB3ZSB1c2Ugc3RyaW5ncywgc2luY2UgSURzIG1heSBiZSBzZXJpYWxpemVkCiAgLy8gYW5kIGxvc2UgdHlwZSBpbmZvcm1hdGlvbi4gIEZvciBleGFtcGxlLCBFbWJlcidzIHJvdXRlciBtYXkgcHV0IGEgcmVjb3JkJ3MKICAvLyBJRCBpbnRvIHRoZSBVUkwsIGFuZCBpZiB3ZSBsYXRlciB0cnkgdG8gZGVzZXJpYWxpemUgdGhhdCBVUkwgYW5kIGZpbmQgdGhlCiAgLy8gY29ycmVzcG9uZGluZyByZWNvcmQsIHdlIHdpbGwgbm90IGtub3cgaWYgaXQgaXMgYSBzdHJpbmcgb3IgYSBudW1iZXIuCiAgZnVuY3Rpb24gY29lcmNlSWQoaWQpIHsKICAgIGlmIChpZCA9PT0gbnVsbCB8fCBpZCA9PT0gdW5kZWZpbmVkIHx8IGlkID09PSAnJykgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBpZiAodHlwZW9mIGlkID09PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gaWQ7CiAgICB9CgogICAgaWYgKHR5cGVvZiBpZCA9PT0gJ3N5bWJvbCcpIHsKICAgICAgcmV0dXJuIGlkLnRvU3RyaW5nKCk7CiAgICB9CgogICAgcmV0dXJuICcnICsgaWQ7CiAgfQoKICBmdW5jdGlvbiBlbnN1cmVTdHJpbmdJZChpZCkgewogICAgdmFyIG5vcm1hbGl6ZWQgPSBudWxsOwoKICAgIGlmICh0eXBlb2YgaWQgPT09ICdzdHJpbmcnKSB7CiAgICAgIG5vcm1hbGl6ZWQgPSBpZC5sZW5ndGggPiAwID8gaWQgOiBudWxsOwogICAgfSBlbHNlIGlmICh0eXBlb2YgaWQgPT09ICdudW1iZXInICYmICFpc05hTihpZCkpIHsKICAgICAgbm9ybWFsaXplZCA9ICcnICsgaWQ7CiAgICB9CgogICAgcmV0dXJuIG5vcm1hbGl6ZWQ7CiAgfQoKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyLWRhdGEvc3RvcmUKICAqLwogIC8vIHN1cHBvcnQgSUUxMQogIHZhciBDUllQVE8gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgaGFzV2luZG93ID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCc7CiAgICB2YXIgaXNGYXN0Qm9vdCA9IHR5cGVvZiBGYXN0Qm9vdCAhPT0gJ3VuZGVmaW5lZCc7CgogICAgaWYgKGlzRmFzdEJvb3QpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBnZXRSYW5kb21WYWx1ZXM6IGZ1bmN0aW9uIGdldFJhbmRvbVZhbHVlcyhidWZmZXIpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBGYXN0Qm9vdC5yZXF1aXJlKCdjcnlwdG8nKS5yYW5kb21GaWxsU3luYyhidWZmZXIpOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVXNpbmcgY3JlYXRlUmVjb3JkIGluIEZhc3Rib290IHJlcXVpcmVzIHlvdSB0byBhZGQgdGhlICJjcnlwdG8iIHBhY2thZ2UgdG8gImZhc3Rib290RGVwZW5kZW5jaWVzIiBpbiB5b3VyIHBhY2thZ2UuanNvbicpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH0gZWxzZSBpZiAoaGFzV2luZG93ICYmIHR5cGVvZiB3aW5kb3cuY3J5cHRvICE9PSAndW5kZWZpbmVkJykgewogICAgICByZXR1cm4gd2luZG93LmNyeXB0bzsKICAgIH0gZWxzZSBpZiAoaGFzV2luZG93ICYmIHR5cGVvZiB3aW5kb3cubXNDcnlwdG8gIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiB3aW5kb3cubXNDcnlwdG8uZ2V0UmFuZG9tVmFsdWVzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHJldHVybiB3aW5kb3cubXNDcnlwdG87CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2VtYmVyLWRhdGE6IENhbm5vdCBmaW5kIGEgdmFsaWQgd2F5IHRvIGdlbmVyYXRlIGxvY2FsIGlkZW50aWZpZXJzJyk7CiAgICB9CiAgfSgpOyAvLyB3ZSBtaWdodCBiZSBhYmxlIHRvIG9wdGltaXplIHRoaXMgYnkgcmVxdWVzdGluZyBtb3JlIGJ5dGVzIHRoYW4gd2UgbmVlZCBhdCBhIHRpbWUKCgogIGZ1bmN0aW9uIHJuZygpIHsKICAgIC8vIFdIQVRXRyBjcnlwdG8gUk5HIC0gaHR0cDovL3dpa2kud2hhdHdnLm9yZy93aWtpL0NyeXB0bwogICAgdmFyIHJuZHM4ID0gbmV3IFVpbnQ4QXJyYXkoMTYpOwogICAgcmV0dXJuIENSWVBUTy5nZXRSYW5kb21WYWx1ZXMocm5kczgpOwogIH0KICAvKioKICAgKiBDb252ZXJ0IGFycmF5IG9mIDE2IGJ5dGUgdmFsdWVzIHRvIFVVSUQgc3RyaW5nIGZvcm1hdCBvZiB0aGUgZm9ybToKICAgKiBYWFhYWFhYWC1YWFhYLVhYWFgtWFhYWC1YWFhYWFhYWFhYWFgKICAgKi8KCgogIHZhciBieXRlVG9IZXggPSBbXTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCAyNTY7ICsraSkgewogICAgYnl0ZVRvSGV4W2ldID0gKGkgKyAweDEwMCkudG9TdHJpbmcoMTYpLnN1YnN0cigxKTsKICB9CgogIGZ1bmN0aW9uIGJ5dGVzVG9VdWlkKGJ1ZikgewogICAgdmFyIGJ0aCA9IGJ5dGVUb0hleDsgLy8gam9pbiB1c2VkIHRvIGZpeCBtZW1vcnkgaXNzdWUgY2F1c2VkIGJ5IGNvbmNhdGVuYXRpb246IGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTMxNzUjYzQKCiAgICByZXR1cm4gW2J0aFtidWZbMF1dLCBidGhbYnVmWzFdXSwgYnRoW2J1ZlsyXV0sIGJ0aFtidWZbM11dLCAnLScsIGJ0aFtidWZbNF1dLCBidGhbYnVmWzVdXSwgJy0nLCBidGhbYnVmWzZdXSwgYnRoW2J1Zls3XV0sICctJywgYnRoW2J1Zls4XV0sIGJ0aFtidWZbOV1dLCAnLScsIGJ0aFtidWZbMTBdXSwgYnRoW2J1ZlsxMV1dLCBidGhbYnVmWzEyXV0sIGJ0aFtidWZbMTNdXSwgYnRoW2J1ZlsxNF1dLCBidGhbYnVmWzE1XV1dLmpvaW4oJycpOwogIH0KCiAgZnVuY3Rpb24gdXVpZHY0KCkgewogICAgdmFyIHJuZHMgPSBybmcoKTsgLy8gUGVyIDQuNCwgc2V0IGJpdHMgZm9yIHZlcnNpb24gYW5kIGBjbG9ja19zZXFfaGlfYW5kX3Jlc2VydmVkYAoKICAgIHJuZHNbNl0gPSBybmRzWzZdICYgMHgwZiB8IDB4NDA7CiAgICBybmRzWzhdID0gcm5kc1s4XSAmIDB4M2YgfCAweDgwOwogICAgcmV0dXJuIGJ5dGVzVG9VdWlkKHJuZHMpOwogIH0KCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL3N0b3JlCiAgKi8KICB2YXIgSURFTlRJRklFUlMgPSBuZXcgV2Vha01hcCgpOwogIGZ1bmN0aW9uIGlzU3RhYmxlSWRlbnRpZmllcihpZGVudGlmaWVyKSB7CiAgICByZXR1cm4gSURFTlRJRklFUlMuaGFzKGlkZW50aWZpZXIpOwogIH0KICBmdW5jdGlvbiBtYXJrU3RhYmxlSWRlbnRpZmllcihpZGVudGlmaWVyKSB7CiAgICBJREVOVElGSUVSUy5zZXQoaWRlbnRpZmllciwgJ2lzLWlkZW50aWZpZXInKTsKICB9CiAgZnVuY3Rpb24gdW5tYXJrU3RhYmxlSWRlbnRpZmllcihpZGVudGlmaWVyKSB7CiAgICBJREVOVElGSUVSUy5kZWxldGUoaWRlbnRpZmllcik7CiAgfQoKICBmdW5jdGlvbiBpc05vbkVtcHR5U3RyaW5nKHN0cikgewogICAgcmV0dXJuIHR5cGVvZiBzdHIgPT09ICdzdHJpbmcnICYmIHN0ci5sZW5ndGggPiAwOwogIH0KCiAgdmFyIGNvbmZpZ3VyZWRGb3JnZXRNZXRob2Q7CiAgdmFyIGNvbmZpZ3VyZWRHZW5lcmF0aW9uTWV0aG9kOwogIHZhciBjb25maWd1cmVkUmVzZXRNZXRob2Q7CiAgdmFyIGNvbmZpZ3VyZWRVcGRhdGVNZXRob2Q7CiAgZnVuY3Rpb24gc2V0SWRlbnRpZmllckdlbmVyYXRpb25NZXRob2QobWV0aG9kKSB7CiAgICBjb25maWd1cmVkR2VuZXJhdGlvbk1ldGhvZCA9IG1ldGhvZDsKICB9CiAgZnVuY3Rpb24gc2V0SWRlbnRpZmllclVwZGF0ZU1ldGhvZChtZXRob2QpIHsKICAgIGNvbmZpZ3VyZWRVcGRhdGVNZXRob2QgPSBtZXRob2Q7CiAgfQogIGZ1bmN0aW9uIHNldElkZW50aWZpZXJGb3JnZXRNZXRob2QobWV0aG9kKSB7CiAgICBjb25maWd1cmVkRm9yZ2V0TWV0aG9kID0gbWV0aG9kOwogIH0KICBmdW5jdGlvbiBzZXRJZGVudGlmaWVyUmVzZXRNZXRob2QobWV0aG9kKSB7CiAgICBjb25maWd1cmVkUmVzZXRNZXRob2QgPSBtZXRob2Q7CiAgfQoKICBmdW5jdGlvbiBkZWZhdWx0R2VuZXJhdGlvbk1ldGhvZChkYXRhLCBidWNrZXQpIHsKICAgIGlmIChpc05vbkVtcHR5U3RyaW5nKGRhdGEubGlkKSkgewogICAgICByZXR1cm4gZGF0YS5saWQ7CiAgICB9CgogICAgdmFyIHR5cGUgPSBkYXRhLnR5cGUsCiAgICAgICAgaWQgPSBkYXRhLmlkOwoKICAgIGlmIChpc05vbkVtcHR5U3RyaW5nKGlkKSkgewogICAgICByZXR1cm4gIkBlbWJlci1kYXRhOmxpZC0iICsgbm9ybWFsaXplTW9kZWxOYW1lKHR5cGUpICsgIi0iICsgaWQ7CiAgICB9CgogICAgcmV0dXJuIHV1aWR2NCgpOwogIH0KCiAgdmFyIElkZW50aWZpZXJDYWNoZXMgPSBuZXcgV2Vha01hcCgpOwogIGZ1bmN0aW9uIGlkZW50aWZpZXJDYWNoZUZvcihzdG9yZSkgewogICAgdmFyIGNhY2hlID0gSWRlbnRpZmllckNhY2hlcy5nZXQoc3RvcmUpOwoKICAgIGlmIChjYWNoZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGNhY2hlID0gbmV3IElkZW50aWZpZXJDYWNoZSgpOwogICAgICBJZGVudGlmaWVyQ2FjaGVzLnNldChzdG9yZSwgY2FjaGUpOwogICAgfQoKICAgIHJldHVybiBjYWNoZTsKICB9CgogIGZ1bmN0aW9uIGRlZmF1bHRFbXB0eUNhbGxiYWNrKCkge30KCiAgdmFyIElkZW50aWZpZXJDYWNoZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIC8vIFR5cGVzY3JpcHQgc3RpbGwgbGVha3MgcHJpdmF0ZSBwcm9wZXJ0aWVzIGluIHRoZSBmaW5hbAogICAgLy8gY29tcGlsZWQgY2xhc3MsIHNvIHdlIG1heSB3YW50IHRvIG1vdmUgdGhlc2UgZnJvbSBfdW5kZXJzY29yZQogICAgLy8gdG8gYSBXZWFrTWFwIHRvIGF2b2lkIGxlYWtpbmcKICAgIC8vIGN1cnJlbnRseSB3ZSBsZWFrIHRoaXMgZm9yIHRlc3QgcHVycG9zZXMKICAgIGZ1bmN0aW9uIElkZW50aWZpZXJDYWNoZSgpIHsKICAgICAgdGhpcy5fY2FjaGUgPSB7CiAgICAgICAgbGlkczogT2JqZWN0LmNyZWF0ZShudWxsKSwKICAgICAgICB0eXBlczogT2JqZWN0LmNyZWF0ZShudWxsKQogICAgICB9OwogICAgICB0aGlzLl9nZW5lcmF0ZSA9IHZvaWQgMDsKICAgICAgdGhpcy5fdXBkYXRlID0gdm9pZCAwOwogICAgICB0aGlzLl9mb3JnZXQgPSB2b2lkIDA7CiAgICAgIHRoaXMuX3Jlc2V0ID0gdm9pZCAwOwogICAgICB0aGlzLl9tZXJnZSA9IHZvaWQgMDsKICAgICAgLy8gd2UgY2FjaGUgdGhlIHVzZXIgY29uZmlndXJlZEdlbmVyYXRpb25NZXRob2QgYXQgaW5pdCBiZWNhdXNlIGl0IG11c3QKICAgICAgLy8gYmUgY29uZmlndXJlZCBwcmlvciBhbmQgaXMgbm90IGFsbG93ZWQgdG8gYmUgY2hhbmdlZAogICAgICB0aGlzLl9nZW5lcmF0ZSA9IGNvbmZpZ3VyZWRHZW5lcmF0aW9uTWV0aG9kIHx8IGRlZmF1bHRHZW5lcmF0aW9uTWV0aG9kOwogICAgICB0aGlzLl91cGRhdGUgPSBjb25maWd1cmVkVXBkYXRlTWV0aG9kIHx8IGRlZmF1bHRFbXB0eUNhbGxiYWNrOwogICAgICB0aGlzLl9mb3JnZXQgPSBjb25maWd1cmVkRm9yZ2V0TWV0aG9kIHx8IGRlZmF1bHRFbXB0eUNhbGxiYWNrOwogICAgICB0aGlzLl9yZXNldCA9IGNvbmZpZ3VyZWRSZXNldE1ldGhvZCB8fCBkZWZhdWx0RW1wdHlDYWxsYmFjazsKICAgICAgdGhpcy5fbWVyZ2UgPSBkZWZhdWx0RW1wdHlDYWxsYmFjazsKICAgIH0KICAgIC8qKgogICAgICogaG9vayB0byBhbGxvdyBtYW5hZ2VtZW50IG9mIG1lcmdlIGNvbmZsaWN0cyB3aXRoIGlkZW50aWZpZXJzLgogICAgICoKICAgICAqIHdlIGFsbG93IGxhdGUgYmluZGluZyBvZiB0aGlzIHByaXZhdGUgaW50ZXJuYWwgbWVyZ2Ugc28gdGhhdCBgaW50ZXJuYWxNb2RlbEZhY3RvcnlgCiAgICAgKiBjYW4gaW5zZXJ0IGl0c2VsZiBoZXJlIHRvIGhhbmRsZSBlbGltaW5hdGlvbiBvZiBkdXBsaWNhdGVzCiAgICAgKgogICAgICogQGludGVybmFsCiAgICAgKi8KCgogICAgdmFyIF9wcm90byA9IElkZW50aWZpZXJDYWNoZS5wcm90b3R5cGU7CgogICAgX3Byb3RvLl9fY29uZmlndXJlTWVyZ2UgPSBmdW5jdGlvbiBfX2NvbmZpZ3VyZU1lcmdlKG1ldGhvZCkgewogICAgICB0aGlzLl9tZXJnZSA9IG1ldGhvZCB8fCBkZWZhdWx0RW1wdHlDYWxsYmFjazsKICAgIH0KICAgIC8qKgogICAgICogQGludGVybmFsCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8uX2dldFJlY29yZElkZW50aWZpZXIgPSBmdW5jdGlvbiBfZ2V0UmVjb3JkSWRlbnRpZmllcihyZXNvdXJjZSwgc2hvdWxkR2VuZXJhdGUpIHsKICAgICAgaWYgKHNob3VsZEdlbmVyYXRlID09PSB2b2lkIDApIHsKICAgICAgICBzaG91bGRHZW5lcmF0ZSA9IGZhbHNlOwogICAgICB9CgogICAgICAvLyBzaG9ydCBjaXJjdWl0IGlmIHdlJ3JlIGFscmVhZHkgdGhlIHN0YWJsZSB2ZXJzaW9uCiAgICAgIGlmIChpc1N0YWJsZUlkZW50aWZpZXIocmVzb3VyY2UpKSB7CgogICAgICAgIHJldHVybiByZXNvdXJjZTsKICAgICAgfSAvLyBgdHlwZWAgbXVzdCBhbHdheXMgYmUgcHJlc2VudAoKICAgICAgdmFyIHR5cGUgPSBub3JtYWxpemVNb2RlbE5hbWUocmVzb3VyY2UudHlwZSk7CiAgICAgIHZhciBrZXlPcHRpb25zID0gZ2V0VHlwZUluZGV4KHRoaXMuX2NhY2hlLnR5cGVzLCB0eXBlKTsKICAgICAgdmFyIGlkZW50aWZpZXI7CiAgICAgIHZhciBsaWQgPSBjb2VyY2VJZChyZXNvdXJjZS5saWQpOwogICAgICB2YXIgaWQgPSBjb2VyY2VJZChyZXNvdXJjZS5pZCk7IC8vIGdvIHN0cmFpZ2h0IGZvciB0aGUgc3RhYmxlIFJlY29yZElkZW50aWZpZXIga2V5J2QgdG8gYGxpZGAKCiAgICAgIGlmIChsaWQgIT09IG51bGwpIHsKICAgICAgICBpZGVudGlmaWVyID0ga2V5T3B0aW9ucy5saWRbbGlkXTsKICAgICAgfSAvLyB3ZSBtYXkgaGF2ZSBub3Qgc2VlbiB0aGlzIHJlc291cmNlIGJlZm9yZQogICAgICAvLyBidXQganVzdCBpbiBjYXNlIHdlIGNoZWNrIG91ciBvd24gc2Vjb25kYXJ5IGxvb2t1cCAoYGlkYCkKCgogICAgICBpZiAoaWRlbnRpZmllciA9PT0gdW5kZWZpbmVkICYmIGlkICE9PSBudWxsKSB7CiAgICAgICAgaWRlbnRpZmllciA9IGtleU9wdGlvbnMuaWRbaWRdOwogICAgICB9CgogICAgICBpZiAoaWRlbnRpZmllciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgLy8gd2UgaGF2ZSBkZWZpbml0ZWx5IG5vdCBzZWVuIHRoaXMgcmVzb3VyY2UgYmVmb3JlCiAgICAgICAgLy8gc28gd2UgYWxsb3cgdGhlIHVzZXIgY29uZmlndXJlZCBgR2VuZXJhdGlvbk1ldGhvZGAgdG8gdGVsbCB1cwogICAgICAgIHZhciBuZXdMaWQgPSB0aGlzLl9nZW5lcmF0ZShyZXNvdXJjZSwgJ3JlY29yZCcpOyAvLyB3ZSBkbyB0aGlzIF9ldmVuXyB3aGVuIGBsaWRgIGlzIHByZXNlbnQgYmVjYXVzZSBzZWNvbmRhcnkgbG9va3VwcwogICAgICAgIC8vIG1heSBuZWVkIHRvIGJlIHBvcHVsYXRlZCwgYnV0IHdlIGVuZm9yY2Ugbm90IGdpdmluZyB1cyBzb21ldGhpbmcKICAgICAgICAvLyBkaWZmZXJlbnQgdGhhbiBleHBlY3RlZAoKCiAgICAgICAgaWYgKGxpZCAhPT0gbnVsbCAmJiBuZXdMaWQgIT09IGxpZCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3Ugc2hvdWxkIG5vdCBjaGFuZ2UgdGhlIDxsaWQ+IG9mIGEgUmVjb3JkSWRlbnRpZmllciIpOwogICAgICAgIH0gZWxzZSBpZiAobGlkID09PSBudWxsKSB7CiAgICAgICAgICAvLyBhbGxvdyBjb25maWd1cmF0aW9uIHRvIHRlbGwgdXMgdGhhdCB3ZSBoYXZlCiAgICAgICAgICAvLyBzZWVuIHRoaXMgYGxpZGAgYmVmb3JlLiBFLmcuIGEgc2Vjb25kYXJ5IGxvb2t1cAogICAgICAgICAgLy8gY29ubmVjdHMgdGhpcyByZXNvdXJjZSB0byBhIHByZXZpb3VzbHkgc2VlbgogICAgICAgICAgLy8gcmVzb3VyY2UuCiAgICAgICAgICBpZGVudGlmaWVyID0ga2V5T3B0aW9ucy5saWRbbmV3TGlkXTsKICAgICAgICB9CgogICAgICAgIGlmIChzaG91bGRHZW5lcmF0ZSA9PT0gdHJ1ZSkgewogICAgICAgICAgaWYgKGlkZW50aWZpZXIgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAvLyBpZiB3ZSBzdGlsbCBkb24ndCBoYXZlIGFuIGlkZW50aWZpZXIsIHRpbWUgdG8gZ2VuZXJhdGUgb25lCiAgICAgICAgICAgIGlkZW50aWZpZXIgPSBtYWtlU3RhYmxlUmVjb3JkSWRlbnRpZmllcihpZCwgdHlwZSwgbmV3TGlkKTsgLy8gcG9wdWxhdGUgb3VyIHVuaXF1ZSB0YWJsZQoKICAgICAgICAgICAgdGhpcy5fY2FjaGUubGlkc1tpZGVudGlmaWVyLmxpZF0gPSBpZGVudGlmaWVyOyAvLyBwb3B1bGF0ZSBvdXIgcHJpbWFyeSBsb29rdXAgdGFibGUKICAgICAgICAgICAgLy8gVE9ETyBjb25zaWRlciBoYXZpbmcgdGhlIGBsaWRgIGNhY2hlIGJlCiAgICAgICAgICAgIC8vIG9uZSBsZXZlbCB1cAoKICAgICAgICAgICAga2V5T3B0aW9ucy5saWRbaWRlbnRpZmllci5saWRdID0gaWRlbnRpZmllcjsgLy8gVE9ETyBleGlzdHMgdGVtcG9yYXJpbHkgdG8gc3VwcG9ydCBgcGVla0FsbGAKICAgICAgICAgICAgLy8gYnV0IGxpa2VseSB0byBtb3ZlCgogICAgICAgICAgICBrZXlPcHRpb25zLl9hbGxJZGVudGlmaWVycy5wdXNoKGlkZW50aWZpZXIpOwogICAgICAgICAgfSAvLyBwb3B1bGF0ZSBvdXIgb3duIHNlY29uZGFyeSBsb29rdXAgdGFibGUKICAgICAgICAgIC8vIGV2ZW4gZm9yIHRoZSAic3VjY2Vzc2Z1bCIgc2Vjb25kYXJ5IGxvb2t1cAogICAgICAgICAgLy8gYnkgYF9nZW5lcmF0ZSgpYCwgc2luY2Ugd2UgbWlzc2VkIHRoZSBjYWNoZQogICAgICAgICAgLy8gcHJldmlvdXNseQogICAgICAgICAgLy8gd2UgdXNlIGlkZW50aWZpZXIuaWQgaW5zdGVhZCBvZiBpZCBoZXJlCiAgICAgICAgICAvLyBiZWNhdXNlIHRoZXkgbWF5IG5vdCBtYXRjaCBhbmQgd2UgcHJlZmVyCiAgICAgICAgICAvLyB3aGF0IHdlJ3ZlIHNldCB2aWEgcmVzb3VyY2UgZGF0YQoKCiAgICAgICAgICBpZiAoaWRlbnRpZmllci5pZCAhPT0gbnVsbCkgewogICAgICAgICAgICBrZXlPcHRpb25zLmlkW2lkZW50aWZpZXIuaWRdID0gaWRlbnRpZmllcjsgLy8gVE9ETyBhbGxvdyBmaWxsaW5nIG91dCBvZiBgaWRgIGhlcmUKICAgICAgICAgICAgLy8gZm9yIHRoZSBgdXNlcm5hbWVgIG5vbi1jbGllbnQgY3JlYXRlZAogICAgICAgICAgICAvLyBjYXNlLgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGlkZW50aWZpZXI7CiAgICB9CiAgICAvKioKICAgICAqIGFsbG93cyB1cyB0byBwZWVrIHdpdGhvdXQgZ2VuZXJhdGluZyB3aGVuIG5lZWRlZAogICAgICogdXNlZnVsIGZvciB0aGUgImNyZWF0ZSIgY2FzZSB3aGVuIHdlIG5lZWQgdG8gc2VlIGlmCiAgICAgKiB3ZSBhcmUgYWNjaWRlbnRhbGx5IG92ZXJ3cml0dGluZyBzb21ldGhpbmcKICAgICAqCiAgICAgKiBAaW50ZXJuYWwKICAgICAqLwogICAgOwoKICAgIF9wcm90by5wZWVrUmVjb3JkSWRlbnRpZmllciA9IGZ1bmN0aW9uIHBlZWtSZWNvcmRJZGVudGlmaWVyKHJlc291cmNlKSB7CiAgICAgIHJldHVybiB0aGlzLl9nZXRSZWNvcmRJZGVudGlmaWVyKHJlc291cmNlLCBmYWxzZSk7CiAgICB9CiAgICAvKgogICAgICBSZXR1cm5zIHRoZSBJZGVudGlmaWVyIGZvciB0aGUgZ2l2ZW4gUmVzb3VyY2UsIGNyZWF0ZXMgb25lIGlmIGl0IGRvZXMgbm90IHlldCBleGlzdC4KICAgICAgIFNwZWNpZmljYWxseSB0aGlzIG1lYW5zIHRoYXQgd2U6CiAgICAgICAtIHZhbGlkYXRlIHRoZSBgaWRgIGB0eXBlYCBhbmQgYGxpZGAgY29tYm8gYWdhaW5zdCBrbm93biBpZGVudGlmaWVycwogICAgICAtIHJldHVybiBhbiBvYmplY3Qgd2l0aCBhbiBgbGlkYCB0aGF0IGlzIHN0YWJsZSAocmVwZWF0ZWQgY2FsbHMgd2l0aCB0aGUgc2FtZQogICAgICAgIGBpZGAgKyBgdHlwZWAgb3IgYGxpZGAgd2lsbCByZXR1cm4gdGhlIHNhbWUgYGxpZGAgdmFsdWUpCiAgICAgIC0gdGhpcyByZWZlcmVudGlhbCBzdGFiaWxpdHkgb2YgdGhlIG9iamVjdCBpdHNlbGYgaXMgZ3VhcmFudGVlZAogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uZ2V0T3JDcmVhdGVSZWNvcmRJZGVudGlmaWVyID0gZnVuY3Rpb24gZ2V0T3JDcmVhdGVSZWNvcmRJZGVudGlmaWVyKHJlc291cmNlKSB7CiAgICAgIHJldHVybiB0aGlzLl9nZXRSZWNvcmRJZGVudGlmaWVyKHJlc291cmNlLCB0cnVlKTsKICAgIH0KICAgIC8qCiAgICAgUmV0dXJucyBhIG5ldyBJZGVudGlmaWVyIGZvciB0aGUgc3VwcGxpZWQgZGF0YS4gQ2FsbCB0aGlzIG1ldGhvZCB0byBnZW5lcmF0ZQogICAgIGFuIGlkZW50aWZpZXIgd2hlbiBhIG5ldyByZXNvdXJjZSBpcyBiZWluZyBjcmVhdGVkIGxvY2FsIHRvIHRoZSBjbGllbnQgYW5kCiAgICAgcG90ZW50aWFsbHkgZG9lcyBub3QgaGF2ZSBhbiBgaWRgLgogICAgICBEZWxlZ2F0ZXMgZ2VuZXJhdGlvbiB0byB0aGUgdXNlciBzdXBwbGllZCBgR2VuZXJhdGVNZXRob2RgIGlmIG9uZSBoYXMgYmVlbiBwcm92aWRlZAogICAgIHdpdGggdGhlIHNpZ25hdHVyZSBgZ2VuZXJhdGVNZXRob2QoeyB0eXBlIH0sICdyZWNvcmQnKWAuCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8uY3JlYXRlSWRlbnRpZmllckZvck5ld1JlY29yZCA9IGZ1bmN0aW9uIGNyZWF0ZUlkZW50aWZpZXJGb3JOZXdSZWNvcmQoZGF0YSkgewogICAgICB2YXIgbmV3TGlkID0gdGhpcy5fZ2VuZXJhdGUoZGF0YSwgJ3JlY29yZCcpOwoKICAgICAgdmFyIGlkZW50aWZpZXIgPSBtYWtlU3RhYmxlUmVjb3JkSWRlbnRpZmllcihkYXRhLmlkIHx8IG51bGwsIGRhdGEudHlwZSwgbmV3TGlkKTsKICAgICAgdmFyIGtleU9wdGlvbnMgPSBnZXRUeXBlSW5kZXgodGhpcy5fY2FjaGUudHlwZXMsIGRhdGEudHlwZSk7IC8vIHBvcHVsYXRlIG91ciB1bmlxdWUgdGFibGUKCiAgICAgIHRoaXMuX2NhY2hlLmxpZHNbaWRlbnRpZmllci5saWRdID0gaWRlbnRpZmllcjsgLy8gcG9wdWxhdGUgdGhlIHR5cGUrbGlkIGNhY2hlCgogICAgICBrZXlPcHRpb25zLmxpZFtuZXdMaWRdID0gaWRlbnRpZmllcjsgLy8gZW5zdXJlIGEgcGVla0FsbCBzZWVzIG91ciBuZXcgaWRlbnRpZmllciB0b28KICAgICAgLy8gVE9ETyBtb3ZlIHRoaXMgb3V0dGEgaGVyZT8KCiAgICAgIGtleU9wdGlvbnMuX2FsbElkZW50aWZpZXJzLnB1c2goaWRlbnRpZmllcik7CgogICAgICByZXR1cm4gaWRlbnRpZmllcjsKICAgIH0KICAgIC8qCiAgICAgUHJvdmlkZXMgdGhlIG9wcG9ydHVuaXR5IHRvIHVwZGF0ZSBzZWNvbmRhcnkgbG9va3VwIHRhYmxlcyBmb3IgZXhpc3RpbmcgaWRlbnRpZmllcnMKICAgICBDYWxsZWQgYWZ0ZXIgYW4gaWRlbnRpZmllciBjcmVhdGVkIHdpdGggYGNyZWF0ZUlkZW50aWZpZXJGb3JOZXdSZWNvcmRgIGhhcyBiZWVuCiAgICAgY29tbWl0dGVkLgogICAgICBBc3NpZ25lZCBgaWRgIHRvIGFuIGBJZGVudGlmaWVyYCBpZiBgaWRgIGhhcyBub3QgcHJldmlvdXNseSBleGlzdGVkOyBob3dldmVyLAogICAgIGF0dGVtcHRpbmcgdG8gY2hhbmdlIHRoZSBgaWRgIG9yIGNhbGxpbmcgdXBkYXRlIHdpdGhvdXQgcHJvdmlkaW5nIGFuIGBpZGAgd2hlbgogICAgIG9uZSBpcyBtaXNzaW5nIHdpbGwgdGhyb3cgYW4gZXJyb3IuCiAgICAgICAtIHNldHMgYGlkYCAoaWYgYGlkYCB3YXMgcHJldmlvdXNseSBgbnVsbGApCiAgICAgIC0gYGxpZGAgYW5kIGB0eXBlYCBNVVNUIE5PVCBiZSBhbHRlcmVkIHBvc3QgY3JlYXRpb24KICAgICAgIElmIGEgbWVyZ2Ugb2NjdXJzLCBpdCBpcyBwb3NzaWJsZSB0aGUgcmV0dXJuZWQgaWRlbnRpZmllciBkb2VzIG5vdCBtYXRjaCB0aGUgb3JpZ2luYWxseQogICAgICBwcm92aWRlZCBpZGVudGlmaWVyLiBJbiB0aGlzIGNhc2UgdGhlIGFiYW5kb25lZCBpZGVudGlmaWVyIHdpbGwgZ28gdGhyb3VnaCB0aGUgdXN1YWwKICAgICAgYGZvcmdldFJlY29yZElkZW50aWZpZXJgIGNvZGVwYXRocy4KICAgICovCiAgICA7CgogICAgX3Byb3RvLnVwZGF0ZVJlY29yZElkZW50aWZpZXIgPSBmdW5jdGlvbiB1cGRhdGVSZWNvcmRJZGVudGlmaWVyKGlkZW50aWZpZXJPYmplY3QsIGRhdGEpIHsKICAgICAgdmFyIGlkZW50aWZpZXIgPSB0aGlzLmdldE9yQ3JlYXRlUmVjb3JkSWRlbnRpZmllcihpZGVudGlmaWVyT2JqZWN0KTsKICAgICAgdmFyIGlkID0gaWRlbnRpZmllci5pZDsKICAgICAgdmFyIG5ld0lkID0gY29lcmNlSWQoZGF0YS5pZCk7CiAgICAgIHZhciBrZXlPcHRpb25zID0gZ2V0VHlwZUluZGV4KHRoaXMuX2NhY2hlLnR5cGVzLCBpZGVudGlmaWVyLnR5cGUpOwogICAgICB2YXIgZXhpc3RpbmdJZGVudGlmaWVyID0gZGV0ZWN0TWVyZ2Uoa2V5T3B0aW9ucywgaWRlbnRpZmllciwgbmV3SWQpOwoKICAgICAgaWYgKGV4aXN0aW5nSWRlbnRpZmllcikgewogICAgICAgIGlkZW50aWZpZXIgPSB0aGlzLl9tZXJnZVJlY29yZElkZW50aWZpZXJzKGtleU9wdGlvbnMsIGlkZW50aWZpZXIsIGV4aXN0aW5nSWRlbnRpZmllciwgZGF0YSwgbmV3SWQpOwogICAgICB9CgogICAgICBpZCA9IGlkZW50aWZpZXIuaWQ7CiAgICAgIHBlcmZvcm1SZWNvcmRJZGVudGlmaWVyVXBkYXRlKGlkZW50aWZpZXIsIGRhdGEsIHRoaXMuX3VwZGF0ZSk7CiAgICAgIG5ld0lkID0gaWRlbnRpZmllci5pZDsgLy8gYWRkIHRvIG91ciBvd24gc2Vjb25kYXJ5IGxvb2t1cCB0YWJsZQoKICAgICAgaWYgKGlkICE9PSBuZXdJZCAmJiBuZXdJZCAhPT0gbnVsbCkgewogICAgICAgIHZhciBfa2V5T3B0aW9ucyA9IGdldFR5cGVJbmRleCh0aGlzLl9jYWNoZS50eXBlcywgaWRlbnRpZmllci50eXBlKTsKCiAgICAgICAgX2tleU9wdGlvbnMuaWRbbmV3SWRdID0gaWRlbnRpZmllcjsKCiAgICAgICAgaWYgKGlkICE9PSBudWxsKSB7CiAgICAgICAgICBkZWxldGUgX2tleU9wdGlvbnMuaWRbaWRdOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGlkZW50aWZpZXI7CiAgICB9OwoKICAgIF9wcm90by5fbWVyZ2VSZWNvcmRJZGVudGlmaWVycyA9IGZ1bmN0aW9uIF9tZXJnZVJlY29yZElkZW50aWZpZXJzKGtleU9wdGlvbnMsIGlkZW50aWZpZXIsIGV4aXN0aW5nSWRlbnRpZmllciwgZGF0YSwgbmV3SWQpIHsKICAgICAgLy8gZGVsZWdhdGUgZGV0ZXJtaW5pbmcgd2hpY2ggaWRlbnRpZmllciB0byBrZWVwIHRvIHRoZSBjb25maWd1cmVkIE1lcmdlTWV0aG9kCiAgICAgIHZhciBrZXB0ID0gdGhpcy5fbWVyZ2UoaWRlbnRpZmllciwgZXhpc3RpbmdJZGVudGlmaWVyLCBkYXRhKTsKCiAgICAgIHZhciBhYmFuZG9uZWQgPSBrZXB0ID09PSBpZGVudGlmaWVyID8gZXhpc3RpbmdJZGVudGlmaWVyIDogaWRlbnRpZmllcjsgLy8gY2xlYW51cCB0aGUgaWRlbnRpZmllciB3ZSBubyBsb25nZXIgbmVlZAoKICAgICAgdGhpcy5mb3JnZXRSZWNvcmRJZGVudGlmaWVyKGFiYW5kb25lZCk7IC8vIGVuc3VyZSBhIHNlY29uZGFyeSBjYWNoZSBlbnRyeSBmb3IgdGhpcyBpZCBmb3IgdGhlIGlkZW50aWZpZXIgd2UgZG8ga2VlcAoKICAgICAga2V5T3B0aW9ucy5pZFtuZXdJZF0gPSBrZXB0OyAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgYGxpZGAgb24gdGhlIGRhdGEgd2UgYXJlIHByb2Nlc3NpbmcgbWF0Y2hlcyB0aGUgbGlkIHdlIGtlcHQKCiAgICAgIGRhdGEubGlkID0ga2VwdC5saWQ7CiAgICAgIHJldHVybiBrZXB0OwogICAgfQogICAgLyoKICAgICBQcm92aWRlcyB0aGUgb3Bwb3J0dW5pdHkgdG8gZWxpbWluYXRlIGFuIGlkZW50aWZpZXIgZnJvbSBzZWNvbmRhcnkgbG9va3VwIHRhYmxlcwogICAgIGFzIHdlbGwgYXMgZWxpbWluYXRlcyBpdCBmcm9tIGVtYmVyLWRhdGEncyBvd24gbG9va3VwIHRhYmxlcyBhbmQgYm9vayBrZWVwaW5nLgogICAgICBVc2VmdWwgd2hlbiBhIHJlY29yZCBoYXMgYmVlbiBkZWxldGVkIGFuZCB0aGUgZGVsZXRpb24gaGFzIGJlZW4gcGVyc2lzdGVkIGFuZAogICAgIHdlIGRvIG5vdCBjYXJlIGFib3V0IHRoZSByZWNvcmQgYW55bW9yZS4gRXNwZWNpYWxseSB1c2VmdWwgd2hlbiBhbiBgaWRgIG9mIGEKICAgICBkZWxldGVkIHJlY29yZCBtaWdodCBiZSByZXVzZWQgbGF0ZXIgZm9yIGEgbmV3IHJlY29yZC4KICAgICovCiAgICA7CgogICAgX3Byb3RvLmZvcmdldFJlY29yZElkZW50aWZpZXIgPSBmdW5jdGlvbiBmb3JnZXRSZWNvcmRJZGVudGlmaWVyKGlkZW50aWZpZXJPYmplY3QpIHsKICAgICAgdmFyIGlkZW50aWZpZXIgPSB0aGlzLmdldE9yQ3JlYXRlUmVjb3JkSWRlbnRpZmllcihpZGVudGlmaWVyT2JqZWN0KTsKICAgICAgdmFyIGtleU9wdGlvbnMgPSBnZXRUeXBlSW5kZXgodGhpcy5fY2FjaGUudHlwZXMsIGlkZW50aWZpZXIudHlwZSk7CgogICAgICBpZiAoaWRlbnRpZmllci5pZCAhPT0gbnVsbCkgewogICAgICAgIGRlbGV0ZSBrZXlPcHRpb25zLmlkW2lkZW50aWZpZXIuaWRdOwogICAgICB9CgogICAgICBkZWxldGUgdGhpcy5fY2FjaGUubGlkc1tpZGVudGlmaWVyLmxpZF07CiAgICAgIGRlbGV0ZSBrZXlPcHRpb25zLmxpZFtpZGVudGlmaWVyLmxpZF07CgogICAgICB2YXIgaW5kZXggPSBrZXlPcHRpb25zLl9hbGxJZGVudGlmaWVycy5pbmRleE9mKGlkZW50aWZpZXIpOwoKICAgICAga2V5T3B0aW9ucy5fYWxsSWRlbnRpZmllcnMuc3BsaWNlKGluZGV4LCAxKTsKCiAgICAgIHVubWFya1N0YWJsZUlkZW50aWZpZXIoaWRlbnRpZmllck9iamVjdCk7CgogICAgICB0aGlzLl9mb3JnZXQoaWRlbnRpZmllciwgJ3JlY29yZCcpOwogICAgfTsKCiAgICBfcHJvdG8uZGVzdHJveSA9IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgIHRoaXMuX3Jlc2V0KCk7CiAgICB9OwoKICAgIHJldHVybiBJZGVudGlmaWVyQ2FjaGU7CiAgfSgpOwoKICBmdW5jdGlvbiBnZXRUeXBlSW5kZXgodHlwZU1hcCwgdHlwZSkgewogICAgdmFyIHR5cGVJbmRleCA9IHR5cGVNYXBbdHlwZV07CgogICAgaWYgKHR5cGVJbmRleCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHR5cGVJbmRleCA9IHsKICAgICAgICBsaWQ6IE9iamVjdC5jcmVhdGUobnVsbCksCiAgICAgICAgaWQ6IE9iamVjdC5jcmVhdGUobnVsbCksCiAgICAgICAgX2FsbElkZW50aWZpZXJzOiBbXQogICAgICB9OwogICAgICB0eXBlTWFwW3R5cGVdID0gdHlwZUluZGV4OwogICAgfQoKICAgIHJldHVybiB0eXBlSW5kZXg7CiAgfQoKICBmdW5jdGlvbiBtYWtlU3RhYmxlUmVjb3JkSWRlbnRpZmllcihpZCwgdHlwZSwgbGlkLCBidWNrZXQsIGNsaWVudE9yaWdpbmF0ZWQpIHsKCiAgICB2YXIgcmVjb3JkSWRlbnRpZmllciA9IHsKICAgICAgbGlkOiBsaWQsCiAgICAgIGlkOiBpZCwKICAgICAgdHlwZTogdHlwZQogICAgfTsKICAgIG1hcmtTdGFibGVJZGVudGlmaWVyKHJlY29yZElkZW50aWZpZXIpOwoKICAgIHJldHVybiByZWNvcmRJZGVudGlmaWVyOwogIH0KCiAgZnVuY3Rpb24gcGVyZm9ybVJlY29yZElkZW50aWZpZXJVcGRhdGUoaWRlbnRpZmllciwgZGF0YSwgdXBkYXRlRm4pIHsKICAgIHZhciBpZCA9IGRhdGEuaWQsCiAgICAgICAgbGlkID0gZGF0YS5saWQ7CiAgICB2YXIgdHlwZSA9IG5vcm1hbGl6ZU1vZGVsTmFtZShkYXRhLnR5cGUpOwoKICAgIHsKICAgICAgdXBkYXRlRm4oaWRlbnRpZmllciwgZGF0YSwgJ3JlY29yZCcpOwogICAgfSAvLyB1cGdyYWRlIHRoZSBJRCwgdGhpcyBpcyBhICJvbmUgdGltZSBvbmx5IiBhYmlsaXR5CiAgICAvLyBmb3IgdGhlIG11bHRpcGxlLWNhY2hlLWtleSBzY2VuYXJpbyB3ZSAiY291bGQiCiAgICAvLyB1c2UgYSBoZXVyaXN0aWMgdG8gZ3Vlc3MgdGhlIGJlc3QgaWQgZm9yIGRpc3BsYXkKICAgIC8vICh1c3VhbGx5IHdoZW4gYGRhdGEuaWRgIGlzIGF2YWlsYWJsZSBhbmQgYGRhdGEuYXR0cmlidXRlc2AgaXMgbm90KQoKCiAgICBpZiAoaWQgIT09IHVuZGVmaW5lZCkgewogICAgICBpZGVudGlmaWVyLmlkID0gY29lcmNlSWQoaWQpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZGV0ZWN0TWVyZ2Uoa2V5T3B0aW9ucywgaWRlbnRpZmllciwgbmV3SWQpIHsKICAgIHZhciBpZCA9IGlkZW50aWZpZXIuaWQ7CgogICAgaWYgKGlkICE9PSBudWxsICYmIGlkICE9PSBuZXdJZCAmJiBuZXdJZCAhPT0gbnVsbCkgewogICAgICB2YXIgZXhpc3RpbmdJZGVudGlmaWVyID0ga2V5T3B0aW9ucy5pZFtuZXdJZF07CiAgICAgIHJldHVybiBleGlzdGluZ0lkZW50aWZpZXIgIT09IHVuZGVmaW5lZCA/IGV4aXN0aW5nSWRlbnRpZmllciA6IGZhbHNlOwogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9CgogIC8qKgogICAgQG1vZHVsZSBAZW1iZXItZGF0YS9zdG9yZQogICovCiAgLyoKICAgIFRoaXMgZmlsZSBlbmNhcHN1bGF0ZXMgdGhlIHZhcmlvdXMgc3RhdGVzIHRoYXQgYSByZWNvcmQgY2FuIHRyYW5zaXRpb24KICAgIHRocm91Z2ggZHVyaW5nIGl0cyBsaWZlY3ljbGUuCiAgKi8KCiAgLyoqCiAgICAjIyMgU3RhdGUKCiAgICBFYWNoIHJlY29yZCBoYXMgYSBgY3VycmVudFN0YXRlYCBwcm9wZXJ0eSB0aGF0IGV4cGxpY2l0bHkgdHJhY2tzIHdoYXQKICAgIHN0YXRlIGEgcmVjb3JkIGlzIGluIGF0IGFueSBnaXZlbiB0aW1lLiBGb3IgaW5zdGFuY2UsIGlmIGEgcmVjb3JkIGlzCiAgICBuZXdseSBjcmVhdGVkIGFuZCBoYXMgbm90IHlldCBiZWVuIHNlbnQgdG8gdGhlIGFkYXB0ZXIgdG8gYmUgc2F2ZWQsCiAgICBpdCB3b3VsZCBiZSBpbiB0aGUgYHJvb3QubG9hZGVkLmNyZWF0ZWQudW5jb21taXR0ZWRgIHN0YXRlLiAgSWYgYQogICAgcmVjb3JkIGhhcyBoYWQgbG9jYWwgbW9kaWZpY2F0aW9ucyBtYWRlIHRvIGl0IHRoYXQgYXJlIGluIHRoZQogICAgcHJvY2VzcyBvZiBiZWluZyBzYXZlZCwgdGhlIHJlY29yZCB3b3VsZCBiZSBpbiB0aGUKICAgIGByb290LmxvYWRlZC51cGRhdGVkLmluRmxpZ2h0YCBzdGF0ZS4gKFRoaXMgc3RhdGUgcGF0aCB3aWxsIGJlCiAgICBleHBsYWluZWQgaW4gbW9yZSBkZXRhaWwgYmVsb3cuKQoKICAgIEV2ZW50cyBhcmUgc2VudCBieSB0aGUgcmVjb3JkIG9yIGl0cyBzdG9yZSB0byB0aGUgcmVjb3JkJ3MKICAgIGBjdXJyZW50U3RhdGVgIHByb3BlcnR5LiBIb3cgdGhlIHN0YXRlIHJlYWN0cyB0byB0aGVzZSBldmVudHMgaXMKICAgIGRlcGVuZGVudCBvbiB3aGljaCBzdGF0ZSBpdCBpcyBpbi4gSW4gc29tZSBzdGF0ZXMsIGNlcnRhaW4gZXZlbnRzCiAgICB3aWxsIGJlIGludmFsaWQgYW5kIHdpbGwgY2F1c2UgYW4gZXhjZXB0aW9uIHRvIGJlIHJhaXNlZC4KCiAgICBTdGF0ZXMgYXJlIGhpZXJhcmNoaWNhbCBhbmQgZXZlcnkgc3RhdGUgaXMgYSBzdWItc3RhdGUgb2YgdGhlCiAgICBgUm9vdFN0YXRlYC4gRm9yIGV4YW1wbGUsIGEgcmVjb3JkIGNhbiBiZSBpbiB0aGUKICAgIGByb290LmRlbGV0ZWQudW5jb21taXR0ZWRgIHN0YXRlIHRoZW4gdHJhbnNpdGlvbnMgaW50byB0aGUKICAgIGByb290LmRlbGV0ZWQuaW5GbGlnaHRgIHN0YXRlLiBJZiBhIGNoaWxkIHN0YXRlIGRvZXMgbm90IGltcGxlbWVudAogICAgYW4gZXZlbnQgaGFuZGxlciwgdGhlIHN0YXRlIG1hbmFnZXIgd2lsbCBhdHRlbXB0IHRvIGludm9rZSB0aGUgZXZlbnQKICAgIG9uIGFsbCBwYXJlbnQgc3RhdGVzIHVudGlsIHRoZSByb290IHN0YXRlIGlzIHJlYWNoZWQuIFRoZSBzdGF0ZQogICAgaGllcmFyY2h5IG9mIGEgcmVjb3JkIGlzIGRlc2NyaWJlZCBpbiB0ZXJtcyBvZiBhIHBhdGggc3RyaW5nLiBZb3UKICAgIGNhbiBkZXRlcm1pbmUgYSByZWNvcmQncyBjdXJyZW50IHN0YXRlIGJ5IGdldHRpbmcgdGhlIHN0YXRlJ3MKICAgIGBzdGF0ZU5hbWVgIHByb3BlcnR5OgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHJlY29yZC5nZXQoJ2N1cnJlbnRTdGF0ZS5zdGF0ZU5hbWUnKTsKICAgIC8vPT4gInJvb3QuY3JlYXRlZC51bmNvbW1pdHRlZCIKICAgICBgYGAKCiAgICBUaGUgaGllcmFyY2h5IG9mIHZhbGlkIHN0YXRlcyB0aGF0IHNoaXAgd2l0aCBlbWJlciBkYXRhIGxvb2tzIGxpa2UKICAgIHRoaXM6CgogICAgYGBgdGV4dAogICAgKiByb290CiAgICAgICogZGVsZXRlZAogICAgICAgICogc2F2ZWQKICAgICAgICAqIHVuY29tbWl0dGVkCiAgICAgICAgKiBpbkZsaWdodAogICAgICAqIGVtcHR5CiAgICAgICogbG9hZGVkCiAgICAgICAgKiBjcmVhdGVkCiAgICAgICAgICAqIHVuY29tbWl0dGVkCiAgICAgICAgICAqIGluRmxpZ2h0CiAgICAgICAgKiBzYXZlZAogICAgICAgICogdXBkYXRlZAogICAgICAgICAgKiB1bmNvbW1pdHRlZAogICAgICAgICAgKiBpbkZsaWdodAogICAgICAqIGxvYWRpbmcKICAgIGBgYAoKICAgIFRoZSBgTW9kZWxgIHN0YXRlcyBhcmUgdGhlbXNlbHZlcyBzdGF0ZWxlc3MuIFdoYXQgdGhhdCBtZWFucyBpcwogICAgdGhhdCwgdGhlIGhpZXJhcmNoaWNhbCBzdGF0ZXMgdGhhdCBlYWNoIG9mICp0aG9zZSogcG9pbnRzIHRvIGlzIGEKICAgIHNoYXJlZCBkYXRhIHN0cnVjdHVyZS4gRm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMsIGluc3RlYWQgb2YgZWFjaAogICAgcmVjb3JkIGdldHRpbmcgaXRzIG93biBjb3B5IG9mIHRoZSBoaWVyYXJjaHkgb2Ygc3RhdGVzLCBlYWNoIHJlY29yZAogICAgcG9pbnRzIHRvIHRoaXMgZ2xvYmFsLCBpbW11dGFibGUgc2hhcmVkIGluc3RhbmNlLiBIb3cgZG9lcyBhIHN0YXRlCiAgICBrbm93IHdoaWNoIHJlY29yZCBpdCBzaG91bGQgYmUgYWN0aW5nIG9uPyBXZSBwYXNzIHRoZSByZWNvcmQKICAgIGluc3RhbmNlIGludG8gdGhlIHN0YXRlJ3MgZXZlbnQgaGFuZGxlcnMgYXMgdGhlIGZpcnN0IGFyZ3VtZW50LgoKICAgIFRoZSByZWNvcmQgcGFzc2VkIGFzIHRoZSBmaXJzdCBwYXJhbWV0ZXIgaXMgd2hlcmUgeW91IHNob3VsZCBzdGFzaAogICAgc3RhdGUgYWJvdXQgdGhlIHJlY29yZCBpZiBuZWVkZWQ7IHlvdSBzaG91bGQgbmV2ZXIgc3RvcmUgZGF0YSBvbiB0aGUgc3RhdGUKICAgIG9iamVjdCBpdHNlbGYuCgogICAgIyMjIEV2ZW50cyBhbmQgRmxhZ3MKCiAgICBBIHN0YXRlIG1heSBpbXBsZW1lbnQgemVybyBvciBtb3JlIGV2ZW50cyBhbmQgZmxhZ3MuCgogICAgIyMjIyBFdmVudHMKCiAgICBFdmVudHMgYXJlIG5hbWVkIGZ1bmN0aW9ucyB0aGF0IGFyZSBpbnZva2VkIHdoZW4gc2VudCB0byBhIHJlY29yZC4gVGhlCiAgICByZWNvcmQgd2lsbCBmaXJzdCBsb29rIGZvciBhIG1ldGhvZCB3aXRoIHRoZSBnaXZlbiBuYW1lIG9uIHRoZQogICAgY3VycmVudCBzdGF0ZS4gSWYgbm8gbWV0aG9kIGlzIGZvdW5kLCBpdCB3aWxsIHNlYXJjaCB0aGUgY3VycmVudAogICAgc3RhdGUncyBwYXJlbnQsIGFuZCB0aGVuIGl0cyBncmFuZHBhcmVudCwgYW5kIHNvIG9uIHVudGlsIHJlYWNoaW5nCiAgICB0aGUgdG9wIG9mIHRoZSBoaWVyYXJjaHkuIElmIHRoZSByb290IGlzIHJlYWNoZWQgd2l0aG91dCBhbiBldmVudAogICAgaGFuZGxlciBiZWluZyBmb3VuZCwgYW4gZXhjZXB0aW9uIHdpbGwgYmUgcmFpc2VkLiBUaGlzIGNhbiBiZSB2ZXJ5CiAgICBoZWxwZnVsIHdoZW4gZGVidWdnaW5nIG5ldyBmZWF0dXJlcy4KCiAgICBIZXJlJ3MgYW4gZXhhbXBsZSBpbXBsZW1lbnRhdGlvbiBvZiBhIHN0YXRlIHdpdGggYSBgbXlFdmVudGAgZXZlbnQgaGFuZGxlcjoKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBhU3RhdGU6IFN0YXRlLmNyZWF0ZSh7CiAgICAgIG15RXZlbnQ6IGZ1bmN0aW9uKG1hbmFnZXIsIHBhcmFtKSB7CiAgICAgICAgY29uc29sZS5sb2coIlJlY2VpdmVkIG15RXZlbnQgd2l0aCIsIHBhcmFtKTsKICAgICAgfQogICAgfSkKICAgIGBgYAoKICAgIFRvIHRyaWdnZXIgdGhpcyBldmVudDoKCiAgICBgYGBqYXZhc2NyaXB0CiAgICByZWNvcmQuc2VuZCgnbXlFdmVudCcsICdmb28nKTsKICAgIC8vPT4gIlJlY2VpdmVkIG15RXZlbnQgd2l0aCBmb28iCiAgICBgYGAKCiAgICBOb3RlIHRoYXQgYW4gb3B0aW9uYWwgcGFyYW1ldGVyIGNhbiBiZSBzZW50IHRvIGEgcmVjb3JkJ3MgYHNlbmQoKWAgbWV0aG9kLAogICAgd2hpY2ggd2lsbCBiZSBwYXNzZWQgYXMgdGhlIHNlY29uZCBwYXJhbWV0ZXIgdG8gdGhlIGV2ZW50IGhhbmRsZXIuCgogICAgRXZlbnRzIHNob3VsZCB0cmFuc2l0aW9uIHRvIGEgZGlmZmVyZW50IHN0YXRlIGlmIGFwcHJvcHJpYXRlLiBUaGlzIGNhbiBiZQogICAgZG9uZSBieSBjYWxsaW5nIHRoZSByZWNvcmQncyBgdHJhbnNpdGlvblRvKClgIG1ldGhvZCB3aXRoIGEgcGF0aCB0byB0aGUKICAgIGRlc2lyZWQgc3RhdGUuIFRoZSBzdGF0ZSBtYW5hZ2VyIHdpbGwgYXR0ZW1wdCB0byByZXNvbHZlIHRoZSBzdGF0ZSBwYXRoCiAgICByZWxhdGl2ZSB0byB0aGUgY3VycmVudCBzdGF0ZS4gSWYgbm8gc3RhdGUgaXMgZm91bmQgYXQgdGhhdCBwYXRoLCBpdCB3aWxsCiAgICBhdHRlbXB0IHRvIHJlc29sdmUgaXQgcmVsYXRpdmUgdG8gdGhlIGN1cnJlbnQgc3RhdGUncyBwYXJlbnQsIGFuZCB0aGVuIGl0cwogICAgcGFyZW50LCBhbmQgc28gb24gdW50aWwgdGhlIHJvb3QgaXMgcmVhY2hlZC4gRm9yIGV4YW1wbGUsIGltYWdpbmUgYSBoaWVyYXJjaHkKICAgIGxpa2UgdGhpczoKCiAgICAgICAgKiBjcmVhdGVkCiAgICAgICAgICAqIHVuY29tbWl0dGVkIDwtLSBjdXJyZW50U3RhdGUKICAgICAgICAgICogaW5GbGlnaHQKICAgICAgICAqIHVwZGF0ZWQKICAgICAgICAgICogaW5GbGlnaHQKCiAgICBJZiB3ZSBhcmUgY3VycmVudGx5IGluIHRoZSBgdW5jb21taXR0ZWRgIHN0YXRlLCBjYWxsaW5nCiAgICBgdHJhbnNpdGlvblRvKCdpbkZsaWdodCcpYCB3b3VsZCB0cmFuc2l0aW9uIHRvIHRoZSBgY3JlYXRlZC5pbkZsaWdodGAgc3RhdGUsCiAgICB3aGlsZSBjYWxsaW5nIGB0cmFuc2l0aW9uVG8oJ3VwZGF0ZWQuaW5GbGlnaHQnKWAgd291bGQgdHJhbnNpdGlvbiB0bwogICAgdGhlIGB1cGRhdGVkLmluRmxpZ2h0YCBzdGF0ZS4KCiAgICBSZW1lbWJlciB0aGF0ICpvbmx5IGV2ZW50cyogc2hvdWxkIGV2ZXIgY2F1c2UgYSBzdGF0ZSB0cmFuc2l0aW9uLiBZb3Ugc2hvdWxkCiAgICBuZXZlciBjYWxsIGB0cmFuc2l0aW9uVG8oKWAgZnJvbSBvdXRzaWRlIGEgc3RhdGUncyBldmVudCBoYW5kbGVyLiBJZiB5b3UgYXJlCiAgICB0ZW1wdGVkIHRvIGRvIHNvLCBjcmVhdGUgYSBuZXcgZXZlbnQgYW5kIHNlbmQgdGhhdCB0byB0aGUgc3RhdGUgbWFuYWdlci4KCiAgICAjIyMjIEZsYWdzCgogICAgRmxhZ3MgYXJlIEJvb2xlYW4gdmFsdWVzIHRoYXQgY2FuIGJlIHVzZWQgdG8gaW50cm9zcGVjdCBhIHJlY29yZCdzIGN1cnJlbnQKICAgIHN0YXRlIGluIGEgbW9yZSB1c2VyLWZyaWVuZGx5IHdheSB0aGFuIGV4YW1pbmluZyBpdHMgc3RhdGUgcGF0aC4gRm9yIGV4YW1wbGUsCiAgICBpbnN0ZWFkIG9mIGRvaW5nIHRoaXM6CgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIHN0YXRlUGF0aCA9IHJlY29yZC5nZXQoJ3N0YXRlTWFuYWdlci5jdXJyZW50UGF0aCcpOwogICAgaWYgKHN0YXRlUGF0aCA9PT0gJ2NyZWF0ZWQuaW5GbGlnaHQnKSB7CiAgICAgIGRvU29tZXRoaW5nKCk7CiAgICB9CiAgICBgYGAKCiAgICBZb3UgY2FuIHNheToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpZiAocmVjb3JkLmdldCgnaXNOZXcnKSAmJiByZWNvcmQuZ2V0KCdpc1NhdmluZycpKSB7CiAgICAgIGRvU29tZXRoaW5nKCk7CiAgICB9CiAgICBgYGAKCiAgICBJZiB5b3VyIHN0YXRlIGRvZXMgbm90IHNldCBhIHZhbHVlIGZvciBhIGdpdmVuIGZsYWcsIHRoZSB2YWx1ZSB3aWxsCiAgICBiZSBpbmhlcml0ZWQgZnJvbSBpdHMgcGFyZW50IChvciB0aGUgZmlyc3QgcGxhY2UgaW4gdGhlIHN0YXRlIGhpZXJhcmNoeQogICAgd2hlcmUgaXQgaXMgZGVmaW5lZCkuCgogICAgVGhlIGN1cnJlbnQgc2V0IG9mIGZsYWdzIGFyZSBkZWZpbmVkIGJlbG93LiBJZiB5b3Ugd2FudCB0byBhZGQgYSBuZXcgZmxhZywKICAgIGluIGFkZGl0aW9uIHRvIHRoZSBhcmVhIGJlbG93LCB5b3Ugd2lsbCBhbHNvIG5lZWQgdG8gZGVjbGFyZSBpdCBpbiB0aGUKICAgIGBNb2RlbGAgY2xhc3MuCgoKICAgICAqIFtpc0VtcHR5XShNb2RlbC9wcm9wZXJ0aWVzL2lzRW1wdHk/YW5jaG9yPWlzRW1wdHkpCiAgICAgKiBbaXNMb2FkaW5nXShNb2RlbC9wcm9wZXJ0aWVzL2lzTG9hZGluZz9hbmNob3I9aXNMb2FkaW5nKQogICAgICogW2lzTG9hZGVkXShNb2RlbC9wcm9wZXJ0aWVzL2lzTG9hZGVkP2FuY2hvcj1pc0xvYWRlZCkKICAgICAqIFtoYXNEaXJ0eUF0dHJpYnV0ZXNdKE1vZGVsL3Byb3BlcnRpZXMvaGFzRGlydHlBdHRyaWJ1dGVzP2FuY2hvcj1oYXNEaXJ0eUF0dHJpYnV0ZXMpCiAgICAgKiBbaXNTYXZpbmddKE1vZGVsL3Byb3BlcnRpZXMvaXNTYXZpbmc/YW5jaG9yPWlzU2F2aW5nKQogICAgICogW2lzRGVsZXRlZF0oTW9kZWwvcHJvcGVydGllcy9pc0RlbGV0ZWQ/YW5jaG9yPWlzRGVsZXRlZCkKICAgICAqIFtpc05ld10oTW9kZWwvcHJvcGVydGllcy9pc05ldz9hbmNob3I9aXNOZXcpCiAgICAgKiBbaXNWYWxpZF0oTW9kZWwvcHJvcGVydGllcy9pc1ZhbGlkP2FuY2hvcj1pc1ZhbGlkKQoKICAgIEBjbGFzcyBSb290U3RhdGUKICAqLwoKICBmdW5jdGlvbiBfZGlkU2V0UHJvcGVydHkoaW50ZXJuYWxNb2RlbCwgY29udGV4dCkgewogICAgaWYgKGNvbnRleHQuaXNEaXJ0eSkgewogICAgICBpbnRlcm5hbE1vZGVsLnNlbmQoJ2JlY29tZURpcnR5Jyk7CiAgICB9IGVsc2UgewogICAgICBpbnRlcm5hbE1vZGVsLnNlbmQoJ3Byb3BlcnR5V2FzUmVzZXQnKTsKICAgIH0KCiAgICBpbnRlcm5hbE1vZGVsLnVwZGF0ZVJlY29yZEFycmF5cygpOwogIH0gLy8gSW1wbGVtZW50YXRpb24gbm90ZXM6CiAgLy8KICAvLyBFYWNoIHN0YXRlIGhhcyBhIGJvb2xlYW4gdmFsdWUgZm9yIGFsbCBvZiB0aGUgZm9sbG93aW5nIGZsYWdzOgogIC8vCiAgLy8gKiBpc0xvYWRlZDogVGhlIHJlY29yZCBoYXMgYSBwb3B1bGF0ZWQgYGRhdGFgIHByb3BlcnR5LiBXaGVuIGEKICAvLyAgIHJlY29yZCBpcyBsb2FkZWQgdmlhIGBzdG9yZS5maW5kYCwgYGlzTG9hZGVkYCBpcyBmYWxzZQogIC8vICAgdW50aWwgdGhlIGFkYXB0ZXIgc2V0cyBpdC4gV2hlbiBhIHJlY29yZCBpcyBjcmVhdGVkIGxvY2FsbHksCiAgLy8gICBpdHMgYGlzTG9hZGVkYCBwcm9wZXJ0eSBpcyBhbHdheXMgdHJ1ZS4KICAvLyAqIGlzRGlydHk6IFRoZSByZWNvcmQgaGFzIGxvY2FsIGNoYW5nZXMgdGhhdCBoYXZlIG5vdCB5ZXQgYmVlbgogIC8vICAgc2F2ZWQgYnkgdGhlIGFkYXB0ZXIuIFRoaXMgaW5jbHVkZXMgcmVjb3JkcyB0aGF0IGhhdmUgYmVlbgogIC8vICAgY3JlYXRlZCAoYnV0IG5vdCB5ZXQgc2F2ZWQpIG9yIGRlbGV0ZWQuCiAgLy8gKiBpc1NhdmluZzogVGhlIHJlY29yZCBoYXMgYmVlbiBjb21taXR0ZWQsIGJ1dAogIC8vICAgdGhlIGFkYXB0ZXIgaGFzIG5vdCB5ZXQgYWNrbm93bGVkZ2VkIHRoYXQgdGhlIGNoYW5nZXMgaGF2ZQogIC8vICAgYmVlbiBwZXJzaXN0ZWQgdG8gdGhlIGJhY2tlbmQuCiAgLy8gKiBpc0RlbGV0ZWQ6IFRoZSByZWNvcmQgd2FzIG1hcmtlZCBmb3IgZGVsZXRpb24uIFdoZW4gYGlzRGVsZXRlZGAKICAvLyAgIGlzIHRydWUgYW5kIGBpc0RpcnR5YCBpcyB0cnVlLCB0aGUgcmVjb3JkIGlzIGRlbGV0ZWQgbG9jYWxseQogIC8vICAgYnV0IHRoZSBkZWxldGlvbiB3YXMgbm90IHlldCBwZXJzaXN0ZWQuIFdoZW4gYGlzU2F2aW5nYCBpcwogIC8vICAgdHJ1ZSwgdGhlIGNoYW5nZSBpcyBpbi1mbGlnaHQuIFdoZW4gYm90aCBgaXNEaXJ0eWAgYW5kCiAgLy8gICBgaXNTYXZpbmdgIGFyZSBmYWxzZSwgdGhlIGNoYW5nZSBoYXMgcGVyc2lzdGVkLgogIC8vICogaXNOZXc6IFRoZSByZWNvcmQgd2FzIGNyZWF0ZWQgb24gdGhlIGNsaWVudCBhbmQgdGhlIGFkYXB0ZXIKICAvLyAgIGRpZCBub3QgeWV0IHJlcG9ydCB0aGF0IGl0IHdhcyBzdWNjZXNzZnVsbHkgc2F2ZWQuCiAgLy8gKiBpc1ZhbGlkOiBUaGUgYWRhcHRlciBkaWQgbm90IHJlcG9ydCBhbnkgc2VydmVyLXNpZGUgdmFsaWRhdGlvbgogIC8vICAgZmFpbHVyZXMuCiAgLy8gVGhlIGRpcnR5IHN0YXRlIGlzIGEgYWJzdHJhY3Qgc3RhdGUgd2hvc2UgZnVuY3Rpb25hbGl0eSBpcwogIC8vIHNoYXJlZCBiZXR3ZWVuIHRoZSBgY3JlYXRlZGAgYW5kIGB1cGRhdGVkYCBzdGF0ZXMuCiAgLy8KICAvLyBUaGUgZGVsZXRlZCBzdGF0ZSBzaGFyZXMgdGhlIGBpc0RpcnR5YCBmbGFnIHdpdGggdGhlCiAgLy8gc3ViY2xhc3NlcyBvZiBgRGlydHlTdGF0ZWAsIGJ1dCB3aXRoIGEgdmVyeSBkaWZmZXJlbnQKICAvLyBpbXBsZW1lbnRhdGlvbi4KICAvLwogIC8vIERpcnR5IHN0YXRlcyBoYXZlIHRocmVlIGNoaWxkIHN0YXRlczoKICAvLwogIC8vIGB1bmNvbW1pdHRlZGA6IHRoZSBzdG9yZSBoYXMgbm90IHlldCBoYW5kZWQgb2ZmIHRoZSByZWNvcmQKICAvLyAgIHRvIGJlIHNhdmVkLgogIC8vIGBpbkZsaWdodGA6IHRoZSBzdG9yZSBoYXMgaGFuZGVkIG9mZiB0aGUgcmVjb3JkIHRvIGJlIHNhdmVkLAogIC8vICAgYnV0IHRoZSBhZGFwdGVyIGhhcyBub3QgeWV0IGFja25vd2xlZGdlZCBzdWNjZXNzLgogIC8vIGBpbnZhbGlkYDogdGhlIHJlY29yZCBoYXMgaW52YWxpZCBpbmZvcm1hdGlvbiBhbmQgY2Fubm90IGJlCiAgLy8gICBzZW50IHRvIHRoZSBhZGFwdGVyIHlldC4KCgogIHZhciBEaXJ0eVN0YXRlID0gewogICAgaW5pdGlhbFN0YXRlOiAndW5jb21taXR0ZWQnLAogICAgLy8gRkxBR1MKICAgIGlzRGlydHk6IHRydWUsCiAgICAvLyBTVUJTVEFURVMKICAgIC8vIFdoZW4gYSByZWNvcmQgZmlyc3QgYmVjb21lcyBkaXJ0eSwgaXQgaXMgYHVuY29tbWl0dGVkYC4KICAgIC8vIFRoaXMgbWVhbnMgdGhhdCB0aGVyZSBhcmUgbG9jYWwgcGVuZGluZyBjaGFuZ2VzLCBidXQgdGhleQogICAgLy8gaGF2ZSBub3QgeWV0IGJlZ3VuIHRvIGJlIHNhdmVkLCBhbmQgYXJlIG5vdCBpbnZhbGlkLgogICAgdW5jb21taXR0ZWQ6IHsKICAgICAgLy8gRVZFTlRTCiAgICAgIGRpZFNldFByb3BlcnR5OiBfZGlkU2V0UHJvcGVydHksCiAgICAgIC8vVE9ETyhJZ29yKSByZWxvYWRpbmcgbm93IHRyaWdnZXJzIGEKICAgICAgLy9sb2FkaW5nRGF0YSBldmVudCwgdGhvdWdoIGl0IHNlZW1zIGZpbmU/CiAgICAgIGxvYWRpbmdEYXRhOiBmdW5jdGlvbiBsb2FkaW5nRGF0YSgpIHt9LAogICAgICBwcm9wZXJ0eVdhc1Jlc2V0OiBmdW5jdGlvbiBwcm9wZXJ0eVdhc1Jlc2V0KGludGVybmFsTW9kZWwsIG5hbWUpIHsKICAgICAgICBpZiAoIWludGVybmFsTW9kZWwuaGFzQ2hhbmdlZEF0dHJpYnV0ZXMoKSkgewogICAgICAgICAgaW50ZXJuYWxNb2RlbC5zZW5kKCdyb2xsZWRCYWNrJyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwdXNoZWREYXRhOiBmdW5jdGlvbiBwdXNoZWREYXRhKGludGVybmFsTW9kZWwpIHsKICAgICAgICBpZiAoIWludGVybmFsTW9kZWwuaGFzQ2hhbmdlZEF0dHJpYnV0ZXMoKSkgewogICAgICAgICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2xvYWRlZC5zYXZlZCcpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYmVjb21lRGlydHk6IGZ1bmN0aW9uIGJlY29tZURpcnR5KCkge30sCiAgICAgIHdpbGxDb21taXQ6IGZ1bmN0aW9uIHdpbGxDb21taXQoaW50ZXJuYWxNb2RlbCkgewogICAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdpbkZsaWdodCcpOwogICAgICB9LAogICAgICByZWxvYWRSZWNvcmQ6IGZ1bmN0aW9uIHJlbG9hZFJlY29yZChpbnRlcm5hbE1vZGVsLCBfcmVmKSB7CiAgICAgICAgdmFyIHJlc29sdmUgPSBfcmVmLnJlc29sdmUsCiAgICAgICAgICAgIG9wdGlvbnMgPSBfcmVmLm9wdGlvbnM7CiAgICAgICAgcmVzb2x2ZShpbnRlcm5hbE1vZGVsLnN0b3JlLl9yZWxvYWRSZWNvcmQoaW50ZXJuYWxNb2RlbCwgb3B0aW9ucykpOwogICAgICB9LAogICAgICByb2xsZWRCYWNrOiBmdW5jdGlvbiByb2xsZWRCYWNrKGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnbG9hZGVkLnNhdmVkJyk7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ3JvbGxlZEJhY2snKTsKICAgICAgfSwKICAgICAgYmVjYW1lSW52YWxpZDogZnVuY3Rpb24gYmVjYW1lSW52YWxpZChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2ludmFsaWQnKTsKICAgICAgfSwKICAgICAgcm9sbGJhY2s6IGZ1bmN0aW9uIHJvbGxiYWNrKGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLnJvbGxiYWNrQXR0cmlidXRlcygpOwogICAgICAgIGludGVybmFsTW9kZWwudHJpZ2dlckxhdGVyKCdyZWFkeScpOwogICAgICB9CiAgICB9LAogICAgLy8gT25jZSBhIHJlY29yZCBoYXMgYmVlbiBoYW5kZWQgb2ZmIHRvIHRoZSBhZGFwdGVyIHRvIGJlCiAgICAvLyBzYXZlZCwgaXQgaXMgaW4gdGhlICdpbiBmbGlnaHQnIHN0YXRlLiBDaGFuZ2VzIHRvIHRoZQogICAgLy8gcmVjb3JkIGNhbm5vdCBiZSBtYWRlIGR1cmluZyB0aGlzIHdpbmRvdy4KICAgIGluRmxpZ2h0OiB7CiAgICAgIC8vIEZMQUdTCiAgICAgIGlzU2F2aW5nOiB0cnVlLAogICAgICAvLyBFVkVOVFMKICAgICAgZGlkU2V0UHJvcGVydHk6IF9kaWRTZXRQcm9wZXJ0eSwKICAgICAgYmVjb21lRGlydHk6IGZ1bmN0aW9uIGJlY29tZURpcnR5KCkge30sCiAgICAgIHB1c2hlZERhdGE6IGZ1bmN0aW9uIHB1c2hlZERhdGEoKSB7fSwKICAgICAgdW5sb2FkUmVjb3JkOiBhc3NlcnRBZ2FpbnN0VW5sb2FkUmVjb3JkLAogICAgICAvLyBUT0RPOiBNb3JlIHJvYnVzdCBzZW1hbnRpY3MgYXJvdW5kIHNhdmUtd2hpbGUtaW4tZmxpZ2h0CiAgICAgIHdpbGxDb21taXQ6IGZ1bmN0aW9uIHdpbGxDb21taXQoKSB7fSwKICAgICAgZGlkQ29tbWl0OiBmdW5jdGlvbiBkaWRDb21taXQoaW50ZXJuYWxNb2RlbCkgewogICAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdzYXZlZCcpOwogICAgICAgIGludGVybmFsTW9kZWwuc2VuZCgnaW52b2tlTGlmZWN5Y2xlQ2FsbGJhY2tzJywgdGhpcy5kaXJ0eVR5cGUpOwogICAgICB9LAogICAgICByb2xsZWRCYWNrOiBmdW5jdGlvbiByb2xsZWRCYWNrKGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcigncm9sbGVkQmFjaycpOwogICAgICB9LAogICAgICBiZWNhbWVJbnZhbGlkOiBmdW5jdGlvbiBiZWNhbWVJbnZhbGlkKGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnaW52YWxpZCcpOwogICAgICAgIGludGVybmFsTW9kZWwuc2VuZCgnaW52b2tlTGlmZWN5Y2xlQ2FsbGJhY2tzJyk7CiAgICAgIH0sCiAgICAgIGJlY2FtZUVycm9yOiBmdW5jdGlvbiBiZWNhbWVFcnJvcihpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ3VuY29tbWl0dGVkJyk7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ2JlY2FtZUVycm9yJywgaW50ZXJuYWxNb2RlbCk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBBIHJlY29yZCBpcyBpbiB0aGUgYGludmFsaWRgIGlmIHRoZSBhZGFwdGVyIGhhcyBpbmRpY2F0ZWQKICAgIC8vIHRoZSB0aGUgcmVjb3JkIGZhaWxlZCBzZXJ2ZXItc2lkZSBpbnZhbGlkYXRpb25zLgogICAgaW52YWxpZDogewogICAgICAvLyBGTEFHUwogICAgICBpc1ZhbGlkOiBmYWxzZSwKICAgICAgLy8gRVZFTlRTCiAgICAgIGRlbGV0ZVJlY29yZDogZnVuY3Rpb24gZGVsZXRlUmVjb3JkKGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnZGVsZXRlZC51bmNvbW1pdHRlZCcpOwogICAgICB9LAogICAgICBkaWRTZXRQcm9wZXJ0eTogZnVuY3Rpb24gZGlkU2V0UHJvcGVydHkoaW50ZXJuYWxNb2RlbCwgY29udGV4dCkgewogICAgICAgIGludGVybmFsTW9kZWwucmVtb3ZlRXJyb3JNZXNzYWdlRnJvbUF0dHJpYnV0ZShjb250ZXh0Lm5hbWUpOwoKICAgICAgICBfZGlkU2V0UHJvcGVydHkoaW50ZXJuYWxNb2RlbCwgY29udGV4dCk7CgogICAgICAgIGlmICghaW50ZXJuYWxNb2RlbC5oYXNFcnJvcnMoKSkgewogICAgICAgICAgdGhpcy5iZWNhbWVWYWxpZChpbnRlcm5hbE1vZGVsKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGJlY2FtZUludmFsaWQ6IGZ1bmN0aW9uIGJlY2FtZUludmFsaWQoKSB7fSwKICAgICAgYmVjb21lRGlydHk6IGZ1bmN0aW9uIGJlY29tZURpcnR5KCkge30sCiAgICAgIHB1c2hlZERhdGE6IGZ1bmN0aW9uIHB1c2hlZERhdGEoKSB7fSwKICAgICAgd2lsbENvbW1pdDogZnVuY3Rpb24gd2lsbENvbW1pdChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC5jbGVhckVycm9yTWVzc2FnZXMoKTsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnaW5GbGlnaHQnKTsKICAgICAgfSwKICAgICAgcm9sbGVkQmFjazogZnVuY3Rpb24gcm9sbGVkQmFjayhpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC5jbGVhckVycm9yTWVzc2FnZXMoKTsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnbG9hZGVkLnNhdmVkJyk7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ3JlYWR5Jyk7CiAgICAgIH0sCiAgICAgIGJlY2FtZVZhbGlkOiBmdW5jdGlvbiBiZWNhbWVWYWxpZChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ3VuY29tbWl0dGVkJyk7CiAgICAgIH0sCiAgICAgIGludm9rZUxpZmVjeWNsZUNhbGxiYWNrczogZnVuY3Rpb24gaW52b2tlTGlmZWN5Y2xlQ2FsbGJhY2tzKGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcignYmVjYW1lSW52YWxpZCcsIGludGVybmFsTW9kZWwpOwogICAgICB9CiAgICB9CiAgfTsgLy8gVGhlIGNyZWF0ZWQgYW5kIHVwZGF0ZWQgc3RhdGVzIGFyZSBjcmVhdGVkIG91dHNpZGUgdGhlIHN0YXRlCiAgLy8gY2hhcnQgc28gd2UgY2FuIHJlb3BlbiB0aGVpciBzdWJzdGF0ZXMgYW5kIGFkZCBtaXhpbnMgYXMKICAvLyBuZWNlc3NhcnkuCgogIGZ1bmN0aW9uIGRlZXBDbG9uZShvYmplY3QpIHsKICAgIHZhciBjbG9uZSA9IHt9OwogICAgdmFyIHZhbHVlOwoKICAgIGZvciAodmFyIHByb3AgaW4gb2JqZWN0KSB7CiAgICAgIHZhbHVlID0gb2JqZWN0W3Byb3BdOwoKICAgICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBjbG9uZVtwcm9wXSA9IGRlZXBDbG9uZSh2YWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2xvbmVbcHJvcF0gPSB2YWx1ZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBjbG9uZTsKICB9CgogIGZ1bmN0aW9uIG1peGluKG9yaWdpbmFsLCBoYXNoKSB7CiAgICBmb3IgKHZhciBwcm9wIGluIGhhc2gpIHsKICAgICAgb3JpZ2luYWxbcHJvcF0gPSBoYXNoW3Byb3BdOwogICAgfQoKICAgIHJldHVybiBvcmlnaW5hbDsKICB9CgogIGZ1bmN0aW9uIGRpcnR5U3RhdGUob3B0aW9ucykgewogICAgdmFyIG5ld1N0YXRlID0gZGVlcENsb25lKERpcnR5U3RhdGUpOwogICAgcmV0dXJuIG1peGluKG5ld1N0YXRlLCBvcHRpb25zKTsKICB9CgogIHZhciBjcmVhdGVkU3RhdGUgPSBkaXJ0eVN0YXRlKHsKICAgIGRpcnR5VHlwZTogJ2NyZWF0ZWQnLAogICAgLy8gRkxBR1MKICAgIGlzTmV3OiB0cnVlCiAgfSk7CgogIGNyZWF0ZWRTdGF0ZS5pbnZhbGlkLnJvbGxlZEJhY2sgPSBmdW5jdGlvbiAoaW50ZXJuYWxNb2RlbCkgewogICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2RlbGV0ZWQuc2F2ZWQnKTsKICAgIGludGVybmFsTW9kZWwudHJpZ2dlckxhdGVyKCdyb2xsZWRCYWNrJyk7CiAgfTsKCiAgY3JlYXRlZFN0YXRlLnVuY29tbWl0dGVkLnJvbGxlZEJhY2sgPSBmdW5jdGlvbiAoaW50ZXJuYWxNb2RlbCkgewogICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2RlbGV0ZWQuc2F2ZWQnKTsKICAgIGludGVybmFsTW9kZWwudHJpZ2dlckxhdGVyKCdyb2xsZWRCYWNrJyk7CiAgfTsKCiAgdmFyIHVwZGF0ZWRTdGF0ZSA9IGRpcnR5U3RhdGUoewogICAgZGlydHlUeXBlOiAndXBkYXRlZCcKICB9KTsKCiAgZnVuY3Rpb24gY3JlYXRlZFN0YXRlRGVsZXRlUmVjb3JkKGludGVybmFsTW9kZWwpIHsKICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdkZWxldGVkLnNhdmVkJyk7CiAgICBpbnRlcm5hbE1vZGVsLnNlbmQoJ2ludm9rZUxpZmVjeWNsZUNhbGxiYWNrcycpOwogIH0KCiAgY3JlYXRlZFN0YXRlLnVuY29tbWl0dGVkLmRlbGV0ZVJlY29yZCA9IGNyZWF0ZWRTdGF0ZURlbGV0ZVJlY29yZDsKICBjcmVhdGVkU3RhdGUuaW52YWxpZC5kZWxldGVSZWNvcmQgPSBjcmVhdGVkU3RhdGVEZWxldGVSZWNvcmQ7CgogIGNyZWF0ZWRTdGF0ZS51bmNvbW1pdHRlZC5yb2xsYmFjayA9IGZ1bmN0aW9uIChpbnRlcm5hbE1vZGVsKSB7CiAgICBEaXJ0eVN0YXRlLnVuY29tbWl0dGVkLnJvbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnZGVsZXRlZC5zYXZlZCcpOwogIH07CgogIGNyZWF0ZWRTdGF0ZS51bmNvbW1pdHRlZC5wdXNoZWREYXRhID0gZnVuY3Rpb24gKGludGVybmFsTW9kZWwpIHsKICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdsb2FkZWQudXBkYXRlZC51bmNvbW1pdHRlZCcpOwogICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ2RpZExvYWQnKTsKICB9OwoKICBjcmVhdGVkU3RhdGUudW5jb21taXR0ZWQucHJvcGVydHlXYXNSZXNldCA9IGZ1bmN0aW9uICgpIHt9OwoKICBmdW5jdGlvbiBhc3NlcnRBZ2FpbnN0VW5sb2FkUmVjb3JkKGludGVybmFsTW9kZWwpIHsKICB9CgogIHVwZGF0ZWRTdGF0ZS5pbnZhbGlkLmJlY2FtZVZhbGlkID0gZnVuY3Rpb24gKGludGVybmFsTW9kZWwpIHsKICAgIC8vIHdlJ3JlIGVhZ2VybHkgdHJhbnNpdGlvbiBpbnRvIHRoZSBsb2FkZWQuc2F2ZWQgc3RhdGUsIGV2ZW4gdGhvdWdoIHdlIGNvdWxkCiAgICAvLyBiZSBzdGlsbCBkaXJ0eTsgYnV0IHRoZSBzZXR1cCBob29rIG9mIHRoZSBsb2FkZWQuc2F2ZWQgc3RhdGUgY2hlY2tzIGZvcgogICAgLy8gZGlydHkgYXR0cmlidXRlcyBhbmQgdHJhbnNpdGlvbnMgaW50byB0aGUgY29ycmVzcG9uZGluZyBkaXJ0eSBzdGF0ZQogICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2xvYWRlZC5zYXZlZCcpOwogIH07CgogIHVwZGF0ZWRTdGF0ZS5pbkZsaWdodC51bmxvYWRSZWNvcmQgPSBhc3NlcnRBZ2FpbnN0VW5sb2FkUmVjb3JkOwoKICB1cGRhdGVkU3RhdGUudW5jb21taXR0ZWQuZGVsZXRlUmVjb3JkID0gZnVuY3Rpb24gKGludGVybmFsTW9kZWwpIHsKICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdkZWxldGVkLnVuY29tbWl0dGVkJyk7CiAgfTsKCiAgdXBkYXRlZFN0YXRlLmludmFsaWQucm9sbGVkQmFjayA9IGZ1bmN0aW9uIChpbnRlcm5hbE1vZGVsKSB7CiAgICBpbnRlcm5hbE1vZGVsLmNsZWFyRXJyb3JNZXNzYWdlcygpOwogICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2xvYWRlZC5zYXZlZCcpOwogICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ3JvbGxlZEJhY2snKTsKICB9OwoKICB2YXIgUm9vdFN0YXRlID0gewogICAgLy8gRkxBR1MKICAgIGlzRW1wdHk6IGZhbHNlLAogICAgaXNMb2FkaW5nOiBmYWxzZSwKICAgIGlzTG9hZGVkOiBmYWxzZSwKICAgIGlzRGlydHk6IGZhbHNlLAogICAgaXNTYXZpbmc6IGZhbHNlLAogICAgaXNEZWxldGVkOiBmYWxzZSwKICAgIGlzTmV3OiBmYWxzZSwKICAgIGlzVmFsaWQ6IHRydWUsCiAgICAvLyBERUZBVUxUIEVWRU5UUwogICAgLy8gVHJ5aW5nIHRvIHJvbGwgYmFjayBpZiB5b3UncmUgbm90IGluIHRoZSBkaXJ0eSBzdGF0ZQogICAgLy8gZG9lc24ndCBjaGFuZ2UgeW91ciBzdGF0ZS4gRm9yIGV4YW1wbGUsIGlmIHlvdSdyZSBpbiB0aGUKICAgIC8vIGluLWZsaWdodCBzdGF0ZSwgcm9sbGluZyBiYWNrIHRoZSByZWNvcmQgZG9lc24ndCBtb3ZlCiAgICAvLyB5b3Ugb3V0IG9mIHRoZSBpbi1mbGlnaHQgc3RhdGUuCiAgICByb2xsZWRCYWNrOiBmdW5jdGlvbiByb2xsZWRCYWNrKCkge30sCiAgICB1bmxvYWRSZWNvcmQ6IGZ1bmN0aW9uIHVubG9hZFJlY29yZChpbnRlcm5hbE1vZGVsKSB7fSwKICAgIHByb3BlcnR5V2FzUmVzZXQ6IGZ1bmN0aW9uIHByb3BlcnR5V2FzUmVzZXQoKSB7fSwKICAgIC8vIFNVQlNUQVRFUwogICAgLy8gQSByZWNvcmQgYmVnaW5zIGl0cyBsaWZlY3ljbGUgaW4gdGhlIGBlbXB0eWAgc3RhdGUuCiAgICAvLyBJZiBpdHMgZGF0YSB3aWxsIGNvbWUgZnJvbSB0aGUgYWRhcHRlciwgaXQgd2lsbAogICAgLy8gdHJhbnNpdGlvbiBpbnRvIHRoZSBgbG9hZGluZ2Agc3RhdGUuIE90aGVyd2lzZSwgaWYKICAgIC8vIHRoZSByZWNvcmQgaXMgYmVpbmcgY3JlYXRlZCBvbiB0aGUgY2xpZW50LCBpdCB3aWxsCiAgICAvLyB0cmFuc2l0aW9uIGludG8gdGhlIGBjcmVhdGVkYCBzdGF0ZS4KICAgIGVtcHR5OiB7CiAgICAgIGlzRW1wdHk6IHRydWUsCiAgICAgIC8vIEVWRU5UUwogICAgICBsb2FkaW5nRGF0YTogZnVuY3Rpb24gbG9hZGluZ0RhdGEoaW50ZXJuYWxNb2RlbCwgcHJvbWlzZSkgewogICAgICAgIGlmICghY2FuYXJ5RmVhdHVyZXMuUkVRVUVTVF9TRVJWSUNFKSB7CiAgICAgICAgICBpbnRlcm5hbE1vZGVsLl9wcm9taXNlUHJveHkgPSBwcm9taXNlOwogICAgICAgIH0KCiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2xvYWRpbmcnKTsKICAgICAgfSwKICAgICAgbG9hZGVkRGF0YTogZnVuY3Rpb24gbG9hZGVkRGF0YShpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2xvYWRlZC5jcmVhdGVkLnVuY29tbWl0dGVkJyk7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ3JlYWR5Jyk7CiAgICAgIH0sCiAgICAgIHB1c2hlZERhdGE6IGZ1bmN0aW9uIHB1c2hlZERhdGEoaW50ZXJuYWxNb2RlbCkgewogICAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdsb2FkZWQuc2F2ZWQnKTsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcignZGlkTG9hZCcpOwogICAgICAgIGludGVybmFsTW9kZWwudHJpZ2dlckxhdGVyKCdyZWFkeScpOwogICAgICB9LAogICAgICAvLyBSZWNvcmQgaXMgYWxyZWFkeSBpbiBhbiBlbXB0eSBzdGF0ZSwgdHJpZ2dlcmluZyB0cmFuc2l0aW9uIHRvIGVtcHR5IGhlcmUKICAgICAgLy8gcHJvZHVjZSBhbiBlcnJvci4KICAgICAgbm90Rm91bmQ6IGZ1bmN0aW9uIG5vdEZvdW5kKCkge30KICAgIH0sCiAgICAvLyBBIHJlY29yZCBlbnRlcnMgdGhpcyBzdGF0ZSB3aGVuIHRoZSBzdG9yZSBhc2tzCiAgICAvLyB0aGUgYWRhcHRlciBmb3IgaXRzIGRhdGEuIEl0IHJlbWFpbnMgaW4gdGhpcyBzdGF0ZQogICAgLy8gdW50aWwgdGhlIGFkYXB0ZXIgcHJvdmlkZXMgdGhlIHJlcXVlc3RlZCBkYXRhLgogICAgLy8KICAgIC8vIFVzdWFsbHksIHRoaXMgcHJvY2VzcyBpcyBhc3luY2hyb25vdXMsIHVzaW5nIGFuCiAgICAvLyBYSFIgdG8gcmV0cmlldmUgdGhlIGRhdGEuCiAgICBsb2FkaW5nOiB7CiAgICAgIC8vIEZMQUdTCiAgICAgIGlzTG9hZGluZzogdHJ1ZSwKICAgICAgZXhpdDogZnVuY3Rpb24gZXhpdChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC5fcHJvbWlzZVByb3h5ID0gbnVsbDsKICAgICAgfSwKICAgICAgbG9hZGluZ0RhdGE6IGZ1bmN0aW9uIGxvYWRpbmdEYXRhKCkge30sCiAgICAgIC8vIEVWRU5UUwogICAgICBwdXNoZWREYXRhOiBmdW5jdGlvbiBwdXNoZWREYXRhKGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnbG9hZGVkLnNhdmVkJyk7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ2RpZExvYWQnKTsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcigncmVhZHknKTsgLy9UT0RPIHRoaXMgc2VlbXMgb3V0IG9mIHBsYWNlIGhlcmUKCiAgICAgICAgaW50ZXJuYWxNb2RlbC5kaWRDbGVhbkVycm9yKCk7CiAgICAgIH0sCiAgICAgIGJlY2FtZUVycm9yOiBmdW5jdGlvbiBiZWNhbWVFcnJvcihpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ2JlY2FtZUVycm9yJywgaW50ZXJuYWxNb2RlbCk7CiAgICAgIH0sCiAgICAgIG5vdEZvdW5kOiBmdW5jdGlvbiBub3RGb3VuZChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2VtcHR5Jyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBBIHJlY29yZCBlbnRlcnMgdGhpcyBzdGF0ZSB3aGVuIGl0cyBkYXRhIGlzIHBvcHVsYXRlZC4KICAgIC8vIE1vc3Qgb2YgYSByZWNvcmQncyBsaWZlY3ljbGUgaXMgc3BlbnQgaW5zaWRlIHN1YnN0YXRlcwogICAgLy8gb2YgdGhlIGBsb2FkZWRgIHN0YXRlLgogICAgbG9hZGVkOiB7CiAgICAgIGluaXRpYWxTdGF0ZTogJ3NhdmVkJywKICAgICAgLy8gRkxBR1MKICAgICAgaXNMb2FkZWQ6IHRydWUsCiAgICAgIC8vVE9ETyhJZ29yKSBSZWxvYWRpbmcgbm93IHRyaWdnZXJzIGEgbG9hZGluZ0RhdGEgZXZlbnQsCiAgICAgIC8vYnV0IGl0IHNob3VsZCBiZSBvaz8KICAgICAgbG9hZGluZ0RhdGE6IGZ1bmN0aW9uIGxvYWRpbmdEYXRhKCkge30sCiAgICAgIC8vIFNVQlNUQVRFUwogICAgICAvLyBJZiB0aGVyZSBhcmUgbm8gbG9jYWwgY2hhbmdlcyB0byBhIHJlY29yZCwgaXQgcmVtYWlucwogICAgICAvLyBpbiB0aGUgYHNhdmVkYCBzdGF0ZS4KICAgICAgc2F2ZWQ6IHsKICAgICAgICBzZXR1cDogZnVuY3Rpb24gc2V0dXAoaW50ZXJuYWxNb2RlbCkgewogICAgICAgICAgaWYgKGludGVybmFsTW9kZWwuaGFzQ2hhbmdlZEF0dHJpYnV0ZXMoKSkgewogICAgICAgICAgICBpbnRlcm5hbE1vZGVsLmFkYXB0ZXJEaWREaXJ0eSgpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLy8gRVZFTlRTCiAgICAgICAgZGlkU2V0UHJvcGVydHk6IF9kaWRTZXRQcm9wZXJ0eSwKICAgICAgICBwdXNoZWREYXRhOiBmdW5jdGlvbiBwdXNoZWREYXRhKCkge30sCiAgICAgICAgYmVjb21lRGlydHk6IGZ1bmN0aW9uIGJlY29tZURpcnR5KGludGVybmFsTW9kZWwpIHsKICAgICAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCd1cGRhdGVkLnVuY29tbWl0dGVkJyk7CiAgICAgICAgfSwKICAgICAgICB3aWxsQ29tbWl0OiBmdW5jdGlvbiB3aWxsQ29tbWl0KGludGVybmFsTW9kZWwpIHsKICAgICAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCd1cGRhdGVkLmluRmxpZ2h0Jyk7CiAgICAgICAgfSwKICAgICAgICByZWxvYWRSZWNvcmQ6IGZ1bmN0aW9uIHJlbG9hZFJlY29yZChpbnRlcm5hbE1vZGVsLCBfcmVmMikgewogICAgICAgICAgdmFyIHJlc29sdmUgPSBfcmVmMi5yZXNvbHZlLAogICAgICAgICAgICAgIG9wdGlvbnMgPSBfcmVmMi5vcHRpb25zOwoKICAgICAgICAgIGlmICghY2FuYXJ5RmVhdHVyZXMuUkVRVUVTVF9TRVJWSUNFKSB7CiAgICAgICAgICAgIHJlc29sdmUoaW50ZXJuYWxNb2RlbC5zdG9yZS5fcmVsb2FkUmVjb3JkKGludGVybmFsTW9kZWwsIG9wdGlvbnMpKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGRlbGV0ZVJlY29yZDogZnVuY3Rpb24gZGVsZXRlUmVjb3JkKGludGVybmFsTW9kZWwpIHsKICAgICAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdkZWxldGVkLnVuY29tbWl0dGVkJyk7CiAgICAgICAgfSwKICAgICAgICB1bmxvYWRSZWNvcmQ6IGZ1bmN0aW9uIHVubG9hZFJlY29yZChpbnRlcm5hbE1vZGVsKSB7fSwKICAgICAgICBkaWRDb21taXQ6IGZ1bmN0aW9uIGRpZENvbW1pdCgpIHt9LAogICAgICAgIC8vIGxvYWRlZC5zYXZlZC5ub3RGb3VuZCB3b3VsZCBiZSB0cmlnZ2VyZWQgYnkgYSBmYWlsZWQKICAgICAgICAvLyBgcmVsb2FkKClgIG9uIGFuIHVuY2hhbmdlZCByZWNvcmQKICAgICAgICBub3RGb3VuZDogZnVuY3Rpb24gbm90Rm91bmQoKSB7fQogICAgICB9LAogICAgICAvLyBBIHJlY29yZCBpcyBpbiB0aGlzIHN0YXRlIGFmdGVyIGl0IGhhcyBiZWVuIGxvY2FsbHkKICAgICAgLy8gY3JlYXRlZCBidXQgYmVmb3JlIHRoZSBhZGFwdGVyIGhhcyBpbmRpY2F0ZWQgdGhhdAogICAgICAvLyBpdCBoYXMgYmVlbiBzYXZlZC4KICAgICAgY3JlYXRlZDogY3JlYXRlZFN0YXRlLAogICAgICAvLyBBIHJlY29yZCBpcyBpbiB0aGlzIHN0YXRlIGlmIGl0IGhhcyBhbHJlYWR5IGJlZW4KICAgICAgLy8gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYnV0IHRoZXJlIGFyZSBuZXcgbG9jYWwgY2hhbmdlcwogICAgICAvLyB0aGF0IGhhdmUgbm90IHlldCBiZWVuIHNhdmVkLgogICAgICB1cGRhdGVkOiB1cGRhdGVkU3RhdGUKICAgIH0sCiAgICAvLyBBIHJlY29yZCBpcyBpbiB0aGlzIHN0YXRlIGlmIGl0IHdhcyBkZWxldGVkIGZyb20gdGhlIHN0b3JlLgogICAgZGVsZXRlZDogewogICAgICBpbml0aWFsU3RhdGU6ICd1bmNvbW1pdHRlZCcsCiAgICAgIGRpcnR5VHlwZTogJ2RlbGV0ZWQnLAogICAgICAvLyBGTEFHUwogICAgICBpc0RlbGV0ZWQ6IHRydWUsCiAgICAgIGlzTG9hZGVkOiB0cnVlLAogICAgICBpc0RpcnR5OiB0cnVlLAogICAgICAvLyBUUkFOU0lUSU9OUwogICAgICBzZXR1cDogZnVuY3Rpb24gc2V0dXAoaW50ZXJuYWxNb2RlbCkgewogICAgICAgIGludGVybmFsTW9kZWwudXBkYXRlUmVjb3JkQXJyYXlzKCk7CiAgICAgIH0sCiAgICAgIC8vIFNVQlNUQVRFUwogICAgICAvLyBXaGVuIGEgcmVjb3JkIGlzIGRlbGV0ZWQsIGl0IGVudGVycyB0aGUgYHN0YXJ0YAogICAgICAvLyBzdGF0ZS4gSXQgd2lsbCBleGl0IHRoaXMgc3RhdGUgd2hlbiB0aGUgcmVjb3JkCiAgICAgIC8vIHN0YXJ0cyB0byBjb21taXQuCiAgICAgIHVuY29tbWl0dGVkOiB7CiAgICAgICAgLy8gRVZFTlRTCiAgICAgICAgd2lsbENvbW1pdDogZnVuY3Rpb24gd2lsbENvbW1pdChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnaW5GbGlnaHQnKTsKICAgICAgICB9LAogICAgICAgIHJvbGxiYWNrOiBmdW5jdGlvbiByb2xsYmFjayhpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgICBpbnRlcm5hbE1vZGVsLnJvbGxiYWNrQXR0cmlidXRlcygpOwogICAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ3JlYWR5Jyk7CiAgICAgICAgfSwKICAgICAgICBwdXNoZWREYXRhOiBmdW5jdGlvbiBwdXNoZWREYXRhKCkge30sCiAgICAgICAgYmVjb21lRGlydHk6IGZ1bmN0aW9uIGJlY29tZURpcnR5KCkge30sCiAgICAgICAgZGVsZXRlUmVjb3JkOiBmdW5jdGlvbiBkZWxldGVSZWNvcmQoKSB7fSwKICAgICAgICByb2xsZWRCYWNrOiBmdW5jdGlvbiByb2xsZWRCYWNrKGludGVybmFsTW9kZWwpIHsKICAgICAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdsb2FkZWQuc2F2ZWQnKTsKICAgICAgICAgIGludGVybmFsTW9kZWwudHJpZ2dlckxhdGVyKCdyZWFkeScpOwogICAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ3JvbGxlZEJhY2snKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIC8vIEFmdGVyIGEgcmVjb3JkIHN0YXJ0cyBjb21taXR0aW5nLCBidXQKICAgICAgLy8gYmVmb3JlIHRoZSBhZGFwdGVyIGluZGljYXRlcyB0aGF0IHRoZSBkZWxldGlvbgogICAgICAvLyBoYXMgc2F2ZWQgdG8gdGhlIHNlcnZlciwgYSByZWNvcmQgaXMgaW4gdGhlCiAgICAgIC8vIGBpbkZsaWdodGAgc3Vic3RhdGUgb2YgYGRlbGV0ZWRgLgogICAgICBpbkZsaWdodDogewogICAgICAgIC8vIEZMQUdTCiAgICAgICAgaXNTYXZpbmc6IHRydWUsCiAgICAgICAgLy8gRVZFTlRTCiAgICAgICAgdW5sb2FkUmVjb3JkOiBhc3NlcnRBZ2FpbnN0VW5sb2FkUmVjb3JkLAogICAgICAgIC8vIFRPRE86IE1vcmUgcm9idXN0IHNlbWFudGljcyBhcm91bmQgc2F2ZS13aGlsZS1pbi1mbGlnaHQKICAgICAgICB3aWxsQ29tbWl0OiBmdW5jdGlvbiB3aWxsQ29tbWl0KCkge30sCiAgICAgICAgZGlkQ29tbWl0OiBmdW5jdGlvbiBkaWRDb21taXQoaW50ZXJuYWxNb2RlbCkgewogICAgICAgICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ3NhdmVkJyk7CiAgICAgICAgICBpbnRlcm5hbE1vZGVsLnNlbmQoJ2ludm9rZUxpZmVjeWNsZUNhbGxiYWNrcycpOwogICAgICAgIH0sCiAgICAgICAgYmVjYW1lRXJyb3I6IGZ1bmN0aW9uIGJlY2FtZUVycm9yKGludGVybmFsTW9kZWwpIHsKICAgICAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCd1bmNvbW1pdHRlZCcpOwogICAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ2JlY2FtZUVycm9yJywgaW50ZXJuYWxNb2RlbCk7CiAgICAgICAgfSwKICAgICAgICBiZWNhbWVJbnZhbGlkOiBmdW5jdGlvbiBiZWNhbWVJbnZhbGlkKGludGVybmFsTW9kZWwpIHsKICAgICAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdpbnZhbGlkJyk7CiAgICAgICAgICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcignYmVjYW1lSW52YWxpZCcsIGludGVybmFsTW9kZWwpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgLy8gT25jZSB0aGUgYWRhcHRlciBpbmRpY2F0ZXMgdGhhdCB0aGUgZGVsZXRpb24gaGFzCiAgICAgIC8vIGJlZW4gc2F2ZWQsIHRoZSByZWNvcmQgZW50ZXJzIHRoZSBgc2F2ZWRgIHN1YnN0YXRlCiAgICAgIC8vIG9mIGBkZWxldGVkYC4KICAgICAgc2F2ZWQ6IHsKICAgICAgICAvLyBGTEFHUwogICAgICAgIGlzRGlydHk6IGZhbHNlLAogICAgICAgIHNldHVwOiBmdW5jdGlvbiBzZXR1cChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgICBpbnRlcm5hbE1vZGVsLnJlbW92ZUZyb21JbnZlcnNlUmVsYXRpb25zaGlwcygpOwogICAgICAgIH0sCiAgICAgICAgaW52b2tlTGlmZWN5Y2xlQ2FsbGJhY2tzOiBmdW5jdGlvbiBpbnZva2VMaWZlY3ljbGVDYWxsYmFja3MoaW50ZXJuYWxNb2RlbCkgewogICAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ2RpZERlbGV0ZScsIGludGVybmFsTW9kZWwpOwogICAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ2RpZENvbW1pdCcsIGludGVybmFsTW9kZWwpOwogICAgICAgIH0sCiAgICAgICAgd2lsbENvbW1pdDogZnVuY3Rpb24gd2lsbENvbW1pdCgpIHt9LAogICAgICAgIGRpZENvbW1pdDogZnVuY3Rpb24gZGlkQ29tbWl0KCkge30sCiAgICAgICAgcHVzaGVkRGF0YTogZnVuY3Rpb24gcHVzaGVkRGF0YSgpIHt9CiAgICAgIH0sCiAgICAgIGludmFsaWQ6IHsKICAgICAgICBpc1ZhbGlkOiBmYWxzZSwKICAgICAgICBkaWRTZXRQcm9wZXJ0eTogZnVuY3Rpb24gZGlkU2V0UHJvcGVydHkoaW50ZXJuYWxNb2RlbCwgY29udGV4dCkgewogICAgICAgICAgaW50ZXJuYWxNb2RlbC5yZW1vdmVFcnJvck1lc3NhZ2VGcm9tQXR0cmlidXRlKGNvbnRleHQubmFtZSk7CgogICAgICAgICAgX2RpZFNldFByb3BlcnR5KGludGVybmFsTW9kZWwsIGNvbnRleHQpOwoKICAgICAgICAgIGlmICghaW50ZXJuYWxNb2RlbC5oYXNFcnJvcnMoKSkgewogICAgICAgICAgICB0aGlzLmJlY2FtZVZhbGlkKGludGVybmFsTW9kZWwpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYmVjYW1lSW52YWxpZDogZnVuY3Rpb24gYmVjYW1lSW52YWxpZCgpIHt9LAogICAgICAgIGJlY29tZURpcnR5OiBmdW5jdGlvbiBiZWNvbWVEaXJ0eSgpIHt9LAogICAgICAgIGRlbGV0ZVJlY29yZDogZnVuY3Rpb24gZGVsZXRlUmVjb3JkKCkge30sCiAgICAgICAgd2lsbENvbW1pdDogZnVuY3Rpb24gd2lsbENvbW1pdCgpIHt9LAogICAgICAgIHJvbGxlZEJhY2s6IGZ1bmN0aW9uIHJvbGxlZEJhY2soaW50ZXJuYWxNb2RlbCkgewogICAgICAgICAgaW50ZXJuYWxNb2RlbC5jbGVhckVycm9yTWVzc2FnZXMoKTsKICAgICAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdsb2FkZWQuc2F2ZWQnKTsKICAgICAgICAgIGludGVybmFsTW9kZWwudHJpZ2dlckxhdGVyKCdyZWFkeScpOwogICAgICAgIH0sCiAgICAgICAgYmVjYW1lVmFsaWQ6IGZ1bmN0aW9uIGJlY2FtZVZhbGlkKGludGVybmFsTW9kZWwpIHsKICAgICAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCd1bmNvbW1pdHRlZCcpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGludm9rZUxpZmVjeWNsZUNhbGxiYWNrczogZnVuY3Rpb24gaW52b2tlTGlmZWN5Y2xlQ2FsbGJhY2tzKGludGVybmFsTW9kZWwsIGRpcnR5VHlwZSkgewogICAgICBpZiAoZGlydHlUeXBlID09PSAnY3JlYXRlZCcpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcignZGlkQ3JlYXRlJywgaW50ZXJuYWxNb2RlbCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ2RpZFVwZGF0ZScsIGludGVybmFsTW9kZWwpOwogICAgICB9CgogICAgICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcignZGlkQ29tbWl0JywgaW50ZXJuYWxNb2RlbCk7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gd2lyZVN0YXRlKG9iamVjdCwgcGFyZW50LCBuYW1lKSB7CiAgICAvLyBUT0RPOiBVc2UgT2JqZWN0LmNyZWF0ZSBhbmQgY29weSBpbnN0ZWFkCiAgICBvYmplY3QgPSBtaXhpbihwYXJlbnQgPyBPYmplY3QuY3JlYXRlKHBhcmVudCkgOiB7fSwgb2JqZWN0KTsKICAgIG9iamVjdC5wYXJlbnRTdGF0ZSA9IHBhcmVudDsKICAgIG9iamVjdC5zdGF0ZU5hbWUgPSBuYW1lOwoKICAgIGZvciAodmFyIHByb3AgaW4gb2JqZWN0KSB7CiAgICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwgcHJvcCkgfHwgcHJvcCA9PT0gJ3BhcmVudFN0YXRlJyB8fCBwcm9wID09PSAnc3RhdGVOYW1lJykgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CgogICAgICBpZiAodHlwZW9mIG9iamVjdFtwcm9wXSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBvYmplY3RbcHJvcF0gPSB3aXJlU3RhdGUob2JqZWN0W3Byb3BdLCBvYmplY3QsIG5hbWUgKyAnLicgKyBwcm9wKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBvYmplY3Q7CiAgfQoKICB2YXIgUm9vdFN0YXRlJDEgPSB3aXJlU3RhdGUoUm9vdFN0YXRlLCBudWxsLCAncm9vdCcpOwoKICAvKgogICAqIFJldHVybnMgdGhlIFJlY29yZERhdGEgaW5zdGFuY2UgYXNzb2NpYXRlZCB3aXRoIGEgZ2l2ZW4KICAgKiBNb2RlbCBvciBJbnRlcm5hbE1vZGVsLgogICAqCiAgICogSW50ZW50aW9uYWxseSAibG9vc2UiIHRvIGFsbG93IGFueXRoaW5nIHdpdGggYW4gX2ludGVybmFsTW9kZWwKICAgKiBwcm9wZXJ0eSB1bnRpbCBJbnRlcm5hbE1vZGVsIGlzIGVsaW1pbmF0ZWQuCiAgICoKICAgKiBJbnRlbnRpb25hbGx5IG5vdCB0eXBlZCB0byBgSW50ZXJuYWxNb2RlbGAgZHVlIHRvIGNpcmN1bGFyIGRlcGVuZGVuY3kKICAgKiAgd2hpY2ggdGhhdCBjcmVhdGVzLgogICAqCiAgICogT3ZlcnRpbWUsIHRoaXMgc2hvdWxkIHNoaWZ0IHRvIGEgIndlYWttYXAiIGJhc2VkIGxvb2t1cCBpbiB0aGUKICAgKiAgIkVtYmVyLmdldE93bmVyKG9iaikiIHN0eWxlLgogICAqLwogIGZ1bmN0aW9uIHJlY29yZERhdGFGb3IoaW5zdGFuY2UpIHsKICAgIHZhciBpbnRlcm5hbE1vZGVsID0gaW5zdGFuY2UuX2ludGVybmFsTW9kZWwgfHwgaW5zdGFuY2UuaW50ZXJuYWxNb2RlbCB8fCBpbnN0YW5jZTsKICAgIHJldHVybiBpbnRlcm5hbE1vZGVsLl9yZWNvcmREYXRhIHx8IG51bGw7CiAgfQoKICBmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKICBmdW5jdGlvbiBfY3JlYXRlQ2xhc3MoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKICBmdW5jdGlvbiByZWxhdGlvbnNoaXBzRm9yKGluc3RhbmNlKSB7CiAgICB2YXIgcmVjb3JkRGF0YSA9IHJlY29yZERhdGFGb3IoaW5zdGFuY2UpIHx8IGluc3RhbmNlOwogICAgcmV0dXJuIHJlY29yZERhdGEuX3JlbGF0aW9uc2hpcHM7CiAgfQoKICBmdW5jdGlvbiByZWxhdGlvbnNoaXBTdGF0ZUZvcihpbnN0YW5jZSwgcHJvcGVydHlOYW1lKSB7CiAgICByZXR1cm4gcmVsYXRpb25zaGlwc0ZvcihpbnN0YW5jZSkuZ2V0KHByb3BlcnR5TmFtZSk7CiAgfQogIC8qKgogICAgQGNsYXNzIFNuYXBzaG90CiAgICBAcHJpdmF0ZQogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge01vZGVsfSBpbnRlcm5hbE1vZGVsIFRoZSBtb2RlbCB0byBjcmVhdGUgYSBzbmFwc2hvdCBmcm9tCiAgKi8KCgogIHZhciBTbmFwc2hvdCA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFNuYXBzaG90KG9wdGlvbnMsIGlkZW50aWZpZXIsIHN0b3JlKSB7CiAgICAgIHRoaXMuX19hdHRyaWJ1dGVzID0gbnVsbDsKICAgICAgdGhpcy5fYmVsb25nc1RvUmVsYXRpb25zaGlwcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHRoaXMuX2JlbG9uZ3NUb0lkcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHRoaXMuX2hhc01hbnlSZWxhdGlvbnNoaXBzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgdGhpcy5faGFzTWFueUlkcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CgogICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IHRoaXMuX2ludGVybmFsTW9kZWwgPSBzdG9yZS5faW50ZXJuYWxNb2RlbEZvclJlc291cmNlKGlkZW50aWZpZXIpOwoKICAgICAgdGhpcy5fc3RvcmUgPSBzdG9yZTsKICAgICAgdGhpcy5tb2RlbE5hbWUgPSBpZGVudGlmaWVyLnR5cGU7CgogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuQ1VTVE9NX01PREVMX0NMQVNTKSB7CiAgICAgICAgdGhpcy5pZGVudGlmaWVyID0gaWRlbnRpZmllcjsKICAgICAgfQogICAgICAvKgogICAgICAgIElmIHRoZSBpbnRlcm5hbE1vZGVsIGRvZXMgbm90IHlldCBoYXZlIGEgcmVjb3JkLCB0aGVuIHdlIGFyZQogICAgICAgIGxpa2VseSBhIHNuYXBzaG90IGJlaW5nIHByb3ZpZGVkIHRvIGEgZmluZCByZXF1ZXN0LCBzbyB3ZQogICAgICAgIHBvcHVsYXRlIF9fYXR0cmlidXRlcyBsYXppbHkuIEVsc2UsIHRvIHByZXNlcnZlIHRoZSAibW9tZW50CiAgICAgICAgaW4gdGltZSIgaW4gd2hpY2ggYSBzbmFwc2hvdCBpcyBjcmVhdGVkLCB3ZSBncmVlZGlseSBncmFiCiAgICAgICAgdGhlIHZhbHVlcy4KICAgICAgICovCgoKICAgICAgaWYgKGludGVybmFsTW9kZWwuaGFzUmVjb3JkKSB7CiAgICAgICAgdGhpcy5fYXR0cmlidXRlczsKICAgICAgfQogICAgICAvKipPCiAgICAgICBUaGUgaWQgb2YgdGhlIHNuYXBzaG90J3MgdW5kZXJseWluZyByZWNvcmQKICAgICAgICBFeGFtcGxlCiAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgLy8gc3RvcmUucHVzaCgncG9zdCcsIHsgaWQ6IDEsIGF1dGhvcjogJ1RvbXN0ZXInLCB0aXRsZTogJ0VtYmVyLmpzIHJvY2tzJyB9KTsKICAgICAgIHBvc3RTbmFwc2hvdC5pZDsgLy8gPT4gJzEnCiAgICAgICBgYGAKICAgICAgICBAcHJvcGVydHkgaWQKICAgICAgIEB0eXBlIHtTdHJpbmd9CiAgICAgICAqLwoKCiAgICAgIHRoaXMuaWQgPSBpZGVudGlmaWVyLmlkOwogICAgICAvKioKICAgICAgIEEgaGFzaCBvZiBhZGFwdGVyIG9wdGlvbnMKICAgICAgIEBwcm9wZXJ0eSBhZGFwdGVyT3B0aW9ucwogICAgICAgQHR5cGUge09iamVjdH0KICAgICAgICovCgogICAgICB0aGlzLmFkYXB0ZXJPcHRpb25zID0gb3B0aW9ucy5hZGFwdGVyT3B0aW9uczsKICAgICAgdGhpcy5pbmNsdWRlID0gb3B0aW9ucy5pbmNsdWRlOwogICAgICAvKioKICAgICAgIFRoZSBuYW1lIG9mIHRoZSB0eXBlIG9mIHRoZSB1bmRlcmx5aW5nIHJlY29yZCBmb3IgdGhpcyBzbmFwc2hvdCwgYXMgYSBzdHJpbmcuCiAgICAgICAgQHByb3BlcnR5IG1vZGVsTmFtZQogICAgICAgQHR5cGUge1N0cmluZ30KICAgICAgICovCgogICAgICB0aGlzLm1vZGVsTmFtZSA9IGludGVybmFsTW9kZWwubW9kZWxOYW1lOwoKICAgICAgaWYgKGludGVybmFsTW9kZWwuaGFzUmVjb3JkKSB7CiAgICAgICAgdGhpcy5fY2hhbmdlZEF0dHJpYnV0ZXMgPSByZWNvcmREYXRhRm9yKGludGVybmFsTW9kZWwpLmNoYW5nZWRBdHRyaWJ1dGVzKCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgIFRoZSB1bmRlcmx5aW5nIHJlY29yZCBmb3IgdGhpcyBzbmFwc2hvdC4gQ2FuIGJlIHVzZWQgdG8gYWNjZXNzIG1ldGhvZHMgYW5kCiAgICAgcHJvcGVydGllcyBkZWZpbmVkIG9uIHRoZSByZWNvcmQuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgamF2YXNjcmlwdAogICAgIGxldCBqc29uID0gc25hcHNob3QucmVjb3JkLnRvSlNPTigpOwogICAgIGBgYAogICAgICBAcHJvcGVydHkgcmVjb3JkCiAgICAgQHR5cGUge01vZGVsfQogICAgICovCgoKICAgIHZhciBfcHJvdG8gPSBTbmFwc2hvdC5wcm90b3R5cGU7CgogICAgLyoqCiAgICAgUmV0dXJucyB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAvLyBzdG9yZS5wdXNoKCdwb3N0JywgeyBpZDogMSwgYXV0aG9yOiAnVG9tc3RlcicsIHRpdGxlOiAnRW1iZXIuanMgcm9ja3MnIH0pOwogICAgIHBvc3RTbmFwc2hvdC5hdHRyKCdhdXRob3InKTsgLy8gPT4gJ1RvbXN0ZXInCiAgICAgcG9zdFNuYXBzaG90LmF0dHIoJ3RpdGxlJyk7IC8vID0+ICdFbWJlci5qcyByb2NrcycKICAgICBgYGAKICAgICAgTm90ZTogVmFsdWVzIGFyZSBsb2FkZWQgZWFnZXJseSBhbmQgY2FjaGVkIHdoZW4gdGhlIHNuYXBzaG90IGlzIGNyZWF0ZWQuCiAgICAgIEBtZXRob2QgYXR0cgogICAgIEBwYXJhbSB7U3RyaW5nfSBrZXlOYW1lCiAgICAgQHJldHVybiB7T2JqZWN0fSBUaGUgYXR0cmlidXRlIHZhbHVlIG9yIHVuZGVmaW5lZAogICAgICovCiAgICBfcHJvdG8uYXR0ciA9IGZ1bmN0aW9uIGF0dHIoa2V5TmFtZSkgewogICAgICBpZiAoa2V5TmFtZSBpbiB0aGlzLl9hdHRyaWJ1dGVzKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2F0dHJpYnV0ZXNba2V5TmFtZV07CiAgICAgIH0KCiAgICAgIHRocm93IG5ldyBFbWJlci5FcnJvcigiTW9kZWwgJyIgKyBFbWJlci5pbnNwZWN0KHRoaXMucmVjb3JkKSArICInIGhhcyBubyBhdHRyaWJ1dGUgbmFtZWQgJyIgKyBrZXlOYW1lICsgIicgZGVmaW5lZC4iKTsKICAgIH0KICAgIC8qKgogICAgIFJldHVybnMgYWxsIGF0dHJpYnV0ZXMgYW5kIHRoZWlyIGNvcnJlc3BvbmRpbmcgdmFsdWVzLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAvLyBzdG9yZS5wdXNoKCdwb3N0JywgeyBpZDogMSwgYXV0aG9yOiAnVG9tc3RlcicsIHRpdGxlOiAnRW1iZXIuanMgcm9ja3MnIH0pOwogICAgIHBvc3RTbmFwc2hvdC5hdHRyaWJ1dGVzKCk7IC8vID0+IHsgYXV0aG9yOiAnVG9tc3RlcicsIHRpdGxlOiAnRW1iZXIuanMgcm9ja3MnIH0KICAgICBgYGAKICAgICAgQG1ldGhvZCBhdHRyaWJ1dGVzCiAgICAgQHJldHVybiB7T2JqZWN0fSBBbGwgYXR0cmlidXRlcyBvZiB0aGUgY3VycmVudCBzbmFwc2hvdAogICAgICovCiAgICA7CgogICAgX3Byb3RvLmF0dHJpYnV0ZXMgPSBmdW5jdGlvbiBhdHRyaWJ1dGVzKCkgewogICAgICByZXR1cm4gRW1iZXIuYXNzaWduKHt9LCB0aGlzLl9hdHRyaWJ1dGVzKTsKICAgIH0KICAgIC8qKgogICAgIFJldHVybnMgYWxsIGNoYW5nZWQgYXR0cmlidXRlcyBhbmQgdGhlaXIgb2xkIGFuZCBuZXcgdmFsdWVzLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAvLyBzdG9yZS5wdXNoKCdwb3N0JywgeyBpZDogMSwgYXV0aG9yOiAnVG9tc3RlcicsIHRpdGxlOiAnRW1iZXIuanMgcm9ja3MnIH0pOwogICAgIHBvc3RNb2RlbC5zZXQoJ3RpdGxlJywgJ0VtYmVyLmpzIHJvY2tzIScpOwogICAgIHBvc3RTbmFwc2hvdC5jaGFuZ2VkQXR0cmlidXRlcygpOyAvLyA9PiB7IHRpdGxlOiBbJ0VtYmVyLmpzIHJvY2tzJywgJ0VtYmVyLmpzIHJvY2tzISddIH0KICAgICBgYGAKICAgICAgQG1ldGhvZCBjaGFuZ2VkQXR0cmlidXRlcwogICAgIEByZXR1cm4ge09iamVjdH0gQWxsIGNoYW5nZWQgYXR0cmlidXRlcyBvZiB0aGUgY3VycmVudCBzbmFwc2hvdAogICAgICovCiAgICA7CgogICAgX3Byb3RvLmNoYW5nZWRBdHRyaWJ1dGVzID0gZnVuY3Rpb24gY2hhbmdlZEF0dHJpYnV0ZXMoKSB7CiAgICAgIHZhciBjaGFuZ2VkQXR0cmlidXRlcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHZhciBjaGFuZ2VkQXR0cmlidXRlS2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuX2NoYW5nZWRBdHRyaWJ1dGVzKTsKCiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBjaGFuZ2VkQXR0cmlidXRlS2V5cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHZhciBrZXkgPSBjaGFuZ2VkQXR0cmlidXRlS2V5c1tpXTsKICAgICAgICBjaGFuZ2VkQXR0cmlidXRlc1trZXldID0gdGhpcy5fY2hhbmdlZEF0dHJpYnV0ZXNba2V5XS5zbGljZSgpOwogICAgICB9CgogICAgICByZXR1cm4gY2hhbmdlZEF0dHJpYnV0ZXM7CiAgICB9CiAgICAvKioKICAgICBSZXR1cm5zIHRoZSBjdXJyZW50IHZhbHVlIG9mIGEgYmVsb25nc1RvIHJlbGF0aW9uc2hpcC4KICAgICAgYGJlbG9uZ3NUb2AgdGFrZXMgYW4gb3B0aW9uYWwgaGFzaCBvZiBvcHRpb25zIGFzIGEgc2Vjb25kIHBhcmFtZXRlciwKICAgICBjdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAgICAtIGBpZGA6IHNldCB0byBgdHJ1ZWAgaWYgeW91IG9ubHkgd2FudCB0aGUgSUQgb2YgdGhlIHJlbGF0ZWQgcmVjb3JkIHRvIGJlCiAgICAgcmV0dXJuZWQuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgamF2YXNjcmlwdAogICAgIC8vIHN0b3JlLnB1c2goJ3Bvc3QnLCB7IGlkOiAxLCB0aXRsZTogJ0hlbGxvIFdvcmxkJyB9KTsKICAgICAvLyBzdG9yZS5jcmVhdGVSZWNvcmQoJ2NvbW1lbnQnLCB7IGJvZHk6ICdMb3JlbSBpcHN1bScsIHBvc3Q6IHBvc3QgfSk7CiAgICAgY29tbWVudFNuYXBzaG90LmJlbG9uZ3NUbygncG9zdCcpOyAvLyA9PiBTbmFwc2hvdAogICAgIGNvbW1lbnRTbmFwc2hvdC5iZWxvbmdzVG8oJ3Bvc3QnLCB7IGlkOiB0cnVlIH0pOyAvLyA9PiAnMScKICAgICAgLy8gc3RvcmUucHVzaCgnY29tbWVudCcsIHsgaWQ6IDEsIGJvZHk6ICdMb3JlbSBpcHN1bScgfSk7CiAgICAgY29tbWVudFNuYXBzaG90LmJlbG9uZ3NUbygncG9zdCcpOyAvLyA9PiB1bmRlZmluZWQKICAgICBgYGAKICAgICAgQ2FsbGluZyBgYmVsb25nc1RvYCB3aWxsIHJldHVybiBhIG5ldyBTbmFwc2hvdCBhcyBsb25nIGFzIHRoZXJlJ3MgYW55IGtub3duCiAgICAgZGF0YSBmb3IgdGhlIHJlbGF0aW9uc2hpcCBhdmFpbGFibGUsIHN1Y2ggYXMgYW4gSUQuIElmIHRoZSByZWxhdGlvbnNoaXAgaXMKICAgICBrbm93biBidXQgdW5zZXQsIGBiZWxvbmdzVG9gIHdpbGwgcmV0dXJuIGBudWxsYC4gSWYgdGhlIGNvbnRlbnRzIG9mIHRoZQogICAgIHJlbGF0aW9uc2hpcCBpcyB1bmtub3duIGBiZWxvbmdzVG9gIHdpbGwgcmV0dXJuIGB1bmRlZmluZWRgLgogICAgICBOb3RlOiBSZWxhdGlvbnNoaXBzIGFyZSBsb2FkZWQgbGF6aWx5IGFuZCBjYWNoZWQgdXBvbiBmaXJzdCBhY2Nlc3MuCiAgICAgIEBtZXRob2QgYmVsb25nc1RvCiAgICAgQHBhcmFtIHtTdHJpbmd9IGtleU5hbWUKICAgICBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdCiAgICAgQHJldHVybiB7KFNuYXBzaG90fFN0cmluZ3xudWxsfHVuZGVmaW5lZCl9IEEgc25hcHNob3Qgb3IgSUQgb2YgYSBrbm93bgogICAgIHJlbGF0aW9uc2hpcCBvciBudWxsIGlmIHRoZSByZWxhdGlvbnNoaXAgaXMga25vd24gYnV0IHVuc2V0LiB1bmRlZmluZWQKICAgICB3aWxsIGJlIHJldHVybmVkIGlmIHRoZSBjb250ZW50cyBvZiB0aGUgcmVsYXRpb25zaGlwIGlzIHVua25vd24uCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8uYmVsb25nc1RvID0gZnVuY3Rpb24gYmVsb25nc1RvKGtleU5hbWUsIG9wdGlvbnMpIHsKICAgICAgdmFyIGlkID0gb3B0aW9ucyAmJiBvcHRpb25zLmlkOwogICAgICB2YXIgcmVsYXRpb25zaGlwOwogICAgICB2YXIgaW52ZXJzZUludGVybmFsTW9kZWw7CiAgICAgIHZhciByZXN1bHQ7CiAgICAgIHZhciBzdG9yZSA9IHRoaXMuX2ludGVybmFsTW9kZWwuc3RvcmU7CgogICAgICBpZiAoaWQgJiYga2V5TmFtZSBpbiB0aGlzLl9iZWxvbmdzVG9JZHMpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYmVsb25nc1RvSWRzW2tleU5hbWVdOwogICAgICB9CgogICAgICBpZiAoIWlkICYmIGtleU5hbWUgaW4gdGhpcy5fYmVsb25nc1RvUmVsYXRpb25zaGlwcykgewogICAgICAgIHJldHVybiB0aGlzLl9iZWxvbmdzVG9SZWxhdGlvbnNoaXBzW2tleU5hbWVdOwogICAgICB9CgogICAgICB2YXIgcmVsYXRpb25zaGlwTWV0YSA9IHN0b3JlLl9yZWxhdGlvbnNoaXBNZXRhRm9yKHRoaXMubW9kZWxOYW1lLCBudWxsLCBrZXlOYW1lKTsKCiAgICAgIGlmICghKHJlbGF0aW9uc2hpcE1ldGEgJiYgcmVsYXRpb25zaGlwTWV0YS5raW5kID09PSAnYmVsb25nc1RvJykpIHsKICAgICAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIk1vZGVsICciICsgRW1iZXIuaW5zcGVjdCh0aGlzLnJlY29yZCkgKyAiJyBoYXMgbm8gYmVsb25nc1RvIHJlbGF0aW9uc2hpcCBuYW1lZCAnIiArIGtleU5hbWUgKyAiJyBkZWZpbmVkLiIpOwogICAgICB9CgogICAgICByZWxhdGlvbnNoaXAgPSByZWxhdGlvbnNoaXBTdGF0ZUZvcih0aGlzLCBrZXlOYW1lKTsKICAgICAgdmFyIHZhbHVlID0gcmVsYXRpb25zaGlwLmdldERhdGEoKTsKICAgICAgdmFyIGRhdGEgPSB2YWx1ZSAmJiB2YWx1ZS5kYXRhOwogICAgICBpbnZlcnNlSW50ZXJuYWxNb2RlbCA9IGRhdGEgJiYgc3RvcmUuX2ludGVybmFsTW9kZWxGb3JSZXNvdXJjZShkYXRhKTsKCiAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS5kYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAoaW52ZXJzZUludGVybmFsTW9kZWwgJiYgIWludmVyc2VJbnRlcm5hbE1vZGVsLmlzRGVsZXRlZCgpKSB7CiAgICAgICAgICBpZiAoaWQpIHsKICAgICAgICAgICAgcmVzdWx0ID0gRW1iZXIuZ2V0KGludmVyc2VJbnRlcm5hbE1vZGVsLCAnaWQnKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdCA9IGludmVyc2VJbnRlcm5hbE1vZGVsLmNyZWF0ZVNuYXBzaG90KCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdCA9IG51bGw7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaWQpIHsKICAgICAgICB0aGlzLl9iZWxvbmdzVG9JZHNba2V5TmFtZV0gPSByZXN1bHQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fYmVsb25nc1RvUmVsYXRpb25zaGlwc1trZXlOYW1lXSA9IHJlc3VsdDsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8qKgogICAgIFJldHVybnMgdGhlIGN1cnJlbnQgdmFsdWUgb2YgYSBoYXNNYW55IHJlbGF0aW9uc2hpcC4KICAgICAgYGhhc01hbnlgIHRha2VzIGFuIG9wdGlvbmFsIGhhc2ggb2Ygb3B0aW9ucyBhcyBhIHNlY29uZCBwYXJhbWV0ZXIsCiAgICAgY3VycmVudGx5IHN1cHBvcnRlZCBvcHRpb25zIGFyZToKICAgICAgLSBgaWRzYDogc2V0IHRvIGB0cnVlYCBpZiB5b3Ugb25seSB3YW50IHRoZSBJRHMgb2YgdGhlIHJlbGF0ZWQgcmVjb3JkcyB0byBiZQogICAgIHJldHVybmVkLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAvLyBzdG9yZS5wdXNoKCdwb3N0JywgeyBpZDogMSwgdGl0bGU6ICdIZWxsbyBXb3JsZCcsIGNvbW1lbnRzOiBbMiwgM10gfSk7CiAgICAgcG9zdFNuYXBzaG90Lmhhc01hbnkoJ2NvbW1lbnRzJyk7IC8vID0+IFtTbmFwc2hvdCwgU25hcHNob3RdCiAgICAgcG9zdFNuYXBzaG90Lmhhc01hbnkoJ2NvbW1lbnRzJywgeyBpZHM6IHRydWUgfSk7IC8vID0+IFsnMicsICczJ10KICAgICAgLy8gc3RvcmUucHVzaCgncG9zdCcsIHsgaWQ6IDEsIHRpdGxlOiAnSGVsbG8gV29ybGQnIH0pOwogICAgIHBvc3RTbmFwc2hvdC5oYXNNYW55KCdjb21tZW50cycpOyAvLyA9PiB1bmRlZmluZWQKICAgICBgYGAKICAgICAgTm90ZTogUmVsYXRpb25zaGlwcyBhcmUgbG9hZGVkIGxhemlseSBhbmQgY2FjaGVkIHVwb24gZmlyc3QgYWNjZXNzLgogICAgICBAbWV0aG9kIGhhc01hbnkKICAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZQogICAgIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10KICAgICBAcmV0dXJuIHsoQXJyYXl8dW5kZWZpbmVkKX0gQW4gYXJyYXkgb2Ygc25hcHNob3RzIG9yIElEcyBvZiBhIGtub3duCiAgICAgcmVsYXRpb25zaGlwIG9yIGFuIGVtcHR5IGFycmF5IGlmIHRoZSByZWxhdGlvbnNoaXAgaXMga25vd24gYnV0IHVuc2V0LgogICAgIHVuZGVmaW5lZCB3aWxsIGJlIHJldHVybmVkIGlmIHRoZSBjb250ZW50cyBvZiB0aGUgcmVsYXRpb25zaGlwIGlzIHVua25vd24uCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8uaGFzTWFueSA9IGZ1bmN0aW9uIGhhc01hbnkoa2V5TmFtZSwgb3B0aW9ucykgewogICAgICB2YXIgaWRzID0gb3B0aW9ucyAmJiBvcHRpb25zLmlkczsKICAgICAgdmFyIHJlbGF0aW9uc2hpcDsKICAgICAgdmFyIHJlc3VsdHM7CgogICAgICBpZiAoaWRzICYmIGtleU5hbWUgaW4gdGhpcy5faGFzTWFueUlkcykgewogICAgICAgIHJldHVybiB0aGlzLl9oYXNNYW55SWRzW2tleU5hbWVdOwogICAgICB9CgogICAgICBpZiAoIWlkcyAmJiBrZXlOYW1lIGluIHRoaXMuX2hhc01hbnlSZWxhdGlvbnNoaXBzKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2hhc01hbnlSZWxhdGlvbnNoaXBzW2tleU5hbWVdOwogICAgICB9CgogICAgICB2YXIgc3RvcmUgPSB0aGlzLl9pbnRlcm5hbE1vZGVsLnN0b3JlOwoKICAgICAgdmFyIHJlbGF0aW9uc2hpcE1ldGEgPSBzdG9yZS5fcmVsYXRpb25zaGlwTWV0YUZvcih0aGlzLm1vZGVsTmFtZSwgbnVsbCwga2V5TmFtZSk7CgogICAgICBpZiAoIShyZWxhdGlvbnNoaXBNZXRhICYmIHJlbGF0aW9uc2hpcE1ldGEua2luZCA9PT0gJ2hhc01hbnknKSkgewogICAgICAgIHRocm93IG5ldyBFbWJlci5FcnJvcigiTW9kZWwgJyIgKyBFbWJlci5pbnNwZWN0KHRoaXMucmVjb3JkKSArICInIGhhcyBubyBoYXNNYW55IHJlbGF0aW9uc2hpcCBuYW1lZCAnIiArIGtleU5hbWUgKyAiJyBkZWZpbmVkLiIpOwogICAgICB9CgogICAgICByZWxhdGlvbnNoaXAgPSByZWxhdGlvbnNoaXBTdGF0ZUZvcih0aGlzLCBrZXlOYW1lKTsKICAgICAgdmFyIHZhbHVlID0gcmVsYXRpb25zaGlwLmdldERhdGEoKTsKCiAgICAgIGlmICh2YWx1ZS5kYXRhKSB7CiAgICAgICAgcmVzdWx0cyA9IFtdOwogICAgICAgIHZhbHVlLmRhdGEuZm9yRWFjaChmdW5jdGlvbiAobWVtYmVyKSB7CiAgICAgICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IHN0b3JlLl9pbnRlcm5hbE1vZGVsRm9yUmVzb3VyY2UobWVtYmVyKTsKCiAgICAgICAgICBpZiAoIWludGVybmFsTW9kZWwuaXNEZWxldGVkKCkpIHsKICAgICAgICAgICAgaWYgKGlkcykgewogICAgICAgICAgICAgIHJlc3VsdHMucHVzaChtZW1iZXIuaWQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc3VsdHMucHVzaChpbnRlcm5hbE1vZGVsLmNyZWF0ZVNuYXBzaG90KCkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmIChpZHMpIHsKICAgICAgICB0aGlzLl9oYXNNYW55SWRzW2tleU5hbWVdID0gcmVzdWx0czsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9oYXNNYW55UmVsYXRpb25zaGlwc1trZXlOYW1lXSA9IHJlc3VsdHM7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHRzOwogICAgfQogICAgLyoqCiAgICAgIEl0ZXJhdGVzIHRocm91Z2ggYWxsIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCwgY2FsbGluZyB0aGUgcGFzc2VkCiAgICAgIGZ1bmN0aW9uIG9uIGVhY2ggYXR0cmlidXRlLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBzbmFwc2hvdC5lYWNoQXR0cmlidXRlKGZ1bmN0aW9uKG5hbWUsIG1ldGEpIHsKICAgICAgICAvLyAuLi4KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBlYWNoQXR0cmlidXRlCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIHRoZSBjYWxsYmFjayB0byBleGVjdXRlCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBbYmluZGluZ10gdGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBjYWxsYmFjaydzIGB0aGlzYCBzaG91bGQgYmUgYm91bmQKICAgICovCiAgICA7CgogICAgX3Byb3RvLmVhY2hBdHRyaWJ1dGUgPSBmdW5jdGlvbiBlYWNoQXR0cmlidXRlKGNhbGxiYWNrLCBiaW5kaW5nKSB7CiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MpIHsKICAgICAgICB2YXIgYXR0ckRlZnMgPSB0aGlzLl9zdG9yZS5fYXR0cmlidXRlc0RlZmluaXRpb25Gb3IodGhpcy5tb2RlbE5hbWUsIHRoaXMuaWRlbnRpZmllcik7CgogICAgICAgIE9iamVjdC5rZXlzKGF0dHJEZWZzKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIGNhbGxiYWNrLmNhbGwoYmluZGluZywga2V5LCBhdHRyRGVmc1trZXldKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnJlY29yZC5lYWNoQXR0cmlidXRlKGNhbGxiYWNrLCBiaW5kaW5nKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgIEl0ZXJhdGVzIHRocm91Z2ggYWxsIHRoZSByZWxhdGlvbnNoaXBzIG9mIHRoZSBtb2RlbCwgY2FsbGluZyB0aGUgcGFzc2VkCiAgICAgIGZ1bmN0aW9uIG9uIGVhY2ggcmVsYXRpb25zaGlwLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBzbmFwc2hvdC5lYWNoUmVsYXRpb25zaGlwKGZ1bmN0aW9uKG5hbWUsIHJlbGF0aW9uc2hpcCkgewogICAgICAgIC8vIC4uLgogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGVhY2hSZWxhdGlvbnNoaXAKICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgdGhlIGNhbGxiYWNrIHRvIGV4ZWN1dGUKICAgICAgQHBhcmFtIHtPYmplY3R9IFtiaW5kaW5nXSB0aGUgdmFsdWUgdG8gd2hpY2ggdGhlIGNhbGxiYWNrJ3MgYHRoaXNgIHNob3VsZCBiZSBib3VuZAogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uZWFjaFJlbGF0aW9uc2hpcCA9IGZ1bmN0aW9uIGVhY2hSZWxhdGlvbnNoaXAoY2FsbGJhY2ssIGJpbmRpbmcpIHsKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLkNVU1RPTV9NT0RFTF9DTEFTUykgewogICAgICAgIHZhciByZWxhdGlvbnNoaXBEZWZzID0gdGhpcy5fc3RvcmUuX3JlbGF0aW9uc2hpcHNEZWZpbml0aW9uRm9yKHRoaXMubW9kZWxOYW1lLCB0aGlzLmlkZW50aWZpZXIpOwoKICAgICAgICBPYmplY3Qua2V5cyhyZWxhdGlvbnNoaXBEZWZzKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIGNhbGxiYWNrLmNhbGwoYmluZGluZywga2V5LCByZWxhdGlvbnNoaXBEZWZzW2tleV0pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucmVjb3JkLmVhY2hSZWxhdGlvbnNoaXAoY2FsbGJhY2ssIGJpbmRpbmcpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAgU2VyaWFsaXplcyB0aGUgc25hcHNob3QgdXNpbmcgdGhlIHNlcmlhbGl6ZXIgZm9yIHRoZSBtb2RlbC4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgQWRhcHRlciBmcm9tICdAZW1iZXItZGF0YS9hZGFwdGVyJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IEFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICBjcmVhdGVSZWNvcmQoc3RvcmUsIHR5cGUsIHNuYXBzaG90KSB7CiAgICAgICAgICB2YXIgZGF0YSA9IHNuYXBzaG90LnNlcmlhbGl6ZSh7IGluY2x1ZGVJZDogdHJ1ZSB9KTsKICAgICAgICAgIHZhciB1cmwgPSBgLyR7dHlwZS5tb2RlbE5hbWV9YDsKICAgICAgICAgICByZXR1cm4gZmV0Y2godXJsLCB7CiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLAogICAgICAgICAgICBib2R5OiBkYXRhLAogICAgICAgICAgfSkudGhlbigocmVzcG9uc2UpID0+IHJlc3BvbnNlLmpzb24oKSkKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2Qgc2VyaWFsaXplCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgIEByZXR1cm4ge09iamVjdH0gYW4gb2JqZWN0IHdob3NlIHZhbHVlcyBhcmUgcHJpbWl0aXZlIEpTT04gdmFsdWVzIG9ubHkKICAgICAqLwogICAgOwoKICAgIF9wcm90by5zZXJpYWxpemUgPSBmdW5jdGlvbiBzZXJpYWxpemUob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5yZWNvcmQuc3RvcmUuc2VyaWFsaXplckZvcih0aGlzLm1vZGVsTmFtZSkuc2VyaWFsaXplKHRoaXMsIG9wdGlvbnMpOwogICAgfTsKCiAgICBfY3JlYXRlQ2xhc3MoU25hcHNob3QsIFt7CiAgICAgIGtleTogInJlY29yZCIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9pbnRlcm5hbE1vZGVsLmdldFJlY29yZCgpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9hdHRyaWJ1dGVzIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgdmFyIGF0dHJpYnV0ZXMgPSB0aGlzLl9fYXR0cmlidXRlczsKCiAgICAgICAgaWYgKGF0dHJpYnV0ZXMgPT09IG51bGwpIHsKICAgICAgICAgIHZhciByZWNvcmQgPSB0aGlzLnJlY29yZDsKICAgICAgICAgIGF0dHJpYnV0ZXMgPSB0aGlzLl9fYXR0cmlidXRlcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgICAgICB2YXIgYXR0cnM7CgogICAgICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLkNVU1RPTV9NT0RFTF9DTEFTUykgewogICAgICAgICAgICBhdHRycyA9IE9iamVjdC5rZXlzKHRoaXMuX3N0b3JlLl9hdHRyaWJ1dGVzRGVmaW5pdGlvbkZvcih0aGlzLm1vZGVsTmFtZSwgdGhpcy5pZGVudGlmaWVyKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhdHRycyA9IE9iamVjdC5rZXlzKHRoaXMuX3N0b3JlLl9hdHRyaWJ1dGVzRGVmaW5pdGlvbkZvcih0aGlzLm1vZGVsTmFtZSwgcmVjb3JkLmlkKSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLkNVU1RPTV9NT0RFTF9DTEFTUykgewogICAgICAgICAgICBhdHRycy5mb3JFYWNoKGZ1bmN0aW9uIChrZXlOYW1lKSB7CiAgICAgICAgICAgICAgaWYgKF90aGlzLnR5cGUuaXNNb2RlbCkgewogICAgICAgICAgICAgICAgYXR0cmlidXRlc1trZXlOYW1lXSA9IEVtYmVyLmdldChyZWNvcmQsIGtleU5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzW2tleU5hbWVdID0gcmVjb3JkRGF0YUZvcihfdGhpcy5faW50ZXJuYWxNb2RlbCkuZ2V0QXR0cihrZXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVjb3JkLmVhY2hBdHRyaWJ1dGUoZnVuY3Rpb24gKGtleU5hbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gYXR0cmlidXRlc1trZXlOYW1lXSA9IEVtYmVyLmdldChyZWNvcmQsIGtleU5hbWUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBhdHRyaWJ1dGVzOwogICAgICB9CiAgICAgIC8qKgogICAgICAgVGhlIHR5cGUgb2YgdGhlIHVuZGVybHlpbmcgcmVjb3JkIGZvciB0aGlzIHNuYXBzaG90LCBhcyBhIE1vZGVsLgogICAgICAgIEBwcm9wZXJ0eSB0eXBlCiAgICAgICBAdHlwZSB7TW9kZWx9CiAgICAgICAqLwoKICAgIH0sIHsKICAgICAga2V5OiAidHlwZSIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIC8vIFRPRE8gQHJ1bnNwaXJlZCB3ZSBzaG91bGQgZGVwcmVjYXRlIHRoaXMgaW4gZmF2b3Igb2YgbW9kZWxDbGFzcyBidXQgb25seSBvbmNlCiAgICAgICAgLy8gd2UndmUgY2xlYW5lZCB1cCB0aGUgaW50ZXJuYWxzIGVub3VnaCB0aGF0IGEgcHVibGljIGNoYW5nZSB0byBmb2xsb3cgc3VpdGUgaXMKICAgICAgICAvLyB1bmNvbnRyb3ZlcnNpYWwuCiAgICAgICAgcmV0dXJuIHRoaXMuX2ludGVybmFsTW9kZWwubW9kZWxDbGFzczsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJpc05ldyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIGlmICghY2FuYXJ5RmVhdHVyZXMuQ1VTVE9NX01PREVMX0NMQVNTKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2lzTmV3IGlzIG9ubHkgYXZhaWxhYmxlIHdoZW4gY3VzdG9tIG1vZGVsIGNsYXNzIGZmIGlzIG9uJyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5faW50ZXJuYWxNb2RlbC5pc05ldygpOwogICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIFNuYXBzaG90OwogIH0oKTsKCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL3N0b3JlCiAgKi8KCiAgdmFyIERlcHJlY2F0ZWRFdmVudGVkID0gIEVtYmVyLkV2ZW50ZWQ7CgogIC8qKgogICAgQG1vZHVsZSBAZW1iZXItZGF0YS9zdG9yZQogICovCgogIC8qCiAgICBBIGBQcm9taXNlQXJyYXlgIGlzIGFuIG9iamVjdCB0aGF0IGFjdHMgbGlrZSBib3RoIGFuIGBFbWJlci5BcnJheWAKICAgIGFuZCBhIHByb21pc2UuIFdoZW4gdGhlIHByb21pc2UgaXMgcmVzb2x2ZWQgdGhlIHJlc3VsdGluZyB2YWx1ZQogICAgd2lsbCBiZSBzZXQgdG8gdGhlIGBQcm9taXNlQXJyYXlgJ3MgYGNvbnRlbnRgIHByb3BlcnR5LiBUaGlzIG1ha2VzCiAgICBpdCBlYXN5IHRvIGNyZWF0ZSBkYXRhIGJpbmRpbmdzIHdpdGggdGhlIGBQcm9taXNlQXJyYXlgIHRoYXQgd2lsbCBiZQogICAgdXBkYXRlZCB3aGVuIHRoZSBwcm9taXNlIHJlc29sdmVzLgoKICAgIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSB0aGUgW0VtYmVyLlByb21pc2VQcm94eU1peGluCiAgICBkb2N1bWVudGF0aW9uXSgvYXBpL2NsYXNzZXMvRW1iZXIuUHJvbWlzZVByb3h5TWl4aW4uaHRtbCkuCgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCBwcm9taXNlQXJyYXkgPSBQcm9taXNlQXJyYXkuY3JlYXRlKHsKICAgICAgcHJvbWlzZTogJC5nZXRKU09OKCcvc29tZS9yZW1vdGUvZGF0YS5qc29uJykKICAgIH0pOwoKICAgIHByb21pc2VBcnJheS5nZXQoJ2xlbmd0aCcpOyAvLyAwCgogICAgcHJvbWlzZUFycmF5LnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHByb21pc2VBcnJheS5nZXQoJ2xlbmd0aCcpOyAvLyAxMDAKICAgIH0pOwogICAgYGBgCgogICAgQGNsYXNzIFByb21pc2VBcnJheQogICAgQGV4dGVuZHMgRW1iZXIuQXJyYXlQcm94eQogICAgQHVzZXMgRW1iZXIuUHJvbWlzZVByb3h5TWl4aW4KICAqLwoKICB2YXIgUHJvbWlzZUFycmF5ID0gRW1iZXIuQXJyYXlQcm94eS5leHRlbmQoRW1iZXIuUHJvbWlzZVByb3h5TWl4aW4sIHsKICAgIG1ldGE6IEVtYmVyLmNvbXB1dGVkLnJlYWRzKCdjb250ZW50Lm1ldGEnKQogIH0pOwogIC8qCiAgICBBIGBQcm9taXNlT2JqZWN0YCBpcyBhbiBvYmplY3QgdGhhdCBhY3RzIGxpa2UgYm90aCBhbiBgRW1iZXJPYmplY3RgCiAgICBhbmQgYSBwcm9taXNlLiBXaGVuIHRoZSBwcm9taXNlIGlzIHJlc29sdmVkLCB0aGVuIHRoZSByZXN1bHRpbmcgdmFsdWUKICAgIHdpbGwgYmUgc2V0IHRvIHRoZSBgUHJvbWlzZU9iamVjdGAncyBgY29udGVudGAgcHJvcGVydHkuIFRoaXMgbWFrZXMKICAgIGl0IGVhc3kgdG8gY3JlYXRlIGRhdGEgYmluZGluZ3Mgd2l0aCB0aGUgYFByb21pc2VPYmplY3RgIHRoYXQgd2lsbAogICAgYmUgdXBkYXRlZCB3aGVuIHRoZSBwcm9taXNlIHJlc29sdmVzLgoKICAgIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSB0aGUgW0VtYmVyLlByb21pc2VQcm94eU1peGluCiAgICBkb2N1bWVudGF0aW9uXSgvYXBpL2NsYXNzZXMvRW1iZXIuUHJvbWlzZVByb3h5TWl4aW4uaHRtbCkuCgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCBwcm9taXNlT2JqZWN0ID0gUHJvbWlzZU9iamVjdC5jcmVhdGUoewogICAgICBwcm9taXNlOiAkLmdldEpTT04oJy9zb21lL3JlbW90ZS9kYXRhLmpzb24nKQogICAgfSk7CgogICAgcHJvbWlzZU9iamVjdC5nZXQoJ25hbWUnKTsgLy8gbnVsbAoKICAgIHByb21pc2VPYmplY3QudGhlbihmdW5jdGlvbigpIHsKICAgICAgcHJvbWlzZU9iamVjdC5nZXQoJ25hbWUnKTsgLy8gJ1RvbXN0ZXInCiAgICB9KTsKICAgIGBgYAoKICAgIEBjbGFzcyBQcm9taXNlT2JqZWN0CiAgICBAZXh0ZW5kcyBFbWJlci5PYmplY3RQcm94eQogICAgQHVzZXMgRW1iZXIuUHJvbWlzZVByb3h5TWl4aW4KICAqLwoKICB2YXIgUHJvbWlzZU9iamVjdCA9IEVtYmVyLk9iamVjdFByb3h5LmV4dGVuZChFbWJlci5Qcm9taXNlUHJveHlNaXhpbik7CiAgZnVuY3Rpb24gcHJvbWlzZU9iamVjdChwcm9taXNlLCBsYWJlbCkgewogICAgcmV0dXJuIFByb21pc2VPYmplY3QuY3JlYXRlKHsKICAgICAgcHJvbWlzZTogRW1iZXIuUlNWUC5Qcm9taXNlLnJlc29sdmUocHJvbWlzZSwgbGFiZWwpCiAgICB9KTsKICB9CiAgZnVuY3Rpb24gcHJvbWlzZUFycmF5KHByb21pc2UsIGxhYmVsKSB7CiAgICByZXR1cm4gUHJvbWlzZUFycmF5LmNyZWF0ZSh7CiAgICAgIHByb21pc2U6IEVtYmVyLlJTVlAuUHJvbWlzZS5yZXNvbHZlKHByb21pc2UsIGxhYmVsKQogICAgfSk7CiAgfQogIHZhciBQcm9taXNlQmVsb25nc1RvID0gUHJvbWlzZU9iamVjdC5leHRlbmQoewogICAgLy8gd2UgZG9uJ3QgcHJveHkgbWV0YSBiZWNhdXNlIHdlIHdvdWxkIG5lZWQgdG8gcHJveHkgaXQgdG8gdGhlIHJlbGF0aW9uc2hpcCBzdGF0ZSBjb250YWluZXIKICAgIC8vICBob3dldmVyLCBtZXRhIG9uIHJlbGF0aW9uc2hpcHMgZG9lcyBub3QgdHJpZ2dlciBjaGFuZ2Ugbm90aWZpY2F0aW9ucy4KICAgIC8vICBpZiB5b3UgbmVlZCByZWxhdGlvbnNoaXAgbWV0YSwgeW91IHNob3VsZCBkbyBgcmVjb3JkLmJlbG9uZ3NUbyhyZWxhdGlvbnNoaXBOYW1lKS5tZXRhKClgCiAgICBtZXRhOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbiAoKSB7CiAgICB9KSwKICAgIHJlbG9hZDogZnVuY3Rpb24gcmVsb2FkKG9wdGlvbnMpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIF90aGlzJF9iZWxvbmdzVG9TdGF0ZSA9IHRoaXMuX2JlbG9uZ3NUb1N0YXRlLAogICAgICAgICAga2V5ID0gX3RoaXMkX2JlbG9uZ3NUb1N0YXRlLmtleSwKICAgICAgICAgIHN0b3JlID0gX3RoaXMkX2JlbG9uZ3NUb1N0YXRlLnN0b3JlLAogICAgICAgICAgb3JpZ2luYXRpbmdJbnRlcm5hbE1vZGVsID0gX3RoaXMkX2JlbG9uZ3NUb1N0YXRlLm9yaWdpbmF0aW5nSW50ZXJuYWxNb2RlbDsKICAgICAgcmV0dXJuIHN0b3JlLnJlbG9hZEJlbG9uZ3NUbyh0aGlzLCBvcmlnaW5hdGluZ0ludGVybmFsTW9kZWwsIGtleSwgb3B0aW9ucykudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIF90aGlzOwogICAgICB9KTsKICAgIH0KICB9KTsKICBmdW5jdGlvbiBwcm94eVRvQ29udGVudChtZXRob2QpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfRW1iZXJHZXQ7CgogICAgICByZXR1cm4gKF9FbWJlckdldCA9IEVtYmVyLmdldCh0aGlzLCAnY29udGVudCcpKVttZXRob2RdLmFwcGx5KF9FbWJlckdldCwgYXJndW1lbnRzKTsKICAgIH07CiAgfQogIC8qCiAgICBBIFByb21pc2VNYW55QXJyYXkgaXMgYSBQcm9taXNlQXJyYXkgdGhhdCBhbHNvIHByb3hpZXMgY2VydGFpbiBtZXRob2QgY2FsbHMKICAgIHRvIHRoZSB1bmRlcmx5aW5nIG1hbnlBcnJheS4KICAgIFJpZ2h0IG5vdyB3ZSBwcm94eToKCiAgICAgICogYHJlbG9hZCgpYAogICAgICAqIGBjcmVhdGVSZWNvcmQoKWAKICAgICAgKiBgb24oKWAKICAgICAgKiBgb25lKClgCiAgICAgICogYHRyaWdnZXIoKWAKICAgICAgKiBgb2ZmKClgCiAgICAgICogYGhhcygpYAoKICAgIEBjbGFzcyBQcm9taXNlTWFueUFycmF5CiAgICBAZXh0ZW5kcyBFbWJlci5BcnJheVByb3h5CiAgKi8KCiAgdmFyIFByb21pc2VNYW55QXJyYXkgPSBQcm9taXNlQXJyYXkuZXh0ZW5kKHsKICAgIGxpbmtzOiBjYW5hcnlGZWF0dXJlcy5GVUxMX0xJTktTX09OX1JFTEFUSU9OU0hJUFMgPyBFbWJlci5jb21wdXRlZC5yZWFkcygnY29udGVudC5saW5rcycpIDogdW5kZWZpbmVkLAogICAgcmVsb2FkOiBmdW5jdGlvbiByZWxvYWQob3B0aW9ucykgewogICAgICB0aGlzLnNldCgncHJvbWlzZScsIHRoaXMuZ2V0KCdjb250ZW50JykucmVsb2FkKG9wdGlvbnMpKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgY3JlYXRlUmVjb3JkOiBwcm94eVRvQ29udGVudCgnY3JlYXRlUmVjb3JkJyksCiAgICBvbjogcHJveHlUb0NvbnRlbnQoJ29uJyksCiAgICBvbmU6IHByb3h5VG9Db250ZW50KCdvbmUnKSwKICAgIHRyaWdnZXI6IHByb3h5VG9Db250ZW50KCd0cmlnZ2VyJyksCiAgICBvZmY6IHByb3h5VG9Db250ZW50KCdvZmYnKSwKICAgIGhhczogcHJveHlUb0NvbnRlbnQoJ2hhcycpCiAgfSk7CgogIC8qKgogICAgQG1vZHVsZSBAZW1iZXItZGF0YS9zdG9yZQogICovCiAgZnVuY3Rpb24gX2JpbmQoZm4pIHsKICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGZuLmFwcGx5KHVuZGVmaW5lZCwgYXJncyk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBfZ3VhcmQocHJvbWlzZSwgdGVzdCkgewogICAgdmFyIGd1YXJkZWQgPSBwcm9taXNlLmZpbmFsbHkoZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRlc3QoKSkgewogICAgICAgIGd1YXJkZWQuX3N1YnNjcmliZXJzLmxlbmd0aCA9IDA7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIGd1YXJkZWQ7CiAgfQogIGZ1bmN0aW9uIF9vYmplY3RJc0FsaXZlKG9iamVjdCkgewogICAgcmV0dXJuICEoRW1iZXIuZ2V0KG9iamVjdCwgJ2lzRGVzdHJveWVkJykgfHwgRW1iZXIuZ2V0KG9iamVjdCwgJ2lzRGVzdHJveWluZycpKTsKICB9CiAgZnVuY3Rpb24gZ3VhcmREZXN0cm95ZWRTdG9yZShwcm9taXNlLCBzdG9yZSwgbGFiZWwpIHsKCiAgICB2YXIgd3JhcHBlclByb21pc2UgPSBFbWJlci5SU1ZQLnJlc29sdmUocHJvbWlzZSwgbGFiZWwpLnRoZW4oZnVuY3Rpb24gKHYpIHsKICAgICAgcmV0dXJuIHByb21pc2U7CiAgICB9KTsKICAgIHJldHVybiBfZ3VhcmQod3JhcHBlclByb21pc2UsIGZ1bmN0aW9uICgpIHsKCiAgICAgIHJldHVybiBfb2JqZWN0SXNBbGl2ZShzdG9yZSk7CiAgICB9KTsKICB9CgogIC8qKgogICAgQG1vZHVsZSBAZW1iZXItZGF0YS9zdG9yZQogICovCgogIC8qKgogICAgQG1ldGhvZCBkaWZmQXJyYXkKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0FycmF5fSBvbGRBcnJheSB0aGUgb2xkIGFycmF5CiAgICBAcGFyYW0ge0FycmF5fSBuZXdBcnJheSB0aGUgbmV3IGFycmF5CiAgICBAcmV0dXJuIHtoYXNofSB7CiAgICAgICAgZmlyc3RDaGFuZ2VJbmRleDogPGludGVnZXI+LCAgLy8gbnVsbCBpZiBubyBjaGFuZ2UKICAgICAgICBhZGRlZENvdW50OiA8aW50ZWdlcj4sICAgICAgICAvLyAwIGlmIG5vIGNoYW5nZQogICAgICAgIHJlbW92ZWRDb3VudDogPGludGVnZXI+ICAgICAgIC8vIDAgaWYgbm8gY2hhbmdlCiAgICAgIH0KICAqLwogIGZ1bmN0aW9uIGRpZmZBcnJheShvbGRBcnJheSwgbmV3QXJyYXkpIHsKICAgIHZhciBvbGRMZW5ndGggPSBvbGRBcnJheS5sZW5ndGg7CiAgICB2YXIgbmV3TGVuZ3RoID0gbmV3QXJyYXkubGVuZ3RoOwogICAgdmFyIHNob3J0ZXN0TGVuZ3RoID0gTWF0aC5taW4ob2xkTGVuZ3RoLCBuZXdMZW5ndGgpOwogICAgdmFyIGZpcnN0Q2hhbmdlSW5kZXggPSBudWxsOyAvLyBudWxsIHNpZ25pZmllcyBubyBjaGFuZ2VzCiAgICAvLyBmaW5kIHRoZSBmaXJzdCBjaGFuZ2UKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNob3J0ZXN0TGVuZ3RoOyBpKyspIHsKICAgICAgLy8gY29tcGFyZSBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5CiAgICAgIGlmIChvbGRBcnJheVtpXSAhPT0gbmV3QXJyYXlbaV0pIHsKICAgICAgICBmaXJzdENoYW5nZUluZGV4ID0gaTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQoKICAgIGlmIChmaXJzdENoYW5nZUluZGV4ID09PSBudWxsICYmIG5ld0xlbmd0aCAhPT0gb2xkTGVuZ3RoKSB7CiAgICAgIC8vIG5vIGNoYW5nZSBmb3VuZCBpbiB0aGUgb3ZlcmxhcHBpbmcgYmxvY2sKICAgICAgLy8gYW5kIGFycmF5IGxlbmd0aHMgZGlmZmVyLAogICAgICAvLyBzbyBjaGFuZ2Ugc3RhcnRzIGF0IGVuZCBvZiBvdmVybGFwCiAgICAgIGZpcnN0Q2hhbmdlSW5kZXggPSBzaG9ydGVzdExlbmd0aDsKICAgIH0KCiAgICB2YXIgYWRkZWRDb3VudCA9IDA7CiAgICB2YXIgcmVtb3ZlZENvdW50ID0gMDsKCiAgICBpZiAoZmlyc3RDaGFuZ2VJbmRleCAhPT0gbnVsbCkgewogICAgICAvLyB3ZSBmb3VuZCBhIGNoYW5nZSwgZmluZCB0aGUgZW5kIG9mIHRoZSBjaGFuZ2UKICAgICAgdmFyIHVuY2hhbmdlZEVuZEJsb2NrTGVuZ3RoID0gc2hvcnRlc3RMZW5ndGggLSBmaXJzdENoYW5nZUluZGV4OyAvLyB3YWxrIGJhY2sgZnJvbSB0aGUgZW5kIG9mIGJvdGggYXJyYXlzIHVudGlsIHdlIGZpbmQgYSBjaGFuZ2UKCiAgICAgIGZvciAodmFyIF9pID0gMTsgX2kgPD0gc2hvcnRlc3RMZW5ndGg7IF9pKyspIHsKICAgICAgICAvLyBjb21wYXJlIGVhY2ggaXRlbSBpbiB0aGUgYXJyYXkKICAgICAgICBpZiAob2xkQXJyYXlbb2xkTGVuZ3RoIC0gX2ldICE9PSBuZXdBcnJheVtuZXdMZW5ndGggLSBfaV0pIHsKICAgICAgICAgIHVuY2hhbmdlZEVuZEJsb2NrTGVuZ3RoID0gX2kgLSAxOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICBhZGRlZENvdW50ID0gbmV3TGVuZ3RoIC0gdW5jaGFuZ2VkRW5kQmxvY2tMZW5ndGggLSBmaXJzdENoYW5nZUluZGV4OwogICAgICByZW1vdmVkQ291bnQgPSBvbGRMZW5ndGggLSB1bmNoYW5nZWRFbmRCbG9ja0xlbmd0aCAtIGZpcnN0Q2hhbmdlSW5kZXg7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgZmlyc3RDaGFuZ2VJbmRleDogZmlyc3RDaGFuZ2VJbmRleCwKICAgICAgYWRkZWRDb3VudDogYWRkZWRDb3VudCwKICAgICAgcmVtb3ZlZENvdW50OiByZW1vdmVkQ291bnQKICAgIH07CiAgfQoKICAvL2ltcG9ydCBFdmVudGVkIGZyb20gJ0BlbWJlci9vYmplY3QvZXZlbnRlZCc7CiAgLyoqCiAgICBBIGBNYW55QXJyYXlgIGlzIGEgYE11dGFibGVBcnJheWAgdGhhdCByZXByZXNlbnRzIHRoZSBjb250ZW50cyBvZiBhIGhhcy1tYW55CiAgICByZWxhdGlvbnNoaXAuCgogICAgVGhlIGBNYW55QXJyYXlgIGlzIGluc3RhbnRpYXRlZCBsYXppbHkgdGhlIGZpcnN0IHRpbWUgdGhlIHJlbGF0aW9uc2hpcCBpcwogICAgcmVxdWVzdGVkLgoKICAgICMjIyBJbnZlcnNlcwoKICAgIE9mdGVuLCB0aGUgcmVsYXRpb25zaGlwcyBpbiBFbWJlciBEYXRhIGFwcGxpY2F0aW9ucyB3aWxsIGhhdmUKICAgIGFuIGludmVyc2UuIEZvciBleGFtcGxlLCBpbWFnaW5lIHRoZSBmb2xsb3dpbmcgbW9kZWxzIGFyZQogICAgZGVmaW5lZDoKCiAgICBgYGBhcHAvbW9kZWxzL3Bvc3QuanMKICAgIGltcG9ydCBNb2RlbCwgeyBoYXNNYW55IH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwoKICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgIGNvbW1lbnRzOiBoYXNNYW55KCdjb21tZW50JykKICAgIH0pOwogICAgYGBgCgogICAgYGBgYXBwL21vZGVscy9jb21tZW50LmpzCiAgICBpbXBvcnQgTW9kZWwsIHsgYmVsb25nc1RvIH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwoKICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgIHBvc3Q6IGJlbG9uZ3NUbygncG9zdCcpCiAgICB9KTsKICAgIGBgYAoKICAgIElmIHlvdSBjcmVhdGVkIGEgbmV3IGluc3RhbmNlIG9mIGBQb3N0YCBhbmQgYWRkZWQKICAgIGEgYENvbW1lbnRgIHJlY29yZCB0byBpdHMgYGNvbW1lbnRzYCBoYXMtbWFueQogICAgcmVsYXRpb25zaGlwLCB5b3Ugd291bGQgZXhwZWN0IHRoZSBjb21tZW50J3MgYHBvc3RgCiAgICBwcm9wZXJ0eSB0byBiZSBzZXQgdG8gdGhlIHBvc3QgdGhhdCBjb250YWluZWQKICAgIHRoZSBoYXMtbWFueS4KCiAgICBXZSBjYWxsIHRoZSByZWNvcmQgdG8gd2hpY2ggYSByZWxhdGlvbnNoaXAgYmVsb25ncy10byB0aGUKICAgIHJlbGF0aW9uc2hpcCdzIF9vd25lcl8uCgogICAgQGNsYXNzIE1hbnlBcnJheQogICAgQGV4dGVuZHMgRW1iZXJPYmplY3QKICAgIEB1c2VzIEVtYmVyLk11dGFibGVBcnJheSwgRW1iZXJEYXRhLkRlcHJlY2F0ZWRFdmVudAogICovCgogIHZhciBNYW55QXJyYXkgPSBFbWJlci5PYmplY3QuZXh0ZW5kKEVtYmVyLk11dGFibGVBcnJheSwgRGVwcmVjYXRlZEV2ZW50ZWQsIHsKICAgIC8vIGhlcmUgdG8gbWFrZSBUUyBoYXBweQogICAgX2ludmVyc2VJc0FzeW5jOiBmYWxzZSwKICAgIGlzTG9hZGVkOiBmYWxzZSwKICAgIGluaXQ6IGZ1bmN0aW9uIGluaXQoKSB7CiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIC8qKgogICAgICBUaGUgbG9hZGluZyBzdGF0ZSBvZiB0aGlzIGFycmF5CiAgICAgICBAcHJvcGVydHkge0Jvb2xlYW59IGlzTG9hZGVkCiAgICAgICovCgoKICAgICAgdGhpcy5pc0xvYWRlZCA9IHRoaXMuaXNMb2FkZWQgfHwgZmFsc2U7CiAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgLyoqCiAgICAgIFVzZWQgZm9yIGFzeW5jIGBoYXNNYW55YCBhcnJheXMKICAgICAgdG8ga2VlcCB0cmFjayBvZiB3aGVuIHRoZXkgd2lsbCByZXNvbHZlLgogICAgICAgQHByb3BlcnR5IHtFbWJlci5SU1ZQLlByb21pc2V9IHByb21pc2UKICAgICAgQHByaXZhdGUKICAgICAgKi8KCiAgICAgIHRoaXMucHJvbWlzZSA9IG51bGw7CiAgICAgIC8qKgogICAgICBNZXRhZGF0YSBhc3NvY2lhdGVkIHdpdGggdGhlIHJlcXVlc3QgZm9yIGFzeW5jIGhhc01hbnkgcmVsYXRpb25zaGlwcy4KICAgICAgIEV4YW1wbGUKICAgICAgIEdpdmVuIHRoYXQgdGhlIHNlcnZlciByZXR1cm5zIHRoZSBmb2xsb3dpbmcgSlNPTiBwYXlsb2FkIHdoZW4gZmV0Y2hpbmcgYQogICAgICBoYXNNYW55IHJlbGF0aW9uc2hpcDoKICAgICAgIGBgYGpzCiAgICAgIHsKICAgICAgICAiY29tbWVudHMiOiBbewogICAgICAgICAgImlkIjogMSwKICAgICAgICAgICJjb21tZW50IjogIlRoaXMgaXMgdGhlIGZpcnN0IGNvbW1lbnQiLAogICAgICAgIH0sIHsKICAgICAgLy8gLi4uCiAgICAgICAgfV0sCiAgICAgICAgICJtZXRhIjogewogICAgICAgICAgInBhZ2UiOiAxLAogICAgICAgICAgInRvdGFsIjogNQogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgIFlvdSBjYW4gdGhlbiBhY2Nlc3MgdGhlIG1ldGFkYXRhIHZpYSB0aGUgYG1ldGFgIHByb3BlcnR5OgogICAgICAgYGBganMKICAgICAgcG9zdC5nZXQoJ2NvbW1lbnRzJykudGhlbihmdW5jdGlvbihjb21tZW50cykgewogICAgICAgIHZhciBtZXRhID0gY29tbWVudHMuZ2V0KCdtZXRhJyk7CiAgICAgICAvLyBtZXRhLnBhZ2UgPT4gMQogICAgICAvLyBtZXRhLnRvdGFsID0+IDUKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQHByb3BlcnR5IHtPYmplY3R9IG1ldGEKICAgICAgQHB1YmxpYwogICAgICAqLwogICAgICAvLyBUT0RPIHRoaXMgaXMgbGlrZWx5IGJyb2tlbiBpbiBvdXIgcmVmYWN0b3IKCiAgICAgIHRoaXMubWV0YSA9IHRoaXMubWV0YSB8fCBudWxsOwogICAgICAvKioKICAgICAgYHRydWVgIGlmIHRoZSByZWxhdGlvbnNoaXAgaXMgcG9seW1vcnBoaWMsIGBmYWxzZWAgb3RoZXJ3aXNlLgogICAgICAgQHByb3BlcnR5IHtCb29sZWFufSBpc1BvbHltb3JwaGljCiAgICAgIEBwcml2YXRlCiAgICAgICovCgogICAgICB0aGlzLmlzUG9seW1vcnBoaWMgPSB0aGlzLmlzUG9seW1vcnBoaWMgfHwgZmFsc2U7CiAgICAgIC8qKgogICAgICBUaGUgcmVsYXRpb25zaGlwIHdoaWNoIG1hbmFnZXMgdGhpcyBhcnJheS4KICAgICAgIEBwcm9wZXJ0eSB7TWFueVJlbGF0aW9uc2hpcH0gcmVsYXRpb25zaGlwCiAgICAgIEBwcml2YXRlCiAgICAgICovCgogICAgICB0aGlzLmN1cnJlbnRTdGF0ZSA9IFtdOwogICAgICB0aGlzLmZsdXNoQ2Fub25pY2FsKHRoaXMuaW5pdGlhbFN0YXRlLCBmYWxzZSk7CiAgICB9LAogICAgLy8gVE9ETzogaWYoREVCVUcpCiAgICBhbnlVbmxvYWRlZDogZnVuY3Rpb24gYW55VW5sb2FkZWQoKSB7CiAgICAgIC8vIFVzZSBgZmlsdGVyWzBdYCBhcyBvcHBvc2VkIHRvIGBmaW5kYCBiZWNhdXNlIG9mIElFMTEKICAgICAgdmFyIHVubG9hZGVkID0gdGhpcy5jdXJyZW50U3RhdGUuZmlsdGVyKGZ1bmN0aW9uIChpbSkgewogICAgICAgIHJldHVybiBpbS5faXNEZW1hdGVyaWFsaXppbmcgfHwgIWltLmlzTG9hZGVkKCk7CiAgICAgIH0pWzBdOwogICAgICByZXR1cm4gISF1bmxvYWRlZDsKICAgIH0sCiAgICByZW1vdmVVbmxvYWRlZEludGVybmFsTW9kZWw6IGZ1bmN0aW9uIHJlbW92ZVVubG9hZGVkSW50ZXJuYWxNb2RlbCgpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmN1cnJlbnRTdGF0ZS5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBpbnRlcm5hbE1vZGVsID0gdGhpcy5jdXJyZW50U3RhdGVbaV07CiAgICAgICAgdmFyIHNob3VsZFJlbW92ZSA9IHZvaWQgMDsKCiAgICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLkNVU1RPTV9NT0RFTF9DTEFTUykgewogICAgICAgICAgc2hvdWxkUmVtb3ZlID0gaW50ZXJuYWxNb2RlbC5faXNEZW1hdGVyaWFsaXppbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNob3VsZFJlbW92ZSA9IGludGVybmFsTW9kZWwuX2lzRGVtYXRlcmlhbGl6aW5nIHx8ICFpbnRlcm5hbE1vZGVsLmlzTG9hZGVkKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlKSB7CiAgICAgICAgICB0aGlzLmFycmF5Q29udGVudFdpbGxDaGFuZ2UoaSwgMSwgMCk7CiAgICAgICAgICB0aGlzLmN1cnJlbnRTdGF0ZS5zcGxpY2UoaSwgMSk7CiAgICAgICAgICB0aGlzLnNldCgnbGVuZ3RoJywgdGhpcy5jdXJyZW50U3RhdGUubGVuZ3RoKTsKICAgICAgICAgIHRoaXMuYXJyYXlDb250ZW50RGlkQ2hhbmdlKGksIDEsIDApOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogICAgb2JqZWN0QXQ6IGZ1bmN0aW9uIG9iamVjdEF0KGluZGV4KSB7CiAgICAgIC8vIFRPRE8gd2UgbGlrZWx5IG5lZWQgdG8gZm9yY2UgZmx1c2ggaGVyZQoKICAgICAgLyoKICAgICAgaWYgKHRoaXMucmVsYXRpb25zaGlwLl93aWxsVXBkYXRlTWFueUFycmF5KSB7CiAgICAgICAgdGhpcy5yZWxhdGlvbnNoaXAuX2ZsdXNoUGVuZGluZ01hbnlBcnJheVVwZGF0ZXMoKTsKICAgICAgfQogICAgICAqLwogICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IHRoaXMuY3VycmVudFN0YXRlW2luZGV4XTsKCiAgICAgIGlmIChpbnRlcm5hbE1vZGVsID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsLmdldFJlY29yZCgpOwogICAgfSwKICAgIGZsdXNoQ2Fub25pY2FsOiBmdW5jdGlvbiBmbHVzaENhbm9uaWNhbCh0b1NldCwgaXNJbml0aWFsaXplZCkgewogICAgICBpZiAoaXNJbml0aWFsaXplZCA9PT0gdm9pZCAwKSB7CiAgICAgICAgaXNJbml0aWFsaXplZCA9IHRydWU7CiAgICAgIH0KCiAgICAgIC8vIEl04oCZcyBwb3NzaWJsZSB0aGUgcGFyZW50IHNpZGUgb2YgdGhlIHJlbGF0aW9uc2hpcCBtYXkgaGF2ZSBiZWVuIHVubG9hZGVkIGJ5IHRoaXMgcG9pbnQKICAgICAgaWYgKCFfb2JqZWN0SXNBbGl2ZSh0aGlzKSkgewogICAgICAgIHJldHVybjsKICAgICAgfSAvLyBkaWZmIHRvIGZpbmQgY2hhbmdlcwoKCiAgICAgIHZhciBkaWZmID0gZGlmZkFycmF5KHRoaXMuY3VycmVudFN0YXRlLCB0b1NldCk7CgogICAgICBpZiAoZGlmZi5maXJzdENoYW5nZUluZGV4ICE9PSBudWxsKSB7CiAgICAgICAgLy8gaXQncyBudWxsIGlmIG5vIGNoYW5nZSBmb3VuZAogICAgICAgIC8vIHdlIGZvdW5kIGEgY2hhbmdlCiAgICAgICAgdGhpcy5hcnJheUNvbnRlbnRXaWxsQ2hhbmdlKGRpZmYuZmlyc3RDaGFuZ2VJbmRleCwgZGlmZi5yZW1vdmVkQ291bnQsIGRpZmYuYWRkZWRDb3VudCk7CiAgICAgICAgdGhpcy5zZXQoJ2xlbmd0aCcsIHRvU2V0Lmxlbmd0aCk7CiAgICAgICAgdGhpcy5jdXJyZW50U3RhdGUgPSB0b1NldC5zbGljZSgpOwogICAgICAgIHRoaXMuYXJyYXlDb250ZW50RGlkQ2hhbmdlKGRpZmYuZmlyc3RDaGFuZ2VJbmRleCwgZGlmZi5yZW1vdmVkQ291bnQsIGRpZmYuYWRkZWRDb3VudCk7CgogICAgICAgIGlmIChpc0luaXRpYWxpemVkICYmIGRpZmYuYWRkZWRDb3VudCA+IDApIHsKICAgICAgICAgIC8vbm90aWZ5IG9ubHkgb24gYWRkaXRpb25zCiAgICAgICAgICAvL1RPRE8gb25seSBub3RpZnkgaWYgdW5sb2FkZWQKICAgICAgICAgIHRoaXMuaW50ZXJuYWxNb2RlbC5tYW55QXJyYXlSZWNvcmRBZGRlZCh0aGlzLmdldCgna2V5JykpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHJlcGxhY2U6IGZ1bmN0aW9uIHJlcGxhY2UoaWR4LCBhbXQsIG9iamVjdHMpIHsKICAgICAgdmFyIGludGVybmFsTW9kZWxzOwoKICAgICAgaWYgKGFtdCA+IDApIHsKICAgICAgICBpbnRlcm5hbE1vZGVscyA9IHRoaXMuY3VycmVudFN0YXRlLnNsaWNlKGlkeCwgaWR4ICsgYW10KTsKICAgICAgICB0aGlzLmdldCgncmVjb3JkRGF0YScpLnJlbW92ZUZyb21IYXNNYW55KHRoaXMuZ2V0KCdrZXknKSwgaW50ZXJuYWxNb2RlbHMubWFwKGZ1bmN0aW9uIChpbSkgewogICAgICAgICAgcmV0dXJuIHJlY29yZERhdGFGb3IoaW0pOwogICAgICAgIH0pKTsKICAgICAgfQoKICAgICAgaWYgKG9iamVjdHMpIHsKICAgICAgICB0aGlzLmdldCgncmVjb3JkRGF0YScpLmFkZFRvSGFzTWFueSh0aGlzLmdldCgna2V5JyksIG9iamVjdHMubWFwKGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgIHJldHVybiByZWNvcmREYXRhRm9yKG9iaik7CiAgICAgICAgfSksIGlkeCk7CiAgICAgIH0KCiAgICAgIHRoaXMucmV0cmlldmVMYXRlc3QoKTsKICAgIH0sCiAgICAvLyBPayB0aGlzIGlzIGtpbmRhIGZ1bmt5IGJlY2F1c2UgaWYgYnVnZ3kgd2UgbWlnaHQgbG9zZSBwb3NpdGlvbnMsIGV0Yy4KICAgIC8vIGJ1dCBjdXJyZW50IGNvZGUgaXMgdGhpcyB3YXkgc28gc2hvdWxkbid0IGJlIHRvbyBiaWcgb2YgYSBwcm9ibGVtCiAgICByZXRyaWV2ZUxhdGVzdDogZnVuY3Rpb24gcmV0cmlldmVMYXRlc3QoKSB7CiAgICAgIHZhciBqc29uQXBpID0gdGhpcy5nZXQoJ3JlY29yZERhdGEnKS5nZXRIYXNNYW55KHRoaXMuZ2V0KCdrZXknKSk7IC8vIFRPRE8gdGhpcyBpcyBvZGQsIHdoeSBzaG91bGQgTWFueUFycmF5IGV2ZXIgdGVsbCBpdHNlbGYgdG8gcmVzeW5jPwoKICAgICAgdmFyIGludGVybmFsTW9kZWxzID0gdGhpcy5zdG9yZS5fZ2V0SGFzTWFueUJ5SnNvbkFwaVJlc291cmNlKGpzb25BcGkpOwoKICAgICAgaWYgKGpzb25BcGkubWV0YSkgewogICAgICAgIHRoaXMuc2V0KCdtZXRhJywganNvbkFwaS5tZXRhKTsKICAgICAgfQoKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLkZVTExfTElOS1NfT05fUkVMQVRJT05TSElQUykgewogICAgICAgIGlmIChqc29uQXBpLmxpbmtzKSB7CiAgICAgICAgICB0aGlzLnNldCgnbGlua3MnLCBqc29uQXBpLmxpbmtzKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuZmx1c2hDYW5vbmljYWwoaW50ZXJuYWxNb2RlbHMsIHRydWUpOwogICAgfSwKCiAgICAvKioKICAgICAgUmVsb2FkcyBhbGwgb2YgdGhlIHJlY29yZHMgaW4gdGhlIG1hbnlBcnJheS4gSWYgdGhlIG1hbnlBcnJheQogICAgICBob2xkcyBhIHJlbGF0aW9uc2hpcCB0aGF0IHdhcyBvcmlnaW5hbGx5IGZldGNoZWQgdXNpbmcgYSBsaW5rcyB1cmwKICAgICAgRW1iZXIgRGF0YSB3aWxsIHJldmlzaXQgdGhlIG9yaWdpbmFsIGxpbmtzIHVybCB0byByZXBvcHVsYXRlIHRoZQogICAgICByZWxhdGlvbnNoaXAuCiAgICAgICBJZiB0aGUgbWFueUFycmF5IGhvbGRzIHRoZSByZXN1bHQgb2YgYSBgc3RvcmUucXVlcnkoKWAgcmVsb2FkIHdpbGwKICAgICAgcmUtcnVuIHRoZSBvcmlnaW5hbCBxdWVyeS4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgdmFyIHVzZXIgPSBzdG9yZS5wZWVrUmVjb3JkKCd1c2VyJywgMSkKICAgICAgdXNlci5sb2dpbigpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgdXNlci5nZXQoJ3Blcm1pc3Npb25zJykudGhlbihmdW5jdGlvbihwZXJtaXNzaW9ucykgewogICAgICAgICAgcmV0dXJuIHBlcm1pc3Npb25zLnJlbG9hZCgpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHJlbG9hZAogICAgICBAcHVibGljCiAgICAqLwogICAgcmVsb2FkOiBmdW5jdGlvbiByZWxvYWQob3B0aW9ucykgewogICAgICAvLyBUT0RPIHRoaXMgaXMgb2RkLCB3ZSBkb24ndCBhc2sgdGhlIHN0b3JlIGZvciBhbnl0aGluZyBlbHNlIGxpa2UgdGhpcz8KICAgICAgcmV0dXJuIHRoaXMuZ2V0KCdzdG9yZScpLnJlbG9hZE1hbnlBcnJheSh0aGlzLCB0aGlzLmdldCgnaW50ZXJuYWxNb2RlbCcpLCB0aGlzLmdldCgna2V5JyksIG9wdGlvbnMpOwogICAgfSwKCiAgICAvKioKICAgICAgU2F2ZXMgYWxsIG9mIHRoZSByZWNvcmRzIGluIHRoZSBgTWFueUFycmF5YC4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgc3RvcmUuZmluZFJlY29yZCgnaW5ib3gnLCAxKS50aGVuKGZ1bmN0aW9uKGluYm94KSB7CiAgICAgICAgaW5ib3guZ2V0KCdtZXNzYWdlcycpLnRoZW4oZnVuY3Rpb24obWVzc2FnZXMpIHsKICAgICAgICAgIG1lc3NhZ2VzLmZvckVhY2goZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICBtZXNzYWdlLnNldCgnaXNSZWFkJywgdHJ1ZSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIG1lc3NhZ2VzLnNhdmUoKQogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHNhdmUKICAgICAgQHJldHVybiB7UHJvbWlzZUFycmF5fSBwcm9taXNlCiAgICAqLwogICAgc2F2ZTogZnVuY3Rpb24gc2F2ZSgpIHsKICAgICAgdmFyIG1hbnlBcnJheSA9IHRoaXM7CiAgICAgIHZhciBwcm9taXNlTGFiZWwgPSAnRFM6IE1hbnlBcnJheSNzYXZlICcgKyBFbWJlci5nZXQodGhpcywgJ3R5cGUnKTsKICAgICAgdmFyIHByb21pc2UgPSBFbWJlci5SU1ZQLmFsbCh0aGlzLmludm9rZSgnc2F2ZScpLCBwcm9taXNlTGFiZWwpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBtYW55QXJyYXk7CiAgICAgIH0sIG51bGwsICdEUzogTWFueUFycmF5I3NhdmUgcmV0dXJuIE1hbnlBcnJheScpOwogICAgICByZXR1cm4gUHJvbWlzZUFycmF5LmNyZWF0ZSh7CiAgICAgICAgcHJvbWlzZTogcHJvbWlzZQogICAgICB9KTsKICAgIH0sCgogICAgLyoqCiAgICAgIENyZWF0ZSBhIGNoaWxkIHJlY29yZCB3aXRoaW4gdGhlIG93bmVyCiAgICAgICBAbWV0aG9kIGNyZWF0ZVJlY29yZAogICAgICBAcHJpdmF0ZQogICAgICBAcGFyYW0ge09iamVjdH0gaGFzaAogICAgICBAcmV0dXJuIHtNb2RlbH0gcmVjb3JkCiAgICAqLwogICAgY3JlYXRlUmVjb3JkOiBmdW5jdGlvbiBjcmVhdGVSZWNvcmQoaGFzaCkgewogICAgICB2YXIgc3RvcmUgPSBFbWJlci5nZXQodGhpcywgJ3N0b3JlJyk7CiAgICAgIHZhciB0eXBlID0gRW1iZXIuZ2V0KHRoaXMsICd0eXBlJyk7CiAgICAgIHZhciByZWNvcmQgPSBzdG9yZS5jcmVhdGVSZWNvcmQodHlwZS5tb2RlbE5hbWUsIGhhc2gpOwogICAgICB0aGlzLnB1c2hPYmplY3QocmVjb3JkKTsKICAgICAgcmV0dXJuIHJlY29yZDsKICAgIH0KICB9KTsKCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL3N0b3JlCiAgKi8KICB2YXIgU09VUkNFX1BPSU5URVJfUkVHRVhQID0gL15cLz9kYXRhXC8oYXR0cmlidXRlc3xyZWxhdGlvbnNoaXBzKVwvKC4qKS87CiAgdmFyIFNPVVJDRV9QT0lOVEVSX1BSSU1BUllfUkVHRVhQID0gL15cLz9kYXRhLzsKICB2YXIgUFJJTUFSWV9BVFRSSUJVVEVfS0VZID0gJ2Jhc2UnOwogIC8qKgogICAgQ29udmVydCBhbiBoYXNoIG9mIGVycm9ycyBpbnRvIGFuIGFycmF5IHdpdGggZXJyb3JzIGluIEpTT04tQVBJIGZvcm1hdC4KICAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgY29uc3QgeyBlcnJvcnNIYXNoVG9BcnJheSB9ID0gRFM7CiAgICAgbGV0IGVycm9ycyA9IHsKICAgICAgYmFzZTogJ0ludmFsaWQgYXR0cmlidXRlcyBvbiBzYXZpbmcgdGhpcyByZWNvcmQnLAogICAgICBuYW1lOiAnTXVzdCBiZSBwcmVzZW50JywKICAgICAgYWdlOiBbJ011c3QgYmUgcHJlc2VudCcsICdNdXN0IGJlIGEgbnVtYmVyJ10KICAgIH07CiAgICAgbGV0IGVycm9yc0FycmF5ID0gZXJyb3JzSGFzaFRvQXJyYXkoZXJyb3JzKTsKICAgIC8vIFsKICAgIC8vICAgewogICAgLy8gICAgIHRpdGxlOiAiSW52YWxpZCBEb2N1bWVudCIsCiAgICAvLyAgICAgZGV0YWlsOiAiSW52YWxpZCBhdHRyaWJ1dGVzIG9uIHNhdmluZyB0aGlzIHJlY29yZCIsCiAgICAvLyAgICAgc291cmNlOiB7IHBvaW50ZXI6ICIvZGF0YSIgfQogICAgLy8gICB9LAogICAgLy8gICB7CiAgICAvLyAgICAgdGl0bGU6ICJJbnZhbGlkIEF0dHJpYnV0ZSIsCiAgICAvLyAgICAgZGV0YWlsOiAiTXVzdCBiZSBwcmVzZW50IiwKICAgIC8vICAgICBzb3VyY2U6IHsgcG9pbnRlcjogIi9kYXRhL2F0dHJpYnV0ZXMvbmFtZSIgfQogICAgLy8gICB9LAogICAgLy8gICB7CiAgICAvLyAgICAgdGl0bGU6ICJJbnZhbGlkIEF0dHJpYnV0ZSIsCiAgICAvLyAgICAgZGV0YWlsOiAiTXVzdCBiZSBwcmVzZW50IiwKICAgIC8vICAgICBzb3VyY2U6IHsgcG9pbnRlcjogIi9kYXRhL2F0dHJpYnV0ZXMvYWdlIiB9CiAgICAvLyAgIH0sCiAgICAvLyAgIHsKICAgIC8vICAgICB0aXRsZTogIkludmFsaWQgQXR0cmlidXRlIiwKICAgIC8vICAgICBkZXRhaWw6ICJNdXN0IGJlIGEgbnVtYmVyIiwKICAgIC8vICAgICBzb3VyY2U6IHsgcG9pbnRlcjogIi9kYXRhL2F0dHJpYnV0ZXMvYWdlIiB9CiAgICAvLyAgIH0KICAgIC8vIF0KICAgIGBgYAogICAgQG1ldGhvZCBlcnJvcnNIYXNoVG9BcnJheQogICAgQHB1YmxpYwogICAgQHBhcmFtIHtPYmplY3R9IGVycm9ycyBoYXNoIHdpdGggZXJyb3JzIGFzIHByb3BlcnRpZXMKICAgIEByZXR1cm4ge0FycmF5fSBhcnJheSBvZiBlcnJvcnMgaW4gSlNPTi1BUEkgZm9ybWF0CiAgKi8KCiAgZnVuY3Rpb24gZXJyb3JzSGFzaFRvQXJyYXkoZXJyb3JzKSB7CiAgICB2YXIgb3V0ID0gW107CgogICAgaWYgKEVtYmVyLmlzUHJlc2VudChlcnJvcnMpKSB7CiAgICAgIE9iamVjdC5rZXlzKGVycm9ycykuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgdmFyIG1lc3NhZ2VzID0gRW1iZXIubWFrZUFycmF5KGVycm9yc1trZXldKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZXNzYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIHRpdGxlID0gJ0ludmFsaWQgQXR0cmlidXRlJzsKICAgICAgICAgIHZhciBwb2ludGVyID0gIi9kYXRhL2F0dHJpYnV0ZXMvIiArIGtleTsKCiAgICAgICAgICBpZiAoa2V5ID09PSBQUklNQVJZX0FUVFJJQlVURV9LRVkpIHsKICAgICAgICAgICAgdGl0bGUgPSAnSW52YWxpZCBEb2N1bWVudCc7CiAgICAgICAgICAgIHBvaW50ZXIgPSAiL2RhdGEiOwogICAgICAgICAgfQoKICAgICAgICAgIG91dC5wdXNoKHsKICAgICAgICAgICAgdGl0bGU6IHRpdGxlLAogICAgICAgICAgICBkZXRhaWw6IG1lc3NhZ2VzW2ldLAogICAgICAgICAgICBzb3VyY2U6IHsKICAgICAgICAgICAgICBwb2ludGVyOiBwb2ludGVyCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIG91dDsKICB9CiAgLyoqCiAgICBDb252ZXJ0IGFuIGFycmF5IG9mIGVycm9ycyBpbiBKU09OLUFQSSBmb3JtYXQgaW50byBhbiBvYmplY3QuCgogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwoKICAgIGNvbnN0IHsgZXJyb3JzQXJyYXlUb0hhc2ggfSA9IERTOwoKICAgIGxldCBlcnJvcnNBcnJheSA9IFsKICAgICAgewogICAgICAgIHRpdGxlOiAnSW52YWxpZCBBdHRyaWJ1dGUnLAogICAgICAgIGRldGFpbDogJ011c3QgYmUgcHJlc2VudCcsCiAgICAgICAgc291cmNlOiB7IHBvaW50ZXI6ICcvZGF0YS9hdHRyaWJ1dGVzL25hbWUnIH0KICAgICAgfSwKICAgICAgewogICAgICAgIHRpdGxlOiAnSW52YWxpZCBBdHRyaWJ1dGUnLAogICAgICAgIGRldGFpbDogJ011c3QgYmUgcHJlc2VudCcsCiAgICAgICAgc291cmNlOiB7IHBvaW50ZXI6ICcvZGF0YS9hdHRyaWJ1dGVzL2FnZScgfQogICAgICB9LAogICAgICB7CiAgICAgICAgdGl0bGU6ICdJbnZhbGlkIEF0dHJpYnV0ZScsCiAgICAgICAgZGV0YWlsOiAnTXVzdCBiZSBhIG51bWJlcicsCiAgICAgICAgc291cmNlOiB7IHBvaW50ZXI6ICcvZGF0YS9hdHRyaWJ1dGVzL2FnZScgfQogICAgICB9CiAgICBdOwoKICAgIGxldCBlcnJvcnMgPSBlcnJvcnNBcnJheVRvSGFzaChlcnJvcnNBcnJheSk7CiAgICAvLyB7CiAgICAvLyAgICJuYW1lIjogWyJNdXN0IGJlIHByZXNlbnQiXSwKICAgIC8vICAgImFnZSI6ICBbIk11c3QgYmUgcHJlc2VudCIsICJtdXN0IGJlIGEgbnVtYmVyIl0KICAgIC8vIH0KICAgIGBgYAoKICAgIEBtZXRob2QgZXJyb3JzQXJyYXlUb0hhc2gKICAgIEBwdWJsaWMKICAgIEBwYXJhbSB7QXJyYXl9IGVycm9ycyBhcnJheSBvZiBlcnJvcnMgaW4gSlNPTi1BUEkgZm9ybWF0CiAgICBAcmV0dXJuIHtPYmplY3R9CiAgKi8KCiAgZnVuY3Rpb24gZXJyb3JzQXJyYXlUb0hhc2goZXJyb3JzKSB7CiAgICB2YXIgb3V0ID0ge307CgogICAgaWYgKEVtYmVyLmlzUHJlc2VudChlcnJvcnMpKSB7CiAgICAgIGVycm9ycy5mb3JFYWNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgIGlmIChlcnJvci5zb3VyY2UgJiYgZXJyb3Iuc291cmNlLnBvaW50ZXIpIHsKICAgICAgICAgIHZhciBrZXkgPSBlcnJvci5zb3VyY2UucG9pbnRlci5tYXRjaChTT1VSQ0VfUE9JTlRFUl9SRUdFWFApOwoKICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAga2V5ID0ga2V5WzJdOwogICAgICAgICAgfSBlbHNlIGlmIChlcnJvci5zb3VyY2UucG9pbnRlci5zZWFyY2goU09VUkNFX1BPSU5URVJfUFJJTUFSWV9SRUdFWFApICE9PSAtMSkgewogICAgICAgICAgICBrZXkgPSBQUklNQVJZX0FUVFJJQlVURV9LRVk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICBvdXRba2V5XSA9IG91dFtrZXldIHx8IFtdOwogICAgICAgICAgICBvdXRba2V5XS5wdXNoKGVycm9yLmRldGFpbCB8fCBlcnJvci50aXRsZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4gb3V0OwogIH0KCiAgZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXMkMSh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKICBmdW5jdGlvbiBfY3JlYXRlQ2xhc3MkMShDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzJDEoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyQxKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyLWRhdGEvc3RvcmUKICAqLwoKICAvKioKICAgIEBjbGFzcyBTbmFwc2hvdFJlY29yZEFycmF5CiAgICBAcHJpdmF0ZQogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge0FycmF5fSBzbmFwc2hvdHMgQW4gYXJyYXkgb2Ygc25hcHNob3RzCiAgICBAcGFyYW0ge09iamVjdH0gbWV0YQogICovCiAgdmFyIFNuYXBzaG90UmVjb3JkQXJyYXkgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBTbmFwc2hvdFJlY29yZEFycmF5KHJlY29yZEFycmF5LCBtZXRhLCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIC8qKgogICAgICAgIEFuIGFycmF5IG9mIHNuYXBzaG90cwogICAgICAgIEBwcml2YXRlCiAgICAgICAgQHByb3BlcnR5IF9zbmFwc2hvdHMKICAgICAgICBAdHlwZSB7QXJyYXl9CiAgICAgICovCiAgICAgIHRoaXMuX3NuYXBzaG90cyA9IG51bGw7CiAgICAgIC8qKgogICAgICAgIEFuIGFycmF5IG9mIHJlY29yZHMKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwcm9wZXJ0eSBfcmVjb3JkQXJyYXkKICAgICAgICBAdHlwZSB7QXJyYXl9CiAgICAgICovCgogICAgICB0aGlzLl9yZWNvcmRBcnJheSA9IHJlY29yZEFycmF5OwogICAgICAvKioKICAgICAgICBOdW1iZXIgb2YgcmVjb3JkcyBpbiB0aGUgYXJyYXkKICAgICAgICAgRXhhbXBsZQogICAgICAgICBgYGBhcHAvYWRhcHRlcnMvcG9zdC5qcwogICAgICAgIGltcG9ydCBKU09OQVBJQWRhcHRlciBmcm9tICdAZW1iZXItZGF0YS9hZGFwdGVyL2pzb24tYXBpJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgSlNPTkFQSUFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICAgIHNob3VsZFJlbG9hZEFsbChzdG9yZSwgc25hcHNob3RSZWNvcmRBcnJheSkgewogICAgICAgICAgICByZXR1cm4gIXNuYXBzaG90UmVjb3JkQXJyYXkubGVuZ3RoOwogICAgICAgICAgfSwKICAgICAgICB9KTsKICAgICAgICBgYGAKICAgICAgICAgQHByb3BlcnR5IGxlbmd0aAogICAgICAgIEB0eXBlIHtOdW1iZXJ9CiAgICAgICovCgogICAgICB0aGlzLmxlbmd0aCA9IHJlY29yZEFycmF5LmdldCgnbGVuZ3RoJyk7CiAgICAgIHRoaXMuX3R5cGUgPSBudWxsOwogICAgICAvKioKICAgICAgICBNZXRhIG9iamVjdHMgZm9yIHRoZSByZWNvcmQgYXJyYXkuCiAgICAgICAgIEV4YW1wbGUKICAgICAgICAgYGBgYXBwL2FkYXB0ZXJzL3Bvc3QuanMKICAgICAgICBpbXBvcnQgSlNPTkFQSUFkYXB0ZXIgZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlci9qc29uLWFwaSc7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IEpTT05BUElBZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgICBzaG91bGRSZWxvYWRBbGwoc3RvcmUsIHNuYXBzaG90UmVjb3JkQXJyYXkpIHsKICAgICAgICAgICAgdmFyIGxhc3RSZXF1ZXN0VGltZSA9IHNuYXBzaG90UmVjb3JkQXJyYXkubWV0YS5sYXN0UmVxdWVzdFRpbWU7CiAgICAgICAgICAgIHZhciB0d2VudHlNaW51dGVzID0gMjAgKiA2MCAqIDEwMDA7CiAgICAgICAgICAgIHJldHVybiBEYXRlLm5vdygpID4gbGFzdFJlcXVlc3RUaW1lICsgdHdlbnR5TWludXRlczsKICAgICAgICAgIH0sCiAgICAgICAgfSk7CiAgICAgICAgYGBgCiAgICAgICAgIEBwcm9wZXJ0eSBtZXRhCiAgICAgICAgQHR5cGUge09iamVjdH0KICAgICAgKi8KCiAgICAgIHRoaXMubWV0YSA9IG1ldGE7CiAgICAgIC8qKgogICAgICAgIEEgaGFzaCBvZiBhZGFwdGVyIG9wdGlvbnMgcGFzc2VkIGludG8gdGhlIHN0b3JlIG1ldGhvZCBmb3IgdGhpcyByZXF1ZXN0LgogICAgICAgICBFeGFtcGxlCiAgICAgICAgIGBgYGFwcC9hZGFwdGVycy9wb3N0LmpzCiAgICAgICAgaW1wb3J0IE15Q3VzdG9tQWRhcHRlciBmcm9tICcuL2N1c3RvbS1hZGFwdGVyJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgTXlDdXN0b21BZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgICBmaW5kQWxsKHN0b3JlLCB0eXBlLCBzaW5jZVRva2VuLCBzbmFwc2hvdFJlY29yZEFycmF5KSB7CiAgICAgICAgICAgIGlmIChzbmFwc2hvdFJlY29yZEFycmF5LmFkYXB0ZXJPcHRpb25zLnN1YnNjcmliZSkgewogICAgICAgICAgICAgIC8vIC4uLgogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIC4uLgogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGBgYAogICAgICAgICBAcHJvcGVydHkgYWRhcHRlck9wdGlvbnMKICAgICAgICBAdHlwZSB7T2JqZWN0fQogICAgICAqLwoKICAgICAgdGhpcy5hZGFwdGVyT3B0aW9ucyA9IG9wdGlvbnMuYWRhcHRlck9wdGlvbnM7CiAgICAgIC8qKgogICAgICAgIFRoZSByZWxhdGlvbnNoaXBzIHRvIGluY2x1ZGUgZm9yIHRoaXMgcmVxdWVzdC4KICAgICAgICAgRXhhbXBsZQogICAgICAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgICAgICBpbXBvcnQgQWRhcHRlciBmcm9tICdAZW1iZXItZGF0YS9hZGFwdGVyJzsKICAgICAgICAgZXhwb3J0IGRlZmF1bHQgQWRhcHRlci5leHRlbmQoewogICAgICAgICAgZmluZEFsbChzdG9yZSwgdHlwZSwgc25hcHNob3RSZWNvcmRBcnJheSkgewogICAgICAgICAgICB2YXIgdXJsID0gYC8ke3R5cGUubW9kZWxOYW1lfT9pbmNsdWRlPSR7ZW5jb2RlVVJJQ29tcG9uZW50KHNuYXBzaG90UmVjb3JkQXJyYXkuaW5jbHVkZSl9YDsKICAgICAgICAgICAgIHJldHVybiBmZXRjaCh1cmwpLnRoZW4oKHJlc3BvbnNlKSA9PiByZXNwb25zZS5qc29uKCkpCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgYGBgCiAgICAgICAgIEBwcm9wZXJ0eSBpbmNsdWRlCiAgICAgICAgQHR5cGUge1N0cmluZ3xBcnJheX0KICAgICAgKi8KCiAgICAgIHRoaXMuaW5jbHVkZSA9IG9wdGlvbnMuaW5jbHVkZTsKICAgIH0KICAgIC8qKgogICAgICBUaGUgdHlwZSBvZiB0aGUgdW5kZXJseWluZyByZWNvcmRzIGZvciB0aGUgc25hcHNob3RzIGluIHRoZSBhcnJheSwgYXMgYSBNb2RlbAogICAgICBAcHJvcGVydHkgdHlwZQogICAgICBAdHlwZSB7TW9kZWx9CiAgICAqLwoKCiAgICB2YXIgX3Byb3RvID0gU25hcHNob3RSZWNvcmRBcnJheS5wcm90b3R5cGU7CgogICAgLyoqCiAgICAgIEdldCBzbmFwc2hvdHMgb2YgdGhlIHVuZGVybHlpbmcgcmVjb3JkIGFycmF5CiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBhcHAvYWRhcHRlcnMvcG9zdC5qcwogICAgICBpbXBvcnQgSlNPTkFQSUFkYXB0ZXIgZnJvbSAnQGVtYmVyLWRhdGEvYWRhcHRlci9qc29uLWFwaSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBKU09OQVBJQWRhcHRlci5leHRlbmQoewogICAgICAgIHNob3VsZFJlbG9hZEFsbChzdG9yZSwgc25hcHNob3RBcnJheSkgewogICAgICAgICAgdmFyIHNuYXBzaG90cyA9IHNuYXBzaG90QXJyYXkuc25hcHNob3RzKCk7CiAgICAgICAgICAgcmV0dXJuIHNuYXBzaG90cy5hbnkoZnVuY3Rpb24odGlja2V0U25hcHNob3QpIHsKICAgICAgICAgICAgdmFyIHRpbWVEaWZmID0gbW9tZW50KCkuZGlmZih0aWNrZXRTbmFwc2hvdC5hdHRyKCdsYXN0QWNjZXNzZWRBdCcpLCAnbWludXRlcycpOwogICAgICAgICAgICBpZiAodGltZURpZmYgPiAyMCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHNuYXBzaG90cwogICAgICBAcmV0dXJuIHtBcnJheX0gQXJyYXkgb2Ygc25hcHNob3RzCiAgICAqLwogICAgX3Byb3RvLnNuYXBzaG90cyA9IGZ1bmN0aW9uIHNuYXBzaG90cygpIHsKICAgICAgaWYgKHRoaXMuX3NuYXBzaG90cyAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiB0aGlzLl9zbmFwc2hvdHM7CiAgICAgIH0KCiAgICAgIHRoaXMuX3NuYXBzaG90cyA9IHRoaXMuX3JlY29yZEFycmF5Ll90YWtlU25hcHNob3QoKTsKICAgICAgcmV0dXJuIHRoaXMuX3NuYXBzaG90czsKICAgIH07CgogICAgX2NyZWF0ZUNsYXNzJDEoU25hcHNob3RSZWNvcmRBcnJheSwgW3sKICAgICAga2V5OiAidHlwZSIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl90eXBlIHx8ICh0aGlzLl90eXBlID0gdGhpcy5fcmVjb3JkQXJyYXkuZ2V0KCd0eXBlJykpOwogICAgICB9CiAgICAgIC8qKgogICAgICAgIFRoZSBtb2RlbE5hbWUgb2YgdGhlIHVuZGVybHlpbmcgcmVjb3JkcyBmb3IgdGhlIHNuYXBzaG90cyBpbiB0aGUgYXJyYXksIGFzIGEgTW9kZWwKICAgICAgICBAcHJvcGVydHkgdHlwZQogICAgICAgIEB0eXBlIHtNb2RlbH0KICAgICAgKi8KCiAgICB9LCB7CiAgICAgIGtleTogIm1vZGVsTmFtZSIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9yZWNvcmRBcnJheS5tb2RlbE5hbWU7CiAgICAgIH0KICAgIH1dKTsKCiAgICByZXR1cm4gU25hcHNob3RSZWNvcmRBcnJheTsKICB9KCk7CgogIC8qKgogICAgQG1vZHVsZSBAZW1iZXItZGF0YS9zdG9yZQogICovCiAgLyoqCiAgICBBIHJlY29yZCBhcnJheSBpcyBhbiBhcnJheSB0aGF0IGNvbnRhaW5zIHJlY29yZHMgb2YgYSBjZXJ0YWluIG1vZGVsTmFtZS4gVGhlIHJlY29yZAogICAgYXJyYXkgbWF0ZXJpYWxpemVzIHJlY29yZHMgYXMgbmVlZGVkIHdoZW4gdGhleSBhcmUgcmV0cmlldmVkIGZvciB0aGUgZmlyc3QKICAgIHRpbWUuIFlvdSBzaG91bGQgbm90IGNyZWF0ZSByZWNvcmQgYXJyYXlzIHlvdXJzZWxmLiBJbnN0ZWFkLCBhbiBpbnN0YW5jZSBvZgogICAgYFJlY29yZEFycmF5YCBvciBpdHMgc3ViY2xhc3NlcyB3aWxsIGJlIHJldHVybmVkIGJ5IHlvdXIgYXBwbGljYXRpb24ncyBzdG9yZQogICAgaW4gcmVzcG9uc2UgdG8gcXVlcmllcy4KCiAgICBAY2xhc3MgUmVjb3JkQXJyYXkKICAgIEBleHRlbmRzIEFycmF5UHJveHkKICAgIEB1c2VzIEVtYmVyLkV2ZW50ZWQKICAqLwoKICB2YXIgUmVjb3JkQXJyYXkgPSBFbWJlci5BcnJheVByb3h5LmV4dGVuZChEZXByZWNhdGVkRXZlbnRlZCwgewogICAgaW5pdDogZnVuY3Rpb24gaW5pdCgpIHsKCiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIC8qKgogICAgICAgIFRoZSBhcnJheSBvZiBjbGllbnQgaWRzIGJhY2tpbmcgdGhlIHJlY29yZCBhcnJheS4gV2hlbiBhCiAgICAgICAgcmVjb3JkIGlzIHJlcXVlc3RlZCBmcm9tIHRoZSByZWNvcmQgYXJyYXksIHRoZSByZWNvcmQKICAgICAgICBmb3IgdGhlIGNsaWVudCBpZCBhdCB0aGUgc2FtZSBpbmRleCBpcyBtYXRlcmlhbGl6ZWQsIGlmCiAgICAgICAgbmVjZXNzYXJ5LCBieSB0aGUgc3RvcmUuCiAgICAgICAgIEBwcm9wZXJ0eSBjb250ZW50CiAgICAgICAgQHByaXZhdGUKICAgICAgICBAdHlwZSBFbWJlci5BcnJheQogICAgICAgICovCgoKICAgICAgdGhpcy5zZXQoJ2NvbnRlbnQnLCB0aGlzLmNvbnRlbnQgfHwgbnVsbCk7CiAgICAgIC8qKgogICAgICBUaGUgZmxhZyB0byBzaWduYWwgYSBgUmVjb3JkQXJyYXlgIGlzIGZpbmlzaGVkIGxvYWRpbmcgZGF0YS4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgdmFyIHBlb3BsZSA9IHN0b3JlLnBlZWtBbGwoJ3BlcnNvbicpOwogICAgICBwZW9wbGUuZ2V0KCdpc0xvYWRlZCcpOyAvLyB0cnVlCiAgICAgIGBgYAogICAgICAgQHByb3BlcnR5IGlzTG9hZGVkCiAgICAgIEB0eXBlIEJvb2xlYW4KICAgICAgKi8KCiAgICAgIHRoaXMuaXNMb2FkZWQgPSB0aGlzLmlzTG9hZGVkIHx8IGZhbHNlOwogICAgICAvKioKICAgICAgVGhlIGZsYWcgdG8gc2lnbmFsIGEgYFJlY29yZEFycmF5YCBpcyBjdXJyZW50bHkgbG9hZGluZyBkYXRhLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgamF2YXNjcmlwdAogICAgICB2YXIgcGVvcGxlID0gc3RvcmUucGVla0FsbCgncGVyc29uJyk7CiAgICAgIHBlb3BsZS5nZXQoJ2lzVXBkYXRpbmcnKTsgLy8gZmFsc2UKICAgICAgcGVvcGxlLnVwZGF0ZSgpOwogICAgICBwZW9wbGUuZ2V0KCdpc1VwZGF0aW5nJyk7IC8vIHRydWUKICAgICAgYGBgCiAgICAgICBAcHJvcGVydHkgaXNVcGRhdGluZwogICAgICBAdHlwZSBCb29sZWFuCiAgICAgICovCgogICAgICB0aGlzLmlzVXBkYXRpbmcgPSBmYWxzZTsKICAgICAgLyoqCiAgICAgIFRoZSBzdG9yZSB0aGF0IGNyZWF0ZWQgdGhpcyByZWNvcmQgYXJyYXkuCiAgICAgICBAcHJvcGVydHkgc3RvcmUKICAgICAgQHByaXZhdGUKICAgICAgQHR5cGUgU3RvcmUKICAgICAgKi8KCiAgICAgIHRoaXMuc3RvcmUgPSB0aGlzLnN0b3JlIHx8IG51bGw7CiAgICAgIHRoaXMuX3VwZGF0aW5nUHJvbWlzZSA9IG51bGw7CiAgICB9LAogICAgcmVwbGFjZTogZnVuY3Rpb24gcmVwbGFjZSgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgcmVzdWx0IG9mIGEgc2VydmVyIHF1ZXJ5IChmb3IgYWxsICIgKyB0aGlzLm1vZGVsTmFtZSArICIgdHlwZXMpIGlzIGltbXV0YWJsZS4gVG8gbW9kaWZ5IGNvbnRlbnRzLCB1c2UgdG9BcnJheSgpIik7CiAgICB9LAoKICAgIC8qKgogICAgIFRoZSBtb2RlbENsYXNzIHJlcHJlc2VudGVkIGJ5IHRoaXMgcmVjb3JkIGFycmF5LgogICAgICBAcHJvcGVydHkgdHlwZQogICAgIEB0eXBlIE1vZGVsCiAgICAgKi8KICAgIHR5cGU6IEVtYmVyLmNvbXB1dGVkKCdtb2RlbE5hbWUnLCBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghdGhpcy5tb2RlbE5hbWUpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuc3RvcmUubW9kZWxGb3IodGhpcy5tb2RlbE5hbWUpOwogICAgfSkucmVhZE9ubHkoKSwKCiAgICAvKioKICAgICAgUmV0cmlldmVzIGFuIG9iamVjdCBmcm9tIHRoZSBjb250ZW50IGJ5IGluZGV4LgogICAgICAgQG1ldGhvZCBvYmplY3RBdENvbnRlbnQKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtOdW1iZXJ9IGluZGV4CiAgICAgIEByZXR1cm4ge01vZGVsfSByZWNvcmQKICAgICovCiAgICBvYmplY3RBdENvbnRlbnQ6IGZ1bmN0aW9uIG9iamVjdEF0Q29udGVudChpbmRleCkgewogICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IEVtYmVyLmdldCh0aGlzLCAnY29udGVudCcpLm9iamVjdEF0KGluZGV4KTsKICAgICAgcmV0dXJuIGludGVybmFsTW9kZWwgJiYgaW50ZXJuYWxNb2RlbC5nZXRSZWNvcmQoKTsKICAgIH0sCgogICAgLyoqCiAgICAgIFVzZWQgdG8gZ2V0IHRoZSBsYXRlc3QgdmVyc2lvbiBvZiBhbGwgb2YgdGhlIHJlY29yZHMgaW4gdGhpcyBhcnJheQogICAgICBmcm9tIHRoZSBhZGFwdGVyLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgamF2YXNjcmlwdAogICAgICB2YXIgcGVvcGxlID0gc3RvcmUucGVla0FsbCgncGVyc29uJyk7CiAgICAgIHBlb3BsZS5nZXQoJ2lzVXBkYXRpbmcnKTsgLy8gZmFsc2UKICAgICAgIHBlb3BsZS51cGRhdGUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgIHBlb3BsZS5nZXQoJ2lzVXBkYXRpbmcnKTsgLy8gZmFsc2UKICAgICAgfSk7CiAgICAgICBwZW9wbGUuZ2V0KCdpc1VwZGF0aW5nJyk7IC8vIHRydWUKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHVwZGF0ZQogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKCkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIGlmIChFbWJlci5nZXQodGhpcywgJ2lzVXBkYXRpbmcnKSkgewogICAgICAgIHJldHVybiB0aGlzLl91cGRhdGluZ1Byb21pc2U7CiAgICAgIH0KCiAgICAgIHRoaXMuc2V0KCdpc1VwZGF0aW5nJywgdHJ1ZSk7CgogICAgICB2YXIgdXBkYXRpbmdQcm9taXNlID0gdGhpcy5fdXBkYXRlKCkuZmluYWxseShmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMyLl91cGRhdGluZ1Byb21pc2UgPSBudWxsOwoKICAgICAgICBpZiAoX3RoaXMyLmdldCgnaXNEZXN0cm95aW5nJykgfHwgX3RoaXMyLmdldCgnaXNEZXN0cm95ZWQnKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgX3RoaXMyLnNldCgnaXNVcGRhdGluZycsIGZhbHNlKTsKICAgICAgfSk7CgogICAgICB0aGlzLl91cGRhdGluZ1Byb21pc2UgPSB1cGRhdGluZ1Byb21pc2U7CiAgICAgIHJldHVybiB1cGRhdGluZ1Byb21pc2U7CiAgICB9LAoKICAgIC8qCiAgICAgIFVwZGF0ZSB0aGlzIFJlY29yZEFycmF5IGFuZCByZXR1cm4gYSBwcm9taXNlIHdoaWNoIHJlc29sdmVzIG9uY2UgdGhlIHVwZGF0ZQogICAgICBpcyBmaW5pc2hlZC4KICAgICAqLwogICAgX3VwZGF0ZTogZnVuY3Rpb24gX3VwZGF0ZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc3RvcmUuZmluZEFsbCh0aGlzLm1vZGVsTmFtZSwgewogICAgICAgIHJlbG9hZDogdHJ1ZQogICAgICB9KTsKICAgIH0sCgogICAgLyoqCiAgICAgIEFkZHMgYW4gaW50ZXJuYWwgbW9kZWwgdG8gdGhlIGBSZWNvcmRBcnJheWAgd2l0aG91dCBkdXBsaWNhdGVzCiAgICAgICBAbWV0aG9kIF9wdXNoSW50ZXJuYWxNb2RlbHMKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtJbnRlcm5hbE1vZGVsfSBpbnRlcm5hbE1vZGVsCiAgICAqLwogICAgX3B1c2hJbnRlcm5hbE1vZGVsczogZnVuY3Rpb24gX3B1c2hJbnRlcm5hbE1vZGVscyhpbnRlcm5hbE1vZGVscykgewogICAgICAvLyBwdXNoT2JqZWN0cyBiZWNhdXNlIHRoZSBpbnRlcm5hbE1vZGVscy5fcmVjb3JkQXJyYXlzIHNldCB3YXMgYWxyZWFkeQogICAgICAvLyBjb25zdWx0ZWQgZm9yIGluY2x1c2lvbiwgc28gYWRkT2JqZWN0IGFuZCBpdHMgb24gLmNvbnRhaW5zIGNhbGwgaXMgbm90CiAgICAgIC8vIHJlcXVpcmVkLgogICAgICBFbWJlci5nZXQodGhpcywgJ2NvbnRlbnQnKS5wdXNoT2JqZWN0cyhpbnRlcm5hbE1vZGVscyk7CiAgICB9LAoKICAgIC8qKgogICAgICBSZW1vdmVzIGFuIGludGVybmFsTW9kZWwgdG8gdGhlIGBSZWNvcmRBcnJheWAuCiAgICAgICBAbWV0aG9kIHJlbW92ZUludGVybmFsTW9kZWwKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtJbnRlcm5hbE1vZGVsfSBpbnRlcm5hbE1vZGVsCiAgICAqLwogICAgX3JlbW92ZUludGVybmFsTW9kZWxzOiBmdW5jdGlvbiBfcmVtb3ZlSW50ZXJuYWxNb2RlbHMoaW50ZXJuYWxNb2RlbHMpIHsKICAgICAgRW1iZXIuZ2V0KHRoaXMsICdjb250ZW50JykucmVtb3ZlT2JqZWN0cyhpbnRlcm5hbE1vZGVscyk7CiAgICB9LAoKICAgIC8qKgogICAgICBTYXZlcyBhbGwgb2YgdGhlIHJlY29yZHMgaW4gdGhlIGBSZWNvcmRBcnJheWAuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHZhciBtZXNzYWdlcyA9IHN0b3JlLnBlZWtBbGwoJ21lc3NhZ2UnKTsKICAgICAgbWVzc2FnZXMuZm9yRWFjaChmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgICAgbWVzc2FnZS5zZXQoJ2hhc0JlZW5TZWVuJywgdHJ1ZSk7CiAgICAgIH0pOwogICAgICBtZXNzYWdlcy5zYXZlKCk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBzYXZlCiAgICAgIEByZXR1cm4ge1Byb21pc2VBcnJheX0gcHJvbWlzZQogICAgKi8KICAgIHNhdmU6IGZ1bmN0aW9uIHNhdmUoKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgdmFyIHByb21pc2VMYWJlbCA9ICJEUzogUmVjb3JkQXJyYXkjc2F2ZSAiICsgdGhpcy5tb2RlbE5hbWU7CiAgICAgIHZhciBwcm9taXNlID0gRW1iZXIuUlNWUC5Qcm9taXNlLmFsbCh0aGlzLmludm9rZSgnc2F2ZScpLCBwcm9taXNlTGFiZWwpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBfdGhpczM7CiAgICAgIH0sIG51bGwsICdEUzogUmVjb3JkQXJyYXkjc2F2ZSByZXR1cm4gUmVjb3JkQXJyYXknKTsKICAgICAgcmV0dXJuIFByb21pc2VBcnJheS5jcmVhdGUoewogICAgICAgIHByb21pc2U6IHByb21pc2UKICAgICAgfSk7CiAgICB9LAogICAgX2Rpc3NvY2lhdGVGcm9tT3duUmVjb3JkczogZnVuY3Rpb24gX2Rpc3NvY2lhdGVGcm9tT3duUmVjb3JkcygpIHsKICAgICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgICB0aGlzLmdldCgnY29udGVudCcpLmZvckVhY2goZnVuY3Rpb24gKGludGVybmFsTW9kZWwpIHsKICAgICAgICB2YXIgcmVjb3JkQXJyYXlzID0gaW50ZXJuYWxNb2RlbC5fX3JlY29yZEFycmF5czsKCiAgICAgICAgaWYgKHJlY29yZEFycmF5cykgewogICAgICAgICAgcmVjb3JkQXJyYXlzLmRlbGV0ZShfdGhpczQpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICBAbWV0aG9kIF91bnJlZ2lzdGVyRnJvbU1hbmFnZXIKICAgICAgQHByaXZhdGUKICAgICovCiAgICBfdW5yZWdpc3RlckZyb21NYW5hZ2VyOiBmdW5jdGlvbiBfdW5yZWdpc3RlckZyb21NYW5hZ2VyKCkgewogICAgICB0aGlzLm1hbmFnZXIudW5yZWdpc3RlclJlY29yZEFycmF5KHRoaXMpOwogICAgfSwKICAgIHdpbGxEZXN0cm95OiBmdW5jdGlvbiB3aWxsRGVzdHJveSgpIHsKICAgICAgdGhpcy5fdW5yZWdpc3RlckZyb21NYW5hZ2VyKCk7CgogICAgICB0aGlzLl9kaXNzb2NpYXRlRnJvbU93blJlY29yZHMoKTsgLy8gVE9ETzogd2Ugc2hvdWxkIG5vdCBkbyB3b3JrIGR1cmluZyBkZXN0cm95OgogICAgICAvLyAgICogd2hlbiBvYmplY3RzIGFyZSBkZXN0cm95ZWQsIHRoZXkgc2hvdWxkIHNpbXBseSBiZSBsZWZ0IHRvIGRvCiAgICAgIC8vICAgKiBpZiBsb2dpYyBlcnJvcnMgZG8gdG8gdGhpcywgdGhhdCBsb2dpYyBuZWVkcyB0byBiZSBtb3JlIGNhcmVmdWwgZHVyaW5nCiAgICAgIC8vICAgIHRlYXJkb3duIChlbWJlciBwcm92aWRlcyBpc0Rlc3Ryb3lpbmcvaXNEZXN0cm95ZWQpIGZvciB0aGlzIHJlYXNvbgogICAgICAvLyAgICogdGhlIGV4Y2VwdGlvbiBiZWluZzogaWYgYW4gZG9taW5hdG9yIGhhcyBhIHJlZmVyZW5jZSB0byB0aGlzIG9iamVjdCwKICAgICAgLy8gICAgIGFuZCBtdXN0IGJlIGluZm9ybWVkIHRvIHJlbGVhc2UgZS5nLiBlLmcuIHJlbW92aW5nIGl0c2VsZiBmcm9tIHRoCiAgICAgIC8vICAgICByZWNvcmRBcnJheU1hbmFuZ2VyCgoKICAgICAgRW1iZXIuc2V0KHRoaXMsICdjb250ZW50JywgbnVsbCk7CiAgICAgIEVtYmVyLnNldCh0aGlzLCAnbGVuZ3RoJywgMCk7CgogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvKgogICAgICBAbWV0aG9kIF9jcmVhdGVTbmFwc2hvdAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9jcmVhdGVTbmFwc2hvdDogZnVuY3Rpb24gX2NyZWF0ZVNuYXBzaG90KG9wdGlvbnMpIHsKICAgICAgLy8gdGhpcyBpcyBwcml2YXRlIGZvciB1c2VycywgYnV0IHB1YmxpYyBmb3IgZW1iZXItZGF0YSBpbnRlcm5hbHMKICAgICAgcmV0dXJuIG5ldyBTbmFwc2hvdFJlY29yZEFycmF5KHRoaXMsIHRoaXMuZ2V0KCdtZXRhJyksIG9wdGlvbnMpOwogICAgfSwKCiAgICAvKgogICAgICBAbWV0aG9kIF90YWtlU25hcHNob3QKICAgICAgQHByaXZhdGUKICAgICovCiAgICBfdGFrZVNuYXBzaG90OiBmdW5jdGlvbiBfdGFrZVNuYXBzaG90KCkgewogICAgICByZXR1cm4gRW1iZXIuZ2V0KHRoaXMsICdjb250ZW50JykubWFwKGZ1bmN0aW9uIChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgcmV0dXJuIGludGVybmFsTW9kZWwuY3JlYXRlU25hcHNob3QoKTsKICAgICAgfSk7CiAgICB9CiAgfSk7CgogIGZ1bmN0aW9uIGlzUmVzb3VyY2VJZGVudGlmZXJXaXRoUmVsYXRlZExpbmtzKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgJiYgdmFsdWUubGlua3MgJiYgdmFsdWUubGlua3MucmVsYXRlZDsKICB9CiAgLyoqCiAgICBUaGlzIGlzIHRoZSBiYXNlQ2xhc3MgZm9yIHRoZSBkaWZmZXJlbnQgUmVmZXJlbmNlcwogICAgbGlrZSBSZWNvcmRSZWZlcmVuY2UvSGFzTWFueVJlZmVyZW5jZS9CZWxvbmdzVG9SZWZlcmVuY2UKCiAgIEBjbGFzcyBSZWZlcmVuY2UKICAgKi8KCgogIHZhciBSZWZlcmVuY2UgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBSZWZlcmVuY2Uoc3RvcmUsIGludGVybmFsTW9kZWwpIHsKICAgICAgdGhpcy5zdG9yZSA9IHN0b3JlOwogICAgICB0aGlzLmludGVybmFsTW9kZWwgPSBpbnRlcm5hbE1vZGVsOwogICAgICB0aGlzLnJlY29yZERhdGEgPSB2b2lkIDA7CiAgICAgIHRoaXMucmVjb3JkRGF0YSA9IHJlY29yZERhdGFGb3IodGhpcyk7CiAgICB9CgogICAgdmFyIF9wcm90byA9IFJlZmVyZW5jZS5wcm90b3R5cGU7CgogICAgX3Byb3RvLl9yZXNvdXJjZSA9IGZ1bmN0aW9uIF9yZXNvdXJjZSgpIHt9CiAgICAvKioKICAgICBUaGlzIHJldHVybnMgYSBzdHJpbmcgdGhhdCByZXByZXNlbnRzIGhvdyB0aGUgcmVmZXJlbmNlIHdpbGwgYmUKICAgICBsb29rZWQgdXAgd2hlbiBpdCBpcyBsb2FkZWQuIElmIHRoZSByZWxhdGlvbnNoaXAgaGFzIGEgbGluayBpdCB3aWxsCiAgICAgdXNlIHRoZSAibGluayIgb3RoZXJ3aXNlIGl0IGRlZmF1bHRzIHRvICJpZCIuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgYXBwL21vZGVscy9wb3N0LmpzCiAgICAgaW1wb3J0IE1vZGVsLCB7IGhhc01hbnkgfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CiAgICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgICBjb21tZW50czogaGFzTWFueSh7IGFzeW5jOiB0cnVlIH0pCiAgICAgfSk7CiAgICAgYGBgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBsZXQgcG9zdCA9IHN0b3JlLnB1c2goewogICAgICAgZGF0YTogewogICAgICAgICB0eXBlOiAncG9zdCcsCiAgICAgICAgIGlkOiAxLAogICAgICAgICByZWxhdGlvbnNoaXBzOiB7CiAgICAgICAgICAgY29tbWVudHM6IHsKICAgICAgICAgICAgIGRhdGE6IFt7IHR5cGU6ICdjb21tZW50JywgaWQ6IDEgfV0KICAgICAgICAgICB9CiAgICAgICAgIH0KICAgICAgIH0KICAgICB9KTsKICAgICAgbGV0IGNvbW1lbnRzUmVmID0gcG9zdC5oYXNNYW55KCdjb21tZW50cycpOwogICAgICAvLyBnZXQgdGhlIGlkZW50aWZpZXIgb2YgdGhlIHJlZmVyZW5jZQogICAgIGlmIChjb21tZW50c1JlZi5yZW1vdGVUeXBlKCkgPT09ICJpZHMiKSB7CiAgICAgICBsZXQgaWRzID0gY29tbWVudHNSZWYuaWRzKCk7CiAgICAgfSBlbHNlIGlmIChjb21tZW50c1JlZi5yZW1vdGVUeXBlKCkgPT09ICJsaW5rIikgewogICAgICAgbGV0IGxpbmsgPSBjb21tZW50c1JlZi5saW5rKCk7CiAgICAgfQogICAgIGBgYAogICAgICBAbWV0aG9kIHJlbW90ZVR5cGUKICAgICBAcmV0dXJuIHtTdHJpbmd9IFRoZSBuYW1lIG9mIHRoZSByZW1vdGUgdHlwZS4gVGhpcyBzaG91bGQgZWl0aGVyIGJlICJsaW5rIiBvciAiaWRzIgogICAgICovCiAgICA7CgogICAgX3Byb3RvLnJlbW90ZVR5cGUgPSBmdW5jdGlvbiByZW1vdGVUeXBlKCkgewogICAgICB2YXIgdmFsdWUgPSB0aGlzLl9yZXNvdXJjZSgpOwoKICAgICAgaWYgKGlzUmVzb3VyY2VJZGVudGlmZXJXaXRoUmVsYXRlZExpbmtzKHZhbHVlKSkgewogICAgICAgIHJldHVybiAnbGluayc7CiAgICAgIH0KCiAgICAgIHJldHVybiAnaWQnOwogICAgfQogICAgLyoqCiAgICAgVGhlIGxpbmsgRW1iZXIgRGF0YSB3aWxsIHVzZSB0byBmZXRjaCBvciByZWxvYWQgdGhpcyBiZWxvbmdzLXRvCiAgICAgcmVsYXRpb25zaGlwLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAvLyBtb2RlbHMvYmxvZy5qcwogICAgIGltcG9ydCBNb2RlbCwgeyBiZWxvbmdzVG8gfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CiAgICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgICB1c2VyOiBiZWxvbmdzVG8oeyBhc3luYzogdHJ1ZSB9KQogICAgICB9KTsKICAgICAgbGV0IGJsb2cgPSBzdG9yZS5wdXNoKHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICB0eXBlOiAnYmxvZycsCiAgICAgICAgICBpZDogMSwKICAgICAgICAgIHJlbGF0aW9uc2hpcHM6IHsKICAgICAgICAgICAgdXNlcjogewogICAgICAgICAgICAgIGxpbmtzOiB7CiAgICAgICAgICAgICAgICByZWxhdGVkOiAnL2FydGljbGVzLzEvYXV0aG9yJwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgbGV0IHVzZXJSZWYgPSBibG9nLmJlbG9uZ3NUbygndXNlcicpOwogICAgICAvLyBnZXQgdGhlIGlkZW50aWZpZXIgb2YgdGhlIHJlZmVyZW5jZQogICAgIGlmICh1c2VyUmVmLnJlbW90ZVR5cGUoKSA9PT0gImxpbmsiKSB7CiAgICAgICAgbGV0IGxpbmsgPSB1c2VyUmVmLmxpbmsoKTsKICAgICAgfQogICAgIGBgYAogICAgICBAbWV0aG9kIGxpbmsKICAgICBAcmV0dXJuIHtTdHJpbmd9IFRoZSBsaW5rIEVtYmVyIERhdGEgd2lsbCB1c2UgdG8gZmV0Y2ggb3IgcmVsb2FkIHRoaXMgYmVsb25ncy10byByZWxhdGlvbnNoaXAuCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8ubGluayA9IGZ1bmN0aW9uIGxpbmsoKSB7CiAgICAgIHZhciBsaW5rOwoKICAgICAgdmFyIHJlc291cmNlID0gdGhpcy5fcmVzb3VyY2UoKTsKCiAgICAgIGlmIChpc1Jlc291cmNlSWRlbnRpZmVyV2l0aFJlbGF0ZWRMaW5rcyhyZXNvdXJjZSkpIHsKICAgICAgICBpZiAocmVzb3VyY2UubGlua3MpIHsKICAgICAgICAgIGxpbmsgPSByZXNvdXJjZS5saW5rcy5yZWxhdGVkOwogICAgICAgICAgbGluayA9ICFsaW5rIHx8IHR5cGVvZiBsaW5rID09PSAnc3RyaW5nJyA/IGxpbmsgOiBsaW5rLmhyZWY7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gbGluayB8fCBudWxsOwogICAgfQogICAgLyoqCiAgICAgVGhlIG1ldGEgZGF0YSBmb3IgdGhlIGJlbG9uZ3MtdG8gcmVsYXRpb25zaGlwLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAvLyBtb2RlbHMvYmxvZy5qcwogICAgIGltcG9ydCBNb2RlbCwgeyBiZWxvbmdzVG8gfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CiAgICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgICB1c2VyOiBiZWxvbmdzVG8oeyBhc3luYzogdHJ1ZSB9KQogICAgICB9KTsKICAgICAgbGV0IGJsb2cgPSBzdG9yZS5wdXNoKHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICB0eXBlOiAnYmxvZycsCiAgICAgICAgICBpZDogMSwKICAgICAgICAgIHJlbGF0aW9uc2hpcHM6IHsKICAgICAgICAgICAgdXNlcjogewogICAgICAgICAgICAgIGxpbmtzOiB7CiAgICAgICAgICAgICAgICByZWxhdGVkOiB7CiAgICAgICAgICAgICAgICAgIGhyZWY6ICcvYXJ0aWNsZXMvMS9hdXRob3InCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgbWV0YTogewogICAgICAgICAgICAgICAgICBsYXN0VXBkYXRlZDogMTQ1ODAxNDQwMDAwMAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGxldCB1c2VyUmVmID0gYmxvZy5iZWxvbmdzVG8oJ3VzZXInKTsKICAgICAgdXNlclJlZi5tZXRhKCkgLy8geyBsYXN0VXBkYXRlZDogMTQ1ODAxNDQwMDAwMCB9CiAgICAgYGBgCiAgICAgIEBtZXRob2QgbWV0YQogICAgIEByZXR1cm4ge09iamVjdH0gVGhlIG1ldGEgaW5mb3JtYXRpb24gZm9yIHRoZSBiZWxvbmdzLXRvIHJlbGF0aW9uc2hpcC4KICAgICAqLwogICAgOwoKICAgIF9wcm90by5tZXRhID0gZnVuY3Rpb24gbWV0YSgpIHsKICAgICAgdmFyIG1ldGEgPSBudWxsOwoKICAgICAgdmFyIHJlc291cmNlID0gdGhpcy5fcmVzb3VyY2UoKTsKCiAgICAgIGlmIChyZXNvdXJjZSAmJiByZXNvdXJjZS5tZXRhICYmIHR5cGVvZiByZXNvdXJjZS5tZXRhID09PSAnb2JqZWN0JykgewogICAgICAgIG1ldGEgPSByZXNvdXJjZS5tZXRhOwogICAgICB9CgogICAgICByZXR1cm4gbWV0YTsKICAgIH07CgogICAgcmV0dXJuIFJlZmVyZW5jZTsKICB9KCk7CgogIGlmIChjYW5hcnlGZWF0dXJlcy5GVUxMX0xJTktTX09OX1JFTEFUSU9OU0hJUFMpIHsKICAgIFJlZmVyZW5jZS5wcm90b3R5cGUubGlua3MgPSBmdW5jdGlvbiBsaW5rcygpIHsKICAgICAgdmFyIHJlc291cmNlID0gdGhpcy5fcmVzb3VyY2UoKTsKCiAgICAgIHJldHVybiByZXNvdXJjZSAmJiByZXNvdXJjZS5saW5rcyA/IHJlc291cmNlLmxpbmtzIDogbnVsbDsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyQyKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9CgogIGZ1bmN0aW9uIF9jcmVhdGVDbGFzcyQyKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMkMihDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzJDIoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9CgogIGZ1bmN0aW9uIF9pbmhlcml0c0xvb3NlKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcy5wcm90b3R5cGUpOyBzdWJDbGFzcy5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBzdWJDbGFzczsgc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyLWRhdGEvc3RvcmUKICAqLwoKICAvKioKICAgICBBIGBSZWNvcmRSZWZlcmVuY2VgIGlzIGEgbG93LWxldmVsIEFQSSB0aGF0IGFsbG93cyB1c2VycyBhbmQKICAgICBhZGRvbiBhdXRob3JzIHRvIHBlcmZvcm0gbWV0YS1vcGVyYXRpb25zIG9uIGEgcmVjb3JkLgoKICAgICBAY2xhc3MgUmVjb3JkUmVmZXJlbmNlCiAgICAgQGV4dGVuZHMgUmVmZXJlbmNlCiAgKi8KICB2YXIgUmVjb3JkUmVmZXJlbmNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9SZWZlcmVuY2UpIHsKICAgIF9pbmhlcml0c0xvb3NlKFJlY29yZFJlZmVyZW5jZSwgX1JlZmVyZW5jZSk7CgogICAgZnVuY3Rpb24gUmVjb3JkUmVmZXJlbmNlKCkgewogICAgICB2YXIgX3RoaXM7CgogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CgogICAgICBfdGhpcyA9IF9SZWZlcmVuY2UuY2FsbC5hcHBseShfUmVmZXJlbmNlLCBbdGhpc10uY29uY2F0KGFyZ3MpKSB8fCB0aGlzOwogICAgICBfdGhpcy50eXBlID0gX3RoaXMuaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWU7CiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICB2YXIgX3Byb3RvID0gUmVjb3JkUmVmZXJlbmNlLnByb3RvdHlwZTsKCiAgICAvKioKICAgICAgIFRoZSBgaWRgIG9mIHRoZSByZWNvcmQgdGhhdCB0aGlzIHJlZmVyZW5jZSByZWZlcnMgdG8uCiAgICAgICAgVG9nZXRoZXIsIHRoZSBgdHlwZWAgYW5kIGBpZGAgcHJvcGVydGllcyBmb3JtIGEgY29tcG9zaXRlIGtleSBmb3IKICAgICAgIHRoZSBpZGVudGl0eSBtYXAuCiAgICAgICAgRXhhbXBsZQogICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgIGxldCB1c2VyUmVmID0gc3RvcmUuZ2V0UmVmZXJlbmNlKCd1c2VyJywgMSk7CiAgICAgICAgdXNlclJlZi5pZCgpOyAvLyAnMScKICAgICAgIGBgYAogICAgICAgIEBtZXRob2QgaWQKICAgICAgIEByZXR1cm4ge1N0cmluZ30gVGhlIGlkIG9mIHRoZSByZWNvcmQuCiAgICAqLwogICAgX3Byb3RvLmlkID0gZnVuY3Rpb24gaWQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9pZDsKICAgIH0KICAgIC8qKgogICAgICAgSG93IHRoZSByZWZlcmVuY2Ugd2lsbCBiZSBsb29rZWQgdXAgd2hlbiBpdCBpcyBsb2FkZWQuIEN1cnJlbnRseQogICAgICAgdGhpcyBhbHdheXMgcmV0dXJucyBgaWRlbnRpdHlgIHRvIHNpZ25pZnkgdGhhdCBhIHJlY29yZCB3aWxsIGJlCiAgICAgICBsb2FkZWQgYnkgaXRzIGB0eXBlYCBhbmQgYGlkYC4KICAgICAgICBFeGFtcGxlCiAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgY29uc3QgdXNlclJlZiA9IHN0b3JlLmdldFJlZmVyZW5jZSgndXNlcicsIDEpOwogICAgICAgIHVzZXJSZWYucmVtb3RlVHlwZSgpOyAvLyAnaWRlbnRpdHknCiAgICAgICBgYGAKICAgICAgICBAbWV0aG9kIHJlbW90ZVR5cGUKICAgICAgIEByZXR1cm4ge1N0cmluZ30gJ2lkZW50aXR5JwogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucmVtb3RlVHlwZSA9IGZ1bmN0aW9uIHJlbW90ZVR5cGUoKSB7CiAgICAgIHJldHVybiAnaWRlbnRpdHknOwogICAgfQogICAgLyoqCiAgICAgIFRoaXMgQVBJIGFsbG93cyB5b3UgdG8gcHJvdmlkZSBhIHJlZmVyZW5jZSB3aXRoIG5ldyBkYXRhLiBUaGUKICAgICAgc2ltcGxlc3QgdXNhZ2Ugb2YgdGhpcyBBUEkgaXMgc2ltaWxhciB0byBgc3RvcmUucHVzaGA6IHlvdSBwcm92aWRlIGEKICAgICAgbm9ybWFsaXplZCBoYXNoIG9mIGRhdGEgYW5kIHRoZSBvYmplY3QgcmVwcmVzZW50ZWQgYnkgdGhlIHJlZmVyZW5jZQogICAgICB3aWxsIHVwZGF0ZS4KICAgICAgIElmIHlvdSBwYXNzIGEgcHJvbWlzZSB0byBgcHVzaGAsIEVtYmVyIERhdGEgd2lsbCBub3QgYXNrIHRoZSBhZGFwdGVyCiAgICAgIGZvciB0aGUgZGF0YSBpZiBhbm90aGVyIGF0dGVtcHQgdG8gZmV0Y2ggaXQgaXMgbWFkZSBpbiB0aGUKICAgICAgaW50ZXJpbS4gV2hlbiB0aGUgcHJvbWlzZSByZXNvbHZlcywgdGhlIHVuZGVybHlpbmcgb2JqZWN0IGlzIHVwZGF0ZWQKICAgICAgd2l0aCB0aGUgbmV3IGRhdGEsIGFuZCB0aGUgcHJvbWlzZSByZXR1cm5lZCBieSAqdGhpcyBmdW5jdGlvbiogaXMgcmVzb2x2ZWQKICAgICAgd2l0aCB0aGF0IG9iamVjdC4KICAgICAgIEZvciBleGFtcGxlLCBgcmVjb3JkUmVmZXJlbmNlLnB1c2gocHJvbWlzZSlgIHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCBhCiAgICAgIHJlY29yZC4KICAgICAgICBFeGFtcGxlCiAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgbGV0IHVzZXJSZWYgPSBzdG9yZS5nZXRSZWZlcmVuY2UoJ3VzZXInLCAxKTsKICAgICAgICAvLyBwcm92aWRlIGRhdGEgZm9yIHJlZmVyZW5jZQogICAgICAgdXNlclJlZi5wdXNoKHsKICAgICAgICAgZGF0YTogewogICAgICAgICAgIGlkOiAiMSIsCiAgICAgICAgICAgdHlwZTogInVzZXIiLAogICAgICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgICAgIHVzZXJuYW1lOiAiQHVzZXIiCiAgICAgICAgICAgfQogICAgICAgICB9CiAgICAgICB9KS50aGVuKGZ1bmN0aW9uKHVzZXIpIHsKICAgICAgICAgdXNlclJlZi52YWx1ZSgpID09PSB1c2VyOwogICAgICAgfSk7CiAgICAgICBgYGAKICAgICAgIEBtZXRob2QgcHVzaAogICAgICBAcGFyYW0gb2JqZWN0T3JQcm9taXNlIGEgSlNPTjpBUEkgUmVzb3VyY2VEb2N1bWVudCBvciBhIHByb21pc2UgcmVzb2x2aW5nIHRvIG9uZQogICAgICBAcmV0dXJuIGEgcHJvbWlzZSBmb3IgdGhlIHZhbHVlIChyZWNvcmQgb3IgcmVsYXRpb25zaGlwKQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucHVzaCA9IGZ1bmN0aW9uIHB1c2gob2JqZWN0T3JQcm9taXNlKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgcmV0dXJuIEVtYmVyLlJTVlAucmVzb2x2ZShvYmplY3RPclByb21pc2UpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICByZXR1cm4gX3RoaXMyLnN0b3JlLnB1c2goZGF0YSk7CiAgICAgIH0pOwogICAgfQogICAgLyoqCiAgICAgIElmIHRoZSBlbnRpdHkgcmVmZXJyZWQgdG8gYnkgdGhlIHJlZmVyZW5jZSBpcyBhbHJlYWR5IGxvYWRlZCwgaXQgaXMKICAgICAgcHJlc2VudCBhcyBgcmVmZXJlbmNlLnZhbHVlYC4gT3RoZXJ3aXNlIHRoZSB2YWx1ZSByZXR1cm5lZCBieSB0aGlzIGZ1bmN0aW9uCiAgICAgIGlzIGBudWxsYC4KICAgICAgICBFeGFtcGxlCiAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgbGV0IHVzZXJSZWYgPSBzdG9yZS5nZXRSZWZlcmVuY2UoJ3VzZXInLCAxKTsKICAgICAgICB1c2VyUmVmLnZhbHVlKCk7IC8vIHVzZXIKICAgICAgIGBgYAogICAgICAgIEBtZXRob2QgdmFsdWUKICAgICAgIEByZXR1cm4ge01vZGVsfSB0aGUgcmVjb3JkIGZvciB0aGlzIFJlY29yZFJlZmVyZW5jZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8udmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgaWYgKHRoaXMuaW50ZXJuYWxNb2RlbC5oYXNSZWNvcmQpIHsKICAgICAgICByZXR1cm4gdGhpcy5pbnRlcm5hbE1vZGVsLmdldFJlY29yZCgpOwogICAgICB9CgogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIC8qKgogICAgICAgVHJpZ2dlcnMgYSBmZXRjaCBmb3IgdGhlIGJhY2tpbmcgZW50aXR5IGJhc2VkIG9uIGl0cyBgcmVtb3RlVHlwZWAKICAgICAgIChzZWUgYHJlbW90ZVR5cGVgIGRlZmluaXRpb25zIHBlciByZWZlcmVuY2UgdHlwZSkuCiAgICAgICAgRXhhbXBsZQogICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgIGxldCB1c2VyUmVmID0gc3RvcmUuZ2V0UmVmZXJlbmNlKCd1c2VyJywgMSk7CiAgICAgICAgLy8gbG9hZCB1c2VyICh2aWEgc3RvcmUuZmluZCkKICAgICAgIHVzZXJSZWYubG9hZCgpLnRoZW4oLi4uKQogICAgICAgYGBgCiAgICAgICAgQG1ldGhvZCBsb2FkCiAgICAgICBAcmV0dXJuIHtQcm9taXNlPHJlY29yZD59IHRoZSByZWNvcmQgZm9yIHRoaXMgUmVjb3JkUmVmZXJlbmNlCiAgICAqLwogICAgOwoKICAgIF9wcm90by5sb2FkID0gZnVuY3Rpb24gbG9hZCgpIHsKICAgICAgaWYgKHRoaXMuX2lkICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmUuZmluZFJlY29yZCh0aGlzLnR5cGUsIHRoaXMuX2lkKTsKICAgICAgfQoKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmV0Y2ggcmVjb3JkIG9mIHR5cGUgIiArIHRoaXMudHlwZSArICIgd2l0aG91dCBhbiBpZCIpOwogICAgfQogICAgLyoqCiAgICAgICBSZWxvYWRzIHRoZSByZWNvcmQgaWYgaXQgaXMgYWxyZWFkeSBsb2FkZWQuIElmIHRoZSByZWNvcmQgaXMgbm90CiAgICAgICBsb2FkZWQgaXQgd2lsbCBsb2FkIHRoZSByZWNvcmQgdmlhIGBzdG9yZS5maW5kUmVjb3JkYAogICAgICAgIEV4YW1wbGUKICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgICBsZXQgdXNlclJlZiA9IHN0b3JlLmdldFJlZmVyZW5jZSgndXNlcicsIDEpOwogICAgICAgIC8vIG9yIHRyaWdnZXIgYSByZWxvYWQKICAgICAgIHVzZXJSZWYucmVsb2FkKCkudGhlbiguLi4pCiAgICAgICBgYGAKICAgICAgICBAbWV0aG9kIHJlbG9hZAogICAgICAgQHJldHVybiB7UHJvbWlzZTxyZWNvcmQ+fSB0aGUgcmVjb3JkIGZvciB0aGlzIFJlY29yZFJlZmVyZW5jZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucmVsb2FkID0gZnVuY3Rpb24gcmVsb2FkKCkgewogICAgICB2YXIgcmVjb3JkID0gdGhpcy52YWx1ZSgpOwoKICAgICAgaWYgKHJlY29yZCkgewogICAgICAgIHJldHVybiByZWNvcmQucmVsb2FkKCk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLmxvYWQoKTsKICAgIH07CgogICAgX2NyZWF0ZUNsYXNzJDIoUmVjb3JkUmVmZXJlbmNlLCBbewogICAgICBrZXk6ICJfaWQiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5pbnRlcm5hbE1vZGVsLmlkOwogICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIFJlY29yZFJlZmVyZW5jZTsKICB9KFJlZmVyZW5jZSk7CgogIGZ1bmN0aW9uIF9pbmhlcml0c0xvb3NlJDEoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzLnByb3RvdHlwZSk7IHN1YkNsYXNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHN1YkNsYXNzOyBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9CiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL3N0b3JlCiAgKi8KCiAgLyoqCiAgIEEgYEJlbG9uZ3NUb1JlZmVyZW5jZWAgaXMgYSBsb3ctbGV2ZWwgQVBJIHRoYXQgYWxsb3dzIHVzZXJzIGFuZAogICBhZGRvbiBhdXRob3JzIHRvIHBlcmZvcm0gbWV0YS1vcGVyYXRpb25zIG9uIGEgYmVsb25ncy10bwogICByZWxhdGlvbnNoaXAuCgogICBAY2xhc3MgQmVsb25nc1RvUmVmZXJlbmNlCiAgIEBleHRlbmRzIFJlZmVyZW5jZQogICAqLwoKICB2YXIgQmVsb25nc1RvUmVmZXJlbmNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKF9SZWZlcmVuY2UpIHsKICAgIF9pbmhlcml0c0xvb3NlJDEoQmVsb25nc1RvUmVmZXJlbmNlLCBfUmVmZXJlbmNlKTsKCiAgICBmdW5jdGlvbiBCZWxvbmdzVG9SZWZlcmVuY2Uoc3RvcmUsIHBhcmVudEludGVybmFsTW9kZWwsIGJlbG9uZ3NUb1JlbGF0aW9uc2hpcCwga2V5KSB7CiAgICAgIHZhciBfdGhpczsKCiAgICAgIF90aGlzID0gX1JlZmVyZW5jZS5jYWxsKHRoaXMsIHN0b3JlLCBwYXJlbnRJbnRlcm5hbE1vZGVsKSB8fCB0aGlzOwogICAgICBfdGhpcy5rZXkgPSBrZXk7CiAgICAgIF90aGlzLmJlbG9uZ3NUb1JlbGF0aW9uc2hpcCA9IGJlbG9uZ3NUb1JlbGF0aW9uc2hpcDsKICAgICAgX3RoaXMudHlwZSA9IGJlbG9uZ3NUb1JlbGF0aW9uc2hpcC5yZWxhdGlvbnNoaXBNZXRhLnR5cGU7CiAgICAgIF90aGlzLnBhcmVudCA9IHBhcmVudEludGVybmFsTW9kZWwucmVjb3JkUmVmZXJlbmNlOwogICAgICBfdGhpcy5wYXJlbnRJbnRlcm5hbE1vZGVsID0gcGFyZW50SW50ZXJuYWxNb2RlbDsgLy8gVE9ETyBpbnZlcnNlCgogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CiAgICAvKioKICAgICBUaGUgYGlkYCBvZiB0aGUgcmVjb3JkIHRoYXQgdGhpcyByZWZlcmVuY2UgcmVmZXJzIHRvLiBUb2dldGhlciwgdGhlCiAgICAgYHR5cGUoKWAgYW5kIGBpZCgpYCBtZXRob2RzIGZvcm0gYSBjb21wb3NpdGUga2V5IGZvciB0aGUgaWRlbnRpdHkKICAgICBtYXAuIFRoaXMgY2FuIGJlIHVzZWQgdG8gYWNjZXNzIHRoZSBpZCBvZiBhbiBhc3luYyByZWxhdGlvbnNoaXAKICAgICB3aXRob3V0IHRyaWdnZXJpbmcgYSBmZXRjaCB0aGF0IHdvdWxkIG5vcm1hbGx5IGhhcHBlbiBpZiB5b3UKICAgICBhdHRlbXB0ZWQgdG8gdXNlIGByZWNvcmQuZ2V0KCdyZWxhdGlvbnNoaXAuaWQnKWAuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgamF2YXNjcmlwdAogICAgIC8vIG1vZGVscy9ibG9nLmpzCiAgICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgICB1c2VyOiBiZWxvbmdzVG8oeyBhc3luYzogdHJ1ZSB9KQogICAgICB9KTsKICAgICAgbGV0IGJsb2cgPSBzdG9yZS5wdXNoKHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICB0eXBlOiAnYmxvZycsCiAgICAgICAgICBpZDogMSwKICAgICAgICAgIHJlbGF0aW9uc2hpcHM6IHsKICAgICAgICAgICAgdXNlcjogewogICAgICAgICAgICAgIGRhdGE6IHsgdHlwZTogJ3VzZXInLCBpZDogMSB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgIGxldCB1c2VyUmVmID0gYmxvZy5iZWxvbmdzVG8oJ3VzZXInKTsKICAgICAgLy8gZ2V0IHRoZSBpZGVudGlmaWVyIG9mIHRoZSByZWZlcmVuY2UKICAgICBpZiAodXNlclJlZi5yZW1vdGVUeXBlKCkgPT09ICJpZCIpIHsKICAgICAgICBsZXQgaWQgPSB1c2VyUmVmLmlkKCk7CiAgICAgIH0KICAgICBgYGAKICAgICAgQG1ldGhvZCBpZAogICAgIEByZXR1cm4ge1N0cmluZ30gVGhlIGlkIG9mIHRoZSByZWNvcmQgaW4gdGhpcyBiZWxvbmdzVG8gcmVsYXRpb25zaGlwLgogICAgICovCgoKICAgIHZhciBfcHJvdG8gPSBCZWxvbmdzVG9SZWZlcmVuY2UucHJvdG90eXBlOwoKICAgIF9wcm90by5pZCA9IGZ1bmN0aW9uIGlkKCkgewogICAgICB2YXIgaWQgPSBudWxsOwoKICAgICAgdmFyIHJlc291cmNlID0gdGhpcy5fcmVzb3VyY2UoKTsKCiAgICAgIGlmIChyZXNvdXJjZSAmJiByZXNvdXJjZS5kYXRhICYmIHJlc291cmNlLmRhdGEuaWQpIHsKICAgICAgICBpZCA9IHJlc291cmNlLmRhdGEuaWQ7CiAgICAgIH0KCiAgICAgIHJldHVybiBpZDsKICAgIH07CgogICAgX3Byb3RvLl9yZXNvdXJjZSA9IGZ1bmN0aW9uIF9yZXNvdXJjZSgpIHsKICAgICAgcmV0dXJuIHRoaXMucmVjb3JkRGF0YS5nZXRCZWxvbmdzVG8odGhpcy5rZXkpOwogICAgfQogICAgLyoqCiAgICAgYHB1c2hgIGNhbiBiZSB1c2VkIHRvIHVwZGF0ZSB0aGUgZGF0YSBpbiB0aGUgcmVsYXRpb25zaGlwIGFuZCBFbWJlcgogICAgIERhdGEgd2lsbCB0cmVhdCB0aGUgbmV3IGRhdGEgYXMgdGhlIGNvbmFuaWNhbCB2YWx1ZSBvZiB0aGlzCiAgICAgcmVsYXRpb25zaGlwIG9uIHRoZSBiYWNrZW5kLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGFwcC9tb2RlbHMvYmxvZy5qcwogICAgIGltcG9ydCBNb2RlbCwgeyBiZWxvbmdzVG8gfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CiAgICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgICAgdXNlcjogYmVsb25nc1RvKHsgYXN5bmM6IHRydWUgfSkKICAgICAgfSk7CiAgICAgIGxldCBibG9nID0gc3RvcmUucHVzaCh7CiAgICAgICAgZGF0YTogewogICAgICAgICAgdHlwZTogJ2Jsb2cnLAogICAgICAgICAgaWQ6IDEsCiAgICAgICAgICByZWxhdGlvbnNoaXBzOiB7CiAgICAgICAgICAgIHVzZXI6IHsKICAgICAgICAgICAgICBkYXRhOiB7IHR5cGU6ICd1c2VyJywgaWQ6IDEgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICBsZXQgdXNlclJlZiA9IGJsb2cuYmVsb25nc1RvKCd1c2VyJyk7CiAgICAgIC8vIHByb3ZpZGUgZGF0YSBmb3IgcmVmZXJlbmNlCiAgICAgdXNlclJlZi5wdXNoKHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICB0eXBlOiAndXNlcicsCiAgICAgICAgICBpZDogMSwKICAgICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgICAgdXNlcm5hbWU6ICJAdXNlciIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pLnRoZW4oZnVuY3Rpb24odXNlcikgewogICAgICAgIHVzZXJSZWYudmFsdWUoKSA9PT0gdXNlcjsKICAgICAgfSk7CiAgICAgYGBgCiAgICAgIEBtZXRob2QgcHVzaAogICAgIEBwYXJhbSB7T2JqZWN0fFByb21pc2V9IG9iamVjdE9yUHJvbWlzZSBhIHByb21pc2UgdGhhdCByZXNvbHZlcyB0byBhIEpTT05BUEkgZG9jdW1lbnQgb2JqZWN0IGRlc2NyaWJpbmcgdGhlIG5ldyB2YWx1ZSBvZiB0aGlzIHJlbGF0aW9uc2hpcC4KICAgICBAcmV0dXJuIHtQcm9taXNlPHJlY29yZD59IEEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHdpdGggdGhlIG5ldyB2YWx1ZSBpbiB0aGlzIGJlbG9uZ3MtdG8gcmVsYXRpb25zaGlwLgogICAgICovCiAgICA7CgogICAgX3Byb3RvLnB1c2ggPSBmdW5jdGlvbiBwdXNoKG9iamVjdE9yUHJvbWlzZSkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIC8vIFRPRE8gZGVwcmVjYXRlIHRoZW5hYmxlIHN1cHBvcnQKICAgICAgcmV0dXJuIEVtYmVyLlJTVlAucmVzb2x2ZShvYmplY3RPclByb21pc2UpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB2YXIgcmVjb3JkOyAvLyBUT0RPIGRlcHJlY2F0ZSBkYXRhIGFzIE1vZGVsCgogICAgICAgIGlmIChwZWVrUmVjb3JkSWRlbnRpZmllcihkYXRhKSkgewogICAgICAgICAgcmVjb3JkID0gZGF0YTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVjb3JkID0gX3RoaXMyLnN0b3JlLnB1c2goZGF0YSk7CiAgICAgICAgfQoKICAgICAgICAvL1RPRE8gSWdvciBjbGVhbnVwLCBtYXliZSBtb3ZlIHRvIHJlbGF0aW9uc2hpcCBwdXNoCiAgICAgICAgX3RoaXMyLmJlbG9uZ3NUb1JlbGF0aW9uc2hpcC5zZXRDYW5vbmljYWxSZWNvcmREYXRhKHJlY29yZERhdGFGb3IocmVjb3JkKSk7CgogICAgICAgIHJldHVybiByZWNvcmQ7CiAgICAgIH0pOwogICAgfQogICAgLyoqCiAgICAgYHZhbHVlKClgIHN5bmNocm9ub3VzbHkgcmV0dXJucyB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgYmVsb25ncy10bwogICAgIHJlbGF0aW9uc2hpcC4gVW5saWtlIGByZWNvcmQuZ2V0KCdyZWxhdGlvbnNoaXBOYW1lJylgLCBjYWxsaW5nCiAgICAgYHZhbHVlKClgIG9uIGEgcmVmZXJlbmNlIGRvZXMgbm90IHRyaWdnZXIgYSBmZXRjaCBpZiB0aGUgYXN5bmMKICAgICByZWxhdGlvbnNoaXAgaXMgbm90IHlldCBsb2FkZWQuIElmIHRoZSByZWxhdGlvbnNoaXAgaXMgbm90IGxvYWRlZAogICAgIGl0IHdpbGwgYWx3YXlzIHJldHVybiBgbnVsbGAuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgamF2YXNjcmlwdAogICAgIC8vIG1vZGVscy9ibG9nLmpzCiAgICAgaW1wb3J0IE1vZGVsLCB7IGJlbG9uZ3NUbyB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKICAgICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgICB1c2VyOiBiZWxvbmdzVG8oeyBhc3luYzogdHJ1ZSB9KQogICAgICB9KTsKICAgICAgbGV0IGJsb2cgPSBzdG9yZS5wdXNoKHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICB0eXBlOiAnYmxvZycsCiAgICAgICAgICBpZDogMSwKICAgICAgICAgIHJlbGF0aW9uc2hpcHM6IHsKICAgICAgICAgICAgdXNlcjogewogICAgICAgICAgICAgIGRhdGE6IHsgdHlwZTogJ3VzZXInLCBpZDogMSB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgIGxldCB1c2VyUmVmID0gYmxvZy5iZWxvbmdzVG8oJ3VzZXInKTsKICAgICAgdXNlclJlZi52YWx1ZSgpOyAvLyBudWxsCiAgICAgIC8vIHByb3ZpZGUgZGF0YSBmb3IgcmVmZXJlbmNlCiAgICAgdXNlclJlZi5wdXNoKHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICB0eXBlOiAndXNlcicsCiAgICAgICAgICBpZDogMSwKICAgICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgICAgdXNlcm5hbWU6ICJAdXNlciIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pLnRoZW4oZnVuY3Rpb24odXNlcikgewogICAgICAgIHVzZXJSZWYudmFsdWUoKTsgLy8gdXNlcgogICAgICB9KTsKICAgICBgYGAKICAgICAgQG1ldGhvZCB2YWx1ZQogICAgIEByZXR1cm4ge01vZGVsfSB0aGUgcmVjb3JkIGluIHRoaXMgcmVsYXRpb25zaGlwCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8udmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdmFyIHN0b3JlID0gdGhpcy5wYXJlbnRJbnRlcm5hbE1vZGVsLnN0b3JlOwoKICAgICAgdmFyIHJlc291cmNlID0gdGhpcy5fcmVzb3VyY2UoKTsKCiAgICAgIGlmIChyZXNvdXJjZSAmJiByZXNvdXJjZS5kYXRhKSB7CiAgICAgICAgdmFyIGludmVyc2VJbnRlcm5hbE1vZGVsID0gc3RvcmUuX2ludGVybmFsTW9kZWxGb3JSZXNvdXJjZShyZXNvdXJjZS5kYXRhKTsKCiAgICAgICAgaWYgKGludmVyc2VJbnRlcm5hbE1vZGVsICYmIGludmVyc2VJbnRlcm5hbE1vZGVsLmlzTG9hZGVkKCkpIHsKICAgICAgICAgIHJldHVybiBpbnZlcnNlSW50ZXJuYWxNb2RlbC5nZXRSZWNvcmQoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgLyoqCiAgICAgTG9hZHMgYSByZWNvcmQgaW4gYSBiZWxvbmdzLXRvIHJlbGF0aW9uc2hpcCBpZiBpdCBpcyBub3QgYWxyZWFkeQogICAgIGxvYWRlZC4gSWYgdGhlIHJlbGF0aW9uc2hpcCBpcyBhbHJlYWR5IGxvYWRlZCB0aGlzIG1ldGhvZCBkb2VzIG5vdAogICAgIHRyaWdnZXIgYSBuZXcgbG9hZC4KICAgICAgRXhhbXBsZQogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgLy8gbW9kZWxzL2Jsb2cuanMKICAgICBpbXBvcnQgTW9kZWwsIHsgYmVsb25nc1RvIH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogICAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICAgIHVzZXI6IGJlbG9uZ3NUbyh7IGFzeW5jOiB0cnVlIH0pCiAgICAgIH0pOwogICAgICBsZXQgYmxvZyA9IHN0b3JlLnB1c2goewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIHR5cGU6ICdibG9nJywKICAgICAgICAgIGlkOiAxLAogICAgICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAgICAgICB1c2VyOiB7CiAgICAgICAgICAgICAgZGF0YTogeyB0eXBlOiAndXNlcicsIGlkOiAxIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgbGV0IHVzZXJSZWYgPSBibG9nLmJlbG9uZ3NUbygndXNlcicpOwogICAgICB1c2VyUmVmLnZhbHVlKCk7IC8vIG51bGwKICAgICAgdXNlclJlZi5sb2FkKCkudGhlbihmdW5jdGlvbih1c2VyKSB7CiAgICAgICAgdXNlclJlZi52YWx1ZSgpID09PSB1c2VyCiAgICAgIH0pOwogICAgIGBgYAogICAgICBZb3UgbWF5IGFsc28gcGFzcyBpbiBhbiBvcHRpb25zIG9iamVjdCB3aG9zZSBwcm9wZXJ0aWVzIHdpbGwgYmUKICAgICBmZWQgZm9yd2FyZC4gVGhpcyBlbmFibGVzIHlvdSB0byBwYXNzIGBhZGFwdGVyT3B0aW9uc2AgaW50byB0aGUKICAgICByZXF1ZXN0IGdpdmVuIHRvIHRoZSBhZGFwdGVyIHZpYSB0aGUgcmVmZXJlbmNlLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICB1c2VyUmVmLmxvYWQoeyBhZGFwdGVyT3B0aW9uczogeyBpc1ByaXZhdGU6IHRydWUgfSB9KS50aGVuKGZ1bmN0aW9uKHVzZXIpIHsKICAgICAgIHVzZXJSZWYudmFsdWUoKSA9PT0gdXNlcjsKICAgICB9KTsKICAgICBgYGAKICAgICAgYGBgYXBwL2FkYXB0ZXJzL3VzZXIuanMKICAgICBleHBvcnQgZGVmYXVsdCBBcHBsaWNhdGlvbkFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgIGZpbmRSZWNvcmQoc3RvcmUsIHR5cGUsIGlkLCBzbmFwc2hvdCkgewogICAgICAgICAvLyBJbiB0aGUgYWRhcHRlciB5b3Ugd2lsbCBoYXZlIGFjY2VzcyB0byBhZGFwdGVyT3B0aW9ucy4KICAgICAgICAgbGV0IGFkYXB0ZXJPcHRpb25zID0gc25hcHNob3QuYWRhcHRlck9wdGlvbnM7CiAgICAgICB9CiAgICAgfSk7CiAgICAgYGBgCiAgICAgIEBtZXRob2QgbG9hZAogICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIHRoZSBvcHRpb25zIHRvIHBhc3MgaW4uCiAgICAgQHJldHVybiB7UHJvbWlzZX0gYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgd2l0aCB0aGUgcmVjb3JkIGluIHRoaXMgYmVsb25ncy10byByZWxhdGlvbnNoaXAuCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8ubG9hZCA9IGZ1bmN0aW9uIGxvYWQob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5wYXJlbnRJbnRlcm5hbE1vZGVsLmdldEJlbG9uZ3NUbyh0aGlzLmtleSwgb3B0aW9ucyk7CiAgICB9CiAgICAvKioKICAgICBUcmlnZ2VycyBhIHJlbG9hZCBvZiB0aGUgdmFsdWUgaW4gdGhpcyByZWxhdGlvbnNoaXAuIElmIHRoZQogICAgIHJlbW90ZVR5cGUgaXMgYCJsaW5rImAgRW1iZXIgRGF0YSB3aWxsIHVzZSB0aGUgcmVsYXRpb25zaGlwIGxpbmsgdG8KICAgICByZWxvYWQgdGhlIHJlbGF0aW9uc2hpcC4gT3RoZXJ3aXNlIGl0IHdpbGwgcmVsb2FkIHRoZSByZWNvcmQgYnkgaXRzCiAgICAgaWQuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgamF2YXNjcmlwdAogICAgIC8vIG1vZGVscy9ibG9nLmpzCiAgICAgaW1wb3J0IE1vZGVsLCB7IGJlbG9uZ3NUbyB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKICAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICAgIHVzZXI6IGJlbG9uZ3NUbyh7IGFzeW5jOiB0cnVlIH0pCiAgICAgIH0pOwogICAgICBsZXQgYmxvZyA9IHN0b3JlLnB1c2goewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIHR5cGU6ICdibG9nJywKICAgICAgICAgIGlkOiAxLAogICAgICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAgICAgICB1c2VyOiB7CiAgICAgICAgICAgICAgZGF0YTogeyB0eXBlOiAndXNlcicsIGlkOiAxIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgbGV0IHVzZXJSZWYgPSBibG9nLmJlbG9uZ3NUbygndXNlcicpOwogICAgICB1c2VyUmVmLnJlbG9hZCgpLnRoZW4oZnVuY3Rpb24odXNlcikgewogICAgICAgIHVzZXJSZWYudmFsdWUoKSA9PT0gdXNlcgogICAgICB9KTsKICAgICBgYGAKICAgICAgWW91IG1heSBhbHNvIHBhc3MgaW4gYW4gb3B0aW9ucyBvYmplY3Qgd2hvc2UgcHJvcGVydGllcyB3aWxsIGJlCiAgICAgZmVkIGZvcndhcmQuIFRoaXMgZW5hYmxlcyB5b3UgdG8gcGFzcyBgYWRhcHRlck9wdGlvbnNgIGludG8gdGhlCiAgICAgcmVxdWVzdCBnaXZlbiB0byB0aGUgYWRhcHRlciB2aWEgdGhlIHJlZmVyZW5jZS4gQSBmdWxsIGV4YW1wbGUKICAgICBjYW4gYmUgZm91bmQgaW4gdGhlIGBsb2FkYCBtZXRob2QuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgamF2YXNjcmlwdAogICAgIHVzZXJSZWYucmVsb2FkKHsgYWRhcHRlck9wdGlvbnM6IHsgaXNQcml2YXRlOiB0cnVlIH0gfSkKICAgICBgYGAKICAgICAgQG1ldGhvZCByZWxvYWQKICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyB0aGUgb3B0aW9ucyB0byBwYXNzIGluLgogICAgIEByZXR1cm4ge1Byb21pc2V9IGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHdpdGggdGhlIHJlY29yZCBpbiB0aGlzIGJlbG9uZ3MtdG8gcmVsYXRpb25zaGlwIGFmdGVyIHRoZSByZWxvYWQgaGFzIGNvbXBsZXRlZC4KICAgICAqLwogICAgOwoKICAgIF9wcm90by5yZWxvYWQgPSBmdW5jdGlvbiByZWxvYWQob3B0aW9ucykgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIHJldHVybiB0aGlzLnBhcmVudEludGVybmFsTW9kZWwucmVsb2FkQmVsb25nc1RvKHRoaXMua2V5LCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uIChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgcmV0dXJuIF90aGlzMy52YWx1ZSgpOwogICAgICB9KTsKICAgIH07CgogICAgcmV0dXJuIEJlbG9uZ3NUb1JlZmVyZW5jZTsKICB9KFJlZmVyZW5jZSk7CgogIGZ1bmN0aW9uIF9pbmhlcml0c0xvb3NlJDIoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzLnByb3RvdHlwZSk7IHN1YkNsYXNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHN1YkNsYXNzOyBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9CiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL3N0b3JlCiAgKi8KCiAgLyoqCiAgIEEgYEhhc01hbnlSZWZlcmVuY2VgIGlzIGEgbG93LWxldmVsIEFQSSB0aGF0IGFsbG93cyB1c2VycyBhbmQgYWRkb24KICAgYXV0aG9ycyB0byBwZXJmb3JtIG1ldGEtb3BlcmF0aW9ucyBvbiBhIGhhcy1tYW55IHJlbGF0aW9uc2hpcC4KCiAgIEBjbGFzcyBIYXNNYW55UmVmZXJlbmNlCiAgIEBleHRlbmRzIFJlZmVyZW5jZQogICAqLwoKICB2YXIgSGFzTWFueVJlZmVyZW5jZSA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uIChfUmVmZXJlbmNlKSB7CiAgICBfaW5oZXJpdHNMb29zZSQyKEhhc01hbnlSZWZlcmVuY2UsIF9SZWZlcmVuY2UpOwoKICAgIGZ1bmN0aW9uIEhhc01hbnlSZWZlcmVuY2Uoc3RvcmUsIHBhcmVudEludGVybmFsTW9kZWwsIGhhc01hbnlSZWxhdGlvbnNoaXAsIGtleSkgewogICAgICB2YXIgX3RoaXM7CgogICAgICBfdGhpcyA9IF9SZWZlcmVuY2UuY2FsbCh0aGlzLCBzdG9yZSwgcGFyZW50SW50ZXJuYWxNb2RlbCkgfHwgdGhpczsKICAgICAgX3RoaXMua2V5ID0ga2V5OwogICAgICBfdGhpcy5oYXNNYW55UmVsYXRpb25zaGlwID0gaGFzTWFueVJlbGF0aW9uc2hpcDsKICAgICAgX3RoaXMudHlwZSA9IGhhc01hbnlSZWxhdGlvbnNoaXAucmVsYXRpb25zaGlwTWV0YS50eXBlOwogICAgICBfdGhpcy5wYXJlbnQgPSBwYXJlbnRJbnRlcm5hbE1vZGVsLnJlY29yZFJlZmVyZW5jZTsKICAgICAgX3RoaXMucGFyZW50SW50ZXJuYWxNb2RlbCA9IHBhcmVudEludGVybmFsTW9kZWw7IC8vIFRPRE8gaW52ZXJzZQoKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBIYXNNYW55UmVmZXJlbmNlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8uX3Jlc291cmNlID0gZnVuY3Rpb24gX3Jlc291cmNlKCkgewogICAgICByZXR1cm4gdGhpcy5yZWNvcmREYXRhLmdldEhhc01hbnkodGhpcy5rZXkpOwogICAgfQogICAgLyoqCiAgICAgVGhpcyByZXR1cm5zIGEgc3RyaW5nIHRoYXQgcmVwcmVzZW50cyBob3cgdGhlIHJlZmVyZW5jZSB3aWxsIGJlCiAgICAgbG9va2VkIHVwIHdoZW4gaXQgaXMgbG9hZGVkLiBJZiB0aGUgcmVsYXRpb25zaGlwIGhhcyBhIGxpbmsgaXQgd2lsbAogICAgIHVzZSB0aGUgImxpbmsiIG90aGVyd2lzZSBpdCBkZWZhdWx0cyB0byAiaWQiLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGFwcC9tb2RlbHMvcG9zdC5qcwogICAgIGltcG9ydCBNb2RlbCwgeyBoYXNNYW55IH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgICBjb21tZW50czogaGFzTWFueSh7IGFzeW5jOiB0cnVlIH0pCiAgICAgfSk7CiAgICAgYGBgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBsZXQgcG9zdCA9IHN0b3JlLnB1c2goewogICAgICAgZGF0YTogewogICAgICAgICB0eXBlOiAncG9zdCcsCiAgICAgICAgIGlkOiAxLAogICAgICAgICByZWxhdGlvbnNoaXBzOiB7CiAgICAgICAgICAgY29tbWVudHM6IHsKICAgICAgICAgICAgIGRhdGE6IFt7IHR5cGU6ICdjb21tZW50JywgaWQ6IDEgfV0KICAgICAgICAgICB9CiAgICAgICAgIH0KICAgICAgIH0KICAgICB9KTsKICAgICAgbGV0IGNvbW1lbnRzUmVmID0gcG9zdC5oYXNNYW55KCdjb21tZW50cycpOwogICAgICAvLyBnZXQgdGhlIGlkZW50aWZpZXIgb2YgdGhlIHJlZmVyZW5jZQogICAgIGlmIChjb21tZW50c1JlZi5yZW1vdGVUeXBlKCkgPT09ICJpZHMiKSB7CiAgICAgICBsZXQgaWRzID0gY29tbWVudHNSZWYuaWRzKCk7CiAgICAgfSBlbHNlIGlmIChjb21tZW50c1JlZi5yZW1vdGVUeXBlKCkgPT09ICJsaW5rIikgewogICAgICAgbGV0IGxpbmsgPSBjb21tZW50c1JlZi5saW5rKCk7CiAgICAgfQogICAgIGBgYAogICAgICBAbWV0aG9kIHJlbW90ZVR5cGUKICAgICBAcmV0dXJuIHtTdHJpbmd9IFRoZSBuYW1lIG9mIHRoZSByZW1vdGUgdHlwZS4gVGhpcyBzaG91bGQgZWl0aGVyIGJlIGBsaW5rYCBvciBgaWRzYAogICAgICovCiAgICA7CgogICAgX3Byb3RvLnJlbW90ZVR5cGUgPSBmdW5jdGlvbiByZW1vdGVUeXBlKCkgewogICAgICB2YXIgdmFsdWUgPSB0aGlzLl9yZXNvdXJjZSgpOwoKICAgICAgaWYgKHZhbHVlICYmIHZhbHVlLmxpbmtzICYmIHZhbHVlLmxpbmtzLnJlbGF0ZWQpIHsKICAgICAgICByZXR1cm4gJ2xpbmsnOwogICAgICB9CgogICAgICByZXR1cm4gJ2lkcyc7CiAgICB9CiAgICAvKioKICAgICBgaWRzKClgIHJldHVybnMgYW4gYXJyYXkgb2YgdGhlIHJlY29yZCBJRHMgaW4gdGhpcyByZWxhdGlvbnNoaXAuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgYXBwL21vZGVscy9wb3N0LmpzCiAgICAgaW1wb3J0IE1vZGVsLCB7IGhhc01hbnkgfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CiAgICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgIGNvbW1lbnRzOiBoYXNNYW55KHsgYXN5bmM6IHRydWUgfSkKICAgICB9KTsKICAgICBgYGAKICAgICAgYGBgamF2YXNjcmlwdAogICAgIGxldCBwb3N0ID0gc3RvcmUucHVzaCh7CiAgICAgICBkYXRhOiB7CiAgICAgICAgIHR5cGU6ICdwb3N0JywKICAgICAgICAgaWQ6IDEsCiAgICAgICAgIHJlbGF0aW9uc2hpcHM6IHsKICAgICAgICAgICBjb21tZW50czogewogICAgICAgICAgICAgZGF0YTogW3sgdHlwZTogJ2NvbW1lbnQnLCBpZDogMSB9XQogICAgICAgICAgIH0KICAgICAgICAgfQogICAgICAgfQogICAgIH0pOwogICAgICBsZXQgY29tbWVudHNSZWYgPSBwb3N0Lmhhc01hbnkoJ2NvbW1lbnRzJyk7CiAgICAgIGNvbW1lbnRzUmVmLmlkcygpOyAvLyBbJzEnXQogICAgIGBgYAogICAgICBAbWV0aG9kIGlkcwogICAgIEByZXR1cm4ge0FycmF5fSBUaGUgaWRzIGluIHRoaXMgaGFzLW1hbnkgcmVsYXRpb25zaGlwCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8uaWRzID0gZnVuY3Rpb24gaWRzKCkgewogICAgICB2YXIgcmVzb3VyY2UgPSB0aGlzLl9yZXNvdXJjZSgpOwoKICAgICAgdmFyIGlkcyA9IFtdOwoKICAgICAgaWYgKHJlc291cmNlLmRhdGEpIHsKICAgICAgICBpZHMgPSByZXNvdXJjZS5kYXRhLm1hcChmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgcmV0dXJuIGRhdGEuaWQ7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBpZHM7CiAgICB9CiAgICAvKioKICAgICBgcHVzaGAgY2FuIGJlIHVzZWQgdG8gdXBkYXRlIHRoZSBkYXRhIGluIHRoZSByZWxhdGlvbnNoaXAgYW5kIEVtYmVyCiAgICAgRGF0YSB3aWxsIHRyZWF0IHRoZSBuZXcgZGF0YSBhcyB0aGUgY2Fub25pY2FsIHZhbHVlIG9mIHRoaXMKICAgICByZWxhdGlvbnNoaXAgb24gdGhlIGJhY2tlbmQuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgYXBwL21vZGVscy9wb3N0LmpzCiAgICAgaW1wb3J0IE1vZGVsLCB7IGhhc01hbnkgfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CiAgICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgIGNvbW1lbnRzOiBoYXNNYW55KHsgYXN5bmM6IHRydWUgfSkKICAgICB9KTsKICAgICBgYGAKICAgICAgYGBgCiAgICAgbGV0IHBvc3QgPSBzdG9yZS5wdXNoKHsKICAgICAgIGRhdGE6IHsKICAgICAgICAgdHlwZTogJ3Bvc3QnLAogICAgICAgICBpZDogMSwKICAgICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAgICAgIGNvbW1lbnRzOiB7CiAgICAgICAgICAgICBkYXRhOiBbeyB0eXBlOiAnY29tbWVudCcsIGlkOiAxIH1dCiAgICAgICAgICAgfQogICAgICAgICB9CiAgICAgICB9CiAgICAgfSk7CiAgICAgIGxldCBjb21tZW50c1JlZiA9IHBvc3QuaGFzTWFueSgnY29tbWVudHMnKTsKICAgICAgY29tbWVudHNSZWYuaWRzKCk7IC8vIFsnMSddCiAgICAgIGNvbW1lbnRzUmVmLnB1c2goWwogICAgIFt7IHR5cGU6ICdjb21tZW50JywgaWQ6IDIgfV0sCiAgICAgW3sgdHlwZTogJ2NvbW1lbnQnLCBpZDogMyB9XSwKICAgICBdKQogICAgICBjb21tZW50c1JlZi5pZHMoKTsgLy8gWycyJywgJzMnXQogICAgIGBgYAogICAgICBAbWV0aG9kIHB1c2gKICAgICBAcGFyYW0ge0FycmF5fFByb21pc2V9IG9iamVjdE9yUHJvbWlzZSBhIHByb21pc2UgdGhhdCByZXNvbHZlcyB0byBhIEpTT05BUEkgZG9jdW1lbnQgb2JqZWN0IGRlc2NyaWJpbmcgdGhlIG5ldyB2YWx1ZSBvZiB0aGlzIHJlbGF0aW9uc2hpcC4KICAgICBAcmV0dXJuIHtNYW55QXJyYXl9CiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucHVzaCA9IGZ1bmN0aW9uIHB1c2gob2JqZWN0T3JQcm9taXNlKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgcmV0dXJuIEVtYmVyLlJTVlAucmVzb2x2ZShvYmplY3RPclByb21pc2UpLnRoZW4oZnVuY3Rpb24gKHBheWxvYWQpIHsKICAgICAgICB2YXIgYXJyYXkgPSBwYXlsb2FkOwoKICAgICAgICBpZiAodHlwZW9mIHBheWxvYWQgPT09ICdvYmplY3QnICYmIHBheWxvYWQuZGF0YSkgewogICAgICAgICAgYXJyYXkgPSBwYXlsb2FkLmRhdGE7CiAgICAgICAgfQoKICAgICAgICB2YXIgaW50ZXJuYWxNb2RlbHMgPSBhcnJheS5tYXAoZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgdmFyIHJlY29yZCA9IF90aGlzMi5zdG9yZS5wdXNoKG9iaik7CgogICAgICAgICAgcmV0dXJuIHJlY29yZERhdGFGb3IocmVjb3JkKTsKICAgICAgICB9KTsKCiAgICAgICAgX3RoaXMyLmhhc01hbnlSZWxhdGlvbnNoaXAuY29tcHV0ZUNoYW5nZXMoaW50ZXJuYWxNb2RlbHMpOwoKICAgICAgICByZXR1cm4gX3RoaXMyLmludGVybmFsTW9kZWwuZ2V0SGFzTWFueShfdGhpczIuaGFzTWFueVJlbGF0aW9uc2hpcC5rZXkpOyAvLyBUT0RPIElHT1IgaXQgc2VlbXMgd3JvbmcgdGhhdCB3ZSB3ZXJlIHJldHVybmluZyB0aGUgbWFueSBhcnJheSBoZXJlCiAgICAgICAgLy9yZXR1cm4gdGhpcy5oYXNNYW55UmVsYXRpb25zaGlwLm1hbnlBcnJheTsKICAgICAgfSk7CiAgICB9OwoKICAgIF9wcm90by5faXNMb2FkZWQgPSBmdW5jdGlvbiBfaXNMb2FkZWQoKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgdmFyIGhhc1JlbGF0aW9uc2hpcERhdGFQcm9wZXJ0eSA9IEVtYmVyLmdldCh0aGlzLmhhc01hbnlSZWxhdGlvbnNoaXAsICdoYXNBbnlSZWxhdGlvbnNoaXBEYXRhJyk7CgogICAgICBpZiAoIWhhc1JlbGF0aW9uc2hpcERhdGFQcm9wZXJ0eSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgdmFyIG1lbWJlcnMgPSB0aGlzLmhhc01hbnlSZWxhdGlvbnNoaXAubWVtYmVycy50b0FycmF5KCk7IC8vVE9ETyBJZ29yIGNsZWFudXAKCiAgICAgIHJldHVybiBtZW1iZXJzLmV2ZXJ5KGZ1bmN0aW9uIChyZWNvcmREYXRhKSB7CiAgICAgICAgdmFyIHN0b3JlID0gX3RoaXMzLnBhcmVudEludGVybmFsTW9kZWwuc3RvcmU7CgogICAgICAgIHZhciBpbnRlcm5hbE1vZGVsID0gc3RvcmUuX2ludGVybmFsTW9kZWxGb3JSZXNvdXJjZShyZWNvcmREYXRhLmdldFJlc291cmNlSWRlbnRpZmllcigpKTsKCiAgICAgICAgcmV0dXJuIGludGVybmFsTW9kZWwuaXNMb2FkZWQoKSA9PT0gdHJ1ZTsKICAgICAgfSk7CiAgICB9CiAgICAvKioKICAgICBgdmFsdWUoKWAgc3luY2hyb25vdXNseSByZXR1cm5zIHRoZSBjdXJyZW50IHZhbHVlIG9mIHRoZSBoYXMtbWFueQogICAgIHJlbGF0aW9uc2hpcC4gVW5saWtlIGByZWNvcmQuZ2V0KCdyZWxhdGlvbnNoaXBOYW1lJylgLCBjYWxsaW5nCiAgICAgYHZhbHVlKClgIG9uIGEgcmVmZXJlbmNlIGRvZXMgbm90IHRyaWdnZXIgYSBmZXRjaCBpZiB0aGUgYXN5bmMKICAgICByZWxhdGlvbnNoaXAgaXMgbm90IHlldCBsb2FkZWQuIElmIHRoZSByZWxhdGlvbnNoaXAgaXMgbm90IGxvYWRlZAogICAgIGl0IHdpbGwgYWx3YXlzIHJldHVybiBgbnVsbGAuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgYXBwL21vZGVscy9wb3N0LmpzCiAgICAgaW1wb3J0IE1vZGVsLCB7IGhhc01hbnkgfSBmcm9tICdAZW1iZXItZGF0YS9tb2RlbCc7CiAgICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgIGNvbW1lbnRzOiBoYXNNYW55KHsgYXN5bmM6IHRydWUgfSkKICAgICB9KTsKICAgICBgYGAKICAgICAgYGBgamF2YXNjcmlwdAogICAgIGxldCBwb3N0ID0gc3RvcmUucHVzaCh7CiAgICAgICBkYXRhOiB7CiAgICAgICAgIHR5cGU6ICdwb3N0JywKICAgICAgICAgaWQ6IDEsCiAgICAgICAgIHJlbGF0aW9uc2hpcHM6IHsKICAgICAgICAgICBjb21tZW50czogewogICAgICAgICAgICAgZGF0YTogW3sgdHlwZTogJ2NvbW1lbnQnLCBpZDogMSB9XQogICAgICAgICAgIH0KICAgICAgICAgfQogICAgICAgfQogICAgIH0pOwogICAgICBsZXQgY29tbWVudHNSZWYgPSBwb3N0Lmhhc01hbnkoJ2NvbW1lbnRzJyk7CiAgICAgIHBvc3QuZ2V0KCdjb21tZW50cycpLnRoZW4oZnVuY3Rpb24oY29tbWVudHMpIHsKICAgICAgIGNvbW1lbnRzUmVmLnZhbHVlKCkgPT09IGNvbW1lbnRzCiAgICAgfSkKICAgICBgYGAKICAgICAgQG1ldGhvZCB2YWx1ZQogICAgIEByZXR1cm4ge01hbnlBcnJheX0KICAgICAqLwogICAgOwoKICAgIF9wcm90by52YWx1ZSA9IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICBpZiAodGhpcy5faXNMb2FkZWQoKSkgewogICAgICAgIHJldHVybiB0aGlzLmludGVybmFsTW9kZWwuZ2V0TWFueUFycmF5KHRoaXMua2V5KTsKICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICAvKioKICAgICBMb2FkcyB0aGUgcmVsYXRpb25zaGlwIGlmIGl0IGlzIG5vdCBhbHJlYWR5IGxvYWRlZC4gIElmIHRoZQogICAgIHJlbGF0aW9uc2hpcCBpcyBhbHJlYWR5IGxvYWRlZCB0aGlzIG1ldGhvZCBkb2VzIG5vdCB0cmlnZ2VyIGEgbmV3CiAgICAgbG9hZC4gVGhpcyBjYXVzZXMgYSByZXF1ZXN0IHRvIHRoZSBzcGVjaWZpZWQKICAgICByZWxhdGlvbnNoaXAgbGluayBvciByZWxvYWRzIGFsbCBpdGVtcyBjdXJyZW50bHkgaW4gdGhlIHJlbGF0aW9uc2hpcC4KICAgICAgRXhhbXBsZQogICAgICBgYGBhcHAvbW9kZWxzL3Bvc3QuanMKICAgICBpbXBvcnQgTW9kZWwsIHsgaGFzTWFueSB9IGZyb20gJ0BlbWJlci1kYXRhL21vZGVsJzsKICAgICBleHBvcnQgZGVmYXVsdCBNb2RlbC5leHRlbmQoewogICAgICAgY29tbWVudHM6IGhhc01hbnkoeyBhc3luYzogdHJ1ZSB9KQogICAgIH0pOwogICAgIGBgYAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgbGV0IHBvc3QgPSBzdG9yZS5wdXNoKHsKICAgICAgIGRhdGE6IHsKICAgICAgICAgdHlwZTogJ3Bvc3QnLAogICAgICAgICBpZDogMSwKICAgICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAgICAgIGNvbW1lbnRzOiB7CiAgICAgICAgICAgICBkYXRhOiBbeyB0eXBlOiAnY29tbWVudCcsIGlkOiAxIH1dCiAgICAgICAgICAgfQogICAgICAgICB9CiAgICAgICB9CiAgICAgfSk7CiAgICAgIGxldCBjb21tZW50c1JlZiA9IHBvc3QuaGFzTWFueSgnY29tbWVudHMnKTsKICAgICAgY29tbWVudHNSZWYubG9hZCgpLnRoZW4oZnVuY3Rpb24oY29tbWVudHMpIHsKICAgICAgIC8vLi4uCiAgICAgfSk7CiAgICAgYGBgCiAgICAgIFlvdSBtYXkgYWxzbyBwYXNzIGluIGFuIG9wdGlvbnMgb2JqZWN0IHdob3NlIHByb3BlcnRpZXMgd2lsbCBiZQogICAgIGZlZCBmb3J3YXJkLiBUaGlzIGVuYWJsZXMgeW91IHRvIHBhc3MgYGFkYXB0ZXJPcHRpb25zYCBpbnRvIHRoZQogICAgIHJlcXVlc3QgZ2l2ZW4gdG8gdGhlIGFkYXB0ZXIgdmlhIHRoZSByZWZlcmVuY2UuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgamF2YXNjcmlwdAogICAgIGNvbW1lbnRzUmVmLmxvYWQoeyBhZGFwdGVyT3B0aW9uczogeyBpc1ByaXZhdGU6IHRydWUgfSB9KQogICAgICAgLnRoZW4oZnVuY3Rpb24oY29tbWVudHMpIHsKICAgICAgICAgLy8uLi4KICAgICAgIH0pOwogICAgIGBgYAogICAgICBgYGBhcHAvYWRhcHRlcnMvY29tbWVudC5qcwogICAgIGV4cG9ydCBkZWZhdWx0IEFwcGxpY2F0aW9uQWRhcHRlci5leHRlbmQoewogICAgICAgZmluZE1hbnkoc3RvcmUsIHR5cGUsIGlkLCBzbmFwc2hvdHMpIHsKICAgICAgICAgLy8gSW4gdGhlIGFkYXB0ZXIgeW91IHdpbGwgaGF2ZSBhY2Nlc3MgdG8gYWRhcHRlck9wdGlvbnMuCiAgICAgICAgIGxldCBhZGFwdGVyT3B0aW9ucyA9IHNuYXBzaG90c1swXS5hZGFwdGVyT3B0aW9uczsKICAgICAgIH0KICAgICB9KTsKICAgICBgYGAKICAgICAgQG1ldGhvZCBsb2FkCiAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgdGhlIG9wdGlvbnMgdG8gcGFzcyBpbi4KICAgICBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2UgdGhhdCByZXNvbHZlcyB3aXRoIHRoZSBNYW55QXJyYXkgaW4KICAgICB0aGlzIGhhcy1tYW55IHJlbGF0aW9uc2hpcC4KICAgICAqLwogICAgOwoKICAgIF9wcm90by5sb2FkID0gZnVuY3Rpb24gbG9hZChvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLmludGVybmFsTW9kZWwuZ2V0SGFzTWFueSh0aGlzLmtleSwgb3B0aW9ucyk7CiAgICB9CiAgICAvKioKICAgICBSZWxvYWRzIHRoaXMgaGFzLW1hbnkgcmVsYXRpb25zaGlwLiBUaGlzIGNhdXNlcyBhIHJlcXVlc3QgdG8gdGhlIHNwZWNpZmllZAogICAgIHJlbGF0aW9uc2hpcCBsaW5rIG9yIHJlbG9hZHMgYWxsIGl0ZW1zIGN1cnJlbnRseSBpbiB0aGUgcmVsYXRpb25zaGlwLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGFwcC9tb2RlbHMvcG9zdC5qcwogICAgIGltcG9ydCBNb2RlbCwgeyBoYXNNYW55IH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogICAgIGV4cG9ydCBkZWZhdWx0IE1vZGVsLmV4dGVuZCh7CiAgICAgICBjb21tZW50czogaGFzTWFueSh7IGFzeW5jOiB0cnVlIH0pCiAgICAgfSk7CiAgICAgYGBgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBsZXQgcG9zdCA9IHN0b3JlLnB1c2goewogICAgICAgZGF0YTogewogICAgICAgICB0eXBlOiAncG9zdCcsCiAgICAgICAgIGlkOiAxLAogICAgICAgICByZWxhdGlvbnNoaXBzOiB7CiAgICAgICAgICAgY29tbWVudHM6IHsKICAgICAgICAgICAgIGRhdGE6IFt7IHR5cGU6ICdjb21tZW50JywgaWQ6IDEgfV0KICAgICAgICAgICB9CiAgICAgICAgIH0KICAgICAgIH0KICAgICB9KTsKICAgICAgbGV0IGNvbW1lbnRzUmVmID0gcG9zdC5oYXNNYW55KCdjb21tZW50cycpOwogICAgICBjb21tZW50c1JlZi5yZWxvYWQoKS50aGVuKGZ1bmN0aW9uKGNvbW1lbnRzKSB7CiAgICAgICAvLy4uLgogICAgIH0pOwogICAgIGBgYAogICAgICBZb3UgbWF5IGFsc28gcGFzcyBpbiBhbiBvcHRpb25zIG9iamVjdCB3aG9zZSBwcm9wZXJ0aWVzIHdpbGwgYmUKICAgICBmZWQgZm9yd2FyZC4gVGhpcyBlbmFibGVzIHlvdSB0byBwYXNzIGBhZGFwdGVyT3B0aW9uc2AgaW50byB0aGUKICAgICByZXF1ZXN0IGdpdmVuIHRvIHRoZSBhZGFwdGVyIHZpYSB0aGUgcmVmZXJlbmNlLiBBIGZ1bGwgZXhhbXBsZQogICAgIGNhbiBiZSBmb3VuZCBpbiB0aGUgYGxvYWRgIG1ldGhvZC4KICAgICAgRXhhbXBsZQogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgY29tbWVudHNSZWYucmVsb2FkKHsgYWRhcHRlck9wdGlvbnM6IHsgaXNQcml2YXRlOiB0cnVlIH0gfSkKICAgICBgYGAKICAgICAgQG1ldGhvZCByZWxvYWQKICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyB0aGUgb3B0aW9ucyB0byBwYXNzIGluLgogICAgIEByZXR1cm4ge1Byb21pc2V9IGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHdpdGggdGhlIE1hbnlBcnJheSBpbiB0aGlzIGhhcy1tYW55IHJlbGF0aW9uc2hpcC4KICAgICAqLwogICAgOwoKICAgIF9wcm90by5yZWxvYWQgPSBmdW5jdGlvbiByZWxvYWQob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5pbnRlcm5hbE1vZGVsLnJlbG9hZEhhc01hbnkodGhpcy5rZXksIG9wdGlvbnMpOwogICAgfTsKCiAgICByZXR1cm4gSGFzTWFueVJlZmVyZW5jZTsKICB9KFJlZmVyZW5jZSk7CgogIGZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0aWVzJDModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCiAgZnVuY3Rpb24gX2NyZWF0ZUNsYXNzJDMoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyQzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMkMyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCiAgLy8gb25jZSB0aGUgcHJlc2VudGF0aW9uIGxvZ2ljIGlzIG1vdmVkIGludG8gdGhlIE1vZGVsIHBhY2thZ2Ugd2UgY2FuIG1ha2UKICAvLyBlbGltaW5hdGUgdGhlc2UgbG9zc3kgYW5kIHJlZHVuZGFudCBoZWxwZXJzCiAgZnVuY3Rpb24gcmVsYXRpb25zaGlwc0ZvciQxKGluc3RhbmNlKSB7CiAgICB2YXIgcmVjb3JkRGF0YSA9IHJlY29yZERhdGFGb3IoaW5zdGFuY2UpOwogICAgcmV0dXJuIHJlY29yZERhdGEuX3JlbGF0aW9uc2hpcHM7CiAgfQoKICBmdW5jdGlvbiByZWxhdGlvbnNoaXBTdGF0ZUZvciQxKGluc3RhbmNlLCBwcm9wZXJ0eU5hbWUpIHsKICAgIHJldHVybiByZWxhdGlvbnNoaXBzRm9yJDEoaW5zdGFuY2UpLmdldChwcm9wZXJ0eU5hbWUpOwogIH0KCiAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyLWRhdGEvc3RvcmUKICAqLwogIC8vIG1vdmUgdG8gVFMgaGFja3MgbW9kdWxlIHRoYXQgd2UgY2FuIGRlbGV0ZSB3aGVuIHRoaXMgaXMgbm8gbG9uZ2VyIGEgbmVjZXNzYXJ5IHJlY2FzdAoKICAvLyBUT0RPIHRoaXMgc2hvdWxkIGJlIGludGVncmF0ZWQgd2l0aCB0aGUgY29kZSByZW1vdmFsIHNvIHdlIGNhbiB1c2UgaXQgdG9nZXRoZXIgd2l0aCB0aGUgaWYgY29uZGl0aW9uCiAgLy8gYW5kIG5vdCBhbG9uZ3NpZGUgaXQKICBmdW5jdGlvbiBpc05vdEN1c3RvbU1vZGVsQ2xhc3Moc3RvcmUpIHsKICAgIHJldHVybiAhY2FuYXJ5RmVhdHVyZXMuQ1VTVE9NX01PREVMX0NMQVNTOwogIH0KCiAgLyoKICAgIFRoZSBUcmFuc2l0aW9uQ2hhaW5NYXAgY2FjaGVzIHRoZSBgc3RhdGUuZW50ZXJzYCwgYHN0YXRlLnNldHVwc2AsIGFuZCBmaW5hbCBzdGF0ZSByZWFjaGVkCiAgICB3aGVuIHRyYW5zaXRpb25pbmcgZnJvbSBvbmUgc3RhdGUgdG8gYW5vdGhlciwgc28gdGhhdCBmdXR1cmUgdHJhbnNpdGlvbnMgY2FuIHJlcGxheSB0aGUKICAgIHRyYW5zaXRpb24gd2l0aG91dCBuZWVkaW5nIHRvIHdhbGsgdGhlIHN0YXRlIHRyZWUsIGNvbGxlY3QgdGhlc2UgaG9vayBjYWxscyBhbmQgZGV0ZXJtaW5lCiAgICAgdGhlIHN0YXRlIHRvIHRyYW5zaXRpb24gaW50by4KCiAgICAgQSBmdXR1cmUgb3B0aW1pemF0aW9uIHdvdWxkIGJlIHRvIGJ1aWxkIGEgc2luZ2xlIGNoYWluZWQgbWV0aG9kIG91dCBvZiB0aGUgY29sbGVjdGVkIGVudGVycwogICAgIGFuZCBzZXR1cHMuIEl0IG1heSBhbHNvIGJlIGZhc3RlciB0byBkbyBhIHR3byBsZXZlbCBjYWNoZSAoZnJvbTogeyB0byB9KSBpbnN0ZWFkIG9mIGNhY2hpbmcgYmFzZWQKICAgICBvbiBhIGtleSB0aGF0IGFkZHMgdGhlIHR3byB0b2dldGhlci4KICAgKi8KICB2YXIgVHJhbnNpdGlvbkNoYWluTWFwID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCiAgdmFyIF9leHRyYWN0UGl2b3ROYW1lQ2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwoKICB2YXIgX3NwbGl0T25Eb3RDYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CgogIGZ1bmN0aW9uIHNwbGl0T25Eb3QobmFtZSkgewogICAgcmV0dXJuIF9zcGxpdE9uRG90Q2FjaGVbbmFtZV0gfHwgKF9zcGxpdE9uRG90Q2FjaGVbbmFtZV0gPSBuYW1lLnNwbGl0KCcuJykpOwogIH0KCiAgZnVuY3Rpb24gZXh0cmFjdFBpdm90TmFtZShuYW1lKSB7CiAgICByZXR1cm4gX2V4dHJhY3RQaXZvdE5hbWVDYWNoZVtuYW1lXSB8fCAoX2V4dHJhY3RQaXZvdE5hbWVDYWNoZVtuYW1lXSA9IHNwbGl0T25Eb3QobmFtZSlbMF0pOwogIH0KICAvKgogICAgYEludGVybmFsTW9kZWxgIGlzIHRoZSBNb2RlbCBjbGFzcyB0aGF0IHdlIHVzZSBpbnRlcm5hbGx5IGluc2lkZSBFbWJlciBEYXRhIHRvIHJlcHJlc2VudCBtb2RlbHMuCiAgICBJbnRlcm5hbCBFRCBtZXRob2RzIHNob3VsZCBvbmx5IGRlYWwgd2l0aCBgSW50ZXJuYWxNb2RlbGAgb2JqZWN0cy4gSXQgaXMgYSBmYXN0LCBwbGFpbiBKYXZhc2NyaXB0IGNsYXNzLgoKICAgIFdlIGV4cG9zZSBgTW9kZWxgIHRvIGFwcGxpY2F0aW9uIGNvZGUsIGJ5IG1hdGVyaWFsaXppbmcgYSBgTW9kZWxgIGZyb20gYEludGVybmFsTW9kZWxgIGxhemlseSwgYXMKICAgIGEgcGVyZm9ybWFuY2Ugb3B0aW1pemF0aW9uLgoKICAgIGBJbnRlcm5hbE1vZGVsYCBzaG91bGQgbmV2ZXIgYmUgZXhwb3NlZCB0byBhcHBsaWNhdGlvbiBjb2RlLiBBdCB0aGUgYm91bmRhcmllcyBvZiB0aGUgc3lzdGVtLCBpbiBwbGFjZXMKICAgIGxpa2UgYGZpbmRgLCBgcHVzaGAsIGV0Yy4gd2UgY29udmVydCBiZXR3ZWVuIE1vZGVscyBhbmQgSW50ZXJuYWxNb2RlbHMuCgogICAgV2UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdCB0aGUgcHJvcGVydGllcyBmcm9tIGBJbnRlcm5hbE1vZGVsYCBhcmUgY29ycmVjdGx5IGV4cG9zZWQvcHJveGllZCBvbiBgTW9kZWxgCiAgICBpZiB0aGV5IGFyZSBuZWVkZWQuCgogICAgQHByaXZhdGUKICAgIEBjbGFzcyBJbnRlcm5hbE1vZGVsCiAgKi8KCgogIHZhciBJbnRlcm5hbE1vZGVsID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgLy8gTm90IHR5cGVkIHlldAogICAgLy8gVGhlIHByZXZpb3VzIE1hbnlBcnJheXMgZm9yIHRoaXMgcmVsYXRpb25zaGlwIHdoaWNoIHdpbGwgYmUgZGVzdHJveWVkIHdoZW4KICAgIC8vIHdlIGNyZWF0ZSBhIG5ldyBNYW55QXJyYXksIGJ1dCBpbiB0aGUgaW50ZXJpbSB0aGUgcmV0YWluZWQgdmVyc2lvbiB3aWxsIGJlCiAgICAvLyB1cGRhdGVkIGlmIGludmVyc2UgaW50ZXJuYWwgbW9kZWxzIGFyZSB1bmxvYWRlZC4KICAgIGZ1bmN0aW9uIEludGVybmFsTW9kZWwoc3RvcmUsIGlkZW50aWZpZXIpIHsKICAgICAgdGhpcy5zdG9yZSA9IHN0b3JlOwogICAgICB0aGlzLmlkZW50aWZpZXIgPSBpZGVudGlmaWVyOwogICAgICB0aGlzLl9pZCA9IHZvaWQgMDsKICAgICAgdGhpcy5tb2RlbE5hbWUgPSB2b2lkIDA7CiAgICAgIHRoaXMuY2xpZW50SWQgPSB2b2lkIDA7CiAgICAgIHRoaXMuX19yZWNvcmREYXRhID0gdm9pZCAwOwogICAgICB0aGlzLl9pc0Rlc3Ryb3llZCA9IHZvaWQgMDsKICAgICAgdGhpcy5pc0Vycm9yID0gdm9pZCAwOwogICAgICB0aGlzLl9wZW5kaW5nUmVjb3JkQXJyYXlNYW5hZ2VyRmx1c2ggPSB2b2lkIDA7CiAgICAgIHRoaXMuX2lzRGVtYXRlcmlhbGl6aW5nID0gdm9pZCAwOwogICAgICB0aGlzLmlzUmVsb2FkaW5nID0gdm9pZCAwOwogICAgICB0aGlzLl9kb05vdERlc3Ryb3kgPSB2b2lkIDA7CiAgICAgIHRoaXMuaXNEZXN0cm95aW5nID0gdm9pZCAwOwogICAgICB0aGlzLl9wcm9taXNlUHJveHkgPSB2b2lkIDA7CiAgICAgIHRoaXMuX3JlY29yZCA9IHZvaWQgMDsKICAgICAgdGhpcy5fc2NoZWR1bGVkRGVzdHJveSA9IHZvaWQgMDsKICAgICAgdGhpcy5fbW9kZWxDbGFzcyA9IHZvaWQgMDsKICAgICAgdGhpcy5fX2RlZmVycmVkVHJpZ2dlcnMgPSB2b2lkIDA7CiAgICAgIHRoaXMuX19yZWNvcmRBcnJheXMgPSB2b2lkIDA7CiAgICAgIHRoaXMuX3JlZmVyZW5jZXMgPSB2b2lkIDA7CiAgICAgIHRoaXMuX3JlY29yZFJlZmVyZW5jZSA9IHZvaWQgMDsKICAgICAgdGhpcy5fbWFueUFycmF5Q2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB0aGlzLl9yZXRhaW5lZE1hbnlBcnJheUNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgdGhpcy5fcmVsYXRpb25zaGlwUHJvbWlzZXNDYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHRoaXMuX3JlbGF0aW9uc2hpcFByb3h5Q2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB0aGlzLmN1cnJlbnRTdGF0ZSA9IHZvaWQgMDsKICAgICAgdGhpcy5lcnJvciA9IHZvaWQgMDsKICAgICAgdGhpcy5faWQgPSBpZGVudGlmaWVyLmlkOwogICAgICB0aGlzLm1vZGVsTmFtZSA9IGlkZW50aWZpZXIudHlwZTsKICAgICAgdGhpcy5jbGllbnRJZCA9IGlkZW50aWZpZXIubGlkOwogICAgICB0aGlzLl9fcmVjb3JkRGF0YSA9IG51bGw7IC8vIHRoaXMgZW5zdXJlIG9yZGVyZWQgc2V0IGNhbiBxdWlja2x5IGlkZW50aWZ5IHRoaXMgYXMgdW5pcXVlCgogICAgICB0aGlzW0VtYmVyLkdVSURfS0VZXSA9IGlkZW50aWZpZXIubGlkOwogICAgICB0aGlzLl9wcm9taXNlUHJveHkgPSBudWxsOwogICAgICB0aGlzLl9yZWNvcmQgPSBudWxsOwogICAgICB0aGlzLl9pc0Rlc3Ryb3llZCA9IGZhbHNlOwogICAgICB0aGlzLmlzRXJyb3IgPSBmYWxzZTsKICAgICAgdGhpcy5fcGVuZGluZ1JlY29yZEFycmF5TWFuYWdlckZsdXNoID0gZmFsc2U7IC8vIHVzZWQgYnkgdGhlIHJlY29yZEFycmF5TWFuYWdlcgogICAgICAvLyBEdXJpbmcgZGVtYXRlcmlhbGl6YXRpb24gd2UgZG9uJ3Qgd2FudCB0byByZW1hdGVyaWFsaXplIHRoZSByZWNvcmQuICBUaGUKICAgICAgLy8gcmVhc29uIHRoaXMgbWlnaHQgaGFwcGVuIGlzIHRoYXQgZGVtYXRlcmlhbGl6YXRpb24gcmVtb3ZlcyByZWNvcmRzIGZyb20KICAgICAgLy8gcmVjb3JkIGFycmF5cywgIGFuZCBFbWJlciBhcnJheXMgd2lsbCBhbHdheXMgYG9iamVjdEF0KDApYCBhbmQKICAgICAgLy8gYG9iamVjdEF0KGxlbiAtIDEpYCB0byB0ZXN0IHdoZXRoZXIgb3Igbm90IGBmaXJzdE9iamVjdGAgb3IgYGxhc3RPYmplY3RgCiAgICAgIC8vIGhhdmUgY2hhbmdlZC4KCiAgICAgIHRoaXMuX2lzRGVtYXRlcmlhbGl6aW5nID0gZmFsc2U7CiAgICAgIHRoaXMuX3NjaGVkdWxlZERlc3Ryb3kgPSBudWxsOwogICAgICB0aGlzLnJlc2V0UmVjb3JkKCk7IC8vIGNhY2hlcyBmb3IgbGF6eSBnZXR0ZXJzCgogICAgICB0aGlzLl9tb2RlbENsYXNzID0gbnVsbDsKICAgICAgdGhpcy5fX2RlZmVycmVkVHJpZ2dlcnMgPSBudWxsOwogICAgICB0aGlzLl9fcmVjb3JkQXJyYXlzID0gbnVsbDsKICAgICAgdGhpcy5fcmVmZXJlbmNlcyA9IG51bGw7CiAgICAgIHRoaXMuX3JlY29yZFJlZmVyZW5jZSA9IG51bGw7CiAgICB9CgogICAgdmFyIF9wcm90byA9IEludGVybmFsTW9kZWwucHJvdG90eXBlOwoKICAgIF9wcm90by5pc0hpZGRlbkZyb21SZWNvcmRBcnJheXMgPSBmdW5jdGlvbiBpc0hpZGRlbkZyb21SZWNvcmRBcnJheXMoKSB7CiAgICAgIC8vIER1cmluZyBkZW1hdGVyaWFsaXphdGlvbiB3ZSBkb24ndCB3YW50IHRvIHJlbWF0ZXJpYWxpemUgdGhlIHJlY29yZC4KICAgICAgLy8gcmVjb3JkV2FzRGVsZXRlZCBjYW4gY2F1c2Ugb3RoZXIgcmVjb3JkcyB0byByZW1hdGVyaWFsaXplIGJlY2F1c2UgaXQKICAgICAgLy8gcmVtb3ZlcyB0aGUgaW50ZXJuYWwgbW9kZWwgZnJvbSB0aGUgYXJyYXkgYW5kIEVtYmVyIGFycmF5cyB3aWxsIGFsd2F5cwogICAgICAvLyBgb2JqZWN0QXQoMClgIGFuZCBgb2JqZWN0QXQobGVuIC0xKWAgdG8gY2hlY2sgd2hldGhlciBgZmlyc3RPYmplY3RgIG9yCiAgICAgIC8vIGBsYXN0T2JqZWN0YCBoYXZlIGNoYW5nZWQuICBXaGVuIHRoaXMgaGFwcGVucyB3ZSBkb24ndCB3YW50IHRob3NlCiAgICAgIC8vIG1vZGVscyB0byByZW1hdGVyaWFsaXplIHRoZWlyIHJlY29yZHMuCiAgICAgIC8vIGVhZ2VyIGNoZWNrcyB0byBhdm9pZCBpbnN0YW50aWF0aW5nIHJlY29yZCBkYXRhIGlmIHdlIGFyZSBlbXB0eSBvciBsb2FkaW5nCiAgICAgIGlmICh0aGlzLmlzRW1wdHkoKSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuUkVDT1JEX0RBVEFfU1RBVEUpIHsKICAgICAgICBpZiAodGhpcy5pc0xvYWRpbmcoKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIGlzUmVjb3JkRnVsbHlEZWxldGVkOwoKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFQ09SRF9EQVRBX1NUQVRFKSB7CiAgICAgICAgaXNSZWNvcmRGdWxseURlbGV0ZWQgPSB0aGlzLl9pc1JlY29yZEZ1bGx5RGVsZXRlZCgpOwogICAgICB9IGVsc2UgewogICAgICAgIGlzUmVjb3JkRnVsbHlEZWxldGVkID0gdGhpcy5jdXJyZW50U3RhdGUuc3RhdGVOYW1lID09PSAncm9vdC5kZWxldGVkLnNhdmVkJzsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuX2lzRGVtYXRlcmlhbGl6aW5nIHx8IHRoaXMuaGFzU2NoZWR1bGVkRGVzdHJveSgpIHx8IHRoaXMuaXNEZXN0cm95ZWQgfHwgaXNSZWNvcmRGdWxseURlbGV0ZWQ7CiAgICB9OwoKICAgIF9wcm90by5faXNSZWNvcmRGdWxseURlbGV0ZWQgPSBmdW5jdGlvbiBfaXNSZWNvcmRGdWxseURlbGV0ZWQoKSB7CiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5SRUNPUkRfREFUQV9TVEFURSkgewogICAgICAgIGlmICh0aGlzLl9yZWNvcmREYXRhLmlzRGVsZXRpb25Db21taXR0ZWQgJiYgdGhpcy5fcmVjb3JkRGF0YS5pc0RlbGV0aW9uQ29tbWl0dGVkKCkpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5fcmVjb3JkRGF0YS5pc05ldyAmJiB0aGlzLl9yZWNvcmREYXRhLmlzRGVsZXRlZCAmJiB0aGlzLl9yZWNvcmREYXRhLmlzTmV3KCkgJiYgdGhpcy5fcmVjb3JkRGF0YS5pc0RlbGV0ZWQoKSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRTdGF0ZS5zdGF0ZU5hbWUgPT09ICdyb290LmRlbGV0ZWQuc2F2ZWQnOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBhc3NlcnQgaGVyZQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uaXNSZWNvcmRJblVzZSA9IGZ1bmN0aW9uIGlzUmVjb3JkSW5Vc2UoKSB7CiAgICAgIHZhciByZWNvcmQgPSB0aGlzLl9yZWNvcmQ7CiAgICAgIHJldHVybiByZWNvcmQgJiYgIShyZWNvcmQuZ2V0KCdpc0Rlc3Ryb3llZCcpIHx8IHJlY29yZC5nZXQoJ2lzRGVzdHJveWluZycpKTsKICAgIH07CgogICAgX3Byb3RvLmlzRW1wdHkgPSBmdW5jdGlvbiBpc0VtcHR5KCkgewogICAgICByZXR1cm4gdGhpcy5jdXJyZW50U3RhdGUuaXNFbXB0eTsKICAgIH07CgogICAgX3Byb3RvLmlzTG9hZGluZyA9IGZ1bmN0aW9uIGlzTG9hZGluZygpIHsKICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFN0YXRlLmlzTG9hZGluZzsKICAgIH07CgogICAgX3Byb3RvLmlzTG9hZGVkID0gZnVuY3Rpb24gaXNMb2FkZWQoKSB7CiAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRTdGF0ZS5pc0xvYWRlZDsKICAgIH07CgogICAgX3Byb3RvLmhhc0RpcnR5QXR0cmlidXRlcyA9IGZ1bmN0aW9uIGhhc0RpcnR5QXR0cmlidXRlcygpIHsKICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFN0YXRlLmhhc0RpcnR5QXR0cmlidXRlczsKICAgIH07CgogICAgX3Byb3RvLmlzU2F2aW5nID0gZnVuY3Rpb24gaXNTYXZpbmcoKSB7CiAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRTdGF0ZS5pc1NhdmluZzsKICAgIH07CgogICAgX3Byb3RvLmlzRGVsZXRlZCA9IGZ1bmN0aW9uIGlzRGVsZXRlZCgpIHsKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFQ09SRF9EQVRBX1NUQVRFKSB7CiAgICAgICAgaWYgKHRoaXMuX3JlY29yZERhdGEuaXNEZWxldGVkKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmVjb3JkRGF0YS5pc0RlbGV0ZWQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFN0YXRlLmlzRGVsZXRlZDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFN0YXRlLmlzRGVsZXRlZDsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uaXNOZXcgPSBmdW5jdGlvbiBpc05ldygpIHsKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFQ09SRF9EQVRBX1NUQVRFKSB7CiAgICAgICAgaWYgKHRoaXMuX3JlY29yZERhdGEuaXNOZXcpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZWNvcmREYXRhLmlzTmV3KCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRTdGF0ZS5pc05ldzsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFN0YXRlLmlzTmV3OwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5pc1ZhbGlkID0gZnVuY3Rpb24gaXNWYWxpZCgpIHsKICAgICAgaWYgKCFjYW5hcnlGZWF0dXJlcy5SRUNPUkRfREFUQV9FUlJPUlMpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50U3RhdGUuaXNWYWxpZDsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uZGlydHlUeXBlID0gZnVuY3Rpb24gZGlydHlUeXBlKCkgewogICAgICByZXR1cm4gdGhpcy5jdXJyZW50U3RhdGUuZGlydHlUeXBlOwogICAgfTsKCiAgICBfcHJvdG8uZ2V0UmVjb3JkID0gZnVuY3Rpb24gZ2V0UmVjb3JkKHByb3BlcnRpZXMpIHsKICAgICAgaWYgKCF0aGlzLl9yZWNvcmQgJiYgIXRoaXMuX2lzRGVtYXRlcmlhbGl6aW5nKSB7CiAgICAgICAgdmFyIF9zdG9yZSA9IHRoaXMuc3RvcmU7CgogICAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MpIHsKICAgICAgICAgIHRoaXMuX3JlY29yZCA9IF9zdG9yZS5faW5zdGFudGlhdGVSZWNvcmQodGhpcywgdGhpcy5tb2RlbE5hbWUsIHRoaXMuX3JlY29yZERhdGEsIHRoaXMuaWRlbnRpZmllciwgcHJvcGVydGllcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChpc05vdEN1c3RvbU1vZGVsQ2xhc3MoKSkgewogICAgICAgICAgICAvLyBsb29rdXBGYWN0b3J5IHNob3VsZCByZWFsbHkgcmV0dXJuIGFuIG9iamVjdCB0aGF0IGNyZWF0ZXMKICAgICAgICAgICAgLy8gaW5zdGFuY2VzIHdpdGggdGhlIGluamVjdGlvbnMgYXBwbGllZAogICAgICAgICAgICB2YXIgY3JlYXRlT3B0aW9ucyA9IHsKICAgICAgICAgICAgICBzdG9yZTogX3N0b3JlLAogICAgICAgICAgICAgIF9pbnRlcm5hbE1vZGVsOiB0aGlzLAogICAgICAgICAgICAgIGN1cnJlbnRTdGF0ZTogdGhpcy5jdXJyZW50U3RhdGUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmICghY2FuYXJ5RmVhdHVyZXMuUkVRVUVTVF9TRVJWSUNFKSB7CiAgICAgICAgICAgICAgY3JlYXRlT3B0aW9ucy5pc0Vycm9yID0gdGhpcy5pc0Vycm9yOwogICAgICAgICAgICAgIGNyZWF0ZU9wdGlvbnMuYWRhcHRlckVycm9yID0gdGhpcy5lcnJvcjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMgIT09IHVuZGVmaW5lZCkgewoKICAgICAgICAgICAgICBpZiAoJ2lkJyBpbiBwcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgaWQgPSBjb2VyY2VJZChwcm9wZXJ0aWVzLmlkKTsKCiAgICAgICAgICAgICAgICBpZiAoaWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJZChpZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSAvLyBjb252ZXJ0IHJlbGF0aW9uc2hpcCBSZWNvcmRzIHRvIFJlY29yZERhdGFzIGJlZm9yZSBwYXNzaW5nIHRvIFJlY29yZERhdGEKCgogICAgICAgICAgICAgIHZhciBkZWZzID0gX3N0b3JlLl9yZWxhdGlvbnNoaXBzRGVmaW5pdGlvbkZvcih0aGlzLm1vZGVsTmFtZSk7CgogICAgICAgICAgICAgIGlmIChkZWZzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHByb3BlcnRpZXMpOwogICAgICAgICAgICAgICAgdmFyIHJlbGF0aW9uc2hpcFZhbHVlOwoKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICB2YXIgcHJvcCA9IGtleXNbaV07CiAgICAgICAgICAgICAgICAgIHZhciBkZWYgPSBkZWZzW3Byb3BdOwoKICAgICAgICAgICAgICAgICAgaWYgKGRlZiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlZi5raW5kID09PSAnaGFzTWFueScpIHsKCiAgICAgICAgICAgICAgICAgICAgICByZWxhdGlvbnNoaXBWYWx1ZSA9IGV4dHJhY3RSZWNvcmREYXRhc0Zyb21SZWNvcmRzKHByb3BlcnRpZXNbcHJvcF0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZWxhdGlvbnNoaXBWYWx1ZSA9IGV4dHJhY3RSZWNvcmREYXRhRnJvbVJlY29yZChwcm9wZXJ0aWVzW3Byb3BdKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHByb3BlcnRpZXNbcHJvcF0gPSByZWxhdGlvbnNoaXBWYWx1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGFkZGl0aW9uYWxDcmVhdGVPcHRpb25zID0gdGhpcy5fcmVjb3JkRGF0YS5faW5pdFJlY29yZENyZWF0ZU9wdGlvbnMocHJvcGVydGllcyk7CgogICAgICAgICAgICBFbWJlci5hc3NpZ24oY3JlYXRlT3B0aW9ucywgYWRkaXRpb25hbENyZWF0ZU9wdGlvbnMpOyAvLyBlbnN1cmUgdGhhdCBgZ2V0T3duZXIodGhpcylgIHdvcmtzIGluc2lkZSBhIG1vZGVsIGluc3RhbmNlCgogICAgICAgICAgICBFbWJlci5zZXRPd25lcihjcmVhdGVPcHRpb25zLCBFbWJlci5nZXRPd25lcihfc3RvcmUpKTsKICAgICAgICAgICAgdGhpcy5fcmVjb3JkID0gX3N0b3JlLl9tb2RlbEZhY3RvcnlGb3IodGhpcy5tb2RlbE5hbWUpLmNyZWF0ZShjcmVhdGVPcHRpb25zKTsKICAgICAgICAgICAgc2V0UmVjb3JkSWRlbnRpZmllcih0aGlzLl9yZWNvcmQsIHRoaXMuaWRlbnRpZmllcik7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLl90cmlnZ2VyRGVmZXJyZWRUcmlnZ2VycygpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fcmVjb3JkOwogICAgfTsKCiAgICBfcHJvdG8ucmVzZXRSZWNvcmQgPSBmdW5jdGlvbiByZXNldFJlY29yZCgpIHsKICAgICAgdGhpcy5fcmVjb3JkID0gbnVsbDsKICAgICAgdGhpcy5pc1JlbG9hZGluZyA9IGZhbHNlOwogICAgICB0aGlzLmVycm9yID0gbnVsbDsKICAgICAgdGhpcy5jdXJyZW50U3RhdGUgPSBSb290U3RhdGUkMS5lbXB0eTsKICAgIH07CgogICAgX3Byb3RvLmRlbWF0ZXJpYWxpemVSZWNvcmQgPSBmdW5jdGlvbiBkZW1hdGVyaWFsaXplUmVjb3JkKCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdGhpcy5faXNEZW1hdGVyaWFsaXppbmcgPSB0cnVlOyAvLyBUT0RPIElHT1IgYWRkIGEgdGVzdCB0aGF0IGZhaWxzIHdoZW4gdGhpcyBpcyBtaXNzaW5nLCBzb21ldGhpbmcgdGhhdCBpbnZvbHZlcyBjYW5jZWxpaW5nIGEgZGVzdHJveQogICAgICAvLyBhbmQgdGhlIGRlc3Ryb3kgbm90IGhhcHBlbmluZywgYW5kIHRoZW4gbGF0ZXIgb24gdHJ5aW5nIHRvIGRlc3Ryb3kKCiAgICAgIHRoaXMuX2RvTm90RGVzdHJveSA9IGZhbHNlOwoKICAgICAgaWYgKHRoaXMuX3JlY29yZCkgewogICAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MpIHsKICAgICAgICAgIHRoaXMuc3RvcmUudGVhcmRvd25SZWNvcmQodGhpcy5fcmVjb3JkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fcmVjb3JkLmRlc3Ryb3koKTsKICAgICAgICB9CgogICAgICAgIE9iamVjdC5rZXlzKHRoaXMuX3JlbGF0aW9uc2hpcFByb3h5Q2FjaGUpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgaWYgKF90aGlzLl9yZWxhdGlvbnNoaXBQcm94eUNhY2hlW2tleV0uZGVzdHJveSkgewogICAgICAgICAgICBfdGhpcy5fcmVsYXRpb25zaGlwUHJveHlDYWNoZVtrZXldLmRlc3Ryb3koKTsKICAgICAgICAgIH0KCiAgICAgICAgICBkZWxldGUgX3RoaXMuX3JlbGF0aW9uc2hpcFByb3h5Q2FjaGVba2V5XTsKICAgICAgICB9KTsKICAgICAgICBPYmplY3Qua2V5cyh0aGlzLl9tYW55QXJyYXlDYWNoZSkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICB2YXIgbWFueUFycmF5ID0gX3RoaXMuX3JldGFpbmVkTWFueUFycmF5Q2FjaGVba2V5XSA9IF90aGlzLl9tYW55QXJyYXlDYWNoZVtrZXldOwogICAgICAgICAgZGVsZXRlIF90aGlzLl9tYW55QXJyYXlDYWNoZVtrZXldOwoKICAgICAgICAgIGlmIChtYW55QXJyYXkgJiYgIW1hbnlBcnJheS5faW52ZXJzZUlzQXN5bmMpIHsKICAgICAgICAgICAgLyoKICAgICAgICAgICAgICBJZiB0aGUgbWFueUFycmF5IGlzIGZvciBhIHN5bmMgcmVsYXRpb25zaGlwLCB3ZSBzaG91bGQgY2xlYXIgaXQKICAgICAgICAgICAgICAgIHRvIHByZXNlcnZlIHRoZSBzZW1hbnRpY3Mgb2YgY2xpZW50LXNpZGUgZGVsZXRlLgogICAgICAgICAgICAgICBJdCBpcyBsaWtlbHkgaW4gdGhpcyBjYXNlIGluc3RlYWQgb2YgcmV0YWluaW5nIHdlIHNob3VsZCBkZXN0cm95CiAgICAgICAgICAgICAgICAtIEBydW5zcGlyZWQKICAgICAgICAgICAgKi8KICAgICAgICAgICAgbWFueUFycmF5LmNsZWFyKCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0gLy8gbW92ZSB0byBhbiBlbXB0eSBuZXZlci1sb2FkZWQgc3RhdGUKCgogICAgICB0aGlzLl9yZWNvcmREYXRhLnVubG9hZFJlY29yZCgpOwoKICAgICAgdGhpcy5yZXNldFJlY29yZCgpOwogICAgICB0aGlzLnVwZGF0ZVJlY29yZEFycmF5cygpOwogICAgfTsKCiAgICBfcHJvdG8uZGVsZXRlUmVjb3JkID0gZnVuY3Rpb24gZGVsZXRlUmVjb3JkKCkgewogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuUkVDT1JEX0RBVEFfU1RBVEUpIHsKICAgICAgICBpZiAodGhpcy5fcmVjb3JkRGF0YS5zZXRJc0RlbGV0ZWQpIHsKICAgICAgICAgIHRoaXMuX3JlY29yZERhdGEuc2V0SXNEZWxldGVkKHRydWUpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5zZW5kKCdkZWxldGVSZWNvcmQnKTsKICAgIH07CgogICAgX3Byb3RvLnNhdmUgPSBmdW5jdGlvbiBzYXZlKG9wdGlvbnMpIHsKICAgICAgdmFyIHByb21pc2VMYWJlbCA9ICdEUzogTW9kZWwjc2F2ZSAnICsgdGhpczsKICAgICAgdmFyIHJlc29sdmVyID0gRW1iZXIuUlNWUC5kZWZlcihwcm9taXNlTGFiZWwpOwoKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFUVVFU1RfU0VSVklDRSkgewogICAgICAgIC8vIENhc3RpbmcgdG8gbmFycm93IGR1ZSB0byB0aGUgZmVhdHVyZSBmbGFnIHBhdGhzIGluc2lkZSBzY2hlZHVsZVNhdmUKICAgICAgICByZXR1cm4gdGhpcy5zdG9yZS5zY2hlZHVsZVNhdmUodGhpcywgcmVzb2x2ZXIsIG9wdGlvbnMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc3RvcmUuc2NoZWR1bGVTYXZlKHRoaXMsIHJlc29sdmVyLCBvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb2x2ZXIucHJvbWlzZTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uc3RhcnRlZFJlbG9hZGluZyA9IGZ1bmN0aW9uIHN0YXJ0ZWRSZWxvYWRpbmcoKSB7CiAgICAgIHRoaXMuaXNSZWxvYWRpbmcgPSB0cnVlOwoKICAgICAgaWYgKHRoaXMuaGFzUmVjb3JkKSB7CiAgICAgICAgRW1iZXIuc2V0KHRoaXMuX3JlY29yZCwgJ2lzUmVsb2FkaW5nJywgdHJ1ZSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLmZpbmlzaGVkUmVsb2FkaW5nID0gZnVuY3Rpb24gZmluaXNoZWRSZWxvYWRpbmcoKSB7CiAgICAgIHRoaXMuaXNSZWxvYWRpbmcgPSBmYWxzZTsKCiAgICAgIGlmICh0aGlzLmhhc1JlY29yZCkgewogICAgICAgIEVtYmVyLnNldCh0aGlzLl9yZWNvcmQsICdpc1JlbG9hZGluZycsIGZhbHNlKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8ucmVsb2FkID0gZnVuY3Rpb24gcmVsb2FkKG9wdGlvbnMpIHsKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFUVVFU1RfU0VSVklDRSkgewogICAgICAgIGlmICghb3B0aW9ucykgewogICAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zdGFydGVkUmVsb2FkaW5nKCk7CiAgICAgICAgdmFyIGludGVybmFsTW9kZWwgPSB0aGlzOwogICAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsLnN0b3JlLl9yZWxvYWRSZWNvcmQoaW50ZXJuYWxNb2RlbCwgb3B0aW9ucykudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAvL1RPRE8gTk9XIHNlZW1zIGxpa2Ugd2Ugc2hvdWxkbid0IG5lZWQgdG8gZG8gdGhpcwogICAgICAgICAgcmV0dXJuIGludGVybmFsTW9kZWw7CiAgICAgICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9LCAnRFM6IE1vZGVsI3JlbG9hZCBjb21wbGV0ZSwgdXBkYXRlIGZsYWdzJykuZmluYWxseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpbnRlcm5hbE1vZGVsLmZpbmlzaGVkUmVsb2FkaW5nKCk7CiAgICAgICAgICBpbnRlcm5hbE1vZGVsLnVwZGF0ZVJlY29yZEFycmF5cygpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc3RhcnRlZFJlbG9hZGluZygpOwoKICAgICAgICB2YXIgX2ludGVybmFsTW9kZWwgPSB0aGlzOwoKICAgICAgICB2YXIgcHJvbWlzZUxhYmVsID0gJ0RTOiBNb2RlbCNyZWxvYWQgb2YgJyArIHRoaXM7CiAgICAgICAgcmV0dXJuIG5ldyBFbWJlci5SU1ZQLlByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgICAgICAgIF9pbnRlcm5hbE1vZGVsLnNlbmQoJ3JlbG9hZFJlY29yZCcsIHsKICAgICAgICAgICAgcmVzb2x2ZTogcmVzb2x2ZSwKICAgICAgICAgICAgb3B0aW9uczogb3B0aW9ucwogICAgICAgICAgfSk7CiAgICAgICAgfSwgcHJvbWlzZUxhYmVsKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIF9pbnRlcm5hbE1vZGVsLmRpZENsZWFuRXJyb3IoKTsKCiAgICAgICAgICByZXR1cm4gX2ludGVybmFsTW9kZWw7CiAgICAgICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICBfaW50ZXJuYWxNb2RlbC5kaWRFcnJvcihlcnJvcik7CgogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfSwgJ0RTOiBNb2RlbCNyZWxvYWQgY29tcGxldGUsIHVwZGF0ZSBmbGFncycpLmZpbmFsbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgX2ludGVybmFsTW9kZWwuZmluaXNoZWRSZWxvYWRpbmcoKTsKCiAgICAgICAgICBfaW50ZXJuYWxNb2RlbC51cGRhdGVSZWNvcmRBcnJheXMoKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogICAgLyoKICAgICAgVW5sb2FkIHRoZSByZWNvcmQgZm9yIHRoaXMgaW50ZXJuYWwgbW9kZWwuIFRoaXMgd2lsbCBjYXVzZSB0aGUgcmVjb3JkIHRvIGJlCiAgICAgIGRlc3Ryb3llZCBhbmQgZnJlZWQgdXAgZm9yIGdhcmJhZ2UgY29sbGVjdGlvbi4gSXQgd2lsbCBhbHNvIGRvIGEgY2hlY2sKICAgICAgZm9yIGNsZWFuaW5nIHVwIGludGVybmFsIG1vZGVscy4KICAgICAgIFRoaXMgY2hlY2sgaXMgcGVyZm9ybWVkIGJ5IGZpcnN0IGNvbXB1dGluZyB0aGUgc2V0IG9mIHJlbGF0ZWQgaW50ZXJuYWwKICAgICAgbW9kZWxzLiBJZiBhbGwgcmVjb3JkcyBpbiB0aGlzIHNldCBhcmUgdW5sb2FkZWQsIHRoZW4gdGhlIGVudGlyZSBzZXQgaXMKICAgICAgZGVzdHJveWVkLiBPdGhlcndpc2UsIG5vdGhpbmcgaW4gdGhlIHNldCBpcyBkZXN0cm95ZWQuCiAgICAgICBUaGlzIG1lYW5zIHRoYXQgdGhpcyBpbnRlcm5hbCBtb2RlbCB3aWxsIGJlIGZyZWVkIHVwIGZvciBnYXJiYWdlIGNvbGxlY3Rpb24KICAgICAgb25jZSBhbGwgbW9kZWxzIHRoYXQgcmVmZXIgdG8gaXQgdmlhIHNvbWUgcmVsYXRpb25zaGlwIGFyZSBhbHNvIHVubG9hZGVkLgogICAgKi8KICAgIDsKCiAgICBfcHJvdG8udW5sb2FkUmVjb3JkID0gZnVuY3Rpb24gdW5sb2FkUmVjb3JkKCkgewogICAgICBpZiAodGhpcy5pc0Rlc3Ryb3llZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5zZW5kKCd1bmxvYWRSZWNvcmQnKTsKICAgICAgdGhpcy5kZW1hdGVyaWFsaXplUmVjb3JkKCk7CgogICAgICBpZiAodGhpcy5fc2NoZWR1bGVkRGVzdHJveSA9PT0gbnVsbCkgewogICAgICAgIHRoaXMuX3NjaGVkdWxlZERlc3Ryb3kgPSBFbWJlci5ydW4uYmFja2J1cm5lci5zY2hlZHVsZSgnZGVzdHJveScsIHRoaXMsICdfY2hlY2tGb3JPcnBoYW5lZEludGVybmFsTW9kZWxzJyk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLmhhc1NjaGVkdWxlZERlc3Ryb3kgPSBmdW5jdGlvbiBoYXNTY2hlZHVsZWREZXN0cm95KCkgewogICAgICByZXR1cm4gISF0aGlzLl9zY2hlZHVsZWREZXN0cm95OwogICAgfTsKCiAgICBfcHJvdG8uY2FuY2VsRGVzdHJveSA9IGZ1bmN0aW9uIGNhbmNlbERlc3Ryb3koKSB7CiAgICAgIHRoaXMuX2RvTm90RGVzdHJveSA9IHRydWU7CiAgICAgIHRoaXMuX2lzRGVtYXRlcmlhbGl6aW5nID0gZmFsc2U7CiAgICAgIEVtYmVyLnJ1bi5jYW5jZWwodGhpcy5fc2NoZWR1bGVkRGVzdHJveSk7CiAgICAgIHRoaXMuX3NjaGVkdWxlZERlc3Ryb3kgPSBudWxsOwogICAgfSAvLyB0eXBpY2FsbHksIHdlIHByZWZlciB0byBhc3luYyBkZXN0cm95IHRoaXMgbGV0cyB1cyBiYXRjaCBjbGVhbnVwIHdvcmsuCiAgICAvLyBVbmZvcnR1bmF0ZWx5LCBzb21lIHNjZW5hcmlvcyB3aGVyZSB0aGF0IGlzIG5vdCBwb3NzaWJsZS4gU3VjaCBhczoKICAgIC8vCiAgICAvLyBgYGBqcwogICAgLy8gY29uc3QgcmVjb3JkID0gc3RvcmUuZmluZCjigJhyZWNvcmTigJksIDEpOwogICAgLy8gcmVjb3JkLnVubG9hZFJlY29yZCgpOwogICAgLy8gc3RvcmUuY3JlYXRlUmVjb3JkKOKAmHJlY29yZOKAmSwgMSk7CiAgICAvLyBgYGAKICAgIC8vCiAgICAvLyBJbiB0aG9zZSBzY2VuYXJpb3MsIHdlIG1ha2UgdGhhdCBtb2RlbCdzIGNsZWFudXAgd29yaywgc3luYy4KICAgIC8vCiAgICA7CgogICAgX3Byb3RvLmRlc3Ryb3lTeW5jID0gZnVuY3Rpb24gZGVzdHJveVN5bmMoKSB7CiAgICAgIGlmICh0aGlzLl9pc0RlbWF0ZXJpYWxpemluZykgewogICAgICAgIHRoaXMuY2FuY2VsRGVzdHJveSgpOwogICAgICB9CgogICAgICB0aGlzLl9jaGVja0Zvck9ycGhhbmVkSW50ZXJuYWxNb2RlbHMoKTsKCiAgICAgIGlmICh0aGlzLmlzRGVzdHJveWVkIHx8IHRoaXMuaXNEZXN0cm95aW5nKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vIGp1c3QgaW4tY2FzZSB3ZSBhcmUgbm90IG9uZSBvZiB0aGUgb3JwaGFuZWQsIHdlIHNob3VsZCBzdGlsbAogICAgICAvLyBzdGlsbCBkZXN0cm95IG91cnNlbHZlcwoKCiAgICAgIHRoaXMuZGVzdHJveSgpOwogICAgfTsKCiAgICBfcHJvdG8uX2NoZWNrRm9yT3JwaGFuZWRJbnRlcm5hbE1vZGVscyA9IGZ1bmN0aW9uIF9jaGVja0Zvck9ycGhhbmVkSW50ZXJuYWxNb2RlbHMoKSB7CiAgICAgIHRoaXMuX2lzRGVtYXRlcmlhbGl6aW5nID0gZmFsc2U7CiAgICAgIHRoaXMuX3NjaGVkdWxlZERlc3Ryb3kgPSBudWxsOwoKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLmVhY2hSZWxhdGlvbnNoaXAgPSBmdW5jdGlvbiBlYWNoUmVsYXRpb25zaGlwKGNhbGxiYWNrLCBiaW5kaW5nKSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGVsQ2xhc3MuZWFjaFJlbGF0aW9uc2hpcChjYWxsYmFjaywgYmluZGluZyk7CiAgICB9OwoKICAgIF9wcm90by5fZmluZEJlbG9uZ3NUbyA9IGZ1bmN0aW9uIF9maW5kQmVsb25nc1RvKGtleSwgcmVzb3VyY2UsIHJlbGF0aW9uc2hpcE1ldGEsIG9wdGlvbnMpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICAvLyBUT0RPIEBydW5zcGlyZWQgZm9sbG93IHVwIGlmIHBhcmVudCBpc05ldyB0aGVuIHdlIHNob3VsZCBub3QgYmUgYXR0ZW1wdGluZyBsb2FkIGhlcmUKICAgICAgcmV0dXJuIHRoaXMuc3RvcmUuX2ZpbmRCZWxvbmdzVG9CeUpzb25BcGlSZXNvdXJjZShyZXNvdXJjZSwgdGhpcywgcmVsYXRpb25zaGlwTWV0YSwgb3B0aW9ucykudGhlbihmdW5jdGlvbiAoaW50ZXJuYWxNb2RlbCkgewogICAgICAgIHJldHVybiBoYW5kbGVDb21wbGV0ZWRSZWxhdGlvbnNoaXBSZXF1ZXN0KF90aGlzMiwga2V5LCByZXNvdXJjZS5fcmVsYXRpb25zaGlwLCBpbnRlcm5hbE1vZGVsLCBudWxsKTsKICAgICAgfSwgZnVuY3Rpb24gKGUpIHsKICAgICAgICByZXR1cm4gaGFuZGxlQ29tcGxldGVkUmVsYXRpb25zaGlwUmVxdWVzdChfdGhpczIsIGtleSwgcmVzb3VyY2UuX3JlbGF0aW9uc2hpcCwgbnVsbCwgZSk7CiAgICAgIH0pOwogICAgfTsKCiAgICBfcHJvdG8uZ2V0QmVsb25nc1RvID0gZnVuY3Rpb24gZ2V0QmVsb25nc1RvKGtleSwgb3B0aW9ucykgewogICAgICB2YXIgcmVzb3VyY2UgPSB0aGlzLl9yZWNvcmREYXRhLmdldEJlbG9uZ3NUbyhrZXkpOwoKICAgICAgdmFyIGlkZW50aWZpZXIgPSByZXNvdXJjZSAmJiByZXNvdXJjZS5kYXRhID8gaWRlbnRpZmllckNhY2hlRm9yKHRoaXMuc3RvcmUpLmdldE9yQ3JlYXRlUmVjb3JkSWRlbnRpZmllcihyZXNvdXJjZS5kYXRhKSA6IG51bGw7CgogICAgICB2YXIgcmVsYXRpb25zaGlwTWV0YSA9IHRoaXMuc3RvcmUuX3JlbGF0aW9uc2hpcE1ldGFGb3IodGhpcy5tb2RlbE5hbWUsIG51bGwsIGtleSk7CgogICAgICB2YXIgc3RvcmUgPSB0aGlzLnN0b3JlOwogICAgICB2YXIgYXN5bmMgPSByZWxhdGlvbnNoaXBNZXRhLm9wdGlvbnMuYXN5bmM7CiAgICAgIHZhciBpc0FzeW5jID0gdHlwZW9mIGFzeW5jID09PSAndW5kZWZpbmVkJyA/IHRydWUgOiBhc3luYzsKICAgICAgdmFyIF9iZWxvbmdzVG9TdGF0ZSA9IHsKICAgICAgICBrZXk6IGtleSwKICAgICAgICBzdG9yZTogc3RvcmUsCiAgICAgICAgb3JpZ2luYXRpbmdJbnRlcm5hbE1vZGVsOiB0aGlzLAogICAgICAgIG1vZGVsTmFtZTogcmVsYXRpb25zaGlwTWV0YS50eXBlCiAgICAgIH07CgogICAgICBpZiAoaXNBc3luYykgewogICAgICAgIHZhciBpbnRlcm5hbE1vZGVsID0gaWRlbnRpZmllciAhPT0gbnVsbCA/IHN0b3JlLl9pbnRlcm5hbE1vZGVsRm9yUmVzb3VyY2UoaWRlbnRpZmllcikgOiBudWxsOwoKICAgICAgICBpZiAocmVzb3VyY2UuX3JlbGF0aW9uc2hpcC5oYXNGYWlsZWRMb2FkQXR0ZW1wdCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JlbGF0aW9uc2hpcFByb3h5Q2FjaGVba2V5XTsKICAgICAgICB9CgogICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5fZmluZEJlbG9uZ3NUbyhrZXksIHJlc291cmNlLCByZWxhdGlvbnNoaXBNZXRhLCBvcHRpb25zKTsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVByb21pc2VQcm94eUZvcignYmVsb25nc1RvJywga2V5LCB7CiAgICAgICAgICBwcm9taXNlOiBwcm9taXNlLAogICAgICAgICAgY29udGVudDogaW50ZXJuYWxNb2RlbCA/IGludGVybmFsTW9kZWwuZ2V0UmVjb3JkKCkgOiBudWxsLAogICAgICAgICAgX2JlbG9uZ3NUb1N0YXRlOiBfYmVsb25nc1RvU3RhdGUKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaWRlbnRpZmllciA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBfaW50ZXJuYWxNb2RlbDIgPSBzdG9yZS5faW50ZXJuYWxNb2RlbEZvclJlc291cmNlKGlkZW50aWZpZXIpOwoKICAgICAgICAgIHZhciB0b1JldHVybiA9IF9pbnRlcm5hbE1vZGVsMi5nZXRSZWNvcmQoKTsKICAgICAgICAgIHJldHVybiB0b1JldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgIH0gLy8gVE9ETyBJZ29yIGNvbnNpZGVyIGdldHRpbmcgcmlkIG9mIGluaXRpYWwgc3RhdGUKICAgIDsKCiAgICBfcHJvdG8uZ2V0TWFueUFycmF5ID0gZnVuY3Rpb24gZ2V0TWFueUFycmF5KGtleSwgaXNBc3luYykgewogICAgICBpZiAoaXNBc3luYyA9PT0gdm9pZCAwKSB7CiAgICAgICAgaXNBc3luYyA9IGZhbHNlOwogICAgICB9CgogICAgICB2YXIgcmVsYXRpb25zaGlwTWV0YSA9IHRoaXMuc3RvcmUuX3JlbGF0aW9uc2hpcE1ldGFGb3IodGhpcy5tb2RlbE5hbWUsIG51bGwsIGtleSk7CgogICAgICB2YXIganNvbkFwaSA9IHRoaXMuX3JlY29yZERhdGEuZ2V0SGFzTWFueShrZXkpOwoKICAgICAgdmFyIG1hbnlBcnJheSA9IHRoaXMuX21hbnlBcnJheUNhY2hlW2tleV07CgogICAgICBpZiAoIW1hbnlBcnJheSkgewogICAgICAgIHZhciBpbml0aWFsU3RhdGUgPSB0aGlzLnN0b3JlLl9nZXRIYXNNYW55QnlKc29uQXBpUmVzb3VyY2UoanNvbkFwaSk7IC8vIFRPRE8gbW92ZSB0aGlzIHRvIGEgcHVibGljIGFwaQoKCiAgICAgICAgdmFyIGludmVyc2VJc0FzeW5jID0ganNvbkFwaS5fcmVsYXRpb25zaGlwID8ganNvbkFwaS5fcmVsYXRpb25zaGlwLl9pbnZlcnNlSXNBc3luYygpIDogZmFsc2U7CiAgICAgICAgbWFueUFycmF5ID0gTWFueUFycmF5LmNyZWF0ZSh7CiAgICAgICAgICBzdG9yZTogdGhpcy5zdG9yZSwKICAgICAgICAgIHR5cGU6IHRoaXMuc3RvcmUubW9kZWxGb3IocmVsYXRpb25zaGlwTWV0YS50eXBlKSwKICAgICAgICAgIHJlY29yZERhdGE6IHRoaXMuX3JlY29yZERhdGEsCiAgICAgICAgICBtZXRhOiBqc29uQXBpLm1ldGEsCiAgICAgICAgICBsaW5rczogY2FuYXJ5RmVhdHVyZXMuRlVMTF9MSU5LU19PTl9SRUxBVElPTlNISVBTID8ganNvbkFwaS5saW5rcyA6IHVuZGVmaW5lZCwKICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgaXNQb2x5bW9ycGhpYzogcmVsYXRpb25zaGlwTWV0YS5vcHRpb25zLnBvbHltb3JwaGljLAogICAgICAgICAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGUuc2xpY2UoKSwKICAgICAgICAgIF9pbnZlcnNlSXNBc3luYzogaW52ZXJzZUlzQXN5bmMsCiAgICAgICAgICBpbnRlcm5hbE1vZGVsOiB0aGlzLAogICAgICAgICAgaXNMb2FkZWQ6ICFpc0FzeW5jCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5fbWFueUFycmF5Q2FjaGVba2V5XSA9IG1hbnlBcnJheTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX3JldGFpbmVkTWFueUFycmF5Q2FjaGVba2V5XSkgewogICAgICAgIHRoaXMuX3JldGFpbmVkTWFueUFycmF5Q2FjaGVba2V5XS5kZXN0cm95KCk7CgogICAgICAgIGRlbGV0ZSB0aGlzLl9yZXRhaW5lZE1hbnlBcnJheUNhY2hlW2tleV07CiAgICAgIH0KCiAgICAgIHJldHVybiBtYW55QXJyYXk7CiAgICB9OwoKICAgIF9wcm90by5mZXRjaEFzeW5jSGFzTWFueSA9IGZ1bmN0aW9uIGZldGNoQXN5bmNIYXNNYW55KGtleSwgcmVsYXRpb25zaGlwTWV0YSwganNvbkFwaSwgbWFueUFycmF5LCBvcHRpb25zKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgLy8gVE9ETyBAcnVuc3BpcmVkIGZvbGxvdyB1cCBpZiBwYXJlbnQgaXNOZXcgdGhlbiB3ZSBzaG91bGQgbm90IGJlIGF0dGVtcHRpbmcgbG9hZCBoZXJlCiAgICAgIHZhciBsb2FkaW5nUHJvbWlzZSA9IHRoaXMuX3JlbGF0aW9uc2hpcFByb21pc2VzQ2FjaGVba2V5XTsKCiAgICAgIGlmIChsb2FkaW5nUHJvbWlzZSkgewogICAgICAgIHJldHVybiBsb2FkaW5nUHJvbWlzZTsKICAgICAgfQoKICAgICAgbG9hZGluZ1Byb21pc2UgPSB0aGlzLnN0b3JlLl9maW5kSGFzTWFueUJ5SnNvbkFwaVJlc291cmNlKGpzb25BcGksIHRoaXMsIHJlbGF0aW9uc2hpcE1ldGEsIG9wdGlvbnMpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIC8vIFRPRE8gd2h5IGRvbid0IHdlIGRvIHRoaXMgaW4gdGhlIHN0b3JlIG1ldGhvZAogICAgICAgIG1hbnlBcnJheS5yZXRyaWV2ZUxhdGVzdCgpOwogICAgICAgIG1hbnlBcnJheS5zZXQoJ2lzTG9hZGVkJywgdHJ1ZSk7CiAgICAgICAgcmV0dXJuIG1hbnlBcnJheTsKICAgICAgfSkudGhlbihmdW5jdGlvbiAobWFueUFycmF5KSB7CiAgICAgICAgcmV0dXJuIGhhbmRsZUNvbXBsZXRlZFJlbGF0aW9uc2hpcFJlcXVlc3QoX3RoaXMzLCBrZXksIGpzb25BcGkuX3JlbGF0aW9uc2hpcCwgbWFueUFycmF5LCBudWxsKTsKICAgICAgfSwgZnVuY3Rpb24gKGUpIHsKICAgICAgICByZXR1cm4gaGFuZGxlQ29tcGxldGVkUmVsYXRpb25zaGlwUmVxdWVzdChfdGhpczMsIGtleSwganNvbkFwaS5fcmVsYXRpb25zaGlwLCBudWxsLCBlKTsKICAgICAgfSk7CiAgICAgIHRoaXMuX3JlbGF0aW9uc2hpcFByb21pc2VzQ2FjaGVba2V5XSA9IGxvYWRpbmdQcm9taXNlOwogICAgICByZXR1cm4gbG9hZGluZ1Byb21pc2U7CiAgICB9OwoKICAgIF9wcm90by5nZXRIYXNNYW55ID0gZnVuY3Rpb24gZ2V0SGFzTWFueShrZXksIG9wdGlvbnMpIHsKICAgICAgdmFyIGpzb25BcGkgPSB0aGlzLl9yZWNvcmREYXRhLmdldEhhc01hbnkoa2V5KTsKCiAgICAgIHZhciByZWxhdGlvbnNoaXBNZXRhID0gdGhpcy5zdG9yZS5fcmVsYXRpb25zaGlwTWV0YUZvcih0aGlzLm1vZGVsTmFtZSwgbnVsbCwga2V5KTsKCiAgICAgIHZhciBhc3luYyA9IHJlbGF0aW9uc2hpcE1ldGEub3B0aW9ucy5hc3luYzsKICAgICAgdmFyIGlzQXN5bmMgPSB0eXBlb2YgYXN5bmMgPT09ICd1bmRlZmluZWQnID8gdHJ1ZSA6IGFzeW5jOwogICAgICB2YXIgbWFueUFycmF5ID0gdGhpcy5nZXRNYW55QXJyYXkoa2V5LCBpc0FzeW5jKTsKCiAgICAgIGlmIChpc0FzeW5jKSB7CiAgICAgICAgaWYgKGpzb25BcGkuX3JlbGF0aW9uc2hpcC5oYXNGYWlsZWRMb2FkQXR0ZW1wdCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JlbGF0aW9uc2hpcFByb3h5Q2FjaGVba2V5XTsKICAgICAgICB9CgogICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5mZXRjaEFzeW5jSGFzTWFueShrZXksIHJlbGF0aW9uc2hpcE1ldGEsIGpzb25BcGksIG1hbnlBcnJheSwgb3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVByb21pc2VQcm94eUZvcignaGFzTWFueScsIGtleSwgewogICAgICAgICAgcHJvbWlzZTogcHJvbWlzZSwKICAgICAgICAgIGNvbnRlbnQ6IG1hbnlBcnJheQogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBtYW55QXJyYXk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLl91cGRhdGVQcm9taXNlUHJveHlGb3IgPSBmdW5jdGlvbiBfdXBkYXRlUHJvbWlzZVByb3h5Rm9yKGtpbmQsIGtleSwgYXJncykgewogICAgICB2YXIgcHJvbWlzZVByb3h5ID0gdGhpcy5fcmVsYXRpb25zaGlwUHJveHlDYWNoZVtrZXldOwoKICAgICAgaWYgKHByb21pc2VQcm94eSkgewogICAgICAgIGlmIChhcmdzLmNvbnRlbnQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgLy8gdGhpcyB1c2FnZSBvZiBgYW55YCBjYW4gYmUgcmVtb3ZlZCB3aGVuIGBAdHlwZXMvZW1iZXJfb2JqZWN0YCBwcm94eSBhbGxvd3MgYG51bGxgIGZvciBjb250ZW50CiAgICAgICAgICBwcm9taXNlUHJveHkuc2V0KCdjb250ZW50JywgYXJncy5jb250ZW50KTsKICAgICAgICB9CgogICAgICAgIHByb21pc2VQcm94eS5zZXQoJ3Byb21pc2UnLCBhcmdzLnByb21pc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBrbGFzcyA9IGtpbmQgPT09ICdoYXNNYW55JyA/IFByb21pc2VNYW55QXJyYXkgOiBQcm9taXNlQmVsb25nc1RvOyAvLyB0aGlzIHVzYWdlIG9mIGBhbnlgIGNhbiBiZSByZW1vdmVkIHdoZW4gYEB0eXBlcy9lbWJlcl9vYmplY3RgIHByb3h5IGFsbG93cyBgbnVsbGAgZm9yIGNvbnRlbnQKCiAgICAgICAgdGhpcy5fcmVsYXRpb25zaGlwUHJveHlDYWNoZVtrZXldID0ga2xhc3MuY3JlYXRlKGFyZ3MpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fcmVsYXRpb25zaGlwUHJveHlDYWNoZVtrZXldOwogICAgfTsKCiAgICBfcHJvdG8ucmVsb2FkSGFzTWFueSA9IGZ1bmN0aW9uIHJlbG9hZEhhc01hbnkoa2V5LCBvcHRpb25zKSB7CiAgICAgIHZhciBsb2FkaW5nUHJvbWlzZSA9IHRoaXMuX3JlbGF0aW9uc2hpcFByb21pc2VzQ2FjaGVba2V5XTsKCiAgICAgIGlmIChsb2FkaW5nUHJvbWlzZSkgewogICAgICAgIHJldHVybiBsb2FkaW5nUHJvbWlzZTsKICAgICAgfQoKICAgICAgdmFyIGpzb25BcGkgPSB0aGlzLl9yZWNvcmREYXRhLmdldEhhc01hbnkoa2V5KTsgLy8gVE9ETyBtb3ZlIHRoaXMgdG8gYSBwdWJsaWMgYXBpCgoKICAgICAgaWYgKGpzb25BcGkuX3JlbGF0aW9uc2hpcCkgewogICAgICAgIGpzb25BcGkuX3JlbGF0aW9uc2hpcC5zZXRIYXNGYWlsZWRMb2FkQXR0ZW1wdChmYWxzZSk7CgogICAgICAgIGpzb25BcGkuX3JlbGF0aW9uc2hpcC5zZXRTaG91bGRGb3JjZVJlbG9hZCh0cnVlKTsKICAgICAgfQoKICAgICAgdmFyIHJlbGF0aW9uc2hpcE1ldGEgPSB0aGlzLnN0b3JlLl9yZWxhdGlvbnNoaXBNZXRhRm9yKHRoaXMubW9kZWxOYW1lLCBudWxsLCBrZXkpOwoKICAgICAgdmFyIG1hbnlBcnJheSA9IHRoaXMuZ2V0TWFueUFycmF5KGtleSk7CiAgICAgIHZhciBwcm9taXNlID0gdGhpcy5mZXRjaEFzeW5jSGFzTWFueShrZXksIHJlbGF0aW9uc2hpcE1ldGEsIGpzb25BcGksIG1hbnlBcnJheSwgb3B0aW9ucyk7CgogICAgICBpZiAodGhpcy5fcmVsYXRpb25zaGlwUHJveHlDYWNoZVtrZXldKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVByb21pc2VQcm94eUZvcignaGFzTWFueScsIGtleSwgewogICAgICAgICAgcHJvbWlzZTogcHJvbWlzZQogICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH07CgogICAgX3Byb3RvLnJlbG9hZEJlbG9uZ3NUbyA9IGZ1bmN0aW9uIHJlbG9hZEJlbG9uZ3NUbyhrZXksIG9wdGlvbnMpIHsKICAgICAgdmFyIGxvYWRpbmdQcm9taXNlID0gdGhpcy5fcmVsYXRpb25zaGlwUHJvbWlzZXNDYWNoZVtrZXldOwoKICAgICAgaWYgKGxvYWRpbmdQcm9taXNlKSB7CiAgICAgICAgcmV0dXJuIGxvYWRpbmdQcm9taXNlOwogICAgICB9CgogICAgICB2YXIgcmVzb3VyY2UgPSB0aGlzLl9yZWNvcmREYXRhLmdldEJlbG9uZ3NUbyhrZXkpOyAvLyBUT0RPIG1vdmUgdGhpcyB0byBhIHB1YmxpYyBhcGkKCgogICAgICBpZiAocmVzb3VyY2UuX3JlbGF0aW9uc2hpcCkgewogICAgICAgIHJlc291cmNlLl9yZWxhdGlvbnNoaXAuc2V0SGFzRmFpbGVkTG9hZEF0dGVtcHQoZmFsc2UpOwoKICAgICAgICByZXNvdXJjZS5fcmVsYXRpb25zaGlwLnNldFNob3VsZEZvcmNlUmVsb2FkKHRydWUpOwogICAgICB9CgogICAgICB2YXIgcmVsYXRpb25zaGlwTWV0YSA9IHRoaXMuc3RvcmUuX3JlbGF0aW9uc2hpcE1ldGFGb3IodGhpcy5tb2RlbE5hbWUsIG51bGwsIGtleSk7CgogICAgICB2YXIgcHJvbWlzZSA9IHRoaXMuX2ZpbmRCZWxvbmdzVG8oa2V5LCByZXNvdXJjZSwgcmVsYXRpb25zaGlwTWV0YSwgb3B0aW9ucyk7CgogICAgICBpZiAodGhpcy5fcmVsYXRpb25zaGlwUHJveHlDYWNoZVtrZXldKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVByb21pc2VQcm94eUZvcignYmVsb25nc1RvJywga2V5LCB7CiAgICAgICAgICBwcm9taXNlOiBwcm9taXNlCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwcm9taXNlOwogICAgfTsKCiAgICBfcHJvdG8uZGVzdHJveUZyb21SZWNvcmREYXRhID0gZnVuY3Rpb24gZGVzdHJveUZyb21SZWNvcmREYXRhKCkgewogICAgICBpZiAodGhpcy5fZG9Ob3REZXN0cm95KSB7CiAgICAgICAgdGhpcy5fZG9Ob3REZXN0cm95ID0gZmFsc2U7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLmRlc3Ryb3koKTsKICAgIH07CgogICAgX3Byb3RvLmRlc3Ryb3kgPSBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICB2YXIgX3RoaXM0ID0gdGhpczsKICAgICAgdGhpcy5pc0Rlc3Ryb3lpbmcgPSB0cnVlOwogICAgICBPYmplY3Qua2V5cyh0aGlzLl9yZXRhaW5lZE1hbnlBcnJheUNhY2hlKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBfdGhpczQuX3JldGFpbmVkTWFueUFycmF5Q2FjaGVba2V5XS5kZXN0cm95KCk7CgogICAgICAgIGRlbGV0ZSBfdGhpczQuX3JldGFpbmVkTWFueUFycmF5Q2FjaGVba2V5XTsKICAgICAgfSk7CiAgICAgIGludGVybmFsTW9kZWxGYWN0b3J5Rm9yKHRoaXMuc3RvcmUpLnJlbW92ZSh0aGlzKTsKICAgICAgdGhpcy5faXNEZXN0cm95ZWQgPSB0cnVlOwogICAgfTsKCiAgICBfcHJvdG8uZWFjaEF0dHJpYnV0ZSA9IGZ1bmN0aW9uIGVhY2hBdHRyaWJ1dGUoY2FsbGJhY2ssIGJpbmRpbmcpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxDbGFzcy5lYWNoQXR0cmlidXRlKGNhbGxiYWNrLCBiaW5kaW5nKTsKICAgIH07CgogICAgX3Byb3RvLmludmVyc2VGb3IgPSBmdW5jdGlvbiBpbnZlcnNlRm9yKGtleSkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbENsYXNzLmludmVyc2VGb3Ioa2V5KTsKICAgIH07CgogICAgX3Byb3RvLnNldHVwRGF0YSA9IGZ1bmN0aW9uIHNldHVwRGF0YShkYXRhKSB7CiAgICAgIHZhciBjaGFuZ2VkS2V5cyA9IHRoaXMuX3JlY29yZERhdGEucHVzaERhdGEoZGF0YSwgdGhpcy5oYXNSZWNvcmQpOwoKICAgICAgaWYgKHRoaXMuaGFzUmVjb3JkKSB7CiAgICAgICAgdGhpcy5fcmVjb3JkLl9ub3RpZnlQcm9wZXJ0aWVzKGNoYW5nZWRLZXlzKTsKICAgICAgfQoKICAgICAgdGhpcy5wdXNoZWREYXRhKCk7CiAgICB9OwoKICAgIF9wcm90by5nZXRBdHRyaWJ1dGVWYWx1ZSA9IGZ1bmN0aW9uIGdldEF0dHJpYnV0ZVZhbHVlKGtleSkgewogICAgICByZXR1cm4gdGhpcy5fcmVjb3JkRGF0YS5nZXRBdHRyKGtleSk7CiAgICB9OwoKICAgIF9wcm90by5zZXREaXJ0eUhhc01hbnkgPSBmdW5jdGlvbiBzZXREaXJ0eUhhc01hbnkoa2V5LCByZWNvcmRzKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWNvcmREYXRhLnNldERpcnR5SGFzTWFueShrZXksIGV4dHJhY3RSZWNvcmREYXRhc0Zyb21SZWNvcmRzKHJlY29yZHMpKTsKICAgIH07CgogICAgX3Byb3RvLnNldERpcnR5QmVsb25nc1RvID0gZnVuY3Rpb24gc2V0RGlydHlCZWxvbmdzVG8oa2V5LCB2YWx1ZSkgewogICAgICByZXR1cm4gdGhpcy5fcmVjb3JkRGF0YS5zZXREaXJ0eUJlbG9uZ3NUbyhrZXksIGV4dHJhY3RSZWNvcmREYXRhRnJvbVJlY29yZCh2YWx1ZSkpOwogICAgfTsKCiAgICBfcHJvdG8uc2V0RGlydHlBdHRyaWJ1dGUgPSBmdW5jdGlvbiBzZXREaXJ0eUF0dHJpYnV0ZShrZXksIHZhbHVlKSB7CiAgICAgIGlmICh0aGlzLmlzRGVsZXRlZCgpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKCJBdHRlbXB0ZWQgdG8gc2V0ICciICsga2V5ICsgIicgdG8gJyIgKyB2YWx1ZSArICInIG9uIHRoZSBkZWxldGVkIHJlY29yZCAiICsgdGhpcyk7CiAgICAgIH0KCiAgICAgIHZhciBjdXJyZW50VmFsdWUgPSB0aGlzLmdldEF0dHJpYnV0ZVZhbHVlKGtleSk7CgogICAgICBpZiAoY3VycmVudFZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgIHRoaXMuX3JlY29yZERhdGEuc2V0RGlydHlBdHRyaWJ1dGUoa2V5LCB2YWx1ZSk7CgogICAgICAgIHZhciBpc0RpcnR5ID0gdGhpcy5fcmVjb3JkRGF0YS5pc0F0dHJEaXJ0eShrZXkpOwoKICAgICAgICB0aGlzLnNlbmQoJ2RpZFNldFByb3BlcnR5JywgewogICAgICAgICAgbmFtZToga2V5LAogICAgICAgICAgaXNEaXJ0eTogaXNEaXJ0eQogICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gdmFsdWU7CiAgICB9OwoKICAgIC8qCiAgICAgIEBtZXRob2QgY3JlYXRlU25hcHNob3QKICAgICAgQHByaXZhdGUKICAgICovCiAgICBfcHJvdG8uY3JlYXRlU25hcHNob3QgPSBmdW5jdGlvbiBjcmVhdGVTbmFwc2hvdChvcHRpb25zKSB7CiAgICAgIHJldHVybiBuZXcgU25hcHNob3Qob3B0aW9ucyB8fCB7fSwgdGhpcy5pZGVudGlmaWVyLCB0aGlzLnN0b3JlKTsKICAgIH0KICAgIC8qCiAgICAgIEBtZXRob2QgbG9hZGluZ0RhdGEKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtQcm9taXNlfSBwcm9taXNlCiAgICAqLwogICAgOwoKICAgIF9wcm90by5sb2FkaW5nRGF0YSA9IGZ1bmN0aW9uIGxvYWRpbmdEYXRhKHByb21pc2UpIHsKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFUVVFU1RfU0VSVklDRSkgewogICAgICAgIHRoaXMuc2VuZCgnbG9hZGluZ0RhdGEnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnNlbmQoJ2xvYWRpbmdEYXRhJywgcHJvbWlzZSk7CiAgICAgIH0KICAgIH0KICAgIC8qCiAgICAgIEBtZXRob2QgbG9hZGVkRGF0YQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ubG9hZGVkRGF0YSA9IGZ1bmN0aW9uIGxvYWRlZERhdGEoKSB7CiAgICAgIHRoaXMuc2VuZCgnbG9hZGVkRGF0YScpOwogICAgfQogICAgLyoKICAgICAgQG1ldGhvZCBub3RGb3VuZAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ubm90Rm91bmQgPSBmdW5jdGlvbiBub3RGb3VuZCgpIHsKICAgICAgdGhpcy5zZW5kKCdub3RGb3VuZCcpOwogICAgfQogICAgLyoKICAgICAgQG1ldGhvZCBwdXNoZWREYXRhCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgOwoKICAgIF9wcm90by5wdXNoZWREYXRhID0gZnVuY3Rpb24gcHVzaGVkRGF0YSgpIHsKICAgICAgdGhpcy5zZW5kKCdwdXNoZWREYXRhJyk7CiAgICB9OwoKICAgIF9wcm90by5oYXNDaGFuZ2VkQXR0cmlidXRlcyA9IGZ1bmN0aW9uIGhhc0NoYW5nZWRBdHRyaWJ1dGVzKCkgewogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuUkVRVUVTVF9TRVJWSUNFKSB7CiAgICAgICAgaWYgKCF0aGlzLl9fcmVjb3JkRGF0YSkgewogICAgICAgICAgLy8gbm8gbmVlZCB0byBjYWxjdWxhdGUgY2hhbmdlZCBhdHRyaWJ1dGVzIHdoZW4gY2FsbGluZyBgZmluZFJlY29yZGAKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHRoaXMuaXNMb2FkaW5nKCkgJiYgIXRoaXMuaXNSZWxvYWRpbmcpIHsKICAgICAgICAgIC8vIG5vIG5lZWQgdG8gY2FsY3VsYXRlIGNoYW5nZWQgYXR0cmlidXRlcyB3aGVuIGNhbGxpbmcgYGZpbmRSZWNvcmRgCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fcmVjb3JkRGF0YS5oYXNDaGFuZ2VkQXR0cmlidXRlcygpOwogICAgfQogICAgLyoKICAgICAgUmV0dXJucyBhbiBvYmplY3QsIHdob3NlIGtleXMgYXJlIGNoYW5nZWQgcHJvcGVydGllcywgYW5kIHZhbHVlIGlzIGFuCiAgICAgIFtvbGRQcm9wLCBuZXdQcm9wXSBhcnJheS4KICAgICAgIEBtZXRob2QgY2hhbmdlZEF0dHJpYnV0ZXMKICAgICAgQHByaXZhdGUKICAgICovCiAgICA7CgogICAgX3Byb3RvLmNoYW5nZWRBdHRyaWJ1dGVzID0gZnVuY3Rpb24gY2hhbmdlZEF0dHJpYnV0ZXMoKSB7CiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5SRVFVRVNUX1NFUlZJQ0UpIHsKICAgICAgICBpZiAoIXRoaXMuX19yZWNvcmREYXRhKSB7CiAgICAgICAgICAvLyBubyBuZWVkIHRvIGNhbGN1bGF0ZSBjaGFuZ2VkIGF0dHJpYnV0ZXMgd2hlbiBjYWxsaW5nIGBmaW5kUmVjb3JkYAogICAgICAgICAgcmV0dXJuIHt9OwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5pc0xvYWRpbmcoKSAmJiAhdGhpcy5pc1JlbG9hZGluZykgewogICAgICAgICAgLy8gbm8gbmVlZCB0byBjYWxjdWxhdGUgY2hhbmdlZCBhdHRyaWJ1dGVzIHdoZW4gY2FsbGluZyBgZmluZFJlY29yZGAKICAgICAgICAgIHJldHVybiB7fTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLl9yZWNvcmREYXRhLmNoYW5nZWRBdHRyaWJ1dGVzKCk7CiAgICB9CiAgICAvKgogICAgICBAbWV0aG9kIGFkYXB0ZXJXaWxsQ29tbWl0CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgOwoKICAgIF9wcm90by5hZGFwdGVyV2lsbENvbW1pdCA9IGZ1bmN0aW9uIGFkYXB0ZXJXaWxsQ29tbWl0KCkgewogICAgICB0aGlzLl9yZWNvcmREYXRhLndpbGxDb21taXQoKTsKCiAgICAgIHRoaXMuc2VuZCgnd2lsbENvbW1pdCcpOwogICAgfQogICAgLyoKICAgICAgQG1ldGhvZCBhZGFwdGVyRGlkRGlydHkKICAgICAgQHByaXZhdGUKICAgICovCiAgICA7CgogICAgX3Byb3RvLmFkYXB0ZXJEaWREaXJ0eSA9IGZ1bmN0aW9uIGFkYXB0ZXJEaWREaXJ0eSgpIHsKICAgICAgdGhpcy5zZW5kKCdiZWNvbWVEaXJ0eScpOwogICAgICB0aGlzLnVwZGF0ZVJlY29yZEFycmF5cygpOwogICAgfQogICAgLyoKICAgICAgQG1ldGhvZCBzZW5kCiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0CiAgICAqLwogICAgOwoKICAgIF9wcm90by5zZW5kID0gZnVuY3Rpb24gc2VuZChuYW1lLCBjb250ZXh0KSB7CiAgICAgIHZhciBjdXJyZW50U3RhdGUgPSB0aGlzLmN1cnJlbnRTdGF0ZTsKCiAgICAgIGlmICghY3VycmVudFN0YXRlW25hbWVdKSB7CiAgICAgICAgdGhpcy5fdW5oYW5kbGVkRXZlbnQoY3VycmVudFN0YXRlLCBuYW1lLCBjb250ZXh0KTsKICAgICAgfQoKICAgICAgcmV0dXJuIGN1cnJlbnRTdGF0ZVtuYW1lXSh0aGlzLCBjb250ZXh0KTsKICAgIH07CgogICAgX3Byb3RvLm1hbnlBcnJheVJlY29yZEFkZGVkID0gZnVuY3Rpb24gbWFueUFycmF5UmVjb3JkQWRkZWQoa2V5KSB7CiAgICAgIGlmICh0aGlzLmhhc1JlY29yZCkgewogICAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MpIHsKICAgICAgICAgIHRoaXMuc3RvcmUuX25vdGlmaWNhdGlvbk1hbmFnZXIubm90aWZ5KHRoaXMuaWRlbnRpZmllciwgJ3JlbGF0aW9uc2hpcHMnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fcmVjb3JkLm5vdGlmeUhhc01hbnlBZGRlZChrZXkpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8ubm90aWZ5SGFzTWFueUNoYW5nZSA9IGZ1bmN0aW9uIG5vdGlmeUhhc01hbnlDaGFuZ2Uoa2V5KSB7CiAgICAgIGlmICh0aGlzLmhhc1JlY29yZCkgewogICAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MpIHsKICAgICAgICAgIHRoaXMuc3RvcmUuX25vdGlmaWNhdGlvbk1hbmFnZXIubm90aWZ5KHRoaXMuaWRlbnRpZmllciwgJ3JlbGF0aW9uc2hpcHMnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIG1hbnlBcnJheSA9IHRoaXMuX21hbnlBcnJheUNhY2hlW2tleV07CgogICAgICAgICAgaWYgKG1hbnlBcnJheSkgewogICAgICAgICAgICAvLyBUT0RPOiB0aGlzIHdpbGwgInJlc3VycmVjdCIgcHJldmlvdXNseSB1bmxvYWRlZCByZWNvcmRzCiAgICAgICAgICAgIC8vIHNlZSB0ZXN0ICcxOm1hbnkgYXN5bmMgdW5sb2FkIG1hbnkgc2lkZScKICAgICAgICAgICAgLy8gIGluIGB0ZXN0cy9pbnRlZ3JhdGlvbi9yZWNvcmRzL3VubG9hZC10ZXN0LmpzYAogICAgICAgICAgICAvLyAgcHJvYmFibHkgd2UgZG9uJ3Qgd2FudCB0byByZXRyaWV2ZSBsYXRlc3QgZWFnZXJseSB3aGVuIG5vdGlmeWhhc21hbnkgY2hhbmdlZAogICAgICAgICAgICAvLyAgYnV0IHJhdGhlciBsYXppbHkgd2hlbiBzb21lb25lIGFjdHVhbGx5IGFza3MgZm9yIGEgbWFueWFycmF5CiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vICB0aGF0IHNhaWQsIGFsc28gbm90IGNsZWFyIHdoeSB3ZSBoYXZlbid0IG1vdmVkIHRoaXMgdG8gcmV0YWluZWRtYW55YXJyYXkgc28gbWF5YmUgdGhhdCdzIHRoZSBiaXQgdGhhdCdzIGp1c3Qgbm90IHdvcmtpZ24KICAgICAgICAgICAgbWFueUFycmF5LnJldHJpZXZlTGF0ZXN0KCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnVwZGF0ZVJlY29yZEFycmF5cygpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5ub3RpZnlCZWxvbmdzVG9DaGFuZ2UgPSBmdW5jdGlvbiBub3RpZnlCZWxvbmdzVG9DaGFuZ2Uoa2V5KSB7CiAgICAgIGlmICh0aGlzLmhhc1JlY29yZCkgewogICAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MpIHsKICAgICAgICAgIHRoaXMuc3RvcmUuX25vdGlmaWNhdGlvbk1hbmFnZXIubm90aWZ5KHRoaXMuaWRlbnRpZmllciwgJ3JlbGF0aW9uc2hpcHMnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fcmVjb3JkLm5vdGlmeUJlbG9uZ3NUb0NoYW5nZShrZXksIHRoaXMuX3JlY29yZCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnVwZGF0ZVJlY29yZEFycmF5cygpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5oYXNNYW55UmVtb3ZhbENoZWNrID0gZnVuY3Rpb24gaGFzTWFueVJlbW92YWxDaGVjayhrZXkpIHsKICAgICAgdmFyIG1hbnlBcnJheSA9IHRoaXMuX21hbnlBcnJheUNhY2hlW2tleV0gfHwgdGhpcy5fcmV0YWluZWRNYW55QXJyYXlDYWNoZVtrZXldOwogICAgICB2YXIgZGlkUmVtb3ZlVW5sb2FkZWRNb2RlbCA9IGZhbHNlOwoKICAgICAgaWYgKG1hbnlBcnJheSkgewogICAgICAgIGRpZFJlbW92ZVVubG9hZGVkTW9kZWwgPSBtYW55QXJyYXkucmVtb3ZlVW5sb2FkZWRJbnRlcm5hbE1vZGVsKCk7CgogICAgICAgIGlmICh0aGlzLl9tYW55QXJyYXlDYWNoZVtrZXldICYmIGRpZFJlbW92ZVVubG9hZGVkTW9kZWwpIHsKICAgICAgICAgIHRoaXMuX3JldGFpbmVkTWFueUFycmF5Q2FjaGVba2V5XSA9IHRoaXMuX21hbnlBcnJheUNhY2hlW2tleV07CiAgICAgICAgICBkZWxldGUgdGhpcy5fbWFueUFycmF5Q2FjaGVba2V5XTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBkaWRSZW1vdmVVbmxvYWRlZE1vZGVsOwogICAgfTsKCiAgICBfcHJvdG8ubm90aWZ5UHJvcGVydHlDaGFuZ2UgPSBmdW5jdGlvbiBub3RpZnlQcm9wZXJ0eUNoYW5nZShrZXkpIHsKICAgICAgaWYgKHRoaXMuaGFzUmVjb3JkKSB7CiAgICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLkNVU1RPTV9NT0RFTF9DTEFTUykgewogICAgICAgICAgdGhpcy5zdG9yZS5fbm90aWZpY2F0aW9uTWFuYWdlci5ub3RpZnkodGhpcy5pZGVudGlmaWVyLCAncHJvcGVydHknKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fcmVjb3JkLm5vdGlmeVByb3BlcnR5Q2hhbmdlKGtleSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnVwZGF0ZVJlY29yZEFycmF5cygpOwogICAgICB9CgogICAgICBpZiAoIWNhbmFyeUZlYXR1cmVzLkNVU1RPTV9NT0RFTF9DTEFTUykgewogICAgICAgIHZhciBtYW55QXJyYXkgPSB0aGlzLl9tYW55QXJyYXlDYWNoZVtrZXldIHx8IHRoaXMuX3JldGFpbmVkTWFueUFycmF5Q2FjaGVba2V5XTsKCiAgICAgICAgaWYgKG1hbnlBcnJheSkgewogICAgICAgICAgdmFyIGRpZFJlbW92ZVVubG9hZGVkTW9kZWwgPSBtYW55QXJyYXkucmVtb3ZlVW5sb2FkZWRJbnRlcm5hbE1vZGVsKCk7CgogICAgICAgICAgaWYgKHRoaXMuX21hbnlBcnJheUNhY2hlW2tleV0gJiYgZGlkUmVtb3ZlVW5sb2FkZWRNb2RlbCkgewogICAgICAgICAgICB0aGlzLl9yZXRhaW5lZE1hbnlBcnJheUNhY2hlW2tleV0gPSB0aGlzLl9tYW55QXJyYXlDYWNoZVtrZXldOwogICAgICAgICAgICBkZWxldGUgdGhpcy5fbWFueUFycmF5Q2FjaGVba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLm5vdGlmeVN0YXRlQ2hhbmdlID0gZnVuY3Rpb24gbm90aWZ5U3RhdGVDaGFuZ2Uoa2V5KSB7CgogICAgICBpZiAodGhpcy5oYXNSZWNvcmQpIHsKICAgICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuQ1VTVE9NX01PREVMX0NMQVNTKSB7CiAgICAgICAgICB0aGlzLnN0b3JlLl9ub3RpZmljYXRpb25NYW5hZ2VyLm5vdGlmeSh0aGlzLmlkZW50aWZpZXIsICdzdGF0ZScpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoIWtleSB8fCBrZXkgPT09ICdpc05ldycpIHsKICAgICAgICAgICAgdGhpcy5nZXRSZWNvcmQoKS5ub3RpZnlQcm9wZXJ0eUNoYW5nZSgnaXNOZXcnKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIWtleSB8fCBrZXkgPT09ICdpc0RlbGV0ZWQnKSB7CiAgICAgICAgICAgIHRoaXMuZ2V0UmVjb3JkKCkubm90aWZ5UHJvcGVydHlDaGFuZ2UoJ2lzRGVsZXRlZCcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCFrZXkgfHwga2V5ID09PSAnaXNEZWxldGlvbkNvbW1pdHRlZCcpIHsKICAgICAgICB0aGlzLnVwZGF0ZVJlY29yZEFycmF5cygpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5kaWRDcmVhdGVSZWNvcmQgPSBmdW5jdGlvbiBkaWRDcmVhdGVSZWNvcmQoKSB7CiAgICAgIHRoaXMuX3JlY29yZERhdGEuY2xpZW50RGlkQ3JlYXRlKCk7CiAgICB9OwoKICAgIF9wcm90by5yb2xsYmFja0F0dHJpYnV0ZXMgPSBmdW5jdGlvbiByb2xsYmFja0F0dHJpYnV0ZXMoKSB7CiAgICAgIHZhciBkaXJ0eUtleXMgPSB0aGlzLl9yZWNvcmREYXRhLnJvbGxiYWNrQXR0cmlidXRlcygpOwoKICAgICAgaWYgKEVtYmVyLmdldCh0aGlzLCAnaXNFcnJvcicpKSB7CiAgICAgICAgdGhpcy5kaWRDbGVhbkVycm9yKCk7CiAgICAgIH0KCiAgICAgIHRoaXMuc2VuZCgncm9sbGVkQmFjaycpOwoKICAgICAgaWYgKHRoaXMuX3JlY29yZCAmJiBkaXJ0eUtleXMgJiYgZGlydHlLZXlzLmxlbmd0aCA+IDApIHsKICAgICAgICB0aGlzLl9yZWNvcmQuX25vdGlmeVByb3BlcnRpZXMoZGlydHlLZXlzKTsKICAgICAgfQogICAgfQogICAgLyoKICAgICAgQG1ldGhvZCB0cmFuc2l0aW9uVG8KICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUKICAgICovCiAgICA7CgogICAgX3Byb3RvLnRyYW5zaXRpb25UbyA9IGZ1bmN0aW9uIHRyYW5zaXRpb25UbyhuYW1lKSB7CiAgICAgIC8vIFBPU1NJQkxFIFRPRE86IFJlbW92ZSB0aGlzIGNvZGUgYW5kIHJlcGxhY2Ugd2l0aAogICAgICAvLyBhbHdheXMgaGF2aW5nIGRpcmVjdCByZWZlcmVuY2UgdG8gc3RhdGUgb2JqZWN0cwogICAgICB2YXIgcGl2b3ROYW1lID0gZXh0cmFjdFBpdm90TmFtZShuYW1lKTsKICAgICAgdmFyIHN0YXRlID0gdGhpcy5jdXJyZW50U3RhdGU7CiAgICAgIHZhciB0cmFuc2l0aW9uTWFwSWQgPSBzdGF0ZS5zdGF0ZU5hbWUgKyAiLT4iICsgbmFtZTsKCiAgICAgIGRvIHsKICAgICAgICBpZiAoc3RhdGUuZXhpdCkgewogICAgICAgICAgc3RhdGUuZXhpdCh0aGlzKTsKICAgICAgICB9CgogICAgICAgIHN0YXRlID0gc3RhdGUucGFyZW50U3RhdGU7CiAgICAgIH0gd2hpbGUgKCFzdGF0ZVtwaXZvdE5hbWVdKTsKCiAgICAgIHZhciBzZXR1cHM7CiAgICAgIHZhciBlbnRlcnM7CiAgICAgIHZhciBpOwogICAgICB2YXIgbDsKICAgICAgdmFyIG1hcCA9IFRyYW5zaXRpb25DaGFpbk1hcFt0cmFuc2l0aW9uTWFwSWRdOwoKICAgICAgaWYgKG1hcCkgewogICAgICAgIHNldHVwcyA9IG1hcC5zZXR1cHM7CiAgICAgICAgZW50ZXJzID0gbWFwLmVudGVyczsKICAgICAgICBzdGF0ZSA9IG1hcC5zdGF0ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXR1cHMgPSBbXTsKICAgICAgICBlbnRlcnMgPSBbXTsKICAgICAgICB2YXIgcGF0aCA9IHNwbGl0T25Eb3QobmFtZSk7CgogICAgICAgIGZvciAoaSA9IDAsIGwgPSBwYXRoLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgc3RhdGUgPSBzdGF0ZVtwYXRoW2ldXTsKCiAgICAgICAgICBpZiAoc3RhdGUuZW50ZXIpIHsKICAgICAgICAgICAgZW50ZXJzLnB1c2goc3RhdGUpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChzdGF0ZS5zZXR1cCkgewogICAgICAgICAgICBzZXR1cHMucHVzaChzdGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBUcmFuc2l0aW9uQ2hhaW5NYXBbdHJhbnNpdGlvbk1hcElkXSA9IHsKICAgICAgICAgIHNldHVwczogc2V0dXBzLAogICAgICAgICAgZW50ZXJzOiBlbnRlcnMsCiAgICAgICAgICBzdGF0ZTogc3RhdGUKICAgICAgICB9OwogICAgICB9CgogICAgICBmb3IgKGkgPSAwLCBsID0gZW50ZXJzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIGVudGVyc1tpXS5lbnRlcih0aGlzKTsKICAgICAgfQoKICAgICAgdGhpcy5jdXJyZW50U3RhdGUgPSBzdGF0ZTsKCiAgICAgIGlmICh0aGlzLmhhc1JlY29yZCkgewogICAgICAgIEVtYmVyLnNldCh0aGlzLl9yZWNvcmQsICdjdXJyZW50U3RhdGUnLCBzdGF0ZSk7CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IDAsIGwgPSBzZXR1cHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgc2V0dXBzW2ldLnNldHVwKHRoaXMpOwogICAgICB9CgogICAgICB0aGlzLnVwZGF0ZVJlY29yZEFycmF5cygpOwogICAgfTsKCiAgICBfcHJvdG8uX3VuaGFuZGxlZEV2ZW50ID0gZnVuY3Rpb24gX3VuaGFuZGxlZEV2ZW50KHN0YXRlLCBuYW1lLCBjb250ZXh0KSB7CiAgICAgIHZhciBlcnJvck1lc3NhZ2UgPSAnQXR0ZW1wdGVkIHRvIGhhbmRsZSBldmVudCBgJyArIG5hbWUgKyAnYCAnOwogICAgICBlcnJvck1lc3NhZ2UgKz0gJ29uICcgKyBTdHJpbmcodGhpcykgKyAnIHdoaWxlIGluIHN0YXRlICc7CiAgICAgIGVycm9yTWVzc2FnZSArPSBzdGF0ZS5zdGF0ZU5hbWUgKyAnLiAnOwoKICAgICAgaWYgKGNvbnRleHQgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGVycm9yTWVzc2FnZSArPSAnQ2FsbGVkIHdpdGggJyArIEVtYmVyLmluc3BlY3QoY29udGV4dCkgKyAnLic7CiAgICAgIH0KCiAgICAgIHRocm93IG5ldyBFbWJlci5FcnJvcihlcnJvck1lc3NhZ2UpOwogICAgfTsKCiAgICBfcHJvdG8udHJpZ2dlckxhdGVyID0gZnVuY3Rpb24gdHJpZ2dlckxhdGVyKCkgewogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CgogICAgICBpZiAodGhpcy5fZGVmZXJyZWRUcmlnZ2Vycy5wdXNoKGFyZ3MpICE9PSAxKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLnN0b3JlLl91cGRhdGVJbnRlcm5hbE1vZGVsKHRoaXMpOwogICAgfTsKCiAgICBfcHJvdG8uX3RyaWdnZXJEZWZlcnJlZFRyaWdnZXJzID0gZnVuY3Rpb24gX3RyaWdnZXJEZWZlcnJlZFRyaWdnZXJzKCkgewogICAgICAvL1RPRE86IEJlZm9yZSAxLjAgd2Ugd2FudCB0byByZW1vdmUgYWxsIHRoZSBldmVudHMgdGhhdCBoYXBwZW4gb24gdGhlIHByZSBtYXRlcmlhbGl6ZWQgcmVjb3JkLAogICAgICAvL2J1dCBmb3Igbm93LCB3ZSBxdWV1ZSB1cCBhbGwgdGhlIGV2ZW50cyB0cmlnZ2VyZWQgYmVmb3JlIHRoZSByZWNvcmQgd2FzIG1hdGVyaWFsaXplZCwgYW5kIGZsdXNoCiAgICAgIC8vdGhlbSBvbmNlIHdlIGhhdmUgdGhlIHJlY29yZAogICAgICBpZiAoIXRoaXMuaGFzUmVjb3JkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgdHJpZ2dlcnMgPSB0aGlzLl9kZWZlcnJlZFRyaWdnZXJzOwogICAgICB2YXIgcmVjb3JkID0gdGhpcy5fcmVjb3JkOwogICAgICB2YXIgdHJpZ2dlciA9IHJlY29yZC50cmlnZ2VyOyAvLyBUT0RPIElnb3IgbWFrZSBuaWNlciBjaGVjawoKICAgICAgaWYgKHRyaWdnZXIgJiYgdHlwZW9mIHRyaWdnZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRyaWdnZXJzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdmFyIGV2ZW50TmFtZSA9IHRyaWdnZXJzW2ldOwogICAgICAgICAgdHJpZ2dlci5hcHBseShyZWNvcmQsIGV2ZW50TmFtZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0cmlnZ2Vycy5sZW5ndGggPSAwOwogICAgfTsKCiAgICBfcHJvdG8ucmVtb3ZlRnJvbUludmVyc2VSZWxhdGlvbnNoaXBzID0gZnVuY3Rpb24gcmVtb3ZlRnJvbUludmVyc2VSZWxhdGlvbnNoaXBzKGlzTmV3KSB7CiAgICAgIGlmIChpc05ldyA9PT0gdm9pZCAwKSB7CiAgICAgICAgaXNOZXcgPSBmYWxzZTsKICAgICAgfQoKICAgICAgdGhpcy5fcmVjb3JkRGF0YS5yZW1vdmVGcm9tSW52ZXJzZVJlbGF0aW9uc2hpcHMoaXNOZXcpOwogICAgfQogICAgLyoKICAgICAgV2hlbiBhIGZpbmQgcmVxdWVzdCBpcyB0cmlnZ2VyZWQgb24gdGhlIHN0b3JlLCB0aGUgdXNlciBjYW4gb3B0aW9uYWxseSBwYXNzIGluCiAgICAgIGF0dHJpYnV0ZXMgYW5kIHJlbGF0aW9uc2hpcHMgdG8gYmUgcHJlbG9hZGVkLiBUaGVzZSBhcmUgbWVhbnQgdG8gYmVoYXZlIGFzIGlmIHRoZXkKICAgICAgY2FtZSBiYWNrIGZyb20gdGhlIHNlcnZlciwgZXhjZXB0IHRoZSB1c2VyIG9idGFpbmVkIHRoZW0gb3V0IG9mIGJhbmQgYW5kIGlzIGluZm9ybWluZwogICAgICB0aGUgc3RvcmUgb2YgdGhlaXIgZXhpc3RlbmNlLiBUaGUgbW9zdCBjb21tb24gdXNlIGNhc2UgaXMgZm9yIHN1cHBvcnRpbmcgY2xpZW50IHNpZGUKICAgICAgbmVzdGVkIFVSTHMsIHN1Y2ggYXMgYC9wb3N0cy8xL2NvbW1lbnRzLzJgIHNvIHRoZSB1c2VyIGNhbiBkbwogICAgICBgc3RvcmUuZmluZFJlY29yZCgnY29tbWVudCcsIDIsIHsgcHJlbG9hZDogeyBwb3N0OiAxIH0gfSlgIHdpdGhvdXQgaGF2aW5nIHRvIGZldGNoIHRoZSBwb3N0LgogICAgICAgUHJlbG9hZGVkIGRhdGEgY2FuIGJlIGF0dHJpYnV0ZXMgYW5kIHJlbGF0aW9uc2hpcHMgcGFzc2VkIGluIGVpdGhlciBhcyBJRHMgb3IgYXMgYWN0dWFsCiAgICAgIG1vZGVscy4KICAgICAgIEBtZXRob2QgcHJlbG9hZERhdGEKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtPYmplY3R9IHByZWxvYWQKICAgICovCiAgICA7CgogICAgX3Byb3RvLnByZWxvYWREYXRhID0gZnVuY3Rpb24gcHJlbG9hZERhdGEocHJlbG9hZCkgewogICAgICB2YXIgX3RoaXM1ID0gdGhpczsKCiAgICAgIHZhciBqc29uUGF5bG9hZCA9IHt9OyAvL1RPRE8oSWdvcikgY29uc2lkZXIgdGhlIHBvbHltb3JwaGljIGNhc2UKCiAgICAgIE9iamVjdC5rZXlzKHByZWxvYWQpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIHZhciBwcmVsb2FkVmFsdWUgPSBFbWJlci5nZXQocHJlbG9hZCwga2V5KTsKCiAgICAgICAgdmFyIHJlbGF0aW9uc2hpcE1ldGEgPSBfdGhpczUubW9kZWxDbGFzcy5tZXRhRm9yUHJvcGVydHkoa2V5KTsKCiAgICAgICAgaWYgKHJlbGF0aW9uc2hpcE1ldGEuaXNSZWxhdGlvbnNoaXApIHsKICAgICAgICAgIGlmICghanNvblBheWxvYWQucmVsYXRpb25zaGlwcykgewogICAgICAgICAgICBqc29uUGF5bG9hZC5yZWxhdGlvbnNoaXBzID0ge307CiAgICAgICAgICB9CgogICAgICAgICAganNvblBheWxvYWQucmVsYXRpb25zaGlwc1trZXldID0gX3RoaXM1Ll9wcmVsb2FkUmVsYXRpb25zaGlwKGtleSwgcHJlbG9hZFZhbHVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKCFqc29uUGF5bG9hZC5hdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgIGpzb25QYXlsb2FkLmF0dHJpYnV0ZXMgPSB7fTsKICAgICAgICAgIH0KCiAgICAgICAgICBqc29uUGF5bG9hZC5hdHRyaWJ1dGVzW2tleV0gPSBwcmVsb2FkVmFsdWU7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHRoaXMuX3JlY29yZERhdGEucHVzaERhdGEoanNvblBheWxvYWQpOwogICAgfTsKCiAgICBfcHJvdG8uX3ByZWxvYWRSZWxhdGlvbnNoaXAgPSBmdW5jdGlvbiBfcHJlbG9hZFJlbGF0aW9uc2hpcChrZXksIHByZWxvYWRWYWx1ZSkgewogICAgICB2YXIgX3RoaXM2ID0gdGhpczsKCiAgICAgIHZhciByZWxhdGlvbnNoaXBNZXRhID0gdGhpcy5tb2RlbENsYXNzLm1ldGFGb3JQcm9wZXJ0eShrZXkpOwogICAgICB2YXIgbW9kZWxDbGFzcyA9IHJlbGF0aW9uc2hpcE1ldGEudHlwZTsKICAgICAgdmFyIGRhdGE7CgogICAgICBpZiAocmVsYXRpb25zaGlwTWV0YS5raW5kID09PSAnaGFzTWFueScpIHsKICAgICAgICBkYXRhID0gcHJlbG9hZFZhbHVlLm1hcChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgIHJldHVybiBfdGhpczYuX2NvbnZlcnRQcmVsb2FkUmVsYXRpb25zaGlwVG9KU09OKHZhbHVlLCBtb2RlbENsYXNzKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkYXRhID0gdGhpcy5fY29udmVydFByZWxvYWRSZWxhdGlvbnNoaXBUb0pTT04ocHJlbG9hZFZhbHVlLCBtb2RlbENsYXNzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiBkYXRhCiAgICAgIH07CiAgICB9OwoKICAgIF9wcm90by5fY29udmVydFByZWxvYWRSZWxhdGlvbnNoaXBUb0pTT04gPSBmdW5jdGlvbiBfY29udmVydFByZWxvYWRSZWxhdGlvbnNoaXBUb0pTT04odmFsdWUsIG1vZGVsQ2xhc3MpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBtb2RlbENsYXNzLAogICAgICAgICAgaWQ6IHZhbHVlCiAgICAgICAgfTsKICAgICAgfQoKICAgICAgdmFyIGludGVybmFsTW9kZWw7CgogICAgICBpZiAodmFsdWUuX2ludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsID0gdmFsdWUuX2ludGVybmFsTW9kZWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbCA9IHZhbHVlOwogICAgICB9IC8vIFRPRE8gSUdPUiBEQVZJRCBhc3NlcnQgaWYgbm8gaWQgaXMgcHJlc2VudAoKCiAgICAgIHJldHVybiB7CiAgICAgICAgdHlwZTogaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWUsCiAgICAgICAgaWQ6IGludGVybmFsTW9kZWwuaWQKICAgICAgfTsKICAgIH0KICAgIC8qCiAgICAgIFVzZWQgdG8gbm90aWZ5IHRoZSBzdG9yZSB0byB1cGRhdGUgRmlsdGVyZWRSZWNvcmRBcnJheSBtZW1iZXJzaGlwLgogICAgICAgQG1ldGhvZCB1cGRhdGVSZWNvcmRBcnJheXMKICAgICAgQHByaXZhdGUKICAgICovCiAgICA7CgogICAgX3Byb3RvLnVwZGF0ZVJlY29yZEFycmF5cyA9IGZ1bmN0aW9uIHVwZGF0ZVJlY29yZEFycmF5cygpIHsKICAgICAgLy8gQHRzLWlnbm9yZTogU3RvcmUgaXMgdW50eXBlZCBhbmQgdHlwZXNjcmlwdCBkb2VzIG5vdCBkZXRlY3QgaW5zdGFuY2UgcHJvcHMgc2V0IGluIGBpbml0YAogICAgICB0aGlzLnN0b3JlLnJlY29yZEFycmF5TWFuYWdlci5yZWNvcmREaWRDaGFuZ2UodGhpcyk7CiAgICB9OwoKICAgIF9wcm90by5zZXRJZCA9IGZ1bmN0aW9uIHNldElkKGlkKSB7CgogICAgICB2YXIgZGlkQ2hhbmdlID0gaWQgIT09IHRoaXMuX2lkOwogICAgICB0aGlzLl9pZCA9IGlkOwoKICAgICAgaWYgKGRpZENoYW5nZSAmJiBpZCAhPT0gbnVsbCkgewogICAgICAgIHRoaXMuc3RvcmUuc2V0UmVjb3JkSWQodGhpcy5tb2RlbE5hbWUsIGlkLCB0aGlzLmNsaWVudElkKTsKICAgICAgfQoKICAgICAgaWYgKGRpZENoYW5nZSAmJiB0aGlzLmhhc1JlY29yZCkgewogICAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MpIHsKICAgICAgICAgIHRoaXMuc3RvcmUuX25vdGlmaWNhdGlvbk1hbmFnZXIubm90aWZ5KHRoaXMuaWRlbnRpZmllciwgJ2lkZW50aXR5Jyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMubm90aWZ5UHJvcGVydHlDaGFuZ2UoJ2lkJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5kaWRFcnJvciA9IGZ1bmN0aW9uIGRpZEVycm9yKGVycm9yKSB7CiAgICAgIGlmICghY2FuYXJ5RmVhdHVyZXMuUkVRVUVTVF9TRVJWSUNFKSB7CiAgICAgICAgdGhpcy5lcnJvciA9IGVycm9yOwogICAgICAgIHRoaXMuaXNFcnJvciA9IHRydWU7CgogICAgICAgIGlmICh0aGlzLmhhc1JlY29yZCkgewogICAgICAgICAgdGhpcy5fcmVjb3JkLnNldFByb3BlcnRpZXMoewogICAgICAgICAgICBpc0Vycm9yOiB0cnVlLAogICAgICAgICAgICBhZGFwdGVyRXJyb3I6IGVycm9yCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLmRpZENsZWFuRXJyb3IgPSBmdW5jdGlvbiBkaWRDbGVhbkVycm9yKCkgewogICAgICBpZiAoIWNhbmFyeUZlYXR1cmVzLlJFUVVFU1RfU0VSVklDRSkgewogICAgICAgIHRoaXMuZXJyb3IgPSBudWxsOwogICAgICAgIHRoaXMuaXNFcnJvciA9IGZhbHNlOwoKICAgICAgICBpZiAodGhpcy5oYXNSZWNvcmQpIHsKICAgICAgICAgIHRoaXMuX3JlY29yZC5zZXRQcm9wZXJ0aWVzKHsKICAgICAgICAgICAgaXNFcnJvcjogZmFsc2UsCiAgICAgICAgICAgIGFkYXB0ZXJFcnJvcjogbnVsbAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKgogICAgICBJZiB0aGUgYWRhcHRlciBkaWQgbm90IHJldHVybiBhIGhhc2ggaW4gcmVzcG9uc2UgdG8gYSBjb21taXQsCiAgICAgIG1lcmdlIHRoZSBjaGFuZ2VkIGF0dHJpYnV0ZXMgYW5kIHJlbGF0aW9uc2hpcHMgaW50byB0aGUgZXhpc3RpbmcKICAgICAgc2F2ZWQgZGF0YS4KICAgICAgIEBtZXRob2QgYWRhcHRlckRpZENvbW1pdAogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uYWRhcHRlckRpZENvbW1pdCA9IGZ1bmN0aW9uIGFkYXB0ZXJEaWRDb21taXQoZGF0YSkgewogICAgICB0aGlzLmRpZENsZWFuRXJyb3IoKTsKCiAgICAgIHZhciBjaGFuZ2VkS2V5cyA9IHRoaXMuX3JlY29yZERhdGEuZGlkQ29tbWl0KGRhdGEpOwoKICAgICAgdGhpcy5zZW5kKCdkaWRDb21taXQnKTsKICAgICAgdGhpcy51cGRhdGVSZWNvcmRBcnJheXMoKTsKCiAgICAgIGlmICghZGF0YSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLkNVU1RPTV9NT0RFTF9DTEFTUykgewogICAgICAgIHRoaXMuc3RvcmUuX25vdGlmaWNhdGlvbk1hbmFnZXIubm90aWZ5KHRoaXMuaWRlbnRpZmllciwgJ2F0dHJpYnV0ZXMnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9yZWNvcmQuX25vdGlmeVByb3BlcnRpZXMoY2hhbmdlZEtleXMpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5hZGRFcnJvck1lc3NhZ2VUb0F0dHJpYnV0ZSA9IGZ1bmN0aW9uIGFkZEVycm9yTWVzc2FnZVRvQXR0cmlidXRlKGF0dHJpYnV0ZSwgbWVzc2FnZSkgewogICAgICBFbWJlci5nZXQodGhpcy5nZXRSZWNvcmQoKSwgJ2Vycm9ycycpLl9hZGQoYXR0cmlidXRlLCBtZXNzYWdlKTsKICAgIH07CgogICAgX3Byb3RvLnJlbW92ZUVycm9yTWVzc2FnZUZyb21BdHRyaWJ1dGUgPSBmdW5jdGlvbiByZW1vdmVFcnJvck1lc3NhZ2VGcm9tQXR0cmlidXRlKGF0dHJpYnV0ZSkgewogICAgICBFbWJlci5nZXQodGhpcy5nZXRSZWNvcmQoKSwgJ2Vycm9ycycpLl9yZW1vdmUoYXR0cmlidXRlKTsKICAgIH07CgogICAgX3Byb3RvLmNsZWFyRXJyb3JNZXNzYWdlcyA9IGZ1bmN0aW9uIGNsZWFyRXJyb3JNZXNzYWdlcygpIHsKICAgICAgRW1iZXIuZ2V0KHRoaXMuZ2V0UmVjb3JkKCksICdlcnJvcnMnKS5fY2xlYXIoKTsKICAgIH07CgogICAgX3Byb3RvLmhhc0Vycm9ycyA9IGZ1bmN0aW9uIGhhc0Vycm9ycygpIHsKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFQ09SRF9EQVRBX0VSUk9SUykgewogICAgICAgIGlmICh0aGlzLl9yZWNvcmREYXRhLmdldEVycm9ycykgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JlY29yZERhdGEuZ2V0RXJyb3JzKCB0aGlzLmlkZW50aWZpZXIgKS5sZW5ndGggPiAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgZXJyb3JzID0gRW1iZXIuZ2V0KHRoaXMuZ2V0UmVjb3JkKCksICdlcnJvcnMnKTsKICAgICAgICAgIHJldHVybiBlcnJvcnMuZ2V0KCdsZW5ndGgnKSA+IDA7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZhciBfZXJyb3JzID0gRW1iZXIuZ2V0KHRoaXMuZ2V0UmVjb3JkKCksICdlcnJvcnMnKTsKCiAgICAgICAgcmV0dXJuIF9lcnJvcnMuZ2V0KCdsZW5ndGgnKSA+IDA7CiAgICAgIH0KICAgIH0gLy8gRk9SIFVTRSBEVVJJTkcgQ09NTUlUIFBST0NFU1MKCiAgICAvKgogICAgICBAbWV0aG9kIGFkYXB0ZXJEaWRJbnZhbGlkYXRlCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgOwoKICAgIF9wcm90by5hZGFwdGVyRGlkSW52YWxpZGF0ZSA9IGZ1bmN0aW9uIGFkYXB0ZXJEaWRJbnZhbGlkYXRlKHBhcnNlZEVycm9ycywgZXJyb3IpIHsKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFQ09SRF9EQVRBX0VSUk9SUykgewogICAgICAgIHZhciBhdHRyaWJ1dGU7CgogICAgICAgIGlmIChlcnJvciAmJiBwYXJzZWRFcnJvcnMpIHsKICAgICAgICAgIGlmICghdGhpcy5fcmVjb3JkRGF0YS5nZXRFcnJvcnMpIHsKICAgICAgICAgICAgZm9yIChhdHRyaWJ1dGUgaW4gcGFyc2VkRXJyb3JzKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwocGFyc2VkRXJyb3JzLCBhdHRyaWJ1dGUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFkZEVycm9yTWVzc2FnZVRvQXR0cmlidXRlKGF0dHJpYnV0ZSwgcGFyc2VkRXJyb3JzW2F0dHJpYnV0ZV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHZhciBqc29uQXBpRXJyb3JzID0gZXJyb3JzSGFzaFRvQXJyYXkocGFyc2VkRXJyb3JzKTsKICAgICAgICAgIHRoaXMuc2VuZCgnYmVjYW1lSW52YWxpZCcpOwoKICAgICAgICAgIGlmIChqc29uQXBpRXJyb3JzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBqc29uQXBpRXJyb3JzID0gW3sKICAgICAgICAgICAgICB0aXRsZTogJ0ludmFsaWQgRXJyb3InLAogICAgICAgICAgICAgIGRldGFpbDogJycsCiAgICAgICAgICAgICAgc291cmNlOiB7CiAgICAgICAgICAgICAgICBwb2ludGVyOiAnL2RhdGEnCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9XTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLl9yZWNvcmREYXRhLmNvbW1pdFdhc1JlamVjdGVkKCB0aGlzLmlkZW50aWZpZXIgLCBqc29uQXBpRXJyb3JzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5zZW5kKCdiZWNhbWVFcnJvcicpOwoKICAgICAgICAgIHRoaXMuX3JlY29yZERhdGEuY29tbWl0V2FzUmVqZWN0ZWQoIHRoaXMuaWRlbnRpZmllciApOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgX2F0dHJpYnV0ZTsKCiAgICAgICAgZm9yIChfYXR0cmlidXRlIGluIHBhcnNlZEVycm9ycykgewogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwocGFyc2VkRXJyb3JzLCBfYXR0cmlidXRlKSkgewogICAgICAgICAgICB0aGlzLmFkZEVycm9yTWVzc2FnZVRvQXR0cmlidXRlKF9hdHRyaWJ1dGUsIHBhcnNlZEVycm9yc1tfYXR0cmlidXRlXSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNlbmQoJ2JlY2FtZUludmFsaWQnKTsKCiAgICAgICAgdGhpcy5fcmVjb3JkRGF0YS5jb21taXRXYXNSZWplY3RlZCgpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5ub3RpZnlFcnJvcnNDaGFuZ2UgPSBmdW5jdGlvbiBub3RpZnlFcnJvcnNDaGFuZ2UoKSB7CiAgICAgIHZhciBpbnZhbGlkRXJyb3JzOwoKICAgICAgaWYgKHRoaXMuX3JlY29yZERhdGEuZ2V0RXJyb3JzKSB7CiAgICAgICAgaW52YWxpZEVycm9ycyA9IHRoaXMuX3JlY29yZERhdGEuZ2V0RXJyb3JzKCB0aGlzLmlkZW50aWZpZXIgKSB8fCBbXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMubm90aWZ5SW52YWxpZEVycm9yc0NoYW5nZShpbnZhbGlkRXJyb3JzKTsKICAgIH07CgogICAgX3Byb3RvLm5vdGlmeUludmFsaWRFcnJvcnNDaGFuZ2UgPSBmdW5jdGlvbiBub3RpZnlJbnZhbGlkRXJyb3JzQ2hhbmdlKGpzb25BcGlFcnJvcnMpIHsKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLkNVU1RPTV9NT0RFTF9DTEFTUykgewogICAgICAgIHRoaXMuc3RvcmUuX25vdGlmaWNhdGlvbk1hbmFnZXIubm90aWZ5KHRoaXMuaWRlbnRpZmllciwgJ2Vycm9ycycpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuZ2V0UmVjb3JkKCkuaW52YWxpZEVycm9yc0NoYW5nZWQoanNvbkFwaUVycm9ycyk7CiAgICAgIH0KICAgIH0KICAgIC8qCiAgICAgIEBtZXRob2QgYWRhcHRlckRpZEVycm9yCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgOwoKICAgIF9wcm90by5hZGFwdGVyRGlkRXJyb3IgPSBmdW5jdGlvbiBhZGFwdGVyRGlkRXJyb3IoZXJyb3IpIHsKICAgICAgdGhpcy5zZW5kKCdiZWNhbWVFcnJvcicpOwogICAgICB0aGlzLmRpZEVycm9yKGVycm9yKTsKCiAgICAgIHRoaXMuX3JlY29yZERhdGEuY29tbWl0V2FzUmVqZWN0ZWQoKTsKICAgIH07CgogICAgX3Byb3RvLnRvU3RyaW5nID0gZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgIHJldHVybiAiPCIgKyB0aGlzLm1vZGVsTmFtZSArICI6IiArIHRoaXMuaWQgKyAiPiI7CiAgICB9OwoKICAgIF9wcm90by5yZWZlcmVuY2VGb3IgPSBmdW5jdGlvbiByZWZlcmVuY2VGb3Ioa2luZCwgbmFtZSkgewogICAgICB2YXIgcmVmZXJlbmNlID0gdGhpcy5yZWZlcmVuY2VzW25hbWVdOwoKICAgICAgaWYgKCFyZWZlcmVuY2UpIHsKICAgICAgICAvLyBUT0RPIElHT1IgQU5EIERBVklEIFJFRkFDVE9SCiAgICAgICAgdmFyIHJlbGF0aW9uc2hpcCA9IHJlbGF0aW9uc2hpcFN0YXRlRm9yJDEodGhpcywgbmFtZSk7CgogICAgICAgIHZhciByZWxhdGlvbnNoaXBLaW5kID0gcmVsYXRpb25zaGlwLnJlbGF0aW9uc2hpcE1ldGEua2luZDsKCiAgICAgICAgaWYgKHJlbGF0aW9uc2hpcEtpbmQgPT09ICdiZWxvbmdzVG8nKSB7CiAgICAgICAgICByZWZlcmVuY2UgPSBuZXcgQmVsb25nc1RvUmVmZXJlbmNlKHRoaXMuc3RvcmUsIHRoaXMsIHJlbGF0aW9uc2hpcCwgbmFtZSk7CiAgICAgICAgfSBlbHNlIGlmIChyZWxhdGlvbnNoaXBLaW5kID09PSAnaGFzTWFueScpIHsKICAgICAgICAgIHJlZmVyZW5jZSA9IG5ldyBIYXNNYW55UmVmZXJlbmNlKHRoaXMuc3RvcmUsIHRoaXMsIHJlbGF0aW9uc2hpcCwgbmFtZSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnJlZmVyZW5jZXNbbmFtZV0gPSByZWZlcmVuY2U7CiAgICAgIH0KCiAgICAgIHJldHVybiByZWZlcmVuY2U7CiAgICB9OwoKICAgIF9jcmVhdGVDbGFzcyQzKEludGVybmFsTW9kZWwsIFt7CiAgICAgIGtleTogImlkIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgewogICAgICAgICAgcmV0dXJuIHRoaXMuaWRlbnRpZmllci5pZDsgLy8gfHwgdGhpcy5faWQ7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldCh2YWx1ZSkgewogICAgICAgIHsKICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy5faWQpIHsKICAgICAgICAgICAgdmFyIG5ld0lkZW50aWZpZXIgPSB7CiAgICAgICAgICAgICAgdHlwZTogdGhpcy5pZGVudGlmaWVyLnR5cGUsCiAgICAgICAgICAgICAgbGlkOiB0aGlzLmlkZW50aWZpZXIubGlkLAogICAgICAgICAgICAgIGlkOiB2YWx1ZQogICAgICAgICAgICB9OwogICAgICAgICAgICBpZGVudGlmaWVyQ2FjaGVGb3IodGhpcy5zdG9yZSkudXBkYXRlUmVjb3JkSWRlbnRpZmllcih0aGlzLmlkZW50aWZpZXIsIG5ld0lkZW50aWZpZXIpOyAvLyBUT0RPIFNob3cgZGVwcmVjYXRpb24gZm9yIHByaXZhdGUgYXBpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIm1vZGVsQ2xhc3MiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICBpZiAodGhpcy5zdG9yZS5tb2RlbEZvcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX21vZGVsQ2xhc3MgfHwgKHRoaXMuX21vZGVsQ2xhc3MgPSB0aGlzLnN0b3JlLm1vZGVsRm9yKHRoaXMubW9kZWxOYW1lKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInR5cGUiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5tb2RlbENsYXNzOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlY29yZFJlZmVyZW5jZSIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIGlmICh0aGlzLl9yZWNvcmRSZWZlcmVuY2UgPT09IG51bGwpIHsKICAgICAgICAgIHRoaXMuX3JlY29yZFJlZmVyZW5jZSA9IG5ldyBSZWNvcmRSZWZlcmVuY2UodGhpcy5zdG9yZSwgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5fcmVjb3JkUmVmZXJlbmNlOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9yZWNvcmREYXRhIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgaWYgKHRoaXMuX19yZWNvcmREYXRhID09PSBudWxsKSB7CiAgICAgICAgICB2YXIgcmVjb3JkRGF0YSA9IHRoaXMuc3RvcmUuX2NyZWF0ZVJlY29yZERhdGEodGhpcy5pZGVudGlmaWVyKTsKCiAgICAgICAgICB0aGlzLl9yZWNvcmREYXRhID0gcmVjb3JkRGF0YTsKICAgICAgICAgIHJldHVybiByZWNvcmREYXRhOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuX19yZWNvcmREYXRhOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldChuZXdWYWx1ZSkgewogICAgICAgIHRoaXMuX19yZWNvcmREYXRhID0gbmV3VmFsdWU7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX3JlY29yZEFycmF5cyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIGlmICh0aGlzLl9fcmVjb3JkQXJyYXlzID09PSBudWxsKSB7CiAgICAgICAgICB0aGlzLl9fcmVjb3JkQXJyYXlzID0gbmV3IFNldCgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuX19yZWNvcmRBcnJheXM7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVmZXJlbmNlcyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIGlmICh0aGlzLl9yZWZlcmVuY2VzID09PSBudWxsKSB7CiAgICAgICAgICB0aGlzLl9yZWZlcmVuY2VzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLl9yZWZlcmVuY2VzOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9kZWZlcnJlZFRyaWdnZXJzIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgaWYgKHRoaXMuX19kZWZlcnJlZFRyaWdnZXJzID09PSBudWxsKSB7CiAgICAgICAgICB0aGlzLl9fZGVmZXJyZWRUcmlnZ2VycyA9IFtdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuX19kZWZlcnJlZFRyaWdnZXJzOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImlzRGVzdHJveWVkIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2lzRGVzdHJveWVkOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImhhc1JlY29yZCIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiAhIXRoaXMuX3JlY29yZDsKICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBJbnRlcm5hbE1vZGVsOwogIH0oKTsKCiAgZnVuY3Rpb24gaGFuZGxlQ29tcGxldGVkUmVsYXRpb25zaGlwUmVxdWVzdChpbnRlcm5hbE1vZGVsLCBrZXksIHJlbGF0aW9uc2hpcCwgdmFsdWUsIGVycm9yKSB7CiAgICBkZWxldGUgaW50ZXJuYWxNb2RlbC5fcmVsYXRpb25zaGlwUHJvbWlzZXNDYWNoZVtrZXldOwogICAgcmVsYXRpb25zaGlwLnNldFNob3VsZEZvcmNlUmVsb2FkKGZhbHNlKTsKCiAgICBpZiAoZXJyb3IpIHsKICAgICAgcmVsYXRpb25zaGlwLnNldEhhc0ZhaWxlZExvYWRBdHRlbXB0KHRydWUpOwogICAgICB2YXIgcHJveHkgPSBpbnRlcm5hbE1vZGVsLl9yZWxhdGlvbnNoaXBQcm94eUNhY2hlW2tleV07IC8vIGJlbG9uZ3NUbyByZWxhdGlvbnNoaXBzIGFyZSBzb21ldGltZXMgdW5sb2FkZWQKICAgICAgLy8gd2hlbiBhIGxvYWQgZmFpbHMsIGluIHRoaXMgY2FzZSB3ZSBuZWVkCiAgICAgIC8vIHRvIG1ha2Ugc3VyZSB0aGF0IHdlIGFyZW4ndCBwcm94eWluZwogICAgICAvLyB0byBkZXN0cm95ZWQgY29udGVudAogICAgICAvLyBmb3IgdGhlIHN5bmMgYmVsb25nc1RvIHJlbG9hZCBjYXNlIHRoZXJlIHdpbGwgYmUgbm8gcHJveHkKICAgICAgLy8gZm9yIHRoZSBhc3luYyByZWxvYWQgY2FzZSB0aGVyZSB3aWxsIGJlIG5vIHByb3h5IGlmIHRoZSB1aQogICAgICAvLyBoYXMgbmV2ZXIgYmVlbiBhY2Nlc3NlZAoKICAgICAgaWYgKHByb3h5ICYmIHJlbGF0aW9uc2hpcC5raW5kID09PSAnYmVsb25nc1RvJykgewogICAgICAgIGlmIChwcm94eS5jb250ZW50ICYmIHByb3h5LmNvbnRlbnQuaXNEZXN0cm95aW5nKSB7CiAgICAgICAgICBwcm94eS5zZXQoJ2NvbnRlbnQnLCBudWxsKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRocm93IGVycm9yOwogICAgfQoKICAgIHJlbGF0aW9uc2hpcC5zZXRIYXNGYWlsZWRMb2FkQXR0ZW1wdChmYWxzZSk7IC8vIG9ubHkgc2V0IHRvIG5vdCBzdGFsZSBpZiBubyBlcnJvciBpcyB0aHJvd24KCiAgICByZWxhdGlvbnNoaXAuc2V0UmVsYXRpb25zaGlwSXNTdGFsZShmYWxzZSk7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGZ1bmN0aW9uIGV4dHJhY3RSZWNvcmREYXRhc0Zyb21SZWNvcmRzKHJlY29yZHMpIHsKICAgIHJldHVybiByZWNvcmRzLm1hcChleHRyYWN0UmVjb3JkRGF0YUZyb21SZWNvcmQpOwogIH0KICBmdW5jdGlvbiBleHRyYWN0UmVjb3JkRGF0YUZyb21SZWNvcmQocmVjb3JkT3JQcm9taXNlUmVjb3JkKSB7CiAgICBpZiAoIXJlY29yZE9yUHJvbWlzZVJlY29yZCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBpZiAocmVjb3JkT3JQcm9taXNlUmVjb3JkLnRoZW4pIHsKICAgICAgdmFyIGNvbnRlbnQgPSByZWNvcmRPclByb21pc2VSZWNvcmQuZ2V0ICYmIHJlY29yZE9yUHJvbWlzZVJlY29yZC5nZXQoJ2NvbnRlbnQnKTsKICAgICAgcmV0dXJuIGNvbnRlbnQgPyByZWNvcmREYXRhRm9yKGNvbnRlbnQpIDogbnVsbDsKICAgIH0KCiAgICByZXR1cm4gcmVjb3JkRGF0YUZvcihyZWNvcmRPclByb21pc2VSZWNvcmQpOwogIH0KCiAgZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXMkNCh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKICBmdW5jdGlvbiBfY3JlYXRlQ2xhc3MkNChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzJDQoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyQ0KENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyLWRhdGEvc3RvcmUKICAqLwoKICAvKioKICAgYEludGVybmFsTW9kZWxNYXBgIGlzIGEgY3VzdG9tIHN0b3JhZ2UgbWFwIGZvciBpbnRlcm5hbE1vZGVscyBvZiBhIGdpdmVuIG1vZGVsTmFtZQogICB1c2VkIGJ5IGBJZGVudGl0eU1hcGAuCgogICBJdCB3YXMgZXh0cmFjdGVkIGZyb20gYW4gaW1wbGljaXQgcG9qbyBiYXNlZCAiaW50ZXJuYWxNb2RlbCBtYXAiIGFuZCBwcmVzZXJ2ZXMKICAgdGhhdCBpbnRlcmZhY2Ugd2hpbGUgd2Ugd29yayB0b3dhcmRzIGEgbW9yZSBvZmZpY2lhbCBBUEkuCgogICBAY2xhc3MgSW50ZXJuYWxNb2RlbE1hcAogICBAcHJpdmF0ZQogICAqLwogIHZhciBJbnRlcm5hbE1vZGVsTWFwID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gSW50ZXJuYWxNb2RlbE1hcChtb2RlbE5hbWUpIHsKICAgICAgdGhpcy5tb2RlbE5hbWUgPSBtb2RlbE5hbWU7CiAgICAgIHRoaXMuX2lkVG9Nb2RlbCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHRoaXMuX21vZGVscyA9IFtdOwogICAgICB0aGlzLl9tZXRhZGF0YSA9IG51bGw7CiAgICB9CiAgICAvKioKICAgICAqIEBtZXRob2QgZ2V0CiAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAqIEByZXR1cm4ge0ludGVybmFsTW9kZWx9CiAgICAgKi8KCgogICAgdmFyIF9wcm90byA9IEludGVybmFsTW9kZWxNYXAucHJvdG90eXBlOwoKICAgIF9wcm90by5nZXQgPSBmdW5jdGlvbiBnZXQoaWQpIHsKICAgICAgcmV0dXJuIHRoaXMuX2lkVG9Nb2RlbFtpZF0gfHwgbnVsbDsKICAgIH07CgogICAgX3Byb3RvLmhhcyA9IGZ1bmN0aW9uIGhhcyhpZCkgewogICAgICByZXR1cm4gISF0aGlzLl9pZFRvTW9kZWxbaWRdOwogICAgfTsKCiAgICBfcHJvdG8uc2V0ID0gZnVuY3Rpb24gc2V0KGlkLCBpbnRlcm5hbE1vZGVsKSB7CiAgICAgIHRoaXMuX2lkVG9Nb2RlbFtpZF0gPSBpbnRlcm5hbE1vZGVsOwogICAgfTsKCiAgICBfcHJvdG8uYWRkID0gZnVuY3Rpb24gYWRkKGludGVybmFsTW9kZWwsIGlkKSB7CgogICAgICBpZiAoaWQpIHsKICAgICAgICB0aGlzLl9pZFRvTW9kZWxbaWRdID0gaW50ZXJuYWxNb2RlbDsKICAgICAgfQoKICAgICAgdGhpcy5fbW9kZWxzLnB1c2goaW50ZXJuYWxNb2RlbCk7CiAgICB9OwoKICAgIF9wcm90by5yZW1vdmUgPSBmdW5jdGlvbiByZW1vdmUoaW50ZXJuYWxNb2RlbCwgaWQpIHsKICAgICAgZGVsZXRlIHRoaXMuX2lkVG9Nb2RlbFtpZF07CgogICAgICB2YXIgbG9jID0gdGhpcy5fbW9kZWxzLmluZGV4T2YoaW50ZXJuYWxNb2RlbCk7CgogICAgICBpZiAobG9jICE9PSAtMSkgewogICAgICAgIHRoaXMuX21vZGVscy5zcGxpY2UobG9jLCAxKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uY29udGFpbnMgPSBmdW5jdGlvbiBjb250YWlucyhpbnRlcm5hbE1vZGVsKSB7CiAgICAgIHJldHVybiB0aGlzLl9tb2RlbHMuaW5kZXhPZihpbnRlcm5hbE1vZGVsKSAhPT0gLTE7CiAgICB9CiAgICAvKioKICAgICBBbiBhcnJheSBvZiBhbGwgbW9kZWxzIG9mIHRoaXMgbW9kZWxOYW1lCiAgICAgQHByb3BlcnR5IG1vZGVscwogICAgIEB0eXBlIEFycmF5CiAgICAgKi8KICAgIDsKCiAgICAvKioKICAgICBEZXN0cm95IGFsbCBtb2RlbHMgaW4gdGhlIGludGVybmFsTW9kZWxUZXN0IGFuZCB3aXBlIG1ldGFkYXRhLgogICAgICBAbWV0aG9kIGNsZWFyCiAgICAgKi8KICAgIF9wcm90by5jbGVhciA9IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICB2YXIgaW50ZXJuYWxNb2RlbHMgPSB0aGlzLl9tb2RlbHM7CiAgICAgIHRoaXMuX21vZGVscyA9IFtdOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbnRlcm5hbE1vZGVscy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBpbnRlcm5hbE1vZGVsID0gaW50ZXJuYWxNb2RlbHNbaV07CiAgICAgICAgaW50ZXJuYWxNb2RlbC51bmxvYWRSZWNvcmQoKTsKICAgICAgfQoKICAgICAgdGhpcy5fbWV0YWRhdGEgPSBudWxsOwogICAgfTsKCiAgICBfY3JlYXRlQ2xhc3MkNChJbnRlcm5hbE1vZGVsTWFwLCBbewogICAgICBrZXk6ICJsZW5ndGgiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fbW9kZWxzLmxlbmd0aDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJtb2RlbHMiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fbW9kZWxzOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBtZXRhIGluZm9ybWF0aW9uIGFib3V0IGludGVybmFsTW9kZWxzCiAgICAgICAqIEBwcm9wZXJ0eSBtZXRhZGF0YQogICAgICAgKiBAdHlwZSBPYmplY3QKICAgICAgICovCgogICAgfSwgewogICAgICBrZXk6ICJtZXRhZGF0YSIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9tZXRhZGF0YSB8fCAodGhpcy5fbWV0YWRhdGEgPSBPYmplY3QuY3JlYXRlKG51bGwpKTsKICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBJbnRlcm5hbE1vZGVsTWFwOwogIH0oKTsKCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL3N0b3JlCiAgKi8KCiAgLyoqCiAgIGBJZGVudGl0eU1hcGAgaXMgYSBjdXN0b20gc3RvcmFnZSBtYXAgZm9yIHJlY29yZHMgYnkgbW9kZWxOYW1lCiAgIHVzZWQgYnkgYFN0b3JlYC4KCiAgIEBjbGFzcyBJZGVudGl0eU1hcAogICBAcHJpdmF0ZQogICAqLwogIHZhciBJZGVudGl0eU1hcCA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIElkZW50aXR5TWFwKCkgewogICAgICB0aGlzLl9tYXAgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBJZGVudGl0eU1hcC5wcm90b3R5cGU7CgogICAgLyoqCiAgICAgUmV0cmlldmVzIHRoZSBgSW50ZXJuYWxNb2RlbE1hcGAgZm9yIGEgZ2l2ZW4gbW9kZWxOYW1lLAogICAgIGNyZWF0aW5nIG9uZSBpZiBvbmUgZGlkIG5vdCBhbHJlYWR5IGV4aXN0LiBUaGlzIGlzCiAgICAgc2ltaWxhciB0byBgZ2V0V2l0aERlZmF1bHRgIG9yIGBnZXRgIG9uIGEgYE1hcFdpdGhEZWZhdWx0YAogICAgICBAbWV0aG9kIHJldHJpZXZlCiAgICAgQHBhcmFtIG1vZGVsTmFtZSBhIHByZXZpb3VzbHkgbm9ybWFsaXplZCBtb2RlbE5hbWUKICAgICBAcmV0dXJuIHtJbnRlcm5hbE1vZGVsTWFwfSB0aGUgSW50ZXJuYWxNb2RlbE1hcCBmb3IgdGhlIGdpdmVuIG1vZGVsTmFtZQogICAgICovCiAgICBfcHJvdG8ucmV0cmlldmUgPSBmdW5jdGlvbiByZXRyaWV2ZShtb2RlbE5hbWUpIHsKICAgICAgdmFyIG1hcCA9IHRoaXMuX21hcFttb2RlbE5hbWVdOwoKICAgICAgaWYgKG1hcCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgbWFwID0gdGhpcy5fbWFwW21vZGVsTmFtZV0gPSBuZXcgSW50ZXJuYWxNb2RlbE1hcChtb2RlbE5hbWUpOwogICAgICB9CgogICAgICByZXR1cm4gbWFwOwogICAgfQogICAgLyoqCiAgICAgQ2xlYXJzIHRoZSBjb250ZW50cyBvZiBhbGwga25vd24gYFJlY29yZE1hcHNgLCBidXQgZG9lcwogICAgIG5vdCByZW1vdmUgdGhlIEludGVybmFsTW9kZWxNYXAgaW5zdGFuY2VzLgogICAgICBAbWV0aG9kIGNsZWFyCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8uY2xlYXIgPSBmdW5jdGlvbiBjbGVhcigpIHsKICAgICAgdmFyIG1hcCA9IHRoaXMuX21hcDsKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhtYXApOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgbWFwW2tleV0uY2xlYXIoKTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gSWRlbnRpdHlNYXA7CiAgfSgpOwoKICBmdW5jdGlvbiBjb25zdHJ1Y3RSZXNvdXJjZSh0eXBlLCBpZCwgbGlkKSB7CiAgICB2YXIgdHJ1ZUlkID0gY29lcmNlSWQoaWQpOwoKICAgIGlmICghaXNOb25FbXB0eVN0cmluZyh0cnVlSWQpKSB7CiAgICAgIGlmIChpc05vbkVtcHR5U3RyaW5nKGxpZCkpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgIGlkOiB0cnVlSWQsCiAgICAgICAgICBsaWQ6IGxpZAogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgZWl0aGVyIGlkIG9yIGxpZCB0byBiZSBhIHZhbGlkIHN0cmluZyIpOwogICAgfQoKICAgIGlmIChpc05vbkVtcHR5U3RyaW5nKGxpZCkpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgIGlkOiB0cnVlSWQsCiAgICAgICAgbGlkOiBsaWQKICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICB0eXBlOiB0eXBlLAogICAgICBpZDogdHJ1ZUlkCiAgICB9OwogIH0KCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL3N0b3JlCiAgKi8KCiAgdmFyIEZhY3RvcnlDYWNoZSA9IG5ldyBXZWFrTWFwKCk7CiAgdmFyIFJlY29yZENhY2hlID0gbmV3IFdlYWtNYXAoKTsKICBmdW5jdGlvbiBwZWVrUmVjb3JkSWRlbnRpZmllcihyZWNvcmQpIHsKICAgIHJldHVybiBSZWNvcmRDYWNoZS5nZXQocmVjb3JkKTsKICB9CiAgZnVuY3Rpb24gcmVjb3JkSWRlbnRpZmllckZvcihyZWNvcmQpIHsKICAgIHZhciBpZGVudGlmaWVyID0gUmVjb3JkQ2FjaGUuZ2V0KHJlY29yZCk7CgogICAgcmV0dXJuIGlkZW50aWZpZXI7CiAgfQogIGZ1bmN0aW9uIHNldFJlY29yZElkZW50aWZpZXIocmVjb3JkLCBpZGVudGlmaWVyKSB7CiAgICAvKgogICAgSXQgd291bGQgYmUgbmljZSB0byBkbyBhIHJldmVyc2UgY2hlY2sgaGVyZSB0aGF0IGFuIGlkZW50aWZpZXIgaGFzIG5vdAogICAgcHJldmlvdXNseSBiZWVuIGFzc2lnbmVkIGEgcmVjb3JkOyBob3dldmVyLCB1bmxvYWQgKyByZW1hdGVyaWFsaXphdGlvbgogICAgcHJldmVudHMgdXMgZnJvbSBoYXZpbmcgYSBncmVhdCB3YXkgb2YgZG9pbmcgc28gd2hlbiBDdXN0b21SZWNvcmRDbGFzc2VzCiAgICBkb24ndCBuZWNlc3NhcmlseSBnaXZlIHVzIGFjY2VzcyB0byBhIGBpc0Rlc3Ryb3llZGAgZm9yIGRlbWF0ZXJpYWxpemVkCiAgICBpbnN0YW5jZS4KICAgICovCgoKICAgIFJlY29yZENhY2hlLnNldChyZWNvcmQsIGlkZW50aWZpZXIpOwogIH0KICBmdW5jdGlvbiBpbnRlcm5hbE1vZGVsRmFjdG9yeUZvcihzdG9yZSkgewogICAgdmFyIGZhY3RvcnkgPSBGYWN0b3J5Q2FjaGUuZ2V0KHN0b3JlKTsKCiAgICBpZiAoZmFjdG9yeSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGZhY3RvcnkgPSBuZXcgSW50ZXJuYWxNb2RlbEZhY3Rvcnkoc3RvcmUpOwogICAgICBGYWN0b3J5Q2FjaGUuc2V0KHN0b3JlLCBmYWN0b3J5KTsKICAgIH0KCiAgICByZXR1cm4gZmFjdG9yeTsKICB9CiAgLyoqCiAgICogVGhlIEludGVybmFsTW9kZWxGYWN0b3J5IGhhbmRsZXMgdGhlIGxpZmVjeWxlIG9mCiAgICogaW5zdGFudGlhdGluZywgY2FjaGluZywgYW5kIGRlc3Ryb3lpbmcgSW50ZXJuYWxNb2RlbAogICAqIGluc3RhbmNlcy4KICAgKgogICAqIEBpbnRlcm5hbAogICAqLwoKICB2YXIgSW50ZXJuYWxNb2RlbEZhY3RvcnkgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBJbnRlcm5hbE1vZGVsRmFjdG9yeShzdG9yZSkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdGhpcy5zdG9yZSA9IHN0b3JlOwogICAgICB0aGlzLl9pZGVudGl0eU1hcCA9IHZvaWQgMDsKICAgICAgdGhpcy5fbmV3bHlDcmVhdGVkID0gdm9pZCAwOwogICAgICB0aGlzLmlkZW50aWZpZXJDYWNoZSA9IHZvaWQgMDsKICAgICAgdGhpcy5pZGVudGlmaWVyQ2FjaGUgPSBpZGVudGlmaWVyQ2FjaGVGb3Ioc3RvcmUpOwoKICAgICAgdGhpcy5pZGVudGlmaWVyQ2FjaGUuX19jb25maWd1cmVNZXJnZShmdW5jdGlvbiAoaWRlbnRpZmllciwgbWF0Y2hlZElkZW50aWZpZXIsIHJlc291cmNlRGF0YSkgewogICAgICAgIHZhciBpbnRlbmRlZElkZW50aWZpZXIgPSBpZGVudGlmaWVyLmlkID09PSByZXNvdXJjZURhdGEuaWQgPyBpZGVudGlmaWVyIDogbWF0Y2hlZElkZW50aWZpZXI7CiAgICAgICAgdmFyIGFsdElkZW50aWZpZXIgPSBpZGVudGlmaWVyLmlkID09PSByZXNvdXJjZURhdGEuaWQgPyBtYXRjaGVkSWRlbnRpZmllciA6IGlkZW50aWZpZXI7IC8vIGNoZWNrIGZvciBkdXBsaWNhdGUgSW50ZXJuYWxNb2RlbCdzCgogICAgICAgIHZhciBtYXAgPSBfdGhpcy5tb2RlbE1hcEZvcihpZGVudGlmaWVyLnR5cGUpOwoKICAgICAgICB2YXIgaW0gPSBtYXAuZ2V0KGludGVuZGVkSWRlbnRpZmllci5saWQpOwogICAgICAgIHZhciBvdGhlckltID0gbWFwLmdldChhbHRJZGVudGlmaWVyLmxpZCk7IC8vIHdlIGNhbm5vdCBtZXJnZSBpbnRlcm5hbE1vZGVscyB3aGVuIGJvdGggaGF2ZSByZWNvcmRzCiAgICAgICAgLy8gKHRoaXMgbWF5IG5vdCBiZSBzdHJpY3RseSB0cnVlLCB3ZSBjb3VsZCBwcm9iYWJseSBzd2FwIHRoZSBpbnRlcm5hbE1vZGVsIHRoZSByZWNvcmQgcG9pbnRzIGF0KQoKICAgICAgICBpZiAoaW0gJiYgb3RoZXJJbSAmJiBpbS5oYXNSZWNvcmQgJiYgb3RoZXJJbS5oYXNSZWNvcmQpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRmFpbGVkIHRvIHVwZGF0ZSB0aGUgJ2lkJyBmb3IgdGhlIFJlY29yZElkZW50aWZpZXIgJyIgKyBpZGVudGlmaWVyICsgIicgdG8gJyIgKyByZXNvdXJjZURhdGEuaWQgKyAiJywgYmVjYXVzZSB0aGF0IGlkIGlzIGFscmVhZHkgaW4gdXNlIGJ5ICciICsgbWF0Y2hlZElkZW50aWZpZXIgKyAiJyIpOwogICAgICAgIH0gLy8gcmVtb3ZlIG90aGVySW0gZnJvbSBjYWNoZQoKCiAgICAgICAgaWYgKG90aGVySW0pIHsKICAgICAgICAgIG1hcC5yZW1vdmUob3RoZXJJbSwgYWx0SWRlbnRpZmllci5saWQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGltID09PSBudWxsICYmIG90aGVySW0gPT09IG51bGwpIHsKICAgICAgICAgIC8vIG5vdGhpbmcgbW9yZSB0byBkbwogICAgICAgICAgcmV0dXJuIGludGVuZGVkSWRlbnRpZmllcjsgLy8gb25seSB0aGUgb3RoZXIgaGFzIGFuIEludGVybmFsTW9kZWwKICAgICAgICAgIC8vIE9SIG9ubHkgdGhlIG90aGVyIGhhcyBhIFJlY29yZAogICAgICAgIH0gZWxzZSBpZiAoaW0gPT09IG51bGwgJiYgb3RoZXJJbSAhPT0gbnVsbCB8fCBpbSAmJiAhaW0uaGFzUmVjb3JkICYmIG90aGVySW0gJiYgb3RoZXJJbS5oYXNSZWNvcmQpIHsKICAgICAgICAgIGlmIChpbSkgewogICAgICAgICAgICAvLyBUT0RPIGNoZWNrIGlmIHdlIGFyZSByZXRhaW5lZCBpbiBhbnkgYXN5bmMgcmVsYXRpb25zaGlwcwogICAgICAgICAgICBtYXAucmVtb3ZlKGltLCBpbnRlbmRlZElkZW50aWZpZXIubGlkKTsgLy8gaW0uZGVzdHJveSgpOwogICAgICAgICAgfQoKICAgICAgICAgIGltID0gb3RoZXJJbTsgLy8gVE9ETyBkbyB3ZSBuZWVkIHRvIG5vdGlmeSB0aGUgaWQgY2hhbmdlPwoKICAgICAgICAgIGltLl9pZCA9IGludGVuZGVkSWRlbnRpZmllci5pZDsKICAgICAgICAgIG1hcC5hZGQoaW0sIGludGVuZGVkSWRlbnRpZmllci5saWQpOyAvLyBqdXN0IHVzZSBpbQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGludGVuZGVkSWRlbnRpZmllcjsKICAgICAgfSk7CgogICAgICB0aGlzLl9pZGVudGl0eU1hcCA9IG5ldyBJZGVudGl0eU1hcCgpOwogICAgfQogICAgLyoqCiAgICAgKiBSZXRyaWV2ZSB0aGUgSW50ZXJuYWxNb2RlbCBmb3IgYSBnaXZlbiB7IHR5cGUsIGlkLCBsaWQgfS4KICAgICAqCiAgICAgKiBJZiBhbiBJbnRlcm5hbE1vZGVsIGRvZXMgbm90IGV4aXN0LCBpdCBpbnN0YW50aWF0ZXMgb25lLgogICAgICoKICAgICAqIElmIGFuIEludGVybmFsTW9kZWwgZG9lcyBleGlzdCBidXMgaGFzIGEgc2NoZWR1bGVkIGRlc3Ryb3ksCiAgICAgKiAgIHRoZSBzY2hlZHVsZWQgZGVzdHJveSB3aWxsIGJlIGNhbmNlbGxlZC4KICAgICAqCiAgICAgKiBAaW50ZXJuYWwKICAgICAqLwoKCiAgICB2YXIgX3Byb3RvID0gSW50ZXJuYWxNb2RlbEZhY3RvcnkucHJvdG90eXBlOwoKICAgIF9wcm90by5sb29rdXAgPSBmdW5jdGlvbiBsb29rdXAocmVzb3VyY2UsIGRhdGEpIHsKICAgICAgaWYgKCBkYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAvLyBpZiB3ZSd2ZSBiZWVuIGdpdmVuIGRhdGEgYXNzb2NpYXRlZCB3aXRoIHRoaXMgbG9va3VwCiAgICAgICAgLy8gd2UgbXVzdCBmaXJzdCBnaXZlIHNlY29uZGFyeS1jYWNoZXMgZm9yIExJRHMgdGhlCiAgICAgICAgLy8gb3Bwb3J0dW5pdHkgdG8gcG9wdWxhdGUgYmFzZWQgb24gaXQKICAgICAgICB0aGlzLmlkZW50aWZpZXJDYWNoZS5nZXRPckNyZWF0ZVJlY29yZElkZW50aWZpZXIoZGF0YSk7CiAgICAgIH0KCiAgICAgIHZhciBpZGVudGlmaWVyID0gdGhpcy5pZGVudGlmaWVyQ2FjaGUuZ2V0T3JDcmVhdGVSZWNvcmRJZGVudGlmaWVyKHJlc291cmNlKTsKICAgICAgdmFyIGludGVybmFsTW9kZWwgPSB0aGlzLnBlZWsoaWRlbnRpZmllcik7CgogICAgICBpZiAoaW50ZXJuYWxNb2RlbCkgewogICAgICAgIC8vIHVubG9hZFJlY29yZCBpcyBhc3luYywgaWYgb25lIGF0dGVtcHRzIHRvIHVubG9hZCArIHRoZW4gc3luYyBwdXNoLAogICAgICAgIC8vICAgd2UgbXVzdCBlbnN1cmUgdGhlIHVubG9hZCBpcyBjYW5jZWxlZCBiZWZvcmUgY29udGludWluZwogICAgICAgIC8vICAgVGhlIGNyZWF0ZVJlY29yZCBwYXRoIHdpbGwgdGFrZSBfZXhpc3RpbmdJbnRlcm5hbE1vZGVsRm9ySWQoKQogICAgICAgIC8vICAgd2hpY2ggd2lsbCBjYWxsIGBkZXN0cm95U3luY2AgaW5zdGVhZCBmb3IgdGhpcyB1bmxvYWQgKyB0aGVuCiAgICAgICAgLy8gICBzeW5jIGNyZWF0ZVJlY29yZCBzY2VuYXJpby4gT25jZSB3ZSBoYXZlIHRydWUgY2xpZW50LXNpZGUKICAgICAgICAvLyAgIGRlbGV0ZSBzaWduYWxpbmcsIHdlIHNob3VsZCBuZXZlciBjYWxsIGRlc3Ryb3lTeW5jCiAgICAgICAgaWYgKGludGVybmFsTW9kZWwuaGFzU2NoZWR1bGVkRGVzdHJveSgpKSB7CiAgICAgICAgICBpbnRlcm5hbE1vZGVsLmNhbmNlbERlc3Ryb3koKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fYnVpbGQoaWRlbnRpZmllciwgZmFsc2UpOwogICAgfQogICAgLyoqCiAgICAgKiBQZWVrIHRoZSBJbnRlcm5hbE1vZGVsIGZvciBhIGdpdmVuIHsgdHlwZSwgaWQsIGxpZCB9LgogICAgICoKICAgICAqIElmIGFuIEludGVybmFsTW9kZWwgZG9lcyBub3QgZXhpc3QsIHJldHVybiBgbnVsbGAuCiAgICAgKgogICAgICogQGludGVybmFsCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucGVlayA9IGZ1bmN0aW9uIHBlZWsoaWRlbnRpZmllcikgewogICAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMubW9kZWxNYXBGb3IoaWRlbnRpZmllci50eXBlKS5nZXQoaWRlbnRpZmllci5saWQpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5nZXRCeVJlc291cmNlID0gZnVuY3Rpb24gZ2V0QnlSZXNvdXJjZShyZXNvdXJjZSkgewogICAgICB7CiAgICAgICAgdmFyIG5vcm1hbGl6ZWRSZXNvdXJjZSA9IGNvbnN0cnVjdFJlc291cmNlKHJlc291cmNlLnR5cGUsIHJlc291cmNlLmlkLCByZXNvdXJjZS5saWQpOwogICAgICAgIHJldHVybiB0aGlzLmxvb2t1cChub3JtYWxpemVkUmVzb3VyY2UpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5zZXRSZWNvcmRJZCA9IGZ1bmN0aW9uIHNldFJlY29yZElkKHR5cGUsIGlkLCBsaWQpIHsKICAgICAgdmFyIHJlc291cmNlID0gewogICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgaWQ6IG51bGwsCiAgICAgICAgbGlkOiBsaWQKICAgICAgfTsKICAgICAgdmFyIGlkZW50aWZpZXIgPSB0aGlzLmlkZW50aWZpZXJDYWNoZS5nZXRPckNyZWF0ZVJlY29yZElkZW50aWZpZXIocmVzb3VyY2UpOwogICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IHRoaXMucGVlayhpZGVudGlmaWVyKTsKCiAgICAgIGlmIChpbnRlcm5hbE1vZGVsID09PSBudWxsKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgc2V0IHRoZSBpZCAiICsgaWQgKyAiIG9uIHRoZSByZWNvcmQgIiArIHR5cGUgKyAiOiIgKyBsaWQgKyAiIGFzIHRoZXJlIGlzIG5vIHN1Y2ggcmVjb3JkIGluIHRoZSBjYWNoZS4iKTsKICAgICAgfQoKICAgICAgdmFyIG9sZElkID0gaW50ZXJuYWxNb2RlbC5pZDsKICAgICAgdmFyIG1vZGVsTmFtZSA9IGludGVybmFsTW9kZWwubW9kZWxOYW1lOyAvLyBJRCBhYnNvbHV0ZWx5IGNhbid0IGJlIG1pc3NpbmcgaWYgdGhlIG9sZElEIGlzIGVtcHR5IChtaXNzaW5nIElkIGluIHJlc3BvbnNlIGZvciBhIG5ldyByZWNvcmQpCiAgICAgIC8vIGhvd2V2ZXIsIHRoaXMgaXMgbW9yZSB0aGFuIGxpa2VseSBhIGRldmVsb3BlciBlcnJvci4KCiAgICAgIGlmIChvbGRJZCAhPT0gbnVsbCAmJiBpZCA9PT0gbnVsbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGV4aXN0aW5nSW50ZXJuYWxNb2RlbCA9IHRoaXMucGVla0J5SWQobW9kZWxOYW1lLCBpZCk7CgogICAgICBpZiAoaWRlbnRpZmllci5pZCA9PT0gbnVsbCkgewogICAgICAgIHRoaXMuaWRlbnRpZmllckNhY2hlLnVwZGF0ZVJlY29yZElkZW50aWZpZXIoaWRlbnRpZmllciwgewogICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgIGlkOiBpZAogICAgICAgIH0pOwogICAgICB9CgogICAgICBpbnRlcm5hbE1vZGVsLnNldElkKGlkKTsKICAgIH07CgogICAgX3Byb3RvLnBlZWtCeUlkID0gZnVuY3Rpb24gcGVla0J5SWQodHlwZSwgaWQpIHsKICAgICAgdmFyIGlkZW50aWZpZXIgPSB0aGlzLmlkZW50aWZpZXJDYWNoZS5wZWVrUmVjb3JkSWRlbnRpZmllcih7CiAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICBpZDogaWQKICAgICAgfSk7CiAgICAgIHZhciBpbnRlcm5hbE1vZGVsOwoKICAgICAgewogICAgICAgIGludGVybmFsTW9kZWwgPSBpZGVudGlmaWVyID8gdGhpcy5tb2RlbE1hcEZvcih0eXBlKS5nZXQoaWRlbnRpZmllci5saWQpIDogbnVsbDsKICAgICAgfQoKICAgICAgaWYgKGludGVybmFsTW9kZWwgJiYgaW50ZXJuYWxNb2RlbC5oYXNTY2hlZHVsZWREZXN0cm95KCkpIHsKICAgICAgICAvLyB1bmxvYWRSZWNvcmQgaXMgYXN5bmMsIGlmIG9uZSBhdHRlbXB0cyB0byB1bmxvYWQgKyB0aGVuIHN5bmMgY3JlYXRlLAogICAgICAgIC8vICAgd2UgbXVzdCBlbnN1cmUgdGhlIHVubG9hZCBpcyBjb21wbGV0ZSBiZWZvcmUgc3RhcnRpbmcgdGhlIGNyZWF0ZQogICAgICAgIC8vICAgVGhlIHB1c2ggcGF0aCB3aWxsIHRha2UgdGhpcy5sb29rdXAoKQogICAgICAgIC8vICAgd2hpY2ggd2lsbCBjYWxsIGBjYW5jZWxEZXN0cm95YCBpbnN0ZWFkIGZvciB0aGlzIHVubG9hZCArIHRoZW4KICAgICAgICAvLyAgIHN5bmMgcHVzaCBzY2VuYXJpby4gT25jZSB3ZSBoYXZlIHRydWUgY2xpZW50LXNpZGUKICAgICAgICAvLyAgIGRlbGV0ZSBzaWduYWxpbmcsIHdlIHNob3VsZCBuZXZlciBjYWxsIGRlc3Ryb3lTeW5jCiAgICAgICAgaW50ZXJuYWxNb2RlbC5kZXN0cm95U3luYygpOwogICAgICAgIGludGVybmFsTW9kZWwgPSBudWxsOwogICAgICB9CgogICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbDsKICAgIH07CgogICAgX3Byb3RvLmJ1aWxkID0gZnVuY3Rpb24gYnVpbGQobmV3UmVzb3VyY2VJbmZvKSB7CiAgICAgIHJldHVybiB0aGlzLl9idWlsZChuZXdSZXNvdXJjZUluZm8sIHRydWUpOwogICAgfTsKCiAgICBfcHJvdG8uX2J1aWxkID0gZnVuY3Rpb24gX2J1aWxkKHJlc291cmNlLCBpc0NyZWF0ZSkgewogICAgICBpZiAoaXNDcmVhdGUgPT09IHZvaWQgMCkgewogICAgICAgIGlzQ3JlYXRlID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmIChpc0NyZWF0ZSA9PT0gdHJ1ZSAmJiByZXNvdXJjZS5pZCkgewogICAgICAgIHZhciBleGlzdGluZ0ludGVybmFsTW9kZWwgPSB0aGlzLnBlZWtCeUlkKHJlc291cmNlLnR5cGUsIHJlc291cmNlLmlkKTsKICAgICAgfQoKICAgICAgdmFyIGlkZW50aWZpZXJDYWNoZSA9IHRoaXMuaWRlbnRpZmllckNhY2hlOwogICAgICB2YXIgaWRlbnRpZmllcjsKCiAgICAgIGlmIChpc0NyZWF0ZSA9PT0gdHJ1ZSkgewogICAgICAgIGlkZW50aWZpZXIgPSBpZGVudGlmaWVyQ2FjaGUuY3JlYXRlSWRlbnRpZmllckZvck5ld1JlY29yZChyZXNvdXJjZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWRlbnRpZmllciA9IHJlc291cmNlOwogICAgICB9IC8vIGxvb2t1cEZhY3Rvcnkgc2hvdWxkIHJlYWxseSByZXR1cm4gYW4gb2JqZWN0IHRoYXQgY3JlYXRlcwogICAgICAvLyBpbnN0YW5jZXMgd2l0aCB0aGUgaW5qZWN0aW9ucyBhcHBsaWVkCgoKICAgICAgdmFyIGludGVybmFsTW9kZWwgPSBuZXcgSW50ZXJuYWxNb2RlbCh0aGlzLnN0b3JlLCBpZGVudGlmaWVyKTsKCiAgICAgIHsKICAgICAgICB0aGlzLm1vZGVsTWFwRm9yKHJlc291cmNlLnR5cGUpLmFkZChpbnRlcm5hbE1vZGVsLCBpZGVudGlmaWVyLmxpZCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsOwogICAgfTsKCiAgICBfcHJvdG8ucmVtb3ZlID0gZnVuY3Rpb24gcmVtb3ZlKGludGVybmFsTW9kZWwpIHsKICAgICAgdmFyIHJlY29yZE1hcCA9IHRoaXMubW9kZWxNYXBGb3IoaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWUpOwogICAgICB2YXIgY2xpZW50SWQgPSBpbnRlcm5hbE1vZGVsLmlkZW50aWZpZXIubGlkOwoKICAgICAgewogICAgICAgIHJlY29yZE1hcC5yZW1vdmUoaW50ZXJuYWxNb2RlbCwgY2xpZW50SWQpOwogICAgICB9CgogICAgICB2YXIgaWRlbnRpZmllciA9IGludGVybmFsTW9kZWwuaWRlbnRpZmllcjsKICAgICAgdGhpcy5pZGVudGlmaWVyQ2FjaGUuZm9yZ2V0UmVjb3JkSWRlbnRpZmllcihpZGVudGlmaWVyKTsKICAgIH07CgogICAgX3Byb3RvLm1vZGVsTWFwRm9yID0gZnVuY3Rpb24gbW9kZWxNYXBGb3IodHlwZSkgewogICAgICByZXR1cm4gdGhpcy5faWRlbnRpdHlNYXAucmV0cmlldmUodHlwZSk7CiAgICB9OwoKICAgIF9wcm90by5fbmV3bHlDcmVhdGVkTW9kZWxzRm9yID0gZnVuY3Rpb24gX25ld2x5Q3JlYXRlZE1vZGVsc0Zvcih0eXBlKSB7CiAgICAgIHJldHVybiB0aGlzLl9uZXdseUNyZWF0ZWQucmV0cmlldmUodHlwZSk7CiAgICB9OwoKICAgIF9wcm90by5jbGVhciA9IGZ1bmN0aW9uIGNsZWFyKHR5cGUpIHsKICAgICAgaWYgKHR5cGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuX2lkZW50aXR5TWFwLmNsZWFyKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tb2RlbE1hcEZvcih0eXBlKS5jbGVhcigpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBJbnRlcm5hbE1vZGVsRmFjdG9yeTsKICB9KCk7CgogIGZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0aWVzJDUodGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCiAgZnVuY3Rpb24gX2NyZWF0ZUNsYXNzJDUoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyQ1KENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMkNShDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCiAgdmFyIFJlY29yZERhdGFTdG9yZVdyYXBwZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBSZWNvcmREYXRhU3RvcmVXcmFwcGVyKF9zdG9yZSkgewogICAgICB0aGlzLl9zdG9yZSA9IF9zdG9yZTsKICAgICAgdGhpc1tCUkFORF9TWU1CT0xdID0gdm9pZCAwOwogICAgICB0aGlzLl93aWxsVXBkYXRlTWFueUFycmF5cyA9IHZvaWQgMDsKICAgICAgdGhpcy5fcGVuZGluZ01hbnlBcnJheVVwZGF0ZXMgPSB2b2lkIDA7CiAgICAgIHRoaXMuX3dpbGxVcGRhdGVNYW55QXJyYXlzID0gZmFsc2U7CiAgICAgIHRoaXMuX3BlbmRpbmdNYW55QXJyYXlVcGRhdGVzID0gW107CiAgICB9CgogICAgdmFyIF9wcm90byA9IFJlY29yZERhdGFTdG9yZVdyYXBwZXIucHJvdG90eXBlOwoKICAgIC8qKgogICAgICogRXhpc3RzIHNvIHRoYXQgRGVmYXVsdFJlY29yZERhdGEgY2FuIGNoZWNrIGZvciBtb2RlbCB0eXBlcwogICAgICogaW4gREVCVUcgZm9yIHJlbGF0aW9uc2hpcHMuIFNob3VsZCBiZSByZWZhY3RvcmVkIGF3YXkuCiAgICAgKgogICAgICogQGludGVybmFsCiAgICAgKi8KICAgIF9wcm90by5faGFzTW9kZWxGb3IgPSBmdW5jdGlvbiBfaGFzTW9kZWxGb3IodHlwZSkgewogICAgICByZXR1cm4gdGhpcy5fc3RvcmUuX2hhc01vZGVsRm9yKHR5cGUpOwogICAgfQogICAgLyoqCiAgICAgKiBAaW50ZXJuYWwKICAgICAqLwogICAgOwoKICAgIF9wcm90by5fc2NoZWR1bGVNYW55QXJyYXlVcGRhdGUgPSBmdW5jdGlvbiBfc2NoZWR1bGVNYW55QXJyYXlVcGRhdGUoaWRlbnRpZmllciwga2V5KSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgcGVuZGluZyA9IHRoaXMuX3BlbmRpbmdNYW55QXJyYXlVcGRhdGVzID0gdGhpcy5fcGVuZGluZ01hbnlBcnJheVVwZGF0ZXMgfHwgW107CiAgICAgIHBlbmRpbmcucHVzaChpZGVudGlmaWVyLCBrZXkpOwoKICAgICAgaWYgKHRoaXMuX3dpbGxVcGRhdGVNYW55QXJyYXlzID09PSB0cnVlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl93aWxsVXBkYXRlTWFueUFycmF5cyA9IHRydWU7CiAgICAgIHZhciBiYWNrYnVybmVyID0gdGhpcy5fc3RvcmUuX2JhY2tidXJuZXI7CiAgICAgIGJhY2tidXJuZXIuam9pbihmdW5jdGlvbiAoKSB7CiAgICAgICAgYmFja2J1cm5lci5zY2hlZHVsZSgnc3luY1JlbGF0aW9uc2hpcHMnLCBfdGhpcywgX3RoaXMuX2ZsdXNoUGVuZGluZ01hbnlBcnJheVVwZGF0ZXMpOwogICAgICB9KTsKICAgIH07CgogICAgX3Byb3RvLm5vdGlmeUVycm9yc0NoYW5nZSA9IGZ1bmN0aW9uIG5vdGlmeUVycm9yc0NoYW5nZSh0eXBlLCBpZCwgbGlkKSB7CiAgICAgIHZhciByZXNvdXJjZSA9IGNvbnN0cnVjdFJlc291cmNlKHR5cGUsIGlkLCBsaWQpOwogICAgICB2YXIgaWRlbnRpZmllciA9IGlkZW50aWZpZXJDYWNoZUZvcih0aGlzLl9zdG9yZSkuZ2V0T3JDcmVhdGVSZWNvcmRJZGVudGlmaWVyKHJlc291cmNlKTsKICAgICAgdmFyIGludGVybmFsTW9kZWwgPSBpbnRlcm5hbE1vZGVsRmFjdG9yeUZvcih0aGlzLl9zdG9yZSkucGVlayhpZGVudGlmaWVyKTsKCiAgICAgIGlmIChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC5ub3RpZnlFcnJvcnNDaGFuZ2UoKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uX2ZsdXNoUGVuZGluZ01hbnlBcnJheVVwZGF0ZXMgPSBmdW5jdGlvbiBfZmx1c2hQZW5kaW5nTWFueUFycmF5VXBkYXRlcygpIHsKICAgICAgaWYgKHRoaXMuX3dpbGxVcGRhdGVNYW55QXJyYXlzID09PSBmYWxzZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHBlbmRpbmcgPSB0aGlzLl9wZW5kaW5nTWFueUFycmF5VXBkYXRlczsKICAgICAgdGhpcy5fcGVuZGluZ01hbnlBcnJheVVwZGF0ZXMgPSBbXTsKICAgICAgdGhpcy5fd2lsbFVwZGF0ZU1hbnlBcnJheXMgPSBmYWxzZTsKICAgICAgdmFyIGZhY3RvcnkgPSBpbnRlcm5hbE1vZGVsRmFjdG9yeUZvcih0aGlzLl9zdG9yZSk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBlbmRpbmcubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICB2YXIgaWRlbnRpZmllciA9IHBlbmRpbmdbaV07CiAgICAgICAgdmFyIF9rZXkgPSBwZW5kaW5nW2kgKyAxXTsKICAgICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IGZhY3RvcnkucGVlayhpZGVudGlmaWVyKTsKCiAgICAgICAgaWYgKGludGVybmFsTW9kZWwpIHsKICAgICAgICAgIGludGVybmFsTW9kZWwubm90aWZ5SGFzTWFueUNoYW5nZShfa2V5KTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLmF0dHJpYnV0ZXNEZWZpbml0aW9uRm9yID0gZnVuY3Rpb24gYXR0cmlidXRlc0RlZmluaXRpb25Gb3IodHlwZSkgewogICAgICByZXR1cm4gdGhpcy5fc3RvcmUuX2F0dHJpYnV0ZXNEZWZpbml0aW9uRm9yKHR5cGUpOwogICAgfTsKCiAgICBfcHJvdG8ucmVsYXRpb25zaGlwc0RlZmluaXRpb25Gb3IgPSBmdW5jdGlvbiByZWxhdGlvbnNoaXBzRGVmaW5pdGlvbkZvcih0eXBlKSB7CiAgICAgIHJldHVybiB0aGlzLl9zdG9yZS5fcmVsYXRpb25zaGlwc0RlZmluaXRpb25Gb3IodHlwZSk7CiAgICB9OwoKICAgIF9wcm90by5pbnZlcnNlRm9yUmVsYXRpb25zaGlwID0gZnVuY3Rpb24gaW52ZXJzZUZvclJlbGF0aW9uc2hpcCh0eXBlLCBrZXkpIHsKICAgICAgdmFyIG1vZGVsQ2xhc3MgPSB0aGlzLl9zdG9yZS5tb2RlbEZvcih0eXBlKTsKCiAgICAgIHZhciBkZWZpbml0aW9uID0gdXBncmFkZUZvckludGVybmFsKHRoaXMucmVsYXRpb25zaGlwc0RlZmluaXRpb25Gb3IodHlwZSlba2V5XSk7CgogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuQ1VTVE9NX01PREVMX0NMQVNTKSB7CiAgICAgICAgaWYgKGRlZmluaXRpb24uaW52ZXJzZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gZGVmaW5pdGlvbi5pbnZlcnNlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvL1RPRE8gYWRkIGEgdGVzdCBmb3IgdGhpcyBicmFuY2gKICAgICAgICAgIGlmICghZGVmaW5pdGlvbi5faW52ZXJzZUtleSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gZGVmaW5pdGlvbi5faW52ZXJzZUtleSh0aGlzLl9zdG9yZSwgbW9kZWxDbGFzcyk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBkZWZpbml0aW9uLl9pbnZlcnNlS2V5KHRoaXMuX3N0b3JlLCBtb2RlbENsYXNzKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uaW52ZXJzZUlzQXN5bmNGb3JSZWxhdGlvbnNoaXAgPSBmdW5jdGlvbiBpbnZlcnNlSXNBc3luY0ZvclJlbGF0aW9uc2hpcCh0eXBlLCBrZXkpIHsKICAgICAgdmFyIG1vZGVsQ2xhc3MgPSB0aGlzLl9zdG9yZS5tb2RlbEZvcih0eXBlKTsKCiAgICAgIHZhciBkZWZpbml0aW9uID0gdXBncmFkZUZvckludGVybmFsKHRoaXMucmVsYXRpb25zaGlwc0RlZmluaXRpb25Gb3IodHlwZSlba2V5XSk7CgogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuQ1VTVE9NX01PREVMX0NMQVNTKSB7CiAgICAgICAgaWYgKGRlZmluaXRpb24uaW52ZXJzZSA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRlZmluaXRpb24uaW52ZXJzZUlzQXN5bmMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuICEhZGVmaW5pdGlvbi5pbnZlcnNlSXNBc3luYzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGRlZmluaXRpb24uX2ludmVyc2VJc0FzeW5jKHRoaXMuX3N0b3JlLCBtb2RlbENsYXNzKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGRlZmluaXRpb24uX2ludmVyc2VJc0FzeW5jKHRoaXMuX3N0b3JlLCBtb2RlbENsYXNzKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8ubm90aWZ5UHJvcGVydHlDaGFuZ2UgPSBmdW5jdGlvbiBub3RpZnlQcm9wZXJ0eUNoYW5nZSh0eXBlLCBpZCwgbGlkLCBrZXkpIHsKICAgICAgdmFyIHJlc291cmNlID0gY29uc3RydWN0UmVzb3VyY2UodHlwZSwgaWQsIGxpZCk7CiAgICAgIHZhciBpZGVudGlmaWVyID0gaWRlbnRpZmllckNhY2hlRm9yKHRoaXMuX3N0b3JlKS5nZXRPckNyZWF0ZVJlY29yZElkZW50aWZpZXIocmVzb3VyY2UpOwogICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IGludGVybmFsTW9kZWxGYWN0b3J5Rm9yKHRoaXMuX3N0b3JlKS5wZWVrKGlkZW50aWZpZXIpOwoKICAgICAgaWYgKGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLm5vdGlmeVByb3BlcnR5Q2hhbmdlKGtleSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLm5vdGlmeUhhc01hbnlDaGFuZ2UgPSBmdW5jdGlvbiBub3RpZnlIYXNNYW55Q2hhbmdlKHR5cGUsIGlkLCBsaWQsIGtleSkgewogICAgICB2YXIgcmVzb3VyY2UgPSBjb25zdHJ1Y3RSZXNvdXJjZSh0eXBlLCBpZCwgbGlkKTsKICAgICAgdmFyIGlkZW50aWZpZXIgPSBpZGVudGlmaWVyQ2FjaGVGb3IodGhpcy5fc3RvcmUpLmdldE9yQ3JlYXRlUmVjb3JkSWRlbnRpZmllcihyZXNvdXJjZSk7CgogICAgICB0aGlzLl9zY2hlZHVsZU1hbnlBcnJheVVwZGF0ZShpZGVudGlmaWVyLCBrZXkpOwogICAgfTsKCiAgICBfcHJvdG8ubm90aWZ5QmVsb25nc1RvQ2hhbmdlID0gZnVuY3Rpb24gbm90aWZ5QmVsb25nc1RvQ2hhbmdlKHR5cGUsIGlkLCBsaWQsIGtleSkgewogICAgICB2YXIgcmVzb3VyY2UgPSBjb25zdHJ1Y3RSZXNvdXJjZSh0eXBlLCBpZCwgbGlkKTsKICAgICAgdmFyIGlkZW50aWZpZXIgPSBpZGVudGlmaWVyQ2FjaGVGb3IodGhpcy5fc3RvcmUpLmdldE9yQ3JlYXRlUmVjb3JkSWRlbnRpZmllcihyZXNvdXJjZSk7CiAgICAgIHZhciBpbnRlcm5hbE1vZGVsID0gaW50ZXJuYWxNb2RlbEZhY3RvcnlGb3IodGhpcy5fc3RvcmUpLnBlZWsoaWRlbnRpZmllcik7CgogICAgICBpZiAoaW50ZXJuYWxNb2RlbCkgewogICAgICAgIGludGVybmFsTW9kZWwubm90aWZ5QmVsb25nc1RvQ2hhbmdlKGtleSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLm5vdGlmeVN0YXRlQ2hhbmdlID0gZnVuY3Rpb24gbm90aWZ5U3RhdGVDaGFuZ2UodHlwZSwgaWQsIGxpZCwga2V5KSB7CiAgICAgIHZhciByZXNvdXJjZSA9IGNvbnN0cnVjdFJlc291cmNlKHR5cGUsIGlkLCBsaWQpOwogICAgICB2YXIgaWRlbnRpZmllciA9IGlkZW50aWZpZXJDYWNoZUZvcih0aGlzLl9zdG9yZSkuZ2V0T3JDcmVhdGVSZWNvcmRJZGVudGlmaWVyKHJlc291cmNlKTsKICAgICAgdmFyIGludGVybmFsTW9kZWwgPSBpbnRlcm5hbE1vZGVsRmFjdG9yeUZvcih0aGlzLl9zdG9yZSkucGVlayhpZGVudGlmaWVyKTsKCiAgICAgIGlmIChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC5ub3RpZnlTdGF0ZUNoYW5nZShrZXkpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5yZWNvcmREYXRhRm9yID0gZnVuY3Rpb24gcmVjb3JkRGF0YUZvcih0eXBlLCBpZCwgbGlkKSB7CiAgICAgIHZhciBpZGVudGlmaWVyOwogICAgICB2YXIgaXNDcmVhdGUgPSBmYWxzZTsKCiAgICAgIGlmICghaWQgJiYgIWxpZCkgewogICAgICAgIGlzQ3JlYXRlID0gdHJ1ZTsKICAgICAgICBpZGVudGlmaWVyID0gewogICAgICAgICAgdHlwZTogdHlwZQogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHJlc291cmNlID0gY29uc3RydWN0UmVzb3VyY2UodHlwZSwgaWQsIGxpZCk7CiAgICAgICAgaWRlbnRpZmllciA9IGlkZW50aWZpZXJDYWNoZUZvcih0aGlzLl9zdG9yZSkuZ2V0T3JDcmVhdGVSZWNvcmRJZGVudGlmaWVyKHJlc291cmNlKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuX3N0b3JlLnJlY29yZERhdGFGb3IoaWRlbnRpZmllciwgaXNDcmVhdGUpOwogICAgfTsKCiAgICBfcHJvdG8uc2V0UmVjb3JkSWQgPSBmdW5jdGlvbiBzZXRSZWNvcmRJZCh0eXBlLCBpZCwgbGlkKSB7CiAgICAgIHRoaXMuX3N0b3JlLnNldFJlY29yZElkKHR5cGUsIGlkLCBsaWQpOwogICAgfTsKCiAgICBfcHJvdG8uaXNSZWNvcmRJblVzZSA9IGZ1bmN0aW9uIGlzUmVjb3JkSW5Vc2UodHlwZSwgaWQsIGxpZCkgewogICAgICB2YXIgcmVzb3VyY2UgPSBjb25zdHJ1Y3RSZXNvdXJjZSh0eXBlLCBpZCwgbGlkKTsKICAgICAgdmFyIGlkZW50aWZpZXIgPSBpZGVudGlmaWVyQ2FjaGVGb3IodGhpcy5fc3RvcmUpLmdldE9yQ3JlYXRlUmVjb3JkSWRlbnRpZmllcihyZXNvdXJjZSk7CiAgICAgIHZhciBpbnRlcm5hbE1vZGVsID0gaW50ZXJuYWxNb2RlbEZhY3RvcnlGb3IodGhpcy5fc3RvcmUpLnBlZWsoaWRlbnRpZmllcik7CgogICAgICBpZiAoIWludGVybmFsTW9kZWwpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsLmlzUmVjb3JkSW5Vc2UoKTsKICAgIH07CgogICAgX3Byb3RvLmRpc2Nvbm5lY3RSZWNvcmQgPSBmdW5jdGlvbiBkaXNjb25uZWN0UmVjb3JkKHR5cGUsIGlkLCBsaWQpIHsKICAgICAgdmFyIHJlc291cmNlID0gY29uc3RydWN0UmVzb3VyY2UodHlwZSwgaWQsIGxpZCk7CiAgICAgIHZhciBpZGVudGlmaWVyID0gaWRlbnRpZmllckNhY2hlRm9yKHRoaXMuX3N0b3JlKS5nZXRPckNyZWF0ZVJlY29yZElkZW50aWZpZXIocmVzb3VyY2UpOwogICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IGludGVybmFsTW9kZWxGYWN0b3J5Rm9yKHRoaXMuX3N0b3JlKS5wZWVrKGlkZW50aWZpZXIpOwoKICAgICAgaWYgKGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLmRlc3Ryb3lGcm9tUmVjb3JkRGF0YSgpOwogICAgICB9CiAgICB9OwoKICAgIF9jcmVhdGVDbGFzcyQ1KFJlY29yZERhdGFTdG9yZVdyYXBwZXIsIFt7CiAgICAgIGtleTogImlkZW50aWZpZXJDYWNoZSIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewoKICAgICAgICByZXR1cm4gaWRlbnRpZmllckNhY2hlRm9yKHRoaXMuX3N0b3JlKTsKICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBSZWNvcmREYXRhU3RvcmVXcmFwcGVyOwogIH0oKTsKCiAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci1kYXRhL3N0b3JlCiAgKi8KICAvKgogICAgVGhpcyBpcyBhIGhlbHBlciBtZXRob2QgdGhhdCBhbHdheXMgcmV0dXJucyBhIEpTT04tQVBJIERvY3VtZW50LgoKICAgIEBtZXRob2Qgbm9ybWFsaXplUmVzcG9uc2VIZWxwZXIKICAgIEBwYXJhbSB7U2VyaWFsaXplcn0gc2VyaWFsaXplcgogICAgQHBhcmFtIHtTdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgTW9kZWx9IG1vZGVsQ2xhc3MKICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IGlkCiAgICBAcGFyYW0ge1N0cmluZ30gcmVxdWVzdFR5cGUKICAgIEByZXR1cm4ge09iamVjdH0gSlNPTi1BUEkgRG9jdW1lbnQKICAqLwoKICBmdW5jdGlvbiBub3JtYWxpemVSZXNwb25zZUhlbHBlcihzZXJpYWxpemVyLCBzdG9yZSwgbW9kZWxDbGFzcywgcGF5bG9hZCwgaWQsIHJlcXVlc3RUeXBlKSB7CiAgICB2YXIgbm9ybWFsaXplZFJlc3BvbnNlID0gc2VyaWFsaXplci5ub3JtYWxpemVSZXNwb25zZShzdG9yZSwgbW9kZWxDbGFzcywgcGF5bG9hZCwgaWQsIHJlcXVlc3RUeXBlKTsKICAgIHJldHVybiBub3JtYWxpemVkUmVzcG9uc2U7CiAgfQoKICB2YXIgUmVxdWVzdFN0YXRlRW51bTsKCiAgKGZ1bmN0aW9uIChSZXF1ZXN0U3RhdGVFbnVtKSB7CiAgICBSZXF1ZXN0U3RhdGVFbnVtWyJwZW5kaW5nIl0gPSAicGVuZGluZyI7CiAgICBSZXF1ZXN0U3RhdGVFbnVtWyJmdWxmaWxsZWQiXSA9ICJmdWxmaWxsZWQiOwogICAgUmVxdWVzdFN0YXRlRW51bVsicmVqZWN0ZWQiXSA9ICJyZWplY3RlZCI7CiAgfSkoUmVxdWVzdFN0YXRlRW51bSB8fCAoUmVxdWVzdFN0YXRlRW51bSA9IHt9KSk7CgogIHZhciBUb3VjaGluZyA9IHN5bWJvbCgndG91Y2hpbmcnKTsKICB2YXIgUmVxdWVzdFByb21pc2UgPSBzeW1ib2woJ3Byb21pc2UnKTsKCiAgZnVuY3Rpb24gaGFzUmVjb3JkSWRlbnRpZmllcihvcCkgewogICAgcmV0dXJuICdyZWNvcmRJZGVudGlmaWVyJyBpbiBvcDsKICB9CgogIHZhciBSZXF1ZXN0Q2FjaGUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBSZXF1ZXN0Q2FjaGUoKSB7CiAgICAgIHRoaXMuX3BlbmRpbmcgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB0aGlzLl9kb25lID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgdGhpcy5fc3Vic2NyaXB0aW9ucyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB9CgogICAgdmFyIF9wcm90byA9IFJlcXVlc3RDYWNoZS5wcm90b3R5cGU7CgogICAgX3Byb3RvLmVucXVldWUgPSBmdW5jdGlvbiBlbnF1ZXVlKHByb21pc2UsIHF1ZXJ5UmVxdWVzdCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIHF1ZXJ5ID0gcXVlcnlSZXF1ZXN0LmRhdGFbMF07CgogICAgICBpZiAoaGFzUmVjb3JkSWRlbnRpZmllcihxdWVyeSkpIHsKICAgICAgICB2YXIgX3JlcXVlc3Q7CgogICAgICAgIHZhciBfbGlkID0gcXVlcnkucmVjb3JkSWRlbnRpZmllci5saWQ7CiAgICAgICAgdmFyIHR5cGUgPSBxdWVyeS5vcCA9PT0gJ3NhdmVSZWNvcmQnID8gJ211dGF0aW9uJyA6ICdxdWVyeSc7CgogICAgICAgIGlmICghdGhpcy5fcGVuZGluZ1tfbGlkXSkgewogICAgICAgICAgdGhpcy5fcGVuZGluZ1tfbGlkXSA9IFtdOwogICAgICAgIH0KCiAgICAgICAgdmFyIHJlcXVlc3QgPSAoX3JlcXVlc3QgPSB7CiAgICAgICAgICBzdGF0ZTogUmVxdWVzdFN0YXRlRW51bS5wZW5kaW5nLAogICAgICAgICAgcmVxdWVzdDogcXVlcnlSZXF1ZXN0LAogICAgICAgICAgdHlwZTogdHlwZQogICAgICAgIH0sIF9yZXF1ZXN0W1RvdWNoaW5nXSA9IFtxdWVyeS5yZWNvcmRJZGVudGlmaWVyXSwgX3JlcXVlc3RbUmVxdWVzdFByb21pc2VdID0gcHJvbWlzZSwgX3JlcXVlc3QpOwoKICAgICAgICB0aGlzLl9wZW5kaW5nW19saWRdLnB1c2gocmVxdWVzdCk7CgogICAgICAgIHRoaXMuX3RyaWdnZXJTdWJzY3JpcHRpb25zKHJlcXVlc3QpOwoKICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgICAgdmFyIF9maW5hbGl6ZWRSZXF1ZXN0OwoKICAgICAgICAgIF90aGlzLl9kZXF1ZXVlKF9saWQsIHJlcXVlc3QpOwoKICAgICAgICAgIHZhciBmaW5hbGl6ZWRSZXF1ZXN0ID0gKF9maW5hbGl6ZWRSZXF1ZXN0ID0gewogICAgICAgICAgICBzdGF0ZTogUmVxdWVzdFN0YXRlRW51bS5mdWxmaWxsZWQsCiAgICAgICAgICAgIHJlcXVlc3Q6IHF1ZXJ5UmVxdWVzdCwKICAgICAgICAgICAgdHlwZTogdHlwZQogICAgICAgICAgfSwgX2ZpbmFsaXplZFJlcXVlc3RbVG91Y2hpbmddID0gcmVxdWVzdFtUb3VjaGluZ10sIF9maW5hbGl6ZWRSZXF1ZXN0LnJlc3BvbnNlID0gewogICAgICAgICAgICBkYXRhOiByZXN1bHQKICAgICAgICAgIH0sIF9maW5hbGl6ZWRSZXF1ZXN0KTsKCiAgICAgICAgICBfdGhpcy5fYWRkRG9uZShmaW5hbGl6ZWRSZXF1ZXN0KTsKCiAgICAgICAgICBfdGhpcy5fdHJpZ2dlclN1YnNjcmlwdGlvbnMoZmluYWxpemVkUmVxdWVzdCk7CiAgICAgICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICB2YXIgX2ZpbmFsaXplZFJlcXVlc3QyOwoKICAgICAgICAgIF90aGlzLl9kZXF1ZXVlKF9saWQsIHJlcXVlc3QpOwoKICAgICAgICAgIHZhciBmaW5hbGl6ZWRSZXF1ZXN0ID0gKF9maW5hbGl6ZWRSZXF1ZXN0MiA9IHsKICAgICAgICAgICAgc3RhdGU6IFJlcXVlc3RTdGF0ZUVudW0ucmVqZWN0ZWQsCiAgICAgICAgICAgIHJlcXVlc3Q6IHF1ZXJ5UmVxdWVzdCwKICAgICAgICAgICAgdHlwZTogdHlwZQogICAgICAgICAgfSwgX2ZpbmFsaXplZFJlcXVlc3QyW1RvdWNoaW5nXSA9IHJlcXVlc3RbVG91Y2hpbmddLCBfZmluYWxpemVkUmVxdWVzdDIucmVzcG9uc2UgPSB7CiAgICAgICAgICAgIGRhdGE6IGVycm9yICYmIGVycm9yLmVycm9yCiAgICAgICAgICB9LCBfZmluYWxpemVkUmVxdWVzdDIpOwoKICAgICAgICAgIF90aGlzLl9hZGREb25lKGZpbmFsaXplZFJlcXVlc3QpOwoKICAgICAgICAgIF90aGlzLl90cmlnZ2VyU3Vic2NyaXB0aW9ucyhmaW5hbGl6ZWRSZXF1ZXN0KTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uX3RyaWdnZXJTdWJzY3JpcHRpb25zID0gZnVuY3Rpb24gX3RyaWdnZXJTdWJzY3JpcHRpb25zKHJlcSkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIHJlcVtUb3VjaGluZ10uZm9yRWFjaChmdW5jdGlvbiAoaWRlbnRpZmllcikgewogICAgICAgIGlmIChfdGhpczIuX3N1YnNjcmlwdGlvbnNbaWRlbnRpZmllci5saWRdKSB7CiAgICAgICAgICBfdGhpczIuX3N1YnNjcmlwdGlvbnNbaWRlbnRpZmllci5saWRdLmZvckVhY2goZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhyZXEpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CgogICAgX3Byb3RvLl9kZXF1ZXVlID0gZnVuY3Rpb24gX2RlcXVldWUobGlkLCByZXF1ZXN0KSB7CiAgICAgIHRoaXMuX3BlbmRpbmdbbGlkXSA9IHRoaXMuX3BlbmRpbmdbbGlkXS5maWx0ZXIoZnVuY3Rpb24gKHJlcSkgewogICAgICAgIHJldHVybiByZXEgIT09IHJlcXVlc3Q7CiAgICAgIH0pOwogICAgfTsKCiAgICBfcHJvdG8uX2FkZERvbmUgPSBmdW5jdGlvbiBfYWRkRG9uZShyZXF1ZXN0KSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgcmVxdWVzdFtUb3VjaGluZ10uZm9yRWFjaChmdW5jdGlvbiAoaWRlbnRpZmllcikgewogICAgICAgIGlmICghX3RoaXMzLl9kb25lW2lkZW50aWZpZXIubGlkXSkgewogICAgICAgICAgX3RoaXMzLl9kb25lW2lkZW50aWZpZXIubGlkXSA9IFtdOwogICAgICAgIH0gLy8gVE9ETyBhZGQgc3VwcG9ydCBmb3IgbXVsdGlwbGUKCgogICAgICAgIHZhciByZXF1ZXN0RGF0YU9wID0gcmVxdWVzdC5yZXF1ZXN0LmRhdGFbMF0ub3A7CiAgICAgICAgX3RoaXMzLl9kb25lW2lkZW50aWZpZXIubGlkXSA9IF90aGlzMy5fZG9uZVtpZGVudGlmaWVyLmxpZF0uZmlsdGVyKGZ1bmN0aW9uIChyZXEpIHsKICAgICAgICAgIC8vIFRPRE8gYWRkIHN1cHBvcnQgZm9yIG11bHRpcGxlCiAgICAgICAgICB2YXIgZGF0YTsKCiAgICAgICAgICBpZiAocmVxLnJlcXVlc3QuZGF0YSBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgIGRhdGEgPSByZXEucmVxdWVzdC5kYXRhWzBdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGF0YSA9IHJlcS5yZXF1ZXN0LmRhdGE7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGRhdGEub3AgIT09IHJlcXVlc3REYXRhT3A7CiAgICAgICAgfSk7CgogICAgICAgIF90aGlzMy5fZG9uZVtpZGVudGlmaWVyLmxpZF0ucHVzaChyZXF1ZXN0KTsKICAgICAgfSk7CiAgICB9OwoKICAgIF9wcm90by5zdWJzY3JpYmVGb3JSZWNvcmQgPSBmdW5jdGlvbiBzdWJzY3JpYmVGb3JSZWNvcmQoaWRlbnRpZmllciwgY2FsbGJhY2spIHsKICAgICAgaWYgKCF0aGlzLl9zdWJzY3JpcHRpb25zW2lkZW50aWZpZXIubGlkXSkgewogICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNbaWRlbnRpZmllci5saWRdID0gW107CiAgICAgIH0KCiAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNbaWRlbnRpZmllci5saWRdLnB1c2goY2FsbGJhY2spOwogICAgfTsKCiAgICBfcHJvdG8uZ2V0UGVuZGluZ1JlcXVlc3RzRm9yUmVjb3JkID0gZnVuY3Rpb24gZ2V0UGVuZGluZ1JlcXVlc3RzRm9yUmVjb3JkKGlkZW50aWZpZXIpIHsKICAgICAgaWYgKHRoaXMuX3BlbmRpbmdbaWRlbnRpZmllci5saWRdKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3BlbmRpbmdbaWRlbnRpZmllci5saWRdOwogICAgICB9CgogICAgICByZXR1cm4gW107CiAgICB9OwoKICAgIF9wcm90by5nZXRMYXN0UmVxdWVzdEZvclJlY29yZCA9IGZ1bmN0aW9uIGdldExhc3RSZXF1ZXN0Rm9yUmVjb3JkKGlkZW50aWZpZXIpIHsKICAgICAgdmFyIHJlcXVlc3RzID0gdGhpcy5fZG9uZVtpZGVudGlmaWVyLmxpZF07CgogICAgICBpZiAocmVxdWVzdHMpIHsKICAgICAgICByZXR1cm4gcmVxdWVzdHNbcmVxdWVzdHMubGVuZ3RoIC0gMV07CiAgICAgIH0KCiAgICAgIHJldHVybiBudWxsOwogICAgfTsKCiAgICByZXR1cm4gUmVxdWVzdENhY2hlOwogIH0oKTsKCiAgdmFyIGVtYmVyUnVuID0gRW1iZXIucnVuLmJhY2tidXJuZXI7CiAgdmFyIFNhdmVPcCA9IHN5bWJvbCgnU2F2ZU9wJyk7CgogIHZhciBGZXRjaE1hbmFnZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICAvLyBzYXZlcyB3aGljaCBhcmUgcGVuZGluZyBpbiB0aGUgcnVubG9vcAogICAgLy8gZmV0Y2hlcyBwZW5kaW5nIGluIHRoZSBydW5sb29wLCB3YWl0aW5nIHRvIGJlIGNvYWxlc2NlZAogICAgZnVuY3Rpb24gRmV0Y2hNYW5hZ2VyKF9zdG9yZSkgewogICAgICB0aGlzLl9zdG9yZSA9IF9zdG9yZTsKICAgICAgdGhpcy5pc0Rlc3Ryb3llZCA9IHZvaWQgMDsKICAgICAgdGhpcy5yZXF1ZXN0Q2FjaGUgPSB2b2lkIDA7CiAgICAgIHRoaXMuX3BlbmRpbmdTYXZlID0gdm9pZCAwOwogICAgICB0aGlzLl9wZW5kaW5nRmV0Y2ggPSB2b2lkIDA7CiAgICAgIC8vIHVzZWQgdG8ga2VlcCB0cmFjayBvZiBhbGwgdGhlIGZpbmQgcmVxdWVzdHMgdGhhdCBuZWVkIHRvIGJlIGNvYWxlc2NlZAogICAgICB0aGlzLl9wZW5kaW5nRmV0Y2ggPSBuZXcgTWFwKCk7CiAgICAgIHRoaXMuX3BlbmRpbmdTYXZlID0gW107CiAgICAgIHRoaXMucmVxdWVzdENhY2hlID0gbmV3IFJlcXVlc3RDYWNoZSgpOwogICAgfQogICAgLyoqCiAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBieSBgcmVjb3JkLnNhdmVgLCBhbmQgZ2V0cyBwYXNzZWQgYQogICAgICByZXNvbHZlciBmb3IgdGhlIHByb21pc2UgdGhhdCBgcmVjb3JkLnNhdmVgIHJldHVybnMuCiAgICAgICBJdCBzY2hlZHVsZXMgc2F2aW5nIHRvIGhhcHBlbiBhdCB0aGUgZW5kIG9mIHRoZSBydW4gbG9vcC4KICAgICovCgoKICAgIHZhciBfcHJvdG8gPSBGZXRjaE1hbmFnZXIucHJvdG90eXBlOwoKICAgIF9wcm90by5zY2hlZHVsZVNhdmUgPSBmdW5jdGlvbiBzY2hlZHVsZVNhdmUoaWRlbnRpZmllciwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICB2YXIgcHJvbWlzZUxhYmVsID0gJ0RTOiBNb2RlbCNzYXZlICcgKyB0aGlzOwogICAgICB2YXIgcmVzb2x2ZXIgPSBFbWJlci5SU1ZQLmRlZmVyKHByb21pc2VMYWJlbCk7CiAgICAgIHZhciBxdWVyeSA9IHsKICAgICAgICBvcDogJ3NhdmVSZWNvcmQnLAogICAgICAgIHJlY29yZElkZW50aWZpZXI6IGlkZW50aWZpZXIsCiAgICAgICAgb3B0aW9uczogb3B0aW9ucwogICAgICB9OwogICAgICB2YXIgcXVlcnlSZXF1ZXN0ID0gewogICAgICAgIGRhdGE6IFtxdWVyeV0KICAgICAgfTsKICAgICAgdmFyIHNuYXBzaG90ID0gbmV3IFNuYXBzaG90KG9wdGlvbnMsIGlkZW50aWZpZXIsIHRoaXMuX3N0b3JlKTsKICAgICAgdmFyIHBlbmRpbmdTYXZlSXRlbSA9IHsKICAgICAgICBzbmFwc2hvdDogc25hcHNob3QsCiAgICAgICAgcmVzb2x2ZXI6IHJlc29sdmVyLAogICAgICAgIGlkZW50aWZpZXI6IGlkZW50aWZpZXIsCiAgICAgICAgb3B0aW9uczogb3B0aW9ucywKICAgICAgICBxdWVyeVJlcXVlc3Q6IHF1ZXJ5UmVxdWVzdAogICAgICB9OwoKICAgICAgdGhpcy5fcGVuZGluZ1NhdmUucHVzaChwZW5kaW5nU2F2ZUl0ZW0pOwoKICAgICAgZW1iZXJSdW4uc2NoZWR1bGVPbmNlKCdhY3Rpb25zJywgdGhpcywgdGhpcy5fZmx1c2hQZW5kaW5nU2F2ZXMpOwogICAgICB0aGlzLnJlcXVlc3RDYWNoZS5lbnF1ZXVlKHJlc29sdmVyLnByb21pc2UsIHBlbmRpbmdTYXZlSXRlbS5xdWVyeVJlcXVlc3QpOwogICAgICByZXR1cm4gcmVzb2x2ZXIucHJvbWlzZTsKICAgIH07CgogICAgX3Byb3RvLl9mbHVzaFBlbmRpbmdTYXZlID0gZnVuY3Rpb24gX2ZsdXNoUGVuZGluZ1NhdmUocGVuZGluZykgewogICAgICB2YXIgc25hcHNob3QgPSBwZW5kaW5nLnNuYXBzaG90LAogICAgICAgICAgcmVzb2x2ZXIgPSBwZW5kaW5nLnJlc29sdmVyLAogICAgICAgICAgaWRlbnRpZmllciA9IHBlbmRpbmcuaWRlbnRpZmllciwKICAgICAgICAgIG9wdGlvbnMgPSBwZW5kaW5nLm9wdGlvbnM7CgogICAgICB2YXIgYWRhcHRlciA9IHRoaXMuX3N0b3JlLmFkYXB0ZXJGb3IoaWRlbnRpZmllci50eXBlKTsKCiAgICAgIHZhciBvcGVyYXRpb24gPSBvcHRpb25zW1NhdmVPcF07CiAgICAgIHZhciBpbnRlcm5hbE1vZGVsID0gc25hcHNob3QuX2ludGVybmFsTW9kZWw7CiAgICAgIHZhciBtb2RlbE5hbWUgPSBzbmFwc2hvdC5tb2RlbE5hbWU7CiAgICAgIHZhciBzdG9yZSA9IHRoaXMuX3N0b3JlOwogICAgICB2YXIgbW9kZWxDbGFzcyA9IHN0b3JlLm1vZGVsRm9yKG1vZGVsTmFtZSk7CiAgICAgIHZhciBwcm9taXNlID0gRW1iZXIuUlNWUC5Qcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gYWRhcHRlcltvcGVyYXRpb25dKHN0b3JlLCBtb2RlbENsYXNzLCBzbmFwc2hvdCk7CiAgICAgIH0pOwogICAgICB2YXIgc2VyaWFsaXplciA9IHN0b3JlLnNlcmlhbGl6ZXJGb3IobW9kZWxOYW1lKTsKICAgICAgdmFyIGxhYmVsID0gIkRTOiBFeHRyYWN0IGFuZCBub3RpZnkgYWJvdXQgIiArIG9wZXJhdGlvbiArICIgY29tcGxldGlvbiBvZiAiICsgaW50ZXJuYWxNb2RlbDsKICAgICAgcHJvbWlzZSA9IGd1YXJkRGVzdHJveWVkU3RvcmUocHJvbWlzZSwgc3RvcmUsIGxhYmVsKTsKICAgICAgcHJvbWlzZSA9IF9ndWFyZChwcm9taXNlLCBfYmluZChfb2JqZWN0SXNBbGl2ZSwgaW50ZXJuYWxNb2RlbCkpOwogICAgICBwcm9taXNlID0gcHJvbWlzZS50aGVuKGZ1bmN0aW9uIChhZGFwdGVyUGF5bG9hZCkgewogICAgICAgIGlmIChhZGFwdGVyUGF5bG9hZCkgewogICAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZVJlc3BvbnNlSGVscGVyKHNlcmlhbGl6ZXIsIHN0b3JlLCBtb2RlbENsYXNzLCBhZGFwdGVyUGF5bG9hZCwgc25hcHNob3QuaWQsIG9wZXJhdGlvbik7CiAgICAgICAgfQogICAgICB9LCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICBpZiAoZXJyb3IgJiYgZXJyb3IuaXNBZGFwdGVyRXJyb3IgPT09IHRydWUgJiYgZXJyb3IuY29kZSA9PT0gJ0ludmFsaWRFcnJvcicpIHsKICAgICAgICAgIHZhciBwYXJzZWRFcnJvcnMgPSBlcnJvci5lcnJvcnM7CgogICAgICAgICAgaWYgKHR5cGVvZiBzZXJpYWxpemVyLmV4dHJhY3RFcnJvcnMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgcGFyc2VkRXJyb3JzID0gc2VyaWFsaXplci5leHRyYWN0RXJyb3JzKHN0b3JlLCBtb2RlbENsYXNzLCBlcnJvciwgc25hcHNob3QuaWQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGFyc2VkRXJyb3JzID0gZXJyb3JzQXJyYXlUb0hhc2goZXJyb3IuZXJyb3JzKTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aHJvdyB7CiAgICAgICAgICAgIGVycm9yOiBlcnJvciwKICAgICAgICAgICAgcGFyc2VkRXJyb3JzOiBwYXJzZWRFcnJvcnMKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IHsKICAgICAgICAgICAgZXJyb3I6IGVycm9yCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSwgbGFiZWwpOwogICAgICByZXNvbHZlci5yZXNvbHZlKHByb21pc2UpOwogICAgfQogICAgLyoqCiAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBhdCB0aGUgZW5kIG9mIHRoZSBydW4gbG9vcCwgYW5kCiAgICAgIGZsdXNoZXMgYW55IHJlY29yZHMgcGFzc2VkIGludG8gYHNjaGVkdWxlU2F2ZWAKICAgICAgIEBtZXRob2QgZmx1c2hQZW5kaW5nU2F2ZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uX2ZsdXNoUGVuZGluZ1NhdmVzID0gZnVuY3Rpb24gX2ZsdXNoUGVuZGluZ1NhdmVzKCkgewogICAgICB2YXIgcGVuZGluZyA9IHRoaXMuX3BlbmRpbmdTYXZlLnNsaWNlKCk7CgogICAgICB0aGlzLl9wZW5kaW5nU2F2ZSA9IFtdOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBwZW5kaW5nLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgIHZhciBwZW5kaW5nSXRlbSA9IHBlbmRpbmdbaV07CgogICAgICAgIHRoaXMuX2ZsdXNoUGVuZGluZ1NhdmUocGVuZGluZ0l0ZW0pOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5zY2hlZHVsZUZldGNoID0gZnVuY3Rpb24gc2NoZWR1bGVGZXRjaChpZGVudGlmaWVyLCBvcHRpb25zLCBzaG91bGRUcmFjZSkgewogICAgICAvLyBUT0RPIFByb2JhYmx5IHRoZSBzdG9yZSBzaG91bGQgcGFzcyBpbiB0aGUgcXVlcnkgb2JqZWN0CiAgICAgIHZhciBxdWVyeSA9IHsKICAgICAgICBvcDogJ2ZpbmRSZWNvcmQnLAogICAgICAgIHJlY29yZElkZW50aWZpZXI6IGlkZW50aWZpZXIsCiAgICAgICAgb3B0aW9uczogb3B0aW9ucwogICAgICB9OwogICAgICB2YXIgcXVlcnlSZXF1ZXN0ID0gewogICAgICAgIGRhdGE6IFtxdWVyeV0KICAgICAgfTsKCiAgICAgIHZhciBwZW5kaW5nRmV0Y2hlcyA9IHRoaXMuX3BlbmRpbmdGZXRjaC5nZXQoaWRlbnRpZmllci50eXBlKTsgLy8gV2UgYWxyZWFkeSBoYXZlIGEgcGVuZGluZyBmZXRjaCBmb3IgdGhpcwoKCiAgICAgIGlmIChwZW5kaW5nRmV0Y2hlcykgewogICAgICAgIHZhciBtYXRjaGluZ1BlbmRpbmdGZXRjaCA9IHBlbmRpbmdGZXRjaGVzLmZpbmQoZnVuY3Rpb24gKGZldGNoKSB7CiAgICAgICAgICByZXR1cm4gZmV0Y2guaWRlbnRpZmllci5pZCA9PT0gaWRlbnRpZmllci5pZDsKICAgICAgICB9KTsKCiAgICAgICAgaWYgKG1hdGNoaW5nUGVuZGluZ0ZldGNoKSB7CiAgICAgICAgICByZXR1cm4gbWF0Y2hpbmdQZW5kaW5nRmV0Y2gucmVzb2x2ZXIucHJvbWlzZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBpZCA9IGlkZW50aWZpZXIuaWQ7CiAgICAgIHZhciBtb2RlbE5hbWUgPSBpZGVudGlmaWVyLnR5cGU7CiAgICAgIHZhciByZXNvbHZlciA9IEVtYmVyLlJTVlAuZGVmZXIoIkZldGNoaW5nICIgKyBtb2RlbE5hbWUgKyAiJyB3aXRoIGlkOiAiICsgaWQpOwogICAgICB2YXIgcGVuZGluZ0ZldGNoSXRlbSA9IHsKICAgICAgICBpZGVudGlmaWVyOiBpZGVudGlmaWVyLAogICAgICAgIHJlc29sdmVyOiByZXNvbHZlciwKICAgICAgICBvcHRpb25zOiBvcHRpb25zLAogICAgICAgIHF1ZXJ5UmVxdWVzdDogcXVlcnlSZXF1ZXN0CiAgICAgIH07CgogICAgICB2YXIgcHJvbWlzZSA9IHJlc29sdmVyLnByb21pc2U7CgogICAgICBpZiAodGhpcy5fcGVuZGluZ0ZldGNoLnNpemUgPT09IDApIHsKICAgICAgICBlbWJlclJ1bi5zY2hlZHVsZSgnYWN0aW9ucycsIHRoaXMsIHRoaXMuZmx1c2hBbGxQZW5kaW5nRmV0Y2hlcyk7CiAgICAgIH0KCiAgICAgIHZhciBmZXRjaGVzID0gdGhpcy5fcGVuZGluZ0ZldGNoOwoKICAgICAgaWYgKCFmZXRjaGVzLmhhcyhtb2RlbE5hbWUpKSB7CiAgICAgICAgZmV0Y2hlcy5zZXQobW9kZWxOYW1lLCBbXSk7CiAgICAgIH0KCiAgICAgIGZldGNoZXMuZ2V0KG1vZGVsTmFtZSkucHVzaChwZW5kaW5nRmV0Y2hJdGVtKTsKICAgICAgdGhpcy5yZXF1ZXN0Q2FjaGUuZW5xdWV1ZShwcm9taXNlLCBwZW5kaW5nRmV0Y2hJdGVtLnF1ZXJ5UmVxdWVzdCk7CiAgICAgIHJldHVybiBwcm9taXNlOwogICAgfTsKCiAgICBfcHJvdG8uX2ZldGNoUmVjb3JkID0gZnVuY3Rpb24gX2ZldGNoUmVjb3JkKGZldGNoSXRlbSkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIGlkZW50aWZpZXIgPSBmZXRjaEl0ZW0uaWRlbnRpZmllcjsKICAgICAgdmFyIG1vZGVsTmFtZSA9IGlkZW50aWZpZXIudHlwZTsKCiAgICAgIHZhciBhZGFwdGVyID0gdGhpcy5fc3RvcmUuYWRhcHRlckZvcihtb2RlbE5hbWUpOwogICAgICB2YXIgc25hcHNob3QgPSBuZXcgU25hcHNob3QoZmV0Y2hJdGVtLm9wdGlvbnMsIGlkZW50aWZpZXIsIHRoaXMuX3N0b3JlKTsKCiAgICAgIHZhciBrbGFzcyA9IHRoaXMuX3N0b3JlLm1vZGVsRm9yKGlkZW50aWZpZXIudHlwZSk7CgogICAgICB2YXIgcHJvbWlzZSA9IEVtYmVyLlJTVlAuUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGFkYXB0ZXIuZmluZFJlY29yZChfdGhpcy5fc3RvcmUsIGtsYXNzLCBpZGVudGlmaWVyLmlkLCBzbmFwc2hvdCk7CiAgICAgIH0pOwogICAgICB2YXIgaWQgPSBpZGVudGlmaWVyLmlkOwogICAgICB2YXIgbGFiZWwgPSAiRFM6IEhhbmRsZSBBZGFwdGVyI2ZpbmRSZWNvcmQgb2YgJyIgKyBtb2RlbE5hbWUgKyAiJyB3aXRoIGlkOiAnIiArIGlkICsgIiciOwogICAgICBwcm9taXNlID0gZ3VhcmREZXN0cm95ZWRTdG9yZShwcm9taXNlLCB0aGlzLl9zdG9yZSwgbGFiZWwpOwogICAgICBwcm9taXNlID0gcHJvbWlzZS50aGVuKGZ1bmN0aW9uIChhZGFwdGVyUGF5bG9hZCkgewoKICAgICAgICB2YXIgc2VyaWFsaXplciA9IF90aGlzLl9zdG9yZS5zZXJpYWxpemVyRm9yKG1vZGVsTmFtZSk7CgogICAgICAgIHZhciBwYXlsb2FkID0gbm9ybWFsaXplUmVzcG9uc2VIZWxwZXIoc2VyaWFsaXplciwgX3RoaXMuX3N0b3JlLCBrbGFzcywgYWRhcHRlclBheWxvYWQsIGlkLCAnZmluZFJlY29yZCcpOwogICAgICAgIHJldHVybiBwYXlsb2FkOwogICAgICB9LCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfSwgIkRTOiBFeHRyYWN0IHBheWxvYWQgb2YgJyIgKyBtb2RlbE5hbWUgKyAiJyIpOwogICAgICBmZXRjaEl0ZW0ucmVzb2x2ZXIucmVzb2x2ZShwcm9taXNlKTsKICAgIH0gLy8gVE9ETyBzaG91bGQgcHJvYmFibHkgcmVmYWN0b3IgZXhwZWN0ZWRTbmFwc2hvdHMgdG8gYmUgaWRlbnRpZmllcnMKICAgIDsKCiAgICBfcHJvdG8uaGFuZGxlRm91bmRSZWNvcmRzID0gZnVuY3Rpb24gaGFuZGxlRm91bmRSZWNvcmRzKHNlZWtpbmcsIGNvYWxlc2NlZFBheWxvYWQsIGV4cGVjdGVkU25hcHNob3RzKSB7CiAgICAgIC8vIHJlc29sdmUgZm91bmQgcmVjb3JkcwogICAgICB2YXIgZm91bmQgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB2YXIgcGF5bG9hZHMgPSBjb2FsZXNjZWRQYXlsb2FkLmRhdGE7CiAgICAgIHZhciBjb2FsZXNjZWRJbmNsdWRlZCA9IGNvYWxlc2NlZFBheWxvYWQuaW5jbHVkZWQgfHwgW107CgogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHBheWxvYWRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHZhciBwYXlsb2FkID0gcGF5bG9hZHNbaV07CiAgICAgICAgdmFyIHBhaXIgPSBzZWVraW5nW3BheWxvYWQuaWRdOwogICAgICAgIGZvdW5kW3BheWxvYWQuaWRdID0gcGF5bG9hZDsKICAgICAgICB2YXIgaW5jbHVkZWQgPSBjb2FsZXNjZWRJbmNsdWRlZC5jb25jYXQocGF5bG9hZHMpOyAvLyBUT0RPIHJlbW92ZSBvcmlnaW5hbCBkYXRhIGZyb20gaW5jbHVkZWQKCiAgICAgICAgaWYgKHBhaXIpIHsKICAgICAgICAgIHZhciByZXNvbHZlciA9IHBhaXIucmVzb2x2ZXI7CiAgICAgICAgICByZXNvbHZlci5yZXNvbHZlKHsKICAgICAgICAgICAgZGF0YTogcGF5bG9hZCwKICAgICAgICAgICAgaW5jbHVkZWQ6IGluY2x1ZGVkCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gLy8gcmVqZWN0IG1pc3NpbmcgcmVjb3JkcwogICAgICAvLyBUT0RPIE5PVyBjbGVhbiB0aGlzIHVwIHRvIHJlZmVyIHRvIHBheWxvYWRzCgoKICAgICAgdmFyIG1pc3NpbmdTbmFwc2hvdHMgPSBbXTsKCiAgICAgIGZvciAodmFyIF9pID0gMCwgX2wgPSBleHBlY3RlZFNuYXBzaG90cy5sZW5ndGg7IF9pIDwgX2w7IF9pKyspIHsKICAgICAgICB2YXIgc25hcHNob3QgPSBleHBlY3RlZFNuYXBzaG90c1tfaV07CgogICAgICAgIGlmICghZm91bmRbc25hcHNob3QuaWRdKSB7CiAgICAgICAgICBtaXNzaW5nU25hcHNob3RzLnB1c2goc25hcHNob3QpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKG1pc3NpbmdTbmFwc2hvdHMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5yZWplY3RGZXRjaGVkSXRlbXMoc2Vla2luZywgbWlzc2luZ1NuYXBzaG90cyk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLnJlamVjdEZldGNoZWRJdGVtcyA9IGZ1bmN0aW9uIHJlamVjdEZldGNoZWRJdGVtcyhzZWVraW5nLCBzbmFwc2hvdHMsIGVycm9yKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gc25hcHNob3RzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHZhciBpZGVudGlmaWVyID0gc25hcHNob3RzW2ldOwogICAgICAgIHZhciBwYWlyID0gc2Vla2luZ1tpZGVudGlmaWVyLmlkXTsKCiAgICAgICAgaWYgKHBhaXIpIHsKICAgICAgICAgIHBhaXIucmVzb2x2ZXIucmVqZWN0KGVycm9yIHx8IG5ldyBFcnJvcigiRXhwZWN0ZWQ6ICc8IiArIGlkZW50aWZpZXIubW9kZWxOYW1lICsgIjoiICsgaWRlbnRpZmllci5pZCArICI+JyB0byBiZSBwcmVzZW50IGluIHRoZSBhZGFwdGVyIHByb3ZpZGVkIHBheWxvYWQsIGJ1dCBpdCB3YXMgbm90IGZvdW5kLiIpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLl9maW5kTWFueSA9IGZ1bmN0aW9uIF9maW5kTWFueShhZGFwdGVyLCBzdG9yZSwgbW9kZWxOYW1lLCBzbmFwc2hvdHMsIGlkZW50aWZpZXJzLCBvcHRpb25zTWFwKSB7CiAgICAgIHZhciBtb2RlbENsYXNzID0gc3RvcmUubW9kZWxGb3IobW9kZWxOYW1lKTsgLy8gYGFkYXB0ZXIuZmluZE1hbnlgIGdldHMgdGhlIG1vZGVsQ2xhc3Mgc3RpbGwKCiAgICAgIHZhciBpZHMgPSBzbmFwc2hvdHMubWFwKGZ1bmN0aW9uIChzKSB7CiAgICAgICAgcmV0dXJuIHMuaWQ7CiAgICAgIH0pOwogICAgICB2YXIgcHJvbWlzZSA9IGFkYXB0ZXIuZmluZE1hbnkoc3RvcmUsIG1vZGVsQ2xhc3MsIGlkcywgRW1iZXIuQShzbmFwc2hvdHMpKTsKICAgICAgdmFyIGxhYmVsID0gIkRTOiBIYW5kbGUgQWRhcHRlciNmaW5kTWFueSBvZiAnIiArIG1vZGVsTmFtZSArICInIjsKCiAgICAgIGlmIChwcm9taXNlID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2FkYXB0ZXIuZmluZE1hbnkgcmV0dXJuZWQgdW5kZWZpbmVkLCB0aGlzIHdhcyB2ZXJ5IGxpa2VseSBhIG1pc3Rha2UnKTsKICAgICAgfQoKICAgICAgcHJvbWlzZSA9IGd1YXJkRGVzdHJveWVkU3RvcmUocHJvbWlzZSwgc3RvcmUsIGxhYmVsKTsKICAgICAgcmV0dXJuIHByb21pc2UudGhlbihmdW5jdGlvbiAoYWRhcHRlclBheWxvYWQpIHsKICAgICAgICB2YXIgc2VyaWFsaXplciA9IHN0b3JlLnNlcmlhbGl6ZXJGb3IobW9kZWxOYW1lKTsKICAgICAgICB2YXIgcGF5bG9hZCA9IG5vcm1hbGl6ZVJlc3BvbnNlSGVscGVyKHNlcmlhbGl6ZXIsIHN0b3JlLCBtb2RlbENsYXNzLCBhZGFwdGVyUGF5bG9hZCwgbnVsbCwgJ2ZpbmRNYW55Jyk7CiAgICAgICAgcmV0dXJuIHBheWxvYWQ7CiAgICAgIH0sIG51bGwsICJEUzogRXh0cmFjdCBwYXlsb2FkIG9mICIgKyBtb2RlbE5hbWUpOwogICAgfTsKCiAgICBfcHJvdG8uX3Byb2Nlc3NDb2FsZXNjZWRHcm91cCA9IGZ1bmN0aW9uIF9wcm9jZXNzQ29hbGVzY2VkR3JvdXAoc2Vla2luZywgZ3JvdXAsIGFkYXB0ZXIsIG9wdGlvbnNNYXAsIG1vZGVsTmFtZSkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIC8vVE9ETyBjaGVjayB3aGF0IGhhcHBlbmVkIHdpdGggaWRlbnRpZmllcnMgaGVyZQogICAgICB2YXIgdG90YWxJbkdyb3VwID0gZ3JvdXAubGVuZ3RoOwogICAgICB2YXIgaWRzID0gbmV3IEFycmF5KHRvdGFsSW5Hcm91cCk7CiAgICAgIHZhciBncm91cGVkU25hcHNob3RzID0gbmV3IEFycmF5KHRvdGFsSW5Hcm91cCk7CgogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRvdGFsSW5Hcm91cDsgaisrKSB7CiAgICAgICAgZ3JvdXBlZFNuYXBzaG90c1tqXSA9IGdyb3VwW2pdOwogICAgICAgIGlkc1tqXSA9IGdyb3VwZWRTbmFwc2hvdHNbal0uaWQ7CiAgICAgIH0KCiAgICAgIHZhciBzdG9yZSA9IHRoaXMuX3N0b3JlOwoKICAgICAgaWYgKHRvdGFsSW5Hcm91cCA+IDEpIHsKICAgICAgICB0aGlzLl9maW5kTWFueShhZGFwdGVyLCBzdG9yZSwgbW9kZWxOYW1lLCBncm91cCwgZ3JvdXBlZFNuYXBzaG90cywgb3B0aW9uc01hcCkudGhlbihmdW5jdGlvbiAocGF5bG9hZHMpIHsKICAgICAgICAgIF90aGlzMi5oYW5kbGVGb3VuZFJlY29yZHMoc2Vla2luZywgcGF5bG9hZHMsIGdyb3VwZWRTbmFwc2hvdHMpOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgX3RoaXMyLnJlamVjdEZldGNoZWRJdGVtcyhzZWVraW5nLCBncm91cGVkU25hcHNob3RzLCBlcnJvcik7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAoaWRzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHZhciBwYWlyID0gc2Vla2luZ1tncm91cGVkU25hcHNob3RzWzBdLmlkXTsKCiAgICAgICAgdGhpcy5fZmV0Y2hSZWNvcmQocGFpcik7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLl9mbHVzaFBlbmRpbmdGZXRjaEZvclR5cGUgPSBmdW5jdGlvbiBfZmx1c2hQZW5kaW5nRmV0Y2hGb3JUeXBlKHBlbmRpbmdGZXRjaEl0ZW1zLCBtb2RlbE5hbWUpIHsKICAgICAgdmFyIGFkYXB0ZXIgPSB0aGlzLl9zdG9yZS5hZGFwdGVyRm9yKG1vZGVsTmFtZSk7CgogICAgICB2YXIgc2hvdWxkQ29hbGVzY2UgPSAhIWFkYXB0ZXIuZmluZE1hbnkgJiYgYWRhcHRlci5jb2FsZXNjZUZpbmRSZXF1ZXN0czsKICAgICAgdmFyIHRvdGFsSXRlbXMgPSBwZW5kaW5nRmV0Y2hJdGVtcy5sZW5ndGg7CiAgICAgIHZhciBpZGVudGlmaWVycyA9IG5ldyBBcnJheSh0b3RhbEl0ZW1zKTsKICAgICAgdmFyIHNlZWtpbmcgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB2YXIgb3B0aW9uc01hcCA9IG5ldyBXZWFrTWFwKCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRvdGFsSXRlbXM7IGkrKykgewogICAgICAgIHZhciBwZW5kaW5nSXRlbSA9IHBlbmRpbmdGZXRjaEl0ZW1zW2ldOwogICAgICAgIHZhciBpZGVudGlmaWVyID0gcGVuZGluZ0l0ZW0uaWRlbnRpZmllcjsKICAgICAgICBpZGVudGlmaWVyc1tpXSA9IGlkZW50aWZpZXI7CiAgICAgICAgb3B0aW9uc01hcC5zZXQoaWRlbnRpZmllciwgcGVuZGluZ0l0ZW0ub3B0aW9ucyk7CiAgICAgICAgc2Vla2luZ1tpZGVudGlmaWVyLmlkXSA9IHBlbmRpbmdJdGVtOwogICAgICB9CgogICAgICBpZiAoc2hvdWxkQ29hbGVzY2UpIHsKICAgICAgICAvLyBUT0RPOiBJbXByb3ZlIHJlY29yZHMgPT4gc25hcHNob3RzID0+IHJlY29yZHMgPT4gc25hcHNob3RzCiAgICAgICAgLy8KICAgICAgICAvLyBXZSB3YW50IHRvIHByb3ZpZGUgcmVjb3JkcyB0byBhbGwgc3RvcmUgbWV0aG9kcyBhbmQgc25hcHNob3RzIHRvIGFsbAogICAgICAgIC8vIGFkYXB0ZXIgbWV0aG9kcy4gVG8gbWFrZSBzdXJlIHdlJ3JlIGRvaW5nIHRoYXQgd2UncmUgcHJvdmlkaW5nIGFuIGFycmF5CiAgICAgICAgLy8gb2Ygc25hcHNob3RzIHRvIGFkYXB0ZXIuZ3JvdXBSZWNvcmRzRm9yRmluZE1hbnkoKSwgd2hpY2ggaW4gdHVybiB3aWxsCiAgICAgICAgLy8gcmV0dXJuIGdyb3VwZWQgc25hcHNob3RzIGluc3RlYWQgb2YgZ3JvdXBlZCByZWNvcmRzLgogICAgICAgIC8vCiAgICAgICAgLy8gQnV0IHNpbmNlIHRoZSBfZmluZE1hbnkoKSBmaW5kZXIgaXMgYSBzdG9yZSBtZXRob2Qgd2UgbmVlZCB0byBnZXQgdGhlCiAgICAgICAgLy8gcmVjb3JkcyBmcm9tIHRoZSBncm91cGVkIHNuYXBzaG90cyBldmVuIHRob3VnaCB0aGUgX2ZpbmRNYW55KCkgZmluZGVyCiAgICAgICAgLy8gd2lsbCBvbmNlIGFnYWluIGNvbnZlcnQgdGhlIHJlY29yZHMgdG8gc25hcHNob3RzIGZvciBhZGFwdGVyLmZpbmRNYW55KCkKICAgICAgICB2YXIgc25hcHNob3RzID0gbmV3IEFycmF5KHRvdGFsSXRlbXMpOwoKICAgICAgICBmb3IgKHZhciBfaTIgPSAwOyBfaTIgPCB0b3RhbEl0ZW1zOyBfaTIrKykgewogICAgICAgICAgdmFyIG9wdGlvbnMgPSBvcHRpb25zTWFwLmdldChpZGVudGlmaWVyc1tfaTJdKTsKICAgICAgICAgIHNuYXBzaG90c1tfaTJdID0gbmV3IFNuYXBzaG90KG9wdGlvbnMsIGlkZW50aWZpZXJzW19pMl0sIHRoaXMuX3N0b3JlKTsKICAgICAgICB9CgogICAgICAgIHZhciBncm91cHMgPSBhZGFwdGVyLmdyb3VwUmVjb3Jkc0ZvckZpbmRNYW55KHRoaXMsIHNuYXBzaG90cyk7CgogICAgICAgIGZvciAodmFyIF9pMyA9IDAsIGwgPSBncm91cHMubGVuZ3RoOyBfaTMgPCBsOyBfaTMrKykgewogICAgICAgICAgdGhpcy5fcHJvY2Vzc0NvYWxlc2NlZEdyb3VwKHNlZWtpbmcsIGdyb3Vwc1tfaTNdLCBhZGFwdGVyLCBvcHRpb25zTWFwLCBtb2RlbE5hbWUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKHZhciBfaTQgPSAwOyBfaTQgPCB0b3RhbEl0ZW1zOyBfaTQrKykgewogICAgICAgICAgdGhpcy5fZmV0Y2hSZWNvcmQocGVuZGluZ0ZldGNoSXRlbXNbX2k0XSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5mbHVzaEFsbFBlbmRpbmdGZXRjaGVzID0gZnVuY3Rpb24gZmx1c2hBbGxQZW5kaW5nRmV0Y2hlcygpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuX3BlbmRpbmdGZXRjaC5mb3JFYWNoKHRoaXMuX2ZsdXNoUGVuZGluZ0ZldGNoRm9yVHlwZSwgdGhpcyk7CgogICAgICB0aGlzLl9wZW5kaW5nRmV0Y2guY2xlYXIoKTsKICAgIH07CgogICAgX3Byb3RvLmRlc3Ryb3kgPSBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICB0aGlzLmlzRGVzdHJveWVkID0gdHJ1ZTsKICAgIH07CgogICAgcmV0dXJuIEZldGNoTWFuYWdlcjsKICB9KCk7CgogIGZ1bmN0aW9uIF9maW5kKGFkYXB0ZXIsIHN0b3JlLCBtb2RlbENsYXNzLCBpZCwgaW50ZXJuYWxNb2RlbCwgb3B0aW9ucykgewoKICAgIHZhciBzbmFwc2hvdCA9IGludGVybmFsTW9kZWwuY3JlYXRlU25hcHNob3Qob3B0aW9ucyk7CiAgICB2YXIgbW9kZWxOYW1lID0gaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWU7CiAgICB2YXIgcHJvbWlzZSA9IEVtYmVyLlJTVlAuUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBhZGFwdGVyLmZpbmRSZWNvcmQoc3RvcmUsIG1vZGVsQ2xhc3MsIGlkLCBzbmFwc2hvdCk7CiAgICB9KTsKICAgIHZhciBsYWJlbCA9ICJEUzogSGFuZGxlIEFkYXB0ZXIjZmluZFJlY29yZCBvZiAnIiArIG1vZGVsTmFtZSArICInIHdpdGggaWQ6ICciICsgaWQgKyAiJyI7CiAgICB2YXIgaWRlbnRpZmllciA9IGludGVybmFsTW9kZWwuaWRlbnRpZmllcjsKICAgIHByb21pc2UgPSBndWFyZERlc3Ryb3llZFN0b3JlKHByb21pc2UsIHN0b3JlLCBsYWJlbCk7CiAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uIChhZGFwdGVyUGF5bG9hZCkgewogICAgICB2YXIgc2VyaWFsaXplciA9IHN0b3JlLnNlcmlhbGl6ZXJGb3IobW9kZWxOYW1lKTsKICAgICAgdmFyIHBheWxvYWQgPSBub3JtYWxpemVSZXNwb25zZUhlbHBlcihzZXJpYWxpemVyLCBzdG9yZSwgbW9kZWxDbGFzcywgYWRhcHRlclBheWxvYWQsIGlkLCAnZmluZFJlY29yZCcpOwoKICAgICAgewogICAgICAgIC8vIGVuc3VyZSB0aGF0IHJlZ2FyZGxlc3Mgb2YgaWQgcmV0dXJuZWQgd2UgYXNzaWduIHRvIHRoZSBjb3JyZWN0IHJlY29yZAogICAgICAgIHBheWxvYWQuZGF0YS5saWQgPSBpZGVudGlmaWVyLmxpZDsKICAgICAgfQoKICAgICAgcmV0dXJuIHN0b3JlLl9wdXNoKHBheWxvYWQpOwogICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgIGludGVybmFsTW9kZWwubm90Rm91bmQoKTsKCiAgICAgIGlmIChpbnRlcm5hbE1vZGVsLmlzRW1wdHkoKSkgewogICAgICAgIGludGVybmFsTW9kZWwudW5sb2FkUmVjb3JkKCk7CiAgICAgIH0KCiAgICAgIHRocm93IGVycm9yOwogICAgfSwgIkRTOiBFeHRyYWN0IHBheWxvYWQgb2YgJyIgKyBtb2RlbE5hbWUgKyAiJyIpOwogIH0KICBmdW5jdGlvbiBfZmluZE1hbnkoYWRhcHRlciwgc3RvcmUsIG1vZGVsTmFtZSwgaWRzLCBpbnRlcm5hbE1vZGVscywgb3B0aW9uc01hcCkgewogICAgdmFyIHNuYXBzaG90cyA9IEVtYmVyLkEoaW50ZXJuYWxNb2RlbHMubWFwKGZ1bmN0aW9uIChpbnRlcm5hbE1vZGVsKSB7CiAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsLmNyZWF0ZVNuYXBzaG90KG9wdGlvbnNNYXAuZ2V0KGludGVybmFsTW9kZWwpKTsKICAgIH0pKTsKICAgIHZhciBtb2RlbENsYXNzID0gc3RvcmUubW9kZWxGb3IobW9kZWxOYW1lKTsgLy8gYGFkYXB0ZXIuZmluZE1hbnlgIGdldHMgdGhlIG1vZGVsQ2xhc3Mgc3RpbGwKCiAgICB2YXIgcHJvbWlzZSA9IGFkYXB0ZXIuZmluZE1hbnkoc3RvcmUsIG1vZGVsQ2xhc3MsIGlkcywgc25hcHNob3RzKTsKICAgIHZhciBsYWJlbCA9ICJEUzogSGFuZGxlIEFkYXB0ZXIjZmluZE1hbnkgb2YgJyIgKyBtb2RlbE5hbWUgKyAiJyI7CgogICAgaWYgKHByb21pc2UgPT09IHVuZGVmaW5lZCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2FkYXB0ZXIuZmluZE1hbnkgcmV0dXJuZWQgdW5kZWZpbmVkLCB0aGlzIHdhcyB2ZXJ5IGxpa2VseSBhIG1pc3Rha2UnKTsKICAgIH0KCiAgICBwcm9taXNlID0gZ3VhcmREZXN0cm95ZWRTdG9yZShwcm9taXNlLCBzdG9yZSwgbGFiZWwpOwogICAgcmV0dXJuIHByb21pc2UudGhlbihmdW5jdGlvbiAoYWRhcHRlclBheWxvYWQpIHsKICAgICAgdmFyIHNlcmlhbGl6ZXIgPSBzdG9yZS5zZXJpYWxpemVyRm9yKG1vZGVsTmFtZSk7CiAgICAgIHZhciBwYXlsb2FkID0gbm9ybWFsaXplUmVzcG9uc2VIZWxwZXIoc2VyaWFsaXplciwgc3RvcmUsIG1vZGVsQ2xhc3MsIGFkYXB0ZXJQYXlsb2FkLCBudWxsLCAnZmluZE1hbnknKTsKICAgICAgcmV0dXJuIHN0b3JlLl9wdXNoKHBheWxvYWQpOwogICAgfSwgbnVsbCwgIkRTOiBFeHRyYWN0IHBheWxvYWQgb2YgIiArIG1vZGVsTmFtZSk7CiAgfQoKICBmdW5jdGlvbiBpdGVyYXRlRGF0YShkYXRhLCBmbikgewogICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHsKICAgICAgcmV0dXJuIGRhdGEubWFwKGZuKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmbihkYXRhKTsKICAgIH0KICB9IC8vIHN5bmMKICAvLyBpdGVyYXRlIG92ZXIgcmVjb3JkcyBpbiBwYXlsb2FkLmRhdGEKICAvLyBmb3IgZWFjaCByZWNvcmQKICAvLyAgIGFzc2VydCB0aGF0IHJlY29yZC5yZWxhdGlvbnNoaXBzW2ludmVyc2VdIGlzIGVpdGhlciB1bmRlZmluZWQgKHNvIHdlIGNhbiBmaXggaXQpCiAgLy8gICAgIG9yIHByb3ZpZGUgYSBkYXRhOiB7aWQsIHR5cGV9IHRoYXQgbWF0Y2hlcyB0aGUgcmVjb3JkIHRoYXQgcmVxdWVzdGVkIGl0CiAgLy8gICByZXR1cm4gdGhlIHJlbGF0aW9uc2hpcCBkYXRhIGZvciB0aGUgcGFyZW50CgoKICBmdW5jdGlvbiBzeW5jUmVsYXRpb25zaGlwRGF0YUZyb21MaW5rKHN0b3JlLCBwYXlsb2FkLCBwYXJlbnRJbnRlcm5hbE1vZGVsLCByZWxhdGlvbnNoaXApIHsKICAgIHZhciBfcmVsYXRpb25zaGlwczsKCiAgICAvLyBlbnN1cmUgdGhlIHJpZ2h0IGhhbmQgc2lkZSAoaW5jb21pbmcgcGF5bG9hZCkgcG9pbnRzIHRvIHRoZSBwYXJlbnQgcmVjb3JkIHRoYXQKICAgIC8vIHJlcXVlc3RlZCB0aGlzIHJlbGF0aW9uc2hpcAogICAgdmFyIHJlbGF0aW9uc2hpcERhdGEgPSBpdGVyYXRlRGF0YShwYXlsb2FkLmRhdGEsIGZ1bmN0aW9uIChkYXRhLCBpbmRleCkgewogICAgICB2YXIgaWQgPSBkYXRhLmlkLAogICAgICAgICAgdHlwZSA9IGRhdGEudHlwZTsKICAgICAgZW5zdXJlUmVsYXRpb25zaGlwSXNTZXRUb1BhcmVudChkYXRhLCBwYXJlbnRJbnRlcm5hbE1vZGVsLCBzdG9yZSwgcmVsYXRpb25zaGlwKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBpZDogaWQsCiAgICAgICAgdHlwZTogdHlwZQogICAgICB9OwogICAgfSk7IC8vIG5vdywgcHVzaCB0aGUgbGVmdCBoYW5kIHNpZGUgKHRoZSBwYXJlbnQgcmVjb3JkKSB0byBlbnN1cmUgdGhpbmdzIGFyZSBpbiBzeW5jLCBzaW5jZQogICAgLy8gdGhlIHBheWxvYWQgd2lsbCBiZSBwdXNoZWQgd2l0aCBzdG9yZS5fcHVzaAoKICAgIHZhciBwYXJlbnRQYXlsb2FkID0gewogICAgICBpZDogcGFyZW50SW50ZXJuYWxNb2RlbC5pZCwKICAgICAgdHlwZTogcGFyZW50SW50ZXJuYWxNb2RlbC5tb2RlbE5hbWUsCiAgICAgIHJlbGF0aW9uc2hpcHM6IChfcmVsYXRpb25zaGlwcyA9IHt9LCBfcmVsYXRpb25zaGlwc1tyZWxhdGlvbnNoaXAua2V5XSA9IHsKICAgICAgICBtZXRhOiBwYXlsb2FkLm1ldGEsCiAgICAgICAgbGlua3M6IHBheWxvYWQubGlua3MsCiAgICAgICAgZGF0YTogcmVsYXRpb25zaGlwRGF0YQogICAgICB9LCBfcmVsYXRpb25zaGlwcykKICAgIH07CgogICAgaWYgKCFBcnJheS5pc0FycmF5KHBheWxvYWQuaW5jbHVkZWQpKSB7CiAgICAgIHBheWxvYWQuaW5jbHVkZWQgPSBbXTsKICAgIH0KCiAgICBwYXlsb2FkLmluY2x1ZGVkLnB1c2gocGFyZW50UGF5bG9hZCk7CiAgICByZXR1cm4gcGF5bG9hZDsKICB9CgogIGZ1bmN0aW9uIGVuc3VyZVJlbGF0aW9uc2hpcElzU2V0VG9QYXJlbnQocGF5bG9hZCwgcGFyZW50SW50ZXJuYWxNb2RlbCwgc3RvcmUsIHBhcmVudFJlbGF0aW9uc2hpcCwgaW5kZXgpIHsKICAgIHZhciBpZCA9IHBheWxvYWQuaWQsCiAgICAgICAgdHlwZSA9IHBheWxvYWQudHlwZTsKCiAgICBpZiAoIXBheWxvYWQucmVsYXRpb25zaGlwcykgewogICAgICBwYXlsb2FkLnJlbGF0aW9uc2hpcHMgPSB7fTsKICAgIH0KCiAgICB2YXIgcmVsYXRpb25zaGlwcyA9IHBheWxvYWQucmVsYXRpb25zaGlwczsKICAgIHZhciBpbnZlcnNlID0gZ2V0SW52ZXJzZShzdG9yZSwgcGFyZW50SW50ZXJuYWxNb2RlbCwgcGFyZW50UmVsYXRpb25zaGlwLCB0eXBlKTsKCiAgICBpZiAoaW52ZXJzZSkgewogICAgICB2YXIgaW52ZXJzZUtleSA9IGludmVyc2UuaW52ZXJzZUtleSwKICAgICAgICAgIGtpbmQgPSBpbnZlcnNlLmtpbmQ7CiAgICAgIHZhciByZWxhdGlvbnNoaXBEYXRhID0gcmVsYXRpb25zaGlwc1tpbnZlcnNlS2V5XSAmJiByZWxhdGlvbnNoaXBzW2ludmVyc2VLZXldLmRhdGE7CgogICAgICBpZiAoa2luZCAhPT0gJ2hhc01hbnknIHx8IHR5cGVvZiByZWxhdGlvbnNoaXBEYXRhICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIHJlbGF0aW9uc2hpcHNbaW52ZXJzZUtleV0gPSByZWxhdGlvbnNoaXBzW2ludmVyc2VLZXldIHx8IHt9OwogICAgICAgIHJlbGF0aW9uc2hpcHNbaW52ZXJzZUtleV0uZGF0YSA9IGZpeFJlbGF0aW9uc2hpcERhdGEocmVsYXRpb25zaGlwRGF0YSwga2luZCwgcGFyZW50SW50ZXJuYWxNb2RlbCk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGdldEludmVyc2Uoc3RvcmUsIHBhcmVudEludGVybmFsTW9kZWwsIHBhcmVudFJlbGF0aW9uc2hpcCwgdHlwZSkgewogICAgcmV0dXJuIHJlY29yZERhdGFGaW5kSW52ZXJzZVJlbGF0aW9uc2hpcEluZm8oc3RvcmUsIHBhcmVudEludGVybmFsTW9kZWwsIHBhcmVudFJlbGF0aW9uc2hpcCwgdHlwZSk7CiAgfQoKICBmdW5jdGlvbiByZWNvcmREYXRhRmluZEludmVyc2VSZWxhdGlvbnNoaXBJbmZvKF9yZWYsIHBhcmVudEludGVybmFsTW9kZWwsIHBhcmVudFJlbGF0aW9uc2hpcCwgdHlwZSkgewogICAgdmFyIF9zdG9yZVdyYXBwZXIgPSBfcmVmLl9zdG9yZVdyYXBwZXI7CiAgICB2YXIgbGhzX3JlbGF0aW9uc2hpcE5hbWUgPSBwYXJlbnRSZWxhdGlvbnNoaXAubmFtZTsKICAgIHZhciBtb2RlbE5hbWUgPSBwYXJlbnRJbnRlcm5hbE1vZGVsLm1vZGVsTmFtZTsKCiAgICB2YXIgaW52ZXJzZUtleSA9IF9zdG9yZVdyYXBwZXIuaW52ZXJzZUZvclJlbGF0aW9uc2hpcChtb2RlbE5hbWUsIGxoc19yZWxhdGlvbnNoaXBOYW1lKTsKCiAgICBpZiAoaW52ZXJzZUtleSkgewogICAgICB2YXIga2luZCA9IF9zdG9yZVdyYXBwZXIucmVsYXRpb25zaGlwc0RlZmluaXRpb25Gb3IodHlwZSlbaW52ZXJzZUtleV0ubWV0YS5raW5kOwoKICAgICAgcmV0dXJuIHsKICAgICAgICBpbnZlcnNlS2V5OiBpbnZlcnNlS2V5LAogICAgICAgIGtpbmQ6IGtpbmQKICAgICAgfTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGZpeFJlbGF0aW9uc2hpcERhdGEocmVsYXRpb25zaGlwRGF0YSwgcmVsYXRpb25zaGlwS2luZCwgX3JlZjIpIHsKICAgIHZhciBpZCA9IF9yZWYyLmlkLAogICAgICAgIG1vZGVsTmFtZSA9IF9yZWYyLm1vZGVsTmFtZTsKICAgIHZhciBwYXJlbnRSZWxhdGlvbnNoaXBEYXRhID0gewogICAgICBpZDogaWQsCiAgICAgIHR5cGU6IG1vZGVsTmFtZQogICAgfTsKICAgIHZhciBwYXlsb2FkOwoKICAgIGlmIChyZWxhdGlvbnNoaXBLaW5kID09PSAnaGFzTWFueScpIHsKICAgICAgcGF5bG9hZCA9IHJlbGF0aW9uc2hpcERhdGEgfHwgW107CiAgICAgIHBheWxvYWQucHVzaChwYXJlbnRSZWxhdGlvbnNoaXBEYXRhKTsKICAgIH0gZWxzZSB7CiAgICAgIHBheWxvYWQgPSByZWxhdGlvbnNoaXBEYXRhIHx8IHt9OwogICAgICBFbWJlci5hc3NpZ24ocGF5bG9hZCwgcGFyZW50UmVsYXRpb25zaGlwRGF0YSk7CiAgICB9CgogICAgcmV0dXJuIHBheWxvYWQ7CiAgfQoKICBmdW5jdGlvbiBfZmluZEhhc01hbnkoYWRhcHRlciwgc3RvcmUsIGludGVybmFsTW9kZWwsIGxpbmssIHJlbGF0aW9uc2hpcCwgb3B0aW9ucykgewogICAgdmFyIHNuYXBzaG90ID0gaW50ZXJuYWxNb2RlbC5jcmVhdGVTbmFwc2hvdChvcHRpb25zKTsKICAgIHZhciBtb2RlbENsYXNzID0gc3RvcmUubW9kZWxGb3IocmVsYXRpb25zaGlwLnR5cGUpOwogICAgdmFyIHVzZUxpbmsgPSAhbGluayB8fCB0eXBlb2YgbGluayA9PT0gJ3N0cmluZyc7CiAgICB2YXIgcmVsYXRlZExpbmsgPSB1c2VMaW5rID8gbGluayA6IGxpbmsuaHJlZjsKICAgIHZhciBwcm9taXNlID0gYWRhcHRlci5maW5kSGFzTWFueShzdG9yZSwgc25hcHNob3QsIHJlbGF0ZWRMaW5rLCByZWxhdGlvbnNoaXApOwogICAgdmFyIGxhYmVsID0gIkRTOiBIYW5kbGUgQWRhcHRlciNmaW5kSGFzTWFueSBvZiAnIiArIGludGVybmFsTW9kZWwubW9kZWxOYW1lICsgIicgOiAnIiArIHJlbGF0aW9uc2hpcC50eXBlICsgIiciOwogICAgcHJvbWlzZSA9IGd1YXJkRGVzdHJveWVkU3RvcmUocHJvbWlzZSwgc3RvcmUsIGxhYmVsKTsKICAgIHByb21pc2UgPSBfZ3VhcmQocHJvbWlzZSwgX2JpbmQoX29iamVjdElzQWxpdmUsIGludGVybmFsTW9kZWwpKTsKICAgIHJldHVybiBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKGFkYXB0ZXJQYXlsb2FkKSB7CiAgICAgIHZhciBzZXJpYWxpemVyID0gc3RvcmUuc2VyaWFsaXplckZvcihyZWxhdGlvbnNoaXAudHlwZSk7CiAgICAgIHZhciBwYXlsb2FkID0gbm9ybWFsaXplUmVzcG9uc2VIZWxwZXIoc2VyaWFsaXplciwgc3RvcmUsIG1vZGVsQ2xhc3MsIGFkYXB0ZXJQYXlsb2FkLCBudWxsLCAnZmluZEhhc01hbnknKTsKICAgICAgcGF5bG9hZCA9IHN5bmNSZWxhdGlvbnNoaXBEYXRhRnJvbUxpbmsoc3RvcmUsIHBheWxvYWQsIGludGVybmFsTW9kZWwsIHJlbGF0aW9uc2hpcCk7CgogICAgICB2YXIgaW50ZXJuYWxNb2RlbEFycmF5ID0gc3RvcmUuX3B1c2gocGF5bG9hZCk7CgogICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbEFycmF5OwogICAgfSwgbnVsbCwgIkRTOiBFeHRyYWN0IHBheWxvYWQgb2YgJyIgKyBpbnRlcm5hbE1vZGVsLm1vZGVsTmFtZSArICInIDogaGFzTWFueSAnIiArIHJlbGF0aW9uc2hpcC50eXBlICsgIiciKTsKICB9CiAgZnVuY3Rpb24gX2ZpbmRCZWxvbmdzVG8oYWRhcHRlciwgc3RvcmUsIGludGVybmFsTW9kZWwsIGxpbmssIHJlbGF0aW9uc2hpcCwgb3B0aW9ucykgewogICAgdmFyIHNuYXBzaG90ID0gaW50ZXJuYWxNb2RlbC5jcmVhdGVTbmFwc2hvdChvcHRpb25zKTsKICAgIHZhciBtb2RlbENsYXNzID0gc3RvcmUubW9kZWxGb3IocmVsYXRpb25zaGlwLnR5cGUpOwogICAgdmFyIHVzZUxpbmsgPSAhbGluayB8fCB0eXBlb2YgbGluayA9PT0gJ3N0cmluZyc7CiAgICB2YXIgcmVsYXRlZExpbmsgPSB1c2VMaW5rID8gbGluayA6IGxpbmsuaHJlZjsKICAgIHZhciBwcm9taXNlID0gYWRhcHRlci5maW5kQmVsb25nc1RvKHN0b3JlLCBzbmFwc2hvdCwgcmVsYXRlZExpbmssIHJlbGF0aW9uc2hpcCk7CiAgICB2YXIgbGFiZWwgPSAiRFM6IEhhbmRsZSBBZGFwdGVyI2ZpbmRCZWxvbmdzVG8gb2YgIiArIGludGVybmFsTW9kZWwubW9kZWxOYW1lICsgIiA6ICIgKyByZWxhdGlvbnNoaXAudHlwZTsKICAgIHByb21pc2UgPSBndWFyZERlc3Ryb3llZFN0b3JlKHByb21pc2UsIHN0b3JlLCBsYWJlbCk7CiAgICBwcm9taXNlID0gX2d1YXJkKHByb21pc2UsIF9iaW5kKF9vYmplY3RJc0FsaXZlLCBpbnRlcm5hbE1vZGVsKSk7CiAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uIChhZGFwdGVyUGF5bG9hZCkgewogICAgICB2YXIgc2VyaWFsaXplciA9IHN0b3JlLnNlcmlhbGl6ZXJGb3IocmVsYXRpb25zaGlwLnR5cGUpOwogICAgICB2YXIgcGF5bG9hZCA9IG5vcm1hbGl6ZVJlc3BvbnNlSGVscGVyKHNlcmlhbGl6ZXIsIHN0b3JlLCBtb2RlbENsYXNzLCBhZGFwdGVyUGF5bG9hZCwgbnVsbCwgJ2ZpbmRCZWxvbmdzVG8nKTsKCiAgICAgIGlmICghcGF5bG9hZC5kYXRhKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIHBheWxvYWQgPSBzeW5jUmVsYXRpb25zaGlwRGF0YUZyb21MaW5rKHN0b3JlLCBwYXlsb2FkLCBpbnRlcm5hbE1vZGVsLCByZWxhdGlvbnNoaXApOwogICAgICByZXR1cm4gc3RvcmUuX3B1c2gocGF5bG9hZCk7CiAgICB9LCBudWxsLCAiRFM6IEV4dHJhY3QgcGF5bG9hZCBvZiAiICsgaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWUgKyAiIDogIiArIHJlbGF0aW9uc2hpcC50eXBlKTsKICB9CiAgZnVuY3Rpb24gX2ZpbmRBbGwoYWRhcHRlciwgc3RvcmUsIG1vZGVsTmFtZSwgb3B0aW9ucykgewogICAgdmFyIG1vZGVsQ2xhc3MgPSBzdG9yZS5tb2RlbEZvcihtb2RlbE5hbWUpOyAvLyBhZGFwdGVyLmZpbmRBbGwgZGVwZW5kcyBvbiB0aGUgY2xhc3MKCiAgICB2YXIgcmVjb3JkQXJyYXkgPSBzdG9yZS5wZWVrQWxsKG1vZGVsTmFtZSk7CgogICAgdmFyIHNuYXBzaG90QXJyYXkgPSByZWNvcmRBcnJheS5fY3JlYXRlU25hcHNob3Qob3B0aW9ucyk7CgogICAgdmFyIHByb21pc2UgPSBFbWJlci5SU1ZQLlByb21pc2UucmVzb2x2ZSgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gYWRhcHRlci5maW5kQWxsKHN0b3JlLCBtb2RlbENsYXNzLCBudWxsLCBzbmFwc2hvdEFycmF5KTsKICAgIH0pOwogICAgdmFyIGxhYmVsID0gJ0RTOiBIYW5kbGUgQWRhcHRlciNmaW5kQWxsIG9mICcgKyBtb2RlbENsYXNzOwogICAgcHJvbWlzZSA9IGd1YXJkRGVzdHJveWVkU3RvcmUocHJvbWlzZSwgc3RvcmUsIGxhYmVsKTsKICAgIHJldHVybiBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKGFkYXB0ZXJQYXlsb2FkKSB7CiAgICAgIHZhciBzZXJpYWxpemVyID0gc3RvcmUuc2VyaWFsaXplckZvcihtb2RlbE5hbWUpOwogICAgICB2YXIgcGF5bG9hZCA9IG5vcm1hbGl6ZVJlc3BvbnNlSGVscGVyKHNlcmlhbGl6ZXIsIHN0b3JlLCBtb2RlbENsYXNzLCBhZGFwdGVyUGF5bG9hZCwgbnVsbCwgJ2ZpbmRBbGwnKTsKCiAgICAgIHN0b3JlLl9wdXNoKHBheWxvYWQpOwoKICAgICAgc3RvcmUuX2RpZFVwZGF0ZUFsbChtb2RlbE5hbWUpOwoKICAgICAgcmV0dXJuIHJlY29yZEFycmF5OwogICAgfSwgbnVsbCwgJ0RTOiBFeHRyYWN0IHBheWxvYWQgb2YgZmluZEFsbCAke21vZGVsTmFtZX0nKTsKICB9CiAgZnVuY3Rpb24gX3F1ZXJ5KGFkYXB0ZXIsIHN0b3JlLCBtb2RlbE5hbWUsIHF1ZXJ5LCByZWNvcmRBcnJheSwgb3B0aW9ucykgewogICAgdmFyIG1vZGVsQ2xhc3MgPSBzdG9yZS5tb2RlbEZvcihtb2RlbE5hbWUpOyAvLyBhZGFwdGVyLnF1ZXJ5IG5lZWRzIHRoZSBjbGFzcwoKICAgIHJlY29yZEFycmF5ID0gcmVjb3JkQXJyYXkgfHwgc3RvcmUucmVjb3JkQXJyYXlNYW5hZ2VyLmNyZWF0ZUFkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheShtb2RlbE5hbWUsIHF1ZXJ5KTsKICAgIHZhciBwcm9taXNlID0gRW1iZXIuUlNWUC5Qcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGFkYXB0ZXIucXVlcnkoc3RvcmUsIG1vZGVsQ2xhc3MsIHF1ZXJ5LCByZWNvcmRBcnJheSwgb3B0aW9ucyk7CiAgICB9KTsKICAgIHZhciBsYWJlbCA9ICJEUzogSGFuZGxlIEFkYXB0ZXIjcXVlcnkgb2YgIiArIG1vZGVsTmFtZTsKICAgIHByb21pc2UgPSBndWFyZERlc3Ryb3llZFN0b3JlKHByb21pc2UsIHN0b3JlLCBsYWJlbCk7CiAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uIChhZGFwdGVyUGF5bG9hZCkgewogICAgICB2YXIgc2VyaWFsaXplciA9IHN0b3JlLnNlcmlhbGl6ZXJGb3IobW9kZWxOYW1lKTsKICAgICAgdmFyIHBheWxvYWQgPSBub3JtYWxpemVSZXNwb25zZUhlbHBlcihzZXJpYWxpemVyLCBzdG9yZSwgbW9kZWxDbGFzcywgYWRhcHRlclBheWxvYWQsIG51bGwsICdxdWVyeScpOwoKICAgICAgdmFyIGludGVybmFsTW9kZWxzID0gc3RvcmUuX3B1c2gocGF5bG9hZCk7CgogICAgICBpZiAocmVjb3JkQXJyYXkpIHsKICAgICAgICByZWNvcmRBcnJheS5fc2V0SW50ZXJuYWxNb2RlbHMoaW50ZXJuYWxNb2RlbHMsIHBheWxvYWQpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlY29yZEFycmF5ID0gc3RvcmUucmVjb3JkQXJyYXlNYW5hZ2VyLmNyZWF0ZUFkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheShtb2RlbE5hbWUsIHF1ZXJ5LCBpbnRlcm5hbE1vZGVscywgcGF5bG9hZCk7CiAgICAgIH0KCiAgICAgIHJldHVybiByZWNvcmRBcnJheTsKICAgIH0sIG51bGwsICJEUzogRXh0cmFjdCBwYXlsb2FkIG9mIHF1ZXJ5ICIgKyBtb2RlbE5hbWUpOwogIH0KICBmdW5jdGlvbiBfcXVlcnlSZWNvcmQoYWRhcHRlciwgc3RvcmUsIG1vZGVsTmFtZSwgcXVlcnksIG9wdGlvbnMpIHsKICAgIHZhciBtb2RlbENsYXNzID0gc3RvcmUubW9kZWxGb3IobW9kZWxOYW1lKTsgLy8gYWRhcHRlci5xdWVyeVJlY29yZCBuZWVkcyB0aGUgY2xhc3MKCiAgICB2YXIgcHJvbWlzZSA9IEVtYmVyLlJTVlAuUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBhZGFwdGVyLnF1ZXJ5UmVjb3JkKHN0b3JlLCBtb2RlbENsYXNzLCBxdWVyeSwgb3B0aW9ucyk7CiAgICB9KTsKICAgIHZhciBsYWJlbCA9ICJEUzogSGFuZGxlIEFkYXB0ZXIjcXVlcnlSZWNvcmQgb2YgIiArIG1vZGVsTmFtZTsKICAgIHByb21pc2UgPSBndWFyZERlc3Ryb3llZFN0b3JlKHByb21pc2UsIHN0b3JlLCBsYWJlbCk7CiAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uIChhZGFwdGVyUGF5bG9hZCkgewogICAgICB2YXIgc2VyaWFsaXplciA9IHN0b3JlLnNlcmlhbGl6ZXJGb3IobW9kZWxOYW1lKTsKICAgICAgdmFyIHBheWxvYWQgPSBub3JtYWxpemVSZXNwb25zZUhlbHBlcihzZXJpYWxpemVyLCBzdG9yZSwgbW9kZWxDbGFzcywgYWRhcHRlclBheWxvYWQsIG51bGwsICdxdWVyeVJlY29yZCcpOwogICAgICByZXR1cm4gc3RvcmUuX3B1c2gocGF5bG9hZCk7CiAgICB9LCBudWxsLCAiRFM6IEV4dHJhY3QgcGF5bG9hZCBvZiBxdWVyeVJlY29yZCAiICsgbW9kZWxOYW1lKTsKICB9CgogIC8qKgogICAgQG1vZHVsZSBAZW1iZXItZGF0YS9zdG9yZQogICovCgogIC8qKgogICAgUmVwcmVzZW50cyBhbiBvcmRlcmVkIGxpc3Qgb2YgcmVjb3JkcyB3aG9zZSBvcmRlciBhbmQgbWVtYmVyc2hpcCBpcwogICAgZGV0ZXJtaW5lZCBieSB0aGUgYWRhcHRlci4gRm9yIGV4YW1wbGUsIGEgcXVlcnkgc2VudCB0byB0aGUgYWRhcHRlcgogICAgbWF5IHRyaWdnZXIgYSBzZWFyY2ggb24gdGhlIHNlcnZlciwgd2hvc2UgcmVzdWx0cyB3b3VsZCBiZSBsb2FkZWQKICAgIGludG8gYW4gaW5zdGFuY2Ugb2YgdGhlIGBBZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXlgLgoKICAgIC0tLQoKICAgIElmIHlvdSB3YW50IHRvIHVwZGF0ZSB0aGUgYXJyYXkgYW5kIGdldCB0aGUgbGF0ZXN0IHJlY29yZHMgZnJvbSB0aGUKICAgIGFkYXB0ZXIsIHlvdSBjYW4gaW52b2tlIFtgdXBkYXRlKClgXShBZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXkvbWV0aG9kcy91cGRhdGU/YW5jaG9yPXVwZGF0ZSk6CgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIC8vIEdFVCAvdXNlcnM/aXNBZG1pbj10cnVlCiAgICBzdG9yZS5xdWVyeSgndXNlcicsIHsgaXNBZG1pbjogdHJ1ZSB9KS50aGVuKGZ1bmN0aW9uKGFkbWlucykgewoKICAgICAgYWRtaW5zLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc29sZS5sb2coYWRtaW5zLmdldCgibGVuZ3RoIikpOyAvLyA0MgogICAgICB9KTsKCiAgICAgIC8vIHNvbWV3aGVyZSBsYXRlciBpbiB0aGUgYXBwIGNvZGUsIHdoZW4gbmV3IGFkbWlucyBoYXZlIGJlZW4gY3JlYXRlZAogICAgICAvLyBpbiB0aGUgbWVhbnRpbWUKICAgICAgLy8KICAgICAgLy8gR0VUIC91c2Vycz9pc0FkbWluPXRydWUKICAgICAgYWRtaW5zLnVwZGF0ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgYWRtaW5zLmdldCgnaXNVcGRhdGluZycpOyAvLyBmYWxzZQogICAgICAgIGNvbnNvbGUubG9nKGFkbWlucy5nZXQoImxlbmd0aCIpKTsgLy8gMTIzCiAgICAgIH0pOwoKICAgICAgYWRtaW5zLmdldCgnaXNVcGRhdGluZycpOyAvLyB0cnVlCiAgICB9CiAgICBgYGAKCiAgICBAY2xhc3MgQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5CiAgICBAZXh0ZW5kcyBSZWNvcmRBcnJheQogICovCiAgdmFyIEFkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheSA9IFJlY29yZEFycmF5LmV4dGVuZCh7CiAgICBpbml0OiBmdW5jdGlvbiBpbml0KCkgewoKICAgICAgLy8geWVzIHdlIGFyZSB0b3VjaGluZyBgdGhpc2AgYmVmb3JlIHN1cGVyLCBidXQgQXJyYXlQcm94eSBoYXMgYSBidWcgdGhhdCByZXF1aXJlcyB0aGlzLgogICAgICB0aGlzLnNldCgnY29udGVudCcsIHRoaXMuZ2V0KCdjb250ZW50JykgfHwgRW1iZXIuQSgpKTsKCiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICB0aGlzLnF1ZXJ5ID0gdGhpcy5xdWVyeSB8fCBudWxsOwogICAgICB0aGlzLmxpbmtzID0gdGhpcy5saW5rcyB8fCBudWxsOwogICAgfSwKICAgIHJlcGxhY2U6IGZ1bmN0aW9uIHJlcGxhY2UoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIHJlc3VsdCBvZiBhIHNlcnZlciBxdWVyeSAob24gIiArIHRoaXMubW9kZWxOYW1lICsgIikgaXMgaW1tdXRhYmxlLiIpOwogICAgfSwKICAgIF91cGRhdGU6IGZ1bmN0aW9uIF91cGRhdGUoKSB7CiAgICAgIHZhciBzdG9yZSA9IEVtYmVyLmdldCh0aGlzLCAnc3RvcmUnKTsKICAgICAgdmFyIHF1ZXJ5ID0gRW1iZXIuZ2V0KHRoaXMsICdxdWVyeScpOwogICAgICByZXR1cm4gc3RvcmUuX3F1ZXJ5KHRoaXMubW9kZWxOYW1lLCBxdWVyeSwgdGhpcyk7CiAgICB9LAoKICAgIC8qKgogICAgICBAbWV0aG9kIF9zZXRJbnRlcm5hbE1vZGVscwogICAgICBAcGFyYW0ge0FycmF5fSBpbnRlcm5hbE1vZGVscwogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZCBub3JtYWxpemVkIHBheWxvYWQKICAgICAgQHByaXZhdGUKICAgICovCiAgICBfc2V0SW50ZXJuYWxNb2RlbHM6IGZ1bmN0aW9uIF9zZXRJbnRlcm5hbE1vZGVscyhpbnRlcm5hbE1vZGVscywgcGF5bG9hZCkgewogICAgICAvLyBUT0RPOiBpbml0aWFsIGxvYWQgc2hvdWxkIG5vdCBjYXVzZSBjaGFuZ2UgZXZlbnRzIGF0IGFsbCwgb25seQogICAgICAvLyBzdWJzZXF1ZW50LiBUaGlzIHJlcXVpcmVzIGNoYW5naW5nIHRoZSBwdWJsaWMgYXBpIG9mIGFkYXB0ZXIucXVlcnksIGJ1dAogICAgICAvLyBob3BlZnVsbHkgd2UgY2FuIGRvIHRoYXQgc29vbi4KICAgICAgdGhpcy5nZXQoJ2NvbnRlbnQnKS5zZXRPYmplY3RzKGludGVybmFsTW9kZWxzKTsKICAgICAgdGhpcy5zZXRQcm9wZXJ0aWVzKHsKICAgICAgICBpc0xvYWRlZDogdHJ1ZSwKICAgICAgICBpc1VwZGF0aW5nOiBmYWxzZSwKICAgICAgICBtZXRhOiBFbWJlci5hc3NpZ24oe30sIHBheWxvYWQubWV0YSksCiAgICAgICAgbGlua3M6IEVtYmVyLmFzc2lnbih7fSwgcGF5bG9hZC5saW5rcykKICAgICAgfSk7CgogICAgICB0aGlzLm1hbmFnZXIuX2Fzc29jaWF0ZVdpdGhSZWNvcmRBcnJheShpbnRlcm5hbE1vZGVscywgdGhpcyk7CgogICAgICB2YXIgX2hhc0RpZExvYWQgPSAgdGhpcy5oYXMoJ2RpZExvYWQnKTsKCiAgICAgIGlmIChfaGFzRGlkTG9hZCkgewogICAgICAgIC8vIFRPRE86IHNob3VsZCB0cmlnZ2VyaW5nIGRpZExvYWQgZXZlbnQgYmUgdGhlIGxhc3QgYWN0aW9uIG9mIHRoZSBydW5Mb29wPwogICAgICAgIEVtYmVyLnJ1bi5vbmNlKHRoaXMsICd0cmlnZ2VyJywgJ2RpZExvYWQnKTsKICAgICAgfQogICAgfQogIH0pOwoKICB2YXIgZW1iZXJSdW4kMSA9IEVtYmVyLnJ1bi5iYWNrYnVybmVyOwogIC8qKgogICAgQGNsYXNzIFJlY29yZEFycmF5TWFuYWdlcgogICAgQHByaXZhdGUKICAqLwoKICB2YXIgUmVjb3JkQXJyYXlNYW5hZ2VyID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gUmVjb3JkQXJyYXlNYW5hZ2VyKG9wdGlvbnMpIHsKICAgICAgdGhpcy5zdG9yZSA9IG9wdGlvbnMuc3RvcmU7CiAgICAgIHRoaXMuaXNEZXN0cm95aW5nID0gZmFsc2U7CiAgICAgIHRoaXMuaXNEZXN0cm95ZWQgPSBmYWxzZTsKICAgICAgdGhpcy5fbGl2ZVJlY29yZEFycmF5cyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHRoaXMuX3BlbmRpbmcgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB0aGlzLl9hZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXlzID0gW107CiAgICB9CgogICAgdmFyIF9wcm90byA9IFJlY29yZEFycmF5TWFuYWdlci5wcm90b3R5cGU7CgogICAgX3Byb3RvLnJlY29yZERpZENoYW5nZSA9IGZ1bmN0aW9uIHJlY29yZERpZENoYW5nZShpbnRlcm5hbE1vZGVsKSB7CiAgICAgIC8vIFRPRE86IGNoYW5nZSBuYW1lCiAgICAgIC8vIFRPRE86IHRyYWNrIHRoYXQgaXQgd2FzIGFsc28gYSBjaGFuZ2UKICAgICAgdGhpcy5pbnRlcm5hbE1vZGVsRGlkQ2hhbmdlKGludGVybmFsTW9kZWwpOwogICAgfTsKCiAgICBfcHJvdG8ucmVjb3JkV2FzTG9hZGVkID0gZnVuY3Rpb24gcmVjb3JkV2FzTG9hZGVkKGludGVybmFsTW9kZWwpIHsKICAgICAgLy8gVE9ETzogY2hhbmdlIG5hbWUKICAgICAgLy8gVE9ETzogdHJhY2sgdGhhdCBpdCB3YXMgYWxzbyB0aGF0IGl0IHdhcyBmaXJzdCBsb2FkZWQKICAgICAgdGhpcy5pbnRlcm5hbE1vZGVsRGlkQ2hhbmdlKGludGVybmFsTW9kZWwpOwogICAgfTsKCiAgICBfcHJvdG8uaW50ZXJuYWxNb2RlbERpZENoYW5nZSA9IGZ1bmN0aW9uIGludGVybmFsTW9kZWxEaWRDaGFuZ2UoaW50ZXJuYWxNb2RlbCkgewogICAgICB2YXIgbW9kZWxOYW1lID0gaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWU7CgogICAgICBpZiAoaW50ZXJuYWxNb2RlbC5fcGVuZGluZ1JlY29yZEFycmF5TWFuYWdlckZsdXNoKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpbnRlcm5hbE1vZGVsLl9wZW5kaW5nUmVjb3JkQXJyYXlNYW5hZ2VyRmx1c2ggPSB0cnVlOwogICAgICB2YXIgcGVuZGluZyA9IHRoaXMuX3BlbmRpbmc7CiAgICAgIHZhciBtb2RlbHMgPSBwZW5kaW5nW21vZGVsTmFtZV0gPSBwZW5kaW5nW21vZGVsTmFtZV0gfHwgW107CgogICAgICBpZiAobW9kZWxzLnB1c2goaW50ZXJuYWxNb2RlbCkgIT09IDEpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGVtYmVyUnVuJDEuc2NoZWR1bGUoJ2FjdGlvbnMnLCB0aGlzLCB0aGlzLl9mbHVzaCk7CiAgICB9OwoKICAgIF9wcm90by5fZmx1c2hQZW5kaW5nSW50ZXJuYWxNb2RlbHNGb3JNb2RlbE5hbWUgPSBmdW5jdGlvbiBfZmx1c2hQZW5kaW5nSW50ZXJuYWxNb2RlbHNGb3JNb2RlbE5hbWUobW9kZWxOYW1lLCBpbnRlcm5hbE1vZGVscykgewogICAgICB2YXIgbW9kZWxzVG9SZW1vdmUgPSBbXTsKCiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgaW50ZXJuYWxNb2RlbHMubGVuZ3RoOyBqKyspIHsKICAgICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IGludGVybmFsTW9kZWxzW2pdOyAvLyBtYXJrIGludGVybmFsTW9kZWxzLCBzbyB0aGV5IGNhbiBvbmNlIGFnYWluIGJlIHByb2Nlc3NlZCBieSB0aGUKICAgICAgICAvLyByZWNvcmRBcnJheU1hbmFnZXIKCiAgICAgICAgaW50ZXJuYWxNb2RlbC5fcGVuZGluZ1JlY29yZEFycmF5TWFuYWdlckZsdXNoID0gZmFsc2U7IC8vIGJ1aWxkIHVwIGEgc2V0IG9mIG1vZGVscyB0byBlbnN1cmUgd2UgaGF2ZSBwdXJnZWQgY29ycmVjdGx5OwoKICAgICAgICBpZiAoaW50ZXJuYWxNb2RlbC5pc0hpZGRlbkZyb21SZWNvcmRBcnJheXMoKSkgewogICAgICAgICAgbW9kZWxzVG9SZW1vdmUucHVzaChpbnRlcm5hbE1vZGVsKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBhcnJheSA9IHRoaXMuX2xpdmVSZWNvcmRBcnJheXNbbW9kZWxOYW1lXTsKCiAgICAgIGlmIChhcnJheSkgewogICAgICAgIC8vIFRPRE86IHNraXAgaWYgaXQgb25seSBjaGFuZ2VkCiAgICAgICAgLy8gcHJvY2VzcyBsaXZlUmVjb3JkQXJyYXlzCiAgICAgICAgdGhpcy51cGRhdGVMaXZlUmVjb3JkQXJyYXkoYXJyYXksIGludGVybmFsTW9kZWxzKTsKICAgICAgfSAvLyBwcm9jZXNzIGFkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheXMKCgogICAgICBpZiAobW9kZWxzVG9SZW1vdmUubGVuZ3RoID4gMCkgewogICAgICAgIHJlbW92ZUZyb21BZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXlzKG1vZGVsc1RvUmVtb3ZlKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uX2ZsdXNoID0gZnVuY3Rpb24gX2ZsdXNoKCkgewogICAgICB2YXIgcGVuZGluZyA9IHRoaXMuX3BlbmRpbmc7CiAgICAgIHRoaXMuX3BlbmRpbmcgPSBPYmplY3QuY3JlYXRlKG51bGwpOwoKICAgICAgZm9yICh2YXIgbW9kZWxOYW1lIGluIHBlbmRpbmcpIHsKICAgICAgICB0aGlzLl9mbHVzaFBlbmRpbmdJbnRlcm5hbE1vZGVsc0Zvck1vZGVsTmFtZShtb2RlbE5hbWUsIHBlbmRpbmdbbW9kZWxOYW1lXSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLnVwZGF0ZUxpdmVSZWNvcmRBcnJheSA9IGZ1bmN0aW9uIHVwZGF0ZUxpdmVSZWNvcmRBcnJheShhcnJheSwgaW50ZXJuYWxNb2RlbHMpIHsKICAgICAgcmV0dXJuIF91cGRhdGVMaXZlUmVjb3JkQXJyYXkoYXJyYXksIGludGVybmFsTW9kZWxzKTsKICAgIH07CgogICAgX3Byb3RvLl9zeW5jTGl2ZVJlY29yZEFycmF5ID0gZnVuY3Rpb24gX3N5bmNMaXZlUmVjb3JkQXJyYXkoYXJyYXksIG1vZGVsTmFtZSkgewogICAgICB2YXIgcGVuZGluZyA9IHRoaXMuX3BlbmRpbmdbbW9kZWxOYW1lXTsKICAgICAgdmFyIGhhc1BlbmRpbmdDaGFuZ2VzID0gQXJyYXkuaXNBcnJheShwZW5kaW5nKTsKICAgICAgdmFyIGhhc05vUG90ZW50aWFsRGVsZXRpb25zID0gIWhhc1BlbmRpbmdDaGFuZ2VzIHx8IHBlbmRpbmcubGVuZ3RoID09PSAwOwogICAgICB2YXIgbWFwID0gaW50ZXJuYWxNb2RlbEZhY3RvcnlGb3IodGhpcy5zdG9yZSkubW9kZWxNYXBGb3IobW9kZWxOYW1lKTsKICAgICAgdmFyIGhhc05vSW5zZXJ0aW9uc09yUmVtb3ZhbHMgPSBFbWJlci5nZXQobWFwLCAnbGVuZ3RoJykgPT09IEVtYmVyLmdldChhcnJheSwgJ2xlbmd0aCcpOwogICAgICAvKgogICAgICAgIElkZWFsbHkgdGhlIHJlY29yZEFycmF5TWFuYWdlciBoYXMga25vd2xlZGdlIG9mIHRoZSBjaGFuZ2VzIHRvIGJlIGFwcGxpZWQgdG8KICAgICAgICBsaXZlUmVjb3JkQXJyYXlzLCBhbmQgaXMgY2FwYWJsZSBvZiBzdHJhdGVnaWNhbGx5IGZsdXNoaW5nIHRob3NlIGNoYW5nZXMgYW5kIGFwcGx5aW5nCiAgICAgICAgc21hbGwgZGlmZnMgaWYgZGVzaXJlZC4gIEhvd2V2ZXIsIHVudGlsIHdlJ3ZlIHJlZmFjdG9yZWQgcmVjb3JkQXJyYXlNYW5hZ2VyLCB0aGlzIGRpcnR5CiAgICAgICAgY2hlY2sgcHJldmVudHMgdXMgZnJvbSB1bm5lY2Vzc2FyaWx5IHdpcGluZyBvdXQgbGl2ZSByZWNvcmQgYXJyYXlzIHJldHVybmVkIGJ5IHBlZWtBbGwuCiAgICAgICAgKi8KCiAgICAgIGlmIChoYXNOb1BvdGVudGlhbERlbGV0aW9ucyAmJiBoYXNOb0luc2VydGlvbnNPclJlbW92YWxzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoaGFzUGVuZGluZ0NoYW5nZXMpIHsKICAgICAgICB0aGlzLl9mbHVzaFBlbmRpbmdJbnRlcm5hbE1vZGVsc0Zvck1vZGVsTmFtZShtb2RlbE5hbWUsIHBlbmRpbmcpOwoKICAgICAgICBkZWxldGUgdGhpcy5fcGVuZGluZ1ttb2RlbE5hbWVdOwogICAgICB9CgogICAgICB2YXIgaW50ZXJuYWxNb2RlbHMgPSB0aGlzLl92aXNpYmxlSW50ZXJuYWxNb2RlbHNCeVR5cGUobW9kZWxOYW1lKTsKCiAgICAgIHZhciBtb2RlbHNUb0FkZCA9IFtdOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbnRlcm5hbE1vZGVscy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBpbnRlcm5hbE1vZGVsID0gaW50ZXJuYWxNb2RlbHNbaV07CiAgICAgICAgdmFyIHJlY29yZEFycmF5cyA9IGludGVybmFsTW9kZWwuX3JlY29yZEFycmF5czsKCiAgICAgICAgaWYgKHJlY29yZEFycmF5cy5oYXMoYXJyYXkpID09PSBmYWxzZSkgewogICAgICAgICAgcmVjb3JkQXJyYXlzLmFkZChhcnJheSk7CiAgICAgICAgICBtb2RlbHNUb0FkZC5wdXNoKGludGVybmFsTW9kZWwpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKG1vZGVsc1RvQWRkLmxlbmd0aCkgewogICAgICAgIGFycmF5Ll9wdXNoSW50ZXJuYWxNb2RlbHMobW9kZWxzVG9BZGQpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5fZGlkVXBkYXRlQWxsID0gZnVuY3Rpb24gX2RpZFVwZGF0ZUFsbChtb2RlbE5hbWUpIHsKICAgICAgdmFyIHJlY29yZEFycmF5ID0gdGhpcy5fbGl2ZVJlY29yZEFycmF5c1ttb2RlbE5hbWVdOwoKICAgICAgaWYgKHJlY29yZEFycmF5KSB7CiAgICAgICAgRW1iZXIuc2V0KHJlY29yZEFycmF5LCAnaXNVcGRhdGluZycsIGZhbHNlKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgIEdldCB0aGUgYFJlY29yZEFycmF5YCBmb3IgYSBtb2RlbE5hbWUsIHdoaWNoIGNvbnRhaW5zIGFsbCBsb2FkZWQgcmVjb3JkcyBvZgogICAgICBnaXZlbiBtb2RlbE5hbWUuCiAgICAgICBAbWV0aG9kIGxpdmVSZWNvcmRBcnJheUZvcgogICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICAgIEByZXR1cm4ge1JlY29yZEFycmF5fQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ubGl2ZVJlY29yZEFycmF5Rm9yID0gZnVuY3Rpb24gbGl2ZVJlY29yZEFycmF5Rm9yKG1vZGVsTmFtZSkgewogICAgICB2YXIgYXJyYXkgPSB0aGlzLl9saXZlUmVjb3JkQXJyYXlzW21vZGVsTmFtZV07CgogICAgICBpZiAoYXJyYXkpIHsKICAgICAgICAvLyBpZiB0aGUgYXJyYXkgYWxyZWFkeSBleGlzdHMsIHN5bmNocm9uaXplCiAgICAgICAgdGhpcy5fc3luY0xpdmVSZWNvcmRBcnJheShhcnJheSwgbW9kZWxOYW1lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBpZiB0aGUgYXJyYXkgaXMgYmVpbmcgbmV3bHkgY3JlYXRlZCBtZXJlbHkgY3JlYXRlIGl0IHdpdGggaXRzIGluaXRpYWwKICAgICAgICAvLyBjb250ZW50IGFscmVhZHkgc2V0LiBUaGlzIHByZXZlbnRzIHVubmVlZGVkIGNoYW5nZSBldmVudHMuCiAgICAgICAgdmFyIGludGVybmFsTW9kZWxzID0gdGhpcy5fdmlzaWJsZUludGVybmFsTW9kZWxzQnlUeXBlKG1vZGVsTmFtZSk7CgogICAgICAgIGFycmF5ID0gdGhpcy5jcmVhdGVSZWNvcmRBcnJheShtb2RlbE5hbWUsIGludGVybmFsTW9kZWxzKTsKICAgICAgICB0aGlzLl9saXZlUmVjb3JkQXJyYXlzW21vZGVsTmFtZV0gPSBhcnJheTsKICAgICAgfQoKICAgICAgcmV0dXJuIGFycmF5OwogICAgfTsKCiAgICBfcHJvdG8uX3Zpc2libGVJbnRlcm5hbE1vZGVsc0J5VHlwZSA9IGZ1bmN0aW9uIF92aXNpYmxlSW50ZXJuYWxNb2RlbHNCeVR5cGUobW9kZWxOYW1lKSB7CiAgICAgIHZhciBhbGwgPSBpbnRlcm5hbE1vZGVsRmFjdG9yeUZvcih0aGlzLnN0b3JlKS5tb2RlbE1hcEZvcihtb2RlbE5hbWUpLl9tb2RlbHM7CgogICAgICB2YXIgdmlzaWJsZSA9IFtdOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhbGwubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgbW9kZWwgPSBhbGxbaV07CgogICAgICAgIGlmIChtb2RlbC5pc0hpZGRlbkZyb21SZWNvcmRBcnJheXMoKSA9PT0gZmFsc2UpIHsKICAgICAgICAgIHZpc2libGUucHVzaChtb2RlbCk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdmlzaWJsZTsKICAgIH0KICAgIC8qKgogICAgICBDcmVhdGUgYSBgUmVjb3JkQXJyYXlgIGZvciBhIG1vZGVsTmFtZS4KICAgICAgIEBtZXRob2QgY3JlYXRlUmVjb3JkQXJyYXkKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgICBAcGFyYW0ge0FycmF5fSBfY29udGVudCAob3B0aW9uYWx8cHJpdmF0ZSkKICAgICAgQHJldHVybiB7UmVjb3JkQXJyYXl9CiAgICAqLwogICAgOwoKICAgIF9wcm90by5jcmVhdGVSZWNvcmRBcnJheSA9IGZ1bmN0aW9uIGNyZWF0ZVJlY29yZEFycmF5KG1vZGVsTmFtZSwgY29udGVudCkgewogICAgICB2YXIgYXJyYXkgPSBSZWNvcmRBcnJheS5jcmVhdGUoewogICAgICAgIG1vZGVsTmFtZTogbW9kZWxOYW1lLAogICAgICAgIGNvbnRlbnQ6IEVtYmVyLkEoY29udGVudCB8fCBbXSksCiAgICAgICAgc3RvcmU6IHRoaXMuc3RvcmUsCiAgICAgICAgaXNMb2FkZWQ6IHRydWUsCiAgICAgICAgbWFuYWdlcjogdGhpcwogICAgICB9KTsKCiAgICAgIGlmIChBcnJheS5pc0FycmF5KGNvbnRlbnQpKSB7CiAgICAgICAgYXNzb2NpYXRlV2l0aFJlY29yZEFycmF5KGNvbnRlbnQsIGFycmF5KTsKICAgICAgfQoKICAgICAgcmV0dXJuIGFycmF5OwogICAgfQogICAgLyoqCiAgICAgIENyZWF0ZSBhIGBBZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXlgIGZvciBhIG1vZGVsTmFtZSB3aXRoIGdpdmVuIHF1ZXJ5LgogICAgICAgQG1ldGhvZCBjcmVhdGVBZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXkKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgICBAcGFyYW0ge09iamVjdH0gcXVlcnkKICAgICAgQHJldHVybiB7QWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5fQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uY3JlYXRlQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5ID0gZnVuY3Rpb24gY3JlYXRlQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5KG1vZGVsTmFtZSwgcXVlcnksIGludGVybmFsTW9kZWxzLCBwYXlsb2FkKSB7CiAgICAgIHZhciBhcnJheTsKCiAgICAgIGlmIChBcnJheS5pc0FycmF5KGludGVybmFsTW9kZWxzKSkgewogICAgICAgIGFycmF5ID0gQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5LmNyZWF0ZSh7CiAgICAgICAgICBtb2RlbE5hbWU6IG1vZGVsTmFtZSwKICAgICAgICAgIHF1ZXJ5OiBxdWVyeSwKICAgICAgICAgIGNvbnRlbnQ6IEVtYmVyLkEoaW50ZXJuYWxNb2RlbHMpLAogICAgICAgICAgc3RvcmU6IHRoaXMuc3RvcmUsCiAgICAgICAgICBtYW5hZ2VyOiB0aGlzLAogICAgICAgICAgaXNMb2FkZWQ6IHRydWUsCiAgICAgICAgICBpc1VwZGF0aW5nOiBmYWxzZSwKICAgICAgICAgIG1ldGE6IEVtYmVyLmFzc2lnbih7fSwgcGF5bG9hZC5tZXRhKSwKICAgICAgICAgIGxpbmtzOiBFbWJlci5hc3NpZ24oe30sIHBheWxvYWQubGlua3MpCiAgICAgICAgfSk7CiAgICAgICAgYXNzb2NpYXRlV2l0aFJlY29yZEFycmF5KGludGVybmFsTW9kZWxzLCBhcnJheSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYXJyYXkgPSBBZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXkuY3JlYXRlKHsKICAgICAgICAgIG1vZGVsTmFtZTogbW9kZWxOYW1lLAogICAgICAgICAgcXVlcnk6IHF1ZXJ5LAogICAgICAgICAgY29udGVudDogRW1iZXIuQSgpLAogICAgICAgICAgc3RvcmU6IHRoaXMuc3RvcmUsCiAgICAgICAgICBtYW5hZ2VyOiB0aGlzCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHRoaXMuX2FkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheXMucHVzaChhcnJheSk7CgogICAgICByZXR1cm4gYXJyYXk7CiAgICB9CiAgICAvKioKICAgICAgVW5yZWdpc3RlciBhIFJlY29yZEFycmF5LgogICAgICBTbyBtYW5hZ2VyIHdpbGwgbm90IHVwZGF0ZSB0aGlzIGFycmF5LgogICAgICAgQG1ldGhvZCB1bnJlZ2lzdGVyUmVjb3JkQXJyYXkKICAgICAgQHBhcmFtIHtSZWNvcmRBcnJheX0gYXJyYXkKICAgICovCiAgICA7CgogICAgX3Byb3RvLnVucmVnaXN0ZXJSZWNvcmRBcnJheSA9IGZ1bmN0aW9uIHVucmVnaXN0ZXJSZWNvcmRBcnJheShhcnJheSkgewogICAgICB2YXIgbW9kZWxOYW1lID0gYXJyYXkubW9kZWxOYW1lOyAvLyByZW1vdmUgZnJvbSBhZGFwdGVyIHBvcHVsYXRlZCByZWNvcmQgYXJyYXkKCiAgICAgIHZhciByZW1vdmVkRnJvbUFkYXB0ZXJQb3B1bGF0ZWQgPSByZW1vdmUodGhpcy5fYWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5cywgYXJyYXkpOwoKICAgICAgaWYgKCFyZW1vdmVkRnJvbUFkYXB0ZXJQb3B1bGF0ZWQpIHsKICAgICAgICB2YXIgbGl2ZVJlY29yZEFycmF5Rm9yVHlwZSA9IHRoaXMuX2xpdmVSZWNvcmRBcnJheXNbbW9kZWxOYW1lXTsgLy8gdW5yZWdpc3RlciBsaXZlIHJlY29yZCBhcnJheQoKICAgICAgICBpZiAobGl2ZVJlY29yZEFycmF5Rm9yVHlwZSkgewogICAgICAgICAgaWYgKGFycmF5ID09PSBsaXZlUmVjb3JkQXJyYXlGb3JUeXBlKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9saXZlUmVjb3JkQXJyYXlzW21vZGVsTmFtZV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5fYXNzb2NpYXRlV2l0aFJlY29yZEFycmF5ID0gZnVuY3Rpb24gX2Fzc29jaWF0ZVdpdGhSZWNvcmRBcnJheShpbnRlcm5hbE1vZGVscywgYXJyYXkpIHsKICAgICAgYXNzb2NpYXRlV2l0aFJlY29yZEFycmF5KGludGVybmFsTW9kZWxzLCBhcnJheSk7CiAgICB9OwoKICAgIF9wcm90by53aWxsRGVzdHJveSA9IGZ1bmN0aW9uIHdpbGxEZXN0cm95KCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgT2JqZWN0LmtleXModGhpcy5fbGl2ZVJlY29yZEFycmF5cykuZm9yRWFjaChmdW5jdGlvbiAobW9kZWxOYW1lKSB7CiAgICAgICAgcmV0dXJuIF90aGlzLl9saXZlUmVjb3JkQXJyYXlzW21vZGVsTmFtZV0uZGVzdHJveSgpOwogICAgICB9KTsKCiAgICAgIHRoaXMuX2FkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheXMuZm9yRWFjaChkZXN0cm95KTsKCiAgICAgIHRoaXMuaXNEZXN0cm95ZWQgPSB0cnVlOwogICAgfTsKCiAgICBfcHJvdG8uZGVzdHJveSA9IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgIHRoaXMuaXNEZXN0cm95aW5nID0gdHJ1ZTsKICAgICAgZW1iZXJSdW4kMS5zY2hlZHVsZSgnYWN0aW9ucycsIHRoaXMsIHRoaXMud2lsbERlc3Ryb3kpOwogICAgfTsKCiAgICByZXR1cm4gUmVjb3JkQXJyYXlNYW5hZ2VyOwogIH0oKTsKCiAgZnVuY3Rpb24gZGVzdHJveShlbnRyeSkgewogICAgZW50cnkuZGVzdHJveSgpOwogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlKGFycmF5LCBpdGVtKSB7CiAgICB2YXIgaW5kZXggPSBhcnJheS5pbmRleE9mKGl0ZW0pOwoKICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgZnVuY3Rpb24gX3VwZGF0ZUxpdmVSZWNvcmRBcnJheShhcnJheSwgaW50ZXJuYWxNb2RlbHMpIHsKICAgIHZhciBtb2RlbHNUb0FkZCA9IFtdOwogICAgdmFyIG1vZGVsc1RvUmVtb3ZlID0gW107CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbnRlcm5hbE1vZGVscy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IGludGVybmFsTW9kZWxzW2ldOwogICAgICB2YXIgaXNEZWxldGVkID0gaW50ZXJuYWxNb2RlbC5pc0hpZGRlbkZyb21SZWNvcmRBcnJheXMoKTsKICAgICAgdmFyIHJlY29yZEFycmF5cyA9IGludGVybmFsTW9kZWwuX3JlY29yZEFycmF5czsKCiAgICAgIGlmICghaXNEZWxldGVkICYmICFpbnRlcm5hbE1vZGVsLmlzRW1wdHkoKSkgewogICAgICAgIGlmICghcmVjb3JkQXJyYXlzLmhhcyhhcnJheSkpIHsKICAgICAgICAgIG1vZGVsc1RvQWRkLnB1c2goaW50ZXJuYWxNb2RlbCk7CiAgICAgICAgICByZWNvcmRBcnJheXMuYWRkKGFycmF5KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChpc0RlbGV0ZWQpIHsKICAgICAgICBtb2RlbHNUb1JlbW92ZS5wdXNoKGludGVybmFsTW9kZWwpOwogICAgICAgIHJlY29yZEFycmF5cy5kZWxldGUoYXJyYXkpOwogICAgICB9CiAgICB9CgogICAgaWYgKG1vZGVsc1RvQWRkLmxlbmd0aCA+IDApIHsKICAgICAgYXJyYXkuX3B1c2hJbnRlcm5hbE1vZGVscyhtb2RlbHNUb0FkZCk7CiAgICB9CgogICAgaWYgKG1vZGVsc1RvUmVtb3ZlLmxlbmd0aCA+IDApIHsKICAgICAgYXJyYXkuX3JlbW92ZUludGVybmFsTW9kZWxzKG1vZGVsc1RvUmVtb3ZlKTsKICAgIH0gLy8gcmV0dXJuIHdoZXRoZXIgd2UgcGVyZm9ybWVkIGFuIHVwZGF0ZS4KICAgIC8vIE5lY2Vzc2FyeSB1bnRpbCAzLjUgYWxsb3dzIHVzIHRvIGZpbmlzaCBvZmYgZW1iZXItZGF0YS1maWx0ZXIgc3VwcG9ydC4KCgogICAgcmV0dXJuIChtb2RlbHNUb0FkZC5sZW5ndGggfHwgbW9kZWxzVG9SZW1vdmUubGVuZ3RoKSA+IDA7CiAgfQoKICBmdW5jdGlvbiByZW1vdmVGcm9tQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5cyhpbnRlcm5hbE1vZGVscykgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbnRlcm5hbE1vZGVscy5sZW5ndGg7IGkrKykgewogICAgICByZW1vdmVGcm9tQWxsKGludGVybmFsTW9kZWxzW2ldKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbW92ZUZyb21BbGwoaW50ZXJuYWxNb2RlbCkgewogICAgdmFyIHJlY29yZEFycmF5cyA9IGludGVybmFsTW9kZWwuX3JlY29yZEFycmF5czsKICAgIHJlY29yZEFycmF5cy5mb3JFYWNoKGZ1bmN0aW9uIChyZWNvcmRBcnJheSkgewogICAgICByZWNvcmRBcnJheS5fcmVtb3ZlSW50ZXJuYWxNb2RlbHMoW2ludGVybmFsTW9kZWxdKTsKICAgIH0pOwogICAgcmVjb3JkQXJyYXlzLmNsZWFyKCk7CiAgfQoKICBmdW5jdGlvbiBhc3NvY2lhdGVXaXRoUmVjb3JkQXJyYXkoaW50ZXJuYWxNb2RlbHMsIGFycmF5KSB7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGludGVybmFsTW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IGludGVybmFsTW9kZWxzW2ldOwoKICAgICAgaW50ZXJuYWxNb2RlbC5fcmVjb3JkQXJyYXlzLmFkZChhcnJheSk7CiAgICB9CiAgfQoKICB2YXIgYmFja2J1cm5lciA9IG5ldyBFbWJlci5fQmFja2J1cm5lcihbJ25vcm1hbGl6ZVJlbGF0aW9uc2hpcHMnLCAnc3luY1JlbGF0aW9uc2hpcHMnLCAnZmluaXNoZWQnXSk7CgogIC8qKgogICAgQG1vZHVsZSBAZW1iZXItZGF0YS9zdG9yZQogICovCgogIC8qKgogICAqIEdldCB0aGUgbWF0ZXJpYWxpemVkIG1vZGVsIGZyb20gdGhlIGludGVybmFsTW9kZWwvcHJvbWlzZQogICAqIHRoYXQgcmV0dXJucyBhbiBpbnRlcm5hbCBtb2RlbCBhbmQgcmV0dXJuIGl0IGluIGEgcHJvbWlzZU9iamVjdC4KICAgKgogICAqIFVzZWZ1bCBmb3IgcmV0dXJuaW5nIGZyb20gZmluZCBtZXRob2RzCiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KICBmdW5jdGlvbiBwcm9taXNlUmVjb3JkKGludGVybmFsTW9kZWxQcm9taXNlLCBsYWJlbCkgewogICAgdmFyIHRvUmV0dXJuID0gaW50ZXJuYWxNb2RlbFByb21pc2UudGhlbihmdW5jdGlvbiAoaW50ZXJuYWxNb2RlbCkgewogICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbC5nZXRSZWNvcmQoKTsKICAgIH0pOwogICAgcmV0dXJuIHByb21pc2VPYmplY3QodG9SZXR1cm4sIGxhYmVsKTsKICB9CgogIHZhciBDYWNoZSA9IG5ldyBXZWFrTWFwKCk7CiAgdmFyIFRva2VucyA9IG5ldyBXZWFrTWFwKCk7CiAgLyoKICAgIEN1cnJlbnRseSBvbmx5IHN1cHBvcnQgYSBzaW5nbGUgY2FsbGJhY2sgcGVyIGlkZW50aWZpZXIKICAqLwoKICB2YXIgTm90aWZpY2F0aW9uTWFuYWdlciA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIE5vdGlmaWNhdGlvbk1hbmFnZXIoc3RvcmUpIHsKICAgICAgdGhpcy5zdG9yZSA9IHN0b3JlOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBOb3RpZmljYXRpb25NYW5hZ2VyLnByb3RvdHlwZTsKCiAgICBfcHJvdG8uc3Vic2NyaWJlID0gZnVuY3Rpb24gc3Vic2NyaWJlKGlkZW50aWZpZXIsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBzdGFibGVJZGVudGlmaWVyID0gaWRlbnRpZmllckNhY2hlRm9yKHRoaXMuc3RvcmUpLmdldE9yQ3JlYXRlUmVjb3JkSWRlbnRpZmllcihpZGVudGlmaWVyKTsKICAgICAgQ2FjaGUuc2V0KHN0YWJsZUlkZW50aWZpZXIsIGNhbGxiYWNrKTsKICAgICAgdmFyIHVuc3ViVG9rZW4gPSBuZXcgT2JqZWN0KCk7CiAgICAgIFRva2Vucy5zZXQodW5zdWJUb2tlbiwgc3RhYmxlSWRlbnRpZmllcik7CiAgICAgIHJldHVybiBpZGVudGlmaWVyOwogICAgfTsKCiAgICBfcHJvdG8ubm90aWZ5ID0gZnVuY3Rpb24gbm90aWZ5KGlkZW50aWZpZXIsIHZhbHVlKSB7CiAgICAgIHZhciBzdGFibGVJZGVudGlmaWVyID0gaWRlbnRpZmllckNhY2hlRm9yKHRoaXMuc3RvcmUpLmdldE9yQ3JlYXRlUmVjb3JkSWRlbnRpZmllcihpZGVudGlmaWVyKTsKICAgICAgdmFyIGNhbGxiYWNrID0gQ2FjaGUuZ2V0KHN0YWJsZUlkZW50aWZpZXIpOwoKICAgICAgaWYgKCFjYWxsYmFjaykgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgY2FsbGJhY2soc3RhYmxlSWRlbnRpZmllciwgdmFsdWUpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CgogICAgcmV0dXJuIE5vdGlmaWNhdGlvbk1hbmFnZXI7CiAgfSgpOwoKICBmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyQ2KHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9CgogIGZ1bmN0aW9uIF9jcmVhdGVDbGFzcyQ2KENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMkNihDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzJDYoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9CgogIHZhciBBdmFpbGFibGVTaGltcyA9IG5ldyBXZWFrTWFwKCk7CiAgZnVuY3Rpb24gZ2V0U2hpbUNsYXNzKHN0b3JlLCBtb2RlbE5hbWUpIHsKICAgIHZhciBzaGltcyA9IEF2YWlsYWJsZVNoaW1zLmdldChzdG9yZSk7CgogICAgaWYgKHNoaW1zID09PSB1bmRlZmluZWQpIHsKICAgICAgc2hpbXMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBBdmFpbGFibGVTaGltcy5zZXQoc3RvcmUsIHNoaW1zKTsKICAgIH0KCiAgICB2YXIgc2hpbSA9IHNoaW1zW21vZGVsTmFtZV07CgogICAgaWYgKHNoaW0gPT09IHVuZGVmaW5lZCkgewogICAgICBzaGltID0gc2hpbXNbbW9kZWxOYW1lXSA9IG5ldyBTaGltTW9kZWxDbGFzcyhzdG9yZSwgbW9kZWxOYW1lKTsKICAgIH0KCiAgICByZXR1cm4gc2hpbTsKICB9IC8vIE1pbWljcyB0aGUgc3RhdGljIGFwaXMgb2YgRFNNb2RlbAoKICB2YXIgU2hpbU1vZGVsQ2xhc3MgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICAvLyBUT0RPIE1heWJlIGV4cG9zZSB0aGUgY2xhc3MgaGVyZT8KICAgIGZ1bmN0aW9uIFNoaW1Nb2RlbENsYXNzKF9fc3RvcmUsIG1vZGVsTmFtZSkgewogICAgICB0aGlzLl9fc3RvcmUgPSBfX3N0b3JlOwogICAgICB0aGlzLm1vZGVsTmFtZSA9IG1vZGVsTmFtZTsKICAgIH0KCiAgICB2YXIgX3Byb3RvID0gU2hpbU1vZGVsQ2xhc3MucHJvdG90eXBlOwoKICAgIF9wcm90by5lYWNoQXR0cmlidXRlID0gZnVuY3Rpb24gZWFjaEF0dHJpYnV0ZShjYWxsYmFjaywgYmluZGluZykgewogICAgICB2YXIgYXR0ckRlZnMgPSB0aGlzLl9fc3RvcmUuX2F0dHJpYnV0ZXNEZWZpbml0aW9uRm9yKHRoaXMubW9kZWxOYW1lKTsKCiAgICAgIE9iamVjdC5rZXlzKGF0dHJEZWZzKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBjYWxsYmFjay5jYWxsKGJpbmRpbmcsIGtleSwgYXR0ckRlZnNba2V5XSk7CiAgICAgIH0pOwogICAgfTsKCiAgICBfcHJvdG8uZWFjaFJlbGF0aW9uc2hpcCA9IGZ1bmN0aW9uIGVhY2hSZWxhdGlvbnNoaXAoY2FsbGJhY2ssIGJpbmRpbmcpIHsKICAgICAgdmFyIHJlbGF0aW9uc2hpcERlZnMgPSB0aGlzLl9fc3RvcmUuX3JlbGF0aW9uc2hpcHNEZWZpbml0aW9uRm9yKHRoaXMubW9kZWxOYW1lKTsKCiAgICAgIE9iamVjdC5rZXlzKHJlbGF0aW9uc2hpcERlZnMpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIGNhbGxiYWNrLmNhbGwoYmluZGluZywga2V5LCByZWxhdGlvbnNoaXBEZWZzW2tleV0pOwogICAgICB9KTsKICAgIH07CgogICAgX3Byb3RvLmVhY2hUcmFuc2Zvcm1lZEF0dHJpYnV0ZSA9IGZ1bmN0aW9uIGVhY2hUcmFuc2Zvcm1lZEF0dHJpYnV0ZShjYWxsYmFjaywgYmluZGluZykgewogICAgICB2YXIgcmVsYXRpb25zaGlwRGVmcyA9IHRoaXMuX19zdG9yZS5fcmVsYXRpb25zaGlwc0RlZmluaXRpb25Gb3IodGhpcy5tb2RlbE5hbWUpOwoKICAgICAgT2JqZWN0LmtleXMocmVsYXRpb25zaGlwRGVmcykuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgaWYgKHJlbGF0aW9uc2hpcERlZnNba2V5XS50eXBlKSB7CiAgICAgICAgICBjYWxsYmFjay5jYWxsKGJpbmRpbmcsIGtleSwgcmVsYXRpb25zaGlwRGVmc1trZXldKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKCiAgICBfY3JlYXRlQ2xhc3MkNihTaGltTW9kZWxDbGFzcywgW3sKICAgICAga2V5OiAiZmllbGRzIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgdmFyIGF0dHJzID0gdGhpcy5fX3N0b3JlLl9hdHRyaWJ1dGVzRGVmaW5pdGlvbkZvcih0aGlzLm1vZGVsTmFtZSk7CgogICAgICAgIHZhciByZWxhdGlvbnNoaXBzID0gdGhpcy5fX3N0b3JlLl9yZWxhdGlvbnNoaXBzRGVmaW5pdGlvbkZvcih0aGlzLm1vZGVsTmFtZSk7CgogICAgICAgIHZhciBmaWVsZHMgPSBuZXcgTWFwKCk7CiAgICAgICAgT2JqZWN0LmtleXMoYXR0cnMpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgcmV0dXJuIGZpZWxkcy5zZXQoa2V5LCAnYXR0cmlidXRlJyk7CiAgICAgICAgfSk7CiAgICAgICAgT2JqZWN0LmtleXMocmVsYXRpb25zaGlwcykuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICByZXR1cm4gZmllbGRzLnNldChrZXksIHJlbGF0aW9uc2hpcHNba2V5XS5raW5kKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZmllbGRzOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImF0dHJpYnV0ZXMiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICB2YXIgYXR0cnMgPSB0aGlzLl9fc3RvcmUuX2F0dHJpYnV0ZXNEZWZpbml0aW9uRm9yKHRoaXMubW9kZWxOYW1lKTsKCiAgICAgICAgcmV0dXJuIG5ldyBNYXAoT2JqZWN0LmVudHJpZXMoYXR0cnMpKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZWxhdGlvbnNoaXBzQnlOYW1lIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgdmFyIHJlbGF0aW9uc2hpcHMgPSB0aGlzLl9fc3RvcmUuX3JlbGF0aW9uc2hpcHNEZWZpbml0aW9uRm9yKHRoaXMubW9kZWxOYW1lKTsKCiAgICAgICAgcmV0dXJuIG5ldyBNYXAoT2JqZWN0LmVudHJpZXMocmVsYXRpb25zaGlwcykpOwogICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIFNoaW1Nb2RlbENsYXNzOwogIH0oKTsKCiAgZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXMkNyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKICBmdW5jdGlvbiBfY3JlYXRlQ2xhc3MkNyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzJDcoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyQ3KENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKICBmdW5jdGlvbiBfYXNzZXJ0VGhpc0luaXRpYWxpemVkKHNlbGYpIHsgaWYgKHNlbGYgPT09IHZvaWQgMCkgeyB0aHJvdyBuZXcgUmVmZXJlbmNlRXJyb3IoInRoaXMgaGFzbid0IGJlZW4gaW5pdGlhbGlzZWQgLSBzdXBlcigpIGhhc24ndCBiZWVuIGNhbGxlZCIpOyB9IHJldHVybiBzZWxmOyB9CgogIGZ1bmN0aW9uIF9pbmhlcml0c0xvb3NlJDMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzLnByb3RvdHlwZSk7IHN1YkNsYXNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHN1YkNsYXNzOyBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9CiAgdmFyIGVtYmVyUnVuJDIgPSBFbWJlci5ydW4uYmFja2J1cm5lcjsKICB2YXIgRU5WID0gRW1iZXIuRU5WOwogIHZhciBIQVNfU0VSSUFMSVpFUl9QQUNLQUdFID0gcmVxdWlyZS5oYXMoJ0BlbWJlci1kYXRhL3NlcmlhbGl6ZXInKTsKICB2YXIgSEFTX0FEQVBURVJfUEFDS0FHRSA9IHJlcXVpcmUuaGFzKCdAZW1iZXItZGF0YS9hZGFwdGVyJyk7CiAgdmFyIEhBU19NT0RFTF9QQUNLQUdFID0gcmVxdWlyZS5oYXMoJ0BlbWJlci1kYXRhL21vZGVsJyk7CgogIHZhciBfTW9kZWw7CgogIGZ1bmN0aW9uIGdldE1vZGVsKCkgewogICAgaWYgKEhBU19NT0RFTF9QQUNLQUdFKSB7CiAgICAgIF9Nb2RlbCA9IF9Nb2RlbCB8fCByZXF1aXJlX19kZWZhdWx0KCdAZW1iZXItZGF0YS9tb2RlbCcpLmRlZmF1bHQ7CiAgICB9CgogICAgcmV0dXJuIF9Nb2RlbDsKICB9CiAgLyoqCiAgICBUaGUgc3RvcmUgY29udGFpbnMgYWxsIG9mIHRoZSBkYXRhIGZvciByZWNvcmRzIGxvYWRlZCBmcm9tIHRoZSBzZXJ2ZXIuCiAgICBJdCBpcyBhbHNvIHJlc3BvbnNpYmxlIGZvciBjcmVhdGluZyBpbnN0YW5jZXMgb2YgYE1vZGVsYCB0aGF0IHdyYXAKICAgIHRoZSBpbmRpdmlkdWFsIGRhdGEgZm9yIGEgcmVjb3JkLCBzbyB0aGF0IHRoZXkgY2FuIGJlIGJvdW5kIHRvIGluIHlvdXIKICAgIEhhbmRsZWJhcnMgdGVtcGxhdGVzLgoKICAgIERlZmluZSB5b3VyIGFwcGxpY2F0aW9uJ3Mgc3RvcmUgbGlrZSB0aGlzOgoKICAgIGBgYGFwcC9zZXJ2aWNlcy9zdG9yZS5qcwogICAgaW1wb3J0IFN0b3JlIGZyb20gJ0BlbWJlci1kYXRhL3N0b3JlJzsKCiAgICBleHBvcnQgZGVmYXVsdCBTdG9yZS5leHRlbmQoewogICAgfSk7CiAgICBgYGAKCiAgICBNb3N0IEVtYmVyLmpzIGFwcGxpY2F0aW9ucyB3aWxsIG9ubHkgaGF2ZSBhIHNpbmdsZSBgU3RvcmVgIHRoYXQgaXMKICAgIGF1dG9tYXRpY2FsbHkgY3JlYXRlZCBieSB0aGVpciBgRW1iZXIuQXBwbGljYXRpb25gLgoKICAgIFlvdSBjYW4gcmV0cmlldmUgbW9kZWxzIGZyb20gdGhlIHN0b3JlIGluIHNldmVyYWwgd2F5cy4gVG8gcmV0cmlldmUgYSByZWNvcmQKICAgIGZvciBhIHNwZWNpZmljIGlkLCB1c2UgYFN0b3JlYCdzIGBmaW5kUmVjb3JkKClgIG1ldGhvZDoKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBzdG9yZS5maW5kUmVjb3JkKCdwZXJzb24nLCAxMjMpLnRoZW4oZnVuY3Rpb24gKHBlcnNvbikgewogICAgfSk7CiAgICBgYGAKCiAgICBCeSBkZWZhdWx0LCB0aGUgc3RvcmUgd2lsbCB0YWxrIHRvIHlvdXIgYmFja2VuZCB1c2luZyBhIHN0YW5kYXJkCiAgICBSRVNUIG1lY2hhbmlzbS4gWW91IGNhbiBjdXN0b21pemUgaG93IHRoZSBzdG9yZSB0YWxrcyB0byB5b3VyCiAgICBiYWNrZW5kIGJ5IHNwZWNpZnlpbmcgYSBjdXN0b20gYWRhcHRlcjoKCiAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgIGltcG9ydCBBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXInOwoKICAgIGV4cG9ydCBkZWZhdWx0IEFkYXB0ZXIuZXh0ZW5kKHsKICAgIH0pOwogICAgYGBgCgogICAgWW91IGNhbiBsZWFybiBtb3JlIGFib3V0IHdyaXRpbmcgYSBjdXN0b20gYWRhcHRlciBieSByZWFkaW5nIHRoZSBgQWRhcHRlcmAKICAgIGRvY3VtZW50YXRpb24uCgogICAgIyMjIFN0b3JlIGNyZWF0ZVJlY29yZCgpIHZzLiBwdXNoKCkgdnMuIHB1c2hQYXlsb2FkKCkKCiAgICBUaGUgc3RvcmUgcHJvdmlkZXMgbXVsdGlwbGUgd2F5cyB0byBjcmVhdGUgbmV3IHJlY29yZCBvYmplY3RzLiBUaGV5IGhhdmUKICAgIHNvbWUgc3VidGxlIGRpZmZlcmVuY2VzIGluIHRoZWlyIHVzZSB3aGljaCBhcmUgZGV0YWlsZWQgYmVsb3c6CgogICAgW2NyZWF0ZVJlY29yZF0oU3RvcmUvbWV0aG9kcy9jcmVhdGVSZWNvcmQ/YW5jaG9yPWNyZWF0ZVJlY29yZCkgaXMgdXNlZCBmb3IgY3JlYXRpbmcgbmV3CiAgICByZWNvcmRzIG9uIHRoZSBjbGllbnQgc2lkZS4gVGhpcyB3aWxsIHJldHVybiBhIG5ldyByZWNvcmQgaW4gdGhlCiAgICBgY3JlYXRlZC51bmNvbW1pdHRlZGAgc3RhdGUuIEluIG9yZGVyIHRvIHBlcnNpc3QgdGhpcyByZWNvcmQgdG8gdGhlCiAgICBiYWNrZW5kLCB5b3Ugd2lsbCBuZWVkIHRvIGNhbGwgYHJlY29yZC5zYXZlKClgLgoKICAgIFtwdXNoXShTdG9yZS9tZXRob2RzL3B1c2g/YW5jaG9yPXB1c2gpIGlzIHVzZWQgdG8gbm90aWZ5IEVtYmVyIERhdGEncyBzdG9yZSBvZiBuZXcgb3IKICAgIHVwZGF0ZWQgcmVjb3JkcyB0aGF0IGV4aXN0IGluIHRoZSBiYWNrZW5kLiBUaGlzIHdpbGwgcmV0dXJuIGEgcmVjb3JkCiAgICBpbiB0aGUgYGxvYWRlZC5zYXZlZGAgc3RhdGUuIFRoZSBwcmltYXJ5IHVzZS1jYXNlIGZvciBgc3RvcmUjcHVzaGAgaXMKICAgIHRvIG5vdGlmeSBFbWJlciBEYXRhIGFib3V0IHJlY29yZCB1cGRhdGVzIChmdWxsIG9yIHBhcnRpYWwpIHRoYXQgaGFwcGVuCiAgICBvdXRzaWRlIG9mIHRoZSBub3JtYWwgYWRhcHRlciBtZXRob2RzIChmb3IgZXhhbXBsZQogICAgW1NTRV0oaHR0cDovL2Rldi53My5vcmcvaHRtbDUvZXZlbnRzb3VyY2UvKSBvciBbV2ViCiAgICBTb2NrZXRzXShodHRwOi8vd3d3LnczLm9yZy9UUi8yMDA5L1dELXdlYnNvY2tldHMtMjAwOTEyMjIvKSkuCgogICAgW3B1c2hQYXlsb2FkXShTdG9yZS9tZXRob2RzL3B1c2hQYXlsb2FkP2FuY2hvcj1wdXNoUGF5bG9hZCkgaXMgYSBjb252ZW5pZW5jZSB3cmFwcGVyIGZvcgogICAgYHN0b3JlI3B1c2hgIHRoYXQgd2lsbCBkZXNlcmlhbGl6ZSBwYXlsb2FkcyBpZiB0aGUKICAgIFNlcmlhbGl6ZXIgaW1wbGVtZW50cyBhIGBwdXNoUGF5bG9hZGAgbWV0aG9kLgoKICAgIE5vdGU6IFdoZW4gY3JlYXRpbmcgYSBuZXcgcmVjb3JkIHVzaW5nIGFueSBvZiB0aGUgYWJvdmUgbWV0aG9kcwogICAgRW1iZXIgRGF0YSB3aWxsIHVwZGF0ZSBgUmVjb3JkQXJyYXlgcyBzdWNoIGFzIHRob3NlIHJldHVybmVkIGJ5CiAgICBgc3RvcmUjcGVla0FsbCgpYCBvciBgc3RvcmUjZmluZEFsbCgpYC4gVGhpcyBtZWFucyBhbnkKICAgIGRhdGEgYmluZGluZ3Mgb3IgY29tcHV0ZWQgcHJvcGVydGllcyB0aGF0IGRlcGVuZCBvbiB0aGUgUmVjb3JkQXJyYXkKICAgIHdpbGwgYXV0b21hdGljYWxseSBiZSBzeW5jZWQgdG8gaW5jbHVkZSB0aGUgbmV3IG9yIHVwZGF0ZWQgcmVjb3JkCiAgICB2YWx1ZXMuCgogICAgQGNsYXNzIFN0b3JlCiAgICBAZXh0ZW5kcyBFbWJlci5TZXJ2aWNlCiAgKi8KCgogIHZhciBDb3JlU3RvcmUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0VtYmVyU2VydmljZSkgewogICAgX2luaGVyaXRzTG9vc2UkMyhDb3JlU3RvcmUsIF9FbWJlclNlcnZpY2UpOwoKICAgIC8qKgogICAgICogRW1iZXJEYXRhIHNwZWNpZmljIGJhY2tidXJuZXIgaW5zdGFuY2UKICAgICAqLwoKICAgIC8qCiAgICAgIEVtYmVyIERhdGEgdXNlcyBzZXZlcmFsIHNwZWNpYWxpemVkIG1pY3JvLXF1ZXVlcyBmb3Igb3JnYW5pemluZwogICAgICBhbmQgY29hbGVzY2luZyBzaW1pbGFyIGFzeW5jIHdvcmsuCiAgICAgICBUaGVzZSBxdWV1ZXMgYXJlIGN1cnJlbnRseSBjb250cm9sbGVkIGJ5IGEgZmx1c2ggc2NoZWR1bGVkIGludG8KICAgICAgZW1iZXItZGF0YSdzIGN1c3RvbSBiYWNrYnVybmVyIGluc3RhbmNlLgogICAgICAqLwogICAgLy8gdXNlZCBmb3IgY29hbGVzY2luZyByZWNvcmQgc2F2ZSByZXF1ZXN0cwogICAgLy8gdXNlZCBmb3IgY29hbGVzY2luZyByZWxhdGlvbnNoaXAgdXBkYXRlcwogICAgLy8gdXNlZCBmb3IgY29hbGVzY2luZyBpbnRlcm5hbCBtb2RlbCB1cGRhdGVzCiAgICAvLyB1c2VkIHRvIGtlZXAgdHJhY2sgb2YgYWxsIHRoZSBmaW5kIHJlcXVlc3RzIHRoYXQgbmVlZCB0byBiZSBjb2FsZXNjZWQKICAgIC8vIERFQlVHLW9ubHkgcHJvcGVydGllcwoKICAgIC8qKgogICAgICBUaGUgZGVmYXVsdCBhZGFwdGVyIHRvIHVzZSB0byBjb21tdW5pY2F0ZSB0byBhIGJhY2tlbmQgc2VydmVyIG9yCiAgICAgIG90aGVyIHBlcnNpc3RlbmNlIGxheWVyLiBUaGlzIHdpbGwgYmUgb3ZlcnJpZGRlbiBieSBhbiBhcHBsaWNhdGlvbgogICAgICBhZGFwdGVyIGlmIHByZXNlbnQuCiAgICAgICBJZiB5b3Ugd2FudCB0byBzcGVjaWZ5IGBhcHAvYWRhcHRlcnMvY3VzdG9tLmpzYCBhcyBhIHN0cmluZywgZG86CiAgICAgICBgYGBqcwogICAgICBpbXBvcnQgU3RvcmUgZnJvbSAnQGVtYmVyLWRhdGEvc3RvcmUnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgU3RvcmUuZXh0ZW5kKHsKICAgICAgICBpbml0KCkgewogICAgICAgICAgdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgICAgICAgIHRoaXMuYWRhcHRlciA9ICdjdXN0b20nOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQHByb3BlcnR5IGFkYXB0ZXIKICAgICAgQGRlZmF1bHQgJy1qc29uLWFwaScKICAgICAgQHR5cGUge1N0cmluZ30KICAgICovCgogICAgLyoqCiAgICBUaGlzIHByb3BlcnR5IHJldHVybnMgdGhlIGFkYXB0ZXIsIGFmdGVyIHJlc29sdmluZyBhIHBvc3NpYmxlCiAgICBzdHJpbmcga2V5LgogICAgIElmIHRoZSBzdXBwbGllZCBgYWRhcHRlcmAgd2FzIGEgY2xhc3MsIG9yIGEgU3RyaW5nIHByb3BlcnR5CiAgICBwYXRoIHJlc29sdmVkIHRvIGEgY2xhc3MsIHRoaXMgcHJvcGVydHkgd2lsbCBpbnN0YW50aWF0ZSB0aGUKICAgIGNsYXNzLgogICAgIFRoaXMgcHJvcGVydHkgaXMgY2FjaGVhYmxlLCBzbyB0aGUgc2FtZSBpbnN0YW5jZSBvZiBhIHNwZWNpZmllZAogICAgYWRhcHRlciBjbGFzcyBzaG91bGQgYmUgdXNlZCBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzdG9yZS4KICAgICBAcHJvcGVydHkgZGVmYXVsdEFkYXB0ZXIKICAgIEBwcml2YXRlCiAgICBAcmV0dXJuIEFkYXB0ZXIKICAgICovCgogICAgLyoqCiAgICAgIEBtZXRob2QgaW5pdAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGZ1bmN0aW9uIENvcmVTdG9yZSgpIHsKICAgICAgdmFyIF90aGlzOwoKICAgICAgX3RoaXMgPSBfRW1iZXJTZXJ2aWNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgICAgX3RoaXMuX2JhY2tidXJuZXIgPSBiYWNrYnVybmVyOwogICAgICBfdGhpcy5yZWNvcmRBcnJheU1hbmFnZXIgPSBuZXcgUmVjb3JkQXJyYXlNYW5hZ2VyKHsKICAgICAgICBzdG9yZTogX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcykKICAgICAgfSk7CiAgICAgIF90aGlzLl9ub3RpZmljYXRpb25NYW5hZ2VyID0gdm9pZCAwOwogICAgICBfdGhpcy5fYWRhcHRlckNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgX3RoaXMuX3NlcmlhbGl6ZXJDYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIF90aGlzLl9zdG9yZVdyYXBwZXIgPSBuZXcgUmVjb3JkRGF0YVN0b3JlV3JhcHBlcihfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSk7CiAgICAgIF90aGlzLl9wZW5kaW5nU2F2ZSA9IFtdOwogICAgICBfdGhpcy5fdXBkYXRlZFJlbGF0aW9uc2hpcHMgPSBbXTsKICAgICAgX3RoaXMuX3VwZGF0ZWRJbnRlcm5hbE1vZGVscyA9IFtdOwogICAgICBfdGhpcy5fcGVuZGluZ0ZldGNoID0gbmV3IE1hcCgpOwogICAgICBfdGhpcy5fZmV0Y2hNYW5hZ2VyID0gdm9pZCAwOwogICAgICBfdGhpcy5fc2NoZW1hRGVmaW5pdGlvblNlcnZpY2UgPSB2b2lkIDA7CiAgICAgIF90aGlzLl90cmFja2VkQXN5bmNSZXF1ZXN0cyA9IHZvaWQgMDsKICAgICAgX3RoaXMuc2hvdWxkQXNzZXJ0TWV0aG9kQ2FsbHNPbkRlc3Ryb3llZFN0b3JlID0gZmFsc2U7CiAgICAgIF90aGlzLnNob3VsZFRyYWNrQXN5bmNSZXF1ZXN0cyA9IGZhbHNlOwogICAgICBfdGhpcy5nZW5lcmF0ZVN0YWNrVHJhY2VzRm9yVHJhY2tlZFJlcXVlc3RzID0gZmFsc2U7CiAgICAgIF90aGlzLl90cmFja0FzeW5jUmVxdWVzdFN0YXJ0ID0gdm9pZCAwOwogICAgICBfdGhpcy5fdHJhY2tBc3luY1JlcXVlc3RFbmQgPSB2b2lkIDA7CiAgICAgIF90aGlzLl9fYXN5bmNXYWl0ZXIgPSB2b2lkIDA7CgogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuUkVRVUVTVF9TRVJWSUNFKSB7CiAgICAgICAgX3RoaXMuX2ZldGNoTWFuYWdlciA9IG5ldyBGZXRjaE1hbmFnZXIoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcykpOwogICAgICB9CgogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuQ1VTVE9NX01PREVMX0NMQVNTKSB7CiAgICAgICAgX3RoaXMuX25vdGlmaWNhdGlvbk1hbmFnZXIgPSBuZXcgTm90aWZpY2F0aW9uTWFuYWdlcihfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSk7CiAgICAgICAgX3RoaXMuX19yZWNvcmREYXRhRm9yID0gX3RoaXMuX19yZWNvcmREYXRhRm9yLmJpbmQoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcykpOwogICAgICB9CgogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgdmFyIF9wcm90byA9IENvcmVTdG9yZS5wcm90b3R5cGU7CgogICAgX3Byb3RvLmdldFJlcXVlc3RTdGF0ZVNlcnZpY2UgPSBmdW5jdGlvbiBnZXRSZXF1ZXN0U3RhdGVTZXJ2aWNlKCkgewogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuUkVRVUVTVF9TRVJWSUNFKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ZldGNoTWFuYWdlci5yZXF1ZXN0Q2FjaGU7CiAgICAgIH0KCiAgICAgIHRocm93IG5ldyBFcnJvcignUmVxdWVzdFNlcnZpY2UgaXMgbm90IGF2YWlsYWJsZSB1bmxlc3MgdGhlIGZlYXR1cmUgZmxhZyBpcyBvbiBhbmQgcnVubmluZyBvbiBhIGNhbmFyeSBidWlsZCcpOwogICAgfTsKCiAgICBfcHJvdG8uX2luc3RhbnRpYXRlUmVjb3JkID0gZnVuY3Rpb24gX2luc3RhbnRpYXRlUmVjb3JkKGludGVybmFsTW9kZWwsIG1vZGVsTmFtZSwgcmVjb3JkRGF0YSwgaWRlbnRpZmllciwgcHJvcGVydGllcykgewogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuQ1VTVE9NX01PREVMX0NMQVNTKSB7CiAgICAgICAgLy8gYXNzZXJ0IGhlcmUKICAgICAgICBpZiAocHJvcGVydGllcyAhPT0gdW5kZWZpbmVkKSB7CgogICAgICAgICAgaWYgKCdpZCcgaW4gcHJvcGVydGllcykgewogICAgICAgICAgICBpbnRlcm5hbE1vZGVsLnNldElkKHByb3BlcnRpZXMuaWQpOwogICAgICAgICAgfSAvLyBjb252ZXJ0IHJlbGF0aW9uc2hpcCBSZWNvcmRzIHRvIFJlY29yZERhdGFzIGJlZm9yZSBwYXNzaW5nIHRvIFJlY29yZERhdGEKCgogICAgICAgICAgdmFyIGRlZnMgPSB0aGlzLl9yZWxhdGlvbnNoaXBzRGVmaW5pdGlvbkZvcihtb2RlbE5hbWUpOwoKICAgICAgICAgIGlmIChkZWZzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMocHJvcGVydGllcyk7CiAgICAgICAgICAgIHZhciByZWxhdGlvbnNoaXBWYWx1ZTsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBwcm9wID0ga2V5c1tpXTsKICAgICAgICAgICAgICB2YXIgZGVmID0gZGVmc1twcm9wXTsKCiAgICAgICAgICAgICAgaWYgKGRlZiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVmLmtpbmQgPT09ICdoYXNNYW55JykgewoKICAgICAgICAgICAgICAgICAgcmVsYXRpb25zaGlwVmFsdWUgPSBleHRyYWN0UmVjb3JkRGF0YXNGcm9tUmVjb3Jkcyhwcm9wZXJ0aWVzW3Byb3BdKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJlbGF0aW9uc2hpcFZhbHVlID0gZXh0cmFjdFJlY29yZERhdGFGcm9tUmVjb3JkKHByb3BlcnRpZXNbcHJvcF0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHByb3BlcnRpZXNbcHJvcF0gPSByZWxhdGlvbnNoaXBWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IC8vIFRPRE8gZ3VhcmQgYWdhaW5zdCBpbml0UmVjb3JkT3B0aW9ucyBubyBiZWluZyB0aGVyZQoKCiAgICAgICAgdmFyIGNyZWF0ZU9wdGlvbnMgPSByZWNvcmREYXRhLl9pbml0UmVjb3JkQ3JlYXRlT3B0aW9ucyhwcm9wZXJ0aWVzKTsgLy9UT0RPIElnb3IgcGFzcyBhIHdyYXBwZXIgaW5zdGVhZCBvZiBSRAoKCiAgICAgICAgdmFyIF9yZWNvcmQgPSB0aGlzLmluc3RhbnRpYXRlUmVjb3JkKGlkZW50aWZpZXIsIGNyZWF0ZU9wdGlvbnMsIHRoaXMuX19yZWNvcmREYXRhRm9yLCB0aGlzLl9ub3RpZmljYXRpb25NYW5hZ2VyKTsKCiAgICAgICAgc2V0UmVjb3JkSWRlbnRpZmllcihfcmVjb3JkLCBpZGVudGlmaWVyKTsgLy9yZWNvcmRUb0ludGVybmFsTW9kZWxNYXAuc2V0KHJlY29yZCwgaW50ZXJuYWxNb2RlbCk7CgogICAgICAgIHJldHVybiBfcmVjb3JkOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignc2hvdWxkIG5vdCBiZSBoZXJlLCBjdXN0b20gbW9kZWwgY2xhc3MgZmYgZXJyb3InKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uX2ludGVybmFsRGVsZXRlUmVjb3JkID0gZnVuY3Rpb24gX2ludGVybmFsRGVsZXRlUmVjb3JkKGludGVybmFsTW9kZWwpIHsKICAgICAgaW50ZXJuYWxNb2RlbC5kZWxldGVSZWNvcmQoKTsKICAgIH0gLy8gRmVhdHVyZUZsYWdnZWQgaW4gdGhlIERTTW9kZWxTdG9yZSBjbGFhcwogICAgOwoKICAgIF9wcm90by5fYXR0cmlidXRlc0RlZmluaXRpb25Gb3IgPSBmdW5jdGlvbiBfYXR0cmlidXRlc0RlZmluaXRpb25Gb3IobW9kZWxOYW1lLCBpZGVudGlmaWVyKSB7CiAgICAgIGlmIChpZGVudGlmaWVyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2NoZW1hRGVmaW5pdGlvblNlcnZpY2UoKS5hdHRyaWJ1dGVzRGVmaW5pdGlvbkZvcihpZGVudGlmaWVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRTY2hlbWFEZWZpbml0aW9uU2VydmljZSgpLmF0dHJpYnV0ZXNEZWZpbml0aW9uRm9yKG1vZGVsTmFtZSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLl9yZWxhdGlvbnNoaXBzRGVmaW5pdGlvbkZvciA9IGZ1bmN0aW9uIF9yZWxhdGlvbnNoaXBzRGVmaW5pdGlvbkZvcihtb2RlbE5hbWUsIGlkZW50aWZpZXIpIHsKICAgICAgaWYgKGlkZW50aWZpZXIpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRTY2hlbWFEZWZpbml0aW9uU2VydmljZSgpLnJlbGF0aW9uc2hpcHNEZWZpbml0aW9uRm9yKGlkZW50aWZpZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmdldFNjaGVtYURlZmluaXRpb25TZXJ2aWNlKCkucmVsYXRpb25zaGlwc0RlZmluaXRpb25Gb3IobW9kZWxOYW1lKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8ucmVnaXN0ZXJTY2hlbWFEZWZpbml0aW9uU2VydmljZSA9IGZ1bmN0aW9uIHJlZ2lzdGVyU2NoZW1hRGVmaW5pdGlvblNlcnZpY2Uoc2NoZW1hKSB7CiAgICAgIHRoaXMuX3NjaGVtYURlZmluaXRpb25TZXJ2aWNlID0gc2NoZW1hOwogICAgfTsKCiAgICBfcHJvdG8uZ2V0U2NoZW1hRGVmaW5pdGlvblNlcnZpY2UgPSBmdW5jdGlvbiBnZXRTY2hlbWFEZWZpbml0aW9uU2VydmljZSgpIHsKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLkNVU1RPTV9NT0RFTF9DTEFTUykgewogICAgICAgIHJldHVybiB0aGlzLl9zY2hlbWFEZWZpbml0aW9uU2VydmljZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25lZWQgdG8gZW5hYmxlIENVU1RPTV9NT0RFTF9DTEFTUyBmZWF0dXJlIGZsYWcgaW4gb3JkZXIgdG8gYWNjZXNzIFNjaGVtYURlZmluaXRpb25TZXJ2aWNlJyk7CiAgICAgIH0KICAgIH0gLy8gVE9ETyBEb3VibGUgY2hlY2sgdGhpcyByZXR1cm4gdmFsdWUgaXMgY29ycmVjdAogICAgOwoKICAgIF9wcm90by5fcmVsYXRpb25zaGlwTWV0YUZvciA9IGZ1bmN0aW9uIF9yZWxhdGlvbnNoaXBNZXRhRm9yKG1vZGVsTmFtZSwgaWQsIGtleSkgewogICAgICByZXR1cm4gdGhpcy5fcmVsYXRpb25zaGlwc0RlZmluaXRpb25Gb3IobW9kZWxOYW1lKVtrZXldOwogICAgfTsKCiAgICBfcHJvdG8ubW9kZWxGb3IgPSBmdW5jdGlvbiBtb2RlbEZvcihtb2RlbE5hbWUpIHsKCiAgICAgIHJldHVybiBnZXRTaGltQ2xhc3ModGhpcywgbW9kZWxOYW1lKTsKICAgIH0gLy8gRmVhdHVyZSBGbGFnZ2VkIGluIERTTW9kZWxTdG9yZQoKICAgIC8qCiAgICBSZXR1cm5zIHdoZXRoZXIgYSBNb2RlbENsYXNzIGV4aXN0cyBmb3IgYSBnaXZlbiBtb2RlbE5hbWUKICAgIFRoaXMgZXhpc3RzIGZvciBsZWdhY3kgc3VwcG9ydCBmb3IgdGhlIFJFU1RTZXJpYWxpemVyLAogICAgd2hpY2ggZHVlIHRvIGhvdyBpdCBtdXN0IGd1ZXNzIHdoZXRoZXIgYSBrZXkgaXMgYSBtb2RlbAogICAgbXVzdCBxdWVyeSBmb3Igd2hldGhlciBhIG1hdGNoIGV4aXN0cy4KICAgICBXZSBzaG91bGQgaW52ZXN0aWdhdGUgYW4gUkZDIHRvIG1ha2UgdGhpcyBwdWJsaWMgb3IgcmVtb3ZpbmcKICAgIHRoaXMgcmVxdWlyZW1lbnQuCiAgICAgQHByaXZhdGUKICAgICovCiAgICA7CgogICAgX3Byb3RvLl9oYXNNb2RlbEZvciA9IGZ1bmN0aW9uIF9oYXNNb2RlbEZvcihtb2RlbE5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0U2NoZW1hRGVmaW5pdGlvblNlcnZpY2UoKS5kb2VzVHlwZUV4aXN0KG1vZGVsTmFtZSk7CiAgICB9IC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLgogICAgLy8gLiBDUkVBVEUgTkVXIFJFQ09SRCAuCiAgICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4KCiAgICAvKioKICAgICAgQ3JlYXRlIGEgbmV3IHJlY29yZCBpbiB0aGUgY3VycmVudCBzdG9yZS4gVGhlIHByb3BlcnRpZXMgcGFzc2VkCiAgICAgIHRvIHRoaXMgbWV0aG9kIGFyZSBzZXQgb24gdGhlIG5ld2x5IGNyZWF0ZWQgcmVjb3JkLgogICAgICAgVG8gY3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgYFBvc3RgOgogICAgICAgYGBganMKICAgICAgc3RvcmUuY3JlYXRlUmVjb3JkKCdwb3N0JywgewogICAgICAgIHRpdGxlOiAnRW1iZXIgaXMgYXdlc29tZSEnCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFRvIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIGBQb3N0YCB0aGF0IGhhcyBhIHJlbGF0aW9uc2hpcCB3aXRoIGEgYFVzZXJgIHJlY29yZDoKICAgICAgIGBgYGpzCiAgICAgIGxldCB1c2VyID0gdGhpcy5zdG9yZS5wZWVrUmVjb3JkKCd1c2VyJywgMSk7CiAgICAgIHN0b3JlLmNyZWF0ZVJlY29yZCgncG9zdCcsIHsKICAgICAgICB0aXRsZTogJ0VtYmVyIGlzIGF3ZXNvbWUhJywKICAgICAgICB1c2VyOiB1c2VyCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgY3JlYXRlUmVjb3JkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgICAgQHBhcmFtIHtPYmplY3R9IGlucHV0UHJvcGVydGllcyBhIGhhc2ggb2YgcHJvcGVydGllcyB0byBzZXQgb24gdGhlCiAgICAgICAgbmV3bHkgY3JlYXRlZCByZWNvcmQuCiAgICAgIEByZXR1cm4ge01vZGVsfSByZWNvcmQKICAgICovCiAgICA7CgogICAgX3Byb3RvLmNyZWF0ZVJlY29yZCA9IGZ1bmN0aW9uIGNyZWF0ZVJlY29yZChtb2RlbE5hbWUsIGlucHV0UHJvcGVydGllcykgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKICAgICAgLy8gICBjYWxscyB0byBgY3JlYXRlUmVjb3JkYC4gVGhlIHJ1biBsb29wIHVzYWdlIGhlcmUgaXMgYmVjYXVzZSB3ZSBiYXRjaCB0aGUgam9pbmluZyBhbmQgdXBkYXRpbmcKICAgICAgLy8gICBvZiByZWNvcmQtYXJyYXlzIHZpYSBlbWJlcidzIHJ1biBsb29wLCBub3Qgb3VyIG93bi4KICAgICAgLy8KICAgICAgLy8gICB0byByZW1vdmUgdGhpcywgd2Ugd291bGQgbmVlZCB0byBtb3ZlIHRvIGEgbmV3IGBhc3luY2AgQVBJLgoKICAgICAgcmV0dXJuIGVtYmVyUnVuJDIuam9pbihmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIF90aGlzMi5fYmFja2J1cm5lci5qb2luKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBub3JtYWxpemVkTW9kZWxOYW1lID0gbm9ybWFsaXplTW9kZWxOYW1lKG1vZGVsTmFtZSk7CiAgICAgICAgICB2YXIgcHJvcGVydGllcyA9IEVtYmVyLmFzc2lnbih7fSwgaW5wdXRQcm9wZXJ0aWVzKTsgLy8gSWYgdGhlIHBhc3NlZCBwcm9wZXJ0aWVzIGRvIG5vdCBpbmNsdWRlIGEgcHJpbWFyeSBrZXksCiAgICAgICAgICAvLyBnaXZlIHRoZSBhZGFwdGVyIGFuIG9wcG9ydHVuaXR5IHRvIGdlbmVyYXRlIG9uZS4gVHlwaWNhbGx5LAogICAgICAgICAgLy8gY2xpZW50LXNpZGUgSUQgZ2VuZXJhdG9ycyB3aWxsIHVzZSBzb21ldGhpbmcgbGlrZSB1dWlkLmpzCiAgICAgICAgICAvLyB0byBhdm9pZCBjb25mbGljdHMuCgogICAgICAgICAgaWYgKEVtYmVyLmlzTm9uZShwcm9wZXJ0aWVzLmlkKSkgewogICAgICAgICAgICBwcm9wZXJ0aWVzLmlkID0gX3RoaXMyLl9nZW5lcmF0ZUlkKG5vcm1hbGl6ZWRNb2RlbE5hbWUsIHByb3BlcnRpZXMpOwogICAgICAgICAgfSAvLyBDb2VyY2UgSUQgdG8gYSBzdHJpbmcKCgogICAgICAgICAgcHJvcGVydGllcy5pZCA9IGNvZXJjZUlkKHByb3BlcnRpZXMuaWQpOwogICAgICAgICAgdmFyIGZhY3RvcnkgPSBpbnRlcm5hbE1vZGVsRmFjdG9yeUZvcihfdGhpczIpOwogICAgICAgICAgdmFyIGludGVybmFsTW9kZWwgPSBmYWN0b3J5LmJ1aWxkKHsKICAgICAgICAgICAgdHlwZTogbm9ybWFsaXplZE1vZGVsTmFtZSwKICAgICAgICAgICAgaWQ6IHByb3BlcnRpZXMuaWQKICAgICAgICAgIH0pOwogICAgICAgICAgaW50ZXJuYWxNb2RlbC5sb2FkZWREYXRhKCk7IC8vIFRPRE8gdGhpcyBleGlzdHMganVzdCB0byBwcm94eSBgaXNOZXdgIHRvIFJlY29yZERhdGEgd2hpY2ggaXMgd2VpcmQKCiAgICAgICAgICBpbnRlcm5hbE1vZGVsLmRpZENyZWF0ZVJlY29yZCgpOwogICAgICAgICAgcmV0dXJuIGludGVybmFsTW9kZWwuZ2V0UmVjb3JkKHByb3BlcnRpZXMpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICAgIC8qKgogICAgICBJZiBwb3NzaWJsZSwgdGhpcyBtZXRob2QgYXNrcyB0aGUgYWRhcHRlciB0byBnZW5lcmF0ZSBhbiBJRCBmb3IKICAgICAgYSBuZXdseSBjcmVhdGVkIHJlY29yZC4KICAgICAgIEBtZXRob2QgX2dlbmVyYXRlSWQKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgICBAcGFyYW0ge09iamVjdH0gcHJvcGVydGllcyBmcm9tIHRoZSBuZXcgcmVjb3JkCiAgICAgIEByZXR1cm4ge1N0cmluZ30gaWYgdGhlIGFkYXB0ZXIgY2FuIGdlbmVyYXRlIG9uZSwgYW4gSUQKICAgICovCiAgICA7CgogICAgX3Byb3RvLl9nZW5lcmF0ZUlkID0gZnVuY3Rpb24gX2dlbmVyYXRlSWQobW9kZWxOYW1lLCBwcm9wZXJ0aWVzKSB7CiAgICAgIHZhciBhZGFwdGVyID0gdGhpcy5hZGFwdGVyRm9yKG1vZGVsTmFtZSk7CgogICAgICBpZiAoYWRhcHRlciAmJiBhZGFwdGVyLmdlbmVyYXRlSWRGb3JSZWNvcmQpIHsKICAgICAgICByZXR1cm4gYWRhcHRlci5nZW5lcmF0ZUlkRm9yUmVjb3JkKHRoaXMsIG1vZGVsTmFtZSwgcHJvcGVydGllcyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBudWxsOwogICAgfSAvLyAuLi4uLi4uLi4uLi4uLi4uLgogICAgLy8gLiBERUxFVEUgUkVDT1JEIC4KICAgIC8vIC4uLi4uLi4uLi4uLi4uLi4uCgogICAgLyoqCiAgICAgIEZvciBzeW1tZXRyeSwgYSByZWNvcmQgY2FuIGJlIGRlbGV0ZWQgdmlhIHRoZSBzdG9yZS4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgbGV0IHBvc3QgPSBzdG9yZS5jcmVhdGVSZWNvcmQoJ3Bvc3QnLCB7CiAgICAgICAgdGl0bGU6ICdFbWJlciBpcyBhd2Vzb21lIScKICAgICAgfSk7CiAgICAgICBzdG9yZS5kZWxldGVSZWNvcmQocG9zdCk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBkZWxldGVSZWNvcmQKICAgICAgQHBhcmFtIHtNb2RlbH0gcmVjb3JkCiAgICAqLwogICAgOwoKICAgIF9wcm90by5kZWxldGVSZWNvcmQgPSBmdW5jdGlvbiBkZWxldGVSZWNvcmQocmVjb3JkKSB7CgogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuQ1VTVE9NX01PREVMX0NMQVNTKSB7CiAgICAgICAgaWYgKEhBU19NT0RFTF9QQUNLQUdFICYmIHJlY29yZCBpbnN0YW5jZW9mIGdldE1vZGVsKCkpIHsKICAgICAgICAgIHJldHVybiByZWNvcmQuZGVsZXRlUmVjb3JkKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBfaWRlbnRpZmllciA9IHJlY29yZElkZW50aWZpZXJGb3IocmVjb3JkKTsKCiAgICAgICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IGludGVybmFsTW9kZWxGYWN0b3J5Rm9yKHRoaXMpLnBlZWsoX2lkZW50aWZpZXIpOwogICAgICAgICAgaW50ZXJuYWxNb2RlbC5kZWxldGVSZWNvcmQoKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVjb3JkLmRlbGV0ZVJlY29yZCgpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAgRm9yIHN5bW1ldHJ5LCBhIHJlY29yZCBjYW4gYmUgdW5sb2FkZWQgdmlhIHRoZSBzdG9yZS4KICAgICAgVGhpcyB3aWxsIGNhdXNlIHRoZSByZWNvcmQgdG8gYmUgZGVzdHJveWVkIGFuZCBmcmVlZCB1cCBmb3IgZ2FyYmFnZSBjb2xsZWN0aW9uLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBzdG9yZS5maW5kUmVjb3JkKCdwb3N0JywgMSkudGhlbihmdW5jdGlvbihwb3N0KSB7CiAgICAgICAgc3RvcmUudW5sb2FkUmVjb3JkKHBvc3QpOwogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHVubG9hZFJlY29yZAogICAgICBAcGFyYW0ge01vZGVsfSByZWNvcmQKICAgICovCiAgICA7CgogICAgX3Byb3RvLnVubG9hZFJlY29yZCA9IGZ1bmN0aW9uIHVubG9hZFJlY29yZChyZWNvcmQpIHsKCiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MpIHsKICAgICAgICBpZiAoSEFTX01PREVMX1BBQ0tBR0UgJiYgcmVjb3JkIGluc3RhbmNlb2YgZ2V0TW9kZWwoKSkgewogICAgICAgICAgcmV0dXJuIHJlY29yZC51bmxvYWRSZWNvcmQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIF9pZGVudGlmaWVyMiA9IHJlY29yZElkZW50aWZpZXJGb3IocmVjb3JkKTsKCiAgICAgICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IGludGVybmFsTW9kZWxGYWN0b3J5Rm9yKHRoaXMpLnBlZWsoX2lkZW50aWZpZXIyKTsKICAgICAgICAgIGludGVybmFsTW9kZWwudW5sb2FkUmVjb3JkKCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJlY29yZC51bmxvYWRSZWNvcmQoKTsKICAgICAgfQogICAgfSAvLyAuLi4uLi4uLi4uLi4uLi4uCiAgICAvLyAuIEZJTkQgUkVDT1JEUyAuCiAgICAvLyAuLi4uLi4uLi4uLi4uLi4uCgogICAgLyoqCiAgICAgIEBtZXRob2QgZmluZAogICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICAgIEBwYXJhbSB7U3RyaW5nfEludGVnZXJ9IGlkCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICAgQHByaXZhdGUKICAgICovCiAgICA7CgogICAgX3Byb3RvLmZpbmQgPSBmdW5jdGlvbiBmaW5kKG1vZGVsTmFtZSwgaWQsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuZmluZFJlY29yZChtb2RlbE5hbWUsIGlkKTsKICAgIH0KICAgIC8qKgogICAgICBUaGlzIG1ldGhvZCByZXR1cm5zIGEgcmVjb3JkIGZvciBhIGdpdmVuIHR5cGUgYW5kIGlkIGNvbWJpbmF0aW9uLgogICAgICAgVGhlIGBmaW5kUmVjb3JkYCBtZXRob2Qgd2lsbCBhbHdheXMgcmVzb2x2ZSBpdHMgcHJvbWlzZSB3aXRoIHRoZSBzYW1lCiAgICAgIG9iamVjdCBmb3IgYSBnaXZlbiB0eXBlIGFuZCBgaWRgLgogICAgICAgVGhlIGBmaW5kUmVjb3JkYCBtZXRob2Qgd2lsbCBhbHdheXMgcmV0dXJuIGEgKipwcm9taXNlKiogdGhhdCB3aWxsIGJlCiAgICAgIHJlc29sdmVkIHdpdGggdGhlIHJlY29yZC4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9yb3V0ZXMvcG9zdC5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgICBtb2RlbChwYXJhbXMpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnN0b3JlLmZpbmRSZWNvcmQoJ3Bvc3QnLCBwYXJhbXMucG9zdF9pZCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBJZiB0aGUgcmVjb3JkIGlzIG5vdCB5ZXQgYXZhaWxhYmxlLCB0aGUgc3RvcmUgd2lsbCBhc2sgdGhlIGFkYXB0ZXIncyBgZmluZGAKICAgICAgbWV0aG9kIHRvIGZpbmQgdGhlIG5lY2Vzc2FyeSBkYXRhLiBJZiB0aGUgcmVjb3JkIGlzIGFscmVhZHkgcHJlc2VudCBpbiB0aGUKICAgICAgc3RvcmUsIGl0IGRlcGVuZHMgb24gdGhlIHJlbG9hZCBiZWhhdmlvciBfd2hlbl8gdGhlIHJldHVybmVkIHByb21pc2UKICAgICAgcmVzb2x2ZXMuCiAgICAgICAjIyMgUHJlbG9hZGluZwogICAgICAgWW91IGNhbiBvcHRpb25hbGx5IGBwcmVsb2FkYCBzcGVjaWZpYyBhdHRyaWJ1dGVzIGFuZCByZWxhdGlvbnNoaXBzIHRoYXQgeW91IGtub3cgb2YKICAgICAgYnkgcGFzc2luZyB0aGVtIHZpYSB0aGUgcGFzc2VkIGBvcHRpb25zYC4KICAgICAgIEZvciBleGFtcGxlLCBpZiB5b3VyIEVtYmVyIHJvdXRlIGxvb2tzIGxpa2UgYC9wb3N0cy8xL2NvbW1lbnRzLzJgIGFuZCB5b3VyIEFQSSByb3V0ZQogICAgICBmb3IgdGhlIGNvbW1lbnQgYWxzbyBsb29rcyBsaWtlIGAvcG9zdHMvMS9jb21tZW50cy8yYCBpZiB5b3Ugd2FudCB0byBmZXRjaCB0aGUgY29tbWVudAogICAgICB3aXRob3V0IGZldGNoaW5nIHRoZSBwb3N0IHlvdSBjYW4gcGFzcyBpbiB0aGUgcG9zdCB0byB0aGUgYGZpbmRSZWNvcmRgIGNhbGw6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHN0b3JlLmZpbmRSZWNvcmQoJ2NvbW1lbnQnLCAyLCB7IHByZWxvYWQ6IHsgcG9zdDogMSB9IH0pOwogICAgICBgYGAKICAgICAgIElmIHlvdSBoYXZlIGFjY2VzcyB0byB0aGUgcG9zdCBtb2RlbCB5b3UgY2FuIGFsc28gcGFzcyB0aGUgbW9kZWwgaXRzZWxmOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBzdG9yZS5maW5kUmVjb3JkKCdwb3N0JywgMSkudGhlbihmdW5jdGlvbiAobXlQb3N0TW9kZWwpIHsKICAgICAgICBzdG9yZS5maW5kUmVjb3JkKCdjb21tZW50JywgMiwgeyBwb3N0OiBteVBvc3RNb2RlbCB9KTsKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgIyMjIFJlbG9hZGluZwogICAgICAgVGhlIHJlbG9hZCBiZWhhdmlvciBpcyBjb25maWd1cmVkIGVpdGhlciB2aWEgdGhlIHBhc3NlZCBgb3B0aW9uc2AgaGFzaCBvcgogICAgICB0aGUgcmVzdWx0IG9mIHRoZSBhZGFwdGVyJ3MgYHNob3VsZFJlbG9hZFJlY29yZGAuCiAgICAgICBJZiBgeyByZWxvYWQ6IHRydWUgfWAgaXMgcGFzc2VkIG9yIGBhZGFwdGVyLnNob3VsZFJlbG9hZFJlY29yZGAgZXZhbHVhdGVzCiAgICAgIHRvIGB0cnVlYCwgdGhlbiB0aGUgcmV0dXJuZWQgcHJvbWlzZSByZXNvbHZlcyBvbmNlIHRoZSBhZGFwdGVyIHJldHVybnMKICAgICAgZGF0YSwgcmVnYXJkbGVzcyBpZiB0aGUgcmVxdWVzdGVkIHJlY29yZCBpcyBhbHJlYWR5IGluIHRoZSBzdG9yZToKICAgICAgIGBgYGpzCiAgICAgIHN0b3JlLnB1c2goewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIGlkOiAxLAogICAgICAgICAgdHlwZTogJ3Bvc3QnLAogICAgICAgICAgcmV2aXNpb246IDEKICAgICAgICB9CiAgICAgIH0pOwogICAgICAgLy8gYWRhcHRlciNmaW5kUmVjb3JkIHJlc29sdmVzIHdpdGgKICAgICAgLy8gWwogICAgICAvLyAgIHsKICAgICAgLy8gICAgIGlkOiAxLAogICAgICAvLyAgICAgdHlwZTogJ3Bvc3QnLAogICAgICAvLyAgICAgcmV2aXNpb246IDIKICAgICAgLy8gICB9CiAgICAgIC8vIF0KICAgICAgc3RvcmUuZmluZFJlY29yZCgncG9zdCcsIDEsIHsgcmVsb2FkOiB0cnVlIH0pLnRoZW4oZnVuY3Rpb24ocG9zdCkgewogICAgICAgIHBvc3QuZ2V0KCdyZXZpc2lvbicpOyAvLyAyCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIElmIG5vIHJlbG9hZCBpcyBpbmRpY2F0ZWQgdmlhIHRoZSBhYm92ZSBtZW50aW9uZWQgd2F5cywgdGhlbiB0aGUgcHJvbWlzZQogICAgICBpbW1lZGlhdGVseSByZXNvbHZlcyB3aXRoIHRoZSBjYWNoZWQgdmVyc2lvbiBpbiB0aGUgc3RvcmUuCiAgICAgICAjIyMgQmFja2dyb3VuZCBSZWxvYWRpbmcKICAgICAgIE9wdGlvbmFsbHksIGlmIGBhZGFwdGVyLnNob3VsZEJhY2tncm91bmRSZWxvYWRSZWNvcmRgIGV2YWx1YXRlcyB0byBgdHJ1ZWAsCiAgICAgIHRoZW4gYSBiYWNrZ3JvdW5kIHJlbG9hZCBpcyBzdGFydGVkLCB3aGljaCB1cGRhdGVzIHRoZSByZWNvcmRzJyBkYXRhLCBvbmNlCiAgICAgIGl0IGlzIGF2YWlsYWJsZToKICAgICAgIGBgYGpzCiAgICAgIC8vIGFwcC9hZGFwdGVycy9wb3N0LmpzCiAgICAgIGltcG9ydCBBcHBsaWNhdGlvbkFkYXB0ZXIgZnJvbSAiLi9hcHBsaWNhdGlvbiI7CiAgICAgICBleHBvcnQgZGVmYXVsdCBBcHBsaWNhdGlvbkFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICBzaG91bGRSZWxvYWRSZWNvcmQoc3RvcmUsIHNuYXBzaG90KSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICAgc2hvdWxkQmFja2dyb3VuZFJlbG9hZFJlY29yZChzdG9yZSwgc25hcHNob3QpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgICAvLyAuLi4KICAgICAgIHN0b3JlLnB1c2goewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIGlkOiAxLAogICAgICAgICAgdHlwZTogJ3Bvc3QnLAogICAgICAgICAgcmV2aXNpb246IDEKICAgICAgICB9CiAgICAgIH0pOwogICAgICAgbGV0IGJsb2dQb3N0ID0gc3RvcmUuZmluZFJlY29yZCgncG9zdCcsIDEpLnRoZW4oZnVuY3Rpb24ocG9zdCkgewogICAgICAgIHBvc3QuZ2V0KCdyZXZpc2lvbicpOyAvLyAxCiAgICAgIH0pOwogICAgICAgLy8gbGF0ZXIsIG9uY2UgYWRhcHRlciNmaW5kUmVjb3JkIHJlc29sdmVkIHdpdGgKICAgICAgLy8gWwogICAgICAvLyAgIHsKICAgICAgLy8gICAgIGlkOiAxLAogICAgICAvLyAgICAgdHlwZTogJ3Bvc3QnLAogICAgICAvLyAgICAgcmV2aXNpb246IDIKICAgICAgLy8gICB9CiAgICAgIC8vIF0KICAgICAgIGJsb2dQb3N0LmdldCgncmV2aXNpb24nKTsgLy8gMgogICAgICBgYGAKICAgICAgIElmIHlvdSB3b3VsZCBsaWtlIHRvIGZvcmNlIG9yIHByZXZlbnQgYmFja2dyb3VuZCByZWxvYWRpbmcsIHlvdSBjYW4gc2V0IGEKICAgICAgYm9vbGVhbiB2YWx1ZSBmb3IgYGJhY2tncm91bmRSZWxvYWRgIGluIHRoZSBvcHRpb25zIG9iamVjdCBmb3IKICAgICAgYGZpbmRSZWNvcmRgLgogICAgICAgYGBgYXBwL3JvdXRlcy9wb3N0L2VkaXQuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgICAgbW9kZWwocGFyYW1zKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5zdG9yZS5maW5kUmVjb3JkKCdwb3N0JywgcGFyYW1zLnBvc3RfaWQsIHsgYmFja2dyb3VuZFJlbG9hZDogZmFsc2UgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBJZiB5b3UgcGFzcyBhbiBvYmplY3Qgb24gdGhlIGBhZGFwdGVyT3B0aW9uc2AgcHJvcGVydHkgb2YgdGhlIG9wdGlvbnMKICAgICAgYXJndW1lbnQgaXQgd2lsbCBiZSBwYXNzZWQgdG8geW91IGFkYXB0ZXIgdmlhIHRoZSBzbmFwc2hvdAogICAgICAgYGBgYXBwL3JvdXRlcy9wb3N0L2VkaXQuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgICAgbW9kZWwocGFyYW1zKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5zdG9yZS5maW5kUmVjb3JkKCdwb3N0JywgcGFyYW1zLnBvc3RfaWQsIHsKICAgICAgICAgICAgYWRhcHRlck9wdGlvbnM6IHsgc3Vic2NyaWJlOiBmYWxzZSB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIGBgYGFwcC9hZGFwdGVycy9wb3N0LmpzCiAgICAgIGltcG9ydCBNeUN1c3RvbUFkYXB0ZXIgZnJvbSAnLi9jdXN0b20tYWRhcHRlcic7CiAgICAgICBleHBvcnQgZGVmYXVsdCBNeUN1c3RvbUFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICBmaW5kUmVjb3JkKHN0b3JlLCB0eXBlLCBpZCwgc25hcHNob3QpIHsKICAgICAgICAgIGlmIChzbmFwc2hvdC5hZGFwdGVyT3B0aW9ucy5zdWJzY3JpYmUpIHsKICAgICAgICAgICAgLy8gLi4uCiAgICAgICAgICB9CiAgICAgICAgICAvLyAuLi4KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFNlZSBbcGVla1JlY29yZF0oU3RvcmUvbWV0aG9kcy9wZWVrUmVjb3JkP2FuY2hvcj1wZWVrUmVjb3JkKSB0byBnZXQgdGhlIGNhY2hlZCB2ZXJzaW9uIG9mIGEgcmVjb3JkLgogICAgICAgIyMjIFJldHJpZXZpbmcgUmVsYXRlZCBNb2RlbCBSZWNvcmRzCiAgICAgICBJZiB5b3UgdXNlIGFuIGFkYXB0ZXIgc3VjaCBhcyBFbWJlcidzIGRlZmF1bHQKICAgICAgW2BKU09OQVBJQWRhcHRlcmBdKC9lbWJlci1kYXRhL3JlbGVhc2UvY2xhc3Nlcy9KU09OQVBJQWRhcHRlcikKICAgICAgdGhhdCBzdXBwb3J0cyB0aGUgW0pTT04gQVBJIHNwZWNpZmljYXRpb25dKGh0dHA6Ly9qc29uYXBpLm9yZy8pIGFuZCBpZiB5b3VyIHNlcnZlcgogICAgICBlbmRwb2ludCBzdXBwb3J0cyB0aGUgdXNlIG9mIGFuCiAgICAgIFsnaW5jbHVkZScgcXVlcnkgcGFyYW1ldGVyXShodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0LyNmZXRjaGluZy1pbmNsdWRlcyksCiAgICAgIHlvdSBjYW4gdXNlIGBmaW5kUmVjb3JkKClgIHRvIGF1dG9tYXRpY2FsbHkgcmV0cmlldmUgYWRkaXRpb25hbCByZWNvcmRzIHJlbGF0ZWQgdG8KICAgICAgdGhlIG9uZSB5b3UgcmVxdWVzdCBieSBzdXBwbHlpbmcgYW4gYGluY2x1ZGVgIHBhcmFtZXRlciBpbiB0aGUgYG9wdGlvbnNgIG9iamVjdC4KICAgICAgIEZvciBleGFtcGxlLCBnaXZlbiBhIGBwb3N0YCBtb2RlbCB0aGF0IGhhcyBhIGBoYXNNYW55YCByZWxhdGlvbnNoaXAgd2l0aCBhIGBjb21tZW50YAogICAgICBtb2RlbCwgd2hlbiB3ZSByZXRyaWV2ZSBhIHNwZWNpZmljIHBvc3Qgd2UgY2FuIGhhdmUgdGhlIHNlcnZlciBhbHNvIHJldHVybiB0aGF0IHBvc3QncwogICAgICBjb21tZW50cyBpbiB0aGUgc2FtZSByZXF1ZXN0OgogICAgICAgYGBgYXBwL3JvdXRlcy9wb3N0LmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoewogICAgICAgIG1vZGVsKHBhcmFtcykgewogICAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmUuZmluZFJlY29yZCgncG9zdCcsIHBhcmFtcy5wb3N0X2lkLCB7IGluY2x1ZGU6ICdjb21tZW50cycgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgIGBgYAogICAgICBJbiB0aGlzIGNhc2UsIHRoZSBwb3N0J3MgY29tbWVudHMgd291bGQgdGhlbiBiZSBhdmFpbGFibGUgaW4geW91ciB0ZW1wbGF0ZSBhcwogICAgICBgbW9kZWwuY29tbWVudHNgLgogICAgICAgTXVsdGlwbGUgcmVsYXRpb25zaGlwcyBjYW4gYmUgcmVxdWVzdGVkIHVzaW5nIGFuIGBpbmNsdWRlYCBwYXJhbWV0ZXIgY29uc2lzdGluZyBvZiBhCiAgICAgIGNvbW1hLXNlcGFyYXRlZCBsaXN0ICh3aXRob3V0IHdoaXRlLXNwYWNlKSB3aGlsZSBuZXN0ZWQgcmVsYXRpb25zaGlwcyBjYW4gYmUgc3BlY2lmaWVkCiAgICAgIHVzaW5nIGEgZG90LXNlcGFyYXRlZCBzZXF1ZW5jZSBvZiByZWxhdGlvbnNoaXAgbmFtZXMuIFNvIHRvIHJlcXVlc3QgYm90aCB0aGUgcG9zdCdzCiAgICAgIGNvbW1lbnRzIGFuZCB0aGUgYXV0aG9ycyBvZiB0aG9zZSBjb21tZW50cyB0aGUgcmVxdWVzdCB3b3VsZCBsb29rIGxpa2UgdGhpczoKICAgICAgIGBgYGFwcC9yb3V0ZXMvcG9zdC5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgICBtb2RlbChwYXJhbXMpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnN0b3JlLmZpbmRSZWNvcmQoJ3Bvc3QnLCBwYXJhbXMucG9zdF9pZCwgeyBpbmNsdWRlOiAnY29tbWVudHMsY29tbWVudHMuYXV0aG9yJyB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAgYGBgCiAgICAgICBAc2luY2UgMS4xMy4wCiAgICAgIEBtZXRob2QgZmluZFJlY29yZAogICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICAgIEBwYXJhbSB7KFN0cmluZ3xJbnRlZ2VyKX0gaWQKICAgICAgQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXQogICAgICBAcGFyYW0ge09iamVjdH0gcHJlbG9hZCAtIG9wdGlvbmFsIHNldCBvZiBhdHRyaWJ1dGVzIGFuZCByZWxhdGlvbnNoaXBzIHBhc3NlZCBpbiBlaXRoZXIgYXMgSURzIG9yIGFzIGFjdHVhbCBtb2RlbHMKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uZmluZFJlY29yZCA9IGZ1bmN0aW9uIGZpbmRSZWNvcmQobW9kZWxOYW1lLCBpZCwgb3B0aW9ucykgewogICAgICB2YXIgdHlwZSA9IG5vcm1hbGl6ZU1vZGVsTmFtZShtb2RlbE5hbWUpOwogICAgICB2YXIgbm9ybWFsaXplZElkID0gZW5zdXJlU3RyaW5nSWQoaWQpOwogICAgICB2YXIgcmVzb3VyY2UgPSBjb25zdHJ1Y3RSZXNvdXJjZSh0eXBlLCBub3JtYWxpemVkSWQpOwogICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IGludGVybmFsTW9kZWxGYWN0b3J5Rm9yKHRoaXMpLmxvb2t1cChyZXNvdXJjZSk7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgaWYgKCF0aGlzLmhhc1JlY29yZEZvcklkKHR5cGUsIG5vcm1hbGl6ZWRJZCkpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZmluZEJ5SW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsLCBvcHRpb25zKTsKICAgICAgfQoKICAgICAgdmFyIGZldGNoZWRJbnRlcm5hbE1vZGVsID0gdGhpcy5fZmluZFJlY29yZChpbnRlcm5hbE1vZGVsLCBvcHRpb25zKTsKCiAgICAgIHJldHVybiBwcm9taXNlUmVjb3JkKGZldGNoZWRJbnRlcm5hbE1vZGVsLCAiRFM6IFN0b3JlI2ZpbmRSZWNvcmQgIiArIHR5cGUgKyAiIHdpdGggaWQ6ICIgKyBpZCk7CiAgICB9OwoKICAgIF9wcm90by5fZmluZFJlY29yZCA9IGZ1bmN0aW9uIF9maW5kUmVjb3JkKGludGVybmFsTW9kZWwsIG9wdGlvbnMpIHsKICAgICAgLy8gUmVmZXRjaCBpZiB0aGUgcmVsb2FkIG9wdGlvbiBpcyBwYXNzZWQKICAgICAgaWYgKG9wdGlvbnMucmVsb2FkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3NjaGVkdWxlRmV0Y2goaW50ZXJuYWxNb2RlbCwgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIHZhciBzbmFwc2hvdCA9IGludGVybmFsTW9kZWwuY3JlYXRlU25hcHNob3Qob3B0aW9ucyk7CiAgICAgIHZhciBhZGFwdGVyID0gdGhpcy5hZGFwdGVyRm9yKGludGVybmFsTW9kZWwubW9kZWxOYW1lKTsgLy8gUmVmZXRjaCB0aGUgcmVjb3JkIGlmIHRoZSBhZGFwdGVyIHRoaW5rcyB0aGUgcmVjb3JkIGlzIHN0YWxlCgogICAgICBpZiAoYWRhcHRlci5zaG91bGRSZWxvYWRSZWNvcmQodGhpcywgc25hcHNob3QpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3NjaGVkdWxlRmV0Y2goaW50ZXJuYWxNb2RlbCwgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLmJhY2tncm91bmRSZWxvYWQgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuIEVtYmVyLlJTVlAuUHJvbWlzZS5yZXNvbHZlKGludGVybmFsTW9kZWwpOwogICAgICB9IC8vIFRyaWdnZXIgdGhlIGJhY2tncm91bmQgcmVmZXRjaCBpZiBiYWNrZ3JvdW5kUmVsb2FkIG9wdGlvbiBpcyBwYXNzZWQKCgogICAgICBpZiAob3B0aW9ucy5iYWNrZ3JvdW5kUmVsb2FkIHx8IGFkYXB0ZXIuc2hvdWxkQmFja2dyb3VuZFJlbG9hZFJlY29yZCh0aGlzLCBzbmFwc2hvdCkpIHsKICAgICAgICB0aGlzLl9zY2hlZHVsZUZldGNoKGludGVybmFsTW9kZWwsIG9wdGlvbnMpOwogICAgICB9IC8vIFJldHVybiB0aGUgY2FjaGVkIHJlY29yZAoKCiAgICAgIHJldHVybiBFbWJlci5SU1ZQLlByb21pc2UucmVzb2x2ZShpbnRlcm5hbE1vZGVsKTsKICAgIH07CgogICAgX3Byb3RvLl9maW5kQnlJbnRlcm5hbE1vZGVsID0gZnVuY3Rpb24gX2ZpbmRCeUludGVybmFsTW9kZWwoaW50ZXJuYWxNb2RlbCwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy5wcmVsb2FkKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC5wcmVsb2FkRGF0YShvcHRpb25zLnByZWxvYWQpOwogICAgICB9CgogICAgICB2YXIgZmV0Y2hlZEludGVybmFsTW9kZWwgPSB0aGlzLl9maW5kRW1wdHlJbnRlcm5hbE1vZGVsKGludGVybmFsTW9kZWwsIG9wdGlvbnMpOwoKICAgICAgcmV0dXJuIHByb21pc2VSZWNvcmQoZmV0Y2hlZEludGVybmFsTW9kZWwsICJEUzogU3RvcmUjZmluZFJlY29yZCAiICsgaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWUgKyAiIHdpdGggaWQ6ICIgKyBpbnRlcm5hbE1vZGVsLmlkKTsKICAgIH07CgogICAgX3Byb3RvLl9maW5kRW1wdHlJbnRlcm5hbE1vZGVsID0gZnVuY3Rpb24gX2ZpbmRFbXB0eUludGVybmFsTW9kZWwoaW50ZXJuYWxNb2RlbCwgb3B0aW9ucykgewogICAgICBpZiAoaW50ZXJuYWxNb2RlbC5pc0VtcHR5KCkpIHsKICAgICAgICByZXR1cm4gdGhpcy5fc2NoZWR1bGVGZXRjaChpbnRlcm5hbE1vZGVsLCBvcHRpb25zKTsKICAgICAgfSAvL1RPRE8gZG91YmxlIGNoZWNrIGFib3V0IHJlbG9hZGluZwoKCiAgICAgIGlmICghY2FuYXJ5RmVhdHVyZXMuUkVRVUVTVF9TRVJWSUNFKSB7CiAgICAgICAgaWYgKGludGVybmFsTW9kZWwuaXNMb2FkaW5nKCkpIHsKICAgICAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsLl9wcm9taXNlUHJveHk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChpbnRlcm5hbE1vZGVsLmlzTG9hZGluZygpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fc2NoZWR1bGVGZXRjaChpbnRlcm5hbE1vZGVsLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBFbWJlci5SU1ZQLlByb21pc2UucmVzb2x2ZShpbnRlcm5hbE1vZGVsKTsKICAgIH0KICAgIC8qKgogICAgICBUaGlzIG1ldGhvZCBtYWtlcyBhIHNlcmllcyBvZiByZXF1ZXN0cyB0byB0aGUgYWRhcHRlcidzIGBmaW5kYCBtZXRob2QKICAgICAgYW5kIHJldHVybnMgYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgb25jZSB0aGV5IGFyZSBhbGwgbG9hZGVkLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBmaW5kQnlJZHMKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgICBAcGFyYW0ge0FycmF5fSBpZHMKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uZmluZEJ5SWRzID0gZnVuY3Rpb24gZmluZEJ5SWRzKG1vZGVsTmFtZSwgaWRzKSB7CiAgICAgIHZhciBwcm9taXNlcyA9IG5ldyBBcnJheShpZHMubGVuZ3RoKTsKICAgICAgdmFyIG5vcm1hbGl6ZWRNb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaWRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcHJvbWlzZXNbaV0gPSB0aGlzLmZpbmRSZWNvcmQobm9ybWFsaXplZE1vZGVsTmFtZSwgaWRzW2ldKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHByb21pc2VBcnJheShFbWJlci5SU1ZQLmFsbChwcm9taXNlcykudGhlbihFbWJlci5BLCBudWxsLCAiRFM6IFN0b3JlI2ZpbmRCeUlkcyBvZiAiICsgbm9ybWFsaXplZE1vZGVsTmFtZSArICIgY29tcGxldGUiKSk7CiAgICB9CiAgICAvKioKICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGJ5IGBmaW5kUmVjb3JkYCBpZiBpdCBkaXNjb3ZlcnMgdGhhdCBhIHBhcnRpY3VsYXIKICAgICAgdHlwZS9pZCBwYWlyIGhhc24ndCBiZWVuIGxvYWRlZCB5ZXQgdG8ga2ljayBvZmYgYSByZXF1ZXN0IHRvIHRoZQogICAgICBhZGFwdGVyLgogICAgICAgQG1ldGhvZCBfZmV0Y2hSZWNvcmQKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtJbnRlcm5hbE1vZGVsfSBpbnRlcm5hbE1vZGVsIG1vZGVsCiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICAqLwogICAgOwoKICAgIF9wcm90by5fZmV0Y2hSZWNvcmQgPSBmdW5jdGlvbiBfZmV0Y2hSZWNvcmQoaW50ZXJuYWxNb2RlbCwgb3B0aW9ucykgewogICAgICB2YXIgbW9kZWxOYW1lID0gaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWU7CiAgICAgIHZhciBhZGFwdGVyID0gdGhpcy5hZGFwdGVyRm9yKG1vZGVsTmFtZSk7CiAgICAgIHJldHVybiBfZmluZChhZGFwdGVyLCB0aGlzLCBpbnRlcm5hbE1vZGVsLnR5cGUsIGludGVybmFsTW9kZWwuaWQsIGludGVybmFsTW9kZWwsIG9wdGlvbnMpOwogICAgfTsKCiAgICBfcHJvdG8uX3NjaGVkdWxlRmV0Y2hNYW55ID0gZnVuY3Rpb24gX3NjaGVkdWxlRmV0Y2hNYW55KGludGVybmFsTW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHZhciBmZXRjaGVzID0gbmV3IEFycmF5KGludGVybmFsTW9kZWxzLmxlbmd0aCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGludGVybmFsTW9kZWxzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZmV0Y2hlc1tpXSA9IHRoaXMuX3NjaGVkdWxlRmV0Y2goaW50ZXJuYWxNb2RlbHNbaV0sIG9wdGlvbnMpOwogICAgICB9CgogICAgICByZXR1cm4gRW1iZXIuUlNWUC5Qcm9taXNlLmFsbChmZXRjaGVzKTsKICAgIH07CgogICAgX3Byb3RvLl9zY2hlZHVsZUZldGNoVGhyb3VnaEZldGNoTWFuYWdlciA9IGZ1bmN0aW9uIF9zY2hlZHVsZUZldGNoVGhyb3VnaEZldGNoTWFuYWdlcihpbnRlcm5hbE1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgdmFyIGdlbmVyYXRlU3RhY2tUcmFjZSA9IHRoaXMuZ2VuZXJhdGVTdGFja1RyYWNlc0ZvclRyYWNrZWRSZXF1ZXN0czsgLy8gVE9ETyAgcmVtb3ZlIHRoaXMgb25jZSB3ZSBkb250IHJlbHkgb24gc3RhdGUgbWFjaGluZQoKICAgICAgaW50ZXJuYWxNb2RlbC5sb2FkaW5nRGF0YSgpOwogICAgICB2YXIgaWRlbnRpZmllciA9IGludGVybmFsTW9kZWwuaWRlbnRpZmllcjsKCiAgICAgIHZhciBwcm9taXNlID0gdGhpcy5fZmV0Y2hNYW5hZ2VyLnNjaGVkdWxlRmV0Y2goaW50ZXJuYWxNb2RlbC5pZGVudGlmaWVyLCBvcHRpb25zLCBnZW5lcmF0ZVN0YWNrVHJhY2UpOwoKICAgICAgcmV0dXJuIHByb21pc2UudGhlbihmdW5jdGlvbiAocGF5bG9hZCkgewogICAgICAgIHsKICAgICAgICAgIC8vIGVuc3VyZSB0aGF0IHJlZ2FyZGxlc3Mgb2YgaWQgcmV0dXJuZWQgd2UgYXNzaWduIHRvIHRoZSBjb3JyZWN0IHJlY29yZAogICAgICAgICAgaWYgKHBheWxvYWQuZGF0YSAmJiAhQXJyYXkuaXNBcnJheShwYXlsb2FkLmRhdGEpKSB7CiAgICAgICAgICAgIHBheWxvYWQuZGF0YS5saWQgPSBpZGVudGlmaWVyLmxpZDsKICAgICAgICAgIH0KICAgICAgICB9IC8vIFJldHVybmluZyB0aGlzLl9wdXNoIGhlcmUsIGJyZWFrcyB0eXBpbmcgYnV0IG5vdCBhbnkgdGVzdHMsIGludmVzc3RpZ2F0ZSBwb3RlbnRpYWwgbWlzc2luZyB0ZXN0cwoKCiAgICAgICAgdmFyIHBvdGVudGlhbGx5TmV3SW0gPSBfdGhpczMuX3B1c2gocGF5bG9hZCk7CgogICAgICAgIGlmIChwb3RlbnRpYWxseU5ld0ltICYmICFBcnJheS5pc0FycmF5KHBvdGVudGlhbGx5TmV3SW0pKSB7CiAgICAgICAgICByZXR1cm4gcG90ZW50aWFsbHlOZXdJbTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGludGVybmFsTW9kZWw7CiAgICAgICAgfQogICAgICB9LCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAvLyBUT0RPICByZW1vdmUgdGhpcyBvbmNlIHdlIGRvbnQgcmVseSBvbiBzdGF0ZSBtYWNoaW5lCiAgICAgICAgaW50ZXJuYWxNb2RlbC5ub3RGb3VuZCgpOwoKICAgICAgICBpZiAoaW50ZXJuYWxNb2RlbC5pc0VtcHR5KCkpIHsKICAgICAgICAgIGludGVybmFsTW9kZWwudW5sb2FkUmVjb3JkKCk7CiAgICAgICAgfQoKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfSk7CiAgICB9OwoKICAgIF9wcm90by5fc2NoZWR1bGVGZXRjaCA9IGZ1bmN0aW9uIF9zY2hlZHVsZUZldGNoKGludGVybmFsTW9kZWwsIG9wdGlvbnMpIHsKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFUVVFU1RfU0VSVklDRSkgewogICAgICAgIHJldHVybiB0aGlzLl9zY2hlZHVsZUZldGNoVGhyb3VnaEZldGNoTWFuYWdlcihpbnRlcm5hbE1vZGVsLCBvcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaW50ZXJuYWxNb2RlbC5fcHJvbWlzZVByb3h5KSB7CiAgICAgICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbC5fcHJvbWlzZVByb3h5OwogICAgICAgIH0KCiAgICAgICAgdmFyIGlkID0gaW50ZXJuYWxNb2RlbC5pZCwKICAgICAgICAgICAgbW9kZWxOYW1lID0gaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWU7CiAgICAgICAgdmFyIHJlc29sdmVyID0gRW1iZXIuUlNWUC5kZWZlcigiRmV0Y2hpbmcgIiArIG1vZGVsTmFtZSArICInIHdpdGggaWQ6ICIgKyBpZCk7CiAgICAgICAgdmFyIHBlbmRpbmdGZXRjaEl0ZW0gPSB7CiAgICAgICAgICBpbnRlcm5hbE1vZGVsOiBpbnRlcm5hbE1vZGVsLAogICAgICAgICAgcmVzb2x2ZXI6IHJlc29sdmVyLAogICAgICAgICAgb3B0aW9uczogb3B0aW9ucwogICAgICAgIH07CgogICAgICAgIHZhciBwcm9taXNlID0gcmVzb2x2ZXIucHJvbWlzZTsKICAgICAgICBpbnRlcm5hbE1vZGVsLmxvYWRpbmdEYXRhKHByb21pc2UpOwoKICAgICAgICBpZiAodGhpcy5fcGVuZGluZ0ZldGNoLnNpemUgPT09IDApIHsKICAgICAgICAgIGVtYmVyUnVuJDIuc2NoZWR1bGUoJ2FjdGlvbnMnLCB0aGlzLCB0aGlzLmZsdXNoQWxsUGVuZGluZ0ZldGNoZXMpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGZldGNoZXMgPSB0aGlzLl9wZW5kaW5nRmV0Y2g7CiAgICAgICAgdmFyIHBlbmRpbmcgPSBmZXRjaGVzLmdldChtb2RlbE5hbWUpOwoKICAgICAgICBpZiAocGVuZGluZyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBwZW5kaW5nID0gW107CiAgICAgICAgICBmZXRjaGVzLnNldChtb2RlbE5hbWUsIHBlbmRpbmcpOwogICAgICAgIH0KCiAgICAgICAgcGVuZGluZy5wdXNoKHBlbmRpbmdGZXRjaEl0ZW0pOwogICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5mbHVzaEFsbFBlbmRpbmdGZXRjaGVzID0gZnVuY3Rpb24gZmx1c2hBbGxQZW5kaW5nRmV0Y2hlcygpIHsKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFUVVFU1RfU0VSVklDRSkgewogICAgICAgIHJldHVybjsgLy9hc3NlcnQgaGVyZQogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0aGlzLmlzRGVzdHJveWVkIHx8IHRoaXMuaXNEZXN0cm95aW5nKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9wZW5kaW5nRmV0Y2guZm9yRWFjaCh0aGlzLl9mbHVzaFBlbmRpbmdGZXRjaEZvclR5cGUsIHRoaXMpOwoKICAgICAgICB0aGlzLl9wZW5kaW5nRmV0Y2guY2xlYXIoKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uX2ZsdXNoUGVuZGluZ0ZldGNoRm9yVHlwZSA9IGZ1bmN0aW9uIF9mbHVzaFBlbmRpbmdGZXRjaEZvclR5cGUocGVuZGluZ0ZldGNoSXRlbXMsIG1vZGVsTmFtZSkgewogICAgICB2YXIgc3RvcmUgPSB0aGlzOwogICAgICB2YXIgYWRhcHRlciA9IHN0b3JlLmFkYXB0ZXJGb3IobW9kZWxOYW1lKTsKICAgICAgdmFyIHNob3VsZENvYWxlc2NlID0gISFhZGFwdGVyLmZpbmRNYW55ICYmIGFkYXB0ZXIuY29hbGVzY2VGaW5kUmVxdWVzdHM7CiAgICAgIHZhciB0b3RhbEl0ZW1zID0gcGVuZGluZ0ZldGNoSXRlbXMubGVuZ3RoOwogICAgICB2YXIgaW50ZXJuYWxNb2RlbHMgPSBuZXcgQXJyYXkodG90YWxJdGVtcyk7CiAgICAgIHZhciBzZWVraW5nID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgdmFyIG9wdGlvbnNNYXAgPSBuZXcgV2Vha01hcCgpOwoKICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IHRvdGFsSXRlbXM7IF9pKyspIHsKICAgICAgICB2YXIgcGVuZGluZ0l0ZW0gPSBwZW5kaW5nRmV0Y2hJdGVtc1tfaV07CiAgICAgICAgdmFyIF9pbnRlcm5hbE1vZGVsID0gcGVuZGluZ0l0ZW0uaW50ZXJuYWxNb2RlbDsKICAgICAgICBpbnRlcm5hbE1vZGVsc1tfaV0gPSBfaW50ZXJuYWxNb2RlbDsKICAgICAgICBvcHRpb25zTWFwLnNldChfaW50ZXJuYWxNb2RlbCwgcGVuZGluZ0l0ZW0ub3B0aW9ucyk7IC8vIFdlIGNhbiByZW1vdmUgdGhpcyAibm90IG51bGwiIGNhc3Qgb25jZSB3ZSBoYXZlIGVub3VnaCB0eXBpbmcKICAgICAgICAvLyB0byBrbm93IHdlIGFyZSBvbmx5IGRlYWxpbmcgd2l0aCBFeGlzdGluZ1Jlc291cmNlSWRlbnRpZmllck9iamVjdHMKCiAgICAgICAgc2Vla2luZ1tfaW50ZXJuYWxNb2RlbC5pZF0gPSBwZW5kaW5nSXRlbTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gX2ZldGNoUmVjb3JkKHJlY29yZFJlc29sdmVyUGFpcikgewogICAgICAgIHZhciByZWNvcmRGZXRjaCA9IHN0b3JlLl9mZXRjaFJlY29yZChyZWNvcmRSZXNvbHZlclBhaXIuaW50ZXJuYWxNb2RlbCwgcmVjb3JkUmVzb2x2ZXJQYWlyLm9wdGlvbnMpOwoKICAgICAgICByZWNvcmRSZXNvbHZlclBhaXIucmVzb2x2ZXIucmVzb2x2ZShyZWNvcmRGZXRjaCk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGhhbmRsZUZvdW5kUmVjb3Jkcyhmb3VuZEludGVybmFsTW9kZWxzLCBleHBlY3RlZEludGVybmFsTW9kZWxzKSB7CiAgICAgICAgLy8gcmVzb2x2ZSBmb3VuZCByZWNvcmRzCiAgICAgICAgdmFyIGZvdW5kID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCiAgICAgICAgZm9yICh2YXIgX2kyID0gMCwgX2wgPSBmb3VuZEludGVybmFsTW9kZWxzLmxlbmd0aDsgX2kyIDwgX2w7IF9pMisrKSB7CiAgICAgICAgICB2YXIgX2ludGVybmFsTW9kZWwyID0gZm91bmRJbnRlcm5hbE1vZGVsc1tfaTJdOyAvLyBXZSBjYW4gcmVtb3ZlIHRoaXMgIm5vdCBudWxsIiBjYXN0IG9uY2Ugd2UgaGF2ZSBlbm91Z2ggdHlwaW5nCiAgICAgICAgICAvLyB0byBrbm93IHdlIGFyZSBvbmx5IGRlYWxpbmcgd2l0aCBFeGlzdGluZ1Jlc291cmNlSWRlbnRpZmllck9iamVjdHMKCiAgICAgICAgICB2YXIgX3BhaXIgPSBzZWVraW5nW19pbnRlcm5hbE1vZGVsMi5pZF07CiAgICAgICAgICBmb3VuZFtfaW50ZXJuYWxNb2RlbDIuaWRdID0gX2ludGVybmFsTW9kZWwyOwoKICAgICAgICAgIGlmIChfcGFpcikgewogICAgICAgICAgICB2YXIgcmVzb2x2ZXIgPSBfcGFpci5yZXNvbHZlcjsKICAgICAgICAgICAgcmVzb2x2ZXIucmVzb2x2ZShfaW50ZXJuYWxNb2RlbDIpOwogICAgICAgICAgfQogICAgICAgIH0gLy8gcmVqZWN0IG1pc3NpbmcgcmVjb3JkcwoKCiAgICAgICAgdmFyIG1pc3NpbmdJbnRlcm5hbE1vZGVscyA9IFtdOwoKICAgICAgICBmb3IgKHZhciBfaTMgPSAwLCBfbDIgPSBleHBlY3RlZEludGVybmFsTW9kZWxzLmxlbmd0aDsgX2kzIDwgX2wyOyBfaTMrKykgewogICAgICAgICAgdmFyIF9pbnRlcm5hbE1vZGVsMyA9IGV4cGVjdGVkSW50ZXJuYWxNb2RlbHNbX2kzXTsgLy8gV2UgY2FuIHJlbW92ZSB0aGlzICJub3QgbnVsbCIgY2FzdCBvbmNlIHdlIGhhdmUgZW5vdWdoIHR5cGluZwogICAgICAgICAgLy8gdG8ga25vdyB3ZSBhcmUgb25seSBkZWFsaW5nIHdpdGggRXhpc3RpbmdSZXNvdXJjZUlkZW50aWZpZXJPYmplY3RzCgogICAgICAgICAgaWYgKCFmb3VuZFtfaW50ZXJuYWxNb2RlbDMuaWRdKSB7CiAgICAgICAgICAgIG1pc3NpbmdJbnRlcm5hbE1vZGVscy5wdXNoKF9pbnRlcm5hbE1vZGVsMyk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAobWlzc2luZ0ludGVybmFsTW9kZWxzLmxlbmd0aCkgewogICAgICAgICAgcmVqZWN0SW50ZXJuYWxNb2RlbHMobWlzc2luZ0ludGVybmFsTW9kZWxzKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHJlamVjdEludGVybmFsTW9kZWxzKGludGVybmFsTW9kZWxzLCBlcnJvcikgewogICAgICAgIGZvciAodmFyIF9pNCA9IDAsIF9sMyA9IGludGVybmFsTW9kZWxzLmxlbmd0aDsgX2k0IDwgX2wzOyBfaTQrKykgewogICAgICAgICAgdmFyIF9pbnRlcm5hbE1vZGVsNCA9IGludGVybmFsTW9kZWxzW19pNF07IC8vIFdlIGNhbiByZW1vdmUgdGhpcyAibm90IG51bGwiIGNhc3Qgb25jZSB3ZSBoYXZlIGVub3VnaCB0eXBpbmcKICAgICAgICAgIC8vIHRvIGtub3cgd2UgYXJlIG9ubHkgZGVhbGluZyB3aXRoIEV4aXN0aW5nUmVzb3VyY2VJZGVudGlmaWVyT2JqZWN0cwoKICAgICAgICAgIHZhciBfcGFpcjIgPSBzZWVraW5nW19pbnRlcm5hbE1vZGVsNC5pZF07CgogICAgICAgICAgaWYgKF9wYWlyMikgewogICAgICAgICAgICBfcGFpcjIucmVzb2x2ZXIucmVqZWN0KGVycm9yIHx8IG5ldyBFcnJvcigiRXhwZWN0ZWQ6ICciICsgX2ludGVybmFsTW9kZWw0ICsgIicgdG8gYmUgcHJlc2VudCBpbiB0aGUgYWRhcHRlciBwcm92aWRlZCBwYXlsb2FkLCBidXQgaXQgd2FzIG5vdCBmb3VuZC4iKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoc2hvdWxkQ29hbGVzY2UpIHsKICAgICAgICAvLyBUT0RPOiBJbXByb3ZlIHJlY29yZHMgPT4gc25hcHNob3RzID0+IHJlY29yZHMgPT4gc25hcHNob3RzCiAgICAgICAgLy8KICAgICAgICAvLyBXZSB3YW50IHRvIHByb3ZpZGUgcmVjb3JkcyB0byBhbGwgc3RvcmUgbWV0aG9kcyBhbmQgc25hcHNob3RzIHRvIGFsbAogICAgICAgIC8vIGFkYXB0ZXIgbWV0aG9kcy4gVG8gbWFrZSBzdXJlIHdlJ3JlIGRvaW5nIHRoYXQgd2UncmUgcHJvdmlkaW5nIGFuIGFycmF5CiAgICAgICAgLy8gb2Ygc25hcHNob3RzIHRvIGFkYXB0ZXIuZ3JvdXBSZWNvcmRzRm9yRmluZE1hbnkoKSwgd2hpY2ggaW4gdHVybiB3aWxsCiAgICAgICAgLy8gcmV0dXJuIGdyb3VwZWQgc25hcHNob3RzIGluc3RlYWQgb2YgZ3JvdXBlZCByZWNvcmRzLgogICAgICAgIC8vCiAgICAgICAgLy8gQnV0IHNpbmNlIHRoZSBfZmluZE1hbnkoKSBmaW5kZXIgaXMgYSBzdG9yZSBtZXRob2Qgd2UgbmVlZCB0byBnZXQgdGhlCiAgICAgICAgLy8gcmVjb3JkcyBmcm9tIHRoZSBncm91cGVkIHNuYXBzaG90cyBldmVuIHRob3VnaCB0aGUgX2ZpbmRNYW55KCkgZmluZGVyCiAgICAgICAgLy8gd2lsbCBvbmNlIGFnYWluIGNvbnZlcnQgdGhlIHJlY29yZHMgdG8gc25hcHNob3RzIGZvciBhZGFwdGVyLmZpbmRNYW55KCkKICAgICAgICB2YXIgc25hcHNob3RzID0gbmV3IEFycmF5KHRvdGFsSXRlbXMpOwoKICAgICAgICBmb3IgKHZhciBfaTUgPSAwOyBfaTUgPCB0b3RhbEl0ZW1zOyBfaTUrKykgewogICAgICAgICAgc25hcHNob3RzW19pNV0gPSBpbnRlcm5hbE1vZGVsc1tfaTVdLmNyZWF0ZVNuYXBzaG90KG9wdGlvbnNNYXAuZ2V0KGludGVybmFsTW9kZWwpKTsKICAgICAgICB9CgogICAgICAgIHZhciBncm91cHMgPSBhZGFwdGVyLmdyb3VwUmVjb3Jkc0ZvckZpbmRNYW55KHRoaXMsIHNuYXBzaG90cyk7CgogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gZ3JvdXBzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdmFyIGdyb3VwID0gZ3JvdXBzW2ldOwogICAgICAgICAgdmFyIHRvdGFsSW5Hcm91cCA9IGdyb3Vwc1tpXS5sZW5ndGg7CiAgICAgICAgICB2YXIgaWRzID0gbmV3IEFycmF5KHRvdGFsSW5Hcm91cCk7CiAgICAgICAgICB2YXIgZ3JvdXBlZEludGVybmFsTW9kZWxzID0gbmV3IEFycmF5KHRvdGFsSW5Hcm91cCk7CgogICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB0b3RhbEluR3JvdXA7IGorKykgewogICAgICAgICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IGdyb3VwW2pdLl9pbnRlcm5hbE1vZGVsOwogICAgICAgICAgICBncm91cGVkSW50ZXJuYWxNb2RlbHNbal0gPSBpbnRlcm5hbE1vZGVsOwogICAgICAgICAgICBpZHNbal0gPSBpbnRlcm5hbE1vZGVsLmlkOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICh0b3RhbEluR3JvdXAgPiAxKSB7CiAgICAgICAgICAgIChmdW5jdGlvbiAoZ3JvdXBlZEludGVybmFsTW9kZWxzKSB7CiAgICAgICAgICAgICAgX2ZpbmRNYW55KGFkYXB0ZXIsIHN0b3JlLCBtb2RlbE5hbWUsIGlkcywgZ3JvdXBlZEludGVybmFsTW9kZWxzLCBvcHRpb25zTWFwKS50aGVuKGZ1bmN0aW9uIChmb3VuZEludGVybmFsTW9kZWxzKSB7CiAgICAgICAgICAgICAgICBoYW5kbGVGb3VuZFJlY29yZHMoZm91bmRJbnRlcm5hbE1vZGVscywgZ3JvdXBlZEludGVybmFsTW9kZWxzKTsKICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIHJlamVjdEludGVybmFsTW9kZWxzKGdyb3VwZWRJbnRlcm5hbE1vZGVscywgZXJyb3IpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KShncm91cGVkSW50ZXJuYWxNb2RlbHMpOwogICAgICAgICAgfSBlbHNlIGlmIChpZHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgIHZhciBwYWlyID0gc2Vla2luZ1tncm91cGVkSW50ZXJuYWxNb2RlbHNbMF0uaWRdOwoKICAgICAgICAgICAgX2ZldGNoUmVjb3JkKHBhaXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKHZhciBfaTYgPSAwOyBfaTYgPCB0b3RhbEl0ZW1zOyBfaTYrKykgewogICAgICAgICAgX2ZldGNoUmVjb3JkKHBlbmRpbmdGZXRjaEl0ZW1zW19pNl0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgIEdldCB0aGUgcmVmZXJlbmNlIGZvciB0aGUgc3BlY2lmaWVkIHJlY29yZC4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgbGV0IHVzZXJSZWYgPSBzdG9yZS5nZXRSZWZlcmVuY2UoJ3VzZXInLCAxKTsKICAgICAgIC8vIGNoZWNrIGlmIHRoZSB1c2VyIGlzIGxvYWRlZAogICAgICBsZXQgaXNMb2FkZWQgPSB1c2VyUmVmLnZhbHVlKCkgIT09IG51bGw7CiAgICAgICAvLyBnZXQgdGhlIHJlY29yZCBvZiB0aGUgcmVmZXJlbmNlIChudWxsIGlmIG5vdCB5ZXQgYXZhaWxhYmxlKQogICAgICBsZXQgdXNlciA9IHVzZXJSZWYudmFsdWUoKTsKICAgICAgIC8vIGdldCB0aGUgaWRlbnRpZmllciBvZiB0aGUgcmVmZXJlbmNlCiAgICAgIGlmICh1c2VyUmVmLnJlbW90ZVR5cGUoKSA9PT0gJ2lkJykgewogICAgICBsZXQgaWQgPSB1c2VyUmVmLmlkKCk7CiAgICAgIH0KICAgICAgIC8vIGxvYWQgdXNlciAodmlhIHN0b3JlLmZpbmQpCiAgICAgIHVzZXJSZWYubG9hZCgpLnRoZW4oLi4uKQogICAgICAgLy8gb3IgdHJpZ2dlciBhIHJlbG9hZAogICAgICB1c2VyUmVmLnJlbG9hZCgpLnRoZW4oLi4uKQogICAgICAgLy8gcHJvdmlkZSBkYXRhIGZvciByZWZlcmVuY2UKICAgICAgdXNlclJlZi5wdXNoKHsgaWQ6IDEsIHVzZXJuYW1lOiAnQHVzZXInIH0pLnRoZW4oZnVuY3Rpb24odXNlcikgewogICAgICAgIHVzZXJSZWYudmFsdWUoKSA9PT0gdXNlcjsKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBnZXRSZWZlcmVuY2UKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgICBAcGFyYW0ge1N0cmluZ3xJbnRlZ2VyfSBpZAogICAgICBAc2luY2UgMi41LjAKICAgICAgQHJldHVybiB7UmVjb3JkUmVmZXJlbmNlfQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uZ2V0UmVmZXJlbmNlID0gZnVuY3Rpb24gZ2V0UmVmZXJlbmNlKG1vZGVsTmFtZSwgaWQpIHsKCiAgICAgIHZhciB0eXBlID0gbm9ybWFsaXplTW9kZWxOYW1lKG1vZGVsTmFtZSk7CiAgICAgIHZhciBub3JtYWxpemVkSWQgPSBlbnN1cmVTdHJpbmdJZChpZCk7CiAgICAgIHZhciByZXNvdXJjZSA9IGNvbnN0cnVjdFJlc291cmNlKHR5cGUsIG5vcm1hbGl6ZWRJZCk7CiAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsRmFjdG9yeUZvcih0aGlzKS5sb29rdXAocmVzb3VyY2UpLnJlY29yZFJlZmVyZW5jZTsKICAgIH0KICAgIC8qKgogICAgICBHZXQgYSByZWNvcmQgYnkgYSBnaXZlbiB0eXBlIGFuZCBJRCB3aXRob3V0IHRyaWdnZXJpbmcgYSBmZXRjaC4KICAgICAgIFRoaXMgbWV0aG9kIHdpbGwgc3luY2hyb25vdXNseSByZXR1cm4gdGhlIHJlY29yZCBpZiBpdCBpcyBhdmFpbGFibGUgaW4gdGhlIHN0b3JlLAogICAgICBvdGhlcndpc2UgaXQgd2lsbCByZXR1cm4gYG51bGxgLiBBIHJlY29yZCBpcyBhdmFpbGFibGUgaWYgaXQgaGFzIGJlZW4gZmV0Y2hlZCBlYXJsaWVyLCBvcgogICAgICBwdXNoZWQgbWFudWFsbHkgaW50byB0aGUgc3RvcmUuCiAgICAgICBTZWUgW2ZpbmRSZWNvcmRdKFN0b3JlL21ldGhvZHMvZmluZFJlY29yZD9hbmNob3I9ZmluZFJlY29yZCkgaWYgeW91IHdvdWxkIGxpa2UgdG8gcmVxdWVzdCB0aGlzIHJlY29yZCBmcm9tIHRoZSBiYWNrZW5kLgogICAgICAgX05vdGU6IFRoaXMgaXMgYSBzeW5jaHJvbm91cyBtZXRob2QgYW5kIGRvZXMgbm90IHJldHVybiBhIHByb21pc2UuXwogICAgICAgYGBganMKICAgICAgbGV0IHBvc3QgPSBzdG9yZS5wZWVrUmVjb3JkKCdwb3N0JywgMSk7CiAgICAgICBwb3N0LmdldCgnaWQnKTsgLy8gMQogICAgICBgYGAKICAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBwZWVrUmVjb3JkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgICAgQHBhcmFtIHtTdHJpbmd8SW50ZWdlcn0gaWQKICAgICAgQHJldHVybiB7TW9kZWx8bnVsbH0gcmVjb3JkCiAgICAqLwogICAgOwoKICAgIF9wcm90by5wZWVrUmVjb3JkID0gZnVuY3Rpb24gcGVla1JlY29yZChtb2RlbE5hbWUsIGlkKSB7CiAgICAgIHZhciB0eXBlID0gbm9ybWFsaXplTW9kZWxOYW1lKG1vZGVsTmFtZSk7CiAgICAgIHZhciBub3JtYWxpemVkSWQgPSBlbnN1cmVTdHJpbmdJZChpZCk7CgogICAgICBpZiAodGhpcy5oYXNSZWNvcmRGb3JJZCh0eXBlLCBub3JtYWxpemVkSWQpKSB7CiAgICAgICAgdmFyIHJlc291cmNlID0gY29uc3RydWN0UmVzb3VyY2UodHlwZSwgbm9ybWFsaXplZElkKTsKICAgICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbEZhY3RvcnlGb3IodGhpcykubG9va3VwKHJlc291cmNlKS5nZXRSZWNvcmQoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBieSB0aGUgcmVjb3JkJ3MgYHJlbG9hZGAgbWV0aG9kLgogICAgICAgVGhpcyBtZXRob2QgY2FsbHMgdGhlIGFkYXB0ZXIncyBgZmluZGAgbWV0aG9kLCB3aGljaCByZXR1cm5zIGEgcHJvbWlzZS4gV2hlbgogICAgICAqKnRoYXQqKiBwcm9taXNlIHJlc29sdmVzLCBgX3JlbG9hZFJlY29yZGAgd2lsbCByZXNvbHZlIHRoZSBwcm9taXNlIHJldHVybmVkCiAgICAgIGJ5IHRoZSByZWNvcmQncyBgcmVsb2FkYC4KICAgICAgIEBtZXRob2QgX3JlbG9hZFJlY29yZAogICAgICBAcHJpdmF0ZQogICAgICBAcGFyYW0ge01vZGVsfSBpbnRlcm5hbE1vZGVsCiAgICAgIEBwYXJhbSBvcHRpb25zIG9wdGlvbmFsIHRvIGluY2x1ZGUgYWRhcHRlck9wdGlvbnMKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uX3JlbG9hZFJlY29yZCA9IGZ1bmN0aW9uIF9yZWxvYWRSZWNvcmQoaW50ZXJuYWxNb2RlbCwgb3B0aW9ucykgewogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuUkVRVUVTVF9TRVJWSUNFKSB7CiAgICAgICAgb3B0aW9ucy5pc1JlbG9hZGluZyA9IHRydWU7CiAgICAgIH0KCiAgICAgIHZhciBpZCA9IGludGVybmFsTW9kZWwuaWQsCiAgICAgICAgICBtb2RlbE5hbWUgPSBpbnRlcm5hbE1vZGVsLm1vZGVsTmFtZTsKICAgICAgdmFyIGFkYXB0ZXIgPSB0aGlzLmFkYXB0ZXJGb3IobW9kZWxOYW1lKTsKICAgICAgcmV0dXJuIHRoaXMuX3NjaGVkdWxlRmV0Y2goaW50ZXJuYWxNb2RlbCwgb3B0aW9ucyk7CiAgICB9CiAgICAvKioKICAgICBUaGlzIG1ldGhvZCByZXR1cm5zIHRydWUgaWYgYSByZWNvcmQgZm9yIGEgZ2l2ZW4gbW9kZWxOYW1lIGFuZCBpZCBpcyBhbHJlYWR5CiAgICAgbG9hZGVkIGluIHRoZSBzdG9yZS4gVXNlIHRoaXMgZnVuY3Rpb24gdG8ga25vdyBiZWZvcmVoYW5kIGlmIGEgZmluZFJlY29yZCgpCiAgICAgd2lsbCByZXN1bHQgaW4gYSByZXF1ZXN0IG9yIHRoYXQgaXQgd2lsbCBiZSBhIGNhY2hlIGhpdC4KICAgICAgRXhhbXBsZQogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgc3RvcmUuaGFzUmVjb3JkRm9ySWQoJ3Bvc3QnLCAxKTsgLy8gZmFsc2UKICAgICBzdG9yZS5maW5kUmVjb3JkKCdwb3N0JywgMSkudGhlbihmdW5jdGlvbigpIHsKICAgICAgIHN0b3JlLmhhc1JlY29yZEZvcklkKCdwb3N0JywgMSk7IC8vIHRydWUKICAgICB9KTsKICAgICBgYGAKICAgICAgIEBtZXRob2QgaGFzUmVjb3JkRm9ySWQKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgICBAcGFyYW0geyhTdHJpbmd8SW50ZWdlcil9IGlkCiAgICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICAqLwogICAgOwoKICAgIF9wcm90by5oYXNSZWNvcmRGb3JJZCA9IGZ1bmN0aW9uIGhhc1JlY29yZEZvcklkKG1vZGVsTmFtZSwgaWQpIHsKICAgICAgdmFyIHR5cGUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKICAgICAgdmFyIHRydWVJZCA9IGVuc3VyZVN0cmluZ0lkKGlkKTsKICAgICAgdmFyIHJlc291cmNlID0gewogICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgaWQ6IHRydWVJZAogICAgICB9OwogICAgICB2YXIgaWRlbnRpZmllciA9IGlkZW50aWZpZXJDYWNoZUZvcih0aGlzKS5wZWVrUmVjb3JkSWRlbnRpZmllcihyZXNvdXJjZSk7CiAgICAgIHZhciBpbnRlcm5hbE1vZGVsID0gaWRlbnRpZmllciAmJiBpbnRlcm5hbE1vZGVsRmFjdG9yeUZvcih0aGlzKS5wZWVrKGlkZW50aWZpZXIpOwogICAgICByZXR1cm4gISFpbnRlcm5hbE1vZGVsICYmIGludGVybmFsTW9kZWwuaXNMb2FkZWQoKTsKICAgIH0KICAgIC8qKgogICAgICBSZXR1cm5zIGlkIHJlY29yZCBmb3IgYSBnaXZlbiB0eXBlIGFuZCBJRC4gSWYgb25lIGlzbid0IGFscmVhZHkgbG9hZGVkLAogICAgICBpdCBidWlsZHMgYSBuZXcgcmVjb3JkIGFuZCBsZWF2ZXMgaXQgaW4gdGhlIGBlbXB0eWAgc3RhdGUuCiAgICAgICBAbWV0aG9kIHJlY29yZEZvcklkCiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgICAgQHBhcmFtIHsoU3RyaW5nfEludGVnZXIpfSBpZAogICAgICBAcmV0dXJuIHtNb2RlbH0gcmVjb3JkCiAgICAqLwogICAgOwoKICAgIF9wcm90by5yZWNvcmRGb3JJZCA9IGZ1bmN0aW9uIHJlY29yZEZvcklkKG1vZGVsTmFtZSwgaWQpIHsKICAgICAgdmFyIHJlc291cmNlID0gY29uc3RydWN0UmVzb3VyY2UobW9kZWxOYW1lLCBlbnN1cmVTdHJpbmdJZChpZCkpOwogICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbEZhY3RvcnlGb3IodGhpcykubG9va3VwKHJlc291cmNlKS5nZXRSZWNvcmQoKTsKICAgIH0KICAgIC8qKgogICAgICBAbWV0aG9kIGZpbmRNYW55CiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7QXJyYXl9IGludGVybmFsTW9kZWxzCiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICovCiAgICA7CgogICAgX3Byb3RvLmZpbmRNYW55ID0gZnVuY3Rpb24gZmluZE1hbnkoaW50ZXJuYWxNb2RlbHMsIG9wdGlvbnMpIHsKCiAgICAgIHZhciBmaW5kcyA9IG5ldyBBcnJheShpbnRlcm5hbE1vZGVscy5sZW5ndGgpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbnRlcm5hbE1vZGVscy5sZW5ndGg7IGkrKykgewogICAgICAgIGZpbmRzW2ldID0gdGhpcy5fZmluZEVtcHR5SW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsc1tpXSwgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBFbWJlci5SU1ZQLlByb21pc2UuYWxsKGZpbmRzKTsKICAgIH0KICAgIC8qKgogICAgICBJZiBhIHJlbGF0aW9uc2hpcCB3YXMgb3JpZ2luYWxseSBwb3B1bGF0ZWQgYnkgdGhlIGFkYXB0ZXIgYXMgYSBsaW5rCiAgICAgIChhcyBvcHBvc2VkIHRvIGEgbGlzdCBvZiBJRHMpLCB0aGlzIG1ldGhvZCBpcyBjYWxsZWQgd2hlbiB0aGUKICAgICAgcmVsYXRpb25zaGlwIGlzIGZldGNoZWQuCiAgICAgICBUaGUgbGluayAod2hpY2ggaXMgdXN1YWxseSBhIFVSTCkgaXMgcGFzc2VkIHRocm91Z2ggdW5jaGFuZ2VkLCBzbyB0aGUKICAgICAgYWRhcHRlciBjYW4gbWFrZSB3aGF0ZXZlciByZXF1ZXN0IGl0IHdhbnRzLgogICAgICAgVGhlIHVzdWFsIHVzZS1jYXNlIGlzIGZvciB0aGUgc2VydmVyIHRvIHJlZ2lzdGVyIGEgVVJMIGFzIGEgbGluaywgYW5kCiAgICAgIHRoZW4gdXNlIHRoYXQgVVJMIGluIHRoZSBmdXR1cmUgdG8gbWFrZSBhIHJlcXVlc3QgZm9yIHRoZSByZWxhdGlvbnNoaXAuCiAgICAgICBAbWV0aG9kIGZpbmRIYXNNYW55CiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7SW50ZXJuYWxNb2RlbH0gaW50ZXJuYWxNb2RlbAogICAgICBAcGFyYW0ge2FueX0gbGluawogICAgICBAcGFyYW0geyhSZWxhdGlvbnNoaXApfSByZWxhdGlvbnNoaXAKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uZmluZEhhc01hbnkgPSBmdW5jdGlvbiBmaW5kSGFzTWFueShpbnRlcm5hbE1vZGVsLCBsaW5rLCByZWxhdGlvbnNoaXAsIG9wdGlvbnMpIHsKCiAgICAgIHZhciBhZGFwdGVyID0gdGhpcy5hZGFwdGVyRm9yKGludGVybmFsTW9kZWwubW9kZWxOYW1lKTsKICAgICAgcmV0dXJuIF9maW5kSGFzTWFueShhZGFwdGVyLCB0aGlzLCBpbnRlcm5hbE1vZGVsLCBsaW5rLCByZWxhdGlvbnNoaXAsIG9wdGlvbnMpOwogICAgfTsKCiAgICBfcHJvdG8uX2ZpbmRIYXNNYW55QnlKc29uQXBpUmVzb3VyY2UgPSBmdW5jdGlvbiBfZmluZEhhc01hbnlCeUpzb25BcGlSZXNvdXJjZShyZXNvdXJjZSwgcGFyZW50SW50ZXJuYWxNb2RlbCwgcmVsYXRpb25zaGlwTWV0YSwgb3B0aW9ucykgewogICAgICB2YXIgX3RoaXM0ID0gdGhpczsKCiAgICAgIGlmICghcmVzb3VyY2UpIHsKICAgICAgICByZXR1cm4gRW1iZXIuUlNWUC5yZXNvbHZlKFtdKTsKICAgICAgfQoKICAgICAgdmFyIF9yZXNvdXJjZSRfcmVsYXRpb25zaCA9IHJlc291cmNlLl9yZWxhdGlvbnNoaXAsCiAgICAgICAgICByZWxhdGlvbnNoaXBJc1N0YWxlID0gX3Jlc291cmNlJF9yZWxhdGlvbnNoLnJlbGF0aW9uc2hpcElzU3RhbGUsCiAgICAgICAgICBhbGxJbnZlcnNlUmVjb3Jkc0FyZUxvYWRlZCA9IF9yZXNvdXJjZSRfcmVsYXRpb25zaC5hbGxJbnZlcnNlUmVjb3Jkc0FyZUxvYWRlZCwKICAgICAgICAgIGhhc0RlbWF0ZXJpYWxpemVkSW52ZXJzZSA9IF9yZXNvdXJjZSRfcmVsYXRpb25zaC5oYXNEZW1hdGVyaWFsaXplZEludmVyc2UsCiAgICAgICAgICBoYXNBbnlSZWxhdGlvbnNoaXBEYXRhID0gX3Jlc291cmNlJF9yZWxhdGlvbnNoLmhhc0FueVJlbGF0aW9uc2hpcERhdGEsCiAgICAgICAgICByZWxhdGlvbnNoaXBJc0VtcHR5ID0gX3Jlc291cmNlJF9yZWxhdGlvbnNoLnJlbGF0aW9uc2hpcElzRW1wdHksCiAgICAgICAgICBzaG91bGRGb3JjZVJlbG9hZCA9IF9yZXNvdXJjZSRfcmVsYXRpb25zaC5zaG91bGRGb3JjZVJlbG9hZDsKICAgICAgdmFyIHNob3VsZEZpbmRWaWFMaW5rID0gcmVzb3VyY2UubGlua3MgJiYgcmVzb3VyY2UubGlua3MucmVsYXRlZCAmJiAoc2hvdWxkRm9yY2VSZWxvYWQgfHwgaGFzRGVtYXRlcmlhbGl6ZWRJbnZlcnNlIHx8IHJlbGF0aW9uc2hpcElzU3RhbGUgfHwgIWFsbEludmVyc2VSZWNvcmRzQXJlTG9hZGVkICYmICFyZWxhdGlvbnNoaXBJc0VtcHR5KTsgLy8gZmV0Y2ggdmlhIGxpbmsKCiAgICAgIGlmIChzaG91bGRGaW5kVmlhTGluaykgewogICAgICAgIHJldHVybiB0aGlzLmZpbmRIYXNNYW55KHBhcmVudEludGVybmFsTW9kZWwsIHJlc291cmNlLmxpbmtzLnJlbGF0ZWQsIHJlbGF0aW9uc2hpcE1ldGEsIG9wdGlvbnMpOwogICAgICB9CgogICAgICB2YXIgcHJlZmVyTG9jYWxDYWNoZSA9IGhhc0FueVJlbGF0aW9uc2hpcERhdGEgJiYgIXJlbGF0aW9uc2hpcElzRW1wdHk7CiAgICAgIHZhciBoYXNMb2NhbFBhcnRpYWxEYXRhID0gaGFzRGVtYXRlcmlhbGl6ZWRJbnZlcnNlIHx8IHJlbGF0aW9uc2hpcElzRW1wdHkgJiYgQXJyYXkuaXNBcnJheShyZXNvdXJjZS5kYXRhKSAmJiByZXNvdXJjZS5kYXRhLmxlbmd0aCA+IDA7IC8vIGZldGNoIHVzaW5nIGRhdGEsIHB1bGxpbmcgZnJvbSBsb2NhbCBjYWNoZSBpZiBwb3NzaWJsZQoKICAgICAgaWYgKCFzaG91bGRGb3JjZVJlbG9hZCAmJiAhcmVsYXRpb25zaGlwSXNTdGFsZSAmJiAocHJlZmVyTG9jYWxDYWNoZSB8fCBoYXNMb2NhbFBhcnRpYWxEYXRhKSkgewogICAgICAgIHZhciBpbnRlcm5hbE1vZGVscyA9IHJlc291cmNlLmRhdGEubWFwKGZ1bmN0aW9uIChqc29uKSB7CiAgICAgICAgICByZXR1cm4gX3RoaXM0Ll9pbnRlcm5hbE1vZGVsRm9yUmVzb3VyY2UoanNvbik7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHRoaXMuZmluZE1hbnkoaW50ZXJuYWxNb2RlbHMsIG9wdGlvbnMpOwogICAgICB9CgogICAgICB2YXIgaGFzRGF0YSA9IGhhc0FueVJlbGF0aW9uc2hpcERhdGEgJiYgIXJlbGF0aW9uc2hpcElzRW1wdHk7IC8vIGZldGNoIGJ5IGRhdGEKCiAgICAgIGlmIChoYXNEYXRhIHx8IGhhc0xvY2FsUGFydGlhbERhdGEpIHsKICAgICAgICB2YXIgX2ludGVybmFsTW9kZWxzID0gcmVzb3VyY2UuZGF0YS5tYXAoZnVuY3Rpb24gKGpzb24pIHsKICAgICAgICAgIHJldHVybiBfdGhpczQuX2ludGVybmFsTW9kZWxGb3JSZXNvdXJjZShqc29uKTsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3NjaGVkdWxlRmV0Y2hNYW55KF9pbnRlcm5hbE1vZGVscywgb3B0aW9ucyk7CiAgICAgIH0gLy8gd2Ugd2VyZSBleHBsaWNpdGx5IHRvbGQgd2UgaGF2ZSBubyBkYXRhIGFuZCBubyBsaW5rcy4KICAgICAgLy8gICBUT0RPIGlmIHRoZSByZWxhdGlvbnNoaXBJc1N0YWxlLCBzaG91bGQgd2UgaGl0IHRoZSBhZGFwdGVyIGFueXdheT8KCgogICAgICByZXR1cm4gRW1iZXIuUlNWUC5yZXNvbHZlKFtdKTsKICAgIH07CgogICAgX3Byb3RvLl9nZXRIYXNNYW55QnlKc29uQXBpUmVzb3VyY2UgPSBmdW5jdGlvbiBfZ2V0SGFzTWFueUJ5SnNvbkFwaVJlc291cmNlKHJlc291cmNlKSB7CiAgICAgIHZhciBfdGhpczUgPSB0aGlzOwoKICAgICAgdmFyIGludGVybmFsTW9kZWxzID0gW107CgogICAgICBpZiAocmVzb3VyY2UgJiYgcmVzb3VyY2UuZGF0YSkgewogICAgICAgIGludGVybmFsTW9kZWxzID0gcmVzb3VyY2UuZGF0YS5tYXAoZnVuY3Rpb24gKHJlZmVyZW5jZSkgewogICAgICAgICAgcmV0dXJuIF90aGlzNS5faW50ZXJuYWxNb2RlbEZvclJlc291cmNlKHJlZmVyZW5jZSk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsczsKICAgIH0KICAgIC8qKgogICAgICBAbWV0aG9kIGZpbmRCZWxvbmdzVG8KICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtJbnRlcm5hbE1vZGVsfSBpbnRlcm5hbE1vZGVsCiAgICAgIEBwYXJhbSB7YW55fSBsaW5rCiAgICAgIEBwYXJhbSB7UmVsYXRpb25zaGlwfSByZWxhdGlvbnNoaXAKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uZmluZEJlbG9uZ3NUbyA9IGZ1bmN0aW9uIGZpbmRCZWxvbmdzVG8oaW50ZXJuYWxNb2RlbCwgbGluaywgcmVsYXRpb25zaGlwLCBvcHRpb25zKSB7CgogICAgICB2YXIgYWRhcHRlciA9IHRoaXMuYWRhcHRlckZvcihpbnRlcm5hbE1vZGVsLm1vZGVsTmFtZSk7CiAgICAgIHJldHVybiBfZmluZEJlbG9uZ3NUbyhhZGFwdGVyLCB0aGlzLCBpbnRlcm5hbE1vZGVsLCBsaW5rLCByZWxhdGlvbnNoaXAsIG9wdGlvbnMpOwogICAgfTsKCiAgICBfcHJvdG8uX2ZldGNoQmVsb25nc1RvTGlua0Zyb21SZXNvdXJjZSA9IGZ1bmN0aW9uIF9mZXRjaEJlbG9uZ3NUb0xpbmtGcm9tUmVzb3VyY2UocmVzb3VyY2UsIHBhcmVudEludGVybmFsTW9kZWwsIHJlbGF0aW9uc2hpcE1ldGEsIG9wdGlvbnMpIHsKICAgICAgaWYgKCFyZXNvdXJjZSB8fCAhcmVzb3VyY2UubGlua3MgfHwgIXJlc291cmNlLmxpbmtzLnJlbGF0ZWQpIHsKICAgICAgICAvLyBzaG91bGQgd2Ugd2FybiBoZXJlLCBub3Qgc3VyZSBjYXVzZSBpdHMgYW4gaW50ZXJuYWwgbWV0aG9kCiAgICAgICAgcmV0dXJuIEVtYmVyLlJTVlAucmVzb2x2ZShudWxsKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuZmluZEJlbG9uZ3NUbyhwYXJlbnRJbnRlcm5hbE1vZGVsLCByZXNvdXJjZS5saW5rcy5yZWxhdGVkLCByZWxhdGlvbnNoaXBNZXRhLCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uIChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgcmV0dXJuIGludGVybmFsTW9kZWwgPyBpbnRlcm5hbE1vZGVsLmdldFJlY29yZCgpIDogbnVsbDsKICAgICAgfSk7CiAgICB9OwoKICAgIF9wcm90by5fZmluZEJlbG9uZ3NUb0J5SnNvbkFwaVJlc291cmNlID0gZnVuY3Rpb24gX2ZpbmRCZWxvbmdzVG9CeUpzb25BcGlSZXNvdXJjZShyZXNvdXJjZSwgcGFyZW50SW50ZXJuYWxNb2RlbCwgcmVsYXRpb25zaGlwTWV0YSwgb3B0aW9ucykgewogICAgICBpZiAoIXJlc291cmNlKSB7CiAgICAgICAgcmV0dXJuIEVtYmVyLlJTVlAucmVzb2x2ZShudWxsKTsKICAgICAgfQoKICAgICAgdmFyIGludGVybmFsTW9kZWwgPSByZXNvdXJjZS5kYXRhID8gdGhpcy5faW50ZXJuYWxNb2RlbEZvclJlc291cmNlKHJlc291cmNlLmRhdGEpIDogbnVsbDsKICAgICAgdmFyIF9yZXNvdXJjZSRfcmVsYXRpb25zaDIgPSByZXNvdXJjZS5fcmVsYXRpb25zaGlwLAogICAgICAgICAgcmVsYXRpb25zaGlwSXNTdGFsZSA9IF9yZXNvdXJjZSRfcmVsYXRpb25zaDIucmVsYXRpb25zaGlwSXNTdGFsZSwKICAgICAgICAgIGFsbEludmVyc2VSZWNvcmRzQXJlTG9hZGVkID0gX3Jlc291cmNlJF9yZWxhdGlvbnNoMi5hbGxJbnZlcnNlUmVjb3Jkc0FyZUxvYWRlZCwKICAgICAgICAgIGhhc0RlbWF0ZXJpYWxpemVkSW52ZXJzZSA9IF9yZXNvdXJjZSRfcmVsYXRpb25zaDIuaGFzRGVtYXRlcmlhbGl6ZWRJbnZlcnNlLAogICAgICAgICAgaGFzQW55UmVsYXRpb25zaGlwRGF0YSA9IF9yZXNvdXJjZSRfcmVsYXRpb25zaDIuaGFzQW55UmVsYXRpb25zaGlwRGF0YSwKICAgICAgICAgIHJlbGF0aW9uc2hpcElzRW1wdHkgPSBfcmVzb3VyY2UkX3JlbGF0aW9uc2gyLnJlbGF0aW9uc2hpcElzRW1wdHksCiAgICAgICAgICBzaG91bGRGb3JjZVJlbG9hZCA9IF9yZXNvdXJjZSRfcmVsYXRpb25zaDIuc2hvdWxkRm9yY2VSZWxvYWQ7CiAgICAgIHZhciBzaG91bGRGaW5kVmlhTGluayA9IHJlc291cmNlLmxpbmtzICYmIHJlc291cmNlLmxpbmtzLnJlbGF0ZWQgJiYgKHNob3VsZEZvcmNlUmVsb2FkIHx8IGhhc0RlbWF0ZXJpYWxpemVkSW52ZXJzZSB8fCByZWxhdGlvbnNoaXBJc1N0YWxlIHx8ICFhbGxJbnZlcnNlUmVjb3Jkc0FyZUxvYWRlZCAmJiAhcmVsYXRpb25zaGlwSXNFbXB0eSk7CgogICAgICBpZiAoaW50ZXJuYWxNb2RlbCkgewogICAgICAgIC8vIHNob3J0IGNpcmN1aXQgaWYgd2UgYXJlIGFscmVhZHkgbG9hZGluZwogICAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5SRVFVRVNUX1NFUlZJQ0UpIHsKICAgICAgICAgIC8vIFRlbXBvcmFyeSBmaXggZm9yIHJlcXVlc3RzIGFscmVhZHkgbG9hZGluZyB1bnRpbCB3ZSBtb3ZlIHRoaXMgaW5zaWRlIHRoZSBmZXRjaCBtYW5hZ2VyCiAgICAgICAgICB2YXIgcGVuZGluZ1JlcXVlc3RzID0gdGhpcy5nZXRSZXF1ZXN0U3RhdGVTZXJ2aWNlKCkuZ2V0UGVuZGluZ1JlcXVlc3RzRm9yUmVjb3JkKGludGVybmFsTW9kZWwuaWRlbnRpZmllcikuZmlsdGVyKGZ1bmN0aW9uIChyZXEpIHsKICAgICAgICAgICAgcmV0dXJuIHJlcS50eXBlID09PSAncXVlcnknOwogICAgICAgICAgfSk7CgogICAgICAgICAgaWYgKHBlbmRpbmdSZXF1ZXN0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHJldHVybiBwZW5kaW5nUmVxdWVzdHNbMF1bUmVxdWVzdFByb21pc2VdLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsLmdldFJlY29yZCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGludGVybmFsTW9kZWwuaXNMb2FkaW5nKCkpIHsKICAgICAgICAgICAgcmV0dXJuIGludGVybmFsTW9kZWwuX3Byb21pc2VQcm94eS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbC5nZXRSZWNvcmQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IC8vIGZldGNoIHZpYSBsaW5rCgoKICAgICAgaWYgKHNob3VsZEZpbmRWaWFMaW5rKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ZldGNoQmVsb25nc1RvTGlua0Zyb21SZXNvdXJjZShyZXNvdXJjZSwgcGFyZW50SW50ZXJuYWxNb2RlbCwgcmVsYXRpb25zaGlwTWV0YSwgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIHZhciBwcmVmZXJMb2NhbENhY2hlID0gaGFzQW55UmVsYXRpb25zaGlwRGF0YSAmJiBhbGxJbnZlcnNlUmVjb3Jkc0FyZUxvYWRlZCAmJiAhcmVsYXRpb25zaGlwSXNFbXB0eTsKICAgICAgdmFyIGhhc0xvY2FsUGFydGlhbERhdGEgPSBoYXNEZW1hdGVyaWFsaXplZEludmVyc2UgfHwgcmVsYXRpb25zaGlwSXNFbXB0eSAmJiByZXNvdXJjZS5kYXRhOyAvLyBudWxsIGlzIGV4cGxpY2l0IGVtcHR5LCB1bmRlZmluZWQgaXMgIndlIGRvbid0IGtub3cgYW55dGhpbmciCgogICAgICB2YXIgbG9jYWxEYXRhSXNFbXB0eSA9IHJlc291cmNlLmRhdGEgPT09IHVuZGVmaW5lZCB8fCByZXNvdXJjZS5kYXRhID09PSBudWxsOyAvLyBmZXRjaCB1c2luZyBkYXRhLCBwdWxsaW5nIGZyb20gbG9jYWwgY2FjaGUgaWYgcG9zc2libGUKCiAgICAgIGlmICghc2hvdWxkRm9yY2VSZWxvYWQgJiYgIXJlbGF0aW9uc2hpcElzU3RhbGUgJiYgKHByZWZlckxvY2FsQ2FjaGUgfHwgaGFzTG9jYWxQYXJ0aWFsRGF0YSkpIHsKICAgICAgICAvKgogICAgICAgICAgV2UgaGF2ZSBjYW5vbmljYWwgZGF0YSwgYnV0IG91ciBsb2NhbCBzdGF0ZSBpcyBlbXB0eQogICAgICAgICAqLwogICAgICAgIGlmIChsb2NhbERhdGFJc0VtcHR5KSB7CiAgICAgICAgICByZXR1cm4gRW1iZXIuUlNWUC5yZXNvbHZlKG51bGwpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuX2ZpbmRCeUludGVybmFsTW9kZWwoaW50ZXJuYWxNb2RlbCwgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIHZhciByZXNvdXJjZUlzTG9jYWwgPSAhbG9jYWxEYXRhSXNFbXB0eSAmJiByZXNvdXJjZS5kYXRhLmlkID09PSBudWxsOwoKICAgICAgaWYgKGludGVybmFsTW9kZWwgJiYgcmVzb3VyY2VJc0xvY2FsKSB7CiAgICAgICAgcmV0dXJuIEVtYmVyLlJTVlAucmVzb2x2ZShpbnRlcm5hbE1vZGVsLmdldFJlY29yZCgpKTsKICAgICAgfSAvLyBmZXRjaCBieSBkYXRhCgoKICAgICAgaWYgKGludGVybmFsTW9kZWwgJiYgIWxvY2FsRGF0YUlzRW1wdHkpIHsKICAgICAgICByZXR1cm4gdGhpcy5fc2NoZWR1bGVGZXRjaChpbnRlcm5hbE1vZGVsLCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsLmdldFJlY29yZCgpOwogICAgICAgIH0pOwogICAgICB9IC8vIHdlIHdlcmUgZXhwbGljaXRseSB0b2xkIHdlIGhhdmUgbm8gZGF0YSBhbmQgbm8gbGlua3MuCiAgICAgIC8vICAgVE9ETyBpZiB0aGUgcmVsYXRpb25zaGlwSXNTdGFsZSwgc2hvdWxkIHdlIGhpdCB0aGUgYWRhcHRlciBhbnl3YXk/CgoKICAgICAgcmV0dXJuIEVtYmVyLlJTVlAucmVzb2x2ZShudWxsKTsKICAgIH0KICAgIC8qKgogICAgICBUaGlzIG1ldGhvZCBkZWxlZ2F0ZXMgYSBxdWVyeSB0byB0aGUgYWRhcHRlci4gVGhpcyBpcyB0aGUgb25lIHBsYWNlIHdoZXJlCiAgICAgIGFkYXB0ZXItbGV2ZWwgc2VtYW50aWNzIGFyZSBleHBvc2VkIHRvIHRoZSBhcHBsaWNhdGlvbi4KICAgICAgIEVhY2ggdGltZSB0aGlzIG1ldGhvZCBpcyBjYWxsZWQgYSBuZXcgcmVxdWVzdCBpcyBtYWRlIHRocm91Z2ggdGhlIGFkYXB0ZXIuCiAgICAgICBFeHBvc2luZyBxdWVyaWVzIHRoaXMgd2F5IHNlZW1zIHByZWZlcmFibGUgdG8gY3JlYXRpbmcgYW4gYWJzdHJhY3QgcXVlcnkKICAgICAgbGFuZ3VhZ2UgZm9yIGFsbCBzZXJ2ZXItc2lkZSBxdWVyaWVzLCBhbmQgdGhlbiByZXF1aXJlIGFsbCBhZGFwdGVycyB0bwogICAgICBpbXBsZW1lbnQgdGhlbS4KICAgICAgIC0tLQogICAgICAgSWYgeW91IGRvIHNvbWV0aGluZyBsaWtlIHRoaXM6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHN0b3JlLnF1ZXJ5KCdwZXJzb24nLCB7IHBhZ2U6IDEgfSk7CiAgICAgIGBgYAogICAgICAgVGhlIHJlcXVlc3QgbWFkZSB0byB0aGUgc2VydmVyIHdpbGwgbG9vayBzb21ldGhpbmcgbGlrZSB0aGlzOgogICAgICAgYGBgCiAgICAgIEdFVCAiL2FwaS92MS9wZXJzb24/cGFnZT0xIgogICAgICBgYGAKICAgICAgIC0tLQogICAgICAgSWYgeW91IGRvIHNvbWV0aGluZyBsaWtlIHRoaXM6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHN0b3JlLnF1ZXJ5KCdwZXJzb24nLCB7IGlkczogWzEsIDIsIDNdIH0pOwogICAgICBgYGAKICAgICAgIFRoZSByZXF1ZXN0IG1hZGUgdG8gdGhlIHNlcnZlciB3aWxsIGxvb2sgc29tZXRoaW5nIGxpa2UgdGhpczoKICAgICAgIGBgYAogICAgICBHRVQgIi9hcGkvdjEvcGVyc29uP2lkcyU1QiU1RD0xJmlkcyU1QiU1RD0yJmlkcyU1QiU1RD0zIgogICAgICBkZWNvZGVkOiAiL2FwaS92MS9wZXJzb24/aWRzW109MSZpZHNbXT0yJmlkc1tdPTMiCiAgICAgIGBgYAogICAgICAgVGhpcyBtZXRob2QgcmV0dXJucyBhIHByb21pc2UsIHdoaWNoIGlzIHJlc29sdmVkIHdpdGggYW4KICAgICAgW2BBZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXlgXSgvZW1iZXItZGF0YS9yZWxlYXNlL2NsYXNzZXMvQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5KQogICAgICBvbmNlIHRoZSBzZXJ2ZXIgcmV0dXJucy4KICAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBxdWVyeQogICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICAgIEBwYXJhbSB7YW55fSBxdWVyeSBhbiBvcGFxdWUgcXVlcnkgdG8gYmUgdXNlZCBieSB0aGUgYWRhcHRlcgogICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBvcHRpb25hbCwgbWF5IGluY2x1ZGUgYGFkYXB0ZXJPcHRpb25zYCBoYXNoIHdoaWNoIHdpbGwgYmUgcGFzc2VkIHRvIGFkYXB0ZXIucXVlcnkKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucXVlcnkgPSBmdW5jdGlvbiBxdWVyeShtb2RlbE5hbWUsIF9xdWVyeTIsIG9wdGlvbnMpIHsKICAgICAgdmFyIGFkYXB0ZXJPcHRpb25zV3JhcHBlciA9IHt9OwoKICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5hZGFwdGVyT3B0aW9ucykgewogICAgICAgIGFkYXB0ZXJPcHRpb25zV3JhcHBlci5hZGFwdGVyT3B0aW9ucyA9IG9wdGlvbnMuYWRhcHRlck9wdGlvbnM7CiAgICAgIH0KCiAgICAgIHZhciBub3JtYWxpemVkTW9kZWxOYW1lID0gbm9ybWFsaXplTW9kZWxOYW1lKG1vZGVsTmFtZSk7CiAgICAgIHJldHVybiB0aGlzLl9xdWVyeShub3JtYWxpemVkTW9kZWxOYW1lLCBfcXVlcnkyLCBudWxsLCBhZGFwdGVyT3B0aW9uc1dyYXBwZXIpOwogICAgfTsKCiAgICBfcHJvdG8uX3F1ZXJ5ID0gZnVuY3Rpb24gX3F1ZXJ5JDEobW9kZWxOYW1lLCBxdWVyeSwgYXJyYXksIG9wdGlvbnMpIHsKICAgICAgdmFyIGFkYXB0ZXIgPSB0aGlzLmFkYXB0ZXJGb3IobW9kZWxOYW1lKTsKICAgICAgcmV0dXJuIHByb21pc2VBcnJheShfcXVlcnkoYWRhcHRlciwgdGhpcywgbW9kZWxOYW1lLCBxdWVyeSwgYXJyYXksIG9wdGlvbnMpKTsKICAgIH0KICAgIC8qKgogICAgICBUaGlzIG1ldGhvZCBtYWtlcyBhIHJlcXVlc3QgZm9yIG9uZSByZWNvcmQsIHdoZXJlIHRoZSBgaWRgIGlzIG5vdCBrbm93bgogICAgICBiZWZvcmVoYW5kIChpZiB0aGUgYGlkYCBpcyBrbm93biwgdXNlIFtgZmluZFJlY29yZGBdKFN0b3JlL21ldGhvZHMvZmluZFJlY29yZD9hbmNob3I9ZmluZFJlY29yZCkKICAgICAgaW5zdGVhZCkuCiAgICAgICBUaGlzIG1ldGhvZCBjYW4gYmUgdXNlZCB3aGVuIGl0IGlzIGNlcnRhaW4gdGhhdCB0aGUgc2VydmVyIHdpbGwgcmV0dXJuIGEKICAgICAgc2luZ2xlIG9iamVjdCBmb3IgdGhlIHByaW1hcnkgZGF0YS4KICAgICAgIEVhY2ggdGltZSB0aGlzIG1ldGhvZCBpcyBjYWxsZWQgYSBuZXcgcmVxdWVzdCBpcyBtYWRlIHRocm91Z2ggdGhlIGFkYXB0ZXIuCiAgICAgICBMZXQncyBhc3N1bWUgb3VyIEFQSSBwcm92aWRlcyBhbiBlbmRwb2ludCBmb3IgdGhlIGN1cnJlbnRseSBsb2dnZWQgaW4gdXNlcgogICAgICB2aWE6CiAgICAgICBgYGAKICAgICAgLy8gR0VUIC9hcGkvY3VycmVudF91c2VyCiAgICAgIHsKICAgICAgICB1c2VyOiB7CiAgICAgICAgICBpZDogMTIzNCwKICAgICAgICAgIHVzZXJuYW1lOiAnYWRtaW4nCiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgU2luY2UgdGhlIHNwZWNpZmljIGBpZGAgb2YgdGhlIGB1c2VyYCBpcyBub3Qga25vd24gYmVmb3JlaGFuZCwgd2UgY2FuIHVzZQogICAgICBgcXVlcnlSZWNvcmRgIHRvIGdldCB0aGUgdXNlcjoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgc3RvcmUucXVlcnlSZWNvcmQoJ3VzZXInLCB7fSkudGhlbihmdW5jdGlvbih1c2VyKSB7CiAgICAgICAgbGV0IHVzZXJuYW1lID0gdXNlci5nZXQoJ3VzZXJuYW1lJyk7CiAgICAgICAgY29uc29sZS5sb2coYEN1cnJlbnRseSBsb2dnZWQgaW4gYXMgJHt1c2VybmFtZX1gKTsKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgVGhlIHJlcXVlc3QgaXMgbWFkZSB0aHJvdWdoIHRoZSBhZGFwdGVycycgYHF1ZXJ5UmVjb3JkYDoKICAgICAgIGBgYGFwcC9hZGFwdGVycy91c2VyLmpzCiAgICAgIGltcG9ydCAkIGZyb20gJ2pxdWVyeSc7CiAgICAgIGltcG9ydCBBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXInOwogICAgICAgZXhwb3J0IGRlZmF1bHQgQWRhcHRlci5leHRlbmQoewogICAgICAgIHF1ZXJ5UmVjb3JkKG1vZGVsTmFtZSwgcXVlcnkpIHsKICAgICAgICAgIHJldHVybiAkLmdldEpTT04oJy9hcGkvY3VycmVudF91c2VyJyk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBOb3RlOiB0aGUgcHJpbWFyeSB1c2UgY2FzZSBmb3IgYHN0b3JlLnF1ZXJ5UmVjb3JkYCBpcyB3aGVuIGEgc2luZ2xlIHJlY29yZAogICAgICBpcyBxdWVyaWVkIGFuZCB0aGUgYGlkYCBpcyBub3Qga25vd24gYmVmb3JlaGFuZC4gSW4gYWxsIG90aGVyIGNhc2VzCiAgICAgIGBzdG9yZS5xdWVyeWAgYW5kIHVzaW5nIHRoZSBmaXJzdCBpdGVtIG9mIHRoZSBhcnJheSBpcyBsaWtlbHkgdGhlIHByZWZlcnJlZAogICAgICB3YXk6CiAgICAgICBgYGAKICAgICAgLy8gR0VUIC91c2Vycz91c2VybmFtZT11bmlxdWUKICAgICAgewogICAgICAgIGRhdGE6IFt7CiAgICAgICAgICBpZDogMTIzNCwKICAgICAgICAgIHR5cGU6ICd1c2VyJywKICAgICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgICAgdXNlcm5hbWU6ICJ1bmlxdWUiCiAgICAgICAgICB9CiAgICAgICAgfV0KICAgICAgfQogICAgICBgYGAKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgc3RvcmUucXVlcnkoJ3VzZXInLCB7IHVzZXJuYW1lOiAndW5pcXVlJyB9KS50aGVuKGZ1bmN0aW9uKHVzZXJzKSB7CiAgICAgICAgcmV0dXJuIHVzZXJzLmdldCgnZmlyc3RPYmplY3QnKTsKICAgICAgfSkudGhlbihmdW5jdGlvbih1c2VyKSB7CiAgICAgICAgbGV0IGlkID0gdXNlci5nZXQoJ2lkJyk7CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFRoaXMgbWV0aG9kIHJldHVybnMgYSBwcm9taXNlLCB3aGljaCByZXNvbHZlcyB3aXRoIHRoZSBmb3VuZCByZWNvcmQuCiAgICAgICBJZiB0aGUgYWRhcHRlciByZXR1cm5zIG5vIGRhdGEgZm9yIHRoZSBwcmltYXJ5IGRhdGEgb2YgdGhlIHBheWxvYWQsIHRoZW4KICAgICAgYHF1ZXJ5UmVjb3JkYCByZXNvbHZlcyB3aXRoIGBudWxsYDoKICAgICAgIGBgYAogICAgICAvLyBHRVQgL3VzZXJzP3VzZXJuYW1lPXVuaXF1ZQogICAgICB7CiAgICAgICAgZGF0YTogbnVsbAogICAgICB9CiAgICAgIGBgYAogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBzdG9yZS5xdWVyeVJlY29yZCgndXNlcicsIHsgdXNlcm5hbWU6ICd1bmlxdWUnIH0pLnRoZW4oZnVuY3Rpb24odXNlcikgewogICAgICAgIGNvbnNvbGUubG9nKHVzZXIpOyAvLyBudWxsCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBxdWVyeVJlY29yZAogICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICAgIEBwYXJhbSB7YW55fSBxdWVyeSBhbiBvcGFxdWUgcXVlcnkgdG8gYmUgdXNlZCBieSB0aGUgYWRhcHRlcgogICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBvcHRpb25hbCwgbWF5IGluY2x1ZGUgYGFkYXB0ZXJPcHRpb25zYCBoYXNoIHdoaWNoIHdpbGwgYmUgcGFzc2VkIHRvIGFkYXB0ZXIucXVlcnlSZWNvcmQKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSB3aGljaCByZXNvbHZlcyB3aXRoIHRoZSBmb3VuZCByZWNvcmQgb3IgYG51bGxgCiAgICAqLwogICAgOwoKICAgIF9wcm90by5xdWVyeVJlY29yZCA9IGZ1bmN0aW9uIHF1ZXJ5UmVjb3JkKG1vZGVsTmFtZSwgcXVlcnksIG9wdGlvbnMpIHsKICAgICAgdmFyIG5vcm1hbGl6ZWRNb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKICAgICAgdmFyIGFkYXB0ZXIgPSB0aGlzLmFkYXB0ZXJGb3Iobm9ybWFsaXplZE1vZGVsTmFtZSk7CiAgICAgIHZhciBhZGFwdGVyT3B0aW9uc1dyYXBwZXIgPSB7fTsKCiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuYWRhcHRlck9wdGlvbnMpIHsKICAgICAgICBhZGFwdGVyT3B0aW9uc1dyYXBwZXIuYWRhcHRlck9wdGlvbnMgPSBvcHRpb25zLmFkYXB0ZXJPcHRpb25zOwogICAgICB9CiAgICAgIHJldHVybiBwcm9taXNlT2JqZWN0KF9xdWVyeVJlY29yZChhZGFwdGVyLCB0aGlzLCBub3JtYWxpemVkTW9kZWxOYW1lLCBxdWVyeSwgYWRhcHRlck9wdGlvbnNXcmFwcGVyKS50aGVuKGZ1bmN0aW9uIChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgLy8gdGhlIHByb21pc2UgcmV0dXJuZWQgYnkgc3RvcmUucXVlcnlSZWNvcmQgaXMgZXhwZWN0ZWQgdG8gcmVzb2x2ZSB3aXRoCiAgICAgICAgLy8gYW4gaW5zdGFuY2Ugb2YgTW9kZWwKICAgICAgICBpZiAoaW50ZXJuYWxNb2RlbCkgewogICAgICAgICAgcmV0dXJuIGludGVybmFsTW9kZWwuZ2V0UmVjb3JkKCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSkpOwogICAgfQogICAgLyoqCiAgICAgIGBmaW5kQWxsYCBhc2tzIHRoZSBhZGFwdGVyJ3MgYGZpbmRBbGxgIG1ldGhvZCB0byBmaW5kIHRoZSByZWNvcmRzIGZvciB0aGUKICAgICAgZ2l2ZW4gdHlwZSwgYW5kIHJldHVybnMgYSBwcm9taXNlIHdoaWNoIHdpbGwgcmVzb2x2ZSB3aXRoIGFsbCByZWNvcmRzIG9mCiAgICAgIHRoaXMgdHlwZSBwcmVzZW50IGluIHRoZSBzdG9yZSwgZXZlbiBpZiB0aGUgYWRhcHRlciBvbmx5IHJldHVybnMgYSBzdWJzZXQKICAgICAgb2YgdGhlbS4KICAgICAgIGBgYGFwcC9yb3V0ZXMvYXV0aG9ycy5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgICBtb2RlbChwYXJhbXMpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnN0b3JlLmZpbmRBbGwoJ2F1dGhvcicpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgX1doZW5fIHRoZSByZXR1cm5lZCBwcm9taXNlIHJlc29sdmVzIGRlcGVuZHMgb24gdGhlIHJlbG9hZCBiZWhhdmlvciwKICAgICAgY29uZmlndXJlZCB2aWEgdGhlIHBhc3NlZCBgb3B0aW9uc2AgaGFzaCBhbmQgdGhlIHJlc3VsdCBvZiB0aGUgYWRhcHRlcidzCiAgICAgIGBzaG91bGRSZWxvYWRBbGxgIG1ldGhvZC4KICAgICAgICMjIyBSZWxvYWRpbmcKICAgICAgIElmIGB7IHJlbG9hZDogdHJ1ZSB9YCBpcyBwYXNzZWQgb3IgYGFkYXB0ZXIuc2hvdWxkUmVsb2FkQWxsYCBldmFsdWF0ZXMgdG8KICAgICAgYHRydWVgLCB0aGVuIHRoZSByZXR1cm5lZCBwcm9taXNlIHJlc29sdmVzIG9uY2UgdGhlIGFkYXB0ZXIgcmV0dXJucyBkYXRhLAogICAgICByZWdhcmRsZXNzIGlmIHRoZXJlIGFyZSBhbHJlYWR5IHJlY29yZHMgaW4gdGhlIHN0b3JlOgogICAgICAgYGBganMKICAgICAgc3RvcmUucHVzaCh7CiAgICAgICAgZGF0YTogewogICAgICAgICAgaWQ6ICdmaXJzdCcsCiAgICAgICAgICB0eXBlOiAnYXV0aG9yJwogICAgICAgIH0KICAgICAgfSk7CiAgICAgICAvLyBhZGFwdGVyI2ZpbmRBbGwgcmVzb2x2ZXMgd2l0aAogICAgICAvLyBbCiAgICAgIC8vICAgewogICAgICAvLyAgICAgaWQ6ICdzZWNvbmQnLAogICAgICAvLyAgICAgdHlwZTogJ2F1dGhvcicKICAgICAgLy8gICB9CiAgICAgIC8vIF0KICAgICAgc3RvcmUuZmluZEFsbCgnYXV0aG9yJywgeyByZWxvYWQ6IHRydWUgfSkudGhlbihmdW5jdGlvbihhdXRob3JzKSB7CiAgICAgICAgYXV0aG9ycy5nZXRFYWNoKCdpZCcpOyAvLyBbJ2ZpcnN0JywgJ3NlY29uZCddCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIElmIG5vIHJlbG9hZCBpcyBpbmRpY2F0ZWQgdmlhIHRoZSBhYm92ZSBtZW50aW9uZWQgd2F5cywgdGhlbiB0aGUgcHJvbWlzZQogICAgICBpbW1lZGlhdGVseSByZXNvbHZlcyB3aXRoIGFsbCB0aGUgcmVjb3JkcyBjdXJyZW50bHkgbG9hZGVkIGluIHRoZSBzdG9yZS4KICAgICAgICMjIyBCYWNrZ3JvdW5kIFJlbG9hZGluZwogICAgICAgT3B0aW9uYWxseSwgaWYgYGFkYXB0ZXIuc2hvdWxkQmFja2dyb3VuZFJlbG9hZEFsbGAgZXZhbHVhdGVzIHRvIGB0cnVlYCwKICAgICAgdGhlbiBhIGJhY2tncm91bmQgcmVsb2FkIGlzIHN0YXJ0ZWQuIE9uY2UgdGhpcyByZXNvbHZlcywgdGhlIGFycmF5IHdpdGgKICAgICAgd2hpY2ggdGhlIHByb21pc2UgcmVzb2x2ZXMsIGlzIHVwZGF0ZWQgYXV0b21hdGljYWxseSBzbyBpdCBjb250YWlucyBhbGwgdGhlCiAgICAgIHJlY29yZHMgaW4gdGhlIHN0b3JlOgogICAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBBZGFwdGVyIGZyb20gJ0BlbWJlci1kYXRhL2FkYXB0ZXInOwogICAgICBleHBvcnQgZGVmYXVsdCBBZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgc2hvdWxkUmVsb2FkQWxsKHN0b3JlLCBzbmFwc2hvdHNBcnJheSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgIHNob3VsZEJhY2tncm91bmRSZWxvYWRBbGwoc3RvcmUsIHNuYXBzaG90c0FycmF5KSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAgLy8gLi4uCiAgICAgICBzdG9yZS5wdXNoKHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICBpZDogJ2ZpcnN0JywKICAgICAgICAgIHR5cGU6ICdhdXRob3InCiAgICAgICAgfQogICAgICB9KTsKICAgICAgIGxldCBhbGxBdXRob3JzOwogICAgICBzdG9yZS5maW5kQWxsKCdhdXRob3InKS50aGVuKGZ1bmN0aW9uKGF1dGhvcnMpIHsKICAgICAgICBhdXRob3JzLmdldEVhY2goJ2lkJyk7IC8vIFsnZmlyc3QnXQogICAgICAgICBhbGxBdXRob3JzID0gYXV0aG9yczsKICAgICAgfSk7CiAgICAgICAvLyBsYXRlciwgb25jZSBhZGFwdGVyI2ZpbmRBbGwgcmVzb2x2ZWQgd2l0aAogICAgICAvLyBbCiAgICAgIC8vICAgewogICAgICAvLyAgICAgaWQ6ICdzZWNvbmQnLAogICAgICAvLyAgICAgdHlwZTogJ2F1dGhvcicKICAgICAgLy8gICB9CiAgICAgIC8vIF0KICAgICAgIGFsbEF1dGhvcnMuZ2V0RWFjaCgnaWQnKTsgLy8gWydmaXJzdCcsICdzZWNvbmQnXQogICAgICBgYGAKICAgICAgIElmIHlvdSB3b3VsZCBsaWtlIHRvIGZvcmNlIG9yIHByZXZlbnQgYmFja2dyb3VuZCByZWxvYWRpbmcsIHlvdSBjYW4gc2V0IGEKICAgICAgYm9vbGVhbiB2YWx1ZSBmb3IgYGJhY2tncm91bmRSZWxvYWRgIGluIHRoZSBvcHRpb25zIG9iamVjdCBmb3IKICAgICAgYGZpbmRBbGxgLgogICAgICAgYGBgYXBwL3JvdXRlcy9wb3N0L2VkaXQuanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgICAgbW9kZWwoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5zdG9yZS5maW5kQWxsKCdwb3N0JywgeyBiYWNrZ3JvdW5kUmVsb2FkOiBmYWxzZSB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIElmIHlvdSBwYXNzIGFuIG9iamVjdCBvbiB0aGUgYGFkYXB0ZXJPcHRpb25zYCBwcm9wZXJ0eSBvZiB0aGUgb3B0aW9ucwogICAgICBhcmd1bWVudCBpdCB3aWxsIGJlIHBhc3NlZCB0byB5b3UgYWRhcHRlciB2aWEgdGhlIGBzbmFwc2hvdFJlY29yZEFycmF5YAogICAgICAgYGBgYXBwL3JvdXRlcy9wb3N0cy5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgICBtb2RlbChwYXJhbXMpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnN0b3JlLmZpbmRBbGwoJ3Bvc3QnLCB7CiAgICAgICAgICAgIGFkYXB0ZXJPcHRpb25zOiB7IHN1YnNjcmliZTogZmFsc2UgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBgYGBhcHAvYWRhcHRlcnMvcG9zdC5qcwogICAgICBpbXBvcnQgTXlDdXN0b21BZGFwdGVyIGZyb20gJy4vY3VzdG9tLWFkYXB0ZXInOwogICAgICAgZXhwb3J0IGRlZmF1bHQgTXlDdXN0b21BZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgZmluZEFsbChzdG9yZSwgdHlwZSwgc2luY2VUb2tlbiwgc25hcHNob3RSZWNvcmRBcnJheSkgewogICAgICAgICAgaWYgKHNuYXBzaG90UmVjb3JkQXJyYXkuYWRhcHRlck9wdGlvbnMuc3Vic2NyaWJlKSB7CiAgICAgICAgICAgIC8vIC4uLgogICAgICAgICAgfQogICAgICAgICAgLy8gLi4uCiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBTZWUgW3BlZWtBbGxdKFN0b3JlL21ldGhvZHMvcGVla0FsbD9hbmNob3I9cGVla0FsbCkgdG8gZ2V0IGFuIGFycmF5IG9mIGN1cnJlbnQgcmVjb3JkcyBpbiB0aGUKICAgICAgc3RvcmUsIHdpdGhvdXQgd2FpdGluZyB1bnRpbCBhIHJlbG9hZCBpcyBmaW5pc2hlZC4KICAgICAgICMjIyBSZXRyaWV2aW5nIFJlbGF0ZWQgTW9kZWwgUmVjb3JkcwogICAgICAgSWYgeW91IHVzZSBhbiBhZGFwdGVyIHN1Y2ggYXMgRW1iZXIncyBkZWZhdWx0CiAgICAgIFtgSlNPTkFQSUFkYXB0ZXJgXSgvZW1iZXItZGF0YS9yZWxlYXNlL2NsYXNzZXMvSlNPTkFQSUFkYXB0ZXIpCiAgICAgIHRoYXQgc3VwcG9ydHMgdGhlIFtKU09OIEFQSSBzcGVjaWZpY2F0aW9uXShodHRwOi8vanNvbmFwaS5vcmcvKSBhbmQgaWYgeW91ciBzZXJ2ZXIKICAgICAgZW5kcG9pbnQgc3VwcG9ydHMgdGhlIHVzZSBvZiBhbgogICAgICBbJ2luY2x1ZGUnIHF1ZXJ5IHBhcmFtZXRlcl0oaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZmV0Y2hpbmctaW5jbHVkZXMpLAogICAgICB5b3UgY2FuIHVzZSBgZmluZEFsbCgpYCB0byBhdXRvbWF0aWNhbGx5IHJldHJpZXZlIGFkZGl0aW9uYWwgcmVjb3JkcyByZWxhdGVkIHRvCiAgICAgIHRob3NlIHJlcXVlc3RlZCBieSBzdXBwbHlpbmcgYW4gYGluY2x1ZGVgIHBhcmFtZXRlciBpbiB0aGUgYG9wdGlvbnNgIG9iamVjdC4KICAgICAgIEZvciBleGFtcGxlLCBnaXZlbiBhIGBwb3N0YCBtb2RlbCB0aGF0IGhhcyBhIGBoYXNNYW55YCByZWxhdGlvbnNoaXAgd2l0aCBhIGBjb21tZW50YAogICAgICBtb2RlbCwgd2hlbiB3ZSByZXRyaWV2ZSBhbGwgb2YgdGhlIHBvc3QgcmVjb3JkcyB3ZSBjYW4gaGF2ZSB0aGUgc2VydmVyIGFsc28gcmV0dXJuCiAgICAgIGFsbCBvZiB0aGUgcG9zdHMnIGNvbW1lbnRzIGluIHRoZSBzYW1lIHJlcXVlc3Q6CiAgICAgICBgYGBhcHAvcm91dGVzL3Bvc3RzLmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoewogICAgICAgIG1vZGVsKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmUuZmluZEFsbCgncG9zdCcsIHsgaW5jbHVkZTogJ2NvbW1lbnRzJyB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAgYGBgCiAgICAgIE11bHRpcGxlIHJlbGF0aW9uc2hpcHMgY2FuIGJlIHJlcXVlc3RlZCB1c2luZyBhbiBgaW5jbHVkZWAgcGFyYW1ldGVyIGNvbnNpc3Rpbmcgb2YgYQogICAgICBjb21tYS1zZXBhcmF0ZWQgbGlzdCAod2l0aG91dCB3aGl0ZS1zcGFjZSkgd2hpbGUgbmVzdGVkIHJlbGF0aW9uc2hpcHMgY2FuIGJlIHNwZWNpZmllZAogICAgICB1c2luZyBhIGRvdC1zZXBhcmF0ZWQgc2VxdWVuY2Ugb2YgcmVsYXRpb25zaGlwIG5hbWVzLiBTbyB0byByZXF1ZXN0IGJvdGggdGhlIHBvc3RzJwogICAgICBjb21tZW50cyBhbmQgdGhlIGF1dGhvcnMgb2YgdGhvc2UgY29tbWVudHMgdGhlIHJlcXVlc3Qgd291bGQgbG9vayBsaWtlIHRoaXM6CiAgICAgICBgYGBhcHAvcm91dGVzL3Bvc3RzLmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoewogICAgICAgIG1vZGVsKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmUuZmluZEFsbCgncG9zdCcsIHsgaW5jbHVkZTogJ2NvbW1lbnRzLGNvbW1lbnRzLmF1dGhvcicgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgIGBgYAogICAgICAgU2VlIFtxdWVyeV0oU3RvcmUvbWV0aG9kcy9xdWVyeT9hbmNob3I9cXVlcnkpIHRvIG9ubHkgZ2V0IGEgc3Vic2V0IG9mIHJlY29yZHMgZnJvbSB0aGUgc2VydmVyLgogICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIGZpbmRBbGwKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgICAqLwogICAgOwoKICAgIF9wcm90by5maW5kQWxsID0gZnVuY3Rpb24gZmluZEFsbChtb2RlbE5hbWUsIG9wdGlvbnMpIHsKICAgICAgdmFyIG5vcm1hbGl6ZWRNb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKCiAgICAgIHZhciBmZXRjaCA9IHRoaXMuX2ZldGNoQWxsKG5vcm1hbGl6ZWRNb2RlbE5hbWUsIHRoaXMucGVla0FsbChub3JtYWxpemVkTW9kZWxOYW1lKSwgb3B0aW9ucyk7CgogICAgICByZXR1cm4gZmV0Y2g7CiAgICB9CiAgICAvKioKICAgICAgQG1ldGhvZCBfZmV0Y2hBbGwKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtNb2RlbH0gbW9kZWxOYW1lCiAgICAgIEBwYXJhbSB7UmVjb3JkQXJyYXl9IGFycmF5CiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICovCiAgICA7CgogICAgX3Byb3RvLl9mZXRjaEFsbCA9IGZ1bmN0aW9uIF9mZXRjaEFsbChtb2RlbE5hbWUsIGFycmF5LCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIHZhciBhZGFwdGVyID0gdGhpcy5hZGFwdGVyRm9yKG1vZGVsTmFtZSk7CgogICAgICBpZiAob3B0aW9ucy5yZWxvYWQpIHsKICAgICAgICBFbWJlci5zZXQoYXJyYXksICdpc1VwZGF0aW5nJywgdHJ1ZSk7CiAgICAgICAgcmV0dXJuIHByb21pc2VBcnJheShfZmluZEFsbChhZGFwdGVyLCB0aGlzLCBtb2RlbE5hbWUsIG9wdGlvbnMpKTsKICAgICAgfQoKICAgICAgdmFyIHNuYXBzaG90QXJyYXkgPSBhcnJheS5fY3JlYXRlU25hcHNob3Qob3B0aW9ucyk7CgogICAgICBpZiAoYWRhcHRlci5zaG91bGRSZWxvYWRBbGwodGhpcywgc25hcHNob3RBcnJheSkpIHsKICAgICAgICBFbWJlci5zZXQoYXJyYXksICdpc1VwZGF0aW5nJywgdHJ1ZSk7CiAgICAgICAgcmV0dXJuIHByb21pc2VBcnJheShfZmluZEFsbChhZGFwdGVyLCB0aGlzLCBtb2RlbE5hbWUsIG9wdGlvbnMpKTsKICAgICAgfQoKICAgICAgaWYgKG9wdGlvbnMuYmFja2dyb3VuZFJlbG9hZCA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm4gcHJvbWlzZUFycmF5KEVtYmVyLlJTVlAuUHJvbWlzZS5yZXNvbHZlKGFycmF5KSk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLmJhY2tncm91bmRSZWxvYWQgfHwgYWRhcHRlci5zaG91bGRCYWNrZ3JvdW5kUmVsb2FkQWxsKHRoaXMsIHNuYXBzaG90QXJyYXkpKSB7CiAgICAgICAgRW1iZXIuc2V0KGFycmF5LCAnaXNVcGRhdGluZycsIHRydWUpOwoKICAgICAgICBfZmluZEFsbChhZGFwdGVyLCB0aGlzLCBtb2RlbE5hbWUsIG9wdGlvbnMpOwogICAgICB9CgogICAgICByZXR1cm4gcHJvbWlzZUFycmF5KEVtYmVyLlJTVlAuUHJvbWlzZS5yZXNvbHZlKGFycmF5KSk7CiAgICB9CiAgICAvKioKICAgICAgQG1ldGhvZCBfZGlkVXBkYXRlQWxsCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgICAgQHByaXZhdGUKICAgICovCiAgICA7CgogICAgX3Byb3RvLl9kaWRVcGRhdGVBbGwgPSBmdW5jdGlvbiBfZGlkVXBkYXRlQWxsKG1vZGVsTmFtZSkgewogICAgICB0aGlzLnJlY29yZEFycmF5TWFuYWdlci5fZGlkVXBkYXRlQWxsKG1vZGVsTmFtZSk7CiAgICB9CiAgICAvKioKICAgICAgVGhpcyBtZXRob2QgcmV0dXJucyBhIGZpbHRlcmVkIGFycmF5IHRoYXQgY29udGFpbnMgYWxsIG9mIHRoZQogICAgICBrbm93biByZWNvcmRzIGZvciBhIGdpdmVuIHR5cGUgaW4gdGhlIHN0b3JlLgogICAgICAgTm90ZSB0aGF0IGJlY2F1c2UgaXQncyBqdXN0IGEgZmlsdGVyLCB0aGUgcmVzdWx0IHdpbGwgY29udGFpbiBhbnkKICAgICAgbG9jYWxseSBjcmVhdGVkIHJlY29yZHMgb2YgdGhlIHR5cGUsIGhvd2V2ZXIsIGl0IHdpbGwgbm90IG1ha2UgYQogICAgICByZXF1ZXN0IHRvIHRoZSBiYWNrZW5kIHRvIHJldHJpZXZlIGFkZGl0aW9uYWwgcmVjb3Jkcy4gSWYgeW91CiAgICAgIHdvdWxkIGxpa2UgdG8gcmVxdWVzdCBhbGwgdGhlIHJlY29yZHMgZnJvbSB0aGUgYmFja2VuZCBwbGVhc2UgdXNlCiAgICAgIFtzdG9yZS5maW5kQWxsXShTdG9yZS9tZXRob2RzL2ZpbmRBbGw/YW5jaG9yPWZpbmRBbGwpLgogICAgICAgQWxzbyBub3RlIHRoYXQgbXVsdGlwbGUgY2FsbHMgdG8gYHBlZWtBbGxgIGZvciBhIGdpdmVuIHR5cGUgd2lsbCBhbHdheXMKICAgICAgcmV0dXJuIHRoZSBzYW1lIGBSZWNvcmRBcnJheWAuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGxldCBsb2NhbFBvc3RzID0gc3RvcmUucGVla0FsbCgncG9zdCcpOwogICAgICBgYGAKICAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBwZWVrQWxsCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgICAgQHJldHVybiB7UmVjb3JkQXJyYXl9CiAgICAqLwogICAgOwoKICAgIF9wcm90by5wZWVrQWxsID0gZnVuY3Rpb24gcGVla0FsbChtb2RlbE5hbWUpIHsKICAgICAgdmFyIG5vcm1hbGl6ZWRNb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKICAgICAgcmV0dXJuIHRoaXMucmVjb3JkQXJyYXlNYW5hZ2VyLmxpdmVSZWNvcmRBcnJheUZvcihub3JtYWxpemVkTW9kZWxOYW1lKTsKICAgIH0KICAgIC8qKgogICAgICBUaGlzIG1ldGhvZCB1bmxvYWRzIGFsbCByZWNvcmRzIGluIHRoZSBzdG9yZS4KICAgICAgSXQgc2NoZWR1bGVzIHVubG9hZGluZyB0byBoYXBwZW4gZHVyaW5nIHRoZSBuZXh0IHJ1biBsb29wLgogICAgICAgT3B0aW9uYWxseSB5b3UgY2FuIHBhc3MgYSB0eXBlIHdoaWNoIHVubG9hZCBhbGwgcmVjb3JkcyBmb3IgYSBnaXZlbiB0eXBlLgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBzdG9yZS51bmxvYWRBbGwoKTsKICAgICAgc3RvcmUudW5sb2FkQWxsKCdwb3N0Jyk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCB1bmxvYWRBbGwKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgKi8KICAgIDsKCiAgICBfcHJvdG8udW5sb2FkQWxsID0gZnVuY3Rpb24gdW5sb2FkQWxsKG1vZGVsTmFtZSkgewogICAgICB2YXIgZmFjdG9yeSA9IGludGVybmFsTW9kZWxGYWN0b3J5Rm9yKHRoaXMpOwoKICAgICAgaWYgKG1vZGVsTmFtZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgZmFjdG9yeS5jbGVhcigpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBub3JtYWxpemVkTW9kZWxOYW1lID0gbm9ybWFsaXplTW9kZWxOYW1lKG1vZGVsTmFtZSk7CiAgICAgICAgZmFjdG9yeS5jbGVhcihub3JtYWxpemVkTW9kZWxOYW1lKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uZmlsdGVyID0gZnVuY3Rpb24gZmlsdGVyKCkgewogICAgfSAvLyAuLi4uLi4uLi4uLi4uLgogICAgLy8gLiBQRVJTSVNUSU5HIC4KICAgIC8vIC4uLi4uLi4uLi4uLi4uCgogICAgLyoqCiAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBieSBgcmVjb3JkLnNhdmVgLCBhbmQgZ2V0cyBwYXNzZWQgYQogICAgICByZXNvbHZlciBmb3IgdGhlIHByb21pc2UgdGhhdCBgcmVjb3JkLnNhdmVgIHJldHVybnMuCiAgICAgICBJdCBzY2hlZHVsZXMgc2F2aW5nIHRvIGhhcHBlbiBhdCB0aGUgZW5kIG9mIHRoZSBydW4gbG9vcC4KICAgICAgIEBtZXRob2Qgc2NoZWR1bGVTYXZlCiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7SW50ZXJuYWxNb2RlbH0gaW50ZXJuYWxNb2RlbAogICAgICBAcGFyYW0ge1Jlc29sdmVyfSByZXNvbHZlcgogICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgKi8KICAgIDsKCiAgICBfcHJvdG8uc2NoZWR1bGVTYXZlID0gZnVuY3Rpb24gc2NoZWR1bGVTYXZlKGludGVybmFsTW9kZWwsIHJlc29sdmVyLCBvcHRpb25zKSB7CiAgICAgIHZhciBfdGhpczYgPSB0aGlzOwoKICAgICAgdmFyIHNuYXBzaG90ID0gaW50ZXJuYWxNb2RlbC5jcmVhdGVTbmFwc2hvdChvcHRpb25zKTsKCiAgICAgIGlmIChpbnRlcm5hbE1vZGVsLl9pc1JlY29yZEZ1bGx5RGVsZXRlZCgpKSB7CiAgICAgICAgcmVzb2x2ZXIucmVzb2x2ZSgpOwogICAgICAgIHJldHVybiByZXNvbHZlci5wcm9taXNlOwogICAgICB9CgogICAgICBpbnRlcm5hbE1vZGVsLmFkYXB0ZXJXaWxsQ29tbWl0KCk7CgogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuUkVRVUVTVF9TRVJWSUNFKSB7CiAgICAgICAgaWYgKCFvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0ge307CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVjb3JkRGF0YSA9IGludGVybmFsTW9kZWwuX3JlY29yZERhdGE7CiAgICAgICAgdmFyIG9wZXJhdGlvbiA9ICd1cGRhdGVSZWNvcmQnOyAvLyBUT0RPIGhhbmRsZSBtaXNzaW5nIGlzTmV3CgogICAgICAgIGlmIChyZWNvcmREYXRhLmlzTmV3ICYmIHJlY29yZERhdGEuaXNOZXcoKSkgewogICAgICAgICAgb3BlcmF0aW9uID0gJ2NyZWF0ZVJlY29yZCc7CiAgICAgICAgfSBlbHNlIGlmIChyZWNvcmREYXRhLmlzRGVsZXRlZCAmJiByZWNvcmREYXRhLmlzRGVsZXRlZCgpKSB7CiAgICAgICAgICBvcGVyYXRpb24gPSAnZGVsZXRlUmVjb3JkJzsKICAgICAgICB9CgogICAgICAgIG9wdGlvbnNbU2F2ZU9wXSA9IG9wZXJhdGlvbjsKCiAgICAgICAgdmFyIGZldGNoTWFuYWdlclByb21pc2UgPSB0aGlzLl9mZXRjaE1hbmFnZXIuc2NoZWR1bGVTYXZlKGludGVybmFsTW9kZWwuaWRlbnRpZmllciwgb3B0aW9ucyk7CgogICAgICAgIHZhciBwcm9taXNlID0gZmV0Y2hNYW5hZ2VyUHJvbWlzZS50aGVuKGZ1bmN0aW9uIChwYXlsb2FkKSB7CiAgICAgICAgICAvKgogICAgICAgICAgTm90ZSB0byBmdXR1cmUgc3BlbHVua2VycyBob3BpbmcgdG8gb3B0aW1pemUuCiAgICAgICAgICBXZSByZWx5IG9uIHRoaXMgYHJ1bmAgdG8gY3JlYXRlIGEgcnVuIGxvb3AgaWYgbmVlZGVkCiAgICAgICAgICB0aGF0IGBzdG9yZS5fcHVzaGAgYW5kIGBzdG9yZS5kaWRTYXZlUmVjb3JkYCB3aWxsIGJvdGggc2hhcmUuCiAgICAgICAgICBXZSB1c2UgYGpvaW5gIGJlY2F1c2UgaXQgaXMgb2Z0ZW4gdGhlIGNhc2UgdGhhdCB3ZQogICAgICAgICAgaGF2ZSBhbiBvdXRlciBydW4gbG9vcCBhdmFpbGFibGUgc3RpbGwgZnJvbSB0aGUgZmlyc3QKICAgICAgICAgIGNhbGwgdG8gYHN0b3JlLl9wdXNoYDsKICAgICAgICAgICovCiAgICAgICAgICBfdGhpczYuX2JhY2tidXJuZXIuam9pbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBkYXRhID0gcGF5bG9hZCAmJiBwYXlsb2FkLmRhdGE7CgogICAgICAgICAgICBfdGhpczYuZGlkU2F2ZVJlY29yZChpbnRlcm5hbE1vZGVsLCB7CiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9LCBvcGVyYXRpb24pOwoKICAgICAgICAgICAgaWYgKHBheWxvYWQgJiYgcGF5bG9hZC5pbmNsdWRlZCkgewogICAgICAgICAgICAgIF90aGlzNi5fcHVzaCh7CiAgICAgICAgICAgICAgICBkYXRhOiBudWxsLAogICAgICAgICAgICAgICAgaW5jbHVkZWQ6IHBheWxvYWQuaW5jbHVkZWQKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSwgZnVuY3Rpb24gKF9yZWYpIHsKICAgICAgICAgIHZhciBlcnJvciA9IF9yZWYuZXJyb3IsCiAgICAgICAgICAgICAgcGFyc2VkRXJyb3JzID0gX3JlZi5wYXJzZWRFcnJvcnM7CgogICAgICAgICAgX3RoaXM2LnJlY29yZFdhc0ludmFsaWQoaW50ZXJuYWxNb2RlbCwgcGFyc2VkRXJyb3JzLCBlcnJvcik7CgogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgIH0KCiAgICAgIHRoaXMuX3BlbmRpbmdTYXZlLnB1c2goewogICAgICAgIHNuYXBzaG90OiBzbmFwc2hvdCwKICAgICAgICByZXNvbHZlcjogcmVzb2x2ZXIKICAgICAgfSk7CgogICAgICBlbWJlclJ1biQyLnNjaGVkdWxlT25jZSgnYWN0aW9ucycsIHRoaXMsIHRoaXMuZmx1c2hQZW5kaW5nU2F2ZSk7CiAgICB9CiAgICAvKioKICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGF0IHRoZSBlbmQgb2YgdGhlIHJ1biBsb29wLCBhbmQKICAgICAgZmx1c2hlcyBhbnkgcmVjb3JkcyBwYXNzZWQgaW50byBgc2NoZWR1bGVTYXZlYAogICAgICAgQG1ldGhvZCBmbHVzaFBlbmRpbmdTYXZlCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgOwoKICAgIF9wcm90by5mbHVzaFBlbmRpbmdTYXZlID0gZnVuY3Rpb24gZmx1c2hQZW5kaW5nU2F2ZSgpIHsKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFUVVFU1RfU0VSVklDRSkgewogICAgICAgIC8vIGFzc2VydCBoZXJlCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgcGVuZGluZyA9IHRoaXMuX3BlbmRpbmdTYXZlLnNsaWNlKCk7CgogICAgICB0aGlzLl9wZW5kaW5nU2F2ZSA9IFtdOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBwZW5kaW5nLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgIHZhciBwZW5kaW5nSXRlbSA9IHBlbmRpbmdbaV07CiAgICAgICAgdmFyIHNuYXBzaG90ID0gcGVuZGluZ0l0ZW0uc25hcHNob3Q7CiAgICAgICAgdmFyIHJlc29sdmVyID0gcGVuZGluZ0l0ZW0ucmVzb2x2ZXI7CiAgICAgICAgdmFyIGludGVybmFsTW9kZWwgPSBzbmFwc2hvdC5faW50ZXJuYWxNb2RlbDsKICAgICAgICB2YXIgYWRhcHRlciA9IHRoaXMuYWRhcHRlckZvcihpbnRlcm5hbE1vZGVsLm1vZGVsTmFtZSk7CiAgICAgICAgdmFyIG9wZXJhdGlvbiA9IHZvaWQgMDsKCiAgICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFQ09SRF9EQVRBX1NUQVRFKSB7CiAgICAgICAgICAvLyBUT0RPIG1vdmUgdGhpcyBvdXQgb2YgaW50ZXJuYWxNb2RlbAogICAgICAgICAgaWYgKGludGVybmFsTW9kZWwuaXNOZXcoKSkgewogICAgICAgICAgICBvcGVyYXRpb24gPSAnY3JlYXRlUmVjb3JkJzsKICAgICAgICAgIH0gZWxzZSBpZiAoaW50ZXJuYWxNb2RlbC5pc0RlbGV0ZWQoKSkgewogICAgICAgICAgICBvcGVyYXRpb24gPSAnZGVsZXRlUmVjb3JkJzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9wZXJhdGlvbiA9ICd1cGRhdGVSZWNvcmQnOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoaW50ZXJuYWxNb2RlbC5jdXJyZW50U3RhdGUuc3RhdGVOYW1lID09PSAncm9vdC5kZWxldGVkLnNhdmVkJykgewogICAgICAgICAgICByZXNvbHZlci5yZXNvbHZlKCk7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfSBlbHNlIGlmIChpbnRlcm5hbE1vZGVsLmlzTmV3KCkpIHsKICAgICAgICAgICAgb3BlcmF0aW9uID0gJ2NyZWF0ZVJlY29yZCc7CiAgICAgICAgICB9IGVsc2UgaWYgKGludGVybmFsTW9kZWwuaXNEZWxldGVkKCkpIHsKICAgICAgICAgICAgb3BlcmF0aW9uID0gJ2RlbGV0ZVJlY29yZCc7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvcGVyYXRpb24gPSAndXBkYXRlUmVjb3JkJzsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJlc29sdmVyLnJlc29sdmUoX2NvbW1pdChhZGFwdGVyLCB0aGlzLCBvcGVyYXRpb24sIHNuYXBzaG90KSk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgb25jZSB0aGUgcHJvbWlzZSByZXR1cm5lZCBieSBhbgogICAgICBhZGFwdGVyJ3MgYGNyZWF0ZVJlY29yZGAsIGB1cGRhdGVSZWNvcmRgIG9yIGBkZWxldGVSZWNvcmRgCiAgICAgIGlzIHJlc29sdmVkLgogICAgICAgSWYgdGhlIGRhdGEgcHJvdmlkZXMgYSBzZXJ2ZXItZ2VuZXJhdGVkIElELCBpdCB3aWxsCiAgICAgIHVwZGF0ZSB0aGUgcmVjb3JkIGFuZCB0aGUgc3RvcmUncyBpbmRleGVzLgogICAgICAgQG1ldGhvZCBkaWRTYXZlUmVjb3JkCiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7SW50ZXJuYWxNb2RlbH0gaW50ZXJuYWxNb2RlbCB0aGUgaW4tZmxpZ2h0IGludGVybmFsIG1vZGVsCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIG9wdGlvbmFsIGRhdGEgKHNlZSBhYm92ZSkKICAgICAgQHBhcmFtIHtzdHJpbmd9IG9wIHRoZSBhZGFwdGVyIG9wZXJhdGlvbiB0aGF0IHdhcyBjb21taXR0ZWQKICAgICovCiAgICA7CgogICAgX3Byb3RvLmRpZFNhdmVSZWNvcmQgPSBmdW5jdGlvbiBkaWRTYXZlUmVjb3JkKGludGVybmFsTW9kZWwsIGRhdGFBcmcsIG9wKSB7CgogICAgICB2YXIgZGF0YTsKCiAgICAgIGlmIChkYXRhQXJnKSB7CiAgICAgICAgZGF0YSA9IGRhdGFBcmcuZGF0YTsKICAgICAgfQoKICAgICAgewogICAgICAgIHZhciBjYWNoZSA9IGlkZW50aWZpZXJDYWNoZUZvcih0aGlzKTsKICAgICAgICB2YXIgX2lkZW50aWZpZXIzID0gaW50ZXJuYWxNb2RlbC5pZGVudGlmaWVyOwoKICAgICAgICBpZiAob3AgIT09ICdkZWxldGVSZWNvcmQnICYmIGRhdGEpIHsKICAgICAgICAgIGNhY2hlLnVwZGF0ZVJlY29yZElkZW50aWZpZXIoX2lkZW50aWZpZXIzLCBkYXRhKTsKICAgICAgICB9CiAgICAgIH0gLy9XZSBmaXJzdCBtYWtlIHN1cmUgdGhlIHByaW1hcnkgZGF0YSBoYXMgYmVlbiB1cGRhdGVkCiAgICAgIC8vVE9ETyB0cnkgdG8gbW92ZSBub3RpZmljYXRpb24gdG8gdGhlIHVzZXIgdG8gdGhlIGVuZCBvZiB0aGUgcnVubG9vcAoKCiAgICAgIGludGVybmFsTW9kZWwuYWRhcHRlckRpZENvbW1pdChkYXRhKTsKICAgIH0KICAgIC8qKgogICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgb25jZSB0aGUgcHJvbWlzZSByZXR1cm5lZCBieSBhbgogICAgICBhZGFwdGVyJ3MgYGNyZWF0ZVJlY29yZGAsIGB1cGRhdGVSZWNvcmRgIG9yIGBkZWxldGVSZWNvcmRgCiAgICAgIGlzIHJlamVjdGVkIHdpdGggYSBgSW52YWxpZEVycm9yYC4KICAgICAgIEBtZXRob2QgcmVjb3JkV2FzSW52YWxpZAogICAgICBAcHJpdmF0ZQogICAgICBAcGFyYW0ge0ludGVybmFsTW9kZWx9IGludGVybmFsTW9kZWwKICAgICAgQHBhcmFtIHtPYmplY3R9IGVycm9ycwogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucmVjb3JkV2FzSW52YWxpZCA9IGZ1bmN0aW9uIHJlY29yZFdhc0ludmFsaWQoaW50ZXJuYWxNb2RlbCwgcGFyc2VkRXJyb3JzLCBlcnJvcikgewoKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLlJFQ09SRF9EQVRBX0VSUk9SUykgewogICAgICAgIGludGVybmFsTW9kZWwuYWRhcHRlckRpZEludmFsaWRhdGUocGFyc2VkRXJyb3JzLCBlcnJvcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC5hZGFwdGVyRGlkSW52YWxpZGF0ZShwYXJzZWRFcnJvcnMpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIG9uY2UgdGhlIHByb21pc2UgcmV0dXJuZWQgYnkgYW4KICAgICAgYWRhcHRlcidzIGBjcmVhdGVSZWNvcmRgLCBgdXBkYXRlUmVjb3JkYCBvciBgZGVsZXRlUmVjb3JkYAogICAgICBpcyByZWplY3RlZCAod2l0aCBhbnl0aGluZyBvdGhlciB0aGFuIGEgYEludmFsaWRFcnJvcmApLgogICAgICAgQG1ldGhvZCByZWNvcmRXYXNFcnJvcgogICAgICBAcHJpdmF0ZQogICAgICBAcGFyYW0ge0ludGVybmFsTW9kZWx9IGludGVybmFsTW9kZWwKICAgICAgQHBhcmFtIHtFcnJvcn0gZXJyb3IKICAgICovCiAgICA7CgogICAgX3Byb3RvLnJlY29yZFdhc0Vycm9yID0gZnVuY3Rpb24gcmVjb3JkV2FzRXJyb3IoaW50ZXJuYWxNb2RlbCwgZXJyb3IpIHsKCiAgICAgIGludGVybmFsTW9kZWwuYWRhcHRlckRpZEVycm9yKGVycm9yKTsKICAgIH0KICAgIC8qKgogICAgICBTZXRzIG5ld2x5IHJlY2VpdmVkIElEIGZyb20gdGhlIGFkYXB0ZXIncyBgY3JlYXRlUmVjb3JkYCwgYHVwZGF0ZVJlY29yZGAKICAgICAgb3IgYGRlbGV0ZVJlY29yZGAuCiAgICAgICBAbWV0aG9kIHNldFJlY29yZElkCiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgICAgQHBhcmFtIHtzdHJpbmd9IG5ld0lkCiAgICAgIEBwYXJhbSB7c3RyaW5nfSBjbGllbnRJZAogICAgICovCiAgICA7CgogICAgX3Byb3RvLnNldFJlY29yZElkID0gZnVuY3Rpb24gc2V0UmVjb3JkSWQobW9kZWxOYW1lLCBuZXdJZCwgY2xpZW50SWQpIHsKCiAgICAgIGludGVybmFsTW9kZWxGYWN0b3J5Rm9yKHRoaXMpLnNldFJlY29yZElkKG1vZGVsTmFtZSwgbmV3SWQsIGNsaWVudElkKTsKICAgIH0gLy8gLi4uLi4uLi4uLi4uLi4uLgogICAgLy8gLiBMT0FESU5HIERBVEEgLgogICAgLy8gLi4uLi4uLi4uLi4uLi4uLgoKICAgIC8qKgogICAgICBUaGlzIGludGVybmFsIG1ldGhvZCBpcyB1c2VkIGJ5IGBwdXNoYC4KICAgICAgIEBtZXRob2QgX2xvYWQKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtPYmplY3R9IGRhdGEKICAgICovCiAgICA7CgogICAgX3Byb3RvLl9sb2FkID0gZnVuY3Rpb24gX2xvYWQoZGF0YSkgewogICAgICB2YXIgcmVzb3VyY2UgPSBjb25zdHJ1Y3RSZXNvdXJjZShub3JtYWxpemVNb2RlbE5hbWUoZGF0YS50eXBlKSwgZW5zdXJlU3RyaW5nSWQoZGF0YS5pZCksIGNvZXJjZUlkKGRhdGEubGlkKSk7CiAgICAgIHZhciBpbnRlcm5hbE1vZGVsID0gaW50ZXJuYWxNb2RlbEZhY3RvcnlGb3IodGhpcykubG9va3VwKHJlc291cmNlLCBkYXRhKTsgLy8gc3RvcmUucHVzaCB3aWxsIGJlIGZyb20gZW1wdHkKICAgICAgLy8gZmluZFJlY29yZCB3aWxsIGJlIGZyb20gcm9vdC5sb2FkaW5nCiAgICAgIC8vIGFsbCBlbHNlIHdpbGwgYmUgdXBkYXRlcwoKICAgICAgdmFyIGlzTG9hZGluZyA9IGludGVybmFsTW9kZWwuY3VycmVudFN0YXRlLnN0YXRlTmFtZSA9PT0gJ3Jvb3QubG9hZGluZyc7CiAgICAgIHZhciBpc1VwZGF0ZSA9IGludGVybmFsTW9kZWwuY3VycmVudFN0YXRlLmlzRW1wdHkgPT09IGZhbHNlICYmICFpc0xvYWRpbmc7CgogICAgICB7CiAgICAgICAgLy8gZXhjbHVkZSBzdG9yZS5wdXNoIChyb290LmVtcHR5KSBjYXNlCiAgICAgICAgaWYgKGlzVXBkYXRlIHx8IGlzTG9hZGluZykgewogICAgICAgICAgdmFyIF9pZGVudGlmaWVyNCA9IGludGVybmFsTW9kZWwuaWRlbnRpZmllcjsKICAgICAgICAgIHZhciB1cGRhdGVkSWRlbnRpZmllciA9IGlkZW50aWZpZXJDYWNoZUZvcih0aGlzKS51cGRhdGVSZWNvcmRJZGVudGlmaWVyKF9pZGVudGlmaWVyNCwgZGF0YSk7CgogICAgICAgICAgaWYgKHVwZGF0ZWRJZGVudGlmaWVyICE9PSBfaWRlbnRpZmllcjQpIHsKICAgICAgICAgICAgLy8gd2UgZW5jb3VudGVyZWQgYSBtZXJnZSBvZiBpZGVudGlmaWVycyBpbiB3aGljaAogICAgICAgICAgICAvLyB0d28gaWRlbnRpZmllcnMgKGFuZCBsaWtlbHkgdHdvIGludGVybmFsTW9kZWxzKQogICAgICAgICAgICAvLyBleGlzdGVkIGZvciB0aGUgc2FtZSByZXNvdXJjZS4gTm93IHRoYXQgd2UgaGF2ZQogICAgICAgICAgICAvLyBkZXRlcm1pbmVkIHRoZSBjb3JyZWN0IGlkZW50aWZpZXIgdG8gdXNlLCBtYWtlIHN1cmUKICAgICAgICAgICAgLy8gdGhhdCB3ZSBhbHNvIHVzZSB0aGUgY29ycmVjdCBpbnRlcm5hbE1vZGVsLgogICAgICAgICAgICBfaWRlbnRpZmllcjQgPSB1cGRhdGVkSWRlbnRpZmllcjsKICAgICAgICAgICAgaW50ZXJuYWxNb2RlbCA9IGludGVybmFsTW9kZWxGYWN0b3J5Rm9yKHRoaXMpLmxvb2t1cChfaWRlbnRpZmllcjQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaW50ZXJuYWxNb2RlbC5zZXR1cERhdGEoZGF0YSk7CgogICAgICBpZiAoaXNVcGRhdGUpIHsKICAgICAgICB0aGlzLnJlY29yZEFycmF5TWFuYWdlci5yZWNvcmREaWRDaGFuZ2UoaW50ZXJuYWxNb2RlbCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5yZWNvcmRBcnJheU1hbmFnZXIucmVjb3JkV2FzTG9hZGVkKGludGVybmFsTW9kZWwpOwogICAgICB9CgogICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbDsKICAgIH0KICAgIC8qKgogICAgICBQdXNoIHNvbWUgZGF0YSBmb3IgYSBnaXZlbiB0eXBlIGludG8gdGhlIHN0b3JlLgogICAgICAgVGhpcyBtZXRob2QgZXhwZWN0cyBub3JtYWxpemVkIFtKU09OIEFQSV0oaHR0cDovL2pzb25hcGkub3JnLykgZG9jdW1lbnQuIFRoaXMgbWVhbnMgeW91IGhhdmUgdG8gZm9sbG93IFtKU09OIEFQSSBzcGVjaWZpY2F0aW9uXShodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0Lykgd2l0aCBmZXcgbWlub3IgYWRqdXN0bWVudHM6CiAgICAgIC0gcmVjb3JkJ3MgYHR5cGVgIHNob3VsZCBhbHdheXMgYmUgaW4gc2luZ3VsYXIsIGRhc2hlcml6ZWQgZm9ybQogICAgICAtIG1lbWJlcnMgKHByb3BlcnRpZXMpIHNob3VsZCBiZSBjYW1lbENhc2VkCiAgICAgICBbWW91ciBwcmltYXJ5IGRhdGEgc2hvdWxkIGJlIHdyYXBwZWQgaW5zaWRlIGBkYXRhYCBwcm9wZXJ0eV0oaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZG9jdW1lbnQtdG9wLWxldmVsKToKICAgICAgIGBgYGpzCiAgICAgIHN0b3JlLnB1c2goewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIC8vIHByaW1hcnkgZGF0YSBmb3Igc2luZ2xlIHJlY29yZCBvZiB0eXBlIGBQZXJzb25gCiAgICAgICAgICBpZDogJzEnLAogICAgICAgICAgdHlwZTogJ3BlcnNvbicsCiAgICAgICAgICBhdHRyaWJ1dGVzOiB7CiAgICAgICAgICAgIGZpcnN0TmFtZTogJ0RhbmllbCcsCiAgICAgICAgICAgIGxhc3ROYW1lOiAnS21haycKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFtEZW1vLl0oaHR0cDovL2VtYmVyLXR3aWRkbGUuY29tL2ZiOTlmMThjZDNiNGQzZTJhNGM3KQogICAgICAgYGRhdGFgIHByb3BlcnR5IGNhbiBhbHNvIGhvbGQgYW4gYXJyYXkgKG9mIHJlY29yZHMpOgogICAgICAgYGBganMKICAgICAgc3RvcmUucHVzaCh7CiAgICAgICAgZGF0YTogWwogICAgICAgICAgLy8gYW4gYXJyYXkgb2YgcmVjb3JkcwogICAgICAgICAgewogICAgICAgICAgICBpZDogJzEnLAogICAgICAgICAgICB0eXBlOiAncGVyc29uJywKICAgICAgICAgICAgYXR0cmlidXRlczogewogICAgICAgICAgICAgIGZpcnN0TmFtZTogJ0RhbmllbCcsCiAgICAgICAgICAgICAgbGFzdE5hbWU6ICdLbWFrJwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgewogICAgICAgICAgICBpZDogJzInLAogICAgICAgICAgICB0eXBlOiAncGVyc29uJywKICAgICAgICAgICAgYXR0cmlidXRlczogewogICAgICAgICAgICAgIGZpcnN0TmFtZTogJ1RvbScsCiAgICAgICAgICAgICAgbGFzdE5hbWU6ICdEYWxlJwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgXQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBbRGVtby5dKGh0dHA6Ly9lbWJlci10d2lkZGxlLmNvbS82OWNkYmVhYTM3MDIxNTlkYzM1NSkKICAgICAgIFRoZXJlIGFyZSBzb21lIHR5cGljYWwgcHJvcGVydGllcyBmb3IgYEpTT05BUElgIHBheWxvYWQ6CiAgICAgICogYGlkYCAtIG1hbmRhdG9yeSwgdW5pcXVlIHJlY29yZCdzIGtleQogICAgICAqIGB0eXBlYCAtIG1hbmRhdG9yeSBzdHJpbmcgd2hpY2ggbWF0Y2hlcyBgbW9kZWxgJ3MgZGFzaGVyaXplZCBuYW1lIGluIHNpbmd1bGFyIGZvcm0KICAgICAgKiBgYXR0cmlidXRlc2AgLSBvYmplY3Qgd2hpY2ggaG9sZHMgZGF0YSBmb3IgcmVjb3JkIGF0dHJpYnV0ZXMgLSBgYXR0cmAncyBkZWNsYXJlZCBpbiBtb2RlbAogICAgICAqIGByZWxhdGlvbnNoaXBzYCAtIG9iamVjdCB3aGljaCBtdXN0IGNvbnRhaW4gYW55IG9mIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllcyB1bmRlciBlYWNoIHJlbGF0aW9uc2hpcHMnIHJlc3BlY3RpdmUga2V5IChleGFtcGxlIHBhdGggaXMgYHJlbGF0aW9uc2hpcHMuYWNoaWV2ZW1lbnRzLmRhdGFgKToKICAgICAgICAtIFtgbGlua3NgXShodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0LyNkb2N1bWVudC1saW5rcykKICAgICAgICAtIFtgZGF0YWBdKGh0dHA6Ly9qc29uYXBpLm9yZy9mb3JtYXQvI2RvY3VtZW50LXJlc291cmNlLW9iamVjdC1saW5rYWdlKSAtIHBsYWNlIGZvciBwcmltYXJ5IGRhdGEKICAgICAgICAtIFtgbWV0YWBdKGh0dHA6Ly9qc29uYXBpLm9yZy9mb3JtYXQvI2RvY3VtZW50LW1ldGEpIC0gb2JqZWN0IHdoaWNoIGNvbnRhaW5zIG1ldGEtaW5mb3JtYXRpb24gYWJvdXQgcmVsYXRpb25zaGlwCiAgICAgICBGb3IgdGhpcyBtb2RlbDoKICAgICAgIGBgYGFwcC9tb2RlbHMvcGVyc29uLmpzCiAgICAgIGltcG9ydCBNb2RlbCwgeyBhdHRyLCBoYXNNYW55IH0gZnJvbSAnQGVtYmVyLWRhdGEvbW9kZWwnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgTW9kZWwuZXh0ZW5kKHsKICAgICAgICBmaXJzdE5hbWU6IGF0dHIoJ3N0cmluZycpLAogICAgICAgIGxhc3ROYW1lOiBhdHRyKCdzdHJpbmcnKSwKICAgICAgICAgY2hpbGRyZW46IGhhc01hbnkoJ3BlcnNvbicpCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFRvIHJlcHJlc2VudCB0aGUgY2hpbGRyZW4gYXMgSURzOgogICAgICAgYGBganMKICAgICAgewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIGlkOiAnMScsCiAgICAgICAgICB0eXBlOiAncGVyc29uJywKICAgICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgICAgZmlyc3ROYW1lOiAnVG9tJywKICAgICAgICAgICAgbGFzdE5hbWU6ICdEYWxlJwogICAgICAgICAgfSwKICAgICAgICAgIHJlbGF0aW9uc2hpcHM6IHsKICAgICAgICAgICAgY2hpbGRyZW46IHsKICAgICAgICAgICAgICBkYXRhOiBbCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlkOiAnMicsCiAgICAgICAgICAgICAgICAgIHR5cGU6ICdwZXJzb24nCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZDogJzMnLAogICAgICAgICAgICAgICAgICB0eXBlOiAncGVyc29uJwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWQ6ICc0JywKICAgICAgICAgICAgICAgICAgdHlwZTogJ3BlcnNvbicKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICBbRGVtby5dKGh0dHA6Ly9lbWJlci10d2lkZGxlLmNvbS8zNDNlMTczNWUwMzQwOTFmNWJkZSkKICAgICAgIFRvIHJlcHJlc2VudCB0aGUgY2hpbGRyZW4gcmVsYXRpb25zaGlwIGFzIGEgVVJMOgogICAgICAgYGBganMKICAgICAgewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIGlkOiAnMScsCiAgICAgICAgICB0eXBlOiAncGVyc29uJywKICAgICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgICAgZmlyc3ROYW1lOiAnVG9tJywKICAgICAgICAgICAgbGFzdE5hbWU6ICdEYWxlJwogICAgICAgICAgfSwKICAgICAgICAgIHJlbGF0aW9uc2hpcHM6IHsKICAgICAgICAgICAgY2hpbGRyZW46IHsKICAgICAgICAgICAgICBsaW5rczogewogICAgICAgICAgICAgICAgcmVsYXRlZDogJy9wZW9wbGUvMS9jaGlsZHJlbicKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICBJZiB5b3UncmUgc3RyZWFtaW5nIGRhdGEgb3IgaW1wbGVtZW50aW5nIGFuIGFkYXB0ZXIsIG1ha2Ugc3VyZQogICAgICB0aGF0IHlvdSBoYXZlIGNvbnZlcnRlZCB0aGUgaW5jb21pbmcgZGF0YSBpbnRvIHRoaXMgZm9ybS4gVGhlCiAgICAgIHN0b3JlJ3MgW25vcm1hbGl6ZV0oU3RvcmUvbWV0aG9kcy9ub3JtYWxpemU/YW5jaG9yPW5vcm1hbGl6ZSkgbWV0aG9kIGlzIGEgY29udmVuaWVuY2UKICAgICAgaGVscGVyIGZvciBjb252ZXJ0aW5nIGEganNvbiBwYXlsb2FkIGludG8gdGhlIGZvcm0gRW1iZXIgRGF0YQogICAgICBleHBlY3RzLgogICAgICAgYGBganMKICAgICAgc3RvcmUucHVzaChzdG9yZS5ub3JtYWxpemUoJ3BlcnNvbicsIGRhdGEpKTsKICAgICAgYGBgCiAgICAgICBUaGlzIG1ldGhvZCBjYW4gYmUgdXNlZCBib3RoIHRvIHB1c2ggaW4gYnJhbmQgbmV3CiAgICAgIHJlY29yZHMsIGFzIHdlbGwgYXMgdG8gdXBkYXRlIGV4aXN0aW5nIHJlY29yZHMuCiAgICAgICBAbWV0aG9kIHB1c2gKICAgICAgQHBhcmFtIHtPYmplY3R9IGRhdGEKICAgICAgQHJldHVybiB0aGUgcmVjb3JkKHMpIHRoYXQgd2FzIGNyZWF0ZWQgb3IKICAgICAgICB1cGRhdGVkLgogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucHVzaCA9IGZ1bmN0aW9uIHB1c2goZGF0YSkgewoKICAgICAgdmFyIHB1c2hlZCA9IHRoaXMuX3B1c2goZGF0YSk7CgogICAgICBpZiAoQXJyYXkuaXNBcnJheShwdXNoZWQpKSB7CiAgICAgICAgdmFyIHJlY29yZHMgPSBwdXNoZWQubWFwKGZ1bmN0aW9uIChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbC5nZXRSZWNvcmQoKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVjb3JkczsKICAgICAgfQoKICAgICAgaWYgKHB1c2hlZCA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICB2YXIgcmVjb3JkID0gcHVzaGVkLmdldFJlY29yZCgpOwogICAgICByZXR1cm4gcmVjb3JkOwogICAgfQogICAgLyoKICAgICAgUHVzaCBzb21lIGRhdGEgaW4gdGhlIGZvcm0gb2YgYSBqc29uLWFwaSBkb2N1bWVudCBpbnRvIHRoZSBzdG9yZSwKICAgICAgd2l0aG91dCBjcmVhdGluZyBtYXRlcmlhbGl6ZWQgcmVjb3Jkcy4KICAgICAgIEBtZXRob2QgX3B1c2gKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtPYmplY3R9IGpzb25BcGlEb2MKICAgICAgQHJldHVybiB7SW50ZXJuYWxNb2RlbHxBcnJheTxJbnRlcm5hbE1vZGVsPn0gcHVzaGVkIEludGVybmFsTW9kZWwocykKICAgICovCiAgICA7CgogICAgX3Byb3RvLl9wdXNoID0gZnVuY3Rpb24gX3B1c2goanNvbkFwaURvYykgewogICAgICB2YXIgX3RoaXM3ID0gdGhpczsKCiAgICAgIHZhciBpbnRlcm5hbE1vZGVsT3JNb2RlbHMgPSB0aGlzLl9iYWNrYnVybmVyLmpvaW4oZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBpbmNsdWRlZCA9IGpzb25BcGlEb2MuaW5jbHVkZWQ7CiAgICAgICAgdmFyIGksIGxlbmd0aDsKCiAgICAgICAgaWYgKGluY2x1ZGVkKSB7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBpbmNsdWRlZC5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBfdGhpczcuX3B1c2hJbnRlcm5hbE1vZGVsKGluY2x1ZGVkW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGpzb25BcGlEb2MuZGF0YSkpIHsKICAgICAgICAgIGxlbmd0aCA9IGpzb25BcGlEb2MuZGF0YS5sZW5ndGg7CiAgICAgICAgICB2YXIgaW50ZXJuYWxNb2RlbHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKCiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaW50ZXJuYWxNb2RlbHNbaV0gPSBfdGhpczcuX3B1c2hJbnRlcm5hbE1vZGVsKGpzb25BcGlEb2MuZGF0YVtpXSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGludGVybmFsTW9kZWxzOwogICAgICAgIH0KCiAgICAgICAgaWYgKGpzb25BcGlEb2MuZGF0YSA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHJldHVybiBfdGhpczcuX3B1c2hJbnRlcm5hbE1vZGVsKGpzb25BcGlEb2MuZGF0YSk7CiAgICAgIH0pOyAvLyB0aGlzIHR5cGVjYXN0IGlzIG5lY2Vzc2FyeSBiZWNhdXNlIGBiYWNrYnVybmVyLmpvaW5gIGlzIG1pc3R5cGVkIHRvIHJldHVybiB2b2lkCgoKICAgICAgcmV0dXJuIGludGVybmFsTW9kZWxPck1vZGVsczsKICAgIH07CgogICAgX3Byb3RvLl9wdXNoSW50ZXJuYWxNb2RlbCA9IGZ1bmN0aW9uIF9wdXNoSW50ZXJuYWxNb2RlbChkYXRhKSB7CiAgICAgIHZhciBtb2RlbE5hbWUgPSBkYXRhLnR5cGU7CgoKICAgICAgdmFyIGludGVybmFsTW9kZWwgPSB0aGlzLl9sb2FkKGRhdGEpOyAvLyAgICB0aGlzLl9zZXR1cFJlbGF0aW9uc2hpcHNGb3JNb2RlbChpbnRlcm5hbE1vZGVsLCBkYXRhKTsKCgogICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbDsKICAgIH0KICAgIC8qKgogICAgICBQdXNoIHNvbWUgcmF3IGRhdGEgaW50byB0aGUgc3RvcmUuCiAgICAgICBUaGlzIG1ldGhvZCBjYW4gYmUgdXNlZCBib3RoIHRvIHB1c2ggaW4gYnJhbmQgbmV3CiAgICAgIHJlY29yZHMsIGFzIHdlbGwgYXMgdG8gdXBkYXRlIGV4aXN0aW5nIHJlY29yZHMuIFlvdQogICAgICBjYW4gcHVzaCBpbiBtb3JlIHRoYW4gb25lIHR5cGUgb2Ygb2JqZWN0IGF0IG9uY2UuCiAgICAgIEFsbCBvYmplY3RzIHNob3VsZCBiZSBpbiB0aGUgZm9ybWF0IGV4cGVjdGVkIGJ5IHRoZQogICAgICBzZXJpYWxpemVyLgogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBSRVNUU2VyaWFsaXplciBmcm9tICdAZW1iZXItZGF0YS9zZXJpYWxpemVyL3Jlc3QnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUkVTVFNlcmlhbGl6ZXI7CiAgICAgIGBgYAogICAgICAgYGBganMKICAgICAgbGV0IHB1c2hEYXRhID0gewogICAgICAgIHBvc3RzOiBbCiAgICAgICAgICB7IGlkOiAxLCBwb3N0VGl0bGU6ICJHcmVhdCBwb3N0IiwgY29tbWVudElkczogWzJdIH0KICAgICAgICBdLAogICAgICAgIGNvbW1lbnRzOiBbCiAgICAgICAgICB7IGlkOiAyLCBjb21tZW50Qm9keTogIkluc2lnaHRmdWwgY29tbWVudCIgfQogICAgICAgIF0KICAgICAgfQogICAgICAgc3RvcmUucHVzaFBheWxvYWQocHVzaERhdGEpOwogICAgICBgYGAKICAgICAgIEJ5IGRlZmF1bHQsIHRoZSBkYXRhIHdpbGwgYmUgZGVzZXJpYWxpemVkIHVzaW5nIGEgZGVmYXVsdAogICAgICBzZXJpYWxpemVyICh0aGUgYXBwbGljYXRpb24gc2VyaWFsaXplciBpZiBpdCBleGlzdHMpLgogICAgICAgQWx0ZXJuYXRpdmVseSwgYHB1c2hQYXlsb2FkYCB3aWxsIGFjY2VwdCBhIG1vZGVsIHR5cGUgd2hpY2gKICAgICAgd2lsbCBkZXRlcm1pbmUgd2hpY2ggc2VyaWFsaXplciB3aWxsIHByb2Nlc3MgdGhlIHBheWxvYWQuCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IFJFU1RTZXJpYWxpemVyIGZyb20gJ0BlbWJlci1kYXRhL3NlcmlhbGl6ZXIvcmVzdCc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSRVNUU2VyaWFsaXplcjsKICAgICAgYGBgCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvcG9zdC5qcwogICAgICBpbXBvcnQgSlNPTlNlcmlhbGl6ZXIgZnJvbSAnQGVtYmVyLWRhdGEvc2VyaWFsaXplci9qc29uJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IEpTT05TZXJpYWxpemVyOwogICAgICBgYGAKICAgICAgIGBgYGpzCiAgICAgIHN0b3JlLnB1c2hQYXlsb2FkKHB1c2hEYXRhKTsgLy8gV2lsbCB1c2UgdGhlIGFwcGxpY2F0aW9uIHNlcmlhbGl6ZXIKICAgICAgc3RvcmUucHVzaFBheWxvYWQoJ3Bvc3QnLCBwdXNoRGF0YSk7IC8vIFdpbGwgdXNlIHRoZSBwb3N0IHNlcmlhbGl6ZXIKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHB1c2hQYXlsb2FkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUgT3B0aW9uYWxseSwgYSBtb2RlbCB0eXBlIHVzZWQgdG8gZGV0ZXJtaW5lIHdoaWNoIHNlcmlhbGl6ZXIgd2lsbCBiZSB1c2VkCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBpbnB1dFBheWxvYWQKICAgICovCiAgICA7CgogICAgX3Byb3RvLnB1c2hQYXlsb2FkID0gZnVuY3Rpb24gcHVzaFBheWxvYWQobW9kZWxOYW1lLCBpbnB1dFBheWxvYWQpIHsKCiAgICAgIHZhciBzZXJpYWxpemVyOwogICAgICB2YXIgcGF5bG9hZDsKCiAgICAgIGlmICghaW5wdXRQYXlsb2FkKSB7CiAgICAgICAgcGF5bG9hZCA9IG1vZGVsTmFtZTsKICAgICAgICBzZXJpYWxpemVyID0gdGhpcy5zZXJpYWxpemVyRm9yKCdhcHBsaWNhdGlvbicpOwogICAgICB9IGVsc2UgewogICAgICAgIHBheWxvYWQgPSBpbnB1dFBheWxvYWQ7CiAgICAgICAgdmFyIG5vcm1hbGl6ZWRNb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKICAgICAgICBzZXJpYWxpemVyID0gdGhpcy5zZXJpYWxpemVyRm9yKG5vcm1hbGl6ZWRNb2RlbE5hbWUpOwogICAgICB9CiAgICAgIHNlcmlhbGl6ZXIucHVzaFBheWxvYWQodGhpcywgcGF5bG9hZCk7CiAgICB9OwoKICAgIF9wcm90by5yZWxvYWRNYW55QXJyYXkgPSBmdW5jdGlvbiByZWxvYWRNYW55QXJyYXkobWFueUFycmF5LCBpbnRlcm5hbE1vZGVsLCBrZXksIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIGludGVybmFsTW9kZWwucmVsb2FkSGFzTWFueShrZXksIG9wdGlvbnMpOwogICAgfTsKCiAgICBfcHJvdG8ucmVsb2FkQmVsb25nc1RvID0gZnVuY3Rpb24gcmVsb2FkQmVsb25nc1RvKGJlbG9uZ3NUb1Byb3h5LCBpbnRlcm5hbE1vZGVsLCBrZXksIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIGludGVybmFsTW9kZWwucmVsb2FkQmVsb25nc1RvKGtleSwgb3B0aW9ucyk7CiAgICB9OwoKICAgIF9wcm90by5faW50ZXJuYWxNb2RlbEZvclJlc291cmNlID0gZnVuY3Rpb24gX2ludGVybmFsTW9kZWxGb3JSZXNvdXJjZShyZXNvdXJjZSkgewogICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbEZhY3RvcnlGb3IodGhpcykuZ2V0QnlSZXNvdXJjZShyZXNvdXJjZSk7CiAgICB9CiAgICAvKioKICAgICAqIFRPRE8gT25seSBuZWVkZWQgdGVtcG9yYXJpbHkgZm9yIHRlc3Qgc3VwcG9ydAogICAgICoKICAgICAqIEBpbnRlcm5hbAogICAgICovCiAgICA7CgogICAgX3Byb3RvLl9pbnRlcm5hbE1vZGVsRm9ySWQgPSBmdW5jdGlvbiBfaW50ZXJuYWxNb2RlbEZvcklkKHR5cGUsIGlkLCBsaWQpIHsKICAgICAgdmFyIHJlc291cmNlID0gY29uc3RydWN0UmVzb3VyY2UodHlwZSwgaWQsIGxpZCk7CiAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsRmFjdG9yeUZvcih0aGlzKS5sb29rdXAocmVzb3VyY2UpOwogICAgfTsKCiAgICBfcHJvdG8uc2VyaWFsaXplUmVjb3JkID0gZnVuY3Rpb24gc2VyaWFsaXplUmVjb3JkKHJlY29yZCwgb3B0aW9ucykgewogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuQ1VTVE9NX01PREVMX0NMQVNTKSB7CiAgICAgICAgdmFyIF9pZGVudGlmaWVyNSA9IHJlY29yZElkZW50aWZpZXJGb3IocmVjb3JkKTsKCiAgICAgICAgdmFyIGludGVybmFsTW9kZWwgPSBpbnRlcm5hbE1vZGVsRmFjdG9yeUZvcih0aGlzKS5wZWVrKF9pZGVudGlmaWVyNSk7IC8vIFRPRE8gd2UgdXNlZCB0byBjaGVjayBpZiB0aGUgcmVjb3JkIHdhcyBkZXN0cm95ZWQgaGVyZQoKICAgICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbC5jcmVhdGVTbmFwc2hvdChvcHRpb25zKS5zZXJpYWxpemUob3B0aW9ucyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdzZXJpYWxpemVSZWNvcmQgaXMgb25seSBhdmFpbGFibGUgd2hlbiBDVVNUT01fTU9ERUxfQ0xBU1MgZmYgaXMgb24nKTsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uc2F2ZVJlY29yZCA9IGZ1bmN0aW9uIHNhdmVSZWNvcmQocmVjb3JkLCBvcHRpb25zKSB7CiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MpIHsKICAgICAgICB2YXIgX2lkZW50aWZpZXI2ID0gcmVjb3JkSWRlbnRpZmllckZvcihyZWNvcmQpOwoKICAgICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IGludGVybmFsTW9kZWxGYWN0b3J5Rm9yKHRoaXMpLnBlZWsoX2lkZW50aWZpZXI2KTsgLy8gVE9ETyB3ZSB1c2VkIHRvIGNoZWNrIGlmIHRoZSByZWNvcmQgd2FzIGRlc3Ryb3llZCBoZXJlCiAgICAgICAgLy8gQ2FzdGluZyBjYW4gYmUgcmVtb3ZlZCBvbmNlIFJFUVVFU1RfU0VSVklDRSBmZiBpcyB0dXJuZWQgb24KICAgICAgICAvLyBiZWNhdXNlIGEgYFJlY29yZGAgaXMgcHJvdmlkZWQgdGhlcmUgd2lsbCBhbHdheXMgYmUgYSBtYXRjaGluZyBpbnRlcm5hbE1vZGVsCgogICAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsLnNhdmUob3B0aW9ucykudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gcmVjb3JkOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignc2F2ZVJlY29yZCBpcyBvbmx5IGF2YWlsYWJsZSB3aGVuIENVU1RPTV9NT0RFTF9DTEFTUyBmZiBpcyBvbicpOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5yZWxhdGlvbnNoaXBSZWZlcmVuY2VGb3IgPSBmdW5jdGlvbiByZWxhdGlvbnNoaXBSZWZlcmVuY2VGb3IoaWRlbnRpZmllciwga2V5KSB7CiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MpIHsKICAgICAgICB2YXIgc3RhYmxlSWRlbnRpZmllciA9IGlkZW50aWZpZXJDYWNoZUZvcih0aGlzKS5nZXRPckNyZWF0ZVJlY29yZElkZW50aWZpZXIoaWRlbnRpZmllcik7CiAgICAgICAgdmFyIGludGVybmFsTW9kZWwgPSBpbnRlcm5hbE1vZGVsRmFjdG9yeUZvcih0aGlzKS5wZWVrKHN0YWJsZUlkZW50aWZpZXIpOyAvLyBUT0RPIHdlIHVzZWQgdG8gY2hlY2sgaWYgdGhlIHJlY29yZCB3YXMgZGVzdHJveWVkIGhlcmUKCiAgICAgICAgcmV0dXJuIGludGVybmFsTW9kZWwucmVmZXJlbmNlRm9yKG51bGwsIGtleSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdyZWxhdGlvbnNoaXBSZWZlcmVuY2VGb3IgaXMgb25seSBhdmFpbGFibGUgd2hlbiBDVVNUT01fTU9ERUxfQ0xBU1MgZmYgaXMgb24nKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBAaW50ZXJuYWwKICAgICAqLwogICAgOwoKICAgIF9wcm90by5fY3JlYXRlUmVjb3JkRGF0YSA9IGZ1bmN0aW9uIF9jcmVhdGVSZWNvcmREYXRhKGlkZW50aWZpZXIpIHsKICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlUmVjb3JkRGF0YUZvcihpZGVudGlmaWVyLnR5cGUsIGlkZW50aWZpZXIuaWQsIGlkZW50aWZpZXIubGlkLCB0aGlzLl9zdG9yZVdyYXBwZXIpOwogICAgfQogICAgLyoqCiAgICAgKiBJbnN0YW50aWF0aW9uIGhvb2sgYWxsb3dpbmcgYXBwbGljYXRpb25zIG9yIGFkZG9ucyB0byBjb25maWd1cmUgdGhlIHN0b3JlCiAgICAgKiB0byB1dGlsaXplIGEgY3VzdG9tIFJlY29yZERhdGEgaW1wbGVtZW50YXRpb24uCiAgICAgKgogICAgICogQHBhcmFtIG1vZGVsTmFtZQogICAgICogQHBhcmFtIGlkCiAgICAgKiBAcGFyYW0gY2xpZW50SWQKICAgICAqIEBwYXJhbSBzdG9yZVdyYXBwZXIKICAgICAqLwogICAgOwoKICAgIF9wcm90by5jcmVhdGVSZWNvcmREYXRhRm9yID0gZnVuY3Rpb24gY3JlYXRlUmVjb3JkRGF0YUZvcihtb2RlbE5hbWUsIGlkLCBjbGllbnRJZCwgc3RvcmVXcmFwcGVyKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgc3RvcmUuY3JlYXRlUmVjb3JkRGF0YUZvciB0byBiZSBpbXBsZW1lbnRlZCBidXQgaXQgd2Fzbid0Iik7CiAgICB9CiAgICAvKioKICAgICAqIEBpbnRlcm5hbAogICAgICovCiAgICA7CgogICAgX3Byb3RvLl9fcmVjb3JkRGF0YUZvciA9IGZ1bmN0aW9uIF9fcmVjb3JkRGF0YUZvcihyZXNvdXJjZSkgewogICAgICB2YXIgaWRlbnRpZmllciA9IGlkZW50aWZpZXJDYWNoZUZvcih0aGlzKS5nZXRPckNyZWF0ZVJlY29yZElkZW50aWZpZXIocmVzb3VyY2UpOwogICAgICByZXR1cm4gdGhpcy5yZWNvcmREYXRhRm9yKGlkZW50aWZpZXIsIGZhbHNlKTsKICAgIH0KICAgIC8qKgogICAgICogQGludGVybmFsCiAgICAgKi8KICAgIDsKCiAgICBfcHJvdG8ucmVjb3JkRGF0YUZvciA9IGZ1bmN0aW9uIHJlY29yZERhdGFGb3IkMShpZGVudGlmaWVyLCBpc0NyZWF0ZSkgewogICAgICB2YXIgaW50ZXJuYWxNb2RlbDsKCiAgICAgIGlmIChpc0NyZWF0ZSA9PT0gdHJ1ZSkgewogICAgICAgIGludGVybmFsTW9kZWwgPSBpbnRlcm5hbE1vZGVsRmFjdG9yeUZvcih0aGlzKS5idWlsZCh7CiAgICAgICAgICB0eXBlOiBpZGVudGlmaWVyLnR5cGUsCiAgICAgICAgICBpZDogbnVsbAogICAgICAgIH0pOwogICAgICAgIGludGVybmFsTW9kZWwubG9hZGVkRGF0YSgpOwogICAgICAgIGludGVybmFsTW9kZWwuZGlkQ3JlYXRlUmVjb3JkKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbCA9IGludGVybmFsTW9kZWxGYWN0b3J5Rm9yKHRoaXMpLmxvb2t1cChpZGVudGlmaWVyKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlY29yZERhdGFGb3IoaW50ZXJuYWxNb2RlbCk7CiAgICB9CiAgICAvKioKICAgICAgYG5vcm1hbGl6ZWAgY29udmVydHMgYSBqc29uIHBheWxvYWQgaW50byB0aGUgbm9ybWFsaXplZCBmb3JtIHRoYXQKICAgICAgW3B1c2hdKFN0b3JlL21ldGhvZHMvcHVzaD9hbmNob3I9cHVzaCkgZXhwZWN0cy4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGpzCiAgICAgIHNvY2tldC5vbignbWVzc2FnZScsIGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgICBsZXQgbW9kZWxOYW1lID0gbWVzc2FnZS5tb2RlbDsKICAgICAgICBsZXQgZGF0YSA9IG1lc3NhZ2UuZGF0YTsKICAgICAgICBzdG9yZS5wdXNoKHN0b3JlLm5vcm1hbGl6ZShtb2RlbE5hbWUsIGRhdGEpKTsKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBub3JtYWxpemUKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZSBUaGUgbmFtZSBvZiB0aGUgbW9kZWwgdHlwZSBmb3IgdGhpcyBwYXlsb2FkCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEByZXR1cm4ge09iamVjdH0gVGhlIG5vcm1hbGl6ZWQgcGF5bG9hZAogICAgKi8KICAgIDsKCiAgICBfcHJvdG8ubm9ybWFsaXplID0gZnVuY3Rpb24gbm9ybWFsaXplKG1vZGVsTmFtZSwgcGF5bG9hZCkgewogICAgICB2YXIgbm9ybWFsaXplZE1vZGVsTmFtZSA9IG5vcm1hbGl6ZU1vZGVsTmFtZShtb2RlbE5hbWUpOwogICAgICB2YXIgc2VyaWFsaXplciA9IHRoaXMuc2VyaWFsaXplckZvcihub3JtYWxpemVkTW9kZWxOYW1lKTsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5tb2RlbEZvcihub3JtYWxpemVkTW9kZWxOYW1lKTsKICAgICAgcmV0dXJuIHNlcmlhbGl6ZXIubm9ybWFsaXplKG1vZGVsLCBwYXlsb2FkKTsKICAgIH07CgogICAgX3Byb3RvLm5ld0NsaWVudElkID0gZnVuY3Rpb24gbmV3Q2xpZW50SWQoKSB7CiAgICAgIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlByaXZhdGUgQVBJIFJlbW92ZWQiKTsKICAgICAgfQogICAgfSAvL0NhbGxlZCBieSB0aGUgc3RhdGUgbWFjaGluZSB0byBub3RpZnkgdGhlIHN0b3JlIHRoYXQgdGhlIHJlY29yZCBpcyByZWFkeSB0byBiZSBpbnRlcmFjdGVkIHdpdGgKICAgIDsKCiAgICBfcHJvdG8ucmVjb3JkV2FzTG9hZGVkID0gZnVuY3Rpb24gcmVjb3JkV2FzTG9hZGVkKHJlY29yZCkgewoKICAgICAgdGhpcy5yZWNvcmRBcnJheU1hbmFnZXIucmVjb3JkV2FzTG9hZGVkKHJlY29yZCk7CiAgICB9IC8vIC4uLi4uLi4uLi4uLi4uLgogICAgLy8gLiBERVNUUlVDVElPTiAuCiAgICAvLyAuLi4uLi4uLi4uLi4uLi4KCiAgICAvKioKICAgICAqIFRPRE8gcmVtb3ZlIHRlc3QgdXNhZ2UKICAgICAqCiAgICAgKiBAaW50ZXJuYWwKICAgICAqLwogICAgOwoKICAgIF9wcm90by5faW50ZXJuYWxNb2RlbHNGb3IgPSBmdW5jdGlvbiBfaW50ZXJuYWxNb2RlbHNGb3IobW9kZWxOYW1lKSB7CiAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsRmFjdG9yeUZvcih0aGlzKS5tb2RlbE1hcEZvcihtb2RlbE5hbWUpOwogICAgfSAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgICAvLyAuIFBFUi1UWVBFIEFEQVBURVJTCiAgICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uCgogICAgLyoqCiAgICAgIFJldHVybnMgYW4gaW5zdGFuY2Ugb2YgdGhlIGFkYXB0ZXIgZm9yIGEgZ2l2ZW4gdHlwZS4gRm9yCiAgICAgIGV4YW1wbGUsIGBhZGFwdGVyRm9yKCdwZXJzb24nKWAgd2lsbCByZXR1cm4gYW4gaW5zdGFuY2Ugb2YKICAgICAgYEFwcC5QZXJzb25BZGFwdGVyYC4KICAgICAgIElmIG5vIGBBcHAuUGVyc29uQWRhcHRlcmAgaXMgZm91bmQsIHRoaXMgbWV0aG9kIHdpbGwgbG9vawogICAgICBmb3IgYW4gYEFwcC5BcHBsaWNhdGlvbkFkYXB0ZXJgICh0aGUgZGVmYXVsdCBhZGFwdGVyIGZvcgogICAgICB5b3VyIGVudGlyZSBhcHBsaWNhdGlvbikuCiAgICAgICBJZiBubyBgQXBwLkFwcGxpY2F0aW9uQWRhcHRlcmAgaXMgZm91bmQsIGl0IHdpbGwgcmV0dXJuCiAgICAgIHRoZSB2YWx1ZSBvZiB0aGUgYGRlZmF1bHRBZGFwdGVyYC4KICAgICAgIEBtZXRob2QgYWRhcHRlckZvcgogICAgICBAcHVibGljCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgICAgQHJldHVybiBBZGFwdGVyCiAgICAqLwogICAgOwoKICAgIF9wcm90by5hZGFwdGVyRm9yID0gZnVuY3Rpb24gYWRhcHRlckZvcihtb2RlbE5hbWUpIHsKICAgICAgdmFyIG5vcm1hbGl6ZWRNb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKICAgICAgdmFyIF9hZGFwdGVyQ2FjaGUgPSB0aGlzLl9hZGFwdGVyQ2FjaGU7CiAgICAgIHZhciBhZGFwdGVyID0gX2FkYXB0ZXJDYWNoZVtub3JtYWxpemVkTW9kZWxOYW1lXTsKCiAgICAgIGlmIChhZGFwdGVyKSB7CiAgICAgICAgcmV0dXJuIGFkYXB0ZXI7CiAgICAgIH0KCiAgICAgIHZhciBvd25lciA9IEVtYmVyLmdldE93bmVyKHRoaXMpOwogICAgICBhZGFwdGVyID0gb3duZXIubG9va3VwKCJhZGFwdGVyOiIgKyBub3JtYWxpemVkTW9kZWxOYW1lKTsgLy8gaW4gcHJvZHVjdGlvbiB0aGlzIGlzIGhhbmRsZWQgYnkgdGhlIHJlLWV4cG9ydAoKICAgICAgaWYgKGFkYXB0ZXIgIT09IHVuZGVmaW5lZCkgewogICAgICAgIEVtYmVyLnNldChhZGFwdGVyLCAnc3RvcmUnLCB0aGlzKTsKICAgICAgICBfYWRhcHRlckNhY2hlW25vcm1hbGl6ZWRNb2RlbE5hbWVdID0gYWRhcHRlcjsKICAgICAgICByZXR1cm4gYWRhcHRlcjsKICAgICAgfSAvLyBubyBhZGFwdGVyIGZvdW5kIGZvciB0aGUgc3BlY2lmaWMgbW9kZWwsIGZhbGxiYWNrIGFuZCBjaGVjayBmb3IgYXBwbGljYXRpb24gYWRhcHRlcgoKCiAgICAgIGFkYXB0ZXIgPSBfYWRhcHRlckNhY2hlLmFwcGxpY2F0aW9uIHx8IG93bmVyLmxvb2t1cCgnYWRhcHRlcjphcHBsaWNhdGlvbicpOwoKICAgICAgaWYgKGFkYXB0ZXIgIT09IHVuZGVmaW5lZCkgewogICAgICAgIEVtYmVyLnNldChhZGFwdGVyLCAnc3RvcmUnLCB0aGlzKTsKICAgICAgICBfYWRhcHRlckNhY2hlW25vcm1hbGl6ZWRNb2RlbE5hbWVdID0gYWRhcHRlcjsKICAgICAgICBfYWRhcHRlckNhY2hlLmFwcGxpY2F0aW9uID0gYWRhcHRlcjsKICAgICAgICByZXR1cm4gYWRhcHRlcjsKICAgICAgfSAvLyBubyBtb2RlbCBzcGVjaWZpYyBhZGFwdGVyIG9yIGFwcGxpY2F0aW9uIGFkYXB0ZXIsIGNoZWNrIGZvciBhbiBgYWRhcHRlcmAKICAgICAgLy8gcHJvcGVydHkgZGVmaW5lZCBvbiB0aGUgc3RvcmUKCgogICAgICB2YXIgYWRhcHRlck5hbWUgPSB0aGlzLmFkYXB0ZXIgfHwgJy1qc29uLWFwaSc7CiAgICAgIGFkYXB0ZXIgPSBhZGFwdGVyTmFtZSA/IF9hZGFwdGVyQ2FjaGVbYWRhcHRlck5hbWVdIHx8IG93bmVyLmxvb2t1cCgiYWRhcHRlcjoiICsgYWRhcHRlck5hbWUpIDogdW5kZWZpbmVkOyAvLyBpbiBwcm9kdWN0aW9uIHRoaXMgaXMgaGFuZGxlZCBieSB0aGUgcmUtZXhwb3J0CgogICAgICBpZiAoYWRhcHRlciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgRW1iZXIuc2V0KGFkYXB0ZXIsICdzdG9yZScsIHRoaXMpOwogICAgICAgIF9hZGFwdGVyQ2FjaGVbbm9ybWFsaXplZE1vZGVsTmFtZV0gPSBhZGFwdGVyOwogICAgICAgIF9hZGFwdGVyQ2FjaGVbYWRhcHRlck5hbWVdID0gYWRhcHRlcjsKICAgICAgICByZXR1cm4gYWRhcHRlcjsKICAgICAgfSAvLyBmaW5hbCBmYWxsYmFjaywgbm8gbW9kZWwgc3BlY2lmaWMgYWRhcHRlciwgbm8gYXBwbGljYXRpb24gYWRhcHRlciwgbm8KICAgICAgLy8gYGFkYXB0ZXJgIHByb3BlcnR5IG9uIHN0b3JlOiB1c2UganNvbi1hcGkgYWRhcHRlcgoKCiAgICAgIGFkYXB0ZXIgPSBfYWRhcHRlckNhY2hlWyctanNvbi1hcGknXSB8fCBvd25lci5sb29rdXAoJ2FkYXB0ZXI6LWpzb24tYXBpJyk7CiAgICAgIEVtYmVyLnNldChhZGFwdGVyLCAnc3RvcmUnLCB0aGlzKTsKICAgICAgX2FkYXB0ZXJDYWNoZVtub3JtYWxpemVkTW9kZWxOYW1lXSA9IGFkYXB0ZXI7CiAgICAgIF9hZGFwdGVyQ2FjaGVbJy1qc29uLWFwaSddID0gYWRhcHRlcjsKICAgICAgcmV0dXJuIGFkYXB0ZXI7CiAgICB9IC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogICAgLy8gLiBSRUNPUkQgQ0hBTkdFIE5PVElGSUNBVElPTiAuCiAgICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KCiAgICAvKioKICAgICAgUmV0dXJucyBhbiBpbnN0YW5jZSBvZiB0aGUgc2VyaWFsaXplciBmb3IgYSBnaXZlbiB0eXBlLiBGb3IKICAgICAgZXhhbXBsZSwgYHNlcmlhbGl6ZXJGb3IoJ3BlcnNvbicpYCB3aWxsIHJldHVybiBhbiBpbnN0YW5jZSBvZgogICAgICBgQXBwLlBlcnNvblNlcmlhbGl6ZXJgLgogICAgICAgSWYgbm8gYEFwcC5QZXJzb25TZXJpYWxpemVyYCBpcyBmb3VuZCwgdGhpcyBtZXRob2Qgd2lsbCBsb29rCiAgICAgIGZvciBhbiBgQXBwLkFwcGxpY2F0aW9uU2VyaWFsaXplcmAgKHRoZSBkZWZhdWx0IHNlcmlhbGl6ZXIgZm9yCiAgICAgIHlvdXIgZW50aXJlIGFwcGxpY2F0aW9uKS4KICAgICAgIGlmIG5vIGBBcHAuQXBwbGljYXRpb25TZXJpYWxpemVyYCBpcyBmb3VuZCwgaXQgd2lsbCBhdHRlbXB0CiAgICAgIHRvIGdldCB0aGUgYGRlZmF1bHRTZXJpYWxpemVyYCBmcm9tIHRoZSBgUGVyc29uQWRhcHRlcmAKICAgICAgKGBhZGFwdGVyRm9yKCdwZXJzb24nKWApLgogICAgICAgSWYgYSBzZXJpYWxpemVyIGNhbm5vdCBiZSBmb3VuZCBvbiB0aGUgYWRhcHRlciwgaXQgd2lsbCBmYWxsIGJhY2sKICAgICAgdG8gYW4gaW5zdGFuY2Ugb2YgYEpTT05TZXJpYWxpemVyYC4KICAgICAgIEBtZXRob2Qgc2VyaWFsaXplckZvcgogICAgICBAcHVibGljCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUgdGhlIHJlY29yZCB0byBzZXJpYWxpemUKICAgICAgQHJldHVybiB7U2VyaWFsaXplcn0KICAgICovCiAgICA7CgogICAgX3Byb3RvLnNlcmlhbGl6ZXJGb3IgPSBmdW5jdGlvbiBzZXJpYWxpemVyRm9yKG1vZGVsTmFtZSkgewogICAgICB2YXIgbm9ybWFsaXplZE1vZGVsTmFtZSA9IG5vcm1hbGl6ZU1vZGVsTmFtZShtb2RlbE5hbWUpOwogICAgICB2YXIgX3NlcmlhbGl6ZXJDYWNoZSA9IHRoaXMuX3NlcmlhbGl6ZXJDYWNoZTsKICAgICAgdmFyIHNlcmlhbGl6ZXIgPSBfc2VyaWFsaXplckNhY2hlW25vcm1hbGl6ZWRNb2RlbE5hbWVdOwoKICAgICAgaWYgKHNlcmlhbGl6ZXIpIHsKICAgICAgICByZXR1cm4gc2VyaWFsaXplcjsKICAgICAgfQoKICAgICAgdmFyIG93bmVyID0gRW1iZXIuZ2V0T3duZXIodGhpcyk7CiAgICAgIHNlcmlhbGl6ZXIgPSBvd25lci5sb29rdXAoInNlcmlhbGl6ZXI6IiArIG5vcm1hbGl6ZWRNb2RlbE5hbWUpOyAvLyBpbiBwcm9kdWN0aW9uIHRoaXMgaXMgaGFuZGxlZCBieSB0aGUgcmUtZXhwb3J0CgogICAgICBpZiAoc2VyaWFsaXplciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgRW1iZXIuc2V0KHNlcmlhbGl6ZXIsICdzdG9yZScsIHRoaXMpOwogICAgICAgIF9zZXJpYWxpemVyQ2FjaGVbbm9ybWFsaXplZE1vZGVsTmFtZV0gPSBzZXJpYWxpemVyOwogICAgICAgIHJldHVybiBzZXJpYWxpemVyOwogICAgICB9IC8vIG5vIHNlcmlhbGl6ZXIgZm91bmQgZm9yIHRoZSBzcGVjaWZpYyBtb2RlbCwgZmFsbGJhY2sgYW5kIGNoZWNrIGZvciBhcHBsaWNhdGlvbiBzZXJpYWxpemVyCgoKICAgICAgc2VyaWFsaXplciA9IF9zZXJpYWxpemVyQ2FjaGUuYXBwbGljYXRpb24gfHwgb3duZXIubG9va3VwKCdzZXJpYWxpemVyOmFwcGxpY2F0aW9uJyk7CgogICAgICBpZiAoc2VyaWFsaXplciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgRW1iZXIuc2V0KHNlcmlhbGl6ZXIsICdzdG9yZScsIHRoaXMpOwogICAgICAgIF9zZXJpYWxpemVyQ2FjaGVbbm9ybWFsaXplZE1vZGVsTmFtZV0gPSBzZXJpYWxpemVyOwogICAgICAgIF9zZXJpYWxpemVyQ2FjaGUuYXBwbGljYXRpb24gPSBzZXJpYWxpemVyOwogICAgICAgIHJldHVybiBzZXJpYWxpemVyOwogICAgICB9IC8vIG5vIG1vZGVsIHNwZWNpZmljIHNlcmlhbGl6ZXIgb3IgYXBwbGljYXRpb24gc2VyaWFsaXplciwgY2hlY2sgZm9yIHRoZSBgZGVmYXVsdFNlcmlhbGl6ZXJgCiAgICAgIC8vIHByb3BlcnR5IGRlZmluZWQgb24gdGhlIGFkYXB0ZXIKCgogICAgICB2YXIgYWRhcHRlciA9IHRoaXMuYWRhcHRlckZvcihtb2RlbE5hbWUpOwogICAgICB2YXIgc2VyaWFsaXplck5hbWUgPSBFbWJlci5nZXQoYWRhcHRlciwgJ2RlZmF1bHRTZXJpYWxpemVyJyk7CiAgICAgIHNlcmlhbGl6ZXIgPSBzZXJpYWxpemVyTmFtZSA/IF9zZXJpYWxpemVyQ2FjaGVbc2VyaWFsaXplck5hbWVdIHx8IG93bmVyLmxvb2t1cCgic2VyaWFsaXplcjoiICsgc2VyaWFsaXplck5hbWUpIDogdW5kZWZpbmVkOyAvLyBpbiBwcm9kdWN0aW9uIHRoaXMgaXMgaGFuZGxlZCBieSB0aGUgcmUtZXhwb3J0CgogICAgICBpZiAoc2VyaWFsaXplciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgRW1iZXIuc2V0KHNlcmlhbGl6ZXIsICdzdG9yZScsIHRoaXMpOwogICAgICAgIF9zZXJpYWxpemVyQ2FjaGVbbm9ybWFsaXplZE1vZGVsTmFtZV0gPSBzZXJpYWxpemVyOwogICAgICAgIF9zZXJpYWxpemVyQ2FjaGVbc2VyaWFsaXplck5hbWVdID0gc2VyaWFsaXplcjsKICAgICAgICByZXR1cm4gc2VyaWFsaXplcjsKICAgICAgfSAvLyBmaW5hbCBmYWxsYmFjaywgbm8gbW9kZWwgc3BlY2lmaWMgc2VyaWFsaXplciwgbm8gYXBwbGljYXRpb24gc2VyaWFsaXplciwgbm8KICAgICAgLy8gYHNlcmlhbGl6ZXJgIHByb3BlcnR5IG9uIHN0b3JlOiB1c2UgdGhlIGNvbnZlbmllbmNlIEpTT05TZXJpYWxpemVyCgoKICAgICAgc2VyaWFsaXplciA9IF9zZXJpYWxpemVyQ2FjaGVbJy1kZWZhdWx0J10gfHwgb3duZXIubG9va3VwKCdzZXJpYWxpemVyOi1kZWZhdWx0Jyk7CiAgICAgIEVtYmVyLnNldChzZXJpYWxpemVyLCAnc3RvcmUnLCB0aGlzKTsKICAgICAgX3NlcmlhbGl6ZXJDYWNoZVtub3JtYWxpemVkTW9kZWxOYW1lXSA9IHNlcmlhbGl6ZXI7CiAgICAgIF9zZXJpYWxpemVyQ2FjaGVbJy1kZWZhdWx0J10gPSBzZXJpYWxpemVyOwogICAgICByZXR1cm4gc2VyaWFsaXplcjsKICAgIH07CgogICAgX3Byb3RvLndpbGxEZXN0cm95ID0gZnVuY3Rpb24gd2lsbERlc3Ryb3koKSB7CiAgICAgIF9FbWJlclNlcnZpY2UucHJvdG90eXBlLndpbGxEZXN0cm95LmNhbGwodGhpcyk7CgogICAgICB0aGlzLnJlY29yZEFycmF5TWFuYWdlci5kZXN0cm95KCk7IC8vIENoZWNrIGlmIHdlIG5lZWQgdG8gbnVsbCB0aGlzIG91dAogICAgICAvLyB0aGlzLl9hZGFwdGVyQ2FjaGUgPSBudWxsOwogICAgICAvLyB0aGlzLl9zZXJpYWxpemVyQ2FjaGUgPSBudWxsOwoKICAgICAgaWRlbnRpZmllckNhY2hlRm9yKHRoaXMpLmRlc3Ryb3koKTsKICAgICAgdGhpcy51bmxvYWRBbGwoKTsKICAgIH07CgogICAgX3Byb3RvLl91cGRhdGVSZWxhdGlvbnNoaXBTdGF0ZSA9IGZ1bmN0aW9uIF91cGRhdGVSZWxhdGlvbnNoaXBTdGF0ZShyZWxhdGlvbnNoaXApIHsKICAgICAgdmFyIF90aGlzOCA9IHRoaXM7CgogICAgICBpZiAodGhpcy5fdXBkYXRlZFJlbGF0aW9uc2hpcHMucHVzaChyZWxhdGlvbnNoaXApICE9PSAxKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl9iYWNrYnVybmVyLmpvaW4oZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzOC5fYmFja2J1cm5lci5zY2hlZHVsZSgnc3luY1JlbGF0aW9uc2hpcHMnLCBfdGhpczgsIF90aGlzOC5fZmx1c2hVcGRhdGVkUmVsYXRpb25zaGlwcyk7CiAgICAgIH0pOwogICAgfTsKCiAgICBfcHJvdG8uX2ZsdXNoVXBkYXRlZFJlbGF0aW9uc2hpcHMgPSBmdW5jdGlvbiBfZmx1c2hVcGRhdGVkUmVsYXRpb25zaGlwcygpIHsKICAgICAgdmFyIHVwZGF0ZWQgPSB0aGlzLl91cGRhdGVkUmVsYXRpb25zaGlwczsKCiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdXBkYXRlZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB1cGRhdGVkW2ldLmZsdXNoQ2Fub25pY2FsKCk7CiAgICAgIH0KCiAgICAgIHVwZGF0ZWQubGVuZ3RoID0gMDsKICAgIH07CgogICAgX3Byb3RvLl91cGRhdGVJbnRlcm5hbE1vZGVsID0gZnVuY3Rpb24gX3VwZGF0ZUludGVybmFsTW9kZWwoaW50ZXJuYWxNb2RlbCkgewogICAgICBpZiAodGhpcy5fdXBkYXRlZEludGVybmFsTW9kZWxzLnB1c2goaW50ZXJuYWxNb2RlbCkgIT09IDEpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGVtYmVyUnVuJDIuc2NoZWR1bGUoJ2FjdGlvbnMnLCB0aGlzLCB0aGlzLl9mbHVzaFVwZGF0ZWRJbnRlcm5hbE1vZGVscyk7CiAgICB9OwoKICAgIF9wcm90by5fZmx1c2hVcGRhdGVkSW50ZXJuYWxNb2RlbHMgPSBmdW5jdGlvbiBfZmx1c2hVcGRhdGVkSW50ZXJuYWxNb2RlbHMoKSB7CiAgICAgIHZhciB1cGRhdGVkID0gdGhpcy5fdXBkYXRlZEludGVybmFsTW9kZWxzOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB1cGRhdGVkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHVwZGF0ZWRbaV0uX3RyaWdnZXJEZWZlcnJlZFRyaWdnZXJzKCk7CiAgICAgIH0KCiAgICAgIHVwZGF0ZWQubGVuZ3RoID0gMDsKICAgIH07CgogICAgX2NyZWF0ZUNsYXNzJDcoQ29yZVN0b3JlLCBbewogICAgICBrZXk6ICJpZGVudGlmaWVyQ2FjaGUiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKCiAgICAgICAgcmV0dXJuIGlkZW50aWZpZXJDYWNoZUZvcih0aGlzKTsKICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBDb3JlU3RvcmU7CiAgfShFbWJlci5TZXJ2aWNlKTsKCiAgRW1iZXIuZGVmaW5lUHJvcGVydHkoQ29yZVN0b3JlLnByb3RvdHlwZSwgJ2RlZmF1bHRBZGFwdGVyJywgRW1iZXIuY29tcHV0ZWQoJ2FkYXB0ZXInLCBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYWRhcHRlciA9IHRoaXMuYWRhcHRlciB8fCAnLWpzb24tYXBpJzsKICAgIHJldHVybiB0aGlzLmFkYXB0ZXJGb3IoYWRhcHRlcik7CiAgfSkpOwoKICBmdW5jdGlvbiBfY29tbWl0KGFkYXB0ZXIsIHN0b3JlLCBvcGVyYXRpb24sIHNuYXBzaG90KSB7CiAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IHNuYXBzaG90Ll9pbnRlcm5hbE1vZGVsOwogICAgdmFyIG1vZGVsTmFtZSA9IHNuYXBzaG90Lm1vZGVsTmFtZTsKICAgIHZhciBtb2RlbENsYXNzID0gc3RvcmUubW9kZWxGb3IobW9kZWxOYW1lKTsKICAgIHZhciBwcm9taXNlID0gRW1iZXIuUlNWUC5Qcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGFkYXB0ZXJbb3BlcmF0aW9uXShzdG9yZSwgbW9kZWxDbGFzcywgc25hcHNob3QpOwogICAgfSk7CiAgICB2YXIgc2VyaWFsaXplciA9IHN0b3JlLnNlcmlhbGl6ZXJGb3IobW9kZWxOYW1lKTsKICAgIHZhciBsYWJlbCA9ICJEUzogRXh0cmFjdCBhbmQgbm90aWZ5IGFib3V0ICIgKyBvcGVyYXRpb24gKyAiIGNvbXBsZXRpb24gb2YgIiArIGludGVybmFsTW9kZWw7CiAgICBwcm9taXNlID0gZ3VhcmREZXN0cm95ZWRTdG9yZShwcm9taXNlLCBzdG9yZSwgbGFiZWwpOwogICAgcHJvbWlzZSA9IF9ndWFyZChwcm9taXNlLCBfYmluZChfb2JqZWN0SXNBbGl2ZSwgaW50ZXJuYWxNb2RlbCkpOwogICAgcmV0dXJuIHByb21pc2UudGhlbihmdW5jdGlvbiAoYWRhcHRlclBheWxvYWQpIHsKICAgICAgLyoKICAgICAgTm90ZSB0byBmdXR1cmUgc3BlbHVua2VycyBob3BpbmcgdG8gb3B0aW1pemUuCiAgICAgIFdlIHJlbHkgb24gdGhpcyBgcnVuYCB0byBjcmVhdGUgYSBydW4gbG9vcCBpZiBuZWVkZWQKICAgICAgdGhhdCBgc3RvcmUuX3B1c2hgIGFuZCBgc3RvcmUuZGlkU2F2ZVJlY29yZGAgd2lsbCBib3RoIHNoYXJlLgogICAgICAgV2UgdXNlIGBqb2luYCBiZWNhdXNlIGl0IGlzIG9mdGVuIHRoZSBjYXNlIHRoYXQgd2UKICAgICAgaGF2ZSBhbiBvdXRlciBydW4gbG9vcCBhdmFpbGFibGUgc3RpbGwgZnJvbSB0aGUgZmlyc3QKICAgICAgY2FsbCB0byBgc3RvcmUuX3B1c2hgOwogICAgICAqLwogICAgICBzdG9yZS5fYmFja2J1cm5lci5qb2luKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgcGF5bG9hZCwgZGF0YSwgc2lkZWxvYWRlZDsKCiAgICAgICAgaWYgKGFkYXB0ZXJQYXlsb2FkKSB7CiAgICAgICAgICBwYXlsb2FkID0gbm9ybWFsaXplUmVzcG9uc2VIZWxwZXIoc2VyaWFsaXplciwgc3RvcmUsIG1vZGVsQ2xhc3MsIGFkYXB0ZXJQYXlsb2FkLCBzbmFwc2hvdC5pZCwgb3BlcmF0aW9uKTsKCiAgICAgICAgICBpZiAocGF5bG9hZC5pbmNsdWRlZCkgewogICAgICAgICAgICBzaWRlbG9hZGVkID0gcGF5bG9hZC5pbmNsdWRlZDsKICAgICAgICAgIH0KCiAgICAgICAgICBkYXRhID0gcGF5bG9hZC5kYXRhOwogICAgICAgIH0KCiAgICAgICAgc3RvcmUuZGlkU2F2ZVJlY29yZChpbnRlcm5hbE1vZGVsLCB7CiAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgfSwgb3BlcmF0aW9uKTsgLy8gc2VlbXMgcmlza3ksIGJ1dCBpZiB0aGUgdGVzdHMgcGFzcyBtaWdodCBiZSBmaW5lPwoKICAgICAgICBpZiAoc2lkZWxvYWRlZCkgewogICAgICAgICAgc3RvcmUuX3B1c2goewogICAgICAgICAgICBkYXRhOiBudWxsLAogICAgICAgICAgICBpbmNsdWRlZDogc2lkZWxvYWRlZAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsOwogICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgIGlmIChlcnJvciAmJiBlcnJvci5pc0FkYXB0ZXJFcnJvciA9PT0gdHJ1ZSAmJiBlcnJvci5jb2RlID09PSAnSW52YWxpZEVycm9yJykgewogICAgICAgIHZhciBwYXJzZWRFcnJvcnM7CgogICAgICAgIGlmICh0eXBlb2Ygc2VyaWFsaXplci5leHRyYWN0RXJyb3JzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBwYXJzZWRFcnJvcnMgPSBzZXJpYWxpemVyLmV4dHJhY3RFcnJvcnMoc3RvcmUsIG1vZGVsQ2xhc3MsIGVycm9yLCBzbmFwc2hvdC5pZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHBhcnNlZEVycm9ycyA9IGVycm9yc0FycmF5VG9IYXNoKGVycm9yLmVycm9ycyk7CiAgICAgICAgfQoKICAgICAgICBzdG9yZS5yZWNvcmRXYXNJbnZhbGlkKGludGVybmFsTW9kZWwsIHBhcnNlZEVycm9ycywgZXJyb3IpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0b3JlLnJlY29yZFdhc0Vycm9yKGludGVybmFsTW9kZWwsIGVycm9yKTsKICAgICAgfQoKICAgICAgdGhyb3cgZXJyb3I7CiAgICB9LCBsYWJlbCk7CiAgfQoKICB2YXIgSEFTX01PREVMX1BBQ0tBR0UkMSA9IHJlcXVpcmUuaGFzKCdAZW1iZXItZGF0YS9tb2RlbCcpOwoKICB2YXIgX01vZGVsJDE7CgogIGZ1bmN0aW9uIGdldE1vZGVsJDEoKSB7CiAgICBpZiAoSEFTX01PREVMX1BBQ0tBR0UkMSkgewogICAgICBfTW9kZWwkMSA9IF9Nb2RlbCQxIHx8IHJlcXVpcmVfX2RlZmF1bHQoJ0BlbWJlci1kYXRhL21vZGVsJykuZGVmYXVsdDsKICAgIH0KCiAgICByZXR1cm4gX01vZGVsJDE7CiAgfQoKICB2YXIgRFNNb2RlbFNjaGVtYURlZmluaXRpb25TZXJ2aWNlID0KICAvKiNfX1BVUkVfXyovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRFNNb2RlbFNjaGVtYURlZmluaXRpb25TZXJ2aWNlKHN0b3JlKSB7CiAgICAgIHRoaXMuc3RvcmUgPSBzdG9yZTsKICAgICAgdGhpcy5fbW9kZWxGYWN0b3J5Q2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB0aGlzLl9yZWxhdGlvbnNoaXBzRGVmQ2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB0aGlzLl9hdHRyaWJ1dGVzRGVmQ2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgfSAvLyBGb2xsb3dpbmcgdGhlIGV4aXN0aW5nIFJEIGltcGxlbWVudGF0aW9uCgoKICAgIHZhciBfcHJvdG8gPSBEU01vZGVsU2NoZW1hRGVmaW5pdGlvblNlcnZpY2UucHJvdG90eXBlOwoKICAgIF9wcm90by5hdHRyaWJ1dGVzRGVmaW5pdGlvbkZvciA9IGZ1bmN0aW9uIGF0dHJpYnV0ZXNEZWZpbml0aW9uRm9yKGlkZW50aWZpZXIpIHsKICAgICAgdmFyIG1vZGVsTmFtZSwgYXR0cmlidXRlczsKCiAgICAgIGlmICh0eXBlb2YgaWRlbnRpZmllciA9PT0gJ3N0cmluZycpIHsKICAgICAgICBtb2RlbE5hbWUgPSBpZGVudGlmaWVyOwogICAgICB9IGVsc2UgewogICAgICAgIG1vZGVsTmFtZSA9IGlkZW50aWZpZXIudHlwZTsKICAgICAgfQoKICAgICAgYXR0cmlidXRlcyA9IHRoaXMuX2F0dHJpYnV0ZXNEZWZDYWNoZVttb2RlbE5hbWVdOwoKICAgICAgaWYgKGF0dHJpYnV0ZXMgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhciBtb2RlbENsYXNzID0gdGhpcy5zdG9yZS5tb2RlbEZvcihtb2RlbE5hbWUpOwogICAgICAgIHZhciBhdHRyaWJ1dGVNYXAgPSBFbWJlci5nZXQobW9kZWxDbGFzcywgJ2F0dHJpYnV0ZXMnKTsKICAgICAgICBhdHRyaWJ1dGVzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICBhdHRyaWJ1dGVNYXAuZm9yRWFjaChmdW5jdGlvbiAobWV0YSwgbmFtZSkgewogICAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZXNbbmFtZV0gPSBtZXRhOwogICAgICAgIH0pOwogICAgICAgIHRoaXMuX2F0dHJpYnV0ZXNEZWZDYWNoZVttb2RlbE5hbWVdID0gYXR0cmlidXRlczsKICAgICAgfQoKICAgICAgcmV0dXJuIGF0dHJpYnV0ZXM7CiAgICB9IC8vIEZvbGxvd2luZyB0aGUgZXhpc3RpbmcgUkQgaW1wbGVtZW50YXRpb24KICAgIDsKCiAgICBfcHJvdG8ucmVsYXRpb25zaGlwc0RlZmluaXRpb25Gb3IgPSBmdW5jdGlvbiByZWxhdGlvbnNoaXBzRGVmaW5pdGlvbkZvcihpZGVudGlmaWVyKSB7CiAgICAgIHZhciBtb2RlbE5hbWUsIHJlbGF0aW9uc2hpcHM7CgogICAgICBpZiAodHlwZW9mIGlkZW50aWZpZXIgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgbW9kZWxOYW1lID0gaWRlbnRpZmllcjsKICAgICAgfSBlbHNlIHsKICAgICAgICBtb2RlbE5hbWUgPSBpZGVudGlmaWVyLnR5cGU7CiAgICAgIH0KCiAgICAgIHJlbGF0aW9uc2hpcHMgPSB0aGlzLl9yZWxhdGlvbnNoaXBzRGVmQ2FjaGVbbW9kZWxOYW1lXTsKCiAgICAgIGlmIChyZWxhdGlvbnNoaXBzID09PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgbW9kZWxDbGFzcyA9IHRoaXMuc3RvcmUubW9kZWxGb3IobW9kZWxOYW1lKTsKICAgICAgICByZWxhdGlvbnNoaXBzID0gRW1iZXIuZ2V0KG1vZGVsQ2xhc3MsICdyZWxhdGlvbnNoaXBzT2JqZWN0JykgfHwgbnVsbDsKICAgICAgICB0aGlzLl9yZWxhdGlvbnNoaXBzRGVmQ2FjaGVbbW9kZWxOYW1lXSA9IHJlbGF0aW9uc2hpcHM7CiAgICAgIH0KCiAgICAgIHJldHVybiByZWxhdGlvbnNoaXBzOwogICAgfTsKCiAgICBfcHJvdG8uZG9lc1R5cGVFeGlzdCA9IGZ1bmN0aW9uIGRvZXNUeXBlRXhpc3QobW9kZWxOYW1lKSB7CiAgICAgIHZhciBub3JtYWxpemVkTW9kZWxOYW1lID0gbm9ybWFsaXplTW9kZWxOYW1lKG1vZGVsTmFtZSk7CiAgICAgIHZhciBmYWN0b3J5ID0gZ2V0TW9kZWxGYWN0b3J5KHRoaXMuc3RvcmUsIHRoaXMuX21vZGVsRmFjdG9yeUNhY2hlLCBub3JtYWxpemVkTW9kZWxOYW1lKTsKICAgICAgcmV0dXJuIGZhY3RvcnkgIT09IG51bGw7CiAgICB9OwoKICAgIHJldHVybiBEU01vZGVsU2NoZW1hRGVmaW5pdGlvblNlcnZpY2U7CiAgfSgpOwogIC8qKgogICAqCiAgICogQHBhcmFtIHN0b3JlCiAgICogQHBhcmFtIGNhY2hlIG1vZGVsRmFjdG9yeUNhY2hlCiAgICogQHBhcmFtIG5vcm1hbGl6ZWRNb2RlbE5hbWUgYWxyZWFkeSBub3JtYWxpemVkIG1vZGVsTmFtZQogICAqIEByZXR1cm4geyp9CiAgICovCgogIGZ1bmN0aW9uIGdldE1vZGVsRmFjdG9yeShzdG9yZSwgY2FjaGUsIG5vcm1hbGl6ZWRNb2RlbE5hbWUpIHsKICAgIHZhciBmYWN0b3J5ID0gY2FjaGVbbm9ybWFsaXplZE1vZGVsTmFtZV07CgogICAgaWYgKCFmYWN0b3J5KSB7CiAgICAgIGZhY3RvcnkgPSBfbG9va3VwTW9kZWxGYWN0b3J5KHN0b3JlLCBub3JtYWxpemVkTW9kZWxOYW1lKTsKCiAgICAgIGlmICghZmFjdG9yeSkgewogICAgICAgIC8vU3VwcG9ydCBsb29raW5nIHVwIG1peGlucyBhcyBiYXNlIHR5cGVzIGZvciBwb2x5bW9ycGhpYyByZWxhdGlvbnNoaXBzCiAgICAgICAgZmFjdG9yeSA9IF9tb2RlbEZvck1peGluKHN0b3JlLCBub3JtYWxpemVkTW9kZWxOYW1lKTsKICAgICAgfQoKICAgICAgaWYgKCFmYWN0b3J5KSB7CiAgICAgICAgLy8gd2UgZG9uJ3QgY2FjaGUgbWlzc2VzIGluIGNhc2Ugc29tZW9uZSB3YW50cyB0byByZWdpc3RlciBhIG1pc3NpbmcgbW9kZWwKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgdmFyIGtsYXNzID0gZmFjdG9yeS5jbGFzczsKCiAgICAgIGlmIChrbGFzcy5pc01vZGVsKSB7CiAgICAgICAgdmFyIGhhc093bk1vZGVsTmFtZVNldCA9IGtsYXNzLm1vZGVsTmFtZSAmJiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoa2xhc3MsICdtb2RlbE5hbWUnKTsKCiAgICAgICAgaWYgKCFoYXNPd25Nb2RlbE5hbWVTZXQpIHsKICAgICAgICAgIGtsYXNzLm1vZGVsTmFtZSA9IG5vcm1hbGl6ZWRNb2RlbE5hbWU7CiAgICAgICAgfQogICAgICB9CgogICAgICBjYWNoZVtub3JtYWxpemVkTW9kZWxOYW1lXSA9IGZhY3Rvcnk7CiAgICB9CgogICAgcmV0dXJuIGZhY3Rvcnk7CiAgfQogIGZ1bmN0aW9uIF9sb29rdXBNb2RlbEZhY3Rvcnkoc3RvcmUsIG5vcm1hbGl6ZWRNb2RlbE5hbWUpIHsKICAgIHZhciBvd25lciA9IEVtYmVyLmdldE93bmVyKHN0b3JlKTsKICAgIHJldHVybiBvd25lci5mYWN0b3J5Rm9yKCJtb2RlbDoiICsgbm9ybWFsaXplZE1vZGVsTmFtZSk7CiAgfQogIC8qCiAgICAgIEluIGNhc2Ugc29tZW9uZSBkZWZpbmVkIGEgcmVsYXRpb25zaGlwIHRvIGEgbWl4aW4sIGZvciBleGFtcGxlOgogICAgICBgYGAKICAgICAgICBsZXQgQ29tbWVudCA9IE1vZGVsLmV4dGVuZCh7CiAgICAgICAgICBvd25lcjogYmVsb25nc1RvKCdjb21tZW50YWJsZScuIHsgcG9seW1vcnBoaWM6IHRydWUgfSkKICAgICAgICB9KTsKICAgICAgICBsZXQgQ29tbWVudGFibGUgPSBFbWJlci5NaXhpbi5jcmVhdGUoewogICAgICAgICAgY29tbWVudHM6IGhhc01hbnkoJ2NvbW1lbnQnKQogICAgICAgIH0pOwogICAgICBgYGAKICAgICAgd2Ugd2FudCB0byBsb29rIHVwIGEgQ29tbWVudGFibGUgY2xhc3Mgd2hpY2ggaGFzIGFsbCB0aGUgbmVjZXNzYXJ5CiAgICAgIHJlbGF0aW9uc2hpcCBtZXRhZGF0YS4gVGh1cywgd2UgbG9vayB1cCB0aGUgbWl4aW4gYW5kIGNyZWF0ZSBhIG1vY2sKICAgICAgTW9kZWwsIHNvIHdlIGNhbiBhY2Nlc3MgdGhlIHJlbGF0aW9uc2hpcCBDUHMgb2YgdGhlIG1peGluIChgY29tbWVudHNgKQogICAgICBpbiB0aGlzIGNhc2UKICAgICovCgogIGZ1bmN0aW9uIF9tb2RlbEZvck1peGluKHN0b3JlLCBub3JtYWxpemVkTW9kZWxOYW1lKSB7CiAgICBpZiAoSEFTX01PREVMX1BBQ0tBR0UkMSkgewogICAgICB2YXIgb3duZXIgPSBFbWJlci5nZXRPd25lcihzdG9yZSk7CiAgICAgIHZhciBNYXliZU1peGluID0gb3duZXIuZmFjdG9yeUZvcigibWl4aW46IiArIG5vcm1hbGl6ZWRNb2RlbE5hbWUpOwogICAgICB2YXIgbWl4aW4gPSBNYXliZU1peGluICYmIE1heWJlTWl4aW4uY2xhc3M7CgogICAgICBpZiAobWl4aW4pIHsKICAgICAgICB2YXIgTW9kZWxGb3JNaXhpbiA9IGdldE1vZGVsJDEoKS5leHRlbmQobWl4aW4pOwogICAgICAgIE1vZGVsRm9yTWl4aW4ucmVvcGVuQ2xhc3MoewogICAgICAgICAgX19pc01peGluOiB0cnVlLAogICAgICAgICAgX19taXhpbjogbWl4aW4KICAgICAgICB9KTsgLy9DYWNoZSB0aGUgY2xhc3MgYXMgYSBtb2RlbAoKICAgICAgICBvd25lci5yZWdpc3RlcignbW9kZWw6JyArIG5vcm1hbGl6ZWRNb2RlbE5hbWUsIE1vZGVsRm9yTWl4aW4pOwogICAgICB9CgogICAgICByZXR1cm4gX2xvb2t1cE1vZGVsRmFjdG9yeShzdG9yZSwgbm9ybWFsaXplZE1vZGVsTmFtZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBub3RpZnlDaGFuZ2VzKGlkZW50aWZpZXIsIHZhbHVlLCByZWNvcmQsIHN0b3JlKSB7CiAgICBpZiAodmFsdWUgPT09ICdhdHRyaWJ1dGVzJykgewogICAgICByZWNvcmQuZWFjaEF0dHJpYnV0ZShmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9IEVtYmVyLmNhY2hlRm9yKHJlY29yZCwga2V5KTsKCiAgICAgICAgdmFyIGludGVybmFsTW9kZWwgPSBzdG9yZS5faW50ZXJuYWxNb2RlbEZvclJlc291cmNlKGlkZW50aWZpZXIpOwoKICAgICAgICBpZiAoY3VycmVudFZhbHVlICE9PSBpbnRlcm5hbE1vZGVsLl9yZWNvcmREYXRhLmdldEF0dHIoa2V5KSkgewogICAgICAgICAgcmVjb3JkLm5vdGlmeVByb3BlcnR5Q2hhbmdlKGtleSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gZWxzZSBpZiAodmFsdWUgPT09ICdyZWxhdGlvbnNoaXBzJykgewogICAgICByZWNvcmQuZWFjaFJlbGF0aW9uc2hpcChmdW5jdGlvbiAoa2V5LCBtZXRhKSB7CiAgICAgICAgdmFyIGludGVybmFsTW9kZWwgPSBzdG9yZS5faW50ZXJuYWxNb2RlbEZvclJlc291cmNlKGlkZW50aWZpZXIpOwoKICAgICAgICBpZiAobWV0YS5raW5kID09PSAnYmVsb25nc1RvJykgewogICAgICAgICAgcmVjb3JkLm5vdGlmeVByb3BlcnR5Q2hhbmdlKGtleSk7CiAgICAgICAgfSBlbHNlIGlmIChtZXRhLmtpbmQgPT09ICdoYXNNYW55JykgewogICAgICAgICAgaWYgKG1ldGEub3B0aW9ucy5hc3luYykgewogICAgICAgICAgICByZWNvcmQubm90aWZ5UHJvcGVydHlDaGFuZ2Uoa2V5KTsKICAgICAgICAgICAgaW50ZXJuYWxNb2RlbC5oYXNNYW55UmVtb3ZhbENoZWNrKGtleSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGludGVybmFsTW9kZWwuX21hbnlBcnJheUNhY2hlW2tleV0pIHsKICAgICAgICAgICAgaW50ZXJuYWxNb2RlbC5fbWFueUFycmF5Q2FjaGVba2V5XS5yZXRyaWV2ZUxhdGVzdCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKHZhbHVlID09PSAnZXJyb3JzJykgewogICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IHN0b3JlLl9pbnRlcm5hbE1vZGVsRm9yUmVzb3VyY2UoaWRlbnRpZmllcik7IC8vVE9ETyBndWFyZAoKCiAgICAgIHZhciBlcnJvcnMgPSBpbnRlcm5hbE1vZGVsLl9yZWNvcmREYXRhLmdldEVycm9ycyhpZGVudGlmaWVyKTsKCiAgICAgIHJlY29yZC5pbnZhbGlkRXJyb3JzQ2hhbmdlZChlcnJvcnMpOwogICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gJ3N0YXRlJykgewogICAgICByZWNvcmQubm90aWZ5UHJvcGVydHlDaGFuZ2UoJ2lzTmV3Jyk7CiAgICAgIHJlY29yZC5ub3RpZnlQcm9wZXJ0eUNoYW5nZSgnaXNEZWxldGVkJyk7CiAgICB9IGVsc2UgaWYgKHZhbHVlID09PSAnaWRlbnRpdHknKSB7CiAgICAgIHJlY29yZC5ub3RpZnlQcm9wZXJ0eUNoYW5nZSgnaWQnKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIF9pbmhlcml0c0xvb3NlJDQoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzLnByb3RvdHlwZSk7IHN1YkNsYXNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHN1YkNsYXNzOyBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9CgogIC8qKgogICAgVGhlIHN0b3JlIHNlcnZpY2UgY29udGFpbnMgYWxsIG9mIHRoZSBkYXRhIGZvciByZWNvcmRzIGxvYWRlZCBmcm9tIHRoZSBzZXJ2ZXIuCiAgICBJdCBpcyBhbHNvIHJlc3BvbnNpYmxlIGZvciBjcmVhdGluZyBpbnN0YW5jZXMgb2YgYE1vZGVsYCB0aGF0IHdyYXAKICAgIHRoZSBpbmRpdmlkdWFsIGRhdGEgZm9yIGEgcmVjb3JkLCBzbyB0aGF0IHRoZXkgY2FuIGJlIGJvdW5kIHRvIGluIHlvdXIKICAgIEhhbmRsZWJhcnMgdGVtcGxhdGVzLgoKICAgIEJ5IGRlZmF1bHQsIGFwcGxpY2F0aW9ucyB3aWxsIGhhdmUgYSBzaW5nbGUgYFN0b3JlYCBzZXJ2aWNlIHRoYXQgaXMKICAgIGF1dG9tYXRpY2FsbHkgY3JlYXRlZC4KCiAgICBUaGUgc3RvcmUgY2FuIGJlIGN1c3RvbWl6ZWQgYnkgZXh0ZW5kaW5nIHRoZSBzZXJ2aWNlIGluIHRoZSBmb2xsb3dpbmcgbWFubmVyOgoKICAgIGBgYGFwcC9zZXJ2aWNlcy9zdG9yZS5qcwogICAgaW1wb3J0IFN0b3JlIGZyb20gJ0BlbWJlci1kYXRhL3N0b3JlJzsKCiAgICBleHBvcnQgZGVmYXVsdCBjbGFzcyBNeVN0b3JlIGV4dGVuZHMgU3RvcmUge30KICAgIGBgYAoKICAgIFlvdSBjYW4gcmV0cmlldmUgbW9kZWxzIGZyb20gdGhlIHN0b3JlIGluIHNldmVyYWwgd2F5cy4gVG8gcmV0cmlldmUgYSByZWNvcmQKICAgIGZvciBhIHNwZWNpZmljIGlkLCB1c2UgdGhlIGBTdG9yZWAncyBgZmluZFJlY29yZCgpYCBtZXRob2Q6CgogICAgYGBgamF2YXNjcmlwdAogICAgc3RvcmUuZmluZFJlY29yZCgncGVyc29uJywgMTIzKS50aGVuKGZ1bmN0aW9uIChwZXJzb24pIHsKICAgIH0pOwogICAgYGBgCgogICAgQnkgZGVmYXVsdCwgdGhlIHN0b3JlIHdpbGwgdGFsayB0byB5b3VyIGJhY2tlbmQgdXNpbmcgYSBzdGFuZGFyZAogICAgUkVTVCBtZWNoYW5pc20uIFlvdSBjYW4gY3VzdG9taXplIGhvdyB0aGUgc3RvcmUgdGFsa3MgdG8geW91cgogICAgYmFja2VuZCBieSBzcGVjaWZ5aW5nIGEgY3VzdG9tIGFkYXB0ZXI6CgogICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CgogICAgZXhwb3J0IGRlZmF1bHQgQWRhcHRlci5leHRlbmQoewogICAgfSk7CiAgICBgYGAKCiAgICBZb3UgY2FuIGxlYXJuIG1vcmUgYWJvdXQgd3JpdGluZyBhIGN1c3RvbSBhZGFwdGVyIGJ5IHJlYWRpbmcgdGhlIGBBZGFwdGVyYAogICAgZG9jdW1lbnRhdGlvbi4KCiAgICAjIyMgU3RvcmUgY3JlYXRlUmVjb3JkKCkgdnMuIHB1c2goKSB2cy4gcHVzaFBheWxvYWQoKQoKICAgIFRoZSBzdG9yZSBwcm92aWRlcyBtdWx0aXBsZSB3YXlzIHRvIGNyZWF0ZSBuZXcgcmVjb3JkIG9iamVjdHMuIFRoZXkgaGF2ZQogICAgc29tZSBzdWJ0bGUgZGlmZmVyZW5jZXMgaW4gdGhlaXIgdXNlIHdoaWNoIGFyZSBkZXRhaWxlZCBiZWxvdzoKCiAgICBbY3JlYXRlUmVjb3JkXShTdG9yZS9tZXRob2RzL2NyZWF0ZVJlY29yZD9hbmNob3I9Y3JlYXRlUmVjb3JkKSBpcyB1c2VkIGZvciBjcmVhdGluZyBuZXcKICAgIHJlY29yZHMgb24gdGhlIGNsaWVudCBzaWRlLiBUaGlzIHdpbGwgcmV0dXJuIGEgbmV3IHJlY29yZCBpbiB0aGUKICAgIGBjcmVhdGVkLnVuY29tbWl0dGVkYCBzdGF0ZS4gSW4gb3JkZXIgdG8gcGVyc2lzdCB0aGlzIHJlY29yZCB0byB0aGUKICAgIGJhY2tlbmQsIHlvdSB3aWxsIG5lZWQgdG8gY2FsbCBgcmVjb3JkLnNhdmUoKWAuCgogICAgW3B1c2hdKFN0b3JlL21ldGhvZHMvcHVzaD9hbmNob3I9cHVzaCkgaXMgdXNlZCB0byBub3RpZnkgRW1iZXIgRGF0YSdzIHN0b3JlIG9mIG5ldyBvcgogICAgdXBkYXRlZCByZWNvcmRzIHRoYXQgZXhpc3QgaW4gdGhlIGJhY2tlbmQuIFRoaXMgd2lsbCByZXR1cm4gYSByZWNvcmQKICAgIGluIHRoZSBgbG9hZGVkLnNhdmVkYCBzdGF0ZS4gVGhlIHByaW1hcnkgdXNlLWNhc2UgZm9yIGBzdG9yZSNwdXNoYCBpcwogICAgdG8gbm90aWZ5IEVtYmVyIERhdGEgYWJvdXQgcmVjb3JkIHVwZGF0ZXMgKGZ1bGwgb3IgcGFydGlhbCkgdGhhdCBoYXBwZW4KICAgIG91dHNpZGUgb2YgdGhlIG5vcm1hbCBhZGFwdGVyIG1ldGhvZHMgKGZvciBleGFtcGxlCiAgICBbU1NFXShodHRwOi8vZGV2LnczLm9yZy9odG1sNS9ldmVudHNvdXJjZS8pIG9yIFtXZWIKICAgIFNvY2tldHNdKGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMDkvV0Qtd2Vic29ja2V0cy0yMDA5MTIyMi8pKS4KCiAgICBbcHVzaFBheWxvYWRdKFN0b3JlL21ldGhvZHMvcHVzaFBheWxvYWQ/YW5jaG9yPXB1c2hQYXlsb2FkKSBpcyBhIGNvbnZlbmllbmNlIHdyYXBwZXIgZm9yCiAgICBgc3RvcmUjcHVzaGAgdGhhdCB3aWxsIGRlc2VyaWFsaXplIHBheWxvYWRzIGlmIHRoZQogICAgU2VyaWFsaXplciBpbXBsZW1lbnRzIGEgYHB1c2hQYXlsb2FkYCBtZXRob2QuCgogICAgTm90ZTogV2hlbiBjcmVhdGluZyBhIG5ldyByZWNvcmQgdXNpbmcgYW55IG9mIHRoZSBhYm92ZSBtZXRob2RzCiAgICBFbWJlciBEYXRhIHdpbGwgdXBkYXRlIGBSZWNvcmRBcnJheWBzIHN1Y2ggYXMgdGhvc2UgcmV0dXJuZWQgYnkKICAgIGBzdG9yZSNwZWVrQWxsKClgIG9yIGBzdG9yZSNmaW5kQWxsKClgLiBUaGlzIG1lYW5zIGFueQogICAgZGF0YSBiaW5kaW5ncyBvciBjb21wdXRlZCBwcm9wZXJ0aWVzIHRoYXQgZGVwZW5kIG9uIHRoZSBSZWNvcmRBcnJheQogICAgd2lsbCBhdXRvbWF0aWNhbGx5IGJlIHN5bmNlZCB0byBpbmNsdWRlIHRoZSBuZXcgb3IgdXBkYXRlZCByZWNvcmQKICAgIHZhbHVlcy4KCiAgICBAY2xhc3MgU3RvcmUKICAgIEBtYWluIEBlbWJlci1kYXRhL3N0b3JlCiAgICBAZXh0ZW5kcyBFbWJlci5TZXJ2aWNlCiAgKi8KICB2YXIgU3RvcmUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX0NvcmVTdG9yZSkgewogICAgX2luaGVyaXRzTG9vc2UkNChTdG9yZSwgX0NvcmVTdG9yZSk7CgogICAgZnVuY3Rpb24gU3RvcmUoKSB7CiAgICAgIHZhciBfdGhpczsKCiAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIF90aGlzID0gX0NvcmVTdG9yZS5jYWxsLmFwcGx5KF9Db3JlU3RvcmUsIFt0aGlzXS5jb25jYXQoYXJncykpIHx8IHRoaXM7CiAgICAgIF90aGlzLl9tb2RlbEZhY3RvcnlDYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIF90aGlzLl9yZWxhdGlvbnNoaXBzRGVmQ2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBfdGhpcy5fYXR0cmlidXRlc0RlZkNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIHZhciBfcHJvdG8gPSBTdG9yZS5wcm90b3R5cGU7CgogICAgX3Byb3RvLmluc3RhbnRpYXRlUmVjb3JkID0gZnVuY3Rpb24gaW5zdGFudGlhdGVSZWNvcmQoaWRlbnRpZmllciwgY3JlYXRlUmVjb3JkQXJncywgcmVjb3JkRGF0YUZvciwgbm90aWZpY2F0aW9uTWFuYWdlcikgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIHZhciBtb2RlbE5hbWUgPSBpZGVudGlmaWVyLnR5cGU7CgogICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IHRoaXMuX2ludGVybmFsTW9kZWxGb3JSZXNvdXJjZShpZGVudGlmaWVyKTsKCiAgICAgIHZhciBjcmVhdGVPcHRpb25zID0gewogICAgICAgIHN0b3JlOiB0aGlzLAogICAgICAgIF9pbnRlcm5hbE1vZGVsOiBpbnRlcm5hbE1vZGVsLAogICAgICAgIGN1cnJlbnRTdGF0ZTogaW50ZXJuYWxNb2RlbC5jdXJyZW50U3RhdGUsCiAgICAgICAgY29udGFpbmVyOiBudWxsCiAgICAgIH07CiAgICAgIEVtYmVyLmFzc2lnbihjcmVhdGVPcHRpb25zLCBjcmVhdGVSZWNvcmRBcmdzKTsgLy8gZW5zdXJlIHRoYXQgYGdldE93bmVyKHRoaXMpYCB3b3JrcyBpbnNpZGUgYSBtb2RlbCBpbnN0YW5jZQoKICAgICAgRW1iZXIuc2V0T3duZXIoY3JlYXRlT3B0aW9ucywgRW1iZXIuZ2V0T3duZXIodGhpcykpOwogICAgICBkZWxldGUgY3JlYXRlT3B0aW9ucy5jb250YWluZXI7CgogICAgICB2YXIgcmVjb3JkID0gdGhpcy5fbW9kZWxGYWN0b3J5Rm9yKG1vZGVsTmFtZSkuY3JlYXRlKGNyZWF0ZU9wdGlvbnMpOyAvL3RvZG8gb3B0aW1pemUKCgogICAgICBub3RpZmljYXRpb25NYW5hZ2VyLnN1YnNjcmliZShpZGVudGlmaWVyLCBmdW5jdGlvbiAoaWRlbnRpZmllciwgdmFsdWUpIHsKICAgICAgICByZXR1cm4gbm90aWZ5Q2hhbmdlcyhpZGVudGlmaWVyLCB2YWx1ZSwgcmVjb3JkLCBfdGhpczIpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlY29yZDsKICAgIH07CgogICAgX3Byb3RvLnRlYXJkb3duUmVjb3JkID0gZnVuY3Rpb24gdGVhcmRvd25SZWNvcmQocmVjb3JkKSB7CiAgICAgIHJlY29yZC5kZXN0cm95KCk7CiAgICB9CiAgICAvKioKICAgIFJldHVybnMgdGhlIG1vZGVsIGNsYXNzIGZvciB0aGUgcGFydGljdWxhciBgbW9kZWxOYW1lYC4KICAgICBUaGUgY2xhc3Mgb2YgYSBtb2RlbCBtaWdodCBiZSB1c2VmdWwgaWYgeW91IHdhbnQgdG8gZ2V0IGEgbGlzdCBvZiBhbGwgdGhlCiAgICByZWxhdGlvbnNoaXAgbmFtZXMgb2YgdGhlIG1vZGVsLCBzZWUKICAgIFtgcmVsYXRpb25zaGlwTmFtZXNgXSgvZW1iZXItZGF0YS9yZWxlYXNlL2NsYXNzZXMvTW9kZWw/YW5jaG9yPXJlbGF0aW9uc2hpcE5hbWVzKQogICAgZm9yIGV4YW1wbGUuCiAgICAgQG1ldGhvZCBtb2RlbEZvcgogICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgQHJldHVybiB7TW9kZWx9CiAgICAgICovCiAgICA7CgogICAgX3Byb3RvLm1vZGVsRm9yID0gZnVuY3Rpb24gbW9kZWxGb3IobW9kZWxOYW1lKSB7CgogICAgICB2YXIgbWF5YmVGYWN0b3J5ID0gdGhpcy5fbW9kZWxGYWN0b3J5Rm9yKG1vZGVsTmFtZSk7IC8vIGZvciBmYWN0b3JGb3IgZmFjdG9yeS9jbGFzcyBzcGxpdAoKCiAgICAgIHZhciBrbGFzcyA9IG1heWJlRmFjdG9yeSAmJiBtYXliZUZhY3RvcnkuY2xhc3MgPyBtYXliZUZhY3RvcnkuY2xhc3MgOiBtYXliZUZhY3Rvcnk7CgogICAgICBpZiAoIWtsYXNzIHx8ICFrbGFzcy5pc01vZGVsKSB7CiAgICAgICAgaWYgKCFjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MgfHwgIXRoaXMuZ2V0U2NoZW1hRGVmaW5pdGlvblNlcnZpY2UoKS5kb2VzVHlwZUV4aXN0KG1vZGVsTmFtZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBFbWJlci5FcnJvcigiTm8gbW9kZWwgd2FzIGZvdW5kIGZvciAnIiArIG1vZGVsTmFtZSArICInIGFuZCBubyBzY2hlbWEgaGFuZGxlcyB0aGUgdHlwZSIpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGdldFNoaW1DbGFzcyh0aGlzLCBtb2RlbE5hbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBrbGFzczsKICAgICAgfQogICAgfTsKCiAgICBfcHJvdG8uX21vZGVsRmFjdG9yeUZvciA9IGZ1bmN0aW9uIF9tb2RlbEZhY3RvcnlGb3IobW9kZWxOYW1lKSB7CiAgICAgIHZhciBub3JtYWxpemVkTW9kZWxOYW1lID0gbm9ybWFsaXplTW9kZWxOYW1lKG1vZGVsTmFtZSk7CiAgICAgIHZhciBmYWN0b3J5ID0gZ2V0TW9kZWxGYWN0b3J5KHRoaXMsIHRoaXMuX21vZGVsRmFjdG9yeUNhY2hlLCBub3JtYWxpemVkTW9kZWxOYW1lKTsKICAgICAgcmV0dXJuIGZhY3Rvcnk7CiAgICB9CiAgICAvKgogICAgUmV0dXJucyB3aGV0aGVyIGEgTW9kZWxDbGFzcyBleGlzdHMgZm9yIGEgZ2l2ZW4gbW9kZWxOYW1lCiAgICBUaGlzIGV4aXN0cyBmb3IgbGVnYWN5IHN1cHBvcnQgZm9yIHRoZSBSRVNUU2VyaWFsaXplciwKICAgIHdoaWNoIGR1ZSB0byBob3cgaXQgbXVzdCBndWVzcyB3aGV0aGVyIGEga2V5IGlzIGEgbW9kZWwKICAgIG11c3QgcXVlcnkgZm9yIHdoZXRoZXIgYSBtYXRjaCBleGlzdHMuCiAgICAgV2Ugc2hvdWxkIGludmVzdGlnYXRlIGFuIFJGQyB0byBtYWtlIHRoaXMgcHVibGljIG9yIHJlbW92aW5nCiAgICB0aGlzIHJlcXVpcmVtZW50LgogICAgIEBwcml2YXRlCiAgICAqLwogICAgOwoKICAgIF9wcm90by5faGFzTW9kZWxGb3IgPSBmdW5jdGlvbiBfaGFzTW9kZWxGb3IobW9kZWxOYW1lKSB7CgogICAgICBpZiAoY2FuYXJ5RmVhdHVyZXMuQ1VTVE9NX01PREVMX0NMQVNTKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2NoZW1hRGVmaW5pdGlvblNlcnZpY2UoKS5kb2VzVHlwZUV4aXN0KG1vZGVsTmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIG5vcm1hbGl6ZWRNb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKICAgICAgICB2YXIgZmFjdG9yeSA9IGdldE1vZGVsRmFjdG9yeSh0aGlzLCB0aGlzLl9tb2RlbEZhY3RvcnlDYWNoZSwgbm9ybWFsaXplZE1vZGVsTmFtZSk7CiAgICAgICAgcmV0dXJuIGZhY3RvcnkgIT09IG51bGw7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLl9yZWxhdGlvbnNoaXBNZXRhRm9yID0gZnVuY3Rpb24gX3JlbGF0aW9uc2hpcE1ldGFGb3IobW9kZWxOYW1lLCBpZCwga2V5KSB7CiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmVsYXRpb25zaGlwc0RlZmluaXRpb25Gb3IobW9kZWxOYW1lKVtrZXldOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBtb2RlbENsYXNzID0gdGhpcy5tb2RlbEZvcihtb2RlbE5hbWUpOwogICAgICAgIHZhciByZWxhdGlvbnNoaXBzQnlOYW1lID0gRW1iZXIuZ2V0KG1vZGVsQ2xhc3MsICdyZWxhdGlvbnNoaXBzQnlOYW1lJyk7CiAgICAgICAgcmV0dXJuIHJlbGF0aW9uc2hpcHNCeU5hbWUuZ2V0KGtleSk7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLl9hdHRyaWJ1dGVzRGVmaW5pdGlvbkZvciA9IGZ1bmN0aW9uIF9hdHRyaWJ1dGVzRGVmaW5pdGlvbkZvcihtb2RlbE5hbWUsIGlkZW50aWZpZXIpIHsKICAgICAgaWYgKGNhbmFyeUZlYXR1cmVzLkNVU1RPTV9NT0RFTF9DTEFTUykgewogICAgICAgIGlmIChpZGVudGlmaWVyKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRTY2hlbWFEZWZpbml0aW9uU2VydmljZSgpLmF0dHJpYnV0ZXNEZWZpbml0aW9uRm9yKGlkZW50aWZpZXIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRTY2hlbWFEZWZpbml0aW9uU2VydmljZSgpLmF0dHJpYnV0ZXNEZWZpbml0aW9uRm9yKG1vZGVsTmFtZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZhciBhdHRyaWJ1dGVzID0gdGhpcy5fYXR0cmlidXRlc0RlZkNhY2hlW21vZGVsTmFtZV07CgogICAgICAgIGlmIChhdHRyaWJ1dGVzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciBtb2RlbENsYXNzID0gdGhpcy5tb2RlbEZvcihtb2RlbE5hbWUpOwogICAgICAgICAgdmFyIGF0dHJpYnV0ZU1hcCA9IEVtYmVyLmdldChtb2RlbENsYXNzLCAnYXR0cmlidXRlcycpOwogICAgICAgICAgYXR0cmlidXRlcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgICAgICBhdHRyaWJ1dGVNYXAuZm9yRWFjaChmdW5jdGlvbiAobWV0YSwgbmFtZSkgewogICAgICAgICAgICByZXR1cm4gYXR0cmlidXRlc1tuYW1lXSA9IG1ldGE7CiAgICAgICAgICB9KTsKICAgICAgICAgIHRoaXMuX2F0dHJpYnV0ZXNEZWZDYWNoZVttb2RlbE5hbWVdID0gYXR0cmlidXRlczsKICAgICAgICB9CgogICAgICAgIHJldHVybiBhdHRyaWJ1dGVzOwogICAgICB9CiAgICB9OwoKICAgIF9wcm90by5fcmVsYXRpb25zaGlwc0RlZmluaXRpb25Gb3IgPSBmdW5jdGlvbiBfcmVsYXRpb25zaGlwc0RlZmluaXRpb25Gb3IobW9kZWxOYW1lLCBpZGVudGlmaWVyKSB7CiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MpIHsKICAgICAgICBpZiAoaWRlbnRpZmllcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2NoZW1hRGVmaW5pdGlvblNlcnZpY2UoKS5yZWxhdGlvbnNoaXBzRGVmaW5pdGlvbkZvcihpZGVudGlmaWVyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2NoZW1hRGVmaW5pdGlvblNlcnZpY2UoKS5yZWxhdGlvbnNoaXBzRGVmaW5pdGlvbkZvcihtb2RlbE5hbWUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcmVsYXRpb25zaGlwcyA9IHRoaXMuX3JlbGF0aW9uc2hpcHNEZWZDYWNoZVttb2RlbE5hbWVdOwoKICAgICAgICBpZiAocmVsYXRpb25zaGlwcyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB2YXIgbW9kZWxDbGFzcyA9IHRoaXMubW9kZWxGb3IobW9kZWxOYW1lKTsKICAgICAgICAgIHJlbGF0aW9uc2hpcHMgPSBFbWJlci5nZXQobW9kZWxDbGFzcywgJ3JlbGF0aW9uc2hpcHNPYmplY3QnKSB8fCBudWxsOwogICAgICAgICAgdGhpcy5fcmVsYXRpb25zaGlwc0RlZkNhY2hlW21vZGVsTmFtZV0gPSByZWxhdGlvbnNoaXBzOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlbGF0aW9uc2hpcHM7CiAgICAgIH0KICAgIH07CgogICAgX3Byb3RvLmdldFNjaGVtYURlZmluaXRpb25TZXJ2aWNlID0gZnVuY3Rpb24gZ2V0U2NoZW1hRGVmaW5pdGlvblNlcnZpY2UoKSB7CiAgICAgIGlmIChjYW5hcnlGZWF0dXJlcy5DVVNUT01fTU9ERUxfQ0xBU1MpIHsKICAgICAgICBpZiAoIXRoaXMuX3NjaGVtYURlZmluaXRpb25TZXJ2aWNlKSB7CiAgICAgICAgICB0aGlzLl9zY2hlbWFEZWZpbml0aW9uU2VydmljZSA9IG5ldyBEU01vZGVsU2NoZW1hRGVmaW5pdGlvblNlcnZpY2UodGhpcyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5fc2NoZW1hRGVmaW5pdGlvblNlcnZpY2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgJ3NjaGVtYSBzZXJ2aWNlIGlzIG9ubHkgYXZhaWxhYmxlIHdoZW4gY3VzdG9tIG1vZGVsIGNsYXNzIGZlYXR1cmUgZmxhZyBpcyBvbic7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIFN0b3JlOwogIH0oQ29yZVN0b3JlKTsKCiAgZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXMkOCh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKICBmdW5jdGlvbiBfY3JlYXRlQ2xhc3MkOChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzJDgoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyQ4KENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyLWRhdGEvc3RvcmUKICAqLwogIGZ1bmN0aW9uIHR5cGVGb3JSZWxhdGlvbnNoaXBNZXRhKG1ldGEpIHsKICAgIHZhciBtb2RlbE5hbWU7CiAgICBtb2RlbE5hbWUgPSBtZXRhLnR5cGUgfHwgbWV0YS5rZXk7CiAgICBtb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKCiAgICBpZiAobWV0YS5raW5kID09PSAnaGFzTWFueScpIHsKICAgICAgbW9kZWxOYW1lID0gZW1iZXJJbmZsZWN0b3Iuc2luZ3VsYXJpemUobW9kZWxOYW1lKTsKICAgIH0KCiAgICByZXR1cm4gbW9kZWxOYW1lOwogIH0KCiAgZnVuY3Rpb24gc2hvdWxkRmluZEludmVyc2UocmVsYXRpb25zaGlwTWV0YSkgewogICAgdmFyIG9wdGlvbnMgPSByZWxhdGlvbnNoaXBNZXRhLm9wdGlvbnM7CiAgICByZXR1cm4gIShvcHRpb25zICYmIG9wdGlvbnMuaW52ZXJzZSA9PT0gbnVsbCk7CiAgfQoKICB2YXIgUmVsYXRpb25zaGlwRGVmaW5pdGlvbiA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFJlbGF0aW9uc2hpcERlZmluaXRpb24obWV0YSkgewogICAgICB0aGlzLm1ldGEgPSBtZXRhOwogICAgICB0aGlzW0JSQU5EX1NZTUJPTF0gPSB2b2lkIDA7CiAgICAgIHRoaXMuX3R5cGUgPSAnJzsKICAgICAgdGhpcy5fX2ludmVyc2VLZXkgPSAnJzsKICAgICAgdGhpcy5fX2ludmVyc2VJc0FzeW5jID0gdHJ1ZTsKICAgICAgdGhpcy5fX2hhc0NhbGN1bGF0ZWRJbnZlcnNlID0gZmFsc2U7CiAgICAgIHRoaXMucGFyZW50TW9kZWxOYW1lID0gdm9pZCAwOwogICAgICB0aGlzLmludmVyc2UgPSB2b2lkIDA7CiAgICAgIHRoaXMuaW52ZXJzZUlzQXN5bmMgPSB2b2lkIDA7CiAgICAgIHRoaXMucGFyZW50TW9kZWxOYW1lID0gbWV0YS5wYXJlbnRNb2RlbE5hbWU7CiAgICB9CgogICAgdmFyIF9wcm90byA9IFJlbGF0aW9uc2hpcERlZmluaXRpb24ucHJvdG90eXBlOwoKICAgIF9wcm90by5faW52ZXJzZUtleSA9IGZ1bmN0aW9uIF9pbnZlcnNlS2V5KHN0b3JlLCBtb2RlbENsYXNzKSB7CiAgICAgIGlmICh0aGlzLl9faGFzQ2FsY3VsYXRlZEludmVyc2UgPT09IGZhbHNlKSB7CiAgICAgICAgdGhpcy5fY2FsY3VsYXRlSW52ZXJzZShzdG9yZSwgbW9kZWxDbGFzcyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLl9faW52ZXJzZUtleTsKICAgIH07CgogICAgX3Byb3RvLl9pbnZlcnNlSXNBc3luYyA9IGZ1bmN0aW9uIF9pbnZlcnNlSXNBc3luYyhzdG9yZSwgbW9kZWxDbGFzcykgewogICAgICBpZiAodGhpcy5fX2hhc0NhbGN1bGF0ZWRJbnZlcnNlID09PSBmYWxzZSkgewogICAgICAgIHRoaXMuX2NhbGN1bGF0ZUludmVyc2Uoc3RvcmUsIG1vZGVsQ2xhc3MpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fX2ludmVyc2VJc0FzeW5jOwogICAgfTsKCiAgICBfcHJvdG8uX2NhbGN1bGF0ZUludmVyc2UgPSBmdW5jdGlvbiBfY2FsY3VsYXRlSW52ZXJzZShzdG9yZSwgbW9kZWxDbGFzcykgewogICAgICB0aGlzLl9faGFzQ2FsY3VsYXRlZEludmVyc2UgPSB0cnVlOwogICAgICB2YXIgaW52ZXJzZUtleSwgaW52ZXJzZUlzQXN5bmM7CiAgICAgIHZhciBpbnZlcnNlID0gbnVsbDsKCiAgICAgIGlmIChzaG91bGRGaW5kSW52ZXJzZSh0aGlzLm1ldGEpKSB7CiAgICAgICAgaW52ZXJzZSA9IG1vZGVsQ2xhc3MuaW52ZXJzZUZvcih0aGlzLmtleSwgc3RvcmUpOwogICAgICB9CgogICAgICBpZiAoaW52ZXJzZSkgewogICAgICAgIGludmVyc2VLZXkgPSBpbnZlcnNlLm5hbWU7CiAgICAgICAgaW52ZXJzZUlzQXN5bmMgPSBpc0ludmVyc2VBc3luYyhpbnZlcnNlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpbnZlcnNlS2V5ID0gbnVsbDsKICAgICAgICBpbnZlcnNlSXNBc3luYyA9IGZhbHNlOwogICAgICB9CgogICAgICB0aGlzLl9faW52ZXJzZUtleSA9IGludmVyc2VLZXk7CiAgICAgIHRoaXMuX19pbnZlcnNlSXNBc3luYyA9IGludmVyc2VJc0FzeW5jOwogICAgfTsKCiAgICBfY3JlYXRlQ2xhc3MkOChSZWxhdGlvbnNoaXBEZWZpbml0aW9uLCBbewogICAgICBrZXk6ICJrZXkiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5tZXRhLmtleTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJraW5kIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubWV0YS5raW5kOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInR5cGUiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICBpZiAodGhpcy5fdHlwZSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3R5cGU7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl90eXBlID0gdHlwZUZvclJlbGF0aW9uc2hpcE1ldGEodGhpcy5tZXRhKTsKICAgICAgICByZXR1cm4gdGhpcy5fdHlwZTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJvcHRpb25zIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubWV0YS5vcHRpb25zOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIm5hbWUiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5tZXRhLm5hbWU7CiAgICAgIH0KICAgIH1dKTsKCiAgICByZXR1cm4gUmVsYXRpb25zaGlwRGVmaW5pdGlvbjsKICB9KCk7CgogIGZ1bmN0aW9uIGlzSW52ZXJzZUFzeW5jKG1ldGEpIHsKICAgIHZhciBpbnZlcnNlQXN5bmMgPSBtZXRhLm9wdGlvbnMgJiYgbWV0YS5vcHRpb25zLmFzeW5jOwogICAgcmV0dXJuIHR5cGVvZiBpbnZlcnNlQXN5bmMgPT09ICd1bmRlZmluZWQnID8gdHJ1ZSA6IGludmVyc2VBc3luYzsKICB9CgogIGZ1bmN0aW9uIHJlbGF0aW9uc2hpcEZyb21NZXRhKG1ldGEpIHsKICAgIHJldHVybiBuZXcgUmVsYXRpb25zaGlwRGVmaW5pdGlvbihtZXRhKTsKICB9CgogIC8qKgogICAgQG1vZHVsZSBAZW1iZXItZGF0YS9zdG9yZQogICovCgogIHZhciByZWxhdGlvbnNoaXBzRGVzY3JpcHRvciA9IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uICgpIHsKICAgIHZhciBtYXAgPSBuZXcgTWFwKCk7CiAgICB2YXIgcmVsYXRpb25zaGlwc0J5TmFtZSA9IEVtYmVyLmdldCh0aGlzLCAncmVsYXRpb25zaGlwc0J5TmFtZScpOyAvLyBMb29wIHRocm91Z2ggZWFjaCBjb21wdXRlZCBwcm9wZXJ0eSBvbiB0aGUgY2xhc3MKCiAgICByZWxhdGlvbnNoaXBzQnlOYW1lLmZvckVhY2goZnVuY3Rpb24gKGRlc2MpIHsKICAgICAgdmFyIHR5cGUgPSBkZXNjLnR5cGU7CgogICAgICBpZiAoIW1hcC5oYXModHlwZSkpIHsKICAgICAgICBtYXAuc2V0KHR5cGUsIFtdKTsKICAgICAgfQoKICAgICAgbWFwLmdldCh0eXBlKS5wdXNoKGRlc2MpOwogICAgfSk7CiAgICByZXR1cm4gbWFwOwogIH0pLnJlYWRPbmx5KCk7CiAgdmFyIHJlbGF0ZWRUeXBlc0Rlc2NyaXB0b3IgPSBFbWJlci5jb21wdXRlZChmdW5jdGlvbiAoKSB7CgogICAgdmFyIHBhcmVudE1vZGVsTmFtZSA9IHRoaXMubW9kZWxOYW1lOwogICAgdmFyIHR5cGVzID0gRW1iZXIuQSgpOyAvLyBMb29wIHRocm91Z2ggZWFjaCBjb21wdXRlZCBwcm9wZXJ0eSBvbiB0aGUgY2xhc3MsCiAgICAvLyBhbmQgY3JlYXRlIGFuIGFycmF5IG9mIHRoZSB1bmlxdWUgdHlwZXMgaW52b2x2ZWQKICAgIC8vIGluIHJlbGF0aW9uc2hpcHMKCiAgICB0aGlzLmVhY2hDb21wdXRlZFByb3BlcnR5KGZ1bmN0aW9uIChuYW1lLCBtZXRhKSB7CiAgICAgIGlmIChtZXRhLmlzUmVsYXRpb25zaGlwKSB7CiAgICAgICAgbWV0YS5rZXkgPSBuYW1lOwogICAgICAgIHZhciBtb2RlbE5hbWUgPSB0eXBlRm9yUmVsYXRpb25zaGlwTWV0YShtZXRhKTsKCiAgICAgICAgaWYgKCF0eXBlcy5pbmNsdWRlcyhtb2RlbE5hbWUpKSB7CiAgICAgICAgICB0eXBlcy5wdXNoKG1vZGVsTmFtZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHJldHVybiB0eXBlczsKICB9KS5yZWFkT25seSgpOwogIHZhciByZWxhdGlvbnNoaXBzT2JqZWN0RGVzY3JpcHRvciA9IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uICgpIHsKICAgIHZhciByZWxhdGlvbnNoaXBzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHZhciBtb2RlbE5hbWUgPSB0aGlzLm1vZGVsTmFtZTsKICAgIHRoaXMuZWFjaENvbXB1dGVkUHJvcGVydHkoZnVuY3Rpb24gKG5hbWUsIG1ldGEpIHsKICAgICAgaWYgKG1ldGEuaXNSZWxhdGlvbnNoaXApIHsKICAgICAgICBtZXRhLmtleSA9IG5hbWU7CiAgICAgICAgbWV0YS5uYW1lID0gbmFtZTsKICAgICAgICBtZXRhLnBhcmVudE1vZGVsTmFtZSA9IG1vZGVsTmFtZTsKICAgICAgICByZWxhdGlvbnNoaXBzW25hbWVdID0gcmVsYXRpb25zaGlwRnJvbU1ldGEobWV0YSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlbGF0aW9uc2hpcHM7CiAgfSk7CiAgdmFyIHJlbGF0aW9uc2hpcHNCeU5hbWVEZXNjcmlwdG9yID0gRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24gKCkgewogICAgdmFyIG1hcCA9IG5ldyBNYXAoKTsKICAgIHZhciByZWxzID0gRW1iZXIuZ2V0KHRoaXMsICdyZWxhdGlvbnNoaXBzT2JqZWN0Jyk7CiAgICB2YXIgcmVsYXRpb25zaGlwcyA9IE9iamVjdC5rZXlzKHJlbHMpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVsYXRpb25zaGlwcy5sZW5ndGg7IGkrKykgewogICAgICB2YXIga2V5ID0gcmVsYXRpb25zaGlwc1tpXTsKICAgICAgdmFyIHZhbHVlID0gcmVsc1trZXldOwogICAgICBtYXAuc2V0KHZhbHVlLmtleSwgdmFsdWUpOwogICAgfQoKICAgIHJldHVybiBtYXA7CiAgfSkucmVhZE9ubHkoKTsKCiAgZXhwb3J0cy5BZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXkgPSBBZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXk7CiAgZXhwb3J0cy5EZXByZWNhdGVkRXZlbnRlZCA9IERlcHJlY2F0ZWRFdmVudGVkOwogIGV4cG9ydHMuSW50ZXJuYWxNb2RlbCA9IEludGVybmFsTW9kZWw7CiAgZXhwb3J0cy5NYW55QXJyYXkgPSBNYW55QXJyYXk7CiAgZXhwb3J0cy5Qcm9taXNlQXJyYXkgPSBQcm9taXNlQXJyYXk7CiAgZXhwb3J0cy5Qcm9taXNlTWFueUFycmF5ID0gUHJvbWlzZU1hbnlBcnJheTsKICBleHBvcnRzLlByb21pc2VPYmplY3QgPSBQcm9taXNlT2JqZWN0OwogIGV4cG9ydHMuUmVjb3JkQXJyYXkgPSBSZWNvcmRBcnJheTsKICBleHBvcnRzLlJlY29yZEFycmF5TWFuYWdlciA9IFJlY29yZEFycmF5TWFuYWdlcjsKICBleHBvcnRzLlJlY29yZERhdGFTdG9yZVdyYXBwZXIgPSBSZWNvcmREYXRhU3RvcmVXcmFwcGVyOwogIGV4cG9ydHMuUm9vdFN0YXRlID0gUm9vdFN0YXRlJDE7CiAgZXhwb3J0cy5TbmFwc2hvdCA9IFNuYXBzaG90OwogIGV4cG9ydHMuU25hcHNob3RSZWNvcmRBcnJheSA9IFNuYXBzaG90UmVjb3JkQXJyYXk7CiAgZXhwb3J0cy5TdG9yZSA9IFN0b3JlOwogIGV4cG9ydHMuX2JpbmQgPSBfYmluZDsKICBleHBvcnRzLl9ndWFyZCA9IF9ndWFyZDsKICBleHBvcnRzLl9vYmplY3RJc0FsaXZlID0gX29iamVjdElzQWxpdmU7CiAgZXhwb3J0cy5jb2VyY2VJZCA9IGNvZXJjZUlkOwogIGV4cG9ydHMuZGlmZkFycmF5ID0gZGlmZkFycmF5OwogIGV4cG9ydHMuZXJyb3JzQXJyYXlUb0hhc2ggPSBlcnJvcnNBcnJheVRvSGFzaDsKICBleHBvcnRzLmVycm9yc0hhc2hUb0FycmF5ID0gZXJyb3JzSGFzaFRvQXJyYXk7CiAgZXhwb3J0cy5ndWFyZERlc3Ryb3llZFN0b3JlID0gZ3VhcmREZXN0cm95ZWRTdG9yZTsKICBleHBvcnRzLmlkZW50aWZpZXJDYWNoZUZvciA9IGlkZW50aWZpZXJDYWNoZUZvcjsKICBleHBvcnRzLm5vcm1hbGl6ZU1vZGVsTmFtZSA9IG5vcm1hbGl6ZU1vZGVsTmFtZTsKICBleHBvcnRzLnJlY29yZERhdGFGb3IgPSByZWNvcmREYXRhRm9yOwogIGV4cG9ydHMucmVjb3JkSWRlbnRpZmllckZvciA9IHJlY29yZElkZW50aWZpZXJGb3I7CiAgZXhwb3J0cy5yZWxhdGVkVHlwZXNEZXNjcmlwdG9yID0gcmVsYXRlZFR5cGVzRGVzY3JpcHRvcjsKICBleHBvcnRzLnJlbGF0aW9uc2hpcHNCeU5hbWVEZXNjcmlwdG9yID0gcmVsYXRpb25zaGlwc0J5TmFtZURlc2NyaXB0b3I7CiAgZXhwb3J0cy5yZWxhdGlvbnNoaXBzRGVzY3JpcHRvciA9IHJlbGF0aW9uc2hpcHNEZXNjcmlwdG9yOwogIGV4cG9ydHMucmVsYXRpb25zaGlwc09iamVjdERlc2NyaXB0b3IgPSByZWxhdGlvbnNoaXBzT2JqZWN0RGVzY3JpcHRvcjsKICBleHBvcnRzLnNldElkZW50aWZpZXJGb3JnZXRNZXRob2QgPSBzZXRJZGVudGlmaWVyRm9yZ2V0TWV0aG9kOwogIGV4cG9ydHMuc2V0SWRlbnRpZmllckdlbmVyYXRpb25NZXRob2QgPSBzZXRJZGVudGlmaWVyR2VuZXJhdGlvbk1ldGhvZDsKICBleHBvcnRzLnNldElkZW50aWZpZXJSZXNldE1ldGhvZCA9IHNldElkZW50aWZpZXJSZXNldE1ldGhvZDsKICBleHBvcnRzLnNldElkZW50aWZpZXJVcGRhdGVNZXRob2QgPSBzZXRJZGVudGlmaWVyVXBkYXRlTWV0aG9kOwogIGV4cG9ydHMudXBncmFkZUZvckludGVybmFsID0gdXBncmFkZUZvckludGVybmFsOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7IHZhbHVlOiB0cnVlIH0pOwoKfSk7Cgo7ZGVmaW5lKCJAZW1iZXItZGF0YS9zdG9yZS9pbmRleCIsIFsiZXhwb3J0cyIsICJAZW1iZXItZGF0YS9zdG9yZS8tcHJpdmF0ZSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9wcml2YXRlKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJkZWZhdWx0IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3ByaXZhdGUuU3RvcmU7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAibm9ybWFsaXplTW9kZWxOYW1lIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3ByaXZhdGUubm9ybWFsaXplTW9kZWxOYW1lOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgInNldElkZW50aWZpZXJHZW5lcmF0aW9uTWV0aG9kIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3ByaXZhdGUuc2V0SWRlbnRpZmllckdlbmVyYXRpb25NZXRob2Q7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAic2V0SWRlbnRpZmllclVwZGF0ZU1ldGhvZCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9wcml2YXRlLnNldElkZW50aWZpZXJVcGRhdGVNZXRob2Q7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAic2V0SWRlbnRpZmllckZvcmdldE1ldGhvZCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9wcml2YXRlLnNldElkZW50aWZpZXJGb3JnZXRNZXRob2Q7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAic2V0SWRlbnRpZmllclJlc2V0TWV0aG9kIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3ByaXZhdGUuc2V0SWRlbnRpZmllclJlc2V0TWV0aG9kOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgInJlY29yZElkZW50aWZpZXJGb3IiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfcHJpdmF0ZS5yZWNvcmRJZGVudGlmaWVyRm9yOwogICAgfQogIH0pOwp9KTsKO2RlZmluZSgnQGVtYmVyL29yZGVyZWQtc2V0L2luZGV4JywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwoKICBmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7CiAgICBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsKICAgIH0KICB9CgogIHZhciBORUVEU19DVVNUT01fT1JERVJFRF9TRVQgPSB0cnVlOwoKICB2YXIgT3JkZXJlZFNldCA9IHZvaWQgMDsKCiAgaWYgKE5FRURTX0NVU1RPTV9PUkRFUkVEX1NFVCkgewogICAgLyoqCiAgICBAY2xhc3MgT3JkZXJlZFNldAogICAgQGNvbnN0cnVjdG9yCiAgICAqLwogICAgT3JkZXJlZFNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgZnVuY3Rpb24gT3JkZXJlZFNldCgpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgT3JkZXJlZFNldCk7CgogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgfQoKICAgICAgLyoqCiAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgIEBzdGF0aWMKICAgICAgQHJldHVybiB7T3JkZXJlZFNldH0KICAgICAgKi8KCgogICAgICBPcmRlcmVkU2V0LmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZSgpIHsKICAgICAgICB2YXIgQ29uc3RydWN0b3IgPSB0aGlzOwogICAgICAgIHJldHVybiBuZXcgQ29uc3RydWN0b3IoKTsKICAgICAgfTsKCiAgICAgIE9yZGVyZWRTZXQucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAgICAgdGhpcy5wcmVzZW5jZVNldCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgICAgdGhpcy5saXN0ID0gW107CiAgICAgICAgdGhpcy5zaXplID0gMDsKICAgICAgfTsKCiAgICAgIE9yZGVyZWRTZXQucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uIGFkZChvYmosIF9ndWlkKSB7CiAgICAgICAgdmFyIGd1aWQgPSBfZ3VpZCB8fCBFbWJlci5ndWlkRm9yKG9iaik7CiAgICAgICAgdmFyIHByZXNlbmNlU2V0ID0gdGhpcy5wcmVzZW5jZVNldDsKICAgICAgICB2YXIgbGlzdCA9IHRoaXMubGlzdDsKCiAgICAgICAgaWYgKHByZXNlbmNlU2V0W2d1aWRdICE9PSB0cnVlKSB7CiAgICAgICAgICBwcmVzZW5jZVNldFtndWlkXSA9IHRydWU7CiAgICAgICAgICB0aGlzLnNpemUgPSBsaXN0LnB1c2gob2JqKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9OwoKICAgICAgT3JkZXJlZFNldC5wcm90b3R5cGUuZGVsZXRlID0gZnVuY3Rpb24gX2RlbGV0ZShvYmosIF9ndWlkKSB7CiAgICAgICAgdmFyIGd1aWQgPSBfZ3VpZCB8fCBFbWJlci5ndWlkRm9yKG9iaik7CiAgICAgICAgdmFyIHByZXNlbmNlU2V0ID0gdGhpcy5wcmVzZW5jZVNldDsKICAgICAgICB2YXIgbGlzdCA9IHRoaXMubGlzdDsKCiAgICAgICAgaWYgKHByZXNlbmNlU2V0W2d1aWRdID09PSB0cnVlKSB7CiAgICAgICAgICBkZWxldGUgcHJlc2VuY2VTZXRbZ3VpZF07CiAgICAgICAgICB2YXIgaW5kZXggPSBsaXN0LmluZGV4T2Yob2JqKTsKICAgICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICAgIGxpc3Quc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuc2l6ZSA9IGxpc3QubGVuZ3RoOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBPcmRlcmVkU2V0LnByb3RvdHlwZS5pc0VtcHR5ID0gZnVuY3Rpb24gaXNFbXB0eSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5zaXplID09PSAwOwogICAgICB9OwoKICAgICAgT3JkZXJlZFNldC5wcm90b3R5cGUuaGFzID0gZnVuY3Rpb24gaGFzKG9iaikgewogICAgICAgIGlmICh0aGlzLnNpemUgPT09IDApIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHZhciBndWlkID0gRW1iZXIuZ3VpZEZvcihvYmopOwogICAgICAgIHZhciBwcmVzZW5jZVNldCA9IHRoaXMucHJlc2VuY2VTZXQ7CgogICAgICAgIHJldHVybiBwcmVzZW5jZVNldFtndWlkXSA9PT0gdHJ1ZTsKICAgICAgfTsKCiAgICAgIE9yZGVyZWRTZXQucHJvdG90eXBlLmZvckVhY2ggPSBmdW5jdGlvbiBmb3JFYWNoKGZuIC8qLCAuLi50aGlzQXJnKi8pIHsKICAgICAgICAoZmFsc2UgJiYgISh0eXBlb2YgZm4gPT09ICdmdW5jdGlvbicpICYmIEVtYmVyLmFzc2VydChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZm4pICsgJyBpcyBub3QgYSBmdW5jdGlvbicsIHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJykpOwoKCiAgICAgICAgaWYgKHRoaXMuc2l6ZSA9PT0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGxpc3QgPSB0aGlzLmxpc3Q7CgogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgZm4uY2FsbChhcmd1bWVudHNbMV0sIGxpc3RbaV0pOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgbGlzdC5sZW5ndGg7IF9pKyspIHsKICAgICAgICAgICAgZm4obGlzdFtfaV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKCiAgICAgIE9yZGVyZWRTZXQucHJvdG90eXBlLnRvQXJyYXkgPSBmdW5jdGlvbiB0b0FycmF5KCkgewogICAgICAgIHJldHVybiB0aGlzLmxpc3Quc2xpY2UoKTsKICAgICAgfTsKCiAgICAgIE9yZGVyZWRTZXQucHJvdG90eXBlLmNvcHkgPSBmdW5jdGlvbiBjb3B5KCkgewogICAgICAgIHZhciBDb25zdHJ1Y3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICAgdmFyIHNldCA9IG5ldyBDb25zdHJ1Y3RvcigpOwoKICAgICAgICBzZXQucHJlc2VuY2VTZXQgPSBPYmplY3QuY3JlYXRlKG51bGwpOwoKICAgICAgICBmb3IgKHZhciBwcm9wIGluIHRoaXMucHJlc2VuY2VTZXQpIHsKICAgICAgICAgIC8vIGhhc093blByb3BlcnkgaXMgbm90IG5lZWRlZCBiZWNhdXNlIG9iaiBpcyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgICAgc2V0LnByZXNlbmNlU2V0W3Byb3BdID0gdGhpcy5wcmVzZW5jZVNldFtwcm9wXTsKICAgICAgICB9CgogICAgICAgIHNldC5saXN0ID0gdGhpcy50b0FycmF5KCk7CiAgICAgICAgc2V0LnNpemUgPSB0aGlzLnNpemU7CgogICAgICAgIHJldHVybiBzZXQ7CiAgICAgIH07CgogICAgICByZXR1cm4gT3JkZXJlZFNldDsKICAgIH0oKTsKICB9IGVsc2UgewogICAgT3JkZXJlZFNldCA9IEVtYmVyLl9fT3JkZXJlZFNldF9fIHx8IEVtYmVyLk9yZGVyZWRTZXQ7CiAgfQoKICBleHBvcnRzLmRlZmF1bHQgPSBPcmRlcmVkU2V0Owp9KTsKO2RlZmluZSgnZW1iZXItY2xpLWFwcC12ZXJzaW9uL2luaXRpYWxpemVyLWZhY3RvcnknLCBbJ2V4cG9ydHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5kZWZhdWx0ID0gaW5pdGlhbGl6ZXJGYWN0b3J5OwogIHZhciBsaWJyYXJpZXMgPSBFbWJlci5saWJyYXJpZXM7CiAgZnVuY3Rpb24gaW5pdGlhbGl6ZXJGYWN0b3J5KG5hbWUsIHZlcnNpb24pIHsKICAgIHZhciByZWdpc3RlcmVkID0gZmFsc2U7CgogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKCFyZWdpc3RlcmVkICYmIG5hbWUgJiYgdmVyc2lvbikgewogICAgICAgIHZhciBhcHBOYW1lID0gRW1iZXIuU3RyaW5nLmNsYXNzaWZ5KG5hbWUpOwogICAgICAgIGxpYnJhcmllcy5yZWdpc3RlcihhcHBOYW1lLCB2ZXJzaW9uKTsKICAgICAgICByZWdpc3RlcmVkID0gdHJ1ZTsKICAgICAgfQogICAgfTsKICB9Cn0pOwo7ZGVmaW5lKCJlbWJlci1jbGktYXBwLXZlcnNpb24vdXRpbHMvcmVnZXhwIiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIHZhciB2ZXJzaW9uUmVnRXhwID0gZXhwb3J0cy52ZXJzaW9uUmVnRXhwID0gL1xkK1suXVxkK1suXVxkKy87IC8vIE1hdGNoIGFueSBudW1iZXIgb2YgMyBzZWN0aW9ucyBvZiBkaWdpdHMgc2VwYXJhdGVkIGJ5IC4KICB2YXIgdmVyc2lvbkV4dGVuZGVkUmVnRXhwID0gZXhwb3J0cy52ZXJzaW9uRXh0ZW5kZWRSZWdFeHAgPSAvXGQrWy5dXGQrWy5dXGQrLVthLXpdKihbLl1cZCspPy87IC8vIE1hdGNoIHRoZSBhYm92ZSBidXQgYWxzbyBoeXBoZW4gZm9sbG93ZWQgYnkgYW55IG51bWJlciBvZiBsb3dlcmNhc2UgbGV0dGVycywgdGhlbiBvcHRpb25hbGx5IHBlcmlvZCBhbmQgZGlnaXRzCiAgdmFyIHNoYVJlZ0V4cCA9IGV4cG9ydHMuc2hhUmVnRXhwID0gL1thLXpcZF17OH0kLzsgLy8gTWF0Y2ggOCBsb3dlcmNhc2UgbGV0dGVycyBhbmQgZGlnaXRzLCBhdCB0aGUgZW5kIG9mIHRoZSBzdHJpbmcgb25seSAodG8gYXZvaWQgbWF0Y2hpbmcgd2l0aCB2ZXJzaW9uIGV4dGVuZGVkIHBhcnQpCn0pOwo7ZGVmaW5lKCdlbWJlci1kYXRhLy1wcml2YXRlJywgWydleHBvcnRzJywgJ0BlbWJlci1kYXRhL3N0b3JlJywgJ2VtYmVyLWRhdGEvdmVyc2lvbicsICdAZW1iZXItZGF0YS9tb2RlbC8tcHJpdmF0ZScsICdAZW1iZXItZGF0YS9zdG9yZS8tcHJpdmF0ZScsICdAZW1iZXItZGF0YS9yZWNvcmQtZGF0YS8tcHJpdmF0ZSddLCBmdW5jdGlvbiAoZXhwb3J0cywgc3RvcmUsIFZFUlNJT04sIFByaXZhdGUsIFByaXZhdGUkMSwgUHJpdmF0ZSQyKSB7ICd1c2Ugc3RyaWN0JzsKCiAgc3RvcmUgPSBzdG9yZSAmJiBzdG9yZS5oYXNPd25Qcm9wZXJ0eSgnZGVmYXVsdCcpID8gc3RvcmVbJ2RlZmF1bHQnXSA6IHN0b3JlOwogIFZFUlNJT04gPSBWRVJTSU9OICYmIFZFUlNJT04uaGFzT3duUHJvcGVydHkoJ2RlZmF1bHQnKSA/IFZFUlNJT05bJ2RlZmF1bHQnXSA6IFZFUlNJT047CgogIC8qKgogICAqIEBwcm9wZXJ0eSBWRVJTSU9OCiAgICogQHB1YmxpYwogICAqIEBzdGF0aWMKICAgKiBAZm9yIEBlbWJlci1kYXRhCiAgICovCgogIHZhciBEUyA9IEVtYmVyLk5hbWVzcGFjZS5jcmVhdGUoewogICAgVkVSU0lPTjogVkVSU0lPTiwKICAgIG5hbWU6ICdEUycKICB9KTsKCiAgaWYgKEVtYmVyLmxpYnJhcmllcykgewogICAgRW1iZXIubGlicmFyaWVzLnJlZ2lzdGVyQ29yZUxpYnJhcnkoJ0VtYmVyIERhdGEnLCBWRVJTSU9OKTsKICB9CgogIGZ1bmN0aW9uIGZlYXR1cmVJc0VuYWJsZWQoKSB7CiAgICByZXR1cm4gRW1iZXIuRkVBVFVSRVMuaXNFbmFibGVkLmFwcGx5KHZvaWQgMCwgYXJndW1lbnRzKTsKICB9CgogIGV4cG9ydHMuU3RvcmUgPSBzdG9yZTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ0Vycm9ycycsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIFByaXZhdGUuRXJyb3JzOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gUHJpdmF0ZSQxLkFkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ0ludGVybmFsTW9kZWwnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBQcml2YXRlJDEuSW50ZXJuYWxNb2RlbDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ01hbnlBcnJheScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIFByaXZhdGUkMS5NYW55QXJyYXk7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdQcm9taXNlQXJyYXknLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBQcml2YXRlJDEuUHJvbWlzZUFycmF5OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnUHJvbWlzZU1hbnlBcnJheScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIFByaXZhdGUkMS5Qcm9taXNlTWFueUFycmF5OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnUHJvbWlzZU9iamVjdCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIFByaXZhdGUkMS5Qcm9taXNlT2JqZWN0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnUmVjb3JkQXJyYXknLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBQcml2YXRlJDEuUmVjb3JkQXJyYXk7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdSZWNvcmRBcnJheU1hbmFnZXInLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBQcml2YXRlJDEuUmVjb3JkQXJyYXlNYW5hZ2VyOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnUm9vdFN0YXRlJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gUHJpdmF0ZSQxLlJvb3RTdGF0ZTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ1NuYXBzaG90JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gUHJpdmF0ZSQxLlNuYXBzaG90OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnU25hcHNob3RSZWNvcmRBcnJheScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIFByaXZhdGUkMS5TbmFwc2hvdFJlY29yZEFycmF5OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnY29lcmNlSWQnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBQcml2YXRlJDEuY29lcmNlSWQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdub3JtYWxpemVNb2RlbE5hbWUnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBQcml2YXRlJDEubm9ybWFsaXplTW9kZWxOYW1lOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnUmVjb3JkRGF0YScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIFByaXZhdGUkMi5SZWNvcmREYXRhOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnUmVsYXRpb25zaGlwJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gUHJpdmF0ZSQyLlJlbGF0aW9uc2hpcDsKICAgIH0KICB9KTsKICBleHBvcnRzLkRTID0gRFM7CiAgZXhwb3J0cy5pc0VuYWJsZWQgPSBmZWF0dXJlSXNFbmFibGVkOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7IHZhbHVlOiB0cnVlIH0pOwoKfSk7Cgo7ZGVmaW5lKCJlbWJlci1kYXRhL2FkYXB0ZXIiLCBbImV4cG9ydHMiLCAiQGVtYmVyLWRhdGEvYWRhcHRlciJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9hZGFwdGVyKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJkZWZhdWx0IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2FkYXB0ZXIuZGVmYXVsdDsKICAgIH0KICB9KTsKfSk7CjtkZWZpbmUoImVtYmVyLWRhdGEvYWRhcHRlcnMvZXJyb3JzIiwgWyJleHBvcnRzIiwgIkBlbWJlci1kYXRhL2FkYXB0ZXIvZXJyb3IiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfZXJyb3IpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIkFib3J0RXJyb3IiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfZXJyb3IuQWJvcnRFcnJvcjsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJBZGFwdGVyRXJyb3IiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfZXJyb3IuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJDb25mbGljdEVycm9yIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2Vycm9yLkNvbmZsaWN0RXJyb3I7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiRm9yYmlkZGVuRXJyb3IiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfZXJyb3IuRm9yYmlkZGVuRXJyb3I7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiSW52YWxpZEVycm9yIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2Vycm9yLkludmFsaWRFcnJvcjsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJOb3RGb3VuZEVycm9yIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2Vycm9yLk5vdEZvdW5kRXJyb3I7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiU2VydmVyRXJyb3IiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfZXJyb3IuU2VydmVyRXJyb3I7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiVGltZW91dEVycm9yIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2Vycm9yLlRpbWVvdXRFcnJvcjsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJVbmF1dGhvcml6ZWRFcnJvciIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9lcnJvci5VbmF1dGhvcml6ZWRFcnJvcjsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJlcnJvcnNBcnJheVRvSGFzaCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9lcnJvci5lcnJvcnNBcnJheVRvSGFzaDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJlcnJvcnNIYXNoVG9BcnJheSIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9lcnJvci5lcnJvcnNIYXNoVG9BcnJheTsKICAgIH0KICB9KTsKfSk7CjtkZWZpbmUoImVtYmVyLWRhdGEvYWRhcHRlcnMvanNvbi1hcGkiLCBbImV4cG9ydHMiLCAiQGVtYmVyLWRhdGEvYWRhcHRlci9qc29uLWFwaSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9qc29uQXBpKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJkZWZhdWx0IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2pzb25BcGkuZGVmYXVsdDsKICAgIH0KICB9KTsKfSk7CjtkZWZpbmUoImVtYmVyLWRhdGEvYWRhcHRlcnMvcmVzdCIsIFsiZXhwb3J0cyIsICJAZW1iZXItZGF0YS9hZGFwdGVyL3Jlc3QiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfcmVzdCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiZGVmYXVsdCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9yZXN0LmRlZmF1bHQ7CiAgICB9CiAgfSk7Cn0pOwo7ZGVmaW5lKCJlbWJlci1kYXRhL2F0dHIiLCBbImV4cG9ydHMiLCAiQGVtYmVyLWRhdGEvbW9kZWwiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfbW9kZWwpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImRlZmF1bHQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfbW9kZWwuYXR0cjsKICAgIH0KICB9KTsKfSk7CjtkZWZpbmUoImVtYmVyLWRhdGEvaW5kZXgiLCBbImV4cG9ydHMiLCAiZW1iZXItZGF0YS9zdG9yZSIsICJAZW1iZXItZGF0YS9zdG9yZSIsICJAZW1iZXItZGF0YS9kZWJ1ZyIsICJlbWJlci1kYXRhLy1wcml2YXRlIiwgImVtYmVyLWluZmxlY3RvciIsICJlbWJlci1kYXRhL3NldHVwLWNvbnRhaW5lciIsICJlbWJlci1kYXRhL2luaXRpYWxpemUtc3RvcmUtc2VydmljZSIsICJAZW1iZXItZGF0YS9zZXJpYWxpemVyL3RyYW5zZm9ybSIsICJAZW1iZXItZGF0YS9zZXJpYWxpemVyLy1wcml2YXRlIiwgIkBlbWJlci1kYXRhL2FkYXB0ZXIiLCAiQGVtYmVyLWRhdGEvYWRhcHRlci9qc29uLWFwaSIsICJAZW1iZXItZGF0YS9hZGFwdGVyL3Jlc3QiLCAiQGVtYmVyLWRhdGEvYWRhcHRlci9lcnJvciIsICJAZW1iZXItZGF0YS9zZXJpYWxpemVyIiwgIkBlbWJlci1kYXRhL3NlcmlhbGl6ZXIvanNvbi1hcGkiLCAiQGVtYmVyLWRhdGEvc2VyaWFsaXplci9qc29uIiwgIkBlbWJlci1kYXRhL3NlcmlhbGl6ZXIvcmVzdCIsICJAZW1iZXItZGF0YS9tb2RlbCJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9zdG9yZSwgX3N0b3JlMiwgX2RlYnVnLCBfcHJpdmF0ZSwgX2VtYmVySW5mbGVjdG9yLCBfc2V0dXBDb250YWluZXIsIF9pbml0aWFsaXplU3RvcmVTZXJ2aWNlLCBfdHJhbnNmb3JtLCBfcHJpdmF0ZTIsIF9hZGFwdGVyLCBfanNvbkFwaSwgX3Jlc3QsIF9lcnJvciwgX3NlcmlhbGl6ZXIsIF9qc29uQXBpMiwgX2pzb24sIF9yZXN0MiwgX21vZGVsKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKICBpZiAoRW1iZXIuVkVSU0lPTi5tYXRjaCgvXjFcLihbMC05XXwxWzAtMl0pXC4vKSkgewogICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKCdFbWJlciBEYXRhIHJlcXVpcmVzIGF0IGxlYXN0IEVtYmVyIDEuMTMuMCwgYnV0IHlvdSBoYXZlICcgKyBFbWJlci5WRVJTSU9OICsgJy4gUGxlYXNlIHVwZ3JhZGUgeW91ciB2ZXJzaW9uIG9mIEVtYmVyLCB0aGVuIHVwZ3JhZGUgRW1iZXIgRGF0YS4nKTsKICB9CgogIF9wcml2YXRlLkRTLlN0b3JlID0gX3N0b3JlLmRlZmF1bHQ7CiAgX3ByaXZhdGUuRFMuUHJvbWlzZUFycmF5ID0gX3ByaXZhdGUuUHJvbWlzZUFycmF5OwogIF9wcml2YXRlLkRTLlByb21pc2VPYmplY3QgPSBfcHJpdmF0ZS5Qcm9taXNlT2JqZWN0OwogIF9wcml2YXRlLkRTLlByb21pc2VNYW55QXJyYXkgPSBfcHJpdmF0ZS5Qcm9taXNlTWFueUFycmF5OwogIF9wcml2YXRlLkRTLk1vZGVsID0gX21vZGVsLmRlZmF1bHQ7CiAgX3ByaXZhdGUuRFMuUm9vdFN0YXRlID0gX3ByaXZhdGUuUm9vdFN0YXRlOwogIF9wcml2YXRlLkRTLmF0dHIgPSBfbW9kZWwuYXR0cjsKICBfcHJpdmF0ZS5EUy5FcnJvcnMgPSBfcHJpdmF0ZS5FcnJvcnM7CiAgX3ByaXZhdGUuRFMuSW50ZXJuYWxNb2RlbCA9IF9wcml2YXRlLkludGVybmFsTW9kZWw7CiAgX3ByaXZhdGUuRFMuU25hcHNob3QgPSBfcHJpdmF0ZS5TbmFwc2hvdDsKICBfcHJpdmF0ZS5EUy5BZGFwdGVyID0gX2FkYXB0ZXIuZGVmYXVsdDsKICBfcHJpdmF0ZS5EUy5BZGFwdGVyRXJyb3IgPSBfZXJyb3IuZGVmYXVsdDsKICBfcHJpdmF0ZS5EUy5JbnZhbGlkRXJyb3IgPSBfZXJyb3IuSW52YWxpZEVycm9yOwogIF9wcml2YXRlLkRTLlRpbWVvdXRFcnJvciA9IF9lcnJvci5UaW1lb3V0RXJyb3I7CiAgX3ByaXZhdGUuRFMuQWJvcnRFcnJvciA9IF9lcnJvci5BYm9ydEVycm9yOwogIF9wcml2YXRlLkRTLlVuYXV0aG9yaXplZEVycm9yID0gX2Vycm9yLlVuYXV0aG9yaXplZEVycm9yOwogIF9wcml2YXRlLkRTLkZvcmJpZGRlbkVycm9yID0gX2Vycm9yLkZvcmJpZGRlbkVycm9yOwogIF9wcml2YXRlLkRTLk5vdEZvdW5kRXJyb3IgPSBfZXJyb3IuTm90Rm91bmRFcnJvcjsKICBfcHJpdmF0ZS5EUy5Db25mbGljdEVycm9yID0gX2Vycm9yLkNvbmZsaWN0RXJyb3I7CiAgX3ByaXZhdGUuRFMuU2VydmVyRXJyb3IgPSBfZXJyb3IuU2VydmVyRXJyb3I7CiAgX3ByaXZhdGUuRFMuZXJyb3JzSGFzaFRvQXJyYXkgPSBfZXJyb3IuZXJyb3JzSGFzaFRvQXJyYXk7CiAgX3ByaXZhdGUuRFMuZXJyb3JzQXJyYXlUb0hhc2ggPSBfZXJyb3IuZXJyb3JzQXJyYXlUb0hhc2g7CiAgX3ByaXZhdGUuRFMuU2VyaWFsaXplciA9IF9zZXJpYWxpemVyLmRlZmF1bHQ7CiAgX3ByaXZhdGUuRFMuRGVidWdBZGFwdGVyID0gX2RlYnVnLmRlZmF1bHQ7CiAgX3ByaXZhdGUuRFMuUmVjb3JkQXJyYXkgPSBfcHJpdmF0ZS5SZWNvcmRBcnJheTsKICBfcHJpdmF0ZS5EUy5BZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXkgPSBfcHJpdmF0ZS5BZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXk7CiAgX3ByaXZhdGUuRFMuTWFueUFycmF5ID0gX3ByaXZhdGUuTWFueUFycmF5OwogIF9wcml2YXRlLkRTLlJlY29yZEFycmF5TWFuYWdlciA9IF9wcml2YXRlLlJlY29yZEFycmF5TWFuYWdlcjsKICBfcHJpdmF0ZS5EUy5SRVNUQWRhcHRlciA9IF9yZXN0LmRlZmF1bHQ7CiAgX3ByaXZhdGUuRFMuQnVpbGRVUkxNaXhpbiA9IF9hZGFwdGVyLkJ1aWxkVVJMTWl4aW47CiAgX3ByaXZhdGUuRFMuUkVTVFNlcmlhbGl6ZXIgPSBfcmVzdDIuZGVmYXVsdDsKICBfcHJpdmF0ZS5EUy5KU09OU2VyaWFsaXplciA9IF9qc29uLmRlZmF1bHQ7CiAgX3ByaXZhdGUuRFMuSlNPTkFQSUFkYXB0ZXIgPSBfanNvbkFwaS5kZWZhdWx0OwogIF9wcml2YXRlLkRTLkpTT05BUElTZXJpYWxpemVyID0gX2pzb25BcGkyLmRlZmF1bHQ7CiAgX3ByaXZhdGUuRFMuVHJhbnNmb3JtID0gX3RyYW5zZm9ybS5kZWZhdWx0OwogIF9wcml2YXRlLkRTLkRhdGVUcmFuc2Zvcm0gPSBfcHJpdmF0ZTIuRGF0ZVRyYW5zZm9ybTsKICBfcHJpdmF0ZS5EUy5TdHJpbmdUcmFuc2Zvcm0gPSBfcHJpdmF0ZTIuU3RyaW5nVHJhbnNmb3JtOwogIF9wcml2YXRlLkRTLk51bWJlclRyYW5zZm9ybSA9IF9wcml2YXRlMi5OdW1iZXJUcmFuc2Zvcm07CiAgX3ByaXZhdGUuRFMuQm9vbGVhblRyYW5zZm9ybSA9IF9wcml2YXRlMi5Cb29sZWFuVHJhbnNmb3JtOwogIF9wcml2YXRlLkRTLkVtYmVkZGVkUmVjb3Jkc01peGluID0gX3Jlc3QyLkVtYmVkZGVkUmVjb3Jkc01peGluOwogIF9wcml2YXRlLkRTLmJlbG9uZ3NUbyA9IF9tb2RlbC5iZWxvbmdzVG87CiAgX3ByaXZhdGUuRFMuaGFzTWFueSA9IF9tb2RlbC5oYXNNYW55OwogIF9wcml2YXRlLkRTLlJlbGF0aW9uc2hpcCA9IF9wcml2YXRlLlJlbGF0aW9uc2hpcDsKICBfcHJpdmF0ZS5EUy5fc2V0dXBDb250YWluZXIgPSBfc2V0dXBDb250YWluZXIuZGVmYXVsdDsKICBfcHJpdmF0ZS5EUy5faW5pdGlhbGl6ZVN0b3JlU2VydmljZSA9IF9pbml0aWFsaXplU3RvcmVTZXJ2aWNlLmRlZmF1bHQ7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9wcml2YXRlLkRTLCAnbm9ybWFsaXplTW9kZWxOYW1lJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICB2YWx1ZTogX3N0b3JlMi5ub3JtYWxpemVNb2RlbE5hbWUKICB9KTsKICB2YXIgX2RlZmF1bHQgPSBfcHJpdmF0ZS5EUzsKICBfZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pOwo7ZGVmaW5lKCJlbWJlci1kYXRhL2luaXRpYWxpemUtc3RvcmUtc2VydmljZSIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSBpbml0aWFsaXplU3RvcmVTZXJ2aWNlOwoKICAvKgogICAgQ29uZmlndXJlcyBhIHJlZ2lzdHJ5IGZvciB1c2Ugd2l0aCBhbiBFbWJlci1EYXRhCiAgICBzdG9yZS4KICAKICAgIEBtZXRob2QgaW5pdGlhbGl6ZVN0b3JlU2VydmljZQogICAgQHBhcmFtIHtFbWJlci5BcHBsaWNhdGlvbkluc3RhbmNlIHwgRW1iZXIuRW5naW5lSW5zdGFuY2V9IGluc3RhbmNlCiAgKi8KICBmdW5jdGlvbiBpbml0aWFsaXplU3RvcmVTZXJ2aWNlKGluc3RhbmNlKSB7CiAgICAvLyBpbnN0YW5jZS5sb29rdXAgc3VwcG9ydHMgRW1iZXIgMi4xIGFuZCBoaWdoZXIKICAgIC8vIGluc3RhbmNlLmNvbnRhaW5lciBzdXBwb3J0cyBFbWJlciAxLjExIC0gMi4wCiAgICB2YXIgY29udGFpbmVyID0gaW5zdGFuY2UubG9va3VwID8gaW5zdGFuY2UgOiBpbnN0YW5jZS5jb250YWluZXI7IC8vIEVhZ2VybHkgZ2VuZXJhdGUgdGhlIHN0b3JlIHNvIGRlZmF1bHRTdG9yZSBpcyBwb3B1bGF0ZWQuCgogICAgY29udGFpbmVyLmxvb2t1cCgnc2VydmljZTpzdG9yZScpOwogIH0KfSk7CjtkZWZpbmUoImVtYmVyLWRhdGEvbW9kZWwiLCBbImV4cG9ydHMiLCAiQGVtYmVyLWRhdGEvbW9kZWwiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfbW9kZWwpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImRlZmF1bHQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfbW9kZWwuZGVmYXVsdDsKICAgIH0KICB9KTsKfSk7CjtkZWZpbmUoImVtYmVyLWRhdGEvcmVsYXRpb25zaGlwcyIsIFsiZXhwb3J0cyIsICJAZW1iZXItZGF0YS9tb2RlbCJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9tb2RlbCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiYmVsb25nc1RvIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX21vZGVsLmJlbG9uZ3NUbzsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJoYXNNYW55IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX21vZGVsLmhhc01hbnk7CiAgICB9CiAgfSk7Cn0pOwo7ZGVmaW5lKCJlbWJlci1kYXRhL3NlcmlhbGl6ZXIiLCBbImV4cG9ydHMiLCAiQGVtYmVyLWRhdGEvc2VyaWFsaXplciJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9zZXJpYWxpemVyKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJkZWZhdWx0IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3NlcmlhbGl6ZXIuZGVmYXVsdDsKICAgIH0KICB9KTsKfSk7CjtkZWZpbmUoImVtYmVyLWRhdGEvc2VyaWFsaXplcnMvZW1iZWRkZWQtcmVjb3Jkcy1taXhpbiIsIFsiZXhwb3J0cyIsICJAZW1iZXItZGF0YS9zZXJpYWxpemVyL3Jlc3QiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfcmVzdCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiZGVmYXVsdCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9yZXN0LkVtYmVkZGVkUmVjb3Jkc01peGluOwogICAgfQogIH0pOwp9KTsKO2RlZmluZSgiZW1iZXItZGF0YS9zZXJpYWxpemVycy9qc29uLWFwaSIsIFsiZXhwb3J0cyIsICJAZW1iZXItZGF0YS9zZXJpYWxpemVyL2pzb24tYXBpIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2pzb25BcGkpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImRlZmF1bHQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfanNvbkFwaS5kZWZhdWx0OwogICAgfQogIH0pOwp9KTsKO2RlZmluZSgiZW1iZXItZGF0YS9zZXJpYWxpemVycy9qc29uIiwgWyJleHBvcnRzIiwgIkBlbWJlci1kYXRhL3NlcmlhbGl6ZXIvanNvbiJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9qc29uKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJkZWZhdWx0IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2pzb24uZGVmYXVsdDsKICAgIH0KICB9KTsKfSk7CjtkZWZpbmUoImVtYmVyLWRhdGEvc2VyaWFsaXplcnMvcmVzdCIsIFsiZXhwb3J0cyIsICJAZW1iZXItZGF0YS9zZXJpYWxpemVyL3Jlc3QiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfcmVzdCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiZGVmYXVsdCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9yZXN0LmRlZmF1bHQ7CiAgICB9CiAgfSk7Cn0pOwo7ZGVmaW5lKCJlbWJlci1kYXRhL3NldHVwLWNvbnRhaW5lciIsIFsiZXhwb3J0cyIsICJAZW1iZXItZGF0YS9zdG9yZSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9zdG9yZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHNldHVwQ29udGFpbmVyOwoKICBmdW5jdGlvbiBpbml0aWFsaXplU3RvcmUoYXBwbGljYXRpb24pIHsKICAgIC8vIHdlIGNhbiBqdXN0IHVzZSByZWdpc3Rlck9wdGlvbnNGb3JUeXBlIHdoZW4gd2Ugbm8gbG9uZ2VyCiAgICAvLyBzdXBwb3J0IChkZXByZWNhdGVkKSB2ZXJzaW9ucyBvZiBAZW1iZXIvdGVzdC1oZWxwZXJzCiAgICAvLyBXZSdyZSBpc3N1aW5nIGEgInByaXZhdGUtYXBpIiBkZXByZWNhdGlvbiBmb3IgdXNlcnMgb2YgdGhlCiAgICAvLyBkZXByZWNhdGVkIEBlbWJlci90ZXN0LWhlbHBlcnMgdmVyc2lvbnMsIGJ1dCB3aWxsIGtlZXAKICAgIC8vIHRoaXMgZm9yIGFzIGxvbmcgYXMgdW50aWwgNC4wIGFzIG5lZWRlZAogICAgaWYgKGZhbHNlCiAgICAvKiBERUJVRyAqLwogICAgJiYgIWFwcGxpY2F0aW9uLnJlZ2lzdGVyT3B0aW9uc0ZvclR5cGUpIHsKICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmIEVtYmVyLmRlcHJlY2F0ZSgiRGVwcmVjYXRlZCB0ZXN0IHN5bnRheCB1c2FnZSBkZXRlY3RlZCFcblxuXHQiICsgIlRoaXMgdGVzdCByZWxpZXMgb24gYSBkZXByZWNhdGVkIHRlc3Qgc2V0dXAgdGhhdCBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGJ5IEVtYmVyRGF0YS4iICsgIiBUbyByZXNvbHZlIHRoaXMgeW91IHdpbGwgbmVlZCB0byBiZSBvbiBhIHJlY2VudCB2ZXJzaW9uIG9mIEBlbWJlci90ZXN0LWhlbHBlcnMiICsgIiBBTkQgeW91ciB0ZXN0cyBtdXN0IHVzZSBgc2V0QXBwbGljYXRpb24oKWAgaW5zdGVhZCBvZiBgc2V0UmVzb2x2ZXIoKWAgYW5kIiArICIgYG1vZHVsZSgpYCB3aXRoIGBzZXR1cCpUZXN0KClgaW5zdGVhZCBvZiBgbW9kdWxlRm9yKigpYC4iLCBmYWxzZSwgewogICAgICAgIGlkOiAnZW1iZXItZGF0YTpsZWdhY3ktdGVzdC1oZWxwZXItc3VwcG9ydCcsCiAgICAgICAgdW50aWw6ICczLjE3JwogICAgICB9KSk7CiAgICAgIGFwcGxpY2F0aW9uLm9wdGlvbnNGb3JUeXBlKCdzZXJpYWxpemVyJywgewogICAgICAgIHNpbmdsZXRvbjogZmFsc2UKICAgICAgfSk7CiAgICAgIGFwcGxpY2F0aW9uLm9wdGlvbnNGb3JUeXBlKCdhZGFwdGVyJywgewogICAgICAgIHNpbmdsZXRvbjogZmFsc2UKICAgICAgfSk7CgogICAgICBpZiAoIWFwcGxpY2F0aW9uLmhhcygnc2VydmljZTpzdG9yZScpKSB7CiAgICAgICAgYXBwbGljYXRpb24ucmVnaXN0ZXIoJ3NlcnZpY2U6c3RvcmUnLCBfc3RvcmUuZGVmYXVsdCk7CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0KCiAgICBhcHBsaWNhdGlvbi5yZWdpc3Rlck9wdGlvbnNGb3JUeXBlKCdzZXJpYWxpemVyJywgewogICAgICBzaW5nbGV0b246IGZhbHNlCiAgICB9KTsKICAgIGFwcGxpY2F0aW9uLnJlZ2lzdGVyT3B0aW9uc0ZvclR5cGUoJ2FkYXB0ZXInLCB7CiAgICAgIHNpbmdsZXRvbjogZmFsc2UKICAgIH0pOwoKICAgIGlmICghYXBwbGljYXRpb24uaGFzUmVnaXN0cmF0aW9uKCdzZXJ2aWNlOnN0b3JlJykpIHsKICAgICAgYXBwbGljYXRpb24ucmVnaXN0ZXIoJ3NlcnZpY2U6c3RvcmUnLCBfc3RvcmUuZGVmYXVsdCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpbml0aWFsaXplU3RvcmVJbmplY3Rpb25zKGFwcGxpY2F0aW9uKSB7CiAgICB2YXIgaW5qZWN0ID0gYXBwbGljYXRpb24uaW5qZWN0IHx8IGFwcGxpY2F0aW9uLmluamVjdGlvbjsKICAgIGluamVjdC5jYWxsKGFwcGxpY2F0aW9uLCAnY29udHJvbGxlcicsICdzdG9yZScsICdzZXJ2aWNlOnN0b3JlJyk7CiAgICBpbmplY3QuY2FsbChhcHBsaWNhdGlvbiwgJ3JvdXRlJywgJ3N0b3JlJywgJ3NlcnZpY2U6c3RvcmUnKTsKICB9CgogIGZ1bmN0aW9uIHNldHVwQ29udGFpbmVyKGFwcGxpY2F0aW9uKSB7CiAgICBpbml0aWFsaXplU3RvcmVJbmplY3Rpb25zKGFwcGxpY2F0aW9uKTsKICAgIGluaXRpYWxpemVTdG9yZShhcHBsaWNhdGlvbik7CiAgfQp9KTsKO2RlZmluZSgiZW1iZXItZGF0YS9zdG9yZSIsIFsiZXhwb3J0cyIsICJAZW1iZXItZGF0YS9zdG9yZSIsICJAZW1iZXItZGF0YS9yZWNvcmQtZGF0YS8tcHJpdmF0ZSIsICJAZW1iZXItZGF0YS9zdG9yZS8tcHJpdmF0ZSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9zdG9yZSwgX3ByaXZhdGUsIF9wcml2YXRlMikgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgZnVuY3Rpb24gX2luaGVyaXRzTG9vc2Uoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzLnByb3RvdHlwZSk7IHN1YkNsYXNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHN1YkNsYXNzOyBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9CgogIHZhciBEZWZhdWx0U3RvcmUgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoX1N0b3JlKSB7CiAgICBfaW5oZXJpdHNMb29zZShEZWZhdWx0U3RvcmUsIF9TdG9yZSk7CgogICAgZnVuY3Rpb24gRGVmYXVsdFN0b3JlKCkgewogICAgICByZXR1cm4gX1N0b3JlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsKICAgIH0KCiAgICB2YXIgX3Byb3RvID0gRGVmYXVsdFN0b3JlLnByb3RvdHlwZTsKCiAgICBfcHJvdG8uY3JlYXRlUmVjb3JkRGF0YUZvciA9IGZ1bmN0aW9uIGNyZWF0ZVJlY29yZERhdGFGb3IobW9kZWxOYW1lLCBpZCwgY2xpZW50SWQsIHN0b3JlV3JhcHBlcikgewogICAgICBpZiAodHJ1ZQogICAgICAvKiBJREVOVElGSUVSUyAqLwogICAgICApIHsKICAgICAgICB2YXIgaWRlbnRpZmllciA9ICgwLCBfcHJpdmF0ZTIuaWRlbnRpZmllckNhY2hlRm9yKSh0aGlzKS5nZXRPckNyZWF0ZVJlY29yZElkZW50aWZpZXIoewogICAgICAgICAgdHlwZTogbW9kZWxOYW1lLAogICAgICAgICAgaWQ6IGlkLAogICAgICAgICAgbGlkOiBjbGllbnRJZAogICAgICAgIH0pOwogICAgICAgIHJldHVybiBuZXcgX3ByaXZhdGUuUmVjb3JkRGF0YShpZGVudGlmaWVyLCBzdG9yZVdyYXBwZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuZXcgX3ByaXZhdGUuUmVjb3JkRGF0YShtb2RlbE5hbWUsIGlkLCBjbGllbnRJZCwgc3RvcmVXcmFwcGVyKTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gRGVmYXVsdFN0b3JlOwogIH0oX3N0b3JlLmRlZmF1bHQpOwoKICBfZXhwb3J0cy5kZWZhdWx0ID0gRGVmYXVsdFN0b3JlOwp9KTsKO2RlZmluZSgiZW1iZXItZGF0YS90cmFuc2Zvcm0iLCBbImV4cG9ydHMiLCAiQGVtYmVyLWRhdGEvc2VyaWFsaXplci90cmFuc2Zvcm0iXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfdHJhbnNmb3JtKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJkZWZhdWx0IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3RyYW5zZm9ybS5kZWZhdWx0OwogICAgfQogIH0pOwp9KTsKO2RlZmluZSgiZW1iZXItZGF0YS92ZXJzaW9uIiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKICB2YXIgX2RlZmF1bHQgPSAiMy4xNi4wLWFscGhhLjAiOwogIF9leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSk7CjtkZWZpbmUoJ2VtYmVyLWluZmxlY3Rvci9pbmRleCcsIFsnZXhwb3J0cycsICdlbWJlci1pbmZsZWN0b3IvbGliL3N5c3RlbScsICdlbWJlci1pbmZsZWN0b3IvbGliL2V4dC9zdHJpbmcnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9zeXN0ZW0pIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5kZWZhdWx0UnVsZXMgPSBleHBvcnRzLnNpbmd1bGFyaXplID0gZXhwb3J0cy5wbHVyYWxpemUgPSB1bmRlZmluZWQ7CgoKICBfc3lzdGVtLkluZmxlY3Rvci5kZWZhdWx0UnVsZXMgPSBfc3lzdGVtLmRlZmF1bHRSdWxlczsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVtYmVyLCAnSW5mbGVjdG9yJywgewogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIEVtYmVyLmRlcHJlY2F0ZSgnRW1iZXIuSW5mbGVjdG9yIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSBleHBsaWNpdGx5OiBpbXBvcnQgSW5mbGVjdG9yIGZyb20gXCdlbWJlci1pbmZsZWN0b3JcJzsnLCBmYWxzZSwgewogICAgICAgIGlkOiAnZW1iZXItaW5mbGVjdG9yLmdsb2JhbHMnLAogICAgICAgIHVudGlsOiAnMy4wLjAnCiAgICAgIH0pOwoKICAgICAgcmV0dXJuIF9zeXN0ZW0uSW5mbGVjdG9yOwogICAgfQogIH0sIHsgY29uZmlndXJhYmxlOiB0cnVlIH0pOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRW1iZXIuU3RyaW5nLCAnc2luZ3VsYXJpemUnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgRW1iZXIuZGVwcmVjYXRlKCdFbWJlci5TdHJpbmcuc2luZ3VsYXJpemUoKSBpcyBkZXByZWNhdGVkLiBQbGVhc2UgZXhwbGljaXRseTogaW1wb3J0IHsgc2luZ3VsYXJpemUgfSBmcm9tIFwnZW1iZXItaW5mbGVjdG9yXCc7JywgZmFsc2UsIHsKICAgICAgICBpZDogJ2VtYmVyLWluZmxlY3Rvci5nbG9iYWxzJywKICAgICAgICB1bnRpbDogJzMuMC4wJwogICAgICB9KTsKCiAgICAgIHJldHVybiBfc3lzdGVtLnNpbmd1bGFyaXplOwogICAgfQogIH0sIHsgY29uZmlndXJhYmxlOiB0cnVlIH0pOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRW1iZXIuU3RyaW5nLCAncGx1cmFsaXplJywgewogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIEVtYmVyLmRlcHJlY2F0ZSgnRW1iZXIuU3RyaW5nLnBsdXJhbGl6ZSgpIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSBleHBsaWNpdGx5OiBpbXBvcnQgeyBwbHVyYWxpemUgfSBmcm9tIFwnZW1iZXItaW5mbGVjdG9yXCc7JywgZmFsc2UsIHsKICAgICAgICBpZDogJ2VtYmVyLWluZmxlY3Rvci5nbG9iYWxzJywKICAgICAgICB1bnRpbDogJzMuMC4wJwogICAgICB9KTsKCiAgICAgIHJldHVybiBfc3lzdGVtLnBsdXJhbGl6ZTsKICAgIH0KICB9LCB7IGNvbmZpZ3VyYWJsZTogdHJ1ZSB9KTsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gX3N5c3RlbS5JbmZsZWN0b3I7CiAgZXhwb3J0cy5wbHVyYWxpemUgPSBfc3lzdGVtLnBsdXJhbGl6ZTsKICBleHBvcnRzLnNpbmd1bGFyaXplID0gX3N5c3RlbS5zaW5ndWxhcml6ZTsKICBleHBvcnRzLmRlZmF1bHRSdWxlcyA9IF9zeXN0ZW0uZGVmYXVsdFJ1bGVzOwp9KTsKO2RlZmluZSgnZW1iZXItaW5mbGVjdG9yL2xpYi9leHQvc3RyaW5nJywgWydlbWJlci1pbmZsZWN0b3IvbGliL3N5c3RlbS9zdHJpbmcnXSwgZnVuY3Rpb24gKF9zdHJpbmcpIHsKICAndXNlIHN0cmljdCc7CgogIGlmIChFbWJlci5FTlYuRVhURU5EX1BST1RPVFlQRVMgPT09IHRydWUgfHwgRW1iZXIuRU5WLkVYVEVORF9QUk9UT1RZUEVTLlN0cmluZykgewogICAgLyoqCiAgICAgIFNlZSB7eyNjcm9zc0xpbmsgIkVtYmVyLlN0cmluZy9wbHVyYWxpemUifX17ey9jcm9zc0xpbmt9fQogICAgICAgQG1ldGhvZCBwbHVyYWxpemUKICAgICAgQGZvciBTdHJpbmcKICAgICovCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU3RyaW5nLnByb3RvdHlwZSwgJ3BsdXJhbGl6ZScsIHsKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgRW1iZXIuZGVwcmVjYXRlKCdTdHJpbmcucHJvdG90eXBlLnBsdXJhbGl6ZSgpIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSBleHBsaWNpdGx5OiBpbXBvcnQgeyBwbHVyYWxpemUgfSBmcm9tIFwnZW1iZXItaW5mbGVjdG9yXCc7JywgZmFsc2UsIHsKICAgICAgICAgIGlkOiAnZW1iZXItaW5mbGVjdG9yLmdsb2JhbHMnLAogICAgICAgICAgdW50aWw6ICczLjAuMCcKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiAoMCwgX3N0cmluZy5wbHVyYWxpemUpKHRoaXMpOwogICAgICAgIH07CiAgICAgIH0KICAgIH0sIHsgY29uZmlndXJhYmxlOiB0cnVlIH0pOwoKICAgIC8qKgogICAgICBTZWUge3sjY3Jvc3NMaW5rICJFbWJlci5TdHJpbmcvc2luZ3VsYXJpemUifX17ey9jcm9zc0xpbmt9fQogICAgICAgQG1ldGhvZCBzaW5ndWxhcml6ZQogICAgICBAZm9yIFN0cmluZwogICAgKi8KICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTdHJpbmcucHJvdG90eXBlLCAnc2luZ3VsYXJpemUnLCB7CiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIEVtYmVyLmRlcHJlY2F0ZSgnU3RyaW5nLnByb3RvdHlwZS5zaW5ndWxhcml6ZSgpIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSBleHBsaWNpdGx5OiBpbXBvcnQgeyBzaW5ndWxhcml6ZSB9IGZyb20gXCdlbWJlci1pbmZsZWN0b3JcJzsnLCBmYWxzZSwgewogICAgICAgICAgaWQ6ICdlbWJlci1pbmZsZWN0b3IuZ2xvYmFscycsCiAgICAgICAgICB1bnRpbDogJzMuMC4wJwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuICgwLCBfc3RyaW5nLnNpbmd1bGFyaXplKSh0aGlzKTsKICAgICAgICB9OwogICAgICB9CiAgICB9LCB7IGNvbmZpZ3VyYWJsZTogdHJ1ZSB9KTsKICB9Cn0pOwo7ZGVmaW5lKCdlbWJlci1pbmZsZWN0b3IvbGliL2hlbHBlcnMvcGx1cmFsaXplJywgWydleHBvcnRzJywgJ2VtYmVyLWluZmxlY3RvcicsICdlbWJlci1pbmZsZWN0b3IvbGliL3V0aWxzL21ha2UtaGVscGVyJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJJbmZsZWN0b3IsIF9tYWtlSGVscGVyKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwoKICBmdW5jdGlvbiBfdG9Db25zdW1hYmxlQXJyYXkoYXJyKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBhcnIyID0gQXJyYXkoYXJyLmxlbmd0aCk7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICBhcnIyW2ldID0gYXJyW2ldOwogICAgICB9CgogICAgICByZXR1cm4gYXJyMjsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBBcnJheS5mcm9tKGFycik7CiAgICB9CiAgfQoKICBleHBvcnRzLmRlZmF1bHQgPSAoMCwgX21ha2VIZWxwZXIuZGVmYXVsdCkoZnVuY3Rpb24gKHBhcmFtcywgaGFzaCkgewogICAgdmFyIGZ1bGxQYXJhbXMgPSBuZXcgKEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kLmFwcGx5KEFycmF5LCBbbnVsbF0uY29uY2F0KF90b0NvbnN1bWFibGVBcnJheShwYXJhbXMpKSkpKCk7CgogICAgaWYgKGZ1bGxQYXJhbXMubGVuZ3RoID09PSAyKSB7CiAgICAgIGZ1bGxQYXJhbXMucHVzaCh7IHdpdGhvdXRDb3VudDogaGFzaFsid2l0aG91dC1jb3VudCJdIH0pOwogICAgfQoKICAgIHJldHVybiBfZW1iZXJJbmZsZWN0b3IucGx1cmFsaXplLmFwcGx5KHVuZGVmaW5lZCwgX3RvQ29uc3VtYWJsZUFycmF5KGZ1bGxQYXJhbXMpKTsKICB9KTsKfSk7CjtkZWZpbmUoJ2VtYmVyLWluZmxlY3Rvci9saWIvaGVscGVycy9zaW5ndWxhcml6ZScsIFsnZXhwb3J0cycsICdlbWJlci1pbmZsZWN0b3InLCAnZW1iZXItaW5mbGVjdG9yL2xpYi91dGlscy9tYWtlLWhlbHBlciddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVySW5mbGVjdG9yLCBfbWFrZUhlbHBlcikgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSAoMCwgX21ha2VIZWxwZXIuZGVmYXVsdCkoZnVuY3Rpb24gKHBhcmFtcykgewogICAgcmV0dXJuICgwLCBfZW1iZXJJbmZsZWN0b3Iuc2luZ3VsYXJpemUpKHBhcmFtc1swXSk7CiAgfSk7Cn0pOwo7ZGVmaW5lKCJlbWJlci1pbmZsZWN0b3IvbGliL3N5c3RlbSIsIFsiZXhwb3J0cyIsICJlbWJlci1pbmZsZWN0b3IvbGliL3N5c3RlbS9pbmZsZWN0b3IiLCAiZW1iZXItaW5mbGVjdG9yL2xpYi9zeXN0ZW0vc3RyaW5nIiwgImVtYmVyLWluZmxlY3Rvci9saWIvc3lzdGVtL2luZmxlY3Rpb25zIl0sIGZ1bmN0aW9uIChleHBvcnRzLCBfaW5mbGVjdG9yLCBfc3RyaW5nLCBfaW5mbGVjdGlvbnMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5kZWZhdWx0UnVsZXMgPSBleHBvcnRzLnBsdXJhbGl6ZSA9IGV4cG9ydHMuc2luZ3VsYXJpemUgPSBleHBvcnRzLkluZmxlY3RvciA9IHVuZGVmaW5lZDsKCgogIF9pbmZsZWN0b3IuZGVmYXVsdC5pbmZsZWN0b3IgPSBuZXcgX2luZmxlY3Rvci5kZWZhdWx0KF9pbmZsZWN0aW9ucy5kZWZhdWx0KTsKCiAgZXhwb3J0cy5JbmZsZWN0b3IgPSBfaW5mbGVjdG9yLmRlZmF1bHQ7CiAgZXhwb3J0cy5zaW5ndWxhcml6ZSA9IF9zdHJpbmcuc2luZ3VsYXJpemU7CiAgZXhwb3J0cy5wbHVyYWxpemUgPSBfc3RyaW5nLnBsdXJhbGl6ZTsKICBleHBvcnRzLmRlZmF1bHRSdWxlcyA9IF9pbmZsZWN0aW9ucy5kZWZhdWx0Owp9KTsKO2RlZmluZSgnZW1iZXItaW5mbGVjdG9yL2xpYi9zeXN0ZW0vaW5mbGVjdGlvbnMnLCBbJ2V4cG9ydHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5kZWZhdWx0ID0gewogICAgcGx1cmFsczogW1svJC8sICdzJ10sIFsvcyQvaSwgJ3MnXSwgWy9eKGF4fHRlc3QpaXMkL2ksICckMWVzJ10sIFsvKG9jdG9wfHZpcil1cyQvaSwgJyQxaSddLCBbLyhvY3RvcHx2aXIpaSQvaSwgJyQxaSddLCBbLyhhbGlhc3xzdGF0dXN8Ym9udXMpJC9pLCAnJDFlcyddLCBbLyhidSlzJC9pLCAnJDFzZXMnXSwgWy8oYnVmZmFsfHRvbWF0KW8kL2ksICckMW9lcyddLCBbLyhbdGldKXVtJC9pLCAnJDFhJ10sIFsvKFt0aV0pYSQvaSwgJyQxYSddLCBbL3NpcyQvaSwgJ3NlcyddLCBbLyg/OihbXmZdKWZlfChbbHJdKWYpJC9pLCAnJDEkMnZlcyddLCBbLyhoaXZlKSQvaSwgJyQxcyddLCBbLyhbXmFlaW91eV18cXUpeSQvaSwgJyQxaWVzJ10sIFsvKHh8Y2h8c3N8c2gpJC9pLCAnJDFlcyddLCBbLyhtYXRyfHZlcnR8aW5kKSg/Oml4fGV4KSQvaSwgJyQxaWNlcyddLCBbL14obXxsKW91c2UkL2ksICckMWljZSddLCBbL14obXxsKWljZSQvaSwgJyQxaWNlJ10sIFsvXihveCkkL2ksICckMWVuJ10sIFsvXihveGVuKSQvaSwgJyQxJ10sIFsvKHF1aXopJC9pLCAnJDF6ZXMnXV0sCgogICAgc2luZ3VsYXI6IFtbL3MkL2ksICcnXSwgWy8oc3MpJC9pLCAnJDEnXSwgWy8obilld3MkL2ksICckMWV3cyddLCBbLyhbdGldKWEkL2ksICckMXVtJ10sIFsvKChhKW5hbHl8KGIpYXwoZClpYWdub3wocClhcmVudGhlfChwKXJvZ25vfChzKXlub3B8KHQpaGUpKHNpc3xzZXMpJC9pLCAnJDFzaXMnXSwgWy8oXmFuYWx5KShzaXN8c2VzKSQvaSwgJyQxc2lzJ10sIFsvKFteZl0pdmVzJC9pLCAnJDFmZSddLCBbLyhoaXZlKXMkL2ksICckMSddLCBbLyh0aXZlKXMkL2ksICckMSddLCBbLyhbbHJdKXZlcyQvaSwgJyQxZiddLCBbLyhbXmFlaW91eV18cXUpaWVzJC9pLCAnJDF5J10sIFsvKHMpZXJpZXMkL2ksICckMWVyaWVzJ10sIFsvKG0pb3ZpZXMkL2ksICckMW92aWUnXSwgWy8oeHxjaHxzc3xzaCllcyQvaSwgJyQxJ10sIFsvXihtfGwpaWNlJC9pLCAnJDFvdXNlJ10sIFsvKGJ1cykoZXMpPyQvaSwgJyQxJ10sIFsvKG8pZXMkL2ksICckMSddLCBbLyhzaG9lKXMkL2ksICckMSddLCBbLyhjcmlzfHRlc3QpKGlzfGVzKSQvaSwgJyQxaXMnXSwgWy9eKGEpeFtpZV1zJC9pLCAnJDF4aXMnXSwgWy8ob2N0b3B8dmlyKSh1c3xpKSQvaSwgJyQxdXMnXSwgWy8oYWxpYXN8c3RhdHVzfGJvbnVzKShlcyk/JC9pLCAnJDEnXSwgWy9eKG94KWVuL2ksICckMSddLCBbLyh2ZXJ0fGluZClpY2VzJC9pLCAnJDFleCddLCBbLyhtYXRyKWljZXMkL2ksICckMWl4J10sIFsvKHF1aXopemVzJC9pLCAnJDEnXSwgWy8oZGF0YWJhc2UpcyQvaSwgJyQxJ11dLAoKICAgIGlycmVndWxhclBhaXJzOiBbWydwZXJzb24nLCAncGVvcGxlJ10sIFsnbWFuJywgJ21lbiddLCBbJ2NoaWxkJywgJ2NoaWxkcmVuJ10sIFsnc2V4JywgJ3NleGVzJ10sIFsnbW92ZScsICdtb3ZlcyddLCBbJ2NvdycsICdraW5lJ10sIFsnem9tYmllJywgJ3pvbWJpZXMnXV0sCgogICAgdW5jb3VudGFibGU6IFsnZXF1aXBtZW50JywgJ2luZm9ybWF0aW9uJywgJ3JpY2UnLCAnbW9uZXknLCAnc3BlY2llcycsICdzZXJpZXMnLCAnZmlzaCcsICdzaGVlcCcsICdqZWFucycsICdwb2xpY2UnXQogIH07Cn0pOwo7ZGVmaW5lKCdlbWJlci1pbmZsZWN0b3IvbGliL3N5c3RlbS9pbmZsZWN0b3InLCBbJ2V4cG9ydHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CgoKICB2YXIgQkxBTktfUkVHRVggPSAvXlxzKiQvOwogIHZhciBMQVNUX1dPUkRfREFTSEVEX1JFR0VYID0gLyhbXHcvLV0rW18vXHMtXSkoW2EtelxkXSskKS87CiAgdmFyIExBU1RfV09SRF9DQU1FTElaRURfUkVHRVggPSAvKFtcdy9ccy1dKykoW0EtWl1bYS16XGRdKiQpLzsKICB2YXIgQ0FNRUxJWkVEX1JFR0VYID0gL1tBLVpdW2EtelxkXSokLzsKCiAgZnVuY3Rpb24gbG9hZFVuY291bnRhYmxlKHJ1bGVzLCB1bmNvdW50YWJsZSkgewogICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IHVuY291bnRhYmxlLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHJ1bGVzLnVuY291bnRhYmxlW3VuY291bnRhYmxlW2ldLnRvTG93ZXJDYXNlKCldID0gdHJ1ZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGxvYWRJcnJlZ3VsYXIocnVsZXMsIGlycmVndWxhclBhaXJzKSB7CiAgICB2YXIgcGFpciA9IHZvaWQgMDsKCiAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gaXJyZWd1bGFyUGFpcnMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcGFpciA9IGlycmVndWxhclBhaXJzW2ldOwoKICAgICAgLy9wbHVyYWxpemluZwogICAgICBydWxlcy5pcnJlZ3VsYXJbcGFpclswXS50b0xvd2VyQ2FzZSgpXSA9IHBhaXJbMV07CiAgICAgIHJ1bGVzLmlycmVndWxhcltwYWlyWzFdLnRvTG93ZXJDYXNlKCldID0gcGFpclsxXTsKCiAgICAgIC8vc2luZ3VsYXJpemluZwogICAgICBydWxlcy5pcnJlZ3VsYXJJbnZlcnNlW3BhaXJbMV0udG9Mb3dlckNhc2UoKV0gPSBwYWlyWzBdOwogICAgICBydWxlcy5pcnJlZ3VsYXJJbnZlcnNlW3BhaXJbMF0udG9Mb3dlckNhc2UoKV0gPSBwYWlyWzBdOwogICAgfQogIH0KCiAgLyoqCiAgICBJbmZsZWN0b3IuRW1iZXIgcHJvdmlkZXMgYSBtZWNoYW5pc20gZm9yIHN1cHBseWluZyBpbmZsZWN0aW9uIHJ1bGVzIGZvciB5b3VyCiAgICBhcHBsaWNhdGlvbi4gRW1iZXIgaW5jbHVkZXMgYSBkZWZhdWx0IHNldCBvZiBpbmZsZWN0aW9uIHJ1bGVzLCBhbmQgcHJvdmlkZXMgYW4KICAgIEFQSSBmb3IgcHJvdmlkaW5nIGFkZGl0aW9uYWwgcnVsZXMuCiAgCiAgICBFeGFtcGxlczoKICAKICAgIENyZWF0aW5nIGFuIGluZmxlY3RvciB3aXRoIG5vIHJ1bGVzLgogIAogICAgYGBganMKICAgIHZhciBpbmZsZWN0b3IgPSBuZXcgRW1iZXIuSW5mbGVjdG9yKCk7CiAgICBgYGAKICAKICAgIENyZWF0aW5nIGFuIGluZmxlY3RvciB3aXRoIHRoZSBkZWZhdWx0IGVtYmVyIHJ1bGVzZXQuCiAgCiAgICBgYGBqcwogICAgdmFyIGluZmxlY3RvciA9IG5ldyBFbWJlci5JbmZsZWN0b3IoRW1iZXIuSW5mbGVjdG9yLmRlZmF1bHRSdWxlcyk7CiAgCiAgICBpbmZsZWN0b3IucGx1cmFsaXplKCdjb3cnKTsgLy89PiAna2luZScKICAgIGluZmxlY3Rvci5zaW5ndWxhcml6ZSgna2luZScpOyAvLz0+ICdjb3cnCiAgICBgYGAKICAKICAgIENyZWF0aW5nIGFuIGluZmxlY3RvciBhbmQgYWRkaW5nIHJ1bGVzIGxhdGVyLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIGluZmxlY3RvciA9IEVtYmVyLkluZmxlY3Rvci5pbmZsZWN0b3I7CiAgCiAgICBpbmZsZWN0b3IucGx1cmFsaXplKCdhZHZpY2UnKTsgLy8gPT4gJ2FkdmljZXMnCiAgICBpbmZsZWN0b3IudW5jb3VudGFibGUoJ2FkdmljZScpOwogICAgaW5mbGVjdG9yLnBsdXJhbGl6ZSgnYWR2aWNlJyk7IC8vID0+ICdhZHZpY2UnCiAgCiAgICBpbmZsZWN0b3IucGx1cmFsaXplKCdmb3JtdWxhJyk7IC8vID0+ICdmb3JtdWxhcycKICAgIGluZmxlY3Rvci5pcnJlZ3VsYXIoJ2Zvcm11bGEnLCAnZm9ybXVsYWUnKTsKICAgIGluZmxlY3Rvci5wbHVyYWxpemUoJ2Zvcm11bGEnKTsgLy8gPT4gJ2Zvcm11bGFlJwogIAogICAgLy8geW91IHdvdWxkIG5vdCBuZWVkIHRvIGFkZCB0aGVzZSBhcyB0aGV5IGFyZSB0aGUgZGVmYXVsdCBydWxlcwogICAgaW5mbGVjdG9yLnBsdXJhbCgvJC8sICdzJyk7CiAgICBpbmZsZWN0b3Iuc2luZ3VsYXIoL3MkL2ksICcnKTsKICAgIGBgYAogIAogICAgQ3JlYXRpbmcgYW4gaW5mbGVjdG9yIHdpdGggYSBub25kZWZhdWx0IHJ1bGVzZXQuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgcnVsZXMgPSB7CiAgICAgIHBsdXJhbHM6ICBbCiAgICAgICAgWyAvJC8sICdzJyBdCiAgICAgIF0sCiAgICAgIHNpbmd1bGFyOiBbCiAgICAgICAgWyAvXHMkLywgJycgXQogICAgICBdLAogICAgICBpcnJlZ3VsYXJQYWlyczogWwogICAgICAgIFsgJ2NvdycsICdraW5lJyBdCiAgICAgIF0sCiAgICAgIHVuY291bnRhYmxlOiBbICdmaXNoJyBdCiAgICB9OwogIAogICAgdmFyIGluZmxlY3RvciA9IG5ldyBFbWJlci5JbmZsZWN0b3IocnVsZXMpOwogICAgYGBgCiAgCiAgICBAY2xhc3MgSW5mbGVjdG9yCiAgICBAbmFtZXNwYWNlIEVtYmVyCiAgKi8KICBmdW5jdGlvbiBJbmZsZWN0b3IocnVsZVNldCkgewogICAgcnVsZVNldCA9IHJ1bGVTZXQgfHwge307CiAgICBydWxlU2V0LnVuY291bnRhYmxlID0gcnVsZVNldC51bmNvdW50YWJsZSB8fCBtYWtlRGljdGlvbmFyeSgpOwogICAgcnVsZVNldC5pcnJlZ3VsYXJQYWlycyA9IHJ1bGVTZXQuaXJyZWd1bGFyUGFpcnMgfHwgbWFrZURpY3Rpb25hcnkoKTsKCiAgICB2YXIgcnVsZXMgPSB0aGlzLnJ1bGVzID0gewogICAgICBwbHVyYWxzOiBydWxlU2V0LnBsdXJhbHMgfHwgW10sCiAgICAgIHNpbmd1bGFyOiBydWxlU2V0LnNpbmd1bGFyIHx8IFtdLAogICAgICBpcnJlZ3VsYXI6IG1ha2VEaWN0aW9uYXJ5KCksCiAgICAgIGlycmVndWxhckludmVyc2U6IG1ha2VEaWN0aW9uYXJ5KCksCiAgICAgIHVuY291bnRhYmxlOiBtYWtlRGljdGlvbmFyeSgpCiAgICB9OwoKICAgIGxvYWRVbmNvdW50YWJsZShydWxlcywgcnVsZVNldC51bmNvdW50YWJsZSk7CiAgICBsb2FkSXJyZWd1bGFyKHJ1bGVzLCBydWxlU2V0LmlycmVndWxhclBhaXJzKTsKCiAgICB0aGlzLmVuYWJsZUNhY2hlKCk7CiAgfQoKICBpZiAoIU9iamVjdC5jcmVhdGUgJiYgIU9iamVjdC5jcmVhdGUobnVsbCkuaGFzT3duUHJvcGVydHkpIHsKICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgT2JqZWN0LmNyZWF0ZShudWxsKSwgcGxlYXNlIHBvbHlmaWwgd2l0aCBlczUtc2hhbTogaHR0cDovL2dpdC5pby95QlUycmciKTsKICB9CgogIGZ1bmN0aW9uIG1ha2VEaWN0aW9uYXJ5KCkgewogICAgdmFyIGNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIGNhY2hlWydfZGljdCddID0gbnVsbDsKICAgIGRlbGV0ZSBjYWNoZVsnX2RpY3QnXTsKICAgIHJldHVybiBjYWNoZTsKICB9CgogIEluZmxlY3Rvci5wcm90b3R5cGUgPSB7CiAgICBlbmFibGVDYWNoZTogZnVuY3Rpb24gZW5hYmxlQ2FjaGUoKSB7CiAgICAgIHRoaXMucHVyZ2VDYWNoZSgpOwoKICAgICAgdGhpcy5zaW5ndWxhcml6ZSA9IGZ1bmN0aW9uICh3b3JkKSB7CiAgICAgICAgdGhpcy5fY2FjaGVVc2VkID0gdHJ1ZTsKICAgICAgICByZXR1cm4gdGhpcy5fc0NhY2hlW3dvcmRdIHx8ICh0aGlzLl9zQ2FjaGVbd29yZF0gPSB0aGlzLl9zaW5ndWxhcml6ZSh3b3JkKSk7CiAgICAgIH07CgogICAgICB0aGlzLnBsdXJhbGl6ZSA9IGZ1bmN0aW9uIChudW1iZXJPcldvcmQsIHdvcmQpIHsKICAgICAgICB2YXIgb3B0aW9ucyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDoge307CgogICAgICAgIHRoaXMuX2NhY2hlVXNlZCA9IHRydWU7CiAgICAgICAgdmFyIGNhY2hlS2V5ID0gW251bWJlck9yV29yZCwgd29yZCwgb3B0aW9ucy53aXRob3V0Q291bnRdOwogICAgICAgIHJldHVybiB0aGlzLl9wQ2FjaGVbY2FjaGVLZXldIHx8ICh0aGlzLl9wQ2FjaGVbY2FjaGVLZXldID0gdGhpcy5fcGx1cmFsaXplKG51bWJlck9yV29yZCwgd29yZCwgb3B0aW9ucykpOwogICAgICB9OwogICAgfSwKICAgIHB1cmdlQ2FjaGU6IGZ1bmN0aW9uIHB1cmdlQ2FjaGUoKSB7CiAgICAgIHRoaXMuX2NhY2hlVXNlZCA9IGZhbHNlOwogICAgICB0aGlzLl9zQ2FjaGUgPSBtYWtlRGljdGlvbmFyeSgpOwogICAgICB0aGlzLl9wQ2FjaGUgPSBtYWtlRGljdGlvbmFyeSgpOwogICAgfSwKICAgIGRpc2FibGVDYWNoZTogZnVuY3Rpb24gZGlzYWJsZUNhY2hlKCkgewogICAgICB0aGlzLl9zQ2FjaGUgPSBudWxsOwogICAgICB0aGlzLl9wQ2FjaGUgPSBudWxsOwogICAgICB0aGlzLnNpbmd1bGFyaXplID0gZnVuY3Rpb24gKHdvcmQpIHsKICAgICAgICByZXR1cm4gdGhpcy5fc2luZ3VsYXJpemUod29yZCk7CiAgICAgIH07CgogICAgICB0aGlzLnBsdXJhbGl6ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcGx1cmFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9LAogICAgcGx1cmFsOiBmdW5jdGlvbiBwbHVyYWwocmVnZXgsIHN0cmluZykgewogICAgICBpZiAodGhpcy5fY2FjaGVVc2VkKSB7CiAgICAgICAgdGhpcy5wdXJnZUNhY2hlKCk7CiAgICAgIH0KICAgICAgdGhpcy5ydWxlcy5wbHVyYWxzLnB1c2goW3JlZ2V4LCBzdHJpbmcudG9Mb3dlckNhc2UoKV0pOwogICAgfSwKICAgIHNpbmd1bGFyOiBmdW5jdGlvbiBzaW5ndWxhcihyZWdleCwgc3RyaW5nKSB7CiAgICAgIGlmICh0aGlzLl9jYWNoZVVzZWQpIHsKICAgICAgICB0aGlzLnB1cmdlQ2FjaGUoKTsKICAgICAgfQogICAgICB0aGlzLnJ1bGVzLnNpbmd1bGFyLnB1c2goW3JlZ2V4LCBzdHJpbmcudG9Mb3dlckNhc2UoKV0pOwogICAgfSwKICAgIHVuY291bnRhYmxlOiBmdW5jdGlvbiB1bmNvdW50YWJsZShzdHJpbmcpIHsKICAgICAgaWYgKHRoaXMuX2NhY2hlVXNlZCkgewogICAgICAgIHRoaXMucHVyZ2VDYWNoZSgpOwogICAgICB9CiAgICAgIGxvYWRVbmNvdW50YWJsZSh0aGlzLnJ1bGVzLCBbc3RyaW5nLnRvTG93ZXJDYXNlKCldKTsKICAgIH0sCiAgICBpcnJlZ3VsYXI6IGZ1bmN0aW9uIGlycmVndWxhcihzaW5ndWxhciwgcGx1cmFsKSB7CiAgICAgIGlmICh0aGlzLl9jYWNoZVVzZWQpIHsKICAgICAgICB0aGlzLnB1cmdlQ2FjaGUoKTsKICAgICAgfQogICAgICBsb2FkSXJyZWd1bGFyKHRoaXMucnVsZXMsIFtbc2luZ3VsYXIsIHBsdXJhbF1dKTsKICAgIH0sCiAgICBwbHVyYWxpemU6IGZ1bmN0aW9uIHBsdXJhbGl6ZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3BsdXJhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIF9wbHVyYWxpemU6IGZ1bmN0aW9uIF9wbHVyYWxpemUod29yZE9yQ291bnQsIHdvcmQpIHsKICAgICAgdmFyIG9wdGlvbnMgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1syXSA6IHt9OwoKICAgICAgaWYgKHdvcmQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiB0aGlzLmluZmxlY3Qod29yZE9yQ291bnQsIHRoaXMucnVsZXMucGx1cmFscywgdGhpcy5ydWxlcy5pcnJlZ3VsYXIpOwogICAgICB9CgogICAgICBpZiAocGFyc2VGbG9hdCh3b3JkT3JDb3VudCkgIT09IDEpIHsKICAgICAgICB3b3JkID0gdGhpcy5pbmZsZWN0KHdvcmQsIHRoaXMucnVsZXMucGx1cmFscywgdGhpcy5ydWxlcy5pcnJlZ3VsYXIpOwogICAgICB9CgogICAgICByZXR1cm4gb3B0aW9ucy53aXRob3V0Q291bnQgPyB3b3JkIDogd29yZE9yQ291bnQgKyAnICcgKyB3b3JkOwogICAgfSwKICAgIHNpbmd1bGFyaXplOiBmdW5jdGlvbiBzaW5ndWxhcml6ZSh3b3JkKSB7CiAgICAgIHJldHVybiB0aGlzLl9zaW5ndWxhcml6ZSh3b3JkKTsKICAgIH0sCiAgICBfc2luZ3VsYXJpemU6IGZ1bmN0aW9uIF9zaW5ndWxhcml6ZSh3b3JkKSB7CiAgICAgIHJldHVybiB0aGlzLmluZmxlY3Qod29yZCwgdGhpcy5ydWxlcy5zaW5ndWxhciwgdGhpcy5ydWxlcy5pcnJlZ3VsYXJJbnZlcnNlKTsKICAgIH0sCiAgICBpbmZsZWN0OiBmdW5jdGlvbiBpbmZsZWN0KHdvcmQsIHR5cGVSdWxlcywgaXJyZWd1bGFyKSB7CiAgICAgIHZhciBpbmZsZWN0aW9uID0gdm9pZCAwLAogICAgICAgICAgc3Vic3RpdHV0aW9uID0gdm9pZCAwLAogICAgICAgICAgcmVzdWx0ID0gdm9pZCAwLAogICAgICAgICAgbG93ZXJjYXNlID0gdm9pZCAwLAogICAgICAgICAgd29yZFNwbGl0ID0gdm9pZCAwLAogICAgICAgICAgbGFzdFdvcmQgPSB2b2lkIDAsCiAgICAgICAgICBpc0JsYW5rID0gdm9pZCAwLAogICAgICAgICAgaXNDYW1lbGl6ZWQgPSB2b2lkIDAsCiAgICAgICAgICBydWxlID0gdm9pZCAwLAogICAgICAgICAgaXNVbmNvdW50YWJsZSA9IHZvaWQgMDsKCiAgICAgIGlzQmxhbmsgPSAhd29yZCB8fCBCTEFOS19SRUdFWC50ZXN0KHdvcmQpOwogICAgICBpc0NhbWVsaXplZCA9IENBTUVMSVpFRF9SRUdFWC50ZXN0KHdvcmQpOwoKICAgICAgaWYgKGlzQmxhbmspIHsKICAgICAgICByZXR1cm4gd29yZDsKICAgICAgfQoKICAgICAgbG93ZXJjYXNlID0gd29yZC50b0xvd2VyQ2FzZSgpOwogICAgICB3b3JkU3BsaXQgPSBMQVNUX1dPUkRfREFTSEVEX1JFR0VYLmV4ZWMod29yZCkgfHwgTEFTVF9XT1JEX0NBTUVMSVpFRF9SRUdFWC5leGVjKHdvcmQpOwoKICAgICAgaWYgKHdvcmRTcGxpdCkgewogICAgICAgIGxhc3RXb3JkID0gd29yZFNwbGl0WzJdLnRvTG93ZXJDYXNlKCk7CiAgICAgIH0KCiAgICAgIGlzVW5jb3VudGFibGUgPSB0aGlzLnJ1bGVzLnVuY291bnRhYmxlW2xvd2VyY2FzZV0gfHwgdGhpcy5ydWxlcy51bmNvdW50YWJsZVtsYXN0V29yZF07CgogICAgICBpZiAoaXNVbmNvdW50YWJsZSkgewogICAgICAgIHJldHVybiB3b3JkOwogICAgICB9CgogICAgICBmb3IgKHJ1bGUgaW4gaXJyZWd1bGFyKSB7CiAgICAgICAgaWYgKGxvd2VyY2FzZS5tYXRjaChydWxlICsgIiQiKSkgewogICAgICAgICAgc3Vic3RpdHV0aW9uID0gaXJyZWd1bGFyW3J1bGVdOwoKICAgICAgICAgIGlmIChpc0NhbWVsaXplZCAmJiBpcnJlZ3VsYXJbbGFzdFdvcmRdKSB7CiAgICAgICAgICAgIHN1YnN0aXR1dGlvbiA9IEVtYmVyLlN0cmluZy5jYXBpdGFsaXplKHN1YnN0aXR1dGlvbik7CiAgICAgICAgICAgIHJ1bGUgPSBFbWJlci5TdHJpbmcuY2FwaXRhbGl6ZShydWxlKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gd29yZC5yZXBsYWNlKG5ldyBSZWdFeHAocnVsZSwgJ2knKSwgc3Vic3RpdHV0aW9uKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSB0eXBlUnVsZXMubGVuZ3RoLCBtaW4gPSAwOyBpID4gbWluOyBpLS0pIHsKICAgICAgICBpbmZsZWN0aW9uID0gdHlwZVJ1bGVzW2kgLSAxXTsKICAgICAgICBydWxlID0gaW5mbGVjdGlvblswXTsKCiAgICAgICAgaWYgKHJ1bGUudGVzdCh3b3JkKSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICBpbmZsZWN0aW9uID0gaW5mbGVjdGlvbiB8fCBbXTsKCiAgICAgIHJ1bGUgPSBpbmZsZWN0aW9uWzBdOwogICAgICBzdWJzdGl0dXRpb24gPSBpbmZsZWN0aW9uWzFdOwoKICAgICAgcmVzdWx0ID0gd29yZC5yZXBsYWNlKHJ1bGUsIHN1YnN0aXR1dGlvbik7CgogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIH07CgogIGV4cG9ydHMuZGVmYXVsdCA9IEluZmxlY3RvcjsKfSk7CjtkZWZpbmUoJ2VtYmVyLWluZmxlY3Rvci9saWIvc3lzdGVtL3N0cmluZycsIFsnZXhwb3J0cycsICdlbWJlci1pbmZsZWN0b3IvbGliL3N5c3RlbS9pbmZsZWN0b3InXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9pbmZsZWN0b3IpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5zaW5ndWxhcml6ZSA9IGV4cG9ydHMucGx1cmFsaXplID0gdW5kZWZpbmVkOwoKCiAgZnVuY3Rpb24gcGx1cmFsaXplKCkgewogICAgdmFyIF9JbmZsZWN0b3IkaW5mbGVjdG9yOwoKICAgIHJldHVybiAoX0luZmxlY3RvciRpbmZsZWN0b3IgPSBfaW5mbGVjdG9yLmRlZmF1bHQuaW5mbGVjdG9yKS5wbHVyYWxpemUuYXBwbHkoX0luZmxlY3RvciRpbmZsZWN0b3IsIGFyZ3VtZW50cyk7CiAgfQoKICBmdW5jdGlvbiBzaW5ndWxhcml6ZSh3b3JkKSB7CiAgICByZXR1cm4gX2luZmxlY3Rvci5kZWZhdWx0LmluZmxlY3Rvci5zaW5ndWxhcml6ZSh3b3JkKTsKICB9CgogIGV4cG9ydHMucGx1cmFsaXplID0gcGx1cmFsaXplOwogIGV4cG9ydHMuc2luZ3VsYXJpemUgPSBzaW5ndWxhcml6ZTsKfSk7CjtkZWZpbmUoJ2VtYmVyLWluZmxlY3Rvci9saWIvdXRpbHMvbWFrZS1oZWxwZXInLCBbJ2V4cG9ydHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5kZWZhdWx0ID0gbWFrZUhlbHBlcjsKICBmdW5jdGlvbiBtYWtlSGVscGVyKGhlbHBlckZ1bmN0aW9uKSB7CiAgICBpZiAoRW1iZXIuSGVscGVyKSB7CiAgICAgIHJldHVybiBFbWJlci5IZWxwZXIuaGVscGVyKGhlbHBlckZ1bmN0aW9uKTsKICAgIH0KICAgIGlmIChFbWJlci5IVE1MQmFycykgewogICAgICByZXR1cm4gRW1iZXIuSFRNTEJhcnMubWFrZUJvdW5kSGVscGVyKGhlbHBlckZ1bmN0aW9uKTsKICAgIH0KICAgIHJldHVybiBFbWJlci5IYW5kbGViYXJzLm1ha2VCb3VuZEhlbHBlcihoZWxwZXJGdW5jdGlvbik7CiAgfQp9KTsKO2RlZmluZSgiZW1iZXItbG9hZC1pbml0aWFsaXplcnMvaW5kZXgiLCBbImV4cG9ydHMiLCAicmVxdWlyZSJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF9yZXF1aXJlKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gbG9hZEluaXRpYWxpemVyczsKCiAgZnVuY3Rpb24gcmVzb2x2ZUluaXRpYWxpemVyKG1vZHVsZU5hbWUpIHsKICAgIHZhciBtb2R1bGUgPSAoMCwgX3JlcXVpcmUuZGVmYXVsdCkobW9kdWxlTmFtZSwgbnVsbCwgbnVsbCwgdHJ1ZSk7CgogICAgaWYgKCFtb2R1bGUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKG1vZHVsZU5hbWUgKyAnIG11c3QgZXhwb3J0IGFuIGluaXRpYWxpemVyLicpOwogICAgfQoKICAgIHZhciBpbml0aWFsaXplciA9IG1vZHVsZVsnZGVmYXVsdCddOwoKICAgIGlmICghaW5pdGlhbGl6ZXIubmFtZSkgewogICAgICBpbml0aWFsaXplci5uYW1lID0gbW9kdWxlTmFtZS5zbGljZShtb2R1bGVOYW1lLmxhc3RJbmRleE9mKCcvJykgKyAxKTsKICAgIH0KCiAgICByZXR1cm4gaW5pdGlhbGl6ZXI7CiAgfQoKICBmdW5jdGlvbiByZWdpc3RlckluaXRpYWxpemVycyhhcHAsIG1vZHVsZU5hbWVzKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1vZHVsZU5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGFwcC5pbml0aWFsaXplcihyZXNvbHZlSW5pdGlhbGl6ZXIobW9kdWxlTmFtZXNbaV0pKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlZ2lzdGVySW5zdGFuY2VJbml0aWFsaXplcnMoYXBwLCBtb2R1bGVOYW1lcykgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtb2R1bGVOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICBhcHAuaW5zdGFuY2VJbml0aWFsaXplcihyZXNvbHZlSW5pdGlhbGl6ZXIobW9kdWxlTmFtZXNbaV0pKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIF9lbmRzV2l0aChzdHIsIHN1ZmZpeCkgewogICAgcmV0dXJuIHN0ci5pbmRleE9mKHN1ZmZpeCwgc3RyLmxlbmd0aCAtIHN1ZmZpeC5sZW5ndGgpICE9PSAtMTsKICB9CiAgLyoqCiAgICogQ29uZmlndXJlIHlvdXIgYXBwbGljYXRpb24gYXMgaXQgYm9vdHMKICAgKi8KCgogIGZ1bmN0aW9uIGxvYWRJbml0aWFsaXplcnMoYXBwLCBwcmVmaXgpIHsKICAgIHZhciBpbml0aWFsaXplclByZWZpeCA9IHByZWZpeCArICcvaW5pdGlhbGl6ZXJzLyc7CiAgICB2YXIgaW5zdGFuY2VJbml0aWFsaXplclByZWZpeCA9IHByZWZpeCArICcvaW5zdGFuY2UtaW5pdGlhbGl6ZXJzLyc7CiAgICB2YXIgaW5pdGlhbGl6ZXJzID0gW107CiAgICB2YXIgaW5zdGFuY2VJbml0aWFsaXplcnMgPSBbXTsgLy8gdGhpcyBpcyAyIHBhc3MgYmVjYXVzZSBnZW5lcmFsbHkgdGhlIGZpcnN0IHBhc3MgaXMgdGhlIHByb2JsZW0KICAgIC8vIGFuZCBpcyByZWR1Y2VkLCBhbmQgcmVzb2x2ZUluaXRpYWxpemVyIGhhcyBwb3RlbnRpYWwgdG8gZGVvcHQKCiAgICB2YXIgbW9kdWxlTmFtZXMgPSBPYmplY3Qua2V5cyhyZXF1aXJlanMuX2Vha19zZWVuKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1vZHVsZU5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBtb2R1bGVOYW1lID0gbW9kdWxlTmFtZXNbaV07CgogICAgICBpZiAobW9kdWxlTmFtZS5sYXN0SW5kZXhPZihpbml0aWFsaXplclByZWZpeCwgMCkgPT09IDApIHsKICAgICAgICBpZiAoIV9lbmRzV2l0aChtb2R1bGVOYW1lLCAnLXRlc3QnKSkgewogICAgICAgICAgaW5pdGlhbGl6ZXJzLnB1c2gobW9kdWxlTmFtZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKG1vZHVsZU5hbWUubGFzdEluZGV4T2YoaW5zdGFuY2VJbml0aWFsaXplclByZWZpeCwgMCkgPT09IDApIHsKICAgICAgICBpZiAoIV9lbmRzV2l0aChtb2R1bGVOYW1lLCAnLXRlc3QnKSkgewogICAgICAgICAgaW5zdGFuY2VJbml0aWFsaXplcnMucHVzaChtb2R1bGVOYW1lKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZWdpc3RlckluaXRpYWxpemVycyhhcHAsIGluaXRpYWxpemVycyk7CiAgICByZWdpc3Rlckluc3RhbmNlSW5pdGlhbGl6ZXJzKGFwcCwgaW5zdGFuY2VJbml0aWFsaXplcnMpOwogIH0KfSk7CjsvKgogKiBUaGlzIGlzIGEgc3R1YiBmaWxlLCBpdCBtdXN0IGJlIG9uIGRpc2sgYi9jIGJhYmVsLXBsdWdpbi1kZWJ1Zy1tYWNyb3MKICogZG9lcyBub3Qgc3RyaXAgdGhlIG1vZHVsZSByZXF1aXJlIHdoZW4gdGhlIHRyYW5zcGlsZWQgdmFyaWFibGUgdXNhZ2UgaXMKICogc3RyaXBwZWQuCiAqLwpkZWZpbmUoImVtYmVyLXJlc29sdmVyL2ZlYXR1cmVzIiwgW10sIGZ1bmN0aW9uICgpIHsKICAidXNlIHN0cmljdCI7Cn0pOwo7ZGVmaW5lKCdlbWJlci1yZXNvbHZlci9pbmRleCcsIFsnZXhwb3J0cycsICdlbWJlci1yZXNvbHZlci9yZXNvbHZlcnMvY2xhc3NpYyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2NsYXNzaWMpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdkZWZhdWx0JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2NsYXNzaWMuZGVmYXVsdDsKICAgIH0KICB9KTsKfSk7CjtkZWZpbmUoJ2VtYmVyLXJlc29sdmVyL3Jlc29sdmVyJywgWydleHBvcnRzJywgJ2VtYmVyLXJlc29sdmVyL3Jlc29sdmVycy9jbGFzc2ljJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfY2xhc3NpYykgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2RlZmF1bHQnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfY2xhc3NpYy5kZWZhdWx0OwogICAgfQogIH0pOwp9KTsKO2RlZmluZSgnZW1iZXItcmVzb2x2ZXIvcmVzb2x2ZXJzL2NsYXNzaWMvY29udGFpbmVyLWRlYnVnLWFkYXB0ZXInLCBbJ2V4cG9ydHMnLCAnZW1iZXItcmVzb2x2ZXIvcmVzb2x2ZXJzL2NsYXNzaWMvaW5kZXgnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9pbmRleCkgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKCgogIGZ1bmN0aW9uIGdldFBvZCh0eXBlLCBrZXksIHByZWZpeCkgewogICAgdmFyIG1hdGNoID0ga2V5Lm1hdGNoKG5ldyBSZWdFeHAoJ14vPycgKyBwcmVmaXggKyAnLyguKykvJyArIHR5cGUgKyAnJCcpKTsKICAgIGlmIChtYXRjaCAhPT0gbnVsbCkgewogICAgICByZXR1cm4gbWF0Y2hbMV07CiAgICB9CiAgfQoKICAvKgogICAqIFRoaXMgbW9kdWxlIGRlZmluZXMgYSBzdWJjbGFzcyBvZiBFbWJlci5Db250YWluZXJEZWJ1Z0FkYXB0ZXIgdGhhdCBhZGRzCiAgICogc3VwcG9ydCBmb3IgcmVzb2x2aW5nIGZyb20gbW9kdWxlcy4KICAgKgogICAqLwogIGV4cG9ydHMuZGVmYXVsdCA9IEVtYmVyLkNvbnRhaW5lckRlYnVnQWRhcHRlci5leHRlbmQoewogICAgX21vZHVsZVJlZ2lzdHJ5OiBudWxsLAoKICAgIGluaXQ6IGZ1bmN0aW9uIGluaXQoKSB7CiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICBpZiAoIXRoaXMuX21vZHVsZVJlZ2lzdHJ5KSB7CiAgICAgICAgdGhpcy5fbW9kdWxlUmVnaXN0cnkgPSBuZXcgX2luZGV4Lk1vZHVsZVJlZ2lzdHJ5KCk7CiAgICAgIH0KICAgIH0sCgoKICAgIC8qKgogICAgICAgIFRoZSBjb250YWluZXIgb2YgdGhlIGFwcGxpY2F0aW9uIGJlaW5nIGRlYnVnZ2VkLgogICAgICAgIFRoaXMgcHJvcGVydHkgd2lsbCBiZSBpbmplY3RlZAogICAgICAgIG9uIGNyZWF0aW9uLgogICAgICAgICBAcHJvcGVydHkgY29udGFpbmVyCiAgICAgICAgQGRlZmF1bHQgbnVsbAogICAgICAgICovCgogICAgLyoqCiAgICAgICAgVGhlIHJlc29sdmVyIGluc3RhbmNlIG9mIHRoZSBhcHBsaWNhdGlvbgogICAgICAgIGJlaW5nIGRlYnVnZ2VkLiBUaGlzIHByb3BlcnR5IHdpbGwgYmUgaW5qZWN0ZWQKICAgICAgICBvbiBjcmVhdGlvbi4KICAgICAgICAgQHByb3BlcnR5IHJlc29sdmVyCiAgICAgICAgQGRlZmF1bHQgbnVsbAogICAgICAgICovCgogICAgLyoqCiAgICAgICAgUmV0dXJucyB0cnVlIGlmIGl0IGlzIHBvc3NpYmxlIHRvIGNhdGFsb2cgYSBsaXN0IG9mIGF2YWlsYWJsZQogICAgICAgIGNsYXNzZXMgaW4gdGhlIHJlc29sdmVyIGZvciBhIGdpdmVuIHR5cGUuCiAgICAgICAgIEBtZXRob2QgY2FuQ2F0YWxvZ0VudHJpZXNCeVR5cGUKICAgICAgICBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUgdHlwZS4gZS5nLiAibW9kZWwiLCAiY29udHJvbGxlciIsICJyb3V0ZSIKICAgICAgICBAcmV0dXJuIHtib29sZWFufSB3aGV0aGVyIGEgbGlzdCBpcyBhdmFpbGFibGUgZm9yIHRoaXMgdHlwZS4KICAgICAgICAqLwogICAgY2FuQ2F0YWxvZ0VudHJpZXNCeVR5cGU6IGZ1bmN0aW9uIGNhbkNhdGFsb2dFbnRyaWVzQnlUeXBlKHR5cGUpIHsKICAgICAgaWYgKHR5cGUgPT09ICdtb2RlbCcpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgoKICAgIC8qKgogICAgICAgIFJldHVybnMgdGhlIGF2YWlsYWJsZSBjbGFzc2VzIGEgZ2l2ZW4gdHlwZS4KICAgICAgICAgQG1ldGhvZCBjYXRhbG9nRW50cmllc0J5VHlwZQogICAgICAgIEBwYXJhbSB7c3RyaW5nfSB0eXBlIFRoZSB0eXBlLiBlLmcuICJtb2RlbCIsICJjb250cm9sbGVyIiwgInJvdXRlIgogICAgICAgIEByZXR1cm4ge0FycmF5fSBBbiBhcnJheSBvZiBjbGFzc2VzLgogICAgICAgICovCiAgICBjYXRhbG9nRW50cmllc0J5VHlwZTogZnVuY3Rpb24gY2F0YWxvZ0VudHJpZXNCeVR5cGUodHlwZSkgewogICAgICB2YXIgbW9kdWxlTmFtZXMgPSB0aGlzLl9tb2R1bGVSZWdpc3RyeS5tb2R1bGVOYW1lcygpOwogICAgICB2YXIgdHlwZXMgPSBFbWJlci5BKCk7CgogICAgICB2YXIgcHJlZml4ID0gdGhpcy5uYW1lc3BhY2UubW9kdWxlUHJlZml4OwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBtb2R1bGVOYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB2YXIga2V5ID0gbW9kdWxlTmFtZXNbaV07CgogICAgICAgIGlmIChrZXkuaW5kZXhPZih0eXBlKSAhPT0gLTEpIHsKICAgICAgICAgIC8vIENoZWNrIGlmIGl0J3MgYSBwb2QgbW9kdWxlCiAgICAgICAgICB2YXIgbmFtZSA9IGdldFBvZCh0eXBlLCBrZXksIHRoaXMubmFtZXNwYWNlLnBvZE1vZHVsZVByZWZpeCB8fCBwcmVmaXgpOwogICAgICAgICAgaWYgKCFuYW1lKSB7CiAgICAgICAgICAgIC8vIE5vdCBwb2QKICAgICAgICAgICAgbmFtZSA9IGtleS5zcGxpdCh0eXBlICsgJ3MvJykucG9wKCk7CgogICAgICAgICAgICAvLyBTdXBwb3J0IGZvciBkaWZmZXJlbnQgcHJlZml4IChzdWNoIGFzIGVtYmVyLWNsaSBhZGRvbnMpLgogICAgICAgICAgICAvLyBVbmNvbW1lbnQgdGhlIGNvZGUgYmVsb3cgd2hlbgogICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vZW1iZXItY2xpL2VtYmVyLXJlc29sdmVyL3B1bGwvODAgaXMgbWVyZ2VkLgoKICAgICAgICAgICAgLy9sZXQgbWF0Y2ggPSBrZXkubWF0Y2goJ14vPyguKykvJyArIHR5cGUpOwogICAgICAgICAgICAvL2lmIChtYXRjaCAmJiBtYXRjaFsxXSAhPT0gcHJlZml4KSB7CiAgICAgICAgICAgIC8vIERpZmZlcmVudCBwcmVmaXggc3VjaCBhcyBhbiBhZGRvbgogICAgICAgICAgICAvL25hbWUgPSBtYXRjaFsxXSArICdAJyArIG5hbWU7CiAgICAgICAgICAgIC8vfQogICAgICAgICAgfQogICAgICAgICAgdHlwZXMuYWRkT2JqZWN0KG5hbWUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHlwZXM7CiAgICB9CiAgfSk7Cn0pOwo7ZGVmaW5lKCdlbWJlci1yZXNvbHZlci9yZXNvbHZlcnMvY2xhc3NpYy9pbmRleCcsIFsnZXhwb3J0cycsICdlbWJlci1yZXNvbHZlci91dGlscy9jbGFzcy1mYWN0b3J5JywgJ2VtYmVyLXJlc29sdmVyL3V0aWxzL21ha2UtZGljdGlvbmFyeSddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2NsYXNzRmFjdG9yeSwgX21ha2VEaWN0aW9uYXJ5KSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuTW9kdWxlUmVnaXN0cnkgPSB1bmRlZmluZWQ7CgogIGZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsKICAgIGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOwogICAgfQogIH0KCiAgaWYgKHR5cGVvZiByZXF1aXJlanMuZW50cmllcyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgIHJlcXVpcmVqcy5lbnRyaWVzID0gcmVxdWlyZWpzLl9lYWtfc2VlbjsKICB9CgogIHZhciBNb2R1bGVSZWdpc3RyeSA9IGV4cG9ydHMuTW9kdWxlUmVnaXN0cnkgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBNb2R1bGVSZWdpc3RyeShlbnRyaWVzKSB7CiAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBNb2R1bGVSZWdpc3RyeSk7CgogICAgICB0aGlzLl9lbnRyaWVzID0gZW50cmllcyB8fCByZXF1aXJlanMuZW50cmllczsKICAgIH0KCiAgICBNb2R1bGVSZWdpc3RyeS5wcm90b3R5cGUubW9kdWxlTmFtZXMgPSBmdW5jdGlvbiBtb2R1bGVOYW1lcygpIHsKICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuX2VudHJpZXMpOwogICAgfTsKCiAgICBNb2R1bGVSZWdpc3RyeS5wcm90b3R5cGUuaGFzID0gZnVuY3Rpb24gaGFzKG1vZHVsZU5hbWUpIHsKICAgICAgcmV0dXJuIG1vZHVsZU5hbWUgaW4gdGhpcy5fZW50cmllczsKICAgIH07CgogICAgTW9kdWxlUmVnaXN0cnkucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldChtb2R1bGVOYW1lKSB7CiAgICAgIHJldHVybiByZXF1aXJlKG1vZHVsZU5hbWUpOwogICAgfTsKCiAgICByZXR1cm4gTW9kdWxlUmVnaXN0cnk7CiAgfSgpOwoKICAvKioKICAgKiBUaGlzIG1vZHVsZSBkZWZpbmVzIGEgc3ViY2xhc3Mgb2YgRW1iZXIuRGVmYXVsdFJlc29sdmVyIHRoYXQgYWRkcyB0d28KICAgKiBpbXBvcnRhbnQgZmVhdHVyZXM6CiAgICoKICAgKiAgMSkgVGhlIHJlc29sdmVyIG1ha2VzIHRoZSBjb250YWluZXIgYXdhcmUgb2YgZXM2IG1vZHVsZXMgdmlhIHRoZSBBTUQKICAgKiAgICAgb3V0cHV0LiBUaGUgbG9hZGVyJ3MgX21vZHVsZUVudHJpZXMgaXMgY29uc3VsdGVkIHNvIHRoYXQgY2xhc3NlcyBjYW4gYmUKICAgKiAgICAgcmVzb2x2ZWQgZGlyZWN0bHkgdmlhIHRoZSBtb2R1bGUgbG9hZGVyLCB3aXRob3V0IG5lZWRpbmcgYSBtYW51YWwKICAgKiAgICAgYGltcG9ydGAuCiAgICogIDIpIGlzIGFibGUgdG8gcHJvdmlkZSBpbmplY3Rpb25zIHRvIGNsYXNzZXMgdGhhdCBpbXBsZW1lbnQgYGV4dGVuZGAKICAgKiAgICAgKGFzIGlzIHR5cGljYWwgd2l0aCBFbWJlcikuCiAgICovCgogIGZ1bmN0aW9uIHBhcnNlTmFtZShmdWxsTmFtZSkgewogICAgaWYgKGZ1bGxOYW1lLnBhcnNlZE5hbWUgPT09IHRydWUpIHsKICAgICAgcmV0dXJuIGZ1bGxOYW1lOwogICAgfQoKICAgIHZhciBwcmVmaXggPSB2b2lkIDAsCiAgICAgICAgdHlwZSA9IHZvaWQgMCwKICAgICAgICBuYW1lID0gdm9pZCAwOwogICAgdmFyIGZ1bGxOYW1lUGFydHMgPSBmdWxsTmFtZS5zcGxpdCgnQCcpOwoKICAgIGlmIChmdWxsTmFtZVBhcnRzLmxlbmd0aCA9PT0gMikgewogICAgICB2YXIgcHJlZml4UGFydHMgPSBmdWxsTmFtZVBhcnRzWzBdLnNwbGl0KCc6Jyk7CgogICAgICBpZiAocHJlZml4UGFydHMubGVuZ3RoID09PSAyKSB7CiAgICAgICAgaWYgKHByZWZpeFBhcnRzWzFdLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgdHlwZSA9IHByZWZpeFBhcnRzWzBdOwogICAgICAgICAgbmFtZSA9ICdAJyArIGZ1bGxOYW1lUGFydHNbMV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHByZWZpeCA9IHByZWZpeFBhcnRzWzFdOwogICAgICAgICAgdHlwZSA9IHByZWZpeFBhcnRzWzBdOwogICAgICAgICAgbmFtZSA9IGZ1bGxOYW1lUGFydHNbMV07CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZhciBuYW1lUGFydHMgPSBmdWxsTmFtZVBhcnRzWzFdLnNwbGl0KCc6Jyk7CgogICAgICAgIHByZWZpeCA9IGZ1bGxOYW1lUGFydHNbMF07CiAgICAgICAgdHlwZSA9IG5hbWVQYXJ0c1swXTsKICAgICAgICBuYW1lID0gbmFtZVBhcnRzWzFdOwogICAgICB9CgogICAgICBpZiAodHlwZSA9PT0gJ3RlbXBsYXRlJyAmJiBwcmVmaXgubGFzdEluZGV4T2YoJ2NvbXBvbmVudHMvJywgMCkgPT09IDApIHsKICAgICAgICBuYW1lID0gJ2NvbXBvbmVudHMvJyArIG5hbWU7CiAgICAgICAgcHJlZml4ID0gcHJlZml4LnNsaWNlKDExKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZnVsbE5hbWVQYXJ0cyA9IGZ1bGxOYW1lLnNwbGl0KCc6Jyk7CiAgICAgIHR5cGUgPSBmdWxsTmFtZVBhcnRzWzBdOwogICAgICBuYW1lID0gZnVsbE5hbWVQYXJ0c1sxXTsKICAgIH0KCiAgICB2YXIgZnVsbE5hbWVXaXRob3V0VHlwZSA9IG5hbWU7CiAgICB2YXIgbmFtZXNwYWNlID0gRW1iZXIuZ2V0KHRoaXMsICduYW1lc3BhY2UnKTsKICAgIHZhciByb290ID0gbmFtZXNwYWNlOwoKICAgIHJldHVybiB7CiAgICAgIHBhcnNlZE5hbWU6IHRydWUsCiAgICAgIGZ1bGxOYW1lOiBmdWxsTmFtZSwKICAgICAgcHJlZml4OiBwcmVmaXggfHwgdGhpcy5wcmVmaXgoeyB0eXBlOiB0eXBlIH0pLAogICAgICB0eXBlOiB0eXBlLAogICAgICBmdWxsTmFtZVdpdGhvdXRUeXBlOiBmdWxsTmFtZVdpdGhvdXRUeXBlLAogICAgICBuYW1lOiBuYW1lLAogICAgICByb290OiByb290LAogICAgICByZXNvbHZlTWV0aG9kTmFtZTogInJlc29sdmUiICsgRW1iZXIuU3RyaW5nLmNsYXNzaWZ5KHR5cGUpCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gcmVzb2x2ZU90aGVyKHBhcnNlZE5hbWUpIHsKICAgIChmYWxzZSAmJiAhKHRoaXMubmFtZXNwYWNlLm1vZHVsZVByZWZpeCkgJiYgRW1iZXIuYXNzZXJ0KCdgbW9kdWxlUHJlZml4YCBtdXN0IGJlIGRlZmluZWQnLCB0aGlzLm5hbWVzcGFjZS5tb2R1bGVQcmVmaXgpKTsKCgogICAgdmFyIG5vcm1hbGl6ZWRNb2R1bGVOYW1lID0gdGhpcy5maW5kTW9kdWxlTmFtZShwYXJzZWROYW1lKTsKCiAgICBpZiAobm9ybWFsaXplZE1vZHVsZU5hbWUpIHsKICAgICAgdmFyIGRlZmF1bHRFeHBvcnQgPSB0aGlzLl9leHRyYWN0RGVmYXVsdEV4cG9ydChub3JtYWxpemVkTW9kdWxlTmFtZSwgcGFyc2VkTmFtZSk7CgogICAgICBpZiAoZGVmYXVsdEV4cG9ydCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCcgRXhwZWN0ZWQgdG8gZmluZDogXCcnICsgcGFyc2VkTmFtZS5mdWxsTmFtZSArICdcJyB3aXRoaW4gXCcnICsgbm9ybWFsaXplZE1vZHVsZU5hbWUgKyAnXCcgYnV0IGdvdCBcJ3VuZGVmaW5lZFwnLiBEaWQgeW91IGZvcmdldCB0byBcJ2V4cG9ydCBkZWZhdWx0XCcgd2l0aGluIFwnJyArIG5vcm1hbGl6ZWRNb2R1bGVOYW1lICsgJ1wnPycpOwogICAgICB9CgogICAgICBpZiAodGhpcy5zaG91bGRXcmFwSW5DbGFzc0ZhY3RvcnkoZGVmYXVsdEV4cG9ydCwgcGFyc2VkTmFtZSkpIHsKICAgICAgICBkZWZhdWx0RXhwb3J0ID0gKDAsIF9jbGFzc0ZhY3RvcnkuZGVmYXVsdCkoZGVmYXVsdEV4cG9ydCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBkZWZhdWx0RXhwb3J0OwogICAgfQogIH0KCiAgdmFyIFJlc29sdmVyID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICByZXNvbHZlT3RoZXI6IHJlc29sdmVPdGhlciwKICAgIHBhcnNlTmFtZTogcGFyc2VOYW1lLAogICAgcGx1cmFsaXplZFR5cGVzOiBudWxsLAogICAgbW9kdWxlUmVnaXN0cnk6IG51bGwsCgogICAgbWFrZVRvU3RyaW5nOiBmdW5jdGlvbiBtYWtlVG9TdHJpbmcoZmFjdG9yeSwgZnVsbE5hbWUpIHsKICAgICAgcmV0dXJuICcnICsgdGhpcy5uYW1lc3BhY2UubW9kdWxlUHJlZml4ICsgJ0AnICsgZnVsbE5hbWUgKyAnOic7CiAgICB9LAogICAgc2hvdWxkV3JhcEluQ2xhc3NGYWN0b3J5OiBmdW5jdGlvbiBzaG91bGRXcmFwSW5DbGFzc0ZhY3RvcnkoKSAvKiBtb2R1bGUsIHBhcnNlZE5hbWUgKi97CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgICBpbml0OiBmdW5jdGlvbiBpbml0KCkgewogICAgICB0aGlzLl9zdXBlcigpOwogICAgICB0aGlzLm1vZHVsZUJhc2VkUmVzb2x2ZXIgPSB0cnVlOwoKICAgICAgaWYgKCF0aGlzLl9tb2R1bGVSZWdpc3RyeSkgewogICAgICAgIHRoaXMuX21vZHVsZVJlZ2lzdHJ5ID0gbmV3IE1vZHVsZVJlZ2lzdHJ5KCk7CiAgICAgIH0KCiAgICAgIHRoaXMuX25vcm1hbGl6ZUNhY2hlID0gKDAsIF9tYWtlRGljdGlvbmFyeS5kZWZhdWx0KSgpOwoKICAgICAgdGhpcy5wbHVyYWxpemVkVHlwZXMgPSB0aGlzLnBsdXJhbGl6ZWRUeXBlcyB8fCAoMCwgX21ha2VEaWN0aW9uYXJ5LmRlZmF1bHQpKCk7CgogICAgICBpZiAoIXRoaXMucGx1cmFsaXplZFR5cGVzLmNvbmZpZykgewogICAgICAgIHRoaXMucGx1cmFsaXplZFR5cGVzLmNvbmZpZyA9ICdjb25maWcnOwogICAgICB9CiAgICAgIHRoaXMuX2RlcHJlY2F0ZWRQb2RNb2R1bGVQcmVmaXggPSBmYWxzZTsKICAgIH0sCiAgICBub3JtYWxpemU6IGZ1bmN0aW9uIG5vcm1hbGl6ZShmdWxsTmFtZSkgewogICAgICByZXR1cm4gdGhpcy5fbm9ybWFsaXplQ2FjaGVbZnVsbE5hbWVdIHx8ICh0aGlzLl9ub3JtYWxpemVDYWNoZVtmdWxsTmFtZV0gPSB0aGlzLl9ub3JtYWxpemUoZnVsbE5hbWUpKTsKICAgIH0sCiAgICByZXNvbHZlOiBmdW5jdGlvbiByZXNvbHZlKGZ1bGxOYW1lKSB7CiAgICAgIHZhciBwYXJzZWROYW1lID0gdGhpcy5wYXJzZU5hbWUoZnVsbE5hbWUpOwogICAgICB2YXIgcmVzb2x2ZU1ldGhvZE5hbWUgPSBwYXJzZWROYW1lLnJlc29sdmVNZXRob2ROYW1lOwogICAgICB2YXIgcmVzb2x2ZWQgPSB2b2lkIDA7CgogICAgICBpZiAodHlwZW9mIHRoaXNbcmVzb2x2ZU1ldGhvZE5hbWVdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmVzb2x2ZWQgPSB0aGlzW3Jlc29sdmVNZXRob2ROYW1lXShwYXJzZWROYW1lKTsKICAgICAgfQoKICAgICAgaWYgKHJlc29sdmVkID09IG51bGwpIHsKICAgICAgICByZXNvbHZlZCA9IHRoaXMucmVzb2x2ZU90aGVyKHBhcnNlZE5hbWUpOwogICAgICB9CgogICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgICB9LAogICAgX25vcm1hbGl6ZTogZnVuY3Rpb24gX25vcm1hbGl6ZShmdWxsTmFtZSkgewogICAgICAvLyBBKSBDb252ZXJ0IHVuZGVyc2NvcmVzIHRvIGRhc2hlcwogICAgICAvLyBCKSBDb252ZXJ0IGNhbWVsQ2FzZSB0byBkYXNoLWNhc2UsIGV4Y2VwdCBmb3IgY29tcG9uZW50cyAodGhlaXIKICAgICAgLy8gICAgdGVtcGxhdGVzKSBhbmQgaGVscGVycyB3aGVyZSB3ZSB3YW50IHRvIGF2b2lkIHNoYWRvd2luZyBjYW1lbENhc2UKICAgICAgLy8gICAgZXhwcmVzc2lvbnMKICAgICAgLy8gQykgcmVwbGFjZSBgLmAgd2l0aCBgL2AgaW4gb3JkZXIgdG8gbWFrZSBuZXN0ZWQgY29udHJvbGxlcnMgd29yayBpbiB0aGUgZm9sbG93aW5nIGNhc2VzCiAgICAgIC8vICAgICAgMS4gYG5lZWRzOiBbJ3Bvc3RzL3Bvc3QnXWAKICAgICAgLy8gICAgICAyLiBge3tyZW5kZXIgInBvc3RzL3Bvc3QifX1gCiAgICAgIC8vICAgICAgMy4gYHRoaXMucmVuZGVyKCdwb3N0cy9wb3N0JylgIGZyb20gUm91dGUKCiAgICAgIHZhciBzcGxpdCA9IGZ1bGxOYW1lLnNwbGl0KCc6Jyk7CiAgICAgIGlmIChzcGxpdC5sZW5ndGggPiAxKSB7CiAgICAgICAgdmFyIHR5cGUgPSBzcGxpdFswXTsKCiAgICAgICAgaWYgKHR5cGUgPT09ICdjb21wb25lbnQnIHx8IHR5cGUgPT09ICdoZWxwZXInIHx8IHR5cGUgPT09ICd0ZW1wbGF0ZScgJiYgc3BsaXRbMV0uaW5kZXhPZignY29tcG9uZW50cy8nKSA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHR5cGUgKyAnOicgKyBzcGxpdFsxXS5yZXBsYWNlKC9fL2csICctJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiB0eXBlICsgJzonICsgRW1iZXIuU3RyaW5nLmRhc2hlcml6ZShzcGxpdFsxXS5yZXBsYWNlKC9cLi9nLCAnLycpKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZ1bGxOYW1lOwogICAgICB9CiAgICB9LAogICAgcGx1cmFsaXplOiBmdW5jdGlvbiBwbHVyYWxpemUodHlwZSkgewogICAgICByZXR1cm4gdGhpcy5wbHVyYWxpemVkVHlwZXNbdHlwZV0gfHwgKHRoaXMucGx1cmFsaXplZFR5cGVzW3R5cGVdID0gdHlwZSArICdzJyk7CiAgICB9LAogICAgcG9kQmFzZWRMb29rdXBXaXRoUHJlZml4OiBmdW5jdGlvbiBwb2RCYXNlZExvb2t1cFdpdGhQcmVmaXgocG9kUHJlZml4LCBwYXJzZWROYW1lKSB7CiAgICAgIHZhciBmdWxsTmFtZVdpdGhvdXRUeXBlID0gcGFyc2VkTmFtZS5mdWxsTmFtZVdpdGhvdXRUeXBlOwoKICAgICAgaWYgKHBhcnNlZE5hbWUudHlwZSA9PT0gJ3RlbXBsYXRlJykgewogICAgICAgIGZ1bGxOYW1lV2l0aG91dFR5cGUgPSBmdWxsTmFtZVdpdGhvdXRUeXBlLnJlcGxhY2UoL15jb21wb25lbnRzXC8vLCAnJyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwb2RQcmVmaXggKyAnLycgKyBmdWxsTmFtZVdpdGhvdXRUeXBlICsgJy8nICsgcGFyc2VkTmFtZS50eXBlOwogICAgfSwKICAgIHBvZEJhc2VkTW9kdWxlTmFtZTogZnVuY3Rpb24gcG9kQmFzZWRNb2R1bGVOYW1lKHBhcnNlZE5hbWUpIHsKICAgICAgdmFyIHBvZFByZWZpeCA9IHRoaXMubmFtZXNwYWNlLnBvZE1vZHVsZVByZWZpeCB8fCB0aGlzLm5hbWVzcGFjZS5tb2R1bGVQcmVmaXg7CgogICAgICByZXR1cm4gdGhpcy5wb2RCYXNlZExvb2t1cFdpdGhQcmVmaXgocG9kUHJlZml4LCBwYXJzZWROYW1lKTsKICAgIH0sCiAgICBwb2RCYXNlZENvbXBvbmVudHNJblN1YmRpcjogZnVuY3Rpb24gcG9kQmFzZWRDb21wb25lbnRzSW5TdWJkaXIocGFyc2VkTmFtZSkgewogICAgICB2YXIgcG9kUHJlZml4ID0gdGhpcy5uYW1lc3BhY2UucG9kTW9kdWxlUHJlZml4IHx8IHRoaXMubmFtZXNwYWNlLm1vZHVsZVByZWZpeDsKICAgICAgcG9kUHJlZml4ID0gcG9kUHJlZml4ICsgJy9jb21wb25lbnRzJzsKCiAgICAgIGlmIChwYXJzZWROYW1lLnR5cGUgPT09ICdjb21wb25lbnQnIHx8IC9eY29tcG9uZW50cy8udGVzdChwYXJzZWROYW1lLmZ1bGxOYW1lV2l0aG91dFR5cGUpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucG9kQmFzZWRMb29rdXBXaXRoUHJlZml4KHBvZFByZWZpeCwgcGFyc2VkTmFtZSk7CiAgICAgIH0KICAgIH0sCiAgICByZXNvbHZlRW5naW5lOiBmdW5jdGlvbiByZXNvbHZlRW5naW5lKHBhcnNlZE5hbWUpIHsKICAgICAgdmFyIGVuZ2luZU5hbWUgPSBwYXJzZWROYW1lLmZ1bGxOYW1lV2l0aG91dFR5cGU7CiAgICAgIHZhciBlbmdpbmVNb2R1bGUgPSBlbmdpbmVOYW1lICsgJy9lbmdpbmUnOwoKICAgICAgaWYgKHRoaXMuX21vZHVsZVJlZ2lzdHJ5LmhhcyhlbmdpbmVNb2R1bGUpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2V4dHJhY3REZWZhdWx0RXhwb3J0KGVuZ2luZU1vZHVsZSk7CiAgICAgIH0KICAgIH0sCiAgICByZXNvbHZlUm91dGVNYXA6IGZ1bmN0aW9uIHJlc29sdmVSb3V0ZU1hcChwYXJzZWROYW1lKSB7CiAgICAgIHZhciBlbmdpbmVOYW1lID0gcGFyc2VkTmFtZS5mdWxsTmFtZVdpdGhvdXRUeXBlOwogICAgICB2YXIgZW5naW5lUm91dGVzTW9kdWxlID0gZW5naW5lTmFtZSArICcvcm91dGVzJzsKCiAgICAgIGlmICh0aGlzLl9tb2R1bGVSZWdpc3RyeS5oYXMoZW5naW5lUm91dGVzTW9kdWxlKSkgewogICAgICAgIHZhciByb3V0ZU1hcCA9IHRoaXMuX2V4dHJhY3REZWZhdWx0RXhwb3J0KGVuZ2luZVJvdXRlc01vZHVsZSk7CgogICAgICAgIChmYWxzZSAmJiAhKHJvdXRlTWFwLmlzUm91dGVNYXApICYmIEVtYmVyLmFzc2VydCgnVGhlIHJvdXRlIG1hcCBmb3IgJyArIGVuZ2luZU5hbWUgKyAnIHNob3VsZCBiZSB3cmFwcGVkIGJ5IFwnYnVpbGRSb3V0ZXNcJyBiZWZvcmUgZXhwb3J0aW5nLicsIHJvdXRlTWFwLmlzUm91dGVNYXApKTsKCgogICAgICAgIHJldHVybiByb3V0ZU1hcDsKICAgICAgfQogICAgfSwKICAgIHJlc29sdmVUZW1wbGF0ZTogZnVuY3Rpb24gcmVzb2x2ZVRlbXBsYXRlKHBhcnNlZE5hbWUpIHsKICAgICAgdmFyIHJlc29sdmVkID0gdGhpcy5yZXNvbHZlT3RoZXIocGFyc2VkTmFtZSk7CiAgICAgIGlmIChyZXNvbHZlZCA9PSBudWxsKSB7CiAgICAgICAgcmVzb2x2ZWQgPSBFbWJlci5URU1QTEFURVNbcGFyc2VkTmFtZS5mdWxsTmFtZVdpdGhvdXRUeXBlXTsKICAgICAgfQogICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgICB9LAogICAgbWFpbk1vZHVsZU5hbWU6IGZ1bmN0aW9uIG1haW5Nb2R1bGVOYW1lKHBhcnNlZE5hbWUpIHsKICAgICAgaWYgKHBhcnNlZE5hbWUuZnVsbE5hbWVXaXRob3V0VHlwZSA9PT0gJ21haW4nKSB7CiAgICAgICAgLy8gaWYgcm91dGVyOm1haW4gb3IgYWRhcHRlcjptYWluIGxvb2sgZm9yIGEgbW9kdWxlIHdpdGgganVzdCB0aGUgdHlwZSBmaXJzdAogICAgICAgIHJldHVybiBwYXJzZWROYW1lLnByZWZpeCArICcvJyArIHBhcnNlZE5hbWUudHlwZTsKICAgICAgfQogICAgfSwKICAgIGRlZmF1bHRNb2R1bGVOYW1lOiBmdW5jdGlvbiBkZWZhdWx0TW9kdWxlTmFtZShwYXJzZWROYW1lKSB7CiAgICAgIHJldHVybiBwYXJzZWROYW1lLnByZWZpeCArICcvJyArIHRoaXMucGx1cmFsaXplKHBhcnNlZE5hbWUudHlwZSkgKyAnLycgKyBwYXJzZWROYW1lLmZ1bGxOYW1lV2l0aG91dFR5cGU7CiAgICB9LAogICAgbmVzdGVkQ29sb2NhdGlvbkNvbXBvbmVudE1vZHVsZU5hbWU6IGZ1bmN0aW9uIG5lc3RlZENvbG9jYXRpb25Db21wb25lbnRNb2R1bGVOYW1lKHBhcnNlZE5hbWUpIHsKICAgICAgaWYgKHBhcnNlZE5hbWUudHlwZSA9PT0gJ2NvbXBvbmVudCcpIHsKICAgICAgICByZXR1cm4gcGFyc2VkTmFtZS5wcmVmaXggKyAnLycgKyB0aGlzLnBsdXJhbGl6ZShwYXJzZWROYW1lLnR5cGUpICsgJy8nICsgcGFyc2VkTmFtZS5mdWxsTmFtZVdpdGhvdXRUeXBlICsgJy9pbmRleCc7CiAgICAgIH0KICAgIH0sCiAgICBwcmVmaXg6IGZ1bmN0aW9uIHByZWZpeChwYXJzZWROYW1lKSB7CiAgICAgIHZhciB0bXBQcmVmaXggPSB0aGlzLm5hbWVzcGFjZS5tb2R1bGVQcmVmaXg7CgogICAgICBpZiAodGhpcy5uYW1lc3BhY2VbcGFyc2VkTmFtZS50eXBlICsgJ1ByZWZpeCddKSB7CiAgICAgICAgdG1wUHJlZml4ID0gdGhpcy5uYW1lc3BhY2VbcGFyc2VkTmFtZS50eXBlICsgJ1ByZWZpeCddOwogICAgICB9CgogICAgICByZXR1cm4gdG1wUHJlZml4OwogICAgfSwKCgogICAgLyoqCiAgICAgIEEgbGlzdGluZyBvZiBmdW5jdGlvbnMgdG8gdGVzdCBmb3IgbW9kdWxlTmFtZSdzIGJhc2VkIG9uIHRoZSBwcm92aWRlZAogICAgIGBwYXJzZWROYW1lYC4gVGhpcyBhbGxvd3MgZWFzeSBjdXN0b21pemF0aW9uIG9mIGFkZGl0aW9uYWwgbW9kdWxlIGJhc2VkCiAgICAgbG9va3VwIHBhdHRlcm5zLgogICAgICBAcHJvcGVydHkgbW9kdWxlTmFtZUxvb2t1cFBhdHRlcm5zCiAgICAgQHJldHVybnMge0VtYmVyLkFycmF5fQogICAgICovCiAgICBtb2R1bGVOYW1lTG9va3VwUGF0dGVybnM6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIFt0aGlzLnBvZEJhc2VkTW9kdWxlTmFtZSwgdGhpcy5wb2RCYXNlZENvbXBvbmVudHNJblN1YmRpciwgdGhpcy5tYWluTW9kdWxlTmFtZSwgdGhpcy5kZWZhdWx0TW9kdWxlTmFtZSwgdGhpcy5uZXN0ZWRDb2xvY2F0aW9uQ29tcG9uZW50TW9kdWxlTmFtZV07CiAgICB9KS5yZWFkT25seSgpLAoKICAgIGZpbmRNb2R1bGVOYW1lOiBmdW5jdGlvbiBmaW5kTW9kdWxlTmFtZShwYXJzZWROYW1lLCBsb2dnaW5nRGlzYWJsZWQpIHsKICAgICAgdmFyIG1vZHVsZU5hbWVMb29rdXBQYXR0ZXJucyA9IHRoaXMuZ2V0KCdtb2R1bGVOYW1lTG9va3VwUGF0dGVybnMnKTsKICAgICAgdmFyIG1vZHVsZU5hbWUgPSB2b2lkIDA7CgogICAgICBmb3IgKHZhciBpbmRleCA9IDAsIGxlbmd0aCA9IG1vZHVsZU5hbWVMb29rdXBQYXR0ZXJucy5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgdmFyIGl0ZW0gPSBtb2R1bGVOYW1lTG9va3VwUGF0dGVybnNbaW5kZXhdOwoKICAgICAgICB2YXIgdG1wTW9kdWxlTmFtZSA9IGl0ZW0uY2FsbCh0aGlzLCBwYXJzZWROYW1lKTsKCiAgICAgICAgLy8gYWxsb3cgdHJlYXQgYWxsIGRhc2hlZCBhbmQgYWxsIHVuZGVyc2NvcmVkIGFzIHRoZSBzYW1lIHRoaW5nCiAgICAgICAgLy8gc3VwcG9ydHMgY29tcG9uZW50cyB3aXRoIGRhc2hlcyBhbmQgb3RoZXIgc3R1ZmYgd2l0aCB1bmRlcnNjb3Jlcy4KICAgICAgICBpZiAodG1wTW9kdWxlTmFtZSkgewogICAgICAgICAgdG1wTW9kdWxlTmFtZSA9IHRoaXMuY2hvb3NlTW9kdWxlTmFtZSh0bXBNb2R1bGVOYW1lLCBwYXJzZWROYW1lKTsKICAgICAgICB9CgogICAgICAgIGlmICh0bXBNb2R1bGVOYW1lICYmIHRoaXMuX21vZHVsZVJlZ2lzdHJ5Lmhhcyh0bXBNb2R1bGVOYW1lKSkgewogICAgICAgICAgbW9kdWxlTmFtZSA9IHRtcE1vZHVsZU5hbWU7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWxvZ2dpbmdEaXNhYmxlZCkgewogICAgICAgICAgdGhpcy5fbG9nTG9va3VwKG1vZHVsZU5hbWUsIHBhcnNlZE5hbWUsIHRtcE1vZHVsZU5hbWUpOwogICAgICAgIH0KCiAgICAgICAgaWYgKG1vZHVsZU5hbWUpIHsKICAgICAgICAgIHJldHVybiBtb2R1bGVOYW1lOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGNob29zZU1vZHVsZU5hbWU6IGZ1bmN0aW9uIGNob29zZU1vZHVsZU5hbWUobW9kdWxlTmFtZSwgcGFyc2VkTmFtZSkgewogICAgICB2YXIgdW5kZXJzY29yZWRNb2R1bGVOYW1lID0gRW1iZXIuU3RyaW5nLnVuZGVyc2NvcmUobW9kdWxlTmFtZSk7CgogICAgICBpZiAobW9kdWxlTmFtZSAhPT0gdW5kZXJzY29yZWRNb2R1bGVOYW1lICYmIHRoaXMuX21vZHVsZVJlZ2lzdHJ5Lmhhcyhtb2R1bGVOYW1lKSAmJiB0aGlzLl9tb2R1bGVSZWdpc3RyeS5oYXModW5kZXJzY29yZWRNb2R1bGVOYW1lKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FtYmlndW91cyBtb2R1bGUgbmFtZXM6IFwnJyArIG1vZHVsZU5hbWUgKyAnXCcgYW5kIFwnJyArIHVuZGVyc2NvcmVkTW9kdWxlTmFtZSArICdcJycpOwogICAgICB9CgogICAgICBpZiAodGhpcy5fbW9kdWxlUmVnaXN0cnkuaGFzKG1vZHVsZU5hbWUpKSB7CiAgICAgICAgcmV0dXJuIG1vZHVsZU5hbWU7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fbW9kdWxlUmVnaXN0cnkuaGFzKHVuZGVyc2NvcmVkTW9kdWxlTmFtZSkpIHsKICAgICAgICByZXR1cm4gdW5kZXJzY29yZWRNb2R1bGVOYW1lOwogICAgICB9CiAgICAgIC8vIHdvcmthcm91bmQgZm9yIGRhc2hlcml6ZWQgcGFydGlhbHM6CiAgICAgIC8vIHNvbWV0aGluZy9zb21ldGhpbmcvLXNvbWV0aGluZyA9PiBzb21ldGhpbmcvc29tZXRoaW5nL19zb21ldGhpbmcKICAgICAgdmFyIHBhcnRpYWxpemVkTW9kdWxlTmFtZSA9IG1vZHVsZU5hbWUucmVwbGFjZSgvXC8tKFteL10qKSQvLCAnL18kMScpOwoKICAgICAgaWYgKHRoaXMuX21vZHVsZVJlZ2lzdHJ5LmhhcyhwYXJ0aWFsaXplZE1vZHVsZU5hbWUpKSB7CiAgICAgICAgKGZhbHNlICYmICEoZmFsc2UpICYmIEVtYmVyLmRlcHJlY2F0ZSgnTW9kdWxlcyBzaG91bGQgbm90IGNvbnRhaW4gdW5kZXJzY29yZXMuICcgKyAnQXR0ZW1wdGVkIHRvIGxvb2t1cCAiJyArIG1vZHVsZU5hbWUgKyAnIiB3aGljaCAnICsgJ3dhcyBub3QgZm91bmQuIFBsZWFzZSByZW5hbWUgIicgKyBwYXJ0aWFsaXplZE1vZHVsZU5hbWUgKyAnIiAnICsgJ3RvICInICsgbW9kdWxlTmFtZSArICciIGluc3RlYWQuJywgZmFsc2UsIHsgaWQ6ICdlbWJlci1yZXNvbHZlci51bmRlcnNjb3JlZC1tb2R1bGVzJywgdW50aWw6ICczLjAuMCcgfSkpOwoKCiAgICAgICAgcmV0dXJuIHBhcnRpYWxpemVkTW9kdWxlTmFtZTsKICAgICAgfQoKICAgICAgaWYgKGZhbHNlKSB7CiAgICAgICAgdmFyIGlzQ2FtZWxDYXNlSGVscGVyID0gcGFyc2VkTmFtZS50eXBlID09PSAnaGVscGVyJyAmJiAvW2Etel0rW0EtWl0rLy50ZXN0KG1vZHVsZU5hbWUpOwogICAgICAgIGlmIChpc0NhbWVsQ2FzZUhlbHBlcikgewogICAgICAgICAgdGhpcy5fY2FtZWxDYXNlSGVscGVyV2FybmVkTmFtZXMgPSB0aGlzLl9jYW1lbENhc2VIZWxwZXJXYXJuZWROYW1lcyB8fCBbXTsKICAgICAgICAgIHZhciBhbHJlYWR5V2FybmVkID0gdGhpcy5fY2FtZWxDYXNlSGVscGVyV2FybmVkTmFtZXMuaW5kZXhPZihwYXJzZWROYW1lLmZ1bGxOYW1lKSA+IC0xOwogICAgICAgICAgaWYgKCFhbHJlYWR5V2FybmVkICYmIHRoaXMuX21vZHVsZVJlZ2lzdHJ5LmhhcyhFbWJlci5TdHJpbmcuZGFzaGVyaXplKG1vZHVsZU5hbWUpKSkgewogICAgICAgICAgICB0aGlzLl9jYW1lbENhc2VIZWxwZXJXYXJuZWROYW1lcy5wdXNoKHBhcnNlZE5hbWUuZnVsbE5hbWUpOwogICAgICAgICAgICAoZmFsc2UgJiYgRW1iZXIud2FybignQXR0ZW1wdGVkIHRvIGxvb2t1cCAiJyArIHBhcnNlZE5hbWUuZnVsbE5hbWUgKyAnIiB3aGljaCAnICsgJ3dhcyBub3QgZm91bmQuIEluIHByZXZpb3VzIHZlcnNpb25zIG9mIGVtYmVyLXJlc29sdmVyLCBhIGJ1ZyB3b3VsZCBoYXZlICcgKyAnY2F1c2VkIHRoZSBtb2R1bGUgYXQgIicgKyBFbWJlci5TdHJpbmcuZGFzaGVyaXplKG1vZHVsZU5hbWUpICsgJyIgdG8gYmUgJyArICdyZXR1cm5lZCBmb3IgdGhpcyBjYW1lbCBjYXNlIGhlbHBlciBuYW1lLiBUaGlzIGhhcyBiZWVuIGZpeGVkLiAnICsgJ1VzZSB0aGUgZGFzaGVyaXplZCBuYW1lIHRvIHJlc29sdmUgdGhlIG1vZHVsZSB0aGF0IHdvdWxkIGhhdmUgYmVlbiAnICsgJ3JldHVybmVkIGluIHByZXZpb3VzIHZlcnNpb25zLicsIGZhbHNlLCB7IGlkOiAnZW1iZXItcmVzb2x2ZXIuY2FtZWxjYXNlLWhlbHBlci1uYW1lcycsIHVudGlsOiAnMy4wLjAnIH0pKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBsb29rdXBEZXNjcmlwdGlvbjogZnVuY3Rpb24gbG9va3VwRGVzY3JpcHRpb24oZnVsbE5hbWUpIHsKICAgICAgdmFyIHBhcnNlZE5hbWUgPSB0aGlzLnBhcnNlTmFtZShmdWxsTmFtZSk7CgogICAgICB2YXIgbW9kdWxlTmFtZSA9IHRoaXMuZmluZE1vZHVsZU5hbWUocGFyc2VkTmFtZSwgdHJ1ZSk7CgogICAgICByZXR1cm4gbW9kdWxlTmFtZTsKICAgIH0sCiAgICBfbG9nTG9va3VwOiBmdW5jdGlvbiBfbG9nTG9va3VwKGZvdW5kLCBwYXJzZWROYW1lLCBkZXNjcmlwdGlvbikgewogICAgICBpZiAoIUVtYmVyLkVOVi5MT0dfTU9EVUxFX1JFU09MVkVSICYmICFwYXJzZWROYW1lLnJvb3QuTE9HX1JFU09MVkVSKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgcGFkZGluZyA9IHZvaWQgMDsKICAgICAgdmFyIHN5bWJvbCA9IGZvdW5kID8gJ1vinJNdJyA6ICdbIF0nOwoKICAgICAgaWYgKHBhcnNlZE5hbWUuZnVsbE5hbWUubGVuZ3RoID4gNjApIHsKICAgICAgICBwYWRkaW5nID0gJy4nOwogICAgICB9IGVsc2UgewogICAgICAgIHBhZGRpbmcgPSBuZXcgQXJyYXkoNjAgLSBwYXJzZWROYW1lLmZ1bGxOYW1lLmxlbmd0aCkuam9pbignLicpOwogICAgICB9CgogICAgICBpZiAoIWRlc2NyaXB0aW9uKSB7CiAgICAgICAgZGVzY3JpcHRpb24gPSB0aGlzLmxvb2t1cERlc2NyaXB0aW9uKHBhcnNlZE5hbWUpOwogICAgICB9CgogICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1jb25zb2xlICovCiAgICAgIGlmIChjb25zb2xlICYmIGNvbnNvbGUuaW5mbykgewogICAgICAgIGNvbnNvbGUuaW5mbyhzeW1ib2wsIHBhcnNlZE5hbWUuZnVsbE5hbWUsIHBhZGRpbmcsIGRlc2NyaXB0aW9uKTsKICAgICAgfQogICAgfSwKICAgIGtub3duRm9yVHlwZTogZnVuY3Rpb24ga25vd25Gb3JUeXBlKHR5cGUpIHsKICAgICAgdmFyIG1vZHVsZUtleXMgPSB0aGlzLl9tb2R1bGVSZWdpc3RyeS5tb2R1bGVOYW1lcygpOwoKICAgICAgdmFyIGl0ZW1zID0gKDAsIF9tYWtlRGljdGlvbmFyeS5kZWZhdWx0KSgpOwogICAgICBmb3IgKHZhciBpbmRleCA9IDAsIGxlbmd0aCA9IG1vZHVsZUtleXMubGVuZ3RoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgIHZhciBtb2R1bGVOYW1lID0gbW9kdWxlS2V5c1tpbmRleF07CiAgICAgICAgdmFyIGZ1bGxuYW1lID0gdGhpcy50cmFuc2xhdGVUb0NvbnRhaW5lckZ1bGxuYW1lKHR5cGUsIG1vZHVsZU5hbWUpOwoKICAgICAgICBpZiAoZnVsbG5hbWUpIHsKICAgICAgICAgIGl0ZW1zW2Z1bGxuYW1lXSA9IHRydWU7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gaXRlbXM7CiAgICB9LAogICAgdHJhbnNsYXRlVG9Db250YWluZXJGdWxsbmFtZTogZnVuY3Rpb24gdHJhbnNsYXRlVG9Db250YWluZXJGdWxsbmFtZSh0eXBlLCBtb2R1bGVOYW1lKSB7CiAgICAgIHZhciBwcmVmaXggPSB0aGlzLnByZWZpeCh7IHR5cGU6IHR5cGUgfSk7CgogICAgICAvLyBOb3RlOiB1c2luZyBzdHJpbmcgbWFuaXB1bGF0aW9uIGhlcmUgcmF0aGVyIHRoYW4gcmVnZXhlcyBmb3IgYmV0dGVyIHBlcmZvcm1hbmNlLgogICAgICAvLyBwb2QgbW9kdWxlcwogICAgICAvLyAnXicgKyBwcmVmaXggKyAnLyguKykvJyArIHR5cGUgKyAnJCcKICAgICAgdmFyIHBvZFByZWZpeCA9IHByZWZpeCArICcvJzsKICAgICAgdmFyIHBvZFN1ZmZpeCA9ICcvJyArIHR5cGU7CiAgICAgIHZhciBzdGFydCA9IG1vZHVsZU5hbWUuaW5kZXhPZihwb2RQcmVmaXgpOwogICAgICB2YXIgZW5kID0gbW9kdWxlTmFtZS5pbmRleE9mKHBvZFN1ZmZpeCk7CgogICAgICBpZiAoc3RhcnQgPT09IDAgJiYgZW5kID09PSBtb2R1bGVOYW1lLmxlbmd0aCAtIHBvZFN1ZmZpeC5sZW5ndGggJiYgbW9kdWxlTmFtZS5sZW5ndGggPiBwb2RQcmVmaXgubGVuZ3RoICsgcG9kU3VmZml4Lmxlbmd0aCkgewogICAgICAgIHJldHVybiB0eXBlICsgJzonICsgbW9kdWxlTmFtZS5zbGljZShzdGFydCArIHBvZFByZWZpeC5sZW5ndGgsIGVuZCk7CiAgICAgIH0KCiAgICAgIC8vIG5vbi1wb2QgbW9kdWxlcwogICAgICAvLyAnXicgKyBwcmVmaXggKyAnLycgKyBwbHVyYWxpemVkVHlwZSArICcvKC4rKSQnCiAgICAgIHZhciBwbHVyYWxpemVkVHlwZSA9IHRoaXMucGx1cmFsaXplKHR5cGUpOwogICAgICB2YXIgbm9uUG9kUHJlZml4ID0gcHJlZml4ICsgJy8nICsgcGx1cmFsaXplZFR5cGUgKyAnLyc7CgogICAgICBpZiAobW9kdWxlTmFtZS5pbmRleE9mKG5vblBvZFByZWZpeCkgPT09IDAgJiYgbW9kdWxlTmFtZS5sZW5ndGggPiBub25Qb2RQcmVmaXgubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIHR5cGUgKyAnOicgKyBtb2R1bGVOYW1lLnNsaWNlKG5vblBvZFByZWZpeC5sZW5ndGgpOwogICAgICB9CiAgICB9LAogICAgX2V4dHJhY3REZWZhdWx0RXhwb3J0OiBmdW5jdGlvbiBfZXh0cmFjdERlZmF1bHRFeHBvcnQobm9ybWFsaXplZE1vZHVsZU5hbWUpIHsKICAgICAgdmFyIG1vZHVsZSA9IHJlcXVpcmUobm9ybWFsaXplZE1vZHVsZU5hbWUsIG51bGwsIG51bGwsIHRydWUgLyogZm9yY2Ugc3luYyAqLyk7CgogICAgICBpZiAobW9kdWxlICYmIG1vZHVsZVsnZGVmYXVsdCddKSB7CiAgICAgICAgbW9kdWxlID0gbW9kdWxlWydkZWZhdWx0J107CiAgICAgIH0KCiAgICAgIHJldHVybiBtb2R1bGU7CiAgICB9CiAgfSk7CgogIFJlc29sdmVyLnJlb3BlbkNsYXNzKHsKICAgIG1vZHVsZUJhc2VkUmVzb2x2ZXI6IHRydWUKICB9KTsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gUmVzb2x2ZXI7Cn0pOwo7ZGVmaW5lKCdlbWJlci1yZXNvbHZlci91dGlscy9jbGFzcy1mYWN0b3J5JywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IGNsYXNzRmFjdG9yeTsKICBmdW5jdGlvbiBjbGFzc0ZhY3Rvcnkoa2xhc3MpIHsKICAgIHJldHVybiB7CiAgICAgIGNyZWF0ZTogZnVuY3Rpb24gY3JlYXRlKGluamVjdGlvbnMpIHsKICAgICAgICBpZiAodHlwZW9mIGtsYXNzLmV4dGVuZCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgcmV0dXJuIGtsYXNzLmV4dGVuZChpbmplY3Rpb25zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGtsYXNzOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9Cn0pOwo7ZGVmaW5lKCdlbWJlci1yZXNvbHZlci91dGlscy9tYWtlLWRpY3Rpb25hcnknLCBbJ2V4cG9ydHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5kZWZhdWx0ID0gbWFrZURpY3Rpb25hcnk7CiAgZnVuY3Rpb24gbWFrZURpY3Rpb25hcnkoKSB7CiAgICB2YXIgY2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgY2FjaGVbJ19kaWN0J10gPSBudWxsOwogICAgZGVsZXRlIGNhY2hlWydfZGljdCddOwogICAgcmV0dXJuIGNhY2hlOwogIH0KfSk7CjtkZWZpbmUoImVtYmVyLXRlc3Qtd2FpdGVycy9idWlsZC13YWl0ZXIiLCBbImV4cG9ydHMiLCAiZW1iZXItdGVzdC13YWl0ZXJzIiwgImVtYmVyLXRlc3Qtd2FpdGVycy9ub29wLXRlc3Qtd2FpdGVyIl0sIGZ1bmN0aW9uIChfZXhwb3J0cywgX2VtYmVyVGVzdFdhaXRlcnMsIF9ub29wVGVzdFdhaXRlcikgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IGJ1aWxkV2FpdGVyOwoKICAvKioKICAgKiBCdWlsZHMgYW5kIHJldHVybnMgYSB0ZXN0IHdhaXRlci4gVGhlIHR5cGUgb2YgdGhlCiAgICogcmV0dXJuZWQgd2FpdGVyIGlzIGRlcGVuZGVudCBvbiB3aGV0aGVyIHRoZSBhcHAgb3IKICAgKiBhZGRvbiBpcyBpbiBgREVCVUdgIG1vZGUgb3Igbm90LgogICAqCiAgICogQHBhcmFtIG5hbWUge3N0cmluZ30gVGhlIG5hbWUgb2YgdGhlIHRlc3Qgd2FpdGVyCiAgICogQHJldHVybnMge0lUZXN0V2FpdGVyfQogICAqCiAgICogQGV4YW1wbGUKICAgKgogICAqIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICogaW1wb3J0IHsgYnVpbGRXYWl0ZXIgfSBmcm9tICdlbWJlci10ZXN0LXdhaXRlcnMnOwogICAqCiAgICogaWYgKERFQlVHKSB7CiAgICogICBsZXQgd2FpdGVyID0gYnVpbGRXYWl0ZXIoJ2ZyaWVuZC13YWl0ZXInKTsKICAgKiB9CiAgICoKICAgKiBleHBvcnQgZGVmYXVsdCBjbGFzcyBGcmllbmR6IGV4dGVuZHMgQ29tcG9uZW50IHsKICAgKiAgIGRpZEluc2VydEVsZW1lbnQoKSB7CiAgICogICAgIGxldCB0b2tlbiA9IHdhaXRlci5iZWdpbkFzeW5jKHRoaXMpOwogICAqCiAgICogICAgIHNvbWVBc3luY1dvcmsoKS50aGVuKCgpID0+IHsKICAgKiAgICAgICB3YWl0ZXIuZW5kQXN5bmModG9rZW4pOwogICAqICAgICB9KTsKICAgKiAgIH0KICAgKiB9CiAgICovCiAgZnVuY3Rpb24gYnVpbGRXYWl0ZXIobmFtZSkgewogICAgaWYgKGZhbHNlCiAgICAvKiBERUJVRyAqLwogICAgKSB7CiAgICAgIHJldHVybiBuZXcgX2VtYmVyVGVzdFdhaXRlcnMuVGVzdFdhaXRlcihuYW1lKTsKICAgIH0KCiAgICByZXR1cm4gbmV3IF9ub29wVGVzdFdhaXRlci5kZWZhdWx0KG5hbWUpOwogIH0KfSk7CjtkZWZpbmUoImVtYmVyLXRlc3Qtd2FpdGVycy9pbmRleCIsIFsiZXhwb3J0cyIsICJlbWJlci10ZXN0LXdhaXRlcnMvd2FpdGVyLW1hbmFnZXIiLCAiZW1iZXItdGVzdC13YWl0ZXJzL3Rlc3Qtd2FpdGVyIiwgImVtYmVyLXRlc3Qtd2FpdGVycy9idWlsZC13YWl0ZXIiLCAiZW1iZXItdGVzdC13YWl0ZXJzL3dhaXQtZm9yLXByb21pc2UiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfd2FpdGVyTWFuYWdlciwgX3Rlc3RXYWl0ZXIsIF9idWlsZFdhaXRlciwgX3dhaXRGb3JQcm9taXNlKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJyZWdpc3RlciIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF93YWl0ZXJNYW5hZ2VyLnJlZ2lzdGVyOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgInVucmVnaXN0ZXIiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfd2FpdGVyTWFuYWdlci51bnJlZ2lzdGVyOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgImdldFdhaXRlcnMiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfd2FpdGVyTWFuYWdlci5nZXRXYWl0ZXJzOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9yZXNldCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF93YWl0ZXJNYW5hZ2VyLl9yZXNldDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJnZXRQZW5kaW5nV2FpdGVyU3RhdGUiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfd2FpdGVyTWFuYWdlci5nZXRQZW5kaW5nV2FpdGVyU3RhdGU7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiaGFzUGVuZGluZ1dhaXRlcnMiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBfd2FpdGVyTWFuYWdlci5oYXNQZW5kaW5nV2FpdGVyczsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJUZXN0V2FpdGVyIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3Rlc3RXYWl0ZXIuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJidWlsZFdhaXRlciIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIF9idWlsZFdhaXRlci5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIndhaXRGb3JQcm9taXNlIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX3dhaXRGb3JQcm9taXNlLmRlZmF1bHQ7CiAgICB9CiAgfSk7Cn0pOwo7ZGVmaW5lKCJlbWJlci10ZXN0LXdhaXRlcnMvbm9vcC10ZXN0LXdhaXRlciIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoX2V4cG9ydHMpIHsKICAidXNlIHN0cmljdCI7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIF9leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgogIGZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKICBmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKICBmdW5jdGlvbiBfY3JlYXRlQ2xhc3MoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKICAvKioKICAgKiBBIGNsYXNzIHByb3ZpZGluZyBhIHByb2R1Y3Rpb24sIG5vb3AgcmVwbGFjZW1lbnQgZm9yIHRoZSB7VGVzdFdhaXRlcjxUPn0gY2xhc3MuCiAgICoKICAgKiBAcHVibGljCiAgICogQGNsYXNzIFRlc3RXYWl0ZXI8VD4KICAgKi8KICB2YXIgTm9vcFRlc3RXYWl0ZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBOb29wVGVzdFdhaXRlcihuYW1lKSB7CiAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBOb29wVGVzdFdhaXRlcik7CgogICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgfQoKICAgIF9jcmVhdGVDbGFzcyhOb29wVGVzdFdhaXRlciwgW3sKICAgICAga2V5OiAiYmVnaW5Bc3luYyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBiZWdpbkFzeW5jKCkgewogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImVuZEFzeW5jIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGVuZEFzeW5jKCkge30KICAgIH0sIHsKICAgICAga2V5OiAid2FpdFVudGlsIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHdhaXRVbnRpbCgpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJkZWJ1Z0luZm8iLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZGVidWdJbmZvKCkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBOb29wVGVzdFdhaXRlcjsKICB9KCk7CgogIF9leHBvcnRzLmRlZmF1bHQgPSBOb29wVGVzdFdhaXRlcjsKfSk7CjtkZWZpbmUoImVtYmVyLXRlc3Qtd2FpdGVycy90ZXN0LXdhaXRlciIsIFsiZXhwb3J0cyIsICJlbWJlci10ZXN0LXdhaXRlcnMvd2FpdGVyLW1hbmFnZXIiXSwgZnVuY3Rpb24gKF9leHBvcnRzLCBfd2FpdGVyTWFuYWdlcikgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCiAgZnVuY3Rpb24gX3RvQ29uc3VtYWJsZUFycmF5KGFycikgeyByZXR1cm4gX2FycmF5V2l0aG91dEhvbGVzKGFycikgfHwgX2l0ZXJhYmxlVG9BcnJheShhcnIpIHx8IF9ub25JdGVyYWJsZVNwcmVhZCgpOyB9CgogIGZ1bmN0aW9uIF9ub25JdGVyYWJsZVNwcmVhZCgpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiSW52YWxpZCBhdHRlbXB0IHRvIHNwcmVhZCBub24taXRlcmFibGUgaW5zdGFuY2UiKTsgfQoKICBmdW5jdGlvbiBfaXRlcmFibGVUb0FycmF5KGl0ZXIpIHsgaWYgKFN5bWJvbC5pdGVyYXRvciBpbiBPYmplY3QoaXRlcikgfHwgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGl0ZXIpID09PSAiW29iamVjdCBBcmd1bWVudHNdIikgcmV0dXJuIEFycmF5LmZyb20oaXRlcik7IH0KCiAgZnVuY3Rpb24gX2FycmF5V2l0aG91dEhvbGVzKGFycikgeyBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSB7IGZvciAodmFyIGkgPSAwLCBhcnIyID0gbmV3IEFycmF5KGFyci5sZW5ndGgpOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7IGFycjJbaV0gPSBhcnJbaV07IH0gcmV0dXJuIGFycjI7IH0gfQoKICBmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCiAgZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCiAgZnVuY3Rpb24gX2NyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCiAgdmFyIHRva2VuID0gMDsKCiAgZnVuY3Rpb24gZ2V0TmV4dFRva2VuKCkgewogICAgcmV0dXJuIHRva2VuKys7CiAgfQogIC8qKgogICAqIEEgY2xhc3MgcHJvdmlkaW5nIGNyZWF0aW9uLCByZWdpc3RyYXRpb24gYW5kIGFzeW5jIHdhaXRpbmcgZnVuY3Rpb25hbGl0eS4KICAgKgogICAqIEBwdWJsaWMKICAgKiBAY2xhc3MgVGVzdFdhaXRlcjxUPgogICAqLwoKCiAgdmFyIFRlc3RXYWl0ZXIgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICAvKioKICAgICAqIEBwdWJsaWMKICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIG5hbWUge1dhaXRlck5hbWV9IHRoZSBuYW1lIG9mIHRoZSB0ZXN0IHdhaXRlcgogICAgICovCiAgICBmdW5jdGlvbiBUZXN0V2FpdGVyKG5hbWUsIG5leHRUb2tlbikgewogICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgVGVzdFdhaXRlcik7CgogICAgICB0aGlzLmlzUmVnaXN0ZXJlZCA9IGZhbHNlOwogICAgICB0aGlzLml0ZW1zID0gbmV3IE1hcCgpOwogICAgICB0aGlzLm5hbWUgPSBuYW1lOyAvLyBAdHMtaWdub3JlCgogICAgICB0aGlzLm5leHRUb2tlbiA9IG5leHRUb2tlbiB8fCBnZXROZXh0VG9rZW47CiAgICB9CiAgICAvKioKICAgICAqIFdpbGwgcmVnaXN0ZXIgdGhlIHdhaXRlciwgYWxsb3dpbmcgaXQgdG8gYmUgb3B0ZWQgaW4gdG8gcGF1c2luZyBhc3luYwogICAgICogb3BlcmF0aW9ucyB1bnRpbCB0aGV5J3JlIGNvbXBsZXRlZCB3aXRoaW4geW91ciB0ZXN0cy4gWW91IHNob3VsZCBpbnZva2UKICAgICAqIGl0IGFmdGVyIGluc3RhbnRpYXRpbmcgeW91ciBgVGVzdFdhaXRlcmAgaW5zdGFuY2UuCiAgICAgKgogICAgICogKipOb3RlKiosIGlmIHlvdSBmb3JnZXQgdG8gcmVnaXN0ZXIgeW91ciB3YWl0ZXIsIGl0IHdpbGwgYmUgcmVnaXN0ZXJlZAogICAgICogZm9yIHlvdSBvbiB0aGUgZmlyc3QgaW52b2NhdGlvbiBvZiBgYmVnaW5Bc3luY2AuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBtZXRob2QgcmVnaXN0ZXIKICAgICAqLwoKCiAgICBfY3JlYXRlQ2xhc3MoVGVzdFdhaXRlciwgW3sKICAgICAga2V5OiAicmVnaXN0ZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVnaXN0ZXIoKSB7CiAgICAgICAgaWYgKCF0aGlzLmlzUmVnaXN0ZXJlZCkgewogICAgICAgICAgKDAsIF93YWl0ZXJNYW5hZ2VyLnJlZ2lzdGVyKSh0aGlzKTsKICAgICAgICAgIHRoaXMuaXNSZWdpc3RlcmVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIFNob3VsZCBiZSB1c2VkIHRvIHNpZ25hbCB0aGUgYmVnaW5uaW5nIG9mIGFuIGFzeW5jIG9wZXJhdGlvbiB0aGF0CiAgICAgICAqIGlzIHRvIGJlIHdhaXRlZCBmb3IuIEludm9jYXRpb24gb2YgdGhpcyBtZXRob2Qgc2hvdWxkIGJlIHBhaXJlZCB3aXRoIGEgc3Vic2VxdWVudAogICAgICAgKiBgZW5kQXN5bmNgIGNhbGwgdG8gaW5kaWNhdGUgdG8gdGhlIHdhaXRlciBzeXN0ZW0gdGhhdCB0aGUgYXN5bmMgb3BlcmF0aW9uIGlzIGNvbXBsZXRlZC4KICAgICAgICoKICAgICAgICogQHB1YmxpYwogICAgICAgKiBAbWV0aG9kIGJlZ2luQXN5bmMKICAgICAgICogQHBhcmFtIGl0ZW0ge1R9IFRoZSBpdGVtIHRvIHJlZ2lzdGVyIGZvciB3YWl0aW5nCiAgICAgICAqIEBwYXJhbSBsYWJlbCB7c3RyaW5nfSBBbiBvcHRpb25hbCBsYWJlbCB0byBpZGVudGlmeSB0aGUgaXRlbQogICAgICAgKi8KCiAgICB9LCB7CiAgICAgIGtleTogImJlZ2luQXN5bmMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gYmVnaW5Bc3luYygpIHsKICAgICAgICB2YXIgdG9rZW4gPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IHRoaXMubmV4dFRva2VuKCk7CiAgICAgICAgdmFyIGxhYmVsID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBhcmd1bWVudHNbMV0gOiB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5yZWdpc3RlcigpOwoKICAgICAgICBpZiAodGhpcy5pdGVtcy5oYXModG9rZW4pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImJlZ2luQXN5bmMgY2FsbGVkIGZvciAiLmNvbmNhdCh0b2tlbiwgIiBidXQgaXQgaXMgYWxyZWFkeSBwZW5kaW5nLiIpKTsKICAgICAgICB9CgogICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigpOwogICAgICAgIHRoaXMuaXRlbXMuc2V0KHRva2VuLCB7CiAgICAgICAgICBnZXQgc3RhY2soKSB7CiAgICAgICAgICAgIHJldHVybiBlcnJvci5zdGFjazsKICAgICAgICAgIH0sCgogICAgICAgICAgbGFiZWw6IGxhYmVsCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHRva2VuOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBTaG91bGQgYmUgdXNlZCB0byBzaWduYWwgdGhlIGVuZCBvZiBhbiBhc3luYyBvcGVyYXRpb24uIEludm9jYXRpb24gb2YgdGhpcwogICAgICAgKiBtZXRob2Qgc2hvdWxkIGJlIHBhaXJlZCB3aXRoIGEgcHJlY2VlZGluZyBgYmVnaW5Bc3luY2AgY2FsbCwgd2hpY2ggd291bGQgaW5kaWNhdGUgdGhlCiAgICAgICAqIGJlZ2lubmluZyBvZiBhbiBhc3luYyBvcGVyYXRpb24uCiAgICAgICAqCiAgICAgICAqIEBwdWJsaWMKICAgICAgICogQG1ldGhvZCBlbmRBc3luYwogICAgICAgKiBAcGFyYW0gaXRlbSB7VH0gVGhlIGl0ZW0gdG8gdGhhdCB3YXMgcmVnaXN0ZXJlZCBmb3Igd2FpdGluZwogICAgICAgKi8KCiAgICB9LCB7CiAgICAgIGtleTogImVuZEFzeW5jIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGVuZEFzeW5jKHRva2VuKSB7CiAgICAgICAgaWYgKCF0aGlzLml0ZW1zLmhhcyh0b2tlbikpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZW5kQXN5bmMgY2FsbGVkIGZvciAiLmNvbmNhdCh0b2tlbiwgIiBidXQgaXQgaXMgbm90IGN1cnJlbnRseSBwZW5kaW5nLiIpKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuaXRlbXMuZGVsZXRlKHRva2VuKTsKICAgICAgfQogICAgICAvKioKICAgICAgICogVXNlZCB0byBkZXRlcm1pbmUgaWYgdGhlIHdhaXRlciBzeXN0ZW0gc2hvdWxkIHN0aWxsIHdhaXQgZm9yIGFzeW5jCiAgICAgICAqIG9wZXJhdGlvbnMgdG8gY29tcGxldGUuCiAgICAgICAqCiAgICAgICAqIEBwdWJsaWMKICAgICAgICogQG1ldGhvZCB3YWl0VW50aWwKICAgICAgICogQHJldHVybnMge2Jvb2xlYW59CiAgICAgICAqLwoKICAgIH0sIHsKICAgICAga2V5OiAid2FpdFVudGlsIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHdhaXRVbnRpbCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5pdGVtcy5zaXplID09PSAwOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBSZXR1cm5zIHRoZSBgZGVidWdJbmZvYCBmb3IgZWFjaCBpdGVtIHRyYWNraW5nIGFzeW5jIG9wZXJhdGlvbnMgaW4gdGhpcyB3YWl0ZXIuCiAgICAgICAqCiAgICAgICAqIEBwdWJsaWMKICAgICAgICogQG1ldGhvZCBkZWJ1Z0luZm8KICAgICAgICogQHJldHVybnMge0lUZXN0V2FpdGVyRGVidWdJbmZvfQogICAgICAgKi8KCiAgICB9LCB7CiAgICAgIGtleTogImRlYnVnSW5mbyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBkZWJ1Z0luZm8oKSB7CiAgICAgICAgcmV0dXJuIF90b0NvbnN1bWFibGVBcnJheSh0aGlzLml0ZW1zLnZhbHVlcygpKTsKICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBUZXN0V2FpdGVyOwogIH0oKTsKCiAgX2V4cG9ydHMuZGVmYXVsdCA9IFRlc3RXYWl0ZXI7Cn0pOwo7ZGVmaW5lKCJlbWJlci10ZXN0LXdhaXRlcnMvdHlwZXMvaW5kZXgiLCBbXSwgZnVuY3Rpb24gKCkgewogICJ1c2Ugc3RyaWN0IjsKfSk7CjtkZWZpbmUoImVtYmVyLXRlc3Qtd2FpdGVycy93YWl0LWZvci1wcm9taXNlIiwgWyJleHBvcnRzIiwgImVtYmVyLXRlc3Qtd2FpdGVycy90ZXN0LXdhaXRlciJdLCBmdW5jdGlvbiAoX2V4cG9ydHMsIF90ZXN0V2FpdGVyKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX2V4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBfZXhwb3J0cy5kZWZhdWx0ID0gd2FpdEZvclByb21pc2U7CiAgdmFyIFBST01JU0VfV0FJVEVSID0gbmV3IF90ZXN0V2FpdGVyLmRlZmF1bHQoJ3Byb21pc2Utd2FpdGVyJyk7CiAgLyoqCiAgICogQSBjb252ZW5pZW50IHV0aWxpdHkgZnVuY3Rpb24gdG8gc2ltcGxpZnkgd2FpdGluZyBmb3IgYSBwcm9taXNlLgogICAqCiAgICogQHB1YmxpYwogICAqIEBwYXJhbSBwcm9taXNlIHtQcm9taXNlPFQ+fSBUaGUgcHJvbWlzZSB0byB0cmFjayBhc3luYyBvcGVyYXRpb25zIGZvcgogICAqIEBwYXJhbSBsYWJlbCB7c3RyaW5nfSBBbiBvcHRpb25hbCBzdHJpbmcgdG8gaWRlbnRpZnkgdGhlIHByb21pc2UKICAgKgogICAqIEBleGFtcGxlCiAgICoKICAgKiBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAqIGltcG9ydCB7IHdhaXRGb3JQcm9taXNlIH0gZnJvbSAnZW1iZXItdGVzdC13YWl0ZXJzJzsKICAgKgogICAqIGV4cG9ydCBkZWZhdWx0IGNsYXNzIEZyaWVuZHogZXh0ZW5kcyBDb21wb25lbnQgewogICAqICAgZGlkSW5zZXJ0RWxlbWVudCgpIHsKICAgKiAgICAgd2FpdEZvclByb21pc2UobmV3IFByb21pc2UocmVzb2x2ZSA9PiB7CiAgICogICAgICAgZG9Tb21lV29yaygpOwogICAqICAgICAgIHJlc29sdmUoKTsKICAgKiAgICAgfSkpOwogICAqICAgfQogICAqIH0KICAgKi8KCiAgZnVuY3Rpb24gd2FpdEZvclByb21pc2UocHJvbWlzZSwgbGFiZWwpIHsKICAgIHZhciByZXN1bHQgPSBwcm9taXNlOwoKICAgIGlmIChmYWxzZQogICAgLyogREVCVUcgKi8KICAgICkgewogICAgICBQUk9NSVNFX1dBSVRFUi5iZWdpbkFzeW5jKHByb21pc2UsIGxhYmVsKTsKICAgICAgcmVzdWx0ID0gcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIFBST01JU0VfV0FJVEVSLmVuZEFzeW5jKHByb21pc2UpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgUFJPTUlTRV9XQUlURVIuZW5kQXN5bmMocHJvbWlzZSk7CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0pOwogICAgfQoKICAgIHJldHVybiByZXN1bHQ7CiAgfQp9KTsKO2RlZmluZSgiZW1iZXItdGVzdC13YWl0ZXJzL3dhaXRlci1tYW5hZ2VyIiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChfZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KF9leHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgX2V4cG9ydHMucmVnaXN0ZXIgPSByZWdpc3RlcjsKICBfZXhwb3J0cy51bnJlZ2lzdGVyID0gdW5yZWdpc3RlcjsKICBfZXhwb3J0cy5nZXRXYWl0ZXJzID0gZ2V0V2FpdGVyczsKICBfZXhwb3J0cy5fcmVzZXQgPSBfcmVzZXQ7CiAgX2V4cG9ydHMuZ2V0UGVuZGluZ1dhaXRlclN0YXRlID0gZ2V0UGVuZGluZ1dhaXRlclN0YXRlOwogIF9leHBvcnRzLmhhc1BlbmRpbmdXYWl0ZXJzID0gaGFzUGVuZGluZ1dhaXRlcnM7CgogIGZ1bmN0aW9uIF90b0NvbnN1bWFibGVBcnJheShhcnIpIHsgcmV0dXJuIF9hcnJheVdpdGhvdXRIb2xlcyhhcnIpIHx8IF9pdGVyYWJsZVRvQXJyYXkoYXJyKSB8fCBfbm9uSXRlcmFibGVTcHJlYWQoKTsgfQoKICBmdW5jdGlvbiBfbm9uSXRlcmFibGVTcHJlYWQoKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkludmFsaWQgYXR0ZW1wdCB0byBzcHJlYWQgbm9uLWl0ZXJhYmxlIGluc3RhbmNlIik7IH0KCiAgZnVuY3Rpb24gX2l0ZXJhYmxlVG9BcnJheShpdGVyKSB7IGlmIChTeW1ib2wuaXRlcmF0b3IgaW4gT2JqZWN0KGl0ZXIpIHx8IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChpdGVyKSA9PT0gIltvYmplY3QgQXJndW1lbnRzXSIpIHJldHVybiBBcnJheS5mcm9tKGl0ZXIpOyB9CgogIGZ1bmN0aW9uIF9hcnJheVdpdGhvdXRIb2xlcyhhcnIpIHsgaWYgKEFycmF5LmlzQXJyYXkoYXJyKSkgeyBmb3IgKHZhciBpID0gMCwgYXJyMiA9IG5ldyBBcnJheShhcnIubGVuZ3RoKTsgaSA8IGFyci5sZW5ndGg7IGkrKykgeyBhcnIyW2ldID0gYXJyW2ldOyB9IHJldHVybiBhcnIyOyB9IH0KCiAgdmFyIFdBSVRFUlMgPSBuZXcgTWFwKCk7CiAgLyoqCiAgICogQmFja3dhcmRzIGNvbXBhdGliaWxpdHkgd2l0aCBsZWdhY3kgd2FpdGVycyBzeXN0ZW0uCiAgICoKICAgKiBXZSB3YW50IHRvIGFsd2F5cyByZWdpc3RlciBhIHdhaXRlciB1c2luZyB0aGUgbGVnYWN5IHdhaXRlciBzeXN0ZW0sIGFzIHJpZ2h0CiAgICogbm93IGlmIGNvbnN1bWVycyBhcmUgbm90IG9uIHRoZSByaWdodCB2ZXJzaW9uIG9mIEBlbWJlci90ZXN0LWhlbHBlcnMsIHVzaW5nCiAgICogdGhpcyBhZGRvbiB3aWxsIHJlc3VsdCBpbiBub25lIG9mIHRoZXNlIHdhaXRlcnMgd2FpdGluZy4KICAgKi8KICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZW1iZXIvbmV3LW1vZHVsZS1pbXBvcnRzCgogIGlmIChFbWJlci5UZXN0KSB7CiAgICBFbWJlci5UZXN0LnJlZ2lzdGVyV2FpdGVyKGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICFoYXNQZW5kaW5nV2FpdGVycygpOwogICAgfSk7CiAgfQogIC8qKgogICAqIFJlZ2lzdGVycyBhIHdhaXRlci4KICAgKgogICAqIEBwdWJsaWMKICAgKiBAcGFyYW0gd2FpdGVyIHtJV2FpdGVyfSBBIHRlc3Qgd2FpdGVyIGluc3RhbmNlCiAgICovCgoKICBmdW5jdGlvbiByZWdpc3Rlcih3YWl0ZXIpIHsKICAgIFdBSVRFUlMuc2V0KHdhaXRlci5uYW1lLCB3YWl0ZXIpOwogIH0KICAvKioKICAgKiBVbnJlZ2lzdGVycyBhIHdhaXRlci4KICAgKgogICAqIEBwdWJsaWMKICAgKiBAcGFyYW0gd2FpdGVyIHtJV2FpdGVyfSBBIHRlc3Qgd2FpdGVyIGluc3RhbmNlCiAgICovCgoKICBmdW5jdGlvbiB1bnJlZ2lzdGVyKHdhaXRlcikgewogICAgV0FJVEVSUy5kZWxldGUod2FpdGVyLm5hbWUpOwogIH0KICAvKioKICAgKiBHZXRzIGFuIGFycmF5IG9mIGFsbCB3YWl0ZXJzIGN1cnJlbnQgcmVnaXN0ZXJlZC4KICAgKgogICAqIEBwdWJsaWMKICAgKiBAcmV0dXJucyB7SVdhaXRlcltdfQogICAqLwoKCiAgZnVuY3Rpb24gZ2V0V2FpdGVycygpIHsKICAgIHJldHVybiBfdG9Db25zdW1hYmxlQXJyYXkoV0FJVEVSUy52YWx1ZXMoKSk7CiAgfQogIC8qKgogICAqIENsZWFycyBhbGwgd2FpdGVycy4KICAgKgogICAqIEBwdWJsaWMKICAgKi8KCgogIGZ1bmN0aW9uIF9yZXNldCgpIHsKICAgIFdBSVRFUlMuY2xlYXIoKTsKICB9CiAgLyoqCiAgICogR2V0cyB0aGUgY3VycmVudCBzdGF0ZSBvZiBhbGwgd2FpdGVycy4gQW55IHdhaXRlcnMgd2hvc2UKICAgKiBgd2FpdFVudGlsYCBtZXRob2QgcmV0dXJucyBmYWxzZSB3aWxsIGJlIGNvbnNpZGVyZWQgYHBlbmRpbmdgLgogICAqCiAgICogQHJldHVybnMge0lQZW5kaW5nV2FpdGVyU3RhdGV9IEFuIG9iamVjdCBjb250YWluaW5nIGEgY291bnQgb2YgYWxsIHdhaXRlcnMKICAgKiBwZW5kaW5nIGFuZCBhIGB3YWl0ZXJzYCBvYmplY3QgY29udGFpbmluZyB0aGUgbmFtZSBvZiBhbGwgcGVuZGluZyB3YWl0ZXJzCiAgICogYW5kIHRoZWlyIGRlYnVnIGluZm8uCiAgICovCgoKICBmdW5jdGlvbiBnZXRQZW5kaW5nV2FpdGVyU3RhdGUoKSB7CiAgICB2YXIgcmVzdWx0ID0gewogICAgICBwZW5kaW5nOiAwLAogICAgICB3YWl0ZXJzOiB7fQogICAgfTsKICAgIFdBSVRFUlMuZm9yRWFjaChmdW5jdGlvbiAod2FpdGVyKSB7CiAgICAgIGlmICghd2FpdGVyLndhaXRVbnRpbCgpKSB7CiAgICAgICAgcmVzdWx0LnBlbmRpbmcrKzsKICAgICAgICB2YXIgZGVidWdJbmZvID0gd2FpdGVyLmRlYnVnSW5mbygpOwogICAgICAgIHJlc3VsdC53YWl0ZXJzW3dhaXRlci5uYW1lXSA9IGRlYnVnSW5mbyB8fCB0cnVlOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIC8qKgogICAqIERldGVybWluZXMgaWYgdGhlcmUgYXJlIGFueSBwZW5kaW5nIHdhaXRlcnMuCiAgICoKICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gYHRydWVgIGlmIHRoZXJlIGFyZSBwZW5kaW5nIHdhaXRlcnMsIG90aGVyd2lzZSBgZmFsc2VgLgogICAqLwoKCiAgZnVuY3Rpb24gaGFzUGVuZGluZ1dhaXRlcnMoKSB7CiAgICB2YXIgc3RhdGUgPSBnZXRQZW5kaW5nV2FpdGVyU3RhdGUoKTsKICAgIHJldHVybiBzdGF0ZS5wZW5kaW5nID4gMDsKICB9Cn0pOwo7Cg==",
            "encoding": "base64"
          },
          "redirectURL": "",
          "headersSize": 162,
          "bodySize": 2818657,
          "_transferSize": 2818819
        },
        "cache": {},
        "timings": {
          "blocked": 4.185000000586151,
          "dns": 0.014000000000000012,
          "ssl": -1,
          "connect": 0.23699999999999988,
          "send": 0.601,
          "wait": 1.232999999989872,
          "receive": 93.52100000069186,
          "_blocked_queueing": 3.145000000586151
        },
        "serverIPAddress": "[::1]",
        "_initiator": {
          "type": "parser",
          "url": "http://localhost:5000/",
          "lineNumber": 20
        },
        "_priority": "High",
        "_resourceType": "script",
        "connection": "50991",
        "pageref": "page_1"
      },
      {
        "startedDateTime": "2019-11-08T20:37:42.915Z",
        "time": 5.945999999564956,
        "request": {
          "method": "GET",
          "url": "http://localhost:5000/assets/relationship-performance-test-app.js",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Host",
              "value": "localhost:5000"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.97 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "*/*"
            },
            {
              "name": "Sec-Fetch-Site",
              "value": "same-origin"
            },
            {
              "name": "Sec-Fetch-Mode",
              "value": "no-cors"
            },
            {
              "name": "Referer",
              "value": "http://localhost:5000/"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.9"
            },
            {
              "name": "Cookie",
              "value": "io=wIu7CXtmPvSmDD1VAAAM; amplitude_id_5e201f0eac128f83637a72cc714578f0=eyJkZXZpY2VJZCI6IjFjNDI0NTRkLTg5MjgtNDc2OC05MzE3LTJlZjFhZWIyOGEyY1IiLCJ1c2VySWQiOm51bGwsIm9wdE91dCI6ZmFsc2UsInNlc3Npb25JZCI6MTU3MjM4NjI4OTk2MiwibGFzdEV2ZW50VGltZSI6MTU3MjM4ODkwNjkxNiwiZXZlbnRJZCI6MTgyLCJpZGVudGlmeUlkIjo5NCwic2VxdWVuY2VOdW1iZXIiOjI3Nn0="
            }
          ],
          "queryString": [],
          "cookies": [
            {
              "name": "io",
              "value": "wIu7CXtmPvSmDD1VAAAM",
              "expires": null,
              "httpOnly": false,
              "secure": false
            },
            {
              "name": "amplitude_id_5e201f0eac128f83637a72cc714578f0",
              "value": "eyJkZXZpY2VJZCI6IjFjNDI0NTRkLTg5MjgtNDc2OC05MzE3LTJlZjFhZWIyOGEyY1IiLCJ1c2VySWQiOm51bGwsIm9wdE91dCI6ZmFsc2UsInNlc3Npb25JZCI6MTU3MjM4NjI4OTk2MiwibGFzdEV2ZW50VGltZSI6MTU3MjM4ODkwNjkxNiwiZXZlbnRJZCI6MTgyLCJpZGVudGlmeUlkIjo5NCwic2VxdWVuY2VOdW1iZXIiOjI3Nn0=",
              "expires": null,
              "httpOnly": false,
              "secure": false
            }
          ],
          "headersSize": 741,
          "bodySize": 0
        },
        "response": {
          "status": 200,
          "statusText": "OK",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Host",
              "value": "localhost:5000"
            },
            {
              "name": "Date",
              "value": "Fri, 08 Nov 2019 20:37:42 +0000"
            },
            {
              "name": "Connection",
              "value": "close"
            },
            {
              "name": "Content-Type",
              "value": "application/javascript"
            },
            {
              "name": "Content-Length",
              "value": "22947"
            }
          ],
          "cookies": [],
          "content": {
            "size": 22947,
            "mimeType": "application/javascript",
            "compression": 0,
            "text": "'use strict';\n\n\n\n;define(\"relationship-performance-test-app/adapters/-json-api\", [\"exports\", \"@ember-data/adapter/json-api\"], function (_exports, _jsonApi) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  Object.defineProperty(_exports, \"default\", {\n    enumerable: true,\n    get: function get() {\n      return _jsonApi.default;\n    }\n  });\n});\n;define(\"relationship-performance-test-app/adapters/application\", [\"exports\"], function (_exports) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n\n  function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }\n\n  function _nonIterableSpread() { throw new TypeError(\"Invalid attempt to spread non-iterable instance\"); }\n\n  function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === \"[object Arguments]\") return Array.from(iter); }\n\n  function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }\n\n  function _typeof(obj) { if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; }; } return _typeof(obj); }\n\n  function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\n  function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }\n\n  function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }\n\n  function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === \"object\" || typeof call === \"function\")) { return call; } return _assertThisInitialized(self); }\n\n  function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return self; }\n\n  function _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }\n\n  function _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function\"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }\n\n  function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }\n\n  var ApplicationMockAdapter =\n  /*#__PURE__*/\n  function (_EmberObject) {\n    _inherits(ApplicationMockAdapter, _EmberObject);\n\n    function ApplicationMockAdapter() {\n      _classCallCheck(this, ApplicationMockAdapter);\n\n      return _possibleConstructorReturn(this, _getPrototypeOf(ApplicationMockAdapter).apply(this, arguments));\n    }\n\n    _createClass(ApplicationMockAdapter, [{\n      key: \"findAll\",\n      value: function findAll() {\n        return Ember.RSVP.resolve(createCarsPayload(10000));\n      }\n    }, {\n      key: \"shouldReloadAll\",\n      value: function shouldReloadAll() {\n        return false;\n      }\n    }, {\n      key: \"shouldBackgroundReloadAll\",\n      value: function shouldBackgroundReloadAll() {\n        return false;\n      }\n    }]);\n\n    return ApplicationMockAdapter;\n  }(Ember.Object);\n\n  _exports.default = ApplicationMockAdapter;\n  var COLORS = ['red', 'white', 'black', 'pink', 'green', 'blue', 'yellow', 'orange', 'green', 'teal'];\n  var SIZES = ['square', 'rectangle', 'circle', 'oval', 'cube', 'small', 'medium', 'large', 'extra large'];\n  var TYPES = ['suv', 'sedan', 'minivan', 'electric', 'hybrid', 'truck', 'sport'];\n  var FIXTURE_ID = 0;\n\n  function getIndex(index, fixtures) {\n    var count = fixtures.length;\n    return index % count;\n  }\n\n  function assignToMany(resource, id) {\n    resource.relationships = resource.relationships || {};\n    var cars = resource.relationships.cars = resource.relationships.cars || {\n      data: []\n    };\n    cars.data.push({\n      type: 'car',\n      id: id\n    });\n  }\n\n  function getRelatedResource(fixtures, index, id) {\n    var resource = fixtures[getIndex(index, fixtures)];\n    assignToMany(resource, id);\n    return {\n      id: resource.id,\n      type: resource.type\n    };\n  }\n\n  function createCarsPayload(n) {\n    performance.mark('start-fixture-generation');\n    var colors = getColorResources();\n    var types = getTypeResources();\n    var sizes = getSizeResources();\n    var fixture = {\n      data: _toConsumableArray(new Array(n)).map(function (v, i) {\n        var id = \"urn:car:\".concat(FIXTURE_ID++);\n        return {\n          id: id,\n          type: 'car',\n          attributes: {},\n          relationships: {\n            type: {\n              data: getRelatedResource(types, i, id)\n            },\n            size: {\n              data: getRelatedResource(sizes, i, id)\n            },\n            colors: {\n              data: [getRelatedResource(colors, i, id), getRelatedResource(colors, i + 1, id), getRelatedResource(colors, i + 2, id)]\n            }\n          }\n        };\n      }),\n      included: [].concat(colors, types, sizes)\n    };\n    performance.mark('end-fixture-generation');\n    return fixture;\n  }\n\n  function getColorResources() {\n    return COLORS.map(function (name) {\n      return createJsonApiResource(\"urn:color:\".concat(FIXTURE_ID++), 'color', {\n        name: name\n      });\n    });\n  }\n\n  function getSizeResources() {\n    return SIZES.map(function (name) {\n      return createJsonApiResource(\"urn:size:\".concat(FIXTURE_ID++), 'size', {\n        name: name\n      });\n    });\n  }\n\n  function getTypeResources() {\n    return TYPES.map(function (name) {\n      return createJsonApiResource(\"urn:type:\".concat(FIXTURE_ID++), 'type', {\n        name: name\n      });\n    });\n  }\n\n  function createJsonApiResource(id, type, attributes) {\n    return {\n      id: id,\n      type: type,\n      attributes: attributes\n    };\n  }\n});\n;define(\"relationship-performance-test-app/app\", [\"exports\", \"relationship-performance-test-app/resolver\", \"ember-load-initializers\", \"relationship-performance-test-app/config/environment\"], function (_exports, _resolver, _emberLoadInitializers, _environment) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n  var App = Ember.Application.extend({\n    modulePrefix: _environment.default.modulePrefix,\n    podModulePrefix: _environment.default.podModulePrefix,\n    Resolver: _resolver.default\n  });\n  (0, _emberLoadInitializers.default)(App, _environment.default.modulePrefix);\n  var _default = App;\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/data-adapter\", [\"exports\", \"@ember-data/debug\"], function (_exports, _debug) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  Object.defineProperty(_exports, \"default\", {\n    enumerable: true,\n    get: function get() {\n      return _debug.default;\n    }\n  });\n});\n;define(\"relationship-performance-test-app/helpers/app-version\", [\"exports\", \"relationship-performance-test-app/config/environment\", \"ember-cli-app-version/utils/regexp\"], function (_exports, _environment, _regexp) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.appVersion = appVersion;\n  _exports.default = void 0;\n\n  function appVersion(_) {\n    var hash = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    var version = _environment.default.APP.version; // e.g. 1.0.0-alpha.1+4jds75hf\n    // Allow use of 'hideSha' and 'hideVersion' For backwards compatibility\n\n    var versionOnly = hash.versionOnly || hash.hideSha;\n    var shaOnly = hash.shaOnly || hash.hideVersion;\n    var match = null;\n\n    if (versionOnly) {\n      if (hash.showExtended) {\n        match = version.match(_regexp.versionExtendedRegExp); // 1.0.0-alpha.1\n      } // Fallback to just version\n\n\n      if (!match) {\n        match = version.match(_regexp.versionRegExp); // 1.0.0\n      }\n    }\n\n    if (shaOnly) {\n      match = version.match(_regexp.shaRegExp); // 4jds75hf\n    }\n\n    return match ? match[0] : version;\n  }\n\n  var _default = Ember.Helper.helper(appVersion);\n\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/helpers/pluralize\", [\"exports\", \"ember-inflector/lib/helpers/pluralize\"], function (_exports, _pluralize) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n  var _default = _pluralize.default;\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/helpers/singularize\", [\"exports\", \"ember-inflector/lib/helpers/singularize\"], function (_exports, _singularize) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n  var _default = _singularize.default;\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/initializers/app-version\", [\"exports\", \"ember-cli-app-version/initializer-factory\", \"relationship-performance-test-app/config/environment\"], function (_exports, _initializerFactory, _environment) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n  var name, version;\n\n  if (_environment.default.APP) {\n    name = _environment.default.APP.name;\n    version = _environment.default.APP.version;\n  }\n\n  var _default = {\n    name: 'App Version',\n    initialize: (0, _initializerFactory.default)(name, version)\n  };\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/initializers/container-debug-adapter\", [\"exports\", \"ember-resolver/resolvers/classic/container-debug-adapter\"], function (_exports, _containerDebugAdapter) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n  var _default = {\n    name: 'container-debug-adapter',\n    initialize: function initialize() {\n      var app = arguments[1] || arguments[0];\n      app.register('container-debug-adapter:main', _containerDebugAdapter.default);\n      app.inject('container-debug-adapter:main', 'namespace', 'application:main');\n    }\n  };\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/initializers/ember-data-data-adapter\", [\"exports\", \"@ember-data/debug/setup\"], function (_exports, _setup) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  Object.defineProperty(_exports, \"default\", {\n    enumerable: true,\n    get: function get() {\n      return _setup.default;\n    }\n  });\n});\n;define(\"relationship-performance-test-app/initializers/ember-data\", [\"exports\", \"ember-data/setup-container\", \"ember-data\"], function (_exports, _setupContainer, _emberData) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n\n  /*\n    This code initializes EmberData in an Ember application.\n  \n    It ensures that the `store` service is automatically injected\n    as the `store` property on all routes and controllers.\n  */\n  var _default = {\n    name: 'ember-data',\n    initialize: _setupContainer.default\n  };\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/initializers/export-application-global\", [\"exports\", \"relationship-performance-test-app/config/environment\"], function (_exports, _environment) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.initialize = initialize;\n  _exports.default = void 0;\n\n  function initialize() {\n    var application = arguments[1] || arguments[0];\n\n    if (_environment.default.exportApplicationGlobal !== false) {\n      var theGlobal;\n\n      if (typeof window !== 'undefined') {\n        theGlobal = window;\n      } else if (typeof global !== 'undefined') {\n        theGlobal = global;\n      } else if (typeof self !== 'undefined') {\n        theGlobal = self;\n      } else {\n        // no reasonable global, just bail\n        return;\n      }\n\n      var value = _environment.default.exportApplicationGlobal;\n      var globalName;\n\n      if (typeof value === 'string') {\n        globalName = value;\n      } else {\n        globalName = Ember.String.classify(_environment.default.modulePrefix);\n      }\n\n      if (!theGlobal[globalName]) {\n        theGlobal[globalName] = application;\n        application.reopen({\n          willDestroy: function willDestroy() {\n            this._super.apply(this, arguments);\n\n            delete theGlobal[globalName];\n          }\n        });\n      }\n    }\n  }\n\n  var _default = {\n    name: 'export-application-global',\n    initialize: initialize\n  };\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/instance-initializers/ember-data\", [\"exports\", \"ember-data/initialize-store-service\"], function (_exports, _initializeStoreService) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n  var _default = {\n    name: 'ember-data',\n    initialize: _initializeStoreService.default\n  };\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/models/car\", [\"exports\", \"ember-data\"], function (_exports, _emberData) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n  var Model = _emberData.default.Model,\n      belongsTo = _emberData.default.belongsTo,\n      hasMany = _emberData.default.hasMany;\n\n  var _default = Model.extend({\n    type: belongsTo('type', {\n      async: false\n    }),\n    size: belongsTo('size', {\n      async: false\n    }),\n    colors: hasMany('color', {\n      async: false\n    })\n  });\n\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/models/color\", [\"exports\", \"ember-data\"], function (_exports, _emberData) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n  var Model = _emberData.default.Model,\n      attr = _emberData.default.attr,\n      hasMany = _emberData.default.hasMany;\n\n  var _default = Model.extend({\n    name: attr('string'),\n    cars: hasMany('car', {\n      async: false\n    })\n  });\n\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/models/size\", [\"exports\", \"ember-data\"], function (_exports, _emberData) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n  var Model = _emberData.default.Model,\n      attr = _emberData.default.attr,\n      hasMany = _emberData.default.hasMany;\n\n  var _default = Model.extend({\n    name: attr('string'),\n    cars: hasMany('car', {\n      async: false\n    })\n  });\n\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/models/type\", [\"exports\", \"ember-data\"], function (_exports, _emberData) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n  var Model = _emberData.default.Model,\n      attr = _emberData.default.attr,\n      hasMany = _emberData.default.hasMany;\n\n  var _default = Model.extend({\n    name: attr('string'),\n    cars: hasMany('car', {\n      async: false\n    })\n  });\n\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/resolver\", [\"exports\", \"ember-resolver\"], function (_exports, _emberResolver) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n  var _default = _emberResolver.default;\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/router\", [\"exports\", \"relationship-performance-test-app/config/environment\"], function (_exports, _environment) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n  var Router = Ember.Router.extend({\n    location: _environment.default.locationType,\n    rootURL: _environment.default.rootURL\n  });\n  Router.map(function () {});\n  var _default = Router;\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/routes/application\", [\"exports\"], function (_exports) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n\n  var _default = Ember.Route.extend({\n    model: function model() {\n      performance.mark('start-find-all');\n      return this.store.findAll('car', {\n        reload: true\n      }).then(function (cars) {\n        performance.mark('start-outer-materialization');\n        var flattened = cars.map(function (car) {\n          // enforce materialization of our relationships\n          return {\n            name: car.id,\n            size: car.size.name,\n            type: car.type.name,\n            colors: car.colors.map(function (color) {\n              return color.name;\n            })\n          };\n        });\n        performance.mark('stop-outer-materialization');\n        performance.mark('end-find-all');\n        return flattened;\n      });\n    },\n    afterModel: function afterModel() {\n      if (document.location.href.indexOf('?tracerbench=true') !== -1) {\n        document.location.href = 'about:blank';\n      }\n    }\n  });\n\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/serializers/-default\", [\"exports\", \"@ember-data/serializer/json\"], function (_exports, _json) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  Object.defineProperty(_exports, \"default\", {\n    enumerable: true,\n    get: function get() {\n      return _json.default;\n    }\n  });\n});\n;define(\"relationship-performance-test-app/serializers/-json-api\", [\"exports\", \"@ember-data/serializer/json-api\"], function (_exports, _jsonApi) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  Object.defineProperty(_exports, \"default\", {\n    enumerable: true,\n    get: function get() {\n      return _jsonApi.default;\n    }\n  });\n});\n;define(\"relationship-performance-test-app/serializers/-rest\", [\"exports\", \"@ember-data/serializer/rest\"], function (_exports, _rest) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  Object.defineProperty(_exports, \"default\", {\n    enumerable: true,\n    get: function get() {\n      return _rest.default;\n    }\n  });\n});\n;define(\"relationship-performance-test-app/serializers/application\", [\"exports\", \"ember-data\"], function (_exports, _emberData) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n\n  var _default = _emberData.default.JSONAPISerializer.extend({\n    normalizeResponse: function normalizeResponse(store, primaryModelClass, payload) {\n      return payload;\n    }\n  });\n\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/services/store\", [\"exports\", \"ember-data/store\"], function (_exports, _store) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  Object.defineProperty(_exports, \"default\", {\n    enumerable: true,\n    get: function get() {\n      return _store.default;\n    }\n  });\n});\n;define(\"relationship-performance-test-app/templates/application\", [\"exports\"], function (_exports) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  _exports.default = void 0;\n\n  var _default = Ember.HTMLBars.template({\n    \"id\": \"6nqMC1Ym\",\n    \"block\": \"{\\\"symbols\\\":[],\\\"statements\\\":[],\\\"hasEval\\\":false}\",\n    \"meta\": {\n      \"moduleName\": \"relationship-performance-test-app/templates/application.hbs\"\n    }\n  });\n\n  _exports.default = _default;\n});\n;define(\"relationship-performance-test-app/transforms/boolean\", [\"exports\", \"@ember-data/serializer/-private\"], function (_exports, _private) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  Object.defineProperty(_exports, \"default\", {\n    enumerable: true,\n    get: function get() {\n      return _private.BooleanTransform;\n    }\n  });\n});\n;define(\"relationship-performance-test-app/transforms/date\", [\"exports\", \"@ember-data/serializer/-private\"], function (_exports, _private) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  Object.defineProperty(_exports, \"default\", {\n    enumerable: true,\n    get: function get() {\n      return _private.DateTransform;\n    }\n  });\n});\n;define(\"relationship-performance-test-app/transforms/number\", [\"exports\", \"@ember-data/serializer/-private\"], function (_exports, _private) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  Object.defineProperty(_exports, \"default\", {\n    enumerable: true,\n    get: function get() {\n      return _private.NumberTransform;\n    }\n  });\n});\n;define(\"relationship-performance-test-app/transforms/string\", [\"exports\", \"@ember-data/serializer/-private\"], function (_exports, _private) {\n  \"use strict\";\n\n  Object.defineProperty(_exports, \"__esModule\", {\n    value: true\n  });\n  Object.defineProperty(_exports, \"default\", {\n    enumerable: true,\n    get: function get() {\n      return _private.StringTransform;\n    }\n  });\n});\n;\n\n;define('relationship-performance-test-app/config/environment', [], function() {\n  var prefix = 'relationship-performance-test-app';\ntry {\n  var metaName = prefix + '/config/environment';\n  var rawConfig = document.querySelector('meta[name=\"' + metaName + '\"]').getAttribute('content');\n  var config = JSON.parse(decodeURIComponent(rawConfig));\n\n  var exports = { 'default': config };\n\n  Object.defineProperty(exports, '__esModule', { value: true });\n\n  return exports;\n}\ncatch(err) {\n  throw new Error('Could not read config from meta tag with name \"' + metaName + '\".');\n}\n\n});\n\n;\n          if (!runningTests) {\n            require(\"relationship-performance-test-app/app\")[\"default\"].create({\"name\":\"relationship-performance-test-app\",\"version\":\"3.16.0-alpha.0+ec454410\"});\n          }\n        \n"
          },
          "redirectURL": "",
          "headersSize": 160,
          "bodySize": 22947,
          "_transferSize": 23107
        },
        "cache": {},
        "timings": {
          "blocked": 4.667000000505941,
          "dns": 0.010000000000000009,
          "ssl": -1,
          "connect": 0.18300000000000005,
          "send": 0.09099999999999997,
          "wait": 0.6029999991392252,
          "receive": 0.39199999991978984,
          "_blocked_queueing": 3.537000000505941
        },
        "serverIPAddress": "[::1]",
        "_initiator": {
          "type": "parser",
          "url": "http://localhost:5000/",
          "lineNumber": 21
        },
        "_priority": "High",
        "_resourceType": "script",
        "connection": "50995",
        "pageref": "page_1"
      }
    ]
  }
}